[{"title":"","tags":[],"categories":[],"author":"","excerpt":"\n\nå¥½åƒæ¥åˆ°äº†æœªçŸ¥çš„ä¸–ç•Œï¼ï¼ï¼ï¼Ÿ\n\n\n","link":"/404","content":"\n\nå¥½åƒæ¥åˆ°äº†æœªçŸ¥çš„ä¸–ç•Œï¼ï¼ï¼ï¼Ÿ\n\n\n"},{"title":"å…³äºæˆ‘","tags":[],"categories":[],"author":"","excerpt":"\n\n\n# imklaus\n\n\n\n\n\n## é­”æ³•ä¸–ç•Œæ´»è·ƒåº¦ï¼ˆæ¨¡æ¿ - å¾…ä¿®æ”¹ï¼‰\n\n<figure style=\"display: flex\">\n    <embed src=\"https://wakat","link":"/about","content":"\n\n\n# imklaus\n\n\n\n\n\n## é­”æ³•ä¸–ç•Œæ´»è·ƒåº¦ï¼ˆæ¨¡æ¿ - å¾…ä¿®æ”¹ï¼‰\n\n<figure style=\"display: flex\">\n    <embed src=\"https://wakatime.com/share/@Yuumi/a49b3681-974e-4998-9b41-9e5a5c8ada63.svg\" width=50% />\n\t<embed src=\"https://wakatime.com/share/@Yuumi/03d69028-f46a-428b-a168-2696cb23afe7.svg\" width=50% />\n</figure>\n\n\n<div style=\"text-align: center\"><b>æ„Ÿè°¢ä½ åœ¨èŒ«èŒ«äº’è”çš„ç½‘ç»œä¸­ç‚¹è¿›äº†æˆ‘çš„ä¸»é¡µï¼Œå¹¶çœ‹åˆ°äº†è¿™é‡Œã€‚è¡·å¿ƒåœ°ç¥æ„¿ä½ èƒ½æˆä¸ºæ›´å¥½çš„è‡ªå·±ğŸ’›</b></div>\n\n---\n\n<div class=\"primary\">\n\n>Since  2021.9.24\n\n</div>\n\n"},{"title":"å…³äºæ­¤ç«™","tags":[],"categories":[],"author":"","excerpt":"\n# æœªè§£å†³é—®é¢˜ï¼š\n\n- slideæš‚æ—¶æ— æ³•ä½¿ç”¨\n\n \n\n  \n\n\n<iframe src=\"https://quizlet.com/646335908/flashcards/embed?i=2hsr","link":"/about/site","content":"\n# æœªè§£å†³é—®é¢˜ï¼š\n\n- slideæš‚æ—¶æ— æ³•ä½¿ç”¨\n\n \n\n  \n\n\n<iframe src=\"https://quizlet.com/646335908/flashcards/embed?i=2hsreo&x=1jj1\" height=\"500\" width=\"100%\" style=\"border:0\"></iframe>\n"},{"title":"","tags":[],"categories":[],"author":"","excerpt":"","link":"/archives","content":""},{"title":"","tags":[],"categories":[],"author":"","excerpt":"","link":"/categories","content":""},{"title":"ç•™è¨€æ¿","tags":[],"categories":[],"author":"","excerpt":"\n# è¿™æ˜¯ä¸€å—ç•™è¨€æ¿\n\næ¬¢è¿æ¥è¿™é‡Œç•…æ‰€æ¬²è¨€~~\n\n### å…³äºè¯„è®ºå¤´åƒ\n\næœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥æ‹¥æœ‰è‡ªå®šä¹‰è¯„è®ºå¤´åƒï¼š\n\n1. å¡«å†™qqé‚®ç®±ï¼Œè‡ªåŠ¨è·å–qqå¤´åƒï¼›\n2. ç‚¹å‡»è¯„è®ºæ¡†å³ä¸‹è§’çš„ç™»å½•æŒ‰é’®ï¼Œç™»å½•å¾®åš/Gi","link":"/comment","content":"\n# è¿™æ˜¯ä¸€å—ç•™è¨€æ¿\n\næ¬¢è¿æ¥è¿™é‡Œç•…æ‰€æ¬²è¨€~~\n\n### å…³äºè¯„è®ºå¤´åƒ\n\næœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥æ‹¥æœ‰è‡ªå®šä¹‰è¯„è®ºå¤´åƒï¼š\n\n1. å¡«å†™qqé‚®ç®±ï¼Œè‡ªåŠ¨è·å–qqå¤´åƒï¼›\n2. ç‚¹å‡»è¯„è®ºæ¡†å³ä¸‹è§’çš„ç™»å½•æŒ‰é’®ï¼Œç™»å½•å¾®åš/Github/Twitter/Facebookè·å–å¤´åƒï¼Œæˆ–æ³¨å†Œè®¾ç½®å¤´åƒï¼›\n3. é‚®ç®±ç™»å½•æˆ–æ³¨å†Œ [libravatar](https://www.libravatar.org/)ï¼ˆè®°å¾—ç‚¹ä¸€ä¸‹é‚®ç®±éªŒè¯é“¾æ¥å“¦ï¼‰ï¼Œä¸Šä¼ å¤´åƒï¼Œå¹¶åœ¨ç•™è¨€æ—¶å¡«å†™æ­¤é‚®ç®±ã€‚\n\nå¿«æ¥è¯„è®ºï¼ï¼éƒ½ç»™æˆ‘æ¥è¯„è®ºï¼ï¼ï¼\n\n"},{"title":"å­¦ä¹ ã€å‚è€ƒä¸å€Ÿé‰´","tags":[],"categories":[],"author":"","excerpt":"\n<YunLinks :links=frontmatter.links :random=frontmatter.random />\n------\n# å‹é“¾ç”³è¯·æ ¼å¼\n\nå‹é“¾ä¸ºéšæœºé¡ºåºå±•ç¤ºï¼Œå¸Œæœ›äº¤æ¢å‹é“¾çš„","link":"/links","content":"\n<YunLinks :links=frontmatter.links :random=frontmatter.random />\n------\n# å‹é“¾ç”³è¯·æ ¼å¼\n\nå‹é“¾ä¸ºéšæœºé¡ºåºå±•ç¤ºï¼Œå¸Œæœ›äº¤æ¢å‹é“¾çš„è¯å¯ä»¥æŒ‰æ­¤æ ¼å¼åœ¨è¯„è®ºåŒºç•™ä¸‹ä¿¡æ¯ï¼š\n\n```json\n{\n    \"url\": \"https://imlklaus.github.io\",\n    \"avatar\": \"https://imlklaus.github.io/images/tiamat2.jpg\",\n    \"name\": \"imklaus\",\n    \"blog\": \"-imklaus's Blog-\",\n    \"desc\": \"The Winner Takes It All.\",\n    \"color\": \"#102434\"\n}\n```\n------"},{"title":"Listen to music","tags":[],"categories":[],"author":"","excerpt":"\r\n> [BEST LIVEï¼šKalafina 9+ONE@Tokyo International Forum Hall](https://www.bilibili.com/video/BV1UT4y","link":"/music","content":"\r\n> [BEST LIVEï¼šKalafina 9+ONE@Tokyo International Forum Hall](https://www.bilibili.com/video/BV1UT4y1g7Pi)\r\n>\r\n> <div style=\"display: flex; justify-content: space-between;\">\r\n> <span>ã€ŠFate/Zeroã€‹OP2</span>\r\n> <span>Kalafina-to the beginning</span>\r\n> </div>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\r\n\r\n<meting-js\r\n id=\"1322356618\"\r\n server=\"netease\"\r\n type=\"song\"\r\n theme=\"#2980b9\">\r\n</meting-js>\r\n\r\n---\r\n\r\n> [BEST LIVEï¼šKalafina 10th Anniversary LIVE 2018 at æ—¥æœ¬æ­¦é“é¤¨](https://www.bilibili.com/video/BV1Wp4y1k7eS?spm_id_from=333.788.videopod.episodes&vd_source=dab39c6fd8d95012d168e88c73fe62f5&p=2)\r\n>\r\n> <div style=\"display: flex; justify-content: space-between;\">\r\n> <span>ç©ºä¹‹å¢ƒç•Œç¬¬äº”ç« Â·çŸ›ç›¾èºæ—‹ ED</span>\r\n> <span>Kalafina-Sprinter</span>\r\n> </div>\r\n\r\n<meting-js\r\n id=\"33316306\"\r\n server=\"netease\"\r\n type=\"song\"\r\n theme=\"#2980b9\">\r\n</meting-js>\r\n\r\n---\r\n\r\n"},{"title":"ç¼“å­˜+åˆ†å¸ƒå¼é”åœ¨Javaé¡¹ç›®ä¸­çš„åº”ç”¨","tags":["Redis","Spring Cache","Spring Session","Redisson"],"categories":["Java","å¾®ç³»ç»Ÿä¸ç¬¬ä¸‰æ–¹æ¡†æ¶"],"author":"","excerpt":"\r\n\r\nå‚è€ƒè§†é¢‘ï¼š[é›·ç¥è°·ç²’å•†åŸé¡¹ç›®](https://www.bilibili.com/video/BV1np4y1C7Yf/)\r\n\r\n","link":"/posts/Cache_Project","content":"\r\n\r\nå‚è€ƒè§†é¢‘ï¼š[é›·ç¥è°·ç²’å•†åŸé¡¹ç›®](https://www.bilibili.com/video/BV1np4y1C7Yf/)\r\n\r\n<!-- more -->\r\n\r\n\r\n## â… .ä»¿äº¬ä¸œè´­ç‰©è½¦ç³»ç»Ÿ\r\n\r\n- è´­ç‰©è½¦Redisæ•°æ®ç»“æ„é€‰å‹ï¼š\r\n  - åŒå±‚ Mapï¼š`Map<String,Map<String,String>>`\r\n    - ç¬¬ä¸€å±‚ Mapï¼ŒKey æ˜¯ç”¨æˆ· id\r\n    - ç¬¬äºŒå±‚ Mapï¼ŒKey æ˜¯è´­ç‰©è½¦ä¸­å•†å“ idï¼Œå€¼æ˜¯è´­ç‰©é¡¹æ•°æ®\r\n- è´­ç‰©è½¦ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼šæ–°å¢å•†å“åˆ°è´­ç‰©è½¦ã€æŸ¥è¯¢è´­ç‰©è½¦\r\n  - æ–°å¢å•†å“ï¼šåˆ¤æ–­æ˜¯å¦ç™»å½•\r\n    - æ˜¯ï¼šåˆ™æ·»åŠ å•†å“åˆ°åå° Redis ä¸­ï¼ŒæŠŠ user çš„å”¯ä¸€æ ‡è¯†ç¬¦ä½œä¸º keyã€‚\r\n    - å¦ï¼šåˆ™æ·»åŠ å•†å“åˆ°åå° Redis ä¸­ï¼Œä½¿ç”¨éšæœºç”Ÿæˆçš„ user-key ä½œä¸º keyã€‚\r\n- æŸ¥è¯¢è´­ç‰©è½¦åˆ—è¡¨ï¼šåˆ¤æ–­æ˜¯å¦ç™»å½•\r\n  - å¦ï¼šç›´æ¥æ ¹æ® user-key æŸ¥è¯¢ Redis ä¸­æ•°æ®å¹¶å±•ç¤º\r\n  - æ˜¯ï¼šå·²ç™»å½•ï¼Œåˆ™éœ€è¦å…ˆæ ¹æ® user-key æŸ¥è¯¢ Redis æ˜¯å¦æœ‰æ•°æ®ã€‚\r\n  - æœ‰ï¼šéœ€è¦æäº¤åˆ°åå°æ·»åŠ åˆ° Redis ï¼Œåˆå¹¶æ•°æ®ï¼Œè€ŒåæŸ¥è¯¢ã€‚\r\n  - å¦ï¼šç›´æ¥å»åå°æŸ¥è¯¢ Redis ï¼Œè€Œåè¿”å›\r\n\r\n### 1ã€è´­ç‰©è½¦éœ€æ±‚\r\n\r\n#### 1ï¼‰ã€éœ€æ±‚æè¿°ï¼š\r\n\r\n- ç”¨æˆ·å¯ä»¥åœ¨ç™»å½•çŠ¶æ€ä¸‹å°†å•†å“æ·»åŠ åˆ°è´­ç‰©è½¦ã€ç”¨æˆ·è´­ç‰©è½¦/åœ¨çº¿è´­ç‰©è½¦ã€‘\r\n  - æ”¾å…¥æ•°æ®åº“\r\n  - mongodb\r\n  - æ”¾å…¥ redisï¼ˆé‡‡ç”¨ï¼‰\r\n    - ç™»å½•ä»¥åï¼Œä¼šå°†ä¸´æ—¶è´­ç‰©è½¦çš„æ•°æ®å…¨éƒ¨åˆå¹¶è¿‡æ¥ï¼Œå¹¶æ¸…ç©ºä¸´æ—¶è´­ç‰©è½¦ï¼›\r\n- ç”¨æˆ·å¯ä»¥åœ¨æœªç™»å½•çŠ¶æ€ä¸‹å°†å•†å“æ·»åŠ åˆ°è´­ç‰©è½¦ã€æ¸¸å®¢è´­ç‰©è½¦/ç¦»çº¿è´­ç‰©è½¦/ä¸´æ—¶è´­ç‰©è½¦ã€‘\r\n  - æ”¾å…¥ localstorageï¼ˆå®¢æˆ·ç«¯å­˜å‚¨ï¼Œåå°ä¸å­˜ï¼‰\r\n  - cookie\r\n  - WebSQL\r\n  - æ”¾å…¥ redisï¼ˆé‡‡ç”¨ï¼‰\r\n    - æµè§ˆå™¨å³ä½¿å…³é—­ï¼Œä¸‹æ¬¡è¿›å…¥ï¼Œä¸´æ—¶è´­ç‰©è½¦æ•°æ®éƒ½åœ¨\r\n- ç”¨æˆ·å¯ä»¥ä½¿ç”¨è´­ç‰©è½¦ä¸€èµ·ç»“ç®—ä¸‹å•\r\n- ç»™è´­ç‰©è½¦æ·»åŠ å•†å“\r\n- ç”¨æˆ·å¯ä»¥æŸ¥è¯¢è‡ªå·±çš„è´­ç‰©è½¦\r\n- ç”¨æˆ·å¯ä»¥åœ¨è´­ç‰©è½¦ä¸­ä¿®æ”¹è´­ä¹°å•†å“çš„æ•°é‡ã€‚\r\n- ç”¨æˆ·å¯ä»¥åœ¨è´­ç‰©è½¦ä¸­åˆ é™¤å•†å“ã€‚\r\n- é€‰ä¸­ä¸é€‰ä¸­å•†å“\r\n- åœ¨è´­ç‰©è½¦ä¸­å±•ç¤ºå•†å“ä¼˜æƒ ä¿¡æ¯\r\n- æç¤ºè´­ç‰©è½¦å•†å“ä»·æ ¼å˜åŒ–\r\n\r\n#### 2ï¼‰ã€æ•°æ®ç»“æ„\r\n\r\n![image-20230410200320343](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410200320343.png)\r\n\r\n> - `Map<String k1,Map<String k2,CartItemInfo>>` \t|\t\tåœ¨redisä¸­\r\n> - k1ï¼šæ ‡è¯†æ¯ä¸€ä¸ªç”¨æˆ·çš„è´­ç‰©è½¦\t\t\t\t\t\t\t\t\t|\t\tkey:ç”¨æˆ·æ ‡è¯†\r\n> - k2ï¼šè´­ç‰©é¡¹çš„å•†å“id  \t\t\t\t\t\t\t\t\t\t\t\t   |\t    value:Hashï¼ˆkï¼šå•†å“idï¼Œvï¼šè´­ç‰©é¡¹è¯¦æƒ…ï¼‰\r\n\r\n![image-20230424202014610](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230424202014610.png)\r\n\r\nå› æ­¤æ¯ä¸€ä¸ªè´­ç‰©é¡¹ä¿¡æ¯ï¼Œéƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŸºæœ¬å­—æ®µåŒ…æ‹¬ï¼š\r\n\r\n```json\r\n{\r\n\tskuId: 2131241,\r\n\tcheck: true,\r\n\ttitle: \"Apple iphone.....\",\r\n\tdefaultImage: \"...\",\r\n\tprice: 4999,\r\n\tcount: 1,\r\n\ttotalPrice: 4999,\r\n\tskuSaleVO: {...}\r\n}\r\n```\r\n\r\nå¦å¤–ï¼Œè´­ç‰©è½¦ä¸­ä¸æ­¢ä¸€æ¡æ•°æ®ï¼Œå› æ­¤æœ€ç»ˆä¼šæ˜¯å¯¹è±¡çš„æ•°ç»„ã€‚å³ï¼š\r\n\r\n```json\r\n[\r\n\t{...},{...},{...}\r\n]\r\n```\r\n\r\n> Redis æœ‰ 5 ç§ä¸åŒæ•°æ®ç»“æ„ï¼Œè¿™é‡Œé€‰æ‹©å“ªä¸€ç§æ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿ`Map<String, List<String>>`\r\n> - é¦–å…ˆä¸åŒç”¨æˆ·åº”è¯¥æœ‰ç‹¬ç«‹çš„è´­ç‰©è½¦ï¼Œå› æ­¤è´­ç‰©è½¦åº”è¯¥ä»¥ç”¨æˆ·çš„ä½œä¸º key æ¥å­˜å‚¨ï¼ŒValue æ˜¯\r\n> ç”¨æˆ·çš„æ‰€æœ‰è´­ç‰©è½¦ä¿¡æ¯ã€‚è¿™æ ·çœ‹æ¥åŸºæœ¬çš„`k-v`ç»“æ„å°±å¯ä»¥äº†ã€‚\r\n> - ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯¹è´­ç‰©è½¦ä¸­çš„å•†å“è¿›è¡Œå¢ã€åˆ ã€æ”¹æ“ä½œï¼ŒåŸºæœ¬éƒ½éœ€è¦æ ¹æ®å•†å“ id è¿›è¡Œåˆ¤æ–­ï¼Œ\r\n> ä¸ºäº†æ–¹ä¾¿åæœŸå¤„ç†ï¼Œæˆ‘ä»¬çš„è´­ç‰©è½¦ä¹Ÿåº”è¯¥æ˜¯`k-v`ç»“æ„ï¼Œkey æ˜¯å•†å“ idï¼Œvalue æ‰æ˜¯è¿™ä¸ªå•†å“çš„\r\n> è´­ç‰©è½¦ä¿¡æ¯ã€‚\r\n> ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬çš„è´­ç‰©è½¦ç»“æ„æ˜¯ä¸€ä¸ªåŒå±‚ Mapï¼šMap<String,Map<String,String>>\r\n> - ç¬¬ä¸€å±‚ Mapï¼ŒKey æ˜¯ç”¨æˆ· id\r\n> - ç¬¬äºŒå±‚ Mapï¼ŒKey æ˜¯è´­ç‰©è½¦ä¸­å•†å“ idï¼Œå€¼æ˜¯è´­ç‰©é¡¹æ•°æ®\r\n>\r\n\r\n#### 3ï¼‰ã€æµç¨‹\r\n\r\nå‚ç…§äº¬ä¸œ\r\n\r\n![image-20230425192047077](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230425192047077.png)\r\n\r\nuser-key æ˜¯éšæœºç”Ÿæˆçš„ idï¼Œä¸ç®¡æœ‰æ²¡æœ‰ç™»å½•éƒ½ä¼šæœ‰è¿™ä¸ª cookie ä¿¡æ¯ã€‚\r\n\r\nä¸¤ä¸ªåŠŸèƒ½ï¼šæ–°å¢å•†å“åˆ°è´­ç‰©è½¦ã€æŸ¥è¯¢è´­ç‰©è½¦ã€‚\r\n\r\n-  æ–°å¢å•†å“ï¼šåˆ¤æ–­æ˜¯å¦ç™»å½•\r\n\r\n   - æ˜¯ï¼šåˆ™æ·»åŠ å•†å“åˆ°åå° Redis ä¸­ï¼ŒæŠŠ user çš„å”¯ä¸€æ ‡è¯†ç¬¦ä½œä¸º keyã€‚\r\n\r\n\r\n  - å¦ï¼šåˆ™æ·»åŠ å•†å“åˆ°åå° redis ä¸­ï¼Œä½¿ç”¨éšæœºç”Ÿæˆçš„ user-key ä½œä¸º keyã€‚\r\n\r\n\r\n-  æŸ¥è¯¢è´­ç‰©è½¦åˆ—è¡¨ï¼šåˆ¤æ–­æ˜¯å¦ç™»å½•\r\n   - å¦ï¼šç›´æ¥æ ¹æ® user-key æŸ¥è¯¢ redis ä¸­æ•°æ®å¹¶å±•ç¤º\r\n   - æ˜¯ï¼šå·²ç™»å½•ï¼Œåˆ™éœ€è¦å…ˆæ ¹æ® user-key æŸ¥è¯¢ redis æ˜¯å¦æœ‰æ•°æ®ã€‚\r\n   - æœ‰ï¼šéœ€è¦æäº¤åˆ°åå°æ·»åŠ åˆ° redisï¼Œåˆå¹¶æ•°æ®ï¼Œè€ŒåæŸ¥è¯¢ã€‚\r\n   - å¦ï¼šç›´æ¥å»åå°æŸ¥è¯¢ redisï¼Œè€Œåè¿”å›ã€‚\r\n\r\n#### 4ï¼‰ã€å¼•å…¥ä¾èµ–\r\n\r\n```xml\r\n<!-- å¼•å…¥redis -->\r\n<dependency>\r\n  <groupId>org.springframework.boot</groupId>\r\n  <artifactId>spring-boot-starter-data-redis</artifactId>\r\n</dependency>\r\n```\r\n\r\n### 2ã€æ·»åŠ è´­ç‰©è½¦\r\n\r\n- ç”¨æˆ·ä¿¡æ¯æ•°æ®ä¼ è¾“To\r\n  - tempUser = falseè¡¨ç¤ºé»˜è®¤æ˜¯ç™»å½•ç”¨æˆ·ï¼Œå³å°†ç”¨æˆ·å”¯ä¸€idä½œä¸ºç¼“å­˜key\r\n  - tempUser = trueè¡¨ç¤ºæ˜¯æ¸¸å®¢èº«ä»½ï¼Œç³»ç»Ÿå°†ç”Ÿæˆéšæœºç user-keyä½œä¸ºç¼“å­˜key\r\n\r\n```java\r\n@ToString\r\n@Data\r\npublic class UserInfoTo {\r\n\r\n    private Long userId;\r\n    private String userKey;//ä¸€å®šå°è£…\r\n\r\n    private boolean tempUser = false;\r\n}\r\n```\r\n\r\n- è´­ç‰©è½¦æ‹¦æˆªå™¨\r\n\r\n```java\r\n/**\r\n * æ‹¦æˆªå™¨\r\n * åœ¨æ‰§è¡Œç›®æ ‡æ–¹æ³•ä¹‹å‰ï¼Œåˆ¤æ–­ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼Œå¹¶å°è£…ä¼ é€’ç»™controllerç›®æ ‡è¯·æ±‚\r\n * @author Klaus\r\n * @date 2022/9/19\r\n */\r\npublic class CartInterceptor implements HandlerInterceptor {\r\n\r\n    public static ThreadLocal<UserInfoTo> threadLocal = new ThreadLocal<>();\r\n\r\n    /**\r\n     * ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰\r\n     * @param request\r\n     * @param response\r\n     * @param handler\r\n     * @return\r\n     * @throws Exception\r\n     */\r\n    @Override\r\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response,\r\n                             Object handler) throws Exception {\r\n        UserInfoTo userInfoTo = new UserInfoTo();\r\n        HttpSession session = request.getSession();\r\n        MemberRespVo member = (MemberRespVo) session.getAttribute(AuthServerConstant.LOGIN_USER);\r\n        if (member != null){\r\n            //ç”¨æˆ·ç™»å½•\r\n            userInfoTo.setUserId(member.getId());\r\n        }\r\n        Cookie[] cookies = request.getCookies();\r\n        if (cookies != null && cookies.length >0){\r\n            for (Cookie cookie : cookies) {\r\n                //user-key\r\n                String name = cookie.getName();\r\n                if (name.equals(CartConstant.TEMP_USER_COOKIE_NAME)){\r\n                    //user-key:  afrwgrgrg3r\r\n                    userInfoTo.setUserKey(cookie.getValue());\r\n                    userInfoTo.setTempUser(true);\r\n                }\r\n            }\r\n        }\r\n\r\n        //å¦‚æœæ²¡æœ‰ä¸´æ—¶ç”¨æˆ·ä¸€å®šåˆ†é…ä¸€ä¸ªä¸´æ—¶ç”¨æˆ·\r\n        if (StringUtils.isEmpty(userInfoTo.getUserKey())){\r\n            String uuid = UUID.randomUUID().toString();\r\n            userInfoTo.setUserKey(uuid);\r\n        }\r\n        //ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰\r\n        threadLocal.set(userInfoTo);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * ä¸šåŠ¡æ‰§è¡Œä¹‹åï¼Œåˆ†é…ä¸´æ—¶ç”¨æˆ·ï¼Œè®©æµè§ˆå™¨ä¿å­˜\r\n     * @param request\r\n     * @param response\r\n     * @param handler\r\n     * @param modelAndView\r\n     * @throws Exception\r\n     */\r\n    @Override\r\n    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {\r\n        UserInfoTo userInfoTo = threadLocal.get();\r\n        //å¦‚æœæ²¡æœ‰ä¸´æ—¶ç”¨æˆ·ä¸€å®šä¿å­˜ä¸€ä¸ªä¸´æ—¶ç”¨æˆ·ï¼Œé»˜è®¤ä¸æ˜¯\r\n        if (!userInfoTo.isTempUser()){\r\n            //æ˜¯ä¸´æ—¶ç”¨æˆ·\r\n            //å°†user-keyæ”¾å…¥cookie\r\n            Cookie cookie = new Cookie(CartConstant.TEMP_USER_COOKIE_NAME, userInfoTo.getUserKey());\r\n            //ä½œç”¨åŸŸ\r\n            cookie.setDomain(\"gulimall.com\");\r\n            //æŒç»­å»¶è¿Ÿä¸´æ—¶ç”¨æˆ·çš„è¿‡æœŸæ—¶é—´\r\n            cookie.setMaxAge(CartConstant.TEMP_USER_COOKIE_TIMEOUT);\r\n            //å“åº”å¤´é‡ŒåŠ å…¥cookie\r\n            response.addCookie(cookie);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n- DEBUGæ‹¦æˆªå™¨\r\n\r\n  - é¦–æ¬¡è®¿é—®é¦–é¡µï¼ˆæœªç™»å½•çŠ¶æ€ï¼‰ï¼Œæ‰§è¡Œç›®æ ‡æ–¹æ³•ä¹‹å‰ï¼ˆæ·»åŠ å•†å“åˆ°è´­ç‰©è½¦ï¼‰ï¼Œåœ¨é¡µé¢æ²¡æœ‰å¼‚æ­¥è¯·æ±‚æ²¡è¶…æ—¶å‰å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼ˆè¶…æ—¶ç›´æ¥404ï¼Œæ“ä½œå¤±è´¥ï¼‰\r\n\r\n  ![image-20230425004106238](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230425004106238.png)\r\n\r\n  - åœ¨è§„å®šæ—¶é—´ï¼ˆ30så·¦å³ï¼‰å†…å®Œæˆä»¥ä¸Šæ“ä½œï¼Œå°†user-keyå­˜å…¥CookieæˆåŠŸï¼Œè¿”å›preHandleæ–¹æ³•\r\n\r\n  ![image-20230425005929883](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230425005929883.png)\r\n\r\n- æ·»åŠ è´­ç‰©è½¦æ¥å£`org.klaus.zgg01mall.cart.controller.CartController#addToCart`\r\n\r\n```java\r\n/**\r\n     * æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦\r\n     *         redirectAttributes.addFlashAttribute():å°†æ•°æ®æ”¾åœ¨sessioné‡Œé¢å¯ä»¥åœ¨é¡µé¢å–å‡ºï¼Œä½†æ˜¯åªèƒ½å–ä¸€æ¬¡\r\n     *         redirectAttributes.addAttribute(\"skuId\", skuId);å°†æ•°æ®æ”¾åœ¨urlåé¢\r\n     * @return\r\n     */\r\n    @GetMapping(\"/addToCart\")\r\n    public String addToCart(@RequestParam(\"skuId\") Long skuId,\r\n                            @RequestParam(\"num\") Integer num,\r\n                            RedirectAttributes redirectAttributes) throws ExecutionException, InterruptedException {\r\n\r\n        cartService.addToCart(skuId, num);\r\n//        model.addAttribute(\"skuId\", skuId); //Required Long parameter 'skuId' is not present\r\n        redirectAttributes.addAttribute(\"skuId\", skuId);\r\n        //æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦ï¼Œé‡å®šå‘åˆ°æˆåŠŸé¡µé¢->åˆ·æ–°é¡µé¢ä¸ä¼šå†å¢åŠ è´­ç‰©è½¦æ•°é‡http://cart.gulimall.com/addToCart?skuId=35&num=1\r\n        return \"redirect:http://cart.gulimall.com/addToCartSuccess.html\";\r\n    }\r\n```\r\n\r\n- `org.klaus.zgg01mall.cart.vo.Cart`\r\n\r\n\r\n```java\r\n/**\r\n * æ•´ä¸ªè´­ç‰©è½¦çš„å†…å®¹\r\n *  éœ€è¦è®¡ç®—çš„å±æ€§ï¼Œå¿…é¡»é‡å†™ä»–çš„getæ–¹æ³•ï¼Œä¿è¯æ¯æ¬¡è·å–å±æ€§éƒ½ä¼šè¿›è¡Œè®¡ç®—\r\n * @author Klaus\r\n * @date 2022/9/19\r\n */\r\npublic class Cart {\r\n\r\n    private List<CartItem> items;\r\n\r\n    private Integer countNum;//å•†å“æ•°é‡\r\n\r\n    private Integer countType;//å•†å“ç±»å‹æ•°é‡\r\n\r\n    private BigDecimal totalAmount;//å•†å“æ€»ä»·\r\n\r\n    private BigDecimal reduce = new BigDecimal(\"0.00\");//å‡å…ä»·æ ¼\r\n\r\n    public List<CartItem> getItems() {\r\n        return items;\r\n    }\r\n\r\n    public void setItems(List<CartItem> items) {\r\n        this.items = items;\r\n    }\r\n\r\n    /**\r\n     * ç»Ÿè®¡æ¯ä¸€è¡Œ*æ•°é‡ å†ç›¸åŠ \r\n     * @return\r\n     */\r\n    public Integer getCountNum() {\r\n        int count = 0;\r\n        if (items != null && items.size() > 0) {\r\n            for (CartItem item : items) {\r\n                count += item.getCount();\r\n            }\r\n        }\r\n        return count;\r\n    }\r\n\r\n\r\n    /**\r\n     * ç»Ÿè®¡æ¯ä¸€è¡Œç›¸åŠ \r\n     * @return\r\n     */\r\n    public Integer getCountType() {\r\n        int count = 0;\r\n        if (items != null && items.size() > 0) {\r\n            for (CartItem item : items) {\r\n                count += 1;\r\n            }\r\n        }\r\n        return count;\r\n    }\r\n\r\n\r\n\r\n    public BigDecimal getTotalAmount() {\r\n        BigDecimal amount = new BigDecimal(\"0\");\r\n        //1ã€è®¡ç®—è´­ç‰©é¡¹æ€»ä»·\r\n        if (items != null && items.size() > 0) {\r\n            for (CartItem item : items) {\r\n                if (item.getCheck()){\r\n                    //è´­ç‰©é¡¹è¢«é€‰ä¸­æ‰è¿›è¡Œè®¡ç®—\r\n                    BigDecimal totalPrice = item.getTotalPrice();\r\n                    amount = amount.add(totalPrice);\r\n                }\r\n            }\r\n        }\r\n\r\n        //2ã€å‡å»ä¼˜æƒ æ€»ä»·\r\n        BigDecimal subtract = amount.subtract(getReduce());\r\n        return subtract;\r\n    }\r\n\r\n\r\n\r\n    public BigDecimal getReduce() {\r\n        return reduce;\r\n    }\r\n\r\n    public void setReduce(BigDecimal reduce) {\r\n        this.reduce = reduce;\r\n    }\r\n}\r\n```\r\n - `org.klaus.zgg01mall.cart.vo.CartItem`\r\n\r\n```java\r\n    /**\r\n     * è´­ç‰©é¡¹\r\n     * ä¾‹å¦‚ï¼š\r\n     * {\r\n     * skuId: 2131241,\r\n     * check: true,\r\n     * title: \"Apple iphone.....\",\r\n     * defaultImage: \"...\",\r\n     * price: 4999,\r\n     * count: 1,\r\n     * totalPrice: 4999,\r\n     * skuSaleVO: {...}\r\n     * }\r\n     * @author Klaus\r\n     * @date 2022/9/19\r\n     */\r\n    \r\n    public class CartItem {\r\n    \r\n        private Long skuId;\r\n        private Boolean check = true;\r\n        private String title;\r\n        private String image;\r\n        private List<String> skuAttrs;\r\n        private BigDecimal price;\r\n        private Integer count;\r\n        private BigDecimal totalPrice;\r\n    \r\n    \t....\r\n    \r\n        /**\r\n         * è®¡ç®—å½“å‰é¡¹æ€»ä»·\r\n         * @return\r\n         */\r\n        public BigDecimal getTotalPrice() {\r\n            return this.price.multiply(new BigDecimal(\"\" + this.count));\r\n        }\r\n    \r\n        public void setTotalPrice(BigDecimal totalPrice) {\r\n            this.totalPrice = totalPrice;\r\n        }\r\n    }\r\n```\r\n- æ·»åŠ è´­ç‰©è½¦æ–¹æ³•å®ç°`org.klaus.zgg01mall.cart.service.impl.CartServiceImpl#addToCart`\r\n  - å¯¹è´­ç‰©è½¦è¿›è¡ŒRedisçš„hashç»‘å®šæ“ä½œ`Map<String, List<String>>`\r\n\r\n|   key=String   |    value=`List<String>`    |\r\n| :------------: | :------------------------: |\r\n| userId/userKey | cart=`Map<skuId,cartItem>` |\r\n| userId/userKey | cart=`Map<skuId,cartItem>` |\r\n| userId/userKey | cart=`Map<skuId,cartItem>` |\r\n\r\n\r\n\r\n ```java\r\n  /**\r\n   * ç¬¬ä¸€å±‚ Mapï¼Œ Key æ˜¯ç”¨æˆ· id\r\n   * ç¬¬äºŒå±‚ Mapï¼Œ Key æ˜¯è´­ç‰©è½¦ä¸­å•†å“ idï¼Œ å€¼æ˜¯è´­ç‰©é¡¹æ•°æ®\r\n   * å°†å•†å“æ·»åŠ åˆ°è´­ç‰©è½¦\r\n   *\r\n   * @param skuId\r\n   * @param num\r\n   * @return\r\n   */\r\n  @Override\r\n  public CartItem addToCart(Long skuId, Integer num) throws ExecutionException, InterruptedException {\r\n      //æ“ä½œè´­ç‰©è½¦\r\n      BoundHashOperations<String, Object, Object> cartOps = getCartOps();\r\n  \r\n  \r\n      String res = (String) cartOps.get(skuId.toString());\r\n      if (StringUtils.isEmpty(res)) {\r\n          //è´­ç‰©è½¦æ²¡æœ‰è¿™ä¸ªå•†å“æ‰§è¡Œä»¥ä¸‹ä»£ç \r\n          //2ã€æ·»åŠ æ–°å•†å“åˆ°è´­ç‰©è½¦\r\n          CartItem cartItem = new CartItem();\r\n          CompletableFuture<Void> getSkuInfoTask = CompletableFuture.runAsync(() -> {\r\n              //1ã€è¿œç¨‹æŸ¥è¯¢å½“å‰è¦æ·»åŠ çš„å•†å“çš„ä¿¡æ¯\r\n              R r = productFeignService.getSkuInfo(skuId);\r\n              SkuInfoVo data = r.getData(\"skuInfo\", new TypeReference<SkuInfoVo>() {\r\n              });\r\n  \r\n              cartItem.setCheck(true);\r\n              cartItem.setCount(num);\r\n              cartItem.setImage(data.getSkuDefaultImg());\r\n              cartItem.setTitle(data.getSkuTitle());\r\n              cartItem.setSkuId(skuId);\r\n              cartItem.setPrice(data.getPrice());\r\n          }, executor);\r\n  \r\n          //3ã€è¿œç¨‹æŸ¥è¯¢skuçš„ç»„åˆä¿¡æ¯\r\n          CompletableFuture<Void> getSkuSaleAttrValues = CompletableFuture.runAsync(() -> {\r\n              List<String> values = productFeignService.getSkuSaleAttrValues(skuId);\r\n              cartItem.setSkuAttrs(values);\r\n          }, executor);\r\n  \r\n          //å¼‚æ­¥å…¨éƒ¨å®Œæˆæ‰åŠ å…¥ç¼“å­˜\r\n          CompletableFuture.allOf(getSkuInfoTask, getSkuSaleAttrValues).get();\r\n          String s = JSON.toJSONString(cartItem);\r\n          //åŠ å…¥ç¼“å­˜ï¼ŒskuId cartItem\r\n          cartOps.put(skuId.toString(), s);\r\n          return cartItem;\r\n      } else {\r\n          //è´­ç‰©è½¦æœ‰æ­¤å•†å“ï¼Œè¿›è¡Œæ•°é‡ä¿®æ”¹\r\n          CartItem cartItem = JSON.parseObject(res, CartItem.class);\r\n          //å½“å‰æ“ä½œä»…ä¿®æ”¹äº†é€†è½¬å›æ¥çš„æ•°æ®ï¼Œè¿˜éœ€è¦æ›´æ–°redis\r\n          cartItem.setCount(cartItem.getCount() + num);\r\n          //å†å°†ä¿®æ”¹åçš„æ•°æ®è½¬ä¸ºjsonå¹¶å­˜å…¥redis\r\n          cartOps.put(skuId.toString(), JSON.toJSONString(cartItem));\r\n          return cartItem;\r\n      }\r\n  \r\n  \r\n  }\r\n ```\r\n - hashç»‘å®šæ–¹æ³•ï¼Œé€šè¿‡StringRedisTemplateå°†cartKey=gulimall:cart:userId/userKeyä¸hashè¿›è¡Œç»‘å®šæ“ä½œ\r\n```java\r\n/**\r\n   * è·å–åˆ°æˆ‘ä»¬è¦æ“ä½œçš„è´­ç‰©è½¦\r\n   *\r\n   * @return\r\n   */\r\n  private BoundHashOperations<String, Object, Object> getCartOps() {\r\n      UserInfoTo userInfoTo = CartInterceptor.threadLocal.get();\r\n      //1ã€åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•äº†\r\n      String cartKey = \"\";\r\n      if (userInfoTo.getUserId() != null) {\r\n          //ç”¨æˆ·ç™»å½•äº†\r\n          cartKey = CART_PREFIX + userInfoTo.getUserId();\r\n      } else {\r\n          //ç”¨æˆ·æ²¡ç™»å½•\r\n          cartKey = CART_PREFIX + userInfoTo.getUserKey();\r\n      }\r\n  \r\n      //å°†è´­ç‰©è½¦åŠ å…¥ç¼“å­˜ç»‘å®šæ“ä½œï¼ˆhashï¼‰\r\n      BoundHashOperations<String, Object, Object> operations = redisTemplate.boundHashOps(cartKey);\r\n      return operations;\r\n  }\r\n```\r\n> æ·»åŠ è´­ç‰©è½¦æ—¶ç”±String res = (String) cartOps.get(skuId.toString());åˆ¤æ–­æŒ‡å®šå•†å“æ˜¯å¦åŠ å…¥äº†è´­ç‰©è½¦ï¼Œæ²¡æœ‰å°±è¿›è¡Œæ·»åŠ è´­ç‰©è½¦æ“ä½œï¼Œå¼‚æ­¥å…¨éƒ¨å®Œæˆå°è£…è´­ç‰©é¡¹çš„ä¿¡æ¯åæ‰åŠ å…¥ç¼“å­˜ï¼Œå°†è´­ç‰©é¡¹è½¬ä¸ºJsonå½¢å¼å­˜å…¥hashä¸­->String s = JSON.toJSONString(cartItem);cartOps.put(skuId.toString(), s);      è´­ç‰©è½¦æœ‰æ­¤å•†å“åˆ™è¿›è¡Œæ·»åŠ æ“ä½œï¼Œå°†ç¼“å­˜ä¸­çš„Jsonæ•°æ®è½¬ä¸ºè´­ç‰©é¡¹å¯¹è±¡è¿›è¡Œæ·»åŠ æ“ä½œï¼Œæ·»åŠ å®Œå†è½¬å›Jsonå¹¶å­˜å…¥hashä¸­\r\n\r\n\r\n\r\n### 3ã€è´­ç‰©è½¦åˆ—è¡¨\r\n\r\n- è´­ç‰©è½¦åˆ—è¡¨æ¥å£`org.klaus.zgg01mall.cart.controller.CartController#cartListPage`\r\n\r\n```java\r\n/**\r\n     * æµè§ˆå™¨æœ‰ä¸€ä¸ªcookieï¼šuser-keyï¼šæ ‡è¯†ç”¨æˆ·èº«ä»½ï¼Œä¸€ä¸ªæœˆåè¿‡æœŸ\r\n     * å¦‚æœç¬¬ä¸€æ¬¡ä½¿ç”¨jdçš„è´­ç‰©è½¦åŠŸèƒ½ï¼Œéƒ½ä¼šç»™ä¸€ä¸ªä¸´æ—¶çš„ç”¨æˆ·èº«ä»½\r\n     * æµè§ˆå™¨ä»¥åä¿å­˜ï¼Œæ¯æ¬¡è®¿é—®éƒ½ä¼šå¸¦ä¸Šè¿™ä¸ªcookieï¼›\r\n     *\r\n     * ç™»å½•ï¼šsessionæœ‰\r\n     * æ²¡ç™»å½•ï¼ŒæŒ‰ç…§cookieé‡Œé¢å¸¦æ¥user-keyæ¥åš\r\n     * ç¬¬ä¸€æ¬¡ï¼Œå¦‚æœæ²¡æœ‰ä¸´æ—¶ç”¨æˆ·ï¼Œä¼šå¸®å¿™åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç”¨æˆ·ã€‚\r\n     * @return\r\n     */\r\n    @GetMapping(\"/cart.html\")\r\n    public String cartListPage(Model model) throws ExecutionException, InterruptedException {\r\n\r\n        //1ã€å¿«é€Ÿå¾—åˆ°ç”¨æˆ·ä¿¡æ¯ï¼šidï¼Œuser-key\r\n//        UserInfoTo userInfoTo = CartInterceptor.threadLocal.get();\r\n//        System.out.println(userInfoTo);\r\n\r\n        Cart cart = cartService.getCart();\r\n        model.addAttribute(\"cart\", cart);\r\n        return \"cartList\";\r\n    }\r\n```\r\n- è·å–æ•´ä¸ªè´­ç‰©è½¦æ–¹æ³•å®ç°`org.klaus.zgg01mall.cart.service.impl.CartServiceImpl#getCart`\r\n\r\n```java\r\n/**\r\n * è·å–æ•´ä¸ªè´­ç‰©è½¦\r\n *\r\n * @return\r\n */\r\n@Override\r\npublic Cart getCart() throws ExecutionException, InterruptedException {\r\n    Cart cart = new Cart();\r\n    UserInfoTo userInfoTo = CartInterceptor.threadLocal.get();\r\n    if (userInfoTo.getUserId() != null) {\r\n        //1ã€ç™»å½•\r\n        String cartKey = CART_PREFIX + userInfoTo.getUserId();\r\n        //1.1ã€å¦‚æœä¸´æ—¶è´­ç‰©è½¦çš„æ•°æ®è¿˜æ²¡æœ‰åˆå¹¶ã€åˆå¹¶è´­ç‰©è½¦ã€‘\r\n        //ä¸´æ—¶è´­ç‰©è½¦çš„æ‰€æœ‰è´­ç‰©é¡¹\r\n        String tempCartKey = CART_PREFIX + userInfoTo.getUserKey();\r\n        List<CartItem> tempCartItems = getCartItems(tempCartKey);\r\n        if (tempCartItems != null) {\r\n            //ä¸´æ—¶è´­ç‰©è½¦æœ‰æ•°æ®ï¼Œéœ€è¦åˆå¹¶\r\n            for (CartItem item : tempCartItems) {\r\n                addToCart(item.getSkuId(), item.getCount());\r\n            }\r\n            //åˆå¹¶å®Œåæ¸…é™¤ä¸´æ—¶è´­ç‰©è½¦çš„æ•°æ®\r\n            clearCart(tempCartKey);\r\n        }\r\n        //3ã€è·å–ç™»å½•åçš„è´­ç‰©è½¦æ•°æ®ã€åŒ…å«åˆå¹¶è¿‡æ¥çš„ä¸´æ—¶è´­ç‰©è½¦çš„æ•°æ®ï¼Œå’Œç™»å½•åçš„è´­ç‰©è½¦æ•°æ®ã€‘\r\n        List<CartItem> cartItems = getCartItems(cartKey);\r\n        cart.setItems(cartItems);\r\n\r\n    } else {\r\n        //2ã€æ²¡ç™»å½•\r\n        String cartKey = CART_PREFIX + userInfoTo.getUserKey();\r\n        //è·å–ä¸´æ—¶è´­ç‰©è½¦çš„æ‰€æœ‰è´­ç‰©é¡¹\r\n        List<CartItem> cartItems = getCartItems(cartKey);\r\n        cart.setItems(cartItems);\r\n\r\n    }\r\n    return cart;\r\n}\r\n```\r\n- è·å–æ‰€æœ‰è´­ç‰©é¡¹æ–¹æ³•`org.klaus.zgg01mall.cart.service.impl.CartServiceImpl#getCartItems`\r\n  - è·å–è´­ç‰©é¡¹å†æ¬¡è¿›è¡Œhashç»‘å®šæ“ä½œï¼Œå› ä¸ºä¹‹å‰å·²ç»ç»‘å®šè¿‡ä¸€æ¬¡ï¼Œå¦‚æœæ·»åŠ è¿‡è´­ç‰©è½¦ï¼Œç¼“å­˜ä¸­æ˜¯æœ‰æ•°æ®çš„ï¼Œç›´æ¥éå†ç¼“å­˜ä¸­çš„Jsonæ•°æ®å¹¶è½¬ä¸ºè´­ç‰©é¡¹å¯¹è±¡è¿”å›å‡ºå»ï¼Œè‹¥æ²¡æœ‰åˆ™è¿”å›null\r\n\r\n```java\r\nprivate List<CartItem> getCartItems(String cartKey) {\r\n    BoundHashOperations<String, Object, Object> hashOps = redisTemplate.boundHashOps(cartKey);\r\n    List<Object> values = hashOps.values();\r\n    if (values != null && values.size() > 0) {\r\n        List<CartItem> collect = values.stream().map((obj) -> {\r\n            String str = (String) obj;\r\n            CartItem cartItem = JSON.parseObject(str, CartItem.class);\r\n            return cartItem;\r\n        }).collect(Collectors.toList());\r\n        return collect;\r\n    }\r\n    return null;\r\n}\r\n```\r\n\r\n### 4ã€æ·»åŠ è´­ç‰©è½¦æˆåŠŸé¡µ\r\n\r\n- æ·»åŠ è´­ç‰©è½¦æˆåŠŸé¡µæ¥å£`org.klaus.zgg01mall.cart.controller.CartController#addToCartSuccessPage`\r\n\r\n```java\r\n/**\r\n * è·³è½¬åˆ°æˆåŠŸé¡µï¼Œå¢åŠ è´­ç‰©è½¦ç”¨åˆ°2ä¸ªé¡µé¢ï¼Œé˜²æ­¢åœ¨æ·»åŠ è´­ç‰©è½¦ä¹‹åå†åˆ·æ–°é¡µé¢æ—¶è‡ªåŠ¨å¢åŠ \r\n * @param skuId\r\n * @param model\r\n * @return\r\n */\r\n@GetMapping(\"/addToCartSuccess.html\")\r\npublic String addToCartSuccessPage(@RequestParam(\"skuId\")Long skuId, Model model){\r\n    //é‡å®šå‘åˆ°æˆåŠŸé¡µé¢ï¼Œå†æ¬¡æŸ¥è¯¢è´­ç‰©è½¦æ•°æ®å³å¯\r\n    CartItem item = cartService.getCartItem(skuId);\r\n    model.addAttribute(\"item\", item);\r\n    return \"success\";\r\n}\r\n```\r\n\r\n- è·å–è´­ç‰©é¡¹æ–¹æ³•å®ç°`org.klaus.zgg01mall.cart.service.impl.CartServiceImpl#getCartItem`\r\n  - è·å–hashæ“ä½œå¹¶æ‹¿åˆ°æŒ‡å®šskuIdçš„è´­ç‰©é¡¹Jsonï¼Œç„¶åè½¬ä¸ºå¯¹è±¡è¿”å›å‡ºå»\r\n\r\n```java\r\n/**\r\n * è·å–è´­ç‰©è½¦ä¸­æŸä¸ªè´­ç‰©é¡¹\r\n *\r\n * @param skuId\r\n * @return\r\n */\r\n@Override\r\npublic CartItem getCartItem(Long skuId) {\r\n    BoundHashOperations<String, Object, Object> cartOps = getCartOps();\r\n    String str = (String) cartOps.get(skuId.toString());\r\n    //å°†ç¼“å­˜ä¸­çš„æ•°æ®è½¬ä¸ºvoå¯¹è±¡\r\n    CartItem cartItem = JSON.parseObject(str, CartItem.class);\r\n    return cartItem;\r\n}\r\n```\r\n\r\n### 5ã€åˆ é™¤è´­ç‰©é¡¹\r\n\r\n- åˆ é™¤è´­ç‰©é¡¹æ¥å£\r\n\r\n```java\r\n@GetMapping(\"/deleteItem\")\r\npublic String deleteItem(@RequestParam(\"skuId\") Long skuId){\r\n    cartService.deleteItem(skuId);\r\n    return \"redirect:http://cart.gulimall.com/cart.html\";\r\n}\r\n```\r\n\r\n- åˆ é™¤è´­ç‰©é¡¹æ–¹æ³•å®ç°\r\n  - é€šè¿‡hashæ“ä½œåˆ é™¤æŒ‡å®šskuIdçš„è´­ç‰©é¡¹\r\n\r\n```java\r\n/**\r\n * åˆ é™¤è´­ç‰©é¡¹\r\n *\r\n * @param skuId\r\n */\r\n@Override\r\npublic void deleteItem(Long skuId) {\r\n    BoundHashOperations<String, Object, Object> cartOps = getCartOps();\r\n    //åˆ é™¤æŒ‡å®šé”®\r\n    cartOps.delete(skuId.toString());\r\n}\r\n```\r\n\r\n### 6ã€æ”¹å˜è´­ç‰©é¡¹æ•°é‡\r\n\r\n- æ”¹å˜è´­ç‰©é¡¹æ•°é‡æ¥å£\r\n\r\n```java\r\n@GetMapping(\"/countItem\")\r\npublic String countItem(@RequestParam(\"skuId\") Long skuId,\r\n                        @RequestParam(\"num\") Integer num){\r\n    cartService.changeItemCount(skuId, num);\r\n    return \"redirect:http://cart.gulimall.com/cart.html\";\r\n}\r\n```\r\n\r\n- æ”¹å˜è´­ç‰©é¡¹æ•°é‡æ–¹æ³•å®ç°\r\n  - æ”¹å˜æ•°é‡åé€šè¿‡hashæ“ä½œå°†å¯¹è±¡è½¬ä¸ºJsonå¹¶å­˜å…¥hash\r\n\r\n```java\r\n/**\r\n * ä¿®æ”¹è´­ç‰©é¡¹æ•°é‡\r\n *\r\n * @param skuId\r\n * @param num\r\n */\r\n@Override\r\npublic void changeItemCount(Long skuId, Integer num) {\r\n    CartItem cartItem = getCartItem(skuId);\r\n    cartItem.setCount(num);\r\n\r\n    BoundHashOperations<String, Object, Object> cartOps = getCartOps();\r\n    cartOps.put(skuId.toString(), JSON.toJSONString(cartItem));\r\n}\r\n```\r\n\r\n### 7ã€é€‰ä¸­è´­ç‰©é¡¹\r\n\r\n- é€‰ä¸­è´­ç‰©é¡¹æ¥å£\r\n\r\n```java\r\n@GetMapping(\"/checkItem\")\r\npublic String checkItem(@RequestParam(\"skuId\") Long skuId,\r\n                        @RequestParam(\"check\") Integer check){\r\n\r\n    cartService.checkItem(skuId, check);\r\n    return \"redirect:http://cart.gulimall.com/cart.html\";\r\n}\r\n```\r\n\r\n- é€‰ä¸­è´­ç‰©é¡¹æ–¹æ³•å®ç°\r\n  - æ”¹å˜è´­ç‰©é¡¹çš„é€‰ä¸­çŠ¶æ€åé€šè¿‡hashæ“ä½œå°†å¯¹è±¡è½¬ä¸ºJsonå¹¶å­˜å…¥hash\r\n\r\n```java\r\n/**\r\n * å‹¾é€‰è´­ç‰©é¡¹\r\n *\r\n * @param skuId\r\n * @param check\r\n */\r\n@Override\r\npublic void checkItem(Long skuId, Integer check) {\r\n\r\n    BoundHashOperations<String, Object, Object> cartOps = getCartOps();\r\n    CartItem cartItem = getCartItem(skuId);\r\n    cartItem.setCheck(check == 1 ? true : false);\r\n\r\n    //å°†voå¯¹è±¡è½¬ä¸ºjsonåºåˆ—åŒ–çš„æ–‡æœ¬\r\n    String s = JSON.toJSONString(cartItem);\r\n    cartOps.put(skuId.toString(), s);\r\n}\r\n```\r\n\r\n### 8ã€è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è´­ç‰©é¡¹åˆ—è¡¨\r\n\r\n- è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è´­ç‰©é¡¹åˆ—è¡¨æ¥å£ï¼ˆ**æ­¤æ¥å£æ˜¯ç»™è®¢å•æœåŠ¡è¿œç¨‹è°ƒç”¨çš„**ï¼‰\r\n\r\n```java\r\n/**\r\n * ä¸æ˜¯é¡µé¢è·³è½¬éœ€åŠ @ResponseBody\r\n * @return\r\n */\r\n@GetMapping(\"/currentUserCartItems\")\r\n@ResponseBody\r\npublic List<CartItem> currentUserCartItems(){\r\n\r\n\r\n    return cartService.getUserCartItems();\r\n}\r\n```\r\n\r\n- è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è´­ç‰©é¡¹åˆ—è¡¨æ–¹æ³•å®ç°\r\n\r\n```java\r\n/**\r\n     * è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰è´­ç‰©é¡¹\r\n     *\r\n     * @return\r\n     */\r\n    @Override\r\n    public List<CartItem> getUserCartItems() {\r\n        UserInfoTo userInfoTo = CartInterceptor.threadLocal.get();\r\n        if (userInfoTo.getUserId() == null){\r\n            //æ²¡ç™»å½•\r\n            return null;\r\n        }else {\r\n            //ç™»å½•äº†\r\n            String cartKey = CART_PREFIX + userInfoTo.getUserId();\r\n            List<CartItem> cartItems = getCartItems(cartKey);\r\n            //åªè¦é€‰ä¸­äº†çš„è´­ç‰©é¡¹\r\n            List<CartItem> collect = cartItems.stream().filter(item ->\r\n                item.getCheck()//é»˜è®¤æ˜¯true\r\n            ).map(item->{\r\n//                R price = productFeignService.getPrice(item.getSkuId());\r\n                BigDecimal price = productFeignService.getPrice(item.getSkuId());\r\n                //todo æ›´æ–°ä¸ºæœ€æ–°çš„ä»·æ ¼\r\n//                String data = (String) price.get(\"data\");\r\n//                item.setPrice(new BigDecimal(data));\r\n                item.setPrice(price);\r\n                return item;\r\n            }).collect(Collectors.toList());\r\n            return collect;\r\n        }\r\n    }\r\n```\r\n\r\n## â…¡.è§£å†³åˆ†å¸ƒå¼ä¸‹sessionå…±äº«é—®é¢˜\r\n\r\n### 1ã€sessionåŸç†\r\n\r\n![image-20230410195022298](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195022298.png)\r\n\r\n### 2ã€åˆ†å¸ƒå¼ä¸‹sessionå…±äº«é—®é¢˜\r\n\r\n![image-20230410195051946](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195051946.png)\r\n\r\n\r\n\r\n### 3ã€è§£å†³ - sessionå¤åˆ¶\r\n\r\n![image-20230410195126743](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195126743.png)\r\n\r\n\r\n\r\n- ä¼˜ç‚¹\r\n  - web-serverï¼ˆTomcatï¼‰åŸç”Ÿæ”¯æŒï¼Œåªéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶\r\n- ç¼ºç‚¹\r\n  - sessionåŒæ­¥éœ€è¦æ•°æ®ä¼ è¾“ï¼Œå ç”¨å¤§é‡ç½‘ç»œå¸¦å®½ï¼Œé™ä½äº†æœåŠ¡å™¨ç¾¤çš„ä¸šåŠ¡å¤„ç†èƒ½åŠ›\r\n  - ä»»æ„ä¸€å°web-serverä¿å­˜çš„æ•°æ®éƒ½æ˜¯æ‰€æœ‰web-serverçš„sessionæ€»å’Œï¼Œå—åˆ°å†…å­˜é™åˆ¶æ— æ³•æ°´å¹³æ‰©å±•æ›´å¤šçš„web-server\r\n  - å¤§å‹åˆ†å¸ƒå¼é›†ç¾¤æƒ…å†µä¸‹ï¼Œç”±äºæ‰€æœ‰web-serveréƒ½å…¨é‡ä¿å­˜æ•°æ®ï¼Œæ‰€ä»¥æ­¤æ–¹æ¡ˆä¸å¯å–ã€‚\r\n\r\n\r\n\r\n### 4ã€è§£å†³ - å®¢æˆ·ç«¯å­˜å‚¨\r\n\r\n![image-20230410195314820](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195314820.png)\r\n\r\n\r\n\r\n- ä¼˜ç‚¹\r\n  - æœåŠ¡å™¨ä¸éœ€å­˜å‚¨sessionï¼Œç”¨æˆ·ä¿å­˜è‡ªå·±çš„sessionä¿¡æ¯åˆ°cookieä¸­ã€‚èŠ‚çœæœåŠ¡ç«¯èµ„æº\r\n\r\n- ç¼ºç‚¹\r\n  - éƒ½æ˜¯ç¼ºç‚¹ï¼Œè¿™åªæ˜¯ä¸€ç§æ€è·¯ã€‚\r\n  - å…·ä½“å¦‚ä¸‹ï¼š\r\n    - æ¯æ¬¡httpè¯·æ±‚ï¼Œæºå¸¦ç”¨æˆ·åœ¨cookieä¸­çš„å®Œæ•´ä¿¡æ¯ï¼Œæµªè´¹ç½‘ç»œå¸¦å®½\r\n    - sessionæ•°æ®æ”¾åœ¨cookieä¸­ï¼Œcookieæœ‰é•¿åº¦é™åˆ¶4Kï¼Œä¸èƒ½ä¿å­˜å¤§é‡ä¿¡æ¯\r\n    - sessionæ•°æ®æ”¾åœ¨cookieä¸­ï¼Œå­˜åœ¨æ³„æ¼ã€ç¯¡æ”¹ã€çªƒå–ç­‰å®‰å…¨éšæ‚£\r\n- è¿™ç§æ–¹å¼ä¸ä¼šä½¿ç”¨ã€‚\r\n\r\n\r\n\r\n### 5ã€è§£å†³ - hashä¸€è‡´æ€§\r\n\r\n![image-20230410195638892](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195638892.png)\r\n\r\n\r\n\r\n- ä¼˜ç‚¹ï¼š\r\n  - åªéœ€è¦æ”¹nginxé…ç½®ï¼Œä¸éœ€è¦ä¿®æ”¹åº”ç”¨ä»£ç \r\n  - è´Ÿè½½å‡è¡¡ï¼Œåªè¦hashå±æ€§çš„å€¼åˆ†å¸ƒæ˜¯å‡åŒ€çš„ï¼Œå¤šå°web-serverçš„è´Ÿè½½æ˜¯å‡è¡¡çš„\r\n  - å¯ä»¥æ”¯æŒweb-serveræ°´å¹³æ‰©å±•ï¼ˆsessionåŒæ­¥æ³•æ˜¯ä¸è¡Œçš„ï¼Œå—å†…å­˜é™åˆ¶ï¼‰\r\n- ç¼ºç‚¹\r\n  - sessionè¿˜æ˜¯å­˜åœ¨web-serverä¸­çš„ï¼Œæ‰€ä»¥web-serveré‡å¯å¯èƒ½å¯¼è‡´éƒ¨åˆ†sessionä¸¢å¤±ï¼Œå½±å“ä¸šåŠ¡ï¼Œå¦‚éƒ¨åˆ†ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•\r\n  - å¦‚æœweb-serveræ°´å¹³æ‰©å±•ï¼Œrehashåsessioné‡æ–°åˆ†å¸ƒï¼Œä¹Ÿä¼šæœ‰ä¸€éƒ¨åˆ†ç”¨æˆ·è·¯ç”±ä¸åˆ°æ­£ç¡®çš„session\r\n- ä½†æ˜¯ä»¥ä¸Šç¼ºç‚¹é—®é¢˜ä¹Ÿä¸æ˜¯å¾ˆå¤§ï¼Œå› ä¸ºsessionæœ¬æ¥éƒ½æ˜¯æœ‰æœ‰æ•ˆæœŸçš„ã€‚æ‰€ä»¥è¿™ä¸¤ç§åå‘ä»£ç†çš„æ–¹å¼å¯ä»¥ä½¿ç”¨\r\n\r\n\r\n\r\n### 6ã€è§£å†³ - ç»Ÿä¸€å­˜å‚¨\r\n\r\n![image-20230410195856602](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195856602.png)\r\n\r\n\r\n\r\n- ä¼˜ç‚¹ï¼š\r\n  - æ²¡æœ‰å®‰å…¨éšæ‚£\r\n  - å¯ä»¥æ°´å¹³æ‰©å±•ï¼Œæ•°æ®åº“/ç¼“å­˜æ°´å¹³åˆ‡åˆ†å³å¯\r\n  - web-serveré‡å¯æˆ–è€…æ‰©å®¹éƒ½ä¸ä¼šæœ‰sessionä¸¢å¤±\r\n- ä¸è¶³\r\n  - å¢åŠ äº†ä¸€æ¬¡ç½‘ç»œè°ƒç”¨ï¼Œå¹¶ä¸”éœ€è¦ä¿®æ”¹åº”ç”¨ä»£ç ï¼›å¦‚å°†æ‰€æœ‰çš„getSessionæ–¹æ³•æ›¿æ¢ä¸ºä»RedisæŸ¥æ•°æ®çš„æ–¹å¼ã€‚redisè·å–æ•°æ®æ¯”å†…å­˜æ…¢å¾ˆå¤š\r\n  - ä¸Šé¢ç¼ºç‚¹å¯ä»¥ç”¨SpringSessionå®Œç¾è§£å†³\r\n\r\n\r\n\r\n\r\n\r\n### 7ã€è§£å†³ - ä¸åŒæœåŠ¡ï¼Œå­åŸŸsessionå…±äº«\r\n\r\n> jsessionidè¿™ä¸ªcookieé»˜è®¤æ˜¯å½“å‰ç³»ç»ŸåŸŸåçš„ã€‚å½“æˆ‘ä»¬åˆ†æ‹†æœåŠ¡ï¼Œä¸åŒåŸŸåéƒ¨ç½²çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨\r\n> å¦‚ä¸‹è§£å†³æ–¹æ¡ˆï¼›\r\n\r\n![image-20230410200123345](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410200123345.png)\r\n\r\n\r\n\r\n\r\n\r\n### 8ã€SpringSessionæ ¸å¿ƒåŸç†\r\n\r\n![image-20230410200156413](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410200156413.png)\r\n\r\n### 9ã€åº”ç”¨\r\n\r\n```java\r\n/**\r\n * æ ¸å¿ƒåŸç†\r\n * 1ã€@EnableRedisHttpSessionå¯¼å…¥RedisHttpSessionConfigurationé…ç½®\r\n *      1ï¼‰ã€ç»™å®¹å™¨ä¸­æ·»åŠ äº†ä¸€ä¸ªç»„ä»¶\r\n *          ä¼ å…¥SessionRepository==ã€‹ã€RedisOperationsSessionRepositoryã€‘===ã€‹redisæ“ä½œsessionï¼Œsessionçš„å¢åˆ æ”¹æŸ¥å°è£…ç±»\r\n *      2ï¼‰ã€SessionRepositoryFilter==ã€‹Filter(web)ï¼šsessionå­˜å‚¨è¿‡æ»¤å™¨ï¼›æ¯ä¸ªè¯·æ±‚è¿‡æ¥éƒ½å¿…é¡»ç»è¿‡Filter\r\n *         Iï¼‰ã€åˆ›å»ºçš„æ—¶å€™ï¼Œå°±è‡ªåŠ¨ä»å®¹å™¨ä¸­è·å–äº†SessionRepository\r\n *         IIï¼‰ã€åŸå§‹çš„HttpServletRequest request, HttpServletResponse responseéƒ½è¢«åˆ†åˆ«åŒ…è£…æˆäº†SessionRepositoryRequestWrapperï¼ŒSessionRepositoryResponseWrapper\r\n *         IIIï¼‰ã€ä»¥åè·å–session-ã€‹request.getSession();ï¼ˆåŸå§‹çš„ï¼‰\r\n *         //SessionRepositoryRequestWrapperé‡å†™getSessionæ–¹æ³•\r\n *         IVï¼‰ã€wrapperRequest.getSession();==> SessionRepositoryä¸­è·å–çš„åˆ°\r\n *  è£…é¥°è€…æ¨¡å¼ï¼›\r\n *\r\n *  è‡ªåŠ¨å»¶æœŸï¼›redisä¸­çš„æ•°æ®ä¹Ÿæ˜¯æœ‰è¿‡æœŸæ—¶é—´çš„\r\n */\r\n@EnableRedisHttpSession //æ•´åˆredisä½œä¸ºsessionå­˜å‚¨\r\n```\r\n\r\n- å¯¼å…¥ç›¸å…³ä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n  <groupId>org.springframework.boot</groupId>\r\n  <artifactId>spring-boot-starter-data-redis</artifactId>\r\n</dependency>\r\n\r\n<!--æ•´åˆSpringsessionå®Œæˆsessionå…±äº«é—®é¢˜-->\r\n<dependency>\r\n  <groupId>org.springframework.session</groupId>\r\n  <artifactId>spring-session-data-redis</artifactId>\r\n</dependency>\r\n```\r\n\r\n- SpringBootApplicationç±»åŠ ä¸Šæ³¨è§£@EnableRedisHttpSessionå¼€å¯SpringSession\r\n- é…ç½®æ–‡ä»¶æ·»åŠ ç›¸å…³é…ç½®\r\n\r\n```properties\r\nspring.redis.host=192.168.10.103\r\nspring.redis.port=6379\r\nspring.session.store-type=REDIS\r\n```\r\n\r\n- æ·»åŠ é…ç½®ç±»é…ç½®å­åŸŸsessionå…±äº«\r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2022/9/17\r\n */\r\n@Configuration\r\npublic class GulimallSessionConfig {\r\n\r\n    @Bean\r\n    public CookieSerializer cookieSerializer(){\r\n        DefaultCookieSerializer cookieSerializer = new DefaultCookieSerializer();\r\n\r\n        cookieSerializer.setDomainName(\"gulimall.com\");\r\n        cookieSerializer.setCookieName(\"KLAUSSESSION\");\r\n        return cookieSerializer;\r\n    }\r\n\r\n    @Bean\r\n    public RedisSerializer<Object> springSessionDefaultRedisSerializer() {\r\n        return new GenericJackson2JsonRedisSerializer();\r\n    }\r\n}\r\n```\r\n\r\n> ä½¿ç”¨sessionå…±äº«çš„ç›®çš„æ˜¯è®©éœ€è¦ç”¨åˆ°ç™»å½•sessionçš„é¡µé¢éƒ½èƒ½å…±äº«åˆ°åŒä¸€ä¸ªsession\r\n\r\n## â…¢.å•†å“ç³»ç»Ÿç¼“å­˜æ‰€æœ‰åˆ†ç±»\r\n\r\n### ä¸€ã€ç¼“å­˜\r\n\r\n#### æœ¬åœ°ç¼“å­˜\r\n\r\n![image-20230410191857648](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191857648.png)\r\n\r\n```java\r\n//æœ¬åœ°ç¼“å­˜å¯ä»¥ä½¿ç”¨map\r\nprivate Map<String, Object> cache;\r\n```\r\n\r\n#### 1ã€ç¼“å­˜ä½¿ç”¨\r\n\r\n- ä¸ºäº†ç³»ç»Ÿæ€§èƒ½çš„æå‡ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šå°†éƒ¨åˆ†æ•°æ®æ”¾å…¥ç¼“å­˜ä¸­ï¼ŒåŠ é€Ÿè®¿é—®ã€‚è€Œ db æ‰¿æ‹…æ•°æ®è½ç›˜å·¥ä½œã€‚\r\n\r\n  **å“ªäº›æ•°æ®é€‚åˆæ”¾å…¥ç¼“å­˜ï¼Ÿ**\r\n\r\n  - å³æ—¶æ€§ã€æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„\r\n  - è®¿é—®é‡å¤§ä¸”æ›´æ–°é¢‘ç‡ä¸é«˜çš„æ•°æ®ï¼ˆè¯»å¤šï¼Œå†™å°‘ï¼‰\r\n\r\n- ä¸¾ä¾‹ï¼šç”µå•†ç±»åº”ç”¨ï¼Œå•†å“åˆ†ç±»ï¼Œå•†å“åˆ—è¡¨ç­‰é€‚åˆç¼“å­˜å¹¶åŠ ä¸€ä¸ªå¤±æ•ˆæ—¶é—´(æ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡æ¥å®š)ï¼Œåå°å¦‚æœå‘å¸ƒä¸€ä¸ªå•†å“ï¼Œä¹°å®¶éœ€è¦ 5 åˆ†é’Ÿæ‰èƒ½çœ‹åˆ°æ–°çš„å•†å“ä¸€èˆ¬è¿˜æ˜¯å¯ä»¥æ¥å—çš„ã€‚\r\n\r\n![image-20230425213252713](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230425213252713.png)\r\n\r\n```javascript\r\ndata = cache.load(id);//ä»ç¼“å­˜åŠ è½½æ•°æ®\r\nIf(data == null){\r\ndata = db.load(id);//ä»æ•°æ®åº“åŠ è½½æ•°æ®\r\ncache.put(id,data);//ä¿å­˜åˆ° cache ä¸­\r\n}\r\nreturn data;\r\n```\r\n\r\n> æ³¨æ„ï¼šåœ¨å¼€å‘ä¸­ï¼Œå‡¡æ˜¯æ”¾å…¥ç¼“å­˜ä¸­çš„æ•°æ®æˆ‘ä»¬éƒ½åº”è¯¥æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼Œä½¿å…¶å¯ä»¥åœ¨ç³»ç»Ÿå³ä½¿æ²¡æœ‰ä¸»åŠ¨æ›´æ–°æ•°æ®ä¹Ÿèƒ½è‡ªåŠ¨è§¦å‘æ•°æ®åŠ è½½è¿›ç¼“å­˜çš„æµç¨‹ã€‚é¿å…ä¸šåŠ¡å´©æºƒå¯¼è‡´çš„æ•°æ®æ°¸ä¹…ä¸ä¸€è‡´é—®é¢˜ã€‚\r\n\r\n#### 2ã€æ•´åˆ redis ä½œä¸ºç¼“å­˜\r\n\r\n- 1ã€å¼•å…¥ redis-starter\r\n\r\n```xml\r\n<dependency>\r\n<groupId>org.springframework.boot</groupId>\r\n<artifactId>spring-boot-starter-data-redis</artifactId>\r\n</dependency>\r\n```\r\n\r\n- 2ã€é…ç½® redis\r\n\r\n```properties\r\nspring.redis.host=192.168.10.103\r\nspring.redis.port=6379\r\n```\r\n\r\n- 3ã€ä½¿ç”¨ RedisTemplate æ“ä½œ redis\r\n\r\n```java\r\n@Autowired\r\nStringRedisTemplate stringRedisTemplate;\r\n@Test\r\npublic void testStringRedisTemplate(){\r\nValueOperations<String, String> ops = stringRedisTemplate.opsForValue();\r\nops.set(\"hello\",\"world_\"+ UUID.randomUUID().toString());\r\nString hello = ops.get(\"hello\");\r\nSystem.out.println(hello);\r\n}\r\n```\r\n\r\n- 4ã€åˆ‡æ¢ä½¿ç”¨ jedis\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>org.springframework.boot</groupId>\r\n    <artifactId>spring-boot-starter-data-redis</artifactId>\r\n    <exclusions>\r\n        <exclusion>\r\n            <groupId>io.lettuce</groupId>\r\n            <artifactId>lettuce-core</artifactId>\r\n        </exclusion>\r\n    </exclusions>\r\n</dependency>\r\n\r\n<dependency>\r\n    <groupId>redis.clients</groupId>\r\n    <artifactId>jedis</artifactId>\r\n</dependency>\r\n```\r\n\r\n> - äº§ç”Ÿå †å¤–å†…å­˜æº¢å‡ºï¼šOutOfDirectMemoryError\r\n>   1. SpringBoot2.0ä»¥åé»˜è®¤ä½¿ç”¨lettuceä½œä¸ºæ“ä½œredisçš„å®¢æˆ·ç«¯ï¼Œå®ƒä½¿ç”¨nettyè¿›è¡Œç½‘ç»œé€šä¿¡\r\n>   2. lettuceçš„bugå¯¼è‡´nettyå †å¤–å†…å­˜æº¢å‡º  -Xmx 100mï¼›nettyå¦‚æœæ²¡æœ‰æŒ‡å®šå †å¤–å†…å­˜ï¼Œé»˜è®¤ä½¿ç”¨-Xmx 100m\r\n>      - å¯ä»¥é€šè¿‡-Di0.netty.maxDirectMemoryè¿›è¡Œè®¾ç½®\r\n>\r\n> - è§£å†³æ–¹æ¡ˆï¼šä¸èƒ½åªä½¿ç”¨-Di0.netty.maxDirectMemoryå»è°ƒå¤§å †å¤–å†…å­˜\r\n>   1. å‡çº§lettuceå®¢æˆ·ç«¯\r\n>   2. åˆ‡æ¢ä½¿ç”¨è€ç‰ˆçš„jedis\r\n> - lettuce,jedisæ“ä½œredisçš„åº•å±‚å®¢æˆ·ç«¯ï¼ŒSpringå†æ¬¡å°è£…redisTemplate\r\n\r\n### äºŒã€ç¼“å­˜å¤±æ•ˆé—®é¢˜\r\n\r\n#### åˆ†å¸ƒå¼ç¼“å­˜-æœ¬åœ°æ¨¡å¼åœ¨åˆ†å¸ƒå¼ä¸‹çš„é—®é¢˜\r\n\r\n![image-20230410191940056](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191940056.png)\r\n\r\nå…ˆæ¥è§£å†³å¤§å¹¶å‘è¯»æƒ…å†µä¸‹çš„ç¼“å­˜å¤±æ•ˆé—®é¢˜ï¼›\r\n\r\n##### 1ã€é«˜å¹¶å‘ä¸‹ç¼“å­˜å¤±æ•ˆé—®é¢˜-ç¼“å­˜ç©¿é€\r\n\r\n![image-20230410192133778](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192133778.png)\r\n\r\n- ç¼“å­˜ç©¿é€æ˜¯æŒ‡æŸ¥è¯¢ä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ï¼Œç”±äºç¼“å­˜æ˜¯ä¸å‘½ä¸­ï¼Œå°†å»æŸ¥è¯¢æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ä¹Ÿæ— æ­¤è®°å½•ï¼Œæˆ‘ä»¬æ²¡æœ‰å°†è¿™æ¬¡æŸ¥è¯¢çš„ null å†™å…¥ç¼“å­˜ï¼Œè¿™å°†å¯¼è‡´è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆ°å­˜å‚¨å±‚å»æŸ¥è¯¢ï¼Œå¤±å»äº†ç¼“å­˜çš„æ„ä¹‰ã€‚\r\n- é£é™©ï¼š\r\n  - åœ¨æµé‡å¤§æ—¶ï¼Œå¯èƒ½ DB å°±æŒ‚æ‰äº†ï¼Œè¦æ˜¯æœ‰äººåˆ©ç”¨ä¸å­˜åœ¨çš„ key é¢‘ç¹æ”»å‡»æˆ‘ä»¬çš„åº”ç”¨ï¼Œæ•°æ®åº“ç¬æ—¶å‹åŠ›å¢å¤§ï¼Œæœ€ç»ˆå¯¼è‡´å´©æºƒï¼Œè¿™å°±æ˜¯æ¼æ´ã€‚\r\n\r\n- è§£å†³ï¼š\r\n  - ç¼“å­˜ç©ºç»“æœã€å¹¶ä¸”è®¾ç½®çŸ­çš„è¿‡æœŸæ—¶é—´ã€‚\r\n\r\n##### 2ã€é«˜å¹¶å‘ä¸‹ç¼“å­˜å¤±æ•ˆé—®é¢˜-ç¼“å­˜é›ªå´©\r\n\r\n- ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨æˆ‘ä»¬è®¾ç½®ç¼“å­˜æ—¶é‡‡ç”¨äº†ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯¼è‡´ç¼“å­˜åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å¤±æ•ˆï¼Œè¯·æ±‚å…¨éƒ¨è½¬å‘åˆ° DBï¼ŒDB ç¬æ—¶å‹åŠ›è¿‡é‡é›ªå´©ã€‚\r\n\r\n- è§£å†³ï¼š\r\n  - åŸæœ‰çš„å¤±æ•ˆæ—¶é—´åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªéšæœºå€¼ï¼Œæ¯”å¦‚ 1-5 åˆ†é’Ÿéšæœºï¼Œè¿™æ ·æ¯ä¸€ä¸ªç¼“å­˜çš„è¿‡æœŸæ—¶é—´çš„é‡å¤ç‡å°±ä¼šé™ä½ï¼Œå°±å¾ˆéš¾å¼•å‘é›†ä½“å¤±æ•ˆçš„äº‹ä»¶ã€‚\r\n\r\n##### 3ã€é«˜å¹¶å‘ä¸‹ç¼“å­˜å¤±æ•ˆé—®é¢˜-ç¼“å­˜å‡»ç©¿\r\n\r\n![image-20230410192628947](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192628947.png)\r\n\r\n- å¯¹äºä¸€äº›è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ keyï¼Œå¦‚æœè¿™äº› key å¯èƒ½ä¼šåœ¨æŸäº›æ—¶é—´ç‚¹è¢«è¶…é«˜å¹¶å‘åœ°è®¿é—®ï¼Œæ˜¯ä¸€ç§éå¸¸â€œ**çƒ­ç‚¹**â€çš„æ•°æ®ã€‚\r\n- è¿™ä¸ªæ—¶å€™ï¼Œéœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœè¿™ä¸ª key åœ¨å¤§é‡è¯·æ±‚åŒæ—¶è¿›æ¥å‰æ­£å¥½å¤±æ•ˆï¼Œé‚£ä¹ˆæ‰€æœ‰å¯¹è¿™ä¸ª key çš„æ•°æ®æŸ¥è¯¢éƒ½è½åˆ° dbï¼Œæˆ‘ä»¬ç§°ä¸ºç¼“å­˜å‡»ç©¿ã€‚\r\n- è§£å†³ï¼š\r\n  - åŠ é”\r\n    - å¤§é‡å¹¶å‘åªè®©ä¸€ä¸ªå»æŸ¥ï¼Œå…¶ä»–äººç­‰å¾…ï¼ŒæŸ¥åˆ°ä»¥åé‡Šæ”¾é”ï¼Œå…¶ä»–äººè·å–åˆ°é”ï¼Œå…ˆæŸ¥ç¼“å­˜ï¼Œå°±ä¼šæœ‰æ•°æ®ï¼Œä¸ç”¨å»db\r\n\r\n### ä¸‰ã€**ç¼“å­˜æ•°æ®ä¸€è‡´æ€§**\r\n\r\n\r\n\r\n#### 1ã€ç¼“å­˜æ•°æ®ä¸€è‡´æ€§ - åŒå†™æ¨¡å¼\r\n\r\n![image-20230410193831064](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193831064.png)\r\n\r\n#### **å¦‚ä½•ä¿è¯æ•°æ®åº“å’Œç¼“å­˜åŒå†™ä¸€è‡´æ€§ï¼Ÿ**\r\n\r\n- æ•°æ®åº“å’Œç¼“å­˜ï¼ˆæ¯”å¦‚ï¼šredisï¼‰åŒå†™æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œæ˜¯ä¸€ä¸ªè·Ÿå¼€å‘è¯­è¨€æ— å…³çš„å…¬å…±é—®é¢˜ã€‚å°¤å…¶åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªé—®é¢˜å˜å¾—æ›´åŠ ä¸¥é‡ã€‚\r\n\r\n\r\n\r\n- æˆ‘å¾ˆè´Ÿè´£çš„å‘Šè¯‰ä½ ï¼Œè¯¥é—®é¢˜æ— è®ºåœ¨é¢è¯•ï¼Œè¿˜æ˜¯å·¥ä½œä¸­é‡åˆ°çš„æ¦‚ç‡éå¸¸å¤§ï¼Œæ‰€ä»¥éå¸¸æœ‰å¿…è¦è·Ÿå¤§å®¶ä¸€èµ·æ¢è®¨ä¸€ä¸‹ã€‚\r\n\r\n\r\n\r\n- ä»Šå¤©è¿™ç¯‡æ–‡ç« æˆ‘ä¼šä»æµ…å…¥æ·±ï¼Œè·Ÿå¤§å®¶ä¸€èµ·èŠèŠï¼Œæ•°æ®åº“å’Œç¼“å­˜åŒå†™æ•°æ®ä¸€è‡´æ€§é—®é¢˜å¸¸è§çš„è§£å†³æ–¹æ¡ˆï¼Œè¿™äº›æ–¹æ¡ˆä¸­å¯èƒ½å­˜åœ¨çš„å‘ï¼Œä»¥åŠæœ€ä¼˜æ–¹æ¡ˆæ˜¯ä»€ä¹ˆã€‚\r\n\r\n\r\n\r\n##### 1.å¸¸è§æ–¹æ¡ˆ \r\n\r\n\r\n\r\n- é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¼“å­˜çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æå‡æŸ¥è¯¢çš„æ€§èƒ½ã€‚\r\n-  å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯è¿™æ ·ä½¿ç”¨ç¼“å­˜çš„ï¼š\r\n\r\n![image-20230429210507615](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429210507615.png)\r\n\r\n1. ç”¨æˆ·è¯·æ±‚è¿‡æ¥ä¹‹åï¼Œå…ˆæŸ¥ç¼“å­˜æœ‰æ²¡æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¿”å›ã€‚\r\n2. å¦‚æœç¼“å­˜æ²¡æ•°æ®ï¼Œå†ç»§ç»­æŸ¥æ•°æ®åº“ã€‚\r\n3. å¦‚æœæ•°æ®åº“æœ‰æ•°æ®ï¼Œåˆ™å°†æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®ï¼Œæ”¾å…¥ç¼“å­˜ä¸­ï¼Œç„¶åè¿”å›è¯¥æ•°æ®ã€‚\r\n4. å¦‚æœæ•°æ®åº“ä¹Ÿæ²¡æ•°æ®ï¼Œåˆ™ç›´æ¥è¿”å›ç©ºã€‚\r\n\r\n\r\n\r\n- è¿™æ˜¯ç¼“å­˜éå¸¸å¸¸è§çš„ç”¨æ³•ã€‚ä¸€çœ¼çœ‹ä¸Šå»ï¼Œå¥½åƒæ²¡æœ‰å•¥é—®é¢˜ã€‚\r\n- ä½†ä½ å¿½ç•¥äº†ä¸€ä¸ªéå¸¸é‡è¦çš„ç»†èŠ‚ï¼šå¦‚æœæ•°æ®åº“ä¸­çš„æŸæ¡æ•°æ®ï¼Œæ”¾å…¥ç¼“å­˜ä¹‹åï¼Œåˆç«‹é©¬è¢«æ›´æ–°äº†ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•æ›´æ–°ç¼“å­˜å‘¢ï¼Ÿ\r\n- ä¸æ›´æ–°ç¼“å­˜è¡Œä¸è¡Œï¼Ÿ\r\n  - ç­”ï¼šå½“ç„¶ä¸è¡Œï¼Œå¦‚æœä¸æ›´æ–°ç¼“å­˜ï¼Œåœ¨å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´å†…ï¼ˆå†³å®šäºç¼“å­˜çš„è¿‡æœŸæ—¶é—´ï¼‰ï¼Œç”¨æˆ·è¯·æ±‚ä»ç¼“å­˜ä¸­è·å–åˆ°çš„éƒ½å¯èƒ½æ˜¯æ—§å€¼ï¼Œè€Œéæ•°æ®åº“çš„æœ€æ–°å€¼ã€‚è¿™ä¸æ˜¯æœ‰æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Ÿ\r\n- é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•æ›´æ–°ç¼“å­˜å‘¢ï¼Ÿ\r\n  - ç›®å‰æœ‰ä»¥ä¸‹4ç§æ–¹æ¡ˆï¼š\r\n    1. å…ˆå†™ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“\r\n    2. å…ˆå†™æ•°æ®åº“ï¼Œå†å†™ç¼“å­˜\r\n    3. å…ˆåˆ ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“\r\n    4. å…ˆå†™æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜\r\n\r\n\r\n\r\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¯¦ç»†è¯´è¯´è¿™4ç§æ–¹æ¡ˆã€‚\r\n\r\n\r\n\r\n##### 2.å…ˆå†™ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“ \r\n\r\n\r\n\r\n- å¯¹äºæ›´æ–°ç¼“å­˜çš„æ–¹æ¡ˆï¼Œå¾ˆå¤šäººç¬¬ä¸€ä¸ªæƒ³åˆ°çš„å¯èƒ½æ˜¯åœ¨å†™æ“ä½œä¸­ç›´æ¥æ›´æ–°ç¼“å­˜ï¼ˆå†™ç¼“å­˜ï¼‰ï¼Œæ›´ç›´æ¥æ˜äº†ã€‚\r\n\r\n- é‚£ä¹ˆï¼Œé—®é¢˜æ¥äº†ï¼šåœ¨å†™æ“ä½œä¸­ï¼Œåˆ°åº•æ˜¯å…ˆå†™ç¼“å­˜ï¼Œè¿˜æ˜¯å…ˆå†™æ•°æ®åº“å‘¢ï¼Ÿ\r\n\r\n  - æˆ‘ä»¬åœ¨è¿™é‡Œå…ˆèŠèŠå…ˆå†™ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“çš„æƒ…å†µï¼Œå› ä¸ºå®ƒçš„é—®é¢˜æœ€ä¸¥é‡ã€‚\r\n\r\n    ![image-20230429211803146](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429211803146.png)\r\n\r\n  - æŸä¸€ä¸ªç”¨æˆ·çš„æ¯ä¸€æ¬¡å†™æ“ä½œï¼Œå¦‚æœåˆšå†™å®Œç¼“å­˜ï¼Œçªç„¶ç½‘ç»œå‡ºç°äº†å¼‚å¸¸ï¼Œå¯¼è‡´å†™æ•°æ®åº“å¤±è´¥äº†ã€‚\r\n\r\n    ![image-20230429212103693](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429212103693.png)\r\n\r\n\r\n\r\n> - å…¶ç»“æœæ˜¯ç¼“å­˜æ›´æ–°æˆäº†æœ€æ–°æ•°æ®ï¼Œä½†æ•°æ®åº“æ²¡æœ‰ï¼Œè¿™æ ·ç¼“å­˜ä¸­çš„æ•°æ®ä¸å°±å˜æˆè„æ•°æ®äº†ï¼Ÿå¦‚æœæ­¤æ—¶è¯¥ç”¨æˆ·çš„æŸ¥è¯¢è¯·æ±‚ï¼Œæ­£å¥½è¯»å–åˆ°è¯¥æ•°æ®ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ï¼Œå› ä¸ºè¯¥æ•°æ®åœ¨æ•°æ®åº“ä¸­æ ¹æœ¬ä¸å­˜åœ¨ï¼Œè¿™ä¸ªé—®é¢˜éå¸¸ä¸¥é‡ã€‚\r\n> - æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œç¼“å­˜çš„ä¸»è¦ç›®çš„æ˜¯æŠŠæ•°æ®åº“çš„æ•°æ®ä¸´æ—¶ä¿å­˜åœ¨å†…å­˜ï¼Œä¾¿äºåç»­çš„æŸ¥è¯¢ï¼Œæå‡æŸ¥è¯¢é€Ÿåº¦ã€‚\r\n> - ä½†å¦‚æœæŸæ¡æ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä½ ç¼“å­˜è¿™ç§â€œ`å‡æ•°æ®`â€åˆæœ‰å•¥æ„ä¹‰å‘¢ï¼Ÿ\r\n> - å› æ­¤ï¼Œå…ˆå†™ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“çš„æ–¹æ¡ˆæ˜¯ä¸å¯å–çš„ï¼Œåœ¨å®é™…å·¥ä½œä¸­ç”¨å¾—ä¸å¤šã€‚\r\n\r\n\r\n\r\n##### 3.å…ˆå†™æ•°æ®åº“ï¼Œå†å†™ç¼“å­˜\r\n\r\n- æ—¢ç„¶ä¸Šé¢çš„æ–¹æ¡ˆè¡Œä¸é€šï¼Œæ¥ä¸‹æ¥ï¼ŒèŠèŠå…ˆå†™æ•°æ®åº“ï¼Œå†å†™ç¼“å­˜çš„æ–¹æ¡ˆï¼Œè¯¥æ–¹æ¡ˆåœ¨ä½å¹¶å‘ç¼–ç¨‹ä¸­æœ‰äººåœ¨ç”¨ï¼ˆæˆ‘çŒœçš„ï¼‰ã€‚\r\n\r\n![image-20230429212403247](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429212403247.png)\r\n\r\n- ç”¨æˆ·çš„å†™æ“ä½œï¼Œå…ˆå†™æ•°æ®åº“ï¼Œå†å†™ç¼“å­˜ï¼Œå¯ä»¥é¿å…ä¹‹å‰â€œå‡æ•°æ®â€çš„é—®é¢˜ã€‚ä½†å®ƒå´å¸¦æ¥äº†æ–°çš„é—®é¢˜ã€‚\r\n\r\n- ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ\r\n\r\n  - å†™ç¼“å­˜å¤±è´¥äº†\r\n  - é«˜å¹¶å‘ä¸‹çš„é—®é¢˜\r\n\r\n  - æµªè´¹ç³»ç»Ÿèµ„æº\r\n\r\n\r\n\r\n###### 3.1 å†™ç¼“å­˜å¤±è´¥äº†\r\n\r\n- å¦‚æœæŠŠå†™æ•°æ®åº“å’Œå†™ç¼“å­˜æ“ä½œï¼Œæ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡å½“ä¸­ï¼Œå½“å†™ç¼“å­˜å¤±è´¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå†™å…¥æ•°æ®åº“çš„æ•°æ®è¿›è¡Œå›æ»šã€‚\r\n\r\n![image-20230429213036514](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429213036514.png)\r\n\r\n\r\n\r\n> - å¦‚æœæ˜¯å¹¶å‘é‡æ¯”è¾ƒå°ï¼Œå¯¹æ¥å£æ€§èƒ½è¦æ±‚ä¸å¤ªé«˜çš„ç³»ç»Ÿï¼Œå¯ä»¥è¿™ä¹ˆç©ã€‚\r\n> - ä½†å¦‚æœåœ¨é«˜å¹¶å‘çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå†™æ•°æ®åº“å’Œå†™ç¼“å­˜ï¼Œéƒ½å±äºè¿œç¨‹æ“ä½œã€‚ä¸ºäº†é˜²æ­¢å‡ºç°å¤§äº‹åŠ¡ï¼Œé€ æˆçš„æ­»é”é—®é¢˜ï¼Œé€šå¸¸å»ºè®®å†™æ•°æ®åº“å’Œå†™ç¼“å­˜ä¸è¦æ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚\r\n> - ä¹Ÿå°±æ˜¯è¯´åœ¨è¯¥æ–¹æ¡ˆä¸­ï¼Œå¦‚æœå†™æ•°æ®åº“æˆåŠŸäº†ï¼Œä½†å†™ç¼“å­˜å¤±è´¥äº†ï¼Œæ•°æ®åº“ä¸­å·²å†™å…¥çš„æ•°æ®ä¸ä¼šå›æ»šã€‚\r\n> - è¿™å°±ä¼šå‡ºç°ï¼šæ•°æ®åº“æ˜¯`æ–°æ•°æ®`ï¼Œè€Œç¼“å­˜æ˜¯`æ—§æ•°æ®`ï¼Œä¸¤è¾¹`æ•°æ®ä¸ä¸€è‡´`çš„æƒ…å†µã€‚\r\n\r\n\r\n\r\n###### 3.2 é«˜å¹¶å‘ä¸‹çš„é—®é¢˜\r\n\r\n- å‡è®¾åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸­ï¼Œé’ˆå¯¹åŒä¸€ä¸ªç”¨æˆ·çš„åŒä¸€æ¡æ•°æ®ï¼Œæœ‰ä¸¤ä¸ªå†™æ•°æ®è¯·æ±‚ï¼šaå’Œbï¼Œå®ƒä»¬åŒæ—¶è¯·æ±‚åˆ°ä¸šåŠ¡ç³»ç»Ÿã€‚\r\n\r\n- å…¶ä¸­è¯·æ±‚aè·å–çš„æ˜¯æ—§æ•°æ®ï¼Œè€Œè¯·æ±‚bè·å–çš„æ˜¯æ–°æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\r\n\r\n![image-20230429214141109](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429214141109.png)\r\n\r\n1. è¯·æ±‚aå…ˆè¿‡æ¥ï¼Œåˆšå†™å®Œäº†æ•°æ®åº“ã€‚ä½†ç”±äºç½‘ç»œåŸå› ï¼Œå¡é¡¿äº†ä¸€ä¸‹ï¼Œè¿˜æ²¡æ¥å¾—åŠå†™ç¼“å­˜ã€‚\r\n2. è¿™æ—¶å€™è¯·æ±‚bè¿‡æ¥äº†ï¼Œå…ˆå†™äº†æ•°æ®åº“ã€‚\r\n3. æ¥ä¸‹æ¥ï¼Œè¯·æ±‚bé¡ºåˆ©å†™äº†ç¼“å­˜ã€‚\r\n4. æ­¤æ—¶ï¼Œè¯·æ±‚aå¡é¡¿ç»“æŸï¼Œä¹Ÿå†™äº†ç¼“å­˜ã€‚\r\n\r\n> - å¾ˆæ˜¾ç„¶ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­ï¼Œè¯·æ±‚båœ¨ç¼“å­˜ä¸­çš„`æ–°æ•°æ®`ï¼Œè¢«è¯·æ±‚açš„`æ—§æ•°æ®`è¦†ç›–äº†ã€‚\r\n> - ä¹Ÿå°±æ˜¯è¯´ï¼šåœ¨é«˜å¹¶å‘åœºæ™¯ä¸­ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œå…ˆå†™æ•°æ®åº“ï¼Œå†å†™ç¼“å­˜çš„æ“ä½œï¼Œå¯èƒ½ä¼šå‡ºç°æ•°æ®åº“æ˜¯æ–°å€¼ï¼Œè€Œç¼“å­˜ä¸­æ˜¯æ—§å€¼ï¼Œä¸¤è¾¹æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚\r\n\r\n\r\n\r\n###### 3.3 æµªè´¹ç³»ç»Ÿèµ„æº\r\n\r\n- è¯¥æ–¹æ¡ˆè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜å°±æ˜¯ï¼šæ¯ä¸ªå†™æ“ä½œï¼Œå†™å®Œæ•°æ®åº“ï¼Œä¼šé©¬ä¸Šå†™ç¼“å­˜ï¼Œæ¯”è¾ƒæµªè´¹ç³»ç»Ÿèµ„æºã€‚\r\n\r\n- ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿ\r\n\r\n  - ä½ å¯ä»¥è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœå†™çš„ç¼“å­˜ï¼Œå¹¶ä¸æ˜¯ç®€å•çš„æ•°æ®å†…å®¹ï¼Œè€Œæ˜¯è¦ç»è¿‡éå¸¸å¤æ‚çš„è®¡ç®—å¾—å‡ºçš„æœ€ç»ˆç»“æœã€‚è¿™æ ·æ¯å†™ä¸€æ¬¡ç¼“å­˜ï¼Œéƒ½éœ€è¦ç»è¿‡ä¸€æ¬¡éå¸¸å¤æ‚çš„è®¡ç®—ï¼Œä¸æ˜¯éå¸¸æµªè´¹ç³»ç»Ÿèµ„æºå—ï¼Ÿ\r\n\r\n  - å°¤å…¶æ˜¯cpuå’Œå†…å­˜èµ„æºã€‚\r\n\r\n> - è¿˜æœ‰äº›ä¸šåŠ¡åœºæ™¯æ¯”è¾ƒç‰¹æ®Šï¼šå†™å¤šè¯»å°‘ã€‚\r\n>\r\n> - å¦‚æœåœ¨è¿™ç±»ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæ¯ä¸ªç”¨çš„å†™æ“ä½œï¼Œéƒ½éœ€è¦å†™ä¸€æ¬¡ç¼“å­˜ï¼Œæœ‰ç‚¹å¾—ä¸å¿å¤±ã€‚\r\n>\r\n> - ç”±æ­¤å¯è§ï¼Œåœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸­ï¼Œå…ˆå†™æ•°æ®åº“ï¼Œå†å†™ç¼“å­˜ï¼Œè¿™å¥—æ–¹æ¡ˆé—®é¢˜æŒºå¤šçš„ï¼Œä¹Ÿä¸å¤ªå»ºè®®ä½¿ç”¨ã€‚\r\n> - å¦‚æœä½ å·²ç»ç”¨äº†ï¼Œèµ¶ç´§çœ‹çœ‹è¸©å‘äº†æ²¡ï¼Ÿ\r\n\r\n\r\n\r\n##### 4.å…ˆåˆ ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“\r\n\r\n- é€šè¿‡ä¸Šé¢çš„å†…å®¹æˆ‘ä»¬å¾—çŸ¥ï¼Œå¦‚æœç›´æ¥æ›´æ–°ç¼“å­˜çš„é—®é¢˜å¾ˆå¤šã€‚\r\n- é‚£ä¹ˆï¼Œä¸ºä½•æˆ‘ä»¬ä¸èƒ½æ¢ä¸€ç§æ€è·¯ï¼šä¸å»ç›´æ¥æ›´æ–°ç¼“å­˜ï¼Œè€Œæ”¹ä¸ºåˆ é™¤ç¼“å­˜å‘¢ï¼Ÿ\r\n\r\n- åˆ é™¤ç¼“å­˜æ–¹æ¡ˆï¼ŒåŒæ ·æœ‰ä¸¤ç§ï¼š\r\n  1. å…ˆåˆ ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“\r\n  2. å…ˆå†™æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜\r\n\r\n- æˆ‘ä»¬ä¸€èµ·å…ˆçœ‹çœ‹ï¼šå…ˆåˆ ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“çš„æƒ…å†µã€‚\r\n\r\n![image-20230429214804997](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429214804997.png)\r\n\r\n> è¯´ç™½äº†ï¼Œåœ¨ç”¨æˆ·çš„å†™æ“ä½œä¸­ï¼Œå…ˆæ‰§è¡Œåˆ é™¤ç¼“å­˜æ“ä½œï¼Œå†å»å†™æ•°æ®åº“ã€‚è¿™å¥—æ–¹æ¡ˆï¼Œå¯ä»¥æ˜¯å¯ä»¥ï¼Œä½†ä¹Ÿä¼šæœ‰ä¸€æ ·é—®é¢˜ã€‚\r\n\r\n\r\n\r\n###### 4.1 é«˜å¹¶å‘ä¸‹çš„é—®é¢˜\r\n\r\n- å‡è®¾åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸­ï¼ŒåŒä¸€ä¸ªç”¨æˆ·çš„åŒä¸€æ¡æ•°æ®ï¼Œæœ‰ä¸€ä¸ªè¯»æ•°æ®è¯·æ±‚cï¼Œè¿˜æœ‰å¦ä¸€ä¸ªå†™æ•°æ®è¯·æ±‚dï¼ˆä¸€ä¸ªæ›´æ–°æ“ä½œï¼‰ï¼ŒåŒæ—¶è¯·æ±‚åˆ°ä¸šåŠ¡ç³»ç»Ÿã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\r\n\r\n![image-20230429215027947](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429215027947.png)\r\n\r\n1. è¯·æ±‚då…ˆè¿‡æ¥ï¼ŒæŠŠç¼“å­˜åˆ é™¤äº†ã€‚ä½†ç”±äºç½‘ç»œåŸå› ï¼Œå¡é¡¿äº†ä¸€ä¸‹ï¼Œè¿˜æ²¡æ¥å¾—åŠå†™æ•°æ®åº“ã€‚\r\n2. è¿™æ—¶è¯·æ±‚cè¿‡æ¥äº†ï¼Œå…ˆæŸ¥ç¼“å­˜å‘ç°æ²¡æ•°æ®ï¼Œå†æŸ¥æ•°æ®åº“ï¼Œæœ‰æ•°æ®ï¼Œä½†æ˜¯æ—§å€¼ã€‚\r\n3. è¯·æ±‚cå°†æ•°æ®åº“ä¸­çš„æ—§å€¼ï¼Œæ›´æ–°åˆ°ç¼“å­˜ä¸­ã€‚\r\n4. æ­¤æ—¶ï¼Œè¯·æ±‚då¡é¡¿ç»“æŸï¼ŒæŠŠæ–°å€¼å†™å…¥æ•°æ®åº“ã€‚\r\n\r\n- åœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­ï¼Œè¯·æ±‚dçš„æ–°å€¼å¹¶æ²¡æœ‰è¢«è¯·æ±‚cå†™å…¥ç¼“å­˜ï¼ŒåŒæ ·ä¼šå¯¼è‡´ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚\r\n- é‚£ä¹ˆï¼Œè¿™ç§åœºæ™¯çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œèƒ½å¦è§£å†³å‘¢ï¼Ÿ\r\n  - ç¼“å­˜åŒåˆ \r\n\r\n\r\n\r\n###### 4.2 ç¼“å­˜åŒåˆ \r\n\r\n- åœ¨ä¸Šé¢çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¸€ä¸ªè¯»æ•°æ®è¯·æ±‚ï¼Œä¸€ä¸ªå†™æ•°æ®è¯·æ±‚ã€‚å½“å†™æ•°æ®è¯·æ±‚æŠŠç¼“å­˜åˆ äº†ä¹‹åï¼Œè¯»æ•°æ®è¯·æ±‚ï¼Œå¯èƒ½æŠŠå½“æ—¶ä»æ•°æ®åº“æŸ¥è¯¢å‡ºæ¥çš„æ—§å€¼ï¼Œå†™å…¥ç¼“å­˜å½“ä¸­ã€‚\r\n\r\n- æœ‰äººè¯´è¿˜ä¸å¥½åŠï¼Œè¯·æ±‚dåœ¨å†™å®Œæ•°æ®åº“ä¹‹åï¼ŒæŠŠç¼“å­˜é‡æ–°åˆ ä¸€æ¬¡ä¸å°±è¡Œäº†ï¼Ÿ\r\n\r\n![image-20230429215248760](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429215248760.png)\r\n\r\n- è¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ç¼“å­˜åŒåˆ ï¼Œå³åœ¨å†™æ•°æ®åº“ä¹‹å‰åˆ é™¤ä¸€æ¬¡ï¼Œå†™å®Œæ•°æ®åº“åï¼Œå†åˆ é™¤ä¸€æ¬¡ã€‚\r\n- è¯¥æ–¹æ¡ˆæœ‰ä¸ªéå¸¸å…³é”®çš„åœ°æ–¹æ˜¯ï¼šç¬¬äºŒæ¬¡åˆ é™¤ç¼“å­˜ï¼Œå¹¶éç«‹é©¬å°±åˆ ï¼Œè€Œæ˜¯è¦åœ¨ä¸€å®šçš„æ—¶é—´é—´éš”ä¹‹åã€‚\r\n- æˆ‘ä»¬å†é‡æ–°å›é¡¾ä¸€ä¸‹ï¼Œé«˜å¹¶å‘ä¸‹ä¸€ä¸ªè¯»æ•°æ®è¯·æ±‚ï¼Œä¸€ä¸ªå†™æ•°æ®è¯·æ±‚å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„äº§ç”Ÿè¿‡ç¨‹ï¼š\r\n  1. è¯·æ±‚då…ˆè¿‡æ¥ï¼ŒæŠŠç¼“å­˜åˆ é™¤äº†ã€‚ä½†ç”±äºç½‘ç»œåŸå› ï¼Œå¡é¡¿äº†ä¸€ä¸‹ï¼Œè¿˜æ²¡æ¥å¾—åŠå†™æ•°æ®åº“ã€‚\r\n  2. è¿™æ—¶è¯·æ±‚cè¿‡æ¥äº†ï¼Œå…ˆæŸ¥ç¼“å­˜å‘ç°æ²¡æ•°æ®ï¼Œå†æŸ¥æ•°æ®åº“ï¼Œæœ‰æ•°æ®ï¼Œä½†æ˜¯æ—§å€¼ã€‚\r\n  3. è¯·æ±‚cå°†æ•°æ®åº“ä¸­çš„æ—§å€¼ï¼Œæ›´æ–°åˆ°ç¼“å­˜ä¸­ã€‚\r\n  4. æ­¤æ—¶ï¼Œè¯·æ±‚då¡é¡¿ç»“æŸï¼ŒæŠŠæ–°å€¼å†™å…¥æ•°æ®åº“ã€‚\r\n  5. ä¸€æ®µæ—¶é—´ä¹‹åï¼Œæ¯”å¦‚ï¼š500msï¼Œè¯·æ±‚då°†ç¼“å­˜åˆ é™¤ã€‚\r\n\r\n- è¿™æ ·æ¥çœ‹ç¡®å®å¯ä»¥è§£å†³ç¼“å­˜ä¸ä¸€è‡´é—®é¢˜ã€‚\r\n- é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä¸€å®šè¦é—´éš”ä¸€æ®µæ—¶é—´ä¹‹åï¼Œæ‰èƒ½åˆ é™¤ç¼“å­˜å‘¢ï¼Ÿ\r\n- è¯·æ±‚då¡é¡¿ç»“æŸï¼ŒæŠŠæ–°å€¼å†™å…¥æ•°æ®åº“åï¼Œè¯·æ±‚cå°†æ•°æ®åº“ä¸­çš„æ—§å€¼ï¼Œæ›´æ–°åˆ°ç¼“å­˜ä¸­ã€‚\r\n- æ­¤æ—¶ï¼Œå¦‚æœè¯·æ±‚dåˆ é™¤å¤ªå¿«ï¼Œåœ¨è¯·æ±‚cå°†æ•°æ®åº“ä¸­çš„æ—§å€¼æ›´æ–°åˆ°ç¼“å­˜ä¹‹å‰ï¼Œå°±å·²ç»æŠŠç¼“å­˜åˆ é™¤äº†ï¼Œè¿™æ¬¡åˆ é™¤å°±æ²¡ä»»ä½•æ„ä¹‰ã€‚å¿…é¡»è¦åœ¨è¯·æ±‚cæ›´æ–°ç¼“å­˜ä¹‹åï¼Œå†åˆ é™¤ç¼“å­˜ï¼Œæ‰èƒ½æŠŠæ—§å€¼åŠæ—¶åˆ é™¤äº†ã€‚\r\n- æ‰€ä»¥éœ€è¦åœ¨è¯·æ±‚dä¸­åŠ ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œç¡®ä¿è¯·æ±‚cï¼Œæˆ–è€…ç±»ä¼¼äºè¯·æ±‚cçš„å…¶ä»–è¯·æ±‚ï¼Œå¦‚æœåœ¨ç¼“å­˜ä¸­è®¾ç½®äº†æ—§å€¼ï¼Œæœ€ç»ˆéƒ½èƒ½å¤Ÿè¢«è¯·æ±‚dåˆ é™¤æ‰ã€‚\r\n- æ¥ä¸‹æ¥ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœç¬¬äºŒæ¬¡åˆ é™¤ç¼“å­˜æ—¶ï¼Œåˆ é™¤å¤±è´¥äº†è¯¥æ€ä¹ˆåŠï¼Ÿ\r\n- è¿™é‡Œå…ˆç•™ç‚¹æ‚¬å¿µï¼Œåé¢ä¼šè¯¦ç»†è¯´ã€‚\r\n\r\n\r\n\r\n##### 5.å…ˆå†™æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜\r\n\r\n- ä»å‰é¢å¾—çŸ¥ï¼Œå…ˆåˆ ç¼“å­˜ï¼Œå†å†™æ•°æ®åº“ï¼Œåœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯èƒ½ä¼šå‡ºç°ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚\r\n- é‚£ä¹ˆï¼Œæˆ‘ä»¬åªèƒ½å¯„å¸Œæœ›äºæœ€åçš„æ–¹æ¡ˆäº†ã€‚\r\n- æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹çœ‹å…ˆå†™æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜çš„æ–¹æ¡ˆã€‚\r\n\r\n![image-20230429220057198](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429220057198.png)\r\n\r\n- åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸­ï¼Œæœ‰ä¸€ä¸ªè¯»æ•°æ®è¯·æ±‚ï¼Œæœ‰ä¸€ä¸ªå†™æ•°æ®è¯·æ±‚ï¼Œæ›´æ–°è¿‡ç¨‹å¦‚ä¸‹ï¼š\r\n\r\n1. è¯·æ±‚eå…ˆå†™æ•°æ®åº“ï¼Œç”±äºç½‘ç»œåŸå› å¡é¡¿äº†ä¸€ä¸‹ï¼Œæ²¡æœ‰æ¥å¾—åŠåˆ é™¤ç¼“å­˜ã€‚\r\n2. è¯·æ±‚fæŸ¥è¯¢ç¼“å­˜ï¼Œå‘ç°ç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œç›´æ¥è¿”å›è¯¥æ•°æ®ã€‚\r\n3. è¯·æ±‚eåˆ é™¤ç¼“å­˜ã€‚\r\n\r\n- åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåªæœ‰è¯·æ±‚fè¯»äº†ä¸€æ¬¡æ—§æ•°æ®ï¼Œåæ¥æ—§æ•°æ®è¢«è¯·æ±‚eåŠæ—¶åˆ é™¤äº†ï¼Œçœ‹èµ·æ¥é—®é¢˜ä¸å¤§ã€‚\r\n- ä½†å¦‚æœæ˜¯è¯»æ•°æ®è¯·æ±‚å…ˆè¿‡æ¥å‘¢ï¼Ÿ\r\n\r\n1. è¯·æ±‚fæŸ¥è¯¢ç¼“å­˜ï¼Œå‘ç°ç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œç›´æ¥è¿”å›è¯¥æ•°æ®ã€‚\r\n2. è¯·æ±‚eå…ˆå†™æ•°æ®åº“ã€‚\r\n3. è¯·æ±‚eåˆ é™¤ç¼“å­˜ã€‚\r\n\r\n- è¿™ç§æƒ…å†µçœ‹èµ·æ¥ä¹Ÿæ²¡é—®é¢˜å‘€ï¼Ÿ\r\n  - ç­”ï¼šå¯¹çš„ã€‚\r\n- ä½†å°±æ€•å‡ºç°ä¸‹é¢è¿™ç§æƒ…å†µï¼Œå³ç¼“å­˜è‡ªå·±å¤±æ•ˆäº†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\r\n\r\n![image-20230429220431661](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429220431661.png)\r\n\r\n1. ç¼“å­˜è¿‡æœŸæ—¶é—´åˆ°äº†ï¼Œè‡ªåŠ¨å¤±æ•ˆã€‚\r\n2. è¯·æ±‚fæŸ¥è¯¢ç¼“å­˜ï¼Œå‘ç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼ŒæŸ¥è¯¢æ•°æ®åº“çš„æ—§å€¼ï¼Œä½†ç”±äºç½‘ç»œåŸå› å¡é¡¿äº†ï¼Œæ²¡æœ‰æ¥å¾—åŠæ›´æ–°ç¼“å­˜ã€‚\r\n3. è¯·æ±‚eå…ˆå†™æ•°æ®åº“ï¼Œæ¥ç€åˆ é™¤äº†ç¼“å­˜ã€‚\r\n4. è¯·æ±‚fæ›´æ–°æ—§å€¼åˆ°ç¼“å­˜ä¸­ã€‚\r\n\r\n- è¿™æ—¶ï¼Œç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®åŒæ ·å‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µäº†ã€‚\r\n- ä½†è¿™ç§æƒ…å†µè¿˜æ˜¯æ¯”è¾ƒå°‘çš„ï¼Œéœ€è¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰å¯ä»¥ï¼š\r\n  1. ç¼“å­˜åˆšå¥½è‡ªåŠ¨å¤±æ•ˆã€‚\r\n  2. è¯·æ±‚fä»æ•°æ®åº“æŸ¥å‡ºæ—§å€¼ï¼Œæ›´æ–°ç¼“å­˜çš„è€—æ—¶ï¼Œæ¯”è¯·æ±‚eå†™æ•°æ®åº“ï¼Œå¹¶ä¸”åˆ é™¤ç¼“å­˜çš„è¿˜é•¿ã€‚\r\n\r\n- æˆ‘ä»¬éƒ½çŸ¥é“æŸ¥è¯¢æ•°æ®åº“çš„é€Ÿåº¦ï¼Œä¸€èˆ¬æ¯”å†™æ•°æ®åº“è¦å¿«ï¼Œæ›´ä½•å†µå†™å®Œæ•°æ®åº“ï¼Œè¿˜è¦åˆ é™¤ç¼“å­˜ã€‚æ‰€ä»¥ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå†™æ•°æ®è¯·æ±‚æ¯”è¯»æ•°æ®æƒ…å†µè€—æ—¶æ›´é•¿ã€‚\r\n- ç”±æ­¤å¯è§ï¼Œç³»ç»ŸåŒæ—¶æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶çš„æ¦‚ç‡éå¸¸å°ã€‚\r\n\r\n> æ¨èå¤§å®¶ä½¿ç”¨å…ˆå†™æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜çš„æ–¹æ¡ˆï¼Œè™½è¯´ä¸èƒ½100%é¿å…æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œä½†å‡ºç°è¯¥é—®é¢˜çš„æ¦‚ç‡ï¼Œç›¸å¯¹äºå…¶ä»–æ–¹æ¡ˆæ¥è¯´æ˜¯æœ€å°çš„ã€‚\r\n\r\n- ä½†åœ¨è¯¥æ–¹æ¡ˆä¸­ï¼Œå¦‚æœåˆ é™¤ç¼“å­˜å¤±è´¥äº†è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ\r\n\r\n\r\n\r\n##### 6.åˆ ç¼“å­˜å¤±è´¥æ€ä¹ˆåŠï¼Ÿ\r\n\r\n- å…¶å®å…ˆå†™æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜çš„æ–¹æ¡ˆï¼Œè·Ÿç¼“å­˜åŒåˆ çš„æ–¹æ¡ˆä¸€æ ·ï¼Œæœ‰ä¸€ä¸ªå…±åŒçš„é£é™©ç‚¹ï¼Œå³ï¼šå¦‚æœç¼“å­˜åˆ é™¤å¤±è´¥äº†ï¼Œä¹Ÿä¼šå¯¼è‡´ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´ã€‚\r\n- é‚£ä¹ˆï¼Œåˆ é™¤ç¼“å­˜å¤±è´¥æ€ä¹ˆåŠå‘¢ï¼Ÿ\r\n  - ç­”ï¼šéœ€è¦åŠ `é‡è¯•æœºåˆ¶`ã€‚\r\n- åœ¨æ¥å£ä¸­å¦‚æœæ›´æ–°äº†æ•°æ®åº“æˆåŠŸäº†ï¼Œä½†æ›´æ–°ç¼“å­˜å¤±è´¥äº†ï¼Œå¯ä»¥ç«‹åˆ»é‡è¯•3æ¬¡ã€‚å¦‚æœå…¶ä¸­æœ‰ä»»ä½•ä¸€æ¬¡æˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›æˆåŠŸã€‚å¦‚æœ3æ¬¡éƒ½å¤±è´¥äº†ï¼Œåˆ™å†™å…¥æ•°æ®åº“ï¼Œå‡†å¤‡åç»­å†å¤„ç†ã€‚\r\n- å½“ç„¶ï¼Œå¦‚æœä½ åœ¨æ¥å£ä¸­ç›´æ¥`åŒæ­¥é‡è¯•`ï¼Œè¯¥æ¥å£å¹¶å‘é‡æ¯”è¾ƒé«˜çš„æ—¶å€™ï¼Œå¯èƒ½æœ‰ç‚¹å½±å“æ¥å£æ€§èƒ½ã€‚\r\n- è¿™æ—¶ï¼Œå°±éœ€è¦æ”¹æˆ`å¼‚æ­¥é‡è¯•`äº†ã€‚\r\n- å¼‚æ­¥é‡è¯•æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ï¼š\r\n  1. æ¯æ¬¡éƒ½å•ç‹¬èµ·ä¸€ä¸ªçº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ä¸“é—¨åšé‡è¯•çš„å·¥ä½œã€‚ä½†å¦‚æœåœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤ªå¤šçš„çº¿ç¨‹ï¼Œå¯¼è‡´ç³»ç»ŸOOMé—®é¢˜ï¼Œä¸å¤ªå»ºè®®ä½¿ç”¨ã€‚\r\n  2. å°†é‡è¯•çš„ä»»åŠ¡äº¤ç»™çº¿ç¨‹æ± å¤„ç†ï¼Œä½†å¦‚æœæœåŠ¡å™¨é‡å¯ï¼Œéƒ¨åˆ†æ•°æ®å¯èƒ½ä¼šä¸¢å¤±ã€‚\r\n  3. å°†é‡è¯•æ•°æ®å†™è¡¨ï¼Œç„¶åä½¿ç”¨elastic-jobç­‰å®šæ—¶ä»»åŠ¡è¿›è¡Œé‡è¯•ã€‚\r\n  4. å°†é‡è¯•çš„è¯·æ±‚å†™å…¥mqç­‰æ¶ˆæ¯ä¸­é—´ä»¶ä¸­ï¼Œåœ¨mqçš„consumerä¸­å¤„ç†ã€‚\r\n  5. è®¢é˜…mysqlçš„binlogï¼Œåœ¨è®¢é˜…è€…ä¸­ï¼Œå¦‚æœå‘ç°äº†æ›´æ–°æ•°æ®è¯·æ±‚ï¼Œåˆ™åˆ é™¤ç›¸åº”çš„ç¼“å­˜ã€‚\r\n\r\n\r\n\r\n##### 7.å®šæ—¶ä»»åŠ¡\r\n\r\n- ä½¿ç”¨å®šæ—¶ä»»åŠ¡é‡è¯•çš„å…·ä½“æ–¹æ¡ˆå¦‚ä¸‹ï¼š\r\n\r\n1. å½“ç”¨æˆ·æ“ä½œå†™å®Œæ•°æ®åº“ï¼Œä½†åˆ é™¤ç¼“å­˜å¤±è´¥äº†ï¼Œéœ€è¦å°†ç”¨æˆ·æ•°æ®å†™å…¥é‡è¯•è¡¨ä¸­ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\r\n\r\n![image-20230429221037315](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429221037315.png)\r\n\r\n2. åœ¨å®šæ—¶ä»»åŠ¡ä¸­ï¼Œå¼‚æ­¥è¯»å–é‡è¯•è¡¨ä¸­çš„ç”¨æˆ·æ•°æ®ã€‚é‡è¯•è¡¨éœ€è¦è®°å½•ä¸€ä¸ªé‡è¯•æ¬¡æ•°å­—æ®µï¼Œåˆå§‹å€¼ä¸º0ã€‚ç„¶åé‡è¯•5æ¬¡ï¼Œä¸æ–­åˆ é™¤ç¼“å­˜ï¼Œæ¯é‡è¯•ä¸€æ¬¡è¯¥å­—æ®µå€¼+1ã€‚å¦‚æœå…¶ä¸­æœ‰ä»»æ„ä¸€æ¬¡æˆåŠŸäº†ï¼Œåˆ™è¿”å›æˆåŠŸã€‚å¦‚æœé‡è¯•äº†5æ¬¡ï¼Œè¿˜æ˜¯å¤±è´¥ï¼Œåˆ™æˆ‘ä»¬éœ€è¦åœ¨é‡è¯•è¡¨ä¸­è®°å½•ä¸€ä¸ªå¤±è´¥çš„çŠ¶æ€ï¼Œç­‰å¾…åç»­è¿›ä¸€æ­¥å¤„ç†ã€‚\r\n\r\n![image-20230429221203146](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429221203146.png)\r\n\r\n\r\n\r\n3. åœ¨é«˜å¹¶å‘åœºæ™¯ä¸­ï¼Œå®šæ—¶ä»»åŠ¡æ¨èä½¿ç”¨`elastic-job`ã€‚ç›¸å¯¹äºxxl-jobç­‰å®šæ—¶ä»»åŠ¡ï¼Œå®ƒå¯ä»¥åˆ†ç‰‡å¤„ç†ï¼Œæå‡å¤„ç†é€Ÿåº¦ã€‚åŒæ—¶æ¯ç‰‡çš„é—´éš”å¯ä»¥è®¾ç½®æˆï¼š1,2,3,5,7ç§’ç­‰ã€‚\r\n\r\n- å¦‚æœå¤§å®¶å¯¹å®šæ—¶ä»»åŠ¡æ¯”è¾ƒæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ã€Š[å­¦ä¼šè¿™10ç§å®šæ—¶ä»»åŠ¡ï¼Œæˆ‘æœ‰ç‚¹é£˜äº†](https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&mid=2247490314&idx=1&sn=29ddf0c1e99675b86cdfc082556a69a9&chksm=c0ebc3e2f79c4af43cf8582d41b0bc3ede57986cc6c115b103b586a2c7bddb4475555e919b20&token=751314179&lang=zh_CN&scene=21#wechat_redirect)ã€‹ï¼Œé‡Œé¢åˆ—å‡ºäº†ç›®å‰æœ€ä¸»æµçš„å®šæ—¶ä»»åŠ¡ã€‚\r\n- ä½¿ç”¨å®šæ—¶ä»»åŠ¡é‡è¯•çš„è¯ï¼Œæœ‰ä¸ªç¼ºç‚¹å°±æ˜¯å®æ—¶æ€§æ²¡é‚£ä¹ˆé«˜ï¼Œå¯¹äºå®æ—¶æ€§è¦æ±‚ç‰¹åˆ«é«˜çš„ä¸šåŠ¡åœºæ™¯ï¼Œè¯¥æ–¹æ¡ˆä¸å¤ªé€‚ç”¨ã€‚ä½†æ˜¯å¯¹äºä¸€èˆ¬åœºæ™¯ï¼Œè¿˜æ˜¯å¯ä»¥ç”¨ä¸€ç”¨çš„ã€‚\r\n- ä½†å®ƒæœ‰ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜ç‚¹ï¼Œå³æ•°æ®æ˜¯è½åº“çš„ï¼Œä¸ä¼šä¸¢æ•°æ®ã€‚\r\n\r\n\r\n\r\n##### 8.mq\r\n\r\n- åœ¨é«˜å¹¶å‘çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œmqï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰æ˜¯å¿…ä¸å¯å°‘çš„æŠ€æœ¯ä¹‹ä¸€ã€‚å®ƒä¸ä»…å¯ä»¥å¼‚æ­¥è§£è€¦ï¼Œè¿˜èƒ½å‰Šå³°å¡«è°·ã€‚å¯¹ä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§æ˜¯éå¸¸æœ‰æ„ä¹‰çš„ã€‚\r\n- å¯¹mqæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥çœ‹çœ‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ã€Š[mqçš„é‚£äº›ç ´äº‹å„¿](https://mp.weixin.qq.com/s/j5Jedf7OSPkyNs11610v8Q)ã€‹ã€‚\r\n- mqçš„ç”Ÿäº§è€…ï¼Œç”Ÿäº§äº†æ¶ˆæ¯ä¹‹åï¼Œé€šè¿‡æŒ‡å®šçš„topicå‘é€åˆ°mqæœåŠ¡å™¨ã€‚ç„¶åmqçš„æ¶ˆè´¹è€…ï¼Œè®¢é˜…è¯¥topicçš„æ¶ˆæ¯ï¼Œè¯»å–æ¶ˆæ¯æ•°æ®ä¹‹åï¼Œåšä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚\r\n- ä½¿ç”¨mqé‡è¯•çš„å…·ä½“æ–¹æ¡ˆå¦‚ä¸‹ï¼š\r\n\r\n![image-20230429221455529](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429221455529.png)\r\n\r\n1. å½“ç”¨æˆ·æ“ä½œå†™å®Œæ•°æ®åº“ï¼Œä½†åˆ é™¤ç¼“å­˜å¤±è´¥äº†ï¼Œäº§ç”Ÿä¸€æ¡mqæ¶ˆæ¯ï¼Œå‘é€ç»™mqæœåŠ¡å™¨ã€‚\r\n2. mqæ¶ˆè´¹è€…è¯»å–mqæ¶ˆæ¯ï¼Œé‡è¯•5æ¬¡åˆ é™¤ç¼“å­˜ã€‚å¦‚æœå…¶ä¸­æœ‰ä»»æ„ä¸€æ¬¡æˆåŠŸäº†ï¼Œåˆ™è¿”å›æˆåŠŸã€‚å¦‚æœé‡è¯•äº†5æ¬¡ï¼Œè¿˜æ˜¯å¤±è´¥ï¼Œåˆ™å†™å…¥æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚\r\n3. æ¨èmqä½¿ç”¨rocketmqï¼Œé‡è¯•æœºåˆ¶å’Œæ­»ä¿¡é˜Ÿåˆ—é»˜è®¤æ˜¯æ”¯æŒçš„ã€‚ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œè€Œä¸”è¿˜æ”¯æŒé¡ºåºæ¶ˆæ¯ï¼Œå»¶è¿Ÿæ¶ˆæ¯å’Œäº‹åŠ¡æ¶ˆæ¯ç­‰å¤šç§ä¸šåŠ¡åœºæ™¯ã€‚\r\n\r\n> - å½“ç„¶åœ¨è¯¥æ–¹æ¡ˆä¸­ï¼Œåˆ é™¤ç¼“å­˜å¯ä»¥å®Œå…¨èµ°å¼‚æ­¥ã€‚å³ç”¨æˆ·çš„å†™æ“ä½œï¼Œåœ¨å†™å®Œæ•°æ®åº“ä¹‹åï¼Œä¸ç”¨ç«‹åˆ»åˆ é™¤ä¸€æ¬¡ç¼“å­˜ã€‚è€Œç›´æ¥å‘é€mqæ¶ˆæ¯ï¼Œåˆ°mqæœåŠ¡å™¨ï¼Œç„¶åæœ‰mqæ¶ˆè´¹è€…å…¨æƒè´Ÿè´£åˆ é™¤ç¼“å­˜çš„ä»»åŠ¡ã€‚\r\n> - å› ä¸ºmqçš„å®æ—¶æ€§è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œå› æ­¤æ”¹è‰¯åçš„æ–¹æ¡ˆä¹Ÿæ˜¯ä¸€ç§ä¸é”™çš„é€‰æ‹©ã€‚\r\n\r\n\r\n\r\n##### 9.binlog\r\n\r\n- å‰é¢æˆ‘ä»¬èŠè¿‡çš„ï¼Œæ— è®ºæ˜¯å®šæ—¶ä»»åŠ¡ï¼Œè¿˜æ˜¯mqï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œåšé‡è¯•æœºåˆ¶ï¼Œå¯¹ä¸šåŠ¡éƒ½æœ‰ä¸€å®šçš„ä¾µå…¥æ€§ã€‚\r\n- åœ¨ä½¿ç”¨å®šæ—¶ä»»åŠ¡çš„æ–¹æ¡ˆä¸­ï¼Œéœ€è¦åœ¨ä¸šåŠ¡ä»£ç ä¸­å¢åŠ é¢å¤–é€»è¾‘ï¼Œå¦‚æœåˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œéœ€è¦å°†æ•°æ®å†™å…¥é‡è¯•è¡¨ã€‚\r\n- è€Œä½¿ç”¨mqçš„æ–¹æ¡ˆä¸­ï¼Œå¦‚æœåˆ é™¤ç¼“å­˜å¤±è´¥äº†ï¼Œéœ€è¦åœ¨ä¸šåŠ¡ä»£ç ä¸­å‘é€mqæ¶ˆæ¯åˆ°mqæœåŠ¡å™¨ã€‚\r\n- å…¶å®ï¼Œè¿˜æœ‰ä¸€ç§æ›´ä¼˜é›…çš„å®ç°ï¼Œå³ç›‘å¬binlogï¼Œæ¯”å¦‚ä½¿ç”¨ï¼šcanalç­‰ä¸­é—´ä»¶ã€‚\r\n- å…·ä½“æ–¹æ¡ˆå¦‚ä¸‹ï¼š\r\n\r\n![image-20230429221610975](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429221610975.png)\r\n\r\n1. åœ¨ä¸šåŠ¡æ¥å£ä¸­å†™æ•°æ®åº“ä¹‹åï¼Œå°±ä¸ç®¡äº†ï¼Œç›´æ¥è¿”å›æˆåŠŸã€‚\r\n2. mysqlæœåŠ¡å™¨ä¼šè‡ªåŠ¨æŠŠå˜æ›´çš„æ•°æ®å†™å…¥binlogä¸­ã€‚\r\n3. binlogè®¢é˜…è€…è·å–å˜æ›´çš„æ•°æ®ï¼Œç„¶ååˆ é™¤ç¼“å­˜ã€‚\r\n\r\n- è¿™å¥—æ–¹æ¡ˆä¸­ä¸šåŠ¡æ¥å£ç¡®å®ç®€åŒ–äº†ä¸€äº›æµç¨‹ï¼Œåªç”¨å…³å¿ƒæ•°æ®åº“æ“ä½œå³å¯ï¼Œè€Œåœ¨binlogè®¢é˜…è€…ä¸­åšç¼“å­˜åˆ é™¤å·¥ä½œã€‚\r\n- ä½†å¦‚æœåªæ˜¯æŒ‰ç…§å›¾ä¸­çš„æ–¹æ¡ˆè¿›è¡Œåˆ é™¤ç¼“å­˜ï¼Œåªåˆ é™¤äº†ä¸€æ¬¡ï¼Œä¹Ÿå¯èƒ½ä¼šå¤±è´¥ã€‚\r\n- å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ\r\n  - ç­”ï¼šè¿™å°±éœ€è¦åŠ ä¸Šå‰é¢èŠè¿‡çš„`é‡è¯•æœºåˆ¶`äº†ã€‚å¦‚æœåˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œå†™å…¥é‡è¯•è¡¨ï¼Œä½¿ç”¨å®šæ—¶ä»»åŠ¡é‡è¯•ã€‚æˆ–è€…å†™å…¥mqï¼Œè®©mqè‡ªåŠ¨é‡è¯•ã€‚\r\n- åœ¨è¿™é‡Œæ¨èä½¿ç”¨mq`è‡ªåŠ¨é‡è¯•æœºåˆ¶`ã€‚\r\n\r\n![image-20230429221806980](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429221806980.png)\r\n\r\n> åœ¨binlogè®¢é˜…è€…ä¸­å¦‚æœåˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œåˆ™å‘é€ä¸€æ¡mqæ¶ˆæ¯åˆ°mqæœåŠ¡å™¨ï¼Œåœ¨mqæ¶ˆè´¹è€…ä¸­è‡ªåŠ¨é‡è¯•5æ¬¡ã€‚å¦‚æœæœ‰ä»»æ„ä¸€æ¬¡æˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›æˆåŠŸã€‚å¦‚æœé‡è¯•5æ¬¡åè¿˜æ˜¯å¤±è´¥ï¼Œåˆ™è¯¥æ¶ˆæ¯è‡ªåŠ¨è¢«æ”¾å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œåé¢å¯èƒ½éœ€è¦äººå·¥ä»‹å…¥ã€‚\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n#### 2ã€ç¼“å­˜æ•°æ®ä¸€è‡´æ€§ - å¤±æ•ˆæ¨¡å¼\r\n\r\n![image-20230410193909090](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193909090.png)\r\n\r\n\r\n\r\n#### 3ã€ç¼“å­˜æ•°æ®ä¸€è‡´æ€§ - è§£å†³æ–¹æ¡ˆ\r\n\r\n-  æ— è®ºæ˜¯åŒå†™æ¨¡å¼è¿˜æ˜¯å¤±æ•ˆæ¨¡å¼ï¼Œéƒ½ä¼šå¯¼è‡´ç¼“å­˜çš„ä¸ä¸€è‡´é—®é¢˜ã€‚å³å¤šä¸ªå®ä¾‹åŒæ—¶æ›´æ–°ä¼šå‡ºäº‹ã€‚æ€ä¹ˆåŠï¼Ÿ\r\n   - 1ã€å¦‚æœæ˜¯ç”¨æˆ·çº¬åº¦æ•°æ®ï¼ˆè®¢å•æ•°æ®ã€ç”¨æˆ·æ•°æ®ï¼‰ï¼Œè¿™ç§å¹¶å‘å‡ ç‡éå¸¸å°ï¼Œä¸ç”¨è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œç¼“å­˜æ•°æ®åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´è§¦å‘è¯»çš„ä¸»åŠ¨æ›´æ–°å³å¯\r\n   - 2ã€å¦‚æœæ˜¯èœå•ï¼Œå•†å“ä»‹ç»ç­‰åŸºç¡€æ•°æ®ï¼Œä¹Ÿå¯ä»¥å»ä½¿ç”¨canalè®¢é˜…binlogçš„æ–¹å¼ã€‚\r\n   - 3ã€ç¼“å­˜æ•°æ®+è¿‡æœŸæ—¶é—´ä¹Ÿè¶³å¤Ÿè§£å†³å¤§éƒ¨åˆ†ä¸šåŠ¡å¯¹äºç¼“å­˜çš„è¦æ±‚ã€‚\r\n   - 4ã€é€šè¿‡åŠ é”ä¿è¯å¹¶å‘è¯»å†™ï¼Œå†™å†™çš„æ—¶å€™æŒ‰é¡ºåºæ’å¥½é˜Ÿã€‚è¯»è¯»æ— æ‰€è°“ã€‚æ‰€ä»¥é€‚åˆä½¿ç”¨è¯»å†™é”ã€‚ï¼ˆä¸šåŠ¡ä¸å…³å¿ƒè„æ•°æ®ï¼Œå…è®¸ä¸´æ—¶è„æ•°æ®å¯å¿½ç•¥ï¼‰ï¼›\r\n-  æ€»ç»“ï¼š\r\n   - æˆ‘ä»¬èƒ½æ”¾å…¥ç¼“å­˜çš„æ•°æ®æœ¬å°±ä¸åº”è¯¥æ˜¯å®æ—¶æ€§ã€ä¸€è‡´æ€§è¦æ±‚è¶…é«˜çš„ã€‚æ‰€ä»¥ç¼“å­˜æ•°æ®çš„æ—¶å€™åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œä¿è¯æ¯å¤©æ‹¿åˆ°å½“å‰æœ€æ–°æ•°æ®å³å¯ã€‚\r\n   - æˆ‘ä»¬ä¸åº”è¯¥è¿‡åº¦è®¾è®¡ï¼Œå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§\r\n   - é‡åˆ°å®æ—¶æ€§ã€ä¸€è‡´æ€§è¦æ±‚é«˜çš„æ•°æ®ï¼Œå°±åº”è¯¥æŸ¥æ•°æ®åº“ï¼Œå³ä½¿æ…¢ç‚¹ã€‚\r\n\r\n\r\n\r\n#### 4ã€ç¼“å­˜æ•°æ®ä¸€è‡´æ€§ - è§£å†³-Canal\r\n\r\n![image-20230410194458435](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410194458435.png)\r\n\r\n\r\n\r\n### å››ã€åˆ†å¸ƒå¼é”\r\n\r\n#### 1ã€åˆ†å¸ƒå¼é”ä¸æœ¬åœ°é”\r\n\r\n![image-20230425221131744](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230425221131744.png)\r\n\r\n- `org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getDataFromDb`\r\n  - æŠ½å–ä¸šåŠ¡æ–¹æ³•æ–¹ä¾¿åŠ é”\r\n\r\n```java\r\n/**\r\n * æŠ½å–ä¸šåŠ¡æ–¹æ³•\r\n *\r\n * @return\r\n */\r\nprivate Map<String, List<Catalog2Vo>> getDataFromDb() {\r\n    //è·å–ç¼“å­˜\r\n    String catalogJson = stringRedisTemplate.opsForValue().get(\"catalogJson\");\r\n    if (!StringUtils.isEmpty(catalogJson)) {\r\n        //ç¼“å­˜ä¸ä¸ºç©ºç›´æ¥è¿”å›\r\n        Map<String, List<Catalog2Vo>> result = JSON.parseObject(catalogJson, new TypeReference<Map<String, List<Catalog2Vo>>>() {\r\n        });\r\n        return result;\r\n    }\r\n    System.out.println(\"æŸ¥è¯¢äº†æ•°æ®åº“ã€‚ã€‚ã€‚\");\r\n\r\n    /**\r\n     * ç¼“å­˜ä¸ºç©ºï¼Œè¿›è¡ŒæŸ¥è¯¢ä¸šåŠ¡\r\n     * 1ã€å°†æ•°æ®åº“çš„å¤šæ¬¡æŸ¥è¯¢å˜ä¸ºä¸€æ¬¡ï¼Œå³æ–¹æ³•æŠ½å–\r\n     */\r\n    //æŸ¥è¯¢æ‰€æœ‰\r\n    List<CategoryEntity> selectList = baseMapper.selectList(null);\r\n\r\n    //1ã€æŸ¥å‡ºæ‰€æœ‰1çº§åˆ†ç±»                                   çˆ¶åˆ†ç±»é›†åˆï¼Œä¸€çº§åˆ†ç±»çˆ¶åˆ†ç±»idä¸º0\r\n    List<CategoryEntity> level1Categorys = getParent_cid(selectList, 0L);\r\n\r\n    //2ã€å°è£…æ•°æ®\r\n    Map<String, List<Catalog2Vo>> map = level1Categorys.stream().collect(Collectors.toMap(\r\n            //\"pCId\":\"c2{}\"\r\n            k -> k.getCatId().toString(),\r\n            v -> {\r\n                //2.1ã€æ¯ä¸€ä¸ªçš„ä¸€çº§åˆ†ç±»ï¼ŒæŸ¥åˆ°è¿™ä¸ªä¸€çº§åˆ†ç±»çš„[äºŒçº§åˆ†ç±»]\r\n                //å¾—åˆ°äºŒçº§åˆ†ç±»å®ä½“é›†åˆ æŠ½å–æŸ¥è¯¢æ–¹æ³•-> baseMapper.selectList(new QueryWrapper<CategoryEntity>().eq(\"parent_cid\", v.getCatId()));\r\n                //todo                                                 çˆ¶åˆ†ç±»é›†åˆï¼Œ å½“å‰åˆ†ç±»idï¼ˆvä¸ºå½“å‰éå†çš„ä¸€çº§åˆ†ç±»ï¼‰\r\n                List<CategoryEntity> catalog2Entities = getParent_cid(selectList, v.getCatId());\r\n                //2.2ã€å°è£…ä¸Šé¢çš„ç»“æœ\r\n                List<Catalog2Vo> catalog2Vos = null;\r\n                //çˆ¶åˆ†ç±»ä¸ä¸ºç©ºï¼Œå³äºŒçº§åˆ†ç±»å®ä½“é›†åˆä¸ä¸ºç©º\r\n                if (catalog2Entities != null) {\r\n                    //éå†æ‹¿åˆ°æ¯ä¸ªäºŒçº§åˆ†ç±»é›†åˆ\r\n                    catalog2Vos = catalog2Entities.stream().map(l2 -> {\r\n                        //å°è£…äºŒçº§åˆ†ç±»voæ•°æ®\r\n                        Catalog2Vo catalog2Vo = new Catalog2Vo(v.getCatId().toString(), null, l2.getCatId().toString(), l2.getName());\r\n                        //2.2.1ã€æ‰¾å½“å‰äºŒçº§åˆ†ç±»çš„ä¸‰çº§åˆ†ç±»å°è£…æˆvo baseMapper.selectList(new QueryWrapper<CategoryEntity>(). eq(\"parent_cid\", l2.getCatId()));\r\n                        //                                       ï¼ˆä¸‰çº§åˆ†ç±»çˆ¶åˆ†ç±»ï¼‰çˆ¶åˆ†ç±»é›†åˆï¼Œ å½“å‰åˆ†ç±»idï¼ˆl2ä¸ºå½“å‰éå†çš„äºŒçº§åˆ†ç±»ï¼‰\r\n                        List<CategoryEntity> catalog3Entities = getParent_cid(selectList, l2.getCatId());\r\n                        List<Catalog2Vo.Catalog3Vo> catalog3Vos = null;\r\n                        if (catalog3Entities != null) {\r\n                            catalog3Vos = catalog3Entities.stream().map(l3 -> {\r\n                                //2.2.2ã€å°è£…æˆæŒ‡å®šæ ¼å¼\r\n                                Catalog2Vo.Catalog3Vo catalog3Vo = new Catalog2Vo.Catalog3Vo(l2.getCatId().toString(), l3.getCatId().toString(), l3.getName());\r\n                                return catalog3Vo;\r\n                            }).collect(Collectors.toList());\r\n                            catalog2Vo.setCatalog3List(catalog3Vos);\r\n                        }\r\n\r\n\r\n                        return catalog2Vo;\r\n                    }).collect(Collectors.toList());\r\n                }\r\n                return catalog2Vos;\r\n            }));\r\n    //todo 3ã€æŸ¥åˆ°çš„æ•°æ®å†æ”¾å…¥ç¼“å­˜ï¼Œå°†å¯¹è±¡è½¬ä¸ºjsonæ”¾å…¥ç¼“å­˜ä¸­\r\n    String s = JSON.toJSONString(map);\r\n    //å°†æ•°æ®æ”¾å…¥ç¼“å­˜\r\n    stringRedisTemplate.opsForValue().set(\"catalogJson\", s, 1, TimeUnit.DAYS);\r\n    //å°†æ•°æ®åº“æŸ¥åˆ°çš„ç»“æœç›´æ¥è¿”å›ï¼Œå³å°†æ•°æ®åº“æŸ¥åˆ°çš„ç»“æœæ”¾ä¸€ä»½åˆ°ç¼“å­˜ä¸­å¹¶è¿”å›\r\n    return map;\r\n}\r\n\r\n/**\r\n     * æŠ½å–è·å–çˆ¶åˆ†ç±»idçš„æŸ¥è¯¢æ–¹æ³•ï¼Œä¼˜åŒ–ä¸‰çº§åˆ†ç±»æ•°æ®è·å–ï¼Œä½¿å¾—åœ¨å‹åŠ›æµ‹è¯•ä¸­ååé‡æœ‰æ˜æ˜¾çš„æé«˜ï¼›\r\n     * æŸ¥è¯¢æ•°æ®åº“æ˜¯å½±å“ååé‡é«˜ä½çš„é‡è¦å› ç´ ä¹‹ä¸€ï¼Œå› æ­¤å°½é‡å‡å°‘æ•°æ®åº“çš„æŸ¥è¯¢\r\n     *\r\n     * @param selectList\r\n     * @param parent_cid\r\n     * @return\r\n     */\r\n    private List<CategoryEntity> getParent_cid(List<CategoryEntity> selectList, Long parent_cid) {\r\n        //return baseMapper.selectList(new QueryWrapper<CategoryEntity>().eq(\"parent_cid\", v.getCatId()));\r\n        //ç›´æ¥è¿›è¡Œè¿‡æ»¤å¾—åˆ°å½“å‰éå†çš„çˆ¶åˆ†ç±»idä¸ºä¼ å…¥çš„çˆ¶åˆ†ç±»id\r\n        List<CategoryEntity> collect = selectList.stream().filter(item -> item.getParentCid().equals(parent_cid)).collect(Collectors.toList());\r\n        return collect;\r\n    }\r\n```\r\n\r\n- ä½¿ç”¨æœ¬åœ°é”\r\n\r\n```java\r\n/**\r\n     * ä½¿ç”¨redisç¼“å­˜çš„åŒæ—¶ä½¿ç”¨æœ¬åœ°é”ï¼ˆåŒæ­¥é”ï¼‰æ¥æ‰§è¡Œä¸šåŠ¡\r\n     *\r\n     * @return\r\n     */\r\n    public Map<String, List<Catalog2Vo>> getCatalogJsonFromDbWithLocalLock() {\r\n\r\n        //å¦‚æœç¼“å­˜ä¸­æœ‰å°±ç”¨ç¼“å­˜çš„\r\n//        Map<String, List<Catalog2Vo>> catalogJson = (Map<String, List<Catalog2Vo>>) cache.get(\"catalogJson\");\r\n//        if (catalogJson.get(\"catalogJson\") == null){\r\n//            //è°ƒç”¨ä¸šåŠ¡xxx\r\n//            //è¿”å›æ•°æ®åˆæ”¾å…¥ç¼“å­˜\r\n//            cache.put(\"catalogJson\", parent_cid);\r\n//        }\r\n//        return catalogJson;\r\n        //åªè¦æ˜¯åŒä¸€æŠŠé”ï¼Œå°±èƒ½é”ä½éœ€è¦çš„è¿™ä¸ªé”çš„æ‰€æœ‰çº¿ç¨‹\r\n        //1ã€synchronized (this):SpringBootæ‰€æœ‰çš„ç»„ä»¶åœ¨å®¹å™¨ä¸­éƒ½æ˜¯å•ä¾‹çš„\r\n        //todo æœ¬åœ°é”synchronizedï¼ŒJUC(Lock)ï¼Œåœ¨åˆ†å¸ƒå¼æƒ…å†µä¸‹ï¼Œæƒ³è¦é”ä½æ‰€æœ‰ï¼Œå¿…é¡»ä½¿ç”¨åˆ†å¸ƒå¼é”\r\n\r\n        //å•å®ä¾‹çš„åŠ é”ï¼Œå³æœ¬åœ°é”åªèƒ½é”ä½å½“å‰è¿›ç¨‹\r\n        synchronized (this) {\r\n            //å¾—åˆ°é”ä»¥åï¼Œæˆ‘ä»¬åº”è¯¥å†å»ç¼“å­˜ä¸­ç¡®å®šä¸€æ¬¡ï¼Œå¦‚æœæ²¡æœ‰æ‰éœ€è¦ç»§ç»­æŸ¥è¯¢\r\n            return getDataFromDb();\r\n        }\r\n\r\n    }\r\n```\r\n\r\n##### é”-æ—¶åºé—®é¢˜\r\n\r\n![image-20230410193041285](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193041285.png)\r\n\r\n#### 2ã€åˆ†å¸ƒå¼é”æ¼”è¿›\r\n\r\n##### åˆ†å¸ƒå¼é”æ¼”è¿›-åŸºæœ¬åŸç†\r\n\r\n![image-20230410193221079](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193221079.png)\r\n\r\n> æˆ‘ä»¬å¯ä»¥åŒæ—¶å»ä¸€ä¸ªåœ°æ–¹â€œå å‘â€ï¼Œå¦‚æœå åˆ°ï¼Œå°±æ‰§è¡Œé€»è¾‘ã€‚å¦åˆ™å°±å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°é‡Šæ”¾é”ã€‚\r\n> â€œå å‘â€å¯ä»¥å»redisï¼Œå¯ä»¥å»æ•°æ®åº“ï¼Œå¯ä»¥å»ä»»ä½•å¤§å®¶éƒ½èƒ½è®¿é—®çš„åœ°æ–¹ã€‚\r\n> ç­‰å¾…å¯ä»¥è‡ªæ—‹çš„æ–¹å¼ã€‚\r\n\r\n##### åˆ†å¸ƒå¼é”æ¼”è¿›-é˜¶æ®µä¸€\r\n\r\n![image-20230410193430589](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193430589.png)\r\n\r\n```java\r\nBoolean lock = redisTemplate.opsForValue().setIfAbsent(\"lock\", \"0\");\r\n        if (lock) {\r\n            // åŠ é”æˆåŠŸ..æ‰§è¡Œä¸šåŠ¡\r\n            Map<String,List<Catelog2Vo>> dataFromDb = getDataFromDB();\r\n            redisTemplate.delete(\"lock\"); // åˆ é™¤é”\r\n            return dataFromDb;\r\n        } else {\r\n            // åŠ é”å¤±è´¥ï¼Œé‡è¯• synchronized()\r\n            // ä¼‘çœ 100msé‡è¯•\r\n            return getCatelogJsonFromDbWithRedisLock();\r\n        }\r\n```\r\n\r\n\r\n\r\n##### åˆ†å¸ƒå¼é”æ¼”è¿›-é˜¶æ®µäºŒ\r\n\r\n![image-20230410193552631](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193552631.png)\r\n\r\n```java\r\nBoolean lock = redisTemplate.opsForValue().setIfAbsent()\r\n        if (lock) {\r\n            // åŠ é”æˆåŠŸ..æ‰§è¡Œä¸šåŠ¡\r\n            // è®¾ç½®è¿‡æœŸæ—¶é—´\r\n            redisTemplate.expire(\"lock\",30,TimeUnit.SECONDS);\r\n            Map<String,List<Catelog2Vo>> dataFromDb = getDataFromDB();\r\n            redisTemplate.delete(\"lock\"); // åˆ é™¤é”\r\n            return dataFromDb;\r\n        } else {\r\n            // åŠ é”å¤±è´¥ï¼Œé‡è¯• synchronized()\r\n            // ä¼‘çœ 100msé‡è¯•\r\n            return getCatelogJsonFromDbWithRedisLock();\r\n        }\r\n```\r\n\r\n\r\n\r\n##### åˆ†å¸ƒå¼é”æ¼”è¿›-é˜¶æ®µä¸‰\r\n\r\n![image-20230410193625611](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193625611.png)\r\n\r\n```java\r\n// è®¾ç½®å€¼åŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´\r\nBoolean lock = redisTemplate.opsForValue().setIfAbsent(\"lock\",\"111\",300,TimeUnit.SECONDS);\r\nif (lock) {\r\n    // åŠ é”æˆåŠŸ..æ‰§è¡Œä¸šåŠ¡\r\n    // è®¾ç½®è¿‡æœŸæ—¶é—´,å¿…é¡»å’ŒåŠ é”æ˜¯åŒæ­¥çš„ï¼ŒåŸå­çš„\r\n    redisTemplate.expire(\"lock\",30,TimeUnit.SECONDS);\r\n    Map<String,List<Catelog2Vo>> dataFromDb = getDataFromDB();\r\n    redisTemplate.delete(\"lock\"); // åˆ é™¤é”\r\n    return dataFromDb;\r\n} else {\r\n    // åŠ é”å¤±è´¥ï¼Œé‡è¯• synchronized()\r\n    // ä¼‘çœ 100msé‡è¯•\r\n    return getCatelogJsonFromDbWithRedisLock();\r\n}\r\n```\r\n\r\n\r\n\r\n##### åˆ†å¸ƒå¼é”æ¼”è¿›-é˜¶æ®µå››\r\n\r\n![image-20230410193648301](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193648301.png)\r\n\r\n```java\r\nString uuid = UUID.randomUUID().toString();\r\n        // è®¾ç½®å€¼åŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´\r\n        Boolean lock = redisTemplate.opsForValue().setIfAbsent(\"lock\",uuid,300,TimeUnit.SECONDS);\r\n        if (lock) {\r\n            // åŠ é”æˆåŠŸ..æ‰§è¡Œä¸šåŠ¡\r\n            // è®¾ç½®è¿‡æœŸæ—¶é—´,å¿…é¡»å’ŒåŠ é”æ˜¯åŒæ­¥çš„ï¼ŒåŸå­çš„\r\n//            redisTemplate.expire(\"lock\",30,TimeUnit.SECONDS);\r\n            Map<String,List<Catelog2Vo>> dataFromDb = getDataFromDB();\r\n//            String lockValue = redisTemplate.opsForValue().get(\"lock\");\r\n//            if (lockValue.equals(uuid)) {\r\n//                // åˆ é™¤æˆ‘è‡ªå·±çš„é”\r\n//                redisTemplate.delete(\"lock\"); // åˆ é™¤é”\r\n//            }\r\n// é€šè¿‡ä½¿ç”¨luaè„šæœ¬è¿›è¡ŒåŸå­æ€§åˆ é™¤\r\n            String script = \"if redis.call('get',KEYS[1]) == ARGV[1] then return redis.call('del',KEYS[1]) else return 0 end\";\r\n                //åˆ é™¤é”\r\n                Long lock1 = redisTemplate.execute(new DefaultRedisScript<Long>(script, Long.class), Arrays.asList(\"lock\"), uuid);\r\n\r\n            return dataFromDb;\r\n        } else {\r\n            // åŠ é”å¤±è´¥ï¼Œé‡è¯• synchronized()\r\n            // ä¼‘çœ 100msé‡è¯•\r\n            return getCatelogJsonFromDbWithRedisLock();\r\n        }\r\n```\r\n\r\n\r\n\r\n##### åˆ†å¸ƒå¼é”æ¼”è¿›-é˜¶æ®µäº”-æœ€ç»ˆå½¢æ€\r\n\r\n![image-20230410193719776](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193719776.png)\r\n\r\n- `org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getCatalogJsonFromDbWithRedisLock`\r\n\r\n```java\r\n /**\r\n     * ä½¿ç”¨redisåˆ†å¸ƒå¼é”æ¥æ‰§è¡Œä¸šåŠ¡ï¼ˆluoè„šæœ¬è§£é”ï¼‰\r\n     *\r\n     * @return\r\n     */\r\n    //@Override\r\n    public Map<String, List<Catalog2Vo>> getCatalogJsonFromDbWithRedisLock() {\r\n\r\n        //æŠ¢å é”å‰ï¼Œæ¯äººéƒ½è·å–å”¯ä¸€idè®¾ç½®æˆlockçš„valueå€¼\r\n        String uuid = UUID.randomUUID().toString();\r\n        //1ã€å åˆ†å¸ƒå¼é”ï¼Œå»rediså å‘(åŸå­æ“ä½œ)  SET  lock(k)  1111(v)     NX                        EX(æ—¶é—´ä¸èƒ½å¤ªçŸ­)\r\n        Boolean lock = stringRedisTemplate.opsForValue().setIfAbsent(\"lock\", uuid, 300, TimeUnit.SECONDS);\r\n        if (lock) {\r\n            System.out.println(\"è·å–åˆ†å¸ƒå¼é”æˆåŠŸ.......\");\r\n            //2ã€è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢å‡ºç°æ­»é”æƒ…å†µ(è‹¥çªç„¶æ–­ç”µè€Œæ— æ³•æ‰§è¡Œè®¾ç½®è¿‡æœŸæ—¶é—´)\r\n            //å› æ­¤è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¿…é¡»å’ŒåŠ é”æ˜¯åŒæ­¥çš„ï¼ŒåŸå­çš„\r\n            //stringRedisTemplate.expire(\"lock\", 30, TimeUnit.SECONDS);\r\n\r\n            Map<String, List<Catalog2Vo>> dataFromDb;\r\n            try {\r\n                //åŠ é”æˆåŠŸ.... æ‰§è¡Œä¸šåŠ¡\r\n                dataFromDb = getDataFromDb();\r\n            } finally {\r\n                //æ— è®ºä¸šåŠ¡å´©æºƒæˆ–å¼‚å¸¸ç­‰æƒ…å†µéƒ½æ‰§è¡Œåˆ é™¤é”ï¼Œåªè¦ä¿è¯åŸå­åŠ é”å’ŒåŸå­è§£é”æ²¡æœ‰é—®é¢˜å³å¯\r\n                //å› æ­¤å¯ä»¥ä½¿ç”¨luoè„šæœ¬è§£é”æ¥å®ç°åŸå­æ“ä½œ\r\n                //                              æŒ‡å®šçš„lock(key) == æŒ‡å®šçš„uuid(value)                                        åˆ é™¤è¿”å›1ï¼Œå¤±è´¥è¿”å›0\r\n                String script = \"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\";\r\n                //æ‰§è¡Œè„šæœ¬ï¼Œåˆ é™¤é”\r\n                Long lock1 = stringRedisTemplate.execute(\r\n                        //åˆ é™¤key->æˆåŠŸè¿”å›1ï¼Œå¤±è´¥è¿”å›0ï¼Œè¿”å›å€¼ä¸ºInteger\r\n                        new DefaultRedisScript<Long>(script, Long.class),\r\n                        //æ‰€æœ‰çš„keyé›†åˆ->å¾—åˆ°locké›†åˆ\r\n                        Arrays.asList(\"lock\"), uuid);\r\n            }\r\n            //è·å–å€¼å¯¹æ¯”+å¯¹æ¯”æˆåŠŸåˆ é™¤=åŸå­æ“ä½œï¼Œå¦åˆ™ï¼Œå³ä½¿æ¯”å¯¹æˆåŠŸä¹Ÿå¯èƒ½åˆ çš„æ˜¯åˆ«äººçš„é”\r\n//            String lockValue = stringRedisTemplate.opsForValue().get(\"lock\");\r\n//            //æ ¹æ®å é”çš„å”¯ä¸€Idå€¼åˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€æŠŠé”\r\n//            // æç«¯æƒ…å†µï¼Œ10sè¿‡æœŸæ—¶é—´ï¼Œæ‰§è¡Œä¸šåŠ¡ç”¨äº†9.5sï¼Œä½†è·å–é”è¦å‘é€è¯·æ±‚åˆ°è¿œç¨‹çš„redisæ¥è¿”å›æ•°æ®ï¼Œæ‰€éœ€æ—¶é—´ä¸º0.3sï¼Œåˆ¤æ–­éœ€è¦1sï¼Œ\r\n//            // å³æ¯”å¯¹æˆåŠŸæ—¶é”å·²è¿‡æœŸï¼Œåˆ çš„æ˜¯redisåˆšæ›´æ–°çš„æŠ¢å é”\r\n//            if (uuid.equals(lockValue)){\r\n//                //æ˜¯åŒä¸€æŠŠé”å°±æŠŠè¿™æŠŠé”åˆ æ‰\r\n//                //ä¸šåŠ¡æ‰§è¡Œå®Œæ¯•åè§£é”-> åˆ é™¤é”(key)\r\n//                stringRedisTemplate.delete(\"lock\");\r\n//            }\r\n\r\n            return dataFromDb;\r\n        } else {\r\n            System.out.println(\"è·å–åˆ†å¸ƒå¼é”å¤±è´¥.......ç­‰å¾…é‡è¯•\");\r\n            //åŠ é”å¤±è´¥....é‡è¯•ã€‚ã€‚synchronized ()\r\n            //ä¼‘çœ 200msé‡è¯•\r\n            try {\r\n                Thread.sleep(200);\r\n            } catch (InterruptedException e) {\r\n\r\n            }\r\n            //è‡ªæ—‹çš„æ–¹å¼-> é‡æ–°è·å–é”\r\n            return getCatalogJsonFromDbWithRedisLock();\r\n        }\r\n\r\n\r\n    }\r\n```\r\n\r\n- ç»™é¡µé¢è¿”å›æ‰€æœ‰åˆ†ç±»çš„Jsonæ•°æ®ï¼ˆåŠ Redisé”ï¼‰`org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getCatalogJson2`\r\n\r\n```java\r\n/**\r\n     * æŠ½å–ç¼“å­˜æ“ä½œæ–¹æ³•ï¼ˆä½¿ç”¨äº†RedisLockï¼‰\r\n     * æ²¡åŠ ç¼“å­˜æ³¨è§£å‰çš„ç¼“å­˜æ“ä½œä¸šåŠ¡ä»£ç ï¼ˆè·å–åˆ†ç±»çš„jsonæ•°æ®ï¼‰\r\n     * @return\r\n     */\r\n    //@Override\r\n    public Map<String, List<Catalog2Vo>> getCatalogJson2() {\r\n\r\n        //ç»™ç¼“å­˜ä¸­æ”¾jsonå­—ç¬¦ä¸²ï¼Œæ‹¿å‡ºçš„jsonå­—ç¬¦ä¸²ï¼Œè¿˜è¦é€†è½¬ä¸ºèƒ½ç”¨çš„å¯¹è±¡ç±»å‹ã€åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‘\r\n\r\n        /**\r\n         * 1ã€ç©ºç»“æœç¼“å­˜ï¼Œè§£å†³ç¼“å­˜ç©¿é€\r\n         * 2ã€è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆåŠ éšæœºå€¼ï¼‰ï¼šè§£å†³ç¼“å­˜é›ªå´©\r\n         * 3ã€åŠ é”ï¼šè§£å†³ç¼“å­˜å‡»ç©¿\r\n         */\r\n\r\n        //1ã€åŠ å…¥ç¼“å­˜é€»è¾‘ï¼Œç¼“å­˜ä¸­å­˜æ”¾çš„æ•°æ®æ˜¯jsonå­—ç¬¦ä¸²\r\n        //jsonè·¨è¯­è¨€ï¼Œè·¨å¹³å°å…¼å®¹\r\n        String catalogJson = stringRedisTemplate.opsForValue().get(\"catalogJson\");\r\n        if (StringUtils.isEmpty(catalogJson)) {\r\n            //2ã€ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒæŸ¥è¯¢æ•°æ®åº“\r\n            //ä¿è¯æ•°æ®åº“æŸ¥è¯¢å®Œæˆä»¥åï¼Œå°†æ•°æ®æ”¾åœ¨redisä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸå­æ“ä½œ\r\n            System.out.println(\"ç¼“å­˜ä¸å‘½ä¸­ã€‚ã€‚ã€‚ã€‚å°†è¦æŸ¥è¯¢æ•°æ®åº“ã€‚ã€‚ã€‚\");\r\n            Map<String, List<Catalog2Vo>> catalogJsonFromDb = getCatalogJsonFromDbWithRedisLock();\r\n//            //3ã€æŸ¥åˆ°çš„æ•°æ®å†æ”¾å…¥ç¼“å­˜ï¼Œå°†å¯¹è±¡è½¬ä¸ºjsonæ”¾å…¥ç¼“å­˜ä¸­\r\n//            String s = JSON.toJSONString(catalogJsonFromDb);\r\n//            //å°†æ•°æ®æ”¾å…¥ç¼“å­˜\r\n//            stringRedisTemplate.opsForValue().set(\"catalogJson\", s, 1, TimeUnit.DAYS);\r\n            //å°†æ•°æ®åº“æŸ¥åˆ°çš„ç»“æœç›´æ¥è¿”å›ï¼Œå³å°†æ•°æ®åº“æŸ¥åˆ°çš„ç»“æœæ”¾ä¸€ä»½åˆ°ç¼“å­˜ä¸­å¹¶è¿”å›\r\n            return catalogJsonFromDb;\r\n        }\r\n        System.out.println(\"ç¼“å­˜å‘½ä¸­ã€‚ã€‚ã€‚ã€‚ç›´æ¥è¿”å›ã€‚ã€‚ã€‚\");\r\n        //å°†æ•°æ®è½¬ä¸ºæŒ‡å®šç±»å‹\r\n        Map<String, List<Catalog2Vo>> result = JSON.parseObject(catalogJson, new TypeReference<Map<String, List<Catalog2Vo>>>() {\r\n        });\r\n        return result;\r\n    }\r\n```\r\n\r\n#### 3ã€Redisson å®Œæˆåˆ†å¸ƒå¼é”\r\n\r\n**1ã€ç®€ä»‹**\r\n\r\nRedisson æ˜¯æ¶è®¾åœ¨ Redis åŸºç¡€ä¸Šçš„ä¸€ä¸ª Java é©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ã€‚å……åˆ†\r\nçš„åˆ©ç”¨äº† Redis é”®å€¼æ•°æ®åº“æä¾›çš„ä¸€ç³»åˆ—ä¼˜åŠ¿ï¼ŒåŸºäº Java å®ç”¨å·¥å…·åŒ…ä¸­å¸¸ç”¨æ¥å£ï¼Œä¸ºä½¿ç”¨è€…\r\næä¾›äº†ä¸€ç³»åˆ—å…·æœ‰åˆ†å¸ƒå¼ç‰¹æ€§çš„å¸¸ç”¨å·¥å…·ç±»ã€‚ä½¿å¾—åŸæœ¬ä½œä¸ºåè°ƒå•æœºå¤šçº¿ç¨‹å¹¶å‘ç¨‹åºçš„å·¥\r\nå…·åŒ…è·å¾—äº†åè°ƒåˆ†å¸ƒå¼å¤šæœºå¤šçº¿ç¨‹å¹¶å‘ç³»ç»Ÿçš„èƒ½åŠ›ï¼Œå¤§å¤§é™ä½äº†è®¾è®¡å’Œç ”å‘å¤§è§„æ¨¡åˆ†å¸ƒå¼\r\nç³»ç»Ÿçš„éš¾åº¦ã€‚åŒæ—¶ç»“åˆå„å¯Œç‰¹è‰²çš„åˆ†å¸ƒå¼æœåŠ¡ï¼Œæ›´è¿›ä¸€æ­¥ç®€åŒ–äº†åˆ†å¸ƒå¼ç¯å¢ƒä¸­ç¨‹åºç›¸äº’ä¹‹é—´\r\nçš„åä½œã€‚\r\nå®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95\r\n\r\n**2ã€å¼•å…¥ä¾èµ–**\r\n\r\n```xml\r\n<!--ä»¥åä½¿ç”¨redissonä½œä¸ºæ‰€æœ‰åˆ†å¸ƒå¼é”ï¼Œåˆ†å¸ƒå¼å¯¹è±¡ç­‰åŠŸèƒ½æ¡†æ¶ -->\r\n<dependency>\r\n    <groupId>org.redisson</groupId>\r\n    <artifactId>redisson</artifactId>\r\n    <version>3.12.0</version>\r\n</dependency>\r\n```\r\n\r\n**3ã€é…ç½®ç±»**\r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2022/9/7\r\n */\r\n@Configuration\r\npublic class MyRedissonConfig {\r\n\r\n    /**\r\n     * æ‰€æœ‰å¯¹Redissonçš„ä½¿ç”¨éƒ½æ˜¯é€šè¿‡RedissonClientå¯¹è±¡\r\n     * @return\r\n     * @throws IOException\r\n     */\r\n    @Bean(destroyMethod=\"shutdown\")\r\n    public RedissonClient redisson() throws IOException {\r\n        //1ã€åˆ›å»ºé…ç½®\r\n        //Redis url should start with redis:// or rediss://\r\n        Config config = new Config();\r\n        //å¯ä»¥ç”¨\"rediss://\"æ¥å¯ç”¨ SSL è¿æ¥\r\n        config.useSingleServer().setAddress(\"redis://192.168.10.103:6379\");\r\n\r\n        //2ã€æ ¹æ®configåˆ›å»ºå‡ºRedissonå®ä¾‹\r\n        RedissonClient redissonClient = Redisson.create(config);\r\n        return redissonClient;\r\n    }\r\n}\r\n```\r\n\r\n**4ã€ä½¿ç”¨åˆ†å¸ƒå¼é”**\r\n\r\n```java\r\nRLock lock = redisson.getLock(\"anyLock\");// æœ€å¸¸è§çš„ä½¿ç”¨æ–¹æ³•\r\nlock.lock();\r\n// åŠ é”ä»¥å 10 ç§’é’Ÿè‡ªåŠ¨è§£é”// æ— éœ€è°ƒç”¨ unlock æ–¹æ³•æ‰‹åŠ¨è§£é”\r\nlock.lock(10, TimeUnit.SECONDS);\r\n// å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾… 100 ç§’ï¼Œä¸Šé”ä»¥å 10 ç§’è‡ªåŠ¨è§£é” \r\nboolean res = lock.tryLock(100,10, TimeUnit.SECONDS);\r\nif (res) {\r\ntry {\r\n\t...\r\n} finally {\r\n\tlock.unlock();\r\n\t}\r\n}\r\n```\r\n\r\n- `org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getCatalogJsonFromDbWithRedissonLock`\r\n\r\n```java\r\n/**\r\n * ç¼“å­˜é‡Œé¢çš„æ•°æ®å¦‚ä½•å’Œæ•°æ®åº“ä¿æŒä¸€è‡´ï¼ˆä½¿ç”¨äº†RedissonLockï¼‰\r\n * ç¼“å­˜æ•°æ®ä¸€è‡´æ€§\r\n * 1ï¼‰ã€åŒå†™æ¨¡å¼\r\n * 2ï¼‰ã€å¤±æ•ˆæ¨¡å¼\r\n *\r\n * @return\r\n */\r\n//@Override\r\npublic Map<String, List<Catalog2Vo>> getCatalogJsonFromDbWithRedissonLock() {\r\n\r\n    //æŠ¢å é”å‰ï¼Œæ¯äººéƒ½è·å–å”¯ä¸€idè®¾ç½®æˆlockçš„valueå€¼\r\n    //1ã€å åˆ†å¸ƒå¼é”ï¼Œå»rediså å‘(åŸå­æ“ä½œ)\r\n    //æ³¨æ„ï¼šä¼ çš„é”åå­—ä¸€æ ·ï¼Œé”å°±ä¸€æ ·ï¼Œé”çš„ç²’åº¦ï¼Œè¶Šç»†è¶Šå¿«\r\n    //é”çš„ç²’åº¦ï¼šå…·ä½“ç¼“å­˜çš„æ˜¯æŸä¸ªæ•°æ®ï¼Œ11å·-å•†å“ï¼›product-11-lock  product-12-lock product-lock\r\n    RLock lock = redisson.getLock(\"catalogJson-lock\");\r\n    lock.lock();\r\n\r\n    Map<String, List<Catalog2Vo>> dataFromDb;\r\n    try {\r\n        dataFromDb = getDataFromDb();\r\n    } finally {\r\n        lock.unlock();\r\n    }\r\n    return dataFromDb;\r\n\r\n\r\n}\r\n```\r\n\r\n- æ›¿æ¢Redisé”ä¸šåŠ¡æ–¹æ³•ä¸ºRedissoné”å¹¶è¿”å›ç»™é¡µé¢Jsonæ•°æ®\r\n\r\n`Map<String, List<Catalog2Vo>> catalogJsonFromDb = getCatalogJsonFromDbWithRedissonLock();`\r\n\r\n**5ã€ä½¿ç”¨å…¶ä»–**\r\n\r\n**è¡¥å……**\r\n\r\n- 1ã€è·å–ä¸€æŠŠé”ï¼Œåªè¦é”çš„åå­—ä¸€æ ·ï¼Œå°±æ˜¯åŒä¸€æŠŠé”\r\n  - RLock lock = redisson.getLock(\"my-lock\");\r\n- 2ã€åŠ é” é˜»å¡å¼ç­‰å¾…ï¼Œ(é»˜è®¤åŠ çš„é”éƒ½æ˜¯30sæ—¶é—´)å³å¦‚æœåŠ ä¸åˆ°é”ï¼Œå°±ä¼šåœ¨è¿™ä¸€ç›´ç­‰ç›´åˆ°åŠ åˆ°é”ä¸ºæ­¢æ‰ç»§ç»­æ‰§è¡Œä¸‹å»\r\n  - lock.lock();\r\n  - 1)ã€é”çš„è‡ªåŠ¨ç»­æœŸï¼Œå¦‚æœä¸šåŠ¡è¶…é•¿ï¼Œè¿è¡ŒæœŸé—´è‡ªåŠ¨ç»™é”ç»­ä¸Šæ–°çš„30sï¼Œå³ä¸ç”¨æ‹…å¿ƒä¸šåŠ¡æ—¶é—´é•¿è€Œé”è‡ªåŠ¨è¿‡æœŸè¢«åˆ æ‰\r\n  - 2)ã€åŠ é”çš„ä¸šåŠ¡åªè¦è¿è¡Œå®Œæˆï¼Œå°±ä¸ä¼šç»™å½“å‰é”ç»­æœŸï¼Œå³ä½¿ä¸æ‰‹åŠ¨è§£é”ï¼Œé”é»˜è®¤åœ¨30sä»¥åè‡ªåŠ¨åˆ é™¤\r\n- 10ç§’è‡ªåŠ¨è§£é”ï¼Œè‡ªåŠ¨è§£é”æ—¶é—´ä¸€å®šè¦å¤§äºä¸šåŠ¡çš„æ‰§è¡Œæ—¶é—´\r\n  - é—®é¢˜ï¼šlock.lock(10, TimeUnit.SECONDS);åœ¨é”æ—¶é—´åˆ°äº†ä»¥åï¼Œä¸ä¼šè‡ªåŠ¨ç»­æœŸ\r\n- 1ã€å¦‚æœæˆ‘ä»¬ä¼ é€’äº†é”çš„è¶…æ—¶æ—¶é—´ï¼Œå°±å‘é€ç»™redisæ‰§è¡Œè„šæœ¬ï¼Œè¿›è¡Œå é”ï¼Œé»˜è®¤è¶…æ—¶æ—¶é—´å°±æ˜¯æˆ‘ä»¬æŒ‡å®šçš„æ—¶é—´\r\n- 2ã€å¦‚æœæˆ‘ä»¬æœªæŒ‡å®šé”çš„è¶…æ—¶æ—¶é—´ï¼Œå°±ä½¿ç”¨30*1000ã€LockWatchingTimeoutçœ‹é—¨ç‹—çš„é»˜è®¤æ—¶é—´ã€‘ï¼›\r\n- åªè¦å é”æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ã€é‡æ–°ç»™é”è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ–°çš„è¿‡æœŸæ—¶é—´å°±æ˜¯çœ‹é—¨ç‹—çš„é»˜è®¤æ—¶é—´ã€‘ï¼Œæ¯éš”10séƒ½ä¼šè‡ªåŠ¨å†æ¬¡ç»­æœŸï¼Œç»­æˆ30s\r\n- internalLockLeaseTimeã€çœ‹é—¨ç‹—æ—¶é—´ã€‘/  3,10s\r\n\r\n- æœ€ä½³å®æˆ˜\r\n- lock.lock(30, TimeUnit.SECONDS);çœæ‰äº†æ•´ä¸ªç»­æœŸæ“ä½œï¼Œæ‰‹åŠ¨è§£é”\r\n\r\n```java\r\n@ResponseBody\r\n@GetMapping(\"/hello\")\r\npublic String hello() {\r\n\r\n    //1ã€è·å–ä¸€æŠŠé”ï¼Œåªè¦é”çš„åå­—ä¸€æ ·ï¼Œå°±æ˜¯åŒä¸€æŠŠé”\r\n    RLock lock = redisson.getLock(\"my-lock\");\r\n    //2ã€åŠ é” é˜»å¡å¼ç­‰å¾…ï¼Œ(é»˜è®¤åŠ çš„é”éƒ½æ˜¯30sæ—¶é—´)å³å¦‚æœåŠ ä¸åˆ°é”ï¼Œå°±ä¼šåœ¨è¿™ä¸€ç›´ç­‰ç›´åˆ°åŠ åˆ°é”ä¸ºæ­¢æ‰ç»§ç»­æ‰§è¡Œä¸‹å»\r\n    //lock.lock();\r\n    //1)ã€é”çš„è‡ªåŠ¨ç»­æœŸï¼Œå¦‚æœä¸šåŠ¡è¶…é•¿ï¼Œè¿è¡ŒæœŸé—´è‡ªåŠ¨ç»™é”ç»­ä¸Šæ–°çš„30sï¼Œå³ä¸ç”¨æ‹…å¿ƒä¸šåŠ¡æ—¶é—´é•¿è€Œé”è‡ªåŠ¨è¿‡æœŸè¢«åˆ æ‰\r\n    //2)ã€åŠ é”çš„ä¸šåŠ¡åªè¦è¿è¡Œå®Œæˆï¼Œå°±ä¸ä¼šç»™å½“å‰é”ç»­æœŸï¼Œå³ä½¿ä¸æ‰‹åŠ¨è§£é”ï¼Œé”é»˜è®¤åœ¨30sä»¥åè‡ªåŠ¨åˆ é™¤\r\n    //10ç§’è‡ªåŠ¨è§£é”ï¼Œè‡ªåŠ¨è§£é”æ—¶é—´ä¸€å®šè¦å¤§äºä¸šåŠ¡çš„æ‰§è¡Œæ—¶é—´\r\n    lock.lock(30, TimeUnit.SECONDS);\r\n    //todo é—®é¢˜ï¼šlock.lock(10, TimeUnit.SECONDS);åœ¨é”æ—¶é—´åˆ°äº†ä»¥åï¼Œä¸ä¼šè‡ªåŠ¨ç»­æœŸ\r\n    //1ã€å¦‚æœæˆ‘ä»¬ä¼ é€’äº†é”çš„è¶…æ—¶æ—¶é—´ï¼Œå°±å‘é€ç»™redisæ‰§è¡Œè„šæœ¬ï¼Œè¿›è¡Œå é”ï¼Œé»˜è®¤è¶…æ—¶æ—¶é—´å°±æ˜¯æˆ‘ä»¬æŒ‡å®šçš„æ—¶é—´\r\n    //2ã€å¦‚æœæˆ‘ä»¬æœªæŒ‡å®šé”çš„è¶…æ—¶æ—¶é—´ï¼Œå°±ä½¿ç”¨30*1000ã€LockWatchingTimeoutçœ‹é—¨ç‹—çš„é»˜è®¤æ—¶é—´ã€‘ï¼›\r\n    //     åªè¦å é”æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ã€é‡æ–°ç»™é”è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ–°çš„è¿‡æœŸæ—¶é—´å°±æ˜¯çœ‹é—¨ç‹—çš„é»˜è®¤æ—¶é—´ã€‘ï¼Œæ¯éš”10séƒ½ä¼šè‡ªåŠ¨å†æ¬¡ç»­æœŸï¼Œç»­æˆ30s\r\n    //     internalLockLeaseTimeã€çœ‹é—¨ç‹—æ—¶é—´ã€‘/  3,10s\r\n\r\n    //æœ€ä½³å®æˆ˜\r\n    //1ï¼‰ã€lock.lock(30, TimeUnit.SECONDS);çœæ‰äº†æ•´ä¸ªç»­æœŸæ“ä½œï¼Œæ‰‹åŠ¨è§£é”\r\n    try {\r\n        System.out.println(\"åŠ é”æˆåŠŸï¼Œæ‰§è¡Œä¸šåŠ¡ã€‚ã€‚ã€‚\" + Thread.currentThread().getId());\r\n        Thread.sleep(30000);\r\n    } catch (Exception e) {\r\n\r\n    } finally {\r\n        //3ã€è§£é”  å‡è®¾è§£é”ä»£ç æ²¡æœ‰è¿è¡Œï¼Œredissonä¼šä¸ä¼šå‡ºç°æ­»é”\r\n        System.out.println(\"é‡Šæ”¾é”ã€‚ã€‚ã€‚\" + Thread.currentThread().getId());\r\n        lock.unlock();\r\n    }\r\n\r\n    return \"hello\";\r\n}\r\n```\r\n\r\n**1ã€è¯»+å†™é”**\r\n\r\n```java\r\n /**\r\n     * ä¿è¯ä¸€å®šè¯»åˆ°æœ€æ–°æ•°æ®ï¼Œä¿®æ”¹æœŸé—´ï¼Œå†™é”æ˜¯ä¸€ä¸ªæ’å®ƒé”ï¼ˆäº’æ–¥é”ã€ç‹¬äº«é”ï¼‰ï¼Œè¯»é”æ˜¯ä¸€ä¸ªå…±äº«é”\r\n     * å†™é”æ²¡é‡Šæ”¾è¯»å°±å¿…é¡»ç­‰å¾…\r\n     * è¯» + è¯»ï¼š ç›¸å½“äºæ— é”ï¼Œå¹¶å‘è¯»ï¼Œåªä¼šåœ¨redisä¸­è®°å½•å¥½ï¼Œæ‰€æœ‰å½“å‰çš„è¯»é”ï¼Œå®ƒä»¬éƒ½ä¼šåŒæ—¶åŠ é”æˆåŠŸ\r\n     * å†™ + è¯»ï¼š ç­‰å¾…å†™é”é‡Šæ”¾\r\n     * å†™ + å†™ï¼š é˜»å¡çŠ¶æ€\r\n     * è¯» + å†™ï¼š æœ‰è¯»é”ï¼Œå†™ä¹Ÿéœ€è¦ç­‰å¾…\r\n     * åªè¦æœ‰å†™çš„å­˜åœ¨ï¼Œéƒ½å¿…é¡»ç­‰å¾…\r\n     * @return\r\n     */\r\n    @ResponseBody\r\n    @GetMapping(\"/write\")\r\n    public String writeValue() {\r\n        RReadWriteLock lock = redisson.getReadWriteLock(\"rw-lock\");\r\n        String s = \"\";\r\n        RLock rLock = lock.writeLock();\r\n        try {\r\n            //1ã€æ”¹æ•°æ®åŠ å†™é”ï¼Œè¯»æ•°æ®åŠ è¯»é”\r\n            rLock.lock();\r\n            System.out.println(\"å†™é”åŠ é”æˆåŠŸ...\" + Thread.currentThread().getId());\r\n            //v\r\n            s = UUID.randomUUID().toString();\r\n            Thread.sleep(30000);\r\n            //                                  k         v\r\n            redisTemplate.opsForValue().set(\"writeValue\", s);\r\n        } catch (Exception e) {\r\n\r\n        } finally {\r\n            rLock.unlock();\r\n            System.out.println(\"å†™é”é‡Šæ”¾\" + Thread.currentThread().getId());\r\n        }\r\n        return s;\r\n    }\r\n\r\n    //åˆ†å¸ƒå¼é‡Œçš„é”è·ŸJUCçš„APIé‡Œçš„é”å®Œå…¨ä¸€æ ·\r\n    @ResponseBody\r\n    @GetMapping(\"/read\")\r\n    public String readValue() {\r\n        RReadWriteLock lock = redisson.getReadWriteLock(\"rw-lock\");\r\n//        ReentrantReadWriteLock reentrantReadWriteLock = new ReentrantReadWriteLock();\r\n        String s = \"\";\r\n        RLock rLock = lock.readLock();\r\n        //1ã€è¯»æ•°æ®åŠ è¯»é”\r\n        rLock.lock();\r\n        try {\r\n            System.out.println(\"è¯»é”åŠ é”æˆåŠŸ.....\" + Thread.currentThread().getId());\r\n            s = redisTemplate.opsForValue().get(\"writeValue\");\r\n            Thread.sleep(30000);\r\n        } catch (Exception e) {\r\n\r\n        } finally {\r\n            rLock.unlock();\r\n            System.out.println(\"è¯»é”é‡Šæ”¾\" + Thread.currentThread().getId());\r\n        }\r\n        return s;\r\n    }\r\n```\r\n\r\n**2ã€ä¿¡å·é‡**\r\n\r\n```java\r\n/**\r\n     * è½¦åº“åœè½¦\r\n     * 3è½¦ä½\r\n     * ä¿¡å·é‡ä¹Ÿå¯ä»¥ç”¨ä½œåˆ†å¸ƒå¼é™æµ\r\n     * @return\r\n     */\r\n    @ResponseBody\r\n    @GetMapping(\"/park\")\r\n    public String park() throws InterruptedException {\r\n        RSemaphore park = redisson.getSemaphore(\"park\");\r\n//        park.acquire();//è·å–ä¸€ä¸ªä¿¡å·ï¼Œè·å–ä¸€ä¸ªå€¼ï¼Œå ä¸€ä¸ªè½¦ä½ï¼Œé˜»å¡å¼è·å–ï¼Œå³ä¸€å®šè¦è·å–åˆ°ä¸€ä¸ªè½¦ä½\r\n        boolean b = park.tryAcquire();//å°è¯•è·å–è½¦ä½ï¼Œæœ‰å°±åœï¼Œæ²¡æœ‰å°±ç®—äº†\r\n        if (b){\r\n            //æ‰§è¡Œä¸šåŠ¡\r\n        }else {\r\n            return \"error\";\r\n        }\r\n        return \"ok=>\" + b;\r\n    }\r\n\r\n\r\n    /**\r\n     * æŠŠè½¦å¼€èµ°ï¼Œè…¾ç©ºè½¦ä½\r\n     * @return\r\n     */\r\n    @ResponseBody\r\n    @GetMapping(\"/go\")\r\n    public String go(){\r\n        RSemaphore park = redisson.getSemaphore(\"park\");\r\n        park.release();//é‡Šæ”¾ä¸€ä¸ªä¿¡å·(è½¦ä½)\r\n        return \"ok\";\r\n    }\r\n```\r\n\r\n3ã€CountDownLatché—­é”\r\n\r\n```java\r\n/**\r\n * æ”¾å‡ é”é—¨\r\n * 1ç­æ²¡äººäº†ï¼Œ2\r\n * 5ä¸ªç­å…¨éƒ¨éƒ½èµ°å®Œï¼Œæˆ‘ä»¬å¯ä»¥é”å¤§é—¨\r\n * @return\r\n */\r\n@ResponseBody\r\n@GetMapping(\"/lockDoor\")\r\npublic String lockDoor() throws InterruptedException {\r\n    RCountDownLatch door = redisson.getCountDownLatch(\"door\");\r\n    door.trySetCount(5);\r\n    door.await();//ç­‰å¾…é—­é”éƒ½å®Œæˆ\r\n\r\n    return \"æ”¾å‡äº†...\";\r\n}\r\n\r\n@ResponseBody\r\n@GetMapping(\"/gogogo/{id}\")\r\npublic String gogogo(@PathVariable(\"id\") Long id){\r\n    RCountDownLatch door = redisson.getCountDownLatch(\"door\");\r\n    door.countDown();//è®¡æ•°å‡ä¸€\r\n\r\n    return id + \"ç­çš„äººéƒ½èµ°äº†...\";\r\n}\r\n```\r\n\r\n\r\n\r\n### äº”ã€Spring Cache\r\n\r\n#### 1ã€ç®€ä»‹\r\n\r\n- Spring ä» 3.1 å¼€å§‹å®šä¹‰äº† org.springframework.cache.Cacheå’Œ org.springframework.cache.CacheManager æ¥å£æ¥ç»Ÿä¸€ä¸åŒçš„ç¼“å­˜æŠ€æœ¯ï¼›å¹¶æ”¯æŒä½¿ç”¨ JCacheï¼ˆJSR-107ï¼‰æ³¨è§£ç®€åŒ–æˆ‘ä»¬å¼€å‘ï¼›\r\n\r\n- Cache æ¥å£ä¸ºç¼“å­˜çš„ç»„ä»¶è§„èŒƒå®šä¹‰ï¼ŒåŒ…å«ç¼“å­˜çš„å„ç§æ“ä½œé›†åˆï¼›Cache æ¥å£ä¸‹ Spring æä¾›äº†å„ç§ xxxCache çš„å®ç°ï¼›å¦‚ RedisCache ï¼ŒEhCacheCacheï¼Œ ConcurrentMapCache ç­‰ï¼›\r\n\r\n\r\n- æ¯æ¬¡è°ƒç”¨éœ€è¦ç¼“å­˜åŠŸèƒ½çš„æ–¹æ³•æ—¶ï¼ŒSpring ä¼šæ£€æŸ¥æ£€æŸ¥æŒ‡å®šå‚æ•°çš„æŒ‡å®šçš„ç›®æ ‡æ–¹æ³•æ˜¯å¦å·²ç»è¢«è°ƒç”¨è¿‡ï¼›å¦‚æœæœ‰å°±ç›´æ¥ä»ç¼“å­˜ä¸­è·å–æ–¹æ³•è°ƒç”¨åçš„ç»“æœï¼Œå¦‚æœæ²¡æœ‰å°±è°ƒç”¨æ–¹æ³•å¹¶ç¼“å­˜ç»“æœåè¿”å›ç»™ç”¨æˆ·ã€‚ä¸‹æ¬¡è°ƒç”¨ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ã€‚\r\n\r\n- ä½¿ç”¨ Spring ç¼“å­˜æŠ½è±¡æ—¶æˆ‘ä»¬éœ€è¦å…³æ³¨ä»¥ä¸‹ä¸¤ç‚¹ï¼›\r\n\r\n  - 1ã€ç¡®å®šæ–¹æ³•éœ€è¦è¢«ç¼“å­˜ä»¥åŠä»–ä»¬çš„ç¼“å­˜ç­–ç•¥\r\n\r\n  - 2ã€ä»ç¼“å­˜ä¸­è¯»å–ä¹‹å‰ç¼“å­˜å­˜å‚¨çš„æ•°æ®\r\n\r\n#### 2ã€åŸºç¡€æ¦‚å¿µ\r\n\r\n![image-20230425221542910](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230425221542910.png)\r\n\r\n#### 3ã€æ³¨è§£\r\n\r\n![image-20230425221610523](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230425221610523.png)\r\n\r\n![image-20230425221629685](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230425221629685.png)\r\n\r\n#### 4ã€è¡¨è¾¾å¼è¯­æ³•\r\n\r\n![image-20230425221651923](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230425221651923.png)\r\n\r\n#### 5ã€ç¼“å­˜ç©¿é€é—®é¢˜è§£å†³ï¼ˆå…è®¸ null å€¼ç¼“å­˜ï¼‰\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>org.springframework.boot</groupId>\r\n    <artifactId>spring-boot-starter-data-redis</artifactId>\r\n<dependency>\r\n    <groupId>org.springframework.boot</groupId>\r\n    <artifactId>spring-boot-starter-cache</artifactId>\r\n</dependency>\r\n```\r\n\r\n#### 6ã€ä½¿ç”¨\r\n\r\n- æ·»åŠ é…ç½®ç±»å°†é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰é…ç½®éƒ½ç”Ÿæ•ˆ\r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2022/9/7\r\n */\r\n@EnableConfigurationProperties(CacheProperties.class)\r\n@EnableCaching\r\n@Configuration\r\npublic class MyCacheConfig {\r\n\r\n//    @Autowired\r\n//    CacheProperties cacheProperties;\r\n\r\n    /**\r\n     * é…ç½®æ–‡ä»¶ä¸­çš„ä¸œè¥¿æ²¡æœ‰ç”¨ä¸Š\r\n     *\r\n     * 1ã€åŸæ¥å’Œé…ç½®æ–‡ä»¶ç»‘å®šçš„é…ç½®ç±»æ˜¯è¿™æ ·å­çš„\r\n     *      @ConfigurationProperties( prefix = \"spring.cache\")\r\n     *      public class CacheProperties {\r\n     * 2ã€è¦è®©å®ƒç”Ÿæ•ˆ\r\n     *      @EnableConfigurationProperties(CacheProperties.class)\r\n     * @return\r\n     */\r\n    @Bean\r\n    RedisCacheConfiguration redisCacheConfiguration(CacheProperties cacheProperties) {\r\n\r\n        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig();\r\n        //config = config.entryTtl();\r\n        //è¦†ç›–é»˜è®¤é…ç½®\r\n        //å°†æ•°æ®çš„keyåºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²\r\n        config = config.serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()));\r\n        //å°†æ•°æ®çš„å€¼åºåˆ—åŒ–ä¸ºjsonæ ¼å¼ new GenericFastJsonRedisSerializer()å…¼å®¹å„ç§æ³›å‹\r\n        config = config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer()));\r\n\r\n        CacheProperties.Redis redisProperties = cacheProperties.getRedis();\r\n        //å°†é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰é…ç½®éƒ½ç”Ÿæ•ˆ\r\n        if (redisProperties.getTimeToLive() != null) {\r\n            config = config.entryTtl(redisProperties.getTimeToLive());\r\n        }\r\n\r\n        if (redisProperties.getKeyPrefix() != null) {\r\n            config = config.prefixKeysWith(redisProperties.getKeyPrefix());\r\n        }\r\n\r\n        if (!redisProperties.isCacheNullValues()) {\r\n            config = config.disableCachingNullValues();\r\n        }\r\n\r\n        if (!redisProperties.isUseKeyPrefix()) {\r\n            config = config.disableKeyPrefix();\r\n        }\r\n\r\n        return config;\r\n    }\r\n}\r\n```\r\n\r\n- é…ç½®æ–‡ä»¶æ·»åŠ ç›¸å…³é…ç½®\r\n\r\n```properties\r\nspring.cache.type=redis\r\n#è®¾ç½®ç¼“å­˜çš„æ•°æ®å­˜æ´»æ—¶é—´ï¼Œå³ttlæ—¶é—´ï¼ˆæ¯«ç§’ä¸ºå•ä½ï¼‰\r\nspring.cache.redis.time-to-live=3600000\r\n#todo è®¾ç½®å‰ç¼€åé…ç½®åï¼Œç¼“å­˜çš„åˆ†åŒºä¸è§äº†\r\n#å¦‚æœæŒ‡å®šäº†å‰ç¼€å°±ç”¨æˆ‘ä»¬æŒ‡å®šçš„å‰ç¼€CACHE_getLevel1Categorysï¼Œæ²¡æœ‰å°±é»˜è®¤ä½¿ç”¨ç¼“å­˜çš„åå­—ä½œä¸ºå‰ç¼€\r\n#spring.cache.redis.key-prefix=CACHE_\r\n#ä¸ä½¿ç”¨å‰ç¼€å°±ä½¿ç”¨è‡ªå·±æŒ‡å®šçš„keyå€¼ä½œä¸ºç¼“å­˜åå­—key = \"#root.method.name\"ï¼ŒgetLevel1Categorys\r\nspring.cache.redis.use-key-prefix=true\r\n#æ˜¯å¦ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç¼“å­˜ç©¿é€\r\nspring.cache.redis.cache-null-values=true\r\n```\r\n\r\n- è·å–æ‰€æœ‰åˆ†ç±»Jsonæ•°æ®æ¥å£`org.klaus.zgg01mall.product.web.IndexController#getCatalogJson`\r\n\r\n```java\r\n//index/catalog.json\r\n@ResponseBody\r\n@GetMapping(\"/index/catalog.json\")\r\npublic Map<String, List<Catalog2Vo>> getCatalogJson() {\r\n    Map<String, List<Catalog2Vo>> catalogJson = categoryService.getCatalogJson();\r\n    return catalogJson;\r\n}\r\n```\r\n\r\n- è·å–æ‰€æœ‰åˆ†ç±»Jsonæ•°æ®æ–¹æ³•å®ç°`org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getCatalogJson`\r\n\r\n```java\r\n/**\r\n * åŠ å…¥ç¼“å­˜æ³¨è§£ï¼Œå†æ¬¡ç®€åŒ–ç¼“å­˜æ“ä½œä¸šåŠ¡ä»£ç \r\n * @return\r\n */\r\n@Cacheable(value = \"category\", key = \"#root.methodName\")\r\n@Override\r\npublic Map<String, List<Catalog2Vo>> getCatalogJson() {\r\n    System.out.println(\"æŸ¥è¯¢äº†æ•°æ®åº“ã€‚ã€‚ã€‚\");\r\n\r\n    /**\r\n     * ç¼“å­˜ä¸ºç©ºï¼Œè¿›è¡ŒæŸ¥è¯¢ä¸šåŠ¡\r\n     * 1ã€å°†æ•°æ®åº“çš„å¤šæ¬¡æŸ¥è¯¢å˜ä¸ºä¸€æ¬¡ï¼Œå³æ–¹æ³•æŠ½å–\r\n     */\r\n    //æŸ¥è¯¢æ‰€æœ‰\r\n    List<CategoryEntity> selectList = baseMapper.selectList(null);\r\n\r\n    //1ã€æŸ¥å‡ºæ‰€æœ‰1çº§åˆ†ç±»                                   ä¸€çº§åˆ†ç±»é›†åˆï¼Œä¸€çº§åˆ†ç±»çˆ¶åˆ†ç±»idä¸º0\r\n    List<CategoryEntity> level1Categorys = getParent_cid(selectList, 0L);\r\n\r\n    //2ã€å°è£…æ•°æ®\r\n    Map<String, List<Catalog2Vo>> map = level1Categorys.stream().collect(Collectors.toMap(\r\n            //\"pCId\":\"c2{}\"\r\n            k -> k.getCatId().toString(),\r\n            v -> {\r\n                //2.1ã€æ¯ä¸€ä¸ªçš„ä¸€çº§åˆ†ç±»ï¼ŒæŸ¥åˆ°è¿™ä¸ªä¸€çº§åˆ†ç±»çš„[äºŒçº§åˆ†ç±»]\r\n                //å¾—åˆ°äºŒçº§åˆ†ç±»å®ä½“é›†åˆ æŠ½å–æŸ¥è¯¢æ–¹æ³•-> baseMapper.selectList(new QueryWrapper<CategoryEntity>().eq(\"parent_cid\", v.getCatId()));\r\n                //todo                                                 çˆ¶åˆ†ç±»é›†åˆï¼Œ å½“å‰åˆ†ç±»idï¼ˆvä¸ºå½“å‰éå†çš„ä¸€çº§åˆ†ç±»ï¼‰\r\n                List<CategoryEntity> catalog2Entities = getParent_cid(selectList, v.getCatId());\r\n                //2.2ã€å°è£…ä¸Šé¢çš„ç»“æœ\r\n                List<Catalog2Vo> catalog2Vos = null;\r\n                //çˆ¶åˆ†ç±»ä¸ä¸ºç©ºï¼Œå³äºŒçº§åˆ†ç±»å®ä½“é›†åˆä¸ä¸ºç©º\r\n                if (catalog2Entities != null) {\r\n                    //éå†æ‹¿åˆ°æ¯ä¸ªäºŒçº§åˆ†ç±»é›†åˆ\r\n                    catalog2Vos = catalog2Entities.stream().map(l2 -> {\r\n                        //å°è£…äºŒçº§åˆ†ç±»voæ•°æ®\r\n                        Catalog2Vo catalog2Vo = new Catalog2Vo(v.getCatId().toString(), null, l2.getCatId().toString(), l2.getName());\r\n                        //2.2.1ã€æ‰¾å½“å‰äºŒçº§åˆ†ç±»çš„ä¸‰çº§åˆ†ç±»å°è£…æˆvo baseMapper.selectList(new QueryWrapper<CategoryEntity>(). eq(\"parent_cid\", l2.getCatId()));\r\n                        //                                       ï¼ˆä¸‰çº§åˆ†ç±»çˆ¶åˆ†ç±»ï¼‰çˆ¶åˆ†ç±»é›†åˆï¼Œ å½“å‰åˆ†ç±»idï¼ˆl2ä¸ºå½“å‰éå†çš„äºŒçº§åˆ†ç±»ï¼‰\r\n                        List<CategoryEntity> catalog3Entities = getParent_cid(selectList, l2.getCatId());\r\n                        List<Catalog2Vo.Catalog3Vo> catalog3Vos = null;\r\n                        if (catalog3Entities != null) {\r\n                            catalog3Vos = catalog3Entities.stream().map(l3 -> {\r\n                                //2.2.2ã€å°è£…æˆæŒ‡å®šæ ¼å¼\r\n                                Catalog2Vo.Catalog3Vo catalog3Vo = new Catalog2Vo.Catalog3Vo(l2.getCatId().toString(), l3.getCatId().toString(), l3.getName());\r\n                                return catalog3Vo;\r\n                            }).collect(Collectors.toList());\r\n                            catalog2Vo.setCatalog3List(catalog3Vos);\r\n                        }\r\n\r\n\r\n                        return catalog2Vo;\r\n                    }).collect(Collectors.toList());\r\n                }\r\n                return catalog2Vos;\r\n            }));\r\n    return map;\r\n}\r\n```\r\n\r\n- é¦–é¡µè·å–ä¸€çº§åˆ†ç±»å“åº”è§†å›¾æ¸²æŸ“æ¥å£`org.klaus.zgg01mall.product.web.IndexController#indexPage`\r\n\r\n```java\r\n@GetMapping({\"/\", \"index.html\"})\r\n    public String indexPage(Model model) {\r\n//        System.out.println(\"\" + Thread.currentThread().getId());\r\n        //todo 1ã€æŸ¥å‡ºæ‰€æœ‰çš„1çº§åˆ†ç±»\r\n        List<CategoryEntity> categoryEntityList = categoryService.getLevel1Categorys();\r\n\r\n        //è§†å›¾è§£æå™¨è¿›è¡Œæ‹¼æ¥\r\n        //classpath:/templates/ + è¿”å›å€¼ +  .html\r\n        model.addAttribute(\"categorys\", categoryEntityList);\r\n        return \"index\";\r\n    }\r\n```\r\n\r\n- é¦–é¡µè·å–ä¸€çº§åˆ†ç±»æ–¹æ³•å®ç°`org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#getLevel1Categorys`\r\n\r\n```java\r\n@Cacheable(value = {\"category\"}, key = \"#root.method.name\", sync = true)\r\n@Override\r\npublic List<CategoryEntity> getLevel1Categorys() {\r\n    System.out.println(\"getLevel1Categorys.....\");\r\n    long l = System.currentTimeMillis();\r\n    //æŸ¥å‡ºä¸€çº§åˆ†ç±»ï¼Œå³çˆ¶åˆ†ç±»ä¸º0\r\n    List<CategoryEntity> categoryEntities = baseMapper.selectList(new QueryWrapper<CategoryEntity>().\r\n            eq(\"parent_cid\", 0));\r\n    //System.out.println(\"æ¶ˆè€—æ—¶é—´ï¼š\" + (System.currentTimeMillis() - l));\r\n    return categoryEntities;\r\n}\r\n```\r\n\r\n-  çº§è”æ›´æ–°æ‰€æœ‰å…³è”çš„æ•°æ®æ–¹æ³•å®ç°`org.klaus.zgg01mall.product.service.impl.CategoryServiceImpl#updateCascade`\r\n\r\n> @CacheEvict:å¤±æ•ˆæ¨¡å¼\r\n> 1ã€åŒæ—¶è¿›è¡Œå¤šç§ç¼“å­˜æ“ä½œ@Caching\r\n> 2ã€æŒ‡å®šåˆ é™¤æŸä¸ªåˆ†åŒºä¸‹çš„æ‰€æœ‰æ•°æ®@CacheEvict(value = \"category\", allEntries = true)\r\n> 3ã€å­˜å‚¨åŒä¸€ç±»å‹çš„æ•°æ®ï¼Œéƒ½å¯ä»¥æŒ‡å®šæˆåŒä¸€ä¸ªåˆ†åŒºï¼Œåˆ†åŒºåé»˜è®¤å°±æ˜¯ç¼“å­˜çš„å‰ç¼€\r\n\r\n```java\r\n//    @Caching(evict = {\r\n//            @CacheEvict(value = \"category\", key = \"'getLevel1Categorys'\"),\r\n//            @CacheEvict(value = \"category\", key = \"'getCatalogJson'\")\r\n//    })\r\n    //category::key å¤±æ•ˆæ¨¡å¼\r\n    @CacheEvict(value = \"category\", allEntries = true)\r\n//    @CachePut//åŒå†™æ¨¡å¼\r\n    @Transactional\r\n    @Override\r\n    public void updateCascade(CategoryEntity category) {\r\n        //å…ˆæ›´æ–°è‡ªå·±\r\n        this.updateById(category);\r\n        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());\r\n\r\n        //åŒæ—¶ä¿®æ”¹ç¼“å­˜ä¸­çš„æ•°æ®\r\n        //redis.del(\"catalogJSON\");ç­‰å¾…ä¸‹æ¬¡ä¸»åŠ¨æŸ¥è¯¢è¿›è¡Œæ›´æ–°\r\n    }\r\n```\r\n\r\n#### 7ã€æ€»ç»“\r\n\r\n**@Cacheable** \r\n\r\n- 1ã€æ¯ä¸€ä¸ªéœ€è¦ç¼“å­˜çš„æ•°æ®æˆ‘ä»¬éƒ½æ¥æŒ‡å®šè¦æ”¾åˆ°å“ªä¸ªåå­—çš„ç¼“å­˜ã€ç¼“å­˜çš„åˆ†åŒºï¼ˆæŒ‰ç…§ä¸šåŠ¡ç±»å‹åˆ†ï¼‰ã€‘\r\n\r\n- 2ã€ @Cacheable({\"category\"})\r\n\r\n- ä»£è¡¨å½“å‰æ–¹æ³•çš„ç»“æœéœ€è¦ç¼“å­˜ï¼Œ\r\n\r\n- å¦‚æœç¼“å­˜ä¸­æœ‰ï¼Œæ–¹æ³•å°±ä¸ç”¨è°ƒç”¨ï¼›è‹¥ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œä¼šè°ƒç”¨æ–¹æ³•ï¼Œæœ€åå°†æ–¹æ³•çš„ç»“æœæ”¾å…¥ç¼“å­˜\r\n\r\n- 3ã€é»˜è®¤è¡Œä¸º\r\n\r\n    * 1ï¼‰ã€å¦‚æœç¼“å­˜ä¸­æœ‰ï¼Œæ–¹æ³•å°±ä¸ç”¨è°ƒç”¨\r\n\r\n    * 2ï¼‰ã€keyé»˜è®¤è‡ªåŠ¨ç”Ÿæˆï¼š`ç¼“å­˜çš„åå­— ::SimpleKey [](è‡ªä¸»ç”Ÿæˆçš„keyå€¼)`\r\n\r\n    * 3ï¼‰ã€ç¼“å­˜çš„valueå€¼ï¼Œé»˜è®¤ä½¿ç”¨jdkåºåˆ—åŒ–æœºåˆ¶ï¼Œå°†åºåˆ—åŒ–åçš„æ•°æ®å­˜åˆ°redis\r\n\r\n    * 4ï¼‰ã€é»˜è®¤ttlæ—¶é—´ï¼š-1\r\n\r\n    * è‡ªå®šä¹‰ï¼šç¼“å­˜åˆ†åŒºï¼švalue = {\"category\"} :: ç¼“å­˜åå­—ï¼škey = \"'level1Categorys'\"/\"#root.method.name\"\r\n        * 1ï¼‰ã€æŒ‡å®šç”Ÿæˆçš„ç¼“å­˜ä½¿ç”¨çš„keyï¼š  keyå±æ€§æŒ‡å®šï¼Œæ¥å—ä¸€ä¸ªSpEl\r\n        * SpElè¯¦æƒ…ï¼šhttps://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#cache-spel-cont\r\n        * 2ï¼‰ã€æŒ‡å®šç¼“å­˜çš„æ•°æ®çš„å­˜æ´»æ—¶é—´ï¼š  é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ttl\r\n        * 3ï¼‰ã€å°†æ•°æ®ä¿å­˜ä¸ºjsonæ ¼å¼\r\n\r\n- 4ã€Spring-Cacheçš„ä¸è¶³ï¼š\r\n  - 1ï¼‰ã€è¯»æ¨¡å¼:\r\n    - ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸€ä¸ªnullæ•°æ®ï¼Œè§£å†³ï¼šç¼“å­˜ç©ºæ•°æ®ï¼šcache-null-values=true\r\n    - ç¼“å­˜å‡»ç©¿ï¼šå¤§é‡å¹¶å‘è¿›æ¥åŒæ—¶æŸ¥è¯¢ä¸€ä¸ªæ­£å¥½è¿‡æœŸçš„æ•°æ®ï¼Œè§£å†³LåŠ é”ï¼šï¼Ÿé€šè¿‡è°ƒè¯•æºç æ˜¯é»˜è®¤ä¸ºæ— åŠ é”çš„;sync = trueï¼ˆåŠ é”ï¼Œè§£å†³å‡»ç©¿ï¼‰\r\n    - ç¼“å­˜é›ªå´©ï¼šå¤§é‡çš„keyåŒæ—¶è¿‡æœŸï¼Œè§£å†³ï¼šåŠ éšæœºæ—¶é—´ï¼ŒåŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼šspring.cache.redis.time-to-live=3600000\r\n  - 2ï¼‰ã€å†™æ¨¡å¼: (ç¼“å­˜ä¸æ•°æ®åº“ä¸€è‡´)\r\n    - iï¼‰ã€è¯»å†™åŠ é”ï¼ˆé€‚ç”¨äºè¯»å¤šå†™å°‘çš„ç³»ç»Ÿï¼Œä½†è¯»å¤šäº†ä¸€ç›´åŠ é”ç­‰å¾…ä¹Ÿä¸åˆé€‚ï¼‰\r\n    - iiï¼‰ã€å¼•å…¥Canalï¼Œæ„ŸçŸ¥åˆ°MySqlçš„æ›´æ–°å»æ›´æ–°æ•°æ®åº“\r\n    - iiiï¼‰ã€è¯»å¤šå†™å¤šï¼Œç›´æ¥å»æ•°æ®åº“æŸ¥è¯¢å°±è¡Œ\r\n- æ€»ç»“ï¼š\r\n  - å¸¸è§„æ•°æ®ï¼ˆè¯»å¤šå†™å°‘ï¼Œå³æ—¶æ€§ï¼Œä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„æ•°æ®ï¼‰ï¼šå®Œå…¨å¯ä»¥ä½¿ç”¨Spring-Cacheï¼›å†™æ¨¡å¼ï¼ˆåªè¦ç¼“å­˜çš„æ•°æ®æœ‰è¿‡æœŸæ—¶é—´å°±è¶³å¤Ÿäº†ï¼‰\r\n- ç‰¹æ®Šæ•°æ®ï¼šç‰¹æ®Šè®¾è®¡\r\n- åŸç†ï¼š\r\n  - CacheManager(RedisCacheManager)->Cache(RedisCache)->Cacheè´Ÿè´£ç¼“å­˜çš„è¯»å†™\r\n\r\n**æ•´åˆSpringCacheç®€åŒ–ç¼“å­˜å¼€å‘**\r\n\r\n- 1)ã€å¼•å…¥ä¾èµ–\r\n  - spring-boot-starter-cacheã€spring-boot-starter-data-redis\r\n- 2ï¼‰ã€å†™é…ç½®\r\n  - i)ã€è‡ªåŠ¨é…ç½®äº†å“ªäº›\r\n    - CacheAutoConfigurationä¼šå¯¼å…¥RedisCacheConfiguration\r\n    - è‡ªåŠ¨é…å¥½äº†ç¼“å­˜ç®¡ç†å™¨RedisCacheManager\r\n  - ii)ã€é…ç½®ä½¿ç”¨redisä½œä¸ºç¼“å­˜\r\n    - spring.cache.type=redis\r\n- 3ï¼‰ã€æµ‹è¯•ä½¿ç”¨ç¼“å­˜\r\n  - @Cacheable: Triggers cache population. ï¼šè§¦å‘å°†æ•°æ®ä¿å­˜åˆ°ç¼“å­˜çš„æ“ä½œ\r\n  - @CacheEvict: Triggers cache eviction. ï¼š è§¦å‘å°†æ•°æ®ä»ç¼“å­˜ä¸­åˆ é™¤çš„æ“ä½œ\r\n  - @CachePut: Updates the cache without interfering with the method execution.ï¼šä¸å½±å“æ–¹æ³•æ‰§è¡Œæ›´æ–°ç¼“å­˜\r\n  - @Caching: Regroups multiple cache operations to be applied on a method.ï¼šç»„åˆä»¥ä¸Šå¤šä¸ªæ“ä½œ\r\n  - @CacheConfig: Shares some common cache-related settings at class-level.ï¼šåœ¨ç±»çº§åˆ«å…±äº«ç¼“å­˜çš„ç›¸åŒé…ç½®\r\n  - i)ã€å¼€å¯ç¼“å­˜åŠŸèƒ½ @EnableCaching\r\n  - ii)ã€åªéœ€è¦ä½¿ç”¨æ³¨è§£å°±èƒ½å®Œæˆç¼“å­˜æ“ä½œ\r\n- 4)ã€åŸç†ï¼š\r\n  - CacheAutoConfiguration â€”> RedisCacheConfiguration ->è‡ªåŠ¨é…ç½®äº†RedisCacheManager -> åˆå§‹åŒ–æ‰€æœ‰çš„ç¼“å­˜->æ¯ä¸ªç¼“å­˜å†³å®šä½¿ç”¨ä»€ä¹ˆé…ç½®->å¦‚æœredisCacheConfigurationæœ‰å°±ç”¨å·²æœ‰çš„ï¼Œæ²¡æœ‰å°±ç”¨é»˜è®¤->æƒ³æ”¹ç¼“å­˜çš„é…ç½®ï¼Œåªéœ€è¦ç»™å®¹å™¨ä¸­æ”¾ä¸€ä¸ªRedisCacheConfigurationå³å¯->å°±ä¼šåº”ç”¨åˆ°å½“å‰RedisCacheManagerç®¡ç†çš„æ‰€æœ‰ç¼“å­˜åˆ†åŒºä¸­"},{"title":"å¹¶å‘ç¼–ç¨‹æ•´ç†ç‰ˆ-åŸºç¡€/åŒæ­¥","tags":["Thread","ReentrantLock","Synchronized"],"categories":["Java","å¹¶å‘ç¼–ç¨‹"],"author":"imklaus","excerpt":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n","link":"/posts/Concurrent_Programming-Basic+Synchronous","content":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n<!-- more -->\r\n\r\n## è¿›ç¨‹ä¸çº¿ç¨‹\r\n\r\n### æ¦‚è¿°\r\n\r\nè¿›ç¨‹ï¼šç¨‹åºæ˜¯é™æ­¢çš„ï¼Œè¿›ç¨‹å®ä½“çš„è¿è¡Œè¿‡ç¨‹å°±æ˜¯è¿›ç¨‹ï¼Œæ˜¯ç³»ç»Ÿè¿›è¡Œ**èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½**\r\n\r\nè¿›ç¨‹çš„ç‰¹å¾ï¼šå¹¶å‘æ€§ã€å¼‚æ­¥æ€§ã€åŠ¨æ€æ€§ã€ç‹¬ç«‹æ€§ã€ç»“æ„æ€§\r\n\r\n**çº¿ç¨‹**ï¼šçº¿ç¨‹æ˜¯å±äºè¿›ç¨‹çš„ï¼Œæ˜¯ä¸€ä¸ªåŸºæœ¬çš„ CPU æ‰§è¡Œå•å…ƒï¼Œæ˜¯ç¨‹åºæ‰§è¡Œæµçš„æœ€å°å•å…ƒã€‚çº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­çš„ä¸€ä¸ªå®ä½“ï¼Œæ˜¯ç³»ç»Ÿ**ç‹¬ç«‹è°ƒåº¦çš„åŸºæœ¬å•ä½**ï¼Œçº¿ç¨‹æœ¬èº«ä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æºï¼Œåªæ‹¥æœ‰ä¸€ç‚¹åœ¨è¿è¡Œä¸­å¿…ä¸å¯å°‘çš„èµ„æºï¼Œä¸åŒå±ä¸€ä¸ªè¿›ç¨‹çš„å…¶ä»–çº¿ç¨‹å…±äº«è¿›ç¨‹æ‰€æ‹¥æœ‰çš„å…¨éƒ¨èµ„æº\r\n\r\nå…³ç³»ï¼šä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œè¿™å°±æ˜¯å¤šçº¿ç¨‹ï¼Œæ¯”å¦‚çœ‹è§†é¢‘æ˜¯è¿›ç¨‹ï¼Œå›¾ç”»ã€å£°éŸ³ã€å¹¿å‘Šç­‰å°±æ˜¯å¤šä¸ªçº¿ç¨‹\r\n\r\nçº¿ç¨‹çš„ä½œç”¨ï¼šä½¿å¤šé“ç¨‹åºæ›´å¥½çš„å¹¶å‘æ‰§è¡Œï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡å’Œç³»ç»Ÿååé‡ï¼Œå¢å¼ºæ“ä½œç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½\r\n\r\nå¹¶å‘å¹¶è¡Œï¼š\r\n\r\n* å¹¶è¡Œï¼šåœ¨åŒä¸€æ—¶åˆ»ï¼Œæœ‰å¤šä¸ªæŒ‡ä»¤åœ¨å¤šä¸ª CPU ä¸ŠåŒæ—¶æ‰§è¡Œ\r\n* å¹¶å‘ï¼šåœ¨åŒä¸€æ—¶åˆ»ï¼Œæœ‰å¤šä¸ªæŒ‡ä»¤åœ¨å•ä¸ª CPU ä¸Šäº¤æ›¿æ‰§è¡Œ\r\n\r\nåŒæ­¥å¼‚æ­¥ï¼š\r\n\r\n* éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥\r\n* ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å¯¹æ¯”\r\n\r\n#### çº¿ç¨‹è¿›ç¨‹å¯¹æ¯”\r\n\r\n* è¿›ç¨‹åŸºæœ¬ä¸Šç›¸äº’ç‹¬ç«‹çš„ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†\r\n\r\n* è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä¾›å…¶**å†…éƒ¨çš„çº¿ç¨‹å…±äº«**\r\n\r\n  - æ¯”å¦‚åœ¨Javaä¸­ï¼Œå½“æˆ‘ä»¬å¯åŠ¨ main å‡½æ•°å…¶å®å°±å¯åŠ¨äº†ä¸€ä¸ªJVMè¿›ç¨‹ï¼Œè€Œ main å‡½æ•°åœ¨çš„çº¿ç¨‹å°±æ˜¯è¿™ä¸ªè¿›ç¨‹ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿç§°ä¸»çº¿ç¨‹ã€‚\r\n\r\n  ![ç¨‹åºè¿›ç¨‹çº¿ç¨‹å…³ç³»](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/javathread-3.png)\r\n\r\n  > ä¸€ä¸ªè¿›ç¨‹ä¸­æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå¤šä¸ªçº¿ç¨‹å…±ç”¨è¿›ç¨‹çš„å †å’Œæ–¹æ³•åŒºèµ„æºï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨å’Œæ ˆã€‚\r\n\r\n* è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºå¤æ‚\r\n\r\n  åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡ç§°ä¸º IPCï¼ˆInter-process communicationï¼‰\r\n\r\n  * ä¿¡å·é‡ï¼šä¿¡å·é‡æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºå¤šè¿›ç¨‹å¯¹å…±äº«æ•°æ®çš„è®¿é—®ï¼Œè§£å†³åŒæ­¥ç›¸å…³çš„é—®é¢˜å¹¶é¿å…ç«äº‰æ¡ä»¶\r\n  * å…±äº«å­˜å‚¨ï¼šå¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œéœ€è¦ä½¿ç”¨ä¿¡å·é‡ç”¨æ¥åŒæ­¥å¯¹å…±äº«å­˜å‚¨çš„è®¿é—®\r\n  * ç®¡é“é€šä¿¡ï¼šç®¡é“æ˜¯ç”¨äºè¿æ¥ä¸€ä¸ªè¯»è¿›ç¨‹å’Œä¸€ä¸ªå†™è¿›ç¨‹ä»¥å®ç°å®ƒä»¬ä¹‹é—´é€šä¿¡çš„ä¸€ä¸ªå…±äº«æ–‡ä»¶ pipe æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªè¿›ç¨‹è®¿é—®ï¼Œæ‰€ä»¥åªæ”¯æŒ**åŠåŒå·¥é€šä¿¡**\r\n    * åŒ¿åç®¡é“ï¼ˆPipesï¼‰ï¼šç”¨äºå…·æœ‰äº²ç¼˜å…³ç³»çš„çˆ¶å­è¿›ç¨‹é—´æˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡\r\n    * å‘½åç®¡é“ï¼ˆNames Pipesï¼‰ï¼šä»¥ç£ç›˜æ–‡ä»¶çš„æ–¹å¼å­˜åœ¨ï¼Œå¯ä»¥å®ç°æœ¬æœºä»»æ„ä¸¤ä¸ªè¿›ç¨‹é€šä¿¡ï¼Œéµå¾ª FIFO\r\n  * æ¶ˆæ¯é˜Ÿåˆ—ï¼šå†…æ ¸ä¸­å­˜å‚¨æ¶ˆæ¯çš„é“¾è¡¨ï¼Œç”±æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦æ ‡è¯†ï¼Œèƒ½åœ¨ä¸åŒè¿›ç¨‹ä¹‹é—´æä¾›**å…¨åŒå·¥é€šä¿¡**ï¼Œå¯¹æ¯”ç®¡é“ï¼š\r\n    * åŒ¿åç®¡é“å­˜åœ¨äºå†…å­˜ä¸­çš„æ–‡ä»¶ï¼›å‘½åç®¡é“å­˜åœ¨äºå®é™…çš„ç£ç›˜ä»‹è´¨æˆ–è€…æ–‡ä»¶ç³»ç»Ÿï¼›æ¶ˆæ¯é˜Ÿåˆ—å­˜æ”¾åœ¨å†…æ ¸ä¸­ï¼Œåªæœ‰åœ¨å†…æ ¸é‡å¯ï¼ˆæ“ä½œç³»ç»Ÿé‡å¯ï¼‰æˆ–è€…æ˜¾ç¤ºåœ°åˆ é™¤ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—æ‰è¢«çœŸæ­£åˆ é™¤\r\n    * è¯»è¿›ç¨‹å¯ä»¥æ ¹æ®æ¶ˆæ¯ç±»å‹æœ‰é€‰æ‹©åœ°æ¥æ”¶æ¶ˆæ¯ï¼Œè€Œä¸åƒ FIFO é‚£æ ·åªèƒ½é»˜è®¤åœ°æ¥æ”¶\r\n\r\n  ä¸åŒè®¡ç®—æœºä¹‹é—´çš„**è¿›ç¨‹é€šä¿¡**ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œå¹¶éµå®ˆå…±åŒçš„åè®®ï¼Œä¾‹å¦‚ HTTP\r\n\r\n  * å¥—æ¥å­—ï¼šä¸å…¶å®ƒé€šä¿¡æœºåˆ¶ä¸åŒçš„æ˜¯ï¼Œå¯ç”¨äºä¸åŒæœºå™¨é—´çš„äº’ç›¸é€šä¿¡\r\n\r\n* çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºçº¿ç¨‹ä¹‹é—´å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ï¼Œä¸€ä¸ªä¾‹å­æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡\r\n\r\n  **Java ä¸­çš„é€šä¿¡æœºåˆ¶**ï¼švolatileã€ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€join æ–¹å¼ã€InheritableThreadLocalã€MappedByteBuffer\r\n\r\n* çº¿ç¨‹æ›´è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬ä¸Šè¦æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n#### è¿›ç¨‹å’Œçº¿ç¨‹çš„åˆ‡æ¢\r\n\r\n**ä¸Šä¸‹æ–‡åˆ‡æ¢**\r\n\r\nå†…æ ¸ä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹ç»´æŒä¸€ä¸ªä¸Šä¸‹æ–‡ã€‚**ä¸Šä¸‹æ–‡å°±æ˜¯å†…æ ¸é‡æ–°å¯åŠ¨ä¸€ä¸ªè¢«æŠ¢å çš„è¿›ç¨‹æ‰€éœ€çš„çŠ¶æ€**ã€‚åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š\r\n\r\n- é€šç”¨ç›®çš„å¯„å­˜å™¨\r\n- æµ®ç‚¹å¯„å­˜å™¨\r\n- ç¨‹åºè®¡æ•°å™¨\r\n- ç”¨æˆ·æ ˆ\r\n- çŠ¶æ€å¯„å­˜å™¨\r\n- å†…æ ¸æ ˆ\r\n- å„ç§å†…æ ¸æ•°æ®ç»“æ„ï¼šæ¯”å¦‚æç»˜åœ°å€ç©ºé—´çš„**é¡µè¡¨**ï¼ŒåŒ…å«æœ‰å…³å½“å‰è¿›ç¨‹ä¿¡æ¯çš„**è¿›ç¨‹è¡¨**ï¼Œä»¥åŠåŒ…å«è¿›ç¨‹å·²æ‰“å¼€æ–‡ä»¶çš„ä¿¡æ¯çš„**æ–‡ä»¶è¡¨**\r\n\r\n**è¿›ç¨‹åˆ‡æ¢å’Œçº¿ç¨‹åˆ‡æ¢çš„ä¸»è¦åŒºåˆ«**\r\n\r\næœ€ä¸»è¦çš„ä¸€ä¸ªåŒºåˆ«åœ¨äº**è¿›ç¨‹åˆ‡æ¢æ¶‰åŠè™šæ‹Ÿåœ°å€ç©ºé—´çš„åˆ‡æ¢è€Œçº¿ç¨‹ä¸ä¼š**ã€‚å› ä¸ºæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè€Œ**çº¿ç¨‹æ˜¯å…±äº«æ‰€åœ¨è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„**ï¼Œå› æ­¤åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„çº¿ç¨‹è¿›è¡Œçº¿ç¨‹åˆ‡æ¢æ—¶ä¸æ¶‰åŠè™šæ‹Ÿåœ°å€ç©ºé—´çš„è½¬æ¢ï¼Œé¡µè¡¨æŸ¥æ‰¾æ˜¯ä¸€ä¸ªå¾ˆæ…¢çš„è¿‡ç¨‹ï¼Œå› æ­¤é€šå¸¸ä½¿ç”¨cacheæ¥ç¼“å­˜å¸¸ç”¨çš„åœ°å€æ˜ å°„ï¼Œè¿™æ ·å¯ä»¥åŠ é€Ÿé¡µè¡¨æŸ¥æ‰¾ï¼Œè¿™ä¸ªcacheå°±æ˜¯å¿«è¡¨TLBï¼ˆtranslation Lookaside Bufferï¼Œç”¨æ¥åŠ é€Ÿé¡µè¡¨æŸ¥æ‰¾ï¼‰ã€‚ç”±äºæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œé‚£ä¹ˆæ˜¾ç„¶æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„é¡µè¡¨ï¼Œé‚£ä¹ˆ**å½“è¿›ç¨‹åˆ‡æ¢åé¡µè¡¨ä¹Ÿè¦è¿›è¡Œåˆ‡æ¢ï¼Œé¡µè¡¨åˆ‡æ¢åTLBå°±å¤±æ•ˆäº†**ï¼Œcacheå¤±æ•ˆå¯¼è‡´å‘½ä¸­ç‡é™ä½ï¼Œé‚£ä¹ˆè™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€å°±ä¼šå˜æ…¢ï¼Œè¡¨ç°å‡ºæ¥çš„å°±æ˜¯ç¨‹åºè¿è¡Œä¼šå˜æ…¢ï¼Œè€Œçº¿ç¨‹åˆ‡æ¢åˆ™ä¸ä¼šå¯¼è‡´TLBå¤±æ•ˆï¼Œå› ä¸ºçº¿ç¨‹çº¿ç¨‹æ— éœ€åˆ‡æ¢åœ°å€ç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬é€šå¸¸è¯´çº¿ç¨‹åˆ‡æ¢è¦æ¯”è¾ƒè¿›ç¨‹åˆ‡æ¢å¿«ï¼Œè€Œä¸”è¿˜å¯èƒ½å‡ºç°**ç¼ºé¡µä¸­æ–­**ï¼Œè¿™å°±éœ€è¦æ“ä½œç³»ç»Ÿå°†éœ€è¦çš„å†…å®¹è°ƒå…¥å†…å­˜ä¸­ï¼Œè‹¥å†…å­˜å·²æ»¡åˆ™è¿˜éœ€è¦å°†ä¸ç”¨çš„å†…å®¹è°ƒå‡ºå†…å­˜ï¼Œè¿™ä¹Ÿéœ€è¦èŠ±è´¹æ—¶é—´\r\n\r\n**ä¸ºä»€ä¹ˆTLBèƒ½åŠ å¿«è®¿é—®é€Ÿåº¦**\r\n\r\nå¿«è¡¨å¯ä»¥é¿å…æ¯æ¬¡éƒ½å¯¹é¡µå·è¿›è¡Œåœ°å€çš„æœ‰æ•ˆæ€§åˆ¤æ–­ã€‚å¿«è¡¨ä¸­ä¿å­˜äº†å¯¹åº”çš„ç‰©ç†å—å·ï¼Œå¯ä»¥ç›´æ¥è®¡ç®—å‡ºç‰©ç†åœ°å€ï¼Œæ— éœ€å†è¿›è¡Œæœ‰æ•ˆæ€§æ£€æŸ¥\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n### å¹¶å‘ä¸å¹¶è¡Œ\r\n\r\nå•æ ¸ cpu ä¸‹ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯ ä¸²è¡Œæ‰§è¡Œ çš„ã€‚æ“ä½œç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç»„ä»¶å«åšä»»åŠ¡è°ƒåº¦å™¨ï¼Œå°† cpu çš„æ—¶é—´ç‰‡ï¼ˆwindows\r\nä¸‹æ—¶é—´ç‰‡æœ€å°çº¦ä¸º 15 æ¯«ç§’ï¼‰åˆ†ç»™ä¸åŒçš„ç¨‹åºä½¿ç”¨ï¼Œåªæ˜¯ç”±äº cpu åœ¨çº¿ç¨‹é—´ï¼ˆæ—¶é—´ç‰‡å¾ˆçŸ­ï¼‰çš„åˆ‡æ¢éå¸¸å¿«ï¼Œäººç±»æ„Ÿ\r\nè§‰æ˜¯ åŒæ—¶è¿è¡Œçš„ ã€‚\r\næ€»ç»“ä¸ºä¸€å¥è¯å°±æ˜¯ï¼š å¾®è§‚ä¸²è¡Œï¼Œå®è§‚å¹¶è¡Œ ï¼Œä¸€èˆ¬ä¼šå°†è¿™ç§ çº¿ç¨‹è½®æµä½¿ç”¨ CPU çš„åšæ³•ç§°ä¸ºå¹¶å‘ï¼ˆconcurrentï¼‰ \r\n\r\n![image-20230711144528655](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230711144528655.png)\r\n\r\n![image-20230711144538488](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230711144538488.png)\r\n\r\nå¤šæ ¸ cpuä¸‹ï¼Œæ¯ä¸ª æ ¸ï¼ˆcoreï¼‰ éƒ½å¯ä»¥è°ƒåº¦è¿è¡Œçº¿ç¨‹ï¼Œè¿™æ—¶å€™çº¿ç¨‹å¯ä»¥æ˜¯å¹¶è¡Œçš„ã€‚\r\n\r\n![image-20230711144558304](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230711144558304.png)\r\n\r\nå¹¶å‘æ˜¯ä¸€ä¸ªCPUåœ¨ä¸åŒçš„æ—¶é—´å»ä¸åŒçº¿ç¨‹ä¸­æ‰§è¡ŒæŒ‡ä»¤ã€‚\r\n\r\nå¹¶è¡Œæ˜¯å¤šä¸ªCPUåŒæ—¶å¤„ç†ä¸åŒçš„çº¿ç¨‹ã€‚\r\n\r\nå¼•ç”¨ Rob Pike çš„ä¸€æ®µæè¿°ï¼š\r\n\r\n- å¹¶å‘ï¼ˆconcurrentï¼‰æ˜¯åŒä¸€æ—¶é—´**åº”å¯¹**ï¼ˆdealing withï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›\r\n- å¹¶è¡Œï¼ˆparallelï¼‰æ˜¯åŒä¸€æ—¶é—´**åŠ¨æ‰‹åš**ï¼ˆdoingï¼‰å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n## Java çº¿ç¨‹\r\n\r\n### åˆ›å»ºçº¿ç¨‹\r\n\r\n#### Thread\r\n\r\nThread åˆ›å»ºçº¿ç¨‹æ–¹å¼ï¼šåˆ›å»ºçº¿ç¨‹ç±»ï¼ŒåŒ¿åå†…éƒ¨ç±»æ–¹å¼\r\n\r\n* **start() æ–¹æ³•åº•å±‚å…¶å®æ˜¯ç»™ CPU æ³¨å†Œå½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”è§¦å‘ run() æ–¹æ³•æ‰§è¡Œ**\r\n* çº¿ç¨‹çš„å¯åŠ¨å¿…é¡»è°ƒç”¨ start() æ–¹æ³•ï¼Œå¦‚æœçº¿ç¨‹ç›´æ¥è°ƒç”¨ run() æ–¹æ³•ï¼Œç›¸å½“äºå˜æˆäº†æ™®é€šç±»çš„æ‰§è¡Œï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹å°†åªæœ‰æ‰§è¡Œè¯¥çº¿ç¨‹\r\n* å»ºè®®çº¿ç¨‹å…ˆåˆ›å»ºå­çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹çš„ä»»åŠ¡æ”¾åœ¨ä¹‹åï¼Œå¦åˆ™ä¸»çº¿ç¨‹ï¼ˆmainï¼‰æ°¸è¿œæ˜¯å…ˆæ‰§è¡Œå®Œ\r\n\r\nThread æ„é€ å™¨ï¼š\r\n\r\n* `public Thread()`\r\n* `public Thread(String name)`\r\n\r\n```java\r\npublic class ThreadDemo {\r\n    public static void main(String[] args) {\r\n        Thread t = new MyThread();\r\n        t.start();\r\n       \tfor(int i = 0 ; i < 100 ; i++ ){\r\n            System.out.println(\"mainçº¿ç¨‹\" + i)\r\n        }\r\n        // mainçº¿ç¨‹è¾“å‡ºæ”¾åœ¨ä¸Šé¢ å°±å˜æˆæœ‰å…ˆåé¡ºåºäº†ï¼Œå› ä¸ºæ˜¯ main çº¿ç¨‹é©±åŠ¨çš„å­çº¿ç¨‹è¿è¡Œ\r\n    }\r\n}\r\nclass MyThread extends Thread {\r\n    @Override\r\n    public void run() {\r\n        for(int i = 0 ; i < 100 ; i++ ) {\r\n            System.out.println(\"å­çº¿ç¨‹è¾“å‡ºï¼š\"+i)\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nç»§æ‰¿ Thread ç±»çš„ä¼˜ç¼ºç‚¹ï¼š\r\n\r\n* ä¼˜ç‚¹ï¼šç¼–ç ç®€å•\r\n* ç¼ºç‚¹ï¼šçº¿ç¨‹ç±»å·²ç»ç»§æ‰¿äº† Thread ç±»æ— æ³•ç»§æ‰¿å…¶ä»–ç±»äº†ï¼ŒåŠŸèƒ½ä¸èƒ½é€šè¿‡ç»§æ‰¿æ‹“å±•ï¼ˆå•ç»§æ‰¿çš„å±€é™æ€§ï¼‰\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### Runnable\r\n\r\nRunnable åˆ›å»ºçº¿ç¨‹æ–¹å¼ï¼šåˆ›å»ºçº¿ç¨‹ç±»ï¼ŒåŒ¿åå†…éƒ¨ç±»æ–¹å¼\r\n\r\nThread çš„æ„é€ å™¨ï¼š\r\n\r\n* `public Thread(Runnable target)`\r\n* `public Thread(Runnable target, String name)`\r\n\r\n```java\r\npublic class ThreadDemo {\r\n    public static void main(String[] args) {\r\n        Runnable target = new MyRunnable();\r\n        Thread t1 = new Thread(target,\"1å·çº¿ç¨‹\");\r\n\t\tt1.start();\r\n        Thread t2 = new Thread(target);//Thread-0\r\n    }\r\n}\r\n\r\npublic class MyRunnable implements Runnable{\r\n    @Override\r\n    public void run() {\r\n        for(int i = 0 ; i < 10 ; i++ ){\r\n            System.out.println(Thread.currentThread().getName() + \"->\" + i);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n**Thread ç±»æœ¬èº«ä¹Ÿæ˜¯å®ç°äº† Runnable æ¥å£**ï¼ŒThread ç±»ä¸­æŒæœ‰ Runnable çš„å±æ€§ï¼Œæ‰§è¡Œçº¿ç¨‹ run æ–¹æ³•åº•å±‚æ˜¯è°ƒç”¨ `Runnable#run`ï¼š\r\n\r\n```java\r\npublic class Thread implements Runnable {\r\n    private Runnable target;\r\n    \r\n    public void run() {\r\n        if (target != null) {\r\n          \t// åº•å±‚è°ƒç”¨çš„æ˜¯ Runnable çš„ run æ–¹æ³•\r\n            target.run();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nRunnable æ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼š\r\n\r\n* ç¼ºç‚¹ï¼šä»£ç å¤æ‚ä¸€ç‚¹ã€‚\r\n\r\n* ä¼˜ç‚¹ï¼š\r\n\r\n  1. çº¿ç¨‹ä»»åŠ¡ç±»åªæ˜¯å®ç°äº† Runnable æ¥å£ï¼Œå¯ä»¥ç»§ç»­ç»§æ‰¿å…¶ä»–ç±»ï¼Œé¿å…äº†å•ç»§æ‰¿çš„å±€é™æ€§\r\n\r\n  2. åŒä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡å¯¹è±¡å¯ä»¥è¢«åŒ…è£…æˆå¤šä¸ªçº¿ç¨‹å¯¹è±¡\r\n\r\n  3. é€‚åˆå¤šä¸ªçº¿ç¨‹å»å…±äº«åŒä¸€ä¸ªèµ„æº\r\n\r\n  4. å®ç°è§£è€¦æ“ä½œï¼Œçº¿ç¨‹ä»»åŠ¡ä»£ç å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œçº¿ç¨‹ä»»åŠ¡ä»£ç å’Œçº¿ç¨‹ç‹¬ç«‹\r\n\r\n  5. çº¿ç¨‹æ± å¯ä»¥æ”¾å…¥å®ç° Runnable æˆ– Callable çº¿ç¨‹ä»»åŠ¡å¯¹è±¡\r\n\r\nâ€‹     \r\n\r\n****\r\n\r\n\r\n\r\n#### Callable\r\n\r\nå®ç° Callable æ¥å£ï¼š\r\n\r\n1. å®šä¹‰ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ç±»å®ç° Callable æ¥å£ï¼Œç”³æ˜çº¿ç¨‹æ‰§è¡Œçš„ç»“æœç±»å‹\r\n2. é‡å†™çº¿ç¨‹ä»»åŠ¡ç±»çš„ call æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ç›´æ¥è¿”å›æ‰§è¡Œçš„ç»“æœ\r\n3. åˆ›å»ºä¸€ä¸ª Callable çš„çº¿ç¨‹ä»»åŠ¡å¯¹è±¡\r\n4. æŠŠ Callable çš„çº¿ç¨‹ä»»åŠ¡å¯¹è±¡**åŒ…è£…æˆä¸€ä¸ªæœªæ¥ä»»åŠ¡å¯¹è±¡**\r\n5. æŠŠæœªæ¥ä»»åŠ¡å¯¹è±¡åŒ…è£…æˆçº¿ç¨‹å¯¹è±¡\r\n6. è°ƒç”¨çº¿ç¨‹çš„ start() æ–¹æ³•å¯åŠ¨çº¿ç¨‹\r\n\r\n`public FutureTask(Callable<V> callable)`ï¼šæœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œåœ¨çº¿ç¨‹æ‰§è¡Œå®Œåå¾—åˆ°çº¿ç¨‹çš„æ‰§è¡Œç»“æœ\r\n\r\n* FutureTask å°±æ˜¯ Runnable å¯¹è±¡ï¼Œå› ä¸º **Thread ç±»åªèƒ½æ‰§è¡Œ Runnable å®ä¾‹çš„ä»»åŠ¡å¯¹è±¡**ï¼Œæ‰€ä»¥æŠŠ Callable åŒ…è£…æˆæœªæ¥ä»»åŠ¡å¯¹è±¡\r\n* çº¿ç¨‹æ± éƒ¨åˆ†è¯¦è§£äº† FutureTask çš„æºç \r\n\r\n`public V get()`ï¼šåŒæ­¥ç­‰å¾… task æ‰§è¡Œå®Œæ¯•çš„ç»“æœï¼Œå¦‚æœåœ¨çº¿ç¨‹ä¸­è·å–å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æœï¼Œä¼šé˜»å¡ç­‰å¾…ï¼Œç”¨äºçº¿ç¨‹åŒæ­¥\r\n\r\n* get() çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ\r\n* run() æ‰§è¡Œå®Œåä¼šæŠŠç»“æœè®¾ç½®åˆ° FutureTask  çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œget() çº¿ç¨‹å¯ä»¥è·å–åˆ°è¯¥å˜é‡çš„å€¼\r\n\r\nä¼˜ç¼ºç‚¹ï¼š\r\n\r\n* ä¼˜ç‚¹ï¼šåŒ Runnableï¼Œå¹¶ä¸”èƒ½å¾—åˆ°çº¿ç¨‹æ‰§è¡Œçš„ç»“æœ\r\n* ç¼ºç‚¹ï¼šç¼–ç å¤æ‚\r\n\r\n```java\r\npublic class ThreadDemo {\r\n    public static void main(String[] args) {\r\n        Callable call = new MyCallable();\r\n        FutureTask<String> task = new FutureTask<>(call);\r\n        Thread t = new Thread(task);\r\n        t.start();\r\n        try {\r\n            String s = task.get(); // è·å–callæ–¹æ³•è¿”å›çš„ç»“æœï¼ˆæ­£å¸¸/å¼‚å¸¸ç»“æœï¼‰\r\n            System.out.println(s);\r\n        }  catch (Exception e) {\r\n            e.printStackTrace();\r\n        }\r\n    }\r\n\r\npublic class MyCallable implements Callable<String> {\r\n    @Override//é‡å†™çº¿ç¨‹ä»»åŠ¡ç±»æ–¹æ³•\r\n    public String call() throws Exception {\r\n        return Thread.currentThread().getName() + \"->\" + \"Hello World\";\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### çº¿ç¨‹æ–¹æ³•\r\n\r\n#### API\r\n\r\nThread ç±» APIï¼š\r\n\r\n| æ–¹æ³•                                        | è¯´æ˜                                                         |\r\n| ------------------------------------------- | ------------------------------------------------------------ |\r\n| public void start()                         | å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼ŒJavaè™šæ‹Ÿæœºè°ƒç”¨æ­¤çº¿ç¨‹çš„ run æ–¹æ³•              |\r\n| public void run()                           | çº¿ç¨‹å¯åŠ¨åè°ƒç”¨è¯¥æ–¹æ³•                                         |\r\n| public void setName(String name)            | ç»™å½“å‰çº¿ç¨‹å–åå­—                                             |\r\n| public void getName()                       | è·å–å½“å‰çº¿ç¨‹çš„åå­—<br />çº¿ç¨‹å­˜åœ¨é»˜è®¤åç§°ï¼šå­çº¿ç¨‹æ˜¯ Thread-ç´¢å¼•ï¼Œä¸»çº¿ç¨‹æ˜¯ main |\r\n| public static Thread currentThread()        | è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ï¼Œä»£ç åœ¨å“ªä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ                       |\r\n| public static void sleep(long time)         | è®©å½“å‰çº¿ç¨‹ä¼‘çœ å¤šå°‘æ¯«ç§’å†ç»§ç»­æ‰§è¡Œ<br />**Thread.sleep(0)** : è®©æ“ä½œç³»ç»Ÿç«‹åˆ»é‡æ–°è¿›è¡Œä¸€æ¬¡ CPU ç«äº‰ |\r\n| public static native void yield()           | æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹ CPU çš„ä½¿ç”¨                      |\r\n| public final int getPriority()              | è¿”å›æ­¤çº¿ç¨‹çš„ä¼˜å…ˆçº§                                           |\r\n| public final void setPriority(int priority) | æ›´æ”¹æ­¤çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå¸¸ç”¨ 1 5 10                              |\r\n| public void interrupt()                     | ä¸­æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œå¼‚å¸¸å¤„ç†æœºåˆ¶                                   |\r\n| public static boolean interrupted()         | åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°                         |\r\n| public boolean isInterrupted()              | åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œä¸æ¸…é™¤æ‰“æ–­æ ‡è®°                       |\r\n| public final void join()                    | ç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸ                                             |\r\n| public final void join(long millis)         | ç­‰å¾…è¿™ä¸ªçº¿ç¨‹æ­»äº¡ millis æ¯«ç§’ï¼Œ0 æ„å‘³ç€æ°¸è¿œç­‰å¾…               |\r\n| public final native boolean isAlive()       | çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼ˆè¿˜æ²¡æœ‰è¿è¡Œå®Œæ¯•ï¼‰                               |\r\n| public final void setDaemon(boolean on)     | å°†æ­¤çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹æˆ–ç”¨æˆ·çº¿ç¨‹                             |\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### run start\r\n\r\nrunï¼šç§°ä¸ºçº¿ç¨‹ä½“ï¼ŒåŒ…å«äº†è¦æ‰§è¡Œçš„è¿™ä¸ªçº¿ç¨‹çš„å†…å®¹ï¼Œæ–¹æ³•è¿è¡Œç»“æŸï¼Œæ­¤çº¿ç¨‹éšå³ç»ˆæ­¢ã€‚ç›´æ¥è°ƒç”¨ run æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº† runï¼Œæ²¡æœ‰å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œéœ€è¦é¡ºåºæ‰§è¡Œ\r\n\r\nstartï¼šä½¿ç”¨ start æ˜¯å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œæ­¤çº¿ç¨‹å¤„äºå°±ç»ªï¼ˆå¯è¿è¡Œï¼‰çŠ¶æ€ï¼Œé€šè¿‡æ–°çš„çº¿ç¨‹é—´æ¥æ‰§è¡Œ run ä¸­çš„ä»£ç \r\n\r\nè¯´æ˜ï¼š**çº¿ç¨‹æ§åˆ¶èµ„æºç±»**\r\n\r\nrun() æ–¹æ³•ä¸­çš„å¼‚å¸¸ä¸èƒ½æŠ›å‡ºï¼Œåªèƒ½ try/catch\r\n\r\n* å› ä¸ºçˆ¶ç±»ä¸­æ²¡æœ‰æŠ›å‡ºä»»ä½•å¼‚å¸¸ï¼Œå­ç±»ä¸èƒ½æ¯”çˆ¶ç±»æŠ›å‡ºæ›´å¤šçš„å¼‚å¸¸\r\n* **å¼‚å¸¸ä¸èƒ½è·¨çº¿ç¨‹ä¼ æ’­å› main() ä¸­**ï¼Œå› æ­¤å¿…é¡»åœ¨æœ¬åœ°è¿›è¡Œå¤„ç†\r\n\r\n> **ä¸ºä»€ä¹ˆè°ƒç”¨start()æ–¹æ³•æ—¶ä¼šæ‰§è¡Œrun()æ–¹æ³•ï¼Œé‚£æ€ä¹ˆä¸ç›´æ¥è°ƒç”¨run()æ–¹æ³•ï¼Ÿ**\r\n>\r\n> JVMæ‰§è¡Œstartæ–¹æ³•ï¼Œä¼šå…ˆåˆ›å»ºä¸€æ¡çº¿ç¨‹ï¼Œç”±åˆ›å»ºå‡ºæ¥çš„æ–°çº¿ç¨‹å»æ‰§è¡Œthreadçš„runæ–¹æ³•ï¼Œè¿™æ‰èµ·åˆ°å¤šçº¿ç¨‹çš„æ•ˆæœã€‚\r\n>\r\n> ![startæ–¹æ³•](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/javathread-5.png)\r\n>\r\n> **ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨run()æ–¹æ³•**ï¼Ÿä¹Ÿå¾ˆæ¸…æ¥šï¼Œ å¦‚æœç›´æ¥è°ƒç”¨Threadçš„run()æ–¹æ³•ï¼Œé‚£ä¹ˆrunæ–¹æ³•è¿˜æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œç›¸å½“äºé¡ºåºæ‰§è¡Œï¼Œå°±èµ·ä¸åˆ°å¤šçº¿ç¨‹çš„æ•ˆæœã€‚\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### sleep yield\r\n\r\nsleepï¼š\r\n\r\n* è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹ä» `Running` è¿›å…¥ `Timed Waiting` çŠ¶æ€ï¼ˆé˜»å¡ï¼‰\r\n* sleep() æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œ**çº¿ç¨‹ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”**\r\n* å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ interrupt æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡º InterruptedException\r\n* ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œï¼Œéœ€è¦æŠ¢å  CPU\r\n* å»ºè®®ç”¨ TimeUnit çš„ sleep ä»£æ›¿ Thread çš„ sleep æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§\r\n\r\nyieldï¼š\r\n\r\n* è°ƒç”¨ yield ä¼šè®©æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹ CPU çš„ä½¿ç”¨\r\n* å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨\r\n* **ä¼šæ”¾å¼ƒ CPU èµ„æºï¼Œé”èµ„æºä¸ä¼šé‡Šæ”¾**\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### join\r\n\r\npublic final void join()ï¼šç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸ\r\n\r\nåŸç†ï¼šè°ƒç”¨è€…è½®è¯¢æ£€æŸ¥çº¿ç¨‹ alive çŠ¶æ€ï¼Œt1.join() ç­‰ä»·äºï¼š\r\n\r\n```java\r\npublic final synchronized void join(long millis) throws InterruptedException {\r\n    // è°ƒç”¨è€…çº¿ç¨‹è¿›å…¥ thread çš„ waitSet ç­‰å¾…, ç›´åˆ°å½“å‰çº¿ç¨‹è¿è¡Œç»“æŸ\r\n    while (isAlive()) {\r\n        wait(0);\r\n    }\r\n}\r\n```\r\n\r\n* join æ–¹æ³•æ˜¯è¢« synchronized ä¿®é¥°çš„ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯¹è±¡é”ï¼Œå…¶å†…éƒ¨çš„ wait æ–¹æ³•è°ƒç”¨ä¹Ÿæ˜¯é‡Šæ”¾é”çš„ï¼Œä½†æ˜¯**é‡Šæ”¾çš„æ˜¯å½“å‰çš„çº¿ç¨‹å¯¹è±¡é”ï¼Œè€Œä¸æ˜¯å¤–é¢çš„é”**\r\n\r\n* å½“è°ƒç”¨æŸä¸ªçº¿ç¨‹ï¼ˆt1ï¼‰çš„ join æ–¹æ³•åï¼Œè¯¥çº¿ç¨‹ï¼ˆt1ï¼‰æŠ¢å åˆ° CPU èµ„æºï¼Œå°±ä¸å†é‡Šæ”¾ï¼Œç›´åˆ°çº¿ç¨‹æ‰§è¡Œå®Œæ¯•\r\n\r\nçº¿ç¨‹åŒæ­¥ï¼š\r\n\r\n* join å®ç°çº¿ç¨‹åŒæ­¥ï¼Œå› ä¸ºä¼šé˜»å¡ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ç»“æŸï¼Œæ‰èƒ½ç»§ç»­å‘ä¸‹è¿è¡Œ\r\n  * éœ€è¦å¤–éƒ¨å…±äº«å˜é‡ï¼Œä¸ç¬¦åˆé¢å‘å¯¹è±¡å°è£…çš„æ€æƒ³\r\n  * å¿…é¡»ç­‰å¾…çº¿ç¨‹ç»“æŸï¼Œä¸èƒ½é…åˆçº¿ç¨‹æ± ä½¿ç”¨\r\n* Future å®ç°ï¼ˆåŒæ­¥ï¼‰ï¼šget() æ–¹æ³•é˜»å¡ç­‰å¾…æ‰§è¡Œç»“æœ\r\n  * main çº¿ç¨‹æ¥æ”¶ç»“æœ\r\n  * get æ–¹æ³•æ˜¯è®©è°ƒç”¨çº¿ç¨‹åŒæ­¥ç­‰å¾…\r\n\r\n```java\r\npublic class Test {\r\n    static int r = 0;\r\n    public static void main(String[] args) throws InterruptedException {\r\n        test1();\r\n    }\r\n    private static void test1() throws InterruptedException {\r\n        Thread t1 = new Thread(() -> {\r\n            try {\r\n                Thread.sleep(1000);\r\n            } catch (InterruptedException e) {\r\n                e.printStackTrace();\r\n            }\r\n            r = 10;\r\n        });\r\n        t1.start();\r\n        t1.join();//ä¸ç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè¾“å‡ºçš„10\r\n        System.out.println(r);\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### interrupt\r\n\r\n##### æ‰“æ–­çº¿ç¨‹\r\n\r\n`public void interrupt()`ï¼šæ‰“æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œå¼‚å¸¸å¤„ç†æœºåˆ¶\r\n\r\n`public static boolean interrupted()`ï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ‰“æ–­è¿”å› trueï¼Œ**æ¸…é™¤æ‰“æ–­æ ‡è®°**ï¼Œè¿ç»­è°ƒç”¨ä¸¤æ¬¡ä¸€å®šè¿”å› false\r\n\r\n`public boolean isInterrupted()`ï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œä¸æ¸…é™¤æ‰“æ–­æ ‡è®°\r\n\r\næ‰“æ–­çš„çº¿ç¨‹ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ“ä½œç³»ç»Ÿä¼šä¿å­˜çº¿ç¨‹ä¿¡æ¯ï¼ŒæŠ¢å åˆ° CPU åä¼šä»ä¸­æ–­çš„åœ°æ–¹æ¥ç€è¿è¡Œï¼ˆæ‰“æ–­ä¸æ˜¯åœæ­¢ï¼‰\r\n\r\n* sleepã€waitã€join æ–¹æ³•éƒ½ä¼šè®©çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæ‰“æ–­çº¿ç¨‹**ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€**ï¼ˆfalseï¼‰\r\n\r\n  ```java\r\n  public static void main(String[] args) throws InterruptedException {\r\n      Thread t1 = new Thread(()->{\r\n          try {\r\n              Thread.sleep(1000);\r\n          } catch (InterruptedException e) {\r\n              e.printStackTrace();\r\n          }\r\n      }, \"t1\");\r\n      t1.start();\r\n      Thread.sleep(500);\r\n      t1.interrupt();\r\n      System.out.println(\" æ‰“æ–­çŠ¶æ€: {}\" + t1.isInterrupted());// æ‰“æ–­çŠ¶æ€: {}false\r\n  }\r\n  ```\r\n\r\n* æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹ï¼šä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€ï¼ˆtrueï¼‰\r\n\r\n  ```java\r\n  public static void main(String[] args) throws Exception {\r\n      Thread t2 = new Thread(()->{\r\n          while(true) {\r\n              Thread current = Thread.currentThread();\r\n              boolean interrupted = current.isInterrupted();\r\n              if(interrupted) {\r\n                  System.out.println(\" æ‰“æ–­çŠ¶æ€: {}\" + interrupted);//æ‰“æ–­çŠ¶æ€: {}true\r\n                  break;\r\n              }\r\n          }\r\n      }, \"t2\");\r\n      t2.start();\r\n      Thread.sleep(500);\r\n      t2.interrupt();\r\n  }\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ‰“æ–­ park\r\n\r\npark ä½œç”¨ç±»ä¼¼ sleepï¼Œæ‰“æ–­ park çº¿ç¨‹ï¼Œä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€ï¼ˆtrueï¼‰\r\n\r\n```java\r\npublic static void main(String[] args) throws Exception {\r\n    Thread t1 = new Thread(() -> {\r\n        System.out.println(\"park...\");\r\n        LockSupport.park();\r\n        System.out.println(\"unpark...\");\r\n        System.out.println(\"æ‰“æ–­çŠ¶æ€ï¼š\" + Thread.currentThread().isInterrupted());//æ‰“æ–­çŠ¶æ€ï¼štrue\r\n    }, \"t1\");\r\n    t1.start();\r\n    Thread.sleep(2000);\r\n    t1.interrupt();\r\n}\r\n```\r\n\r\nå¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ\r\n\r\n```java\r\nLockSupport.park();\r\nSystem.out.println(\"unpark...\");\r\nLockSupport.park();//å¤±æ•ˆï¼Œä¸ä¼šé˜»å¡\r\nSystem.out.println(\"unpark...\");//å’Œä¸Šä¸€ä¸ªunparkåŒæ—¶æ‰§è¡Œ\r\n```\r\n\r\nå¯ä»¥ä¿®æ”¹è·å–æ‰“æ–­çŠ¶æ€æ–¹æ³•ï¼Œä½¿ç”¨ `Thread.interrupted()`ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°\r\n\r\nLockSupport ç±»åœ¨ åŒæ­¥ â†’ park-un è¯¦è§£\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ç»ˆæ­¢æ¨¡å¼\r\n\r\nç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ï¼šTwo Phase Termination\r\n\r\nç›®æ ‡ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹ T1 ä¸­å¦‚ä½•ä¼˜é›…ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿä¼˜é›…æŒ‡çš„æ˜¯ç»™ T2 ä¸€ä¸ªåç½®å¤„ç†å™¨\r\n\r\né”™è¯¯æ€æƒ³ï¼š\r\n\r\n* ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ `stop()` æ–¹æ³•åœæ­¢çº¿ç¨‹ï¼šstop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”\r\n* ä½¿ç”¨ `System.exit(int)` æ–¹æ³•åœæ­¢çº¿ç¨‹ï¼šç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢\r\n\r\nä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼å›¾ç¤ºï¼š\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230715001002432.png\" alt=\"image-20230715001002432\" class=\"scale-67\" />\r\n\r\næ‰“æ–­çº¿ç¨‹å¯èƒ½åœ¨ä»»ä½•æ—¶é—´ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘åœ¨ä»»ä½•æ—¶åˆ»è¢«æ‰“æ–­çš„å¤„ç†æ–¹æ³•ï¼š\r\n\r\n```java\r\npublic class Test {\r\n    public static void main(String[] args) throws InterruptedException {\r\n        TwoPhaseTermination tpt = new TwoPhaseTermination();\r\n        tpt.start();\r\n        Thread.sleep(3500);\r\n        tpt.stop();\r\n    }\r\n}\r\nclass TwoPhaseTermination {\r\n    private Thread monitor;\r\n    // å¯åŠ¨ç›‘æ§çº¿ç¨‹\r\n    public void start() {\r\n        monitor = new Thread(new Runnable() {\r\n            @Override\r\n            public void run() {\r\n                while (true) {\r\n                    Thread thread = Thread.currentThread();\r\n                    if (thread.isInterrupted()) {\r\n                        System.out.println(\"åç½®å¤„ç†\");\r\n                        break;\r\n                    }\r\n                    try {\r\n                        Thread.sleep(1000);\t\t\t\t\t// ç¡çœ \r\n                        System.out.println(\"æ‰§è¡Œç›‘æ§è®°å½•\");\t// åœ¨æ­¤è¢«æ‰“æ–­ä¸ä¼šå¼‚å¸¸\r\n                    } catch (InterruptedException e) {\t\t// åœ¨ç¡çœ æœŸé—´è¢«æ‰“æ–­ï¼Œè¿›å…¥å¼‚å¸¸å¤„ç†çš„é€»è¾‘\r\n                        e.printStackTrace();\r\n                        // é‡æ–°è®¾ç½®æ‰“æ–­æ ‡è®°ï¼Œæ‰“æ–­ sleep ä¼šæ¸…é™¤æ‰“æ–­çŠ¶æ€\r\n                        thread.interrupt();\r\n                    }\r\n                }\r\n            }\r\n        });\r\n        monitor.start();\r\n    }\r\n    // åœæ­¢ç›‘æ§çº¿ç¨‹\r\n    public void stop() {\r\n        monitor.interrupt();\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### daemon\r\n\r\n`public final void setDaemon(boolean on)`ï¼šå¦‚æœæ˜¯ true ï¼Œå°†æ­¤çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹ \r\n\r\nçº¿ç¨‹**å¯åŠ¨å‰**è°ƒç”¨æ­¤æ–¹æ³•ï¼š\r\n\r\n```java\r\nThread t = new Thread() {\r\n    @Override\r\n    public void run() {\r\n        System.out.println(\"running\");\r\n    }\r\n};\r\n// è®¾ç½®è¯¥çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹\r\nt.setDaemon(true);\r\nt.start();\r\n```\r\n\r\nç”¨æˆ·çº¿ç¨‹ï¼šå¹³å¸¸åˆ›å»ºçš„æ™®é€šçº¿ç¨‹\r\n\r\nå®ˆæŠ¤çº¿ç¨‹ï¼šæœåŠ¡äºç”¨æˆ·çº¿ç¨‹ï¼Œåªè¦å…¶å®ƒéå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚å®ˆæŠ¤è¿›ç¨‹æ˜¯**è„±ç¦»äºç»ˆç«¯å¹¶ä¸”åœ¨åå°è¿è¡Œçš„è¿›ç¨‹**ï¼Œè„±ç¦»ç»ˆç«¯æ˜¯ä¸ºäº†é¿å…åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­çš„ä¿¡æ¯åœ¨ç»ˆç«¯ä¸Šæ˜¾ç¤º\r\n\r\nè¯´æ˜ï¼šå½“è¿è¡Œçš„çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼ŒJava è™šæ‹Ÿæœºå°†é€€å‡ºï¼Œå› ä¸ºæ™®é€šçº¿ç¨‹æ‰§è¡Œå®Œåï¼ŒJVM æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œä¸ä¼šç»§ç»­è¿è¡Œä¸‹å»\r\n\r\nå¸¸è§çš„å®ˆæŠ¤çº¿ç¨‹ï¼š\r\n\r\n* åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹\r\n* Tomcat ä¸­çš„ Acceptor å’Œ Poller çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥ Tomcat æ¥æ”¶åˆ° shutdown å‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä¸æ¨è\r\n\r\nä¸æ¨èä½¿ç”¨çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å·²è¿‡æ—¶ï¼Œå®¹æ˜“ç ´ååŒæ­¥ä»£ç å—ï¼Œé€ æˆçº¿ç¨‹æ­»é”ï¼š\r\n\r\n* `public final void stop()`ï¼šåœæ­¢çº¿ç¨‹è¿è¡Œ\r\n\r\n  åºŸå¼ƒåŸå› ï¼šæ–¹æ³•ç²—æš´ï¼Œé™¤éå¯èƒ½æ‰§è¡Œ finally ä»£ç å—ä»¥åŠé‡Šæ”¾ synchronized å¤–ï¼Œçº¿ç¨‹å°†ç›´æ¥è¢«ç»ˆæ­¢ï¼Œå¦‚æœçº¿ç¨‹æŒæœ‰ JUC çš„äº’æ–¥é”å¯èƒ½å¯¼è‡´é”æ¥ä¸åŠé‡Šæ”¾ï¼Œé€ æˆå…¶ä»–çº¿ç¨‹æ°¸è¿œç­‰å¾…çš„å±€é¢\r\n\r\n* `public final void suspend()`ï¼š**æŒ‚èµ·ï¼ˆæš‚åœï¼‰çº¿ç¨‹è¿è¡Œ**\r\n\r\n  åºŸå¼ƒåŸå› ï¼šå¦‚æœç›®æ ‡çº¿ç¨‹åœ¨æš‚åœæ—¶å¯¹ç³»ç»Ÿèµ„æºæŒæœ‰é”ï¼Œåˆ™åœ¨ç›®æ ‡çº¿ç¨‹æ¢å¤ä¹‹å‰æ²¡æœ‰çº¿ç¨‹å¯ä»¥è®¿é—®è¯¥èµ„æºï¼Œå¦‚æœ**æ¢å¤ç›®æ ‡çº¿ç¨‹çš„çº¿ç¨‹**åœ¨è°ƒç”¨ resume ä¹‹å‰ä¼šå°è¯•è®¿é—®æ­¤å…±äº«èµ„æºï¼Œåˆ™ä¼šå¯¼è‡´æ­»é”\r\n\r\n* `public final void resume()`ï¼šæ¢å¤çº¿ç¨‹è¿è¡Œ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### çº¿ç¨‹åŸç†\r\n\r\n#### è¿è¡Œæœºåˆ¶\r\n\r\nJava Virtual Machine Stacksï¼ˆJava è™šæ‹Ÿæœºæ ˆï¼‰ï¼šæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜\r\n\r\n* æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜\r\n* æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•\r\n\r\nçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆThread Context Switchï¼‰ï¼šä¸€äº›åŸå› å¯¼è‡´ CPU ä¸å†æ‰§è¡Œå½“å‰çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹\r\n\r\n* çº¿ç¨‹çš„ CPU æ—¶é—´ç‰‡ç”¨å®Œ\r\n* åƒåœ¾å›æ”¶\r\n* æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ\r\n* çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€yieldã€waitã€joinã€park ç­‰æ–¹æ³•\r\n\r\nç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼šè®°ä½ä¸‹ä¸€æ¡ JVM æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„\r\n\r\nå½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼ˆPCB ä¸­ï¼‰ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰\r\n\r\nJVM è§„èŒƒå¹¶æ²¡æœ‰é™å®šçº¿ç¨‹æ¨¡å‹ï¼Œä»¥ HotSpot ä¸ºä¾‹ï¼š\r\n\r\n* Java çš„çº¿ç¨‹æ˜¯å†…æ ¸çº§çº¿ç¨‹ï¼ˆ1:1 çº¿ç¨‹æ¨¡å‹ï¼‰ï¼Œæ¯ä¸ª Java çº¿ç¨‹éƒ½æ˜ å°„åˆ°ä¸€ä¸ªæ“ä½œç³»ç»ŸåŸç”Ÿçº¿ç¨‹ï¼Œéœ€è¦æ¶ˆè€—ä¸€å®šçš„å†…æ ¸èµ„æºï¼ˆå †æ ˆï¼‰\r\n* **çº¿ç¨‹çš„è°ƒåº¦æ˜¯åœ¨å†…æ ¸æ€è¿è¡Œçš„ï¼Œè€Œçº¿ç¨‹ä¸­çš„ä»£ç æ˜¯åœ¨ç”¨æˆ·æ€è¿è¡Œ**ï¼Œæ‰€ä»¥çº¿ç¨‹åˆ‡æ¢ï¼ˆçŠ¶æ€æ”¹å˜ï¼‰ä¼šå¯¼è‡´ç”¨æˆ·ä¸å†…æ ¸æ€è½¬æ¢è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ˜¯éå¸¸æ¶ˆè€—æ€§èƒ½\r\n\r\nJava ä¸­ main æ–¹æ³•å¯åŠ¨çš„æ˜¯ä¸€ä¸ªè¿›ç¨‹ä¹Ÿæ˜¯ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œmain æ–¹æ³•é‡Œé¢çš„å…¶ä»–çº¿ç¨‹å‡ä¸ºå­çº¿ç¨‹ï¼Œmain çº¿ç¨‹æ˜¯è¿™äº›çº¿ç¨‹çš„çˆ¶çº¿ç¨‹\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### çº¿ç¨‹è°ƒåº¦\r\n\r\nçº¿ç¨‹è°ƒåº¦æŒ‡ç³»ç»Ÿä¸ºçº¿ç¨‹åˆ†é…å¤„ç†å™¨ä½¿ç”¨æƒçš„è¿‡ç¨‹ï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼šååŒå¼çº¿ç¨‹è°ƒåº¦ã€æŠ¢å å¼çº¿ç¨‹è°ƒåº¦ï¼ˆJava é€‰æ‹©ï¼‰\r\n\r\nååŒå¼çº¿ç¨‹è°ƒåº¦ï¼šçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”±çº¿ç¨‹æœ¬èº«æ§åˆ¶\r\n\r\n* ä¼˜ç‚¹ï¼šçº¿ç¨‹åšå®Œä»»åŠ¡æ‰é€šçŸ¥ç³»ç»Ÿåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹ï¼Œç›¸å½“äºæ‰€æœ‰çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œä¸ä¼šå‡ºç°çº¿ç¨‹åŒæ­¥é—®é¢˜\r\n* ç¼ºç‚¹ï¼šçº¿ç¨‹æ‰§è¡Œæ—¶é—´ä¸å¯æ§ï¼Œå¦‚æœä»£ç ç¼–å†™å‡ºç°é—®é¢˜ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºä¸€ç›´é˜»å¡ï¼Œå¼•èµ·ç³»ç»Ÿçš„å¥”æºƒ\r\n\r\næŠ¢å å¼çº¿ç¨‹è°ƒåº¦ï¼šçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”±ç³»ç»Ÿåˆ†é…\r\n\r\n* ä¼˜ç‚¹ï¼šçº¿ç¨‹æ‰§è¡Œæ—¶é—´å¯æ§ï¼Œä¸ä¼šå› ä¸ºä¸€ä¸ªçº¿ç¨‹çš„é—®é¢˜è€Œå¯¼è‡´æ•´ä½“ç³»ç»Ÿä¸å¯ç”¨\r\n* ç¼ºç‚¹ï¼šæ— æ³•ä¸»åŠ¨ä¸ºæŸä¸ªçº¿ç¨‹å¤šåˆ†é…æ—¶é—´\r\n\r\nJava æä¾›äº†çº¿ç¨‹ä¼˜å…ˆçº§çš„æœºåˆ¶ï¼Œä¼˜å…ˆçº§ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†è¿™ä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒã€‚åœ¨çº¿ç¨‹çš„å°±ç»ªçŠ¶æ€æ—¶ï¼Œå¦‚æœ CPU æ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½† CPU é—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨\r\n\r\nè¯´æ˜ï¼šå¹¶ä¸èƒ½é€šè¿‡ä¼˜å…ˆçº§æ¥åˆ¤æ–­çº¿ç¨‹æ‰§è¡Œçš„å…ˆåé¡ºåº\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æœªæ¥ä¼˜åŒ–\r\n\r\nå†…æ ¸çº§çº¿ç¨‹è°ƒåº¦çš„æˆæœ¬è¾ƒå¤§ï¼Œæ‰€ä»¥å¼•å…¥äº†æ›´è½»é‡çº§çš„åç¨‹ã€‚ç”¨æˆ·çº¿ç¨‹çš„è°ƒåº¦ç”±ç”¨æˆ·è‡ªå·±å®ç°ï¼ˆå¤šå¯¹ä¸€çš„çº¿ç¨‹æ¨¡å‹ï¼Œå¤š**ä¸ªç”¨æˆ·çº¿ç¨‹æ˜ å°„åˆ°ä¸€ä¸ªå†…æ ¸çº§çº¿ç¨‹**ï¼‰ï¼Œè¢«è®¾è®¡ä¸ºååŒå¼è°ƒåº¦ï¼Œæ‰€ä»¥å«åç¨‹\r\n\r\n* æœ‰æ ˆåç¨‹ï¼šåç¨‹ä¼šå®Œæ•´çš„åšè°ƒç”¨æ ˆçš„ä¿æŠ¤ã€æ¢å¤å·¥ä½œï¼Œæ‰€ä»¥å«æœ‰æ ˆåç¨‹\r\n* æ— æ ˆåç¨‹ï¼šæœ¬è´¨ä¸Šæ˜¯ä¸€ç§æœ‰é™çŠ¶æ€æœºï¼ŒçŠ¶æ€ä¿å­˜åœ¨é—­åŒ…é‡Œï¼Œæ¯”æœ‰æ ˆåç¨‹æ›´è½»é‡ï¼Œä½†æ˜¯åŠŸèƒ½æœ‰é™\r\n\r\næœ‰æ ˆåç¨‹ä¸­æœ‰ä¸€ç§ç‰¹ä¾‹å«çº¤ç¨‹ï¼Œåœ¨æ–°å¹¶å‘æ¨¡å‹ä¸­ï¼Œä¸€æ®µçº¤ç¨‹çš„ä»£ç è¢«åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œæ‰§è¡Œè¿‡ç¨‹å’Œè°ƒåº¦å™¨ï¼š\r\n\r\n* æ‰§è¡Œè¿‡ç¨‹ï¼šç”¨äºç»´æŠ¤æ‰§è¡Œç°åœºï¼Œä¿æŠ¤ã€æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€\r\n* è°ƒåº¦å™¨ï¼šè´Ÿè´£ç¼–æ’æ‰€æœ‰è¦æ‰§è¡Œçš„ä»£ç é¡ºåº\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### çº¿ç¨‹çŠ¶æ€\r\n\r\n#### (1)äº”ç§çŠ¶æ€\r\n\r\nè¿™æ˜¯ä» **æ“ä½œç³»ç»Ÿ** å±‚é¢æ¥æè¿°çš„\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608144606.png)\r\n\r\n- ã€åˆå§‹çŠ¶æ€ã€‘ä»…æ˜¯åœ¨è¯­è¨€å±‚é¢åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æœªä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”ï¼ˆä¾‹å¦‚çº¿ç¨‹è°ƒç”¨äº†startæ–¹æ³•ï¼‰\r\n- ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼ˆå°±ç»ªçŠ¶æ€ï¼‰æŒ‡è¯¥çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼ˆä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”ï¼‰ï¼Œå¯ä»¥ç”± CPU è°ƒåº¦æ‰§è¡Œ\r\n- ã€è¿è¡ŒçŠ¶æ€ã€‘æŒ‡è·å–äº† CPU æ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€\r\n  - å½“ CPU æ—¶é—´ç‰‡ç”¨å®Œï¼Œä¼šä»ã€è¿è¡ŒçŠ¶æ€ã€‘è½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼Œä¼šå¯¼è‡´çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢\r\n- ã€é˜»å¡çŠ¶æ€ã€‘\r\n  - å¦‚æœè°ƒç”¨äº†é˜»å¡ APIï¼Œå¦‚ BIO è¯»å†™æ–‡ä»¶ï¼Œè¿™æ—¶è¯¥çº¿ç¨‹å®é™…ä¸ä¼šç”¨åˆ° CPUï¼Œä¼šå¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥ ã€é˜»å¡çŠ¶æ€ã€‘\r\n  - ç­‰ BIO æ“ä½œå®Œæ¯•ï¼Œä¼šç”±æ“ä½œç³»ç»Ÿå”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘\r\n  - ä¸ã€å¯è¿è¡ŒçŠ¶æ€ã€‘çš„åŒºåˆ«æ˜¯ï¼Œå¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„çº¿ç¨‹æ¥è¯´åªè¦å®ƒä»¬ä¸€ç›´ä¸å”¤é†’ï¼Œè°ƒåº¦å™¨å°±ä¸€ç›´ä¸ä¼šè€ƒè™‘è°ƒåº¦å®ƒä»¬\r\n- ã€ç»ˆæ­¢çŠ¶æ€ã€‘è¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œä¸ä¼šå†è½¬æ¢ä¸ºå…¶å®ƒçŠ¶æ€\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n#### (2)å…­ç§çŠ¶æ€\r\n\r\nè¿›ç¨‹çš„çŠ¶æ€å‚è€ƒæ“ä½œç³»ç»Ÿï¼šåˆ›å»ºæ€ã€å°±ç»ªæ€ã€è¿è¡Œæ€ã€é˜»å¡æ€ã€ç»ˆæ­¢æ€\r\n\r\nè¿™æ˜¯ä» **Java API** å±‚é¢æ¥æè¿°çš„\r\n\r\nçº¿ç¨‹ç”±ç”Ÿåˆ°æ­»çš„å®Œæ•´è¿‡ç¨‹ï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰ï¼šå½“çº¿ç¨‹è¢«åˆ›å»ºå¹¶å¯åŠ¨ä»¥åï¼Œæ—¢ä¸æ˜¯ä¸€å¯åŠ¨å°±è¿›å…¥äº†æ‰§è¡ŒçŠ¶æ€ï¼Œä¹Ÿä¸æ˜¯ä¸€ç›´å¤„äºæ‰§è¡ŒçŠ¶æ€ï¼Œåœ¨ API ä¸­ `java.lang.Thread.State` è¿™ä¸ªæšä¸¾ä¸­ç»™å‡ºäº†å…­ç§çº¿ç¨‹çŠ¶æ€ï¼š\r\n\r\n| çº¿ç¨‹çŠ¶æ€                   | å¯¼è‡´çŠ¶æ€å‘ç”Ÿæ¡ä»¶                                             |\r\n| -------------------------- | ------------------------------------------------------------ |\r\n| NEWï¼ˆæ–°å»ºï¼‰                | çº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†æ˜¯å¹¶æœªå¯åŠ¨ï¼Œè¿˜æ²¡è°ƒç”¨ start æ–¹æ³•ï¼Œåªæœ‰çº¿ç¨‹å¯¹è±¡ï¼Œæ²¡æœ‰çº¿ç¨‹ç‰¹å¾ |\r\n| Runnableï¼ˆå¯è¿è¡Œï¼‰         | çº¿ç¨‹å¯ä»¥åœ¨ Java è™šæ‹Ÿæœºä¸­è¿è¡Œçš„çŠ¶æ€ï¼Œå¯èƒ½æ­£åœ¨è¿è¡Œè‡ªå·±ä»£ç ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰ï¼Œè¿™å–å†³äºæ“ä½œç³»ç»Ÿå¤„ç†å™¨ï¼Œè°ƒç”¨äº† `t.start()` æ–¹æ³•ï¼šå°±ç»ªï¼ˆç»å…¸å«æ³•ï¼‰ |\r\n| Blockedï¼ˆé˜»å¡ï¼‰            | å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–ä¸€ä¸ªå¯¹è±¡é”ï¼Œè€Œè¯¥å¯¹è±¡é”è¢«å…¶ä»–çš„çº¿ç¨‹æŒæœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹è¿›å…¥ Blocked çŠ¶æ€ï¼›å½“è¯¥çº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œè¯¥çº¿ç¨‹å°†å˜æˆ Runnable çŠ¶æ€ |\r\n| Waitingï¼ˆæ— é™ç­‰å¾…ï¼‰        | ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸€ä¸ªï¼ˆå”¤é†’ï¼‰åŠ¨ä½œæ—¶ï¼Œè¯¥çº¿ç¨‹è¿›å…¥ Waiting çŠ¶æ€ï¼Œè¿›å…¥è¿™ä¸ªçŠ¶æ€åä¸èƒ½è‡ªåŠ¨å”¤é†’ï¼Œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ notify æˆ–è€… notifyAll æ–¹æ³•æ‰èƒ½å”¤é†’ |\r\n| Timed Waiting ï¼ˆé™æœŸç­‰å¾…ï¼‰ | æœ‰å‡ ä¸ªæ–¹æ³•æœ‰è¶…æ—¶å‚æ•°ï¼Œè°ƒç”¨å°†è¿›å…¥ Timed Waiting çŠ¶æ€ï¼Œè¿™ä¸€çŠ¶æ€å°†ä¸€ç›´ä¿æŒåˆ°è¶…æ—¶æœŸæ»¡æˆ–è€…æ¥æ”¶åˆ°å”¤é†’é€šçŸ¥ã€‚å¸¦æœ‰è¶…æ—¶å‚æ•°çš„å¸¸ç”¨æ–¹æ³•æœ‰ `Thread.sleep` ã€`Object.wait` |\r\n| Teminatedï¼ˆç»“æŸï¼‰          | run æ–¹æ³•æ­£å¸¸é€€å‡ºè€Œæ­»äº¡ï¼Œæˆ–è€…å› ä¸ºæ²¡æœ‰æ•è·çš„å¼‚å¸¸ç»ˆæ­¢äº† run æ–¹æ³•è€Œæ­»äº¡ |\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608144621.png)\r\n\r\n* NEW â†’ RUNNABLEï¼šå½“è°ƒç”¨ `t.start()` æ–¹æ³•æ—¶ï¼Œç”± NEW â†’ RUNNABLE\r\n\r\n* RUNNABLE â†â†’ WAITINGï¼š\r\n\r\n  * è°ƒç”¨ `obj.wait()` æ–¹æ³•æ—¶ï¼Œt çº¿ç¨‹ä» RUNNABLE â†’ WAITING\r\n\r\n    è°ƒç”¨ `obj.notify()`ã€`obj.notifyAll()`ã€`t.interrupt()`ï¼š\r\n\r\n    * ç«äº‰é”æˆåŠŸï¼Œt çº¿ç¨‹ä» WAITING â†’ RUNNABLE\r\n    * ç«äº‰é”å¤±è´¥ï¼Œt çº¿ç¨‹ä» WAITING â†’ BLOCKED\r\n\r\n  * å½“å‰çº¿ç¨‹è°ƒç”¨ `t.join()` æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹ä» RUNNABLE â†’ WAITING\r\n\r\n    * æ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨ t çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…\r\n\r\n    * t çº¿ç¨‹**è¿è¡Œç»“æŸ**ï¼Œæˆ–è°ƒç”¨äº†**å½“å‰çº¿ç¨‹**çš„ interrupt() æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» WAITING â†’ RUNNABLE\r\n\r\n  * å½“å‰çº¿ç¨‹è°ƒç”¨ `LockSupport.park()` æ–¹æ³•ä¼šè®©å½“å‰çº¿ç¨‹ä» RUNNABLE â†’ WAITING\r\n\r\n  * è°ƒç”¨ `LockSupport.unpark(ç›®æ ‡çº¿ç¨‹)` æˆ–è°ƒç”¨äº†çº¿ç¨‹ çš„ `interrupt()` ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä» WAITING â†’ RUNNABLE\r\n\r\n* RUNNABLE â†â†’ TIMED_WAITINGï¼š\r\n\r\n  * t çº¿ç¨‹ç”¨ synchronized(obj) è·å–äº†å¯¹è±¡é”å\r\n    * è°ƒç”¨ `obj.wait(long n)` æ–¹æ³•ã€å½“å‰çº¿ç¨‹è°ƒç”¨ `t.join(long n)` æ–¹æ³•ã€å½“å‰çº¿ç¨‹è°ƒç”¨ `Thread.sleep(long n)`\r\n\r\n    * t çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œæˆ–è°ƒç”¨ `obj.notify()` ï¼Œ `obj.notifyAll()` ï¼Œ `t.interrupt()` æ—¶\r\n      * ç«äº‰é”æˆåŠŸï¼Œt çº¿ç¨‹ä» TIMED_WAITING â†’ RUNNABLE\r\n      * ç«äº‰é”å¤±è´¥ï¼Œt çº¿ç¨‹ä» TIMED_WAITING â†’ BLOCKED\r\n\r\n  * å½“å‰çº¿ç¨‹è°ƒç”¨ `t.join(long n)` æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» RUNNABLE â†’ TIMED_WAITING\r\n\r\n    - æ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨t çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…\r\n\r\n  * å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œæˆ–t çº¿ç¨‹è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„ `interrupt()` æ—¶ï¼Œå½“å‰çº¿ç¨‹ä» TIMED_WAITING â†’ RUNNABLE\r\n\r\n  * å½“å‰çº¿ç¨‹è°ƒç”¨ `Thread.sleep(long n)` ï¼Œå½“å‰çº¿ç¨‹ä» RUNNABLE â†’ TIMED_WAITING\r\n\r\n  * å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº† n æ¯«ç§’ï¼Œå½“å‰çº¿ç¨‹ä» TIMED_WAITING â†’ RUNNABLE\r\n\r\n  * å½“å‰çº¿ç¨‹è°ƒç”¨ `LockSupport.parkNanos(long nanos)` æˆ– `LockSupport.parkUntil(long millis)` æ—¶ï¼Œå½“å‰çº¿ ç¨‹ä» RUNNABLE â†’ TIMED_WAITING\r\n\r\n  * è°ƒç”¨ LockSupport.unpark(ç›®æ ‡çº¿ç¨‹) æˆ–è°ƒç”¨äº†çº¿ç¨‹ çš„ `interrupt()` ï¼Œæˆ–æ˜¯ç­‰å¾…è¶…æ—¶ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä» TIMED_WAITING â†’ RUNNABLE\r\n\r\n* RUNNABLE â†â†’ BLOCKEDï¼š\r\n\r\n  * t çº¿ç¨‹ç”¨ `synchronized(obj)` è·å–äº†å¯¹è±¡é”æ—¶å¦‚æœ**ç«äº‰å¤±è´¥**ï¼Œä» RUNNABLE â†’ BLOCKED\r\n  * æŒ obj é”çº¿ç¨‹çš„åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œä¼šå”¤é†’è¯¥å¯¹è±¡ä¸Šæ‰€æœ‰ BLOCKED çš„çº¿ç¨‹é‡æ–°ç«äº‰ï¼Œå¦‚æœå…¶ä¸­ t çº¿ç¨‹ç«äº‰ æˆåŠŸï¼Œä» BLOCKED â†’ RUNNABLE ï¼Œå…¶å®ƒ**å¤±è´¥**çš„çº¿ç¨‹ä»ç„¶ BLOCKED\r\n\r\n* RUNNABLE â†’ TERMINATEDï¼šå½“å‰çº¿**ç¨‹æ‰€æœ‰ä»£ç è¿è¡Œå®Œæ¯•**ï¼Œè¿›å…¥ TERMINATED\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### æŸ¥çœ‹çº¿ç¨‹\r\n\r\nWindowsï¼š\r\n\r\n* ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹\r\n* `tasklist` æŸ¥çœ‹è¿›ç¨‹\r\n* `taskkill` æ€æ­»è¿›ç¨‹\r\n\r\nLinuxï¼š\r\n\r\n* `ps -ef` æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹\r\n* `ps -fT -p <PID>` æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹\r\n* `kill` æ€æ­»è¿›ç¨‹\r\n* `top` æŒ‰å¤§å†™ H åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹\r\n* `top -H -p <PID>` æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹\r\n\r\nJavaï¼š\r\n\r\n* `jps` å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹\r\n* `jstack <PID>` æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€\r\n* `jconsole` æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n## åŒæ­¥\r\n\r\n### ä¸´ç•ŒåŒº\r\n\r\nä¸´ç•Œèµ„æºï¼šä¸€æ¬¡ä»…å…è®¸ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨çš„èµ„æºæˆä¸ºä¸´ç•Œèµ„æº\r\n\r\nä¸´ç•ŒåŒºï¼šè®¿é—®ä¸´ç•Œèµ„æºçš„ä»£ç å—\r\n\r\nç«æ€æ¡ä»¶ï¼šå¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„æ‰§è¡Œåºåˆ—ä¸åŒè€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†ç«æ€æ¡ä»¶\r\n\r\nä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œå¤šä¸ªçº¿ç¨‹è¯»å…±äº«èµ„æºä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œåœ¨å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜\r\n\r\nä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ˆè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼‰ï¼š\r\n\r\n* é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼Œlock\r\n* éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡\r\n\r\nç®¡ç¨‹ï¼ˆmonitorï¼‰ï¼šç”±å±€éƒ¨äºè‡ªå·±çš„è‹¥å¹²å…¬å…±å˜é‡å’Œæ‰€æœ‰è®¿é—®è¿™äº›å…¬å…±å˜é‡çš„è¿‡ç¨‹æ‰€ç»„æˆçš„è½¯ä»¶æ¨¡å—ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ç®¡ç¨‹å†…æ´»åŠ¨ï¼Œå³ç®¡ç¨‹å†…å®šä¹‰çš„æ“ä½œåœ¨åŒä¸€æ—¶åˆ»åªè¢«ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨ï¼ˆç”±ç¼–è¯‘å™¨å®ç°ï¼‰\r\n\r\n**synchronized**ï¼š**å¯¹è±¡é”**ï¼Œ**ä¿è¯äº†ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§**ï¼Œé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰å¯¹è±¡é”ï¼Œå…¶å®ƒçº¿ç¨‹è·å–è¿™ä¸ªå¯¹è±¡é”æ—¶ä¼šé˜»å¡ï¼Œä¿è¯æ‹¥æœ‰é”çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢\r\n\r\näº’æ–¥å’ŒåŒæ­¥éƒ½å¯ä»¥é‡‡ç”¨ synchronized å…³é”®å­—æ¥å®Œæˆï¼ŒåŒºåˆ«ï¼š\r\n\r\n* äº’æ–¥æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç \r\n* åŒæ­¥æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåé¡ºåºä¸åŒï¼Œéœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®ƒçº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹\r\n\r\næ€§èƒ½ï¼š\r\n\r\n* çº¿ç¨‹å®‰å…¨ï¼Œæ€§èƒ½å·®\r\n* çº¿ç¨‹ä¸å®‰å…¨æ€§èƒ½å¥½ï¼Œå‡å¦‚å¼€å‘ä¸­ä¸ä¼šå­˜åœ¨å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå»ºè®®ä½¿ç”¨çº¿ç¨‹ä¸å®‰å…¨çš„è®¾è®¡ç±»\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### syn-ed\r\n\r\n#### ä½¿ç”¨é”\r\n\r\n##### åŒæ­¥å—\r\n\r\né”å¯¹è±¡ï¼šç†è®ºä¸Šå¯ä»¥æ˜¯**ä»»æ„çš„å”¯ä¸€å¯¹è±¡**\r\n\r\nsynchronized æ˜¯å¯é‡å…¥ã€ä¸å…¬å¹³çš„é‡é‡çº§é”\r\n\r\nåŸåˆ™ä¸Šï¼š\r\n\r\n* é”å¯¹è±¡å»ºè®®ä½¿ç”¨å…±äº«èµ„æº\r\n* åœ¨å®ä¾‹æ–¹æ³•ä¸­ä½¿ç”¨ this ä½œä¸ºé”å¯¹è±¡ï¼Œé”ä½çš„ this æ­£å¥½æ˜¯å…±äº«èµ„æº\r\n* åœ¨é™æ€æ–¹æ³•ä¸­ä½¿ç”¨ç±»å .class å­—èŠ‚ç ä½œä¸ºé”å¯¹è±¡ï¼Œå› ä¸ºé™æ€æˆå‘˜å±äºç±»ï¼Œè¢«æ‰€æœ‰å®ä¾‹å¯¹è±¡å…±äº«ï¼Œæ‰€ä»¥éœ€è¦é”ä½ç±»\r\n\r\nåŒæ­¥ä»£ç å—æ ¼å¼ï¼š\r\n\r\n```java\r\nsynchronized(é”å¯¹è±¡){\r\n\t// è®¿é—®å…±äº«èµ„æºçš„æ ¸å¿ƒä»£ç \r\n}\r\n```\r\n\r\nå®ä¾‹ï¼š\r\n\r\n```java\r\npublic class demo {\r\n    static int counter = 0;\r\n    //staticä¿®é¥°ï¼Œåˆ™å…ƒç´ æ˜¯å±äºç±»æœ¬èº«çš„ï¼Œä¸å±äºå¯¹è±¡  ï¼Œä¸ç±»ä¸€èµ·åŠ è½½ä¸€æ¬¡ï¼Œåªæœ‰ä¸€ä¸ª\r\n    static final Object room = new Object();\r\n    public static void main(String[] args) throws InterruptedException {\r\n        Thread t1 = new Thread(() -> {\r\n            for (int i = 0; i < 5000; i++) {\r\n                synchronized (room) {\r\n                    counter++;\r\n                }\r\n            }\r\n        }, \"t1\");\r\n        Thread t2 = new Thread(() -> {\r\n            for (int i = 0; i < 5000; i++) {\r\n                synchronized (room) {\r\n                    counter--;\r\n                }\r\n            }\r\n        }, \"t2\");\r\n        t1.start();\r\n        t2.start();\r\n        t1.join();\r\n        t2.join();\r\n        System.out.println(counter);\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### åŒæ­¥æ–¹æ³•\r\n\r\næŠŠå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„æ ¸å¿ƒæ–¹æ³•é”èµ·æ¥ï¼Œæ¯æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹è¿›å…¥è®¿é—®\r\n\r\nsynchronized ä¿®é¥°çš„æ–¹æ³•çš„ä¸å…·å¤‡ç»§æ‰¿æ€§ï¼Œæ‰€ä»¥å­ç±»æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¦‚æœå­ç±»çš„æ–¹æ³•ä¹Ÿè¢« synchronized ä¿®é¥°ï¼Œä¸¤ä¸ªé”å¯¹è±¡å…¶å®æ˜¯ä¸€æŠŠé”ï¼Œè€Œä¸”æ˜¯**å­ç±»å¯¹è±¡ä½œä¸ºé”**\r\n\r\nç”¨æ³•ï¼šç›´æ¥ç»™æ–¹æ³•åŠ ä¸Šä¸€ä¸ªä¿®é¥°ç¬¦ synchronized\r\n\r\n```java\r\n//åŒæ­¥æ–¹æ³•\r\nä¿®é¥°ç¬¦ synchronized è¿”å›å€¼ç±»å‹ æ–¹æ³•å(æ–¹æ³•å‚æ•°) { \r\n\tæ–¹æ³•ä½“ï¼›\r\n}\r\n//åŒæ­¥é™æ€æ–¹æ³•\r\nä¿®é¥°ç¬¦ static synchronized è¿”å›å€¼ç±»å‹ æ–¹æ³•å(æ–¹æ³•å‚æ•°) { \r\n\tæ–¹æ³•ä½“ï¼›\r\n}\r\n```\r\n\r\nåŒæ­¥æ–¹æ³•åº•å±‚ä¹Ÿæ˜¯æœ‰é”å¯¹è±¡çš„ï¼š\r\n\r\n* å¦‚æœæ–¹æ³•æ˜¯å®ä¾‹æ–¹æ³•ï¼šåŒæ­¥æ–¹æ³•é»˜è®¤ç”¨ this ä½œä¸ºçš„é”å¯¹è±¡\r\n\r\n  ```java\r\n  public synchronized void test() {} //ç­‰ä»·äº\r\n  public void test() {\r\n      synchronized(this) {}\r\n  }\r\n  ```\r\n\r\n* å¦‚æœæ–¹æ³•æ˜¯é™æ€æ–¹æ³•ï¼šåŒæ­¥æ–¹æ³•é»˜è®¤ç”¨ç±»å .class ä½œä¸ºçš„é”å¯¹è±¡\r\n\r\n  ```java\r\n  class Test{\r\n  \tpublic synchronized static void test() {}\r\n  }\r\n  //ç­‰ä»·äº\r\n  class Test{\r\n      public static void test() {\r\n          synchronized(Test.class) {}\r\n  \t}\r\n  }\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### çº¿ç¨‹å…«é”\r\n\r\nçº¿ç¨‹å…«é”å°±æ˜¯è€ƒå¯Ÿ synchronized é”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡ï¼Œç›´æ¥ç™¾åº¦æœç´¢ç›¸å…³çš„å®ä¾‹\r\n\r\nè¯´æ˜ï¼šä¸»è¦å…³æ³¨é”ä½çš„å¯¹è±¡æ˜¯ä¸æ˜¯åŒä¸€ä¸ª\r\n\r\n* é”ä½ç±»å¯¹è±¡ï¼Œæ‰€æœ‰ç±»çš„å®ä¾‹çš„æ–¹æ³•éƒ½æ˜¯å®‰å…¨çš„ï¼Œç±»çš„æ‰€æœ‰å®ä¾‹éƒ½ç›¸å½“äºåŒä¸€æŠŠé”\r\n* é”ä½ this å¯¹è±¡ï¼Œåªæœ‰åœ¨å½“å‰å®ä¾‹å¯¹è±¡çš„çº¿ç¨‹å†…æ˜¯å®‰å…¨çš„ï¼Œå¦‚æœæœ‰å¤šä¸ªå®ä¾‹å°±ä¸å®‰å…¨\r\n\r\nçº¿ç¨‹ä¸å®‰å…¨ï¼šå› ä¸ºé”ä½çš„ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œçº¿ç¨‹ 1 è°ƒç”¨ a æ–¹æ³•é”ä½çš„ç±»å¯¹è±¡ï¼Œçº¿ç¨‹ 2 è°ƒç”¨ b æ–¹æ³•é”ä½çš„ n2 å¯¹è±¡ï¼Œä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡\r\n\r\n```java\r\nclass Number{\r\n    public static synchronized void a(){\r\n\t\tThread.sleep(1000);\r\n        System.out.println(\"1\");\r\n    }\r\n    public synchronized void b() {\r\n        System.out.println(\"2\");\r\n    }\r\n}\r\npublic static void main(String[] args) {\r\n    Number n1 = new Number();\r\n    Number n2 = new Number();\r\n    new Thread(()->{ n1.a(); }).start();\r\n    new Thread(()->{ n2.b(); }).start();\r\n}\r\n```\r\n\r\nçº¿ç¨‹å®‰å…¨ï¼šå› ä¸º n1 è°ƒç”¨ a() æ–¹æ³•ï¼Œé”ä½çš„æ˜¯ç±»å¯¹è±¡ï¼Œn2 è°ƒç”¨ b() æ–¹æ³•ï¼Œé”ä½çš„ä¹Ÿæ˜¯ç±»å¯¹è±¡ï¼Œæ‰€ä»¥çº¿ç¨‹å®‰å…¨\r\n\r\n```java\r\nclass Number{\r\n    public static synchronized void a(){\r\n\t\tThread.sleep(1000);\r\n        System.out.println(\"1\");\r\n    }\r\n    public static synchronized void b() {\r\n        System.out.println(\"2\");\r\n    }\r\n}\r\npublic static void main(String[] args) {\r\n    Number n1 = new Number();\r\n    Number n2 = new Number();\r\n    new Thread(()->{ n1.a(); }).start();\r\n    new Thread(()->{ n2.b(); }).start();\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### é”åŸç†\r\n\r\n##### Monitor\r\n\r\nMonitor è¢«ç¿»è¯‘ä¸ºç›‘è§†å™¨æˆ–ç®¡ç¨‹\r\n\r\næ¯ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ª Monitor å¯¹è±¡ï¼ŒMonitor ä¹Ÿæ˜¯ classï¼Œå…¶**å®ä¾‹å­˜å‚¨åœ¨å †ä¸­**ï¼Œå¦‚æœä½¿ç”¨ synchronized ç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„ Mark Word ä¸­å°±è¢«è®¾ç½®æŒ‡å‘ Monitor å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿™å°±æ˜¯é‡é‡çº§é”\r\n\r\n* Mark Word ç»“æ„ï¼šæœ€åä¸¤ä½æ˜¯**é”æ ‡å¿—ä½**\r\n\r\n  ![image-20230712141854417](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230712141854417.png)\r\n\r\n* 64 ä½è™šæ‹Ÿæœº Mark Wordï¼š\r\n\r\n  ![image-20230712141907430](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230712141907430.png)\r\n\r\nå·¥ä½œæµç¨‹ï¼š\r\n\r\n* å¼€å§‹æ—¶ Monitor ä¸­ Owner ä¸º null\r\n* å½“ Thread-2 æ‰§è¡Œ synchronized(obj) å°±ä¼šå°† Monitor çš„æ‰€æœ‰è€… Owner ç½®ä¸º Thread-2ï¼ŒMonitor ä¸­åªèƒ½æœ‰ä¸€ä¸ª Ownerï¼Œ**obj å¯¹è±¡çš„ Mark Word æŒ‡å‘ Monitor**ï¼ŒæŠŠ**å¯¹è±¡åŸæœ‰çš„ MarkWord å­˜å…¥çº¿ç¨‹æ ˆä¸­çš„é”è®°å½•**ä¸­ï¼ˆè½»é‡çº§é”éƒ¨åˆ†è¯¦è§£ï¼‰\r\n  ![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608144917.png)\r\n* åœ¨ Thread-2 ä¸Šé”çš„è¿‡ç¨‹ï¼ŒThread-3ã€Thread-4ã€Thread-5 ä¹Ÿæ‰§è¡Œ synchronized(obj)ï¼Œå°±ä¼šè¿›å…¥ EntryList BLOCKEDï¼ˆåŒå‘é“¾è¡¨ï¼‰\r\n* Thread-2 æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œæ ¹æ® obj å¯¹è±¡å¤´ä¸­ Monitor åœ°å€å¯»æ‰¾ï¼Œè®¾ç½® Owner ä¸ºç©ºï¼ŒæŠŠçº¿ç¨‹æ ˆçš„é”è®°å½•ä¸­çš„å¯¹è±¡å¤´çš„å€¼è®¾ç½®å› MarkWord\r\n* å”¤é†’ EntryList ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰æ˜¯**éå…¬å¹³çš„**ï¼Œå¦‚æœè¿™æ—¶æœ‰æ–°çš„çº¿ç¨‹æƒ³è¦è·å–é”ï¼Œå¯èƒ½ç›´æ¥å°±æŠ¢å åˆ°äº†ï¼Œé˜»å¡é˜Ÿåˆ—çš„çº¿ç¨‹å°±ä¼šç»§ç»­é˜»å¡\r\n* WaitSet ä¸­çš„ Thread-0ï¼Œæ˜¯ä»¥å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥ WAITING çŠ¶æ€çš„çº¿ç¨‹ï¼ˆwait-notify æœºåˆ¶ï¼‰\r\n\r\n![image-20230712155102089](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230712155102089.png)\r\n\r\næ³¨æ„ï¼š\r\n\r\n* synchronized å¿…é¡»æ˜¯è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡çš„ Monitor æ‰æœ‰ä¸Šè¿°çš„æ•ˆæœ\r\n* ä¸åŠ  synchronized çš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n##### å­—èŠ‚ç \r\n\r\nä»£ç ï¼š\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    Object lock = new Object();\r\n    synchronized (lock) {\r\n        System.out.println(\"ok\");\r\n    }\r\n}\r\n```\r\n\r\n```java\r\n0: \tnew\t\t\t\t#2\t\t// new Object\r\n3: \tdup\r\n4: \tinvokespecial \t#1 \t\t// invokespecial <init>:()Vï¼Œéè™šæ–¹æ³•\r\n7: \tastore_1 \t\t\t\t// lockå¼•ç”¨ -> lock\r\n8: \taload_1\t\t\t\t\t// lock ï¼ˆsynchronizedå¼€å§‹ï¼‰\r\n9: \tdup\t\t\t\t\t\t// ä¸€ä»½ç”¨æ¥åˆå§‹åŒ–ï¼Œä¸€ä»½ç”¨æ¥å¼•ç”¨\r\n10: astore_2 \t\t\t\t// lockå¼•ç”¨ -> slot 2\r\n11: monitorenter \t\t\t// ã€å°† lockå¯¹è±¡ MarkWord ç½®ä¸º Monitor æŒ‡é’ˆã€‘\r\n12: getstatic \t\t#3\t\t// System.out\r\n15: ldc \t\t\t#4\t\t// \"ok\"\r\n17: invokevirtual \t#5 \t\t// invokevirtual println:(Ljava/lang/String;)V\r\n20: aload_2 \t\t\t\t// slot 2(lockå¼•ç”¨)\r\n21: monitorexit \t\t\t// ã€å°† lockå¯¹è±¡ MarkWord é‡ç½®, å”¤é†’ EntryListã€‘\r\n22: goto 30\r\n25: astore_3 \t\t\t\t// any -> slot 3\r\n26: aload_2 \t\t\t\t// slot 2(lockå¼•ç”¨)\r\n27: monitorexit \t\t\t// ã€å°† lockå¯¹è±¡ MarkWord é‡ç½®, å”¤é†’ EntryListã€‘\r\n28: aload_3\r\n29: athrow\r\n30: return\r\nException table:\r\n    from to target type\r\n      12 22 25 \t\tany\r\n      25 28 25 \t\tany\r\nLineNumberTable: ...\r\nLocalVariableTable:\r\n    Start Length Slot Name Signature\r\n    \t0 \t31 \t\t0 args [Ljava/lang/String;\r\n    \t8 \t23 \t\t1 lock Ljava/lang/Object;\r\n```\r\n\r\nè¯´æ˜ï¼š\r\n\r\n* é€šè¿‡å¼‚å¸¸ **try-catch æœºåˆ¶**ï¼Œç¡®ä¿ä¸€å®šä¼šè¢«è§£é”\r\n* æ–¹æ³•çº§åˆ«çš„ synchronized ä¸ä¼šåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­æœ‰æ‰€ä½“ç°\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### é”å‡çº§\r\n\r\n##### å‡çº§è¿‡ç¨‹\r\n\r\n**synchronized æ˜¯å¯é‡å…¥ã€ä¸å…¬å¹³çš„é‡é‡çº§é”**ï¼Œæ‰€ä»¥å¯ä»¥å¯¹å…¶è¿›è¡Œä¼˜åŒ–\r\n\r\n```java\r\næ— é” -> åå‘é” -> è½»é‡çº§é” -> é‡é‡çº§é”\t// éšç€ç«äº‰çš„å¢åŠ ï¼Œåªèƒ½é”å‡çº§ï¼Œä¸èƒ½é™çº§\r\n```\r\n\r\n![image-20230824170452189](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824170452189.png)\r\n\r\nå¤§ä½“ä¸Šçœç®€çš„å‡çº§è¿‡ç¨‹ï¼š\r\n\r\n![é”å‡çº§ç®€ç•¥è¿‡ç¨‹](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/javathread-36.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### åå‘é”\r\n\r\nåå‘é”çš„æ€æƒ³æ˜¯åå‘äºè®©ç¬¬ä¸€ä¸ªè·å–é”å¯¹è±¡çš„çº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹ä¹‹åé‡æ–°è·å–è¯¥é”ä¸å†éœ€è¦åŒæ­¥æ“ä½œï¼š\r\n\r\n* å½“é”å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å¾—çš„æ—¶å€™è¿›å…¥åå‘çŠ¶æ€ï¼Œæ ‡è®°ä¸º 101ï¼ŒåŒæ—¶**ä½¿ç”¨ CAS æ“ä½œå°†çº¿ç¨‹ ID è®°å½•åˆ° Mark Word**ã€‚å¦‚æœ CAS æ“ä½œæˆåŠŸï¼Œè¿™ä¸ªçº¿ç¨‹ä»¥åè¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—ï¼ŒæŸ¥çœ‹è¿™ä¸ªçº¿ç¨‹ ID æ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œå°±ä¸éœ€è¦å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œ\r\n\r\n* å½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹å»å°è¯•è·å–è¿™ä¸ªé”å¯¹è±¡æ—¶ï¼Œåå‘çŠ¶æ€å°±å®£å‘Šç»“æŸï¼Œæ­¤æ—¶æ’¤é”€åå‘ï¼ˆRevoke Biasï¼‰åæ¢å¤åˆ°æœªé”å®šæˆ–è½»é‡çº§é”çŠ¶æ€\r\n\r\n![image-20230712154420092](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230712154420092.png)\r\n\r\n![image-20230712154150202](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230712154150202.png)\r\n\r\nåªæœ‰ç¬¬ä¸€æ¬¡è®¾ç½®å¯¹è±¡å¤´æ—¶æ‰è¿›è¡ŒCASæ“ä½œï¼ˆç±»ä¼¼äºåˆ»åå­—ï¼‰\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145109.png)\r\n\r\n\r\n\r\nä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š\r\n\r\n* å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼ŒMarkWord å€¼ä¸º 0x05 å³æœ€å 3 ä½ä¸º 101ï¼Œthreadã€epochã€age éƒ½ä¸º 0\r\n* åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ  VM å‚æ•°                                                                        `-XX:BiasedLockingStartupDelay=0` æ¥ç¦ç”¨å»¶è¿Ÿã€‚JDK 8 å»¶è¿Ÿ 4s å¼€å¯åå‘é”åŸå› ï¼šåœ¨åˆšå¼€å§‹æ‰§è¡Œä»£ç æ—¶ï¼Œä¼šæœ‰å¥½å¤šçº¿ç¨‹æ¥æŠ¢é”ï¼Œå¦‚æœå¼€åå‘é”æ•ˆç‡åè€Œé™ä½\r\n* å½“ä¸€ä¸ªå¯¹è±¡å·²ç»è®¡ç®—è¿‡ hashCodeï¼Œå°±å†ä¹Ÿæ— æ³•è¿›å…¥åå‘çŠ¶æ€äº†\r\n* æ·»åŠ  VM å‚æ•° `-XX:-UseBiasedLocking` ç¦ç”¨åå‘é”\r\n\r\n**åå‘çŠ¶æ€**\r\n\r\n- Normalï¼šä¸€èˆ¬çŠ¶æ€ï¼Œæ²¡æœ‰åŠ ä»»ä½•é”ï¼Œå‰é¢62ä½ä¿å­˜çš„æ˜¯å¯¹è±¡çš„ä¿¡æ¯ï¼Œ**æœ€å2ä½ä¸ºçŠ¶æ€ï¼ˆ01ï¼‰ï¼Œå€’æ•°ç¬¬ä¸‰ä½è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨åå‘é”ï¼ˆæœªä½¿ç”¨ï¼š0ï¼‰**\r\n- Biasedï¼šåå‘çŠ¶æ€ï¼Œä½¿ç”¨åå‘é”ï¼Œå‰é¢54ä½ä¿å­˜çš„å½“å‰çº¿ç¨‹çš„IDï¼Œ**æœ€å2ä½ä¸ºçŠ¶æ€ï¼ˆ01ï¼‰ï¼Œå€’æ•°ç¬¬ä¸‰ä½è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨åå‘é”ï¼ˆä½¿ç”¨ï¼š1ï¼‰**\r\n- Lightweightï¼šä½¿ç”¨è½»é‡çº§é”ï¼Œå‰62ä½ä¿å­˜çš„æ˜¯é”è®°å½•çš„æŒ‡é’ˆï¼Œ**æœ€åä¸¤ä½ä¸ºçŠ¶æ€ï¼ˆ00ï¼‰**\r\n- Heavyweightï¼šä½¿ç”¨é‡é‡çº§é”ï¼Œå‰62ä½ä¿å­˜çš„æ˜¯Monitorçš„åœ°å€æŒ‡é’ˆï¼Œ**åä¸¤ä½ä¸ºçŠ¶æ€(10)**\r\n\r\n![image-20230712141907430](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230712141907430.png)\r\n\r\n\r\n\r\n**æ’¤é”€åå‘**\r\n\r\nä»¥ä¸‹å‡ ç§æƒ…å†µä¼šä½¿å¯¹è±¡çš„åå‘é”å¤±æ•ˆ\r\n\r\n- è°ƒç”¨å¯¹è±¡çš„hashCodeæ–¹æ³•\r\n\r\n  - è°ƒç”¨äº†å¯¹è±¡çš„ hashCodeï¼Œä½†åå‘é”çš„å¯¹è±¡ MarkWord ä¸­å­˜å‚¨çš„æ˜¯çº¿ç¨‹ idï¼Œå¦‚æœè°ƒç”¨ hashCode ä¼šå¯¼è‡´åå‘é”è¢«æ’¤é”€ï¼Œå› ä¸ºå¯¹è±¡å¤´é‡Œ Mark Word å­˜å‚¨çº¿ç¨‹Idç”¨äº†54ä½ï¼Œå‰©ä½™ç©ºé—´ä¸å¤Ÿå­˜å‚¨hashå€¼(31ä½)äº†\r\n\r\n    - è½»é‡çº§é”ä¼šåœ¨é”è®°å½•ä¸­è®°å½• hashCode\r\n\r\n    - é‡é‡çº§é”ä¼šåœ¨ Monitor ä¸­è®°å½• hashCode\r\n\r\n- å¤šä¸ªçº¿ç¨‹ä½¿ç”¨è¯¥å¯¹è±¡ï¼ˆå½“æœ‰å…¶å®ƒçº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶ï¼Œä¼šå°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ï¼‰\r\n- **è°ƒç”¨äº†wait/notifyæ–¹æ³•**ï¼ˆwait/notifyåªæœ‰é‡é‡çº§é”æ‰æœ‰ï¼Œåªæœ‰monitoræ‰æœ‰waitsetï¼Œè°ƒç”¨wait/notifyæ–¹æ³•ä¼šå¯¼è‡´è½»é‡çº§é”æˆ–åå‘é”è†¨èƒ€è€Œä½¿ç”¨**é‡é‡çº§é”**ï¼‰\r\n\r\n\r\n\r\n**æ‰¹é‡é‡åå‘**\r\n\r\n- å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯çº¿ç¨‹é—´ä¸å­˜åœ¨ç«äº‰ï¼Œè¿™æ—¶åå‘T1çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘T2ï¼Œé‡åå‘ä¼šé‡ç½®Thread ID\r\n- å½“æ’¤é”€è¶…è¿‡20æ¬¡åï¼ˆè¶…è¿‡é˜ˆå€¼ï¼‰ï¼ŒJVMä¼šè§‰å¾—æ˜¯ä¸æ˜¯åå‘é”™äº†ï¼Œè¿™æ—¶ä¼šåœ¨ç»™å¯¹è±¡åŠ é”æ—¶ï¼Œé‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹ã€‚\r\n\r\n\r\n\r\n**æ‰¹é‡æ’¤é”€**\r\n\r\n* æ‰¹é‡æ’¤é”€ï¼šå½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 40 æ¬¡åï¼ŒJVM ä¼šè§‰å¾—è‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ï¼Œäºæ˜¯æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„\r\n\r\n```java\r\nstatic Thread t1,t2,t3;\r\nprivate static void test4() throws InterruptedException {\r\n    Vector<Dog> list = new Vector<>();\r\n    int loopNumber = 39;\r\n    t1 = new Thread(() -> {\r\n        for (int i = 0; i < loopNumber; i++) {\r\n            Dog d = new Dog();\r\n            list.add(d);\r\n            synchronized (d) {\r\n                log.debug(i + \"\\t\" + ClassLayout.parseInstance(d).toPrintableSimple(true));\r\n            }\r\n        }\r\n        LockSupport.unpark(t2);\r\n    }, \"t1\");\r\n    t1.start();\r\n    t2 = new Thread(() -> {\r\n        LockSupport.park();\r\n        log.debug(\"===============> \");\r\n        for (int i = 0; i < loopNumber; i++) {\r\n            Dog d = list.get(i);\r\n            log.debug(i + \"\\t\" + ClassLayout.parseInstance(d).toPrintableSimple(true));\r\n            synchronized (d) {\r\n            \tlog.debug(i + \"\\t\" + ClassLayout.parseInstance(d).toPrintableSimple(true));\r\n            }\r\n            log.debug(i + \"\\t\" + ClassLayout.parseInstance(d).toPrintableSimple(true));\r\n        }\r\n        LockSupport.unpark(t3);\r\n    }, \"t2\");\r\n    t2.start();\r\n    t3 = new Thread(() -> {\r\n        LockSupport.park();\r\n        log.debug(\"===============> \");\r\n        for (int i = 0; i < loopNumber; i++) {\r\n            Dog d = list.get(i);\r\n            log.debug(i + \"\\t\" + ClassLayout.parseInstance(d).toPrintableSimple(true));\r\n            synchronized (d) {\r\n            \tlog.debug(i + \"\\t\" + ClassLayout.parseInstance(d).toPrintableSimple(true));\r\n            }\r\n            log.debug(i + \"\\t\" + ClassLayout.parseInstance(d).toPrintableSimple(true));\r\n        }\r\n    }, \"t3\");\r\n    t3.start();\r\n    t3.join();\r\n    log.debug(ClassLayout.parseInstance(new Dog()).toPrintableSimple(true));\r\n}\r\n```\r\n\r\n![image-20230712172438740](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230712172438740.png)\r\n\r\n\r\n\r\n> **å‚è€ƒèµ„æ–™**\r\n>\r\n> - https://github.com/farmerjohngit/myblog/issues/12\r\n> - https://www.cnblogs.com/LemonFive/p/11246086.html\r\n> - https://www.cnblogs.com/LemonFive/p/11248248.html\r\n> - [åå‘é”è®ºæ–‡](https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-149958.pdf)\r\n>\r\n> é”æ˜¯å®ä¾‹çº§åˆ«çš„ï¼Œä½†åœ¨æ‰¹é‡æ’¤é”€ï¼ˆåå‘é”ï¼‰ä¸Šæ˜¯ä»¥ç±»ä¸ºå•ä½çš„\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### è½»é‡çº§é”\r\n\r\nä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªçº¿ç¨‹è¦åŠ é”ï¼Œä½†åŠ é”çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ï¼Œè½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼ˆä¸å¯è§ï¼‰\r\n\r\nå¯é‡å…¥é”ï¼šçº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥ç€çš„ä»£ç å—ï¼Œå¯é‡å…¥é”æœ€å¤§çš„ä½œç”¨æ˜¯**é¿å…æ­»é”**\r\n\r\nè½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼ˆé”é‡å…¥æ—¶ï¼‰ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œï¼ŒJava 6 æ‰å¼•å…¥çš„åå‘é”æ¥ä¼˜åŒ–\r\n\r\né”é‡å…¥å®ä¾‹ï¼š\r\n\r\n```java\r\nstatic final Object obj = new Object();\r\npublic static void method1() {\r\n    synchronized( obj ) {\r\n        // åŒæ­¥å— A\r\n        method2();\r\n    }\r\n}\r\npublic static void method2() {\r\n    synchronized( obj ) {\r\n    \t// åŒæ­¥å— B\r\n    }\r\n}\r\n```\r\n\r\n* åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹çš„**æ ˆå¸§**éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå­˜å‚¨é”å®šå¯¹è±¡çš„ Mark Word\r\n\r\n  ![image-20230714012545749](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230714012545749.png)\r\n\r\n* è®©é”è®°å½•ä¸­ Object reference æŒ‡å‘é”ä½çš„å¯¹è±¡ï¼Œå¹¶å°è¯•ç”¨ CAS æ›¿æ¢ Object çš„ Mark Wordï¼Œå°† Mark Word çš„å€¼å­˜å…¥é”è®°å½•\r\n\r\n* å¦‚æœ CAS æ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´ä¸­å­˜å‚¨äº†é”è®°å½•åœ°å€å’ŒçŠ¶æ€ 00ï¼ˆè½»é‡çº§é”ï¼‰ ï¼Œè¡¨ç¤ºç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”\r\n  ![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608144957.png)\r\n\r\n* å¦‚æœ CAS å¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š\r\n\r\n  * å¦‚æœæ˜¯å…¶å®ƒçº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥ Object çš„è½»é‡çº§é”ï¼Œè¿™æ—¶è¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€è¿‡ç¨‹\r\n  * å¦‚æœæ˜¯çº¿ç¨‹è‡ªå·±æ‰§è¡Œäº† synchronized é”é‡å…¥ï¼Œå°±æ·»åŠ ä¸€æ¡ Lock Record ä½œä¸ºé‡å…¥çš„è®¡æ•°\r\n\r\n  ![image-20230712155321048](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230712155321048.png)\r\n\r\n* å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰\r\n\r\n  * å¦‚æœæœ‰å–å€¼ä¸º null çš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ—¶é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡å…¥è®¡æ•°å‡ 1\r\n  * å¦‚æœé”è®°å½•çš„å€¼ä¸ä¸º nullï¼Œè¿™æ—¶ä½¿ç”¨ CAS **å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´**\r\n    * æˆåŠŸï¼Œåˆ™è§£é”æˆåŠŸ\r\n    * å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### é”è†¨èƒ€\r\n\r\nåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCAS æ“ä½œæ— æ³•æˆåŠŸï¼Œå¯èƒ½æ˜¯å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ç«äº‰ï¼‰ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸º**é‡é‡çº§é”**\r\n\r\n* å½“ Thread-1 è¿›è¡Œè½»é‡çº§åŠ é”æ—¶ï¼ŒThread-0 å·²ç»å¯¹è¯¥å¯¹è±¡åŠ äº†è½»é‡çº§é”\r\n\r\n  ![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145004.png)\r\n\r\n* Thread-1 åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹ï¼šThread-1 ä¸º Object å¯¹è±¡ç”³è¯· Monitor é”ï¼Œ**é€šè¿‡ Object å¯¹è±¡å¤´è·å–åˆ°æŒé”çº¿ç¨‹**ï¼Œå°† Monitor çš„ Owner ç½®ä¸º Thread-0ï¼Œå°† Object çš„å¯¹è±¡å¤´æŒ‡å‘é‡é‡çº§é”åœ°å€ï¼Œç„¶åè‡ªå·±è¿›å…¥ Monitor çš„ EntryList BLOCKED\r\n\r\n  ![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145148.png)\r\n\r\n* å½“ Thread-0 é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨ CAS å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´å¤±è´¥ï¼Œè¿™æ—¶è¿›å…¥é‡é‡çº§è§£é”æµç¨‹ï¼Œå³æŒ‰ç…§ Monitor åœ°å€æ‰¾åˆ° Monitor å¯¹è±¡ï¼Œè®¾ç½® Owner ä¸º nullï¼Œå”¤é†’ EntryList ä¸­ BLOCKED çº¿ç¨‹\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### é”ä¼˜åŒ–\r\n\r\n##### è‡ªæ—‹é”\r\n\r\né‡é‡çº§é”ç«äº‰æ—¶ï¼Œå°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œå¯ä»¥ä½¿ç”¨**è‡ªæ—‹**ï¼ˆé»˜è®¤ 10 æ¬¡ï¼‰æ¥è¿›è¡Œä¼˜åŒ–ï¼Œé‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”\r\n\r\næ³¨æ„ï¼š\r\n\r\n* è‡ªæ—‹å ç”¨ CPU æ—¶é—´ï¼Œå•æ ¸ CPU è‡ªæ—‹å°±æ˜¯æµªè´¹æ—¶é—´ï¼Œå› ä¸ºåŒä¸€æ—¶åˆ»åªèƒ½è¿è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œå¤šæ ¸ CPU è‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿\r\n* è‡ªæ—‹å¤±è´¥çš„çº¿ç¨‹ä¼šè¿›å…¥é˜»å¡çŠ¶æ€\r\n\r\nä¼˜ç‚¹ï¼šä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œ**å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—**\r\n\r\nç¼ºç‚¹ï¼šå½“è‡ªæ—‹çš„çº¿ç¨‹è¶Šæ¥è¶Šå¤šæ—¶ï¼Œä¼šä¸æ–­çš„æ¶ˆè€— CPU èµ„æº\r\n\r\nè‡ªæ—‹é”æƒ…å†µï¼š\r\n\r\n* è‡ªæ—‹æˆåŠŸçš„æƒ…å†µï¼š\r\n      ![image-20230714013154482](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230714013154482.png)\r\n\r\n* è‡ªæ—‹å¤±è´¥çš„æƒ…å†µï¼š\r\n\r\n  ![image-20230714013233028](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230714013233028.png)\r\n\r\nè‡ªæ—‹é”è¯´æ˜ï¼š\r\n\r\n* åœ¨ Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ¯”è¾ƒæ™ºèƒ½\r\n* Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½ï¼Œç”± JVM æ§åˆ¶\r\n\r\n```java\r\n//æ‰‹å†™è‡ªæ—‹é”\r\npublic class SpinLock {\r\n    // æ³›å‹è£…çš„æ˜¯Threadï¼ŒåŸå­å¼•ç”¨çº¿ç¨‹\r\n    AtomicReference<Thread> atomicReference = new AtomicReference<>();\r\n\r\n    public void lock() {\r\n        Thread thread = Thread.currentThread();\r\n        System.out.println(thread.getName() + \" come in\");\r\n\r\n        //å¼€å§‹è‡ªæ—‹ï¼ŒæœŸæœ›å€¼ä¸ºnullï¼Œæ›´æ–°å€¼æ˜¯å½“å‰çº¿ç¨‹\r\n        while (!atomicReference.compareAndSet(null, thread)) {\r\n            Thread.sleep(1000);\r\n            System.out.println(thread.getName() + \" æ­£åœ¨è‡ªæ—‹\");\r\n        }\r\n        System.out.println(thread.getName() + \" è‡ªæ—‹æˆåŠŸ\");\r\n    }\r\n\r\n    public void unlock() {\r\n        Thread thread = Thread.currentThread();\r\n\r\n        //çº¿ç¨‹ä½¿ç”¨å®Œé”æŠŠå¼•ç”¨å˜ä¸ºnull\r\n\t\tatomicReference.compareAndSet(thread, null);\r\n        System.out.println(thread.getName() + \" invoke unlock\");\r\n    }\r\n\r\n    public static void main(String[] args) throws InterruptedException {\r\n        SpinLock lock = new SpinLock();\r\n        new Thread(() -> {\r\n            //å æœ‰é”\r\n            lock.lock();\r\n            Thread.sleep(10000); \r\n\r\n            //é‡Šæ”¾é”\r\n            lock.unlock();\r\n        },\"t1\").start();\r\n\r\n        // è®©mainçº¿ç¨‹æš‚åœ1ç§’ï¼Œä½¿å¾—t1çº¿ç¨‹ï¼Œå…ˆæ‰§è¡Œ\r\n        Thread.sleep(1000);\r\n\r\n        new Thread(() -> {\r\n            lock.lock();\r\n            lock.unlock();\r\n        },\"t2\").start();\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### é”æ¶ˆé™¤\r\n\r\né”æ¶ˆé™¤æ˜¯æŒ‡å¯¹äºè¢«æ£€æµ‹å‡ºä¸å¯èƒ½å­˜åœ¨ç«äº‰çš„å…±äº«æ•°æ®çš„é”è¿›è¡Œæ¶ˆé™¤ï¼Œè¿™æ˜¯ JVM **å³æ—¶ç¼–è¯‘å™¨çš„ä¼˜åŒ–**\r\n\r\né”æ¶ˆé™¤ä¸»è¦æ˜¯é€šè¿‡**é€ƒé€¸åˆ†æ**æ¥æ”¯æŒï¼Œå¦‚æœå †ä¸Šçš„å…±äº«æ•°æ®ä¸å¯èƒ½é€ƒé€¸å‡ºå»è¢«å…¶å®ƒçº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠå®ƒä»¬å½“æˆç§æœ‰æ•°æ®å¯¹å¾…ï¼Œä¹Ÿå°±å¯ä»¥å°†å®ƒä»¬çš„é”è¿›è¡Œæ¶ˆé™¤ï¼ˆåŒæ­¥æ¶ˆé™¤ï¼šJVM é€ƒé€¸åˆ†æï¼‰\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### é”ç²—åŒ–\r\n\r\nå¯¹ç›¸åŒå¯¹è±¡å¤šæ¬¡åŠ é”ï¼Œå¯¼è‡´çº¿ç¨‹å‘ç”Ÿå¤šæ¬¡é‡å…¥ï¼Œé¢‘ç¹çš„åŠ é”æ“ä½œå°±ä¼šå¯¼è‡´æ€§èƒ½æŸè€—ï¼Œå¯ä»¥ä½¿ç”¨é”ç²—åŒ–æ–¹å¼ä¼˜åŒ–\r\n\r\nå¦‚æœè™šæ‹Ÿæœºæ¢æµ‹åˆ°ä¸€ä¸²çš„æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†ä¼šæŠŠåŠ é”çš„èŒƒå›´æ‰©å±•ï¼ˆç²—åŒ–ï¼‰åˆ°æ•´ä¸ªæ“ä½œåºåˆ—çš„å¤–éƒ¨\r\n\r\n* ä¸€äº›çœ‹èµ·æ¥æ²¡æœ‰åŠ é”çš„ä»£ç ï¼Œå…¶å®éšå¼çš„åŠ äº†å¾ˆå¤šé”ï¼š\r\n\r\n  ```java\r\n  public static String concatString(String s1, String s2, String s3) {\r\n      return s1 + s2 + s3;\r\n  }\r\n  ```\r\n\r\n* String æ˜¯ä¸€ä¸ªä¸å¯å˜çš„ç±»ï¼Œç¼–è¯‘å™¨ä¼šå¯¹ String çš„æ‹¼æ¥è‡ªåŠ¨ä¼˜åŒ–ã€‚åœ¨ JDK 1.5 ä¹‹å‰ï¼Œè½¬åŒ–ä¸º StringBuffer å¯¹è±¡çš„è¿ç»­ append() æ“ä½œï¼Œæ¯ä¸ª append() æ–¹æ³•ä¸­éƒ½æœ‰ä¸€ä¸ªåŒæ­¥å—\r\n\r\n  ```java\r\n  public static String concatString(String s1, String s2, String s3) {\r\n      StringBuffer sb = new StringBuffer();\r\n      sb.append(s1);\r\n      sb.append(s2);\r\n      sb.append(s3);\r\n      return sb.toString();\r\n  }\r\n  ```\r\n\r\næ‰©å±•åˆ°ç¬¬ä¸€ä¸ª append() æ“ä½œä¹‹å‰ç›´è‡³æœ€åä¸€ä¸ª append() æ“ä½œä¹‹åï¼Œåªéœ€è¦åŠ é”ä¸€æ¬¡å°±å¯ä»¥\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### å¤šæŠŠé”\r\n\r\nå¤šæŠŠä¸ç›¸å¹²çš„é”ï¼šä¸€é—´å¤§å±‹å­æœ‰ä¸¤ä¸ªåŠŸèƒ½ç¡è§‰ã€å­¦ä¹ ï¼Œäº’ä¸ç›¸å¹²ã€‚ç°åœ¨ä¸€äººè¦å­¦ä¹ ï¼Œä¸€äººè¦ç¡è§‰ï¼Œå¦‚æœåªç”¨ä¸€é—´å±‹å­ï¼ˆä¸€ä¸ªå¯¹è±¡é”ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå¹¶å‘åº¦å¾ˆä½\r\n\r\nå°†é”çš„ç²’åº¦ç»†åˆ†ï¼š\r\n\r\n* å¥½å¤„ï¼Œæ˜¯å¯ä»¥å¢å¼ºå¹¶å‘åº¦\r\n* åå¤„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é” \r\n\r\nè§£å†³æ–¹æ³•ï¼šå‡†å¤‡å¤šä¸ªå¯¹è±¡é”\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    BigRoom bigRoom = new BigRoom();\r\n    new Thread(() -> { bigRoom.study(); }).start();\r\n    new Thread(() -> { bigRoom.sleep(); }).start();\r\n}\r\nclass BigRoom {\r\n    private final Object studyRoom = new Object();\r\n    private final Object sleepRoom = new Object();\r\n\r\n    public void sleep() throws InterruptedException {\r\n        synchronized (sleepRoom) {\r\n            System.out.println(\"sleeping 2 å°æ—¶\");\r\n            Thread.sleep(2000);\r\n        }\r\n    }\r\n\r\n    public void study() throws InterruptedException {\r\n        synchronized (studyRoom) {\r\n            System.out.println(\"study 1 å°æ—¶\");\r\n            Thread.sleep(1000);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æ´»è·ƒæ€§\r\n\r\n##### æ­»é”\r\n\r\n###### å½¢æˆ\r\n\r\næ­»é”ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«é˜»å¡ï¼Œå®ƒä»¬ä¸­çš„ä¸€ä¸ªæˆ–è€…å…¨éƒ¨éƒ½åœ¨ç­‰å¾…æŸä¸ªèµ„æºè¢«é‡Šæ”¾ï¼Œç”±äºçº¿ç¨‹è¢«æ— é™æœŸåœ°é˜»å¡ï¼Œå› æ­¤ç¨‹åºä¸å¯èƒ½æ­£å¸¸ç»ˆæ­¢\r\n\r\nJava æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼š\r\n\r\n1. äº’æ–¥æ¡ä»¶ï¼Œå³å½“èµ„æºè¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼ˆå æœ‰ï¼‰æ—¶ï¼Œåˆ«çš„çº¿ç¨‹ä¸èƒ½ä½¿ç”¨\r\n2. ä¸å¯å‰¥å¤ºæ¡ä»¶ï¼Œèµ„æºè¯·æ±‚è€…ä¸èƒ½å¼ºåˆ¶ä»èµ„æºå æœ‰è€…æ‰‹ä¸­å¤ºå–èµ„æºï¼Œèµ„æºåªèƒ½ç”±èµ„æºå æœ‰è€…ä¸»åŠ¨é‡Šæ”¾\r\n3. è¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼Œå³å½“èµ„æºè¯·æ±‚è€…åœ¨è¯·æ±‚å…¶ä»–çš„èµ„æºçš„åŒæ—¶ä¿æŒå¯¹åŸæœ‰èµ„æºçš„å æœ‰\r\n4. å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼Œå³å­˜åœ¨ä¸€ä¸ªç­‰å¾…å¾ªç¯é˜Ÿåˆ—ï¼šp1 è¦ p2 çš„èµ„æºï¼Œp2 è¦ p1 çš„èµ„æºï¼Œå½¢æˆäº†ä¸€ä¸ªç­‰å¾…ç¯è·¯\r\n\r\nå››ä¸ªæ¡ä»¶éƒ½æˆç«‹çš„æ—¶å€™ï¼Œä¾¿å½¢æˆæ­»é”ã€‚æ­»é”æƒ…å†µä¸‹æ‰“ç ´ä¸Šè¿°ä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œä¾¿å¯è®©æ­»é”æ¶ˆå¤±\r\n\r\n```java\r\npublic class Dead {\r\n    public static Object resources1 = new Object();\r\n    public static Object resources2 = new Object();\r\n    public static void main(String[] args) {\r\n        new Thread(() -> {\r\n            // çº¿ç¨‹1ï¼šå ç”¨èµ„æº1 ï¼Œè¯·æ±‚èµ„æº2\r\n            synchronized(resources1){\r\n                System.out.println(\"çº¿ç¨‹1å·²ç»å ç”¨äº†èµ„æº1ï¼Œå¼€å§‹è¯·æ±‚èµ„æº2\");\r\n                Thread.sleep(2000);//ä¼‘æ¯ä¸¤ç§’ï¼Œé˜²æ­¢çº¿ç¨‹1ç›´æ¥è¿è¡Œå®Œæˆã€‚\r\n                //2ç§’å†…çº¿ç¨‹2è‚¯å®šå¯ä»¥é”ä½èµ„æº2\r\n                synchronized (resources2){\r\n                    System.out.println(\"çº¿ç¨‹1å·²ç»å ç”¨äº†èµ„æº2\");\r\n                }\r\n            }\r\n        }).start();\r\n        new Thread(() -> {\r\n            // çº¿ç¨‹2ï¼šå ç”¨èµ„æº2 ï¼Œè¯·æ±‚èµ„æº1\r\n            synchronized(resources2){\r\n                System.out.println(\"çº¿ç¨‹2å·²ç»å ç”¨äº†èµ„æº2ï¼Œå¼€å§‹è¯·æ±‚èµ„æº1\");\r\n                Thread.sleep(2000);\r\n                synchronized (resources1){\r\n                    System.out.println(\"çº¿ç¨‹2å·²ç»å ç”¨äº†èµ„æº1\");\r\n                }\r\n            }\r\n        }).start();\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n###### å®šä½\r\n\r\nå®šä½æ­»é”çš„æ–¹æ³•ï¼š\r\n\r\n* ä½¿ç”¨ jps å®šä½è¿›ç¨‹ idï¼Œå†ç”¨ `jstack id` å®šä½æ­»é”ï¼Œæ‰¾åˆ°æ­»é”çš„çº¿ç¨‹å»æŸ¥çœ‹æºç ï¼Œè§£å†³ä¼˜åŒ–\r\n\r\n  ```sh\r\n  \"Thread-1\" #12 prio=5 os_prio=0 tid=0x000000001eb69000 nid=0xd40 waiting formonitor entry [0x000000001f54f000]\r\n  \tjava.lang.Thread.State: BLOCKED (on object monitor)\r\n  #çœç•¥    \r\n  \"Thread-1\" #12 prio=5 os_prio=0 tid=0x000000001eb69000 nid=0xd40 waiting for monitor entry [0x000000001f54f000]\r\n  \tjava.lang.Thread.State: BLOCKED (on object monitor)\r\n  #çœç•¥\r\n  \r\n  Found one Java-level deadlock:\r\n  ===================================================\r\n  \"Thread-1\":\r\n      waiting to lock monitor 0x000000000361d378 (object 0x000000076b5bf1c0, a java.lang.Object),\r\n      which is held by \"Thread-0\"\r\n  \"Thread-0\":\r\n      waiting to lock monitor 0x000000000361e768 (object 0x000000076b5bf1d0, a java.lang.Object),\r\n      which is held by \"Thread-1\"\r\n      \r\n  Java stack information for the threads listed above:\r\n  ===================================================\r\n  \"Thread-1\":\r\n      at thread.TestDeadLock.lambda$main$1(TestDeadLock.java:28)\r\n      - waiting to lock <0x000000076b5bf1c0> (a java.lang.Object)\r\n      - locked <0x000000076b5bf1d0> (a java.lang.Object)\r\n      at thread.TestDeadLock$$Lambda$2/883049899.run(Unknown Source)\r\n      at java.lang.Thread.run(Thread.java:745)\r\n  \"Thread-0\":\r\n      at thread.TestDeadLock.lambda$main$0(TestDeadLock.java:15)\r\n      - waiting to lock <0x000000076b5bf1d0> (a java.lang.Object)\r\n      - locked <0x000000076b5bf1c0> (a java.lang.Object)\r\n      at thread.TestDeadLock$$Lambda$1/495053715\r\n  ```\r\n\r\n* Linux ä¸‹å¯ä»¥é€šè¿‡ top å…ˆå®šä½åˆ° CPU å ç”¨é«˜çš„ Java è¿›ç¨‹ï¼Œå†åˆ©ç”¨ `top -Hp è¿›ç¨‹id` æ¥å®šä½æ˜¯å“ªä¸ªçº¿ç¨‹ï¼Œæœ€åå†ç”¨ `jstack <pid>`çš„è¾“å‡ºæ¥çœ‹å„ä¸ªçº¿ç¨‹æ ˆ\r\n\r\n* é¿å…æ­»é”ï¼šé¿å…æ­»é”è¦æ³¨æ„åŠ é”é¡ºåº\r\n\r\n* å¯ä»¥ä½¿ç”¨ jconsole å·¥å…·ï¼Œåœ¨ `jdk\\bin` ç›®å½•ä¸‹\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n###### è§£å†³\r\n\r\nåœ¨çº¿ç¨‹ä½¿ç”¨é”å¯¹è±¡æ—¶ï¼Œ**é¡ºåºåŠ é”**å³å¯é¿å…æ­»é”\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145450.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ´»é”\r\n\r\n###### å®šä¹‰\r\n\r\næ´»é”æŒ‡çš„æ˜¯ä»»åŠ¡æˆ–è€…æ‰§è¡Œè€…æ²¡æœ‰è¢«é˜»å¡ï¼Œç”±äºæŸäº›æ¡ä»¶æ²¡æœ‰æ»¡è¶³ï¼Œå¯¼è‡´ä¸€ç›´é‡å¤å°è¯•â€”å¤±è´¥â€”å°è¯•â€”å¤±è´¥çš„è¿‡ç¨‹\r\n\r\nä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸï¼š\r\n\r\n```java\r\nclass TestLiveLock {\r\n    static volatile int count = 10;\r\n    static final Object lock = new Object();\r\n    public static void main(String[] args) {\r\n        new Thread(() -> {\r\n            // æœŸæœ›å‡åˆ° 0 é€€å‡ºå¾ªç¯\r\n            while (count > 0) {\r\n                Thread.sleep(200);\r\n                count--;\r\n                System.out.println(\"çº¿ç¨‹ä¸€count:\" + count);\r\n            }\r\n        }, \"t1\").start();\r\n        new Thread(() -> {\r\n            // æœŸæœ›è¶…è¿‡ 20 é€€å‡ºå¾ªç¯\r\n            while (count < 20) {\r\n                Thread.sleep(200);\r\n                count++;\r\n                System.out.println(\"çº¿ç¨‹äºŒcount:\"+ count);\r\n            }\r\n        }, \"t2\").start();\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n###### è§£å†³\r\n\r\nåœ¨çº¿ç¨‹æ‰§è¡Œæ—¶ï¼Œä¸­é€”ç»™äºˆ**ä¸åŒçš„é—´éš”æ—¶é—´**å³å¯ã€‚\r\n\r\n**æ­»é”ä¸æ´»é”çš„åŒºåˆ«**\r\n\r\n- æ­»é”æ˜¯å› ä¸ºçº¿ç¨‹äº’ç›¸æŒæœ‰å¯¹è±¡æƒ³è¦çš„é”ï¼Œå¹¶ä¸”éƒ½ä¸é‡Šæ”¾ï¼Œç›´åˆ°æœ€å**çº¿ç¨‹é˜»å¡**ï¼Œ**åœæ­¢è¿è¡Œ**çš„ç°è±¡ã€‚\r\n- æ´»é”æ˜¯å› ä¸ºçº¿ç¨‹é—´ä¿®æ”¹äº†å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œè€Œå¯¼è‡´ä»£ç **ä¸€ç›´åœ¨è¿è¡Œ**ï¼Œå´ä¸€ç›´**è¿è¡Œä¸å®Œ**çš„ç°è±¡ã€‚\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### é¥¥é¥¿\r\n\r\né¥¥é¥¿ï¼šä¸€ä¸ªçº¿ç¨‹ç”±äºä¼˜å…ˆçº§å¤ªä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ° CPU è°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸ\r\n\r\nåœ¨ä½¿ç”¨é¡ºåºåŠ é”æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°é¥¥é¥¿ç°è±¡\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### wait-ify\r\n\r\n#### åŸºæœ¬ä½¿ç”¨\r\n\r\néœ€è¦è·å–å¯¹è±¡é”åæ‰å¯ä»¥è°ƒç”¨ `é”å¯¹è±¡.wait()`ï¼Œnotify éšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼ŒnotifyAll å”¤é†’æ‰€æœ‰çº¿ç¨‹å»ç«äº‰ CPU\r\n\r\nObject ç±» APIï¼š\r\n\r\n```java\r\npublic final void notify():å”¤é†’æ­£åœ¨ç­‰å¾…å¯¹è±¡ç›‘è§†å™¨çš„å•ä¸ªçº¿ç¨‹ã€‚\r\npublic final void notifyAll():å”¤é†’æ­£åœ¨ç­‰å¾…å¯¹è±¡ç›‘è§†å™¨çš„æ‰€æœ‰çº¿ç¨‹ã€‚\r\npublic final void wait():å¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¯¥å¯¹è±¡çš„notify()æ–¹æ³•æˆ– notifyAll()æ–¹æ³•ã€‚\r\npublic final native void wait(long timeout):æœ‰æ—¶é™çš„ç­‰å¾…, åˆ°næ¯«ç§’åç»“æŸç­‰å¾…ï¼Œæˆ–æ˜¯è¢«å”¤é†’\r\n```\r\n\r\nè¯´æ˜ï¼š**wait æ˜¯æŒ‚èµ·çº¿ç¨‹ï¼Œéœ€è¦å”¤é†’çš„éƒ½æ˜¯æŒ‚èµ·æ“ä½œ**ï¼Œé˜»å¡çº¿ç¨‹å¯ä»¥è‡ªå·±å»äº‰æŠ¢é”ï¼ŒæŒ‚èµ·çš„çº¿ç¨‹éœ€è¦å”¤é†’åå»äº‰æŠ¢é”\r\n\r\nå¯¹æ¯” sleep()ï¼š\r\n\r\n* åŸç†ä¸åŒï¼šsleep() æ–¹æ³•æ˜¯å±äº Thread ç±»ï¼Œæ˜¯çº¿ç¨‹ç”¨æ¥æ§åˆ¶è‡ªèº«æµç¨‹çš„ï¼Œä½¿æ­¤çº¿ç¨‹æš‚åœæ‰§è¡Œä¸€æ®µæ—¶é—´è€ŒæŠŠæ‰§è¡Œæœºä¼šè®©ç»™å…¶ä»–çº¿ç¨‹ï¼›wait() æ–¹æ³•å±äº Object ç±»ï¼Œç”¨äºçº¿ç¨‹é—´é€šä¿¡\r\n* å¯¹**é”çš„å¤„ç†æœºåˆ¶**ä¸åŒï¼šè°ƒç”¨ sleep() æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œå½“è°ƒç”¨ wait() æ–¹æ³•çš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šæ”¾å¼ƒå¯¹è±¡é”ï¼Œè¿›å…¥ç­‰å¾…æ­¤å¯¹è±¡çš„ç­‰å¾…é”å®šæ± ï¼ˆä¸é‡Šæ”¾é”å…¶ä»–çº¿ç¨‹æ€ä¹ˆæŠ¢å åˆ°é”æ‰§è¡Œå”¤é†’æ“ä½œï¼‰ï¼Œä½†æ˜¯éƒ½ä¼šé‡Šæ”¾ CPU\r\n* ä½¿ç”¨åŒºåŸŸä¸åŒï¼šwait() æ–¹æ³•å¿…é¡»æ”¾åœ¨**åŒæ­¥æ§åˆ¶æ–¹æ³•å’ŒåŒæ­¥ä»£ç å—ï¼ˆå…ˆè·å–é”ï¼‰ä¸­ä½¿ç”¨**ï¼Œsleep() æ–¹æ³•åˆ™å¯ä»¥æ”¾åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨\r\n\r\nåº•å±‚åŸç†ï¼š\r\n\r\n* Owner çº¿ç¨‹å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨ wait æ–¹æ³•ï¼Œå³å¯è¿›å…¥ WaitSet å˜ä¸º WAITING çŠ¶æ€\r\n* BLOCKED å’Œ WAITING çš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨ CPU æ—¶é—´ç‰‡\r\n* BLOCKED çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹é‡Šæ”¾é”æ—¶å”¤é†’\r\n* WAITING çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹è°ƒç”¨ notify æˆ– notifyAll æ—¶å”¤é†’ï¼Œå”¤é†’åå¹¶ä¸æ„å‘³è€…ç«‹åˆ»è·å¾—é”ï¼Œ**éœ€è¦è¿›å…¥ EntryList é‡æ–°ç«äº‰**\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145204.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä»£ç ä¼˜åŒ–\r\n\r\nè™šå‡å”¤é†’ï¼šnotify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ª WaitSet ä¸­çš„çº¿ç¨‹ï¼Œè¿™æ—¶å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå°±å¯èƒ½å”¤é†’ä¸äº†æ­£ç¡®çš„çº¿ç¨‹\r\n\r\nè§£å†³æ–¹æ³•ï¼šé‡‡ç”¨ notifyAll\r\n\r\nnotifyAll ä»…è§£å†³æŸä¸ªçº¿ç¨‹çš„å”¤é†’é—®é¢˜ï¼Œä½¿ç”¨ if + wait åˆ¤æ–­ä»…æœ‰ä¸€æ¬¡æœºä¼šï¼Œä¸€æ—¦æ¡ä»¶ä¸æˆç«‹ï¼Œæ— æ³•é‡æ–°åˆ¤æ–­\r\n\r\nè§£å†³æ–¹æ³•ï¼šç”¨ while + waitï¼Œå½“æ¡ä»¶ä¸æˆç«‹ï¼Œå†æ¬¡ wait\r\n\r\n```java\r\n@Slf4j(topic = \"c.demo\")\r\npublic class demo {\r\n    static final Object room = new Object();\r\n    static boolean hasCigarette = false;    //æœ‰æ²¡æœ‰çƒŸ\r\n    static boolean hasTakeout = false;\r\n\r\n    public static void main(String[] args) throws InterruptedException {\r\n        new Thread(() -> {\r\n            synchronized (room) {\r\n                log.debug(\"æœ‰çƒŸæ²¡ï¼Ÿ[{}]\", hasCigarette);\r\n                while (!hasCigarette) {//whileé˜²æ­¢è™šå‡å”¤é†’\r\n                    log.debug(\"æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼\");\r\n                    try {\r\n                        room.wait();\r\n                    } catch (InterruptedException e) {\r\n                        e.printStackTrace();\r\n                    }\r\n                }\r\n                log.debug(\"æœ‰çƒŸæ²¡ï¼Ÿ[{}]\", hasCigarette);\r\n                if (hasCigarette) {\r\n                    log.debug(\"å¯ä»¥å¼€å§‹å¹²æ´»äº†\");\r\n                } else {\r\n                    log.debug(\"æ²¡å¹²æˆæ´»...\");\r\n                }\r\n            }\r\n        }, \"å°å—\").start();\r\n\r\n        new Thread(() -> {\r\n            synchronized (room) {\r\n                Thread thread = Thread.currentThread();\r\n                log.debug(\"å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]\", hasTakeout);\r\n                if (!hasTakeout) {\r\n                    log.debug(\"æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼\");\r\n                    try {\r\n                        room.wait();\r\n                    } catch (InterruptedException e) {\r\n                        e.printStackTrace();\r\n                    }\r\n                }\r\n                log.debug(\"å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]\", hasTakeout);\r\n                if (hasTakeout) {\r\n                    log.debug(\"å¯ä»¥å¼€å§‹å¹²æ´»äº†\");\r\n                } else {\r\n                    log.debug(\"æ²¡å¹²æˆæ´»...\");\r\n                }\r\n            }\r\n        }, \"å°å¥³\").start();\r\n\r\n\r\n        Thread.sleep(1000);\r\n        new Thread(() -> {\r\n        // è¿™é‡Œèƒ½ä¸èƒ½åŠ  synchronized (room)ï¼Ÿ\r\n            synchronized (room) {\r\n                hasTakeout = true;\r\n\t\t\t\t//log.debug(\"çƒŸåˆ°äº†å™¢ï¼\");\r\n                log.debug(\"å¤–å–åˆ°äº†å™¢ï¼\");\r\n                room.notifyAll();\r\n            }\r\n        }, \"é€å¤–å–çš„\").start();\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### park-un\r\n\r\nLockSupport æ˜¯ç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„**çº¿ç¨‹åŸè¯­**\r\n\r\nLockSupport ç±»æ–¹æ³•ï¼š\r\n\r\n* `LockSupport.park()`ï¼šæš‚åœå½“å‰çº¿ç¨‹ï¼ŒæŒ‚èµ·åŸè¯­\r\n* `LockSupport.unpark(æš‚åœçš„çº¿ç¨‹å¯¹è±¡)`ï¼šæ¢å¤æŸä¸ªçº¿ç¨‹çš„è¿è¡Œ\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    Thread t1 = new Thread(() -> {\r\n        System.out.println(\"start...\");\t//1\r\n\t\tThread.sleep(1000);// Thread.sleep(3000)\r\n        // å…ˆ park å† unpark å’Œå…ˆ unpark å† park æ•ˆæœä¸€æ ·ï¼Œéƒ½ä¼šç›´æ¥æ¢å¤çº¿ç¨‹çš„è¿è¡Œ\r\n        System.out.println(\"park...\");\t//2\r\n        LockSupport.park();\r\n        System.out.println(\"resume...\");//4\r\n    },\"t1\");\r\n    t1.start();\r\n   \tThread.sleep(2000);\r\n    System.out.println(\"unpark...\");\t//3\r\n    LockSupport.unpark(t1);\r\n}\r\n```\r\n\r\nLockSupport å‡ºç°å°±æ˜¯ä¸ºäº†å¢å¼º wait & notify çš„åŠŸèƒ½ï¼š\r\n\r\n* waitï¼Œnotify å’Œ notifyAll å¿…é¡»é…åˆ Object Monitor ä¸€èµ·ä½¿ç”¨ï¼Œè€Œ parkã€unpark ä¸éœ€è¦\r\n* park & unpark **ä»¥çº¿ç¨‹ä¸ºå•ä½**æ¥é˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼Œè€Œ notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ŒnotifyAll æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹\r\n* park & unpark å¯ä»¥å…ˆ unparkï¼Œè€Œ wait & notify ä¸èƒ½å…ˆ notifyã€‚ç±»æ¯”ç”Ÿäº§æ¶ˆè´¹ï¼Œå…ˆæ¶ˆè´¹å‘ç°æœ‰äº§å“å°±æ¶ˆè´¹ï¼Œæ²¡æœ‰å°±ç­‰å¾…ï¼›å…ˆç”Ÿäº§å°±ç›´æ¥äº§ç”Ÿå•†å“ï¼Œç„¶åçº¿ç¨‹ç›´æ¥æ¶ˆè´¹\r\n* wait ä¼šé‡Šæ”¾é”èµ„æºè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œ**park ä¸ä¼šé‡Šæ”¾é”èµ„æº**ï¼Œåªè´Ÿè´£é˜»å¡å½“å‰çº¿ç¨‹ï¼Œä¼šé‡Šæ”¾ CPU\r\n\r\nåŸç†ï¼šç±»ä¼¼ç”Ÿäº§è€…æ¶ˆè´¹è€…\r\n\r\n* æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„**Parkå¯¹è±¡**ï¼Œå¹¶ä¸”è¯¥å¯¹è±¡ç”±`_counter, _cond, _mutex`ç»„æˆ\r\n\r\n  - å…ˆè°ƒç”¨ park å†è°ƒç”¨ unpark æ—¶\r\n\r\n    - å…ˆè°ƒç”¨ park\r\n\r\n      - çº¿ç¨‹è¿è¡Œæ—¶ï¼Œä¼šå°†Parkå¯¹è±¡ä¸­çš„ **`_counter`** **çš„å€¼è®¾ä¸º0**ï¼›\r\n      - è°ƒç”¨ park æ—¶ï¼Œä¼šå…ˆæŸ¥çœ‹`_counter`çš„å€¼æ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ï¼Œåˆ™å°†çº¿ç¨‹æ”¾å…¥é˜»å¡é˜Ÿåˆ—`_cond`ä¸­\r\n      - æ”¾å…¥é˜»å¡é˜Ÿåˆ—ä¸­åï¼Œä¼š**å†æ¬¡**å°†`_counter`è®¾ç½®ä¸º0\r\n\r\n    <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145250.png\" alt=\"img\" class=\"scale-50\" />\r\n\r\n    - ç„¶åè°ƒç”¨unpark\r\n\r\n      - è°ƒç”¨unparkæ–¹æ³•åï¼Œä¼šå°†`_counter`çš„å€¼è®¾ç½®ä¸º1\r\n\r\n      - å»å”¤é†’é˜»å¡é˜Ÿåˆ—`_cond`ä¸­çš„çº¿ç¨‹\r\n\r\n      - çº¿ç¨‹ç»§ç»­è¿è¡Œå¹¶å°†`_counter`çš„å€¼è®¾ä¸º0\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145303.png\" alt=\"img\" class=\"scale-50\" />\r\n\r\n  - å…ˆè°ƒç”¨unparkï¼Œå†è°ƒç”¨park\r\n    - è°ƒç”¨unpark\r\n      - ä¼šå°†`_counter`è®¾ç½®ä¸º1ï¼ˆè¿è¡Œæ—¶0ï¼‰\r\n    - è°ƒç”¨parkæ–¹æ³•\r\n      - æŸ¥çœ‹`_counter`æ˜¯å¦ä¸º0\r\n      - å› ä¸ºunparkå·²ç»æŠŠ`_counter`è®¾ç½®ä¸º1ï¼Œæ‰€ä»¥æ­¤æ—¶å°†`_counter`è®¾ç½®ä¸º0ï¼Œä½†**ä¸æ”¾å…¥**é˜»å¡é˜Ÿåˆ—`_cond`ä¸­\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145313.png\" alt=\"img\" class=\"scale-50\" />\r\n\r\n> å½“ç¨‹åºå¯åŠ¨åï¼Œå½“å‰çº¿ç¨‹å…ˆparkæ‰ä¼šè¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œæ— è®ºæ˜¯å¦å…ˆè°ƒç”¨unparkï¼Œåœ¨è°ƒç”¨unparkåå†è°ƒç”¨parkï¼Œå½“å‰çº¿ç¨‹éƒ½ä¸ä¼šè¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå³é˜»å¡å¤±æ•ˆï¼ˆpark-unpark-parkï¼ˆé˜»å¡å¤±æ•ˆï¼‰ã€unpark-park-parkï¼ˆé˜»å¡å¤±æ•ˆï¼‰ï¼‰\r\n>\r\n\r\n***\r\n\r\n\r\n\r\n### å®‰å…¨åˆ†æ\r\n\r\næˆå‘˜å˜é‡å’Œé™æ€å˜é‡ï¼š\r\n\r\n* å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨\r\n* å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼š\r\n  * å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨\r\n  * å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜\r\n\r\nå±€éƒ¨å˜é‡ï¼š\r\n\r\n* å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„\r\n* å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡ä¸ä¸€å®šçº¿ç¨‹å®‰å…¨ï¼ˆé€ƒé€¸åˆ†æï¼‰ï¼š\r\n  * å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆæ¯ä¸€ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªæ ˆå¸§ï¼‰\r\n  * å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ˆæš´éœ²å¼•ç”¨ï¼‰\r\n\r\nå¸¸è§çº¿ç¨‹å®‰å…¨ç±»ï¼šStringã€Integerã€StringBufferã€Randomã€Vectorã€Hashtableã€java.util.concurrent åŒ…\r\n\r\n* çº¿ç¨‹å®‰å…¨æŒ‡çš„æ˜¯ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„\r\n\r\n* **æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­çš„ï¼Œä½†å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„**ï¼Œåªèƒ½ä¿è¯è°ƒç”¨çš„æ–¹æ³•å†…éƒ¨å®‰å…¨ï¼š\r\n\r\n  ```java\r\n  Hashtable table = new Hashtable();\r\n  // çº¿ç¨‹1ï¼Œçº¿ç¨‹2\r\n  if(table.get(\"key\") == null) {\r\n  \ttable.put(\"key\", value);\r\n  }\r\n  ```\r\n\r\næ— çŠ¶æ€ç±»çº¿ç¨‹å®‰å…¨ï¼Œå°±æ˜¯æ²¡æœ‰æˆå‘˜å˜é‡çš„ç±»\r\n\r\nä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨ï¼šStringã€Integer ç­‰éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œ**å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜**ï¼Œæ‰€ä»¥æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨\r\n\r\n* replace ç­‰æ–¹æ³•åº•å±‚æ˜¯æ–°å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¤åˆ¶è¿‡å»\r\n\r\n  ```java\r\n  Map<String,Object> map = new HashMap<>();\t// çº¿ç¨‹ä¸å®‰å…¨\r\n  String S1 = \"...\";\t\t\t\t\t\t\t// çº¿ç¨‹å®‰å…¨\r\n  final String S2 = \"...\";\t\t\t\t\t// çº¿ç¨‹å®‰å…¨\r\n  Date D1 = new Date();\t\t\t\t\t\t// çº¿ç¨‹ä¸å®‰å…¨\r\n  final Date D2 = new Date();\t\t\t\t\t// çº¿ç¨‹ä¸å®‰å…¨ï¼Œfinalè®©D2å¼•ç”¨çš„å¯¹è±¡ä¸èƒ½å˜ï¼Œä½†å¯¹è±¡çš„å†…å®¹å¯ä»¥å˜\r\n  ```\r\n\r\næŠ½è±¡æ–¹æ³•å¦‚æœæœ‰å‚æ•°ï¼Œè¢«é‡å†™åè¡Œä¸ºä¸ç¡®å®šå¯èƒ½é€ æˆçº¿ç¨‹ä¸å®‰å…¨ï¼Œè¢«ç§°ä¹‹ä¸ºå¤–æ˜Ÿæ–¹æ³•ï¼š`public abstract foo(Student s);`\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### åŒæ­¥æ¨¡å¼\r\n\r\n#### ä¿æŠ¤æ€§æš‚åœ\r\n\r\n##### å•ä»»åŠ¡ç‰ˆ\r\n\r\nGuarded Suspensionï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ\r\n\r\n* æœ‰ä¸€ä¸ªç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©å®ƒä»¬å…³è”åŒä¸€ä¸ª GuardedObject\r\n* å¦‚æœæœ‰ç»“æœä¸æ–­ä»ä¸€ä¸ªçº¿ç¨‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰\r\n* JDK ä¸­ï¼Œjoin çš„å®ç°ã€Future çš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼\r\n\r\n![image-20230714223418977](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230714223418977.png)\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    GuardedObjectV2 object = new GuardedObjectV2();\r\n    new Thread(() -> {\r\n        sleep(1);\r\n        object.complete(Arrays.asList(\"a\", \"b\", \"c\"));\r\n    }).start();\r\n    \r\n    Object response = object.get(2500);\r\n    if (response != null) {\r\n        log.debug(\"get response: [{}] lines\", ((List<String>) response).size());\r\n    } else {\r\n        log.debug(\"can't get response\");\r\n    }\r\n}\r\n\r\nclass GuardedObject {\r\n    private Object response;\r\n    private final Object lock = new Object();\r\n\r\n    //è·å–ç»“æœ\r\n    //timeout :æœ€å¤§ç­‰å¾…æ—¶é—´\r\n    public Object get(long millis) {\r\n        synchronized (lock) {\r\n            // 1) è®°å½•æœ€åˆæ—¶é—´\r\n            long begin = System.currentTimeMillis();\r\n            // 2) å·²ç»ç»å†çš„æ—¶é—´\r\n            long timePassed = 0;\r\n            while (response == null) {\r\n                // 4) å‡è®¾ millis æ˜¯ 1000ï¼Œç»“æœåœ¨ 400 æ—¶å”¤é†’äº†ï¼Œé‚£ä¹ˆè¿˜æœ‰ 600 è¦ç­‰\r\n                long waitTime = millis - timePassed;\r\n                log.debug(\"waitTime: {}\", waitTime);\r\n                //ç»å†æ—¶é—´è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´é€€å‡ºå¾ªç¯\r\n                if (waitTime <= 0) {\r\n                    log.debug(\"break...\");\r\n                    break;\r\n                }\r\n                try {\r\n                    lock.wait(waitTime);\r\n                } catch (InterruptedException e) {\r\n                    e.printStackTrace();\r\n                }\r\n                // 3) å¦‚æœæå‰è¢«å”¤é†’ï¼Œè¿™æ—¶å·²ç»ç»å†çš„æ—¶é—´å‡è®¾ä¸º 400\r\n                timePassed = System.currentTimeMillis() - begin;\r\n                log.debug(\"timePassed: {}, object is null {}\",\r\n                        timePassed, response == null);\r\n            }\r\n            return response;\r\n        }\r\n    }\r\n\r\n    //äº§ç”Ÿç»“æœ\r\n    public void complete(Object response) {\r\n        synchronized (lock) {\r\n            // æ¡ä»¶æ»¡è¶³ï¼Œé€šçŸ¥ç­‰å¾…çº¿ç¨‹\r\n            this.response = response;\r\n            log.debug(\"notify...\");\r\n            lock.notifyAll();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n##### å¤šä»»åŠ¡ç‰ˆ\r\n\r\nå¤šä»»åŠ¡ç‰ˆä¿æŠ¤æ€§æš‚åœï¼š\r\n\r\n![image-20230712214912432](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230712214912432.png)\r\n\r\n```java\r\n@Slf4j(topic = \"c.Test20\")\r\npublic class Test20 {\r\n    public static void main(String[] args) throws InterruptedException {\r\n        for (int i = 0; i < 3; i++) {\r\n            new People().start();\r\n        }\r\n        Sleeper.sleep(1);\r\n        for (Integer id : Mailboxes.getIds()) {\r\n            new Postman(id, \"å†…å®¹\" + id).start();\r\n        }\r\n    }\r\n}\r\n\r\n@Slf4j(topic = \"c.People\")\r\nclass People extends Thread{\r\n    @Override\r\n    public void run() {\r\n        // æ”¶ä¿¡\r\n        GuardedObject guardedObject = Mailboxes.createGuardedObject();\r\n        log.debug(\"å¼€å§‹æ”¶ä¿¡ id:{}\", guardedObject.getId());\r\n        Object mail = guardedObject.get(5000);\r\n        log.debug(\"æ”¶åˆ°ä¿¡ id:{}, å†…å®¹:{}\", guardedObject.getId(), mail);\r\n    }\r\n}\r\n\r\n@Slf4j(topic = \"c.Postman\")\r\nclass Postman extends Thread {\r\n    private int id;\r\n    private String mail;\r\n\r\n    public Postman(int id, String mail) {\r\n        this.id = id;\r\n        this.mail = mail;\r\n    }\r\n\r\n    @Override\r\n    public void run() {\r\n        GuardedObject guardedObject = Mailboxes.getGuardedObject(id);\r\n        log.debug(\"é€ä¿¡ id:{}, å†…å®¹:{}\", id, mail);\r\n        guardedObject.complete(mail);\r\n    }\r\n}\r\n\r\nclass Mailboxes {\r\n    private static Map<Integer, GuardedObject> boxes = new Hashtable<>();\r\n\r\n    private static int id = 1;\r\n    // äº§ç”Ÿå”¯ä¸€ id\r\n    private static synchronized int generateId() {\r\n        return id++;\r\n    }\r\n\r\n    public static GuardedObject getGuardedObject(int id) {\r\n        return boxes.remove(id);\r\n    }\r\n\r\n    public static GuardedObject createGuardedObject() {\r\n        GuardedObject go = new GuardedObject(generateId());\r\n        boxes.put(go.getId(), go);\r\n        return go;\r\n    }\r\n\r\n    public static Set<Integer> getIds() {\r\n        return boxes.keySet();\r\n    }\r\n}\r\n\r\n// å¢åŠ è¶…æ—¶æ•ˆæœ\r\n@Slf4j(topic = \"c.GuardedObject\")\r\nclass GuardedObject {\r\n\r\n    // æ ‡è¯† Guarded Object\r\n    private int id;\r\n\r\n    public GuardedObject(int id) {\r\n        this.id = id;\r\n    }\r\n\r\n    public int getId() {\r\n        return id;\r\n    }\r\n\r\n    // ç»“æœ\r\n    private Object response;\r\n\r\n    private final Object lock = new Object();\r\n\r\n    // è·å–ç»“æœ\r\n    public Object get(long millis) {\r\n        synchronized (this) {\r\n            // 1) è®°å½•æœ€åˆæ—¶é—´\r\n            long last = System.currentTimeMillis();\r\n            // 2) å·²ç»ç»å†çš„æ—¶é—´\r\n            long timePassed = 0;\r\n            while (response == null) {\r\n                // 4) å‡è®¾ millis æ˜¯ 1000ï¼Œç»“æœåœ¨ 400 æ—¶å”¤é†’äº†ï¼Œé‚£ä¹ˆè¿˜æœ‰ 600 è¦ç­‰\r\n                long waitTime = millis - timePassed;\r\n                log.debug(\"waitTime: {}\", waitTime);\r\n                if (waitTime <= 0) {\r\n                    log.debug(\"break...\");\r\n                    break;\r\n                }\r\n                try {\r\n                    this.wait(waitTime);\r\n                } catch (InterruptedException e) {\r\n                    e.printStackTrace();\r\n                }\r\n                // 3) å¦‚æœæå‰è¢«å”¤é†’ï¼Œè¿™æ—¶å·²ç»ç»å†çš„æ—¶é—´å‡è®¾ä¸º 400\r\n                timePassed = System.currentTimeMillis() - last;\r\n                log.debug(\"timePassed: {}, object is null? {}\", timePassed, response == null);\r\n            }\r\n            return response;\r\n        }\r\n    }\r\n\r\n    // äº§ç”Ÿç»“æœ\r\n    public void complete(Object response) {\r\n        synchronized (this) {\r\n            // ç»™ç»“æœæˆå‘˜å˜é‡èµ‹å€¼\r\n            this.response = response;\r\n            log.debug(\"notify...\");\r\n            this.notifyAll();\r\n        }\r\n    }\r\n}\r\n\r\n\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### é¡ºåºè¾“å‡º\r\n\r\n**Wait/Notifyç‰ˆæœ¬**\r\n\r\n```java\r\nstatic final Object LOCK = new Object();\r\n//åˆ¤æ–­å…ˆæ‰§è¡Œçš„å†…å®¹æ˜¯å¦æ‰§è¡Œå®Œæ¯•\r\nstatic Boolean judge = false;\r\npublic static void main(String[] args) {\r\n\tnew Thread(()->{\r\n\t\tsynchronized (LOCK) {\r\n\t\t\twhile (!judge) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tLOCK.wait();\r\n\t\t\t\t} catch (InterruptedException e) {\r\n\t\t\t\t\te.printStackTrace();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tSystem.out.println(\"2\");\r\n\t\t}\r\n\t}).start();\r\n\r\n\tnew Thread(()->{\r\n\t\tsynchronized (LOCK) {\r\n\t\t\tSystem.out.println(\"1\");\r\n\t\t\tjudge = true;\r\n               //æ‰§è¡Œå®Œæ¯•ï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹\r\n\t\t\tLOCK.notifyAll();\r\n\t\t}\r\n\t}).start();\r\n}\r\n```\r\n\r\n**Park Unpark ç‰ˆ**\r\n\r\n```java\r\nThread t1 = new Thread(() -> {\r\ntry { Thread.sleep(1000); } catch (InterruptedException e) { }\r\n// å½“æ²¡æœ‰ã€è®¸å¯ã€æ—¶ï¼Œå½“å‰çº¿ç¨‹æš‚åœè¿è¡Œï¼›æœ‰ã€è®¸å¯ã€æ—¶ï¼Œç”¨æ‰è¿™ä¸ªã€è®¸å¯ã€ï¼Œå½“å‰çº¿ç¨‹æ¢å¤è¿è¡Œ\r\nLockSupport.park();\r\nSystem.out.println(\"1\");\r\n});\r\nThread t2 = new Thread(() -> {\r\nSystem.out.println(\"2\");\r\n// ç»™çº¿ç¨‹ t1 å‘æ”¾ã€è®¸å¯ã€ï¼ˆå¤šæ¬¡è¿ç»­è°ƒç”¨ unpark åªä¼šå‘æ”¾ä¸€ä¸ªã€è®¸å¯ã€ï¼‰\r\nLockSupport.unpark(t1);\r\n});\r\nt1.start();\r\nt2.start();\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### äº¤æ›¿è¾“å‡º\r\n\r\n**wait/notifyç‰ˆæœ¬**\r\n\r\n```java\r\npublic class Test4 {\r\n\tstatic Symbol symbol = new Symbol();\r\n\tpublic static void main(String[] args) {\r\n\t\tnew Thread(()->{\r\n\t\t\tsymbol.run(\"a\", 1, 2);\r\n\t\t}).start();\r\n\r\n\t\tnew Thread(()->{\r\n\t\t\tsymbol.run(\"b\", 2, 3);\r\n\r\n\t\t}).start();\r\n\t\t\r\n\t\tnew Thread(()->{\r\n\t\t\tsymbol.run(\"c\", 3, 1);\r\n\t\t}).start();\r\n\t}\r\n}\r\n\r\nclass Symbol {\r\n\tpublic synchronized void run(String str, int flag, int nextFlag) {\r\n\t\tfor(int i=0; i<loopNumber; i++) {\r\n\t\t\twhile(flag != this.flag) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tthis.wait();\r\n\t\t\t\t} catch (InterruptedException e) {\r\n\t\t\t\t\te.printStackTrace();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tSystem.out.println(str);\r\n\t\t\t//è®¾ç½®ä¸‹ä¸€ä¸ªè¿è¡Œçš„çº¿ç¨‹æ ‡è®°\r\n\t\t\tthis.flag = nextFlag;\r\n\t\t\t//å”¤é†’æ‰€æœ‰çº¿ç¨‹\r\n\t\t\tthis.notifyAll();\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * çº¿ç¨‹çš„æ‰§è¡Œæ ‡è®°ï¼Œ 1->a 2->b 3->c\r\n\t */\r\n\tprivate int flag = 1;\r\n\tprivate int loopNumber = 5;\r\n\r\n\tpublic int getFlag() {\r\n\t\treturn flag;\r\n\t}\r\n\r\n\tpublic void setFlag(int flag) {\r\n\t\tthis.flag = flag;\r\n\t}\r\n\r\n\tpublic int getLoopNumber() {\r\n\t\treturn loopNumber;\r\n\t}\r\n\r\n\tpublic void setLoopNumber(int loopNumber) {\r\n\t\tthis.loopNumber = loopNumber;\r\n\t}\r\n}\r\n```\r\n\r\n**await/signalç‰ˆæœ¬**\r\n\r\n```java\r\npublic class Test5 {\r\n\tstatic AwaitSignal awaitSignal = new AwaitSignal();\r\n\tstatic Condition conditionA = awaitSignal.newCondition();\r\n\tstatic Condition conditionB = awaitSignal.newCondition();\r\n\tstatic Condition conditionC = awaitSignal.newCondition();\r\n\tpublic static void main(String[] args) {\r\n\t\tnew Thread(()->{\r\n\t\t\tawaitSignal.run(\"a\", conditionA, conditionB);\r\n\t\t}).start();\r\n\r\n\t\tnew Thread(()->{\r\n\t\t\tawaitSignal.run(\"b\", conditionB, conditionC);\r\n\t\t}).start();\r\n\r\n\t\tnew Thread(()->{\r\n\t\t\tawaitSignal.run(\"c\", conditionC, conditionA);\r\n\t\t}).start();\r\n\r\n\r\n\t\ttry {\r\n\t\t\tThread.sleep(1000);\r\n\t\t} catch (InterruptedException e) {\r\n\t\t\te.printStackTrace();\r\n\t\t}\r\n\t\tawaitSignal.lock();\r\n\t\ttry {\r\n            //å”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹\r\n\t\t\tconditionA.signal();\r\n\t\t}finally {\r\n\t\t\tawaitSignal.unlock();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass AwaitSignal extends ReentrantLock{\r\n\tpublic void run(String str, Condition thisCondition, Condition nextCondition) {\r\n\t\tfor(int i=0; i<loopNumber; i++) {\r\n\t\t\tlock();\r\n\t\t\ttry {\r\n                //å…¨éƒ¨è¿›å…¥ç­‰å¾…çŠ¶æ€\r\n\t\t\t\tthisCondition.await();\r\n\t\t\t\tSystem.out.print(str);\r\n\t\t\t\tnextCondition.signal();\r\n\t\t\t} catch (InterruptedException e) {\r\n\t\t\t\te.printStackTrace();\r\n\t\t\t} finally {\r\n\t\t\t\tunlock();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprivate int loopNumber=5;\r\n\r\n\tpublic int getLoopNumber() {\r\n\t\treturn loopNumber;\r\n\t}\r\n\r\n\tpublic void setLoopNumber(int loopNumber) {\r\n\t\tthis.loopNumber = loopNumber;\r\n\t}\r\n}\r\n```\r\n\r\n**Park Unpark ç‰ˆ**\r\n\r\n```java\r\n@Slf4j(topic = \"c.Test31\")\r\npublic class Test31 {\r\n\r\n    static Thread t1;\r\n    static Thread t2;\r\n    static Thread t3;\r\n    public static void main(String[] args) {\r\n        ParkUnpark pu = new ParkUnpark(5);\r\n        t1 = new Thread(() -> {\r\n            pu.print(\"a\", t2);\r\n        });\r\n        t2 = new Thread(() -> {\r\n            pu.print(\"b\", t3);\r\n        });\r\n        t3 = new Thread(() -> {\r\n            pu.print(\"c\", t1);\r\n        });\r\n        t1.start();\r\n        t2.start();\r\n        t3.start();\r\n\r\n        LockSupport.unpark(t1);\r\n    }\r\n}\r\n\r\nclass ParkUnpark {\r\n    public void print(String str, Thread next) {\r\n        for (int i = 0; i < loopNumber; i++) {\r\n            LockSupport.park();\r\n            System.out.print(str);\r\n            LockSupport.unpark(next);\r\n        }\r\n    }\r\n\r\n    private int loopNumber;\r\n\r\n    public ParkUnpark(int loopNumber) {\r\n        this.loopNumber = loopNumber;\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å¼‚æ­¥æ¨¡å¼\r\n\r\n#### ä¼ ç»Ÿç‰ˆ\r\n\r\nå¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼š\r\n\r\n```java\r\nclass ShareData {\r\n    private int number = 0;\r\n    private Lock lock = new ReentrantLock();\r\n    private Condition condition = lock.newCondition();\r\n\r\n    public void increment() throws Exception{\r\n        // åŒæ­¥ä»£ç å—ï¼ŒåŠ é”\r\n        lock.lock();\r\n        try {\r\n            // åˆ¤æ–­  é˜²æ­¢è™šå‡å”¤é†’\r\n            while(number != 0) {\r\n                // ç­‰å¾…ä¸èƒ½ç”Ÿäº§\r\n                condition.await();\r\n            }\r\n            // å¹²æ´»\r\n            number++;\r\n            System.out.println(Thread.currentThread().getName() + \"\\t \" + number);\r\n            // é€šçŸ¥ å”¤é†’\r\n            condition.signalAll();\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        } finally {\r\n            lock.unlock();\r\n        }\r\n    }\r\n\r\n    public void decrement() throws Exception{\r\n        // åŒæ­¥ä»£ç å—ï¼ŒåŠ é”\r\n        lock.lock();\r\n        try {\r\n            // åˆ¤æ–­ é˜²æ­¢è™šå‡å”¤é†’\r\n            while(number == 0) {\r\n                // ç­‰å¾…ä¸èƒ½æ¶ˆè´¹\r\n                condition.await();\r\n            }\r\n            // å¹²æ´»\r\n            number--;\r\n            System.out.println(Thread.currentThread().getName() + \"\\t \" + number);\r\n            // é€šçŸ¥ å”¤é†’\r\n            condition.signalAll();\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        } finally {\r\n            lock.unlock();\r\n        }\r\n    }\r\n}\r\n\r\npublic class TraditionalProducerConsumer {\r\n\tpublic static void main(String[] args) {\r\n        ShareData shareData = new ShareData();\r\n        // t1çº¿ç¨‹ï¼Œç”Ÿäº§\r\n        new Thread(() -> {\r\n            for (int i = 0; i < 5; i++) {\r\n            \tshareData.increment();\r\n            }\r\n        }, \"t1\").start();\r\n\r\n        // t2çº¿ç¨‹ï¼Œæ¶ˆè´¹\r\n        new Thread(() -> {\r\n            for (int i = 0; i < 5; i++) {\r\n\t\t\t\tshareData.decrement();\r\n            }\r\n        }, \"t2\").start(); \r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n#### æ”¹è¿›ç‰ˆ\r\n\r\nå¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼š\r\n\r\n* æ¶ˆè´¹é˜Ÿåˆ—å¯ä»¥ç”¨æ¥å¹³è¡¡ç”Ÿäº§å’Œæ¶ˆè´¹çš„çº¿ç¨‹èµ„æºï¼Œä¸éœ€è¦äº§ç”Ÿç»“æœå’Œæ¶ˆè´¹ç»“æœçš„çº¿ç¨‹ä¸€ä¸€å¯¹åº”\r\n* ç”Ÿäº§è€…ä»…è´Ÿè´£äº§ç”Ÿç»“æœæ•°æ®ï¼Œä¸å…³å¿ƒæ•°æ®è¯¥å¦‚ä½•å¤„ç†ï¼Œè€Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç»“æœæ•°æ®\r\n* æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æœ‰å®¹é‡é™åˆ¶çš„ï¼Œæ»¡æ—¶ä¸ä¼šå†åŠ å…¥æ•°æ®ï¼Œç©ºæ—¶ä¸ä¼šå†æ¶ˆè€—æ•°æ®\r\n* JDK ä¸­å„ç§é˜»å¡é˜Ÿåˆ—ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼\r\n\r\n![image-20230712221519679](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230712221519679.png)\r\n\r\n```java\r\npublic class demo {\r\n    public static void main(String[] args) {\r\n        MessageQueue queue = new MessageQueue(2);\r\n        for (int i = 0; i < 3; i++) {\r\n            int id = i;\r\n            new Thread(() -> {\r\n                queue.put(new Message(id,\"å€¼\"+id));\r\n            }, \"ç”Ÿäº§è€…\" + i).start();\r\n        }\r\n        \r\n        new Thread(() -> {\r\n            while (true) {\r\n                try {\r\n                    Thread.sleep(1000);\r\n                    Message message = queue.take();\r\n                } catch (InterruptedException e) {\r\n                    e.printStackTrace();\r\n                }\r\n            }\r\n        },\"æ¶ˆè´¹è€…\").start();\r\n    }\r\n}\r\n\r\n//æ¶ˆæ¯é˜Ÿåˆ—ç±»ï¼ŒJavaé—´çº¿ç¨‹ä¹‹é—´é€šä¿¡\r\nclass MessageQueue {\r\n    private LinkedList<Message> list = new LinkedList<>();//æ¶ˆæ¯çš„é˜Ÿåˆ—é›†åˆ\r\n    private int capacity;//é˜Ÿåˆ—å®¹é‡\r\n    public MessageQueue(int capacity) {\r\n        this.capacity = capacity;\r\n    }\r\n\r\n    //è·å–æ¶ˆæ¯\r\n    public Message take() {\r\n        //æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º\r\n        synchronized (list) {\r\n            while (list.isEmpty()) {\r\n                try {\r\n                    sout(Thread.currentThread().getName() + \":é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…\");\r\n                    list.wait();\r\n                } catch (InterruptedException e) {\r\n                    e.printStackTrace();\r\n                }\r\n            }\r\n            //ä»é˜Ÿåˆ—çš„å¤´éƒ¨è·å–æ¶ˆæ¯è¿”å›\r\n            Message message = list.removeFirst();\r\n            sout(Thread.currentThread().getName() + \"ï¼šå·²æ¶ˆè´¹æ¶ˆæ¯--\" + message);\r\n            list.notifyAll();\r\n            return message;\r\n        }\r\n    }\r\n\r\n    //å­˜å…¥æ¶ˆæ¯\r\n    public void put(Message message) {\r\n        synchronized (list) {\r\n            //æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦æ»¡\r\n            while (list.size() == capacity) {\r\n                try {\r\n                    sout(Thread.currentThread().getName()+\":é˜Ÿåˆ—ä¸ºå·²æ»¡ï¼Œç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…\");\r\n                    list.wait();\r\n                } catch (InterruptedException e) {\r\n                    e.printStackTrace();\r\n                }\r\n            }\r\n            //å°†æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨\r\n            list.addLast(message);\r\n            sout(Thread.currentThread().getName() + \":å·²ç”Ÿäº§æ¶ˆæ¯--\" + message);\r\n            list.notifyAll();\r\n        }\r\n    }\r\n}\r\n\r\nfinal class Message {\r\n    private int id;\r\n    private Object value;\r\n\t//get set\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### é˜»å¡é˜Ÿåˆ—\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    ExecutorService consumer = Executors.newFixedThreadPool(1);\r\n    ExecutorService producer = Executors.newFixedThreadPool(1);\r\n    BlockingQueue<Integer> queue = new SynchronousQueue<>();\r\n    producer.submit(() -> {\r\n        try {\r\n            System.out.println(\"ç”Ÿäº§...\");\r\n            Thread.sleep(1000);\r\n            queue.put(10);\r\n        } catch (InterruptedException e) {\r\n            e.printStackTrace();\r\n        }\r\n    });\r\n    consumer.submit(() -> {\r\n        try {\r\n            System.out.println(\"ç­‰å¾…æ¶ˆè´¹...\");\r\n            Integer result = queue.take();\r\n            System.out.println(\"ç»“æœä¸º:\" + result);\r\n        } catch (InterruptedException e) {\r\n            e.printStackTrace();\r\n        }\r\n    });\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"å¹¶å‘ç¼–ç¨‹æ•´ç†ç‰ˆ-JUC","tags":["ConcurrentHashMap","CopyOnWriteArrayList","SkipListMap","ConcurrentLinkedQueue"],"categories":["Java","å¹¶å‘ç¼–ç¨‹"],"author":"imklaus","excerpt":"\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\n\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\n\n","link":"/posts/Concurrent_Programming-JUC","content":"\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\n\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\n\n<!-- more -->\n\n## å¹¶å‘åŒ…\n\n### ConHashMap\n\n#### å¹¶å‘é›†åˆ\n\n##### é›†åˆå¯¹æ¯”\n\nä¸‰ç§é›†åˆï¼š\n\n* HashMap æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ€§èƒ½å¥½\n* Hashtable çº¿ç¨‹å®‰å…¨åŸºäº synchronizedï¼Œç»¼åˆæ€§èƒ½å·®ï¼Œå·²ç»è¢«æ·˜æ±°\n* ConcurrentHashMap ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œç»¼åˆæ€§èƒ½è¾ƒå¥½ï¼Œä¸æ­¢çº¿ç¨‹å®‰å…¨ï¼Œè€Œä¸”æ•ˆç‡é«˜ï¼Œæ€§èƒ½å¥½\n\né›†åˆå¯¹æ¯”ï¼š\n\n1. Hashtable ç»§æ‰¿ Dictionary ç±»ï¼ŒHashMapã€ConcurrentHashMap ç»§æ‰¿ AbstractMapï¼Œå‡å®ç° Map æ¥å£\n2. Hashtable åº•å±‚æ˜¯æ•°ç»„ + é“¾è¡¨ï¼ŒJDK8 ä»¥å HashMap å’Œ ConcurrentHashMap åº•å±‚æ˜¯æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘\n3. HashMap çº¿ç¨‹éå®‰å…¨ï¼ŒHashtable çº¿ç¨‹å®‰å…¨ï¼ŒHashtable çš„æ–¹æ³•éƒ½åŠ äº† synchronized å…³æ¥ç¡®ä¿çº¿ç¨‹åŒæ­¥\n4. ConcurrentHashMapã€Hashtable **ä¸å…è®¸ null å€¼**ï¼ŒHashMap å…è®¸ null å€¼\n5. ConcurrentHashMapã€HashMap çš„åˆå§‹å®¹é‡ä¸º 16ï¼ŒHashtable åˆå§‹å®¹é‡ä¸º11ï¼Œå¡«å……å› å­é»˜è®¤éƒ½æ˜¯ 0.75ï¼Œä¸¤ç§ Map æ‰©å®¹æ˜¯å½“å‰å®¹é‡ç¿»å€ï¼šcapacity * 2ï¼ŒHashtable æ‰©å®¹æ—¶æ˜¯å®¹é‡ç¿»å€ + 1ï¼šcapacity*2 + 1\n\n![image-20230824175111596](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824175111596.png)\n\nå·¥ä½œæ­¥éª¤ï¼š\n\n1. åˆå§‹åŒ–ï¼Œä½¿ç”¨ cas æ¥ä¿è¯å¹¶å‘å®‰å…¨ï¼Œæ‡’æƒ°åˆå§‹åŒ– table\n\n2. æ ‘åŒ–ï¼Œå½“ table.length < 64 æ—¶ï¼Œå…ˆå°è¯•æ‰©å®¹ï¼Œè¶…è¿‡ 64 æ—¶ï¼Œå¹¶ä¸” bin.length > 8 æ—¶ï¼Œä¼šå°†**é“¾è¡¨æ ‘åŒ–**ï¼Œæ ‘åŒ–è¿‡ç¨‹ä¼šç”¨ synchronized é”ä½é“¾è¡¨å¤´\n\n   è¯´æ˜ï¼šé”ä½æŸä¸ªæ§½ä½çš„å¯¹è±¡å¤´ï¼Œæ˜¯ä¸€ç§å¾ˆå¥½çš„**ç»†ç²’åº¦çš„åŠ é”**æ–¹å¼ï¼Œç±»ä¼¼ MySQL ä¸­çš„è¡Œé”\n\n3. putï¼Œå¦‚æœè¯¥ bin å°šæœªåˆ›å»ºï¼Œåªéœ€è¦ä½¿ç”¨ cas åˆ›å»º binï¼›å¦‚æœå·²ç»æœ‰äº†ï¼Œé”ä½é“¾è¡¨å¤´è¿›è¡Œåç»­ put æ“ä½œï¼Œå…ƒç´ æ·»åŠ è‡³ bin çš„å°¾éƒ¨\n\n4. getï¼Œæ— é”æ“ä½œä»…éœ€è¦ä¿è¯å¯è§æ€§ï¼Œæ‰©å®¹è¿‡ç¨‹ä¸­ get æ“ä½œæ‹¿åˆ°çš„æ˜¯ ForwardingNode ä¼šè®© get æ“ä½œåœ¨æ–° table è¿›è¡Œæœç´¢\n\n5. æ‰©å®¹ï¼Œæ‰©å®¹æ—¶ä»¥ bin ä¸ºå•ä½è¿›è¡Œï¼Œéœ€è¦å¯¹ bin è¿›è¡Œ synchronizedï¼Œä½†è¿™æ—¶å…¶å®ƒç«äº‰çº¿ç¨‹ä¹Ÿä¸æ˜¯æ— äº‹å¯åšï¼Œå®ƒä»¬ä¼šå¸®åŠ©æŠŠå…¶å®ƒ bin è¿›è¡Œæ‰©å®¹\n\n6. sizeï¼Œå…ƒç´ ä¸ªæ•°ä¿å­˜åœ¨ baseCount ä¸­ï¼Œå¹¶å‘æ—¶çš„ä¸ªæ•°å˜åŠ¨ä¿å­˜åœ¨ CounterCell[] å½“ä¸­ï¼Œæœ€åç»Ÿè®¡æ•°é‡æ—¶ç´¯åŠ \n\n```java\n//éœ€æ±‚ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶å¾€HashMapå®¹å™¨ä¸­å­˜å…¥æ•°æ®ä¼šå‡ºç°å®‰å…¨é—®é¢˜\npublic class ConcurrentHashMapDemo{\n    public static Map<String,String> map = new ConcurrentHashMap();\n    \n    public static void main(String[] args){\n        new AddMapDataThread().start();\n        new AddMapDataThread().start();\n        \n        Thread.sleep(1000 * 5);//ä¼‘æ¯5ç§’ï¼Œç¡®ä¿ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•\n        System.out.println(\"Mapå¤§å°ï¼š\" + map.size());//20ä¸‡\n    }\n}\n\npublic class AddMapDataThread extends Thread{\n    @Override\n    public void run() {\n        for(int i = 0 ; i < 1000000 ; i++ ){\n            ConcurrentHashMapDemo.map.put(\"é”®ï¼š\"+i , \"å€¼\"+i);\n        }\n    }\n}\n```\n\n\n\n****\n\n\n\n##### å¹¶å‘æ­»é“¾\n\nJDK1.7 çš„ HashMap é‡‡ç”¨çš„å¤´æ’æ³•ï¼ˆæ‹‰é“¾æ³•ï¼‰è¿›è¡ŒèŠ‚ç‚¹çš„æ·»åŠ ï¼ŒHashMap çš„æ‰©å®¹é•¿åº¦ä¸ºåŸæ¥çš„ 2 å€\n\nresize() ä¸­èŠ‚ç‚¹ï¼ˆEntryï¼‰è½¬ç§»çš„æºä»£ç ï¼š\n\n```java\nvoid transfer(Entry[] newTable, boolean rehash) {\n    int newCapacity = newTable.length;//å¾—åˆ°æ–°æ•°ç»„çš„é•¿åº¦   \n    // éå†æ•´ä¸ªæ•°ç»„å¯¹åº”ä¸‹æ ‡ä¸‹çš„é“¾è¡¨ï¼Œeä»£è¡¨ä¸€ä¸ªèŠ‚ç‚¹\n    for (Entry<K,V> e : table) {   \n        // å½“e == nullæ—¶ï¼Œåˆ™è¯¥é“¾è¡¨éå†å®Œäº†ï¼Œç»§ç»­éå†ä¸‹ä¸€æ•°ç»„ä¸‹æ ‡çš„é“¾è¡¨ \n        while(null != e) { \n            // å…ˆæŠŠeèŠ‚ç‚¹çš„ä¸‹ä¸€èŠ‚ç‚¹å­˜èµ·æ¥\n            Entry<K,V> next = e.next; \n            if (rehash) {              //å¾—åˆ°æ–°çš„hashå€¼\n                e.hash = null == e.key ? 0 : hash(e.key);  \n            }\n            // åœ¨æ–°æ•°ç»„ä¸‹å¾—åˆ°æ–°çš„æ•°ç»„ä¸‹æ ‡\n            int i = indexFor(e.hash, newCapacity);  \n             // å°†eçš„nextæŒ‡é’ˆæŒ‡å‘æ–°æ•°ç»„ä¸‹æ ‡çš„ä½ç½®\n            e.next = newTable[i];   \n            // å°†è¯¥æ•°ç»„ä¸‹æ ‡çš„èŠ‚ç‚¹å˜ä¸ºeèŠ‚ç‚¹\n            newTable[i] = e; \n            // éå†é“¾è¡¨çš„ä¸‹ä¸€èŠ‚ç‚¹\n            e = next;                                   \n        }\n    }\n}\n```\n\nJDK 8 è™½ç„¶å°†æ‰©å®¹ç®—æ³•åšäº†è°ƒæ•´ï¼Œæ”¹ç”¨äº†å°¾æ’æ³•ï¼Œä½†ä»ä¸æ„å‘³ç€èƒ½å¤Ÿåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹èƒ½å¤Ÿå®‰å…¨æ‰©å®¹ï¼Œè¿˜ä¼šå‡ºç°å…¶å®ƒé—®é¢˜ï¼ˆå¦‚æ‰©å®¹ä¸¢æ•°æ®ï¼‰\n\n\n\nBç«™è§†é¢‘è§£æï¼šhttps://www.bilibili.com/video/BV1n541177Ea\n\n\n\n***\n\n\n\n#### æˆå‘˜å±æ€§\n\n##### å˜é‡\n\n* å­˜å‚¨æ•°ç»„ï¼š\n\n  ```java\n  transient volatile Node<K,V>[] table;\n  ```\n\n* æ•£åˆ—è¡¨çš„é•¿åº¦ï¼š\n\n  ```java\n  private static final int MAXIMUM_CAPACITY = 1 << 30;\t// æœ€å¤§é•¿åº¦\n  private static final int DEFAULT_CAPACITY = 16;\t\t\t// é»˜è®¤é•¿åº¦\n  ```\n\n* å¹¶å‘çº§åˆ«ï¼ŒJDK7 é—ç•™ä¸‹æ¥ï¼Œ1.8 ä¸­ä¸ä»£è¡¨å¹¶å‘çº§åˆ«ï¼š\n\n  ```java\n  private static final int DEFAULT_CONCURRENCY_LEVEL = 16;\n  ```\n\n* è´Ÿè½½å› å­ï¼ŒJDK1.8 çš„ ConcurrentHashMap ä¸­æ˜¯å›ºå®šå€¼ï¼š\n\n  ```java\n  private static final float LOAD_FACTOR = 0.75f;\n  ```\n\n* é˜ˆå€¼ï¼š\n\n  ```java\n  static final int TREEIFY_THRESHOLD = 8;\t\t// é“¾è¡¨æ ‘åŒ–çš„é˜ˆå€¼\n  static final int UNTREEIFY_THRESHOLD = 6;\t// çº¢é»‘æ ‘è½¬åŒ–ä¸ºé“¾è¡¨çš„é˜ˆå€¼\n  static final int MIN_TREEIFY_CAPACITY = 64;\t// å½“æ•°ç»„é•¿åº¦è¾¾åˆ°64ä¸”æŸä¸ªæ¡¶ä½ä¸­çš„é“¾è¡¨é•¿åº¦è¶…è¿‡8ï¼Œæ‰ä¼šçœŸæ­£æ ‘åŒ–\n  ```\n\n* æ‰©å®¹ç›¸å…³ï¼š\n\n  ```java\n  private static final int MIN_TRANSFER_STRIDE = 16;\t// çº¿ç¨‹è¿ç§»æ•°æ®ã€æœ€å°æ­¥é•¿ã€‘ï¼Œæ§åˆ¶çº¿ç¨‹è¿ç§»ä»»åŠ¡çš„æœ€å°åŒºé—´\n  private static int RESIZE_STAMP_BITS = 16;\t\t\t// ç”¨æ¥è®¡ç®—æ‰©å®¹æ—¶ç”Ÿæˆçš„ã€æ ‡è¯†æˆ³ã€‘\n  private static final int MAX_RESIZERS = (1 << (32 - RESIZE_STAMP_BITS)) - 1;// 65535-1å¹¶å‘æ‰©å®¹æœ€å¤šçº¿ç¨‹æ•°\n  private static final int RESIZE_STAMP_SHIFT = 32 - RESIZE_STAMP_BITS;\t\t// æ‰©å®¹æ—¶ä½¿ç”¨\n  ```\n\n* èŠ‚ç‚¹å“ˆå¸Œå€¼ï¼š\n\n  ```java\n  static final int MOVED     = -1; \t\t\t// è¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ˜¯ FWD èŠ‚ç‚¹\n  static final int TREEBIN   = -2; \t\t\t// è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»æ ‘åŒ–ï¼Œä¸”å½“å‰èŠ‚ç‚¹ä¸º TreeBin å¯¹è±¡\n  static final int RESERVED  = -3; \t\t\t// è¡¨ç¤ºèŠ‚ç‚¹æ—¶ä¸´æ—¶èŠ‚ç‚¹\n  static final int HASH_BITS = 0x7fffffff; \t// æ­£å¸¸èŠ‚ç‚¹çš„å“ˆå¸Œå€¼çš„å¯ç”¨çš„ä½æ•°\n  ```\n\n* æ‰©å®¹è¿‡ç¨‹ï¼švolatile ä¿®é¥°ä¿è¯å¤šçº¿ç¨‹çš„å¯è§æ€§\n\n  ```java\n  // æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œä¼šå°†æ‰©å®¹ä¸­çš„æ–° table èµ‹å€¼ç»™ nextTable ä¿æŒå¼•ç”¨ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œè¿™é‡Œä¼šè¢«è®¾ç½®ä¸º null\n  private transient volatile Node<K,V>[] nextTable;\n  // è®°å½•æ‰©å®¹è¿›åº¦ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½è¦ä» 0 - transferIndex ä¸­åˆ†é…åŒºé—´ä»»åŠ¡ï¼Œç®€å•è¯´å°±æ˜¯è€è¡¨è½¬ç§»åˆ°å“ªäº†ï¼Œç´¢å¼•ä»é«˜åˆ°ä½è½¬ç§»\n  private transient volatile int transferIndex;\n  ```\n\n* ç´¯åŠ ç»Ÿè®¡ï¼š\n\n  ```java\n  // LongAdder ä¸­çš„ baseCount æœªå‘ç”Ÿç«äº‰æ—¶æˆ–è€…å½“å‰LongAdderå¤„äºåŠ é”çŠ¶æ€æ—¶ï¼Œå¢é‡ç´¯åˆ°åˆ° baseCount ä¸­\n  private transient volatile long baseCount;\n  // LongAdder ä¸­çš„ cellsBuzyï¼Œ0 è¡¨ç¤ºå½“å‰ LongAdder å¯¹è±¡æ— é”çŠ¶æ€ï¼Œ1 è¡¨ç¤ºå½“å‰ LongAdder å¯¹è±¡åŠ é”çŠ¶æ€\n  private transient volatile int cellsBusy;\n  // LongAdder ä¸­çš„ cells æ•°ç»„ï¼Œ\n  private transient volatile CounterCell[] counterCells;\n  ```\n\n* æ§åˆ¶å˜é‡ï¼š\n\n  **sizeCtl** < 0ï¼š\n\n  * -1 è¡¨ç¤ºå½“å‰ table æ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»º table æ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾…\n\n  * å…¶ä»–è´Ÿæ•°è¡¨ç¤ºå½“å‰ map çš„ table æ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œé«˜ 16 ä½è¡¨ç¤ºæ‰©å®¹çš„æ ‡è¯†æˆ³ï¼›ä½ 16 ä½è¡¨ç¤º (1 + nThread) å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ + 1\n\n  sizeCtl = 0ï¼Œè¡¨ç¤ºåˆ›å»º table æ•°ç»„æ—¶ä½¿ç”¨ DEFAULT_CAPACITY ä¸ºæ•°ç»„å¤§å°\n\n  sizeCtl > 0ï¼š\n\n  * å¦‚æœ table æœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å°\n  * å¦‚æœ table å·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼Œå…ƒç´ ä¸ªæ•°ï¼Œä¸æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰\n\n  ```java\n  private transient volatile int sizeCtl;\t\t// volatile ä¿æŒå¯è§æ€§\n  ```\n\n\n\n***\n\n\n\n##### å†…éƒ¨ç±»\n\n* Node èŠ‚ç‚¹ï¼š\n\n  ```java\n  static class Node<K,V> implements Entry<K,V> {\n      // èŠ‚ç‚¹å“ˆå¸Œå€¼\n      final int hash;\n      final K key;\n      volatile V val;\n      // å•å‘é“¾è¡¨\n      volatile Node<K,V> next;\n  }\n  ```\n\n* TreeBin èŠ‚ç‚¹ï¼š\n\n  ```java\n   static final class TreeBin<K,V> extends Node<K,V> {\n       // çº¢é»‘æ ‘æ ¹èŠ‚ç‚¹\n       TreeNode<K,V> root;\n       // é“¾è¡¨çš„å¤´èŠ‚ç‚¹\n       volatile TreeNode<K,V> first;\n       // ç­‰å¾…è€…çº¿ç¨‹\n       volatile Thread waiter;\n  \n       volatile int lockState;\n       // å†™é”çŠ¶æ€ å†™é”æ˜¯ç‹¬å çŠ¶æ€ï¼Œä»¥æ•£åˆ—è¡¨æ¥çœ‹ï¼ŒçœŸæ­£è¿›å…¥åˆ° TreeBin ä¸­çš„å†™çº¿ç¨‹åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹\n       static final int WRITER = 1;\n       // ç­‰å¾…è€…çŠ¶æ€ï¼ˆå†™çº¿ç¨‹åœ¨ç­‰å¾…ï¼‰ï¼Œå½“ TreeBin ä¸­æœ‰è¯»çº¿ç¨‹ç›®å‰æ­£åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå†™çº¿ç¨‹æ— æ³•ä¿®æ”¹æ•°æ®\n       static final int WAITER = 2;\n       // è¯»é”çŠ¶æ€æ˜¯å…±äº«ï¼ŒåŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¿›å…¥åˆ° TreeBi å¯¹è±¡ä¸­è·å–æ•°æ®ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ç»™ lockState + 4\n       static final int READER = 4;\n   }\n  ```\n\n* TreeNode èŠ‚ç‚¹ï¼š\n\n  ```java\n  static final class TreeNode<K,V> extends Node<K,V> {\n      TreeNode<K,V> parent;  // red-black tree links\n      TreeNode<K,V> left;\n      TreeNode<K,V> right;\n      TreeNode<K,V> prev;   //åŒå‘é“¾è¡¨\n      boolean red;\n  }\n  ```\n\n* ForwardingNode èŠ‚ç‚¹ï¼šè½¬ç§»èŠ‚ç‚¹\n\n  ```java\n   static final class ForwardingNode<K,V> extends Node<K,V> {\n       // æŒæœ‰æ‰©å®¹åæ–°çš„å“ˆå¸Œè¡¨çš„å¼•ç”¨\n       final Node<K,V>[] nextTable;\n       ForwardingNode(Node<K,V>[] tab) {\n           // ForwardingNode èŠ‚ç‚¹çš„ hash å€¼è®¾ä¸º -1\n           super(MOVED, null, null, null);\n           this.nextTable = tab;\n       }\n   }\n  ```\n\n\n\n***\n\n\n\n##### ä»£ç å—\n\n* å˜é‡ï¼š\n\n  ```java\n  // è¡¨ç¤ºsizeCtlå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€\n  private static final long SIZECTL;\n  // è¡¨ç¤ºtransferIndexå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€\n  private static final long TRANSFERINDEX;\n  // è¡¨ç¤ºbaseCountå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€\n  private static final long BASECOUNT;\n  // è¡¨ç¤ºcellsBusyå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€\n  private static final long CELLSBUSY;\n  // è¡¨ç¤ºcellValueå±æ€§åœ¨ CounterCell ä¸­å†…å­˜åç§»åœ°å€\n  private static final long CELLVALUE;\n  // è¡¨ç¤ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€\n  private static final long ABASE;\n  // ç”¨ä½ç§»è¿ç®—æ›¿ä»£ä¹˜æ³•\n  private static final int ASHIFT;\n  ```\n\n* èµ‹å€¼æ–¹æ³•ï¼š\n\n  ```java\n  // è¡¨ç¤ºæ•°ç»„å•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°ï¼Œscale è¡¨ç¤º Node[] æ•°ç»„ä¸­æ¯ä¸€ä¸ªå•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°ï¼Œint æ˜¯ 4 å­—èŠ‚\n  int scale = U.arrayIndexScale(ak);\n  // åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯ä¸æ˜¯ 2 çš„ n æ¬¡å¹‚ï¼Œæ¯”å¦‚ 8ï¼š1000 & 0111 = 0000\n  if ((scale & (scale - 1)) != 0)\n      throw new Error(\"data type scale not a power of two\");\n  \n  // numberOfLeadingZeros(n)ï¼šè¿”å›å½“å‰æ•°å€¼è½¬æ¢ä¸ºäºŒè¿›åˆ¶åï¼Œä»é«˜ä½åˆ°ä½ä½å¼€å§‹ç»Ÿè®¡ï¼Œçœ‹æœ‰å¤šå°‘ä¸ª0è¿ç»­åœ¨ä¸€èµ·\n  // 8 â†’ 1000 numberOfLeadingZeros(8) = 28\n  // 4 â†’ 100 numberOfLeadingZeros(4) = 29   int å€¼å°±æ˜¯å 4ä¸ªå­—èŠ‚\n  ASHIFT = 31 - Integer.numberOfLeadingZeros(scale);\n  \n  // ASHIFT = 31 - 29 = 2 ï¼Œint çš„å¤§å°å°±æ˜¯ 2 çš„ 2 æ¬¡æ–¹ï¼Œè·å–æ¬¡æ–¹æ•°\n  // ABASE + ï¼ˆ5 << ASHIFTï¼‰ ç”¨ä½ç§»è¿ç®—æ›¿ä»£äº†ä¹˜æ³•ï¼Œè·å– arr[5] çš„å€¼\n  ```\n\n\n\n\n\n***\n\n\n\n#### æ„é€ æ–¹æ³•\n\n* æ— å‚æ„é€ ï¼Œ æ•£åˆ—è¡¨ç»“æ„å»¶è¿Ÿåˆå§‹åŒ–ï¼Œé»˜è®¤çš„æ•°ç»„å¤§å°æ˜¯ 16ï¼š\n\n  ```java\n  public ConcurrentHashMap() {\n  }\n  ```\n\n* æœ‰å‚æ„é€ ï¼š\n\n  ```java\n  public ConcurrentHashMap(int initialCapacity) {\n      // æŒ‡å®šå®¹é‡åˆå§‹åŒ–\n      if (initialCapacity < 0) throw new IllegalArgumentException();\n      int cap = ((initialCapacity >= (MAXIMUM_CAPACITY >>> 1)) ?\n                 MAXIMUM_CAPACITY :\n                 // å‡å¦‚ä¼ å…¥çš„å‚æ•°æ˜¯ 16ï¼Œ16 + 8 + 1 ï¼Œæœ€åå¾—åˆ° 32\n                 // ä¼ å…¥ 12ï¼Œ 12 + 6 + 1 = 19ï¼Œæœ€åå¾—åˆ° 32ï¼Œå°½å¯èƒ½çš„å¤§ï¼Œä¸ HashMapä¸ä¸€æ ·\n                 tableSizeFor(initialCapacity + (initialCapacity >>> 1) + 1));\n      // sizeCtl > 0ï¼Œå½“ç›®å‰ table æœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtl è¡¨ç¤ºåˆå§‹åŒ–å®¹é‡\n      this.sizeCtl = cap;\n  }\n  ```\n\n  ```java\n  private static final int tableSizeFor(int c) {\n      int n = c - 1;\n      n |= n >>> 1;\n      n |= n >>> 2;\n      n |= n >>> 4;\n      n |= n >>> 8;\n      n |= n >>> 16;\n      return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;\n  }\n  ```\n\n  HashMap éƒ¨åˆ†è¯¦è§£äº†è¯¥å‡½æ•°ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯**æŠŠæœ€é«˜ä½æ˜¯ 1 çš„ä½ä»¥åŠå³è¾¹çš„ä½å…¨éƒ¨ç½® 1**ï¼Œç»“æœåŠ  1 åå°±æ˜¯ 2 çš„ n æ¬¡å¹‚\n\n* å¤šä¸ªå‚æ•°æ„é€ æ–¹æ³•ï¼š\n\n  ```java\n  public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) {\n      if (!(loadFactor > 0.0f) || initialCapacity < 0 || concurrencyLevel <= 0)\n          throw new IllegalArgumentException();\n      // åˆå§‹å®¹é‡å°äºå¹¶å‘çº§åˆ«\n      if (initialCapacity < concurrencyLevel)  \n          // æŠŠå¹¶å‘çº§åˆ«èµ‹å€¼ç»™åˆå§‹å®¹é‡\n          initialCapacity = concurrencyLevel; \n  \t// loadFactor é»˜è®¤æ˜¯ 0.75\n      long size = (long)(1.0 + (long)initialCapacity / loadFactor);\n      int cap = (size >= (long)MAXIMUM_CAPACITY) ?\n          MAXIMUM_CAPACITY : tableSizeFor((int)size);\n      // sizeCtl > 0ï¼Œå½“ç›®å‰ table æœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtl è¡¨ç¤ºåˆå§‹åŒ–å®¹é‡\n      this.sizeCtl = cap;\n  }\n  ```\n  \n* é›†åˆæ„é€ æ–¹æ³•ï¼š\n\n  ```java\n  public ConcurrentHashMap(Map<? extends K, ? extends V> m) {\n      this.sizeCtl = DEFAULT_CAPACITY;\t// é»˜è®¤16\n      putAll(m);\n  }\n  public void putAll(Map<? extends K, ? extends V> m) {\n      // å°è¯•è§¦å‘æ‰©å®¹\n      tryPresize(m.size());\n      for (Entry<? extends K, ? extends V> e : m.entrySet())\n          putVal(e.getKey(), e.getValue(), false);\n  }\n  ```\n\n  ```java\n  private final void tryPresize(int size) {\n      // æ‰©å®¹ä¸ºå¤§äº 2 å€çš„æœ€å°çš„ 2 çš„ n æ¬¡å¹‚\n      int c = (size >= (MAXIMUM_CAPACITY >>> 1)) ? MAXIMUM_CAPACITY :\n      \ttableSizeFor(size + (size >>> 1) + 1);\n      int sc;\n      while ((sc = sizeCtl) >= 0) {\n          Node<K,V>[] tab = table; int n;\n          // æ•°ç»„è¿˜æœªåˆå§‹åŒ–ï¼Œã€ä¸€èˆ¬æ˜¯è°ƒç”¨é›†åˆæ„é€ æ–¹æ³•æ‰ä¼šæˆç«‹ï¼Œput åè°ƒç”¨è¯¥æ–¹æ³•éƒ½æ˜¯ä¸æˆç«‹çš„ã€‘\n          if (tab == null || (n = tab.length) == 0) {\n              n = (sc > c) ? sc : c;\n              if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) {\n                  try {\n                      if (table == tab) {\n                          Node<K,V>[] nt = (Node<K,V>[])new Node<?,?>[n];\n                          table = nt;\n                          sc = n - (n >>> 2);// æ‰©å®¹é˜ˆå€¼ï¼šn - 1/4 n\n                      }\n                  } finally {\n                      sizeCtl = sc;\t// æ‰©å®¹é˜ˆå€¼èµ‹å€¼ç»™sizeCtl\n                  }\n              }\n          }\n          // æœªè¾¾åˆ°æ‰©å®¹é˜ˆå€¼æˆ–è€…æ•°ç»„é•¿åº¦å·²ç»å¤§äºæœ€å¤§é•¿åº¦\n          else if (c <= sc || n >= MAXIMUM_CAPACITY)\n              break;\n          // ä¸ addCount é€»è¾‘ç›¸åŒ\n          else if (tab == table) {\n             \n          }\n      }\n  }\n  ```\n  \n  \n\n\n\n***\n\n\n\n#### æˆå‘˜æ–¹æ³•\n\n##### æ•°æ®è®¿å­˜\n\n* tabAt()ï¼šè·å–æ•°ç»„æŸä¸ªæ§½ä½çš„**å¤´èŠ‚ç‚¹**ï¼Œç±»ä¼¼äºæ•°ç»„ä¸­çš„ç›´æ¥å¯»å€ arr[i]\n\n  ```java\n  // i æ˜¯æ•°ç»„ç´¢å¼•\n  static final <K,V> Node<K,V> tabAt(Node<K,V>[] tab, int i) {\n      // (i << ASHIFT) + ABASE == ABASE + i * 4 ï¼ˆä¸€ä¸ª int å  4 ä¸ªå­—èŠ‚ï¼‰ï¼Œè¿™å°±ç›¸å½“äºå¯»å€ï¼Œæ›¿ä»£äº†ä¹˜æ³•\n      return (Node<K,V>)U.getObjectVolatile(tab, ((long)i << ASHIFT) + ABASE);\n  }\n  ```\n\n* casTabAt()ï¼šæŒ‡å®šæ•°ç»„ç´¢å¼•ä½ç½®ä¿®æ”¹åŸå€¼ä¸ºæŒ‡å®šçš„å€¼\n\n  ```java\n  static final <K,V> boolean casTabAt(Node<K,V>[] tab, int i, Node<K,V> c, Node<K,V> v) {\n      return U.compareAndSwapObject(tab, ((long)i << ASHIFT) + ABASE, c, v);\n  }\n  ```\n\n* setTabAt()ï¼šæŒ‡å®šæ•°ç»„ç´¢å¼•ä½ç½®è®¾ç½®å€¼\n\n  ```java\n  static final <K,V> void setTabAt(Node<K,V>[] tab, int i, Node<K,V> v) {\n      U.putObjectVolatile(tab, ((long)i << ASHIFT) + ABASE, v);\n  }\n  ```\n\n  \n\n\n\n***\n\n\n\n##### æ·»åŠ æ–¹æ³•\n\n```java\npublic V put(K key, V value) {\n    // ç¬¬ä¸‰ä¸ªå‚æ•° onlyIfAbsent ä¸º false è¡¨ç¤ºå“ˆå¸Œè¡¨ä¸­å­˜åœ¨ç›¸åŒçš„ key æ—¶ã€ç”¨å½“å‰æ•°æ®è¦†ç›–æ—§æ•°æ®ã€‘\n    return putVal(key, value, false);\n}\n```\n\n* putVal()\n\n  ```java\n  final V putVal(K key, V value, boolean onlyIfAbsent) {\n      // ã€ConcurrentHashMap ä¸èƒ½å­˜æ”¾ null å€¼ã€‘\n      if (key == null || value == null) throw new NullPointerException();\n      // æ‰°åŠ¨è¿ç®—ï¼Œé«˜ä½ä½éƒ½å‚ä¸å¯»å€è¿ç®—\n      int hash = spread(key.hashCode());\n      // è¡¨ç¤ºå½“å‰ k-v å°è£…æˆ node åæ’å…¥åˆ°æŒ‡å®šæ¡¶ä½åï¼Œåœ¨æ¡¶ä½ä¸­çš„æ‰€å±é“¾è¡¨çš„ä¸‹æ ‡ä½ç½®\n      int binCount = 0;\n      // tab å¼•ç”¨å½“å‰ map çš„æ•°ç»„ tableï¼Œå¼€å§‹è‡ªæ—‹\n      for (Node<K,V>[] tab = table;;) {\n          // f è¡¨ç¤ºæ¡¶ä½çš„å¤´èŠ‚ç‚¹ï¼Œn è¡¨ç¤ºå“ˆå¸Œè¡¨æ•°ç»„çš„é•¿åº¦\n          // i è¡¨ç¤º key é€šè¿‡å¯»å€è®¡ç®—åå¾—åˆ°çš„æ¡¶ä½ä¸‹æ ‡ï¼Œfh è¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹çš„ hash å€¼\n          Node<K,V> f; int n, i, fh;\n          \n          // ã€CASE1ã€‘ï¼šè¡¨ç¤ºå½“å‰ map ä¸­çš„ table å°šæœªåˆå§‹åŒ–\n          if (tab == null || (n = tab.length) == 0)\n              //ã€å»¶è¿Ÿåˆå§‹åŒ–ã€‘\n              tab = initTable();\n          \n          // ã€CASE2ã€‘ï¼ši è¡¨ç¤º key ä½¿ç”¨ã€å¯»å€ç®—æ³•ã€‘å¾—åˆ° key å¯¹åº”æ•°ç»„çš„ä¸‹æ ‡ä½ç½®ï¼ŒtabAt è·å–æŒ‡å®šæ¡¶ä½çš„å¤´ç»“ç‚¹f\n          else if ((f = tabAt(tab, i = (n - 1) & hash)) == null) {\n              // å¯¹åº”çš„æ•°ç»„ä¸º null è¯´æ˜æ²¡æœ‰å“ˆå¸Œå†²çªï¼Œç›´æ¥æ–°å»ºèŠ‚ç‚¹æ·»åŠ åˆ°è¡¨ä¸­\n              if (casTabAt(tab, i, null, new Node<K,V>(hash, key, value, null)))\n                  break;\n          }\n          // ã€CASE3ã€‘ï¼šé€»è¾‘è¯´æ˜æ•°ç»„å·²ç»è¢«åˆå§‹åŒ–ï¼Œå¹¶ä¸”å½“å‰ key å¯¹åº”çš„ä½ç½®ä¸ä¸º null\n          // æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ä¸º FWD ç»“ç‚¹ï¼Œè¡¨ç¤ºç›®å‰ map æ­£å¤„äºæ‰©å®¹è¿‡ç¨‹ä¸­\n          else if ((fh = f.hash) == MOVED)\n              // å½“å‰çº¿ç¨‹ã€éœ€è¦å»å¸®åŠ©å“ˆå¸Œè¡¨å®Œæˆæ‰©å®¹ã€‘\n              tab = helpTransfer(tab, f);\n          \n          // ã€CASE4ã€‘ï¼šå“ˆå¸Œè¡¨æ²¡æœ‰åœ¨æ‰©å®¹ï¼Œå½“å‰æ¡¶ä½å¯èƒ½æ˜¯é“¾è¡¨ä¹Ÿå¯èƒ½æ˜¯çº¢é»‘æ ‘\n          else {\n              // å½“æ’å…¥ key å­˜åœ¨æ—¶ï¼Œä¼šå°†æ—§å€¼èµ‹å€¼ç»™ oldVal è¿”å›\n              V oldVal = null;\n              // ã€é”ä½å½“å‰ key å¯»å€çš„æ¡¶ä½çš„å¤´èŠ‚ç‚¹ã€‘\n              synchronized (f) {\n                  // è¿™é‡Œé‡æ–°è·å–ä¸€ä¸‹æ¡¶çš„å¤´èŠ‚ç‚¹æœ‰æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œå› ä¸ºå¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œè¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„è·å–\n                  if (tabAt(tab, i) == f) {\n                      // ã€å¤´èŠ‚ç‚¹çš„å“ˆå¸Œå€¼å¤§äº 0 è¯´æ˜å½“å‰æ¡¶ä½æ˜¯æ™®é€šçš„é“¾è¡¨èŠ‚ç‚¹ã€‘\n                      if (fh >= 0) {\n                          // å½“å‰çš„æ’å…¥æ“ä½œæ²¡å‡ºç°é‡å¤çš„ keyï¼Œè¿½åŠ åˆ°é“¾è¡¨çš„æœ«å°¾ï¼ŒbinCountè¡¨ç¤ºé“¾è¡¨é•¿åº¦ -1\n                          // æ’å…¥çš„keyä¸é“¾è¡¨ä¸­çš„æŸä¸ªå…ƒç´ çš„ key ä¸€è‡´ï¼Œå˜æˆæ›¿æ¢æ“ä½œï¼ŒbinCount è¡¨ç¤ºç¬¬å‡ ä¸ªèŠ‚ç‚¹å†²çª\n                          binCount = 1;\n                          // è¿­ä»£å¾ªç¯å½“å‰æ¡¶ä½çš„é“¾è¡¨ï¼Œe æ˜¯æ¯æ¬¡å¾ªç¯å¤„ç†èŠ‚ç‚¹ï¼Œe åˆå§‹æ˜¯å¤´èŠ‚ç‚¹\n                          for (Node<K,V> e = f;; ++binCount) {\n                              // å½“å‰å¾ªç¯èŠ‚ç‚¹ key\n                              K ek;\n                              // key çš„å“ˆå¸Œå€¼ä¸å½“å‰èŠ‚ç‚¹çš„å“ˆå¸Œä¸€è‡´ï¼Œå¹¶ä¸” key çš„å€¼ä¹Ÿç›¸åŒ\n                              if (e.hash == hash &&\n                                  ((ek = e.key) == key ||\n                                   (ek != null && key.equals(ek)))) {\n                                  // æŠŠå½“å‰èŠ‚ç‚¹çš„ value èµ‹å€¼ç»™ oldVal\n                                  oldVal = e.val;\n                                  // å…è®¸è¦†ç›–\n                                  if (!onlyIfAbsent)\n                                      // æ–°æ•°æ®è¦†ç›–æ—§æ•°æ®\n                                      e.val = value;\n                                  // è·³å‡ºå¾ªç¯\n                                  break;\n                              }\n                              Node<K,V> pred = e;\n                              // å¦‚æœä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºï¼ŒæŠŠæ•°æ®å°è£…æˆèŠ‚ç‚¹æ’å…¥é“¾è¡¨å°¾éƒ¨ï¼Œã€binCount ä»£è¡¨é•¿åº¦ - 1ã€‘\n                              if ((e = e.next) == null) {\n                                  pred.next = new Node<K,V>(hash, key,\n                                                            value, null);\n                                  break;\n                              }\n                          }\n                      }\n                      // å½“å‰æ¡¶ä½å¤´èŠ‚ç‚¹æ˜¯çº¢é»‘æ ‘\n                      else if (f instanceof TreeBin) {\n                          Node<K,V> p;\n                          binCount = 2;\n                          if ((p = ((TreeBin<K,V>)f).putTreeVal(hash, key,\n                                                                value)) != null) {\n                              oldVal = p.val;\n                              if (!onlyIfAbsent)\n                                  p.val = value;\n                          }\n                      }\n                  }\n              }\n              \n              // æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰æ˜¯é“¾è¡¨æˆ–è€…çº¢é»‘æ ‘\n              if (binCount != 0) {\n                  // å¦‚æœ binCount >= 8 è¡¨ç¤ºå¤„ç†çš„æ¡¶ä½ä¸€å®šæ˜¯é“¾è¡¨ï¼Œè¯´æ˜é•¿åº¦æ˜¯ 9\n                  if (binCount >= TREEIFY_THRESHOLD)\n                      // æ ‘åŒ–\n                      treeifyBin(tab, i);\n                  if (oldVal != null)\n                      return oldVal;\n                  break;\n              }\n          }\n      }\n      // ç»Ÿè®¡å½“å‰ table ä¸€å…±æœ‰å¤šå°‘æ•°æ®ï¼Œåˆ¤æ–­æ˜¯å¦è¾¾åˆ°æ‰©å®¹é˜ˆå€¼æ ‡å‡†ï¼Œè§¦å‘æ‰©å®¹\n      // binCount = 0 è¡¨ç¤ºå½“å‰æ¡¶ä½ä¸º nullï¼Œnode å¯ä»¥ç›´æ¥æ”¾å…¥ï¼Œ2 è¡¨ç¤ºå½“å‰æ¡¶ä½å·²ç»æ˜¯çº¢é»‘æ ‘\n      addCount(1L, binCount);\n      return null;\n  }\n  ```\n  \n* spread()ï¼šæ‰°åŠ¨å‡½æ•°\n\n  å°† hashCode æ— ç¬¦å·å³ç§» 16 ä½ï¼Œé«˜ 16bit å’Œä½ 16bit åšå¼‚æˆ–ï¼Œæœ€åä¸ HASH_BITS ç›¸ä¸å˜æˆæ­£æ•°ï¼Œ**ä¸æ ‘åŒ–èŠ‚ç‚¹å’Œè½¬ç§»èŠ‚ç‚¹åŒºåˆ†**ï¼ŒæŠŠé«˜ä½ä½éƒ½åˆ©ç”¨èµ·æ¥å‡å°‘å“ˆå¸Œå†²çªï¼Œä¿è¯æ•£åˆ—çš„å‡åŒ€æ€§\n\n  ```java\n  static final int spread(int h) {\n      return (h ^ (h >>> 16)) & HASH_BITS; // 0111 1111 1111 1111 1111 1111 1111 1111\n  }\n  ```\n\n* initTable()ï¼šåˆå§‹åŒ–æ•°ç»„ï¼Œå»¶è¿Ÿåˆå§‹åŒ–\n\n  ```java\n  private final Node<K,V>[] initTable() {\n      // tab å¼•ç”¨ map.tableï¼Œsc å¼•ç”¨ sizeCtl\n      Node<K,V>[] tab; int sc;\n      // table å°šæœªåˆå§‹åŒ–ï¼Œå¼€å§‹è‡ªæ—‹\n      while ((tab = table) == null || tab.length == 0) {\n          // sc < 0 è¯´æ˜ table æ­£åœ¨åˆå§‹åŒ–æˆ–è€…æ­£åœ¨æ‰©å®¹ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥é‡Šæ”¾ CPU èµ„æº\n          if ((sc = sizeCtl) < 0)\n              Thread.yield();\n          // sizeCtl è®¾ç½®ä¸º -1ï¼Œç›¸å½“äºåŠ é”ï¼Œã€è®¾ç½®çš„æ˜¯ SIZECTL ä½ç½®çš„æ•°æ®ã€‘ï¼Œ\n          // å› ä¸ºæ˜¯ sizeCtl æ˜¯åŸºæœ¬ç±»å‹ï¼Œä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥ sc ä¿å­˜çš„æ˜¯æ•°æ®çš„å‰¯æœ¬\n          else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) {\n              try {\n                  // çº¿ç¨‹å®‰å…¨çš„é€»è¾‘ï¼Œå†è¿›è¡Œä¸€æ¬¡åˆ¤æ–­\n                  if ((tab = table) == null || tab.length == 0) {\n                      // sc > 0 åˆ›å»º table æ—¶ä½¿ç”¨ sc ä¸ºæŒ‡å®šå¤§å°ï¼Œå¦åˆ™ä½¿ç”¨ 16 é»˜è®¤å€¼\n                      int n = (sc > 0) ? sc : DEFAULT_CAPACITY;\n                      // åˆ›å»ºå“ˆå¸Œè¡¨æ•°ç»„\n                      Node<K,V>[] nt = (Node<K,V>[])new Node<?,?>[n];\n                      table = tab = nt;\n                      // æ‰©å®¹é˜ˆå€¼ï¼Œn >>> 2  => ç­‰äº 1/4 n ï¼Œn - (1/4)n = 3/4 n => 0.75 * n\n                      sc = n - (n >>> 2);\n                  }\n              } finally {\n                  // è§£é”ï¼ŒæŠŠä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼èµ‹å€¼ç»™ sizeCtl\n                  sizeCtl = sc;\n              }\n              break;\n          }\n      }\n      return tab;\n  }\n  ```\n\n* treeifyBin()ï¼šæ ‘åŒ–æ–¹æ³•\n\n  ```java\n  private final void treeifyBin(Node<K,V>[] tab, int index) {\n      Node<K,V> b; int n, sc;\n      if (tab != null) {\n          // æ¡ä»¶æˆç«‹ï¼šã€è¯´æ˜å½“å‰ table æ•°ç»„é•¿åº¦æœªè¾¾åˆ° 64ï¼Œæ­¤æ—¶ä¸è¿›è¡Œæ ‘åŒ–æ“ä½œï¼Œè¿›è¡Œæ‰©å®¹æ“ä½œã€‘\n          if ((n = tab.length) < MIN_TREEIFY_CAPACITY)\n              // å½“å‰å®¹é‡çš„ 2 å€\n              tryPresize(n << 1);\n  \n          // æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œä¸”æ˜¯æ™®é€š node æ•°æ®ã€‚\n          else if ((b = tabAt(tab, index)) != null && b.hash >= 0) {\n              // ã€æ ‘åŒ–åŠ é”ã€‘\n              synchronized (b) {\n                  // æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºåŠ é”æ²¡é—®é¢˜ã€‚\n                  if (tabAt(tab, index) == b) {\n                      TreeNode<K,V> hd = null, tl = null;\n                      for (Node<K,V> e = b; e != null; e = e.next) {\n                          TreeNode<K,V> p = new TreeNode<K,V>(e.hash, e.key, e.val,null, null);\n                          if ((p.prev = tl) == null)\n                              hd = p;\n                          else\n                              tl.next = p;\n                          tl = p;\n                      }\n                      setTabAt(tab, index, new TreeBin<K,V>(hd));\n                  }\n              }\n          }\n      }\n  }\n  ```\n  \n* addCount()ï¼šæ·»åŠ è®¡æ•°ï¼Œ**ä»£è¡¨å“ˆå¸Œè¡¨ä¸­çš„æ•°æ®æ€»é‡**\n\n  ```java\n  private final void addCount(long x, int check) {\n      // ã€ä¸Šé¢è¿™éƒ¨åˆ†çš„é€»è¾‘å°±æ˜¯ LongAdder çš„ç´¯åŠ é€»è¾‘ã€‘\n      CounterCell[] as; long b, s;\n      // åˆ¤æ–­ç´¯åŠ æ•°ç»„ cells æ˜¯å¦åˆå§‹åŒ–ï¼Œæ²¡æœ‰å°±å»ç´¯åŠ  base åŸŸï¼Œç´¯åŠ å¤±è´¥è¿›å…¥æ¡ä»¶å†…é€»è¾‘\n      if ((as = counterCells) != null ||\n          !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) {\n          CounterCell a; long v; int m;\n          // true æœªç«äº‰ï¼Œfalse å‘ç”Ÿç«äº‰\n          boolean uncontended = true;\n          // åˆ¤æ–­ cells æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹åˆå§‹åŒ–\n          if (as == null || (m = as.length - 1) < 0 ||\n              // å‰é¢çš„æ¡ä»¶ä¸º fasle è¯´æ˜ cells è¢«å…¶ä»–çº¿ç¨‹åˆå§‹åŒ–ï¼Œé€šè¿‡ hash å¯»å€å¯¹åº”çš„æ§½ä½\n              (a = as[ThreadLocalRandom.getProbe() & m]) == null ||\n              // å°è¯•å»å¯¹åº”çš„æ§½ä½ç´¯åŠ ï¼Œç´¯åŠ å¤±è´¥è¿›å…¥ fullAddCount è¿›è¡Œé‡è¯•æˆ–è€…æ‰©å®¹\n              !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) {\n              // ä¸ Striped64#longAccumulate æ–¹æ³•ç›¸åŒ\n              fullAddCount(x, uncontended);\n              return;\n          }\n          // è¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ nullï¼Œæˆ–è€…ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹\n          if (check <= 1)\t\n              return;\n      \t// ã€è·å–å½“å‰æ•£åˆ—è¡¨å…ƒç´ ä¸ªæ•°ã€‘ï¼Œè¿™æ˜¯ä¸€ä¸ªæœŸæœ›å€¼\n          s = sumCount();\n      }\n      \n      // è¡¨ç¤ºä¸€å®š ã€æ˜¯ä¸€ä¸ª put æ“ä½œè°ƒç”¨çš„ addCountã€‘\n      if (check >= 0) {\n          Node<K,V>[] tab, nt; int n, sc;\n          \n          // æ¡ä»¶ä¸€ï¼štrue è¯´æ˜å½“å‰ sizeCtl å¯èƒ½ä¸ºä¸€ä¸ªè´Ÿæ•°è¡¨ç¤ºæ­£åœ¨æ‰©å®¹ä¸­ï¼Œæˆ–è€… sizeCtl æ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œè¡¨ç¤ºæ‰©å®¹é˜ˆå€¼\n          //        false è¡¨ç¤ºå“ˆå¸Œè¡¨çš„æ•°æ®çš„æ•°é‡æ²¡è¾¾åˆ°æ‰©å®¹æ¡ä»¶\n          // ç„¶ååˆ¤æ–­å½“å‰ table æ•°ç»„æ˜¯å¦åˆå§‹åŒ–äº†ï¼Œå½“å‰ table é•¿åº¦æ˜¯å¦å°äºæœ€å¤§å€¼é™åˆ¶ï¼Œå°±å¯ä»¥è¿›è¡Œæ‰©å®¹\n          while (s >= (long)(sc = sizeCtl) && (tab = table) != null &&\n                 (n = tab.length) < MAXIMUM_CAPACITY) {\n              // 16 -> 32 æ‰©å®¹ æ ‡è¯†ä¸ºï¼š1000 0000 0001 1011ï¼Œã€è´Ÿæ•°ï¼Œæ‰©å®¹æ‰¹æ¬¡å”¯ä¸€æ ‡è¯†æˆ³ã€‘\n              int rs = resizeStamp(n);\n              \n              // è¡¨ç¤ºå½“å‰ tableï¼Œã€æ­£åœ¨æ‰©å®¹ã€‘ï¼Œsc é«˜ 16 ä½æ˜¯æ‰©å®¹æ ‡è¯†æˆ³ï¼Œä½ 16 ä½æ˜¯çº¿ç¨‹æ•° + 1\n              if (sc < 0) {\n                  // æ¡ä»¶ä¸€ï¼šåˆ¤æ–­æ‰©å®¹æ ‡è¯†æˆ³æ˜¯å¦ä¸€æ ·ï¼Œfasle ä»£è¡¨ä¸€æ ·\n                  // å‹˜è¯¯ä¸¤ä¸ªæ¡ä»¶ï¼š\n                  // æ¡ä»¶äºŒæ˜¯ï¼šsc == (rs << 16 ) + 1ï¼Œtrue ä»£è¡¨æ‰©å®¹å®Œæˆï¼Œå› ä¸ºä½16ä½æ˜¯1ä»£è¡¨æ²¡æœ‰çº¿ç¨‹æ‰©å®¹äº†\n                  // æ¡ä»¶ä¸‰æ˜¯ï¼šsc == (rs << 16) + MAX_RESIZERSï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»è¶…è¿‡æœ€å¤§å…è®¸çš„å¹¶å‘æ‰©å®¹çº¿ç¨‹æ•°\n                  // æ¡ä»¶å››ï¼šåˆ¤æ–­æ–°è¡¨çš„å¼•ç”¨æ˜¯å¦æ˜¯ nullï¼Œä»£è¡¨æ‰©å®¹å®Œæˆ\n                  // æ¡ä»¶äº”ï¼šã€æ‰©å®¹æ˜¯ä»é«˜ä½åˆ°ä½ä½è½¬ç§»ã€‘ï¼ŒtransferIndex < 0 è¯´æ˜æ²¡æœ‰åŒºé—´éœ€è¦æ‰©å®¹äº†\n                  if ((sc >>> RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||\n                      sc == rs + MAX_RESIZERS || (nt = nextTable) == null ||\n                      transferIndex <= 0)\n                      break;\n                  \n                  // è®¾ç½®å½“å‰çº¿ç¨‹å‚ä¸åˆ°æ‰©å®¹ä»»åŠ¡ä¸­ï¼Œå°† sc ä½ 16 ä½å€¼åŠ  1ï¼Œè¡¨ç¤ºå¤šä¸€ä¸ªçº¿ç¨‹å‚ä¸æ‰©å®¹\n                  // è®¾ç½®å¤±è´¥å…¶ä»–çº¿ç¨‹æˆ–è€… transfer å†…éƒ¨ä¿®æ”¹äº† sizeCtl å€¼\n                  if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1))\n                      //ã€ååŠ©æ‰©å®¹çº¿ç¨‹ã€‘ï¼ŒæŒæœ‰nextTableå‚æ•°\n                      transfer(tab, nt);\n              }\n              // é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯è§¦å‘æ‰©å®¹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹æ•°é‡ + 2\n              // 1000 0000 0001 1011 0000 0000 0000 0000 +2 => 1000 0000 0001 1011 0000 0000 0000 0010\n              else if (U.compareAndSwapInt(this, SIZECTL, sc,(rs << RESIZE_STAMP_SHIFT) + 2))\n                  //ã€è§¦å‘æ‰©å®¹æ¡ä»¶çš„çº¿ç¨‹ã€‘ï¼Œä¸æŒæœ‰ nextTableï¼Œåˆå§‹çº¿ç¨‹ä¼šæ–°å»º nextTable\n                  transfer(tab, null);\n              s = sumCount();\n          }\n      }\n  }\n  ```\n\n* resizeStamp()ï¼šæ‰©å®¹æ ‡è¯†ç¬¦ï¼Œ**æ¯æ¬¡æ‰©å®¹éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªï¼Œä¸æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½äº§ç”Ÿ**ï¼Œ16 æ‰©å®¹åˆ° 32 äº§ç”Ÿä¸€ä¸ªï¼Œ32 æ‰©å®¹åˆ° 64 äº§ç”Ÿä¸€ä¸ª\n\n  ```java\n  /**\n   * æ‰©å®¹çš„æ ‡è¯†ç¬¦\n   * 16 -> 32 ä»16æ‰©å®¹åˆ°32\n   * numberOfLeadingZeros(16) => 1 0000 => 32 - 5 = 27 => 0000 0000 0001 1011\n   * (1 << (RESIZE_STAMP_BITS - 1)) => 1000 0000 0000 0000 => 32768\n   * ---------------------------------------------------------------\n   * 0000 0000 0001 1011\n   * 1000 0000 0000 0000\n   * 1000 0000 0001 1011\n   * æ°¸è¿œæ˜¯è´Ÿæ•°\n   */\n  static final int resizeStamp(int n) {\n      // æˆ–è¿ç®—\n      return Integer.numberOfLeadingZeros(n) | (1 << (RESIZE_STAMP_BITS - 1)); // (16 -1 = 15)\n  }\n  ```\n\n\n\n\n\n***\n\n\n\n##### æ‰©å®¹æ–¹æ³•\n\næ‰©å®¹æœºåˆ¶ï¼š\n\n* å½“é“¾è¡¨ä¸­å…ƒç´ ä¸ªæ•°è¶…è¿‡ 8 ä¸ªï¼Œæ•°ç»„çš„å¤§å°è¿˜æœªè¶…è¿‡ 64 æ—¶ï¼Œæ­¤æ—¶è¿›è¡Œæ•°ç»„çš„æ‰©å®¹ï¼Œå¦‚æœè¶…è¿‡åˆ™å°†é“¾è¡¨è½¬åŒ–æˆçº¢é»‘æ ‘\n* put æ•°æ®åè°ƒç”¨ addCount() æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰å“ˆå¸Œè¡¨çš„å®¹é‡è¶…è¿‡é˜ˆå€¼ sizeCtlï¼Œè¶…è¿‡è¿›è¡Œæ‰©å®¹\n* å¢åˆ æ”¹çº¿ç¨‹å‘ç°å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰©å®¹ï¼Œå¸®å…¶æ‰©å®¹\n\nå¸¸è§æ–¹æ³•ï¼š\n\n* transfer()ï¼šæ•°æ®è½¬ç§»åˆ°æ–°è¡¨ä¸­ï¼Œå®Œæˆæ‰©å®¹\n\n  ```java\n  private final void transfer(Node<K,V>[] tab, Node<K,V>[] nextTab) {\n      // n è¡¨ç¤ºæ‰©å®¹ä¹‹å‰ table æ•°ç»„çš„é•¿åº¦\n      int n = tab.length, stride;\n      // stride è¡¨ç¤ºåˆ†é…ç»™çº¿ç¨‹ä»»åŠ¡çš„æ­¥é•¿ï¼Œé»˜è®¤å°±æ˜¯ 16 \n      if ((stride = (NCPU > 1) ? (n >>> 3) / NCPU : n) < MIN_TRANSFER_STRIDE)\n          stride = MIN_TRANSFER_STRIDE;\n      // å¦‚æœå½“å‰çº¿ç¨‹ä¸ºè§¦å‘æœ¬æ¬¡æ‰©å®¹çš„çº¿ç¨‹ï¼Œéœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œï¼Œã€ååŠ©çº¿ç¨‹ä¸åšè¿™ä¸€æ­¥ã€‘\n      if (nextTab == null) {\n          try {\n              // åˆ›å»ºä¸€ä¸ªå®¹é‡æ˜¯ä¹‹å‰ã€äºŒå€çš„ table æ•°ç»„ã€‘\n              Node<K,V>[] nt = (Node<K,V>[])new Node<?,?>[n << 1];\n              nextTab = nt;\n          } catch (Throwable ex) {\n              sizeCtl = Integer.MAX_VALUE;\n              return;\n          }\n          // æŠŠæ–°è¡¨èµ‹å€¼ç»™å¯¹è±¡å±æ€§ nextTableï¼Œæ–¹ä¾¿å…¶ä»–çº¿ç¨‹è·å–æ–°è¡¨\n          nextTable = nextTab;\n          // è®°å½•è¿ç§»æ•°æ®æ•´ä½“ä½ç½®çš„ä¸€ä¸ªæ ‡è®°ï¼ŒtransferIndex è®¡æ•°ä»1å¼€å§‹ä¸æ˜¯ 0ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯é•¿åº¦ï¼Œä¸æ˜¯é•¿åº¦-1\n          transferIndex = n;\n      }\n      // æ–°æ•°ç»„çš„é•¿åº¦\n      int nextn = nextTab.length;\n      // å½“æŸä¸ªæ¡¶ä½æ•°æ®å¤„ç†å®Œæ¯•åï¼Œå°†æ­¤æ¡¶ä½è®¾ç½®ä¸º fwd èŠ‚ç‚¹ï¼Œå…¶å®ƒå†™çº¿ç¨‹æˆ–è¯»çº¿ç¨‹çœ‹åˆ°åï¼Œå¯ä»¥ä»ä¸­è·å–åˆ°æ–°è¡¨\n      ForwardingNode<K,V> fwd = new ForwardingNode<K,V>(nextTab);\n      // æ¨è¿›æ ‡è®°\n      boolean advance = true;\n      // å®Œæˆæ ‡è®°\n      boolean finishing = false;\n      \n      // i è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡ï¼Œæ‰§è¡Œåˆ°çš„æ¡¶ä½\n      // bound è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡çš„ä¸‹ç•Œé™åˆ¶ï¼Œå› ä¸ºæ˜¯å€’åºè¿ç§»ï¼Œ16 è¿ç§»å®Œ è¿ç§» 15ï¼Œ15å®Œæˆå»è¿ç§»14\n      for (int i = 0, bound = 0;;) {\n          Node<K,V> f; int fh;\n          \n          // ç»™å½“å‰çº¿ç¨‹ã€åˆ†é…ä»»åŠ¡åŒºé—´ã€‘\n          while (advance) {\n              // åˆ†é…ä»»åŠ¡çš„å¼€å§‹ä¸‹æ ‡ï¼Œåˆ†é…ä»»åŠ¡çš„ç»“æŸä¸‹æ ‡\n              int nextIndex, nextBound;\n           \n              // --i è®©å½“å‰çº¿ç¨‹å¤„ç†ä¸‹ä¸€ä¸ªç´¢å¼•ï¼Œtrueè¯´æ˜å½“å‰çš„è¿ç§»ä»»åŠ¡å°šæœªå®Œæˆï¼Œfalseè¯´æ˜çº¿ç¨‹å·²ç»å®Œæˆæˆ–è€…è¿˜æœªåˆ†é…\n              if (--i >= bound || finishing)\n                  advance = false;\n              // è¿ç§»çš„å¼€å§‹ä¸‹æ ‡ï¼Œå°äº0è¯´æ˜æ²¡æœ‰åŒºé—´éœ€è¦è¿ç§»äº†ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹çš„ i å˜é‡ä¸º -1 è·³å‡ºå¾ªç¯\n              else if ((nextIndex = transferIndex) <= 0) {\n                  i = -1;\n                  advance = false;\n              }\n              // é€»è¾‘åˆ°è¿™è¯´æ˜è¿˜æœ‰åŒºé—´éœ€è¦åˆ†é…ï¼Œç„¶åç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡ï¼Œ\n              else if (U.compareAndSwapInt(this, TRANSFERINDEX, nextIndex,\n                        // åˆ¤æ–­åŒºé—´æ˜¯å¦è¿˜å¤Ÿä¸€ä¸ªæ­¥é•¿ï¼Œä¸å¤Ÿå°±å…¨éƒ¨åˆ†é…\n                        nextBound = (nextIndex > stride ? nextIndex - stride : 0))) {\n                  // å½“å‰çº¿ç¨‹çš„ç»“æŸä¸‹æ ‡\n                  bound = nextBound;\n                  // å½“å‰çº¿ç¨‹çš„å¼€å§‹ä¸‹æ ‡ï¼Œä¸Šä¸€ä¸ªçº¿ç¨‹ç»“æŸçš„ä¸‹æ ‡çš„ä¸‹ä¸€ä¸ªç´¢å¼•å°±æ˜¯è¿™ä¸ªçº¿ç¨‹å¼€å§‹çš„ä¸‹æ ‡\n                  i = nextIndex - 1;\n                  // ä»»åŠ¡åˆ†é…ç»“æŸï¼Œè·³å‡ºå¾ªç¯æ‰§è¡Œè¿ç§»æ“ä½œ\n                  advance = false;\n              }\n          }\n          \n          // ã€åˆ†é…å®Œæˆï¼Œå¼€å§‹æ•°æ®è¿ç§»æ“ä½œã€‘\n          // ã€CASE1ã€‘ï¼ši < 0 æˆç«‹è¡¨ç¤ºå½“å‰çº¿ç¨‹æœªåˆ†é…åˆ°ä»»åŠ¡ï¼Œæˆ–è€…ä»»åŠ¡æ‰§è¡Œå®Œäº†\n          if (i < 0 || i >= n || i + n >= nextn) {\n              int sc;\n              // å¦‚æœè¿ç§»å®Œæˆ\n              if (finishing) {\n                  nextTable = null;\t// help GC\n                  table = nextTab;\t// æ–°è¡¨èµ‹å€¼ç»™å½“å‰å¯¹è±¡\n                  sizeCtl = (n << 1) - (n >>> 1);// æ‰©å®¹é˜ˆå€¼ä¸º 2n - n/2 = 3n/2 = 0.75*(2n)\n                  return;\n              }\n              // å½“å‰çº¿ç¨‹å®Œæˆäº†åˆ†é…çš„ä»»åŠ¡åŒºé—´ï¼Œå¯ä»¥é€€å‡ºï¼Œå…ˆæŠŠ sizeCtl èµ‹å€¼ç»™ sc ä¿ç•™\n              if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) {\n                  // åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œä¸æ˜¯çš„è¯ç›´æ¥ returnï¼Œ\n                  if ((sc - 2) != resizeStamp(n) << RESIZE_STAMP_SHIFT)\n                      return;\n                  // æ‰€ä»¥æœ€åä¸€ä¸ªçº¿ç¨‹é€€å‡ºçš„æ—¶å€™ï¼ŒsizeCtl çš„ä½ 16 ä½ä¸º 1\n                  finishing = advance = true;\n                  // ã€è¿™é‡Œè¡¨ç¤ºæœ€åä¸€ä¸ªçº¿ç¨‹éœ€è¦é‡æ–°æ£€æŸ¥ä¸€éæ˜¯å¦æœ‰æ¼æ‰çš„åŒºé—´ã€‘\n                  i = n;\n              }\n          }\n          \n          // ã€CASE2ã€‘ï¼šå½“å‰æ¡¶ä½æœªå­˜æ”¾æ•°æ®ï¼Œåªéœ€è¦å°†æ­¤å¤„è®¾ç½®ä¸º fwd èŠ‚ç‚¹å³å¯ã€‚\n          else if ((f = tabAt(tab, i)) == null)\n              advance = casTabAt(tab, i, null, fwd);\n          // ã€CASE3ã€‘ï¼šè¯´æ˜å½“å‰æ¡¶ä½å·²ç»è¿ç§»è¿‡äº†ï¼Œå½“å‰çº¿ç¨‹ä¸ç”¨å†å¤„ç†äº†ï¼Œç›´æ¥å¤„ç†ä¸‹ä¸€ä¸ªæ¡¶ä½å³å¯\n          else if ((fh = f.hash) == MOVED)\n              advance = true; \n          // ã€CASE4ã€‘ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œè€Œä¸” node èŠ‚ç‚¹ä¸æ˜¯ fwd èŠ‚ç‚¹ï¼Œè¯´æ˜è¿™äº›æ•°æ®éœ€è¦è¿ç§»\n          else {\n              // ã€é”ä½å¤´èŠ‚ç‚¹ã€‘\n              synchronized (f) {\n                  // äºŒæ¬¡æ£€æŸ¥ï¼Œé˜²æ­¢å¤´èŠ‚ç‚¹å·²ç»è¢«ä¿®æ”¹äº†ï¼Œå› ä¸ºè¿™é‡Œæ‰æ˜¯çº¿ç¨‹å®‰å…¨çš„è®¿é—®\n                  if (tabAt(tab, i) == f) {\n                      // ã€è¿ç§»æ•°æ®çš„é€»è¾‘ï¼Œå’Œ HashMap ç›¸ä¼¼ã€‘\n                          \n                      // ln è¡¨ç¤ºä½ä½é“¾è¡¨å¼•ç”¨\n                      // hn è¡¨ç¤ºé«˜ä½é“¾è¡¨å¼•ç”¨\n                      Node<K,V> ln, hn;\n                      // å“ˆå¸Œ > 0 è¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯é“¾è¡¨æ¡¶ä½\n                      if (fh >= 0) {\n                          // å’Œ HashMap çš„å¤„ç†æ–¹å¼ä¸€è‡´ï¼Œä¸è€æ•°ç»„é•¿åº¦ç›¸ä¸ï¼Œ16 æ˜¯ 10000\n                          // åˆ¤æ–­å¯¹åº”çš„ 1 çš„ä½ç½®ä¸Šæ˜¯ 0 æˆ– 1 åˆ†æˆé«˜ä½ä½é“¾è¡¨\n                          int runBit = fh & n;\n                          Node<K,V> lastRun = f;\n                          // éå†é“¾è¡¨ï¼Œå¯»æ‰¾ã€é€†åºçœ‹ã€‘æœ€é•¿çš„å¯¹åº”ä½ç›¸åŒçš„é“¾è¡¨ï¼Œçœ‹ä¸‹é¢çš„å›¾æ›´å¥½çš„ç†è§£\n                          for (Node<K,V> p = f.next; p != null; p = p.next) {\n                              // å°†å½“å‰èŠ‚ç‚¹çš„å“ˆå¸Œ ä¸ n\n                              int b = p.hash & n;\n                              // å¦‚æœå½“å‰å€¼ä¸å‰é¢èŠ‚ç‚¹çš„å€¼ å¯¹åº”ä½ ä¸åŒï¼Œåˆ™ä¿®æ”¹ runBitï¼ŒæŠŠ lastRun æŒ‡å‘å½“å‰èŠ‚ç‚¹\n                              if (b != runBit) {\n                                  runBit = b;\n                                  lastRun = p;\n                              }\n                          }\n                          // åˆ¤æ–­ç­›é€‰å‡ºçš„é“¾è¡¨æ˜¯ä½ä½çš„è¿˜æ˜¯é«˜ä½çš„\n                          if (runBit == 0) {\n                              ln = lastRun;\t// ln æŒ‡å‘è¯¥é“¾è¡¨\n                              hn = null;\t\t// hn ä¸º null\n                          }\n                          // è¯´æ˜ lastRun å¼•ç”¨çš„é“¾è¡¨ä¸ºé«˜ä½é“¾è¡¨ï¼Œå°±è®© hn æŒ‡å‘é«˜ä½é“¾è¡¨å¤´èŠ‚ç‚¹\n                          else {\n                              hn = lastRun;\n                              ln = null;\n                          }\n                          // ä»å¤´å¼€å§‹éå†æ‰€æœ‰çš„é“¾è¡¨èŠ‚ç‚¹ï¼Œè¿­ä»£åˆ° p == lastRun èŠ‚ç‚¹è·³å‡ºå¾ªç¯\n                          for (Node<K,V> p = f; p != lastRun; p = p.next) {\n                              int ph = p.hash; K pk = p.key; V pv = p.val;\n                              if ((ph & n) == 0)\n                                  // ã€å¤´æ’æ³•ã€‘ï¼Œä»å³å¾€å·¦çœ‹ï¼Œé¦–å…ˆ ln æŒ‡å‘çš„æ˜¯ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œ\n                                  // æ‰€ä»¥è¿™æ¬¡æ–°å»ºçš„èŠ‚ç‚¹çš„ next æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åæ›´æ–° ln çš„å¼•ç”¨\n                                  ln = new Node<K,V>(ph, pk, pv, ln);\n                              else\n                                  hn = new Node<K,V>(ph, pk, pv, hn);\n                          }\n                          // é«˜ä½ä½é“¾è®¾ç½®åˆ°æ–°è¡¨ä¸­çš„æŒ‡å®šä½ç½®\n                          setTabAt(nextTab, i, ln);\n                          setTabAt(nextTab, i + n, hn);\n                          // è€è¡¨ä¸­çš„è¯¥æ¡¶ä½è®¾ç½®ä¸º fwd èŠ‚ç‚¹\n                          setTabAt(tab, i, fwd);\n                          advance = true;\n                      }\n                      // æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ç»“ç‚¹\n                      else if (f instanceof TreeBin) {\n                          TreeBin<K,V> t = (TreeBin<K,V>)f;\n                          TreeNode<K,V> lo = null, loTail = null;\n                          TreeNode<K,V> hi = null, hiTail = null;\n                          int lc = 0, hc = 0;\n                          // è¿­ä»£ TreeBin ä¸­çš„åŒå‘é“¾è¡¨ï¼Œä»å¤´ç»“ç‚¹è‡³å°¾èŠ‚ç‚¹\n                          for (Node<K,V> e = t.first; e != null; e = e.next) {\n                              // è¿­ä»£çš„å½“å‰å…ƒç´ çš„ hash\n                              int h = e.hash;\n                              TreeNode<K,V> p = new TreeNode<K,V>\n                                  (h, e.key, e.val, null, null);\n                              // æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹å±äºä½ä½é“¾èŠ‚ç‚¹\n                              if ((h & n) == 0) {\n                                  if ((p.prev = loTail) == null)\n                                      lo = p;\n                                  else\n                                      //ã€å°¾æ’æ³•ã€‘\n                                      loTail.next = p;\n                                  // loTail æŒ‡å‘å°¾èŠ‚ç‚¹\n                                  loTail = p;\n                                  ++lc;\n                              }\n                              else {\n                                  if ((p.prev = hiTail) == null)\n                                      hi = p;\n                                  else\n                                      hiTail.next = p;\n                                  hiTail = p;\n                                  ++hc;\n                              }\n                          }\n                          // æ‹†æˆçš„é«˜ä½ä½ä½ä¸¤ä¸ªé“¾ï¼Œã€åˆ¤æ–­æ˜¯å¦éœ€è¦éœ€è¦è½¬åŒ–ä¸ºé“¾è¡¨ã€‘ï¼Œåä¹‹ä¿æŒæ ‘åŒ–\n                          ln = (lc <= UNTREEIFY_THRESHOLD) ? untreeify(lo) :\n                          (hc != 0) ? new TreeBin<K,V>(lo) : t;\n                          hn = (hc <= UNTREEIFY_THRESHOLD) ? untreeify(hi) :\n                          (lc != 0) ? new TreeBin<K,V>(hi) : t;\n                          setTabAt(nextTab, i, ln);\n                          setTabAt(nextTab, i + n, hn);\n                          setTabAt(tab, i, fwd);\n                          advance = true;\n                      }\n                  }\n              }\n          }\n      }\n  }\n  ```\n  \n  é“¾è¡¨å¤„ç†çš„ LastRun æœºåˆ¶ï¼Œ**å¯ä»¥å‡å°‘èŠ‚ç‚¹çš„åˆ›å»º**\n  \n  ![image-20230824175210854](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824175210854.png)\n  \n* helpTransfer()ï¼šå¸®åŠ©æ‰©å®¹æœºåˆ¶\n\n  ```java\n  final Node<K,V>[] helpTransfer(Node<K,V>[] tab, Node<K,V> f) {\n      Node<K,V>[] nextTab; int sc;\n      // æ•°ç»„ä¸ä¸ºç©ºï¼ŒèŠ‚ç‚¹æ˜¯è½¬å‘èŠ‚ç‚¹ï¼Œè·å–è½¬å‘èŠ‚ç‚¹æŒ‡å‘çš„æ–°è¡¨å¼€å§‹ååŠ©ä¸»çº¿ç¨‹æ‰©å®¹\n      if (tab != null && (f instanceof ForwardingNode) &&\n          (nextTab = ((ForwardingNode<K,V>)f).nextTable) != null) {\n          // æ‰©å®¹æ ‡è¯†æˆ³\n          int rs = resizeStamp(tab.length);\n          // åˆ¤æ–­æ•°æ®è¿ç§»æ˜¯å¦å®Œæˆï¼Œè¿ç§»å®Œæˆä¼šæŠŠ æ–°è¡¨èµ‹å€¼ç»™ nextTable å±æ€§\n          while (nextTab == nextTable && table == tab && (sc = sizeCtl) < 0) {\n              if ((sc >>> RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||\n                  sc == rs + MAX_RESIZERS || transferIndex <= 0)\n                  break;\n              // è®¾ç½®æ‰©å®¹çº¿ç¨‹æ•°é‡ + 1\n              if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) {\n                  // ååŠ©æ‰©å®¹\n                  transfer(tab, nextTab);\n                  break;\n              }\n          }\n          return nextTab;\n      }\n      return table;\n  }\n  ```\n  \n  \n\n\n\n***\n\n\n\n##### è·å–æ–¹æ³•\n\nConcurrentHashMap ä½¿ç”¨ get()  æ–¹æ³•è·å–æŒ‡å®š key çš„æ•°æ®\n\n* get()ï¼šè·å–æŒ‡å®šæ•°æ®çš„æ–¹æ³•\n\n  ```java\n  public V get(Object key) {\n      Node<K,V>[] tab; Node<K,V> e, p; int n, eh; K ek;\n      // æ‰°åŠ¨è¿ç®—ï¼Œè·å– key çš„å“ˆå¸Œå€¼\n      int h = spread(key.hashCode());\n      // åˆ¤æ–­å½“å‰å“ˆå¸Œè¡¨çš„æ•°ç»„æ˜¯å¦åˆå§‹åŒ–\n      if ((tab = table) != null && (n = tab.length) > 0 &&\n          // å¦‚æœ table å·²ç»åˆå§‹åŒ–ï¼Œè¿›è¡Œã€å“ˆå¸Œå¯»å€ã€‘ï¼Œæ˜ å°„åˆ°æ•°ç»„å¯¹åº”ç´¢å¼•å¤„ï¼Œè·å–è¯¥ç´¢å¼•å¤„çš„å¤´èŠ‚ç‚¹\n          (e = tabAt(tab, (n - 1) & h)) != null) {\n          // å¯¹æ¯”å¤´ç»“ç‚¹ hash ä¸æŸ¥è¯¢ key çš„ hash æ˜¯å¦ä¸€è‡´\n          if ((eh = e.hash) == h) {\n              // è¿›è¡Œå€¼çš„åˆ¤æ–­ï¼Œå¦‚æœæˆåŠŸå°±è¯´æ˜å½“å‰èŠ‚ç‚¹å°±æ˜¯è¦æŸ¥è¯¢çš„èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›\n              if ((ek = e.key) == key || (ek != null && key.equals(ek)))\n                  return e.val;\n          }\n          // å½“å‰æ§½ä½çš„ã€å“ˆå¸Œå€¼å°äº0ã€‘è¯´æ˜æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹æˆ–è€…æ˜¯æ­£åœ¨æ‰©å®¹çš„ fwd èŠ‚ç‚¹\n          else if (eh < 0)\n              return (p = e.find(h, key)) != null ? p.val : null;\n          // å½“å‰æ¡¶ä½æ˜¯ã€é“¾è¡¨ã€‘ï¼Œå¾ªç¯éå†æŸ¥æ‰¾\n          while ((e = e.next) != null) {\n              if (e.hash == h &&\n                  ((ek = e.key) == key || (ek != null && key.equals(ek))))\n                  return e.val;\n          }\n      }\n      return null;\n  }\n  ```\n  \n* ForwardingNode#findï¼šè½¬ç§»èŠ‚ç‚¹çš„æŸ¥æ‰¾æ–¹æ³•\n\n  ```java\n  Node<K,V> find(int h, Object k) {\n      // è·å–æ–°è¡¨çš„å¼•ç”¨\n      outer: for (Node<K,V>[] tab = nextTable;;)  {\n          // e è¡¨ç¤ºåœ¨æ‰©å®¹è€Œåˆ›å»ºæ–°è¡¨ä½¿ç”¨å¯»å€ç®—æ³•å¾—åˆ°çš„æ¡¶ä½å¤´ç»“ç‚¹ï¼Œn è¡¨ç¤ºä¸ºæ‰©å®¹è€Œåˆ›å»ºçš„æ–°è¡¨çš„é•¿åº¦\n          Node<K,V> e; int n;\n   \n          if (k == null || tab == null || (n = tab.length) == 0 ||\n              // åœ¨æ–°è¡¨ä¸­é‡æ–°å®šä½ hash å¯¹åº”çš„å¤´ç»“ç‚¹ï¼Œè¡¨ç¤ºåœ¨ oldTable ä¸­å¯¹åº”çš„æ¡¶ä½åœ¨è¿ç§»ä¹‹å‰å°±æ˜¯ null\n              (e = tabAt(tab, (n - 1) & h)) == null)\n              return null;\n  \n          for (;;) {\n              int eh; K ek;\n              // ã€å“ˆå¸Œç›¸åŒå€¼ä¹Ÿç›¸åŒã€‘ï¼Œè¡¨ç¤ºæ–°è¡¨å½“å‰å‘½ä¸­æ¡¶ä½ä¸­çš„æ•°æ®ï¼Œå³ä¸ºæŸ¥è¯¢æƒ³è¦æ•°æ®\n              if ((eh = e.hash) == h && ((ek = e.key) == k || (ek != null && k.equals(ek))))\n                  return e;\n  \n              // eh < 0 è¯´æ˜å½“å‰æ–°è¡¨ä¸­è¯¥ç´¢å¼•çš„å¤´èŠ‚ç‚¹æ˜¯ TreeBin ç±»å‹ï¼Œæˆ–è€…æ˜¯ FWD ç±»å‹\n              if (eh < 0) {\n                  // åœ¨å¹¶å‘å¾ˆå¤§çš„æƒ…å†µä¸‹æ–°æ‰©å®¹çš„è¡¨è¿˜æ²¡å®Œæˆå¯èƒ½ã€å†æ¬¡æ‰©å®¹ã€‘ï¼Œåœ¨æ­¤æ–¹æ³•å¤„å†æ¬¡æ‹¿åˆ° FWD ç±»å‹\n                  if (e instanceof ForwardingNode) {\n                      // ç»§ç»­è·å–æ–°çš„ fwd æŒ‡å‘çš„æ–°æ•°ç»„çš„åœ°å€ï¼Œé€’å½’äº†\n                      tab = ((ForwardingNode<K,V>)e).nextTable;\n                      continue outer;\n                  }\n                  else\n                      // è¯´æ˜æ­¤æ¡¶ä½ä¸º TreeBin èŠ‚ç‚¹ï¼Œä½¿ç”¨TreeBin.find æŸ¥æ‰¾çº¢é»‘æ ‘ä¸­ç›¸åº”èŠ‚ç‚¹ã€‚\n                      return e.find(h, k);\n              }\n  \n              // é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰æ¡¶ä½æ˜¯é“¾è¡¨ï¼Œå°†å½“å‰å…ƒç´ æŒ‡å‘é“¾è¡¨çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåˆ¤æ–­å½“å‰å…ƒç´ çš„ä¸‹ä¸€ä¸ªä½ç½®æ˜¯å¦ä¸ºç©º\n              if ((e = e.next) == null)\n                  // æ¡ä»¶æˆç«‹è¯´æ˜è¿­ä»£åˆ°é“¾è¡¨æœ«å°¾ï¼Œã€æœªæ‰¾åˆ°å¯¹åº”çš„æ•°æ®ï¼Œè¿”å› nullã€‘\n                  return null;\n          }\n      }\n  }\n  ```\n  \n  \n\n\n\n****\n\n\n\n##### åˆ é™¤æ–¹æ³•\n\n* remove()ï¼šåˆ é™¤æŒ‡å®šå…ƒç´ \n\n  ```java\n  public V remove(Object key) {\n      return replaceNode(key, null, null);\n  }\n  ```\n\n* replaceNode()ï¼šæ›¿ä»£æŒ‡å®šçš„å…ƒç´ ï¼Œä¼šååŠ©æ‰©å®¹ï¼Œ**å¢åˆ æ”¹ï¼ˆå†™ï¼‰éƒ½ä¼šååŠ©æ‰©å®¹ï¼ŒæŸ¥è¯¢ï¼ˆè¯»ï¼‰æ“ä½œä¸ä¼š**ï¼Œå› ä¸ºè¯»æ“ä½œä¸æ¶‰åŠåŠ é”\n\n  ```java\n  final V replaceNode(Object key, V value, Object cv) {\n      // è®¡ç®— key æ‰°åŠ¨è¿ç®—åçš„ hash\n      int hash = spread(key.hashCode());\n      // å¼€å§‹è‡ªæ—‹\n      for (Node<K,V>[] tab = table;;) {\n          Node<K,V> f; int n, i, fh;\n          \n          // ã€CASE1ã€‘ï¼štable è¿˜æœªåˆå§‹åŒ–æˆ–è€…å“ˆå¸Œå¯»å€çš„æ•°ç»„ç´¢å¼•å¤„ä¸º nullï¼Œç›´æ¥ç»“æŸè‡ªæ—‹ï¼Œè¿”å› null\n          if (tab == null || (n = tab.length) == 0 || (f = tabAt(tab, i = (n - 1) & hash)) == null)\n              break;\n          // ã€CASE2ã€‘ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ table æ­£åœ¨æ‰©å®¹ï¼Œã€å½“å‰æ˜¯ä¸ªå†™æ“ä½œï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹éœ€è¦ååŠ© table å®Œæˆæ‰©å®¹ã€‘\n          else if ((fh = f.hash) == MOVED)\n              tab = helpTransfer(tab, f);\n          // ã€CASE3ã€‘ï¼šå½“å‰æ¡¶ä½å¯èƒ½æ˜¯ é“¾è¡¨ ä¹Ÿå¯èƒ½æ˜¯ çº¢é»‘æ ‘ \n          else {\n              // ä¿ç•™æ›¿æ¢ä¹‹å‰æ•°æ®å¼•ç”¨\n              V oldVal = null;\n              // æ ¡éªŒæ ‡è®°\n              boolean validated = false;\n              // ã€åŠ é”å½“å‰æ¡¶ä½å¤´ç»“ç‚¹ã€‘ï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šè¿›å…¥ä»£ç å—\n              synchronized (f) {\n                  // åŒé‡æ£€æŸ¥\n                  if (tabAt(tab, i) == f) {\n                      // è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯é“¾è¡¨èŠ‚ç‚¹\n                      if (fh >= 0) {\n                          validated = true;\n                          //éå†æ‰€æœ‰çš„èŠ‚ç‚¹\n                          for (Node<K,V> e = f, pred = null;;) {\n                              K ek;\n                              // hash å’Œå€¼éƒ½ç›¸åŒï¼Œå®šä½åˆ°äº†å…·ä½“çš„èŠ‚ç‚¹\n                              if (e.hash == hash &&\n                                  ((ek = e.key) == key ||\n                                   (ek != null && key.equals(ek)))) {\n                                  // å½“å‰èŠ‚ç‚¹çš„value\n                                  V ev = e.val;\n                                  if (cv == null || cv == ev ||\n                                      (ev != null && cv.equals(ev))) {\n                                      // å°†å½“å‰èŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal åç»­è¿”å›ä¼šç”¨åˆ°\n                                      oldVal = ev;\n                                      if (value != null)\t\t// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯æ›¿æ¢æ“ä½œ\n                                          e.val = value;\t\n                                      else if (pred != null)\t// éå¤´èŠ‚ç‚¹åˆ é™¤æ“ä½œï¼Œæ–­å¼€é“¾è¡¨\n                                          pred.next = e.next;\t\n                                      else\n                                          // è¯´æ˜å½“å‰èŠ‚ç‚¹å³ä¸ºå¤´ç»“ç‚¹ï¼Œå°†æ¡¶ä½å¤´èŠ‚ç‚¹è®¾ç½®ä¸ºä»¥å‰å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n                                          setTabAt(tab, i, e.next);\n                                  }\n                                  break;\n                              }\n                              pred = e;\n                              if ((e = e.next) == null)\n                                  break;\n                          }\n                      }\n                      // è¯´æ˜æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹\n                      else if (f instanceof TreeBin) {\n                          validated = true;\n                          TreeBin<K,V> t = (TreeBin<K,V>)f;\n                          TreeNode<K,V> r, p;\n                          if ((r = t.root) != null &&\n                              (p = r.findTreeNode(hash, key, null)) != null) {\n                              V pv = p.val;\n                              if (cv == null || cv == pv ||\n                                  (pv != null && cv.equals(pv))) {\n                                  oldVal = pv;\n                                  // æ¡ä»¶æˆç«‹è¯´æ˜æ›¿æ¢æ“ä½œ\n                                  if (value != null)\n                                      p.val = value;\n                                  // åˆ é™¤æ“ä½œ\n                                  else if (t.removeTreeNode(p))\n                                      setTabAt(tab, i, untreeify(t.first));\n                              }\n                          }\n                      }\n                  }\n              }\n              // å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡æ¡¶ä½å¤´ç»“ç‚¹æ—¶ï¼Œå½“å‰çº¿ç¨‹ sync å¤´ç»“ç‚¹é”é”™å¯¹è±¡ï¼Œvalidated ä¸º falseï¼Œä¼šè¿›å…¥ä¸‹æ¬¡ for è‡ªæ—‹\n              if (validated) {\n                  if (oldVal != null) {\n                      // æ›¿æ¢çš„å€¼ä¸º nullï¼Œã€è¯´æ˜å½“å‰æ˜¯ä¸€æ¬¡åˆ é™¤æ“ä½œï¼Œæ›´æ–°å½“å‰å…ƒç´ ä¸ªæ•°è®¡æ•°å™¨ã€‘\n                      if (value == null)\n                          addCount(-1L, -1);\n                      return oldVal;\n                  }\n                  break;\n              }\n          }\n      }\n      return null;\n  }\n  ```\n  \n  \n\nå‚è€ƒè§†é¢‘ï¼šhttps://space.bilibili.com/457326371/\n\n\n\n***\n\n\n\n#### JDK7åŸç†\n\nConcurrentHashMap å¯¹é”ç²’åº¦è¿›è¡Œäº†ä¼˜åŒ–ï¼Œ**åˆ†æ®µé”æŠ€æœ¯**ï¼Œå°†æ•´å¼ è¡¨åˆ†æˆäº†å¤šä¸ªæ•°ç»„ï¼ˆSegmentï¼‰ï¼Œæ¯ä¸ªæ•°ç»„åˆæ˜¯ä¸€ä¸ªç±»ä¼¼ HashMap æ•°ç»„çš„ç»“æ„ã€‚å…è®¸å¤šä¸ªä¿®æ”¹æ“ä½œå¹¶å‘è¿›è¡Œï¼ŒSegment æ˜¯ä¸€ç§å¯é‡å…¥é”ï¼Œç»§æ‰¿ ReentrantLockï¼Œå¹¶å‘æ—¶é”ä½çš„æ˜¯æ¯ä¸ª Segmentï¼Œå…¶ä»– Segment è¿˜æ˜¯å¯ä»¥æ“ä½œçš„ï¼Œè¿™æ ·ä¸åŒ Segment ä¹‹é—´å°±å¯ä»¥å®ç°å¹¶å‘ï¼Œå¤§å¤§æé«˜æ•ˆç‡ã€‚\n\nåº•å±‚ç»“æ„ï¼š **Segment æ•°ç»„ + HashEntry æ•°ç»„ + é“¾è¡¨**ï¼ˆæ•°ç»„ + é“¾è¡¨æ˜¯ HashMap çš„ç»“æ„ï¼‰\n\n* ä¼˜ç‚¹ï¼šå¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„ segmentï¼Œå®é™…æ˜¯æ²¡æœ‰å†²çªçš„ï¼Œè¿™ä¸ JDK8 ä¸­æ˜¯ç±»ä¼¼çš„\n\n* ç¼ºç‚¹ï¼šSegments æ•°ç»„é»˜è®¤å¤§å°ä¸º16ï¼Œè¿™ä¸ªå®¹é‡åˆå§‹åŒ–æŒ‡å®šåå°±ä¸èƒ½æ”¹å˜äº†ï¼Œå¹¶ä¸”ä¸æ˜¯æ‡’æƒ°åˆå§‹åŒ–\n\n  ![image-20230824175317393](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824175317393.png)\n\n\n\n\n\n\n\n***\n\n\n\n### CopyOnWrite\n\n#### åŸç†åˆ†æ\n\nCopyOnWriteArrayList é‡‡ç”¨äº†**å†™å…¥æ—¶æ‹·è´**çš„æ€æƒ³ï¼Œå¢åˆ æ”¹æ“ä½œä¼šå°†åº•å±‚æ•°ç»„æ‹·è´ä¸€ä»½ï¼Œåœ¨æ–°æ•°ç»„ä¸Šæ‰§è¡Œæ“ä½œï¼Œä¸å½±å“å…¶å®ƒçº¿ç¨‹çš„**å¹¶å‘è¯»ï¼Œè¯»å†™åˆ†ç¦»**\n\nCopyOnWriteArraySet åº•å±‚å¯¹ CopyOnWriteArrayList è¿›è¡Œäº†åŒ…è£…ï¼Œè£…é¥°å™¨æ¨¡å¼\n\n```java\npublic CopyOnWriteArraySet() {\n    al = new CopyOnWriteArrayList<E>();\n}\n```\n\n* å­˜å‚¨ç»“æ„ï¼š\n\n  ```java\n  private transient volatile Object[] array;\t// volatile ä¿è¯äº†è¯»å†™çº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§\n  ```\n\n* å…¨å±€é”ï¼šä¿è¯çº¿ç¨‹çš„æ‰§è¡Œå®‰å…¨\n\n  ```java\n  final transient ReentrantLock lock = new ReentrantLock();\n  ```\n  \n* æ–°å¢æ•°æ®ï¼šéœ€è¦åŠ é”ï¼Œ**åˆ›å»ºæ–°çš„æ•°ç»„æ“ä½œ**\n\n  ```java\n  public boolean add(E e) {\n      final ReentrantLock lock = this.lock;\n      // åŠ é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨\n      lock.lock();\n      try {\n          // è·å–æ—§çš„æ•°ç»„\n          Object[] elements = getArray();\n          int len = elements.length;\n          // ã€æ‹·è´æ–°çš„æ•°ç»„ï¼ˆè¿™é‡Œæ˜¯æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œä½†ä¸å½±å“å…¶å®ƒè¯»çº¿ç¨‹ï¼‰ã€‘\n          Object[] newElements = Arrays.copyOf(elements, len + 1);\n          // æ·»åŠ æ–°å…ƒç´ \n          newElements[len] = e;\n          // æ›¿æ¢æ—§çš„æ•°ç»„ï¼Œã€è¿™ä¸ªæ“ä½œä»¥åï¼Œå…¶ä»–çº¿ç¨‹è·å–æ•°ç»„å°±æ˜¯è·å–çš„æ–°æ•°ç»„äº†ã€‘\n          setArray(newElements);\n          return true;\n      } finally {\n          lock.unlock();\n      }\n  }\n  ```\n\n* è¯»æ“ä½œï¼šä¸åŠ é”ï¼Œ**åœ¨åŸæ•°ç»„ä¸Šæ“ä½œ**\n\n  ```java\n  public E get(int index) {\n      return get(getArray(), index);\n  }\n  private E get(Object[] a, int index) {\n      return (E) a[index];\n  }\n  ```\n\n  é€‚åˆè¯»å¤šå†™å°‘çš„åº”ç”¨åœºæ™¯\n\n* è¿­ä»£å™¨ï¼šCopyOnWriteArrayList åœ¨è¿”å›è¿­ä»£å™¨æ—¶ï¼Œ**åˆ›å»ºä¸€ä¸ªå†…éƒ¨æ•°ç»„å½“å‰çš„å¿«ç…§ï¼ˆå¼•ç”¨ï¼‰**ï¼Œå³ä½¿å…¶ä»–çº¿ç¨‹æ›¿æ¢äº†åŸå§‹æ•°ç»„ï¼Œè¿­ä»£å™¨éå†çš„å¿«ç…§ä¾ç„¶å¼•ç”¨çš„æ˜¯åˆ›å»ºå¿«ç…§æ—¶çš„æ•°ç»„ï¼Œæ‰€ä»¥è¿™ç§å®ç°æ–¹å¼ä¹Ÿå­˜åœ¨ä¸€å®šçš„æ•°æ®å»¶è¿Ÿæ€§ï¼Œå¯¹å…¶ä»–çº¿ç¨‹å¹¶è¡Œæ·»åŠ çš„æ•°æ®ä¸å¯è§\n\n  ```java\n  public Iterator<E> iterator() {\n      // è·å–åˆ°æ•°ç»„å¼•ç”¨ï¼Œæ•´ä¸ªéå†çš„è¿‡ç¨‹è¯¥æ•°ç»„éƒ½ä¸ä¼šå˜ï¼Œä¸€ç›´å¼•ç”¨çš„éƒ½æ˜¯è€æ•°ç»„ï¼Œ\n      return new COWIterator<E>(getArray(), 0);\n  }\n  \n  // è¿­ä»£å™¨ä¼šåˆ›å»ºä¸€ä¸ªåº•å±‚arrayçš„å¿«ç…§ï¼Œæ•…ä¸»ç±»çš„ä¿®æ”¹ä¸å½±å“è¯¥å¿«ç…§\n  static final class COWIterator<E> implements ListIterator<E> {\n      // å†…éƒ¨æ•°ç»„å¿«ç…§\n      private final Object[] snapshot;\n  \n      private COWIterator(Object[] elements, int initialCursor) {\n          cursor = initialCursor;\n          // æ•°ç»„çš„å¼•ç”¨åœ¨è¿­ä»£è¿‡ç¨‹ä¸ä¼šæ”¹å˜\n          snapshot = elements;\n      }\n      // ã€ä¸æ”¯æŒå†™æ“ä½œã€‘ï¼Œå› ä¸ºæ˜¯åœ¨å¿«ç…§ä¸Šæ“ä½œï¼Œæ— æ³•åŒæ­¥å›å»\n      public void remove() {\n          throw new UnsupportedOperationException();\n      } \n  }\n  ```\n  \n  \n\n***\n\n\n\n#### å¼±ä¸€è‡´æ€§\n\næ•°æ®ä¸€è‡´æ€§å°±æ˜¯è¯»åˆ°æœ€æ–°æ›´æ–°çš„æ•°æ®ï¼š\n\n* å¼ºä¸€è‡´æ€§ï¼šå½“æ›´æ–°æ“ä½œå®Œæˆä¹‹åï¼Œä»»ä½•å¤šä¸ªåç»­è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„è®¿é—®éƒ½ä¼šè¿”å›æœ€æ–°çš„æ›´æ–°è¿‡çš„å€¼\n\n* å¼±ä¸€è‡´æ€§ï¼šç³»ç»Ÿå¹¶ä¸ä¿è¯è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„è®¿é—®éƒ½ä¼šè¿”å›æœ€æ–°çš„æ›´æ–°è¿‡çš„å€¼ï¼Œä¹Ÿä¸ä¼šæ‰¿è¯ºå¤šä¹…ä¹‹åå¯ä»¥è¯»åˆ°\n\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230720205728245.png\" alt=\"image-20230720205728245\" class=\"scale-50\" />\n\n| æ—¶é—´ç‚¹ | æ“ä½œ                         |\n| ------ | ---------------------------- |\n| 1      | Thread-0 getArray()          |\n| 2      | Thread-1 getArray()          |\n| 3      | Thread-1 setArray(arrayCopy) |\n| 4      | Thread-0 array[index]        |\n\nThread-0 è¯»åˆ°äº†è„æ•°æ®\n\nä¸ä¸€å®šå¼±ä¸€è‡´æ€§å°±ä¸å¥½\n\n* æ•°æ®åº“çš„**äº‹åŠ¡éš”ç¦»çº§åˆ«**å°±æ˜¯å¼±ä¸€è‡´æ€§çš„è¡¨ç°\n* å¹¶å‘é«˜å’Œä¸€è‡´æ€§æ˜¯çŸ›ç›¾çš„ï¼Œéœ€è¦æƒè¡¡\n\n\n\n***\n\n\n\n#### å®‰å…¨å¤±è´¥\n\nåœ¨ java.util åŒ…çš„é›†åˆç±»å°±éƒ½æ˜¯å¿«é€Ÿå¤±è´¥çš„ï¼Œè€Œ java.util.concurrent åŒ…ä¸‹çš„ç±»éƒ½æ˜¯å®‰å…¨å¤±è´¥\n\n* å¿«é€Ÿå¤±è´¥ï¼šåœ¨ A çº¿ç¨‹ä½¿ç”¨**è¿­ä»£å™¨**å¯¹é›†åˆè¿›è¡Œéå†çš„è¿‡ç¨‹ä¸­ï¼Œæ­¤æ—¶ B çº¿ç¨‹å¯¹é›†åˆè¿›è¡Œä¿®æ”¹ï¼ˆå¢åˆ æ”¹ï¼‰ï¼Œæˆ–è€… A çº¿ç¨‹åœ¨éå†è¿‡ç¨‹ä¸­å¯¹é›†åˆè¿›è¡Œä¿®æ”¹ï¼Œéƒ½ä¼šå¯¼è‡´ A çº¿ç¨‹æŠ›å‡º ConcurrentModificationException å¼‚å¸¸\n  * AbstractList ç±»ä¸­çš„æˆå‘˜å˜é‡ modCountï¼Œç”¨æ¥è®°å½• List ç»“æ„å‘ç”Ÿå˜åŒ–çš„æ¬¡æ•°ï¼Œ**ç»“æ„å‘ç”Ÿå˜åŒ–**æ˜¯æŒ‡æ·»åŠ æˆ–è€…åˆ é™¤è‡³å°‘ä¸€ä¸ªå…ƒç´ çš„æ“ä½œï¼Œæˆ–è€…æ˜¯è°ƒæ•´å†…éƒ¨æ•°ç»„çš„å¤§å°ï¼Œä»…ä»…è®¾ç½®å…ƒç´ çš„å€¼ä¸ç®—ç»“æ„å‘ç”Ÿå˜åŒ–\n  * åœ¨è¿›è¡Œåºåˆ—åŒ–æˆ–è€…è¿­ä»£ç­‰æ“ä½œæ—¶ï¼Œéœ€è¦æ¯”è¾ƒæ“ä½œå‰å modCount æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœæ”¹å˜äº†æŠ›å‡º CME å¼‚å¸¸\n  \n* å®‰å…¨å¤±è´¥ï¼šé‡‡ç”¨å®‰å…¨å¤±è´¥æœºåˆ¶çš„é›†åˆå®¹å™¨ï¼Œåœ¨**è¿­ä»£å™¨**éå†æ—¶ç›´æ¥åœ¨åŸé›†åˆæ•°ç»„å†…å®¹ä¸Šè®¿é—®ï¼Œä½†å…¶ä»–çº¿ç¨‹çš„å¢åˆ æ”¹éƒ½ä¼šæ–°å»ºæ•°ç»„è¿›è¡Œä¿®æ”¹ï¼Œå°±ç®—ä¿®æ”¹äº†é›†åˆåº•å±‚çš„æ•°ç»„å®¹å™¨ï¼Œè¿­ä»£å™¨ä¾ç„¶å¼•ç”¨ç€ä»¥å‰çš„æ•°ç»„ï¼ˆ**å¿«ç…§æ€æƒ³**ï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å¼‚å¸¸\n\n  ConcurrentHashMap ä¸ä¼šå‡ºç°å¹¶å‘æ—¶çš„è¿­ä»£å¼‚å¸¸ï¼Œå› ä¸ºåœ¨è¿­ä»£è¿‡ç¨‹ä¸­ CHM çš„è¿­ä»£å™¨å¹¶æ²¡æœ‰åˆ¤æ–­ç»“æ„çš„å˜åŒ–ï¼Œè¿­ä»£å™¨è¿˜å¯ä»¥æ ¹æ®è¿­ä»£çš„èŠ‚ç‚¹çŠ¶æ€å»å¯»æ‰¾å¹¶å‘æ‰©å®¹æ—¶çš„æ–°è¡¨è¿›è¡Œè¿­ä»£\n\n  ```java\n  ConcurrentHashMap map = new ConcurrentHashMap();\n  // KeyIterator\n  Iterator iterator = map.keySet().iterator();\n  ```\n\n  ```java\n   Traverser(Node<K,V>[] tab, int size, int index, int limit) {\n       // å¼•ç”¨è¿˜æ˜¯åŸæ¥é›†åˆçš„ Node æ•°ç»„ï¼Œæ‰€ä»¥å…¶ä»–çº¿ç¨‹å¯¹æ•°æ®çš„ä¿®æ”¹æ˜¯å¯è§çš„\n       this.tab = tab;\n       this.baseSize = size;\n       this.baseIndex = this.index = index;\n       this.baseLimit = limit;\n       this.next = null;\n   }\n  ```\n\n  ```java\n  public final boolean hasNext() { return next != null; }\n  public final K next() {\n      Node<K,V> p;\n      if ((p = next) == null)\n          throw new NoSuchElementException();\n      K k = p.key;\n      lastReturned = p;\n      // åœ¨æ–¹æ³•ä¸­è¿›è¡Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·å–ï¼Œä¼šè¿›è¡Œæ§½ä½å¤´èŠ‚ç‚¹çš„çŠ¶æ€åˆ¤æ–­\n      advance();\n      return k;\n  }\n  ```\n\n  \n\n\n\n***\n\n\n\n### Collections\n\nCollectionsç±»æ˜¯ç”¨æ¥æ“ä½œé›†åˆçš„å·¥å…·ç±»ï¼Œæä¾›äº†é›†åˆè½¬æ¢æˆçº¿ç¨‹å®‰å…¨çš„æ–¹æ³•ï¼š\n\n```java\n public static <T> Collection<T> synchronizedCollection(Collection<T> c) {\n     return new SynchronizedCollection<>(c);\n }\npublic static <K,V> Map<K,V> synchronizedMap(Map<K,V> m) {\n    return new SynchronizedMap<>(m);\n}\n```\n\næºç ï¼šåº•å±‚ä¹Ÿæ˜¯å¯¹æ–¹æ³•è¿›è¡ŒåŠ é”\n\n```java\npublic boolean add(E e) {\n    synchronized (mutex) {return c.add(e);}\n}\n```\n\n\n\n***\n\n\n\n### SkipListMap\n\n#### åº•å±‚ç»“æ„\n\nè·³è¡¨ SkipList æ˜¯ä¸€ä¸ª**æœ‰åºçš„é“¾è¡¨**ï¼Œé»˜è®¤å‡åºï¼Œåº•å±‚æ˜¯é“¾è¡¨åŠ å¤šçº§ç´¢å¼•çš„ç»“æ„ã€‚è·³è¡¨å¯ä»¥å¯¹å…ƒç´ è¿›è¡Œå¿«é€ŸæŸ¥è¯¢ï¼Œç±»ä¼¼äºå¹³è¡¡æ ‘ï¼Œæ˜¯ä¸€ç§åˆ©ç”¨ç©ºé—´æ¢æ—¶é—´çš„ç®—æ³•\n\nå¯¹äºå•é“¾è¡¨ï¼Œå³ä½¿é“¾è¡¨æ˜¯æœ‰åºçš„ï¼Œå¦‚æœæŸ¥æ‰¾æ•°æ®ä¹Ÿåªèƒ½ä»å¤´åˆ°å°¾éå†é“¾è¡¨ï¼Œæ‰€ä»¥é‡‡ç”¨é“¾è¡¨ä¸Šå»ºç´¢å¼•çš„æ–¹å¼æé«˜æ•ˆç‡ï¼Œè·³è¡¨çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦æ˜¯ **O(logn)**ï¼Œç©ºé—´å¤æ‚åº¦ O(n)\n\nConcurrentSkipListMap æä¾›äº†ä¸€ç§çº¿ç¨‹å®‰å…¨çš„å¹¶å‘è®¿é—®çš„æ’åºæ˜ å°„è¡¨ï¼Œå†…éƒ¨æ˜¯è·³è¡¨ç»“æ„å®ç°ï¼Œé€šè¿‡ CAS + volatile ä¿è¯çº¿ç¨‹å®‰å…¨\n\nå¹³è¡¡æ ‘å’Œè·³è¡¨çš„åŒºåˆ«ï¼š\n\n* å¯¹å¹³è¡¡æ ‘çš„æ’å…¥å’Œåˆ é™¤å¾€å¾€å¾ˆå¯èƒ½å¯¼è‡´å¹³è¡¡æ ‘è¿›è¡Œä¸€æ¬¡å…¨å±€çš„è°ƒæ•´ï¼›è€Œå¯¹è·³è¡¨çš„æ’å…¥å’Œåˆ é™¤ï¼Œ**åªéœ€è¦å¯¹æ•´ä¸ªç»“æ„çš„å±€éƒ¨è¿›è¡Œæ“ä½œ**\n* åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ•´ä¸ªå¹³è¡¡æ ‘çš„çº¿ç¨‹å®‰å…¨éœ€è¦ä¸€ä¸ªå…¨å±€é”ï¼›å¯¹äºè·³è¡¨åˆ™åªéœ€è¦éƒ¨åˆ†é”ï¼Œæ‹¥æœ‰æ›´å¥½çš„æ€§èƒ½\n\n![image-20230824175500066](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824175500066.png)\n\nBaseHeader å­˜å‚¨æ•°æ®ï¼ŒheadIndex å­˜å‚¨ç´¢å¼•ï¼Œçºµå‘ä¸Š**æ‰€æœ‰ç´¢å¼•éƒ½æŒ‡å‘é“¾è¡¨æœ€ä¸‹é¢çš„èŠ‚ç‚¹**\n\n\n\n***\n\n\n\n#### æˆå‘˜å˜é‡\n\n* æ ‡è¯†ç´¢å¼•å¤´èŠ‚ç‚¹ä½ç½®\n\n  ```java\n  private static final Object BASE_HEADER = new Object();\n  ```\n\n* è·³è¡¨çš„é¡¶å±‚ç´¢å¼•\n\n  ```java\n  private transient volatile HeadIndex<K,V> head;\n  ```\n\n* æ¯”è¾ƒå™¨ï¼Œä¸º null åˆ™ä½¿ç”¨è‡ªç„¶æ’åº\n\n  ```java\n  final Comparator<? super K> comparator;\n  ```\n\n* Node èŠ‚ç‚¹\n\n  ```java\n  static final class Node<K, V>{\n      final K key;  \t\t\t\t// key æ˜¯ final çš„, è¯´æ˜èŠ‚ç‚¹ä¸€æ—¦å®šä¸‹æ¥, é™¤äº†åˆ é™¤, ä¸€èˆ¬ä¸ä¼šæ”¹åŠ¨ key\n      volatile Object value; \t\t// å¯¹åº”çš„ value\n      volatile Node<K, V> next; \t// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå•å‘é“¾è¡¨\n  }\n  ```\n\n* ç´¢å¼•èŠ‚ç‚¹ Indexï¼Œåªæœ‰å‘ä¸‹å’Œå‘å³çš„æŒ‡é’ˆ\n\n  ```java\n  static class Index<K, V>{\n      final Node<K, V> node; \t\t// ç´¢å¼•æŒ‡å‘çš„èŠ‚ç‚¹ï¼Œæ¯ä¸ªéƒ½ä¼šæŒ‡å‘æ•°æ®èŠ‚ç‚¹\n      final Index<K, V> down; \t// ä¸‹è¾¹levelå±‚çš„Indexï¼Œåˆ†å±‚ç´¢å¼•\n      volatile Index<K, V> right; // å³è¾¹çš„Indexï¼Œå•å‘\n  \n      // åœ¨ index æœ¬èº«å’Œ succ ä¹‹é—´æ’å…¥ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ newSucc\n      final boolean link(Index<K, V> succ, Index<K, V> newSucc){\n          Node<K, V> n = node;\n          newSucc.right = succ;\n          // æŠŠå½“å‰èŠ‚ç‚¹çš„å³æŒ‡é’ˆä» succ æ”¹ä¸º newSucc\n          return n.value != null && casRight(succ, newSucc);\n      }\n  \n      // æ–­å¼€å½“å‰èŠ‚ç‚¹å’Œ succ èŠ‚ç‚¹ï¼Œå°†å½“å‰çš„èŠ‚ç‚¹ index è®¾ç½®å…¶çš„ right ä¸º succ.rightï¼Œå°±æ˜¯æŠŠ succ åˆ é™¤\n      final boolean unlink(Index<K, V> succ){\n          return node.value != null && casRight(succ, succ.right);\n      }\n  }\n  ```\n\n* å¤´ç´¢å¼•èŠ‚ç‚¹ HeadIndex\n\n  ```java\n  static final class HeadIndex<K,V> extends Index<K,V> {\n      final int level;\t// è¡¨ç¤ºç´¢å¼•å±‚çº§ï¼Œæ‰€æœ‰çš„ HeadIndex éƒ½æŒ‡å‘åŒä¸€ä¸ª Base_header èŠ‚ç‚¹\n      HeadIndex(Node<K,V> node, Index<K,V> down, Index<K,V> right, int level) {\n          super(node, down, right);\n          this.level = level;\n      }\n  }\n  ```\n\n\n\n***\n\n\n\n#### æˆå‘˜æ–¹æ³•\n\n##### å…¶ä»–æ–¹æ³•\n\n* æ„é€ æ–¹æ³•ï¼š\n\n  ```java\n  public ConcurrentSkipListMap() {\n      this.comparator = null;\t// comparator ä¸º nullï¼Œä½¿ç”¨ key çš„è‡ªç„¶åºï¼Œå¦‚å­—å…¸åº\n      initialize();\n  }\n  ```\n\n  ```java\n  private void initialize() {\n      keySet = null;\n      entrySet = null;\n      values = null;\n      descendingMap = null;\n      // åˆå§‹åŒ–ç´¢å¼•å¤´èŠ‚ç‚¹ï¼ŒNode çš„ key ä¸º nullï¼Œvalue ä¸º BASE_HEADER å¯¹è±¡ï¼Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸º null\n      // head çš„åˆ†å±‚ç´¢å¼• down ä¸º nullï¼Œé“¾è¡¨çš„åç»­ç´¢å¼• right ä¸º nullï¼Œå±‚çº§ level ä¸ºç¬¬ 1 å±‚\n      head = new HeadIndex<K,V>(new Node<K,V>(null, BASE_HEADER, null), null, null, 1);\n  }\n  ```\n  \n* cprï¼šæ’åº\n\n  ```java\n  //ã€€x æ˜¯æ¯”è¾ƒè€…ï¼Œy æ˜¯è¢«æ¯”è¾ƒè€…ï¼Œæ¯”è¾ƒè€…å¤§äºè¢«æ¯”è¾ƒè€… è¿”å›æ­£æ•°ï¼Œå°äºè¿”å›è´Ÿæ•°ï¼Œç›¸ç­‰è¿”å› 0\n  static final int cpr(Comparator c, Object x, Object y) {\n      return (c != null) ? c.compare(x, y) : ((Comparable)x).compareTo(y);\n  }\n  ```\n\n\n\n***\n\n\n\n##### æ·»åŠ æ–¹æ³•\n\n* findPredecessor()ï¼šå¯»æ‰¾å‰ç½®èŠ‚ç‚¹\n\n  ä»æœ€ä¸Šå±‚çš„å¤´ç´¢å¼•å¼€å§‹å‘å³æŸ¥æ‰¾ï¼ˆé“¾è¡¨çš„åç»­ç´¢å¼•ï¼‰ï¼Œå¦‚æœåç»­ç´¢å¼•çš„èŠ‚ç‚¹çš„ key å¤§äºè¦æŸ¥æ‰¾çš„ keyï¼Œåˆ™å¤´ç´¢å¼•ç§»åˆ°ä¸‹å±‚é“¾è¡¨ï¼Œåœ¨ä¸‹å±‚é“¾è¡¨æŸ¥æ‰¾ï¼Œä»¥æ­¤åå¤ï¼Œä¸€ç›´æŸ¥æ‰¾åˆ°æ²¡æœ‰ä¸‹å±‚çš„åˆ†å±‚ç´¢å¼•ä¸ºæ­¢ï¼Œè¿”å›è¯¥ç´¢å¼•çš„èŠ‚ç‚¹ã€‚å¦‚æœåç»­ç´¢å¼•çš„èŠ‚ç‚¹çš„ key å°äºè¦æŸ¥æ‰¾çš„ keyï¼Œåˆ™åœ¨è¯¥å±‚é“¾è¡¨ä¸­å‘åæŸ¥æ‰¾ã€‚ç”±äºæŸ¥æ‰¾çš„ key å¯èƒ½æ°¸è¿œå¤§äºç´¢å¼•èŠ‚ç‚¹çš„ keyï¼Œæ‰€ä»¥åªèƒ½æ‰¾åˆ°ç›®æ ‡çš„å‰ç½®ç´¢å¼•èŠ‚ç‚¹ã€‚å¦‚æœé‡åˆ°ç©ºå€¼ç´¢å¼•çš„å­˜åœ¨ï¼Œé€šè¿‡ CAS æ¥æ–­å¼€ç´¢å¼•\n\n  ```java\n  private Node<K,V> findPredecessor(Object key, Comparator<? super K> cmp) {\n      if (key == null)\n          throw new NullPointerException(); // don't postpone errors\n      for (;;) {\n          // 1.åˆå§‹æ•°æ® q æ˜¯ headï¼Œr æ˜¯æœ€é¡¶å±‚ h çš„å³ Index èŠ‚ç‚¹\n          for (Index<K,V> q = head, r = q.right, d;;) {\n              // 2.å³ç´¢å¼•èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™è¿›è¡Œå‘ä¸‹æŸ¥æ‰¾\n              if (r != null) {\n                  Node<K,V> n = r.node;\n                  K k = n.key;\n                  // 3.n.value ä¸º null è¯´æ˜èŠ‚ç‚¹ n æ­£åœ¨åˆ é™¤çš„è¿‡ç¨‹ä¸­ï¼Œæ­¤æ—¶ã€å½“å‰çº¿ç¨‹å¸®å…¶åˆ é™¤ç´¢å¼•ã€‘\n                  if (n.value == null) {\n                      // åœ¨ index å±‚ç›´æ¥åˆ é™¤ r ç´¢å¼•èŠ‚ç‚¹\n                      if (!q.unlink(r))\n                          // åˆ é™¤å¤±è´¥é‡æ–°ä» head èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾ï¼Œbreak ä¸€ä¸ª for åˆ°æ­¥éª¤ 1ï¼Œåˆä»åˆå§‹å€¼å¼€å§‹\n                          break;\n                      \n                      // åˆ é™¤èŠ‚ç‚¹ r æˆåŠŸï¼Œè·å–æ–°çš„ r èŠ‚ç‚¹,\n                      r = q.right;\n                      // å›åˆ°æ­¥éª¤ 2ï¼Œè¿˜æ˜¯ä»è¿™å±‚ç´¢å¼•å¼€å§‹å‘å³éå†\n                      continue;\n                  }\n                  // 4.è‹¥å‚æ•° key > r.node.keyï¼Œåˆ™ç»§ç»­å‘å³éå†, continue åˆ°æ­¥éª¤ 2 å¤„è·å–å³èŠ‚ç‚¹\n                  //   è‹¥å‚æ•° key < r.node.keyï¼Œè¯´æ˜éœ€è¦è¿›å…¥ä¸‹å±‚ç´¢å¼•ï¼Œåˆ°æ­¥éª¤ 5\n                  if (cpr(cmp, key, k) > 0) {\n                      q = r;\n                      r = r.right;\n                      continue;\n                  }\n              }\n              // 5.å…ˆè®© d æŒ‡å‘ q çš„ä¸‹ä¸€å±‚ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ nullï¼Œæ˜¯åˆ™è¯´æ˜å·²ç»åˆ°äº†æ•°æ®å±‚ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€å±‚\n              if ((d = q.down) == null) \n                  return q.node;\n              // 6.æœªåˆ°æ•°æ®å±‚, è¿›è¡Œé‡æ–°èµ‹å€¼å‘ä¸‹æ‰«æ\n              q = d;\t\t// q æŒ‡å‘ d\n              r = d.right;// r æŒ‡å‘ q çš„åç»­ç´¢å¼•èŠ‚ç‚¹ï¼Œæ­¤æ—¶(q.key < key < r.key)\n          }\n      }\n  }\n  ```\n\n  ![image-20230824175548648](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824175548648.png)\n\n* put()ï¼šæ·»åŠ æ•°æ®\n\n  ```java\n  public V put(K key, V value) {\n      // éç©ºåˆ¤æ–­ï¼Œvalueä¸èƒ½ä¸ºç©º\n      if (value == null)\n          throw new NullPointerException();\n      return doPut(key, value, false);\n  }\n  ```\n\n  ```java\n  private V doPut(K key, V value, boolean onlyIfAbsent) {\n      Node<K,V> z;\n      // éç©ºåˆ¤æ–­ï¼Œkey ä¸èƒ½ä¸ºç©º\n      if (key == null)\n          throw new NullPointerException();\n      Comparator<? super K> cmp = comparator;\n      // outer å¾ªç¯ï¼Œã€æŠŠå¾…æ’å…¥æ•°æ®æ’å…¥åˆ°æ•°æ®å±‚çš„åˆé€‚çš„ä½ç½®ï¼Œå¹¶åœ¨æ‰«æè¿‡ç¨‹ä¸­å¤„ç†å·²åˆ é™¤(value = null)çš„æ•°æ®ã€‘\n      outer: for (;;) {\n          //0.for (;;)\n          //1.å°† key å¯¹åº”çš„å‰ç»§èŠ‚ç‚¹æ‰¾åˆ°, b ä¸ºå‰ç»§èŠ‚ç‚¹ï¼Œæ˜¯æ•°æ®å±‚çš„, n æ˜¯å‰ç»§èŠ‚ç‚¹çš„ next, \n  \t\t//  è‹¥æ²¡å‘ç”Ÿæ¡ä»¶ç«äº‰ï¼Œæœ€ç»ˆ key åœ¨ b ä¸ n ä¹‹é—´ (æ‰¾åˆ°çš„ b åœ¨ base_level ä¸Š)\n          for (Node<K,V> b = findPredecessor(key, cmp), n = b.next;;) {\n              // 2.n ä¸ä¸º null è¯´æ˜ b ä¸æ˜¯é“¾è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹\n              if (n != null) {\n                  Object v; int c;\n                  // 3.è·å– n çš„å³èŠ‚ç‚¹\n                  Node<K,V> f = n.next;\n                  // 4.æ¡ä»¶ç«äº‰ï¼Œå¹¶å‘ä¸‹å…¶ä»–çº¿ç¨‹åœ¨ b ä¹‹åæ’å…¥èŠ‚ç‚¹æˆ–ç›´æ¥åˆ é™¤èŠ‚ç‚¹ n, break åˆ°æ­¥éª¤ 0\n                  if (n != b.next)              \n                      break;\n                  //  è‹¥èŠ‚ç‚¹ n å·²ç»åˆ é™¤, åˆ™è°ƒç”¨ helpDelete è¿›è¡Œã€å¸®åŠ©åˆ é™¤èŠ‚ç‚¹ã€‘\n                  if ((v = n.value) == null) {\n                      n.helpDelete(b, f);\n                      break;\n                  }\n                  // 5.èŠ‚ç‚¹ b è¢«åˆ é™¤ä¸­ï¼Œåˆ™ break åˆ°æ­¥éª¤ 0,\n  \t\t\t\t//  ã€è°ƒç”¨findPredecessorå¸®åŠ©åˆ é™¤indexå±‚çš„æ•°æ®, nodeå±‚çš„æ•°æ®ä¼šé€šè¿‡helpDeleteæ–¹æ³•è¿›è¡Œåˆ é™¤ã€‘\n                  if (b.value == null || v == n) \n                      break;\n                  // 6.è‹¥ key > n.keyï¼Œåˆ™è¿›è¡Œå‘åæ‰«æ\n                  //   è‹¥ key < n.keyï¼Œåˆ™è¯æ˜ key åº”è¯¥å­˜å‚¨åœ¨ b å’Œ n ä¹‹é—´\n                  if ((c = cpr(cmp, key, n.key)) > 0) {\n                      b = n;\n                      n = f;\n                      continue;\n                  }\n                  // 7.key çš„å€¼å’Œ n.key ç›¸ç­‰ï¼Œåˆ™å¯ä»¥ç›´æ¥è¦†ç›–èµ‹å€¼\n                  if (c == 0) {\n                      // onlyIfAbsent é»˜è®¤ falseï¼Œ\n                      if (onlyIfAbsent || n.casValue(v, value)) {\n                          @SuppressWarnings(\"unchecked\") V vv = (V)v;\n                          // è¿”å›è¢«è¦†ç›–çš„å€¼\n                          return vv;\n                      }\n                      // caså¤±è´¥ï¼Œbreak ä¸€å±‚å¾ªç¯ï¼Œè¿”å› 0 é‡è¯•\n                      break;\n                  }\n                  // else c < 0; fall through\n              }\n              // 8.æ­¤æ—¶çš„æƒ…å†µ b.key < key < n.keyï¼Œå¯¹åº”æµç¨‹å›¾1ä¸­çš„7ï¼Œåˆ›å»ºzèŠ‚ç‚¹æŒ‡å‘n\n              z = new Node<K,V>(key, value, n);\n              // 9.å°è¯•æŠŠ b.next ä» n è®¾ç½®æˆ z\n              if (!b.casNext(n, z))\n                  // caså¤±è´¥ï¼Œè¿”å›åˆ°æ­¥éª¤0ï¼Œé‡è¯•\n                  break;\n              // 10.break outer å, ä¸Šé¢çš„ for å¾ªç¯ä¸ä¼šå†æ‰§è¡Œ, è€Œåæ‰§è¡Œä¸‹é¢çš„ä»£ç \n              break outer;\n          }\n      }\n  \t// ã€ä»¥ä¸Šæ’å…¥èŠ‚ç‚¹å·²ç»å®Œæˆï¼Œå‰©ä¸‹çš„ä»»åŠ¡è¦æ ¹æ®éšæœºæ•°çš„å€¼æ¥è¡¨ç¤ºæ˜¯å¦å‘ä¸Šå¢åŠ å±‚æ•°ä¸ä¸Šå±‚ç´¢å¼•ã€‘\n      \n      // éšæœºæ•°\n      int rnd = ThreadLocalRandom.nextSecondarySeed();\n      \n      // å¦‚æœéšæœºæ•°çš„äºŒè¿›åˆ¶ä¸ 10000000000000000000000000000001 è¿›è¡Œä¸è¿ç®—ä¸º 0\n      // å³éšæœºæ•°çš„äºŒè¿›åˆ¶æœ€é«˜ä½ä¸æœ€æœ«å°¾å¿…é¡»ä¸º 0ï¼Œå…¶ä»–ä½æ— æ‰€è°“ï¼Œå°±è¿›å…¥è¯¥å¾ªç¯\n      // å¦‚æœéšæœºæ•°çš„äºŒè¿›åˆ¶æœ€é«˜ä½ä¸æœ€æœ«ä½ä¸ä¸º 0ï¼Œä¸å¢åŠ æ–°èŠ‚ç‚¹çš„å±‚æ•°\n      \n      // 11.åˆ¤æ–­æ˜¯å¦éœ€è¦æ·»åŠ  levelï¼Œ32 ä½\n      if ((rnd & 0x80000001) == 0) {\n          // ç´¢å¼•å±‚ levelï¼Œä» 1 å¼€å§‹ï¼Œå°±æ˜¯æœ€åº•å±‚\n          int level = 1, max;\n          // 12.åˆ¤æ–­æœ€ä½ä½å‰é¢æœ‰å‡ ä¸ª 1ï¼Œæœ‰å‡ ä¸ªleveå°±åŠ å‡ ï¼š0..0 0001 1110ï¼Œè¿™æ˜¯4ä¸ªï¼Œåˆ™1+4=5\n          //    ã€æœ€å¤§æœ‰30ä¸ªå°±æ˜¯ 1 + 30 = 31\n          while (((rnd >>>= 1) & 1) != 0)\n              ++level;\n          // æœ€ç»ˆä¼šæŒ‡å‘ z èŠ‚ç‚¹ï¼Œå°±æ˜¯æ·»åŠ çš„èŠ‚ç‚¹ \n          Index<K,V> idx = null;\n          // æŒ‡å‘å¤´ç´¢å¼•èŠ‚ç‚¹\n          HeadIndex<K,V> h = head;\n          \n          // 13.åˆ¤æ–­levelæ˜¯å¦æ¯”å½“å‰æœ€é«˜ç´¢å¼•å°ï¼Œå›¾ä¸­ max ä¸º 3\n          if (level <= (max = h.level)) {\n              for (int i = 1; i <= level; ++i)\n                  // æ ¹æ®å±‚æ•°levelä¸æ–­åˆ›å»ºæ–°å¢èŠ‚ç‚¹çš„ä¸Šå±‚ç´¢å¼•ï¼Œç´¢å¼•çš„åç»§ç´¢å¼•ç•™ç©º\n                  // ç¬¬ä¸€æ¬¡idxä¸ºnullï¼Œä¹Ÿå°±æ˜¯ä¸‹å±‚ç´¢å¼•ä¸ºç©ºï¼Œç¬¬äºŒæ¬¡æŠŠä¸Šæ¬¡çš„ç´¢å¼•ä½œä¸ºä¸‹å±‚ç´¢å¼•ï¼Œã€ç±»ä¼¼å¤´æ’æ³•ã€‘\n                  idx = new Index<K,V>(z, idx, null);\n              // å¾ªç¯ä»¥åçš„ç´¢å¼•ç»“æ„\n              // index-3\tâ† idx\n              //   â†“\n              // index-2\n              //   â†“\n              // index-1\n              //   â†“\n              //  z-node\n          }\n          // 14.è‹¥ level > maxï¼Œåˆ™ã€åªå¢åŠ ä¸€å±‚ index ç´¢å¼•å±‚ã€‘ï¼Œ3 + 1 = 4\n          else { \n              level = max + 1;\n              //åˆ›å»ºä¸€ä¸ª index æ•°ç»„ï¼Œé•¿åº¦æ˜¯ level+1ï¼Œå‡è®¾ level æ˜¯ 4ï¼Œåˆ›å»ºçš„æ•°ç»„é•¿åº¦ä¸º 5\n              Index<K,V>[] idxs = (Index<K,V>[])new Index<?,?>[level+1];\n              // index[0]çš„æ•°ç»„ slot å¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œåªä½¿ç”¨ [1,level] è¿™äº›æ•°ç»„çš„ slot\n              for (int i = 1; i <= level; ++i)\n                  idxs[i] = idx = new Index<K,V>(z, idx, null);\n                \t\t// index-4   â† idx\n                      //   â†“\n                    \t// ......\n                      //   â†“\n                      // index-1\n                      //   â†“\n                      //  z-node\n              \n              for (;;) {\n                  h = head;\n                  // è·å–å¤´ç´¢å¼•çš„å±‚æ•°ï¼Œ3\n                  int oldLevel = h.level;\n                  // å¦‚æœ level <= oldLevelï¼Œè¯´æ˜å…¶ä»–çº¿ç¨‹è¿›è¡Œäº† index å±‚å¢åŠ æ“ä½œï¼Œé€€å‡ºå¾ªç¯\n                  if (level <= oldLevel)\n                      break;\n                  // å®šä¹‰ä¸€ä¸ªæ–°çš„å¤´ç´¢å¼•èŠ‚ç‚¹\n                  HeadIndex<K,V> newh = h;\n                  // è·å–å¤´ç´¢å¼•çš„èŠ‚ç‚¹ï¼Œå°±æ˜¯ BASE_HEADER\n                  Node<K,V> oldbase = h.node;\n                  // å‡çº§ baseHeader ç´¢å¼•ï¼Œå‡é«˜ä¸€çº§ï¼Œå¹¶å‘ä¸‹å¯èƒ½å‡é«˜å¤šçº§\n                  for (int j = oldLevel + 1; j <= level; ++j)\n                      // å‚æ•°1ï¼šåº•å±‚nodeï¼Œå‚æ•°äºŒï¼šdownï¼Œä¸ºä»¥å‰çš„å¤´èŠ‚ç‚¹ï¼Œå‚æ•°ä¸‰ï¼šrightï¼Œæ–°å»º\n                      newh = new HeadIndex<K,V>(oldbase, newh, idxs[j], j);\n                  // æ‰§è¡Œå®Œforå¾ªç¯ä¹‹åï¼ŒbaseHeader ç´¢å¼•é•¿è¿™ä¸ªæ ·å­ï¼Œè¿™é‡Œåªå‡é«˜ä¸€çº§\n                  // index-4             â†’             index-4\tâ† idx\n                  //   â†“                                  â†“\n                  // index-3                           index-3     \n                  //   â†“                                  â†“\n                  // index-2                           index-2\n                  //   â†“                                  â†“\n                  // index-1                           index-1\n                  //   â†“                                  â†“\n                  // baseHeader    â†’    ....      â†’     z-node\n                  \n                  // cas æˆåŠŸåï¼Œhead å­—æ®µæŒ‡å‘æœ€æ–°çš„ headIndexï¼ŒbaseHeader çš„ index-4\n                  if (casHead(h, newh)) {\n                      // h æŒ‡å‘æœ€æ–°çš„ index-4 èŠ‚ç‚¹\n                      h = newh;\n                      // è®© idx æŒ‡å‘ z-node çš„ index-3 èŠ‚ç‚¹ï¼Œ\n  \t\t\t\t\t// å› ä¸ºä» index-3 - index-1 çš„è¿™äº› z-node ç´¢å¼•èŠ‚ç‚¹ éƒ½æ²¡æœ‰æ’å…¥åˆ°ç´¢å¼•é“¾è¡¨\n                      idx = idxs[level = oldLevel];\n                      break;\n                  }\n              }\n          }\n          // 15.ã€æŠŠæ–°åŠ çš„ç´¢å¼•æ’å…¥ç´¢å¼•é“¾è¡¨ä¸­ã€‘ï¼Œæœ‰ä¸Šè¿°ä¸¤ç§æƒ…å†µï¼Œä¸€ç§ç´¢å¼•é«˜åº¦ä¸å˜ï¼Œå¦ä¸€ç§æ˜¯é«˜åº¦åŠ  1\n          // è¦æ’å…¥çš„æ˜¯ç¬¬å‡ å±‚çš„ç´¢å¼•\n          splice: for (int insertionLevel = level;;) {\n              // è·å–å¤´ç´¢å¼•çš„å±‚æ•°ï¼Œæƒ…å†µ 1 æ˜¯ 3ï¼Œæƒ…å†µ 2 æ˜¯ 4\n              int j = h.level;\n              // ã€éå† insertionLevel å±‚çš„ç´¢å¼•ï¼Œæ‰¾åˆ°åˆé€‚çš„æ’å…¥ä½ç½®ã€‘\n              for (Index<K,V> q = h, r = q.right, t = idx;;) {\n                  // å¦‚æœå¤´ç´¢å¼•ä¸º null æˆ–è€…æ–°å¢èŠ‚ç‚¹ç´¢å¼•ä¸º nullï¼Œé€€å‡ºæ’å…¥ç´¢å¼•çš„æ€»å¾ªç¯\n                  if (q == null || t == null)\n                      // æ­¤å¤„è¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹åˆ é™¤äº†å¤´ç´¢å¼•æˆ–è€…æ–°å¢èŠ‚ç‚¹çš„ç´¢å¼•\n                      break splice;\n                  // å¤´ç´¢å¼•çš„é“¾è¡¨åç»­ç´¢å¼•å­˜åœ¨ï¼Œå¦‚æœæ˜¯æ–°å±‚åˆ™ä¸ºæ–°èŠ‚ç‚¹ç´¢å¼•ï¼Œå¦‚æœæ˜¯è€å±‚åˆ™ä¸ºåŸç´¢å¼•\n                  if (r != null) {\n                      // è·å–rçš„èŠ‚ç‚¹\n                      Node<K,V> n = r.node;\n                      // æ’å…¥çš„keyå’Œn.keyçš„æ¯”è¾ƒå€¼\n                      int c = cpr(cmp, key, n.key);\n                      // ã€åˆ é™¤ç©ºå€¼ç´¢å¼•ã€‘\n                      if (n.value == null) {\n                          if (!q.unlink(r))\n                              break;\n                          r = q.right;\n                          continue;\n                      }\n                      // key > r.node.keyï¼Œå‘å³æ‰«æ\n                      if (c > 0) {\n                          q = r;\n                          r = r.right;\n                          continue;\n                      }\n                  }\n                  // æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ key < r.node.keyï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ j å±‚æ’å…¥æ–°å¢èŠ‚ç‚¹çš„å‰ç½®ç´¢å¼•\n                  if (j == insertionLevel) {\n                      // ã€å°†æ–°ç´¢å¼•èŠ‚ç‚¹ t æ’å…¥ q r ä¹‹é—´ã€‘\n                      if (!q.link(r, t))\n                          break; \n                      // å¦‚æœæ–°å¢èŠ‚ç‚¹çš„å€¼ä¸º nullï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹å·²ç»è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤\n                      if (t.node.value == null) {\n                          // æ‰¾åˆ°è¯¥èŠ‚ç‚¹\n                          findNode(key);\n                          break splice;\n                      }\n                      // æ’å…¥å±‚é€å±‚è‡ªå‡ï¼Œå½“ä¸ºæœ€åº•å±‚æ—¶é€€å‡ºå¾ªç¯\n                      if (--insertionLevel == 0)\n                          break splice;\n                  }\n  \t\t\t\t// å…¶ä»–èŠ‚ç‚¹éšç€æ’å…¥èŠ‚ç‚¹çš„å±‚æ•°ä¸‹ç§»è€Œä¸‹ç§»\n                  if (--j >= insertionLevel && j < level)\n                      t = t.down;\n                  q = q.down;\n                  r = q.right;\n              }\n          }\n      }\n      return null;\n  }\n  ```\n\n* findNode()\n\n  ```java\n  private Node<K,V> findNode(Object key) {\n      // åŸç†ä¸doGetç›¸åŒï¼Œæ— éæ˜¯ findNode è¿”å›èŠ‚ç‚¹ï¼ŒdoGet è¿”å› value\n      if ((c = cpr(cmp, key, n.key)) == 0)\n          return n;\n  }\n  ```\n\n\n\n\n***\n\n\n\n##### è·å–æ–¹æ³•\n\n* get(key)ï¼šè·å–å¯¹åº”çš„æ•°æ®\n\n  ```java\n  public V get(Object key) {\n      return doGet(key);\n  }\n  ```\n  \n* doGet()ï¼šæ‰«æè¿‡ç¨‹ä¼šå¯¹å·² value = null çš„å…ƒç´ è¿›è¡Œåˆ é™¤å¤„ç†\n\n  ```java\n  private V doGet(Object key) {\n      if (key == null)\n          throw new NullPointerException();\n      Comparator<? super K> cmp = comparator;\n      outer: for (;;) {\n          // 1.æ‰¾åˆ°æœ€åº•å±‚èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹\n          for (Node<K,V> b = findPredecessor(key, cmp), n = b.next;;) {\n              Object v; int c;\n              // 2.ã€å¦‚æœè¯¥å‰ç½®èŠ‚ç‚¹çš„é“¾è¡¨åç»­èŠ‚ç‚¹ä¸º nullï¼Œè¯´æ˜ä¸å­˜åœ¨è¯¥èŠ‚ç‚¹ã€‘\n              if (n == null)\n                  break outer;\n              // b â†’ n â†’ f\n              Node<K,V> f = n.next;\n              // 3.å¦‚æœnä¸ä¸ºå‰ç½®èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå·²ç»æœ‰å…¶ä»–çº¿ç¨‹åˆ é™¤äº†è¯¥èŠ‚ç‚¹\n              if (n != b.next) \n                  break;\n              // 4.å¦‚æœåç»­èŠ‚ç‚¹çš„å€¼ä¸ºnullï¼Œã€éœ€è¦å¸®åŠ©åˆ é™¤è¯¥èŠ‚ç‚¹ã€‘\n              if ((v = n.value) == null) {\n                  n.helpDelete(b, f);\n                  break;\n              }\n              // 5.å¦‚æœå‰ç½®èŠ‚ç‚¹å·²è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤ï¼Œé‡æ–°å¾ªç¯\n              if (b.value == null || v == n)\n                  break;\n               // 6.å¦‚æœè¦è·å–çš„keyä¸åç»­èŠ‚ç‚¹çš„keyç›¸ç­‰ï¼Œè¿”å›èŠ‚ç‚¹çš„value\n              if ((c = cpr(cmp, key, n.key)) == 0) {\n                  @SuppressWarnings(\"unchecked\") V vv = (V)v;\n                  return vv;\n              }\n              // 7.key < n.keyï¼Œå› ä½ key > b.keyï¼Œb å’Œ n ç›¸è¿ï¼Œè¯´æ˜ä¸å­˜åœ¨è¯¥èŠ‚ç‚¹æˆ–è€…è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤äº†\n              if (c < 0)\n                  break outer;\n              b = n;\n              n = f;\n          }\n      }\n      return null;\n  }\n  ```\n\n  \n\n****\n\n\n\n##### åˆ é™¤æ–¹æ³•\n\n* remove()\n\n  ```java\n  public V remove(Object key) {\n      return doRemove(key, null);\n  }\n  final V doRemove(Object key, Object value) {\n      if (key == null)\n          throw new NullPointerException();\n      Comparator<? super K> cmp = comparator;\n      outer: for (;;) {\n          // 1.æ‰¾åˆ°æœ€åº•å±‚ç›®æ ‡èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ï¼Œb.key < key\n          for (Node<K,V> b = findPredecessor(key, cmp), n = b.next;;) {\n              Object v; int c;\n              // 2.å¦‚æœè¯¥å‰ç½®èŠ‚ç‚¹çš„é“¾è¡¨åç»­èŠ‚ç‚¹ä¸º nullï¼Œé€€å‡ºå¾ªç¯ï¼Œè¯´æ˜ä¸å­˜åœ¨è¿™ä¸ªå…ƒç´ \n              if (n == null)\n                  break outer;\n              // b â†’ n â†’ f\n              Node<K,V> f = n.next;\n              if (n != b.next)                    // inconsistent read\n                  break;\n              if ((v = n.value) == null) {        // n is deleted\n                  n.helpDelete(b, f);\n                  break;\n              }\n              if (b.value == null || v == n)      // b is deleted\n                  break;\n              //3.key < n.keyï¼Œè¯´æ˜è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤äº†ï¼Œæˆ–è€…ä¸å­˜åœ¨è¯¥èŠ‚ç‚¹\n              if ((c = cpr(cmp, key, n.key)) < 0)\n                  break outer;\n              //4.key > n.keyï¼Œç»§ç»­å‘åæ‰«æ\n              if (c > 0) {\n                  b = n;\n                  n = f;\n                  continue;\n              }\n              //5.åˆ°è¿™é‡Œæ˜¯ key = n.keyï¼Œvalue ä¸ä¸ºç©ºçš„æƒ…å†µä¸‹åˆ¤æ–­ value å’Œ n.value æ˜¯å¦ç›¸ç­‰\n              if (value != null && !value.equals(v))\n                  break outer;\n              //6.ã€æŠŠ n èŠ‚ç‚¹çš„ value ç½®ç©ºã€‘\n              if (!n.casValue(v, null))\n                  break;\n              //7.ã€ç»™ n æ·»åŠ ä¸€ä¸ªåˆ é™¤æ ‡å¿— markã€‘ï¼Œmark.next = fï¼Œç„¶åæŠŠ b.next è®¾ç½®ä¸º fï¼ŒæˆåŠŸånå‡ºé˜Ÿ\n              if (!n.appendMarker(f) || !b.casNext(n, f))\n                  // å¯¹ key å¯¹åº”çš„ index è¿›è¡Œåˆ é™¤ï¼Œè°ƒç”¨äº† findPredecessor æ–¹æ³•\n                  findNode(key);\n              else {\n                  // è¿›è¡Œæ“ä½œå¤±è´¥åé€šè¿‡ findPredecessor ä¸­è¿›è¡Œ index çš„åˆ é™¤\n                  findPredecessor(key, cmp);\n                  if (head.right == null)\n                      // è¿›è¡ŒheadIndex å¯¹åº”çš„index å±‚çš„åˆ é™¤\n                      tryReduceLevel();\n              }\n              @SuppressWarnings(\"unchecked\") V vv = (V)v;\n              return vv;\n          }\n      }\n      return null;\n  }\n  ```\n\n  ç»è¿‡ findPredecessor() ä¸­çš„ unlink() åç´¢å¼•å·²ç»è¢«åˆ é™¤\n\n  ![image-20230824175621276](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824175621276.png)\n\n* appendMarker()ï¼šæ·»åŠ åˆ é™¤æ ‡è®°èŠ‚ç‚¹\n\n  ```java\n  boolean appendMarker(Node<K,V> f) {\n      // é€šè¿‡ CAS è®© n.next æŒ‡å‘ä¸€ä¸ª key ä¸º nullï¼Œvalue ä¸º thisï¼Œnext ä¸º f çš„æ ‡è®°èŠ‚ç‚¹\n      return casNext(f, new Node<K,V>(f));\n  }\n  ```\n  \n* helpDelete()ï¼šå°†æ·»åŠ äº†åˆ é™¤æ ‡è®°çš„èŠ‚ç‚¹æ¸…é™¤ï¼Œå‚æ•°æ˜¯è¯¥èŠ‚ç‚¹çš„å‰é©±å’Œåç»§èŠ‚ç‚¹\n\n  ```java\n  void helpDelete(Node<K,V> b, Node<K,V> f) {\n      // this èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹ä¸º fï¼Œä¸”æœ¬èº«ä¸º b çš„åç»­èŠ‚ç‚¹ï¼Œä¸€èˆ¬éƒ½æ˜¯æ­£ç¡®çš„ï¼Œé™¤éè¢«åˆ«çš„çº¿ç¨‹åˆ é™¤\n      if (f == next && this == b.next) {\n          // å¦‚æœ n è¿˜è¿˜æ²¡æœ‰è¢«æ ‡è®°\n          if (f == null || f.value != f) \n              casNext(f, new Node<K,V>(f));\n          else\n              // é€šè¿‡ CASï¼Œå°† b çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ n å˜æˆ f.nextï¼Œå³æˆä¸ºå›¾ä¸­çš„æ ·å¼\n              b.casNext(this, f.next);\n      }\n  }\n  ```\n  \n* tryReduceLevel()ï¼šåˆ é™¤ç´¢å¼•\n\n  ```java\n  private void tryReduceLevel() {\n      HeadIndex<K,V> h = head;\n      HeadIndex<K,V> d;\n      HeadIndex<K,V> e;\n      if (h.level > 3 &&\n          (d = (HeadIndex<K,V>)h.down) != null &&\n          (e = (HeadIndex<K,V>)d.down) != null &&\n          e.right == null &&\n          d.right == null &&\n          h.right == null &&\n          // è®¾ç½®å¤´ç´¢å¼•\n          casHead(h, d) && \n          // é‡æ–°æ£€æŸ¥\n          h.right != null) \n          // é‡æ–°æ£€æŸ¥è¿”å›trueï¼Œè¯´æ˜å…¶ä»–çº¿ç¨‹å¢åŠ äº†ç´¢å¼•å±‚çº§ï¼ŒæŠŠç´¢å¼•å¤´èŠ‚ç‚¹è®¾ç½®å›æ¥\n          casHead(d, h);   \n  }\n  ```\n\n\n\nå‚è€ƒæ–‡ç« ï¼šhttps://my.oschina.net/u/3768341/blog/3135659\n\nå‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1Er4y1P7k1\n\n\n\n\n\n***\n\n\n\n### NoBlocking\n\n#### éé˜»å¡é˜Ÿåˆ—\n\nå¹¶å‘ç¼–ç¨‹ä¸­ï¼Œéœ€è¦ç”¨åˆ°å®‰å…¨çš„é˜Ÿåˆ—ï¼Œå®ç°å®‰å…¨é˜Ÿåˆ—å¯ä»¥ä½¿ç”¨ 2 ç§æ–¹å¼ï¼š\n\n* åŠ é”ï¼Œè¿™ç§å®ç°æ–¹å¼æ˜¯é˜»å¡é˜Ÿåˆ—\n* ä½¿ç”¨å¾ªç¯ CAS ç®—æ³•å®ç°ï¼Œè¿™ç§æ–¹å¼æ˜¯éé˜»å¡é˜Ÿåˆ—\n\nConcurrentLinkedQueue æ˜¯ä¸€ä¸ªåŸºäºé“¾æ¥èŠ‚ç‚¹çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œé‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„è§„åˆ™å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œå½“æ·»åŠ ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šæ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå½“è·å–ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šè¿”å›é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ \n\nè¡¥å……ï¼šConcurrentLinkedDeque æ˜¯åŒå‘é“¾è¡¨ç»“æ„çš„æ— ç•Œå¹¶å‘é˜Ÿåˆ—\n\nConcurrentLinkedQueue ä½¿ç”¨çº¦å®šï¼š\n\n1. ä¸å…è®¸ null å…¥åˆ—\n2. é˜Ÿåˆ—ä¸­æ‰€æœ‰æœªåˆ é™¤çš„èŠ‚ç‚¹çš„ item éƒ½ä¸èƒ½ä¸º null ä¸”éƒ½èƒ½ä» head èŠ‚ç‚¹éå†åˆ°\n3. åˆ é™¤èŠ‚ç‚¹æ˜¯å°† item è®¾ç½®ä¸º nullï¼Œé˜Ÿåˆ—è¿­ä»£æ—¶è·³è¿‡ item ä¸º null èŠ‚ç‚¹\n4. head èŠ‚ç‚¹è·Ÿ tail ä¸ä¸€å®šæŒ‡å‘å¤´èŠ‚ç‚¹æˆ–å°¾èŠ‚ç‚¹ï¼Œå¯èƒ½**å­˜åœ¨æ»åæ€§**\n\nConcurrentLinkedQueue ç”± head èŠ‚ç‚¹å’Œ tail èŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ç”±èŠ‚ç‚¹å…ƒç´ å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ç»„æˆï¼Œç»„æˆä¸€å¼ é“¾è¡¨ç»“æ„çš„é˜Ÿåˆ—\n\n```java\nprivate transient volatile Node<E> head;\nprivate transient volatile Node<E> tail;\n\nprivate static class Node<E> {\n    volatile E item;\n    volatile Node<E> next;\n    //.....\n}\n```\n\n\n\n***\n\n\n\n#### æ„é€ æ–¹æ³•\n\n* æ— å‚æ„é€ æ–¹æ³•ï¼š\n\n  ```java\n  public ConcurrentLinkedQueue() {\n      // é»˜è®¤æƒ…å†µä¸‹ head èŠ‚ç‚¹å­˜å‚¨çš„å…ƒç´ ä¸ºç©ºï¼Œdummy èŠ‚ç‚¹ï¼Œtail èŠ‚ç‚¹ç­‰äº head èŠ‚ç‚¹\n      head = tail = new Node<E>(null);\n  }\n  ```\n\n* æœ‰å‚æ„é€ æ–¹æ³•\n\n  ```java\n  public ConcurrentLinkedQueue(Collection<? extends E> c) {\n      Node<E> h = null, t = null;\n      // éå†èŠ‚ç‚¹\n      for (E e : c) {\n          checkNotNull(e);\n          Node<E> newNode = new Node<E>(e);\n          if (h == null)\n              h = t = newNode;\n          else {\n              // å•å‘é“¾è¡¨\n              t.lazySetNext(newNode);\n              t = newNode;\n          }\n      }\n      if (h == null)\n          h = t = new Node<E>(null);\n      head = h;\n      tail = t;\n  }\n  ```\n\n\n\n***\n\n\n\n#### å…¥é˜Ÿæ–¹æ³•\n\nä¸ä¼ ç»Ÿçš„é“¾è¡¨ä¸åŒï¼Œå•çº¿ç¨‹å…¥é˜Ÿçš„å·¥ä½œæµç¨‹ï¼š\n\n* å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆå½“å‰é˜Ÿåˆ—å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n* æ›´æ–° tail èŠ‚ç‚¹ï¼Œå¦‚æœ tail èŠ‚ç‚¹çš„ next èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆ tail èŠ‚ç‚¹ï¼›å¦‚æœ tail èŠ‚ç‚¹çš„ next èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆ tail çš„ next èŠ‚ç‚¹ï¼Œæ‰€ä»¥ tail èŠ‚ç‚¹ä¸æ€»æ˜¯å°¾èŠ‚ç‚¹ï¼Œ**å­˜åœ¨æ»åæ€§**\n\n```java\npublic boolean offer(E e) {\n    checkNotNull(e);\n    // åˆ›å»ºå…¥é˜ŸèŠ‚ç‚¹\n    final Node<E> newNode = new Node<E>(e);\n\t\n    // å¾ªç¯ CAS ç›´åˆ°å…¥é˜ŸæˆåŠŸ\n    for (Node<E> t = tail, p = t;;) {\n        // p ç”¨æ¥è¡¨ç¤ºé˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼Œåˆå§‹æƒ…å†µä¸‹ç­‰äº tail èŠ‚ç‚¹ï¼Œq æ˜¯ p çš„ next èŠ‚ç‚¹\n        Node<E> q = p.next;\n        // æ¡ä»¶æˆç«‹è¯´æ˜ p æ˜¯å°¾èŠ‚ç‚¹\n        if (q == null) {\n            // p æ˜¯å°¾èŠ‚ç‚¹ï¼Œè®¾ç½® p èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹\n            // è®¾ç½®æˆåŠŸåˆ™ casNext è¿”å› trueï¼Œå¦åˆ™è¿”å› falseï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹æ›´æ–°è¿‡å°¾èŠ‚ç‚¹ï¼Œç»§ç»­å¯»æ‰¾å°¾èŠ‚ç‚¹ï¼Œç»§ç»­ CAS\n            if (p.casNext(null, newNode)) {\n                // é¦–æ¬¡æ·»åŠ æ—¶ï¼Œp ç­‰äº tï¼Œä¸è¿›è¡Œå°¾èŠ‚ç‚¹æ›´æ–°ï¼Œæ‰€ä»¥å°¾èŠ‚ç‚¹å­˜åœ¨æ»åæ€§\n                if (p != t)\n                    // å°† tail è®¾ç½®æˆæ–°å…¥é˜Ÿçš„èŠ‚ç‚¹ï¼Œè®¾ç½®å¤±è´¥è¡¨ç¤ºå…¶ä»–çº¿ç¨‹æ›´æ–°äº† tail èŠ‚ç‚¹\n                    casTail(t, newNode); \n                return true;\n            }\n        }\n        else if (p == q)\n            // å½“ tail ä¸æŒ‡å‘æœ€åèŠ‚ç‚¹æ—¶ï¼Œå¦‚æœæ‰§è¡Œå‡ºåˆ—æ“ä½œï¼Œå¯èƒ½å°† tail ä¹Ÿç§»é™¤ï¼Œtail ä¸åœ¨é“¾è¡¨ä¸­ \n        \t// æ­¤æ—¶éœ€è¦å¯¹ tail èŠ‚ç‚¹è¿›è¡Œå¤ä½ï¼Œå¤ä½åˆ° head èŠ‚ç‚¹\n            p = (t != (t = tail)) ? t : head;\n        else\n            // æ¨åŠ¨ tail å°¾èŠ‚ç‚¹å¾€é˜Ÿå°¾ç§»åŠ¨\n            p = (p != t && t != (t = tail)) ? t : q;\n    }\n}\n```\n\nå›¾è§£å…¥é˜Ÿï¼š\n\n![image-20230824175705470](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824175705470.png)\n\n![image-20230824175745374](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824175745374.png)\n\n![image-20230824175937960](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824175937960.png)\n\nå½“ tail èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹çš„è·ç¦»**å¤§äºç­‰äº 1** æ—¶ï¼ˆæ¯å…¥é˜Ÿä¸¤æ¬¡ï¼‰æ›´æ–° tailï¼Œå¯ä»¥å‡å°‘ CAS æ›´æ–° tail èŠ‚ç‚¹çš„æ¬¡æ•°ï¼Œæé«˜å…¥é˜Ÿæ•ˆç‡\n\nçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š\n\n* çº¿ç¨‹ 1 çº¿ç¨‹ 2 åŒæ—¶å…¥é˜Ÿï¼Œæ— è®ºä»å“ªä¸ªä½ç½®å¼€å§‹å¹¶å‘å…¥é˜Ÿï¼Œéƒ½å¯ä»¥å¾ªç¯ CASï¼Œç›´åˆ°å…¥é˜ŸæˆåŠŸï¼Œçº¿ç¨‹å®‰å…¨\n* çº¿ç¨‹ 1 éå†ï¼Œçº¿ç¨‹ 2 å…¥é˜Ÿï¼Œæ‰€ä»¥é€ æˆ ConcurrentLinkedQueue çš„ size æ˜¯å˜åŒ–ï¼Œéœ€è¦åŠ é”ä¿è¯å®‰å…¨\n* çº¿ç¨‹ 1 çº¿ç¨‹ 2 åŒæ—¶å‡ºåˆ—ï¼Œçº¿ç¨‹ä¹Ÿæ˜¯å®‰å…¨çš„\n\n\n\n***\n\n\n\n#### å‡ºé˜Ÿæ–¹æ³•\n\nå‡ºé˜Ÿåˆ—çš„å°±æ˜¯ä»é˜Ÿåˆ—é‡Œè¿”å›ä¸€ä¸ªèŠ‚ç‚¹å…ƒç´ ï¼Œå¹¶æ¸…ç©ºè¯¥èŠ‚ç‚¹å¯¹å…ƒç´ çš„å¼•ç”¨ï¼Œå¹¶ä¸æ˜¯æ¯æ¬¡å‡ºé˜Ÿéƒ½æ›´æ–° head èŠ‚ç‚¹\n\n* å½“ head èŠ‚ç‚¹é‡Œæœ‰å…ƒç´ æ—¶ï¼Œç›´æ¥å¼¹å‡º head èŠ‚ç‚¹é‡Œçš„å…ƒç´ ï¼Œè€Œä¸ä¼šæ›´æ–° head èŠ‚ç‚¹\n* å½“ head èŠ‚ç‚¹é‡Œæ²¡æœ‰å…ƒç´ æ—¶ï¼Œå‡ºé˜Ÿæ“ä½œæ‰ä¼šæ›´æ–° head èŠ‚ç‚¹\n\n**æ‰¹å¤„ç†æ–¹å¼**å¯ä»¥å‡å°‘ä½¿ç”¨ CAS æ›´æ–° head èŠ‚ç‚¹çš„æ¶ˆè€—ï¼Œä»è€Œæé«˜å‡ºé˜Ÿæ•ˆç‡\n\n```java\npublic E poll() {\n    restartFromHead:\n    for (;;) {\n        // p èŠ‚ç‚¹è¡¨ç¤ºé¦–èŠ‚ç‚¹ï¼Œå³éœ€è¦å‡ºé˜Ÿçš„èŠ‚ç‚¹ï¼ŒFIFO\n        for (Node<E> h = head, p = h, q;;) {\n            E item = p.item;\n\t\t\t// å¦‚æœ p èŠ‚ç‚¹çš„å…ƒç´ ä¸ä¸º nullï¼Œåˆ™é€šè¿‡ CAS æ¥è®¾ç½® p èŠ‚ç‚¹å¼•ç”¨å…ƒç´ ä¸º nullï¼ŒæˆåŠŸè¿”å› item\n            if (item != null && p.casItem(item, null)) {\n                if (p != h)\t\n                   \t// å¯¹ head è¿›è¡Œç§»åŠ¨\n                    updateHead(h, ((q = p.next) != null) ? q : p);\n                return item;\n            }\n           \t// é€»è¾‘åˆ°è¿™è¯´æ˜å¤´èŠ‚ç‚¹çš„å…ƒç´ ä¸ºç©ºæˆ–å¤´èŠ‚ç‚¹å‘ç”Ÿäº†å˜åŒ–ï¼Œå¤´èŠ‚ç‚¹è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†\n            // é‚£ä¹ˆè·å– p èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœ p èŠ‚ç‚¹çš„ä¸‹ä¸€èŠ‚ç‚¹ä¹Ÿä¸º nullï¼Œåˆ™è¡¨æ˜é˜Ÿåˆ—å·²ç»ç©ºäº†\n            else if ((q = p.next) == null) {\n                updateHead(h, p);\n                return null;\n            }\n      \t\t// ç¬¬ä¸€è½®æ“ä½œå¤±è´¥ï¼Œä¸‹ä¸€è½®ç»§ç»­ï¼Œè°ƒå›åˆ°å¾ªç¯å‰\n            else if (p == q)\n                continue restartFromHead;\n            // å¦‚æœä¸‹ä¸€ä¸ªå…ƒç´ ä¸ä¸ºç©ºï¼Œåˆ™å°†å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®æˆå¤´èŠ‚ç‚¹\n            else\n                p = q;\n        }\n    }\n}\nfinal void updateHead(Node<E> h, Node<E> p) {\n    if (h != p && casHead(h, p))\n        // å°†æ—§ç»“ç‚¹ h çš„ next åŸŸæŒ‡å‘ä¸º hï¼Œhelp gc\n        h.lazySetNext(h);\n}\n```\n\nåœ¨æ›´æ–°å®Œ head ä¹‹åï¼Œä¼šå°†æ—§çš„å¤´ç»“ç‚¹ h çš„ next åŸŸæŒ‡å‘ä¸º hï¼Œå›¾ä¸­æ‰€ç¤ºçš„è™šçº¿ä¹Ÿå°±è¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹çš„è‡ªå¼•ç”¨ï¼Œè¢«ç§»åŠ¨çš„èŠ‚ç‚¹ï¼ˆitem ä¸º null çš„èŠ‚ç‚¹ï¼‰ä¼šè¢« GC å›æ”¶\n\n![image-20230824180023394](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824180023394.png)\n\n![image-20230824180101118](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824180101118.png)\n\n![image-20230824180122859](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824180122859.png)\n\nå¦‚æœè¿™æ—¶ï¼Œæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥æ·»åŠ å…ƒç´ ï¼Œé€šè¿‡ tail è·å–çš„ next èŠ‚ç‚¹åˆ™ä»ç„¶æ˜¯å®ƒæœ¬èº«ï¼Œè¿™å°±å‡ºç°äº†p == q çš„æƒ…å†µï¼Œå‡ºç°è¯¥ç§æƒ…å†µä¹‹åï¼Œåˆ™ä¼šè§¦å‘æ‰§è¡Œ head çš„æ›´æ–°ï¼Œå°† p èŠ‚ç‚¹é‡æ–°æŒ‡å‘ä¸º head\n\n\n\nå‚è€ƒæ–‡ç« ï¼šhttps://www.jianshu.com/p/231caf90f30b\n\n\n\n***\n\n\n\n#### æˆå‘˜æ–¹æ³•\n\n* peek()ï¼šä¼šæ”¹å˜ head æŒ‡å‘ï¼Œæ‰§è¡Œ peek() æ–¹æ³•å head ä¼šæŒ‡å‘ç¬¬ä¸€ä¸ªå…·æœ‰éç©ºå…ƒç´ çš„èŠ‚ç‚¹\n\n  ```java\n  // è·å–é“¾è¡¨çš„é¦–éƒ¨å…ƒç´ ï¼Œåªè¯»å–è€Œä¸ç§»é™¤\n  public E peek() {\n      restartFromHead:\n      for (;;) {\n          for (Node<E> h = head, p = h, q;;) {\n              E item = p.item;\n              if (item != null || (q = p.next) == null) {\n                  // æ›´æ”¹hçš„ä½ç½®ä¸ºéç©ºå…ƒç´ èŠ‚ç‚¹\n                  updateHead(h, p);\n                  return item;\n              }\n              else if (p == q)\n                  continue restartFromHead;\n              else\n                  p = q;\n          }\n      }\n  }\n  ```\n  \n* size()ï¼šç”¨æ¥è·å–å½“å‰é˜Ÿåˆ—çš„å…ƒç´ ä¸ªæ•°ï¼Œå› ä¸ºæ•´ä¸ªè¿‡ç¨‹éƒ½æ²¡æœ‰åŠ é”ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸­ä»è°ƒç”¨ size æ–¹æ³•åˆ°è¿”å›ç»“æœæœŸé—´æœ‰å¯èƒ½å¢åˆ å…ƒç´ ï¼Œå¯¼è‡´ç»Ÿè®¡çš„å…ƒç´ ä¸ªæ•°ä¸ç²¾ç¡®\n\n  ```java\n  public int size() {\n      int count = 0;\n      // first() è·å–ç¬¬ä¸€ä¸ªå…·æœ‰éç©ºå…ƒç´ çš„èŠ‚ç‚¹ï¼Œè‹¥ä¸å­˜åœ¨ï¼Œè¿”å› null\n      // succ(p) æ–¹æ³•è·å– p çš„åç»§èŠ‚ç‚¹ï¼Œè‹¥ p == p.nextï¼Œåˆ™è¿”å› head\n      // ç±»ä¼¼éå†é“¾è¡¨\n      for (Node<E> p = first(); p != null; p = succ(p))\n          if (p.item != null)\n              // æœ€å¤§è¿”å›Integer.MAX_VALUE\n              if (++count == Integer.MAX_VALUE)\n                  break;\n      return count;\n  }\n  ```\n  \n* remove()ï¼šç§»é™¤å…ƒç´ \n\n  ```java\n  public boolean remove(Object o) {\n      // åˆ é™¤çš„å…ƒç´ ä¸èƒ½ä¸ºnull\n      if (o != null) {\n          Node<E> next, pred = null;\n          for (Node<E> p = first(); p != null; pred = p, p = next) {\n              boolean removed = false;\n              E item = p.item;\n              // èŠ‚ç‚¹å…ƒç´ ä¸ä¸ºnull\n              if (item != null) {\n                  // è‹¥ä¸åŒ¹é…ï¼Œåˆ™è·å–nextèŠ‚ç‚¹ç»§ç»­åŒ¹é…\n                  if (!o.equals(item)) {\n                      next = succ(p);\n                      continue;\n                  }\n                  // è‹¥åŒ¹é…ï¼Œåˆ™é€šè¿‡ CAS æ“ä½œå°†å¯¹åº”èŠ‚ç‚¹å…ƒç´ ç½®ä¸º null\n                  removed = p.casItem(item, null);\n              }\n              // è·å–åˆ é™¤èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹\n              next = succ(p);\n              // å°†è¢«åˆ é™¤çš„èŠ‚ç‚¹ç§»é™¤é˜Ÿåˆ—\n              if (pred != null && next != null) // unlink\n                  pred.casNext(p, next);\n              if (removed)\n                  return true;\n          }\n      }\n      return false;\n  }\n  ```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"title":"å¹¶å‘ç¼–ç¨‹æ•´ç†ç‰ˆ-æ— é”","tags":["CAS","Atomic","volatile","LongAdder","Unsafe","final","ThreadLocal"],"categories":["Java","å¹¶å‘ç¼–ç¨‹"],"author":"imklaus","excerpt":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n","link":"/posts/Concurrent_Programming-Lock_Free","content":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n<!-- more -->\r\n\r\n## æ— é”\r\n\r\n### CAS\r\n\r\n#### ä¾‹å­\r\n\r\n```java\r\ninterface Account {\r\n\tInteger getBalance();\r\n\r\n\tvoid withdraw(Integer amount);\r\n\r\n\t/**\r\n\t * æ–¹æ³•å†…ä¼šå¯åŠ¨ 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš -10 å…ƒ çš„æ“ä½œ     \r\n\t * å¦‚æœåˆå§‹ä½™é¢ä¸º 10000 é‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”å½“æ˜¯ 0\r\n\t */\r\n\tstatic void demo(Account account) {\r\n\t\tList<Thread> ts = new ArrayList<>();\r\n\t\tlong start = System.nanoTime();\r\n\t\tfor (int i = 0; i < 1000; i++) {\r\n\t\t\tts.add(new Thread(() -> {\r\n\t\t\t\taccount.withdraw(10);\r\n\t\t\t}));\r\n\t\t}\r\n\t\tts.forEach(Thread::start);\r\n\t\tts.forEach(t -> {\r\n\t\t\ttry {\r\n\t\t\t\tt.join();\r\n\t\t\t} catch (InterruptedException e) {\r\n\t\t\t\te.printStackTrace();\r\n\t\t\t}\r\n\t\t});\r\n\t\tlong end = System.nanoTime();\r\n\t\tSystem.out.println(account.getBalance() + \" cost: \" + (end - start) / 1000_000 + \" ms\");\r\n\t}\r\n}\r\n\r\n//çº¿ç¨‹ä¸å®‰å…¨çš„åšæ³•\r\nclass AccountUnsafe implements Account {\r\n\tprivate Integer balance;\r\n\r\n\tpublic AccountUnsafe(Integer balance) {\r\n\t\tthis.balance = balance;\r\n\t}\r\n\r\n\r\n\t@Override\r\n\tpublic Integer getBalance() {\r\n\t\treturn this.balance;\r\n\t}\r\n\r\n\t@Override\r\n\tpublic synchronized void withdraw(Integer amount) {\r\n\t\tbalance -= amount;\r\n\t}\r\n\r\n\tpublic static void main(String[] args) {\r\n\t\tAccount.demo(new AccountUnsafe(10000));\r\n\t\tAccount.demo(new AccountCas(10000));\r\n\t}\r\n}\r\n\r\n//çº¿ç¨‹å®‰å…¨çš„åšæ³•\r\nclass AccountCas implements Account {\r\n\t//ä½¿ç”¨åŸå­æ•´æ•°\r\n\tprivate AtomicInteger balance;\r\n\r\n\tpublic AccountCas(int balance) {\r\n\t\tthis.balance = new AtomicInteger(balance);\r\n\t}\r\n\r\n\t@Override\r\n\tpublic Integer getBalance() {\r\n\t\t//å¾—åˆ°åŸå­æ•´æ•°çš„å€¼\r\n\t\treturn balance.get();\r\n\t}\r\n\r\n\t@Override\r\n\tpublic void withdraw(Integer amount) {\r\n\t\t\t// éœ€è¦ä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢\r\n            while (true) {\r\n            // æ¯”å¦‚æ‹¿åˆ°äº†æ—§å€¼ 1000\r\n            int prev = balance.get();\r\n            // åœ¨è¿™ä¸ªåŸºç¡€ä¸Š 1000-10 = 990\r\n            int next = prev - amount;\r\n            /*\r\n            compareAndSet æ­£æ˜¯åšè¿™ä¸ªæ£€æŸ¥ï¼Œåœ¨ set å‰ï¼Œå…ˆæ¯”è¾ƒ prev ä¸å½“å‰å€¼\r\n            - ä¸ä¸€è‡´äº†ï¼Œnext ä½œåºŸï¼Œè¿”å› false è¡¨ç¤ºå¤±è´¥\r\n            æ¯”å¦‚ï¼Œåˆ«çš„çº¿ç¨‹å·²ç»åšäº†å‡æ³•ï¼Œå½“å‰å€¼å·²ç»è¢«å‡æˆäº† 990\r\n            é‚£ä¹ˆæœ¬çº¿ç¨‹çš„è¿™æ¬¡ 990 å°±ä½œåºŸäº†ï¼Œè¿›å…¥ while ä¸‹æ¬¡å¾ªç¯é‡è¯•\r\n            - ä¸€è‡´ï¼Œä»¥ next è®¾ç½®ä¸ºæ–°å€¼ï¼Œè¿”å› true è¡¨ç¤ºæˆåŠŸ\r\n            */\r\n\t\t\tif(balance.compareAndSet(prev, next)) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n\r\nå‰é¢çœ‹åˆ°çš„ AtomicInteger é€šè¿‡æ— é”è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå†…éƒ¨å¹¶æ²¡æœ‰ç”¨é”æ¥ä¿æŠ¤å…±äº«å˜é‡çš„çº¿ç¨‹å®‰å…¨ã€‚é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿå…¶ä¸­çš„**å…³é”®æ˜¯ compareAndSet**ï¼ˆæ¯”è¾ƒå¹¶è®¾ç½®å€¼ï¼‰ï¼Œå®ƒçš„**ç®€ç§°å°±æ˜¯ CAS** ï¼ˆä¹Ÿæœ‰ Compare And Swap çš„è¯´æ³•ï¼‰ï¼Œå®ƒå¿…é¡»æ˜¯**åŸå­æ“ä½œ**ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145914.png)\r\n\r\n**å·¥ä½œæµç¨‹**\r\n\r\n- å½“ä¸€ä¸ªçº¿ç¨‹è¦å»ä¿®æ”¹Accountå¯¹è±¡ä¸­çš„å€¼æ—¶ï¼Œå…ˆè·å–å€¼preï¼ˆè°ƒç”¨getæ–¹æ³•ï¼‰ï¼Œç„¶åå†å°†å…¶è®¾ç½®ä¸ºæ–°çš„å€¼nextï¼ˆè°ƒç”¨casæ–¹æ³•ï¼‰ã€‚åœ¨è°ƒç”¨casæ–¹æ³•æ—¶ï¼Œä¼šå°†preä¸Accountä¸­çš„ä½™é¢è¿›è¡Œæ¯”è¾ƒã€‚\r\n  - å¦‚æœ**ä¸¤è€…ç›¸ç­‰**ï¼Œå°±è¯´æ˜è¯¥å€¼è¿˜æœªè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œæ­¤æ—¶ä¾¿å¯ä»¥è¿›è¡Œä¿®æ”¹æ“ä½œã€‚\r\n  - å¦‚æœ**ä¸¤è€…ä¸ç›¸ç­‰**ï¼Œå°±ä¸è®¾ç½®å€¼ï¼Œé‡æ–°è·å–å€¼preï¼ˆè°ƒç”¨getæ–¹æ³•ï¼‰ï¼Œç„¶åå†å°†å…¶è®¾ç½®ä¸ºæ–°çš„å€¼nextï¼ˆè°ƒç”¨casæ–¹æ³•ï¼‰ï¼Œç›´åˆ°ä¿®æ”¹æˆåŠŸä¸ºæ­¢ã€‚\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n#### åŸç†\r\n\r\næ— é”ç¼–ç¨‹ï¼šLock Free\r\n\r\nCAS çš„å…¨ç§°æ˜¯ Compare-And-Swapï¼Œæ˜¯ **CPU å¹¶å‘åŸè¯­**\r\n\r\n* CAS å¹¶å‘åŸè¯­ä½“ç°åœ¨ Java è¯­è¨€ä¸­å°±æ˜¯ sun.misc.Unsafe ç±»çš„å„ä¸ªæ–¹æ³•ï¼Œè°ƒç”¨ UnSafe ç±»ä¸­çš„ CAS æ–¹æ³•ï¼ŒJVM ä¼šå®ç°å‡º CAS æ±‡ç¼–æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œå®ç°äº†åŸå­æ“ä½œ\r\n* CAS æ˜¯ä¸€ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»ŸèŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆ ï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œæ‰€ä»¥ CAS æ˜¯ä¸€æ¡ CPU çš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„\r\n\r\nåº•å±‚åŸç†ï¼šCAS çš„åº•å±‚æ˜¯ `lock cmpxchg` æŒ‡ä»¤ï¼ˆX86 æ¶æ„ï¼‰ï¼Œåœ¨å•æ ¸å’Œå¤šæ ¸ CPU ä¸‹éƒ½èƒ½å¤Ÿä¿è¯æ¯”è¾ƒäº¤æ¢çš„åŸå­æ€§\r\n\r\n* ç¨‹åºæ˜¯åœ¨å•æ ¸å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œä¼šçœç•¥ lock å‰ç¼€ï¼Œå•å¤„ç†å™¨è‡ªèº«ä¼šç»´æŠ¤å¤„ç†å™¨å†…çš„é¡ºåºä¸€è‡´æ€§ï¼Œä¸éœ€è¦ lock å‰ç¼€çš„å†…å­˜å±éšœæ•ˆæœ\r\n\r\n* ç¨‹åºæ˜¯åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œä¼šä¸º cmpxchg æŒ‡ä»¤åŠ ä¸Š lock å‰ç¼€ã€‚å½“æŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šæ‰§è¡Œ**æ€»çº¿é”å®šæˆ–ç¼“å­˜é”å®š**ï¼Œå°†ä¿®æ”¹çš„å˜é‡å†™å…¥åˆ°ä¸»å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æœºåˆ¶æ‰€æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„åŸå­æ€§\r\n\r\nä½œç”¨ï¼šæ¯”è¾ƒå½“å‰å·¥ä½œå†…å­˜ä¸­çš„å€¼å’Œä¸»ç‰©ç†å†…å­˜ä¸­çš„å€¼ï¼Œå¦‚æœç›¸åŒåˆ™æ‰§è¡Œè§„å®šæ“ä½œï¼Œå¦åˆ™ç»§ç»­æ¯”è¾ƒç›´åˆ°ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„å€¼ä¸€è‡´ä¸ºæ­¢\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n#### å‰æ\r\n\r\n**CAS å¿…é¡»å€ŸåŠ© volatile** æ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æ–°å€¼æ¥å®ç°ã€æ¯”è¾ƒå¹¶äº¤æ¢ã€‘çš„æ•ˆæœ\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n#### **æ•ˆç‡é«˜**\r\n\r\n- æ— é”æƒ…å†µä¸‹ï¼Œå³ä½¿é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹å§‹ç»ˆåœ¨é«˜é€Ÿè¿è¡Œï¼Œæ²¡æœ‰åœæ­‡ï¼Œè€Œ synchronized ä¼šè®©çº¿ç¨‹åœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶å€™ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡ã€‚\r\n- æ‰“ä¸ªæ¯”å–»ï¼Œçº¿ç¨‹å°±å¥½åƒé«˜é€Ÿè·‘é“ä¸Šçš„èµ›è½¦ï¼Œé«˜é€Ÿè¿è¡Œæ—¶ï¼Œé€Ÿåº¦è¶…å¿«ï¼Œä¸€æ—¦å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°±å¥½æ¯”èµ›è½¦è¦å‡é€Ÿã€ç†„ç«ï¼Œç­‰è¢«å”¤é†’åˆå¾—é‡æ–°æ‰“ç«ã€å¯åŠ¨ã€åŠ é€Ÿ... æ¢å¤åˆ°é«˜é€Ÿè¿è¡Œï¼Œä»£ä»·æ¯”è¾ƒå¤§\r\n- ä½†æ— é”æƒ…å†µä¸‹ï¼Œå› ä¸ºçº¿ç¨‹è¦ä¿æŒè¿è¡Œï¼Œéœ€è¦é¢å¤– CPU çš„æ”¯æŒï¼ŒCPU åœ¨è¿™é‡Œå°±å¥½æ¯”é«˜é€Ÿè·‘é“ï¼Œæ²¡æœ‰é¢å¤–çš„è·‘é“ï¼Œçº¿ç¨‹æƒ³é«˜é€Ÿè¿è¡Œä¹Ÿæ— ä»è°ˆèµ·ï¼Œè™½ç„¶ä¸ä¼šè¿›å…¥é˜»å¡ï¼Œä½†ç”±äºæ²¡æœ‰åˆ†åˆ°æ—¶é—´ç‰‡ï¼Œä»ç„¶ä¼šè¿›å…¥ä¸å¯è¿è¡ŒçŠ¶æ€ï¼Œè¿˜æ˜¯ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ï¼ˆè¶…è¿‡äº†CPUæ ¸å¿ƒæ•°ä¹Ÿå°±æ²¡æœ‰äº†é¢å¤–çš„è·‘é“äº†ï¼Œè¿è¡Œä¹Ÿè¿è¡Œä¸äº†ï¼Œåªèƒ½ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ‰€ä»¥**åœ¨çº¿ç¨‹æ•°å°äºCPUæ ¸å¿ƒæ•°æ—¶ç”¨CASæ˜¯éå¸¸åˆé€‚çš„**ï¼‰\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n#### ä¼˜ç¼ºç‚¹\r\n\r\nCAS ç‰¹ç‚¹:\r\n\r\n* CAS ä½“ç°çš„æ˜¯**æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘**ï¼Œçº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œçº¿ç¨‹ä¸éœ€è¦é¢‘ç¹åˆ‡æ¢çŠ¶æ€ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç³»ç»Ÿè°ƒç”¨ï¼‰\r\n* CAS æ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³\r\n\r\nCAS ç¼ºç‚¹ï¼š\r\n\r\n- æ‰§è¡Œçš„æ˜¯å¾ªç¯æ“ä½œï¼Œå¦‚æœæ¯”è¾ƒä¸æˆåŠŸä¸€ç›´åœ¨å¾ªç¯ï¼Œæœ€å·®çš„æƒ…å†µæŸä¸ªçº¿ç¨‹ä¸€ç›´å–åˆ°çš„å€¼å’Œé¢„æœŸå€¼éƒ½ä¸ä¸€æ ·ï¼Œå°±ä¼šæ— é™å¾ªç¯å¯¼è‡´é¥¥é¥¿ï¼Œ**ä½¿ç”¨ CAS çº¿ç¨‹æ•°ä¸è¦è¶…è¿‡ CPU çš„æ ¸å¿ƒæ•°**ï¼Œé‡‡ç”¨åˆ†æ®µ CAS å’Œè‡ªåŠ¨è¿ç§»æœºåˆ¶\r\n- åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ\r\n  - å¯¹äºä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œå¯ä»¥é€šè¿‡å¾ªç¯ CAS çš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œ\r\n  - å¯¹äºå¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯ CAS å°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™**åªèƒ½ç”¨é”æ¥ä¿è¯åŸå­æ€§**\r\n- å¼•å‡ºæ¥ ABA é—®é¢˜\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä¹è§‚é”\r\n\r\nCAS ä¸ synchronized æ€»ç»“ï¼š\r\n\r\n* synchronized æ˜¯ä»æ‚²è§‚çš„è§’åº¦å‡ºå‘ï¼šæ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼šé˜»å¡ï¼ˆå…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹ï¼‰ï¼Œå› æ­¤ synchronized ä¹Ÿç§°ä¹‹ä¸ºæ‚²è§‚é”ï¼ŒReentrantLock ä¹Ÿæ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œæ€§èƒ½è¾ƒå·®\r\n* CAS æ˜¯ä»ä¹è§‚çš„è§’åº¦å‡ºå‘ï¼šæ€»æ˜¯å‡è®¾æœ€å¥½çš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ®ã€‚**å¦‚æœåˆ«äººä¿®æ”¹è¿‡ï¼Œåˆ™è·å–ç°åœ¨æœ€æ–°çš„å€¼ï¼Œå¦‚æœåˆ«äººæ²¡ä¿®æ”¹è¿‡ï¼Œç›´æ¥ä¿®æ”¹å…±äº«æ•°æ®çš„å€¼**ï¼ŒCAS è¿™ç§æœºåˆ¶ä¹Ÿç§°ä¹‹ä¸ºä¹è§‚é”ï¼Œç»¼åˆæ€§èƒ½è¾ƒå¥½\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### Atomic\r\n\r\n#### å¸¸ç”¨API\r\n\r\nå¸¸è§åŸå­ç±»ï¼šAtomicIntegerã€AtomicBooleanã€AtomicLong\r\n\r\næ„é€ æ–¹æ³•ï¼š\r\n\r\n* `public AtomicInteger()`ï¼šåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤å€¼ä¸º 0 çš„åŸå­å‹ Integer\r\n* `public AtomicInteger(int initialValue)`ï¼šåˆå§‹åŒ–ä¸€ä¸ªæŒ‡å®šå€¼çš„åŸå­å‹ Integer\r\n\r\nå¸¸ç”¨APIï¼š\r\n\r\n| æ–¹æ³•                                  | ä½œç”¨                                                         |\r\n| ------------------------------------- | ------------------------------------------------------------ |\r\n| public final int get()                | è·å– AtomicInteger çš„å€¼                                      |\r\n| public final int getAndIncrement()    | ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ  1ï¼Œè¿”å›çš„æ˜¯è‡ªå¢å‰çš„å€¼                   |\r\n| public final int incrementAndGet()    | ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ  1ï¼Œè¿”å›çš„æ˜¯è‡ªå¢åçš„å€¼                   |\r\n| public final int getAndSet(int value) | ä»¥åŸå­æ–¹å¼è®¾ç½®ä¸º newValue çš„å€¼ï¼Œè¿”å›æ—§å€¼                     |\r\n| public final int addAndGet(int data)  | ä»¥åŸå­æ–¹å¼å°†è¾“å…¥çš„æ•°å€¼ä¸å®ä¾‹ä¸­çš„å€¼ç›¸åŠ å¹¶è¿”å›<br />å®ä¾‹ï¼šAtomicInteger é‡Œçš„ value |\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åŸç†åˆ†æ\r\n\r\n**AtomicInteger åŸç†**ï¼šè‡ªæ—‹é”  + CAS ç®—æ³•\r\n\r\nCAS ç®—æ³•ï¼šæœ‰ 3 ä¸ªæ“ä½œæ•°ï¼ˆå†…å­˜å€¼ Vï¼Œ æ—§çš„é¢„æœŸå€¼ Aï¼Œè¦ä¿®æ”¹çš„å€¼ Bï¼‰\r\n\r\n* å½“æ—§çš„é¢„æœŸå€¼ A == å†…å­˜å€¼ V   æ­¤æ—¶å¯ä»¥ä¿®æ”¹ï¼Œå°† V æ”¹ä¸º B\r\n* å½“æ—§çš„é¢„æœŸå€¼ A !=  å†…å­˜å€¼ V   æ­¤æ—¶ä¸èƒ½ä¿®æ”¹ï¼Œå¹¶é‡æ–°è·å–ç°åœ¨çš„æœ€æ–°å€¼ï¼Œé‡æ–°è·å–çš„åŠ¨ä½œå°±æ˜¯è‡ªæ—‹ \r\n\r\nåˆ†æ getAndSet æ–¹æ³•ï¼š\r\n\r\n* AtomicIntegerï¼š\r\n\r\n  ```java\r\n  public final int getAndSet(int newValue) {\r\n      /**\r\n      * this: \t\tå½“å‰å¯¹è±¡\r\n      * valueOffset:\tå†…å­˜åç§»é‡ï¼Œå†…å­˜åœ°å€\r\n      */\r\n      return unsafe.getAndSetInt(this, valueOffset, newValue);\r\n  }\r\n  ```\r\n\r\n  valueOffsetï¼šåç§»é‡è¡¨ç¤ºè¯¥å˜é‡å€¼ç›¸å¯¹äºå½“å‰å¯¹è±¡åœ°å€çš„åç§»ï¼ŒUnsafe å°±æ˜¯æ ¹æ®å†…å­˜åç§»åœ°å€è·å–æ•°æ®\r\n\r\n  ```java\r\n  valueOffset = unsafe.objectFieldOffset\r\n                  (AtomicInteger.class.getDeclaredField(\"value\"));\r\n  //è°ƒç”¨æœ¬åœ°æ–¹æ³•   -->\r\n  public native long objectFieldOffset(Field var1);\r\n  ```\r\n\r\n* unsafe ç±»ï¼š\r\n\r\n  ```java\r\n  // val1: AtomicIntegerå¯¹è±¡æœ¬èº«ï¼Œvar2: è¯¥å¯¹è±¡å€¼å¾—å¼•ç”¨åœ°å€ï¼Œvar4: éœ€è¦å˜åŠ¨çš„æ•°\r\n  public final int getAndSetInt(Object var1, long var2, int var4) {\r\n      int var5;\r\n      do {\r\n          // var5: ç”¨ var1 å’Œ var2 æ‰¾åˆ°çš„å†…å­˜ä¸­çš„çœŸå®å€¼\r\n          var5 = this.getIntVolatile(var1, var2);\r\n      } while(!this.compareAndSwapInt(var1, var2, var5, var4));\r\n  \r\n      return var5;\r\n  }\r\n  ```\r\n\r\n  var5ï¼šä»ä¸»å†…å­˜ä¸­æ‹·è´åˆ°å·¥ä½œå†…å­˜ä¸­çš„å€¼ï¼ˆæ¯æ¬¡éƒ½è¦ä»ä¸»å†…å­˜æ‹¿åˆ°æœ€æ–°çš„å€¼åˆ°æœ¬åœ°å†…å­˜ï¼‰ï¼Œç„¶åæ‰§è¡Œ `compareAndSwapInt()` å†å’Œä¸»å†…å­˜çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå‡è®¾æ–¹æ³•è¿”å› falseï¼Œé‚£ä¹ˆå°±ä¸€ç›´æ‰§è¡Œ while æ–¹æ³•ï¼Œç›´åˆ°æœŸæœ›çš„å€¼å’ŒçœŸå®å€¼ä¸€æ ·ï¼Œä¿®æ”¹æ•°æ®\r\n\r\n* å˜é‡ value ç”¨ volatile ä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ï¼Œé¿å…çº¿ç¨‹ä»**å·¥ä½œç¼“å­˜**ä¸­è·å–å¤±æ•ˆçš„å˜é‡\r\n\r\n  ```java\r\n  private volatile int value\r\n  ```\r\n\r\n  **CAS å¿…é¡»å€ŸåŠ© volatile æ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°æ¯”è¾ƒå¹¶äº¤æ¢çš„æ•ˆæœ**\r\n  \r\n  > åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œç¼“å­˜ï¼ˆcacheï¼‰æ˜¯ä¸€ç§å­˜å‚¨æ•°æ®çš„ä¸´æ—¶å­˜å‚¨å™¨ï¼Œç”¨äºåŠ å¿«æ•°æ®çš„è®¿é—®é€Ÿåº¦ã€‚ç¼“å­˜é€šå¸¸ä½äºCPUå’Œä¸»å­˜ä¹‹é—´ï¼Œç”¨äºå­˜å‚¨æœ€è¿‘æˆ–é¢‘ç¹è®¿é—®çš„æ•°æ®ï¼Œä»¥é¿å…é¢‘ç¹è®¿é—®ä¸»å­˜æ‰€å¸¦æ¥çš„å»¶è¿Ÿã€‚\r\n  >\r\n  > å½“ä¸€ä¸ªå˜é‡è¢«è¯»å–æˆ–å†™å…¥æ—¶ï¼ŒCPUä¼šé¦–å…ˆåœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾è¯¥å˜é‡çš„å€¼ã€‚å¦‚æœåœ¨ç¼“å­˜ä¸­æ‰¾åˆ°äº†ç›¸åº”çš„å€¼ï¼ˆå³å‘½ä¸­ç¼“å­˜ï¼‰ï¼ŒCPUå°±æ— éœ€è®¿é—®ä¸»å­˜ï¼Œä»è€ŒåŠ å¿«äº†æ•°æ®è®¿é—®é€Ÿåº¦ã€‚ä½†æ˜¯ï¼Œå½“ä¸åŒçš„çº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œç”±äºç¼“å­˜æ˜¯æ¯ä¸ªCPUæ ¸å¿ƒç‹¬ç«‹çš„ï¼Œå…¶ä¸­çš„æ•°æ®å¯èƒ½å¹¶ä¸æ˜¯æœ€æ–°çš„ï¼Œè¿™å°±å¯èƒ½å¯¼è‡´çº¿ç¨‹é—´çš„æ•°æ®ä¸ä¸€è‡´æ€§ã€‚\r\n  >\r\n  > æ‰€ä»¥ï¼Œvolatileå…³é”®å­—å¯ä»¥å‘Šè¯‰CPUæ¯æ¬¡è®¿é—®è¯¥å˜é‡éƒ½è¦ä»å†…å­˜ä¸­è¯»å–æœ€æ–°çš„å€¼ï¼Œè€Œä¸æ˜¯ä»ç¼“å­˜ä¸­è¯»å–ï¼Œä»è€Œä¿è¯äº†è¯¥å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹çš„å¯è§æ€§ã€‚\r\n\r\nåˆ†æ getAndUpdate æ–¹æ³•ï¼š\r\n\r\n* getAndUpdateï¼š\r\n\r\n  ```java\r\n  public final int getAndUpdate(IntUnaryOperator updateFunction) {\r\n      int prev, next;\r\n      do {\r\n          prev = get();\t//å½“å‰å€¼ï¼Œcasçš„æœŸæœ›å€¼\r\n          next = updateFunction.applyAsInt(prev);//æœŸæœ›å€¼æ›´æ–°åˆ°è¯¥å€¼\r\n      } while (!compareAndSet(prev, next));//è‡ªæ—‹\r\n      return prev;\r\n  }\r\n  ```\r\n\r\n  æ¨¡ä»¿ï¼š\r\n\r\n  ```java\r\n  public static void main(String[] args) {\r\n      AtomicInteger i = new AtomicInteger(5);\r\n      System.out.println(updateAndGet(i, p -> p / 2));\r\n  }\r\n  public static int updateAndGet(AtomicInteger i, IntUnaryOperator operator) {\r\n          while (true) {\r\n              int prev = i.get();\r\n              int next = operator.applyAsInt(prev);\r\n              if (i.compareAndSet(prev, next)) {\r\n                  return next;\r\n              }\r\n          }\r\n      }\r\n  ```\r\n\r\n  å‡½æ•°å¼æ¥å£ï¼šå¯ä»¥è‡ªå®šä¹‰æ“ä½œé€»è¾‘\r\n\r\n  ```java\r\n  AtomicInteger a = new AtomicInteger();\r\n  a.getAndUpdate(i -> i + 10);\r\n  ```\r\n\r\n* compareAndSetï¼š\r\n\r\n  ```java\r\n  public final boolean compareAndSet(int expect, int update) {\r\n      /**\r\n      * this: \t\tå½“å‰å¯¹è±¡\r\n      * valueOffset:\tå†…å­˜åç§»é‡ï¼Œå†…å­˜åœ°å€\r\n      * expect:\t\tæœŸæœ›çš„å€¼\r\n      * update: \t\tæ›´æ–°çš„å€¼\r\n      */\r\n      return unsafe.compareAndSwapInt(this, valueOffset, expect, update);\r\n  }\r\n  ```\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åŸå­å¼•ç”¨\r\n\r\nåŸå­å¼•ç”¨ï¼šå¯¹ Object è¿›è¡ŒåŸå­æ“ä½œï¼Œæä¾›ä¸€ç§è¯»å’Œå†™éƒ½æ˜¯åŸå­æ€§çš„å¯¹è±¡å¼•ç”¨å˜é‡\r\n\r\nåŸå­å¼•ç”¨ç±»ï¼šAtomicReferenceã€AtomicStampedReferenceã€AtomicMarkableReference\r\n\r\nAtomicReference ç±»ï¼š\r\n\r\n* æ„é€ æ–¹æ³•ï¼š\r\n  * `public AtomicReference(V initialValue)`ï¼šåˆå§‹åŒ–ä¸€ä¸ªæŒ‡å®šå€¼çš„åŸå­å¼•ç”¨\r\n\r\n  * `public AtomicReference()`ï¼šåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤å€¼ä¸º null çš„åŸå­å¼•ç”¨\r\n\r\n* å¸¸ç”¨ APIï¼š\r\n  * `public final boolean compareAndSet(V expectedValue, V newValue)`ï¼šCAS æ“ä½œ\r\n  * `public final void set(V newValue)`ï¼šå°†å€¼è®¾ç½®ä¸º newValue \r\n  * `public final V get()`ï¼šè¿”å›å½“å‰å€¼\r\n\r\n```java\r\npublic class AtomicReferenceDemo {\r\n    public static void main(String[] args) {\r\n        Student s1 = new Student(33, \"z3\");\r\n        \r\n        // åˆ›å»ºåŸå­å¼•ç”¨åŒ…è£…ç±»\r\n        AtomicReference<Student> atomicReference = new AtomicReference<>();\r\n        // è®¾ç½®ä¸»å†…å­˜å…±äº«å˜é‡ä¸ºs1\r\n        atomicReference.set(s1);\r\n\r\n        // æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œå¦‚æœç°åœ¨ä¸»ç‰©ç†å†…å­˜çš„å€¼ä¸º z3ï¼Œé‚£ä¹ˆäº¤æ¢æˆ l4\r\n        while (true) {\r\n            Student s2 = new Student(44, \"l4\");\r\n            if (atomicReference.compareAndSet(s1, s2)) {\r\n                break;\r\n            }\r\n        }\r\n        System.out.println(atomicReference.get());\r\n    }\r\n}\r\n\r\nclass Student {\r\n    private int id;\r\n    private String name;\r\n    //ã€‚ã€‚ã€‚ã€‚\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åŸå­æ•°ç»„\r\n\r\nåŸå­æ•°ç»„ç±»ï¼šAtomicIntegerArrayã€AtomicLongArrayã€AtomicReferenceArray\r\n\r\nAtomicIntegerArray ç±»æ–¹æ³•ï¼š\r\n\r\n```java\r\n/**\r\n*   i\t\tthe index\r\n* expect \tthe expected value\r\n* update \tthe new value\r\n*/\r\npublic final boolean compareAndSet(int i, int expect, int update) {\r\n    return compareAndSetRaw(checkedByteOffset(i), expect, update);\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åŸå­æ›´æ–°å™¨\r\n\r\nåŸå­æ›´æ–°å™¨ç±»ï¼šAtomicReferenceFieldUpdaterã€AtomicIntegerFieldUpdaterã€AtomicLongFieldUpdater\r\n\r\nåˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹å¯¹è±¡çš„æŸä¸ªåŸŸï¼ˆFieldï¼‰è¿›è¡ŒåŸå­æ“ä½œï¼Œåªèƒ½é…åˆ volatile ä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸ `IllegalArgumentException: Must be volatile type`\r\n\r\nå¸¸ç”¨ APIï¼š\r\n\r\n* `static <U> AtomicIntegerFieldUpdater<U> newUpdater(Class<U> c, String fieldName)`ï¼šé™æ€æ–¹æ³•\r\n* `abstract boolean compareAndSet(T obj, int expect, int update)`ï¼šCAS\r\n\r\n```java\r\npublic class UpdateDemo {\r\n    private volatile int field;\r\n    \r\n    public static void main(String[] args) {\r\n        AtomicIntegerFieldUpdater fieldUpdater = AtomicIntegerFieldUpdater\r\n            \t\t.newUpdater(UpdateDemo.class, \"field\");\r\n        UpdateDemo updateDemo = new UpdateDemo();\r\n        fieldUpdater.compareAndSet(updateDemo, 0, 10);\r\n        System.out.println(updateDemo.field);//10\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åŸå­ç´¯åŠ å™¨\r\n\r\nåŸå­ç´¯åŠ å™¨ç±»ï¼šLongAdderã€DoubleAdderã€LongAccumulatorã€DoubleAccumulator \r\n\r\nLongAdder å’Œ LongAccumulator åŒºåˆ«ï¼š\r\n\r\nç›¸åŒç‚¹ï¼š\r\n\r\n* LongAdder ä¸ LongAccumulator ç±»éƒ½æ˜¯ä½¿ç”¨éé˜»å¡ç®—æ³• CAS å®ç°çš„\r\n* LongAdder ç±»æ˜¯ LongAccumulator ç±»çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œåªæ˜¯ LongAccumulator æä¾›äº†æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ä»¥è‡ªå®šä¹‰ç´¯åŠ è§„åˆ™ï¼Œå½“accumulatorFunction ä¸º null æ—¶å°±ç­‰ä»·äº LongAdder\r\n\r\nä¸åŒç‚¹ï¼š\r\n\r\n* è°ƒç”¨ casBase æ—¶ï¼ŒLongAccumulator ä½¿ç”¨ function.applyAsLong(b = base, x) æ¥è®¡ç®—ï¼ŒLongAdder ä½¿ç”¨ casBase(b = base, b + x) \r\n* LongAccumulator ç±»åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼Œæ„é€ æ–¹æ³•å‚æ•°ä¸­\r\n\r\n  * accumulatorFunction æ˜¯ä¸€ä¸ªåŒç›®è¿ç®—å™¨æ¥å£ï¼Œå¯ä»¥æŒ‡å®šç´¯åŠ è§„åˆ™ï¼Œæ¯”å¦‚ç´¯åŠ æˆ–è€…ç›¸ä¹˜ï¼Œå…¶æ ¹æ®è¾“å…¥çš„ä¸¤ä¸ªå‚æ•°è¿”å›ä¸€ä¸ªè®¡ç®—å€¼ï¼ŒLongAdder å†…ç½®ç´¯åŠ è§„åˆ™\r\n  * identity åˆ™æ˜¯ LongAccumulator ç´¯åŠ å™¨çš„åˆå§‹å€¼ï¼ŒLongAccumulator å¯ä»¥ä¸ºç´¯åŠ å™¨æä¾›é0çš„åˆå§‹å€¼ï¼Œè€Œ LongAdder åªèƒ½æä¾›é»˜è®¤çš„ 0\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### Adder\r\n\r\n#### ä¼˜åŒ–æœºåˆ¶\r\n\r\nLongAdder æ˜¯ Java8 æä¾›çš„ç±»ï¼Œè·Ÿ AtomicLong æœ‰ç›¸åŒçš„æ•ˆæœï¼Œä½†å¯¹ CAS æœºåˆ¶è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå°è¯•ä½¿ç”¨åˆ†æ®µ CAS ä»¥åŠè‡ªåŠ¨åˆ†æ®µè¿ç§»çš„æ–¹å¼æ¥å¤§å¹…åº¦æå‡å¤šçº¿ç¨‹é«˜å¹¶å‘æ‰§è¡Œ CAS æ“ä½œçš„æ€§èƒ½\r\n\r\nCAS åº•å±‚å®ç°æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ä¸æ–­åœ°å°è¯•ä¿®æ”¹ç›®æ ‡å€¼ï¼Œç›´åˆ°ä¿®æ”¹æˆåŠŸã€‚å¦‚æœç«äº‰ä¸æ¿€çƒˆä¿®æ”¹æˆåŠŸç‡å¾ˆé«˜ï¼Œå¦åˆ™å¤±è´¥ç‡å¾ˆé«˜ï¼Œå¤±è´¥åè¿™äº›é‡å¤çš„åŸå­æ€§æ“ä½œä¼šè€—è´¹æ€§èƒ½ï¼ˆå¯¼è‡´å¤§é‡çº¿ç¨‹**ç©ºå¾ªç¯ï¼Œè‡ªæ—‹è½¬**ï¼‰\r\n\r\nä¼˜åŒ–æ ¸å¿ƒæ€æƒ³ï¼šæ•°æ®åˆ†ç¦»ï¼Œå°† AtomicLong çš„**å•ç‚¹çš„æ›´æ–°å‹åŠ›åˆ†æ‹…åˆ°å„ä¸ªèŠ‚ç‚¹ï¼Œç©ºé—´æ¢æ—¶é—´**ï¼Œåœ¨ä½å¹¶å‘çš„æ—¶å€™ç›´æ¥æ›´æ–°ï¼Œå¯ä»¥ä¿éšœå’Œ AtomicLong çš„æ€§èƒ½åŸºæœ¬ä¸€è‡´ï¼Œè€Œåœ¨é«˜å¹¶å‘çš„æ—¶å€™é€šè¿‡åˆ†æ•£å‡å°‘ç«äº‰ï¼Œæé«˜äº†æ€§èƒ½\r\n\r\n**åˆ†æ®µ CAS æœºåˆ¶**ï¼š\r\n\r\n* åœ¨å‘ç”Ÿç«äº‰æ—¶ï¼Œåˆ›å»º Cell æ•°ç»„ç”¨äºå°†ä¸åŒçº¿ç¨‹çš„æ“ä½œç¦»æ•£ï¼ˆé€šè¿‡ hash ç­‰ç®—æ³•æ˜ å°„ï¼‰åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Š\r\n* è®¾ç½®å¤šä¸ªç´¯åŠ å•å…ƒï¼ˆä¼šæ ¹æ®éœ€è¦æ‰©å®¹ï¼Œæœ€å¤§ä¸º CPU æ ¸æ•°ï¼‰ï¼ŒTherad-0 ç´¯åŠ  Cell[0]ï¼Œè€Œ Thread-1 ç´¯åŠ  Cell[1] ç­‰ï¼Œæœ€åå°†ç»“æœæ±‡æ€»\r\n* åœ¨ç´¯åŠ æ—¶æ“ä½œçš„ä¸åŒçš„ Cell å˜é‡ï¼Œå› æ­¤å‡å°‘äº† CAS é‡è¯•å¤±è´¥ï¼Œä»è€Œæé«˜æ€§èƒ½\r\n\r\n**è‡ªåŠ¨åˆ†æ®µè¿ç§»æœºåˆ¶**ï¼šæŸä¸ª Cell çš„ value æ‰§è¡Œ CAS å¤±è´¥ï¼Œå°±ä¼šè‡ªåŠ¨å¯»æ‰¾å¦ä¸€ä¸ª Cell åˆ†æ®µå†…çš„ value å€¼è¿›è¡Œ CAS æ“ä½œ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä¼ªå…±äº«\r\n\r\nCell ä¸ºç´¯åŠ å•å…ƒï¼šæ•°ç»„è®¿é—®ç´¢å¼•æ˜¯é€šè¿‡ Thread é‡Œçš„ threadLocalRandomProbe åŸŸå–æ¨¡å®ç°çš„ï¼Œè¿™ä¸ªåŸŸæ˜¯ ThreadLocalRandom æ›´æ–°çš„\r\n\r\n```java\r\n// Striped64.Cell\r\n@sun.misc.Contended static final class Cell {\r\n    volatile long value;\r\n    Cell(long x) { value = x; }\r\n    // ç”¨ cas æ–¹å¼è¿›è¡Œç´¯åŠ , prev è¡¨ç¤ºæ—§å€¼, next è¡¨ç¤ºæ–°å€¼\r\n    final boolean cas(long prev, long next) {\r\n    \treturn UNSAFE.compareAndSwapLong(this, valueOffset, prev, next);\r\n    }\r\n    // çœç•¥ä¸é‡è¦ä»£ç \r\n}\r\n```\r\n\r\nCell æ˜¯æ•°ç»„å½¢å¼ï¼Œ**åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„**ï¼Œ64 ä½ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ª Cell ä¸º 24 å­—èŠ‚ï¼ˆ16 å­—èŠ‚çš„å¯¹è±¡å¤´å’Œ 8 å­—èŠ‚çš„ valueï¼‰ï¼Œæ¯ä¸€ä¸ª cache line ä¸º 64 å­—èŠ‚ï¼Œå› æ­¤ç¼“å­˜è¡Œå¯ä»¥å­˜ä¸‹ 2 ä¸ªçš„ Cell å¯¹è±¡ï¼Œå½“ Core-0 è¦ä¿®æ”¹ Cell[0]ã€Core-1 è¦ä¿®æ”¹ Cell[1]ï¼Œ**æ— è®ºè°ä¿®æ”¹æˆåŠŸéƒ½ä¼šå¯¼è‡´å½“å‰ç¼“å­˜è¡Œå¤±æ•ˆ**ï¼Œä»è€Œå¯¼è‡´å¯¹æ–¹çš„æ•°æ®å¤±æ•ˆï¼Œéœ€è¦é‡æ–°å»ä¸»å­˜è·å–ï¼Œå½±å“æ•ˆç‡\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608150111.png\" alt=\"img\" class=\"scale-67\" />\r\n\r\n@sun.misc.Contendedï¼šé˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«ï¼Œåœ¨ä½¿ç”¨æ­¤æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µçš„å‰åå„å¢åŠ  128 å­—èŠ‚å¤§å°çš„ paddingï¼Œä½¿ç”¨ 2 å€äºå¤§å¤šæ•°ç¡¬ä»¶ç¼“å­˜è¡Œè®© CPU å°†å¯¹è±¡é¢„è¯»è‡³ç¼“å­˜æ—¶**å ç”¨ä¸åŒçš„ç¼“å­˜è¡Œ**ï¼Œè¿™æ ·å°±ä¸ä¼šé€ æˆå¯¹æ–¹ç¼“å­˜è¡Œçš„å¤±æ•ˆ\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608150119.png\" alt=\"img\" class=\"scale-67\" />\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æºç è§£æ\r\n\r\nStriped64 ç±»æˆå‘˜å±æ€§ï¼š\r\n\r\n```java\r\n// è¡¨ç¤ºå½“å‰è®¡ç®—æœºCPUæ•°é‡\r\nstatic final int NCPU = Runtime.getRuntime().availableProcessors()\r\n// ç´¯åŠ å•å…ƒæ•°ç»„, æ‡’æƒ°åˆå§‹åŒ–\r\ntransient volatile Cell[] cells;\r\n// åŸºç¡€å€¼, å¦‚æœæ²¡æœ‰ç«äº‰, åˆ™ç”¨ cas ç´¯åŠ è¿™ä¸ªåŸŸï¼Œå½“ cells æ‰©å®¹æ—¶ï¼Œä¹Ÿä¼šå°†æ•°æ®å†™åˆ° base ä¸­\r\ntransient volatile long base;\r\n// åœ¨ cells åˆå§‹åŒ–æˆ–æ‰©å®¹æ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ, é€šè¿‡ CAS æ›´æ–° cellsBusy ç½®ä¸º 1 æ¥å®ç°ä¸€ä¸ªé”\r\ntransient volatile int cellsBusy;\r\n```\r\n\r\nå·¥ä½œæµç¨‹ï¼š\r\n\r\n* cells å ç”¨å†…å­˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¤§çš„ï¼Œæ˜¯æƒ°æ€§åŠ è½½çš„ï¼Œåœ¨æ— ç«äº‰æˆ–è€…å…¶ä»–çº¿ç¨‹æ­£åœ¨åˆå§‹åŒ– cells æ•°ç»„çš„æƒ…å†µä¸‹ï¼Œç›´æ¥æ›´æ–° base åŸŸ\r\n\r\n* åœ¨ç¬¬ä¸€æ¬¡å‘ç”Ÿç«äº‰æ—¶ï¼ˆcasBase å¤±è´¥ï¼‰ä¼šåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º 2 çš„ cells æ•°ç»„ï¼Œå°†å½“å‰ç´¯åŠ çš„å€¼åŒ…è£…ä¸º Cell å¯¹è±¡ï¼Œæ”¾å…¥æ˜ å°„çš„æ§½ä½ä¸Š\r\n* åˆ†æ®µç´¯åŠ çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹å¯¹åº”çš„ cells æ§½ä½ä¸ºç©ºï¼Œå°±ä¼šæ–°å»º Cell å¡«å……ï¼Œå¦‚æœå‡ºç°ç«äº‰ï¼Œå°±ä¼šé‡æ–°è®¡ç®—çº¿ç¨‹å¯¹åº”çš„æ§½ä½ï¼Œç»§ç»­è‡ªæ—‹å°è¯•ä¿®æ”¹\r\n* åˆ†æ®µè¿ç§»åè¿˜å‡ºç°ç«äº‰å°±ä¼šæ‰©å®¹ cells æ•°ç»„é•¿åº¦ä¸ºåŸæ¥çš„ä¸¤å€ï¼Œç„¶å rehashï¼Œ**æ•°ç»„é•¿åº¦æ€»æ˜¯ 2 çš„ n æ¬¡å¹‚**ï¼Œé»˜è®¤æœ€å¤§ä¸º CPU æ ¸æ•°ï¼Œä½†æ˜¯å¯ä»¥è¶…è¿‡ï¼Œå¦‚æœæ ¸æ•°æ˜¯ 6 æ ¸ï¼Œæ•°ç»„æœ€é•¿æ˜¯ 8 \r\n\r\næ–¹æ³•åˆ†æï¼š\r\n\r\n* `LongAdder#add`ï¼šç´¯åŠ æ–¹æ³•\r\n\r\n  ```java\r\n  public void add(long x) {\r\n      // as ä¸ºç´¯åŠ å•å…ƒæ•°ç»„çš„å¼•ç”¨ï¼Œb ä¸ºåŸºç¡€å€¼ï¼Œv è¡¨ç¤ºæœŸæœ›å€¼\r\n      // m è¡¨ç¤º cells æ•°ç»„çš„é•¿åº¦ - 1ï¼Œa è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„ cell å•å…ƒæ ¼\r\n      Cell[] as; long b, v; int m; Cell a;\r\n      \r\n      // cells ä¸ä¸ºç©ºè¯´æ˜ cells å·²ç»è¢«åˆå§‹åŒ–ï¼Œçº¿ç¨‹å‘ç”Ÿäº†ç«äº‰ï¼Œå»æ›´æ–°å¯¹åº”çš„ cell æ§½ä½\r\n      // è¿›å…¥ || åçš„é€»è¾‘å»æ›´æ–° base åŸŸï¼Œæ›´æ–°å¤±è´¥è¡¨ç¤ºå‘ç”Ÿç«äº‰è¿›å…¥æ¡ä»¶\r\n      if ((as = cells) != null || !casBase(b = base, b + x)) {\r\n          // uncontended ä¸º true è¡¨ç¤º cell æ²¡æœ‰ç«äº‰\r\n          boolean uncontended = true;\r\n          \r\n          // æ¡ä»¶ä¸€: true è¯´æ˜ cells æœªåˆå§‹åŒ–ï¼Œå¤šçº¿ç¨‹å†™ base å‘ç”Ÿç«äº‰éœ€è¦è¿›è¡Œåˆå§‹åŒ– cells æ•°ç»„\r\n          //\t\t  fasle è¯´æ˜ cells å·²ç»åˆå§‹åŒ–ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªæ¡ä»¶å¯»æ‰¾è‡ªå·±çš„ cell å»ç´¯åŠ \r\n          // æ¡ä»¶äºŒ: getProbe() è·å– hash å€¼ï¼Œ& m çš„é€»è¾‘å’Œ HashMap çš„é€»è¾‘ç›¸åŒï¼Œä¿è¯æ•£åˆ—çš„å‡åŒ€æ€§\r\n          // \t\t  true è¯´æ˜å½“å‰çº¿ç¨‹å¯¹åº”ä¸‹æ ‡çš„ cell ä¸ºç©ºï¼Œéœ€è¦åˆ›å»º cell\r\n          //        false è¯´æ˜å½“å‰çº¿ç¨‹å¯¹åº”çš„ cell ä¸ä¸ºç©ºï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªæ¡ä»¶ã€å°† x å€¼ç´¯åŠ åˆ°å¯¹åº”çš„ cell ä¸­ã€‘\r\n          // æ¡ä»¶ä¸‰: æœ‰å–åç¬¦å·ï¼Œfalse è¯´æ˜ cas æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œtrue è¯´æ˜å¤±è´¥ï¼Œå½“å‰çº¿ç¨‹å¯¹åº”çš„ cell æœ‰ç«äº‰\r\n          if (as == null || (m = as.length - 1) < 0 ||\r\n              (a = as[getProbe() & m]) == null ||\r\n              !(uncontended = a.cas(v = a.value, v + x)))\r\n              longAccumulate(x, null, uncontended);\r\n          \t// ã€uncontended åœ¨å¯¹åº”çš„ cell ä¸Šç´¯åŠ å¤±è´¥çš„æ—¶å€™æ‰ä¸º falseï¼Œå…¶ä½™æƒ…å†µå‡ä¸º trueã€‘\r\n      }\r\n  }\r\n  ```\r\n\r\n* `Striped64`\r\n\r\n```java\r\n// Unsafe mechanics\r\nprivate static final sun.misc.Unsafe UNSAFE;\r\nprivate static final long BASE;\r\nprivate static final long CELLSBUSY;\r\nprivate static final long PROBE;\r\nstatic {\r\n    try {\r\n        UNSAFE = sun.misc.Unsafe.getUnsafe();\r\n        Class<?> sk = Striped64.class;\r\n        BASE = UNSAFE.objectFieldOffset\r\n            (sk.getDeclaredField(\"base\"));\r\n        CELLSBUSY = UNSAFE.objectFieldOffset\r\n            (sk.getDeclaredField(\"cellsBusy\"));\r\n        Class<?> tk = Thread.class;\r\n        PROBE = UNSAFE.objectFieldOffset\r\n            (tk.getDeclaredField(\"threadLocalRandomProbe\"));\r\n    } catch (Exception e) {\r\n        throw new Error(e);\r\n    }\r\n}\r\n```\r\n\r\n* `Striped64#casBase`\r\n\r\n```java\r\n/**\r\n * CASes the base field.\r\n */\r\nfinal boolean casBase(long cmp, long val) {\r\n    return UNSAFE.compareAndSwapLong(this, BASE, cmp, val);\r\n}\r\n```\r\n\r\n* `Striped64#longAccumulate`ï¼šcell æ•°ç»„åˆ›å»º\r\n\r\n  ```java\r\n  // \t\t\t\t\t\t\tx  \t\t\tnull \t\t\tfalse | true\r\n  final void longAccumulate(long x, LongBinaryOperator fn, boolean wasUncontended) {\r\n      int h;\r\n      // å½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰å¯¹åº”çš„ cell, éœ€è¦éšæœºç”Ÿæˆä¸€ä¸ª hash å€¼ç”¨æ¥å°†å½“å‰çº¿ç¨‹ç»‘å®šåˆ° cell\r\n      if ((h = getProbe()) == 0) {\r\n          // åˆå§‹åŒ– probeï¼Œè·å– hash å€¼\r\n          ThreadLocalRandom.current(); \r\n          h = getProbe();\t\r\n          // é»˜è®¤æƒ…å†µä¸‹ å½“å‰çº¿ç¨‹è‚¯å®šæ˜¯å†™å…¥åˆ°äº† cells[0] ä½ç½®ï¼Œä¸æŠŠå®ƒå½“åšä¸€æ¬¡çœŸæ­£çš„ç«äº‰\r\n          wasUncontended = true;\r\n      }\r\n      // è¡¨ç¤ºã€æ‰©å®¹æ„å‘ã€‘ï¼Œfalse ä¸€å®šä¸ä¼šæ‰©å®¹ï¼Œtrue å¯èƒ½ä¼šæ‰©å®¹\r\n      boolean collide = false; \r\n      //è‡ªæ—‹\r\n      for (;;) {\r\n          // as è¡¨ç¤ºcellså¼•ç”¨ï¼Œa è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„ cellï¼Œn è¡¨ç¤º cells æ•°ç»„é•¿åº¦ï¼Œv è¡¨ç¤º æœŸæœ›å€¼\r\n          Cell[] as; Cell a; int n; long v;\r\n          // ã€CASE1ã€‘: è¡¨ç¤º cells å·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®å†™å…¥åˆ°å¯¹åº”çš„ cell ä¸­\r\n          if ((as = cells) != null && (n = as.length) > 0) {\r\n              // CASE1.1: true è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯¹åº”çš„ç´¢å¼•ä¸‹æ ‡çš„ Cell ä¸º nullï¼Œéœ€è¦åˆ›å»º new Cell\r\n              if ((a = as[(n - 1) & h]) == null) {\r\n                  // åˆ¤æ–­ cellsBusy æ˜¯å¦è¢«é”\r\n                  if (cellsBusy == 0) {   \r\n                      // åˆ›å»º cell, åˆå§‹ç´¯åŠ å€¼ä¸º x\r\n                      Cell r = new Cell(x);  \r\n                      // åŠ é”\r\n                      if (cellsBusy == 0 && casCellsBusy()) {\r\n                          // åˆ›å»ºæˆåŠŸæ ‡è®°ï¼Œè¿›å…¥ã€åˆ›å»º cell é€»è¾‘ã€‘\r\n                          boolean created = false;\t\r\n                          try {\r\n                              Cell[] rs; int m, j;\r\n                              // æŠŠå½“å‰ cells æ•°ç»„èµ‹å€¼ç»™ rsï¼Œå¹¶ä¸”ä¸ä¸º null\r\n                              if ((rs = cells) != null &&\r\n                                  (m = rs.length) > 0 &&\r\n                                  // å†æ¬¡åˆ¤æ–­é˜²æ­¢å…¶å®ƒçº¿ç¨‹åˆå§‹åŒ–è¿‡è¯¥ä½ç½®ï¼Œå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–è¯¥ä½ç½®ä¼šé€ æˆæ•°æ®ä¸¢å¤±\r\n                                  // å› ä¸ºè¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ¤æ–­ï¼Œè¿›è¡Œçš„é€»è¾‘ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å½±å“\r\n                                  rs[j = (m - 1) & h] == null) {\r\n                                  // æŠŠæ–°åˆ›å»ºçš„ cell å¡«å……è‡³å½“å‰ä½ç½®\r\n                                  rs[j] = r;\r\n                                  created = true;\t// è¡¨ç¤ºåˆ›å»ºå®Œæˆ\r\n                              }\r\n                          } finally {\r\n                              cellsBusy = 0;\t\t// è§£é”\r\n                          }\r\n                          if (created)\t\t\t// true è¡¨ç¤ºåˆ›å»ºå®Œæˆï¼Œå¯ä»¥æ¨å‡ºå¾ªç¯äº†\r\n                              break;\r\n                          continue;\r\n                      }\r\n                  }\r\n                  collide = false;\r\n              }\r\n              // CASE1.2: æ¡ä»¶æˆç«‹è¯´æ˜çº¿ç¨‹å¯¹åº”çš„ cell æœ‰ç«äº‰, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas\r\n              else if (!wasUncontended)\r\n                  wasUncontended = true;\r\n              // CASE 1.3: å½“å‰çº¿ç¨‹ rehash è¿‡ï¼Œå¦‚æœæ–°å‘½ä¸­çš„ cell ä¸ä¸ºç©ºï¼Œå°±å°è¯•ç´¯åŠ ï¼Œfalse è¯´æ˜æ–°å‘½ä¸­ä¹Ÿæœ‰ç«äº‰\r\n              else if (a.cas(v = a.value, ((fn == null) ? v + x : fn.applyAsLong(v, x))))\r\n                  break;\r\n              // CASE 1.4: cells é•¿åº¦å·²ç»è¶…è¿‡äº†æœ€å¤§é•¿åº¦ CPU å†…æ ¸çš„æ•°é‡æˆ–è€…å·²ç»æ‰©å®¹\r\n              else if (n >= NCPU || cells != as)\r\n                  collide = false; \t\t// æ‰©å®¹æ„å‘æ”¹ä¸ºfalseï¼Œã€è¡¨ç¤ºä¸èƒ½æ‰©å®¹äº†ã€‘\r\n              // CASE 1.5: æ›´æ”¹æ‰©å®¹æ„å‘ï¼Œå¦‚æœ n >= NCPUï¼Œè¿™é‡Œå°±æ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°ï¼Œcase1.4 æ°¸è¿œå…ˆäº 1.5 æ‰§è¡Œ\r\n              else if (!collide)\r\n                  collide = true;\r\n              // CASE 1.6: ã€æ‰©å®¹é€»è¾‘ã€‘ï¼Œè¿›è¡ŒåŠ é”\r\n              else if (cellsBusy == 0 && casCellsBusy()) {\r\n                  try {\r\n                      // çº¿ç¨‹å®‰å…¨çš„æ£€æŸ¥ï¼Œé˜²æ­¢æœŸé—´è¢«å…¶ä»–çº¿ç¨‹æ‰©å®¹äº†\r\n                      if (cells == as) {     \r\n                          // æ‰©å®¹ä¸ºä»¥å‰çš„ 2 å€\r\n                          Cell[] rs = new Cell[n << 1];\r\n                          // éå†ç§»åŠ¨å€¼\r\n                          for (int i = 0; i < n; ++i)\r\n                              rs[i] = as[i];\r\n                          // æŠŠæ‰©å®¹åçš„å¼•ç”¨ç»™ cells\r\n                          cells = rs;\r\n                      }\r\n                  } finally {\r\n                      cellsBusy = 0;\t// è§£é”\r\n                  }\r\n                  collide = false;\t// æ‰©å®¹æ„å‘æ”¹ä¸º falseï¼Œè¡¨ç¤ºä¸æ‰©å®¹äº†\r\n                  continue;\r\n              }\r\n              // é‡ç½®å½“å‰çº¿ç¨‹ Hash å€¼ï¼Œè¿™å°±æ˜¯ã€åˆ†æ®µè¿ç§»æœºåˆ¶ã€‘\r\n              h = advanceProbe(h);\r\n          }\r\n  \r\n          // ã€CASE2ã€‘: è¿è¡Œåˆ°è¿™è¯´æ˜ cells è¿˜æœªåˆå§‹åŒ–ï¼Œas ä¸ºnull\r\n          // åˆ¤æ–­æ˜¯å¦æ²¡æœ‰åŠ é”ï¼Œæ²¡æœ‰åŠ é”å°±ç”¨ CAS åŠ é”\r\n          // æ¡ä»¶äºŒåˆ¤æ–­æ˜¯å¦å…¶å®ƒçº¿ç¨‹åœ¨å½“å‰çº¿ç¨‹ç»™ as èµ‹å€¼ä¹‹åä¿®æ”¹äº† cellsï¼Œè¿™é‡Œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ¤æ–­\r\n          else if (cellsBusy == 0 && cells == as && casCellsBusy()) {\r\n              // åˆå§‹åŒ–æ ‡å¿—ï¼Œå¼€å§‹ ã€åˆå§‹åŒ– cells æ•°ç»„ã€‘\r\n              boolean init = false;\r\n              try { \r\n                 \t// å†æ¬¡åˆ¤æ–­ cells == as é˜²æ­¢å…¶å®ƒçº¿ç¨‹å·²ç»æå‰åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–å¯¼è‡´ä¸¢å¤±æ•°æ®\r\n                  // å› ä¸ºè¿™é‡Œæ˜¯ã€çº¿ç¨‹å®‰å…¨çš„ï¼Œé‡æ–°æ£€æŸ¥ï¼Œç»å…¸ DCLã€‘\r\n                  if (cells == as) {\r\n                      Cell[] rs = new Cell[2];\t// åˆå§‹åŒ–æ•°ç»„å¤§å°ä¸º2\r\n                      rs[h & 1] = new Cell(x);\t// å¡«å……çº¿ç¨‹å¯¹åº”çš„cell\r\n                      cells = rs;\r\n                      init = true;\t\t\t\t// åˆå§‹åŒ–æˆåŠŸï¼Œæ ‡è®°ç½®ä¸º true\r\n                  }\r\n              } finally {\r\n                  cellsBusy = 0;\t\t\t\t\t// è§£é”\r\n              }\r\n              if (init)\r\n                  break;\t\t\t\t\t\t\t// åˆå§‹åŒ–æˆåŠŸç›´æ¥è·³å‡ºè‡ªæ—‹\r\n          }\r\n          // ã€CASE3ã€‘: è¿è¡Œåˆ°è¿™è¯´æ˜å…¶ä»–çº¿ç¨‹åœ¨åˆå§‹åŒ– cellsï¼Œå½“å‰çº¿ç¨‹å°†å€¼ç´¯åŠ åˆ° baseï¼Œç´¯åŠ æˆåŠŸç›´æ¥ç»“æŸè‡ªæ—‹\r\n          else if (casBase(v = base, ((fn == null) ? v + x :\r\n                                      fn.applyAsLong(v, x))))\r\n              break; \r\n      }\r\n  }\r\n  ```\r\n\r\n* `LongAdder#sum`ï¼šè·å–æœ€ç»ˆç»“æœé€šè¿‡ sum æ•´åˆï¼Œ**ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸ä¿è¯å¼ºä¸€è‡´æ€§**\r\n\r\n  ```java\r\n  public long sum() {\r\n      Cell[] as = cells; Cell a;\r\n      long sum = base;\r\n      if (as != null) {\r\n          // éå† ç´¯åŠ \r\n          for (int i = 0; i < as.length; ++i) {\r\n              if ((a = as[i]) != null)\r\n                  sum += a.value;\r\n          }\r\n      }\r\n      return sum;\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ABA\r\n\r\nABA é—®é¢˜ï¼šå½“è¿›è¡Œè·å–ä¸»å†…å­˜å€¼æ—¶ï¼Œè¯¥å†…å­˜å€¼åœ¨å†™å…¥ä¸»å†…å­˜æ—¶å·²ç»è¢«ä¿®æ”¹äº† N æ¬¡ï¼Œä½†æ˜¯æœ€ç»ˆåˆæ”¹æˆåŸæ¥çš„å€¼\r\n\r\nå…¶ä»–çº¿ç¨‹å…ˆæŠŠ A æ”¹æˆ B åˆæ”¹å› Aï¼Œä¸»çº¿ç¨‹**ä»…èƒ½åˆ¤æ–­å‡ºå…±äº«å˜é‡çš„å€¼ä¸æœ€åˆå€¼ A æ˜¯å¦ç›¸åŒ**ï¼Œä¸èƒ½æ„ŸçŸ¥åˆ°è¿™ç§ä» A æ”¹ä¸º B åˆ æ”¹å› A çš„æƒ…å†µï¼Œè¿™æ—¶ CAS è™½ç„¶æˆåŠŸï¼Œä½†æ˜¯è¿‡ç¨‹å­˜åœ¨é—®é¢˜\r\n\r\n\r\n\r\n#### **AtomicStampedReference**\r\n\r\n* æ„é€ æ–¹æ³•ï¼š\r\n  * `public AtomicStampedReference(V initialRef, int initialStamp)`ï¼šåˆå§‹å€¼å’Œåˆå§‹ç‰ˆæœ¬å·\r\n\r\n* å¸¸ç”¨APIï¼š\r\n  * ` public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp)`ï¼š**æœŸæœ›å¼•ç”¨å’ŒæœŸæœ›ç‰ˆæœ¬å·éƒ½ä¸€è‡´**æ‰è¿›è¡Œ CAS ä¿®æ”¹æ•°æ®\r\n  * `public void set(V newReference, int newStamp)`ï¼šè®¾ç½®å€¼å’Œç‰ˆæœ¬å·\r\n  * `public V getReference()`ï¼šè¿”å›å¼•ç”¨çš„å€¼\r\n  * `public int getStamp()`ï¼šè¿”å›å½“å‰ç‰ˆæœ¬å·\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    AtomicStampedReference<Integer> atomicReference = new AtomicStampedReference<>(100,1);\r\n    int startStamp = atomicReference.getStamp();\r\n    new Thread(() ->{\r\n        int stamp = atomicReference.getStamp();\r\n        atomicReference.compareAndSet(100, 101, stamp, stamp + 1);\r\n        stamp = atomicReference.getStamp();\r\n        atomicReference.compareAndSet(101, 100, stamp, stamp + 1);\r\n    },\"t1\").start();\r\n\r\n    new Thread(() ->{\r\n        try {\r\n            Thread.sleep(1000);\r\n        } catch (InterruptedException e) {\r\n            e.printStackTrace();\r\n        }\r\n        if (!atomicReference.compareAndSet(100, 200, startStamp, startStamp + 1)) {\r\n            System.out.println(atomicReference.getReference());//100\r\n            System.out.println(Thread.currentThread().getName() + \"çº¿ç¨‹ä¿®æ”¹å¤±è´¥\");\r\n        }\r\n    },\"t2\").start();\r\n}\r\n```\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n#### AtomicMarkableReference\r\n\r\nAtomicStampedReference å¯ä»¥ç»™åŸå­å¼•ç”¨åŠ ä¸Šç‰ˆæœ¬å·ï¼Œè¿½è¸ªåŸå­å¼•ç”¨æ•´ä¸ªçš„å˜åŒ–è¿‡ç¨‹ï¼Œå¦‚ï¼š A -> B -> A -> C ï¼Œé€šè¿‡AtomicStampedReferenceï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¼•ç”¨å˜é‡ä¸­é€”è¢«æ›´æ”¹äº†å‡ æ¬¡ã€‚\r\nä½†æ˜¯æœ‰æ—¶å€™ï¼Œå¹¶ä¸å…³å¿ƒå¼•ç”¨å˜é‡æ›´æ”¹äº†å‡ æ¬¡ï¼Œåªæ˜¯å•çº¯çš„å…³å¿ƒ**æ˜¯å¦æ›´æ”¹è¿‡**ï¼Œæ‰€ä»¥å°±æœ‰äº† **AtomicMarkableReference**\r\n\r\n![image-20230714183156551](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230714183156551.png)\r\n\r\n```java\r\n@Slf4j(topic = \"c.Test38\")\r\npublic class Test38 {\r\n    public static void main(String[] args) throws InterruptedException {\r\n        GarbageBag bag = new GarbageBag(\"è£…æ»¡äº†åƒåœ¾\");\r\n        // å‚æ•°2 mark å¯ä»¥çœ‹ä½œä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºåƒåœ¾è¢‹æ»¡äº†\r\n        AtomicMarkableReference<GarbageBag> ref = new AtomicMarkableReference<>(bag, true);\r\n\r\n        log.debug(\"start...\");\r\n        GarbageBag prev = ref.getReference();\r\n        log.debug(prev.toString());\r\n\r\n        new Thread(() -> {\r\n            log.debug(\"start...\");\r\n            bag.setDesc(\"ç©ºåƒåœ¾è¢‹\");\r\n            ref.compareAndSet(bag, bag, true, false);\r\n            log.debug(bag.toString());\r\n        },\"ä¿æ´é˜¿å§¨\").start();\r\n\r\n        sleep(1);\r\n        log.debug(\"æƒ³æ¢ä¸€åªæ–°åƒåœ¾è¢‹ï¼Ÿ\");\r\n        boolean success = ref.compareAndSet(prev, new GarbageBag(\"ç©ºåƒåœ¾è¢‹\"), true, false);\r\n        log.debug(\"æ¢äº†ä¹ˆï¼Ÿ\" + success);\r\n        log.debug(ref.getReference().toString());\r\n    }\r\n}\r\n\r\nclass GarbageBag {\r\n    String desc;\r\n\r\n    public GarbageBag(String desc) {\r\n        this.desc = desc;\r\n    }\r\n\r\n    public void setDesc(String desc) {\r\n        this.desc = desc;\r\n    }\r\n\r\n    @Override\r\n    public String toString() {\r\n        return super.toString() + \" \" + desc;\r\n    }\r\n}\r\n```\r\n\r\n![image-20230714183338108](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230714183338108.png)\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n#### ä¸¤è€…çš„åŒºåˆ«\r\n\r\n- **AtomicStampedReference** éœ€è¦æˆ‘ä»¬ä¼ å…¥**æ•´å‹å˜é‡**ä½œä¸ºç‰ˆæœ¬å·ï¼Œæ¥åˆ¤å®šæ˜¯å¦è¢«æ›´æ”¹è¿‡\r\n- **AtomicMarkableReference**éœ€è¦æˆ‘ä»¬ä¼ å…¥**å¸ƒå°”å˜é‡**ä½œä¸ºæ ‡è®°ï¼Œæ¥åˆ¤æ–­æ˜¯å¦è¢«æ›´æ”¹è¿‡\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### Unsafe\r\n\r\nUnsafe æ˜¯ CAS çš„æ ¸å¿ƒç±»ï¼Œç”±äº Java æ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿï¼Œéœ€è¦é€šè¿‡æœ¬åœ°ï¼ˆNativeï¼‰æ–¹æ³•æ¥è®¿é—®\r\n\r\nUnsafe ç±»å­˜åœ¨ sun.misc åŒ…ï¼Œå…¶ä¸­æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ native ä¿®é¥°çš„ï¼Œéƒ½æ˜¯ç›´æ¥è°ƒç”¨**æ“ä½œç³»ç»Ÿåº•å±‚èµ„æº**æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ï¼ŒåŸºäºè¯¥ç±»å¯ä»¥ç›´æ¥æ“ä½œç‰¹å®šçš„å†…å­˜æ•°æ®ï¼Œå…¶å†…éƒ¨æ–¹æ³•æ“ä½œç±»ä¼¼ C çš„æŒ‡é’ˆ\r\n\r\næ¨¡æ‹Ÿå®ç°åŸå­æ•´æ•°ï¼š\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    MyAtomicInteger atomicInteger = new MyAtomicInteger(10);\r\n    if (atomicInteger.compareAndSwap(20)) {\r\n        System.out.println(atomicInteger.getValue());\r\n    }\r\n}\r\n\r\nclass MyAtomicInteger {\r\n    private static final Unsafe UNSAFE;\r\n    private static final long VALUE_OFFSET;\r\n    private volatile int value;\r\n\r\n    static {\r\n        try {\r\n            //Unsafe unsafe = Unsafe.getUnsafe()è¿™æ ·ä¼šæŠ¥é”™ï¼Œéœ€è¦åå°„è·å–\r\n            Field theUnsafe = Unsafe.class.getDeclaredField(\"theUnsafe\");\r\n            theUnsafe.setAccessible(true);\r\n            UNSAFE = (Unsafe) theUnsafe.get(null);\r\n            // è·å– value å±æ€§çš„å†…å­˜åœ°å€ï¼Œvalue å±æ€§æŒ‡å‘è¯¥åœ°å€ï¼Œç›´æ¥è®¾ç½®è¯¥åœ°å€çš„å€¼å¯ä»¥ä¿®æ”¹ value çš„å€¼\r\n            VALUE_OFFSET = UNSAFE.objectFieldOffset(\r\n                \t\t   MyAtomicInteger.class.getDeclaredField(\"value\"));\r\n        } catch (NoSuchFieldException | IllegalAccessException e) {\r\n            e.printStackTrace();\r\n            throw new RuntimeException();\r\n        }\r\n    }\r\n\r\n    public MyAtomicInteger(int value) {\r\n        this.value = value;\r\n    }\r\n    public int getValue() {\r\n        return value;\r\n    }\r\n\r\n    public boolean compareAndSwap(int update) {\r\n        while (true) {\r\n            int prev = this.value;\r\n            int next = update;\r\n            //\t\t\t\t\t\t\tå½“å‰å¯¹è±¡  å†…å­˜åç§»é‡    æœŸæœ›å€¼ æ›´æ–°å€¼\r\n            if (UNSAFE.compareAndSwapInt(this, VALUE_OFFSET, prev, update)) {\r\n                System.out.println(\"CASæˆåŠŸ\");\r\n                return true;\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### final\r\n\r\n#### åŸç†\r\n\r\n```java\r\npublic class TestFinal {\r\n\tfinal int a = 20;\r\n}\r\n```\r\n\r\nå­—èŠ‚ç ï¼š\r\n\r\n```java\r\n0: aload_0\r\n1: invokespecial #1 // Method java/lang/Object.\"<init>\":()V\r\n4: aload_0\r\n5: bipush 20\t\t// å°†å€¼ç›´æ¥æ”¾å…¥æ ˆä¸­\r\n7: putfield #2 \t\t// Field a:I\r\n<-- å†™å±éšœ\r\n10: return\r\n```\r\n\r\nfinal å˜é‡çš„èµ‹å€¼é€šè¿‡ putfield æŒ‡ä»¤æ¥å®Œæˆï¼Œåœ¨è¿™æ¡æŒ‡ä»¤ä¹‹åä¹Ÿä¼šåŠ å…¥å†™å±éšœï¼Œä¿è¯åœ¨å…¶å®ƒçº¿ç¨‹è¯»åˆ°å®ƒçš„å€¼æ—¶ä¸ä¼šå‡ºç°ä¸º 0 çš„æƒ…å†µ\r\n\r\nå…¶ä»–çº¿ç¨‹è®¿é—® final ä¿®é¥°çš„å˜é‡**ä¼šå¤åˆ¶ä¸€ä»½æ”¾å…¥æ ˆä¸­**ï¼Œæ•ˆç‡æ›´é«˜\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä¸å¯å˜\r\n\r\nä¸å¯å˜ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡ä¸èƒ½å¤Ÿä¿®æ”¹å…¶å†…éƒ¨çŠ¶æ€ï¼ˆå±æ€§ï¼‰ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸å¯å˜å¯¹è±¡\r\n\r\nä¸å¯å˜å¯¹è±¡çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸å­˜åœ¨å¹¶å‘ä¿®æ”¹å’Œå¯è§æ€§é—®é¢˜ï¼Œæ˜¯å¦ä¸€ç§é¿å…ç«äº‰çš„æ–¹å¼\r\n\r\nString ç±»ä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œè¯¥ç±»å’Œç±»ä¸­æ‰€æœ‰å±æ€§éƒ½æ˜¯ final çš„\r\n\r\n* ç±»ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥ç±»ä¸­çš„æ–¹æ³•ä¸èƒ½è¢«è¦†ç›–ï¼Œé˜²æ­¢å­ç±»æ— æ„é—´ç ´åä¸å¯å˜æ€§\r\n\r\n* æ— å†™å…¥æ–¹æ³•ï¼ˆsetï¼‰ç¡®ä¿å¤–éƒ¨ä¸èƒ½å¯¹å†…éƒ¨å±æ€§è¿›è¡Œä¿®æ”¹\r\n\r\n* å±æ€§ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸èƒ½ä¿®æ”¹\r\n\r\n  ```java\r\n  public final class String\r\n      implements java.io.Serializable, Comparable<String>, CharSequence {\r\n      /** The value is used for character storage. */\r\n      private final char value[];\r\n      //....\r\n  }\r\n  ```\r\n\r\n* æ›´æ”¹ String ç±»æ•°æ®æ—¶ï¼Œä¼šæ„é€ æ–°å­—ç¬¦ä¸²å¯¹è±¡ï¼Œç”Ÿæˆæ–°çš„ char[] valueï¼Œé€šè¿‡**åˆ›å»ºå‰¯æœ¬å¯¹è±¡æ¥é¿å…å…±äº«çš„æ–¹å¼ç§°ä¹‹ä¸ºä¿æŠ¤æ€§æ‹·è´**\r\n\r\n  \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### State\r\n\r\næ— çŠ¶æ€ï¼šæˆå‘˜å˜é‡ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥ç§°ä¸ºçŠ¶æ€ä¿¡æ¯ï¼Œæ— çŠ¶æ€å°±æ˜¯æ²¡æœ‰æˆå‘˜å˜é‡\r\n\r\nServlet ä¸ºäº†ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ï¼Œä¸€èˆ¬ä¸ä¸º Servlet è®¾ç½®æˆå‘˜å˜é‡ï¼Œè¿™ç§æ²¡æœ‰ä»»ä½•æˆå‘˜å˜é‡çš„ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### Local\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\nThreadLocal ç±»ç”¨æ¥æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œè¿™ç§å˜é‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è®¿é—®ï¼ˆé€šè¿‡ get å’Œ set æ–¹æ³•è®¿é—®ï¼‰æ—¶èƒ½ä¿è¯å„ä¸ªçº¿ç¨‹çš„å˜é‡ç›¸å¯¹ç‹¬ç«‹äºå…¶ä»–çº¿ç¨‹å†…çš„å˜é‡ï¼Œåˆ†é…åœ¨å †å†…çš„ **TLAB** ä¸­\r\n\r\nThreadLocal å®ä¾‹é€šå¸¸æ¥è¯´éƒ½æ˜¯ `private static` ç±»å‹çš„ï¼Œå±äºä¸€ä¸ªçº¿ç¨‹çš„æœ¬åœ°å˜é‡ï¼Œç”¨äºå…³è”çº¿ç¨‹å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šåœ¨ ThreadLocal ä¸­ä¿å­˜ä¸€ä»½è¯¥çº¿ç¨‹ç‹¬æœ‰çš„æ•°æ®ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„\r\n\r\nThreadLocal ä½œç”¨ï¼š\r\n\r\n* çº¿ç¨‹å¹¶å‘ï¼šåº”ç”¨åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„åœºæ™¯ä¸‹\r\n\r\n* ä¼ é€’æ•°æ®ï¼šé€šè¿‡ ThreadLocal å®ç°åœ¨åŒä¸€çº¿ç¨‹ä¸åŒå‡½æ•°æˆ–ç»„ä»¶ä¸­ä¼ é€’å…¬å…±å˜é‡ï¼Œå‡å°‘ä¼ é€’å¤æ‚åº¦\r\n\r\n* çº¿ç¨‹éš”ç¦»ï¼šæ¯ä¸ªçº¿ç¨‹çš„å˜é‡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šäº’ç›¸å½±å“\r\n\r\nå¯¹æ¯” synchronizedï¼š\r\n\r\n|        | synchronized                                                 | ThreadLocal                                                  |\r\n| ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |\r\n| åŸç†   | åŒæ­¥æœºåˆ¶é‡‡ç”¨**ä»¥æ—¶é—´æ¢ç©ºé—´**çš„æ–¹å¼ï¼Œåªæä¾›äº†ä¸€ä»½å˜é‡ï¼Œè®©ä¸åŒçš„çº¿ç¨‹æ’é˜Ÿè®¿é—® | ThreadLocal é‡‡ç”¨**ä»¥ç©ºé—´æ¢æ—¶é—´**çš„æ–¹å¼ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æä¾›äº†ä¸€ä»½å˜é‡çš„å‰¯æœ¬ï¼Œä»è€Œå®ç°åŒæ—¶è®¿é—®è€Œäº’ä¸å¹²æ‰° |\r\n| ä¾§é‡ç‚¹ | å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥                                   | å¤šçº¿ç¨‹ä¸­è®©æ¯ä¸ªçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»                         |\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åŸºæœ¬ä½¿ç”¨\r\n\r\n##### å¸¸ç”¨æ–¹æ³•\r\n\r\n| æ–¹æ³•                       | æè¿°                         |\r\n| -------------------------- | ---------------------------- |\r\n| ThreadLocal<>()            | åˆ›å»º ThreadLocal å¯¹è±¡        |\r\n| protected T initialValue() | è¿”å›å½“å‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼ |\r\n| public void set( T value)  | è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡   |\r\n| public T get()             | è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡   |\r\n| public void remove()       | ç§»é™¤å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡   |\r\n\r\n```java\r\npublic class MyDemo {\r\n\r\n    private static ThreadLocal<String> tl = new ThreadLocal<>();\r\n\r\n    private String content;\r\n\r\n    private String getContent() {\r\n        // è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å˜é‡\r\n        return tl.get();\r\n    }\r\n\r\n    private void setContent(String content) {\r\n        // å˜é‡contentç»‘å®šåˆ°å½“å‰çº¿ç¨‹\r\n        tl.set(content);\r\n    }\r\n\r\n    public static void main(String[] args) {\r\n        MyDemo demo = new MyDemo();\r\n        for (int i = 0; i < 5; i++) {\r\n            Thread thread = new Thread(new Runnable() {\r\n                @Override\r\n                public void run() {\r\n                    // è®¾ç½®æ•°æ®\r\n                    demo.setContent(Thread.currentThread().getName() + \"çš„æ•°æ®\");\r\n                    System.out.println(\"-----------------------\");\r\n                    System.out.println(Thread.currentThread().getName() + \"--->\" + demo.getContent());\r\n                }\r\n            });\r\n            thread.setName(\"çº¿ç¨‹\" + i);\r\n            thread.start();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### åº”ç”¨åœºæ™¯\r\n\r\nThreadLocal é€‚ç”¨äºä¸‹é¢ä¸¤ç§åœºæ™¯ï¼š\r\n\r\n- æ¯ä¸ªçº¿ç¨‹éœ€è¦æœ‰è‡ªå·±å•ç‹¬çš„å®ä¾‹\r\n- å®ä¾‹éœ€è¦åœ¨å¤šä¸ªæ–¹æ³•ä¸­å…±äº«ï¼Œä½†ä¸å¸Œæœ›è¢«å¤šçº¿ç¨‹å…±äº«\r\n\r\nThreadLocal æ–¹æ¡ˆæœ‰ä¸¤ä¸ªçªå‡ºçš„ä¼˜åŠ¿ï¼š \r\n\r\n1. ä¼ é€’æ•°æ®ï¼šä¿å­˜æ¯ä¸ªçº¿ç¨‹ç»‘å®šçš„æ•°æ®ï¼Œåœ¨éœ€è¦çš„åœ°æ–¹å¯ä»¥ç›´æ¥è·å–ï¼Œé¿å…å‚æ•°ç›´æ¥ä¼ é€’å¸¦æ¥çš„ä»£ç è€¦åˆé—®é¢˜\r\n2. çº¿ç¨‹éš”ç¦»ï¼šå„çº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»å´åˆå…·å¤‡å¹¶å‘æ€§ï¼Œé¿å…åŒæ­¥æ–¹å¼å¸¦æ¥çš„æ€§èƒ½æŸå¤±\r\n\r\nThreadLocal ç”¨äºæ•°æ®è¿æ¥çš„äº‹åŠ¡ç®¡ç†ï¼š\r\n\r\n```java\r\npublic class JdbcUtils {\r\n    // ThreadLocalå¯¹è±¡ï¼Œå°†connectionç»‘å®šåœ¨å½“å‰çº¿ç¨‹ä¸­\r\n    private static final ThreadLocal<Connection> tl = new ThreadLocal();\r\n    // c3p0 æ•°æ®åº“è¿æ¥æ± å¯¹è±¡å±æ€§\r\n    private static final ComboPooledDataSource ds = new ComboPooledDataSource();\r\n    // è·å–è¿æ¥\r\n    public static Connection getConnection() throws SQLException {\r\n        //å–å‡ºå½“å‰çº¿ç¨‹ç»‘å®šçš„connectionå¯¹è±¡\r\n        Connection conn = tl.get();\r\n        if (conn == null) {\r\n            //å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä»è¿æ¥æ± ä¸­å–å‡º\r\n            conn = ds.getConnection();\r\n            //å†å°†connectionå¯¹è±¡ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ä¸­ï¼Œéå¸¸é‡è¦çš„æ“ä½œ\r\n            tl.set(conn);\r\n        }\r\n        return conn;\r\n    }\r\n\t// ...\r\n}\r\n```\r\n\r\nç”¨ ThreadLocal ä½¿ SimpleDateFormat ä»ç‹¬äº«å˜é‡å˜æˆå•ä¸ªçº¿ç¨‹å˜é‡ï¼š\r\n\r\n```java\r\npublic class ThreadLocalDateUtil {\r\n    private static ThreadLocal<DateFormat> threadLocal = new ThreadLocal<DateFormat>() {\r\n        @Override\r\n        protected DateFormat initialValue() {\r\n            return new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\");\r\n        }\r\n    };\r\n\r\n    public static Date parse(String dateStr) throws ParseException {\r\n        return threadLocal.get().parse(dateStr);\r\n    }\r\n\r\n    public static String format(Date date) {\r\n        return threadLocal.get().format(date);\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### å®ç°åŸç†\r\n\r\n##### åº•å±‚ç»“æ„\r\n\r\nJDK8 ä»¥å‰ï¼šæ¯ä¸ª ThreadLocal éƒ½åˆ›å»ºä¸€ä¸ª Mapï¼Œç„¶åç”¨çº¿ç¨‹ä½œä¸º Map çš„ keyï¼Œè¦å­˜å‚¨çš„å±€éƒ¨å˜é‡ä½œä¸º Map çš„ valueï¼Œè¾¾åˆ°å„ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡éš”ç¦»çš„æ•ˆæœã€‚è¿™ç§ç»“æ„ä¼šé€ æˆ Map ç»“æ„è¿‡å¤§å’Œå†…å­˜æ³„éœ²ï¼Œå› ä¸º Thread åœæ­¢åæ— æ³•é€šè¿‡ key åˆ é™¤å¯¹åº”çš„æ•°æ®\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824171552294.png\" alt=\"image-20230824171552294\" class=\"scale-80\" />\r\n\r\nJDK8 ä»¥åï¼šæ¯ä¸ª Thread ç»´æŠ¤ä¸€ä¸ª ThreadLocalMapï¼Œè¿™ä¸ª Map çš„ key æ˜¯ ThreadLocal å®ä¾‹æœ¬èº«ï¼Œvalue æ˜¯çœŸæ­£è¦å­˜å‚¨çš„å€¼\r\n\r\n* **æ¯ä¸ª Thread çº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª Map (ThreadLocalMap)**\r\n* Map é‡Œé¢å­˜å‚¨ ThreadLocal å¯¹è±¡ï¼ˆkeyï¼‰å’Œçº¿ç¨‹çš„ç§æœ‰å˜é‡ï¼ˆvalueï¼‰\r\n* Thread å†…éƒ¨çš„ Map æ˜¯ç”± ThreadLocal ç»´æŠ¤çš„ï¼Œç”± ThreadLocal è´Ÿè´£å‘ map è·å–å’Œè®¾ç½®çº¿ç¨‹çš„å˜é‡å€¼\r\n* å¯¹äºä¸åŒçš„çº¿ç¨‹ï¼Œæ¯æ¬¡è·å–å‰¯æœ¬å€¼æ—¶ï¼Œåˆ«çš„çº¿ç¨‹å¹¶ä¸èƒ½è·å–åˆ°å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å€¼ï¼Œå½¢æˆå‰¯æœ¬çš„éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824171625312.png\" alt=\"image-20230824171625312\" class=\"scale-80\" />\r\n\r\nJDK8 å‰åå¯¹æ¯”ï¼š\r\n\r\n* æ¯ä¸ª Map å­˜å‚¨çš„ Entry æ•°é‡ä¼šå˜å°‘ï¼Œå› ä¸ºä¹‹å‰çš„å­˜å‚¨æ•°é‡ç”± Thread çš„æ•°é‡å†³å®šï¼Œç°åœ¨ç”± ThreadLocal çš„æ•°é‡å†³å®šï¼Œåœ¨å®é™…ç¼–ç¨‹å½“ä¸­ï¼Œå¾€å¾€ ThreadLocal çš„æ•°é‡è¦å°‘äº Thread çš„æ•°é‡\r\n* å½“ Thread é”€æ¯ä¹‹åï¼Œå¯¹åº”çš„ ThreadLocalMap ä¹Ÿä¼šéšä¹‹é”€æ¯ï¼Œèƒ½å‡å°‘å†…å­˜çš„ä½¿ç”¨ï¼Œ**é˜²æ­¢å†…å­˜æ³„éœ²**\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æˆå‘˜å˜é‡\r\n\r\n* Thread ç±»çš„ç›¸å…³å±æ€§ï¼š**æ¯ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ä¸€ä¸ª ThreadLocalMap å¯¹è±¡**ï¼Œå­˜æ”¾ç”± ThreadLocal å’Œæ•°æ®ç»„æˆçš„ Entry é”®å€¼å¯¹\r\n\r\n  ```java\r\n  ThreadLocal.ThreadLocalMap threadLocals = null\r\n  ```\r\n\r\n* è®¡ç®— ThreadLocal å¯¹è±¡çš„å“ˆå¸Œå€¼ï¼š\r\n\r\n  ```java\r\n  private final int threadLocalHashCode = nextHashCode()\r\n  ```\r\n\r\n  ä½¿ç”¨ `threadLocalHashCode & (table.length - 1)` è®¡ç®—å½“å‰ entry éœ€è¦å­˜æ”¾çš„ä½ç½®\r\n\r\n* æ¯åˆ›å»ºä¸€ä¸ª ThreadLocal å¯¹è±¡å°±ä¼šä½¿ç”¨ nextHashCode åˆ†é…ä¸€ä¸ª hash å€¼ç»™è¿™ä¸ªå¯¹è±¡ï¼š\r\n\r\n  ```java\r\n  private static AtomicInteger nextHashCode = new AtomicInteger()\r\n  ```\r\n\r\n* æ–æ³¢é‚£å¥‘æ•°ä¹Ÿå«é»„é‡‘åˆ†å‰²æ•°ï¼Œhash çš„**å¢é‡**å°±æ˜¯è¿™ä¸ªæ•°å­—ï¼Œå¸¦æ¥çš„å¥½å¤„æ˜¯ hash åˆ†å¸ƒéå¸¸å‡åŒ€ï¼š\r\n\r\n  ```java\r\n  private static final int HASH_INCREMENT = 0x61c88647\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æˆå‘˜æ–¹æ³•\r\n\r\næ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸º ThreadLocal å±äºä¸€ä¸ªçº¿ç¨‹çš„ï¼ŒThreadLocal ä¸­çš„æ–¹æ³•ï¼Œé€»è¾‘éƒ½æ˜¯è·å–å½“å‰çº¿ç¨‹ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡ï¼Œç„¶åè¿›è¡Œæ•°æ®çš„å¢åˆ æ”¹æŸ¥ï¼Œæ²¡æœ‰æŒ‡å®šåˆå§‹å€¼çš„ threadlcoal å¯¹è±¡é»˜è®¤èµ‹å€¼ä¸º null\r\n\r\n* initialValue()ï¼šè¿”å›è¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼\r\n\r\n  * å»¶è¿Ÿè°ƒç”¨çš„æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œ get æ–¹æ³•æ—¶æ‰æ‰§è¡Œ\r\n  * è¯¥æ–¹æ³•ç¼ºçœï¼ˆé»˜è®¤ï¼‰å®ç°ç›´æ¥è¿”å›ä¸€ä¸ª null\r\n  * å¦‚æœæƒ³è¦ä¸€ä¸ªåˆå§‹å€¼ï¼Œå¯ä»¥é‡å†™æ­¤æ–¹æ³•ï¼Œ è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ª `protected` çš„æ–¹æ³•ï¼Œä¸ºäº†è®©å­ç±»è¦†ç›–è€Œè®¾è®¡çš„\r\n\r\n  ```java\r\n  protected T initialValue() {\r\n      return null;\r\n  }\r\n  ```\r\n\r\n* nextHashCode()ï¼šè®¡ç®—å“ˆå¸Œå€¼ï¼ŒThreadLocal çš„æ•£åˆ—æ–¹å¼ç§°ä¹‹ä¸º**æ–æ³¢é‚£å¥‘æ•£åˆ—**ï¼Œæ¯æ¬¡è·å–å“ˆå¸Œå€¼éƒ½ä¼šåŠ ä¸Š HASH_INCREMENTï¼Œè¿™æ ·åšå¯ä»¥å°½é‡é¿å… hash å†²çªï¼Œè®©å“ˆå¸Œå€¼èƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨ 2 çš„ n æ¬¡æ–¹çš„æ•°ç»„ä¸­\r\n\r\n  ```java\r\n  private static int nextHashCode() {\r\n      // å“ˆå¸Œå€¼è‡ªå¢ä¸€ä¸ª HASH_INCREMENT æ•°å€¼\r\n      return nextHashCode.getAndAdd(HASH_INCREMENT);\r\n  }\r\n  ```\r\n\r\n* set()ï¼šä¿®æ”¹å½“å‰çº¿ç¨‹ä¸å½“å‰ threadlocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡\r\n\r\n  ```java\r\n  public void set(T value) {\r\n      // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡\r\n      Thread t = Thread.currentThread();\r\n      // è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡\r\n      ThreadLocalMap map = getMap(t);\r\n      // åˆ¤æ–­ map æ˜¯å¦å­˜åœ¨\r\n      if (map != null)\r\n          // è°ƒç”¨ threadLocalMap.set æ–¹æ³•è¿›è¡Œé‡å†™æˆ–è€…æ·»åŠ \r\n          map.set(this, value);\r\n      else\r\n          // map ä¸ºç©ºï¼Œè°ƒç”¨ createMap è¿›è¡Œ ThreadLocalMap å¯¹è±¡çš„åˆå§‹åŒ–ã€‚å‚æ•°1æ˜¯å½“å‰çº¿ç¨‹ï¼Œå‚æ•°2æ˜¯å±€éƒ¨å˜é‡\r\n          createMap(t, value);\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // è·å–å½“å‰çº¿ç¨‹ Thread å¯¹åº”ç»´æŠ¤çš„ ThreadLocalMap \r\n  ThreadLocalMap getMap(Thread t) {\r\n      return t.threadLocals;\r\n  }\r\n  // åˆ›å»ºå½“å‰çº¿ç¨‹Threadå¯¹åº”ç»´æŠ¤çš„ThreadLocalMap \r\n  void createMap(Thread t, T firstValue) {\r\n      // ã€è¿™é‡Œçš„ this æ˜¯è°ƒç”¨æ­¤æ–¹æ³•çš„ threadLocalã€‘ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Map å¹¶è®¾ç½®ç¬¬ä¸€ä¸ªæ•°æ®\r\n      t.threadLocals = new ThreadLocalMap(this, firstValue);\r\n  }\r\n  ```\r\n\r\n* get()ï¼šè·å–å½“å‰çº¿ç¨‹ä¸å½“å‰ ThreadLocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡\r\n\r\n  ```java\r\n  public T get() {\r\n      Thread t = Thread.currentThread();\r\n      ThreadLocalMap map = getMap(t);\r\n      // å¦‚æœæ­¤mapå­˜åœ¨\r\n      if (map != null) {\r\n          // ä»¥å½“å‰çš„ ThreadLocal ä¸º keyï¼Œè°ƒç”¨ getEntry è·å–å¯¹åº”çš„å­˜å‚¨å®ä½“ e\r\n          ThreadLocalMap.Entry e = map.getEntry(this);\r\n          // å¯¹ e è¿›è¡Œåˆ¤ç©º \r\n          if (e != null) {\r\n              // è·å–å­˜å‚¨å®ä½“ e å¯¹åº”çš„ valueå€¼\r\n              T result = (T)e.value;\r\n              return result;\r\n          }\r\n      }\r\n      /*æœ‰ä¸¤ç§æƒ…å†µæœ‰æ‰§è¡Œå½“å‰ä»£ç \r\n        ç¬¬ä¸€ç§æƒ…å†µ: map ä¸å­˜åœ¨ï¼Œè¡¨ç¤ºæ­¤çº¿ç¨‹æ²¡æœ‰ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡\r\n        ç¬¬äºŒç§æƒ…å†µ: map å­˜åœ¨, ä½†æ˜¯ã€æ²¡æœ‰ä¸å½“å‰ ThreadLocal å…³è”çš„ entryã€‘ï¼Œå°±ä¼šè®¾ç½®ä¸ºé»˜è®¤å€¼ */\r\n      // åˆå§‹åŒ–å½“å‰çº¿ç¨‹ä¸å½“å‰ threadLocal å¯¹è±¡ç›¸å…³è”çš„ value\r\n      return setInitialValue();\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  private T setInitialValue() {\r\n      // è°ƒç”¨initialValueè·å–åˆå§‹åŒ–çš„å€¼ï¼Œæ­¤æ–¹æ³•å¯ä»¥è¢«å­ç±»é‡å†™, å¦‚æœä¸é‡å†™é»˜è®¤è¿”å› null\r\n      T value = initialValue();\r\n      Thread t = Thread.currentThread();\r\n      ThreadLocalMap map = getMap(t);\r\n      // åˆ¤æ–­ map æ˜¯å¦åˆå§‹åŒ–è¿‡\r\n      if (map != null)\r\n          // å­˜åœ¨åˆ™è°ƒç”¨ map.set è®¾ç½®æ­¤å®ä½“ entryï¼Œvalue æ˜¯é»˜è®¤çš„å€¼\r\n          map.set(this, value);\r\n      else\r\n          // è°ƒç”¨ createMap è¿›è¡Œ ThreadLocalMap å¯¹è±¡çš„åˆå§‹åŒ–ä¸­\r\n          createMap(t, value);\r\n      // è¿”å›çº¿ç¨‹ä¸å½“å‰ threadLocal å…³è”çš„å±€éƒ¨å˜é‡\r\n      return value;\r\n  }\r\n  ```\r\n\r\n* remove()ï¼šç§»é™¤å½“å‰çº¿ç¨‹ä¸å½“å‰ threadLocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡\r\n\r\n  ```java\r\n  public void remove() {\r\n      // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡\r\n      ThreadLocalMap m = getMap(Thread.currentThread());\r\n      if (m != null)\r\n          // map å­˜åœ¨åˆ™è°ƒç”¨ map.removeï¼Œthisæ—¶å½“å‰ThreadLocalï¼Œä»¥thisä¸ºkeyåˆ é™¤å¯¹åº”çš„å®ä½“\r\n          m.remove(this);\r\n  }\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### LocalMap\r\n\r\n##### æˆå‘˜å±æ€§\r\n\r\nThreadLocalMap æ˜¯ ThreadLocal çš„å†…éƒ¨ç±»ï¼Œæ²¡æœ‰å®ç° Map æ¥å£ï¼Œç”¨ç‹¬ç«‹çš„æ–¹å¼å®ç°äº† Map çš„åŠŸèƒ½ï¼Œå…¶å†…éƒ¨ Entry ä¹Ÿæ˜¯ç‹¬ç«‹å®ç°\r\n\r\n```java\r\n// åˆå§‹åŒ–å½“å‰ map å†…éƒ¨æ•£åˆ—è¡¨æ•°ç»„çš„åˆå§‹é•¿åº¦ 16\r\nprivate static final int INITIAL_CAPACITY = 16;\r\n\r\n// å­˜æ”¾æ•°æ®çš„tableï¼Œæ•°ç»„é•¿åº¦å¿…é¡»æ˜¯2çš„æ•´æ¬¡å¹‚ã€‚\r\nprivate Entry[] table;\r\n\r\n// æ•°ç»„é‡Œé¢ entrys çš„ä¸ªæ•°ï¼Œå¯ä»¥ç”¨äºåˆ¤æ–­ table å½“å‰ä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼\r\nprivate int size = 0;\r\n\r\n// è¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼ï¼Œè¡¨ä½¿ç”¨é‡å¤§äºå®ƒçš„æ—¶å€™è¿›è¡Œæ‰©å®¹ã€‚\r\nprivate int threshold;\r\n```\r\n\r\nå­˜å‚¨ç»“æ„ Entryï¼š\r\n\r\n* Entry ç»§æ‰¿ WeakReferenceï¼Œkey æ˜¯å¼±å¼•ç”¨ï¼Œç›®çš„æ˜¯å°† ThreadLocal å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè§£ç»‘\r\n* Entry é™åˆ¶åªèƒ½ç”¨ ThreadLocal ä½œä¸º keyï¼Œkey ä¸º null (entry.get() == null) æ„å‘³ç€ key ä¸å†è¢«å¼•ç”¨ï¼Œentry ä¹Ÿå¯ä»¥ä» table ä¸­æ¸…é™¤\r\n\r\n```java\r\nstatic class Entry extends WeakReference<ThreadLocal<?>> {\r\n    Object value;\r\n    Entry(ThreadLocal<?> k, Object v) {\r\n        // this.referent = referent = key;\r\n        super(k);\r\n        value = v;\r\n    }\r\n}\r\n```\r\n\r\næ„é€ æ–¹æ³•ï¼šå»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œçº¿ç¨‹ç¬¬ä¸€æ¬¡å­˜å‚¨ threadLocal - value æ—¶æ‰ä¼šåˆ›å»º threadLocalMap å¯¹è±¡\r\n\r\n```java\r\nThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {\r\n    // åˆå§‹åŒ–tableï¼Œåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º16çš„Entryæ•°ç»„\r\n    table = new Entry[INITIAL_CAPACITY];\r\n    // ã€å¯»å€ç®—æ³•ã€‘è®¡ç®—ç´¢å¼•\r\n    int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);\r\n    // åˆ›å»º entry å¯¹è±¡ï¼Œå­˜æ”¾åˆ°æŒ‡å®šä½ç½®çš„ slot ä¸­\r\n    table[i] = new Entry(firstKey, firstValue);\r\n    // æ•°æ®æ€»é‡æ˜¯ 1\r\n    size = 1;\r\n    // å°†é˜ˆå€¼è®¾ç½®ä¸º ï¼ˆå½“å‰æ•°ç»„é•¿åº¦ * 2ï¼‰/ 3ã€‚\r\n    setThreshold(INITIAL_CAPACITY);\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æˆå‘˜æ–¹æ³•\r\n\r\n* set()ï¼šæ·»åŠ æ•°æ®ï¼ŒThreadLocalMap ä½¿ç”¨**çº¿æ€§æ¢æµ‹æ³•æ¥è§£å†³å“ˆå¸Œå†²çª**\r\n\r\n  * è¯¥æ–¹æ³•ä¼šä¸€ç›´æ¢æµ‹ä¸‹ä¸€ä¸ªåœ°å€ï¼Œç›´åˆ°æœ‰ç©ºçš„åœ°å€åæ’å…¥ï¼Œè‹¥æ’å…¥å Map æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œæ•°ç»„ä¼šæ‰©å®¹ä¸ºåŸæ¥çš„ 2 å€\r\n\r\n    å‡è®¾å½“å‰ table é•¿åº¦ä¸º16ï¼Œè®¡ç®—å‡ºæ¥ key çš„ hash å€¼ä¸º 14ï¼Œå¦‚æœ table[14] ä¸Šå·²ç»æœ‰å€¼ï¼Œå¹¶ä¸”å…¶ key ä¸å½“å‰ key ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±å‘ç”Ÿäº† hash å†²çªï¼Œè¿™ä¸ªæ—¶å€™å°† 14 åŠ  1 å¾—åˆ° 15ï¼Œå– table[15] è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¿˜æ˜¯å†²çªä¼šå›åˆ° 0ï¼Œå– table[0]ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°å¯ä»¥æ’å…¥ï¼Œå¯ä»¥æŠŠ Entry[]  table çœ‹æˆä¸€ä¸ª**ç¯å½¢æ•°ç»„**\r\n\r\n  * çº¿æ€§æ¢æµ‹æ³•ä¼šå‡ºç°**å †ç§¯é—®é¢˜**ï¼Œå¯ä»¥é‡‡å–å¹³æ–¹æ¢æµ‹æ³•è§£å†³\r\n\r\n  * åœ¨æ¢æµ‹è¿‡ç¨‹ä¸­ ThreadLocal ä¼šå¤ç”¨ key ä¸º null çš„è„ Entry å¯¹è±¡ï¼Œå¹¶è¿›è¡Œåƒåœ¾æ¸…ç†ï¼Œé˜²æ­¢å‡ºç°å†…å­˜æ³„æ¼\r\n\r\n  ```java\r\n  private void set(ThreadLocal<?> key, Object value) {\r\n      // è·å–æ•£åˆ—è¡¨\r\n      ThreadLocal.ThreadLocalMap.Entry[] tab = table;\r\n      int len = tab.length;\r\n      // å“ˆå¸Œå¯»å€\r\n      int i = key.threadLocalHashCode & (len-1);\r\n      // ä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•å‘åæŸ¥æ‰¾å…ƒç´ ï¼Œç¢°åˆ° entry ä¸ºç©ºæ—¶åœæ­¢æ¢æµ‹\r\n      for (ThreadLocal.ThreadLocalMap.Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) {\r\n          // è·å–å½“å‰å…ƒç´  key\r\n          ThreadLocal<?> k = e.get();\r\n          // ThreadLocal å¯¹åº”çš„ key å­˜åœ¨ï¼Œã€ç›´æ¥è¦†ç›–ä¹‹å‰çš„å€¼ã€‘\r\n          if (k == key) {\r\n              e.value = value;\r\n              return;\r\n          }\r\n          // ã€è¿™ä¸¤ä¸ªæ¡ä»¶è°å…ˆæˆç«‹ä¸ä¸€å®šï¼Œæ‰€ä»¥ replaceStaleEntry ä¸­è¿˜éœ€è¦åˆ¤æ–­ k == key çš„æƒ…å†µã€‘\r\n          \r\n          // key ä¸º nullï¼Œä½†æ˜¯å€¼ä¸ä¸º nullï¼Œè¯´æ˜ä¹‹å‰çš„ ThreadLocal å¯¹è±¡å·²ç»è¢«å›æ”¶äº†ï¼Œå½“å‰æ˜¯ã€è¿‡æœŸæ•°æ®ã€‘\r\n          if (k == null) {\r\n              // ã€ç¢°åˆ°ä¸€ä¸ªè¿‡æœŸçš„ slotï¼Œå½“å‰æ•°æ®å¤ç”¨è¯¥æ§½ä½ï¼Œæ›¿æ¢è¿‡æœŸæ•°æ®ã€‘\r\n              // è¿™ä¸ªæ–¹æ³•è¿˜è¿›è¡Œäº†åƒåœ¾æ¸…ç†åŠ¨ä½œï¼Œé˜²æ­¢å†…å­˜æ³„æ¼\r\n              replaceStaleEntry(key, value, i);\r\n              return;\r\n          }\r\n      }\r\n  \t// é€»è¾‘åˆ°è¿™è¯´æ˜ç¢°åˆ° slot == null çš„ä½ç½®ï¼Œåˆ™åœ¨ç©ºå…ƒç´ çš„ä½ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„ Entry\r\n      tab[i] = new Entry(key, value);\r\n      // æ•°é‡ + 1\r\n      int sz = ++size;\r\n      \r\n      // ã€åšä¸€æ¬¡å¯å‘å¼æ¸…ç†ã€‘ï¼Œå¦‚æœæ²¡æœ‰æ¸…é™¤ä»»ä½• entry å¹¶ä¸”ã€å½“å‰ä½¿ç”¨é‡è¾¾åˆ°äº†è´Ÿè½½å› å­æ‰€å®šä¹‰ï¼Œé‚£ä¹ˆè¿›è¡Œ rehash\r\n      if (!cleanSomeSlots(i, sz) && sz >= threshold)\r\n          // æ‰©å®¹\r\n          rehash();\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // è·å–ã€ç¯å½¢æ•°ç»„ã€‘çš„ä¸‹ä¸€ä¸ªç´¢å¼•\r\n  private static int nextIndex(int i, int len) {\r\n      // ç´¢å¼•è¶Šç•Œåä» 0 å¼€å§‹ç»§ç»­è·å–\r\n      return ((i + 1 < len) ? i + 1 : 0);\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // åœ¨æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šçš„æ•°æ®\r\n  private void replaceStaleEntry(ThreadLocal<?> key, Object value, int staleSlot) {\r\n      // è·å–æ•£åˆ—è¡¨\r\n      Entry[] tab = table;\r\n      int len = tab.length;\r\n      Entry e;\r\n  \t// æ¢æµ‹å¼æ¸…ç†çš„å¼€å§‹ä¸‹æ ‡ï¼Œé»˜è®¤ä»å½“å‰ staleSlot å¼€å§‹\r\n      int slotToExpunge = staleSlot;\r\n      // ä»¥å½“å‰ staleSlot å¼€å§‹ã€å‘å‰è¿­ä»£æŸ¥æ‰¾ã€‘ï¼Œæ‰¾åˆ°ç´¢å¼•é å‰è¿‡æœŸæ•°æ®ï¼Œæ‰¾åˆ°ä»¥åæ›¿æ¢ slotToExpunge å€¼\r\n      // ã€ä¿è¯åœ¨ä¸€ä¸ªåŒºé—´æ®µå†…ï¼Œä»æœ€å‰é¢çš„è¿‡æœŸæ•°æ®å¼€å§‹æ¸…ç†ã€‘\r\n      for (int i = prevIndex(staleSlot, len); (e = tab[i]) != null; i = prevIndex(i, len))\r\n          if (e.get() == null)\r\n              slotToExpunge = i;\r\n  \r\n  \t// ä»¥ staleSlot ã€å‘åå»æŸ¥æ‰¾ã€‘ï¼Œç›´åˆ°ç¢°åˆ° null ä¸ºæ­¢ï¼Œè¿˜æ˜¯çº¿æ€§æ¢æµ‹\r\n      for (int i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {\r\n          // è·å–å½“å‰èŠ‚ç‚¹çš„ key\r\n          ThreadLocal<?> k = e.get();\r\n  \t\t// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯ã€æ›¿æ¢é€»è¾‘ã€‘\r\n          if (k == key) {\r\n              e.value = value;\r\n              // å› ä¸ºæœ¬æ¥è¦åœ¨ staleSlot ç´¢å¼•å¤„æ’å…¥è¯¥æ•°æ®ï¼Œç°åœ¨æ‰¾åˆ°äº†iç´¢å¼•å¤„çš„keyä¸æ•°æ®ä¸€è‡´\r\n              // ä½†æ˜¯ i ä½ç½®è·ç¦»æ­£ç¡®çš„ä½ç½®æ›´è¿œï¼Œå› ä¸ºæ˜¯å‘åæŸ¥æ‰¾ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦åœ¨ staleSlot ä½ç½®æ’å…¥å½“å‰ entry\r\n              // ç„¶åå°† table[staleSlot] è¿™ä¸ªè¿‡æœŸæ•°æ®æ”¾åˆ°å½“å‰å¾ªç¯åˆ°çš„ table[i] è¿™ä¸ªä½ç½®ï¼Œ\r\n              tab[i] = tab[staleSlot];\r\n              tab[staleSlot] = e;\r\n  \t\t\t\r\n              // æ¡ä»¶æˆç«‹è¯´æ˜å‘å‰æŸ¥æ‰¾è¿‡æœŸæ•°æ®å¹¶æœªæ‰¾åˆ°è¿‡æœŸçš„ entryï¼Œä½† staleSlot ä½ç½®å·²ç»ä¸æ˜¯è¿‡æœŸæ•°æ®äº†ï¼Œi ä½ç½®æ‰æ˜¯\r\n              if (slotToExpunge == staleSlot)\r\n                  slotToExpunge = i;\r\n              \r\n              // ã€æ¸…ç†è¿‡æœŸæ•°æ®ï¼ŒexpungeStaleEntry æ¢æµ‹å¼æ¸…ç†ï¼ŒcleanSomeSlots å¯å‘å¼æ¸…ç†ã€‘\r\n              cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\r\n              return;\r\n          }\r\n  \t\t// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰éå†çš„ entry æ˜¯ä¸€ä¸ªè¿‡æœŸæ•°æ®ï¼Œå¹¶ä¸”è¯¥ä½ç½®å‰é¢ä¹Ÿæ²¡æœ‰è¿‡æœŸæ•°æ®\r\n          if (k == null && slotToExpunge == staleSlot)\r\n              // æ¢æµ‹å¼æ¸…ç†è¿‡æœŸæ•°æ®çš„å¼€å§‹ä¸‹æ ‡ä¿®æ”¹ä¸ºå½“å‰å¾ªç¯çš„ indexï¼Œå› ä¸º staleSlot ä¼šæ”¾å…¥è¦æ·»åŠ çš„æ•°æ®\r\n              slotToExpunge = i;\r\n      }\r\n  \t// å‘åæŸ¥æ‰¾è¿‡ç¨‹ä¸­å¹¶æœªå‘ç° k == key çš„ entryï¼Œè¯´æ˜å½“å‰æ˜¯ä¸€ä¸ªã€å–ä»£è¿‡æœŸæ•°æ®é€»è¾‘ã€‘\r\n      // åˆ é™¤åŸæœ‰çš„æ•°æ®å¼•ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²\r\n      tab[staleSlot].value = null;\r\n      // staleSlot ä½ç½®æ·»åŠ æ•°æ®ï¼Œã€ä¸Šé¢çš„æ‰€æœ‰é€»è¾‘éƒ½ä¸ä¼šæ›´æ”¹ staleSlot çš„å€¼ã€‘\r\n      tab[staleSlot] = new Entry(key, value);\r\n  \r\n      // æ¡ä»¶æˆç«‹è¯´æ˜é™¤äº† staleSlot ä»¥å¤–ï¼Œè¿˜å‘ç°å…¶å®ƒçš„è¿‡æœŸ slotï¼Œæ‰€ä»¥è¦ã€å¼€å¯æ¸…ç†æ•°æ®çš„é€»è¾‘ã€‘\r\n      if (slotToExpunge != staleSlot)\r\n          cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\r\n  }\r\n  ```\r\n\r\n  ![image-20230824171823217](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824171823217.png)\r\n\r\n  ```java\r\n  private static int prevIndex(int i, int len) {\r\n      // å½¢æˆä¸€ä¸ªç¯ç»•å¼çš„è®¿é—®ï¼Œå¤´ç´¢å¼•è¶Šç•Œåç½®ä¸ºå°¾ç´¢å¼•\r\n      return ((i - 1 >= 0) ? i - 1 : len - 1);\r\n  }\r\n  ```\r\n\r\n* getEntry()ï¼šThreadLocal çš„ get æ–¹æ³•ä»¥å½“å‰çš„ ThreadLocal ä¸º keyï¼Œè°ƒç”¨ getEntry è·å–å¯¹åº”çš„å­˜å‚¨å®ä½“ e\r\n\r\n  ```java\r\n  private Entry getEntry(ThreadLocal<?> key) {\r\n      // å“ˆå¸Œå¯»å€\r\n      int i = key.threadLocalHashCode & (table.length - 1);\r\n      // è®¿é—®æ•£åˆ—è¡¨ä¸­æŒ‡å®šæŒ‡å®šä½ç½®çš„ slot \r\n      Entry e = table[i];\r\n      // æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜ slot æœ‰å€¼å¹¶ä¸” key å°±æ˜¯è¦å¯»æ‰¾çš„ keyï¼Œç›´æ¥è¿”å›\r\n      if (e != null && e.get() == key)\r\n          return e;\r\n      else\r\n          // è¿›è¡Œçº¿æ€§æ¢æµ‹\r\n          return getEntryAfterMiss(key, i, e);\r\n  }\r\n  // çº¿æ€§æ¢æµ‹å¯»å€\r\n  private Entry getEntryAfterMiss(ThreadLocal<?> key, int i, Entry e) {\r\n      // è·å–æ•£åˆ—è¡¨\r\n      Entry[] tab = table;\r\n      int len = tab.length;\r\n  \r\n      // å¼€å§‹éå†ï¼Œç¢°åˆ° slot == null çš„æƒ…å†µï¼Œæœç´¢ç»“æŸ\r\n      while (e != null) {\r\n  \t\t// è·å–å½“å‰ slot ä¸­ entry å¯¹è±¡çš„ key\r\n          ThreadLocal<?> k = e.get();\r\n          // æ¡ä»¶æˆç«‹è¯´æ˜æ‰¾åˆ°äº†ï¼Œç›´æ¥è¿”å›\r\n          if (k == key)\r\n              return e;\r\n          if (k == null)\r\n               // è¿‡æœŸæ•°æ®ï¼Œã€æ¢æµ‹å¼è¿‡æœŸæ•°æ®å›æ”¶ã€‘\r\n              expungeStaleEntry(i);\r\n          else\r\n              // æ›´æ–° index ç»§ç»­å‘åèµ°\r\n              i = nextIndex(i, len);\r\n          // è·å–ä¸‹ä¸€ä¸ªæ§½ä½ä¸­çš„ entry\r\n          e = tab[i];\r\n      }\r\n      // è¯´æ˜å½“å‰åŒºæ®µæ²¡æœ‰æ‰¾åˆ°ç›¸åº”æ•°æ®\r\n      // ã€å› ä¸ºå­˜æ”¾æ•°æ®æ˜¯çº¿æ€§çš„å‘åå¯»æ‰¾æ§½ä½ï¼Œéƒ½æ˜¯ç´§æŒ¨ç€çš„ï¼Œä¸å¯èƒ½è¶Šè¿‡ä¸€ä¸ª ç©ºæ§½ä½ åœ¨åé¢æ”¾ã€‘ï¼Œå¯ä»¥å‡å°‘éå†çš„æ¬¡æ•°\r\n      return null;\r\n  }\r\n  ```\r\n\r\n* rehash()ï¼šè§¦å‘ä¸€æ¬¡å…¨é‡æ¸…ç†ï¼Œå¦‚æœæ•°ç»„é•¿åº¦å¤§äºç­‰äºé•¿åº¦çš„ `2/3 * 3/4 = 1/2`ï¼Œåˆ™è¿›è¡Œ resize\r\n\r\n  ```java\r\n  private void rehash() {\r\n      // æ¸…é™¤å½“å‰æ•£åˆ—è¡¨å†…çš„ã€æ‰€æœ‰ã€‘è¿‡æœŸçš„æ•°æ®\r\n      expungeStaleEntries();\r\n      \r\n      // threshold = len * 2 / 3ï¼Œå°±æ˜¯ 2/3 * (1 - 1/4)\r\n      if (size >= threshold - threshold / 4)\r\n          resize();\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  private void expungeStaleEntries() {\r\n      Entry[] tab = table;\r\n      int len = tab.length;\r\n      // ã€éå†æ‰€æœ‰çš„æ§½ä½ï¼Œæ¸…ç†è¿‡æœŸæ•°æ®ã€‘\r\n      for (int j = 0; j < len; j++) {\r\n          Entry e = tab[j];\r\n          if (e != null && e.get() == null)\r\n              expungeStaleEntry(j);\r\n      }\r\n  }\r\n  ```\r\n\r\n  Entry **æ•°ç»„æ‰©å®¹ä¸ºåŸæ¥çš„ 2 å€** ï¼Œé‡æ–°è®¡ç®— key çš„æ•£åˆ—å€¼ï¼Œå¦‚æœé‡åˆ° key ä¸º null çš„æƒ…å†µï¼Œä¼šå°†å…¶ value ä¹Ÿç½®ä¸º nullï¼Œå¸®åŠ© GC\r\n\r\n  ```java\r\n  private void resize() {\r\n      Entry[] oldTab = table;\r\n      int oldLen = oldTab.length;\r\n      // æ–°æ•°ç»„çš„é•¿åº¦æ˜¯è€æ•°ç»„çš„äºŒå€\r\n      int newLen = oldLen * 2;\r\n      Entry[] newTab = new Entry[newLen];\r\n      // ç»Ÿè®¡æ–°tableä¸­çš„entryæ•°é‡\r\n      int count = 0;\r\n  \t// éå†è€è¡¨ï¼Œè¿›è¡Œã€æ•°æ®è¿ç§»ã€‘\r\n      for (int j = 0; j < oldLen; ++j) {\r\n          // è®¿é—®è€è¡¨çš„æŒ‡å®šä½ç½®çš„ entry\r\n          Entry e = oldTab[j];\r\n          // æ¡ä»¶æˆç«‹è¯´æ˜è€è¡¨ä¸­è¯¥ä½ç½®æœ‰æ•°æ®ï¼Œå¯èƒ½æ˜¯è¿‡æœŸæ•°æ®ä¹Ÿå¯èƒ½ä¸æ˜¯\r\n          if (e != null) {\r\n              ThreadLocal<?> k = e.get();\r\n              // è¿‡æœŸæ•°æ®\r\n              if (k == null) {\r\n                  e.value = null; // Help the GC\r\n              } else {\r\n                  // éè¿‡æœŸæ•°æ®ï¼Œåœ¨æ–°è¡¨ä¸­è¿›è¡Œå“ˆå¸Œå¯»å€\r\n                  int h = k.threadLocalHashCode & (newLen - 1);\r\n                  // ã€çº¿ç¨‹æ¢æµ‹ã€‘\r\n                  while (newTab[h] != null)\r\n                      h = nextIndex(h, newLen);\r\n                  // å°†æ•°æ®å­˜æ”¾åˆ°æ–°è¡¨åˆé€‚çš„ slot ä¸­\r\n                  newTab[h] = e;\r\n                  count++;\r\n              }\r\n          }\r\n      }\r\n  \t// è®¾ç½®ä¸‹ä¸€æ¬¡è§¦å‘æ‰©å®¹çš„æŒ‡æ ‡ï¼šthreshold = len * 2 / 3;\r\n      setThreshold(newLen);\r\n      size = count;\r\n      // å°†æ‰©å®¹åçš„æ–°è¡¨èµ‹å€¼ç»™ threadLocalMap å†…éƒ¨æ•£åˆ—è¡¨æ•°ç»„å¼•ç”¨\r\n      table = newTab;\r\n  }\r\n  ```\r\n\r\n* remove()ï¼šåˆ é™¤ Entry\r\n\r\n  ```java\r\n  private void remove(ThreadLocal<?> key) {\r\n      Entry[] tab = table;\r\n      int len = tab.length;\r\n      // å“ˆå¸Œå¯»å€\r\n      int i = key.threadLocalHashCode & (len-1);\r\n      for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) {\r\n          // æ‰¾åˆ°äº†å¯¹åº”çš„ key\r\n          if (e.get() == key) {\r\n              // è®¾ç½® key ä¸º null\r\n              e.clear();\r\n              // æ¢æµ‹å¼æ¸…ç†\r\n              expungeStaleEntry(i);\r\n              return;\r\n          }\r\n      }\r\n  }\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ¸…ç†æ–¹æ³•\r\n\r\n* æ¢æµ‹å¼æ¸…ç†ï¼šæ²¿ç€å¼€å§‹ä½ç½®å‘åæ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œæ²¿é€”ä¸­ç¢°åˆ°æœªè¿‡æœŸæ•°æ®åˆ™å°†æ­¤æ•°æ® rehash åœ¨ table æ•°ç»„ä¸­çš„å®šä½ï¼Œé‡å®šä½åçš„å…ƒç´ ç†è®ºä¸Šæ›´æ¥è¿‘ `i = entry.key & (table.length - 1)`ï¼Œè®©**æ•°æ®çš„æ’åˆ—æ›´ç´§å‡‘**ï¼Œä¼šä¼˜åŒ–æ•´ä¸ªæ•£åˆ—è¡¨æŸ¥è¯¢æ€§èƒ½\r\n\r\n  ```java\r\n  // table[staleSlot] æ˜¯ä¸€ä¸ªè¿‡æœŸæ•°æ®ï¼Œä»¥è¿™ä¸ªä½ç½®å¼€å§‹ç»§ç»­å‘åæŸ¥æ‰¾è¿‡æœŸæ•°æ®\r\n  private int expungeStaleEntry(int staleSlot) {\r\n      // è·å–æ•£åˆ—è¡¨å’Œæ•°ç»„é•¿åº¦\r\n      Entry[] tab = table;\r\n      int len = tab.length;\r\n  \r\n      // help gcï¼Œå…ˆæŠŠå½“å‰è¿‡æœŸçš„ entry ç½®ç©ºï¼Œåœ¨å–æ¶ˆå¯¹ entry çš„å¼•ç”¨\r\n      tab[staleSlot].value = null;\r\n      tab[staleSlot] = null;\r\n      // æ•°é‡-1\r\n      size--;\r\n  \r\n      Entry e;\r\n      int i;\r\n      // ä» staleSlot å¼€å§‹å‘åéå†ï¼Œç›´åˆ°ç¢°åˆ° slot == null ç»“æŸï¼Œã€åŒºé—´å†…æ¸…ç†è¿‡æœŸæ•°æ®ã€‘\r\n      for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {\r\n          ThreadLocal<?> k = e.get();\r\n          // å½“å‰ entry æ˜¯è¿‡æœŸæ•°æ®\r\n          if (k == null) {\r\n              // help gc\r\n              e.value = null;\r\n              tab[i] = null;\r\n              size--;\r\n          } else {\r\n              // å½“å‰ entry ä¸æ˜¯è¿‡æœŸæ•°æ®çš„é€»è¾‘ï¼Œã€rehashã€‘\r\n              // é‡æ–°è®¡ç®—å½“å‰ entry å¯¹åº”çš„ index\r\n              int h = k.threadLocalHashCode & (len - 1);\r\n              // æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ entry å­˜å‚¨æ—¶å‘ç”Ÿè¿‡ hash å†²çªï¼Œå‘ååç§»è¿‡äº†\r\n              if (h != i) {\r\n                  // å½“å‰ä½ç½®ç½®ç©º\r\n                  tab[i] = null;\r\n                  // ä»¥æ­£ç¡®ä½ç½® h å¼€å§‹ï¼Œå‘åæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯ä»¥å­˜æ”¾ entry çš„ä½ç½®\r\n                  while (tab[h] != null)\r\n                      h = nextIndex(h, len);\r\n                  // å°†å½“å‰å…ƒç´ æ”¾å…¥åˆ°ã€è·ç¦»æ­£ç¡®ä½ç½®æ›´è¿‘çš„ä½ç½®ï¼Œæœ‰å¯èƒ½å°±æ˜¯æ­£ç¡®ä½ç½®ã€‘\r\n                  tab[h] = e;\r\n              }\r\n          }\r\n      }\r\n      // è¿”å› slot = null çš„æ§½ä½ç´¢å¼•ï¼Œå›¾ä¾‹æ˜¯ 7ï¼Œè¿™ä¸ªç´¢å¼•ä»£è¡¨ã€ç´¢å¼•å‰é¢çš„åŒºé—´å·²ç»æ¸…ç†å®Œæˆåƒåœ¾äº†ã€‘\r\n      return i;\r\n  }\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824171939245.png\" alt=\"image-20230824171939245\" class=\"scale-80\" />\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824172017188.png\" alt=\"image-20230824172017188\" class=\"scale-80\" />\r\n\r\n* å¯å‘å¼æ¸…ç†ï¼šå‘åå¾ªç¯æ‰«æè¿‡æœŸæ•°æ®ï¼Œå‘ç°è¿‡æœŸæ•°æ®è°ƒç”¨æ¢æµ‹å¼æ¸…ç†æ–¹æ³•ï¼Œå¦‚æœè¿ç»­å‡ æ¬¡çš„å¾ªç¯éƒ½æ²¡æœ‰å‘ç°è¿‡æœŸæ•°æ®ï¼Œå°±åœæ­¢æ‰«æ\r\n\r\n  ```java\r\n  //  i è¡¨ç¤ºå¯å‘å¼æ¸…ç†å·¥ä½œå¼€å§‹ä½ç½®ï¼Œä¸€èˆ¬æ˜¯ç©º slotï¼Œn ä¸€èˆ¬ä¼ é€’çš„æ˜¯ table.length \r\n  private boolean cleanSomeSlots(int i, int n) {\r\n      // è¡¨ç¤ºå¯å‘å¼æ¸…ç†å·¥ä½œæ˜¯å¦æ¸…é™¤äº†è¿‡æœŸæ•°æ®\r\n      boolean removed = false;\r\n      // è·å–å½“å‰ map çš„æ•£åˆ—è¡¨å¼•ç”¨\r\n      Entry[] tab = table;\r\n      int len = tab.length;\r\n      do {\r\n          // è·å–ä¸‹ä¸€ä¸ªç´¢å¼•ï¼Œå› ä¸ºæ¢æµ‹å¼è¿”å›çš„ slot ä¸º null\r\n          i = nextIndex(i, len);\r\n          Entry e = tab[i];\r\n          // æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯è¿‡æœŸçš„æ•°æ®ï¼Œkey è¢« gc äº†\r\n          if (e != null && e.get() == null) {\r\n              // ã€å‘ç°è¿‡æœŸæ•°æ®é‡ç½® n ä¸ºæ•°ç»„çš„é•¿åº¦ã€‘\r\n              n = len;\r\n              // è¡¨ç¤ºæ¸…ç†è¿‡è¿‡æœŸæ•°æ®\r\n              removed = true;\r\n              // ä»¥å½“å‰è¿‡æœŸçš„ slot ä¸ºå¼€å§‹èŠ‚ç‚¹ åšä¸€æ¬¡æ¢æµ‹å¼æ¸…ç†å·¥ä½œ\r\n              i = expungeStaleEntry(i);\r\n          }\r\n          // å‡è®¾ table é•¿åº¦ä¸º 16\r\n          // 16 >>> 1 ==> 8ï¼Œ8 >>> 1 ==> 4ï¼Œ4 >>> 1 ==> 2ï¼Œ2 >>> 1 ==> 1ï¼Œ1 >>> 1 ==> 0\r\n          // è¿ç»­ç»è¿‡è¿™ä¹ˆå¤šæ¬¡å¾ªç¯ã€æ²¡æœ‰æ‰«æåˆ°è¿‡æœŸæ•°æ®ã€‘ï¼Œå°±åœæ­¢å¾ªç¯ï¼Œæ‰«æåˆ°ç©º slot ä¸ç®—ï¼Œå› ä¸ºä¸æ˜¯è¿‡æœŸæ•°æ®\r\n      } while ((n >>>= 1) != 0);\r\n      \r\n      // è¿”å›æ¸…é™¤æ ‡è®°\r\n      return removed;\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n\r\nå‚è€ƒè§†é¢‘ï¼šhttps://space.bilibili.com/457326371/\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å†…å­˜æ³„æ¼\r\n\r\nMemory leakï¼šå†…å­˜æ³„æ¼æ˜¯æŒ‡ç¨‹åºä¸­åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› æœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œé€Ÿåº¦å‡æ…¢ç”šè‡³ç³»ç»Ÿå´©æºƒç­‰ä¸¥é‡åæœï¼Œå†…å­˜æ³„æ¼çš„å †ç§¯ç»ˆå°†å¯¼è‡´å†…å­˜æº¢å‡º\r\n\r\n* å¦‚æœ key ä½¿ç”¨å¼ºå¼•ç”¨ï¼šä½¿ç”¨å®Œ ThreadLocal ï¼ŒthreadLocal Ref è¢«å›æ”¶ï¼Œä½†æ˜¯ threadLocalMap çš„ Entry å¼ºå¼•ç”¨äº† threadLocalï¼Œé€ æˆ threadLocal æ— æ³•è¢«å›æ”¶ï¼Œæ— æ³•å®Œå…¨é¿å…å†…å­˜æ³„æ¼\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824172101315.png\" alt=\"image-20230824172101315\" class=\"scale-80\" />\r\n\r\n* å¦‚æœ key ä½¿ç”¨å¼±å¼•ç”¨ï¼šä½¿ç”¨å®Œ ThreadLocal ï¼ŒthreadLocal Ref è¢«å›æ”¶ï¼ŒThreadLocalMap åªæŒæœ‰ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œæ‰€ä»¥threadlocal ä¹Ÿå¯ä»¥è¢«å›æ”¶ï¼Œæ­¤æ—¶ Entry ä¸­çš„ key = nullã€‚ä½†æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ª Entry æˆ–è€… CurrentThread ä¾ç„¶è¿è¡Œï¼Œä¾ç„¶å­˜åœ¨å¼ºå¼•ç”¨é“¾ï¼Œvalue ä¸ä¼šè¢«å›æ”¶ï¼Œè€Œè¿™å— value æ°¸è¿œä¸ä¼šè¢«è®¿é—®åˆ°ï¼Œä¹Ÿä¼šå¯¼è‡´ value å†…å­˜æ³„æ¼\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824172141253.png\" alt=\"image-20230824172141253\" class=\"scale-80\" />\r\n\r\n* ä¸¤ä¸ªä¸»è¦åŸå› ï¼š\r\n\r\n  * æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ª Entry\r\n  * CurrentThread ä¾ç„¶è¿è¡Œ\r\n\r\næ ¹æœ¬åŸå› ï¼šThreadLocalMap æ˜¯ Threadçš„ä¸€ä¸ªå±æ€§ï¼Œ**ç”Ÿå‘½å‘¨æœŸè·Ÿ Thread ä¸€æ ·é•¿**ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº” Entry å°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼\r\n\r\nè§£å†³æ–¹æ³•ï¼šä½¿ç”¨å®Œ ThreadLocal ä¸­å­˜å‚¨çš„å†…å®¹åå°†å®ƒ remove æ‰å°±å¯ä»¥\r\n\r\nThreadLocal å†…éƒ¨è§£å†³æ–¹æ³•ï¼šåœ¨ ThreadLocalMap ä¸­çš„ set/getEntry æ–¹æ³•ä¸­ï¼Œé€šè¿‡çº¿æ€§æ¢æµ‹æ³•å¯¹ key è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœ key ä¸º nullï¼ˆThreadLocal ä¸º nullï¼‰ä¼šå¯¹ Entry è¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ‰€ä»¥**ä½¿ç”¨å¼±å¼•ç”¨æ¯”å¼ºå¼•ç”¨å¤šä¸€å±‚ä¿éšœ**ï¼Œå°±ç®—ä¸è°ƒç”¨ removeï¼Œä¹Ÿæœ‰æœºä¼šè¿›è¡Œ GC\r\n\r\n\r\n\r\n***\r\n\r\n#### è¡¥å……ï¼šå†…å­˜é‡Šæ”¾æ—¶æœº\r\n\r\n- è¢«åŠ¨ GC é‡Šæ”¾ key\r\n  - ä»…æ˜¯è®© key çš„å†…å­˜é‡Šæ”¾ï¼Œå…³è” value çš„å†…å­˜å¹¶ä¸ä¼šé‡Šæ”¾\r\n- æ‡’æƒ°è¢«åŠ¨é‡Šæ”¾ value\r\n  - get key æ—¶ï¼Œå‘ç°æ˜¯ null keyï¼Œåˆ™é‡Šæ”¾å…¶ value å†…å­˜\r\n  - set key æ—¶ï¼Œä¼šä½¿ç”¨å¯å‘å¼æ‰«æï¼Œæ¸…é™¤ä¸´è¿‘çš„ null key çš„ value å†…å­˜ï¼Œå¯å‘æ¬¡æ•°ä¸å…ƒç´ ä¸ªæ•°ï¼Œæ˜¯å¦å‘ç° null key æœ‰å…³\r\n- ä¸»åŠ¨ remove é‡Šæ”¾ keyï¼Œvalue\r\n  - ä¼šåŒæ—¶é‡Šæ”¾ keyï¼Œvalue çš„å†…å­˜ï¼Œä¹Ÿä¼šæ¸…é™¤ä¸´è¿‘çš„ null key çš„ value å†…å­˜\r\n  - æ¨èä½¿ç”¨å®ƒï¼Œå› ä¸ºä¸€èˆ¬ä½¿ç”¨ ThreadLocal æ—¶éƒ½æŠŠå®ƒä½œä¸ºé™æ€å˜é‡ï¼ˆå³å¼ºå¼•ç”¨ï¼‰ï¼Œå› æ­¤æ— æ³•è¢«åŠ¨ä¾é  GC å›æ”¶\r\n\r\n> - threadLocalæ˜¯å¼±å¼•ç”¨ä½œä¸ºkeyæ¥å­˜å‚¨çš„ï¼Œå½“ä¸‹é¢çº¿ç¨‹1ä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œä¸æ–­çš„æ’å…¥å…ƒç´ ï¼Œè¿™æ ·é”®å€¼å°±ä¼šè¶Šæ¥è¶Šå¤šï¼Œè¿™æ—¶åªèƒ½ç­‰GCåƒåœ¾å›æ”¶äº†ï¼Œå¦‚æœthreadLocalè®¾è®¡æˆå¼ºå¼•ç”¨å°±ä¸èƒ½è¢«åƒåœ¾å›æ”¶äº†ï¼ˆå³ä½¿åˆ«çš„åœ°æ–¹éƒ½æ²¡æœ‰å¼•ç”¨threadLocalï¼Œåªè¦threadLocalMapä½¿ç”¨å¼ºå¼•ç”¨å¼•ç”¨èµ„æºï¼Œé‚£è¢«å¼•ç”¨çš„èµ„æºå°±å¾—ä¸åˆ°é‡Šæ”¾ï¼‰ï¼Œæ‰€ä»¥å¼±å¼•ç”¨å¼•ç”¨èµ„æºå°†æ¥æ²¡äººå¼•ç”¨äº†å°±ä¼šè¢«å›æ”¶ï¼Œä½†å€¼æ˜¯å¼ºå¼•ç”¨çš„ï¼ŒGCä»…æ˜¯è®©keyçš„å†…å­˜é‡Šæ”¾ï¼Œåç»­è¿˜è¦æ ¹æ® key æ˜¯å¦ä¸º nullæ¥è¿›ä¸€æ­¥é‡Šæ”¾å€¼çš„å†…å­˜\r\n> - GCåƒåœ¾å›æ”¶æ—¶ï¼ŒæŠŠæœªè¢«å¼•ç”¨çš„threadLocalï¼ˆaï¼‰æ¸…ç†æ‰ï¼Œå˜ä¸ºnullï¼Œå€¼è¿˜åœ¨ï¼›å½“æ–°çš„threadLocalï¼ˆcï¼‰å»getè¿™ä¸ªkeyä¸ºNullçš„ä½ç½®æ—¶ï¼Œæ­¤æ—¶å€¼å°±ä¼šè¢«åƒåœ¾å›æ”¶æ‰ï¼Œå˜ä¸ºNullï¼›å½“getä¸€ä¸ªç©ºé—²ä½ç½®æ—¶ï¼Œmapå°±ä¼šæŠŠå½“å‰æ–°çš„threadLocalï¼ˆdï¼‰ä½œä¸ºkeyï¼Œä½†å€¼ä¸ºNull\r\n>\r\n> ![image-20230421195247137](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421195247137.png)\r\n>\r\n> - å½“åœ¨è¢«åƒåœ¾å›æ”¶æ‰keyçš„ä½ç½®setï¼ˆ8ï¼‰æ—¶ï¼Œä¸å…‰æ¸…ç†æ‰å½“å‰ä½ç½®çš„å€¼ï¼ˆæ¸…ç†å¹¶å­˜å‚¨ï¼‰ï¼Œè¿˜ä¼šæŠŠç›¸é‚»ä½ç½®ä¹Ÿä¸€èµ·æ¸…ç†æ‰ï¼ˆ9,10 çš„ k vï¼‰ï¼Œä½†ç¦»å¾—æ¯”è¾ƒè¿œçš„ä½ç½®å°±ä¸ä¼šå»æ¸…ç†ï¼ˆ14ï¼‰\r\n>\r\n> ![image-20230421195536553](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421195536553.png)\r\n>\r\n> - ä¸€èˆ¬æƒ…å†µæ˜¯æ²¡æœ‰å…¶ä»–åœ°æ–¹å¼•ç”¨threadLocalå°±ä¼šè¢«åƒåœ¾å›æ”¶ï¼Œkey=Nullï¼Œgetï¼Œsetå‘ç°Nullkeyæ‰ä¼šè¿›ä¸€æ­¥æ¸…ç†value\r\n> - å®é™…æƒ…å†µæ˜¯ç”¨é™æ€å˜é‡æ¥å¼•ç”¨threadLocalå¯¹è±¡ï¼Œå³é™æ€å˜é‡è·Ÿè¿™ä¸ªå¯¹è±¡ä¸ºå¼ºå¼•ç”¨ï¼Œæ‰€ä»¥é™æ€å˜é‡ä¸€ç›´å¼ºå¼•ç”¨ä½¿ç”¨å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶ä¸äº†ï¼Œå³ä½¿threadLocalæ˜¯å¼±å¼•ç”¨ï¼Œä½†æ˜¯é™æ€å˜é‡å¯¹threadLocalä¸€ç›´ä¿æŒå¼ºå¼•ç”¨çŠ¶æ€ï¼Œæ‰€ä»¥æ‡’æƒ°è¢«åŠ¨é‡Šæ”¾ valueçš„ä¸¤ç§æ–¹å¼æ˜¯è¡Œä¸é€šçš„\r\n> - ä½¿ç”¨removeä¸»åŠ¨æ¸…ç†ç›´æ¥å°†mapçš„é”®å€¼æ¸…ç†æ‰ï¼Œå‰ä¸¤ç§æ–¹å¼æ¸…ç†ï¼ˆget setï¼‰ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ï¼Œéœ€è¦ç”¨removeæ¥åŠæ—¶æ¸…ç†ï¼›å‡è®¾é•¿æ—¶é—´è¿è¡Œçš„çº¿ç¨‹æ± èµ„æºï¼ˆå«threadLocalå…³è”é™æ€èµ„æºï¼‰æ²¡æœ‰å³ä½¿æ¸…ç†çš„è¯ï¼Œå°±ä¼šç§¯ç´¯è¶Šæ¥è¶Šå¤šçš„é”®å€¼èµ„æºï¼Œè¿˜æœ‰å…¶ä»–çš„é™æ€å˜é‡å¼ºå¼•ç”¨keyï¼ŒGCä¹Ÿæ²¡åŠæ³•æŠŠå®ƒä»¬å›æ”¶ï¼Œä¹…è€Œä¹…ä¹‹å°±ä¼šé€ æˆå†…å­˜æ³„æ¼\r\n>\r\n> ![image-20230421200401064](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421200401064.png)\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n#### å˜é‡ä¼ é€’\r\n\r\n##### åŸºæœ¬ä½¿ç”¨\r\n\r\nçˆ¶å­çº¿ç¨‹ï¼šåˆ›å»ºå­çº¿ç¨‹çš„çº¿ç¨‹æ˜¯çˆ¶çº¿ç¨‹ï¼Œæ¯”å¦‚å®ä¾‹ä¸­çš„ main çº¿ç¨‹å°±æ˜¯çˆ¶çº¿ç¨‹\r\n\r\nThreadLocal ä¸­å­˜å‚¨çš„æ˜¯çº¿ç¨‹çš„å±€éƒ¨å˜é‡ï¼Œå¦‚æœæƒ³**å®ç°çº¿ç¨‹é—´å±€éƒ¨å˜é‡ä¼ é€’**å¯ä»¥ä½¿ç”¨ InheritableThreadLocal ç±»\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    ThreadLocal<String> threadLocal = new InheritableThreadLocal<>();\r\n    threadLocal.set(\"çˆ¶çº¿ç¨‹è®¾ç½®çš„å€¼\");\r\n\r\n    new Thread(() -> System.out.println(\"å­çº¿ç¨‹è¾“å‡ºï¼š\" + threadLocal.get())).start();\r\n}\r\n// å­çº¿ç¨‹è¾“å‡ºï¼šçˆ¶çº¿ç¨‹è®¾ç½®çš„å€¼\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å®ç°åŸç†\r\n\r\nInheritableThreadLocal æºç ï¼š\r\n\r\n```java\r\npublic class InheritableThreadLocal<T> extends ThreadLocal<T> {\r\n    protected T childValue(T parentValue) {\r\n        return parentValue;\r\n    }\r\n    ThreadLocalMap getMap(Thread t) {\r\n       return t.inheritableThreadLocals;\r\n    }\r\n    void createMap(Thread t, T firstValue) {\r\n        t.inheritableThreadLocals = new ThreadLocalMap(this, firstValue);\r\n    }\r\n}\r\n```\r\n\r\nå®ç°çˆ¶å­çº¿ç¨‹é—´çš„å±€éƒ¨å˜é‡å…±äº«éœ€è¦è¿½æº¯åˆ° Thread å¯¹è±¡çš„æ„é€ æ–¹æ³•ï¼š\r\n\r\n```java\r\nprivate void init(ThreadGroup g, Runnable target, String name, long stackSize, AccessControlContext acc,\r\n                  // è¯¥å‚æ•°é»˜è®¤æ˜¯ true\r\n                  boolean inheritThreadLocals) {\r\n  \t// ...\r\n    Thread parent = currentThread();\r\n\r\n    // åˆ¤æ–­çˆ¶çº¿ç¨‹ï¼ˆåˆ›å»ºå­çº¿ç¨‹çš„çº¿ç¨‹ï¼‰çš„ inheritableThreadLocals å±æ€§ä¸ä¸º null\r\n    if (inheritThreadLocals && parent.inheritableThreadLocals != null) {\r\n        // å¤åˆ¶çˆ¶çº¿ç¨‹çš„ inheritableThreadLocals å±æ€§ï¼Œå®ç°çˆ¶å­çº¿ç¨‹å±€éƒ¨å˜é‡å…±äº«\r\n        this.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); \r\n    }\r\n    // ..\r\n}\r\n// ã€æœ¬è´¨ä¸Šè¿˜æ˜¯åˆ›å»º ThreadLocalMapï¼Œåªæ˜¯æŠŠçˆ¶ç±»ä¸­çš„å¯ç»§æ‰¿æ•°æ®è®¾ç½®è¿›å»äº†ã€‘\r\nstatic ThreadLocalMap createInheritedMap(ThreadLocalMap parentMap) {\r\n    return new ThreadLocalMap(parentMap);\r\n}\r\n```\r\n\r\n```java\r\nprivate ThreadLocalMap(ThreadLocalMap parentMap) {\r\n    // è·å–çˆ¶çº¿ç¨‹çš„å“ˆå¸Œè¡¨\r\n    Entry[] parentTable = parentMap.table;\r\n    int len = parentTable.length;\r\n    setThreshold(len);\r\n    table = new Entry[len];\r\n\t// ã€é€ä¸ªå¤åˆ¶çˆ¶çº¿ç¨‹ ThreadLocalMap ä¸­çš„æ•°æ®ã€‘\r\n    for (int j = 0; j < len; j++) {\r\n        Entry e = parentTable[j];\r\n        if (e != null) {\r\n            ThreadLocal<Object> key = (ThreadLocal<Object>) e.get();\r\n            if (key != null) {\r\n                // è°ƒç”¨çš„æ˜¯ InheritableThreadLocal#childValue(T parentValue)\r\n                Object value = key.childValue(e.value);\r\n                Entry c = new Entry(key, value);\r\n                int h = key.threadLocalHashCode & (len - 1);\r\n                // çº¿æ€§æ¢æµ‹\r\n                while (table[h] != null)\r\n                    h = nextIndex(h, len);\r\n                table[h] = c;\r\n                size++;\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/feichitianxia/article/details/110495764\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"å¹¶å‘ç¼–ç¨‹æ•´ç†ç‰ˆ-å†…å­˜","tags":["Synchronized","JMM","volatile","ç»ˆæ­¢æ¨¡å¼","Balking"],"categories":["Java","å¹¶å‘ç¼–ç¨‹"],"author":"imklaus","excerpt":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n","link":"/posts/Concurrent_Programming-Memory","content":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n<!-- more -->\r\n\r\n## å†…å­˜\r\n\r\n### JMM\r\n\r\n#### å†…å­˜æ¨¡å‹\r\n\r\nJava å†…å­˜æ¨¡å‹æ˜¯ Java Memory Modelï¼ˆJMMï¼‰ï¼Œæœ¬èº«æ˜¯ä¸€ç§**æŠ½è±¡çš„æ¦‚å¿µ**ï¼Œå®é™…ä¸Šå¹¶ä¸å­˜åœ¨ï¼Œæè¿°çš„æ˜¯ä¸€ç»„è§„åˆ™æˆ–è§„èŒƒï¼Œé€šè¿‡è¿™ç»„è§„èŒƒå®šä¹‰äº†ç¨‹åºä¸­å„ä¸ªå˜é‡ï¼ˆåŒ…æ‹¬å®ä¾‹å­—æ®µï¼Œé™æ€å­—æ®µå’Œæ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ ï¼‰çš„è®¿é—®æ–¹å¼\r\n\r\nJMM ä½œç”¨ï¼š\r\n\r\n* å±è”½å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œå®ç°è®© Java ç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœ\r\n* è§„å®šäº†çº¿ç¨‹å’Œå†…å­˜ä¹‹é—´çš„ä¸€äº›å…³ç³»\r\n\r\næ ¹æ® JMM çš„è®¾è®¡ï¼Œç³»ç»Ÿå­˜åœ¨ä¸€ä¸ªä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ï¼ŒJava ä¸­æ‰€æœ‰å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å­˜ä¸­ï¼Œå¯¹äºæ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯å…±äº«çš„ï¼›æ¯æ¡çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼ˆWorking Memoryï¼‰ï¼Œå·¥ä½œå†…å­˜ä¸­ä¿å­˜çš„æ˜¯ä¸»å­˜ä¸­æŸäº›**å˜é‡çš„æ‹·è´**ï¼Œçº¿ç¨‹å¯¹æ‰€æœ‰å˜é‡çš„æ“ä½œéƒ½æ˜¯å…ˆå¯¹å˜é‡è¿›è¡Œæ‹·è´ï¼Œç„¶ååœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œä¸èƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜ä¸­çš„å˜é‡ï¼›çº¿ç¨‹ä¹‹é—´æ— æ³•ç›¸äº’ç›´æ¥è®¿é—®ï¼Œçº¿ç¨‹é—´çš„é€šä¿¡ï¼ˆä¼ é€’ï¼‰å¿…é¡»é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆ\r\n\r\n![image-20230824170740642](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824170740642.png)\r\n\r\nä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜ï¼š\r\n\r\n* ä¸»å†…å­˜ï¼šè®¡ç®—æœºçš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ç»å¸¸æåˆ°çš„ 8G å†…å­˜ï¼Œ16G å†…å­˜ï¼Œå­˜å‚¨æ‰€æœ‰å…±äº«å˜é‡çš„å€¼\r\n* å·¥ä½œå†…å­˜ï¼šå­˜å‚¨è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„å…±äº«å˜é‡åœ¨ä¸»å†…å­˜ä¸­çš„å€¼çš„å‰¯æœ¬æ‹·è´\r\n\r\n**JVM å’Œ JMM ä¹‹é—´çš„å…³ç³»**ï¼šJMM ä¸­çš„ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜ä¸ JVM ä¸­çš„ Java å †ã€æ ˆã€æ–¹æ³•åŒºç­‰å¹¶ä¸æ˜¯åŒä¸€ä¸ªå±‚æ¬¡çš„å†…å­˜åˆ’åˆ†ï¼Œè¿™ä¸¤è€…åŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰å…³ç³»çš„ï¼Œå¦‚æœä¸¤è€…ä¸€å®šè¦å‹‰å¼ºå¯¹åº”èµ·æ¥ï¼š\r\n\r\n* ä¸»å†…å­˜ä¸»è¦å¯¹åº”äº Java å †ä¸­çš„å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†ï¼Œè€Œå·¥ä½œå†…å­˜åˆ™å¯¹åº”äºè™šæ‹Ÿæœºæ ˆä¸­çš„éƒ¨åˆ†åŒºåŸŸ\r\n* ä»æ›´ä½å±‚æ¬¡ä¸Šè¯´ï¼Œä¸»å†…å­˜ç›´æ¥å¯¹åº”äºç‰©ç†ç¡¬ä»¶çš„å†…å­˜ï¼Œå·¥ä½œå†…å­˜å¯¹åº”å¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å†…å­˜äº¤äº’\r\n\r\nJava å†…å­˜æ¨¡å‹å®šä¹‰äº† 8 ä¸ªæ“ä½œæ¥å®Œæˆä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„äº¤äº’æ“ä½œï¼Œæ¯ä¸ªæ“ä½œéƒ½æ˜¯**åŸå­**çš„\r\n\r\néåŸå­åå®šï¼šæ²¡æœ‰è¢« volatile ä¿®é¥°çš„ longã€double å¤–ï¼Œé»˜è®¤æŒ‰ç…§ä¸¤æ¬¡ 32 ä½çš„æ“ä½œ\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824170847246.png\" alt=\"image-20230824170847246\" class=\"scale-80\" />\r\n\r\n* lockï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œå°†ä¸€ä¸ªå˜é‡æ ‡è¯†ä¸ºè¢«ä¸€ä¸ªçº¿ç¨‹ç‹¬å çŠ¶æ€ï¼ˆå¯¹åº” monitorenterï¼‰\r\n* unclockï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œå°†ä¸€ä¸ªå˜é‡ä»ç‹¬å çŠ¶æ€é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®šï¼ˆå¯¹åº” monitorexitï¼‰\r\n* readï¼šä½œç”¨äºä¸»å†…å­˜ï¼ŒæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°å·¥ä½œå†…å­˜ä¸­\r\n* loadï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼Œåœ¨ read ä¹‹åæ‰§è¡Œï¼ŒæŠŠ read å¾—åˆ°çš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­\r\n* useï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€’ç»™**æ‰§è¡Œå¼•æ“**ï¼Œæ¯å½“é‡åˆ°ä¸€ä¸ªä½¿ç”¨åˆ°å˜é‡çš„æ“ä½œæ—¶éƒ½è¦ä½¿ç”¨è¯¥æŒ‡ä»¤\r\n* assignï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„ä¸€ä¸ªå€¼èµ‹ç»™å·¥ä½œå†…å­˜çš„å˜é‡\r\n* storeï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠå·¥ä½œå†…å­˜çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­\r\n* writeï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œåœ¨ store ä¹‹åæ‰§è¡Œï¼ŒæŠŠ store å¾—åˆ°çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20%E5%B9%B6%E5%8F%91.md\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä¸‰å¤§ç‰¹æ€§\r\n\r\n##### å¯è§æ€§\r\n\r\n:::warning Error Correction!!!\r\n\r\nä»¥ä¸‹å¯è§æ€§é—®é¢˜äº§ç”Ÿçš„æ ¹æœ¬åŸå› å·²è¢«æ¨ç¿»ï¼Œè¯¦æƒ…è¯·çœ‹https://imlklaus.github.io/posts/Java_Interview_Topics-Concurrent#%E5%8F%AF%E8%A7%81%E6%80%A7\r\n\r\n:::\r\n\r\nå¯è§æ€§ï¼šæ˜¯æŒ‡å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼\r\n\r\nå­˜åœ¨ä¸å¯è§é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ç”±äºç¼“å­˜çš„å­˜åœ¨ï¼Œçº¿ç¨‹æŒæœ‰çš„æ˜¯å…±äº«å˜é‡çš„å‰¯æœ¬ï¼Œæ— æ³•æ„ŸçŸ¥å…¶ä»–çº¿ç¨‹å¯¹äºå…±äº«å˜é‡çš„æ›´æ”¹ï¼Œå¯¼è‡´è¯»å–çš„å€¼ä¸æ˜¯æœ€æ–°çš„ã€‚ä½†æ˜¯ final ä¿®é¥°çš„å˜é‡æ˜¯**ä¸å¯å˜**çš„ï¼Œå°±ç®—æœ‰ç¼“å­˜ï¼Œä¹Ÿä¸ä¼šå­˜åœ¨ä¸å¯è§çš„é—®é¢˜\r\n\r\nmain çº¿ç¨‹å¯¹ run å˜é‡çš„ä¿®æ”¹å¯¹äº t çº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº† t çº¿ç¨‹æ— æ³•åœæ­¢ï¼š\r\n\r\n```java\r\nstatic boolean run = true;\t//æ·»åŠ volatile\r\npublic static void main(String[] args) throws InterruptedException {\r\n    Thread t = new Thread(()->{\r\n        while(run){\r\n        // ....\r\n        }\r\n\t});\r\n    t.start();\r\n    sleep(1);\r\n    run = false; // çº¿ç¨‹tä¸ä¼šå¦‚é¢„æƒ³çš„åœä¸‹æ¥\r\n}\r\n```\r\n\r\n**ä¸ºä»€ä¹ˆæ— æ³•é€€å‡ºè¯¥å¾ªç¯**\r\n\r\n- åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»**ä¸»å†…å­˜**è¯»å–äº† run çš„å€¼åˆ°**å·¥ä½œå†…å­˜**ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145505.png)\r\n\r\n- å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼**ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜**ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œ å‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145517.png)\r\n\r\n- 1 ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡ çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯**æ—§å€¼**\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145529.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### åŸå­æ€§\r\n\r\nåŸå­æ€§ï¼šä¸å¯åˆ†å‰²ï¼Œå®Œæ•´æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´æŸä¸ªçº¿ç¨‹æ­£åœ¨åšæŸä¸ªå…·ä½“ä¸šåŠ¡æ—¶ï¼Œä¸­é—´ä¸å¯ä»¥è¢«åˆ†å‰²ï¼Œéœ€è¦å…·ä½“å®Œæˆï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ï¼Œä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“ \r\n\r\nå®šä¹‰åŸå­æ“ä½œçš„ä½¿ç”¨è§„åˆ™ï¼š\r\n\r\n1. ä¸å…è®¸ read å’Œ loadã€store å’Œ write æ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ï¼Œå¿…é¡»é¡ºåºæ‰§è¡Œï¼Œä½†æ˜¯ä¸è¦æ±‚è¿ç»­\r\n2. ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒ assign æ“ä½œï¼Œå¿…é¡»åŒæ­¥å›ä¸»å­˜\r\n3. ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°ï¼ˆæ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½• assign æ“ä½œï¼‰æŠŠæ•°æ®ä»å·¥ä½œå†…å­˜åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­\r\n4. ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­è¯ç”Ÿï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆassign æˆ–è€… loadï¼‰çš„å˜é‡ï¼Œå³å¯¹ä¸€ä¸ªå˜é‡å®æ–½ use å’Œ store æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆè‡ªè¡Œ assign å’Œ load æ“ä½œ\r\n5. ä¸€ä¸ªå˜é‡åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œ lock æ“ä½œï¼Œä½† lock æ“ä½œå¯ä»¥è¢«åŒä¸€çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œ lock åï¼Œåªæœ‰**æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„ unlock** æ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ï¼Œ**lock å’Œ unlock å¿…é¡»æˆå¯¹å‡ºç°**\r\n6. å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ lock æ“ä½œï¼Œå°†ä¼š**æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼**ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡ä¹‹å‰éœ€è¦é‡æ–°ä»ä¸»å­˜åŠ è½½\r\n7. å¦‚æœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢« lock æ“ä½œé”å®šï¼Œåˆ™ä¸å…è®¸æ‰§è¡Œ unlock æ“ä½œï¼Œä¹Ÿä¸å…è®¸å» unlock ä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šçš„å˜é‡\r\n8. å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ unlock æ“ä½œä¹‹å‰ï¼Œå¿…é¡»**å…ˆæŠŠæ­¤å˜é‡åŒæ­¥åˆ°ä¸»å†…å­˜**ä¸­ï¼ˆæ‰§è¡Œ store å’Œ write æ“ä½œï¼‰\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æœ‰åºæ€§\r\n\r\næœ‰åºæ€§ï¼šåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æœ‰åºçš„ï¼›åœ¨ä¸€ä¸ªçº¿ç¨‹è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æ— åºçš„ï¼Œæ— åºæ˜¯å› ä¸ºå‘ç”Ÿäº†æŒ‡ä»¤é‡æ’åº\r\n\r\nCPU çš„åŸºæœ¬å·¥ä½œæ˜¯æ‰§è¡Œå­˜å‚¨çš„æŒ‡ä»¤åºåˆ—ï¼Œå³ç¨‹åºï¼Œç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹å®é™…ä¸Šæ˜¯ä¸æ–­åœ°å–å‡ºæŒ‡ä»¤ã€åˆ†ææŒ‡ä»¤ã€æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šå¯¹æŒ‡ä»¤é‡æ’ï¼Œä¸€èˆ¬åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š\r\n\r\n```java\r\næºä»£ç  -> ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’ -> æŒ‡ä»¤å¹¶è¡Œçš„é‡æ’ -> å†…å­˜ç³»ç»Ÿçš„é‡æ’ -> æœ€ç»ˆæ‰§è¡ŒæŒ‡ä»¤\r\n```\r\n\r\nç°ä»£ CPU æ”¯æŒå¤šçº§æŒ‡ä»¤æµæ°´çº¿ï¼Œå‡ ä¹æ‰€æœ‰çš„å†¯â€¢è¯ºä¼Šæ›¼å‹è®¡ç®—æœºçš„ CPUï¼Œå…¶å·¥ä½œéƒ½å¯ä»¥åˆ†ä¸º 5 ä¸ªé˜¶æ®µï¼šå–æŒ‡ä»¤ã€æŒ‡ä»¤è¯‘ç ã€æ‰§è¡ŒæŒ‡ä»¤ã€è®¿å­˜å–æ•°å’Œç»“æœå†™å›ï¼Œå¯ä»¥ç§°ä¹‹ä¸º**äº”çº§æŒ‡ä»¤æµæ°´çº¿**ã€‚CPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒåŒæ—¶è¿è¡Œäº”æ¡æŒ‡ä»¤çš„**ä¸åŒé˜¶æ®µ**ï¼ˆæ¯ä¸ªçº¿ç¨‹ä¸åŒçš„é˜¶æ®µï¼‰ï¼Œæœ¬è´¨ä¸Šæµæ°´çº¿æŠ€æœ¯å¹¶ä¸èƒ½ç¼©çŸ­å•æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´ï¼Œä½†å˜ç›¸åœ°æé«˜äº†æŒ‡ä»¤åœ°ååç‡\r\n\r\nå¤„ç†å™¨åœ¨è¿›è¡Œé‡æ’åºæ—¶ï¼Œå¿…é¡»è¦è€ƒè™‘**æŒ‡ä»¤ä¹‹é—´çš„æ•°æ®ä¾èµ–æ€§**\r\n\r\n* å•çº¿ç¨‹ç¯å¢ƒä¹Ÿå­˜åœ¨æŒ‡ä»¤é‡æ’ï¼Œç”±äºå­˜åœ¨ä¾èµ–æ€§ï¼Œæœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºçš„ç»“æœä¸€è‡´\r\n* å¤šçº¿ç¨‹ç¯å¢ƒä¸­çº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œç”±äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’ï¼Œä¼šè·å–å…¶ä»–çº¿ç¨‹å¤„åœ¨ä¸åŒé˜¶æ®µçš„æŒ‡ä»¤åŒæ—¶æ‰§è¡Œ\r\n\r\nè¡¥å……çŸ¥è¯†ï¼š\r\n\r\n* æŒ‡ä»¤å‘¨æœŸæ˜¯å–å‡ºä¸€æ¡æŒ‡ä»¤å¹¶æ‰§è¡Œè¿™æ¡æŒ‡ä»¤çš„æ—¶é—´ï¼Œä¸€èˆ¬ç”±è‹¥å¹²ä¸ªæœºå™¨å‘¨æœŸç»„æˆ\r\n* æœºå™¨å‘¨æœŸä¹Ÿç§°ä¸º CPU å‘¨æœŸï¼Œä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªé˜¶æ®µï¼ˆå¦‚å–æŒ‡ã€è¯‘ç ã€æ‰§è¡Œç­‰ï¼‰ï¼Œæ¯ä¸€é˜¶æ®µå®Œæˆä¸€ä¸ªåŸºæœ¬æ“ä½œï¼Œå®Œæˆä¸€ä¸ªåŸºæœ¬æ“ä½œæ‰€éœ€è¦çš„æ—¶é—´ç§°ä¸ºæœºå™¨å‘¨æœŸ\r\n* æŒ¯è¡å‘¨æœŸæŒ‡å‘¨æœŸæ€§ä¿¡å·ä½œå‘¨æœŸæ€§é‡å¤å˜åŒ–çš„æ—¶é—´é—´éš”\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### cache\r\n\r\n#### ç¼“å­˜æœºåˆ¶\r\n\r\n##### ç¼“å­˜ç»“æ„\r\n\r\nåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼ŒCPU é«˜é€Ÿç¼“å­˜ï¼ˆCPU Cacheï¼Œç®€ç§°ç¼“å­˜ï¼‰æ˜¯ç”¨äºå‡å°‘å¤„ç†å™¨è®¿é—®å†…å­˜æ‰€éœ€å¹³å‡æ—¶é—´çš„éƒ¨ä»¶ï¼›åœ¨å­˜å‚¨ä½“ç³»ä¸­ä½äºè‡ªé¡¶å‘ä¸‹çš„ç¬¬äºŒå±‚ï¼Œä»…æ¬¡äº CPU å¯„å­˜å™¨ï¼›å…¶å®¹é‡è¿œå°äºå†…å­˜ï¼Œä½†é€Ÿåº¦å´å¯ä»¥æ¥è¿‘å¤„ç†å™¨çš„é¢‘ç‡\r\n\r\nCPU å¤„ç†å™¨é€Ÿåº¦è¿œè¿œå¤§äºåœ¨ä¸»å†…å­˜ä¸­çš„ï¼Œä¸ºäº†è§£å†³é€Ÿåº¦å·®å¼‚ï¼Œåœ¨å®ƒä»¬ä¹‹é—´æ¶è®¾äº†å¤šçº§ç¼“å­˜ï¼Œå¦‚ L1ã€L2ã€L3 çº§åˆ«çš„ç¼“å­˜ï¼Œè¿™äº›ç¼“å­˜ç¦» CPU è¶Šè¿‘å°±è¶Šå¿«ï¼Œå°†é¢‘ç¹æ“ä½œçš„æ•°æ®ç¼“å­˜åˆ°è¿™é‡Œï¼ŒåŠ å¿«è®¿é—®é€Ÿåº¦\r\n\r\n![image-20230824170955611](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824170955611.png)\r\n\r\n| ä» CPU åˆ° | å¤§çº¦éœ€è¦çš„æ—¶é’Ÿå‘¨æœŸ                |\r\n| --------- | --------------------------------- |\r\n| å¯„å­˜å™¨    | 1 cycle (4GHz çš„ CPU çº¦ä¸º 0.25ns) |\r\n| L1        | 3~4 cycle                         |\r\n| L2        | 10~20 cycle                       |\r\n| L3        | 40~45 cycle                       |\r\n| å†…å­˜      | 120~240 cycle                     |\r\n\r\n\r\n\r\n##### ç¼“å­˜ä½¿ç”¨\r\n\r\nå½“å¤„ç†å™¨å‘å‡ºå†…å­˜è®¿é—®è¯·æ±‚æ—¶ï¼Œä¼šå…ˆæŸ¥çœ‹ç¼“å­˜å†…æ˜¯å¦æœ‰è¯·æ±‚æ•°æ®ï¼Œå¦‚æœå­˜åœ¨ï¼ˆå‘½ä¸­ï¼‰ï¼Œåˆ™ä¸ç”¨è®¿é—®å†…å­˜ç›´æ¥è¿”å›è¯¥æ•°æ®ï¼›å¦‚æœä¸å­˜åœ¨ï¼ˆå¤±æ•ˆï¼‰ï¼Œåˆ™è¦å…ˆæŠŠå†…å­˜ä¸­çš„ç›¸åº”æ•°æ®è½½å…¥ç¼“å­˜ï¼Œå†å°†å…¶è¿”å›å¤„ç†å™¨\r\n\r\nç¼“å­˜ä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œä¸»è¦å› ä¸ºç¨‹åºè¿è¡Œæ—¶å¯¹å†…å­˜çš„è®¿é—®å‘ˆç°å±€éƒ¨æ€§ï¼ˆLocalityï¼‰ç‰¹å¾ã€‚æ—¢åŒ…æ‹¬ç©ºé—´å±€éƒ¨æ€§ï¼ˆSpatial Localityï¼‰ï¼Œä¹ŸåŒ…æ‹¬æ—¶é—´å±€éƒ¨æ€§ï¼ˆTemporal Localityï¼‰ï¼Œæœ‰æ•ˆåˆ©ç”¨è¿™ç§å±€éƒ¨æ€§ï¼Œç¼“å­˜å¯ä»¥è¾¾åˆ°æé«˜çš„å‘½ä¸­ç‡\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä¼ªå…±äº«\r\n\r\n**ç¼“å­˜ä»¥ç¼“å­˜è¡Œ cache line ä¸ºå•ä½**ï¼Œæ¯ä¸ªç¼“å­˜è¡Œå¯¹åº”ç€ä¸€å—å†…å­˜ï¼Œä¸€èˆ¬æ˜¯ 64 byteï¼ˆ8 ä¸ª longï¼‰ï¼Œåœ¨ CPU ä»ä¸»å­˜è·å–æ•°æ®æ—¶ï¼Œä»¥ cache line ä¸ºå•ä½åŠ è½½ï¼Œäºæ˜¯ç›¸é‚»çš„æ•°æ®ä¼šä¸€å¹¶åŠ è½½åˆ°ç¼“å­˜ä¸­\r\n\r\nç¼“å­˜ä¼šé€ æˆæ•°æ®å‰¯æœ¬çš„äº§ç”Ÿï¼Œå³åŒä¸€ä»½æ•°æ®ä¼šç¼“å­˜åœ¨ä¸åŒæ ¸å¿ƒçš„ç¼“å­˜è¡Œä¸­ï¼ŒCPU è¦ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéœ€è¦åšåˆ°æŸä¸ª CPU æ ¸å¿ƒæ›´æ”¹äº†æ•°æ®ï¼Œå…¶å®ƒ CPU æ ¸å¿ƒå¯¹åº”çš„**æ•´ä¸ªç¼“å­˜è¡Œå¿…é¡»å¤±æ•ˆ**ï¼Œè¿™å°±æ˜¯ä¼ªå…±äº«\r\n\r\n![image-20230824171035903](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824171035903.png)\r\n\r\nè§£å†³æ–¹æ³•ï¼š\r\n\r\n* paddingï¼šé€šè¿‡å¡«å……ï¼Œè®©æ•°æ®è½åœ¨ä¸åŒçš„ cache line ä¸­\r\n\r\n* @Contendedï¼šåŸç†å‚è€ƒ æ— é” â†’ Adder â†’ ä¼˜åŒ–æœºåˆ¶ â†’ ä¼ªå…±äº«\r\n\r\nLinux æŸ¥çœ‹ CPU ç¼“å­˜è¡Œï¼š\r\n\r\n* å‘½ä»¤ï¼š`cat /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size64`\r\n* å†…å­˜åœ°å€æ ¼å¼ï¼š[é«˜ä½ç»„æ ‡è®°] [ä½ä½ç´¢å¼•] [åç§»é‡]\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ç¼“å­˜ä¸€è‡´\r\n\r\nç¼“å­˜ä¸€è‡´æ€§ï¼šå½“å¤šä¸ªå¤„ç†å™¨è¿ç®—ä»»åŠ¡éƒ½æ¶‰åŠåˆ°åŒä¸€å—ä¸»å†…å­˜åŒºåŸŸçš„æ—¶å€™ï¼Œå°†å¯èƒ½å¯¼è‡´å„è‡ªçš„ç¼“å­˜æ•°æ®ä¸ä¸€æ ·\r\n\r\n![image-20230824171115157](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824171115157.png)\r\n\r\nMESIï¼ˆModified Exclusive Shared Or Invalidï¼‰æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„**æ”¯æŒå†™å›ç­–ç•¥çš„ç¼“å­˜ä¸€è‡´æ€§åè®®**ï¼ŒCPU ä¸­æ¯ä¸ªç¼“å­˜è¡Œï¼ˆcaceh lineï¼‰ä½¿ç”¨ 4 ç§çŠ¶æ€è¿›è¡Œæ ‡è®°ï¼ˆä½¿ç”¨é¢å¤–çš„ä¸¤ä½ bit è¡¨ç¤º)ï¼š\r\n\r\n* Mï¼šè¢«ä¿®æ”¹ï¼ˆModifiedï¼‰\r\n\r\n  è¯¥ç¼“å­˜è¡Œåªè¢«ç¼“å­˜åœ¨è¯¥ CPU çš„ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”æ˜¯è¢«ä¿®æ”¹è¿‡çš„ï¼Œä¸ä¸»å­˜ä¸­çš„æ•°æ®ä¸ä¸€è‡´ (dirty)ï¼Œè¯¥ç¼“å­˜è¡Œä¸­çš„å†…å­˜éœ€è¦å†™å› (write back) ä¸»å­˜ã€‚è¯¥çŠ¶æ€çš„æ•°æ®å†æ¬¡è¢«ä¿®æ”¹ä¸ä¼šå‘é€å¹¿æ’­ï¼Œå› ä¸ºå…¶ä»–æ ¸å¿ƒçš„æ•°æ®å·²ç»åœ¨ç¬¬ä¸€æ¬¡ä¿®æ”¹æ—¶å¤±æ•ˆä¸€æ¬¡\r\n\r\n  å½“è¢«å†™å›ä¸»å­˜ä¹‹åï¼Œè¯¥ç¼“å­˜è¡Œçš„çŠ¶æ€ä¼šå˜æˆç‹¬äº« (exclusive) çŠ¶æ€\r\n\r\n* Eï¼šç‹¬äº«çš„ï¼ˆExclusiveï¼‰\r\n\r\n  è¯¥ç¼“å­˜è¡Œåªè¢«ç¼“å­˜åœ¨è¯¥ CPU çš„ç¼“å­˜ä¸­ï¼Œæ˜¯æœªè¢«ä¿®æ”¹è¿‡çš„ (clear)ï¼Œä¸ä¸»å­˜ä¸­æ•°æ®ä¸€è‡´ï¼Œä¿®æ”¹æ•°æ®ä¸éœ€è¦é€šçŸ¥å…¶ä»– CPU æ ¸å¿ƒï¼Œè¯¥çŠ¶æ€å¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»æœ‰å…¶å®ƒ CPU è¯»å–è¯¥å†…å­˜æ—¶å˜æˆå…±äº«çŠ¶æ€ (shared)\r\n\r\n  å½“ CPU ä¿®æ”¹è¯¥ç¼“å­˜è¡Œä¸­å†…å®¹æ—¶ï¼Œè¯¥çŠ¶æ€å¯ä»¥å˜æˆ Modified çŠ¶æ€\r\n\r\n* Sï¼šå…±äº«çš„ï¼ˆSharedï¼‰\r\n\r\n  è¯¥çŠ¶æ€æ„å‘³ç€è¯¥ç¼“å­˜è¡Œå¯èƒ½è¢«å¤šä¸ª CPU ç¼“å­˜ï¼Œå¹¶ä¸”å„ä¸ªç¼“å­˜ä¸­çš„æ•°æ®ä¸ä¸»å­˜æ•°æ®ä¸€è‡´ï¼Œå½“ CPU ä¿®æ”¹è¯¥ç¼“å­˜è¡Œä¸­ï¼Œä¼šå‘å…¶å®ƒ CPU æ ¸å¿ƒå¹¿æ’­ä¸€ä¸ªè¯·æ±‚ï¼Œä½¿è¯¥ç¼“å­˜è¡Œå˜æˆæ— æ•ˆçŠ¶æ€ (Invalid)ï¼Œç„¶åå†æ›´æ–°å½“å‰ Cache é‡Œçš„æ•°æ®\r\n\r\n* Iï¼šæ— æ•ˆçš„ï¼ˆInvalidï¼‰\r\n\r\n  è¯¥ç¼“å­˜æ˜¯æ— æ•ˆçš„ï¼Œå¯èƒ½æœ‰å…¶å®ƒ CPU ä¿®æ”¹äº†è¯¥ç¼“å­˜è¡Œ\r\n\r\nè§£å†³æ–¹æ³•ï¼šå„ä¸ªå¤„ç†å™¨è®¿é—®ç¼“å­˜æ—¶éƒ½éµå¾ªä¸€äº›åè®®ï¼Œåœ¨è¯»å†™æ—¶è¦æ ¹æ®åè®®è¿›è¡Œæ“ä½œï¼Œåè®®ä¸»è¦æœ‰ MSIã€MESI ç­‰\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### å¤„ç†æœºåˆ¶\r\n\r\nå•æ ¸ CPU å¤„ç†å™¨ä¼šè‡ªåŠ¨ä¿è¯åŸºæœ¬å†…å­˜æ“ä½œçš„åŸå­æ€§\r\n\r\nå¤šæ ¸ CPU å¤„ç†å™¨ï¼Œæ¯ä¸ª CPU å¤„ç†å™¨å†…ç»´æŠ¤äº†ä¸€å—å†…å­˜ï¼Œæ¯ä¸ªå†…æ ¸å†…éƒ¨ç»´æŠ¤ç€ä¸€å—ç¼“å­˜ï¼Œå½“å¤šçº¿ç¨‹å¹¶å‘è¯»å†™æ—¶ï¼Œå°±ä¼šå‡ºç°ç¼“å­˜æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚å¤„ç†å™¨æä¾›ï¼š\r\n\r\n* æ€»çº¿é”å®šï¼šå½“å¤„ç†å™¨è¦æ“ä½œå…±äº«å˜é‡æ—¶ï¼Œåœ¨ BUS æ€»çº¿ä¸Šå‘å‡ºä¸€ä¸ª LOCK ä¿¡å·ï¼Œå…¶ä»–å¤„ç†å™¨å°±æ— æ³•æ“ä½œè¿™ä¸ªå…±äº«å˜é‡ï¼Œè¯¥æ“ä½œä¼šå¯¼è‡´å¤§é‡é˜»å¡ï¼Œä»è€Œå¢åŠ ç³»ç»Ÿçš„æ€§èƒ½å¼€é”€ï¼ˆ**å¹³å°çº§åˆ«çš„åŠ é”**ï¼‰\r\n* ç¼“å­˜é”å®šï¼šå½“å¤„ç†å™¨å¯¹ç¼“å­˜ä¸­çš„å…±äº«å˜é‡è¿›è¡Œäº†æ“ä½œï¼Œå…¶ä»–å¤„ç†å™¨æœ‰å—…æ¢æœºåˆ¶ï¼Œå°†å„è‡ªç¼“å­˜ä¸­çš„è¯¥å…±äº«å˜é‡çš„å¤±æ•ˆï¼Œè¯»å–æ—¶ä¼šé‡æ–°ä»ä¸»å†…å­˜ä¸­è¯»å–æœ€æ–°çš„æ•°æ®ï¼ŒåŸºäº MESI ç¼“å­˜ä¸€è‡´æ€§åè®®æ¥å®ç°\r\n\r\næœ‰å¦‚ä¸‹ä¸¤ç§æƒ…å†µå¤„ç†å™¨ä¸ä¼šä½¿ç”¨ç¼“å­˜é”å®šï¼š\r\n\r\n* å½“æ“ä½œçš„æ•°æ®è·¨å¤šä¸ªç¼“å­˜è¡Œï¼Œæˆ–æ²¡è¢«ç¼“å­˜åœ¨å¤„ç†å™¨å†…éƒ¨ï¼Œåˆ™å¤„ç†å™¨ä¼šä½¿ç”¨æ€»çº¿é”å®š\r\n\r\n* æœ‰äº›å¤„ç†å™¨ä¸æ”¯æŒç¼“å­˜é”å®šï¼Œæ¯”å¦‚ï¼šIntel 486 å’Œ Pentium å¤„ç†å™¨ä¹Ÿä¼šè°ƒç”¨æ€»çº¿é”å®š\r\n\r\næ€»çº¿æœºåˆ¶ï¼š\r\n\r\n* æ€»çº¿å—…æ¢ï¼šæ¯ä¸ªå¤„ç†å™¨é€šè¿‡å—…æ¢åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±ç¼“å­˜å€¼æ˜¯å¦è¿‡æœŸäº†ï¼Œå½“å¤„ç†å™¨å‘ç°è‡ªå·±çš„ç¼“å­˜å¯¹åº”çš„å†…å­˜åœ°å€çš„æ•°æ®è¢«ä¿®æ”¹ï¼Œå°±**å°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®ä¸ºæ— æ•ˆçŠ¶æ€**ï¼Œå½“å¤„ç†å™¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œæ“ä½œæ—¶ï¼Œä¼šé‡æ–°ä»å†…å­˜ä¸­æŠŠæ•°æ®è¯»å–åˆ°å¤„ç†å™¨ç¼“å­˜ä¸­\r\n\r\n* æ€»çº¿é£æš´ï¼šå½“æŸä¸ª CPU æ ¸å¿ƒæ›´æ–°äº† Cache ä¸­çš„æ•°æ®ï¼Œè¦æŠŠè¯¥äº‹ä»¶å¹¿æ’­é€šçŸ¥åˆ°å…¶ä»–æ ¸å¿ƒï¼ˆ**å†™ä¼ æ’­**ï¼‰ï¼ŒCPU éœ€è¦æ¯æ—¶æ¯åˆ»ç›‘å¬æ€»çº¿ä¸Šçš„ä¸€åˆ‡æ´»åŠ¨ï¼Œä½†æ˜¯ä¸ç®¡åˆ«çš„æ ¸å¿ƒçš„ Cache æ˜¯å¦ç¼“å­˜ç›¸åŒçš„æ•°æ®ï¼Œéƒ½éœ€è¦å‘å‡ºä¸€ä¸ªå¹¿æ’­äº‹ä»¶ï¼Œä¸æ–­çš„ä»ä¸»å†…å­˜å—…æ¢å’Œ CAS å¾ªç¯ï¼Œæ— æ•ˆçš„äº¤äº’ä¼šå¯¼è‡´æ€»çº¿å¸¦å®½è¾¾åˆ°å³°å€¼ï¼›å› æ­¤ä¸è¦å¤§é‡ä½¿ç”¨ volatile å…³é”®å­—ï¼Œä½¿ç”¨ volatileã€syschonized éƒ½éœ€è¦æ ¹æ®å®é™…åœºæ™¯\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### volatile\r\n\r\n#### åŒæ­¥æœºåˆ¶\r\n\r\nvolatile æ˜¯ Java è™šæ‹Ÿæœºæä¾›çš„**è½»é‡çº§**çš„åŒæ­¥æœºåˆ¶ï¼ˆä¸‰å¤§ç‰¹æ€§ï¼‰\r\n\r\n- ä¿è¯å¯è§æ€§\r\n- ä¸ä¿è¯åŸå­æ€§\r\n- ä¿è¯æœ‰åºæ€§ï¼ˆç¦æ­¢æŒ‡ä»¤é‡æ’ï¼‰\r\n\r\næ€§èƒ½ï¼švolatile ä¿®é¥°çš„å˜é‡è¿›è¡Œè¯»æ“ä½œä¸æ™®é€šå˜é‡å‡ ä¹æ²¡ä»€ä¹ˆå·®åˆ«ï¼Œä½†æ˜¯å†™æ“ä½œç›¸å¯¹æ…¢ä¸€äº›ï¼Œå› ä¸ºéœ€è¦åœ¨æœ¬åœ°ä»£ç ä¸­æ’å…¥å¾ˆå¤šå†…å­˜å±éšœæ¥ä¿è¯æŒ‡ä»¤ä¸ä¼šå‘ç”Ÿä¹±åºæ‰§è¡Œï¼Œä½†æ˜¯å¼€é”€æ¯”é”è¦å°\r\n\r\nsynchronized æ— æ³•ç¦æ­¢æŒ‡ä»¤é‡æ’å’Œå¤„ç†å™¨ä¼˜åŒ–ï¼Œä¸ºä»€ä¹ˆå¯ä»¥ä¿è¯æœ‰åºæ€§å¯è§æ€§\r\n\r\n* åŠ äº†é”ä¹‹åï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾—åˆ°äº†é”ï¼Œè·å¾—ä¸åˆ°é”çš„çº¿ç¨‹å°±è¦é˜»å¡ï¼Œæ‰€ä»¥åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œç›¸å½“äºå•çº¿ç¨‹ï¼Œç”±äºæ•°æ®ä¾èµ–æ€§çš„å­˜åœ¨ï¼Œå•çº¿ç¨‹çš„æŒ‡ä»¤é‡æ’æ˜¯æ²¡æœ‰é—®é¢˜çš„\r\n* çº¿ç¨‹åŠ é”å‰ï¼Œå°†**æ¸…ç©ºå·¥ä½œå†…å­˜**ä¸­å…±äº«å˜é‡çš„å€¼ï¼Œä½¿ç”¨å…±äº«å˜é‡æ—¶éœ€è¦ä»ä¸»å†…å­˜ä¸­é‡æ–°è¯»å–æœ€æ–°çš„å€¼ï¼›çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼**åˆ·æ–°åˆ°ä¸»å†…å­˜**ä¸­ï¼ˆJMM å†…å­˜äº¤äº’ç« èŠ‚æœ‰è®²ï¼‰\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æŒ‡ä»¤é‡æ’\r\n\r\nvolatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’\r\n\r\næŒ‡ä»¤é‡æ’å®ä¾‹ï¼š\r\n\r\n* example 1ï¼š\r\n\r\n  ```java\r\n  public void mySort() {\r\n  \tint x = 11;\t//è¯­å¥1\r\n  \tint y = 12;\t//è¯­å¥2  è°å…ˆæ‰§è¡Œæ•ˆæœä¸€æ ·\r\n  \tx = x + 5;\t//è¯­å¥3\r\n  \ty = x * x;\t//è¯­å¥4\r\n  }\r\n  ```\r\n\r\n  æ‰§è¡Œé¡ºåºæ˜¯ï¼š1 2 3 4ã€2 1 3 4ã€1 3 2 4\r\n\r\n  æŒ‡ä»¤é‡æ’ä¹Ÿæœ‰é™åˆ¶ä¸ä¼šå‡ºç°ï¼š4321ï¼Œè¯­å¥ 4 éœ€è¦ä¾èµ–äº y ä»¥åŠ x çš„ç”³æ˜ï¼Œå› ä¸ºå­˜åœ¨æ•°æ®ä¾èµ–ï¼Œæ— æ³•é¦–å…ˆæ‰§è¡Œ\r\n\r\n* example 2ï¼š\r\n\r\n  ```java\r\n  int num = 0;\r\n  boolean ready = false;\r\n  // çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•\r\n  public void actor1(I_Result r) {\r\n      if(ready) {\r\n      \tr.r1 = num + num;\r\n      } else {\r\n      \tr.r1 = 1;\r\n      }\r\n  }\r\n  // çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•\r\n  public void actor2(I_Result r) {\r\n  \tnum = 2;\r\n  \tready = true;\r\n  }\r\n  ```\r\n\r\n  æƒ…å†µä¸€ï¼šçº¿ç¨‹ 1 å…ˆæ‰§è¡Œï¼Œready = falseï¼Œç»“æœä¸º r.r1 = 1\r\n\r\n  æƒ…å†µäºŒï¼šçº¿ç¨‹ 2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†è¿˜æ²¡æ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹ 1 æ‰§è¡Œï¼Œç»“æœä¸º r.r1 = 1\r\n\r\n  æƒ…å†µä¸‰ï¼šçº¿ç¨‹ 2 å…ˆæ‰§è¡Œ num = 2 å’Œ ready = trueï¼Œçº¿ç¨‹ 1 æ‰§è¡Œï¼Œè¿›å…¥ if åˆ†æ”¯ç»“æœä¸º r.r1 = 4\r\n\r\n  æƒ…å†µå››ï¼šçº¿ç¨‹ 2 å…ˆæ‰§è¡Œ ready = trueï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹ 1ï¼Œè¿›å…¥ if åˆ†æ”¯ä¸º r.r1 = 0ï¼Œå†åˆ‡å›çº¿ç¨‹ 2 æ‰§è¡Œ num = 2ï¼Œå‘ç”ŸæŒ‡ä»¤é‡æ’\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### åº•å±‚åŸç†\r\n\r\n##### ç¼“å­˜ä¸€è‡´\r\n\r\nä½¿ç”¨ volatile ä¿®é¥°çš„å…±äº«å˜é‡ï¼Œåº•å±‚é€šè¿‡æ±‡ç¼– lock å‰ç¼€æŒ‡ä»¤è¿›è¡Œç¼“å­˜é”å®šï¼Œåœ¨çº¿ç¨‹ä¿®æ”¹å®Œå…±äº«å˜é‡åå†™å›ä¸»å­˜ï¼Œå…¶ä»–çš„ CPU æ ¸å¿ƒä¸Šè¿è¡Œçš„çº¿ç¨‹é€šè¿‡ CPU æ€»çº¿å—…æ¢æœºåˆ¶ä¼šä¿®æ”¹å…¶**å·¥ä½œå†…å­˜ä¸­çš„å…±äº«å˜é‡å‰¯æœ¬ä¸ºå¤±æ•ˆçŠ¶æ€**ï¼Œè¯»å–æ—¶ä¼šé‡æ–°ä»ä¸»å†…å­˜ä¸­è¯»å–æœ€æ–°çš„æ•°æ®\r\n\r\nlock å‰ç¼€æŒ‡ä»¤å°±ç›¸å½“äºå†…å­˜å±éšœï¼ŒMemory Barrierï¼ˆMemory Fenceï¼‰\r\n\r\n* å¯¹ volatile å˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥å†™å±éšœ\r\n* å¯¹ volatile å˜é‡çš„è¯»æŒ‡ä»¤å‰ä¼šåŠ å…¥è¯»å±éšœ\r\n\r\nå†…å­˜å±éšœæœ‰ä¸‰ä¸ªä½œç”¨ï¼š\r\n\r\n- ç¡®ä¿å¯¹å†…å­˜çš„è¯»-æ”¹-å†™æ“ä½œåŸå­æ‰§è¡Œ\r\n- é˜»æ­¢å±éšœä¸¤ä¾§çš„æŒ‡ä»¤é‡æ’åº\r\n- å¼ºåˆ¶æŠŠç¼“å­˜ä¸­çš„è„æ•°æ®å†™å›ä¸»å†…å­˜ï¼Œè®©ç¼“å­˜è¡Œä¸­ç›¸åº”çš„æ•°æ®å¤±æ•ˆ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å†…å­˜å±éšœ\r\n\r\nä¿è¯**å¯è§æ€§**ï¼š\r\n\r\n* å†™å±éšœï¼ˆsfenceï¼ŒStore Barrierï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­\r\n\r\n  ```java\r\n  public void actor2(I_Result r) {\r\n      num = 2;\r\n      ready = true; // ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ\r\n      // å†™å±éšœ â–²â–²â–²\r\n  }\r\n  ```\r\n\r\n* è¯»å±éšœï¼ˆlfenceï¼ŒLoad Barrierï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹åçš„ï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼Œä»ä¸»å­˜åˆ·æ–°å˜é‡å€¼ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®\r\n\r\n  ```java\r\n  public void actor1(I_Result r) {\r\n      // è¯»å±éšœ â†“â†“â†“â†“\r\n      // ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ\r\n      if(ready) {\r\n      \tr.r1 = num + num;\r\n      } else {\r\n      \tr.r1 = 1;\r\n      }\r\n  }\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145713.png\" alt=\"img\" class=\"scale-67\" />\r\n\r\n* å…¨èƒ½å±éšœï¼šmfenceï¼ˆmodify/mix Barrierï¼‰ï¼Œå…¼å…· sfence å’Œ lfence çš„åŠŸèƒ½\r\n\r\nä¿è¯**æœ‰åºæ€§**ï¼š\r\n\r\n* å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å\r\n* è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰\r\n\r\n![image-20230713210757338](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230713210757338.png)\r\n\r\nä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™ï¼š\r\n\r\n* å†™å±éšœä»…ä»…æ˜¯ä¿è¯ä¹‹åçš„è¯»èƒ½å¤Ÿè¯»åˆ°æœ€æ–°çš„ç»“æœï¼Œä½†ä¸èƒ½ä¿è¯å…¶ä»–çº¿ç¨‹çš„è¯»è·‘åˆ°å†™å±éšœä¹‹å‰\r\n\r\n* æœ‰åºæ€§çš„ä¿è¯ä¹Ÿåªæ˜¯ä¿è¯äº†æœ¬çº¿ç¨‹å†…ç›¸å…³ä»£ç ä¸è¢«é‡æ’åº\r\n\r\n  ```java\r\n  volatile i = 0;\r\n  new Thread(() -> {i++});\r\n  new Thread(() -> {i--});\r\n  ```\r\n\r\n  i++ åç¼–è¯‘åçš„æŒ‡ä»¤ï¼š\r\n\r\n  ```java\r\n  0: iconst_1\t\t\t// å½“intå–å€¼ -1~5 æ—¶ï¼ŒJVMé‡‡ç”¨iconstæŒ‡ä»¤å°†å¸¸é‡å‹å…¥æ ˆä¸­\r\n  1: istore_1\t\t\t// å°†æ“ä½œæ•°æ ˆé¡¶æ•°æ®å¼¹å‡ºï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 1\r\n  2: iinc\t\t1, 1\t\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230713212314498.png\" alt=\"image-20230713212314498\" class=\"scale-67\" />\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n##### äº¤äº’è§„åˆ™\r\n\r\nå¯¹äº volatile ä¿®é¥°çš„å˜é‡ï¼š\r\n\r\n* çº¿ç¨‹å¯¹å˜é‡çš„ use ä¸ loadã€read æ“ä½œæ˜¯ç›¸å…³è”çš„ï¼Œæ‰€ä»¥å˜é‡ä½¿ç”¨å‰å¿…é¡»å…ˆä»ä¸»å­˜åŠ è½½\r\n* çº¿ç¨‹å¯¹å˜é‡çš„ assign ä¸ storeã€write æ“ä½œæ˜¯ç›¸å…³è”çš„ï¼Œæ‰€ä»¥å˜é‡ä½¿ç”¨åå¿…é¡»åŒæ­¥è‡³ä¸»å­˜\r\n* çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 è°å…ˆå¯¹å˜é‡æ‰§è¡Œ read æ“ä½œï¼Œå°±ä¼šå…ˆè¿›è¡Œ write æ“ä½œï¼Œé˜²æ­¢æŒ‡ä»¤é‡æ’\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åŒç«¯æ£€é”\r\n\r\n##### æ£€é”æœºåˆ¶\r\n\r\nDouble-Checked Lockingï¼šåŒç«¯æ£€é”æœºåˆ¶\r\n\r\nDCLï¼ˆåŒç«¯æ£€é”ï¼‰æœºåˆ¶ä¸ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŸå› æ˜¯æœ‰æŒ‡ä»¤é‡æ’çš„å­˜åœ¨ï¼ŒåŠ å…¥ volatile å¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’\r\n\r\n```java\r\npublic final class Singleton {\r\n    private Singleton() { }\r\n    private static Singleton INSTANCE = null;\r\n    \r\n    public static Singleton getInstance() {\r\n        if(INSTANCE == null) { // t2ï¼Œè¿™é‡Œçš„åˆ¤æ–­ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„\r\n            // é¦–æ¬¡è®¿é—®ä¼šåŒæ­¥ï¼Œè€Œä¹‹åçš„ä½¿ç”¨æ²¡æœ‰ synchronized\r\n            synchronized(Singleton.class) {\r\n                // è¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ¤æ–­ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹åœ¨å½“å‰çº¿ç¨‹ç­‰å¾…é”çš„æœŸé—´å®Œæˆäº†åˆå§‹åŒ–\r\n                if (INSTANCE == null) { \r\n                    INSTANCE = new Singleton();\r\n                }\r\n            }\r\n        }\r\n        return INSTANCE;\r\n    }\r\n}\r\n```\r\n\r\nä¸é” INSTANCE çš„åŸå› ï¼š\r\n\r\n* INSTANCE è¦é‡æ–°èµ‹å€¼\r\n* INSTANCE æ˜¯ nullï¼Œçº¿ç¨‹åŠ é”ä¹‹å‰éœ€è¦è·å–å¯¹è±¡çš„å¼•ç”¨ï¼Œè®¾ç½®å¯¹è±¡å¤´ï¼Œnull æ²¡æœ‰å¼•ç”¨\r\n\r\nå®ç°ç‰¹ç‚¹ï¼š \r\n\r\n* æ‡’æƒ°åˆå§‹åŒ–\r\n* é¦–æ¬¡ä½¿ç”¨ getInstance() æ‰ä½¿ç”¨ synchronized åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”\r\n* ç¬¬ä¸€ä¸ª if ä½¿ç”¨äº† INSTANCE å˜é‡ï¼Œæ˜¯åœ¨åŒæ­¥å—ä¹‹å¤–ï¼Œä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šäº§ç”Ÿé—®é¢˜\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### DCLé—®é¢˜\r\n\r\ngetInstance æ–¹æ³•å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š\r\n\r\n```java\r\n0: \tgetstatic \t\t#2 \t\t// Field INSTANCE:Ltest/Singleton;\r\n3: \tifnonnull \t\t37\r\n6: \tldc \t\t\t#3 \t\t// class test/Singleton\r\n8: \tdup\r\n9: \tastore_0\r\n10: monitorenter\r\n11: getstatic \t\t#2 \t\t// Field INSTANCE:Ltest/Singleton;\r\n14: ifnonnull 27\r\n17: new \t\t\t#3 \t\t// class test/Singleton\r\n20: dup\r\n21: invokespecial \t#4 \t\t// Method \"<init>\":()V\r\n24: putstatic \t\t#2 \t\t// Field INSTANCE:Ltest/Singleton;\r\n27: aload_0\r\n28: monitorexit\r\n29: goto 37\r\n32: astore_1\r\n33: aload_0\r\n34: monitorexit\r\n35: aload_1\r\n36: athrow\r\n37: getstatic \t\t#2 \t\t// Field INSTANCE:Ltest/Singleton;\r\n40: areturn\r\n```\r\n\r\n* 17 è¡¨ç¤ºåˆ›å»ºå¯¹è±¡ï¼Œå°†å¯¹è±¡å¼•ç”¨å…¥æ ˆ // new Singleton\r\n* 20 è¡¨ç¤ºå¤åˆ¶ä¸€ä»½å¯¹è±¡å¼•ç”¨ // å¼•ç”¨åœ°å€\r\n* 21 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œè°ƒç”¨æ„é€ æ–¹æ³•\r\n* 24 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œèµ‹å€¼ç»™ static INSTANCE\r\n\r\n**æ­¥éª¤ 21 å’Œ 24 ä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»**ï¼Œè€Œä¸”æ— è®ºé‡æ’å‰åï¼Œç¨‹åºçš„æ‰§è¡Œç»“æœåœ¨å•çº¿ç¨‹ä¸­å¹¶æ²¡æœ‰æ”¹å˜ï¼Œå› æ­¤è¿™ç§é‡æ’ä¼˜åŒ–æ˜¯å…è®¸çš„\r\n\r\nä¹Ÿè®¸ jvm ä¼šä¼˜åŒ–ä¸ºï¼šå…ˆæ‰§è¡Œ 24ï¼Œå†æ‰§è¡Œ 21ã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹ t1ï¼Œt2 æŒ‰å¦‚ä¸‹æ—¶é—´åºåˆ—æ‰§è¡Œï¼š\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230713215804212.png\" alt=\"image-20230713215804212\" class=\"scale-67\" />\r\n\r\n> å…³é”®åœ¨äº 0: getstatic è¿™è¡Œä»£ç åœ¨ monitor æ§åˆ¶ä¹‹å¤–ï¼Œå®ƒå°±åƒä¹‹å‰ä¸¾ä¾‹ä¸­ä¸å®ˆè§„åˆ™çš„äººï¼Œå¯ä»¥è¶Šè¿‡ monitor è¯»å–INSTANCE å˜é‡çš„å€¼ï¼›è¿™æ—¶ t1 è¿˜æœªå®Œå…¨å°†æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­è¦æ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆ t2 æ‹¿åˆ°çš„å°†æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œæ¯•çš„å•ä¾‹ï¼›å¯¹ INSTANCE ä½¿ç”¨ volatile ä¿®é¥°å³å¯ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’ï¼Œä½†è¦æ³¨æ„åœ¨ JDK 5 ä»¥ä¸Šçš„ç‰ˆæœ¬çš„ volatile æ‰ä¼šçœŸæ­£æœ‰æ•ˆ\r\n>\r\n> synchronizedåŒæ­¥çš„ä»£ç å—ï¼Œå…·æœ‰æ’ä»–æ€§ï¼Œä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰ï¼Œæ‰€ä»¥synchronizedä¿è¯åŒä¸€æ—¶åˆ»ï¼Œä»£ç æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ã€‚\r\n>\r\n> å› ä¸ºas-if-serialè¯­ä¹‰çš„å­˜åœ¨ï¼Œå•çº¿ç¨‹çš„ç¨‹åºèƒ½ä¿è¯æœ€ç»ˆç»“æœæ˜¯æœ‰åºçš„ï¼Œä½†æ˜¯ä¸ä¿è¯ä¸ä¼šæŒ‡ä»¤é‡æ’ã€‚\r\n>\r\n> æ‰€ä»¥synchronizedä¿è¯çš„æœ‰åºæ˜¯æ‰§è¡Œç»“æœçš„æœ‰åºæ€§ï¼Œè€Œä¸æ˜¯é˜²æ­¢æŒ‡ä»¤é‡æ’çš„æœ‰åºæ€§ã€‚synchronizedç¡®å®å¯ä»¥ä¿è¯å…±äº«å˜é‡çš„åŸå­ã€å¯è§ã€æœ‰åºæ€§ï¼Œå‰ææ˜¯å…±äº«å˜é‡å®Œå…¨äº¤ç”±synchronizedæ¥ç®¡ç†ï¼Œä¸èƒ½ç•™ä¸€éƒ¨åˆ†å‡ºå»ï¼Œä¸ç„¶å°±è„±ç¦»äº†synchronizedçš„ç®¡ç†äº†\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### è§£å†³æ–¹æ³•\r\n\r\næŒ‡ä»¤é‡æ’åªä¼šä¿è¯ä¸²è¡Œè¯­ä¹‰çš„æ‰§è¡Œä¸€è‡´æ€§ï¼ˆå•çº¿ç¨‹ï¼‰ï¼Œä½†å¹¶ä¸ä¼šä¿è¯å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¸€è‡´æ€§\r\n\r\nå¼•å…¥ volatileï¼Œæ¥ä¿è¯å‡ºç°æŒ‡ä»¤é‡æ’çš„é—®é¢˜ï¼Œä»è€Œä¿è¯å•ä¾‹æ¨¡å¼çš„çº¿ç¨‹å®‰å…¨æ€§ï¼š\r\n\r\n```java\r\nprivate static volatile SingletonDemo INSTANCE = null;\r\n```\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230713215851770.png\" alt=\"image-20230713215851770\" class=\"scale-67\" />\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ha-be\r\n\r\nhappens-before å…ˆè¡Œå‘ç”Ÿ\r\n\r\nJava å†…å­˜æ¨¡å‹å…·å¤‡ä¸€äº›å…ˆå¤©çš„â€œæœ‰åºæ€§â€ï¼Œå³ä¸éœ€è¦é€šè¿‡ä»»ä½•åŒæ­¥æ‰‹æ®µï¼ˆvolatileã€synchronized ç­‰ï¼‰å°±èƒ½å¤Ÿå¾—åˆ°å®‰å…¨çš„ä¿è¯ï¼Œè¿™ä¸ªé€šå¸¸ä¹Ÿç§°ä¸º happens-before åŸåˆ™ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“ï¼ŒJMM å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹çš„å¯è§æ€§å’Œæœ‰åºæ€§ï¼Œä¸ç¬¦åˆ happens-before è§„åˆ™\r\n\r\nhappens-before è§„åˆ™ï¼š\r\n\r\n1. ç¨‹åºæ¬¡åºè§„åˆ™ (Program Order Rule)ï¼šä¸€ä¸ªçº¿ç¨‹å†…ï¼Œé€»è¾‘ä¸Šä¹¦å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºä¹¦å†™åœ¨åé¢çš„æ“ä½œ ï¼Œå› ä¸ºå¤šä¸ªæ“ä½œä¹‹é—´æœ‰å…ˆåä¾èµ–å…³ç³»ï¼Œåˆ™ä¸å…è®¸å¯¹è¿™äº›æ“ä½œè¿›è¡Œé‡æ’åº\r\n\r\n2. é”å®šè§„åˆ™ (Monitor Lock Rule)ï¼šä¸€ä¸ª unlock æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢ï¼ˆæ—¶é—´çš„å…ˆåï¼‰å¯¹åŒä¸€ä¸ªé”çš„ lock æ“ä½œï¼Œæ‰€ä»¥çº¿ç¨‹è§£é” ä¹‹å‰å¯¹å˜é‡  m çš„å†™ï¼ˆè§£é”å‰ä¼šåˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼‰ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§\r\n\r\n3. **volatile å˜é‡è§„åˆ™**  (Volatile Variable Rule)ï¼šå¯¹ volatile å˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»\r\n\r\n4. ä¼ é€’è§„åˆ™ (Transitivity)ï¼šå…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œè€Œæ“ä½œ B åˆå…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œåˆ™å¯ä»¥å¾—å‡ºæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ C\r\n\r\n5. çº¿ç¨‹å¯åŠ¨è§„åˆ™ (Thread Start Rule)ï¼šThread å¯¹è±¡çš„ start()æ–¹ æ³•å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ“ä½œ\r\n\r\n   ```java\r\n   static int x = 10;//çº¿ç¨‹ start å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§\r\n   new Thread(()->{\tSystem.out.println(x);\t},\"t1\").start();\r\n   ```\r\n\r\n6. çº¿ç¨‹ä¸­æ–­è§„åˆ™ (Thread Interruption Rule)ï¼šå¯¹çº¿ç¨‹ interrupt() æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿ\r\n\r\n7. çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ (Thread Termination Rule)ï¼šçº¿ç¨‹ä¸­æ‰€æœ‰çš„æ“ä½œéƒ½å…ˆè¡Œå‘ç”Ÿäºçº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ï¼Œå¯ä»¥é€šè¿‡ Thread.join() æ–¹æ³•ç»“æŸã€Thread.isAlive() çš„è¿”å›å€¼æ‰‹æ®µæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œ\r\n\r\n8. å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼ˆFinaizer Ruleï¼‰ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼ˆæ„é€ å‡½æ•°æ‰§è¡Œç»“æŸï¼‰å…ˆè¡Œå‘ç”Ÿäºå®ƒçš„ finalize() æ–¹æ³•çš„å¼€å§‹\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### è®¾è®¡æ¨¡å¼\r\n\r\n#### ç»ˆæ­¢æ¨¡å¼\r\n\r\nç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ï¼šåœæ­¢æ ‡è®°ç”¨ volatile æ˜¯ä¸ºäº†ä¿è¯è¯¥å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§\r\n\r\n```java\r\nclass TwoPhaseTermination {\r\n    // ç›‘æ§çº¿ç¨‹\r\n    private Thread monitor;\r\n    // åœæ­¢æ ‡è®°\r\n    private volatile boolean stop = false;;\r\n\r\n    // å¯åŠ¨ç›‘æ§çº¿ç¨‹\r\n    public void start() {\r\n        monitor = new Thread(() -> {\r\n            while (true) {\r\n                Thread thread = Thread.currentThread();\r\n                if (stop) {\r\n                    System.out.println(\"åç½®å¤„ç†\");\r\n                    break;\r\n                }\r\n                try {\r\n                    Thread.sleep(1000);// ç¡çœ \r\n                    System.out.println(thread.getName() + \"æ‰§è¡Œç›‘æ§è®°å½•\");\r\n                } catch (InterruptedException e) {\r\n                   \tSystem.out.println(\"è¢«æ‰“æ–­ï¼Œé€€å‡ºç¡çœ \");\r\n                }\r\n            }\r\n        });\r\n        monitor.start();\r\n    }\r\n\r\n    // åœæ­¢ç›‘æ§çº¿ç¨‹\r\n    public void stop() {\r\n        stop = true;\r\n        monitor.interrupt();// è®©çº¿ç¨‹å°½å¿«é€€å‡ºTimed Waiting\r\n    }\r\n}\r\n// æµ‹è¯•\r\npublic static void main(String[] args) throws InterruptedException {\r\n    TwoPhaseTermination tpt = new TwoPhaseTermination();\r\n    tpt.start();\r\n    Thread.sleep(3500);\r\n    System.out.println(\"åœæ­¢ç›‘æ§\");\r\n    tpt.stop();\r\n}\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### Balking\r\n\r\nBalking ï¼ˆçŠ¹è±«ï¼‰æ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹æˆ–æœ¬çº¿ç¨‹å·²ç»åšäº†æŸä¸€ä»¶ç›¸åŒçš„äº‹ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹å°±æ— éœ€å†åšäº†ï¼Œç›´æ¥ç»“æŸè¿”å›\r\n\r\n```java\r\npublic class MonitorService {\r\n    // ç”¨æ¥è¡¨ç¤ºæ˜¯å¦å·²ç»æœ‰çº¿ç¨‹å·²ç»åœ¨æ‰§è¡Œå¯åŠ¨äº†\r\n    private volatile boolean starting = false;\r\n    public void start() {\r\n        System.out.println(\"å°è¯•å¯åŠ¨ç›‘æ§çº¿ç¨‹...\");\r\n        synchronized (this) {\r\n            if (starting) {\r\n            \treturn;\r\n            }\r\n            starting = true;\r\n        }\r\n        // çœŸæ­£å¯åŠ¨ç›‘æ§çº¿ç¨‹...\r\n    }\r\n}\r\n```\r\n\r\nå¯¹æ¯”ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ï¼šä¿æŠ¤æ€§æš‚åœæ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶çº¿ç¨‹ç­‰å¾…\r\n\r\nä¾‹å­ï¼šå¸Œæœ› doInit() æ–¹æ³•ä»…è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹é¢çš„å®ç°å‡ºç°çš„é—®é¢˜ï¼š\r\n\r\n* å½“ t1 çº¿ç¨‹è¿›å…¥ init() å‡†å¤‡ doInit()ï¼Œt2 çº¿ç¨‹è¿›æ¥ï¼Œinitialized è¿˜ä¸ºf alseï¼Œåˆ™ t2 å°±åˆåˆå§‹åŒ–ä¸€æ¬¡\r\n* volatile é€‚åˆä¸€ä¸ªçº¿ç¨‹å†™ï¼Œå…¶ä»–çº¿ç¨‹è¯»çš„æƒ…å†µï¼Œè¿™ä¸ªä»£ç éœ€è¦åŠ é”\r\n\r\n```java\r\npublic class TestVolatile {\r\n    volatile boolean initialized = false;\r\n    \r\n    void init() {\r\n        if (initialized) {\r\n            return;\r\n        }\r\n    \tdoInit();\r\n    \tinitialized = true;\r\n    }\r\n    private void doInit() {\r\n    }\r\n}\r\n```\r\n\r\n> volatileä¸èƒ½ä¿è¯ä»£ç çš„åŸå­æ€§ï¼Œsynchronizedå°±å¯ä»¥\r\n\r\n\r\n\r\n"},{"title":"å¹¶å‘ç¼–ç¨‹æ•´ç†ç‰ˆ-åŒæ­¥å™¨","tags":["AQS","ReentrantLock","ReentrantReadWriteLock","CountDownLatch","CyclicBarrier","Semaphore","Exchanger"],"categories":["Java","å¹¶å‘ç¼–ç¨‹"],"author":"imklaus","excerpt":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n","link":"/posts/Concurrent_Programming-Synchronizer","content":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n<!-- more -->\r\n\r\n\r\n## åŒæ­¥å™¨\r\n\r\n### AQS\r\n\r\n#### æ ¸å¿ƒæ€æƒ³\r\n\r\nAQSï¼šAbstractQueuedSynchronizerï¼Œä¸­æ–‡æ„æ€æ˜¯æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œæ˜¯é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·çš„æ¡†æ¶ï¼Œç”± Doug Lea è®¾è®¡ï¼Œæ˜¯ Java å¹¶å‘åŒ…`java.util.concurrent`çš„æ ¸å¿ƒæ¡†æ¶ç±»ï¼Œè®¸å¤šåŒæ­¥ç±»çš„å®ç°éƒ½ä¾èµ–äºå®ƒï¼Œå¦‚ ReentrantLockã€Semaphoreã€CountDownLatch ç­‰ã€‚\r\n\r\nAQS ç”¨çŠ¶æ€å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†**ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼**ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å–é”å’Œé‡Šæ”¾é”\r\n\r\n* ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œå¦‚ ReentrantLock\r\n* å…±äº«æ¨¡å¼å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æºï¼Œå¦‚ Semaphoreï¼ŒReentrantReadWriteLock æ˜¯ç»„åˆå¼\r\n\r\nAQS æ ¸å¿ƒæ€æƒ³ï¼š\r\n\r\n* å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶å°†å…±äº«èµ„æºè®¾ç½®é”å®šçŠ¶æ€\r\n\r\n* è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼ŒAQS ç”¨é˜Ÿåˆ—å®ç°çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­\r\n\r\n  æ•´ä¸ªè¿‡ç¨‹é€šè¿‡ç»´æŠ¤ä¸€ä¸ª int ç±»å‹çš„çŠ¶æ€å’Œä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é˜Ÿåˆ—ï¼Œæ¥å®ç°å¯¹å…±äº«èµ„æºçš„ç®¡ç†ã€‚\r\n\r\n  ![image-20240612172349107](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240612172349107.png)\r\n\r\nCLH æ˜¯ä¸€ç§åŸºäºå•å‘é“¾è¡¨çš„**é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”**ï¼ŒAQS æ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…\r\n\r\n- å¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œéœ€è¦ä¸€ç§ç‰¹å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”çš„åˆ†é…ï¼ŒAQS ä¼šå°†ç«äº‰å…±äº«èµ„æºå¤±è´¥çš„çº¿ç¨‹æ·»åŠ åˆ°ä¸€ä¸ª CLH é˜Ÿåˆ—ä¸­ã€‚\r\n\r\n![image-20240612174239085](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240612174239085.png)\r\n\r\n- åœ¨ CLH é”ä¸­ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å–é”å¹¶å¤±è´¥æ—¶ï¼Œå®ƒä¼šå°†è‡ªå·±æ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨å¹¶è‡ªæ—‹ï¼Œç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾é”ã€‚\r\n\r\n![image-20240612174302996](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240612174302996.png)\r\n\r\n***\r\n\r\n\r\n\r\n#### è®¾è®¡åŸç†\r\n\r\nè®¾è®¡åŸç†ï¼š\r\n\r\n* è·å–é”ï¼š\r\n\r\n  ```java\r\n  while(state çŠ¶æ€ä¸å…è®¸è·å–) {\t// tryAcquire(arg)\r\n      if(é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰æ­¤çº¿ç¨‹) {\r\n          å…¥é˜Ÿå¹¶é˜»å¡ park\r\n      }\r\n  }\r\n  å½“å‰çº¿ç¨‹å‡ºé˜Ÿ\r\n  ```\r\n\r\n* é‡Šæ”¾é”ï¼š\r\n\r\n  ```java\r\n  if(state çŠ¶æ€å…è®¸äº†) {\t// tryRelease(arg)\r\n  \tæ¢å¤é˜»å¡çš„çº¿ç¨‹(s) unpark\r\n  }\r\n  ```\r\n\r\nAbstractQueuedSynchronizer ä¸­ state è®¾è®¡ï¼š\r\n\r\n* state ä½¿ç”¨äº† 32bit int æ¥ç»´æŠ¤åŒæ­¥çŠ¶æ€ï¼Œç‹¬å æ¨¡å¼ 0 è¡¨ç¤ºæœªåŠ é”çŠ¶æ€ï¼Œå¤§äº 0 è¡¨ç¤ºå·²ç»åŠ é”çŠ¶æ€\r\n\r\n  ```java\r\n  private volatile int state;\r\n  ```\r\n\r\n* state **ä½¿ç”¨ volatile ä¿®é¥°é…åˆ CAS** ä¿è¯å…¶ä¿®æ”¹æ—¶çš„**å¯è§æ€§**\r\n\r\n* state è¡¨ç¤º**çº¿ç¨‹é‡å…¥çš„æ¬¡æ•°ï¼ˆç‹¬å æ¨¡å¼ï¼‰æˆ–è€…å‰©ä½™è®¸å¯æ•°ï¼ˆå…±äº«æ¨¡å¼ï¼‰**\r\n\r\n* state APIï¼š\r\n\r\n  * `protected final int getState()`ï¼šè·å– state çŠ¶æ€\r\n  * `protected final void setState(int newState)`ï¼šè®¾ç½® state çŠ¶æ€\r\n  * `protected final boolean compareAndSetState(int expect,int update)`ï¼š**CAS** å®‰å…¨è®¾ç½® state\r\n\r\nå°è£…çº¿ç¨‹çš„ Node èŠ‚ç‚¹ä¸­ waitstate è®¾è®¡ï¼š\r\n\r\n* ä½¿ç”¨ **volatile ä¿®é¥°é…åˆ CAS** ä¿è¯å…¶ä¿®æ”¹æ—¶çš„**å¯è§æ€§**\r\n\r\n* è¡¨ç¤º Node èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œæœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š\r\n\r\n  ```java\r\n  // é»˜è®¤ä¸º 0\r\n  volatile int waitStatus;\r\n  // ç”±äºè¶…æ—¶æˆ–ä¸­æ–­ï¼Œæ­¤èŠ‚ç‚¹è¢«å–æ¶ˆï¼Œä¸ä¼šå†æ”¹å˜çŠ¶æ€\r\n  static final int CANCELLED =  1;\r\n  // æ­¤èŠ‚ç‚¹åé¢çš„èŠ‚ç‚¹å·²ï¼ˆæˆ–å³å°†ï¼‰è¢«é˜»æ­¢ï¼ˆé€šè¿‡parkï¼‰ï¼Œã€å½“å‰èŠ‚ç‚¹åœ¨é‡Šæ”¾æˆ–å–æ¶ˆæ—¶å¿…é¡»å”¤é†’åé¢çš„èŠ‚ç‚¹ã€‘\r\n  static final int SIGNAL    = -1;\r\n  // æ­¤èŠ‚ç‚¹å½“å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­\r\n  static final int CONDITION = -2;\r\n  // å°†releaseSharedä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹\r\n  static final int PROPAGATE = -3;\r\n  ```\r\n\r\né˜»å¡æ¢å¤è®¾è®¡ï¼š\r\n\r\n* ä½¿ç”¨ `park & unpark` æ¥å®ç°çº¿ç¨‹çš„æš‚åœå’Œæ¢å¤ï¼Œå› ä¸ºå‘½ä»¤çš„å…ˆåé¡ºåºä¸å½±å“ç»“æœ\r\n* `park & unpark` æ˜¯é’ˆå¯¹çº¿ç¨‹çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹åŒæ­¥å™¨çš„ï¼Œå› æ­¤æ§åˆ¶ç²’åº¦æ›´ä¸ºç²¾ç»†\r\n* park çº¿ç¨‹å¯ä»¥é€šè¿‡ interrupt æ‰“æ–­\r\n\r\né˜Ÿåˆ—è®¾è®¡ï¼š\r\n\r\n* ä½¿ç”¨äº† `FIFO` å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ï¼Œå¹¶ä¸æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œ**åŒæ­¥é˜Ÿåˆ—æ˜¯åŒå‘é“¾è¡¨ï¼Œä¾¿äºå‡ºé˜Ÿå…¥é˜Ÿ**\r\n\r\n  ```java\r\n  // å¤´ç»“ç‚¹ï¼ŒæŒ‡å‘å“‘å…ƒèŠ‚ç‚¹\r\n  private transient volatile Node head;\r\n  // é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼Œé˜»å¡é˜Ÿåˆ—ä¸åŒ…å«å¤´ç»“ç‚¹ï¼Œä» head.next â†’ tail è®¤ä¸ºæ˜¯é˜»å¡é˜Ÿåˆ—\r\n  private transient volatile Node tail;\r\n  \r\n  static final class Node {\r\n      // æšä¸¾ï¼šå…±äº«æ¨¡å¼\r\n      static final Node SHARED = new Node();\r\n      // æšä¸¾ï¼šç‹¬å æ¨¡å¼\r\n      static final Node EXCLUSIVE = null;\r\n      // node éœ€è¦æ„å»ºæˆ FIFO é˜Ÿåˆ—ï¼Œprev æŒ‡å‘å‰ç»§èŠ‚ç‚¹\r\n      volatile Node prev;\r\n      // next æŒ‡å‘åç»§èŠ‚ç‚¹\r\n      volatile Node next;\r\n      // å½“å‰ node å°è£…çš„çº¿ç¨‹\r\n      volatile Thread thread;\r\n      // æ¡ä»¶é˜Ÿåˆ—æ˜¯å•å‘é“¾è¡¨ï¼Œåªæœ‰åç»§æŒ‡é’ˆï¼Œæ¡ä»¶é˜Ÿåˆ—ä½¿ç”¨è¯¥å±æ€§\r\n      Node nextWaiter;\r\n      ...\r\n  }\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824173120652.png\" alt=\"image-20230824173120652\" class=\"scale-80\" />\r\n\r\n* æ¡ä»¶å˜é‡æ¥å®ç°ç­‰å¾…ã€å”¤é†’æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œç±»ä¼¼äº Monitor çš„ WaitSetï¼Œ**æ¡ä»¶é˜Ÿåˆ—æ˜¯å•å‘é“¾è¡¨**\r\n\r\n  ````java\r\n   public class ConditionObject implements Condition, java.io.Serializable {\r\n       // æŒ‡å‘æ¡ä»¶é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª node èŠ‚ç‚¹\r\n       private transient Node firstWaiter;\r\n       // æŒ‡å‘æ¡ä»¶é˜Ÿåˆ—çš„æœ€åä¸€ä¸ª node èŠ‚ç‚¹\r\n       private transient Node lastWaiter;\r\n       ...\r\n   }\r\n  ````\r\n  \r\n  \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æ¨¡æ¿å¯¹è±¡\r\n\r\nåŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè¯¥æ¨¡å¼æ˜¯åŸºäºç»§æ‰¿çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†åœ¨ä¸æ”¹å˜æ¨¡æ¿ç»“æ„çš„å‰æä¸‹åœ¨å­ç±»ä¸­é‡æ–°å®šä¹‰æ¨¡æ¿ä¸­çš„å†…å®¹ä»¥å®ç°å¤ç”¨ä»£ç \r\n\r\n* ä½¿ç”¨è€…ç»§æ‰¿ `AbstractQueuedSynchronizer` å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•\r\n* å°† AQS ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨å…¶æ¨¡æ¿æ–¹æ³•ï¼Œè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•\r\n\r\nAQS ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨æ—¶éœ€è¦é‡å†™ä¸‹é¢å‡ ä¸ª AQS æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼š\r\n\r\n```java\r\nisHeldExclusively()\t\t//è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒ\r\ntryAcquire(int)\t\t\t//ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false\r\ntryRelease(int)\t\t\t//ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false\r\ntryAcquireShared(int)\t//å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸä¸”æœ‰å‰©ä½™èµ„æº\r\ntryReleaseShared(int)\t//å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false\r\n```\r\n\r\n* é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æŠ›å‡º `UnsupportedOperationException`\r\n* è¿™äº›æ–¹æ³•çš„å®ç°å¿…é¡»æ˜¯å†…éƒ¨çº¿ç¨‹å®‰å…¨çš„\r\n* AQS ç±»ä¸­çš„å…¶ä»–æ–¹æ³•éƒ½æ˜¯ final ï¼Œæ‰€ä»¥æ— æ³•è¢«å…¶ä»–ç±»ä½¿ç”¨ï¼Œåªæœ‰è¿™å‡ ä¸ªæ–¹æ³•å¯ä»¥è¢«å…¶ä»–ç±»ä½¿ç”¨\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### è‡ªå®šä¹‰\r\n\r\nè‡ªå®šä¹‰ä¸€ä¸ªä¸å¯é‡å…¥é”ï¼š\r\n\r\n```java\r\nclass MyLock implements Lock {\r\n    //ç‹¬å é” ä¸å¯é‡å…¥\r\n    class MySync extends AbstractQueuedSynchronizer {\r\n        @Override\r\n        protected boolean tryAcquire(int arg) {\r\n            if (compareAndSetState(0, 1)) {\r\n                // åŠ ä¸Šé” è®¾ç½® owner ä¸ºå½“å‰çº¿ç¨‹\r\n                setExclusiveOwnerThread(Thread.currentThread());\r\n                return true;\r\n            }\r\n            return false;\r\n        }\r\n        @Override   //è§£é”\r\n        protected boolean tryRelease(int arg) {\r\n            setExclusiveOwnerThread(null);\r\n            setState(0);//volatile ä¿®é¥°çš„å˜é‡æ”¾åœ¨åé¢ï¼Œé˜²æ­¢æŒ‡ä»¤é‡æ’\r\n            return true;\r\n        }\r\n        @Override   //æ˜¯å¦æŒæœ‰ç‹¬å é”\r\n        protected boolean isHeldExclusively() {\r\n            return getState() == 1;\r\n        }\r\n        public Condition newCondition() {\r\n            return new ConditionObject();\r\n        }\r\n    }\r\n\r\n    private MySync sync = new MySync();\r\n\r\n    @Override   //åŠ é”ï¼ˆä¸æˆåŠŸè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ç­‰å¾…ï¼‰\r\n    public void lock() {\r\n        sync.acquire(1);\r\n    }\r\n\r\n    @Override   //åŠ é” å¯æ‰“æ–­\r\n    public void lockInterruptibly() throws InterruptedException {\r\n        sync.acquireInterruptibly(1);\r\n    }\r\n\r\n    @Override   //å°è¯•åŠ é”ï¼Œå°è¯•ä¸€æ¬¡\r\n    public boolean tryLock() {\r\n        return sync.tryAcquire(1);\r\n    }\r\n\r\n    @Override   //å°è¯•åŠ é”ï¼Œå¸¦è¶…æ—¶\r\n    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {\r\n        return sync.tryAcquireNanos(1, unit.toNanos(time));\r\n    }\r\n    \r\n    @Override   //è§£é”\r\n    public void unlock() {\r\n        sync.release(1);\r\n    }\r\n    \r\n    @Override   //æ¡ä»¶å˜é‡\r\n    public Condition newCondition() {\r\n        return sync.newCondition();\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### Re-Lock\r\n\r\n#### é”å¯¹æ¯”\r\n\r\nReentrantLock ç›¸å¯¹äº synchronized å…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š\r\n\r\n1. é”çš„å®ç°ï¼šsynchronized æ˜¯ JVM å®ç°çš„ï¼Œè€Œ ReentrantLock æ˜¯ JDK å®ç°çš„\r\n2. æ€§èƒ½ï¼šæ–°ç‰ˆæœ¬ Java å¯¹ synchronized è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œsynchronized ä¸ ReentrantLock å¤§è‡´ç›¸åŒ\r\n3. ä½¿ç”¨ï¼šReentrantLock éœ€è¦æ‰‹åŠ¨è§£é”ï¼Œsynchronized æ‰§è¡Œå®Œä»£ç å—è‡ªåŠ¨è§£é”\r\n4. **å¯ä¸­æ–­**ï¼šReentrantLock å¯ä¸­æ–­ï¼Œè€Œ synchronized ä¸è¡Œ\r\n5. **å…¬å¹³é”**ï¼šå…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œå¿…é¡»æŒ‰ç…§ç”³è¯·é”çš„æ—¶é—´é¡ºåºæ¥ä¾æ¬¡è·å¾—é”\r\n   * ReentrantLock å¯ä»¥è®¾ç½®å…¬å¹³é”ï¼Œsynchronized ä¸­çš„é”æ˜¯éå…¬å¹³çš„\r\n   * ä¸å…¬å¹³é”çš„å«ä¹‰æ˜¯é˜»å¡é˜Ÿåˆ—å†…å…¬å¹³ï¼Œé˜Ÿåˆ—å¤–éå…¬å¹³\r\n6. é”è¶…æ—¶ï¼šå°è¯•è·å–é”ï¼Œè¶…æ—¶è·å–ä¸åˆ°ç›´æ¥æ”¾å¼ƒï¼Œä¸è¿›å…¥é˜»å¡é˜Ÿåˆ—\r\n   * ReentrantLock å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œsynchronized ä¼šä¸€ç›´ç­‰å¾…\r\n7. é”ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼šä¸€ä¸ª ReentrantLock å¯ä»¥åŒæ—¶ç»‘å®šå¤šä¸ª Condition å¯¹è±¡ï¼Œæ›´ç»†ç²’åº¦çš„å”¤é†’çº¿ç¨‹\r\n8. ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä½¿ç”¨é”\r\n\r\næ„é€ æ–¹æ³•ï¼š`ReentrantLock lock = new ReentrantLock()`\r\n\r\nReentrantLock ç±» APIï¼š\r\n\r\n* `public void lock()`ï¼šè·å¾—é”\r\n  * å¦‚æœé”æ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹å ç”¨ï¼Œåˆ™å°†é”å®šè®¡æ•°è®¾ç½®ä¸º 1\r\n\r\n  * å¦‚æœå½“å‰çº¿ç¨‹å·²ç»ä¿æŒé”å®šï¼Œåˆ™ä¿æŒè®¡æ•°å¢åŠ  1 \r\n\r\n  * å¦‚æœé”è¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¿æŒï¼Œåˆ™å½“å‰çº¿ç¨‹è¢«ç¦ç”¨çº¿ç¨‹è°ƒåº¦ï¼Œå¹¶ä¸”åœ¨é”å·²è¢«é‡Šæ”¾ä¹‹å‰å¤„äºä¼‘çœ çŠ¶æ€\r\n\r\n* `public void unlock()`ï¼šå°è¯•é‡Šæ”¾é”\r\n  * å¦‚æœå½“å‰çº¿ç¨‹æ˜¯è¯¥é”çš„æŒæœ‰è€…ï¼Œåˆ™ä¿æŒè®¡æ•°é€’å‡\r\n  * å¦‚æœä¿æŒè®¡æ•°ç°åœ¨ä¸ºé›¶ï¼Œåˆ™é”å®šè¢«é‡Šæ”¾\r\n  * å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è¯¥é”çš„æŒæœ‰è€…ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸\r\n\r\nåŸºæœ¬è¯­æ³•ï¼š\r\n\r\n```java\r\n// è·å–é”\r\nreentrantLock.lock();\r\ntry {\r\n    // ä¸´ç•ŒåŒº\r\n} finally {\r\n\t// é‡Šæ”¾é”\r\n\treentrantLock.unlock();\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å…¬å¹³é”\r\n\r\n##### åŸºæœ¬ä½¿ç”¨\r\n\r\næ„é€ æ–¹æ³•ï¼š`ReentrantLock lock = new ReentrantLock(true)`\r\n\r\n```java\r\npublic ReentrantLock(boolean fair) {\r\n    sync = fair ? new FairSync() : new NonfairSync();\r\n}\r\n```\r\n\r\nReentrantLock é»˜è®¤æ˜¯ä¸å…¬å¹³çš„ï¼š\r\n\r\n```java\r\npublic ReentrantLock() {\r\n    sync = new NonfairSync();\r\n}\r\n```\r\n\r\nè¯´æ˜ï¼šå…¬å¹³é”ä¸€èˆ¬æ²¡æœ‰å¿…è¦ï¼Œä¼šé™ä½å¹¶å‘åº¦\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### éå…¬åŸç†\r\n\r\n###### åŠ é”\r\n\r\nNonfairSync ç»§æ‰¿è‡ª AQS\r\n\r\n```java\r\npublic void lock() {\r\n    sync.lock();\r\n}\r\n```\r\n\r\n\r\n\r\n* æ²¡æœ‰ç«äº‰ï¼šExclusiveOwnerThread å±äº Thread-0ï¼Œstate è®¾ç½®ä¸º 1\r\n\r\n  ```java\r\n  // ReentrantLock.NonfairSync#lock\r\n  final void lock() {\r\n      // ç”¨ cas å°è¯•ï¼ˆä»…å°è¯•ä¸€æ¬¡ï¼‰å°† state ä» 0 æ”¹ä¸º 1, å¦‚æœæˆåŠŸè¡¨ç¤ºã€è·å¾—äº†ç‹¬å é”ã€‘\r\n      if (compareAndSetState(0, 1))\r\n          // è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å çº¿ç¨‹\r\n          setExclusiveOwnerThread(Thread.currentThread());\r\n      else\r\n          acquire(1);//å¤±è´¥è¿›å…¥\r\n  }\r\n  ```\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719155415862.png\" alt=\"image-20230719155415862\" class=\"scale-67\" />\r\n\r\n* ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°ï¼šThread-1 æ‰§è¡Œï¼ŒCAS å°è¯•å°† state ç”± 0 æ”¹ä¸º 1ï¼Œç»“æœå¤±è´¥ï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œè¿›å…¥ acquire é€»è¾‘\r\n\r\n  ```java\r\n  // AbstractQueuedSynchronizer#acquire\r\n  public final void acquire(int arg) {\r\n      // tryAcquire å°è¯•è·å–é”å¤±è´¥æ—¶, ä¼šè°ƒç”¨ addWaiter å°†å½“å‰çº¿ç¨‹å°è£…æˆnodeå…¥é˜Ÿï¼ŒacquireQueued é˜»å¡å½“å‰çº¿ç¨‹ï¼Œ\r\n      // acquireQueued è¿”å› true è¡¨ç¤ºæŒ‚èµ·è¿‡ç¨‹ä¸­çº¿ç¨‹è¢«ä¸­æ–­å”¤é†’è¿‡ï¼Œfalse è¡¨ç¤ºæœªè¢«ä¸­æ–­è¿‡\r\n      if (!tryAcquire(arg) && acquireQueued(addWaiter(Node.EXCLUSIVE), arg))\r\n          // å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­äº†é€»è¾‘æ¥åˆ°è¿™ï¼Œå®Œæˆä¸€æ¬¡çœŸæ­£çš„æ‰“æ–­æ•ˆæœ\r\n          selfInterrupt();\r\n  }\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719155428092.png\" alt=\"image-20230719155428092\" class=\"scale-67\" />\r\n\r\n* è¿›å…¥ tryAcquire å°è¯•è·å–é”é€»è¾‘ï¼Œè¿™æ—¶ state å·²ç»æ˜¯1ï¼Œç»“æœä»ç„¶å¤±è´¥ï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼ŒåŠ é”æˆåŠŸæœ‰ä¸¤ç§æƒ…å†µï¼š\r\n\r\n  * å½“å‰ AQS å¤„äºæ— é”çŠ¶æ€\r\n  * åŠ é”çº¿ç¨‹å°±æ˜¯å½“å‰çº¿ç¨‹ï¼Œè¯´æ˜å‘ç”Ÿäº†é”é‡å…¥\r\n\r\n  ```java\r\n  // ReentrantLock.NonfairSync#tryAcquire\r\n  protected final boolean tryAcquire(int acquires) {\r\n      return nonfairTryAcquire(acquires);\r\n  }\r\n  // æŠ¢å æˆåŠŸè¿”å› trueï¼ŒæŠ¢å å¤±è´¥è¿”å› false\r\n  final boolean nonfairTryAcquire(int acquires) {\r\n      final Thread current = Thread.currentThread();\r\n      // state å€¼\r\n      int c = getState();\r\n      // æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰å¤„äºã€æ— é”çŠ¶æ€ã€‘\r\n      if (c == 0) {\r\n          //å¦‚æœè¿˜æ²¡æœ‰è·å¾—é”ï¼Œå°è¯•ç”¨casè·å¾—ï¼Œè¿™é‡Œä½“ç°éå…¬å¹³æ€§: ä¸å»æ£€æŸ¥ AQS é˜Ÿåˆ—æ˜¯å¦æœ‰é˜»å¡çº¿ç¨‹ç›´æ¥è·å–é”        \r\n      \tif (compareAndSetState(0, acquires)) {\r\n              // è·å–é”æˆåŠŸè®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å é”çº¿ç¨‹ã€‚\r\n              setExclusiveOwnerThread(current);\r\n              return true;\r\n           }    \r\n  \t}    \r\n     \t// å¦‚æœå·²ç»æœ‰çº¿ç¨‹è·å¾—äº†é”, ç‹¬å é”çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºã€å‘ç”Ÿäº†é”é‡å…¥ã€‘\r\n  \telse if (current == getExclusiveOwnerThread()) {\r\n          // æ›´æ–°é”é‡å…¥çš„å€¼\r\n          int nextc = c + acquires;\r\n          // è¶Šç•Œåˆ¤æ–­ï¼Œå½“é‡å…¥çš„æ·±åº¦å¾ˆæ·±æ—¶ï¼Œä¼šå¯¼è‡´ nextc < 0ï¼Œintå€¼è¾¾åˆ°æœ€å¤§ä¹‹åå† + 1 å˜è´Ÿæ•°\r\n          if (nextc < 0) // overflow\r\n              throw new Error(\"Maximum lock count exceeded\");\r\n          // æ›´æ–° state çš„å€¼ï¼Œè¿™é‡Œä¸ä½¿ç”¨ cas æ˜¯å› ä¸ºå½“å‰çº¿ç¨‹æ­£åœ¨æŒæœ‰é”ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ“ä½œç›¸å½“äºåœ¨ä¸€ä¸ªç®¡ç¨‹å†…\r\n          setState(nextc);\r\n          return true;\r\n      }\r\n      // è·å–å¤±è´¥\r\n      return false;\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n* æ¥ä¸‹æ¥è¿›å…¥ addWaiter é€»è¾‘ï¼Œæ„é€  Node é˜Ÿåˆ—ï¼ˆä¸æ˜¯é˜»å¡é˜Ÿåˆ—ï¼‰ï¼Œå‰ç½®æ¡ä»¶æ˜¯å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¯´æ˜æœ‰çº¿ç¨‹å ç”¨äº†é”\r\n\r\n  * å›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºè¯¥ Node çš„ waitStatus çŠ¶æ€ï¼Œå…¶ä¸­ 0 ä¸ºé»˜è®¤**æ­£å¸¸çŠ¶æ€**\r\n  * Node çš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ª Node ç§°ä¸º **Dummyï¼ˆå“‘å…ƒï¼‰æˆ–å“¨å…µ**ï¼Œç”¨æ¥å ä½ï¼Œå¹¶ä¸å…³è”çº¿ç¨‹\r\n\r\n  ```java\r\n  // AbstractQueuedSynchronizer#addWaiterï¼Œè¿”å›å½“å‰çº¿ç¨‹çš„ node èŠ‚ç‚¹\r\n  private Node addWaiter(Node mode) {\r\n      // å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼   \r\n      Node node = new Node(Thread.currentThread(), mode);\r\n      Node pred = tail;\r\n      // å¿«é€Ÿå…¥é˜Ÿï¼Œå¦‚æœ tail ä¸ä¸º nullï¼Œè¯´æ˜å­˜åœ¨é˜Ÿåˆ—\r\n      if (pred != null) {\r\n          // å°†å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘ å°¾èŠ‚ç‚¹\r\n          node.prev = pred;\r\n          // é€šè¿‡ cas å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—ï¼Œæˆä¸ºå°¾èŠ‚ç‚¹ï¼Œã€å°¾æ’æ³•ã€‘\r\n          if (compareAndSetTail(pred, node)) {\r\n              pred.next = node;// åŒå‘é“¾è¡¨\r\n              return node;\r\n          }\r\n      }\r\n      // åˆå§‹æ—¶é˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€… CAS å¤±è´¥è¿›å…¥è¿™é‡Œ\r\n      enq(node);\r\n      return node;\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // AbstractQueuedSynchronizer#enq\r\n  private Node enq(final Node node) {\r\n      // è‡ªæ—‹å…¥é˜Ÿï¼Œå¿…é¡»å…¥é˜ŸæˆåŠŸæ‰ç»“æŸå¾ªç¯\r\n      for (;;) {\r\n          Node t = tail;\r\n          // è¯´æ˜å½“å‰é”è¢«å ç”¨ï¼Œä¸”å½“å‰çº¿ç¨‹å¯èƒ½æ˜¯ã€ç¬¬ä¸€ä¸ªè·å–é”å¤±è´¥ã€‘çš„çº¿ç¨‹ï¼Œã€è¿˜æ²¡æœ‰å»ºç«‹é˜Ÿåˆ—ã€‘\r\n          if (t == null) {\r\n              // è®¾ç½®ä¸€ä¸ªã€å“‘å…ƒèŠ‚ç‚¹ã€‘ï¼Œå¤´å°¾æŒ‡é’ˆéƒ½æŒ‡å‘è¯¥èŠ‚ç‚¹\r\n              if (compareAndSetHead(new Node()))\r\n                  tail = head;\r\n          } else {\r\n              // è‡ªæ—‹åˆ°è¿™ï¼Œæ™®é€šå…¥é˜Ÿæ–¹å¼ï¼Œé¦–å…ˆèµ‹å€¼å°¾èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ã€å°¾æ’æ³•ã€‘\r\n              node.prev = t;\r\n              // ã€åœ¨è®¾ç½®å®Œå°¾èŠ‚ç‚¹åï¼Œæ‰æ›´æ–°çš„åŸå§‹å°¾èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ­¤æ—¶ä»å‰å¾€åéå†ä¼šä¸¢å¤±å°¾èŠ‚ç‚¹ã€‘\r\n              if (compareAndSetTail(t, node)) {\r\n                  //ã€æ­¤æ—¶ t.next  = nullï¼Œå¹¶ä¸”è¿™é‡Œå·²ç» CAS ç»“æŸï¼Œçº¿ç¨‹å¹¶ä¸æ˜¯å®‰å…¨çš„ï¼Œè¿™æ˜¯ä»å‰å‘åéå†å”¤é†’ä¼šä¸¢å¤±å°¾èŠ‚ç‚¹çš„åŸå› ï¼ã€‘\r\n                  t.next = node;\r\n                  return t;\t// è¿”å›å½“å‰ node çš„å‰é©±èŠ‚ç‚¹\r\n              }\r\n          }\r\n      }\r\n  }\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719155452096.png\" alt=\"image-20230719155452096\" class=\"scale-70\" />\r\n\r\n* çº¿ç¨‹èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—æˆåŠŸï¼Œè¿›å…¥ `AbstractQueuedSynchronizer#acquireQueued` é€»è¾‘é˜»å¡çº¿ç¨‹\r\n\r\n  1.  acquireQueued ä¼šåœ¨ä¸€ä¸ªè‡ªæ—‹ä¸­ä¸æ–­å°è¯•è·å¾—é”ï¼Œå¤±è´¥åè¿›å…¥ park é˜»å¡\r\n  2. å¦‚æœå½“å‰çº¿ç¨‹æ˜¯åœ¨ head èŠ‚ç‚¹åï¼Œä¼šå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œstate ä»ä¸º 1 åˆ™å¤±è´¥ï¼ˆç¬¬ä¸‰æ¬¡ï¼‰\r\n\r\n  ```java\r\n  final boolean acquireQueued(final Node node, int arg) {\r\n      // true è¡¨ç¤ºå½“å‰çº¿ç¨‹æŠ¢å é”å¤±è´¥ï¼Œfalse è¡¨ç¤ºæˆåŠŸ\r\n      boolean failed = true;\r\n      try {\r\n          // ä¸­æ–­æ ‡è®°ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­\r\n          boolean interrupted = false;\r\n          for (;;) {\r\n              // è·å¾—å½“å‰çº¿ç¨‹èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹\r\n              final Node p = node.predecessor();\r\n              // å‰é©±èŠ‚ç‚¹æ˜¯ head, FIFO é˜Ÿåˆ—çš„ç‰¹æ€§è¡¨ç¤ºè½®åˆ°å½“å‰çº¿ç¨‹å¯ä»¥å»è·å–é”\r\n              if (p == head && tryAcquire(arg)) {\r\n                  // è·å–æˆåŠŸ, è®¾ç½®å½“å‰çº¿ç¨‹è‡ªå·±çš„ node ä¸º head\r\n                  setHead(node);\r\n                  p.next = null; // help GC\r\n                  // è¡¨ç¤ºæŠ¢å é”æˆåŠŸ\r\n                  failed = false;\r\n                  // è¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­\r\n                  return interrupted;\r\n              }\r\n              // åˆ¤æ–­æ˜¯å¦åº”å½“ parkï¼Œè¿”å› false åéœ€è¦æ–°ä¸€è½®çš„å¾ªç¯ï¼Œè¿”å› true è¿›å…¥æ¡ä»¶äºŒé˜»å¡çº¿ç¨‹\r\n              if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())\r\n                  // æ¡ä»¶äºŒè¿”å›ç»“æœæ˜¯å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¢«æ‰“æ–­è¿”å› false ä¸è¿›å…¥è¿™é‡Œçš„é€»è¾‘\r\n                  // ã€å°±ç®—è¢«æ‰“æ–­äº†ï¼Œä¹Ÿä¼šç»§ç»­å¾ªç¯ï¼Œå¹¶ä¸ä¼šè¿”å›ã€‘\r\n                  interrupted = true;\r\n          }\r\n      } finally {\r\n          // ã€å¯æ‰“æ–­æ¨¡å¼ä¸‹æ‰ä¼šè¿›å…¥è¯¥é€»è¾‘ã€‘\r\n          if (failed)\r\n              cancelAcquire(node);\r\n      }\r\n  }\r\n  ```\r\n\r\n  3.  è¿›å…¥ shouldParkAfterFailedAcquire é€»è¾‘ï¼Œ**å°†å‰é©± node çš„ waitStatus æ”¹ä¸º -1**ï¼Œè¿”å› falseï¼›waitStatus ä¸º -1 çš„èŠ‚ç‚¹ç”¨æ¥å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r\n\r\n  ```java\r\n  private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {\r\n      int ws = pred.waitStatus;\r\n      // è¡¨ç¤ºå‰ç½®èŠ‚ç‚¹æ˜¯ä¸ªå¯ä»¥å”¤é†’å½“å‰èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼Œè¿”å› true\r\n      if (ws == Node.SIGNAL)\r\n          return true;\r\n      // å‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€å¤„äºå–æ¶ˆçŠ¶æ€ï¼Œéœ€è¦ã€åˆ é™¤å‰é¢æ‰€æœ‰å–æ¶ˆçš„èŠ‚ç‚¹ã€‘, è¿”å›åˆ°å¤–å±‚å¾ªç¯é‡è¯•\r\n      if (ws > 0) {\r\n          do {\r\n              node.prev = pred = pred.prev;\r\n          } while (pred.waitStatus > 0);\r\n          // è·å–åˆ°éå–æ¶ˆçš„èŠ‚ç‚¹ï¼Œè¿æ¥ä¸Šå½“å‰èŠ‚ç‚¹\r\n          pred.next = node;\r\n      \r\n      } else {\r\n          // é»˜è®¤æƒ…å†µä¸‹ node çš„ waitStatus æ˜¯ 0ï¼Œè¿›å…¥è¿™é‡Œçš„é€»è¾‘\r\n          // ã€è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¸º Node.SIGNALã€‘ï¼Œè¿”å›å¤–å±‚å¾ªç¯é‡è¯•\r\n          compareAndSetWaitStatus(pred, ws, Node.SIGNAL);\r\n      }\r\n      // è¿”å›ä¸åº”è¯¥ parkï¼Œå†æ¬¡å°è¯•ä¸€æ¬¡\r\n      return false;\r\n  }\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719155516878.png\" alt=\"image-20230719155516878\" class=\"scale-70\" />\r\n\r\n  4. shouldParkAfterFailedAcquire æ‰§è¡Œå®Œæ¯•å›åˆ° acquireQueued ï¼Œå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œè¿™æ—¶ state ä»ä¸º 1 è·å–å¤±è´¥ï¼ˆç¬¬å››æ¬¡ï¼‰\r\n  5. å½“å†æ¬¡è¿›å…¥ shouldParkAfterFailedAcquire æ—¶ï¼Œè¿™æ—¶å…¶å‰é©± node çš„ waitStatus å·²ç»æ˜¯ -1 äº†ï¼Œè¿”å› true\r\n  6. è¿›å…¥ parkAndCheckInterruptï¼Œ Thread-1 parkï¼ˆç°è‰²è¡¨ç¤ºï¼‰\r\n\r\n  ```java\r\n  private final boolean parkAndCheckInterrupt() {\r\n      // é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ\r\n      LockSupport.park(this);\r\n      // åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°\r\n      return Thread.interrupted();\r\n  }\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719155528402.png\" alt=\"image-20230719155528402\" class=\"scale-70\" />\r\n\r\n* å†æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ç«äº‰å¤±è´¥åï¼š\r\n\r\n  ![image-20230719155542494](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719155542494.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n###### è§£é”\r\n\r\n`ReentrantLock#unlock`ï¼šé‡Šæ”¾é”\r\n\r\n```java\r\npublic void unlock() {\r\n    sync.release(1);\r\n}\r\n```\r\n\r\nThread-0 é‡Šæ”¾é”ï¼Œè¿›å…¥ release æµç¨‹\r\n\r\n* è¿›å…¥ tryReleaseï¼Œè®¾ç½® exclusiveOwnerThread ä¸º nullï¼Œ`state = 0`\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719155652604.png\" alt=\"image-20230719155652604\" class=\"scale-67\" />\r\n\r\n* å½“å‰é˜Ÿåˆ—ä¸ä¸º nullï¼Œå¹¶ä¸” head çš„ `waitStatus = -1`ï¼Œè¿›å…¥ unparkSuccessor\r\n\r\n  ```java\r\n  // AbstractQueuedSynchronizer#release\r\n  public final boolean release(int arg) {\r\n      // å°è¯•é‡Šæ”¾é”ï¼ŒtryRelease è¿”å› true è¡¨ç¤ºå½“å‰çº¿ç¨‹å·²ç»ã€å®Œå…¨é‡Šæ”¾é”ï¼Œé‡å…¥çš„é‡Šæ”¾äº†ã€‘\r\n      if (tryRelease(arg)) {\r\n          // é˜Ÿåˆ—å¤´èŠ‚ç‚¹\r\n          Node h = head;\r\n          // å¤´èŠ‚ç‚¹ä»€ä¹ˆæ—¶å€™æ˜¯ç©ºï¼Ÿæ²¡æœ‰å‘ç”Ÿé”ç«äº‰ï¼Œæ²¡æœ‰ç«äº‰çº¿ç¨‹åˆ›å»ºå“‘å…ƒèŠ‚ç‚¹\r\n          // æ¡ä»¶æˆç«‹è¯´æ˜é˜»å¡é˜Ÿåˆ—æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œéœ€è¦å”¤é†’ head èŠ‚ç‚¹åé¢çš„çº¿ç¨‹\r\n          if (h != null && h.waitStatus != 0)\r\n              unparkSuccessor(h);\r\n          return true;\r\n      }    \r\n      return false;\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // ReentrantLock.Sync#tryRelease\r\n  protected final boolean tryRelease(int releases) {\r\n      // å‡å»é‡Šæ”¾çš„å€¼ï¼Œå¯èƒ½é‡å…¥\r\n      int c = getState() - releases;\r\n      // å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æŒæœ‰é”çš„çº¿ç¨‹ç›´æ¥æŠ¥é”™\r\n      if (Thread.currentThread() != getExclusiveOwnerThread())\r\n          throw new IllegalMonitorStateException();\r\n      // æ˜¯å¦å·²ç»å®Œå…¨é‡Šæ”¾é”\r\n      boolean free = false;\r\n      // æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰å®Œå…¨é‡Šæ”¾é”æˆåŠŸ\r\n      if (c == 0) {\r\n          free = true;\r\n          setExclusiveOwnerThread(null);\r\n      }\r\n      // å½“å‰çº¿ç¨‹å°±æ˜¯æŒæœ‰é”çº¿ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ›´æ–°é”ï¼Œä¸éœ€è¦ä½¿ç”¨ CAS\r\n      setState(c);\r\n      return free;\r\n  }\r\n  ```\r\n\r\n* è¿›å…¥ `AbstractQueuedSynchronizer#unparkSuccessor` æ–¹æ³•ï¼Œå”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹\r\n\r\n  * æ‰¾åˆ°é˜Ÿåˆ—ä¸­è·ç¦» head æœ€è¿‘çš„ä¸€ä¸ªæ²¡å–æ¶ˆçš„ Nodeï¼Œunpark æ¢å¤å…¶è¿è¡Œï¼Œæœ¬ä¾‹ä¸­å³ä¸º Thread-1\r\n  * å›åˆ° Thread-1 çš„ acquireQueued æµç¨‹\r\n\r\n  ```java\r\n  private void unparkSuccessor(Node node) {\r\n      // å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€\r\n      int ws = node.waitStatus;    \r\n      if (ws < 0)        \r\n          // ã€å°è¯•é‡ç½®çŠ¶æ€ä¸º 0ã€‘ï¼Œå› ä¸ºå½“å‰èŠ‚ç‚¹è¦å®Œæˆå¯¹åç»­èŠ‚ç‚¹çš„å”¤é†’ä»»åŠ¡äº†ï¼Œä¸éœ€è¦ -1 äº†\r\n          compareAndSetWaitStatus(node, ws, 0);    \r\n      // æ‰¾åˆ°éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ª    \r\n      Node s = node.next;    \r\n      // å·²å–æ¶ˆçš„èŠ‚ç‚¹ä¸èƒ½å”¤é†’ï¼Œéœ€è¦æ‰¾åˆ°è·ç¦»å¤´èŠ‚ç‚¹æœ€è¿‘çš„éå–æ¶ˆçš„èŠ‚ç‚¹\r\n      if (s == null || s.waitStatus > 0) {\r\n          s = null;\r\n          // AQS é˜Ÿåˆ—ã€ä»åè‡³å‰ã€‘æ‰¾éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œç›´åˆ° t == å½“å‰çš„ node ä¸ºæ­¢ï¼Œæ‰¾ä¸åˆ°å°±ä¸å”¤é†’äº†\r\n          for (Node t = tail; t != null && t != node; t = t.prev)\r\n              // è¯´æ˜å½“å‰çº¿ç¨‹çŠ¶æ€éœ€è¦è¢«å”¤é†’\r\n              if (t.waitStatus <= 0)\r\n                  // ç½®æ¢å¼•ç”¨\r\n                  s = t;\r\n      }\r\n      // ã€æ‰¾åˆ°åˆé€‚çš„å¯ä»¥è¢«å”¤é†’çš„ nodeï¼Œåˆ™å”¤é†’çº¿ç¨‹ã€‘\r\n      if (s != null)\r\n          LockSupport.unpark(s.thread);\r\n  }\r\n  ```\r\n\r\n  **ä»åå‘å‰çš„å”¤é†’çš„åŸå› **ï¼šenq æ–¹æ³•ä¸­ï¼ŒèŠ‚ç‚¹æ˜¯å°¾æ’æ³•ï¼Œé¦–å…ˆèµ‹å€¼çš„æ˜¯å°¾èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œæ­¤æ—¶å‰é©±èŠ‚ç‚¹çš„ next å¹¶æ²¡æœ‰æŒ‡å‘å°¾èŠ‚ç‚¹ï¼Œä»å‰éå†ä¼šä¸¢å¤±å°¾èŠ‚ç‚¹\r\n\r\n  ```java\r\n  for (Node h = head; h != null && h != node; h = h.next)\r\n  ```\r\n\r\n  ![image-20240612222223326](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20240612222223326.png)\r\n\r\n* å”¤é†’çš„çº¿ç¨‹ä¼šä» park ä½ç½®å¼€å§‹æ‰§è¡Œï¼Œå¦‚æœåŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä¼šè®¾ç½®\r\n\r\n  * exclusiveOwnerThread ä¸º Thread-1ï¼Œ`state = 1`\r\n  * head æŒ‡å‘åˆšåˆš Thread-1 æ‰€åœ¨çš„ Nodeï¼Œè¯¥ Node ä¼šæ¸…ç©º Thread\r\n  * åŸæœ¬çš„ head å› ä¸ºä»é“¾è¡¨æ–­å¼€ï¼Œä»è€Œå¯è¢«åƒåœ¾å›æ”¶ï¼ˆå›¾ä¸­æœ‰é”™è¯¯ï¼ŒåŸæ¥çš„å¤´èŠ‚ç‚¹çš„ waitStatus è¢«æ”¹ä¸º 0 äº†ï¼‰\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719155754206.png\" alt=\"image-20230719155754206\" class=\"scale-67\" />\r\n\r\n* å¦‚æœè¿™æ—¶æœ‰å…¶å®ƒçº¿ç¨‹æ¥ç«äº‰ï¼ˆ**éå…¬å¹³**ï¼‰ï¼Œä¾‹å¦‚è¿™æ—¶æœ‰ Thread-4 æ¥äº†å¹¶æŠ¢å äº†é”\r\n\r\n  * Thread-4 è¢«è®¾ç½®ä¸º exclusiveOwnerThreadï¼Œstate = 1\r\n  * Thread-1 å†æ¬¡è¿›å…¥ acquireQueued æµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥ park é˜»å¡\r\n\r\n  ![image-20230719155831915](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719155831915.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å…¬å¹³åŸç†\r\n\r\nä¸éå…¬å¹³é”ä¸»è¦åŒºåˆ«åœ¨äº tryAcquire æ–¹æ³•ï¼šå…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ‰å» CAS ç«äº‰\r\n\r\n```java\r\nstatic final class FairSync extends Sync {\r\n    private static final long serialVersionUID = -3000897897090466540L;\r\n    final void lock() {\r\n        acquire(1);\r\n    }\r\n\r\n    protected final boolean tryAcquire(int acquires) {\r\n        final Thread current = Thread.currentThread();\r\n        int c = getState();\r\n        if (c == 0) {\r\n            // å…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰(false)æ‰å»ç«äº‰\r\n            if (!hasQueuedPredecessors() &&\r\n                compareAndSetState(0, acquires)) {\r\n                setExclusiveOwnerThread(current);\r\n                return true;\r\n            }\r\n        }\r\n        // é”é‡å…¥\r\n        return false;\r\n    }\r\n}\r\n```\r\n\r\n```java\r\npublic final boolean hasQueuedPredecessors() {    \r\n    Node t = tail;\r\n    Node h = head;\r\n    Node s;    \r\n    // å¤´å°¾æŒ‡å‘ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé“¾è¡¨ä¸ºç©ºï¼Œè¿”å›false\r\n    return h != t &&\r\n        // å¤´å°¾ä¹‹é—´æœ‰èŠ‚ç‚¹ï¼Œåˆ¤æ–­å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªæ˜¯ä¸æ˜¯ç©º\r\n        // ä¸æ˜¯ç©ºè¿›å…¥æœ€åçš„åˆ¤æ–­ï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹æ˜¯å¦æ˜¯æœ¬çº¿ç¨‹ï¼Œä¸æ˜¯è¿”å› trueï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹æœ‰å‰é©±èŠ‚ç‚¹\r\n        ((s = h.next) == null || s.thread != Thread.currentThread());\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å¯é‡å…¥\r\n\r\nå¯é‡å…¥æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé”ï¼Œå¦‚æœä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½ï¼Œç›´æ¥é€ æˆæ­»é”\r\n\r\næºç è§£æå‚è€ƒï¼š`nonfairTryAcquire(int acquires)) ` å’Œ `tryRelease(int releases)`\r\n\r\n```java\r\nstatic ReentrantLock lock = new ReentrantLock();\r\npublic static void main(String[] args) {\r\n    method1();\r\n}\r\npublic static void method1() {\r\n    lock.lock();\r\n    try {\r\n        System.out.println(Thread.currentThread().getName() + \" execute method1\");\r\n        method2();\r\n    } finally {\r\n        lock.unlock();\r\n    }\r\n}\r\npublic static void method2() {\r\n    lock.lock();\r\n    try {\r\n        System.out.println(Thread.currentThread().getName() + \" execute method2\");\r\n    } finally {\r\n        lock.unlock();\r\n    }\r\n}\r\n```\r\n\r\nåœ¨ Lock æ–¹æ³•åŠ ä¸¤æŠŠé”ä¼šæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ\r\n\r\n* åŠ é”ä¸¤æ¬¡è§£é”ä¸¤æ¬¡ï¼šæ­£å¸¸æ‰§è¡Œ\r\n* åŠ é”ä¸¤æ¬¡è§£é”ä¸€æ¬¡ï¼šç¨‹åºç›´æ¥å¡æ­»ï¼Œçº¿ç¨‹ä¸èƒ½å‡ºæ¥ï¼Œä¹Ÿå°±è¯´æ˜**ç”³è¯·å‡ æŠŠé”ï¼Œæœ€åéœ€è¦è§£é™¤å‡ æŠŠé”**\r\n* åŠ é”ä¸€æ¬¡è§£é”ä¸¤æ¬¡ï¼šè¿è¡Œç¨‹åºä¼šç›´æ¥æŠ¥é”™\r\n\r\n```java\r\npublic void getLock() {\r\n    lock.lock();\r\n    lock.lock();\r\n    try {\r\n        System.out.println(Thread.currentThread().getName() + \"\\t get Lock\");\r\n    } finally {\r\n        lock.unlock();\r\n        //lock.unlock();\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### å¯æ‰“æ–­\r\n\r\n##### åŸºæœ¬ä½¿ç”¨\r\n\r\n`public void lockInterruptibly()`ï¼šè·å¾—å¯æ‰“æ–­çš„é”\r\n\r\n* å¦‚æœæ²¡æœ‰ç«äº‰æ­¤æ–¹æ³•å°±ä¼šè·å– lock å¯¹è±¡é”\r\n* å¦‚æœæœ‰ç«äº‰å°±è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ç”¨ interrupt æ‰“æ–­\r\n\r\næ³¨æ„ï¼šå¦‚æœæ˜¯ä¸å¯ä¸­æ–­æ¨¡å¼ï¼Œé‚£ä¹ˆå³ä½¿ä½¿ç”¨äº† interrupt ä¹Ÿä¸ä¼šè®©ç­‰å¾…çŠ¶æ€ä¸­çš„çº¿ç¨‹ä¸­æ–­\r\n\r\n```java\r\npublic static void main(String[] args) throws InterruptedException {    \r\n    ReentrantLock lock = new ReentrantLock();    \r\n    Thread t1 = new Thread(() -> {        \r\n        try {            \r\n            System.out.println(\"å°è¯•è·å–é”\");            \r\n            lock.lockInterruptibly();        \r\n        } catch (InterruptedException e) {            \r\n            System.out.println(\"æ²¡æœ‰è·å–åˆ°é”ï¼Œè¢«æ‰“æ–­ï¼Œç›´æ¥è¿”å›\");            \r\n            return;        \r\n        }        \r\n        try {            \r\n            System.out.println(\"è·å–åˆ°é”\");        \r\n        } finally {            \r\n            lock.unlock();        \r\n        }    \r\n    }, \"t1\");    \r\n    lock.lock();    \r\n    t1.start();    \r\n    Thread.sleep(2000);    \r\n    System.out.println(\"ä¸»çº¿ç¨‹è¿›è¡Œæ‰“æ–­é”\");    \r\n    t1.interrupt();\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å®ç°åŸç†\r\n\r\n* ä¸å¯æ‰“æ–­æ¨¡å¼ï¼šå³ä½¿å®ƒè¢«æ‰“æ–­ï¼Œä»ä¼šé©»ç•™åœ¨ AQS é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œä¸€ç›´è¦**ç­‰åˆ°è·å¾—é”åæ‰èƒ½å¾—çŸ¥è‡ªå·±è¢«æ‰“æ–­**äº†\r\n\r\n  ```java\r\n  public final void acquire(int arg) {    \r\n      if (!tryAcquire(arg) && acquireQueued(addWaiter(Node.EXCLUSIVE), arg))//é˜»å¡ç­‰å¾…        \r\n          // å¦‚æœacquireQueuedè¿”å›trueï¼Œæ‰“æ–­çŠ¶æ€ interrupted = true        \r\n          selfInterrupt();\r\n  }\r\n  static void selfInterrupt() {\r\n      // çŸ¥é“è‡ªå·±è¢«æ‰“æ–­äº†ï¼Œéœ€è¦é‡æ–°äº§ç”Ÿä¸€æ¬¡ä¸­æ–­å®Œæˆä¸­æ–­æ•ˆæœ\r\n      Thread.currentThread().interrupt();\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  final boolean acquireQueued(final Node node, int arg) {    \r\n      try {        \r\n          boolean interrupted = false;        \r\n          for (;;) {            \r\n              final Node p = node.predecessor();            \r\n              if (p == head && tryAcquire(arg)) {                \r\n                  setHead(node);                \r\n                  p.next = null; // help GC                \r\n                  failed = false;                \r\n                  // è¿˜æ˜¯éœ€è¦è·å¾—é”å, æ‰èƒ½è¿”å›æ‰“æ–­çŠ¶æ€\r\n                  return interrupted;            \r\n              }            \r\n              if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt()){\r\n                  // æ¡ä»¶äºŒä¸­åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œè¢«æ‰“æ–­è¿”å›trueï¼Œè®¾ç½®ä¸­æ–­æ ‡è®°ä¸º trueï¼Œã€è·å–é”åè¿”å›ã€‘\r\n                  interrupted = true;  \r\n              }                  \r\n          } \r\n      } finally {\r\n          if (failed)\r\n              cancelAcquire(node);\r\n      }\r\n  }\r\n   private final boolean parkAndCheckInterrupt() {    \r\n       // é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ\r\n       LockSupport.park(this);    \r\n       // åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œè¢«æ‰“æ–­è¿”å›true\r\n       return Thread.interrupted();\r\n   }\r\n  ```\r\n\r\n* å¯æ‰“æ–­æ¨¡å¼ï¼š`AbstractQueuedSynchronizer#acquireInterruptibly`ï¼Œ**è¢«æ‰“æ–­åä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸**\r\n\r\n  ```java\r\n  public void lockInterruptibly() throws InterruptedException {    \r\n      sync.acquireInterruptibly(1);\r\n  }\r\n  public final void acquireInterruptibly(int arg) {\r\n      // è¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­äº†ç›´æ¥è¿”å› false\r\n      if (Thread.interrupted())\r\n  \t\tthrow new InterruptedException();\r\n      if (!tryAcquire(arg))\r\n          // æ²¡è·å–åˆ°é”ï¼Œè¿›å…¥è¿™é‡Œ\r\n          doAcquireInterruptibly(arg);\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  private void doAcquireInterruptibly(int arg) throws InterruptedException {\r\n      // è¿”å›å°è£…å½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹\r\n      final Node node = addWaiter(Node.EXCLUSIVE);\r\n      boolean failed = true;\r\n      try {\r\n          for (;;) {\r\n              //...\r\n              if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())\r\n                  // ã€åœ¨ park è¿‡ç¨‹ä¸­å¦‚æœè¢« interrupt ä¼šæŠ›å‡ºå¼‚å¸¸ã€‘, è€Œä¸ä¼šå†æ¬¡è¿›å…¥å¾ªç¯è·å–é”åæ‰å®Œæˆæ‰“æ–­æ•ˆæœ\r\n                  throw new InterruptedException();\r\n          }    \r\n      } finally {\r\n          // æŠ›å‡ºå¼‚å¸¸å‰ä¼šè¿›å…¥è¿™é‡Œ\r\n          if (failed)\r\n              // å–æ¶ˆå½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹\r\n              cancelAcquire(node);\r\n      }\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // å–æ¶ˆèŠ‚ç‚¹å‡ºé˜Ÿçš„é€»è¾‘\r\n  private void cancelAcquire(Node node) {\r\n      // åˆ¤ç©º\r\n      if (node == null)\r\n          return;\r\n  \t// æŠŠå½“å‰èŠ‚ç‚¹å°è£…çš„ Thread ç½®ä¸ºç©º\r\n      node.thread = null;\r\n  \t// è·å–å½“å‰å–æ¶ˆçš„ node çš„å‰é©±èŠ‚ç‚¹\r\n      Node pred = node.prev;\r\n      // å‰é©±èŠ‚ç‚¹ä¹Ÿè¢«å–æ¶ˆäº†ï¼Œå¾ªç¯æ‰¾åˆ°å‰é¢æœ€è¿‘çš„æ²¡è¢«å–æ¶ˆçš„èŠ‚ç‚¹\r\n      while (pred.waitStatus > 0)\r\n          node.prev = pred = pred.prev;\r\n      \r\n  \t// è·å–å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œå¯èƒ½æ˜¯å½“å‰ nodeï¼Œä¹Ÿå¯èƒ½æ˜¯ waitStatus > 0 çš„èŠ‚ç‚¹\r\n      Node predNext = pred.next;\r\n      \r\n  \t// æŠŠå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º ã€å–æ¶ˆçŠ¶æ€ 1ã€‘\r\n      node.waitStatus = Node.CANCELLED;\r\n      \r\n  \t// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹ï¼ŒæŠŠå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹\r\n      if (node == tail && compareAndSetTail(node, pred)) {\r\n          // æŠŠå‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ç½®ç©ºï¼Œè¿™é‡Œç›´æ¥æŠŠæ‰€æœ‰çš„å–æ¶ˆèŠ‚ç‚¹å‡ºé˜Ÿ\r\n          compareAndSetNext(pred, predNext, null);\r\n      } else {\r\n          // è¯´æ˜å½“å‰èŠ‚ç‚¹ä¸æ˜¯ tail èŠ‚ç‚¹\r\n          int ws;\r\n          // æ¡ä»¶ä¸€æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹ä¸æ˜¯ head.next èŠ‚ç‚¹\r\n          if (pred != head &&\r\n              // åˆ¤æ–­å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ä¸æ˜¯ -1ï¼Œä¸æˆç«‹è¯´æ˜å‰é©±çŠ¶æ€å¯èƒ½æ˜¯ 0 æˆ–è€…åˆšè¢«å…¶ä»–çº¿ç¨‹å–æ¶ˆæ’é˜Ÿäº†\r\n              ((ws = pred.waitStatus) == Node.SIGNAL ||\r\n               // å¦‚æœçŠ¶æ€ä¸æ˜¯ -1ï¼Œè®¾ç½®å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º -1\r\n               (ws <= 0 && compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &&\r\n              // å‰é©±èŠ‚ç‚¹çš„çº¿ç¨‹ä¸ä¸ºnull\r\n              pred.thread != null) {\r\n              \r\n              Node next = node.next;\r\n              // å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æ˜¯æ­£å¸¸èŠ‚ç‚¹\r\n              if (next != null && next.waitStatus <= 0)\r\n                  // æŠŠ å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ è®¾ç½®ä¸º å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œã€ä»é˜Ÿåˆ—ä¸­åˆ é™¤äº†å½“å‰èŠ‚ç‚¹ã€‘\r\n                  compareAndSetNext(pred, predNext, next);\r\n          } else {\r\n              // å½“å‰èŠ‚ç‚¹æ˜¯ head.next èŠ‚ç‚¹ï¼Œå”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹\r\n              unparkSuccessor(node);\r\n          }\r\n          node.next = node; // help GC\r\n      }\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### é”è¶…æ—¶\r\n\r\n##### åŸºæœ¬ä½¿ç”¨\r\n\r\n`public boolean tryLock()`ï¼šå°è¯•è·å–é”ï¼Œè·å–åˆ°è¿”å› trueï¼Œè·å–ä¸åˆ°ç›´æ¥æ”¾å¼ƒï¼Œä¸è¿›å…¥é˜»å¡é˜Ÿåˆ—\r\n\r\n`public boolean tryLock(long timeout, TimeUnit unit)`ï¼šåœ¨ç»™å®šæ—¶é—´å†…è·å–é”ï¼Œè·å–ä¸åˆ°å°±é€€å‡º\r\n\r\næ³¨æ„ï¼štryLock æœŸé—´ä¹Ÿå¯ä»¥è¢«æ‰“æ–­\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    ReentrantLock lock = new ReentrantLock();\r\n    Thread t1 = new Thread(() -> {\r\n        try {\r\n            if (!lock.tryLock(2, TimeUnit.SECONDS)) {\r\n                System.out.println(\"è·å–ä¸åˆ°é”\");\r\n                return;\r\n            }\r\n        } catch (InterruptedException e) {\r\n            System.out.println(\"è¢«æ‰“æ–­ï¼Œè·å–ä¸åˆ°é”\");\r\n            return;\r\n        }\r\n        try {\r\n            log.debug(\"è·å–åˆ°é”\");\r\n        } finally {\r\n            lock.unlock();\r\n        }\r\n    }, \"t1\");\r\n    lock.lock();\r\n    System.out.println(\"ä¸»çº¿ç¨‹è·å–åˆ°é”\");\r\n    t1.start();\r\n    \r\n    Thread.sleep(1000);\r\n    try {\r\n        System.out.println(\"ä¸»çº¿ç¨‹é‡Šæ”¾äº†é”\");\r\n    } finally {\r\n        lock.unlock();\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å®ç°åŸç†\r\n\r\n* æˆå‘˜å˜é‡ï¼šæŒ‡å®šè¶…æ—¶é™åˆ¶çš„é˜ˆå€¼ï¼Œå°äºè¯¥å€¼çš„çº¿ç¨‹ä¸ä¼šè¢«æŒ‚èµ·\r\n\r\n  ```java\r\n  static final long spinForTimeoutThreshold = 1000L;\r\n  ```\r\n\r\n  è¶…æ—¶æ—¶é—´è®¾ç½®çš„å°äºè¯¥å€¼ï¼Œå°±ä¼šè¢«ç¦æ­¢æŒ‚èµ·ï¼Œå› ä¸ºé˜»å¡åœ¨å”¤é†’çš„æˆæœ¬å¤ªé«˜ï¼Œä¸å¦‚é€‰æ‹©è‡ªæ—‹ç©ºè½¬\r\n\r\n* tryLock()\r\n\r\n  ```java\r\n  public boolean tryLock() {   \r\n      // åªå°è¯•ä¸€æ¬¡\r\n      return sync.nonfairTryAcquire(1);\r\n  }\r\n  ```\r\n\r\n* tryLock(long timeout, TimeUnit unit)\r\n\r\n  ```java\r\n  public final boolean tryAcquireNanos(int arg, long nanosTimeout) {\r\n      if (Thread.interrupted())        \r\n          throw new InterruptedException();    \r\n      // tryAcquire å°è¯•ä¸€æ¬¡\r\n      return tryAcquire(arg) || doAcquireNanos(arg, nanosTimeout);\r\n  }\r\n  protected final boolean tryAcquire(int acquires) {    \r\n      return nonfairTryAcquire(acquires);\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  private boolean doAcquireNanos(int arg, long nanosTimeout) {    \r\n      if (nanosTimeout <= 0L)\r\n          return false;\r\n      // è·å–æœ€åæœŸé™çš„æ—¶é—´æˆ³\r\n      final long deadline = System.nanoTime() + nanosTimeout;\r\n      //...\r\n      try {\r\n          for (;;) {\r\n              //...\r\n              // è®¡ç®—è¿˜éœ€ç­‰å¾…çš„æ—¶é—´\r\n              nanosTimeout = deadline - System.nanoTime();\r\n              if (nanosTimeout <= 0L)\t//æ—¶é—´å·²åˆ°     \r\n                  return false;\r\n              if (shouldParkAfterFailedAcquire(p, node) &&\r\n                  // å¦‚æœ nanosTimeout å¤§äºè¯¥å€¼ï¼Œæ‰æœ‰é˜»å¡çš„æ„ä¹‰ï¼Œå¦åˆ™ç›´æ¥è‡ªæ—‹ä¼šå¥½ç‚¹\r\n                  nanosTimeout > spinForTimeoutThreshold)\r\n                  LockSupport.parkNanos(this, nanosTimeout);\r\n              // ã€è¢«æ‰“æ–­ä¼šæŠ¥å¼‚å¸¸ã€‘\r\n              if (Thread.interrupted())\r\n                  throw new InterruptedException();\r\n          }    \r\n      }\r\n  }\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å“²å­¦å®¶å°±é¤\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    Chopstick c1 = new Chopstick(\"1\");//...\r\n    Chopstick c5 = new Chopstick(\"5\");\r\n    new Philosopher(\"è‹æ ¼æ‹‰åº•\", c1, c2).start();\r\n    new Philosopher(\"æŸæ‹‰å›¾\", c2, c3).start();\r\n    new Philosopher(\"äºšé‡Œå£«å¤šå¾·\", c3, c4).start();\r\n    new Philosopher(\"èµ«æ‹‰å…‹åˆ©ç‰¹\", c4, c5).start();    \r\n    new Philosopher(\"é˜¿åŸºç±³å¾·\", c5, c1).start();\r\n}\r\nclass Philosopher extends Thread {\r\n    Chopstick left;\r\n    Chopstick right;\r\n    public void run() {\r\n        while (true) {\r\n            // å°è¯•è·å¾—å·¦æ‰‹ç­·å­\r\n            if (left.tryLock()) {\r\n                try {\r\n                    // å°è¯•è·å¾—å³æ‰‹ç­·å­\r\n                    if (right.tryLock()) {\r\n                        try {\r\n                            System.out.println(\"eating...\");\r\n                            Thread.sleep(1000);\r\n                        } finally {\r\n                            right.unlock();\r\n                        }\r\n                    }\r\n                } finally {\r\n                    left.unlock();\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\nclass Chopstick extends ReentrantLock {\r\n    String name;\r\n    public Chopstick(String name) {\r\n        this.name = name;\r\n    }\r\n    @Override\r\n    public String toString() {\r\n        return \"ç­·å­{\" + name + '}';\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æ¡ä»¶å˜é‡\r\n\r\n##### åŸºæœ¬ä½¿ç”¨\r\n\r\nsynchronized çš„æ¡ä»¶å˜é‡ï¼Œæ˜¯å½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥ WaitSet ç­‰å¾…ï¼›ReentrantLock çš„æ¡ä»¶å˜é‡æ¯” synchronized å¼ºå¤§ä¹‹å¤„åœ¨äºæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡\r\n\r\nReentrantLock ç±»è·å– Condition å¯¹è±¡ï¼š`public Condition newCondition()`\r\n\r\nCondition ç±» APIï¼š\r\n\r\n* `void await()`ï¼šå½“å‰çº¿ç¨‹ä»è¿è¡ŒçŠ¶æ€è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œé‡Šæ”¾é”\r\n* `void signal()`ï¼šå”¤é†’ä¸€ä¸ªåœ¨ Condition ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼Œä½†æ˜¯å¿…é¡»è·å¾—ä¸è¯¥ Condition ç›¸å…³çš„é”\r\n\r\nä½¿ç”¨æµç¨‹ï¼š\r\n\r\n* **await / signal å‰éœ€è¦è·å¾—é”**\r\n* await æ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”è¿›å…¥ ConditionObject ç­‰å¾…\r\n* await çš„çº¿ç¨‹è¢«å”¤é†’å»é‡æ–°ç«äº‰ lock é”\r\n\r\n* **çº¿ç¨‹åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«æ‰“æ–­ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸**\r\n\r\n* ç«äº‰ lock é”æˆåŠŸåï¼Œä» await åç»§ç»­æ‰§è¡Œ\r\n\r\n```java\r\npublic static void main(String[] args) throws InterruptedException {    \r\n    ReentrantLock lock = new ReentrantLock();\r\n    //åˆ›å»ºä¸€ä¸ªæ–°çš„æ¡ä»¶å˜é‡\r\n    Condition condition1 = lock.newCondition();\r\n    Condition condition2 = lock.newCondition();\r\n    new Thread(() -> {\r\n        try {\r\n            lock.lock();\r\n            System.out.println(\"è¿›å…¥ç­‰å¾…\");\r\n            //è¿›å…¥ä¼‘æ¯å®¤ç­‰å¾…\r\n            condition1.await();\r\n            System.out.println(\"è¢«å”¤é†’äº†\");\r\n        } catch (InterruptedException e) {\r\n            e.printStackTrace();\r\n        } finally {\r\n            lock.unlock();\r\n        }    \r\n    }).start();\r\n    Thread.sleep(1000);\r\n    //å«é†’\r\n    new Thread(() -> {\r\n        try {            \r\n            lock.lock();\r\n            //å”¤é†’\r\n            condition2.signal();\r\n        } finally {\r\n            lock.unlock();\r\n        }\r\n    }).start();\r\n}\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n##### å®ç°åŸç†\r\n\r\n###### await\r\n\r\næ€»ä½“æµç¨‹æ˜¯å°† await çº¿ç¨‹åŒ…è£…æˆ node èŠ‚ç‚¹æ”¾å…¥ ConditionObject çš„æ¡ä»¶é˜Ÿåˆ—ï¼Œå¦‚æœè¢«å”¤é†’å°±å°† node è½¬ç§»åˆ° AQS çš„æ‰§è¡Œé˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…è·å–é”ï¼Œ**æ¯ä¸ª Condition å¯¹è±¡éƒ½åŒ…å«ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—**\r\n\r\n* å¼€å§‹ Thread-0 æŒæœ‰é”ï¼Œè°ƒç”¨ awaitï¼Œçº¿ç¨‹è¿›å…¥ ConditionObject ç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­ï¼Œè°ƒç”¨ await æ–¹æ³•çš„çº¿ç¨‹éƒ½æ˜¯æŒé”çŠ¶æ€çš„ï¼Œæ‰€ä»¥è¯´é€»è¾‘é‡Œ**ä¸å­˜åœ¨å¹¶å‘**\r\n\r\n  ```java\r\n  public final void await() throws InterruptedException {\r\n       // åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œæ˜¯å°±ç›´æ¥ç»™ä¸ªä¸­æ–­å¼‚å¸¸\r\n      if (Thread.interrupted())\r\n          throw new InterruptedException();\r\n      // å°†è°ƒç”¨ await çš„çº¿ç¨‹åŒ…è£…æˆ Nodeï¼Œæ·»åŠ åˆ°æ¡ä»¶é˜Ÿåˆ—å¹¶è¿”å›\r\n      Node node = addConditionWaiter();\r\n      // å®Œå…¨é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”ï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹å”¤é†’å½“å‰çº¿ç¨‹çš„å‰ææ˜¯ã€æŒæœ‰é”ã€‘\r\n      int savedState = fullyRelease(node);\r\n      \r\n      // è®¾ç½®æ‰“æ–­æ¨¡å¼ä¸ºæ²¡æœ‰è¢«æ‰“æ–­ï¼ŒçŠ¶æ€ç ä¸º 0\r\n      int interruptMode = 0;\r\n      \r\n      // å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜»å¡é˜Ÿåˆ—, park é˜»å¡ï¼Œç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—\r\n      while (!isOnSyncQueue(node)) {\r\n          LockSupport.park(this);\r\n          // å¦‚æœè¢«æ‰“æ–­ï¼Œé€€å‡ºç­‰å¾…é˜Ÿåˆ—ï¼Œå¯¹åº”çš„ node ã€ä¹Ÿä¼šè¢«è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—ã€‘å°¾éƒ¨ï¼ŒçŠ¶æ€è®¾ç½®ä¸º 0\r\n          if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)\r\n              break;\r\n      }\r\n      // é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹é€€å‡ºç­‰å¾…é˜Ÿåˆ—ï¼Œè¿›å…¥ã€é˜»å¡é˜Ÿåˆ—ã€‘\r\n      \r\n      // å°è¯•æªé”ï¼Œé‡Šæ”¾äº†å¤šå°‘é”å°±ã€é‡æ–°è·å–å¤šå°‘é”ã€‘ï¼Œè·å–é”æˆåŠŸåˆ¤æ–­æ‰“æ–­æ¨¡å¼\r\n      if (acquireQueued(node, savedState) && interruptMode != THROW_IE)\r\n          interruptMode = REINTERRUPT;\r\n      \r\n      // node åœ¨æ¡ä»¶é˜Ÿåˆ—æ—¶ å¦‚æœè¢«å¤–éƒ¨çº¿ç¨‹ä¸­æ–­å”¤é†’ï¼Œä¼šåŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä½†æ˜¯å¹¶æœªè®¾ nextWaiter = null\r\n      if (node.nextWaiter != null)\r\n          // æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆçš„ Node\r\n          unlinkCancelledWaiters();\r\n      // æ¡ä»¶æˆç«‹è¯´æ˜æŒ‚èµ·æœŸé—´å‘ç”Ÿè¿‡ä¸­æ–­\r\n      if (interruptMode != 0)\r\n          // åº”ç”¨æ‰“æ–­æ¨¡å¼\r\n          reportInterruptAfterWait(interruptMode);\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶é‡æ–°è®¾ç½®æ‰“æ–­çŠ¶æ€\r\n  private static final int REINTERRUPT = 1;\r\n  // æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶æŠ›å‡ºå¼‚å¸¸\r\n  private static final int THROW_IE = -1;\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719164232726.png\" alt=\"image-20230719164232726\" class=\"scale-80\" />\r\n\r\n* **åˆ›å»ºæ–°çš„ Node çŠ¶æ€ä¸º -2ï¼ˆNode.CONDITIONï¼‰**ï¼Œå…³è” Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨\r\n\r\n  ```java\r\n  private Node addConditionWaiter() {\r\n      // è·å–å½“å‰æ¡ä»¶é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œä¿å­˜åˆ°å±€éƒ¨å˜é‡ t ä¸­\r\n      Node t = lastWaiter;\r\n      // å½“å‰é˜Ÿåˆ—ä¸­ä¸æ˜¯ç©ºï¼Œå¹¶ä¸”èŠ‚ç‚¹çš„çŠ¶æ€ä¸æ˜¯ CONDITIONï¼ˆ-2ï¼‰ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å‘ç”Ÿäº†ä¸­æ–­\r\n      if (t != null && t.waitStatus != Node.CONDITION) {\r\n          // æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆçš„ Node\r\n          unlinkCancelledWaiters();\r\n          // æ¸…ç†å®Œæˆé‡æ–°è·å– å°¾èŠ‚ç‚¹ çš„å¼•ç”¨\r\n          t = lastWaiter;\r\n      }\r\n      // åˆ›å»ºä¸€ä¸ªå…³è”å½“å‰çº¿ç¨‹çš„æ–° node, è®¾ç½®çŠ¶æ€ä¸º CONDITION(-2)ï¼Œæ·»åŠ è‡³é˜Ÿåˆ—å°¾éƒ¨\r\n      Node node = new Node(Thread.currentThread(), Node.CONDITION);\r\n      if (t == null)\r\n          firstWaiter = node;\t\t// ç©ºé˜Ÿåˆ—ç›´æ¥æ”¾åœ¨é˜Ÿé¦–ã€ä¸ç”¨CASå› ä¸ºæ‰§è¡Œçº¿ç¨‹æ˜¯æŒé”çº¿ç¨‹ï¼Œå¹¶å‘å®‰å…¨ã€‘\r\n      else\r\n          t.nextWaiter = node;\t// éç©ºé˜Ÿåˆ—é˜Ÿå°¾è¿½åŠ \r\n      lastWaiter = node;\t\t\t// æ›´æ–°é˜Ÿå°¾çš„å¼•ç”¨\r\n      return node;\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆï¼ˆä¸æ˜¯CONDITIONï¼‰çš„ nodeï¼Œã€é“¾è¡¨åˆ é™¤çš„é€»è¾‘ã€‘\r\n  private void unlinkCancelledWaiters() {\r\n      // ä»å¤´èŠ‚ç‚¹å¼€å§‹éå†ã€FIFOã€‘\r\n      Node t = firstWaiter;\r\n      // æŒ‡å‘æ­£å¸¸çš„ CONDITION èŠ‚ç‚¹\r\n      Node trail = null;\r\n      // ç­‰å¾…é˜Ÿåˆ—ä¸ç©º\r\n      while (t != null) {\r\n          // è·å–å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹\r\n          Node next = t.nextWaiter;\r\n          // åˆ¤æ–­ t èŠ‚ç‚¹æ˜¯ä¸æ˜¯ CONDITION èŠ‚ç‚¹ï¼Œæ¡ä»¶é˜Ÿåˆ—å†…ä¸æ˜¯ CONDITION å°±ä¸æ˜¯æ­£å¸¸çš„\r\n          if (t.waitStatus != Node.CONDITION) { \r\n              // ä¸æ˜¯æ­£å¸¸èŠ‚ç‚¹ï¼Œéœ€è¦ t ä¸ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ–­å¼€\r\n              t.nextWaiter = null;\r\n              // æ¡ä»¶æˆç«‹è¯´æ˜éå†åˆ°çš„èŠ‚ç‚¹è¿˜æœªç¢°åˆ°è¿‡æ­£å¸¸èŠ‚ç‚¹\r\n              if (trail == null)\r\n                  // æ›´æ–° firstWaiter æŒ‡é’ˆä¸ºä¸‹ä¸ªèŠ‚ç‚¹\r\n                  firstWaiter = next;\r\n              else\r\n                  // è®©ä¸Šä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹æŒ‡å‘ å½“å‰å–æ¶ˆèŠ‚ç‚¹çš„ ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œã€åˆ é™¤éæ­£å¸¸çš„èŠ‚ç‚¹ã€‘\r\n                  trail.nextWaiter = next;\r\n              // t æ˜¯å°¾èŠ‚ç‚¹äº†ï¼Œæ›´æ–° lastWaiter æŒ‡å‘æœ€åä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹\r\n              if (next == null)\r\n                  lastWaiter = trail;\r\n          } else {\r\n              // trail æŒ‡å‘çš„æ˜¯æ­£å¸¸èŠ‚ç‚¹ \r\n              trail = t;\r\n          }\r\n          // æŠŠ t.next èµ‹å€¼ç»™ tï¼Œå¾ªç¯éå†\r\n          t = next; \r\n      }\r\n  }\r\n  ```\r\n\r\n* æ¥ä¸‹æ¥ Thread-0 è¿›å…¥ AQS çš„ fullyRelease æµç¨‹ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”\r\n\r\n  ```java\r\n  // çº¿ç¨‹å¯èƒ½é‡å…¥ï¼Œéœ€è¦å°† state å…¨éƒ¨é‡Šæ”¾\r\n  final int fullyRelease(Node node) {\r\n      // å®Œå…¨é‡Šæ”¾é”æ˜¯å¦æˆåŠŸï¼Œfalse ä»£è¡¨æˆåŠŸ\r\n      boolean failed = true;\r\n      try {\r\n          // è·å–å½“å‰çº¿ç¨‹æ‰€æŒæœ‰çš„ state å€¼æ€»æ•°\r\n          int savedState = getState();\r\n          // release -> tryRelease è§£é”é‡å…¥é”\r\n          if (release(savedState)) {\r\n              // é‡Šæ”¾æˆåŠŸ\r\n              failed = false;\r\n              // è¿”å›è§£é”çš„æ·±åº¦\r\n              return savedState;\r\n          } else {\r\n              // è§£é”å¤±è´¥æŠ›å‡ºå¼‚å¸¸\r\n              throw new IllegalMonitorStateException();\r\n          }\r\n      } finally {\r\n          // æ²¡æœ‰é‡Šæ”¾æˆåŠŸï¼Œå°†å½“å‰ node è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€\r\n          if (failed)\r\n              node.waitStatus = Node.CANCELLED;\r\n      }\r\n  }\r\n  ```\r\n\r\n* fullyRelease ä¸­ä¼š unpark AQS é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç«äº‰é”ï¼Œå‡è®¾ Thread-1 ç«äº‰æˆåŠŸ\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719164258904.png\" alt=\"image-20230719164258904\" class=\"scale-80\" />\r\n\r\n* Thread-0 è¿›å…¥ isOnSyncQueue é€»è¾‘åˆ¤æ–­èŠ‚ç‚¹**æ˜¯å¦ç§»åŠ¨åˆ°é˜»å¡é˜Ÿåˆ—**ï¼Œæ²¡æœ‰å°± park é˜»å¡ Thread-0\r\n\r\n  ```java\r\n  final boolean isOnSyncQueue(Node node) {\r\n      // node çš„çŠ¶æ€æ˜¯ CONDITIONï¼Œsignal æ–¹æ³•æ˜¯å…ˆä¿®æ”¹çŠ¶æ€å†è¿ç§»ï¼Œæ‰€ä»¥å‰é©±èŠ‚ç‚¹ä¸ºç©ºè¯æ˜è¿˜ã€æ²¡æœ‰å®Œæˆè¿ç§»ã€‘\r\n      if (node.waitStatus == Node.CONDITION || node.prev == null)\r\n          return false;\r\n      // è¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»æˆåŠŸå…¥é˜Ÿåˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä¸”å½“å‰èŠ‚ç‚¹åé¢å·²ç»æœ‰å…¶å®ƒ nodeï¼Œå› ä¸ºæ¡ä»¶é˜Ÿåˆ—çš„ next æŒ‡é’ˆä¸º null\r\n      if (node.next != null)\r\n          return true;\r\n  \t// è¯´æ˜ã€å¯èƒ½åœ¨é˜»å¡é˜Ÿåˆ—ï¼Œä½†æ˜¯æ˜¯å°¾èŠ‚ç‚¹ã€‘\r\n      // ä»é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹å¼€å§‹å‘å‰ã€éå†æŸ¥æ‰¾ nodeã€‘ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°è¿”å› trueï¼ŒæŸ¥æ‰¾ä¸åˆ°è¿”å› false\r\n      return findNodeFromTail(node);\r\n  }\r\n  ```\r\n\r\n* await çº¿ç¨‹ park åå¦‚æœè¢« unpark æˆ–è€…è¢«æ‰“æ–­ï¼Œéƒ½ä¼šè¿›å…¥ checkInterruptWhileWaiting åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼š**åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«æ‰“æ–­çš„çº¿ç¨‹éœ€è¦æŠ›å‡ºå¼‚å¸¸**\r\n\r\n  ```java\r\n  private int checkInterruptWhileWaiting(Node node) {\r\n      // Thread.interrupted() è¿”å›å½“å‰çº¿ç¨‹ä¸­æ–­æ ‡è®°ä½ï¼Œå¹¶ä¸”é‡ç½®å½“å‰æ ‡è®°ä½ ä¸º false\r\n      // å¦‚æœè¢«ä¸­æ–­äº†ï¼Œæ ¹æ®æ˜¯å¦åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«ä¸­æ–­çš„ï¼Œè®¾ç½®ä¸­æ–­çŠ¶æ€ç \r\n      return Thread.interrupted() ?(transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) : 0;\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // è¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨çº¿ç¨‹æ˜¯è¢«æ‰“æ–­å”¤é†’æ—¶æ‰ä¼šè°ƒç”¨\r\n  final boolean transferAfterCancelledWait(Node node) {\r\n      // æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰nodeä¸€å®šæ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—å†…ï¼Œå› ä¸º signal è¿ç§»èŠ‚ç‚¹åˆ°é˜»å¡é˜Ÿåˆ—æ—¶ï¼Œä¼šå°†èŠ‚ç‚¹çš„çŠ¶æ€ä¿®æ”¹ä¸º 0\r\n      if (compareAndSetWaitStatus(node, Node.CONDITION, 0)) {\r\n          // æŠŠã€ä¸­æ–­å”¤é†’çš„ node åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ã€‘\r\n          enq(node);\r\n          // è¡¨ç¤ºæ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—å†…è¢«ä¸­æ–­äº†ï¼Œè®¾ç½®ä¸º THROW_IE ä¸º -1\r\n          return true;\r\n      }\r\n  \r\n      //æ‰§è¡Œåˆ°è¿™é‡Œçš„æƒ…å†µï¼š\r\n      //1.å½“å‰nodeå·²ç»è¢«å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ signal æ–¹æ³•å°†å…¶è¿ç§»åˆ° é˜»å¡é˜Ÿåˆ— å†…äº†\r\n      //2.å½“å‰nodeæ­£åœ¨è¢«å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ signal æ–¹æ³•å°†å…¶è¿ç§»è‡³ é˜»å¡é˜Ÿåˆ— è¿›è¡Œä¸­çŠ¶æ€\r\n      \r\n      // å¦‚æœå½“å‰çº¿ç¨‹è¿˜æ²¡åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä¸€ç›´é‡Šæ”¾ CPU\r\n      while (!isOnSyncQueue(node))\r\n          Thread.yield();\r\n  \r\n      // è¡¨ç¤ºå½“å‰èŠ‚ç‚¹è¢«ä¸­æ–­å”¤é†’æ—¶ä¸åœ¨æ¡ä»¶é˜Ÿåˆ—äº†ï¼Œè®¾ç½®ä¸º REINTERRUPT ä¸º 1\r\n      return false;\r\n  }\r\n  ```\r\n\r\n* æœ€åå¼€å§‹å¤„ç†ä¸­æ–­çŠ¶æ€ï¼š\r\n\r\n  ```java\r\n  private void reportInterruptAfterWait(int interruptMode) throws InterruptedException {\r\n      // æ¡ä»¶æˆç«‹è¯´æ˜ã€åœ¨æ¡ä»¶é˜Ÿåˆ—å†…å‘ç”Ÿè¿‡ä¸­æ–­ï¼Œæ­¤æ—¶ await æ–¹æ³•æŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‘\r\n      if (interruptMode == THROW_IE)\r\n          throw new InterruptedException();\r\n  \r\n      // æ¡ä»¶æˆç«‹è¯´æ˜ã€åœ¨æ¡ä»¶é˜Ÿåˆ—å¤–å‘ç”Ÿçš„ä¸­æ–­ï¼Œæ­¤æ—¶è®¾ç½®å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ä½ä¸º trueã€‘\r\n      else if (interruptMode == REINTERRUPT)\r\n          // è¿›è¡Œä¸€æ¬¡è‡ªå·±æ‰“æ–­ï¼Œäº§ç”Ÿä¸­æ–­çš„æ•ˆæœ\r\n          selfInterrupt();\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n###### signal\r\n\r\n* å‡è®¾ Thread-1 è¦æ¥å”¤é†’ Thread-0ï¼Œè¿›å…¥ ConditionObject çš„ doSignal æµç¨‹ï¼Œ**å–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Node**ï¼Œå³ Thread-0 æ‰€åœ¨ Nodeï¼Œå¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…çº¿ç¨‹å®‰å…¨\r\n\r\n  ```java\r\n  public final void signal() {\r\n      // åˆ¤æ–­è°ƒç”¨ signal æ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦æ˜¯ç‹¬å é”æŒæœ‰çº¿ç¨‹\r\n      if (!isHeldExclusively())\r\n          throw new IllegalMonitorStateException();\r\n      // è·å–æ¡ä»¶é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Node\r\n      Node first = firstWaiter;\r\n      // ä¸ä¸ºç©ºå°±å°†ç¬¬è¯¥èŠ‚ç‚¹ã€è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—ã€‘\r\n      if (first != null)\r\n          doSignal(first);\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // å”¤é†’ - ã€å°†æ²¡å–æ¶ˆçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—å°¾éƒ¨ã€‘\r\n  private void doSignal(Node first) {\r\n      do {\r\n          // æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ nullï¼Œå½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹äº†ï¼Œé˜Ÿåˆ—ä¸­åªæœ‰å½“å‰ä¸€ä¸ªèŠ‚ç‚¹äº†\r\n          if ((firstWaiter = first.nextWaiter) == null)\r\n              lastWaiter = null;\r\n          first.nextWaiter = null;\r\n      // å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ Node è½¬ç§»è‡³ AQS é˜Ÿåˆ—ï¼Œä¸æˆåŠŸä¸”è¿˜æœ‰èŠ‚ç‚¹åˆ™ç»§ç»­å¾ªç¯\r\n      } while (!transferForSignal(first) && (first = firstWaiter) != null);\r\n  }\r\n  \r\n  // signalAll() ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå”¤é†’æ‰€æœ‰çš„èŠ‚ç‚¹\r\n  private void doSignalAll(Node first) {\r\n      lastWaiter = firstWaiter = null;\r\n      do {\r\n          Node next = first.nextWaiter;\r\n          first.nextWaiter = null;\r\n          transferForSignal(first);\r\n          first = next;\r\n      // å”¤é†’æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œéƒ½æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ä¸­\r\n      } while (first != null);\r\n  }\r\n  ```\r\n\r\n* æ‰§è¡Œ transferForSignalï¼Œ**å…ˆå°†èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º 0ï¼Œç„¶ååŠ å…¥ AQS é˜»å¡é˜Ÿåˆ—å°¾éƒ¨**ï¼Œå°† Thread-3 çš„ waitStatus æ”¹ä¸º -1\r\n\r\n  ```java\r\n  // å¦‚æœèŠ‚ç‚¹çŠ¶æ€æ˜¯å–æ¶ˆ, è¿”å› false è¡¨ç¤ºè½¬ç§»å¤±è´¥, å¦åˆ™è½¬ç§»æˆåŠŸ\r\n  final boolean transferForSignal(Node node) {\r\n      // CAS ä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä¿®æ”¹ä¸º 0ï¼Œå› ä¸ºå½“å‰èŠ‚ç‚¹é©¬ä¸Šè¦è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº†\r\n      // å¦‚æœçŠ¶æ€å·²ç»ä¸æ˜¯ CONDITION, è¯´æ˜çº¿ç¨‹è¢«å–æ¶ˆï¼ˆawait é‡Šæ”¾å…¨éƒ¨é”å¤±è´¥ï¼‰æˆ–è€…è¢«ä¸­æ–­ï¼ˆå¯æ‰“æ–­ cancelAcquireï¼‰\r\n      if (!compareAndSetWaitStatus(node, Node.CONDITION, 0))\r\n          // è¿”å›å‡½æ•°è°ƒç”¨å¤„ç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r\n          return false;\r\n      \r\n      // ã€å…ˆæ”¹çŠ¶æ€ï¼Œå†è¿›è¡Œè¿ç§»ã€‘\r\n      // å°†å½“å‰ node å…¥é˜»å¡é˜Ÿåˆ—ï¼Œp æ˜¯å½“å‰èŠ‚ç‚¹åœ¨é˜»å¡é˜Ÿåˆ—çš„ã€å‰é©±èŠ‚ç‚¹ã€‘\r\n      Node p = enq(node);\r\n      int ws = p.waitStatus;\r\n      \r\n      // å¦‚æœå‰é©±èŠ‚ç‚¹è¢«å–æ¶ˆæˆ–è€…ä¸èƒ½è®¾ç½®çŠ¶æ€ä¸º Node.SIGNALï¼Œå°± unpark å–æ¶ˆå½“å‰èŠ‚ç‚¹çº¿ç¨‹çš„é˜»å¡çŠ¶æ€, \r\n      // è®© thread-0 çº¿ç¨‹ç«äº‰é”ï¼Œé‡æ–°åŒæ­¥çŠ¶æ€\r\n      if (ws > 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))\r\n          LockSupport.unpark(node.thread);\r\n      return true;\r\n  }\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719164353059.png\" alt=\"image-20230719164353059\" class=\"scale-80\" />\r\n\r\n* Thread-1 é‡Šæ”¾é”ï¼Œè¿›å…¥ unlock æµç¨‹\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ReadWrite\r\n\r\n#### è¯»å†™é”\r\n\r\nç‹¬å é”ï¼šæŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ï¼Œå¯¹ ReentrantLock å’Œ Synchronized è€Œè¨€éƒ½æ˜¯ç‹¬å é”\r\n\r\nå…±äº«é”ï¼šæŒ‡è¯¥é”å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹æ‰€æŒæœ‰\r\n\r\nReentrantReadWriteLock å…¶**è¯»é”æ˜¯å…±äº«é”ï¼Œå†™é”æ˜¯ç‹¬å é”**\r\n\r\nä½œç”¨ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä¸ºäº†æ»¡è¶³å¹¶å‘é‡ï¼Œè¯»å–å…±äº«èµ„æºåº”è¯¥åŒæ—¶è¿›è¡Œï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™\r\n\r\nä½¿ç”¨è§„åˆ™ï¼š\r\n\r\n* åŠ é”è§£é”æ ¼å¼ï¼š\r\n\r\n  ```java\r\n  r.lock();\r\n  try {\r\n      // ä¸´ç•ŒåŒº\r\n  } finally {\r\n  \tr.unlock();\r\n  }\r\n  ```\r\n\r\n* è¯»-è¯»èƒ½å…±å­˜ã€è¯»-å†™ä¸èƒ½å…±å­˜ã€å†™-å†™ä¸èƒ½å…±å­˜\r\n\r\n* è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡\r\n\r\n* **é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒ**ï¼šæŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ä¼šå¯¼è‡´è·å–å†™é”æ°¸ä¹…ç­‰å¾…ï¼Œéœ€è¦å…ˆé‡Šæ”¾è¯»ï¼Œå†å»è·å¾—å†™\r\n\r\n* **é‡å…¥æ—¶é™çº§æ”¯æŒ**ï¼šæŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”ï¼Œé€ æˆåªæœ‰å½“å‰çº¿ç¨‹ä¼šæŒæœ‰è¯»é”ï¼Œå› ä¸ºå†™é”ä¼šäº’æ–¥å…¶ä»–çš„é”\r\n\r\n  ```java\r\n  w.lock();\r\n  try {\r\n      r.lock();// é™çº§ä¸ºè¯»é”, é‡Šæ”¾å†™é”, è¿™æ ·èƒ½å¤Ÿè®©å…¶å®ƒçº¿ç¨‹è¯»å–ç¼“å­˜\r\n      try {\r\n          // ...\r\n      } finally{\r\n      \tw.unlock();// è¦åœ¨å†™é”é‡Šæ”¾ä¹‹å‰è·å–è¯»é”\r\n      }\r\n  } finally{\r\n  \tr.unlock();\r\n  }\r\n  ```\r\n\r\næ„é€ æ–¹æ³•ï¼š\r\n\r\n* `public ReentrantReadWriteLock()`ï¼šé»˜è®¤æ„é€ æ–¹æ³•ï¼Œéå…¬å¹³é”\r\n* `public ReentrantReadWriteLock(boolean fair)`ï¼štrue ä¸ºå…¬å¹³é”\r\n\r\nå¸¸ç”¨APIï¼š\r\n\r\n* `public ReentrantReadWriteLock.ReadLock readLock()`ï¼šè¿”å›è¯»é”\r\n* `public ReentrantReadWriteLock.WriteLock writeLock()`ï¼šè¿”å›å†™é”\r\n* `public void lock()`ï¼šåŠ é”\r\n* `public void unlock()`ï¼šè§£é”\r\n* `public boolean tryLock()`ï¼šå°è¯•è·å–é”\r\n\r\nè¯»è¯»å¹¶å‘ï¼š\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    ReentrantReadWriteLock rw = new ReentrantReadWriteLock();\r\n    ReentrantReadWriteLock.ReadLock r = rw.readLock();\r\n    ReentrantReadWriteLock.WriteLock w = rw.writeLock();\r\n\r\n    new Thread(() -> {\r\n        r.lock();\r\n        try {\r\n            Thread.sleep(2000);\r\n            System.out.println(\"Thread 1 running \" + new Date());\r\n        } finally {\r\n            r.unlock();\r\n        }\r\n    },\"t1\").start();\r\n    new Thread(() -> {\r\n        r.lock();\r\n        try {\r\n            Thread.sleep(2000);\r\n            System.out.println(\"Thread 2 running \" + new Date());\r\n        } finally {\r\n            r.unlock();\r\n        }\r\n    },\"t2\").start();\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ç¼“å­˜åº”ç”¨\r\n\r\nç¼“å­˜æ›´æ–°æ—¶ï¼Œæ˜¯å…ˆæ¸…ç¼“å­˜è¿˜æ˜¯å…ˆæ›´æ–°æ•°æ®åº“\r\n\r\n* å…ˆæ¸…ç¼“å­˜ï¼šå¯èƒ½é€ æˆåˆšæ¸…ç†ç¼“å­˜è¿˜æ²¡æœ‰æ›´æ–°æ•°æ®åº“ï¼Œçº¿ç¨‹ç›´æ¥æŸ¥è¯¢äº†æ•°æ®åº“æ›´æ–°è¿‡æœŸæ•°æ®åˆ°ç¼“å­˜\r\n\r\n* å…ˆæ›´æ–°æ®åº“ï¼šå¯èƒ½é€ æˆåˆšæ›´æ–°æ•°æ®åº“ï¼Œè¿˜æ²¡æ¸…ç©ºç¼“å­˜å°±æœ‰çº¿ç¨‹ä»ç¼“å­˜æ‹¿åˆ°äº†æ—§æ•°æ®\r\n\r\n* è¡¥å……æƒ…å†µï¼šæŸ¥è¯¢çº¿ç¨‹ A æŸ¥è¯¢æ•°æ®æ—¶æ°å¥½ç¼“å­˜æ•°æ®ç”±äºæ—¶é—´åˆ°æœŸå¤±æ•ˆï¼Œæˆ–æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è¯¢\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719180125357.png\" alt=\"image-20230719180125357\" class=\"scale-70\" />\r\n\r\nå¯ä»¥ä½¿ç”¨è¯»å†™é”è¿›è¡Œæ“ä½œ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å®ç°åŸç†\r\n\r\n##### æˆå‘˜å±æ€§\r\n\r\nè¯»å†™é”ç”¨çš„æ˜¯åŒä¸€ä¸ª Sycn åŒæ­¥å™¨ï¼Œå› æ­¤ç­‰å¾…é˜Ÿåˆ—ã€state ç­‰ä¹Ÿæ˜¯åŒä¸€ä¸ªï¼ŒåŸç†ä¸ ReentrantLock åŠ é”ç›¸æ¯”æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„ï¼Œä¸åŒæ˜¯**å†™é”çŠ¶æ€å äº† state çš„ä½ 16 ä½ï¼Œè€Œè¯»é”ä½¿ç”¨çš„æ˜¯ state çš„é«˜ 16 ä½**\r\n\r\n* è¯»å†™é”ï¼š\r\n\r\n  ```java\r\n  private final ReentrantReadWriteLock.ReadLock readerLock;\t\t\r\n  private final ReentrantReadWriteLock.WriteLock writerLock;\r\n  ```\r\n\r\n* æ„é€ æ–¹æ³•ï¼šé»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œå¯ä»¥æŒ‡å®šå‚æ•°åˆ›å»ºå…¬å¹³é”\r\n\r\n  ```java\r\n  public ReentrantReadWriteLock(boolean fair) {\r\n      // true ä¸ºå…¬å¹³é”\r\n      sync = fair ? new FairSync() : new NonfairSync();\r\n      // è¿™ä¸¤ä¸ª lock å…±äº«åŒä¸€ä¸ª sync å®ä¾‹ï¼Œéƒ½æ˜¯ç”± ReentrantReadWriteLock çš„ sync æä¾›åŒæ­¥å®ç°\r\n      readerLock = new ReadLock(this);\r\n      writerLock = new WriteLock(this);\r\n  }\r\n  ```\r\n\r\nSync ç±»çš„å±æ€§ï¼š\r\n\r\n* ç»Ÿè®¡å˜é‡ï¼š\r\n\r\n  ```java\r\n  // ç”¨æ¥ç§»ä½\r\n  static final int SHARED_SHIFT   = 16;\r\n  // é«˜16ä½çš„1\r\n  static final int SHARED_UNIT    = (1 << SHARED_SHIFT);\r\n  // 65535ï¼Œ16ä¸ª1ï¼Œä»£è¡¨å†™é”çš„æœ€å¤§é‡å…¥æ¬¡æ•°\r\n  static final int MAX_COUNT      = (1 << SHARED_SHIFT) - 1;\r\n  // ä½16ä½æ©ç ï¼š0b 1111 1111 1111 1111ï¼Œç”¨æ¥è·å–å†™é”é‡å…¥çš„æ¬¡æ•°\r\n  static final int EXCLUSIVE_MASK = (1 << SHARED_SHIFT) - 1;\r\n  ```\r\n\r\n* è·å–è¯»å†™é”çš„æ¬¡æ•°ï¼š\r\n\r\n  ```java\r\n  // è·å–è¯»å†™é”çš„è¯»é”åˆ†é…çš„æ€»æ¬¡æ•°\r\n  static int sharedCount(int c)    { return c >>> SHARED_SHIFT; }\r\n  // å†™é”ï¼ˆç‹¬å ï¼‰é”çš„é‡å…¥æ¬¡æ•°\r\n  static int exclusiveCount(int c) { return c & EXCLUSIVE_MASK; }\r\n  ```\r\n\r\n* å†…éƒ¨ç±»ï¼š\r\n\r\n  ```java\r\n  // è®°å½•è¯»é”çº¿ç¨‹è‡ªå·±çš„æŒæœ‰è¯»é”çš„æ•°é‡ï¼ˆé‡å…¥æ¬¡æ•°ï¼‰ï¼Œå› ä¸º state é«˜16ä½è®°å½•çš„æ˜¯å…¨å±€èŒƒå›´å†…æ‰€æœ‰çš„è¯»çº¿ç¨‹è·å–è¯»é”çš„æ€»é‡\r\n  static final class HoldCounter {\r\n      int count = 0;\r\n      // Use id, not reference, to avoid garbage retention\r\n      final long tid = getThreadId(Thread.currentThread());\r\n  }\r\n  // çº¿ç¨‹å®‰å…¨çš„å­˜æ”¾çº¿ç¨‹å„è‡ªçš„ HoldCounter å¯¹è±¡\r\n  static final class ThreadLocalHoldCounter extends ThreadLocal<HoldCounter> {\r\n      public HoldCounter initialValue() {\r\n          return new HoldCounter();\r\n      }\r\n  }\r\n  ```\r\n\r\n* å†…éƒ¨ç±»å®ä¾‹ï¼š\r\n\r\n  ```java\r\n  // å½“å‰çº¿ç¨‹æŒæœ‰çš„å¯é‡å…¥è¯»é”çš„æ•°é‡ï¼Œè®¡æ•°ä¸º 0 æ—¶åˆ é™¤\r\n  private transient ThreadLocalHoldCounter readHolds;\r\n  // è®°å½•æœ€åä¸€ä¸ªè·å–ã€è¯»é”ã€‘çº¿ç¨‹çš„ HoldCounter å¯¹è±¡\r\n  private transient HoldCounter cachedHoldCounter;\r\n  ```\r\n\r\n* é¦–æ¬¡è·å–é”ï¼š\r\n\r\n  ```java\r\n  // ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹\r\n  private transient Thread firstReader = null;\r\n  // è®°å½•è¯¥çº¿ç¨‹æŒæœ‰çš„è¯»é”æ¬¡æ•°ï¼ˆè¯»é”é‡å…¥æ¬¡æ•°ï¼‰\r\n  private transient int firstReaderHoldCount;\r\n  ```\r\n\r\n* Sync æ„é€ æ–¹æ³•ï¼š\r\n\r\n  ```java\r\n  Sync() {\r\n      readHolds = new ThreadLocalHoldCounter();\r\n      // ç¡®ä¿å…¶ä»–çº¿ç¨‹çš„æ•°æ®å¯è§æ€§ï¼Œstate æ˜¯ volatile ä¿®é¥°çš„å˜é‡ï¼Œé‡å†™è¯¥å€¼ä¼šå°†çº¿ç¨‹æœ¬åœ°ç¼“å­˜æ•°æ®ã€åŒæ­¥è‡³ä¸»å­˜ã€‘\r\n      setState(getState()); \r\n  }\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### åŠ é”åŸç†\r\n\r\n* t1 çº¿ç¨‹ï¼šw.lockï¼ˆ**å†™é”**ï¼‰ï¼ŒæˆåŠŸä¸Šé” state = 0_1\r\n\r\n  ```java\r\n  // lock()  -> sync.acquire(1);\r\n  public void lock() {\r\n      sync.acquire(1);\r\n  }\r\n  public final void acquire(int arg) {\r\n      // å°è¯•è·å¾—å†™é”ï¼Œè·å¾—å†™é”å¤±è´¥ï¼Œå°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼ \r\n      if (!tryAcquire(arg) && acquireQueued(addWaiter(Node.EXCLUSIVE), arg))\r\n          selfInterrupt();\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  protected final boolean tryAcquire(int acquires) {\r\n      Thread current = Thread.currentThread();\r\n      int c = getState();\r\n      // è·å¾—ä½ 16 ä½, ä»£è¡¨å†™é”çš„ state è®¡æ•°\r\n      int w = exclusiveCount(c);\r\n      // è¯´æ˜æœ‰è¯»é”æˆ–è€…å†™é”\r\n      if (c != 0) {\r\n          // c != 0 and w == 0 è¡¨ç¤ºæœ‰è¯»é”ï¼Œã€è¯»é”ä¸èƒ½å‡çº§ã€‘ï¼Œç›´æ¥è¿”å› false\r\n          // w != 0 è¯´æ˜æœ‰å†™é”ï¼Œå†™é”çš„æ‹¥æœ‰è€…ä¸æ˜¯è‡ªå·±ï¼Œè·å–å¤±è´¥\r\n          if (w == 0 || current != getExclusiveOwnerThread())\r\n              return false;\r\n          \r\n          // æ‰§è¡Œåˆ°è¿™é‡Œåªæœ‰ä¸€ç§æƒ…å†µï¼šã€å†™é”é‡å…¥ã€‘ï¼Œæ‰€ä»¥ä¸‹é¢å‡ è¡Œä»£ç ä¸å­˜åœ¨å¹¶å‘\r\n          if (w + exclusiveCount(acquires) > MAX_COUNT)\r\n              throw new Error(\"Maximum lock count exceeded\");\r\n          // å†™é”é‡å…¥, è·å¾—é”æˆåŠŸï¼Œæ²¡æœ‰å¹¶å‘ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨ CAS\r\n          setState(c + acquires);\r\n          return true;\r\n      }\r\n      \r\n      // c == 0ï¼Œè¯´æ˜æ²¡æœ‰ä»»ä½•é”ï¼Œåˆ¤æ–­å†™é”æ˜¯å¦è¯¥é˜»å¡ï¼Œæ˜¯ false å°±å°è¯•è·å–é”ï¼Œå¤±è´¥è¿”å› false\r\n      if (writerShouldBlock() || !compareAndSetState(c, c + acquires))\r\n          return false;\r\n      // è·å¾—é”æˆåŠŸï¼Œè®¾ç½®é”çš„æŒæœ‰çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹\r\n      setExclusiveOwnerThread(current);\r\n      return true;\r\n  }\r\n  // éå…¬å¹³é” writerShouldBlock æ€»æ˜¯è¿”å› false, æ— éœ€é˜»å¡\r\n  final boolean writerShouldBlock() {\r\n      return false; \r\n  }\r\n  // å…¬å¹³é”ä¼šæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰(false)æ‰å»ç«äº‰\r\n  final boolean writerShouldBlock() {\r\n      return hasQueuedPredecessors();\r\n  }\r\n  ```\r\n\r\n* t2 r.lockï¼ˆ**è¯»é”**ï¼‰ï¼Œè¿›å…¥ tryAcquireShared æµç¨‹ï¼š\r\n\r\n  * è¿”å› -1 è¡¨ç¤ºå¤±è´¥\r\n  * å¦‚æœè¿”å› 0 è¡¨ç¤ºæˆåŠŸ\r\n  * è¿”å›æ­£æ•°è¡¨ç¤ºè¿˜æœ‰å¤šå°‘åç»§èŠ‚ç‚¹æ”¯æŒå…±äº«æ¨¡å¼ï¼Œè¯»å†™é”è¿”å› 1\r\n\r\n  ```java\r\n  public void lock() {\r\n      sync.acquireShared(1);\r\n  }\r\n  public final void acquireShared(int arg) {\r\n      // tryAcquireShared è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–è¯»é”å¤±è´¥\r\n      if (tryAcquireShared(arg) < 0)\r\n          doAcquireShared(arg);\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // å°è¯•ä»¥å…±äº«æ¨¡å¼è·å–\r\n  protected final int tryAcquireShared(int unused) {\r\n      Thread current = Thread.currentThread();\r\n      int c = getState();\r\n      // exclusiveCount(c) ä»£è¡¨ä½ 16 ä½, å†™é”çš„ stateï¼Œæˆç«‹è¯´æ˜æœ‰çº¿ç¨‹æŒæœ‰å†™é”\r\n      // å†™é”çš„æŒæœ‰è€…ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è·å–è¯»é”å¤±è´¥ï¼Œã€å†™é”å…è®¸é™çº§ã€‘\r\n      if (exclusiveCount(c) != 0 && getExclusiveOwnerThread() != current)\r\n          return -1;\r\n      \r\n      // é«˜ 16 ä½ï¼Œä»£è¡¨è¯»é”çš„ stateï¼Œå…±äº«é”åˆ†é…å‡ºå»çš„æ€»æ¬¡æ•°\r\n      int r = sharedCount(c);\r\n      // è¯»é”æ˜¯å¦åº”è¯¥é˜»å¡\r\n      if (!readerShouldBlock() &&\tr < MAX_COUNT &&\r\n          compareAndSetState(c, c + SHARED_UNIT)) {\t// å°è¯•å¢åŠ è¯»é”è®¡æ•°\r\n          // åŠ é”æˆåŠŸ\r\n          // åŠ é”ä¹‹å‰è¯»é”ä¸º 0ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹\r\n          if (r == 0) {\r\n              firstReader = current;\r\n              firstReaderHoldCount = 1;\r\n          // ç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹æ˜¯è‡ªå·±å°±å‘ç”Ÿäº†è¯»é”é‡å…¥\r\n          } else if (firstReader == current) {\r\n              firstReaderHoldCount++;\r\n          } else {\r\n              // cachedHoldCounter è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹çš„ holdCounter å¯¹è±¡ï¼Œå³æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹\r\n              HoldCounter rh = cachedHoldCounter;\r\n              // è¯´æ˜è¿˜æ²¡è®¾ç½® rh\r\n              if (rh == null || rh.tid != getThreadId(current))\r\n                  // è·å–å½“å‰çº¿ç¨‹çš„é”é‡å…¥çš„å¯¹è±¡ï¼Œèµ‹å€¼ç»™ cachedHoldCounter\r\n                  cachedHoldCounter = rh = readHolds.get();\r\n              // è¿˜æ²¡é‡å…¥\r\n              else if (rh.count == 0)\r\n                  readHolds.set(rh);\r\n              // é‡å…¥ + 1\r\n              rh.count++;\r\n          }\r\n          // è¯»é”åŠ é”æˆåŠŸ\r\n          return 1;\r\n      }\r\n      // é€»è¾‘åˆ°è¿™ åº”è¯¥é˜»å¡ï¼Œæˆ–è€… cas åŠ é”å¤±è´¥\r\n      // ä¼šä¸æ–­å°è¯• for (;;) è·å–è¯»é”, æ‰§è¡Œè¿‡ç¨‹ä¸­æ— é˜»å¡\r\n      return fullTryAcquireShared(current);\r\n  }\r\n  // éå…¬å¹³é” readerShouldBlock åå‘å†™é”ä¸€äº›ï¼Œçœ‹ AQS é˜»å¡é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯å†™é”ï¼Œæ˜¯åˆ™é˜»å¡ï¼Œåä¹‹ä¸é˜»å¡\r\n  // é˜²æ­¢ä¸€ç›´æœ‰è¯»é”çº¿ç¨‹ï¼Œå¯¼è‡´å†™é”çº¿ç¨‹é¥¥é¥¿\r\n  // true åˆ™è¯¥é˜»å¡, false åˆ™ä¸é˜»å¡\r\n  final boolean readerShouldBlock() {\r\n      return apparentlyFirstQueuedIsExclusive();\r\n  }\r\n  final boolean readerShouldBlock() {\r\n      return hasQueuedPredecessors();\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  final int fullTryAcquireShared(Thread current) {\r\n      // å½“å‰è¯»é”çº¿ç¨‹æŒæœ‰çš„è¯»é”æ¬¡æ•°å¯¹è±¡\r\n      HoldCounter rh = null;\r\n      for (;;) {\r\n          int c = getState();\r\n          // è¯´æ˜æœ‰çº¿ç¨‹æŒæœ‰å†™é”\r\n          if (exclusiveCount(c) != 0) {\r\n              // å†™é”ä¸æ˜¯è‡ªå·±åˆ™è·å–é”å¤±è´¥\r\n              if (getExclusiveOwnerThread() != current)\r\n                  return -1;\r\n          } else if (readerShouldBlock()) {\r\n              // æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ firstReaderï¼Œå½“å‰é”æ˜¯è¯»å¿™ç¢ŒçŠ¶æ€ï¼Œè€Œä¸”å½“å‰çº¿ç¨‹ä¹Ÿæ˜¯è¯»é”é‡å…¥\r\n              if (firstReader == current) {\r\n                  // assert firstReaderHoldCount > 0;\r\n              } else {\r\n                  if (rh == null) {\r\n                      // æœ€åä¸€ä¸ªè¯»é”çš„ HoldCounter\r\n                      rh = cachedHoldCounter;\r\n                      // è¯´æ˜å½“å‰çº¿ç¨‹ä¹Ÿä¸æ˜¯æœ€åä¸€ä¸ªè¯»é”\r\n                      if (rh == null || rh.tid != getThreadId(current)) {\r\n                          // è·å–å½“å‰çº¿ç¨‹çš„ HoldCounter\r\n                          rh = readHolds.get();\r\n                          // æ¡ä»¶æˆç«‹è¯´æ˜ HoldCounter å¯¹è±¡æ˜¯ä¸Šä¸€æ­¥ä»£ç æ–°å»ºçš„\r\n                          // å½“å‰çº¿ç¨‹ä¸æ˜¯é”é‡å…¥ï¼Œåœ¨ readerShouldBlock() è¿”å› true æ—¶éœ€è¦å»æ’é˜Ÿ\r\n                          if (rh.count == 0)\r\n                              // é˜²æ­¢å†…å­˜æ³„æ¼\r\n                              readHolds.remove();\r\n                      }\r\n                  }\r\n                  if (rh.count == 0)\r\n                      return -1;\r\n              }\r\n          }\r\n          // è¶Šç•Œåˆ¤æ–­\r\n          if (sharedCount(c) == MAX_COUNT)\r\n              throw new Error(\"Maximum lock count exceeded\");\r\n          // è¯»é”åŠ é”ï¼Œæ¡ä»¶å†…çš„é€»è¾‘ä¸ tryAcquireShared ç›¸åŒ\r\n          if (compareAndSetState(c, c + SHARED_UNIT)) {\r\n              if (sharedCount(c) == 0) {\r\n                  firstReader = current;\r\n                  firstReaderHoldCount = 1;\r\n              } else if (firstReader == current) {\r\n                  firstReaderHoldCount++;\r\n              } else {\r\n                  if (rh == null)\r\n                      rh = cachedHoldCounter;\r\n                  if (rh == null || rh.tid != getThreadId(current))\r\n                      rh = readHolds.get();\r\n                  else if (rh.count == 0)\r\n                      readHolds.set(rh);\r\n                  rh.count++;\r\n                  cachedHoldCounter = rh; // cache for release\r\n              }\r\n              return 1;\r\n          }\r\n      }\r\n  }\r\n  ```\r\n\r\n* è·å–è¯»é”å¤±è´¥ï¼Œè¿›å…¥ `sync.doAcquireShared(1)` æµç¨‹å¼€å§‹é˜»å¡ï¼Œé¦–å…ˆä¹Ÿæ˜¯è°ƒç”¨ addWaiter æ·»åŠ èŠ‚ç‚¹ï¼Œä¸åŒä¹‹å¤„åœ¨äºèŠ‚ç‚¹è¢«è®¾ç½®ä¸º `Node.SHARED` æ¨¡å¼è€Œé `Node.EXCLUSIVE` æ¨¡å¼ï¼Œæ³¨æ„æ­¤æ—¶ t2 ä»å¤„äºæ´»è·ƒçŠ¶æ€\r\n\r\n  ```java\r\n  private void doAcquireShared(int arg) {\r\n      // å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºå…±äº«æ¨¡å¼\r\n      final Node node = addWaiter(Node.SHARED);\r\n      boolean failed = true;\r\n      try {\r\n          boolean interrupted = false;\r\n          for (;;) {\r\n              // è·å–å‰é©±èŠ‚ç‚¹\r\n              final Node p = node.predecessor();\r\n              // å¦‚æœå‰é©±èŠ‚ç‚¹å°±å¤´èŠ‚ç‚¹å°±å»å°è¯•è·å–é”\r\n              if (p == head) {\r\n                  // å†ä¸€æ¬¡å°è¯•è·å–è¯»é”\r\n                  int r = tryAcquireShared(arg);\r\n                  // r >= 0 è¡¨ç¤ºè·å–æˆåŠŸ\r\n                  if (r >= 0) {\r\n                      //ã€è¿™é‡Œä¼šè®¾ç½®è‡ªå·±ä¸ºå¤´èŠ‚ç‚¹ï¼Œå”¤é†’ç›¸è¿çš„ååºçš„å…±äº«èŠ‚ç‚¹ã€‘\r\n                      setHeadAndPropagate(node, r);\r\n                      p.next = null; // help GC\r\n                      if (interrupted)\r\n                          selfInterrupt();\r\n                      failed = false;\r\n                      return;\r\n                  }\r\n              }\r\n              // æ˜¯å¦åœ¨è·å–è¯»é”å¤±è´¥æ—¶é˜»å¡      \t\t\t\t\t park å½“å‰çº¿ç¨‹\r\n              if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())\r\n                  interrupted = true;\r\n          }\r\n      } finally {\r\n          if (failed)\r\n              cancelAcquire(node);\r\n      }\r\n  }\r\n  ```\r\n\r\n  å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œåœ¨ doAcquireShared å†… `for (;;)` å¾ªç¯ä¸€æ¬¡ï¼ŒshouldParkAfterFailedAcquire å†…æŠŠå‰é©±èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º -1ï¼Œå† for (;;) å¾ªç¯ä¸€æ¬¡å°è¯• tryAcquireSharedï¼Œä¸æˆåŠŸåœ¨ parkAndCheckInterrupt() å¤„ park\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719190714986.png\" alt=\"image-20230719190714986\" class=\"scale-50\" />\r\n\r\n* è¿™ç§çŠ¶æ€ä¸‹ï¼Œå‡è®¾åˆæœ‰ `t3 r.lock`ï¼Œ`t4 w.lock`ï¼Œè¿™æœŸé—´ t1 ä»ç„¶æŒæœ‰é”ï¼Œå°±å˜æˆäº†ä¸‹é¢çš„æ ·å­\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719192612370.png\" alt=\"image-20230719192612370\" class=\"scale-80\" />\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### è§£é”åŸç†\r\n\r\n* t1 `w.unlock`ï¼Œ å†™é”è§£é”\r\n\r\n  ```java\r\n  public void unlock() {\r\n      // é‡Šæ”¾é”\r\n      sync.release(1);\r\n  }\r\n  public final boolean release(int arg) {\r\n      // å°è¯•é‡Šæ”¾é”\r\n      if (tryRelease(arg)) {\r\n          Node h = head;\r\n          // å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºå¹¶ä¸”ä¸æ˜¯ç­‰å¾…çŠ¶æ€ä¸æ˜¯ 0ï¼Œå”¤é†’åç»§çš„éå–æ¶ˆèŠ‚ç‚¹\r\n          if (h != null && h.waitStatus != 0)\r\n              unparkSuccessor(h);\r\n          return true;\r\n      }\r\n      return false;\r\n  }\r\n  protected final boolean tryRelease(int releases) {\r\n      if (!isHeldExclusively())\r\n          throw new IllegalMonitorStateException();\r\n      int nextc = getState() - releases;\r\n      // å› ä¸ºå¯é‡å…¥çš„åŸå› , å†™é”è®¡æ•°ä¸º 0, æ‰ç®—é‡Šæ”¾æˆåŠŸ\r\n      boolean free = exclusiveCount(nextc) == 0;\r\n      if (free)\r\n          setExclusiveOwnerThread(null);\r\n      setState(nextc);\r\n      return free;\r\n  }\r\n  ```\r\n\r\n* å”¤é†’æµç¨‹ `sync.unparkSuccessor`ï¼Œè¿™æ—¶ t2 åœ¨ doAcquireShared çš„ parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œï¼Œç»§ç»­å¾ªç¯ï¼Œæ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€\r\n\r\n* æ¥ä¸‹æ¥ t2 è°ƒç”¨ `setHeadAndPropagate(node, 1)`ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼›è¿˜ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ sharedï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ `doReleaseShared()` å°† head çš„çŠ¶æ€ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ—¶ t3 åœ¨ doAcquireShared å†… `parkAndCheckInterrupt()` å¤„æ¢å¤è¿è¡Œï¼Œ**å”¤é†’è¿ç»­çš„æ‰€æœ‰çš„å…±äº«èŠ‚ç‚¹**\r\n\r\n  ```java\r\n  private void setHeadAndPropagate(Node node, int propagate) {\r\n      Node h = head; \r\n      // è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹\r\n      setHead(node);\r\n      // propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰ï¼Œä¸º 0 å°±æ²¡æœ‰èµ„æº\r\n      if (propagate > 0 || h == null || h.waitStatus < 0 ||\r\n          (h = head) == null || h.waitStatus < 0) {\r\n          // è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r\n          Node s = node.next;\r\n          // å¦‚æœå½“å‰æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ã€ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ã€‘\r\n          if (s == null || s.isShared())\r\n              // å”¤é†’åç»§èŠ‚ç‚¹\r\n              doReleaseShared();\r\n      }\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  private void doReleaseShared() {\r\n      // å¦‚æœ head.waitStatus == Node.SIGNAL ==> 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark\r\n  \t// å¦‚æœ head.waitStatus == 0 ==> Node.PROPAGATE\r\n      for (;;) {\r\n          Node h = head;\r\n          if (h != null && h != tail) {\r\n              int ws = h.waitStatus;\r\n              // SIGNAL å”¤é†’åç»§\r\n              if (ws == Node.SIGNAL) {\r\n                  // å› ä¸ºè¯»é”å…±äº«ï¼Œå¦‚æœå…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨é‡Šæ”¾è¯»é”ï¼Œé‚£ä¹ˆéœ€è¦å°† waitStatus å…ˆæ”¹ä¸º 0\r\n              \t// é˜²æ­¢ unparkSuccessor è¢«å¤šæ¬¡æ‰§è¡Œ\r\n                  if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))\r\n                      continue;  \r\n                  // å”¤é†’åç»§èŠ‚ç‚¹\r\n                  unparkSuccessor(h);\r\n              }\r\n              // å¦‚æœå·²ç»æ˜¯ 0 äº†ï¼Œæ”¹ä¸º -3ï¼Œç”¨æ¥è§£å†³ä¼ æ’­æ€§\r\n              else if (ws == 0 && !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))\r\n                  continue;                \r\n          }\r\n          // æ¡ä»¶ä¸æˆç«‹è¯´æ˜è¢«å”¤é†’çš„èŠ‚ç‚¹éå¸¸ç§¯æï¼Œç›´æ¥å°†è‡ªå·±è®¾ç½®ä¸ºäº†æ–°çš„ headï¼Œ\r\n          // æ­¤æ—¶å”¤é†’å®ƒçš„èŠ‚ç‚¹ï¼ˆå‰é©±ï¼‰æ‰§è¡Œ h == head ä¸æˆç«‹ï¼Œæ‰€ä»¥ä¸ä¼šè·³å‡ºå¾ªç¯ï¼Œä¼šç»§ç»­å”¤é†’æ–°çš„ head èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹\r\n          if (h == head)                   \r\n              break;\r\n      }\r\n  }\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719192838777.png\" alt=\"image-20230719192838777\" class=\"scale-70\" />\r\n\r\n* ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ shared äº†ï¼Œå› æ­¤ä¸ä¼šç»§ç»­å”¤é†’ t4 æ‰€åœ¨èŠ‚ç‚¹\r\n\r\n* t2 è¯»é”è§£é”ï¼Œè¿›å…¥ `sync.releaseShared(1)` ä¸­ï¼Œè°ƒç”¨ `tryReleaseShared(1)` è®©è®¡æ•°å‡ä¸€ï¼Œä½†è®¡æ•°è¿˜ä¸ä¸ºé›¶ï¼Œt3 åŒæ ·è®©è®¡æ•°å‡ä¸€ï¼Œè®¡æ•°ä¸ºé›¶ï¼Œè¿›å…¥`doReleaseShared()` å°†å¤´èŠ‚ç‚¹ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r\n\r\n  ```java\r\n  public void unlock() {\r\n      sync.releaseShared(1);\r\n  }\r\n  public final boolean releaseShared(int arg) {\r\n      if (tryReleaseShared(arg)) {\r\n          doReleaseShared();\r\n          return true;\r\n      }\r\n      return false;\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  protected final boolean tryReleaseShared(int unused) {\r\n  \r\n      for (;;) {\r\n          int c = getState();\r\n          int nextc = c - SHARED_UNIT;\r\n          // è¯»é”çš„è®¡æ•°ä¸ä¼šå½±å“å…¶å®ƒè·å–è¯»é”çº¿ç¨‹, ä½†ä¼šå½±å“å…¶å®ƒè·å–å†™é”çº¿ç¨‹ï¼Œè®¡æ•°ä¸º 0 æ‰æ˜¯çœŸæ­£é‡Šæ”¾\r\n          if (compareAndSetState(c, nextc))\r\n              // è¿”å›æ˜¯å¦å·²ç»å®Œå…¨é‡Šæ”¾äº† \r\n              return nextc == 0;\r\n      }\r\n  }\r\n  ```\r\n\r\n* t4 åœ¨ acquireQueued ä¸­ parkAndCheckInterrupt å¤„æ¢å¤è¿è¡Œï¼Œå†æ¬¡ `for (;;)` è¿™æ¬¡è‡ªå·±æ˜¯å¤´èŠ‚ç‚¹çš„ä¸´èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–èŠ‚ç‚¹ç«äº‰ï¼Œ`tryAcquire(1)` æˆåŠŸï¼Œä¿®æ”¹å¤´ç»“ç‚¹ï¼Œæµç¨‹ç»“æŸ\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719192920793.png\" alt=\"image-20230719192920793\" class=\"scale-70\" />\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### Stamped\r\n\r\nStampedLockï¼šè¯»å†™é”ï¼Œè¯¥ç±»è‡ª JDK 8 åŠ å…¥ï¼Œæ˜¯ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–è¯»æ€§èƒ½\r\n\r\nç‰¹ç‚¹ï¼š\r\n\r\n* åœ¨ä½¿ç”¨è¯»é”ã€å†™é”æ—¶éƒ½å¿…é¡»é…åˆæˆ³ä½¿ç”¨\r\n\r\n* StampedLock ä¸æ”¯æŒæ¡ä»¶å˜é‡\r\n* StampedLock **ä¸æ”¯æŒé‡å…¥**\r\n\r\nåŸºæœ¬ç”¨æ³•\r\n\r\n* åŠ è§£è¯»é”ï¼š\r\n\r\n  ```java\r\n  long stamp = lock.readLock();\r\n  lock.unlockRead(stamp);\t\t\t// ç±»ä¼¼äº unparkï¼Œè§£æŒ‡å®šçš„é”\r\n  ```\r\n\r\n* åŠ è§£å†™é”ï¼š\r\n\r\n  ```java\r\n  long stamp = lock.writeLock();\r\n  lock.unlockWrite(stamp);\r\n  ```\r\n\r\n* ä¹è§‚è¯»ï¼ŒStampedLock æ”¯æŒ `tryOptimisticRead()` æ–¹æ³•ï¼Œè¯»å–å®Œæ¯•ååšä¸€æ¬¡**æˆ³æ ¡éªŒ**ï¼Œå¦‚æœæ ¡éªŒé€šè¿‡ï¼Œè¡¨ç¤ºè¿™æœŸé—´æ²¡æœ‰å…¶ä»–çº¿ç¨‹çš„å†™æ“ä½œï¼Œæ•°æ®å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¦‚æœæ ¡éªŒæ²¡é€šè¿‡ï¼Œéœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§\r\n\r\n  ```java\r\n  long stamp = lock.tryOptimisticRead();\r\n  // éªŒæˆ³\r\n  if(!lock.validate(stamp)){\r\n  \t// é”å‡çº§\r\n  }\r\n  ```\r\n\r\næä¾›ä¸€ä¸ªæ•°æ®å®¹å™¨ç±»å†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„ read() æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„ write() æ–¹æ³•ï¼š\r\n\r\n* è¯»-è¯»å¯ä»¥ä¼˜åŒ–\r\n* è¯»-å†™ä¼˜åŒ–è¯»ï¼Œè¡¥åŠ è¯»é”\r\n\r\n```java\r\npublic static void main(String[] args) throws InterruptedException {\r\n    DataContainerStamped dataContainer = new DataContainerStamped(1);\r\n    new Thread(() -> {\r\n    \tdataContainer.read(1000);\r\n    },\"t1\").start();\r\n    Thread.sleep(500);\r\n    \r\n    new Thread(() -> {\r\n        dataContainer.write(1000);\r\n    },\"t2\").start();\r\n}\r\n\r\nclass DataContainerStamped {\r\n    private int data;\r\n    private final StampedLock lock = new StampedLock();\r\n\r\n    public int read(int readTime) throws InterruptedException {\r\n        long stamp = lock.tryOptimisticRead();\r\n        System.out.println(new Date() + \" optimistic read locking\" + stamp);\r\n        Thread.sleep(readTime);\r\n        // æˆ³æœ‰æ•ˆï¼Œç›´æ¥è¿”å›æ•°æ®\r\n        if (lock.validate(stamp)) {\r\n            Sout(new Date() + \" optimistic read finish...\" + stamp);\r\n            return data;\r\n        }\r\n\r\n        // è¯´æ˜å…¶ä»–çº¿ç¨‹æ›´æ”¹äº†æˆ³ï¼Œéœ€è¦é”å‡çº§äº†ï¼Œä»ä¹è§‚è¯»å‡çº§åˆ°è¯»é”\r\n        System.out.println(new Date() + \" updating to read lock\" + stamp);\r\n        try {\r\n            stamp = lock.readLock();\r\n            System.out.println(new Date() + \" read lock\" + stamp);\r\n            Thread.sleep(readTime);\r\n            System.out.println(new Date() + \" read finish...\" + stamp);\r\n            return data;\r\n        } finally {\r\n            System.out.println(new Date() + \" read unlock \" +  stamp);\r\n            lock.unlockRead(stamp);\r\n        }\r\n    }\r\n\r\n    public void write(int newData) {\r\n        long stamp = lock.writeLock();\r\n        System.out.println(new Date() + \" write lock \" + stamp);\r\n        try {\r\n            Thread.sleep(2000);\r\n            this.data = newData;\r\n        } catch (InterruptedException e) {\r\n            e.printStackTrace();\r\n        } finally {\r\n            System.out.println(new Date() + \" write unlock \" + stamp);\r\n            lock.unlockWrite(stamp);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### CountDown\r\n\r\n#### åŸºæœ¬ä½¿ç”¨\r\n\r\nCountDownLatchï¼šè®¡æ•°å™¨ï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥åä½œï¼Œ**ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ**\r\n\r\næ„é€ å™¨ï¼š\r\n\r\n* `public CountDownLatch(int count)`ï¼šåˆå§‹åŒ–å”¤é†’éœ€è¦çš„ down å‡ æ­¥\r\n\r\nå¸¸ç”¨APIï¼š\r\n\r\n* `public void await() `ï¼šè®©å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œå¿…é¡» down å®Œåˆå§‹åŒ–çš„æ•°å­—æ‰å¯ä»¥è¢«å”¤é†’ï¼Œå¦åˆ™è¿›å…¥æ— é™ç­‰å¾…\r\n* `public void countDown()`ï¼šè®¡æ•°å™¨è¿›è¡Œå‡ 1ï¼ˆdown 1ï¼‰\r\n\r\nåº”ç”¨ï¼šåŒæ­¥ç­‰å¾…å¤šä¸ª Rest è¿œç¨‹è°ƒç”¨ç»“æŸ\r\n\r\n```java\r\n// LOL 10äººè¿›å…¥æ¸¸æˆå€’è®¡æ—¶\r\npublic static void main(String[] args) throws InterruptedException {\r\n    CountDownLatch latch = new CountDownLatch(10);\r\n    ExecutorService service = Executors.newFixedThreadPool(10);\r\n    String[] all = new String[10];\r\n    Random random = new Random();\r\n\r\n    for (int j = 0; j < 10; j++) {\r\n        int finalJ = j;//å¸¸é‡\r\n        service.submit(() -> {\r\n            for (int i = 0; i <= 100; i++) {\r\n                Thread.sleep(random.nextInt(100));\t//éšæœºä¼‘çœ \r\n                all[finalJ] = i + \"%\";\r\n                System.out.print(\"\\r\" + Arrays.toString(all));\t// \\rä»£è¡¨è¦†ç›–\r\n            }\r\n            latch.countDown();\r\n        });\r\n    }\r\n    latch.await();\r\n    System.out.println(\"\\næ¸¸æˆå¼€å§‹\");\r\n    service.shutdown();\r\n}\r\n/*\r\n[100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%]\r\næ¸¸æˆå¼€å§‹\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å®ç°åŸç†\r\n\r\né˜»å¡ç­‰å¾…ï¼š\r\n\r\n* çº¿ç¨‹è°ƒç”¨ await() ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆä»»åŠ¡ï¼šæ”¯æŒæ‰“æ–­\r\n\r\n  ```java\r\n  public void await() throws InterruptedException {\r\n      sync.acquireSharedInterruptibly(1);\r\n  }\r\n  // AbstractQueuedSynchronizer#acquireSharedInterruptibly\r\n  public final void acquireSharedInterruptibly(int arg) throws InterruptedException {\r\n      // åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼ŒæŠ›å‡ºæ‰“æ–­å¼‚å¸¸\r\n      if (Thread.interrupted())\r\n          throw new InterruptedException();\r\n      // å°è¯•è·å–å…±äº«é”ï¼Œæ¡ä»¶æˆç«‹è¯´æ˜ state > 0ï¼Œæ­¤æ—¶çº¿ç¨‹å…¥é˜Ÿé˜»å¡ç­‰å¾…ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹è·å–å…±äº«èµ„æº\r\n      // æ¡ä»¶ä¸æˆç«‹è¯´æ˜ state = 0ï¼Œæ­¤æ—¶ä¸éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œç›´æ¥ç»“æŸå‡½æ•°è°ƒç”¨\r\n      if (tryAcquireShared(arg) < 0)\r\n          doAcquireSharedInterruptibly(arg);\r\n  }\r\n  // CountDownLatch.Sync#tryAcquireShared\r\n  protected int tryAcquireShared(int acquires) {\r\n      return (getState() == 0) ? 1 : -1;\r\n  }\r\n  ```\r\n\r\n* çº¿ç¨‹è¿›å…¥ AbstractQueuedSynchronizer#doAcquireSharedInterruptibly å‡½æ•°é˜»å¡æŒ‚èµ·ï¼Œç­‰å¾… latch å˜ä¸º 0ï¼š\r\n\r\n  ```java\r\n  private void doAcquireSharedInterruptibly(int arg) throws InterruptedException {\r\n      // å°†è°ƒç”¨latch.await()æ–¹æ³•çš„çº¿ç¨‹ åŒ…è£…æˆ SHARED ç±»å‹çš„ node åŠ å…¥åˆ° AQS çš„é˜»å¡é˜Ÿåˆ—ä¸­\r\n      final Node node = addWaiter(Node.SHARED);\r\n      boolean failed = true;\r\n      try {\r\n          for (;;) {\r\n              // è·å–å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹\r\n              final Node p = node.predecessor();\r\n              // å‰é©±èŠ‚ç‚¹æ—¶å¤´èŠ‚ç‚¹å°±å¯ä»¥å°è¯•è·å–é”\r\n              if (p == head) {\r\n                  // å†æ¬¡å°è¯•è·å–é”ï¼Œè·å–æˆåŠŸè¿”å› 1\r\n                  int r = tryAcquireShared(arg);\r\n                  if (r >= 0) {\r\n                      // è·å–é”æˆåŠŸï¼Œè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸º head èŠ‚ç‚¹ï¼Œå¹¶ä¸”å‘åä¼ æ’­\r\n                      setHeadAndPropagate(node, r);\r\n                      p.next = null; // help GC\r\n                      failed = false;\r\n                      return;\r\n                  }\r\n              }\r\n              // é˜»å¡åœ¨è¿™é‡Œ\r\n              if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())\r\n                  throw new InterruptedException();\r\n          }\r\n      } finally {\r\n          // é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­åæŠ›å‡ºå¼‚å¸¸ï¼Œè¿›å…¥å–æ¶ˆèŠ‚ç‚¹çš„é€»è¾‘\r\n          if (failed)\r\n              cancelAcquire(node);\r\n      }\r\n  }\r\n  ```\r\n\r\n* è·å–å…±äº«é”æˆåŠŸï¼Œè¿›å…¥å”¤é†’é˜»å¡é˜Ÿåˆ—ä¸­ä¸å¤´èŠ‚ç‚¹ç›¸è¿çš„ SHARED æ¨¡å¼çš„èŠ‚ç‚¹ï¼š\r\n\r\n  ```java\r\n  private void setHeadAndPropagate(Node node, int propagate) {\r\n      Node h = head;\r\n      // å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„ head èŠ‚ç‚¹ï¼Œå‰é©±èŠ‚ç‚¹å’ŒæŒæœ‰çº¿ç¨‹ç½®ä¸º null\r\n      setHead(node);\r\n  \t// propagate = 1ï¼Œæ¡ä»¶ä¸€æˆç«‹\r\n      if (propagate > 0 || h == null || h.waitStatus < 0 || (h = head) == null || h.waitStatus < 0) {\r\n          // è·å–å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹\r\n          Node s = node.next;\r\n          // å½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹æ—¶ next ä¸º nullï¼Œæˆ–è€…åç»§èŠ‚ç‚¹æ˜¯ SHARED å…±äº«æ¨¡å¼\r\n          if (s == null || s.isShared())\r\n              // å”¤é†’æ‰€æœ‰çš„ç­‰å¾…å…±äº«é”çš„èŠ‚ç‚¹\r\n              doReleaseShared();\r\n      }\r\n  }\r\n  ```\r\n\r\n  \r\n\r\nè®¡æ•°å‡ä¸€ï¼š\r\n\r\n* çº¿ç¨‹è¿›å…¥ countDown() å®Œæˆè®¡æ•°å™¨å‡ä¸€ï¼ˆé‡Šæ”¾é”ï¼‰çš„æ“ä½œ\r\n\r\n  ```java\r\n  public void countDown() {\r\n      sync.releaseShared(1);\r\n  }\r\n  public final boolean releaseShared(int arg) {\r\n      // å°è¯•é‡Šæ”¾å…±äº«é”\r\n      if (tryReleaseShared(arg)) {\r\n          // é‡Šæ”¾é”æˆåŠŸå¼€å§‹å”¤é†’é˜»å¡èŠ‚ç‚¹\r\n          doReleaseShared();\r\n          return true;\r\n      }\r\n      return false;\r\n  }\r\n  ```\r\n\r\n* æ›´æ–° state å€¼ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡ï¼Œstate å€¼å‡ä¸€ï¼Œå½“ state -1 æ­£å¥½ä¸º 0 æ—¶ï¼Œè¿”å› true\r\n\r\n  ```java\r\n  protected boolean tryReleaseShared(int releases) {\r\n      for (;;) {\r\n          int c = getState();\r\n          // æ¡ä»¶æˆç«‹è¯´æ˜å‰é¢ã€å·²ç»æœ‰çº¿ç¨‹è§¦å‘å”¤é†’æ“ä½œã€‘äº†ï¼Œè¿™é‡Œè¿”å› false\r\n          if (c == 0)\r\n              return false;\r\n          // è®¡æ•°å™¨å‡ä¸€\r\n          int nextc = c-1;\r\n          if (compareAndSetState(c, nextc))\r\n              // è®¡æ•°å™¨ä¸º 0 æ—¶è¿”å› true\r\n              return nextc == 0;\r\n      }\r\n  }\r\n  ```\r\n\r\n* state = 0 æ—¶ï¼Œå½“å‰çº¿ç¨‹éœ€è¦æ‰§è¡Œ**å”¤é†’é˜»å¡èŠ‚ç‚¹çš„ä»»åŠ¡**\r\n\r\n  ```java\r\n  private void doReleaseShared() {\r\n      for (;;) {\r\n          Node h = head;\r\n          // åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ˜¯ç©ºé˜Ÿåˆ—\r\n          if (h != null && h != tail) {\r\n              int ws = h.waitStatus;\r\n              // å¤´èŠ‚ç‚¹çš„çŠ¶æ€ä¸º signalï¼Œè¯´æ˜åç»§èŠ‚ç‚¹æ²¡æœ‰è¢«å”¤é†’è¿‡\r\n              if (ws == Node.SIGNAL) {\r\n                  // cas è®¾ç½®å¤´èŠ‚ç‚¹çš„çŠ¶æ€ä¸º 0ï¼Œè®¾ç½®å¤±è´¥ç»§ç»­è‡ªæ—‹\r\n                  if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))\r\n                      continue;\r\n                  // å”¤é†’åç»§èŠ‚ç‚¹\r\n                  unparkSuccessor(h);\r\n              }\r\n              // å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å·²ç»è®¾ç½®äº†å¤´èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œé‡æ–°è®¾ç½®ä¸º PROPAGATE ä¼ æ’­å±æ€§\r\n              else if (ws == 0 && !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))\r\n                  continue;\r\n          }\r\n          // æ¡ä»¶ä¸æˆç«‹è¯´æ˜è¢«å”¤é†’çš„èŠ‚ç‚¹éå¸¸ç§¯æï¼Œç›´æ¥å°†è‡ªå·±è®¾ç½®ä¸ºäº†æ–°çš„headï¼Œ\r\n          // æ­¤æ—¶å”¤é†’å®ƒçš„èŠ‚ç‚¹ï¼ˆå‰é©±ï¼‰æ‰§è¡Œ h == head ä¸æˆç«‹ï¼Œæ‰€ä»¥ä¸ä¼šè·³å‡ºå¾ªç¯ï¼Œä¼šç»§ç»­å”¤é†’æ–°çš„ head èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹\r\n          if (h == head)\r\n              break;\r\n      }\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### CyclicBarrier\r\n\r\n#### åŸºæœ¬ä½¿ç”¨\r\n\r\nCyclicBarrierï¼šå¾ªç¯å±éšœï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åä½œï¼Œç­‰å¾…çº¿ç¨‹æ»¡è¶³æŸä¸ªè®¡æ•°ï¼Œæ‰èƒ½è§¦å‘è‡ªå·±æ‰§è¡Œ\r\n\r\nå¸¸ç”¨æ–¹æ³•ï¼š\r\n\r\n* `public CyclicBarrier(int parties, Runnable barrierAction)`ï¼šç”¨äºåœ¨çº¿ç¨‹åˆ°è¾¾å±éšœ parties æ—¶ï¼Œæ‰§è¡Œ barrierAction\r\n  * partiesï¼šä»£è¡¨å¤šå°‘ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœå¼€å§‹è§¦å‘çº¿ç¨‹ä»»åŠ¡\r\n  * barrierActionï¼šçº¿ç¨‹ä»»åŠ¡\r\n* `public int await()`ï¼šçº¿ç¨‹è°ƒç”¨ await æ–¹æ³•é€šçŸ¥ CyclicBarrier æœ¬çº¿ç¨‹å·²ç»åˆ°è¾¾å±éšœ\r\n\r\nä¸ CountDownLatch çš„åŒºåˆ«ï¼šCyclicBarrier æ˜¯å¯ä»¥é‡ç”¨çš„\r\n\r\nåº”ç”¨ï¼šå¯ä»¥å®ç°å¤šçº¿ç¨‹ä¸­ï¼ŒæŸä¸ªä»»åŠ¡åœ¨ç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä»¥åè§¦å‘\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    ExecutorService service = Executors.newFixedThreadPool(2);\r\n    CyclicBarrier barrier = new CyclicBarrier(2, () -> {\r\n        System.out.println(\"task1 task2 finish...\");\r\n    });\r\n\r\n    for (int i = 0; i < 3; i++) { // å¾ªç¯é‡ç”¨\r\n        service.submit(() -> {\r\n            System.out.println(\"task1 begin...\");\r\n            try {\r\n                Thread.sleep(1000);\r\n                barrier.await();    // 2 - 1 = 1\r\n            } catch (InterruptedException | BrokenBarrierException e) {\r\n                e.printStackTrace();\r\n            }\r\n        });\r\n\r\n        service.submit(() -> {\r\n            System.out.println(\"task2 begin...\");\r\n            try {\r\n                Thread.sleep(2000);\r\n                barrier.await();    // 1 - 1 = 0\r\n            } catch (InterruptedException | BrokenBarrierException e) {\r\n                e.printStackTrace();\r\n            }\r\n        });\r\n    }\r\n    service.shutdown();\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å®ç°åŸç†\r\n\r\n##### æˆå‘˜å±æ€§\r\n\r\n* å…¨å±€é”ï¼šåˆ©ç”¨å¯é‡å…¥é”å®ç°çš„å·¥å…·ç±»\r\n\r\n  ```java\r\n  // barrier å®ç°æ˜¯ä¾èµ–äºConditionæ¡ä»¶é˜Ÿåˆ—ï¼Œcondition æ¡ä»¶é˜Ÿåˆ—å¿…é¡»ä¾èµ–lockæ‰èƒ½ä½¿ç”¨\r\n  private final ReentrantLock lock = new ReentrantLock();\r\n  // çº¿ç¨‹æŒ‚èµ·å®ç°ä½¿ç”¨çš„ condition é˜Ÿåˆ—ï¼Œå½“å‰ä»£æ‰€æœ‰çº¿ç¨‹åˆ°ä½ï¼Œè¿™ä¸ªæ¡ä»¶é˜Ÿåˆ—å†…çš„çº¿ç¨‹æ‰ä¼šè¢«å”¤é†’\r\n  private final Condition trip = lock.newCondition();\r\n  ```\r\n\r\n* çº¿ç¨‹æ•°é‡ï¼š\r\n\r\n  ```java\r\n  private final int parties;\t// ä»£è¡¨å¤šå°‘ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœå¼€å§‹è§¦å‘çº¿ç¨‹ä»»åŠ¡\r\n  private int count;\t\t\t// è¡¨ç¤ºå½“å‰â€œä»£â€è¿˜æœ‰å¤šå°‘ä¸ªçº¿ç¨‹æœªåˆ°ä½ï¼Œåˆå§‹å€¼ä¸º parties\r\n  ```\r\n\r\n* å½“å‰ä»£ä¸­æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°ä½åè¦æ‰§è¡Œçš„äº‹ä»¶ï¼š\r\n\r\n  ```java\r\n  private final Runnable barrierCommand;\r\n  ```\r\n\r\n* ä»£ï¼š\r\n\r\n  ```java\r\n  // è¡¨ç¤º barrier å¯¹è±¡å½“å‰ ä»£\r\n  private Generation generation = new Generation();\r\n  private static class Generation {\r\n      // è¡¨ç¤ºå½“å‰â€œä»£â€æ˜¯å¦è¢«æ‰“ç ´ï¼Œå¦‚æœè¢«æ‰“ç ´å†æ¥åˆ°è¿™ä¸€ä»£çš„çº¿ç¨‹ å°±ä¼šç›´æ¥æŠ›å‡º BrokenException å¼‚å¸¸\r\n      // ä¸”åœ¨è¿™ä¸€ä»£æŒ‚èµ·çš„çº¿ç¨‹éƒ½ä¼šè¢«å”¤é†’ï¼Œç„¶åæŠ›å‡º BrokerException å¼‚å¸¸ã€‚\r\n      boolean broken = false;\r\n  }\r\n  ```\r\n\r\n* æ„é€ æ–¹æ³•ï¼š\r\n\r\n  ```java\r\n  public CyclicBarrie(int parties, Runnable barrierAction) {\r\n      // å› ä¸ºå°äºç­‰äº 0 çš„ barrier æ²¡æœ‰ä»»ä½•æ„ä¹‰\r\n      if (parties <= 0) throw new IllegalArgumentException();\r\n  \r\n      this.parties = parties;\r\n      this.count = parties;\r\n      // å¯ä»¥ä¸º null\r\n      this.barrierCommand = barrierAction;\r\n  }\r\n  ```\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824174620257.png\" alt=\"image-20230824174620257\" class=\"scale-80\" />\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æˆå‘˜æ–¹æ³•\r\n\r\n* await()ï¼šé˜»å¡ç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°ä½\r\n\r\n  ```java\r\n  public int await() throws InterruptedException, BrokenBarrierException {\r\n      try {\r\n          return dowait(false, 0L);\r\n      } catch (TimeoutException toe) {\r\n          throw new Error(toe); // cannot happen\r\n      }\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // timedï¼šè¡¨ç¤ºå½“å‰è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦æŒ‡å®šäº†è¶…æ—¶æ—¶é•¿ï¼Œå¦‚æœ true è¡¨ç¤ºçº¿ç¨‹æ˜¯å“åº”è¶…æ—¶çš„\r\n  // nanosï¼šçº¿ç¨‹ç­‰å¾…è¶…æ—¶æ—¶é•¿ï¼Œå•ä½æ˜¯çº³ç§’\r\n  private int dowait(boolean timed, long nanos) {\r\n      final ReentrantLock lock = this.lock;\r\n      // åŠ é”\r\n      lock.lock();\r\n      try {\r\n          // è·å–å½“å‰ä»£\r\n          final Generation g = generation;\r\n  \r\n          // ã€å¦‚æœå½“å‰ä»£æ˜¯å·²ç»è¢«æ‰“ç ´çŠ¶æ€ï¼Œåˆ™å½“å‰è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºBrokenå¼‚å¸¸ã€‘\r\n          if (g.broken)\r\n              throw new BrokenBarrierException();\r\n  \t\t// å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­äº†ï¼Œåˆ™æ‰“ç ´å½“å‰ä»£ï¼Œç„¶åå½“å‰çº¿ç¨‹æŠ›å‡ºä¸­æ–­å¼‚å¸¸\r\n          if (Thread.interrupted()) {\r\n              // è®¾ç½®å½“å‰ä»£çš„çŠ¶æ€ä¸º broken çŠ¶æ€ï¼Œå”¤é†’åœ¨ trip æ¡ä»¶é˜Ÿåˆ—å†…çš„çº¿ç¨‹\r\n              breakBarrier();\r\n              throw new InterruptedException();\r\n          }\r\n  \r\n          // é€»è¾‘åˆ°è¿™è¯´æ˜ï¼Œå½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€æ˜¯ falseï¼Œ å½“å‰ä»£çš„ broken ä¸º falseï¼ˆæœªæ‰“ç ´çŠ¶æ€ï¼‰\r\n          \r\n          // å‡è®¾ parties ç»™çš„æ˜¯ 5ï¼Œé‚£ä¹ˆindexå¯¹åº”çš„å€¼ä¸º 4,3,2,1,0\r\n          int index = --count;\r\n          // æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯æœ€åä¸€ä¸ªåˆ°è¾¾ barrier çš„çº¿ç¨‹ï¼Œã€éœ€è¦å¼€å¯æ–°ä»£ï¼Œå”¤é†’é˜»å¡çº¿ç¨‹ã€‘\r\n          if (index == 0) {\r\n              // æ …æ ä»»åŠ¡å¯åŠ¨æ ‡è®°\r\n              boolean ranAction = false;\r\n              try {\r\n                  final Runnable command = barrierCommand;\r\n                  if (command != null)\r\n                      // å¯åŠ¨è§¦å‘çš„ä»»åŠ¡\r\n                      command.run();\r\n                  // run()æœªæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œå¯åŠ¨æ ‡è®°è®¾ç½®ä¸º true\r\n                  ranAction = true;\r\n                  // å¼€å¯æ–°çš„ä¸€ä»£ï¼Œè¿™é‡Œä¼šã€å”¤é†’æ‰€æœ‰çš„é˜»å¡é˜Ÿåˆ—ã€‘\r\n                  nextGeneration();\r\n                  // è¿”å› 0 å› ä¸ºå½“å‰çº¿ç¨‹æ˜¯æ­¤ä»£æœ€åä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹ï¼Œindex == 0\r\n                  return 0;\r\n              } finally {\r\n                  // å¦‚æœ command.run() æ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œä¼šè¿›å…¥åˆ°è¿™é‡Œ\r\n                  if (!ranAction)\r\n                      breakBarrier();\r\n              }\r\n          }\r\n  \r\n          // è‡ªæ—‹ï¼Œä¸€ç›´åˆ°æ¡ä»¶æ»¡è¶³ã€å½“å‰ä»£è¢«æ‰“ç ´ã€çº¿ç¨‹è¢«ä¸­æ–­ï¼Œç­‰å¾…è¶…æ—¶\r\n          for (;;) {\r\n              try {\r\n                  // æ ¹æ®æ˜¯å¦éœ€è¦è¶…æ—¶ç­‰å¾…é€‰æ‹©é˜»å¡æ–¹æ³•\r\n                  if (!timed)\r\n                      // å½“å‰çº¿ç¨‹é‡Šæ”¾æ‰ lockï¼Œã€è¿›å…¥åˆ° trip æ¡ä»¶é˜Ÿåˆ—çš„å°¾éƒ¨æŒ‚èµ·è‡ªå·±ã€‘ï¼Œç­‰å¾…è¢«å”¤é†’\r\n                      trip.await();\r\n                  else if (nanos > 0L)\r\n                      nanos = trip.awaitNanos(nanos);\r\n              } catch (InterruptedException ie) {\r\n                  // è¢«ä¸­æ–­åæ¥åˆ°è¿™é‡Œçš„é€»è¾‘\r\n                  \r\n                  // å½“å‰ä»£æ²¡æœ‰å˜åŒ–å¹¶ä¸”æ²¡æœ‰è¢«æ‰“ç ´\r\n                  if (g == generation && !g.broken) {\r\n                      // æ‰“ç ´å±éšœ\r\n                      breakBarrier();\r\n                      // node èŠ‚ç‚¹åœ¨ã€æ¡ä»¶é˜Ÿåˆ—ã€‘å†…æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸\r\n                      throw ie;\r\n                  } else {\r\n                      // ç­‰å¾…è¿‡ç¨‹ä¸­ä»£å˜åŒ–äº†ï¼Œå®Œæˆä¸€æ¬¡è‡ªæˆ‘æ‰“æ–­\r\n                      Thread.currentThread().interrupt();\r\n                  }\r\n              }\r\n  \t\t\t// å”¤é†’åçš„çº¿ç¨‹ï¼Œã€åˆ¤æ–­å½“å‰ä»£å·²ç»è¢«æ‰“ç ´ï¼Œçº¿ç¨‹å”¤é†’åä¾æ¬¡æŠ›å‡º BrokenBarrier å¼‚å¸¸ã€‘\r\n              if (g.broken)\r\n                  throw new BrokenBarrierException();\r\n  \r\n              // å½“å‰çº¿ç¨‹æŒ‚èµ·æœŸé—´ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹åˆ°ä½äº†ï¼Œç„¶åè§¦å‘äº†å¼€å¯æ–°çš„ä¸€ä»£çš„é€»è¾‘\r\n              if (g != generation)\r\n                  return index;\r\n  \t\t\t// å½“å‰çº¿ç¨‹ trip ä¸­ç­‰å¾…è¶…æ—¶ï¼Œç„¶åä¸»åŠ¨è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—\r\n              if (timed && nanos <= 0L) {\r\n                  breakBarrier();\r\n                  // æŠ›å‡ºè¶…æ—¶å¼‚å¸¸\r\n                  throw new TimeoutException();\r\n              }\r\n          }\r\n      } finally {\r\n          // è§£é”\r\n          lock.unlock();\r\n      }\r\n  }\r\n  ```\r\n\r\n* breakBarrier()ï¼šæ‰“ç ´ Barrier å±éšœ\r\n\r\n  ```java\r\n  private void breakBarrier() {\r\n      // å°†ä»£ä¸­çš„ broken è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºè¿™ä¸€ä»£æ˜¯è¢«æ‰“ç ´äº†ï¼Œå†æ¥åˆ°è¿™ä¸€ä»£çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸\r\n      generation.broken = true;\r\n      // é‡ç½® count ä¸º parties\r\n      count = parties;\r\n      // å°†åœ¨tripæ¡ä»¶é˜Ÿåˆ—å†…æŒ‚èµ·çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’ï¼Œå”¤é†’åçš„çº¿ç¨‹ä¼šæ£€æŸ¥å½“å‰æ˜¯å¦æ˜¯æ‰“ç ´çš„ï¼Œç„¶åæŠ›å‡ºå¼‚å¸¸\r\n      trip.signalAll();\r\n  }\r\n  ```\r\n\r\n* nextGeneration()ï¼šå¼€å¯æ–°çš„ä¸‹ä¸€ä»£ \r\n\r\n  ```java\r\n  private void nextGeneration() {\r\n      // å°†åœ¨ trip æ¡ä»¶é˜Ÿåˆ—å†…æŒ‚èµ·çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’\r\n      trip.signalAll();\r\n      // é‡ç½® count ä¸º parties\r\n      count = parties;\r\n  \r\n      // å¼€å¯æ–°çš„ä¸€ä»£ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çš„generationå¯¹è±¡ï¼Œè¡¨ç¤ºæ–°çš„ä¸€ä»£ï¼Œæ–°çš„ä¸€ä»£å’Œä¸Šä¸€ä»£ã€æ²¡æœ‰ä»»ä½•å…³ç³»ã€‘\r\n      generation = new Generation();\r\n  }\r\n  ```\r\n\r\n  \r\n\r\nå‚è€ƒè§†é¢‘ï¼šhttps://space.bilibili.com/457326371/\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### Semaphore\r\n\r\n#### åŸºæœ¬ä½¿ç”¨\r\n\r\nsynchronized å¯ä»¥èµ·åˆ°é”çš„ä½œç”¨ï¼Œä½†æŸä¸ªæ—¶é—´æ®µå†…ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ\r\n\r\nSemaphoreï¼ˆä¿¡å·é‡ï¼‰ç”¨æ¥é™åˆ¶èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™ï¼Œéé‡å…¥é”\r\n\r\næ„é€ æ–¹æ³•ï¼š\r\n\r\n* `public Semaphore(int permits)`ï¼špermits è¡¨ç¤ºè®¸å¯çº¿ç¨‹çš„æ•°é‡ï¼ˆstateï¼‰\r\n* `public Semaphore(int permits, boolean fair)`ï¼šfair è¡¨ç¤ºå…¬å¹³æ€§ï¼Œå¦‚æœè®¾ä¸º trueï¼Œä¸‹æ¬¡æ‰§è¡Œçš„çº¿ç¨‹ä¼šæ˜¯ç­‰å¾…æœ€ä¹…çš„çº¿ç¨‹\r\n\r\nå¸¸ç”¨APIï¼š\r\n\r\n* `public void acquire()`ï¼šè¡¨ç¤ºè·å–è®¸å¯\r\n* `public void release()`ï¼šè¡¨ç¤ºé‡Šæ”¾è®¸å¯ï¼Œacquire() å’Œ release() æ–¹æ³•ä¹‹é—´çš„ä»£ç ä¸ºåŒæ­¥ä»£ç \r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    // 1.åˆ›å»ºSemaphoreå¯¹è±¡\r\n    Semaphore semaphore = new Semaphore(3);\r\n\r\n    // 2. 10ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ\r\n    for (int i = 0; i < 10; i++) {\r\n        new Thread(() -> {\r\n            try {\r\n                // 3. è·å–è®¸å¯\r\n                semaphore.acquire();\r\n                sout(Thread.currentThread().getName() + \" running...\");\r\n                Thread.sleep(1000);\r\n                sout(Thread.currentThread().getName() + \" end...\");\r\n            } catch (InterruptedException e) {\r\n                e.printStackTrace();\r\n            } finally {\r\n                // 4. é‡Šæ”¾è®¸å¯\r\n                semaphore.release();\r\n            }\r\n        }).start();\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å®ç°åŸç†\r\n\r\nåŠ é”æµç¨‹ï¼š\r\n\r\n* Semaphore çš„ permitsï¼ˆstateï¼‰ä¸º 3ï¼Œè¿™æ—¶ 5 ä¸ªçº¿ç¨‹æ¥è·å–èµ„æº\r\n\r\n  ```java\r\n  Sync(int permits) {\r\n      setState(permits);\r\n  }\r\n  ```\r\n\r\n  å‡è®¾å…¶ä¸­ Thread-1ï¼ŒThread-2ï¼ŒThread-4 CAS ç«äº‰æˆåŠŸï¼Œpermits å˜ä¸º 0ï¼Œè€Œ Thread-0 å’Œ Thread-3 ç«äº‰å¤±è´¥ï¼Œè¿›å…¥ AQS é˜Ÿåˆ—park é˜»å¡\r\n\r\n  ```java\r\n  // acquire() -> sync.acquireSharedInterruptibly(1)ï¼Œå¯ä¸­æ–­\r\n  public final void acquireSharedInterruptibly(int arg) {\r\n      if (Thread.interrupted())\r\n          throw new InterruptedException();\r\n      // å°è¯•è·å–é€šè¡Œè¯ï¼Œè·å–æˆåŠŸè¿”å› >= 0çš„å€¼\r\n      if (tryAcquireShared(arg) < 0)\r\n          // è·å–è®¸å¯è¯å¤±è´¥ï¼Œè¿›å…¥é˜»å¡\r\n          doAcquireSharedInterruptibly(arg);\r\n  }\r\n  \r\n  // tryAcquireShared() -> nonfairTryAcquireShared()\r\n  // éå…¬å¹³ï¼Œå…¬å¹³é”ä¼šåœ¨å¾ªç¯å†… hasQueuedPredecessors()æ–¹æ³•åˆ¤æ–­é˜»å¡é˜Ÿåˆ—æ˜¯å¦æœ‰ä¸´å¤´èŠ‚ç‚¹(ç¬¬äºŒä¸ªèŠ‚ç‚¹)\r\n  final int nonfairTryAcquireShared(int acquires) {\r\n      for (;;) {\r\n          // è·å– state ï¼Œstate è¿™é‡Œã€è¡¨ç¤ºé€šè¡Œè¯ã€‘\r\n          int available = getState();\r\n          // è®¡ç®—å½“å‰çº¿ç¨‹è·å–é€šè¡Œè¯å®Œæˆä¹‹åï¼Œé€šè¡Œè¯è¿˜å‰©ä½™æ•°é‡\r\n          int remaining = available - acquires;\r\n          // å¦‚æœè®¸å¯å·²ç»ç”¨å®Œ, è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–å¤±è´¥,\r\n          if (remaining < 0 ||\r\n              // è®¸å¯è¯è¶³å¤Ÿåˆ†é…çš„ï¼Œå¦‚æœ cas é‡è¯•æˆåŠŸ, è¿”å›æ­£æ•°, è¡¨ç¤ºè·å–æˆåŠŸ\r\n              compareAndSetState(available, remaining))\r\n              return remaining;\r\n      }\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  private void doAcquireSharedInterruptibly(int arg) {\r\n      // å°†è°ƒç”¨ Semaphore.aquire æ–¹æ³•çš„çº¿ç¨‹ï¼ŒåŒ…è£…æˆ node åŠ å…¥åˆ° AQS çš„é˜»å¡é˜Ÿåˆ—ä¸­\r\n      final Node node = addWaiter(Node.SHARED);\r\n      // è·å–æ ‡è®°\r\n      boolean failed = true;\r\n      try {\r\n          for (;;) {\r\n              final Node p = node.predecessor();\r\n              // å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹å¯ä»¥å†æ¬¡è·å–è®¸å¯\r\n              if (p == head) {\r\n                  // å†æ¬¡å°è¯•è·å–è®¸å¯ï¼Œã€è¿”å›å‰©ä½™çš„è®¸å¯è¯æ•°é‡ã€‘\r\n                  int r = tryAcquireShared(arg);\r\n                  if (r >= 0) {\r\n                      // æˆåŠŸåæœ¬çº¿ç¨‹å‡ºé˜Ÿï¼ˆAQSï¼‰, æ‰€åœ¨ Nodeè®¾ç½®ä¸º head\r\n                      // r è¡¨ç¤ºã€å¯ç”¨èµ„æºæ•°ã€‘, ä¸º 0 åˆ™ä¸ä¼šç»§ç»­ä¼ æ’­\r\n                      setHeadAndPropagate(node, r); \r\n                      p.next = null; // help GC\r\n                      failed = false;\r\n                      return;\r\n                  }\r\n              }\r\n              // ä¸æˆåŠŸ, è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹ waitStatus = Node.SIGNAL, ä¸‹è½®è¿›å…¥ park é˜»å¡\r\n              if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())\r\n                  throw new InterruptedException();\r\n          }\r\n      } finally {\r\n          // è¢«æ‰“æ–­åè¿›å…¥è¯¥é€»è¾‘\r\n          if (failed)\r\n              cancelAcquire(node);\r\n      }\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  private void setHeadAndPropagate(Node node, int propagate) {    \r\n      Node h = head;\r\n      // è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹\r\n      setHead(node);\r\n      // propagate è¡¨ç¤ºæœ‰ã€å…±äº«èµ„æºã€‘ï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰\r\n      // head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATEï¼ŒdoReleaseShared å‡½æ•°ä¸­è®¾ç½®çš„\r\n      if (propagate > 0 || h == null || h.waitStatus < 0 ||\r\n          (h = head) == null || h.waitStatus < 0) {\r\n          Node s = node.next;\r\n          // å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ï¼Œåšä¸€æ¬¡å”¤é†’\r\n          if (s == null || s.isShared())\r\n              doReleaseShared();\r\n      }\r\n  }\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719211343768.png\" alt=\"image-20230719211343768\" class=\"scale-80\" />\r\n\r\n* è¿™æ—¶ Thread-4 é‡Šæ”¾äº† permitsï¼ŒçŠ¶æ€å¦‚ä¸‹\r\n\r\n  ```java\r\n  // release() -> releaseShared()\r\n  public final boolean releaseShared(int arg) {\r\n      // å°è¯•é‡Šæ”¾é”\r\n      if (tryReleaseShared(arg)) {\r\n          doReleaseShared();\r\n          return true;\r\n      }    \r\n      return false;\r\n  }\r\n  protected final boolean tryReleaseShared(int releases) {    \r\n      for (;;) {\r\n          // è·å–å½“å‰é”èµ„æºçš„å¯ç”¨è®¸å¯è¯æ•°é‡\r\n          int current = getState();\r\n          int next = current + releases;\r\n          // ç´¢å¼•è¶Šç•Œåˆ¤æ–­\r\n          if (next < current)            \r\n              throw new Error(\"Maximum permit count exceeded\");        \r\n          // é‡Šæ”¾é”\r\n          if (compareAndSetState(current, next))            \r\n              return true;    \r\n      }\r\n  }\r\n  private void doReleaseShared() {    \r\n      // PROPAGATE è¯¦è§£    \r\n      // å¦‚æœ head.waitStatus == Node.SIGNAL ==> 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark\t\r\n      // å¦‚æœ head.waitStatus == 0 ==> Node.PROPAGATE\r\n  }\r\n  ```\r\n\r\n  ![image-20230719211353401](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230719211353401.png)\r\n\r\n* æ¥ä¸‹æ¥ Thread-0 ç«äº‰æˆåŠŸï¼Œpermits å†æ¬¡è®¾ç½®ä¸º 0ï¼Œè®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹ï¼Œå¹¶ä¸” unpark æ¥ä¸‹æ¥çš„å…±äº«çŠ¶æ€çš„ Thread-3 èŠ‚ç‚¹ï¼Œä½†ç”±äº permits æ˜¯ 0ï¼Œå› æ­¤ Thread-3 åœ¨å°è¯•ä¸æˆåŠŸåå†æ¬¡è¿›å…¥ park çŠ¶æ€\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### PROPAGATE\r\n\r\nå‡è®¾å­˜åœ¨æŸæ¬¡å¾ªç¯ä¸­é˜Ÿåˆ—é‡Œæ’é˜Ÿçš„ç»“ç‚¹æƒ…å†µä¸º `head(-1) â†’ t1(-1) â†’ t2(0)`ï¼Œå­˜åœ¨å°†è¦é‡Šæ”¾ä¿¡å·é‡çš„ T3 å’Œ T4ï¼Œé‡Šæ”¾é¡ºåºä¸ºå…ˆ T3 å T4\r\n\r\n```java\r\n// è€ç‰ˆæœ¬ä»£ç \r\nprivate void setHeadAndPropagate(Node node, int propagate) {    \r\n    setHead(node);    \r\n    // æœ‰ç©ºé—²èµ„æº    \r\n    if (propagate > 0 && node.waitStatus != 0) {    \t\r\n        Node s = node.next;        \r\n        // ä¸‹ä¸€ä¸ª        \r\n        if (s == null || s.isShared())            \r\n            unparkSuccessor(node);        \r\n    }\r\n}\r\n```\r\n\r\næ­£å¸¸æµç¨‹ï¼š\r\n\r\n* T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0\r\n* T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œç„¶å T4 é‡Šæ”¾ï¼Œå”¤é†’ T2\r\n\r\nBUG æµç¨‹ï¼š\r\n\r\n* T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0\r\n* T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œè°ƒç”¨ tryAcquireSharedï¼Œè¿”å›å€¼ä¸º 0ï¼ˆè·å–é”æˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™èµ„æºé‡ï¼‰\r\n* T1 è¿˜æ²¡è°ƒç”¨ setHeadAndPropagate æ–¹æ³•ï¼ŒT4 è°ƒç”¨ releaseShared(1)ï¼Œæ­¤æ—¶ head.waitStatus ä¸º 0ï¼ˆæ­¤æ—¶è¯»åˆ°çš„ head å’Œ 1 ä¸­ä¸ºåŒä¸€ä¸ª headï¼‰ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼Œå› æ­¤ä¸è°ƒç”¨ unparkSuccessor(head)\r\n* T1 è·å–ä¿¡å·é‡æˆåŠŸï¼Œè°ƒç”¨ setHeadAndPropagate(t1.node, 0) æ—¶ï¼Œå› ä¸ºä¸æ»¡è¶³ propagate > 0ï¼ˆå‰©ä½™èµ„æºé‡ == 0ï¼‰ï¼Œä»è€Œä¸ä¼šå”¤é†’åç»§ç»“ç‚¹ï¼Œ **T2 çº¿ç¨‹å¾—ä¸åˆ°å”¤é†’**\r\n\r\n\r\n\r\næ›´æ–°åæµç¨‹ï¼š\r\n\r\n* T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0\r\n* T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œè°ƒç”¨ tryAcquireSharedï¼Œè¿”å›å€¼ä¸º 0ï¼ˆè·å–é”æˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™èµ„æºé‡ï¼‰\r\n\r\n* T1 è¿˜æ²¡è°ƒç”¨ setHeadAndPropagate æ–¹æ³•ï¼ŒT4 è°ƒç”¨ releaseShared()ï¼Œæ­¤æ—¶ head.waitStatus ä¸º 0ï¼ˆæ­¤æ—¶è¯»åˆ°çš„ head å’Œ 1 ä¸­ä¸ºåŒä¸€ä¸ª headï¼‰ï¼Œè°ƒç”¨ doReleaseShared() å°†ç­‰å¾…çŠ¶æ€ç½®ä¸º **PROPAGATEï¼ˆ-3ï¼‰**\r\n* T1 è·å–ä¿¡å·é‡æˆåŠŸï¼Œè°ƒç”¨ setHeadAndPropagate æ—¶ï¼Œè¯»åˆ° h.waitStatus < 0ï¼Œä»è€Œè°ƒç”¨ doReleaseShared() å”¤é†’ T2\r\n\r\n```java\r\nprivate void setHeadAndPropagate(Node node, int propagate) {    \r\n    Node h = head;\r\n    // è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹\r\n    setHead(node);\r\n    // propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰\r\n    // head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE\r\n    if (propagate > 0 || h == null || h.waitStatus < 0 ||\r\n        (h = head) == null || h.waitStatus < 0) {\r\n        Node s = node.next;\r\n        // å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ï¼Œåšä¸€æ¬¡å”¤é†’\r\n        if (s == null || s.isShared())\r\n            doReleaseShared();\r\n    }\r\n}\r\n```\r\n\r\n```java\r\n// å”¤é†’\r\nprivate void doReleaseShared() {\r\n    // å¦‚æœ head.waitStatus == Node.SIGNAL ==> 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark\t\r\n    // å¦‚æœ head.waitStatus == 0 ==> Node.PROPAGATE    \r\n    for (;;) {\r\n        Node h = head;\r\n        if (h != null && h != tail) {\r\n            int ws = h.waitStatus;\r\n            if (ws == Node.SIGNAL) {\r\n                // é˜²æ­¢ unparkSuccessor è¢«å¤šæ¬¡æ‰§è¡Œ\r\n                if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))\r\n                    continue;\r\n                // å”¤é†’åç»§èŠ‚ç‚¹\r\n                unparkSuccessor(h);\r\n            }\r\n            // å¦‚æœå·²ç»æ˜¯ 0 äº†ï¼Œæ”¹ä¸º -3ï¼Œç”¨æ¥è§£å†³ä¼ æ’­æ€§\r\n            else if (ws == 0 && !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))\r\n                continue;\r\n        }\r\n        if (h == head)\r\n            break;\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### Exchanger\r\n\r\nExchangerï¼šäº¤æ¢å™¨ï¼Œæ˜¯ä¸€ä¸ªç”¨äºçº¿ç¨‹é—´åä½œçš„å·¥å…·ç±»ï¼Œç”¨äºè¿›è¡Œçº¿ç¨‹é—´çš„æ•°æ®äº¤æ¢\r\n\r\nå·¥ä½œæµç¨‹ï¼šä¸¤ä¸ªçº¿ç¨‹é€šè¿‡ exchange æ–¹æ³•äº¤æ¢æ•°æ®ï¼Œå¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ exchange() æ–¹æ³•ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿæ‰§è¡Œ exchange æ–¹æ³•ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹æ—¶ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±å¯ä»¥äº¤æ¢æ•°æ®\r\n\r\nå¸¸ç”¨æ–¹æ³•ï¼š\r\n\r\n* `public Exchanger()`ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº¤æ¢å™¨\r\n* `public V exchange(V x)`ï¼šç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾æ­¤äº¤æ¢ç‚¹\r\n* `public V exchange(V x, long timeout, TimeUnit unit)`ï¼šç­‰å¾…ä¸€å®šçš„æ—¶é—´\r\n\r\n```java\r\npublic class ExchangerDemo {\r\n    public static void main(String[] args) {\r\n        // åˆ›å»ºäº¤æ¢å¯¹è±¡ï¼ˆä¿¡ä½¿ï¼‰\r\n        Exchanger<String> exchanger = new Exchanger<>();\r\n        new ThreadA(exchanger).start();\r\n        new ThreadB(exchanger).start();\r\n    } \r\n}\r\nclass ThreadA extends Thread{\r\n    private Exchanger<String> exchanger();\r\n    \r\n    public ThreadA(Exchanger<String> exchanger){\r\n        this.exchanger = exchanger;\r\n    }\r\n    \r\n    @Override\r\n    public void run() {\r\n        try{\r\n            sout(\"çº¿ç¨‹Aï¼Œåšå¥½äº†ç¤¼ç‰©Aï¼Œç­‰å¾…çº¿ç¨‹Bé€æ¥çš„ç¤¼ç‰©B\");\r\n            //å¦‚æœç­‰å¾…äº†5sè¿˜æ²¡æœ‰äº¤æ¢å°±æ­»äº¡ï¼ˆæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼\r\n            String s = exchanger.exchange(\"ç¤¼ç‰©A\",5,TimeUnit.SECONDS);\r\n            sout(\"çº¿ç¨‹Aæ”¶åˆ°çº¿ç¨‹Bçš„ç¤¼ç‰©ï¼š\" + s);\r\n        } catch (Exception e) {\r\n            System.out.println(\"çº¿ç¨‹Aç­‰å¾…äº†5sï¼Œæ²¡æœ‰æ”¶åˆ°ç¤¼ç‰©,æœ€ç»ˆå°±æ‰§è¡Œç»“æŸäº†!\");\r\n        }\r\n    }\r\n}\r\nclass ThreadB extends Thread{\r\n    private Exchanger<String> exchanger;\r\n    \r\n    public ThreadB(Exchanger<String> exchanger) {\r\n        this.exchanger = exchanger;\r\n    }\r\n    \r\n    @Override\r\n    public void run() {\r\n        try {\r\n            sout(\"çº¿ç¨‹B,åšå¥½äº†ç¤¼ç‰©B,ç­‰å¾…çº¿ç¨‹Aé€æ¥çš„ç¤¼ç‰©A.....\");\r\n            // å¼€å§‹äº¤æ¢ç¤¼ç‰©ã€‚å‚æ•°æ˜¯é€ç»™å…¶ä»–çº¿ç¨‹çš„ç¤¼ç‰©!\r\n            sout(\"çº¿ç¨‹Bæ”¶åˆ°çº¿ç¨‹Açš„ç¤¼ç‰©ï¼š\" + exchanger.exchange(\"ç¤¼ç‰©B\"));\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"å¹¶å‘ç¼–ç¨‹æ•´ç†ç‰ˆ-çº¿ç¨‹æ± ","tags":["çº¿ç¨‹æ± ","BlockingQueue","ThreadPoolExecutor","Executors","ScheduledThreadPoolExecutor","ForkJoin","äº«å…ƒæ¨¡å¼"],"categories":["Java","å¹¶å‘ç¼–ç¨‹"],"author":"imklaus","excerpt":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n","link":"/posts/Concurrent_Programming-threadPool","content":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥JUCå¹¶å‘ç¼–ç¨‹å…¨å¥—æ•™ç¨‹](https://www.bilibili.com/video/BV16J411h7Rd)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n<!-- more -->\r\n\r\n\r\n\r\n## çº¿ç¨‹æ± \r\n\r\n### åŸºæœ¬æ¦‚è¿°\r\n\r\nçº¿ç¨‹æ± ï¼šä¸€ä¸ªå®¹çº³å¤šä¸ªçº¿ç¨‹çš„å®¹å™¨ï¼Œå®¹å™¨ä¸­çš„çº¿ç¨‹å¯ä»¥é‡å¤ä½¿ç”¨ï¼Œçœå»äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¯¹è±¡çš„æ“ä½œ\r\n\r\nçº¿ç¨‹æ± ä½œç”¨ï¼š\r\n\r\n1. é™ä½èµ„æºæ¶ˆè€—ï¼Œå‡å°‘äº†åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„æ¬¡æ•°ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½å¯ä»¥è¢«é‡å¤åˆ©ç”¨ï¼Œå¯æ‰§è¡Œå¤šä¸ªä»»åŠ¡\r\n2. æé«˜å“åº”é€Ÿåº¦ï¼Œå½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œå¦‚æœæœ‰çº¿ç¨‹å¯ä»¥ç›´æ¥ç”¨ï¼Œä¸ä¼šå‡ºç°ç³»ç»Ÿåƒµæ­»\r\n3. æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºçº¿ç¨‹ï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§\r\n\r\nçº¿ç¨‹æ± çš„æ ¸å¿ƒæ€æƒ³ï¼š**çº¿ç¨‹å¤ç”¨**ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¢«é‡å¤ä½¿ç”¨ï¼Œæ¥å¤„ç†å¤šä¸ªä»»åŠ¡\r\n\r\næ± åŒ–æŠ€æœ¯ (Pool) ï¼šä¸€ç§ç¼–ç¨‹æŠ€å·§ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯èµ„æºå¤ç”¨ï¼Œåœ¨è¯·æ±‚é‡å¤§æ—¶èƒ½ä¼˜åŒ–åº”ç”¨æ€§èƒ½ï¼Œé™ä½ç³»ç»Ÿé¢‘ç¹å»ºè¿çš„èµ„æºå¼€é”€\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### é˜»å¡é˜Ÿåˆ—\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\næœ‰ç•Œé˜Ÿåˆ—å’Œæ— ç•Œé˜Ÿåˆ—ï¼š\r\n\r\n- æœ‰ç•Œé˜Ÿåˆ—ï¼šæœ‰å›ºå®šå¤§å°çš„é˜Ÿåˆ—ï¼Œæ¯”å¦‚è®¾å®šäº†å›ºå®šå¤§å°çš„ LinkedBlockingQueueï¼Œåˆæˆ–è€…å¤§å°ä¸º 0\r\n\r\n- æ— ç•Œé˜Ÿåˆ—ï¼šæ²¡æœ‰è®¾ç½®å›ºå®šå¤§å°çš„é˜Ÿåˆ—ï¼Œè¿™äº›é˜Ÿåˆ—å¯ä»¥ç›´æ¥å…¥é˜Ÿï¼Œç›´åˆ°æº¢å‡ºï¼ˆè¶…è¿‡ Integer.MAX_VALUEï¼‰ï¼Œæ‰€ä»¥ç›¸å½“äºæ— ç•Œ\r\n\r\njava.util.concurrent.BlockingQueue æ¥å£æœ‰ä»¥ä¸‹é˜»å¡é˜Ÿåˆ—çš„å®ç°ï¼š**FIFO é˜Ÿåˆ—** \r\n\r\n- ArrayBlockingQueueï¼šç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—\r\n- LinkedBlockingQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œï¼ˆé»˜è®¤å¤§å° Integer.MAX_VALUEï¼‰çš„é˜»å¡é˜Ÿåˆ—\r\n- PriorityBlockingQueueï¼šæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—\r\n- DelayedWorkQueueï¼šä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—\r\n- SynchronousQueueï¼šä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸€ä¸ªç”Ÿäº§çº¿ç¨‹ä¼šé˜»å¡åˆ°æœ‰ä¸€ä¸ª put çš„çº¿ç¨‹æ”¾å…¥å…ƒç´ ä¸ºæ­¢\r\n- LinkedTransferQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—\r\n- LinkedBlockingDequeï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„**åŒå‘**é˜»å¡é˜Ÿåˆ—\r\n\r\nä¸æ™®é€šé˜Ÿåˆ—ï¼ˆLinkedListã€ArrayDequeã€PriorityQueueç­‰ï¼‰çš„ä¸åŒç‚¹åœ¨äºé˜»å¡é˜Ÿåˆ—ä¸­é˜»å¡æ·»åŠ å’Œé˜»å¡åˆ é™¤æ–¹æ³•ï¼Œä»¥åŠçº¿ç¨‹å®‰å…¨ï¼š\r\n\r\n- é˜»å¡æ·»åŠ  put()ï¼šå½“é˜»å¡é˜Ÿåˆ—å…ƒç´ å·²æ»¡æ—¶ï¼Œæ·»åŠ é˜Ÿåˆ—å…ƒç´ çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—å…ƒç´ ä¸æ»¡æ—¶æ‰é‡æ–°å”¤é†’çº¿ç¨‹æ‰§è¡Œ\r\n- é˜»å¡åˆ é™¤ take()ï¼šåœ¨é˜Ÿåˆ—å…ƒç´ ä¸ºç©ºæ—¶ï¼Œåˆ é™¤é˜Ÿåˆ—å…ƒç´ çš„çº¿ç¨‹å°†è¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ä¸ºç©ºå†æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆä¸€èˆ¬ä¼šè¿”å›è¢«åˆ é™¤çš„å…ƒç´ )\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æ ¸å¿ƒæ–¹æ³•\r\n\r\n| æ–¹æ³•ç±»å‹         | æŠ›å‡ºå¼‚å¸¸  | ç‰¹æ®Šå€¼   | é˜»å¡   | è¶…æ—¶                 |\r\n| ---------------- | --------- | -------- | ------ | -------------------- |\r\n| æ’å…¥ï¼ˆå°¾ï¼‰       | add(e)    | offer(e) | put(e) | `offer(e,time,unit)` |\r\n| ç§»é™¤ï¼ˆå¤´ï¼‰       | remove()  | poll()   | take() | `poll(time,unit)`    |\r\n| æ£€æŸ¥ï¼ˆé˜Ÿé¦–å…ƒç´ ï¼‰ | element() | peek()   | ä¸å¯ç”¨ | ä¸å¯ç”¨               |\r\n\r\n- æŠ›å‡ºå¼‚å¸¸ç»„ï¼š\r\n  - å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼šåœ¨å¾€é˜Ÿåˆ—ä¸­ add æ’å…¥å…ƒç´ ä¼šæŠ›å‡º IIIegalStateException: Queue full\r\n  - å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼šå†å¾€é˜Ÿåˆ—ä¸­ remove ç§»é™¤å…ƒç´ ï¼Œä¼šæŠ›å‡º NoSuchException\r\n- ç‰¹æ®Šå€¼ç»„ï¼š\r\n  - æ’å…¥æ–¹æ³•ï¼šæˆåŠŸ trueï¼Œå¤±è´¥ false\r\n  - ç§»é™¤æ–¹æ³•ï¼šæˆåŠŸè¿”å›å‡ºé˜Ÿåˆ—å…ƒç´ ï¼Œé˜Ÿåˆ—æ²¡æœ‰å°±è¿”å› null\r\n- é˜»å¡ç»„ï¼š\r\n  - å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œç”Ÿäº§è€…ç»§ç»­å¾€é˜Ÿåˆ—é‡Œ put å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºé—´ put æ•°æ®æˆ–å“åº”ä¸­æ–­é€€å‡º\r\n  - å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œ take å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å¯ç”¨å…ƒç´ \r\n- è¶…æ—¶é€€å‡ºï¼š\r\n  - å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œè¶…è¿‡é™æ—¶åç”Ÿäº§è€…çº¿ç¨‹ä¼šé€€å‡º\r\n  - å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œè¶…è¿‡é™æ—¶åæ¶ˆè´¹è€…çº¿ç¨‹ä¼šé€€å‡º\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### é“¾è¡¨é˜Ÿåˆ—\r\n\r\n##### å…¥é˜Ÿå‡ºé˜Ÿ\r\n\r\nLinkedBlockingQueue æºç ï¼š\r\n\r\n```java\r\npublic class LinkedBlockingQueue<E> extends AbstractQueue<E>\r\n\t\t\timplements BlockingQueue<E>, java.io.Serializable {\r\n\tstatic class Node<E> {\r\n        E item;\r\n        /**\r\n        * ä¸‹åˆ—ä¸‰ç§æƒ…å†µä¹‹ä¸€\r\n        * - çœŸæ­£çš„åç»§èŠ‚ç‚¹\r\n        * - è‡ªå·±, å‘ç”Ÿåœ¨å‡ºé˜Ÿæ—¶\r\n        * - null, è¡¨ç¤ºæ˜¯æ²¡æœ‰åç»§èŠ‚ç‚¹, æ˜¯å°¾èŠ‚ç‚¹äº†\r\n        */\r\n        Node<E> next;\r\n\r\n        Node(E x) { item = x; }\r\n    }\r\n}\r\n```\r\n\r\nå…¥é˜Ÿï¼š**å°¾æ’æ³•**\r\n\r\n- åˆå§‹åŒ–é“¾è¡¨ `last = head = new Node<E>(null)`ï¼Œ**Dummy èŠ‚ç‚¹ç”¨æ¥å ä½**ï¼Œitem ä¸º null\r\n\r\n  ```java\r\n  public LinkedBlockingQueue(int capacity) {\r\n      // é»˜è®¤æ˜¯ Integer.MAX_VALUE\r\n      if (capacity <= 0) throw new IllegalArgumentException();\r\n      this.capacity = capacity;\r\n      last = head = new Node<E>(null);\r\n  }\r\n  ```\r\n\r\n- å½“ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿï¼š\r\n\r\n  ```java\r\n  private void enqueue(Node<E> node) {\r\n      // ä»å³å‘å·¦è®¡ç®—\r\n      last = last.next = node;\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230720202045345.png\" alt=\"image-20230720202045345\" class=\"scale-80\" />\r\n\r\n- å†æ¥ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ `last = last.next = node`\r\n\r\nå‡ºé˜Ÿï¼š**å‡ºé˜Ÿå¤´èŠ‚ç‚¹**ï¼ŒFIFO\r\n\r\n- å‡ºé˜Ÿæºç ï¼š\r\n\r\n  ```java\r\n  private E dequeue() {\r\n      Node<E> h = head;\r\n      // è·å–ä¸´å¤´èŠ‚ç‚¹\r\n      Node<E> first = h.next;\r\n      // è‡ªå·±æŒ‡å‘è‡ªå·±ï¼Œhelp GC\r\n      h.next = h;\r\n      head = first;\r\n      // å‡ºé˜Ÿçš„å…ƒç´ \r\n      E x = first.item;\r\n      // ã€å½“å‰èŠ‚ç‚¹ç½®ä¸º Dummy èŠ‚ç‚¹ã€‘\r\n      first.item = null;\r\n      return x;\r\n  }\r\n  ```\r\n\r\n- `h = head` â†’ `first = h.next` \r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230720202208218.png\" alt=\"image-20230720202208218\" class=\"scale-80\" />\r\n\r\n- `h.next = h` â†’ `head = first`\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230720202231300.png\" alt=\"image-20230720202231300\" class=\"scale-80\" />\r\n\r\n  - `first.item = null`ï¼šå½“å‰èŠ‚ç‚¹ç½®ä¸º Dummy èŠ‚ç‚¹\r\n\r\n  \r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### åŠ é”åˆ†æ\r\n\r\nç”¨äº†ä¸¤æŠŠé”å’Œ dummy èŠ‚ç‚¹ï¼š\r\n\r\n- ç”¨ä¸€æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œæœ€å¤šåªå…è®¸æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ˆç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…ï¼ŒäºŒé€‰ä¸€ï¼‰æ‰§è¡Œ\r\n- ç”¨ä¸¤æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ä¸ä¸€ä¸ªæ¶ˆè´¹è€…ï¼‰æ‰§è¡Œ\r\n  - æ¶ˆè´¹è€…ä¸æ¶ˆè´¹è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ\r\n  - ç”Ÿäº§è€…ä¸ç”Ÿäº§è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ\r\n\r\nçº¿ç¨‹å®‰å…¨åˆ†æï¼š\r\n\r\n- å½“èŠ‚ç‚¹æ€»æ•°å¤§äº 2 æ—¶ï¼ˆåŒ…æ‹¬ dummy èŠ‚ç‚¹ï¼‰ï¼Œ**putLock ä¿è¯çš„æ˜¯ last èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨ï¼ŒtakeLock ä¿è¯çš„æ˜¯ head èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨**ï¼Œä¸¤æŠŠé”ä¿è¯äº†å…¥é˜Ÿå’Œå‡ºé˜Ÿæ²¡æœ‰ç«äº‰\r\n\r\n- å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 2 æ—¶ï¼ˆå³ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹ï¼‰è¿™æ—¶å€™ï¼Œä»ç„¶æ˜¯ä¸¤æŠŠé”é”ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸ä¼šç«äº‰\r\n\r\n- å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 1 æ—¶ï¼ˆå°±ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼‰è¿™æ—¶ take çº¿ç¨‹ä¼šè¢« notEmpty æ¡ä»¶é˜»å¡ï¼Œæœ‰ç«äº‰ï¼Œä¼šé˜»å¡\r\n\r\n  ```java\r\n  // ç”¨äº put(é˜»å¡) offer(éé˜»å¡)\r\n  private final ReentrantLock putLock = new ReentrantLock();\r\n  private final Condition notFull = putLock.newCondition();\t// é˜»å¡ç­‰å¾…ä¸æ»¡ï¼Œè¯´æ˜å·²ç»æ»¡äº†\r\n  \r\n  // ç”¨äº take(é˜»å¡) poll(éé˜»å¡)\r\n  private final ReentrantLock takeLock = new ReentrantLock();\r\n  private final Condition notEmpty = takeLock.newCondition();\t// é˜»å¡ç­‰å¾…ä¸ç©ºï¼Œè¯´æ˜å·²ç»æ˜¯ç©ºçš„\r\n  ```\r\n\r\nå…¥é˜Ÿå‡ºé˜Ÿï¼š\r\n\r\n- put æ“ä½œï¼š\r\n\r\n  ```java\r\n  public void put(E e) throws InterruptedException {\r\n      // ç©ºæŒ‡é’ˆå¼‚å¸¸\r\n      if (e == null) throw new NullPointerException();\r\n      int c = -1;\r\n      // æŠŠå¾…æ·»åŠ çš„å…ƒç´ å°è£…ä¸º node èŠ‚ç‚¹\r\n      Node<E> node = new Node<E>(e);\r\n      // è·å–å…¨å±€ç”Ÿäº§é”\r\n      final ReentrantLock putLock = this.putLock;\r\n      // count ç”¨æ¥ç»´æŠ¤å…ƒç´ è®¡æ•°\r\n      final AtomicInteger count = this.count;\r\n      // è·å–å¯æ‰“æ–­é”ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸\r\n      putLock.lockInterruptibly();\r\n      try {\r\n      \t// é˜Ÿåˆ—æ»¡äº†ç­‰å¾…\r\n          while (count.get() == capacity) {\r\n              // ã€ç­‰å¾…é˜Ÿåˆ—ä¸æ»¡æ—¶ï¼Œå°±å¯ä»¥ç”Ÿäº§æ•°æ®ã€‘ï¼Œçº¿ç¨‹å¤„äº Waiting\r\n              notFull.await();\r\n          }\r\n          // æœ‰ç©ºä½, å…¥é˜Ÿä¸”è®¡æ•°åŠ ä¸€ï¼Œå°¾æ’æ³•\r\n          enqueue(node);\r\n          // è¿”å›è‡ªå¢å‰çš„æ•°å­—\r\n          c = count.getAndIncrement();\r\n          // put å®Œé˜Ÿåˆ—è¿˜æœ‰ç©ºä½, å”¤é†’å…¶ä»–ç”Ÿäº§ put çº¿ç¨‹ï¼Œå”¤é†’ä¸€ä¸ªå‡å°‘ç«äº‰\r\n          if (c + 1 < capacity)\r\n              notFull.signal();\r\n      } finally {\r\n          // è§£é”\r\n          putLock.unlock();\r\n      }\r\n      // cè‡ªå¢å‰æ˜¯0ï¼Œè¯´æ˜ç”Ÿäº§äº†ä¸€ä¸ªå…ƒç´ ï¼Œå”¤é†’ä¸€ä¸ª take çº¿ç¨‹\r\n      if (c == 0)\r\n          signalNotEmpty();\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  private void signalNotEmpty() {\r\n      final ReentrantLock takeLock = this.takeLock;\r\n      takeLock.lock();\r\n      try {\r\n          // è°ƒç”¨ notEmpty.signal()ï¼Œè€Œä¸æ˜¯ notEmpty.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰ï¼Œå› ä¸ºåªå‰©ä¸‹ä¸€ä¸ªå…ƒç´ \r\n          notEmpty.signal();\r\n      } finally {\r\n          takeLock.unlock();\r\n      }\r\n  }\r\n  ```\r\n\r\n- take æ“ä½œï¼š\r\n\r\n  ```java\r\n  public E take() throws InterruptedException {\r\n      E x;\r\n      int c = -1;\r\n      // å…ƒç´ ä¸ªæ•°\r\n      final AtomicInteger count = this.count;\r\n      // è·å–å…¨å±€æ¶ˆè´¹é”\r\n      final ReentrantLock takeLock = this.takeLock;\r\n      // å¯æ‰“æ–­é”\r\n      takeLock.lockInterruptibly();\r\n      try {\r\n          // æ²¡æœ‰å…ƒç´ å¯ä»¥å‡ºé˜Ÿ\r\n          while (count.get() == 0) {\r\n              // ã€é˜»å¡ç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œå°±å¯ä»¥æ¶ˆè´¹æ•°æ®ã€‘ï¼Œçº¿ç¨‹å¤„äº Waiting\r\n              notEmpty.await();\r\n          }\r\n          // å‡ºé˜Ÿï¼Œè®¡æ•°å‡ä¸€ï¼ŒFIFOï¼Œå‡ºé˜Ÿå¤´èŠ‚ç‚¹\r\n          x = dequeue();\r\n          // è¿”å›è‡ªå‡å‰çš„æ•°å­—\r\n          c = count.getAndDecrement();\r\n          // é˜Ÿåˆ—è¿˜æœ‰å…ƒç´ \r\n          if (c > 1)\r\n              // å”¤é†’ä¸€ä¸ªæ¶ˆè´¹takeçº¿ç¨‹\r\n              notEmpty.signal();\r\n      } finally {\r\n          takeLock.unlock();\r\n      }\r\n      // c æ˜¯æ¶ˆè´¹å‰çš„æ•°æ®ï¼Œæ¶ˆè´¹å‰æ»¡äº†ï¼Œæ¶ˆè´¹ä¸€ä¸ªåè¿˜å‰©ä¸€ä¸ªç©ºä½ï¼Œå”¤é†’ç”Ÿäº§çº¿ç¨‹\r\n      if (c == capacity)\r\n          // è°ƒç”¨çš„æ˜¯ notFull.signal() è€Œä¸æ˜¯ notFull.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰\r\n          signalNotFull();\r\n      return x;\r\n  }\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ€§èƒ½æ¯”è¾ƒ\r\n\r\nä¸»è¦åˆ—ä¸¾ LinkedBlockingQueue ä¸ ArrayBlockingQueue çš„æ€§èƒ½æ¯”è¾ƒï¼š\r\n\r\n- Linked æ”¯æŒæœ‰ç•Œï¼ŒArray å¼ºåˆ¶æœ‰ç•Œ\r\n- Linked å®ç°æ˜¯é“¾è¡¨ï¼ŒArray å®ç°æ˜¯æ•°ç»„\r\n- Linked æ˜¯æ‡’æƒ°çš„ï¼Œè€Œ Array éœ€è¦æå‰åˆå§‹åŒ– Node æ•°ç»„\r\n- Linked æ¯æ¬¡å…¥é˜Ÿä¼šç”Ÿæˆæ–° Nodeï¼Œè€Œ Array çš„ Node æ˜¯æå‰åˆ›å»ºå¥½çš„\r\n- Linked ä¸¤æŠŠé”ï¼ŒArray ä¸€æŠŠé”\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åŒæ­¥é˜Ÿåˆ—\r\n\r\n##### æˆå‘˜å±æ€§\r\n\r\nSynchronousQueue æ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„ BlockingQueueï¼Œ**æ¯ä¸€ä¸ªç”Ÿäº§è€…å¿…é¡»é˜»å¡åŒ¹é…åˆ°ä¸€ä¸ªæ¶ˆè´¹è€…**\r\n\r\næˆå‘˜å˜é‡ï¼š\r\n\r\n- è¿è¡Œå½“å‰ç¨‹åºçš„å¹³å°æ‹¥æœ‰ CPU çš„æ•°é‡ï¼š\r\n\r\n  ```java\r\n  static final int NCPUS = Runtime.getRuntime().availableProcessors()\r\n  ```\r\n\r\n- æŒ‡å®šè¶…æ—¶æ—¶é—´åï¼Œå½“å‰çº¿ç¨‹æœ€å¤§è‡ªæ—‹æ¬¡æ•°ï¼š\r\n\r\n  ```java\r\n  // åªæœ‰ä¸€ä¸ª CPU æ—¶è‡ªæ—‹æ¬¡æ•°ä¸º 0ï¼Œæ‰€æœ‰ç¨‹åºéƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œå¤šæ ¸ CPU æ—¶è‡ªæ—‹ 32 æ¬¡æ˜¯ä¸€ä¸ªç»éªŒå€¼\r\n  static final int maxTimedSpins = (NCPUS < 2) ? 0 : 32;\r\n  ```\r\n\r\n  è‡ªæ—‹çš„åŸå› ï¼šçº¿ç¨‹æŒ‚èµ·å”¤é†’éœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ¶‰åŠåˆ°ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„è½¬å˜ï¼Œæ˜¯éå¸¸æ¶ˆè€—èµ„æºçš„ã€‚è‡ªæ—‹æœŸé—´çº¿ç¨‹ä¼šä¸€ç›´æ£€æŸ¥è‡ªå·±çš„çŠ¶æ€æ˜¯å¦è¢«åŒ¹é…åˆ°ï¼Œå¦‚æœè‡ªæ—‹æœŸé—´è¢«åŒ¹é…åˆ°ï¼Œé‚£ä¹ˆç›´æ¥å°±è¿”å›äº†ï¼Œå¦‚æœè‡ªæ—‹æ¬¡æ•°è¾¾åˆ°æŸä¸ªæŒ‡æ ‡åï¼Œè¿˜æ˜¯ä¼šå°†å½“å‰çº¿ç¨‹æŒ‚èµ·\r\n\r\n- æœªæŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œå½“å‰çº¿ç¨‹æœ€å¤§è‡ªæ—‹æ¬¡æ•°ï¼š\r\n\r\n  ```java\r\n  static final int maxUntimedSpins = maxTimedSpins * 16;\t// maxTimedSpins çš„ 16 å€\r\n  ```\r\n\r\n- æŒ‡å®šè¶…æ—¶é™åˆ¶çš„é˜ˆå€¼ï¼Œå°äºè¯¥å€¼çš„çº¿ç¨‹ä¸ä¼šè¢«æŒ‚èµ·ï¼š\r\n\r\n  ```java\r\n  static final long spinForTimeoutThreshold = 1000L;\t// çº³ç§’\r\n  ```\r\n\r\n  è¶…æ—¶æ—¶é—´è®¾ç½®çš„å°äºè¯¥å€¼ï¼Œå°±ä¼šè¢«ç¦æ­¢æŒ‚èµ·ï¼Œé˜»å¡å†å”¤é†’çš„æˆæœ¬å¤ªé«˜ï¼Œä¸å¦‚é€‰æ‹©è‡ªæ—‹ç©ºè½¬\r\n\r\n- è½¬æ¢å™¨ï¼š\r\n\r\n  ```java\r\n  private transient volatile Transferer<E> transferer;\r\n  abstract static class Transferer<E> {\r\n      /**\r\n      * å‚æ•°ä¸€ï¼šå¯ä»¥ä¸º nullï¼Œnull æ—¶è¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ª REQUEST ç±»å‹çš„è¯·æ±‚ï¼Œåä¹‹æ˜¯ä¸€ä¸ª DATA ç±»å‹çš„è¯·æ±‚\r\n      * å‚æ•°äºŒï¼šå¦‚æœä¸º true è¡¨ç¤ºæŒ‡å®šäº†è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœä¸º false è¡¨ç¤ºä¸æ”¯æŒè¶…æ—¶ï¼Œä¼šä¸€ç›´é˜»å¡åˆ°åŒ¹é…æˆ–è€…è¢«æ‰“æ–­\r\n      * å‚æ•°ä¸‰ï¼šè¶…æ—¶æ—¶é—´é™åˆ¶ï¼Œå•ä½æ˜¯çº³ç§’\r\n      \r\n      * è¿”å›å€¼ï¼šè¿”å›å€¼å¦‚æœä¸ä¸º null è¡¨ç¤ºåŒ¹é…æˆåŠŸï¼ŒDATA ç±»å‹çš„è¯·æ±‚è¿”å›å½“å‰çº¿ç¨‹ put çš„æ•°æ®\r\n      * \t     å¦‚æœè¿”å› nullï¼Œè¡¨ç¤ºè¯·æ±‚è¶…æ—¶æˆ–è¢«ä¸­æ–­\r\n      */\r\n      abstract E transfer(E e, boolean timed, long nanos);\r\n  }\r\n  ```\r\n\r\n- æ„é€ æ–¹æ³•ï¼š\r\n\r\n  ```java\r\n  public SynchronousQueue(boolean fair) {\r\n      // fair é»˜è®¤ false\r\n      // éå…¬å¹³æ¨¡å¼å®ç°çš„æ•°æ®ç»“æ„æ˜¯æ ˆï¼Œå…¬å¹³æ¨¡å¼çš„æ•°æ®ç»“æ„æ˜¯é˜Ÿåˆ—\r\n      transferer = fair ? new TransferQueue<E>() : new TransferStack<E>();\r\n  }\r\n  ```\r\n\r\n- æˆå‘˜æ–¹æ³•ï¼š\r\n\r\n  ```java\r\n  public boolean offer(E e) {\r\n      if (e == null) throw new NullPointerException();\r\n      return transferer.transfer(e, true, 0) != null;\r\n  }\r\n  public E poll() {\r\n      return transferer.transfer(null, true, 0);\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n****\r\n\r\n\r\n\r\n##### éå…¬å®ç°\r\n\r\nTransferStack æ˜¯éå…¬å¹³çš„åŒæ­¥é˜Ÿåˆ—ï¼Œå› ä¸ºæ‰€æœ‰çš„è¯·æ±‚éƒ½è¢«å‹å…¥æ ˆä¸­ï¼Œæ ˆé¡¶çš„å…ƒç´ ä¼šæœ€å…ˆå¾—åˆ°åŒ¹é…ï¼Œé€ æˆæ ˆåº•çš„ç­‰å¾…çº¿ç¨‹é¥¥é¥¿\r\n\r\nTransferStack ç±»æˆå‘˜å˜é‡ï¼š\r\n\r\n- è¯·æ±‚ç±»å‹ï¼š\r\n\r\n  ```java\r\n  // è¡¨ç¤º Node ç±»å‹ä¸ºè¯·æ±‚ç±»å‹\r\n  static final int REQUEST = 0;\r\n  // è¡¨ç¤º Node ç±»å‹ä¸ºæ•°æ®ç±»å‹\r\n  static final int DATA = 1;\r\n  // è¡¨ç¤º Node ç±»å‹ä¸ºåŒ¹é…ä¸­ç±»å‹\r\n  // å‡è®¾æ ˆé¡¶å…ƒç´ ä¸º REQUEST-NODEï¼Œå½“å‰è¯·æ±‚ç±»å‹ä¸º DATAï¼Œå…¥æ ˆä¼šä¿®æ”¹ç±»å‹ä¸º FULFILLING ã€æ ˆé¡¶ & æ ˆé¡¶ä¹‹ä¸‹çš„ä¸€ä¸ªnodeã€‘\r\n  // å‡è®¾æ ˆé¡¶å…ƒç´ ä¸º DATA-NODEï¼Œå½“å‰è¯·æ±‚ç±»å‹ä¸º REQUESTï¼Œå…¥æ ˆä¼šä¿®æ”¹ç±»å‹ä¸º FULFILLING ã€æ ˆé¡¶ & æ ˆé¡¶ä¹‹ä¸‹çš„ä¸€ä¸ªnodeã€‘\r\n  static final int FULFILLING = 2;\r\n  ```\r\n\r\n- æ ˆé¡¶å…ƒç´ ï¼š\r\n\r\n  ```java\r\n  volatile SNode head;\r\n  ```\r\n\r\nå†…éƒ¨ç±» SNodeï¼š\r\n\r\n- æˆå‘˜å˜é‡ï¼š\r\n\r\n  ```java\r\n  static final class SNode {\r\n      // æŒ‡å‘ä¸‹ä¸€ä¸ªæ ˆå¸§\r\n      volatile SNode next; \r\n      // ä¸å½“å‰ node åŒ¹é…çš„èŠ‚ç‚¹\r\n      volatile SNode match;\r\n      // å‡è®¾å½“å‰nodeå¯¹åº”çš„çº¿ç¨‹è‡ªæ—‹æœŸé—´æœªè¢«åŒ¹é…æˆåŠŸï¼Œé‚£ä¹ˆnodeå¯¹åº”çš„çº¿ç¨‹éœ€è¦æŒ‚èµ·ï¼Œ\r\n      // æŒ‚èµ·å‰ waiter ä¿å­˜å¯¹åº”çš„çº¿ç¨‹å¼•ç”¨ï¼Œæ–¹ä¾¿åŒ¹é…æˆåŠŸåï¼Œè¢«å”¤é†’ã€‚\r\n      volatile Thread waiter;\r\n      \r\n      // æ•°æ®åŸŸï¼Œä¸ä¸ºç©ºè¡¨ç¤ºå½“å‰ Node å¯¹åº”çš„è¯·æ±‚ç±»å‹ä¸º DATA ç±»å‹ï¼Œåä¹‹åˆ™è¡¨ç¤º Node ä¸º REQUEST ç±»å‹\r\n      Object item; \r\n      // è¡¨ç¤ºå½“å‰Nodeçš„æ¨¡å¼ ã€DATA/REQUEST/FULFILLINGã€‘\r\n      int mode;\r\n  }\r\n  ```\r\n\r\n- æ„é€ æ–¹æ³•ï¼š\r\n\r\n  ```java\r\n  SNode(Object item) {\r\n      this.item = item;\r\n  }\r\n  ```\r\n\r\n- è®¾ç½®æ–¹æ³•ï¼šè®¾ç½® Node å¯¹è±¡çš„ next å­—æ®µï¼Œæ­¤å¤„**å¯¹ CAS è¿›è¡Œäº†ä¼˜åŒ–**ï¼Œæå‡äº† CAS çš„æ•ˆç‡\r\n\r\n  ```java\r\n  boolean casNext(SNode cmp, SNode val) {\r\n      //ã€ä¼˜åŒ–ï¼šcmp == nextã€‘ï¼Œå¯ä»¥æå‡ä¸€éƒ¨åˆ†æ€§èƒ½ã€‚ cmp == next ä¸ç›¸ç­‰ï¼Œå°±æ²¡å¿…è¦èµ° casæŒ‡ä»¤ã€‚\r\n      return cmp == next && UNSAFE.compareAndSwapObject(this, nextOffset, cmp, val);\r\n  }\r\n  ```\r\n\r\n- åŒ¹é…æ–¹æ³•ï¼š\r\n\r\n  ```java\r\n  boolean tryMatch(SNode s) {\r\n      // å½“å‰ node å°šæœªä¸ä»»ä½•èŠ‚ç‚¹å‘ç”Ÿè¿‡åŒ¹é…ï¼ŒCAS è®¾ç½® match å­—æ®µä¸º s èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå½“å‰ node å·²ç»è¢«åŒ¹é…\r\n      if (match == null && UNSAFE.compareAndSwapObject(this, matchOffset, null, s)) {\r\n          // å½“å‰ node å¦‚æœè‡ªæ—‹ç»“æŸï¼Œä¼š park é˜»å¡ï¼Œé˜»å¡å‰å°† node å¯¹åº”çš„ Thread ä¿ç•™åˆ° waiter å­—æ®µ\r\n          // è·å–å½“å‰ node å¯¹åº”çš„é˜»å¡çº¿ç¨‹\r\n          Thread w = waiter;\r\n          // æ¡ä»¶æˆç«‹è¯´æ˜ node å¯¹åº”çš„ Thread æ­£åœ¨é˜»å¡\r\n          if (w != null) {\r\n              waiter = null;\r\n              // ä½¿ç”¨ unpark æ–¹å¼å”¤é†’çº¿ç¨‹\r\n              LockSupport.unpark(w);\r\n          }\r\n          return true;\r\n      }\r\n      // åŒ¹é…æˆåŠŸè¿”å› true\r\n      return match == s;\r\n  }\r\n  ```\r\n\r\n- å–æ¶ˆæ–¹æ³•ï¼š\r\n\r\n  ```java\r\n  // å–æ¶ˆèŠ‚ç‚¹çš„æ–¹æ³•\r\n  void tryCancel() {\r\n      // match å­—æ®µæŒ‡å‘è‡ªå·±ï¼Œè¡¨ç¤ºè¿™ä¸ª node æ˜¯å–æ¶ˆçŠ¶æ€ï¼Œå–æ¶ˆçŠ¶æ€çš„ nodeï¼Œæœ€ç»ˆä¼šè¢«å¼ºåˆ¶ç§»é™¤å‡ºæ ˆ\r\n      UNSAFE.compareAndSwapObject(this, matchOffset, null, this);\r\n  }\r\n  \r\n  boolean isCancelled() {\r\n      return match == this;\r\n  }\r\n  ```\r\n\r\nTransferStack ç±»æˆå‘˜æ–¹æ³•ï¼š\r\n\r\n- snode()ï¼šå¡«å……èŠ‚ç‚¹æ–¹æ³•\r\n\r\n  ```java\r\n  static SNode snode(SNode s, Object e, SNode next, int mode) {\r\n      // å¼•ç”¨æŒ‡å‘ç©ºæ—¶ï¼Œsnode æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ª SNode å¯¹è±¡ \r\n      if (s == null) s = new SNode(e);\r\n      // å¡«å……æ•°æ®\r\n      s.mode = mode;\r\n      s.next = next;\r\n      return s;\r\n  }\r\n  ```\r\n\r\n- transfer()ï¼šæ ¸å¿ƒæ–¹æ³•ï¼Œè¯·æ±‚åŒ¹é…å‡ºæ ˆï¼Œä¸åŒ¹é…é˜»å¡\r\n\r\n  ```java\r\n  E transfer(E e, boolean timed, long nanos) {\r\n  \t// åŒ…è£…å½“å‰çº¿ç¨‹çš„ node\r\n      SNode s = null;\r\n      // æ ¹æ®å…ƒç´ åˆ¤æ–­å½“å‰çš„è¯·æ±‚ç±»å‹\r\n      int mode = (e == null) ? REQUEST : DATA;\r\n  \t// è‡ªæ—‹\r\n      for (;;) {\r\n          // è·å–æ ˆé¡¶æŒ‡é’ˆ\r\n          SNode h = head;\r\n         // ã€CASE1ã€‘ï¼šå½“å‰æ ˆä¸ºç©ºæˆ–è€…æ ˆé¡¶ node æ¨¡å¼ä¸å½“å‰è¯·æ±‚æ¨¡å¼ä¸€è‡´æ— æ³•åŒ¹é…ï¼Œåšå…¥æ ˆæ“ä½œ\r\n          if (h == null || h.mode == mode) {\r\n              // å½“å‰è¯·æ±‚æ˜¯æ”¯æŒè¶…æ—¶çš„ï¼Œä½†æ˜¯ nanos <= 0 è¯´æ˜è¿™ä¸ªè¯·æ±‚ä¸æ”¯æŒ â€œé˜»å¡ç­‰å¾…â€\r\n              if (timed && nanos <= 0) { \r\n                  // æ ˆé¡¶å…ƒç´ æ˜¯å–æ¶ˆçŠ¶æ€\r\n                  if (h != null && h.isCancelled())\r\n                      // æ ˆé¡¶å‡ºæ ˆï¼Œè®¾ç½®æ–°çš„æ ˆé¡¶\r\n                      casHead(h, h.next);\r\n                  else\r\n                      // è¡¨ç¤ºã€åŒ¹é…å¤±è´¥ã€‘\r\n                      return null;\r\n              // å…¥æ ˆ\r\n              } else if (casHead(h, s = snode(s, e, h, mode))) {\r\n                  // ç­‰å¾…è¢«åŒ¹é…çš„é€»è¾‘ï¼Œæ­£å¸¸æƒ…å†µè¿”å›åŒ¹é…çš„èŠ‚ç‚¹ï¼›å–æ¶ˆæƒ…å†µè¿”å›å½“å‰èŠ‚ç‚¹ï¼Œå°±æ˜¯ s\r\n                  SNode m = awaitFulfill(s, timed, nanos);\r\n                  // è¯´æ˜å½“å‰ node æ˜¯ã€å–æ¶ˆçŠ¶æ€ã€‘\r\n                  if (m == s) { \r\n                      // å°†å–æ¶ˆèŠ‚ç‚¹å‡ºæ ˆ\r\n                      clean(s);\r\n                      return null;\r\n                  }\r\n                  // æ‰§è¡Œåˆ°è¿™è¯´æ˜ã€åŒ¹é…æˆåŠŸã€‘äº†\r\n                  // æ ˆé¡¶æœ‰èŠ‚ç‚¹å¹¶ä¸” åŒ¹é…èŠ‚ç‚¹è¿˜æœªå‡ºæ ˆï¼Œéœ€è¦ååŠ©å‡ºæ ˆ\r\n                  if ((h = head) != null && h.next == s)\r\n                      casHead(h, s.next);\r\n                  // å½“å‰ node æ¨¡å¼ä¸º REQUEST ç±»å‹ï¼Œè¿”å›åŒ¹é…èŠ‚ç‚¹çš„ m.item æ•°æ®åŸŸ\r\n                  // å½“å‰ node æ¨¡å¼ä¸º DATA ç±»å‹ï¼šè¿”å› node.item æ•°æ®åŸŸï¼Œå½“å‰è¯·æ±‚æäº¤çš„æ•°æ® e\r\n                  return (E) ((mode == REQUEST) ? m.item : s.item);\r\n              }\r\n          // ã€CASE2ã€‘ï¼šé€»è¾‘åˆ°è¿™è¯´æ˜è¯·æ±‚æ¨¡å¼ä¸ä¸€è‡´ï¼Œå¦‚æœæ ˆé¡¶ä¸æ˜¯ FULFILLING è¯´æ˜æ²¡è¢«å…¶ä»–èŠ‚ç‚¹åŒ¹é…ï¼Œã€å½“å‰å¯ä»¥åŒ¹é…ã€‘\r\n          } else if (!isFulfilling(h.mode)) {\r\n              // å¤´èŠ‚ç‚¹æ˜¯å–æ¶ˆèŠ‚ç‚¹ï¼Œmatch æŒ‡å‘è‡ªå·±ï¼ŒååŠ©å‡ºæ ˆ\r\n              if (h.isCancelled())\r\n                  casHead(h, h.next);\r\n              // å…¥æ ˆå½“å‰è¯·æ±‚çš„èŠ‚ç‚¹\r\n              else if (casHead(h, s=snode(s, e, h, FULFILLING|mode))) {\r\n                  for (;;) { \r\n                      // m æ˜¯ s çš„åŒ¹é…çš„èŠ‚ç‚¹\r\n                      SNode m = s.next;\r\n                      // m èŠ‚ç‚¹åœ¨ awaitFulfill æ–¹æ³•ä¸­è¢«ä¸­æ–­ï¼Œclean äº†è‡ªå·±\r\n                      if (m == null) {\r\n                          // æ¸…ç©ºæ ˆ\r\n                          casHead(s, null);\r\n                          s = null;\r\n                          // è¿”å›åˆ°å¤–å±‚è‡ªæ—‹ä¸­\r\n                          break;\r\n                      }\r\n                      // è·å–åŒ¹é…èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r\n                      SNode mn = m.next;\r\n                      // å°è¯•åŒ¹é…ï¼Œã€åŒ¹é…æˆåŠŸã€‘ï¼Œåˆ™å°† fulfilling å’Œ m ä¸€èµ·å‡ºæ ˆï¼Œå¹¶ä¸”å”¤é†’è¢«åŒ¹é…çš„èŠ‚ç‚¹çš„çº¿ç¨‹\r\n                      if (m.tryMatch(s)) {\r\n                          casHead(s, mn);\r\n                          return (E) ((mode == REQUEST) ? m.item : s.item);\r\n                      } else\r\n                          // åŒ¹é…å¤±è´¥ï¼Œå‡ºæ ˆ m\r\n                          s.casNext(m, mn);\r\n                  }\r\n              }\r\n          // ã€CASE3ã€‘ï¼šæ ˆé¡¶æ¨¡å¼ä¸º FULFILLING æ¨¡å¼ï¼Œè¡¨ç¤ºã€æ ˆé¡¶å’Œæ ˆé¡¶ä¸‹é¢çš„èŠ‚ç‚¹æ­£åœ¨å‘ç”ŸåŒ¹é…ã€‘ï¼Œå½“å‰è¯·æ±‚éœ€è¦åšååŠ©å·¥ä½œ\r\n          } else {\r\n              // h è¡¨ç¤ºçš„æ˜¯ fulfilling èŠ‚ç‚¹ï¼Œm è¡¨ç¤º fulfilling åŒ¹é…çš„èŠ‚ç‚¹\r\n              SNode m = h.next;\r\n              if (m == null)\r\n                  // æ¸…ç©ºæ ˆ\r\n                  casHead(h, null);\r\n              else {\r\n                  SNode mn = m.next;\r\n                  // m å’Œ h åŒ¹é…ï¼Œå”¤é†’ m ä¸­çš„çº¿ç¨‹\r\n                  if (m.tryMatch(h))\r\n                      casHead(h, mn);\r\n                  else\r\n                      h.casNext(m, mn);\r\n              }\r\n          }\r\n      }\r\n  }\r\n  ```\r\n\r\n- awaitFulfill()ï¼šé˜»å¡å½“å‰çº¿ç¨‹ç­‰å¾…è¢«åŒ¹é…ï¼Œè¿”å›åŒ¹é…çš„èŠ‚ç‚¹ï¼Œæˆ–è€…è¢«å–æ¶ˆçš„èŠ‚ç‚¹\r\n\r\n  ```java\r\n  SNode awaitFulfill(SNode s, boolean timed, long nanos) {\r\n      // ç­‰å¾…çš„æˆªæ­¢æ—¶é—´\r\n      final long deadline = timed ? System.nanoTime() + nanos : 0L;\r\n      // å½“å‰çº¿ç¨‹\r\n      Thread w = Thread.currentThread();\r\n      // è¡¨ç¤ºå½“å‰è¯·æ±‚çº¿ç¨‹åœ¨ä¸‹é¢çš„ for(;;) è‡ªæ—‹æ£€æŸ¥çš„æ¬¡æ•°\r\n      int spins = (shouldSpin(s) ? (timed ? maxTimedSpins : maxUntimedSpins) : 0);\r\n      // è‡ªæ—‹æ£€æŸ¥é€»è¾‘ï¼šæ˜¯å¦åŒ¹é…ã€æ˜¯å¦è¶…æ—¶ã€æ˜¯å¦è¢«ä¸­æ–­\r\n      for (;;) {\r\n          // å½“å‰çº¿ç¨‹æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œéœ€è¦è®¾ç½® node çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€\r\n          if (w.isInterrupted())\r\n              s.tryCancel();\r\n          // è·å–ä¸å½“å‰ s åŒ¹é…çš„èŠ‚ç‚¹\r\n          SNode m = s.match;\r\n          if (m != null)\r\n              // å¯èƒ½æ˜¯æ­£å¸¸çš„åŒ¹é…çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯å–æ¶ˆçš„\r\n              return m;\r\n          // æ‰§è¡Œäº†è¶…æ—¶é™åˆ¶å°±åˆ¤æ–­æ˜¯å¦è¶…æ—¶\r\n          if (timed) {\r\n              nanos = deadline - System.nanoTime();\r\n              // ã€è¶…æ—¶äº†ï¼Œå–æ¶ˆèŠ‚ç‚¹ã€‘\r\n              if (nanos <= 0L) {\r\n                  s.tryCancel();\r\n                  continue;\r\n              }\r\n          }\r\n          // è¯´æ˜å½“å‰çº¿ç¨‹è¿˜å¯ä»¥è¿›è¡Œè‡ªæ—‹æ£€æŸ¥\r\n          if (spins > 0)\r\n              // è‡ªæ—‹ä¸€æ¬¡ é€’å‡ 1\r\n              spins = shouldSpin(s) ? (spins - 1) : 0;\r\n          // è¯´æ˜æ²¡æœ‰è‡ªæ—‹æ¬¡æ•°äº†\r\n          else if (s.waiter == null)\r\n              //ã€æŠŠå½“å‰ node å¯¹åº”çš„ Thread ä¿å­˜åˆ° node.waiter å­—æ®µä¸­ï¼Œè¦é˜»å¡äº†ã€‘\r\n              s.waiter = w;\r\n          // æ²¡æœ‰è¶…æ—¶é™åˆ¶ç›´æ¥é˜»å¡\r\n          else if (!timed)\r\n              LockSupport.park(this);\r\n          // nanos > 1000 çº³ç§’çš„æƒ…å†µä¸‹ï¼Œæ‰å…è®¸æŒ‚èµ·å½“å‰çº¿ç¨‹\r\n          else if (nanos > spinForTimeoutThreshold)\r\n              LockSupport.parkNanos(this, nanos);\r\n      }\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  boolean shouldSpin(SNode s) {\r\n      // è·å–æ ˆé¡¶\r\n      SNode h = head;\r\n      // æ¡ä»¶ä¸€æˆç«‹è¯´æ˜å½“å‰ s å°±æ˜¯æ ˆé¡¶ï¼Œå…è®¸è‡ªæ—‹æ£€æŸ¥\r\n      // æ¡ä»¶äºŒæˆç«‹è¯´æ˜å½“å‰ s èŠ‚ç‚¹è‡ªæ—‹æ£€æŸ¥æœŸé—´ï¼Œåˆæ¥äº†ä¸€ä¸ªä¸å½“å‰ s èŠ‚ç‚¹åŒ¹é…çš„è¯·æ±‚ï¼ŒåŒåŒå‡ºæ ˆåæ¡ä»¶ä¼šæˆç«‹\r\n      // æ¡ä»¶ä¸‰æˆç«‹å‰æå½“å‰ s ä¸æ˜¯æ ˆé¡¶å…ƒç´ ï¼Œå¹¶ä¸”å½“å‰æ ˆé¡¶æ­£åœ¨åŒ¹é…ä¸­ï¼Œè¿™ç§çŠ¶æ€æ ˆé¡¶ä¸‹é¢çš„å…ƒç´ ï¼Œéƒ½å…è®¸è‡ªæ—‹æ£€æŸ¥\r\n      return (h == s || h == null || isFulfilling(h.mode));\r\n  }\r\n  ```\r\n\r\n- clear()ï¼šæŒ‡å®šèŠ‚ç‚¹å‡ºæ ˆ\r\n\r\n  ```java\r\n  void clean(SNode s) {\r\n      // æ¸…ç©ºæ•°æ®åŸŸå’Œå…³è”çº¿ç¨‹\r\n      s.item = null;\r\n      s.waiter = null;\r\n      \r\n  \t// è·å–å–æ¶ˆèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r\n      SNode past = s.next;\r\n      // åˆ¤æ–­åç»§èŠ‚ç‚¹æ˜¯ä¸æ˜¯å–æ¶ˆèŠ‚ç‚¹ï¼Œæ˜¯å°±æ›´æ–° past\r\n      if (past != null && past.isCancelled())\r\n          past = past.next;\r\n  \r\n      SNode p;\r\n      // ä»æ ˆé¡¶å¼€å§‹å‘ä¸‹æ£€æŸ¥ï¼Œã€å°†æ ˆé¡¶å¼€å§‹å‘ä¸‹çš„ å–æ¶ˆçŠ¶æ€ çš„èŠ‚ç‚¹å…¨éƒ¨æ¸…ç†å‡ºå»ã€‘ï¼Œç›´åˆ°ç¢°åˆ° past æˆ–è€…ä¸æ˜¯å–æ¶ˆçŠ¶æ€ä¸ºæ­¢\r\n      while ((p = head) != null && p != past && p.isCancelled())\r\n          // ä¿®æ”¹çš„æ˜¯å†…å­˜åœ°å€å¯¹åº”çš„å€¼ï¼Œp æŒ‡å‘è¯¥å†…å­˜åœ°å€æ‰€ä»¥æ•°æ®ä¸€ç›´åœ¨å˜åŒ–\r\n          casHead(p, p.next);\r\n  \t// è¯´æ˜ä¸­é—´é‡åˆ°äº†ä¸æ˜¯å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œç»§ç»­è¿­ä»£ä¸‹å»\r\n      while (p != null && p != past) {\r\n          SNode n = p.next;\r\n          if (n != null && n.isCancelled())\r\n              p.casNext(n, n.next);\r\n          else\r\n              p = n;\r\n      }\r\n  }\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å…¬å¹³å®ç°\r\n\r\nTransferQueue æ˜¯å…¬å¹³çš„åŒæ­¥é˜Ÿåˆ—ï¼Œé‡‡ç”¨ FIFO çš„é˜Ÿåˆ—å®ç°ï¼Œè¯·æ±‚èŠ‚ç‚¹ä¸é˜Ÿå°¾æ¨¡å¼ä¸åŒï¼Œéœ€è¦ä¸é˜Ÿå¤´å‘ç”ŸåŒ¹é…\r\n\r\nTransferQueue ç±»æˆå‘˜å˜é‡ï¼š\r\n\r\n- æŒ‡å‘é˜Ÿåˆ—çš„ dummy èŠ‚ç‚¹ï¼š\r\n\r\n  ```java\r\n  transient volatile QNode head;\r\n  ```\r\n\r\n- æŒ‡å‘é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼š\r\n\r\n  ```java\r\n  transient volatile QNode tail;\r\n  ```\r\n\r\n- è¢«æ¸…ç†èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼š\r\n\r\n  ```java\r\n  transient volatile QNode cleanMe;\r\n  ```\r\n\r\n  å…¥é˜Ÿæ“ä½œæ˜¯ä¸¤æ­¥å®Œæˆçš„ï¼Œç¬¬ä¸€æ­¥æ˜¯ `t.next = newNode`ï¼Œç¬¬äºŒæ­¥æ˜¯ `tail = newNode`ï¼Œæ‰€ä»¥é˜Ÿå°¾èŠ‚ç‚¹å‡ºé˜Ÿï¼Œæ˜¯ä¸€ç§éå¸¸ç‰¹æ®Šçš„æƒ…å†µ\r\n\r\nTransferQueue å†…éƒ¨ç±»ï¼š\r\n\r\n- QNodeï¼š\r\n\r\n  ```java\r\n  static final class QNode {\r\n      // æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r\n      volatile QNode next;\r\n      // æ•°æ®åŸŸï¼ŒNode ä»£è¡¨çš„æ˜¯ DATA ç±»å‹ item è¡¨ç¤ºæ•°æ®ï¼Œå¦åˆ™ Node ä»£è¡¨çš„ REQUEST ç±»å‹ï¼Œitem == null\r\n      volatile Object item;\r\n      // å‡è®¾å½“å‰ node å¯¹åº”çš„çº¿ç¨‹è‡ªæ—‹æœŸé—´æœªè¢«åŒ¹é…æˆåŠŸï¼Œé‚£ä¹ˆ node å¯¹åº”çš„çº¿ç¨‹éœ€è¦æŒ‚èµ·ï¼Œ\r\n      // æŒ‚èµ·å‰ waiter ä¿å­˜å¯¹åº”çš„çº¿ç¨‹å¼•ç”¨ï¼Œæ–¹ä¾¿åŒ¹é…æˆåŠŸåè¢«å”¤é†’ã€‚\r\n      volatile Thread waiter;\r\n      // true å½“å‰ Node æ˜¯ä¸€ä¸ª DATA ç±»å‹ï¼Œfalse è¡¨ç¤ºå½“å‰ Node æ˜¯ä¸€ä¸ª REQUEST ç±»å‹\r\n      final boolean isData;\r\n  \r\n  \t// æ„å»ºæ–¹æ³•\r\n      QNode(Object item, boolean isData) {\r\n          this.item = item;\r\n          this.isData = isData;\r\n      }\r\n  \r\n      // å°è¯•å–æ¶ˆå½“å‰ nodeï¼Œå–æ¶ˆçŠ¶æ€çš„ node çš„ item åŸŸæŒ‡å‘è‡ªå·±\r\n      void tryCancel(Object cmp) {\r\n          UNSAFE.compareAndSwapObject(this, itemOffset, cmp, this);\r\n      }\r\n  \r\n      // åˆ¤æ–­å½“å‰ node æ˜¯å¦ä¸ºå–æ¶ˆçŠ¶æ€\r\n      boolean isCancelled() {\r\n          return item == this;\r\n      }\r\n  \r\n      // åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ â€œä¸åœ¨â€ é˜Ÿåˆ—å†…ï¼Œå½“ next æŒ‡å‘è‡ªå·±æ—¶ï¼Œè¯´æ˜èŠ‚ç‚¹å·²ç»å‡ºé˜Ÿã€‚\r\n      boolean isOffList() {\r\n          return next == this;\r\n      }\r\n  }\r\n  ```\r\n\r\nTransferQueue ç±»æˆå‘˜æ–¹æ³•ï¼š\r\n\r\n- è®¾ç½®å¤´å°¾èŠ‚ç‚¹ï¼š\r\n\r\n  ```java\r\n  void advanceHead(QNode h, QNode nh) {\r\n      // è®¾ç½®å¤´æŒ‡é’ˆæŒ‡å‘æ–°çš„èŠ‚ç‚¹ï¼Œ\r\n      if (h == head && UNSAFE.compareAndSwapObject(this, headOffset, h, nh))\r\n          // è€çš„å¤´èŠ‚ç‚¹å‡ºé˜Ÿ\r\n          h.next = h;\r\n  }\r\n  void advanceTail(QNode t, QNode nt) {\r\n      if (tail == t)\r\n          // æ›´æ–°é˜Ÿå°¾èŠ‚ç‚¹ä¸ºæ–°çš„é˜Ÿå°¾\r\n          UNSAFE.compareAndSwapObject(this, tailOffset, t, nt);\r\n  }\r\n  ```\r\n\r\n- transfer()ï¼šæ ¸å¿ƒæ–¹æ³•\r\n\r\n  ```java\r\n  E transfer(E e, boolean timed, long nanos) {\r\n      // s æŒ‡å‘å½“å‰è¯·æ±‚å¯¹åº”çš„ node\r\n      QNode s = null;\r\n      // æ˜¯å¦æ˜¯ DATA ç±»å‹çš„è¯·æ±‚\r\n      boolean isData = (e != null);\r\n  \t// è‡ªæ—‹\r\n      for (;;) {\r\n          QNode t = tail;\r\n          QNode h = head;\r\n          if (t == null || h == null)\r\n              continue;\r\n  \t\t// head å’Œ tail åŒæ—¶æŒ‡å‘ dummy èŠ‚ç‚¹ï¼Œè¯´æ˜æ˜¯ç©ºé˜Ÿåˆ—\r\n          // é˜Ÿå°¾èŠ‚ç‚¹ä¸å½“å‰è¯·æ±‚ç±»å‹æ˜¯ä¸€è‡´çš„æƒ…å†µï¼Œè¯´æ˜é˜»å¡é˜Ÿåˆ—ä¸­éƒ½æ— æ³•åŒ¹é…ï¼Œ\r\n          if (h == t || t.isData == isData) {\r\n              // è·å–é˜Ÿå°¾ t çš„ next èŠ‚ç‚¹\r\n              QNode tn = t.next;\r\n              // å¤šçº¿ç¨‹ç¯å¢ƒä¸­å…¶ä»–çº¿ç¨‹å¯èƒ½ä¿®æ”¹å°¾èŠ‚ç‚¹\r\n              if (t != tail)\r\n                  continue;\r\n              // å·²ç»æœ‰çº¿ç¨‹å…¥é˜Ÿäº†ï¼Œæ›´æ–° tail\r\n              if (tn != null) {\r\n                  advanceTail(t, tn);\r\n                  continue;\r\n              }\r\n              // å…è®¸è¶…æ—¶ï¼Œè¶…æ—¶æ—¶é—´å°äº 0ï¼Œè¿™ç§æ–¹æ³•ä¸æ”¯æŒé˜»å¡ç­‰å¾…\r\n              if (timed && nanos <= 0)\r\n                  return null;\r\n              // åˆ›å»º node çš„é€»è¾‘\r\n              if (s == null)\r\n                  s = new QNode(e, isData);\r\n              // å°† node æ·»åŠ åˆ°é˜Ÿå°¾\r\n              if (!t.casNext(null, s))\r\n                  continue;\r\n  \t\t\t// æ›´æ–°é˜Ÿå°¾æŒ‡é’ˆ\r\n              advanceTail(t, s);\r\n              \r\n              // å½“å‰èŠ‚ç‚¹ ç­‰å¾…åŒ¹é…....\r\n              Object x = awaitFulfill(s, e, timed, nanos);\r\n              \r\n              // è¯´æ˜ã€å½“å‰ node çŠ¶æ€ä¸º å–æ¶ˆçŠ¶æ€ã€‘ï¼Œéœ€è¦åšå‡ºé˜Ÿé€»è¾‘\r\n              if (x == s) {\r\n                  clean(t, s);\r\n                  return null;\r\n              }\r\n  \t\t\t// è¯´æ˜å½“å‰ node ä»ç„¶åœ¨é˜Ÿåˆ—å†…ï¼ŒåŒ¹é…æˆåŠŸï¼Œéœ€è¦åšå‡ºé˜Ÿé€»è¾‘\r\n              if (!s.isOffList()) {\r\n                  // t æ˜¯å½“å‰ s èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œåˆ¤æ–­ t æ˜¯ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œæ˜¯å°±æ›´æ–° dummy èŠ‚ç‚¹ä¸º s èŠ‚ç‚¹\r\n                  advanceHead(t, s);\r\n                  // s èŠ‚ç‚¹å·²ç»å‡ºé˜Ÿï¼Œæ‰€ä»¥éœ€è¦æŠŠå®ƒçš„ item åŸŸè®¾ç½®ä¸ºå®ƒè‡ªå·±ï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸ªå–æ¶ˆçŠ¶æ€\r\n                  if (x != null)\r\n                      s.item = s;\r\n                  s.waiter = null;\r\n              }\r\n              return (x != null) ? (E)x : e;\r\n  \t\t// é˜Ÿå°¾èŠ‚ç‚¹ä¸å½“å‰è¯·æ±‚èŠ‚ç‚¹ã€äº’è¡¥åŒ¹é…ã€‘\r\n          } else {\r\n              // h.next èŠ‚ç‚¹ï¼Œã€è¯·æ±‚èŠ‚ç‚¹ä¸é˜Ÿå°¾æ¨¡å¼ä¸åŒï¼Œéœ€è¦ä¸é˜Ÿå¤´å‘ç”ŸåŒ¹é…ã€‘ï¼ŒTransferQueue æ˜¯ä¸€ä¸ªã€å…¬å¹³æ¨¡å¼ã€‘\r\n              QNode m = h.next;\r\n              // å¹¶å‘å¯¼è‡´å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†é˜Ÿå°¾èŠ‚ç‚¹ï¼Œæˆ–è€…å·²ç»æŠŠ head.next åŒ¹é…èµ°äº†\r\n              if (t != tail || m == null || h != head)\r\n                  continue;\r\n  \t\t\t// è·å–åŒ¹é…èŠ‚ç‚¹çš„æ•°æ®åŸŸä¿å­˜åˆ° x\r\n              Object x = m.item;\r\n              // åˆ¤æ–­æ˜¯å¦åŒ¹é…æˆåŠŸ\r\n              if (isData == (x != null) ||\r\n                  x == m ||\r\n                  !m.casItem(x, e)) {\r\n                  advanceHead(h, m);\r\n                  continue;\r\n              }\r\n  \t\t\t// ã€åŒ¹é…å®Œæˆã€‘ï¼Œå°†å¤´èŠ‚ç‚¹å‡ºé˜Ÿï¼Œè®©è¿™ä¸ªæ–°çš„å¤´ç»“ç‚¹æˆä¸º dummy èŠ‚ç‚¹\r\n              advanceHead(h, m);\r\n              // å”¤é†’è¯¥åŒ¹é…èŠ‚ç‚¹çš„çº¿ç¨‹\r\n              LockSupport.unpark(m.waiter);\r\n              return (x != null) ? (E)x : e;\r\n          }\r\n      }\r\n  }\r\n  ```\r\n\r\n- `awaitFulfill()`ï¼šé˜»å¡å½“å‰çº¿ç¨‹ç­‰å¾…è¢«åŒ¹é…\r\n\r\n  ```java\r\n  Object awaitFulfill(QNode s, E e, boolean timed, long nanos) {\r\n      // è¡¨ç¤ºç­‰å¾…æˆªæ­¢æ—¶é—´\r\n      final long deadline = timed ? System.nanoTime() + nanos : 0L;\r\n      Thread w = Thread.currentThread();\r\n      // è‡ªé€‰æ£€æŸ¥çš„æ¬¡æ•°\r\n      int spins = ((head.next == s) ? (timed ? maxTimedSpins : maxUntimedSpins) : 0);\r\n      for (;;) {\r\n          // è¢«æ‰“æ–­å°±å–æ¶ˆèŠ‚ç‚¹\r\n          if (w.isInterrupted())\r\n              s.tryCancel(e);\r\n          // è·å–å½“å‰ Node æ•°æ®åŸŸ\r\n          Object x = s.item;\r\n          \r\n          // å½“å‰è¯·æ±‚ä¸º DATA æ¨¡å¼æ—¶ï¼še è¯·æ±‚å¸¦æ¥çš„æ•°æ®\r\n          // s.item ä¿®æ”¹ä¸º thisï¼Œè¯´æ˜å½“å‰ QNode å¯¹åº”çš„çº¿ç¨‹ å–æ¶ˆçŠ¶æ€\r\n          // s.item ä¿®æ”¹ä¸º null è¡¨ç¤ºå·²ç»æœ‰åŒ¹é…èŠ‚ç‚¹äº†ï¼Œå¹¶ä¸”åŒ¹é…èŠ‚ç‚¹æ‹¿èµ°äº† item æ•°æ®\r\n  \r\n          // å½“å‰è¯·æ±‚ä¸º REQUEST æ¨¡å¼æ—¶ï¼še == null\r\n          // s.item ä¿®æ”¹ä¸º thisï¼Œè¯´æ˜å½“å‰ QNode å¯¹åº”çš„çº¿ç¨‹ å–æ¶ˆçŠ¶æ€\r\n          // s.item != null ä¸” item != this  è¡¨ç¤ºå½“å‰ REQUEST ç±»å‹çš„ Node å·²ç»åŒ¹é…åˆ° DATA äº† \r\n          if (x != e)\r\n              return x;\r\n          // è¶…æ—¶æ£€æŸ¥\r\n          if (timed) {\r\n              nanos = deadline - System.nanoTime();\r\n              if (nanos <= 0L) {\r\n                  s.tryCancel(e);\r\n                  continue;\r\n              }\r\n          }\r\n          // è‡ªæ—‹æ¬¡æ•°å‡ä¸€\r\n          if (spins > 0)\r\n              --spins;\r\n          // æ²¡æœ‰è‡ªæ—‹æ¬¡æ•°äº†ï¼ŒæŠŠå½“å‰çº¿ç¨‹å°è£…è¿›å» waiter\r\n          else if (s.waiter == null)\r\n              s.waiter = w;\r\n          // é˜»å¡\r\n          else if (!timed)\r\n              LockSupport.park(this);\r\n          else if (nanos > spinForTimeoutThreshold)\r\n              LockSupport.parkNanos(this, nanos);\r\n      }\r\n  }\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### æ“ä½œPool\r\n\r\n#### åˆ›å»ºæ–¹å¼\r\n\r\n##### Executor\r\n\r\nå­˜æ”¾çº¿ç¨‹çš„å®¹å™¨ï¼š\r\n\r\n```java\r\nprivate final HashSet<Worker> workers = new HashSet<Worker>();\r\n```\r\n\r\næ„é€ æ–¹æ³•ï¼š\r\n\r\n```java\r\npublic ThreadPoolExecutor(int corePoolSize,\r\n                          int maximumPoolSize,\r\n                          long keepAliveTime,\r\n                          TimeUnit unit,\r\n                          BlockingQueue<Runnable> workQueue,\r\n                          ThreadFactory threadFactory,\r\n                          RejectedExecutionHandler handler)\r\n```\r\n\r\nå‚æ•°ä»‹ç»ï¼š\r\n\r\n- corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡\r\n\r\n- maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ï¼Œå½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡æ—¶ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ›å»ºçº¿ç¨‹å¹¶ç«‹å³æ‰§è¡Œæœ€æ–°çš„ä»»åŠ¡ï¼Œä¸æ ¸å¿ƒçº¿ç¨‹æ•°ä¹‹é—´çš„å·®å€¼åˆå«æ•‘æ€¥çº¿ç¨‹æ•°\r\n\r\n- keepAliveTimeï¼šæ•‘æ€¥çº¿ç¨‹æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº `corePoolSize` çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰åˆ° `keepAliveTime` æ—¶é—´è¶…è¿‡é”€æ¯\r\n\r\n- unitï¼š`keepAliveTime` å‚æ•°çš„æ—¶é—´å•ä½\r\n\r\n- workQueueï¼šé˜»å¡é˜Ÿåˆ—ï¼Œå­˜æ”¾è¢«æäº¤ä½†å°šæœªè¢«æ‰§è¡Œçš„ä»»åŠ¡\r\n\r\n- threadFactoryï¼šçº¿ç¨‹å·¥å‚ï¼Œåˆ›å»ºæ–°çº¿ç¨‹æ—¶ç”¨åˆ°ï¼Œå¯ä»¥ä¸ºçº¿ç¨‹åˆ›å»ºæ—¶èµ·åå­—\r\n\r\n- handlerï¼šæ‹’ç»ç­–ç•¥ï¼Œçº¿ç¨‹åˆ°è¾¾æœ€å¤§çº¿ç¨‹æ•°ä»æœ‰æ–°ä»»åŠ¡æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥\r\n\r\n  RejectedExecutionHandler ä¸‹æœ‰ 4 ä¸ªå®ç°ç±»ï¼š\r\n\r\n  - AbortPolicyï¼šè®©è°ƒç”¨è€…æŠ›å‡º RejectedExecutionException å¼‚å¸¸ï¼Œ**é»˜è®¤ç­–ç•¥**\r\n  - CallerRunsPolicyï¼šè®©è°ƒç”¨è€…è¿è¡Œçš„è°ƒèŠ‚æœºåˆ¶ï¼Œå°†æŸäº›ä»»åŠ¡å›é€€åˆ°è°ƒç”¨è€…ï¼Œä»è€Œé™ä½æ–°ä»»åŠ¡çš„æµé‡\r\n  - DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œä¸äºˆä»»ä½•å¤„ç†ä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸\r\n  - DiscardOldestPolicyï¼šæ”¾å¼ƒé˜Ÿåˆ—ä¸­æœ€æ—©çš„ä»»åŠ¡ï¼ŒæŠŠå½“å‰ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ä¸­å°è¯•å†æ¬¡æäº¤å½“å‰ä»»åŠ¡\r\n\r\n  è¡¥å……ï¼šå…¶ä»–æ¡†æ¶æ‹’ç»ç­–ç•¥\r\n\r\n  - Dubboï¼šåœ¨æŠ›å‡º RejectedExecutionException å¼‚å¸¸å‰è®°å½•æ—¥å¿—ï¼Œå¹¶ dump çº¿ç¨‹æ ˆä¿¡æ¯ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜\r\n  - Nettyï¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡\r\n  - ActiveMQï¼šå¸¦è¶…æ—¶ç­‰å¾…ï¼ˆ60sï¼‰å°è¯•æ”¾å…¥é˜Ÿåˆ—\r\n  - PinPointï¼šå®ƒä½¿ç”¨äº†ä¸€ä¸ªæ‹’ç»ç­–ç•¥é“¾ï¼Œä¼šé€ä¸€å°è¯•ç­–ç•¥é“¾ä¸­æ¯ç§æ‹’ç»ç­–ç•¥\r\n\r\nå·¥ä½œåŸç†ï¼š\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824172606265.png\" alt=\"image-20230824172606265\" class=\"scale-80\" />\r\n\r\n1. åˆ›å»ºçº¿ç¨‹æ± ï¼Œè¿™æ—¶æ²¡æœ‰åˆ›å»ºçº¿ç¨‹ï¼ˆ**æ‡’æƒ°**ï¼‰ï¼Œç­‰å¾…æäº¤è¿‡æ¥çš„ä»»åŠ¡è¯·æ±‚ï¼Œ**è°ƒç”¨ execute æ–¹æ³•æ‰ä¼šåˆ›å»ºçº¿ç¨‹**\r\n\r\n2. å½“è°ƒç”¨ execute() æ–¹æ³•æ·»åŠ ä¸€ä¸ªè¯·æ±‚ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåšå¦‚ä¸‹åˆ¤æ–­ï¼š\r\n   - å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å°äº corePoolSizeï¼Œé‚£ä¹ˆé©¬ä¸Šåˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡\r\n   - å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äº corePoolSizeï¼Œé‚£ä¹ˆå°†è¿™ä¸ªä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—\r\n   - å¦‚æœè¿™æ—¶é˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¿˜å°äº maximumPoolSizeï¼Œé‚£ä¹ˆä¼šåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹**ç«‹åˆ»è¿è¡Œè¿™ä¸ªä»»åŠ¡**ï¼Œå¯¹äºé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸å…¬å¹³ã€‚è¿™æ˜¯å› ä¸ºåˆ›å»ºæ¯ä¸ª Workerï¼ˆçº¿ç¨‹ï¼‰å¯¹è±¡ä¼šç»‘å®šä¸€ä¸ªåˆå§‹ä»»åŠ¡ï¼Œå¯åŠ¨ Worker æ—¶ä¼šä¼˜å…ˆæ‰§è¡Œ\r\n   - å¦‚æœé˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äº maximumPoolSizeï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šå¯åŠ¨é¥±å’Œ**æ‹’ç»ç­–ç•¥**æ¥æ‰§è¡Œ\r\n3. å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡æ—¶ï¼Œä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œ\r\n\r\n4. å½“ä¸€ä¸ªçº¿ç¨‹ç©ºé—²è¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼ˆkeepAliveTimeï¼‰æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ¤æ–­ï¼šå¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äº corePoolSizeï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±è¢«åœæ‰ï¼Œæ‰€ä»¥çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆåæœ€ç»ˆä¼šæ”¶ç¼©åˆ° corePoolSize å¤§å°\r\n\r\n\r\n\r\nå›¾ç‰‡æ¥æºï¼šhttps://space.bilibili.com/457326371/\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### Executors\r\n\r\nExecutors æä¾›äº†å››ç§çº¿ç¨‹æ± çš„åˆ›å»ºï¼šnewCachedThreadPoolã€newFixedThreadPoolã€newSingleThreadExecutorã€newScheduledThreadPool\r\n\r\n- newFixedThreadPoolï¼šåˆ›å»ºä¸€ä¸ªæ‹¥æœ‰ n ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± \r\n\r\n  ```java\r\n  public static ExecutorService newFixedThreadPool(int nThreads) {\r\n      return new ThreadPoolExecutor(nThreads, nThreads, 0L, TimeUnit.MILLISECONDS,\r\n                                    new LinkedBlockingQueue<Runnable>());\r\n  }\r\n  ```\r\n\r\n  - æ ¸å¿ƒçº¿ç¨‹æ•° == æœ€å¤§çº¿ç¨‹æ•°ï¼ˆæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹è¢«åˆ›å»ºï¼‰ï¼Œå› æ­¤ä¹Ÿæ— éœ€è¶…æ—¶æ—¶é—´\r\n  - LinkedBlockingQueue æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°ä¸º `Integer.MAX_VALUE`ï¼Œä¹Ÿå°±æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œå¯ä»¥æ”¾ä»»æ„æ•°é‡çš„ä»»åŠ¡ï¼Œåœ¨ä»»åŠ¡æ¯”è¾ƒå¤šçš„æ—¶å€™ä¼šå¯¼è‡´ OOMï¼ˆå†…å­˜æº¢å‡ºï¼‰\r\n  - é€‚ç”¨äºä»»åŠ¡é‡å·²çŸ¥ï¼Œç›¸å¯¹è€—æ—¶çš„é•¿æœŸä»»åŠ¡\r\n\r\n- newCachedThreadPoolï¼šåˆ›å»ºä¸€ä¸ªå¯æ‰©å®¹çš„çº¿ç¨‹æ± \r\n\r\n  ```java\r\n  public static ExecutorService newCachedThreadPool() {\r\n      return new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS,\r\n                                    new SynchronousQueue<Runnable>());\r\n  }\r\n  ```\r\n\r\n  - æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ 0ï¼Œ æœ€å¤§çº¿ç¨‹æ•°æ˜¯ 29 ä¸ª 1ï¼Œå…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼ˆ60s åå¯ä»¥å›æ”¶ï¼‰ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ **OOM**\r\n  - SynchronousQueue ä½œä¸ºé˜»å¡é˜Ÿåˆ—ï¼Œæ²¡æœ‰å®¹é‡ï¼Œå¯¹äºæ¯ä¸€ä¸ª take çš„çº¿ç¨‹ä¼šé˜»å¡ç›´åˆ°æœ‰ä¸€ä¸ª put çš„çº¿ç¨‹æ”¾å…¥å…ƒç´ ä¸ºæ­¢ï¼ˆç±»ä¼¼ä¸€æ‰‹äº¤é’±ã€ä¸€æ‰‹äº¤è´§ï¼‰\r\n\r\n  - é€‚åˆä»»åŠ¡æ•°æ¯”è¾ƒå¯†é›†ï¼Œä½†æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„æƒ…å†µ\r\n\r\n- newSingleThreadExecutorï¼šåˆ›å»ºä¸€ä¸ªåªæœ‰ 1 ä¸ªçº¿ç¨‹çš„å•çº¿ç¨‹æ± \r\n\r\n  ```java\r\n  public static ExecutorService newSingleThreadExecutor() {\r\n      return new FinalizableDelegatedExecutorService\r\n          (new ThreadPoolExecutor(1, 1,0L, TimeUnit.MILLISECONDS,\r\n                                  new LinkedBlockingQueue<Runnable>()));\r\n  }\r\n  ```\r\n\r\n  - ä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§**æŒ‡å®šé¡ºåºæ‰§è¡Œ**ï¼Œçº¿ç¨‹æ•°å›ºå®šä¸º 1ï¼Œä»»åŠ¡æ•°å¤šäº 1 æ—¶ä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™å”¯ä¸€çš„çº¿ç¨‹ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾\r\n\r\n\r\nå¯¹æ¯”ï¼š\r\n\r\n- åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥è€Œç»ˆæ­¢é‚£ä¹ˆæ²¡æœ‰ä»»ä½•è¡¥æ•‘æªæ–½ï¼Œçº¿ç¨‹æ± ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¿è¯æ± çš„æ­£å¸¸å·¥ä½œ\r\n\r\n- `Executors.newSingleThreadExecutor()` çº¿ç¨‹ä¸ªæ•°å§‹ç»ˆä¸º 1ï¼Œä¸èƒ½ä¿®æ”¹ã€‚`FinalizableDelegatedExecutorService` åº”ç”¨çš„æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œåªå¯¹å¤–æš´éœ²äº† ExecutorService æ¥å£ï¼Œå› æ­¤ä¸èƒ½è°ƒç”¨ ThreadPoolExecutor ä¸­ç‰¹æœ‰çš„æ–¹æ³•\r\n\r\n  åŸå› ï¼šçˆ¶ç±»ä¸èƒ½ç›´æ¥è°ƒç”¨å­ç±»ä¸­çš„æ–¹æ³•ï¼Œéœ€è¦åå°„æˆ–è€…åˆ›å»ºå¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥è°ƒç”¨å­ç±»é™æ€æ–¹æ³•\r\n\r\n- `Executors.newFixedThreadPool(1)` åˆå§‹æ—¶ä¸º 1ï¼Œå¯ä»¥ä¿®æ”¹ã€‚å¯¹å¤–æš´éœ²çš„æ˜¯ ThreadPoolExecutor å¯¹è±¡ï¼Œå¯ä»¥å¼ºè½¬åè°ƒç”¨ setCorePoolSize ç­‰æ–¹æ³•è¿›è¡Œä¿®æ”¹\r\n\r\n![](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/JUC-newSingleThreadExecutor.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å¼€å‘è¦æ±‚\r\n\r\né˜¿é‡Œå·´å·´ `Java` å¼€å‘æ‰‹å†Œè¦æ±‚ï¼š\r\n\r\n- **çº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹**\r\n\r\n  - ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºçš„å¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜\r\n\r\n\r\n  - å¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½é€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…è¿‡åº¦åˆ‡æ¢çš„é—®é¢˜\r\n\r\n\r\n  - çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©\r\n\r\n\r\n- Executors è¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡å¼Šç«¯å¦‚ä¸‹ï¼š\r\n\r\n  - FixedThreadPool å’Œ SingleThreadPoolï¼šè¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸º `Integer.MAX_VALUE`ï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOM\r\n\r\n\r\n  - CacheThreadPool å’Œ ScheduledThreadPoolï¼šå…è®¸åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸º `Integer.MAX_VALUE`ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œå¯¼è‡´ OOM\r\n\r\n\r\nåˆ›å»ºå¤šå¤§å®¹é‡çš„çº¿ç¨‹æ± åˆé€‚ï¼Ÿ\r\n\r\n- ä¸€èˆ¬æ¥è¯´æ± ä¸­**æ€»çº¿ç¨‹æ•°æ˜¯æ ¸å¿ƒæ± çº¿ç¨‹æ•°é‡ä¸¤å€**ï¼Œç¡®ä¿å½“æ ¸å¿ƒæ± æœ‰çº¿ç¨‹åœæ­¢æ—¶ï¼Œæ ¸å¿ƒæ± å¤–æœ‰çº¿ç¨‹è¿›å…¥æ ¸å¿ƒæ± \r\n\r\n- è¿‡å°ä¼šå¯¼è‡´ç¨‹åºä¸èƒ½å……åˆ†åœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºã€å®¹æ˜“å¯¼è‡´é¥¥é¥¿\r\n\r\n- è¿‡å¤§ä¼šå¯¼è‡´æ›´å¤šçš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå ç”¨æ›´å¤šå†…å­˜\r\n\r\n\r\nä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ï¼Œä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢\r\n\r\næ ¸å¿ƒçº¿ç¨‹æ•°å¸¸ç”¨å…¬å¼ï¼š\r\n\r\n- **CPU å¯†é›†å‹ä»»åŠ¡ (N+1)ï¼š** è¿™ç§ä»»åŠ¡æ¶ˆè€—çš„æ˜¯ CPU èµ„æºï¼Œå¯ä»¥å°†æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º N (CPU æ ¸å¿ƒæ•°) + 1ï¼Œæ¯” CPU æ ¸å¿ƒæ•°å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹å‘ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´çš„ä»»åŠ¡æš‚åœè€Œå¸¦æ¥çš„å½±å“ã€‚ä¸€æ—¦ä»»åŠ¡æš‚åœï¼ŒCPU æŸä¸ªæ ¸å¿ƒå°±ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„ç©ºé—²æ—¶é—´\r\n  - CPU å¯†é›†å‹ç®€å•ç†è§£å°±æ˜¯åˆ©ç”¨ CPU è®¡ç®—èƒ½åŠ›çš„ä»»åŠ¡æ¯”å¦‚åœ¨å†…å­˜ä¸­å¯¹å¤§é‡æ•°æ®è¿›è¡Œåˆ†æ\r\n\r\n- **`I/O` å¯†é›†å‹ä»»åŠ¡ï¼š** è¿™ç§ç³»ç»Ÿ CPU å¤„äºé˜»å¡çŠ¶æ€ï¼Œç”¨å¤§éƒ¨åˆ†çš„æ—¶é—´æ¥å¤„ç† `I/O` äº¤äº’ï¼Œè€Œçº¿ç¨‹åœ¨å¤„ç† `I/O` çš„æ—¶é—´æ®µå†…ä¸ä¼šå ç”¨ CPU æ¥å¤„ç†ï¼Œè¿™æ—¶å°±å¯ä»¥å°† CPU äº¤å‡ºç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ï¼Œå› æ­¤åœ¨ `I/O` å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šé…ç½®ä¸€äº›çº¿ç¨‹ï¼Œå…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯ 2N æˆ– `CPU æ ¸æ•°/ (1-é˜»å¡ç³»æ•°)`ï¼Œé˜»å¡ç³»æ•°åœ¨ 0.8~0.9 ä¹‹é—´\r\n  - IO å¯†é›†å‹å°±æ˜¯æ¶‰åŠåˆ°ç½‘ç»œè¯»å–ï¼Œæ–‡ä»¶è¯»å–æ­¤ç±»ä»»åŠ¡ ï¼Œç‰¹ç‚¹æ˜¯ CPU è®¡ç®—è€—è´¹æ—¶é—´ç›¸æ¯”äºç­‰å¾… IO æ“ä½œå®Œæˆçš„æ—¶é—´æ¥è¯´å¾ˆå°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ç­‰å¾… IO æ“ä½œå®Œæˆä¸Š\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æäº¤æ–¹æ³•\r\n\r\nExecutorService ç±» APIï¼š\r\n\r\n| æ–¹æ³•                                                         | è¯´æ˜                                                         |\r\n| ------------------------------------------------------------ | ------------------------------------------------------------ |\r\n| `void execute(Runnable command)`                             | æ‰§è¡Œä»»åŠ¡ï¼ˆExecutor ç±» APIï¼‰                                  |\r\n| `Future<?> submit(Runnable task)`                            | æäº¤ä»»åŠ¡ task()                                              |\r\n| `Future submit(Callable<T> task)`                            | æäº¤ä»»åŠ¡ taskï¼Œç”¨è¿”å›å€¼ Future è·å¾—ä»»åŠ¡æ‰§è¡Œç»“æœ              |\r\n| `List<Future<T>> invokeAll(Collection<? extends Callable<T>> tasks)` | æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡                                        |\r\n| `List<Future<T>> invokeAll(Collection<? extends Callable<T>> tasks, long timeout, TimeUnit unit)` | æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œè¶…æ—¶æ—¶é—´é’ˆå¯¹æ‰€æœ‰taskï¼Œè¶…æ—¶ä¼šå–æ¶ˆæ²¡æœ‰æ‰§è¡Œå®Œçš„ä»»åŠ¡ï¼Œå¹¶æŠ›å‡ºè¶…æ—¶å¼‚å¸¸ |\r\n| `T invokeAny(Collection<? extends Callable<T>> tasks)`       | æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶å®ƒä»»åŠ¡å–æ¶ˆ |\r\n\r\nexecute å’Œ submit éƒ½å±äºçº¿ç¨‹æ± çš„æ–¹æ³•ï¼Œå¯¹æ¯”ï¼š\r\n\r\n- execute åªèƒ½æ‰§è¡Œ Runnable ç±»å‹çš„ä»»åŠ¡ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼› submit æ—¢èƒ½æäº¤ Runnable ç±»å‹ä»»åŠ¡ä¹Ÿèƒ½æäº¤ Callable ç±»å‹ä»»åŠ¡ï¼Œåº•å±‚æ˜¯**å°è£…æˆ FutureTaskï¼Œç„¶åè°ƒç”¨ execute æ‰§è¡Œ**\r\n\r\n- execute ä¼šç›´æ¥æŠ›å‡ºä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸ï¼Œsubmit ä¼šåæ‰å¼‚å¸¸ï¼Œå¯é€šè¿‡ Future çš„ get æ–¹æ³•å°†ä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸é‡æ–°æŠ›å‡º\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å…³é—­æ–¹æ³•\r\n\r\nExecutorService ç±» APIï¼š\r\n\r\n| æ–¹æ³•                                                    | è¯´æ˜                                                         |\r\n| ------------------------------------------------------- | ------------------------------------------------------------ |\r\n| `void shutdown()`                                       | çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º SHUTDOWNï¼Œç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œåå…³é—­çº¿ç¨‹æ± ï¼Œä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†å·²æäº¤ä»»åŠ¡ä¼šæ‰§è¡Œå®Œï¼Œè€Œä¸”ä¹Ÿå¯ä»¥æ·»åŠ çº¿ç¨‹ï¼ˆä¸ç»‘å®šä»»åŠ¡ï¼‰ |\r\n| `List<Runnable> shutdownNow()`                          | çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º STOPï¼Œç”¨ interrupt ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç›´æ¥å…³é—­çº¿ç¨‹æ± ï¼Œä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¼šå°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿”å› |\r\n| `boolean isShutdown()`                                  | ä¸åœ¨ RUNNING çŠ¶æ€çš„çº¿ç¨‹æ± ï¼Œæ­¤æ‰§è¡Œè€…å·²è¢«å…³é—­ï¼Œæ–¹æ³•è¿”å› true   |\r\n| `boolean isTerminated()`                                | çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ˜¯ TERMINATEDï¼Œå¦‚æœæ‰€æœ‰ä»»åŠ¡åœ¨å…³é—­åå®Œæˆï¼Œè¿”å› true |\r\n| `boolean awaitTermination(long timeout, TimeUnit unit)` | è°ƒç”¨ shutdown åï¼Œç”±äºè°ƒç”¨çº¿ç¨‹ä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡è¿è¡Œç»“æŸï¼Œå¦‚æœå®ƒæƒ³åœ¨çº¿ç¨‹æ±  TERMINATED ååšäº›äº‹æƒ…ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ–¹æ³•ç­‰å¾… |\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å¤„ç†å¼‚å¸¸\r\n\r\nexecute ä¼šç›´æ¥æŠ›å‡ºä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸ï¼Œsubmit ä¼šåæ‰å¼‚å¸¸ï¼Œæœ‰ä¸¤ç§å¤„ç†æ–¹æ³•\r\n\r\næ–¹æ³• 1ï¼šä¸»åŠ¨æ‰å¼‚å¸¸\r\n\r\n```java\r\nExecutorService executorService = Executors.newFixedThreadPool(1);\r\npool.submit(() -> {\r\n    try {\r\n        System.out.println(\"task1\");\r\n        int i = 1 / 0;\r\n    } catch (Exception e) {\r\n        e.printStackTrace();\r\n    }\r\n});\r\n```\r\n\r\næ–¹æ³• 2ï¼šä½¿ç”¨ Future å¯¹è±¡\r\n\r\n```java\r\nExecutorService executorService = Executors.newFixedThreadPool(1);\r\nFuture<?> future = pool.submit(() -> {\r\n    System.out.println(\"task1\");\r\n    int i = 1 / 0;\r\n    return true;\r\n});\r\nSystem.out.println(future.get());\r\n```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å·¥ä½œåŸç†\r\n\r\n#### çŠ¶æ€ä¿¡æ¯\r\n\r\nThreadPoolExecutor ä½¿ç”¨ int çš„**é«˜ 3 ä½æ¥è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½ 29 ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡**ã€‚è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªåŸå­å˜é‡ ctl ä¸­ï¼Œç›®çš„æ˜¯å°†çº¿ç¨‹æ± çŠ¶æ€ä¸çº¿ç¨‹ä¸ªæ•°åˆäºŒä¸ºä¸€ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ä¸€æ¬¡ CAS åŸå­æ“ä½œè¿›è¡Œèµ‹å€¼\r\n\r\n- çŠ¶æ€è¡¨ç¤ºï¼š\r\n\r\n  ```java\r\n  // é«˜3ä½ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼Œé™¤å»é«˜3ä½ä¹‹åçš„ä½ä½ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± ä¸­æ‰€æ‹¥æœ‰çš„çº¿ç¨‹æ•°é‡\r\n  private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));\r\n  // è¡¨ç¤ºåœ¨ ctl ä¸­ï¼Œä½ COUNT_BITS ä½ï¼Œæ˜¯ç”¨äºå­˜æ”¾å½“å‰çº¿ç¨‹æ•°é‡çš„ä½\r\n  private static final int COUNT_BITS = Integer.SIZE - 3;\r\n  // ä½ COUNT_BITS ä½æ‰€èƒ½è¡¨è¾¾çš„æœ€å¤§æ•°å€¼ï¼Œ000 11111111111111111111 => 5äº¿å¤š\r\n  private static final int CAPACITY   = (1 << COUNT_BITS) - 1;\r\n  ```\r\n\r\n  <img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824172854832.png\" alt=\"image-20230824172854832\" class=\"scale-80\" />\r\n\r\n- å››ç§çŠ¶æ€ï¼š\r\n\r\n  ```java\r\n  // 111 000000000000000000ï¼Œè½¬æ¢æˆæ•´æ•°åå…¶å®å°±æ˜¯ä¸€ä¸ªã€è´Ÿæ•°ã€‘\r\n  private static final int RUNNING    = -1 << COUNT_BITS;\r\n  // 000 000000000000000000\r\n  private static final int SHUTDOWN   =  0 << COUNT_BITS;\r\n  // 001 000000000000000000\r\n  private static final int STOP       =  1 << COUNT_BITS;\r\n  // 010 000000000000000000\r\n  private static final int TIDYING    =  2 << COUNT_BITS;\r\n  // 011 000000000000000000\r\n  private static final int TERMINATED =  3 << COUNT_BITS;\r\n  ```\r\n\r\n  | çŠ¶æ€       | é«˜3ä½ | æ¥æ”¶æ–°ä»»åŠ¡ | å¤„ç†é˜»å¡ä»»åŠ¡é˜Ÿåˆ— | è¯´æ˜                                      |\r\n  | ---------- | ----- | ---------- | ---------------- | ----------------------------------------- |\r\n  | RUNNING    | 111   | Y          | Y                |                                           |\r\n  | SHUTDOWN   | 000   | N          | Y                | ä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†å¤„ç†é˜»å¡é˜Ÿåˆ—å‰©ä½™ä»»åŠ¡      |\r\n  | STOP       | 001   | N          | N                | ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶æŠ›å¼ƒé˜»å¡é˜Ÿåˆ—ä»»åŠ¡    |\r\n  | TIDYING    | 010   | -          | -                | ä»»åŠ¡å…¨æ‰§è¡Œå®Œæ¯•ï¼Œæ´»åŠ¨çº¿ç¨‹ä¸º 0 å³å°†è¿›å…¥ç»ˆç»“ |\r\n  | TERMINATED | 011   | -          | -                | ç»ˆæ­¢çŠ¶æ€                                  |\r\n\r\n- è·å–å½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼š\r\n\r\n  ```java\r\n  // ~CAPACITY = ~000 11111111111111111111 = 111 000000000000000000000ï¼ˆå–åï¼‰\r\n  // c == ctl = 111 000000000000000000111\r\n  // 111 000000000000000000111\r\n  // 111 000000000000000000000\r\n  // 111 000000000000000000000\tè·å–åˆ°äº†è¿è¡ŒçŠ¶æ€\r\n  private static int runStateOf(int c)     { return c & ~CAPACITY; }\r\n  ```\r\n\r\n- è·å–å½“å‰çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡ï¼š\r\n\r\n  ```java\r\n  //        c = 111 000000000000000000111\r\n  // CAPACITY = 000 111111111111111111111\r\n  //            000 000000000000000000111 => 7\r\n  private static int workerCountOf(int c)  { return c & CAPACITY; }\r\n  ```\r\n\r\n- é‡ç½®å½“å‰çº¿ç¨‹æ± çŠ¶æ€ ctlï¼š\r\n\r\n  ```java\r\n  // rs è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œwc è¡¨ç¤ºå½“å‰çº¿ç¨‹æ± ä¸­ workerï¼ˆçº¿ç¨‹ï¼‰æ•°é‡ï¼Œç›¸ä¸ä»¥åå°±æ˜¯åˆå¹¶åçš„çŠ¶æ€\r\n  private static int ctlOf(int rs, int wc) { return rs | wc; }\r\n  ```\r\n\r\n- æ¯”è¾ƒå½“å‰çº¿ç¨‹æ±  ctl æ‰€è¡¨ç¤ºçš„çŠ¶æ€ï¼š\r\n\r\n  ```java\r\n  // æ¯”è¾ƒå½“å‰çº¿ç¨‹æ±  ctl æ‰€è¡¨ç¤ºçš„çŠ¶æ€ï¼Œæ˜¯å¦å°äºæŸä¸ªçŠ¶æ€ s\r\n  // çŠ¶æ€å¯¹æ¯”ï¼šRUNNING < SHUTDOWN < STOP < TIDYING < TERMINATED\r\n  private static boolean runStateLessThan(int c, int s) { return c < s; }\r\n  // æ¯”è¾ƒå½“å‰çº¿ç¨‹æ±  ctl æ‰€è¡¨ç¤ºçš„çŠ¶æ€ï¼Œæ˜¯å¦å¤§äºç­‰äºæŸä¸ªçŠ¶æ€s\r\n  private static boolean runStateAtLeast(int c, int s) { return c >= s; }\r\n  // å°äº SHUTDOWN çš„ä¸€å®šæ˜¯ RUNNINGï¼ŒSHUTDOWN == 0\r\n  private static boolean isRunning(int c) { return c < SHUTDOWN; }\r\n  ```\r\n\r\n- è®¾ç½®çº¿ç¨‹æ±  ctlï¼š\r\n\r\n  ```java\r\n  // ä½¿ç”¨ CAS æ–¹å¼ è®© ctl å€¼ +1 ï¼ŒæˆåŠŸè¿”å› true, å¤±è´¥è¿”å› false\r\n  private boolean compareAndIncrementWorkerCount(int expect) {\r\n      return ctl.compareAndSet(expect, expect + 1);\r\n  }\r\n  // ä½¿ç”¨ CAS æ–¹å¼ è®© ctl å€¼ -1 ï¼ŒæˆåŠŸè¿”å› true, å¤±è´¥è¿”å› false\r\n  private boolean compareAndDecrementWorkerCount(int expect) {\r\n      return ctl.compareAndSet(expect, expect - 1);\r\n  }\r\n  // å°† ctl å€¼å‡ä¸€ï¼Œdo while å¾ªç¯ä¼šä¸€ç›´é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢\r\n  private void decrementWorkerCount() {\r\n      do {} while (!compareAndDecrementWorkerCount(ctl.get()));\r\n  }\r\n  ```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### æˆå‘˜å±æ€§\r\n\r\næˆå‘˜å˜é‡\r\n\r\n- **çº¿ç¨‹æ± ä¸­å­˜æ”¾ Worker çš„å®¹å™¨**ï¼šçº¿ç¨‹æ± æ²¡æœ‰åˆå§‹åŒ–ï¼Œç›´æ¥å¾€æ± ä¸­åŠ çº¿ç¨‹å³å¯\r\n\r\n  ```java\r\n  private final HashSet<Worker> workers = new HashSet<Worker>();\r\n  ```\r\n\r\n- çº¿ç¨‹å…¨å±€é”ï¼š\r\n\r\n  ```java\r\n  // å¢åŠ å‡å°‘ worker æˆ–è€…æ—¶ä¿®æ”¹çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€éœ€è¦æŒæœ‰ mainLock\r\n  private final ReentrantLock mainLock = new ReentrantLock();\r\n  ```\r\n\r\n- å¯é‡å…¥é”çš„æ¡ä»¶å˜é‡ï¼š\r\n\r\n  ```java\r\n  // å½“å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ awaitTermination() æ–¹æ³•æ—¶ï¼Œä¼šç­‰å¾…å½“å‰çº¿ç¨‹æ± çŠ¶æ€ä¸º Termination ä¸ºæ­¢\r\n  private final Condition termination = mainLock.newCondition()\r\n  ```\r\n\r\n- çº¿ç¨‹æ± ç›¸å…³å‚æ•°ï¼š\r\n\r\n  ```java\r\n  private volatile int corePoolSize;\t\t\t\t// æ ¸å¿ƒçº¿ç¨‹æ•°é‡\r\n  private volatile int maximumPoolSize;\t\t\t// çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°é‡\r\n  private volatile long keepAliveTime;\t\t\t// ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´\r\n  private volatile ThreadFactory threadFactory;\t// åˆ›å»ºçº¿ç¨‹æ—¶ä½¿ç”¨çš„çº¿ç¨‹å·¥å‚ï¼Œé»˜è®¤æ˜¯ DefaultThreadFactory\r\n  private final BlockingQueue<Runnable> workQueue;// ã€è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æäº¤ä»»åŠ¡å°±æ”¾å…¥ é˜»å¡é˜Ÿåˆ—ã€‘\r\n  ```\r\n\r\n  ```java\r\n  private volatile RejectedExecutionHandler handler;\t// æ‹’ç»ç­–ç•¥ï¼ŒjucåŒ…æä¾›äº†4ä¸­æ–¹å¼\r\n  private static final RejectedExecutionHandler defaultHandler = new AbortPolicy();// é»˜è®¤ç­–ç•¥\r\n  ```\r\n\r\n- è®°å½•çº¿ç¨‹æ± ç›¸å…³å±æ€§çš„æ•°å€¼ï¼š\r\n\r\n  ```java\r\n  private int largestPoolSize;\t\t// è®°å½•çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸå†…çº¿ç¨‹æ•°æœ€å¤§å€¼\r\n  private long completedTaskCount;\t// è®°å½•çº¿ç¨‹æ± æ‰€å®Œæˆä»»åŠ¡æ€»æ•°ï¼Œå½“æŸä¸ª worker é€€å‡ºæ—¶å°†å®Œæˆçš„ä»»åŠ¡ç´¯åŠ åˆ°è¯¥å±æ€§\r\n  ```\r\n\r\n- æ§åˆ¶**æ ¸å¿ƒçº¿ç¨‹æ•°é‡å†…çš„çº¿ç¨‹æ˜¯å¦å¯ä»¥è¢«å›æ”¶**ï¼š\r\n\r\n  ```java\r\n  // falseï¼ˆé»˜è®¤ï¼‰ä»£è¡¨ä¸å¯ä»¥ï¼Œä¸º true æ—¶æ ¸å¿ƒçº¿ç¨‹ç©ºé—²è¶…è¿‡ keepAliveTime ä¹Ÿä¼šè¢«å›æ”¶\r\n  // allowCoreThreadTimeOut(boolean value) æ–¹æ³•å¯ä»¥è®¾ç½®è¯¥å€¼\r\n  private volatile boolean allowCoreThreadTimeOut;\r\n  ```\r\n\r\nå†…éƒ¨ç±»ï¼š\r\n\r\n- Worker ç±»ï¼š**æ¯ä¸ª Worker å¯¹è±¡ä¼šç»‘å®šä¸€ä¸ªåˆå§‹ä»»åŠ¡**ï¼Œå¯åŠ¨ Worker æ—¶ä¼˜å…ˆæ‰§è¡Œï¼Œè¿™ä¹Ÿæ˜¯é€ æˆçº¿ç¨‹æ± ä¸å…¬å¹³çš„åŸå› ã€‚Worker ç»§æ‰¿è‡ª AQSï¼Œæœ¬èº«å…·æœ‰é”çš„ç‰¹æ€§ï¼Œé‡‡ç”¨ç‹¬å é”æ¨¡å¼ï¼Œ`state = 0` è¡¨ç¤ºæœªè¢«å ç”¨ï¼Œ`> 0` è¡¨ç¤ºè¢«å ç”¨ï¼Œ`< 0` è¡¨ç¤ºåˆå§‹çŠ¶æ€ä¸èƒ½è¢«æŠ¢é”\r\n\r\n  ```java\r\n  private final class Worker extends AbstractQueuedSynchronizer implements Runnable {\r\n  \tfinal Thread thread;\t\t\t// worker å†…éƒ¨å°è£…çš„å·¥ä½œçº¿ç¨‹\r\n      Runnable firstTask;\t\t\t\t// worker ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ™®é€šçš„ Runnable å®ç°ç±»æˆ–è€…æ˜¯ FutureTask\r\n      volatile long completedTasks;\t// è®°å½•å½“å‰ worker æ‰€å®Œæˆä»»åŠ¡æ•°é‡\r\n      \r\n      // æ„é€ æ–¹æ³•\r\n      Worker(Runnable firstTask) {\r\n          // è®¾ç½®AQSç‹¬å æ¨¡å¼ä¸ºåˆå§‹åŒ–ä¸­çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¸èƒ½è¢«æŠ¢å é”\r\n         \tsetState(-1);\r\n          // firstTaskä¸ä¸ºç©ºæ—¶ï¼Œå½“workerå¯åŠ¨åï¼Œå†…éƒ¨çº¿ç¨‹ä¼šä¼˜å…ˆæ‰§è¡ŒfirstTaskï¼Œæ‰§è¡Œå®Œåä¼šåˆ°queueä¸­å»è·å–ä¸‹ä¸ªä»»åŠ¡\r\n          this.firstTask = firstTask;\r\n          // ä½¿ç”¨çº¿ç¨‹å·¥å‚åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”ã€å°†å½“å‰workeræŒ‡å®šä¸ºRunnableã€‘ï¼Œæ‰€ä»¥threadå¯åŠ¨æ—¶ä¼šè°ƒç”¨ worker.run()\r\n          this.thread = getThreadFactory().newThread(this);\r\n      }\r\n      // ã€ä¸å¯é‡å…¥é”ã€‘\r\n      protected boolean tryAcquire(int unused) {\r\n          if (compareAndSetState(0, 1)) {\r\n              setExclusiveOwnerThread(Thread.currentThread());\r\n              return true;\r\n          }\r\n          return false;\r\n      }\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  public Thread newThread(Runnable r) {\r\n      // å°†å½“å‰ worker æŒ‡å®šä¸º thread çš„æ‰§è¡Œæ–¹æ³•ï¼Œçº¿ç¨‹è°ƒç”¨ start ä¼šè°ƒç”¨ r.run()\r\n      Thread t = new Thread(group, r, namePrefix + threadNumber.getAndIncrement(), 0);\r\n      if (t.isDaemon())\r\n          t.setDaemon(false);\r\n      if (t.getPriority() != Thread.NORM_PRIORITY)\r\n          t.setPriority(Thread.NORM_PRIORITY);\r\n      return t;\r\n  }\r\n  ```\r\n\r\n- æ‹’ç»ç­–ç•¥ç›¸å…³çš„å†…éƒ¨ç±»\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æˆå‘˜æ–¹æ³•\r\n\r\n##### æäº¤æ–¹æ³•\r\n\r\n- `AbstractExecutorService#submit()`ï¼šæäº¤ä»»åŠ¡ï¼Œ**æŠŠ Runnable æˆ– Callable ä»»åŠ¡å°è£…æˆ FutureTask æ‰§è¡Œ**ï¼Œå¯ä»¥é€šè¿‡æ–¹æ³•è¿”å›çš„ä»»åŠ¡å¯¹è±¡ï¼Œè°ƒç”¨ get é˜»å¡è·å–ä»»åŠ¡æ‰§è¡Œçš„ç»“æœæˆ–è€…å¼‚å¸¸ï¼Œæºç åˆ†æåœ¨ç¬”è®°çš„ Future éƒ¨åˆ†\r\n\r\n  ```java\r\n  public Future<?> submit(Runnable task) {\r\n      // ç©ºæŒ‡é’ˆå¼‚å¸¸\r\n      if (task == null) throw new NullPointerException();\r\n      // æŠŠ Runnable å°è£…æˆæœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œæ‰§è¡Œç»“æœå°±æ˜¯ nullï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®š FutureTask#get è¿”å›æ•°æ®\r\n      RunnableFuture<Void> ftask = newTaskFor(task, null);\r\n      // æ‰§è¡Œæ–¹æ³•\r\n      execute(ftask);\r\n      return ftask;\r\n  }\r\n  public <T> Future<T> submit(Callable<T> task) {\r\n      if (task == null) throw new NullPointerException();\r\n      // æŠŠ Callable å°è£…æˆæœªæ¥ä»»åŠ¡å¯¹è±¡\r\n      RunnableFuture<T> ftask = newTaskFor(task);\r\n      // æ‰§è¡Œæ–¹æ³•\r\n      execute(ftask);\t\r\n      // è¿”å›æœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œç”¨æ¥è·å–è¿”å›å€¼\r\n      return ftask;\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  protected <T> RunnableFuture<T> newTaskFor(Runnable runnable, T value) {\r\n      // Runnable å°è£…æˆ FutureTaskï¼Œã€æŒ‡å®šè¿”å›å€¼ã€‘\r\n      return new FutureTask<T>(runnable, value);\r\n  }\r\n  protected <T> RunnableFuture<T> newTaskFor(Callable<T> callable) {\r\n      // Callable ç›´æ¥å°è£…æˆ FutureTask\r\n      return new FutureTask<T>(callable);\r\n  }\r\n  ```\r\n\r\n- `execute()`ï¼šæ‰§è¡Œä»»åŠ¡ï¼Œ**ä½†æ˜¯æ²¡æœ‰è¿”å›å€¼ï¼Œæ²¡åŠæ³•è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ**ï¼Œå‡ºç°å¼‚å¸¸ä¼šç›´æ¥æŠ›å‡ºä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸ã€‚æ ¹æ®çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ï¼Œé€‰æ‹©æ·»åŠ ä»»åŠ¡æ—¶çš„å¤„ç†æ–¹å¼\r\n\r\n  ```java\r\n  // command å¯ä»¥æ˜¯æ™®é€šçš„ Runnable å®ç°ç±»ï¼Œä¹Ÿå¯ä»¥æ˜¯ FutureTaskï¼Œä¸èƒ½æ˜¯ Callable\r\n  public void execute(Runnable command) {\r\n      // éç©ºåˆ¤æ–­\r\n      if (command == null)\r\n          throw new NullPointerException();\r\n    \t// è·å– ctl æœ€æ–°å€¼èµ‹å€¼ç»™ cï¼Œctl é«˜ 3 ä½è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½ä½è¡¨ç¤ºå½“å‰çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡ã€‚\r\n      int c = ctl.get();\r\n      // ã€1ã€‘å½“å‰çº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ­¤æ¬¡æäº¤ä»»åŠ¡ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ workerï¼Œçº¿ç¨‹æ± ä¸­å¤šäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹\r\n      if (workerCountOf(c) < corePoolSize) {\r\n          // addWorker ä¸ºåˆ›å»ºçº¿ç¨‹çš„è¿‡ç¨‹ï¼Œä¼šåˆ›å»º worker å¯¹è±¡å¹¶ä¸”å°† command ä½œä¸º firstTaskï¼Œä¼˜å…ˆæ‰§è¡Œ\r\n          if (addWorker(command, true))\r\n              return;\r\n          \r\n          // æ‰§è¡Œåˆ°è¿™æ¡è¯­å¥ï¼Œè¯´æ˜ addWorker ä¸€å®šæ˜¯å¤±è´¥çš„ï¼Œå­˜åœ¨å¹¶å‘ç°è±¡æˆ–è€…çº¿ç¨‹æ± çŠ¶æ€è¢«æ”¹å˜ï¼Œé‡æ–°è·å–çŠ¶æ€\r\n          // SHUTDOWN çŠ¶æ€ä¸‹ä¹Ÿæœ‰å¯èƒ½åˆ›å»ºæˆåŠŸï¼Œå‰æ firstTask == null è€Œä¸”å½“å‰ queue ä¸ä¸ºç©ºï¼ˆç‰¹æ®Šæƒ…å†µï¼‰\r\n          c = ctl.get();\r\n      }\r\n      // ã€2ã€‘æ‰§è¡Œåˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹æ•°é‡å·²ç»è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°é‡ æˆ–è€… addWorker å¤±è´¥\r\n      // \tåˆ¤æ–­å½“å‰çº¿ç¨‹æ± æ˜¯å¦å¤„äºrunningçŠ¶æ€ï¼Œæˆç«‹å°±å°è¯•å°† task æ”¾å…¥åˆ° workQueue ä¸­\r\n      if (isRunning(c) && workQueue.offer(command)) {\r\n          int recheck = ctl.get();\r\n          // æ¡ä»¶ä¸€æˆç«‹è¯´æ˜çº¿ç¨‹æ± çŠ¶æ€è¢«å¤–éƒ¨çº¿ç¨‹ç»™ä¿®æ”¹äº†ï¼Œå¯èƒ½æ˜¯æ‰§è¡Œäº† shutdown() æ–¹æ³•ï¼Œè¯¥çŠ¶æ€ä¸èƒ½æ¥æ”¶æ–°æäº¤çš„ä»»åŠ¡\r\n          // æ‰€ä»¥è¦æŠŠåˆšæäº¤çš„ä»»åŠ¡åˆ é™¤ï¼Œåˆ é™¤æˆåŠŸè¯´æ˜æäº¤ä¹‹åçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹è¿˜æœªæ¶ˆè´¹ï¼ˆå¤„ç†ï¼‰è¯¥ä»»åŠ¡\r\n          if (!isRunning(recheck) && remove(command))\r\n              // ä»»åŠ¡å‡ºé˜ŸæˆåŠŸï¼Œèµ°æ‹’ç»ç­–ç•¥\r\n              reject(command);\r\n          // æ‰§è¡Œåˆ°è¿™è¯´æ˜çº¿ç¨‹æ± æ˜¯ running çŠ¶æ€ï¼Œè·å–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ 0\r\n          // ã€æ‹…ä¿æœºåˆ¶ã€‘ï¼Œä¿è¯çº¿ç¨‹æ± åœ¨ running çŠ¶æ€ä¸‹ï¼Œæœ€èµ·ç å¾—æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œ\r\n          else if (workerCountOf(recheck) == 0)\r\n              addWorker(null, false);\r\n      }\r\n      // ã€3ã€‘offerå¤±è´¥è¯´æ˜queueæ»¡äº†\r\n      // å¦‚æœçº¿ç¨‹æ•°é‡å°šæœªè¾¾åˆ° maximumPoolSizeï¼Œä¼šåˆ›å»ºéæ ¸å¿ƒ worker çº¿ç¨‹ç›´æ¥æ‰§è¡Œ commandï¼Œã€è¿™ä¹Ÿæ˜¯ä¸å…¬å¹³çš„åŸå› ã€‘\r\n      // å¦‚æœå½“å‰çº¿ç¨‹æ•°é‡è¾¾åˆ° maximumPoolSizeï¼Œè¿™é‡Œ addWorker ä¹Ÿä¼šå¤±è´¥ï¼Œèµ°æ‹’ç»ç­–ç•¥\r\n      else if (!addWorker(command, false))\r\n          reject(command);\r\n  }\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ·»åŠ çº¿ç¨‹\r\n\r\n- `prestartAllCoreThreads()`ï¼š**æå‰é¢„çƒ­**ï¼Œåˆ›å»ºæ‰€æœ‰çš„æ ¸å¿ƒçº¿ç¨‹\r\n\r\n  ```java\r\n  public int prestartAllCoreThreads() {\r\n      int n = 0;\r\n      while (addWorker(null, true))\r\n          ++n;\r\n      return n;\r\n  }\r\n  ```\r\n\r\n- `addWorker()`ï¼š**æ·»åŠ çº¿ç¨‹åˆ°çº¿ç¨‹æ± **ï¼Œè¿”å› true è¡¨ç¤ºåˆ›å»º Worker æˆåŠŸï¼Œä¸”çº¿ç¨‹å¯åŠ¨ã€‚é¦–å…ˆåˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦å…è®¸æ·»åŠ çº¿ç¨‹ï¼Œå…è®¸å°±è®©çº¿ç¨‹æ•°é‡ + 1ï¼Œç„¶åå»åˆ›å»º Worker åŠ å…¥çº¿ç¨‹æ± \r\n\r\n  æ³¨æ„ï¼šSHUTDOWN çŠ¶æ€ä¹Ÿèƒ½æ·»åŠ çº¿ç¨‹ï¼Œä½†æ˜¯è¦æ±‚æ–°åŠ çš„ Woker æ²¡æœ‰ firstTaskï¼Œè€Œä¸”å½“å‰ queue ä¸ä¸ºç©ºï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¸®åŠ©çº¿ç¨‹æ± æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡\r\n\r\n  ```java\r\n  // core == true è¡¨ç¤ºé‡‡ç”¨æ ¸å¿ƒçº¿ç¨‹æ•°é‡é™åˆ¶ï¼Œfalse è¡¨ç¤ºé‡‡ç”¨ maximumPoolSize\r\n  private boolean addWorker(Runnable firstTask, boolean core) {\r\n      // è‡ªæ—‹ã€åˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦å…è®¸åˆ›å»ºçº¿ç¨‹ã€‘ï¼Œå…è®¸å°±è®¾ç½®çº¿ç¨‹æ•°é‡ + 1\r\n      retry:\r\n      for (;;) {\r\n          // è·å– ctl çš„å€¼\r\n          int c = ctl.get();\r\n          // è·å–å½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€\r\n          int rs = runStateOf(c);\t\r\n          \r\n          // åˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€ã€æ˜¯å¦å…è®¸æ·»åŠ çº¿ç¨‹ã€‘\r\n          \r\n          // å½“å‰çº¿ç¨‹æ± æ˜¯ SHUTDOWN çŠ¶æ€ï¼Œä½†æ˜¯é˜Ÿåˆ—é‡Œé¢è¿˜æœ‰ä»»åŠ¡å°šæœªå¤„ç†å®Œï¼Œéœ€è¦å¤„ç†å®Œ queue ä¸­çš„ä»»åŠ¡\r\n          // ã€ä¸å…è®¸å†æäº¤æ–°çš„ taskï¼Œæ‰€ä»¥ firstTask ä¸ºç©ºï¼Œä½†æ˜¯å¯ä»¥ç»§ç»­æ·»åŠ  workerã€‘\r\n          if (rs >= SHUTDOWN && !(rs == SHUTDOWN && firstTask == null && !workQueue.isEmpty()))\r\n              return false;\r\n          for (;;) {\r\n              // è·å–çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡\r\n              int wc = workerCountOf(c);\r\n              // æ¡ä»¶ä¸€ä¸€èˆ¬ä¸æˆç«‹ï¼ŒCAPACITYæ˜¯5äº¿å¤šï¼Œæ ¹æ® core åˆ¤æ–­ä½¿ç”¨å“ªä¸ªå¤§å°é™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œè¶…è¿‡äº†è¿”å› false\r\n              if (wc >= CAPACITY || wc >= (core ? corePoolSize : maximumPoolSize))\r\n                  return false;\r\n              // è®°å½•çº¿ç¨‹æ•°é‡å·²ç»åŠ  1ï¼Œç±»æ¯”äºç”³è¯·åˆ°äº†ä¸€å—ä»¤ç‰Œï¼Œæ¡ä»¶å¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†æ•°é‡\r\n              if (compareAndIncrementWorkerCount(c))\r\n                  // ç”³è¯·æˆåŠŸï¼Œè·³å‡ºäº† retry è¿™ä¸ª for è‡ªæ—‹\r\n                  break retry;\r\n              // CAS å¤±è´¥ï¼Œæ²¡æœ‰æˆåŠŸçš„ç”³è¯·åˆ°ä»¤ç‰Œ\r\n              c = ctl.get();\r\n              // åˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦å‘ç”Ÿè¿‡å˜åŒ–ï¼Œè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†ï¼Œå¯èƒ½å…¶ä»–çº¿ç¨‹è°ƒç”¨äº† shutdown() æ–¹æ³•\r\n              if (runStateOf(c) != rs)\r\n                  // è¿”å›å¤–å±‚å¾ªç¯æ£€æŸ¥æ˜¯å¦èƒ½åˆ›å»ºçº¿ç¨‹ï¼Œåœ¨ if è¯­å¥ä¸­è¿”å› false\r\n                  continue retry;\r\n             \r\n          }\r\n      }\r\n      \r\n      //ã€ä»¤ç‰Œç”³è¯·æˆåŠŸï¼Œå¼€å§‹åˆ›å»ºçº¿ç¨‹ã€‘\r\n      \r\n  \t// è¿è¡Œæ ‡è®°ï¼Œè¡¨ç¤ºåˆ›å»ºçš„ worker æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œfalseæœªå¯åŠ¨  trueå¯åŠ¨\r\n      boolean workerStarted = false;\r\n      // æ·»åŠ æ ‡è®°ï¼Œè¡¨ç¤ºåˆ›å»ºçš„ worker æ˜¯å¦æ·»åŠ åˆ°æ± å­ä¸­äº†ï¼Œé»˜è®¤falseæœªæ·»åŠ ï¼Œtrueæ˜¯æ·»åŠ ã€‚\r\n      boolean workerAdded = false;\r\n      Worker w = null;\r\n      try {\r\n          // ã€åˆ›å»º Workerï¼Œåº•å±‚é€šè¿‡çº¿ç¨‹å·¥å‚ newThread æ–¹æ³•åˆ›å»ºæ‰§è¡Œçº¿ç¨‹ï¼ŒæŒ‡å®šäº†é¦–å…ˆæ‰§è¡Œçš„ä»»åŠ¡ã€‘\r\n          w = new Worker(firstTask);\r\n          // å°†æ–°åˆ›å»ºçš„ worker èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹èµ‹å€¼ç»™ t\r\n          final Thread t = w.thread;\r\n          // è¿™é‡Œçš„åˆ¤æ–­ä¸ºäº†é˜²æ­¢ ç¨‹åºå‘˜è‡ªå®šä¹‰çš„ ThreadFactory å®ç°ç±»æœ‰ bugï¼Œåˆ›é€ ä¸å‡ºçº¿ç¨‹\r\n          if (t != null) {\r\n              final ReentrantLock mainLock = this.mainLock;\r\n              // åŠ äº’æ–¥é”ï¼Œè¦æ·»åŠ  worker äº†\r\n              mainLock.lock();\r\n              try {\r\n                  // è·å–æœ€æ–°çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ä¿å­˜åˆ° rs\r\n                  int rs = runStateOf(ctl.get());\r\n  \t\t\t\t// åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦ä¸ºRUNNINGçŠ¶æ€ï¼Œä¸æ˜¯å†ã€åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºSHUTDOWNçŠ¶æ€ä¸”firstTaskä¸ºç©ºï¼Œç‰¹æ®Šæƒ…å†µã€‘\r\n                  if (rs < SHUTDOWN || (rs == SHUTDOWN && firstTask == null)) {\r\n                      // å½“çº¿ç¨‹startåï¼Œçº¿ç¨‹isAliveä¼šè¿”å›trueï¼Œè¿™é‡Œè¿˜æ²¡å¼€å§‹å¯åŠ¨çº¿ç¨‹ï¼Œå¦‚æœè¢«å¯åŠ¨äº†å°±éœ€è¦æŠ¥é”™\r\n                      if (t.isAlive())\r\n                          throw new IllegalThreadStateException();\r\n                      \r\n                      //ã€å°†æ–°å»ºçš„ Worker æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­ã€‘\r\n                      workers.add(w);\r\n                      int s = workers.size();\r\n  \t\t\t\t\t// å½“å‰æ± ä¸­çš„çº¿ç¨‹æ•°é‡æ˜¯ä¸€ä¸ªæ–°é«˜ï¼Œæ›´æ–° largestPoolSize\r\n                      if (s > largestPoolSize)\r\n                          largestPoolSize = s;\r\n                      // æ·»åŠ æ ‡è®°ç½®ä¸º true\r\n                      workerAdded = true;\r\n                  }\r\n              } finally {\r\n                  // è§£é”å•Š\r\n                  mainLock.unlock();\r\n              }\r\n              // æ·»åŠ æˆåŠŸå°±ã€å¯åŠ¨çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‘\r\n              if (workerAdded) {\r\n                  // Thread ç±»ä¸­æŒæœ‰ Runnable ä»»åŠ¡å¯¹è±¡ï¼Œè°ƒç”¨çš„æ˜¯ Runnable çš„ run ï¼Œä¹Ÿå°±æ˜¯ FutureTask\r\n                  t.start();\r\n                  // è¿è¡Œæ ‡è®°ç½®ä¸º true\r\n                  workerStarted = true;\r\n              }\r\n          }\r\n      } finally {\r\n          // å¦‚æœå¯åŠ¨çº¿ç¨‹å¤±è´¥ï¼Œåšæ¸…ç†å·¥ä½œ\r\n          if (! workerStarted)\r\n              addWorkerFailed(w);\r\n      }\r\n      // è¿”å›æ–°åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å¯åŠ¨\r\n      return workerStarted;\r\n  }\r\n  ```\r\n\r\n- `addWorkerFailed()`ï¼šæ¸…ç†ä»»åŠ¡\r\n\r\n  ```java\r\n  private void addWorkerFailed(Worker w) {\r\n      final ReentrantLock mainLock = this.mainLock;\r\n      // æŒæœ‰çº¿ç¨‹æ± å…¨å±€é”ï¼Œå› ä¸ºæ“ä½œçš„æ˜¯çº¿ç¨‹æ± ç›¸å…³çš„ä¸œè¥¿\r\n      mainLock.lock();\r\n      try {\r\n          //æ¡ä»¶æˆç«‹éœ€è¦å°† worker åœ¨ workers ä¸­æ¸…ç†å‡ºå»ã€‚\r\n          if (w != null)\r\n              workers.remove(w);\r\n          // å°†çº¿ç¨‹æ± è®¡æ•° -1ï¼Œç›¸å½“äºå½’è¿˜ä»¤ç‰Œã€‚\r\n          decrementWorkerCount();\r\n          // å°è¯•åœæ­¢çº¿ç¨‹æ± \r\n          tryTerminate();\r\n      } finally {\r\n          //é‡Šæ”¾çº¿ç¨‹æ± å…¨å±€é”ã€‚\r\n          mainLock.unlock();\r\n      }\r\n  }\r\n  ```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n##### è¿è¡Œæ–¹æ³•\r\n\r\n- `Worker#run`ï¼šWorker å®ç°äº† Runnable æ¥å£ï¼Œå½“çº¿ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šè°ƒç”¨ Worker çš„ run() æ–¹æ³•\r\n\r\n  ```java\r\n  public void run() {\r\n      // ThreadPoolExecutor#runWorker()\r\n      runWorker(this);\r\n  }\r\n  ```\r\n\r\n- `runWorker()`ï¼šçº¿ç¨‹å¯åŠ¨å°±è¦**æ‰§è¡Œä»»åŠ¡**ï¼Œä¼šä¸€ç›´ while å¾ªç¯è·å–ä»»åŠ¡å¹¶æ‰§è¡Œ\r\n\r\n  ```java\r\n  final void runWorker(Worker w) {\r\n      Thread wt = Thread.currentThread();\t\r\n      // è·å– worker çš„ firstTask\r\n      Runnable task = w.firstTask;\r\n      // å¼•ç”¨ç½®ç©ºï¼Œã€é˜²æ­¢å¤ç”¨è¯¥çº¿ç¨‹æ—¶é‡å¤æ‰§è¡Œè¯¥ä»»åŠ¡ã€‘\r\n      w.firstTask = null;\r\n      // åˆå§‹åŒ– worker æ—¶è®¾ç½® state = -1ï¼Œè¡¨ç¤ºä¸å…è®¸æŠ¢å é”\r\n      // è¿™é‡Œéœ€è¦è®¾ç½® state = 0 å’Œ exclusiveOwnerThread = nullï¼Œå¼€å§‹ç‹¬å æ¨¡å¼æŠ¢é”\r\n      w.unlock();\r\n      // true è¡¨ç¤ºå‘ç”Ÿå¼‚å¸¸é€€å‡ºï¼Œfalse è¡¨ç¤ºæ­£å¸¸é€€å‡ºã€‚\r\n      boolean completedAbruptly = true;\r\n      try {\r\n          // firstTask ä¸æ˜¯ null å°±ç›´æ¥è¿è¡Œï¼Œå¦åˆ™å» queue ä¸­è·å–ä»»åŠ¡\r\n          // ã€getTask å¦‚æœæ˜¯é˜»å¡è·å–ä»»åŠ¡ï¼Œä¼šä¸€ç›´é˜»å¡åœ¨takeæ–¹æ³•ï¼Œç›´åˆ°è·å–ä»»åŠ¡ï¼Œä¸ä¼šèµ°è¿”å›nullçš„é€»è¾‘ã€‘\r\n          while (task != null || (task = getTask()) != null) {\r\n              // worker åŠ é”ï¼Œshutdown æ—¶ä¼šåˆ¤æ–­å½“å‰ worker çŠ¶æ€ï¼Œã€æ ¹æ®ç‹¬å é”çŠ¶æ€åˆ¤æ–­æ˜¯å¦ç©ºé—²ã€‘\r\n              w.lock();\r\n              \r\n  \t\t\t// è¯´æ˜çº¿ç¨‹æ± çŠ¶æ€å¤§äº STOPï¼Œç›®å‰å¤„äº STOP/TIDYING/TERMINATIONï¼Œæ­¤æ—¶ç»™çº¿ç¨‹ä¸€ä¸ªä¸­æ–­ä¿¡å·\r\n              if ((runStateAtLeast(ctl.get(), STOP) ||\r\n                   // è¯´æ˜çº¿ç¨‹å¤„äº RUNNING æˆ–è€… SHUTDOWN çŠ¶æ€ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°\r\n                   (Thread.interrupted() && runStateAtLeast(ctl.get(), STOP))) && !wt.isInterrupted())\r\n                  // ä¸­æ–­çº¿ç¨‹ï¼Œè®¾ç½®çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¸º true\r\n                  wt.interrupt();\r\n              try {\r\n                  // é’©å­æ–¹æ³•ï¼Œã€ä»»åŠ¡æ‰§è¡Œçš„å‰ç½®å¤„ç†ã€‘\r\n                  beforeExecute(wt, task);\r\n                  Throwable thrown = null;\r\n                  try {\r\n                      // ã€æ‰§è¡Œä»»åŠ¡ã€‘\r\n                      task.run();\r\n                  } catch (Exception x) {\r\n                   \t//.....\r\n                  } finally {\r\n                      // é’©å­æ–¹æ³•ï¼Œã€ä»»åŠ¡æ‰§è¡Œçš„åç½®å¤„ç†ã€‘\r\n                      afterExecute(task, thrown);\r\n                  }\r\n              } finally {\r\n                  task = null;\t\t// å°†å±€éƒ¨å˜é‡taskç½®ä¸ºnullï¼Œä»£è¡¨ä»»åŠ¡æ‰§è¡Œå®Œæˆ\r\n                  w.completedTasks++;\t// æ›´æ–°workerå®Œæˆä»»åŠ¡æ•°é‡\r\n                  w.unlock();\t\t\t// è§£é”\r\n              }\r\n          }\r\n          // getTask()æ–¹æ³•è¿”å›nullæ—¶ä¼šèµ°åˆ°è¿™é‡Œï¼Œè¡¨ç¤ºqueueä¸ºç©ºå¹¶ä¸”çº¿ç¨‹ç©ºé—²è¶…è¿‡ä¿æ´»æ—¶é—´ï¼Œã€å½“å‰çº¿ç¨‹æ‰§è¡Œé€€å‡ºé€»è¾‘ã€‘\r\n          completedAbruptly = false;\t\r\n      } finally {\r\n          // æ­£å¸¸é€€å‡º completedAbruptly = false\r\n         \t// å¼‚å¸¸é€€å‡º completedAbruptly = trueï¼Œã€ä» task.run() å†…éƒ¨æŠ›å‡ºå¼‚å¸¸ã€‘æ—¶ï¼Œè·³åˆ°è¿™ä¸€è¡Œ\r\n          processWorkerExit(w, completedAbruptly);\r\n      }\r\n  }\r\n  ```\r\n\r\n- `unlock()`ï¼šé‡ç½®é”\r\n\r\n  ```java\r\n  public void unlock() { release(1); }\r\n  public final boolean release(int arg) {\r\n      if (tryRelease(arg)) {\r\n          Node h = head;\r\n          if (h != null && h.waitStatus != 0)\r\n              unparkSuccessor(h);\r\n          return true;\r\n      }\r\n      return false;\r\n  }\r\n  // å¤–éƒ¨ä¸ä¼šç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³• è¿™ä¸ªæ–¹æ³•æ˜¯ AQS å†…è°ƒç”¨çš„ï¼Œå¤–éƒ¨è°ƒç”¨ unlock æ—¶è§¦å‘æ­¤æ–¹æ³•\r\n  protected boolean tryRelease(int unused) {\r\n      setExclusiveOwnerThread(null);\t\t// è®¾ç½®æŒæœ‰è€…ä¸º null\r\n      setState(0);\t\t\t\t\t\t// è®¾ç½® state = 0\r\n      return true;\r\n  }\r\n  ```\r\n\r\n- `getTask()`ï¼šè·å–ä»»åŠ¡ï¼Œçº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡ keepAliveTime å°±ä¼šè¢«å›æ”¶ï¼Œåˆ¤æ–­çš„ä¾æ®æ˜¯**å½“å‰çº¿ç¨‹é˜»å¡è·å–ä»»åŠ¡è¶…è¿‡ä¿æ´»æ—¶é—´**ï¼Œæ–¹æ³•è¿”å› null å°±ä»£è¡¨å½“å‰çº¿ç¨‹è¦è¢«å›æ”¶äº†ï¼Œè¿”å›åˆ° runWorker æ‰§è¡Œçº¿ç¨‹é€€å‡ºé€»è¾‘ã€‚çº¿ç¨‹æ± å…·æœ‰æ‹…ä¿æœºåˆ¶ï¼Œå¯¹äº RUNNING çŠ¶æ€ä¸‹çš„è¶…æ—¶å›æ”¶ï¼Œè¦ä¿è¯çº¿ç¨‹æ± ä¸­æœ€å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹è¿è¡Œï¼Œæˆ–è€…ä»»åŠ¡é˜»å¡é˜Ÿåˆ—å·²ç»æ˜¯ç©º\r\n\r\n  ```java\r\n  private Runnable getTask() {\r\n      // è¶…æ—¶æ ‡è®°ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–ä»»åŠ¡æ˜¯å¦è¶…æ—¶ï¼Œtrue è¡¨ç¤ºå·²è¶…æ—¶\r\n      boolean timedOut = false; \r\n      for (;;) {\r\n          int c = ctl.get();\r\n          // è·å–çº¿ç¨‹æ± å½“å‰è¿è¡ŒçŠ¶æ€\r\n          int rs = runStateOf(c);\r\n  \t\t\r\n          // ã€tryTerminateã€‘æ‰“æ–­çº¿ç¨‹åæ‰§è¡Œåˆ°è¿™ï¼Œæ­¤æ—¶çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOPæˆ–è€…çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNå¹¶ä¸”é˜Ÿåˆ—å·²ç»æ˜¯ç©º\r\n          // æ‰€ä»¥ä¸‹é¢çš„ if æ¡ä»¶ä¸€å®šæ˜¯æˆç«‹çš„ï¼Œå¯ä»¥ç›´æ¥è¿”å› nullï¼Œçº¿ç¨‹å°±åº”è¯¥é€€å‡ºäº†\r\n          if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {\r\n              // ä½¿ç”¨ CAS è‡ªæ—‹çš„æ–¹å¼è®© ctl å€¼ -1\r\n              decrementWorkerCount();\r\n              return null;\r\n          }\r\n          \r\n  \t\t// è·å–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡\r\n          int wc = workerCountOf(c);\r\n  \r\n          // çº¿ç¨‹æ²¡æœ‰æ˜ç¡®çš„åŒºåˆ†è°æ˜¯æ ¸å¿ƒæˆ–è€…éæ ¸å¿ƒçº¿ç¨‹ï¼Œæ˜¯æ ¹æ®å½“å‰æ± ä¸­çš„çº¿ç¨‹æ•°é‡åˆ¤æ–­\r\n          \r\n          // timed = false è¡¨ç¤ºå½“å‰è¿™ä¸ªçº¿ç¨‹ è·å–taskæ—¶ä¸æ”¯æŒè¶…æ—¶æœºåˆ¶çš„ï¼Œå½“å‰çº¿ç¨‹ä¼šä½¿ç”¨ queue.take() é˜»å¡è·å–\r\n          // timed = true è¡¨ç¤ºå½“å‰è¿™ä¸ªçº¿ç¨‹ è·å–taskæ—¶æ”¯æŒè¶…æ—¶æœºåˆ¶ï¼Œä½¿ç”¨ queue.poll(xxx,xxx) è¶…æ—¶è·å–\r\n          // æ¡ä»¶ä¸€ä»£è¡¨å…è®¸å›æ”¶æ ¸å¿ƒçº¿ç¨‹ï¼Œé‚£å°±æ— æ‰€è°“äº†ï¼Œå…¨éƒ¨çº¿ç¨‹éƒ½æ‰§è¡Œè¶…æ—¶å›æ”¶\r\n          // æ¡ä»¶äºŒæˆç«‹è¯´æ˜çº¿ç¨‹æ•°é‡å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå½“å‰çº¿ç¨‹è®¤ä¸ºæ˜¯éæ ¸å¿ƒçº¿ç¨‹ï¼Œæœ‰ä¿æ´»æ—¶é—´ï¼Œå»è¶…æ—¶è·å–ä»»åŠ¡\r\n          boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;\r\n          \r\n  \t\t// å¦‚æœçº¿ç¨‹æ•°é‡æ˜¯è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼Œç›´æ¥å›æ”¶\r\n          // å¦‚æœå½“å‰çº¿ç¨‹ã€å…è®¸è¶…æ—¶å›æ”¶å¹¶ä¸”å·²ç»è¶…æ—¶äº†ã€‘ï¼Œå°±åº”è¯¥è¢«å›æ”¶äº†ï¼Œç”±äºã€æ‹…ä¿æœºåˆ¶ã€‘è¿˜è¦åšåˆ¤æ–­ï¼š\r\n          // \t  wc > 1 è¯´æ˜çº¿ç¨‹æ± è¿˜ç”¨å…¶ä»–çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥ç›´æ¥å›æ”¶\r\n          //    workQueue.isEmpty() å‰ç½®æ¡ä»¶æ˜¯ wc = 1ï¼Œã€å¦‚æœå½“å‰ä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ˜¯ç©ºäº†ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥é€€å‡ºã€‘\r\n          if ((wc > maximumPoolSize || (timed && timedOut)) && (wc > 1 || workQueue.isEmpty())) {\r\n              // ä½¿ç”¨ CAS æœºåˆ¶å°† ctl å€¼ -1 ,å‡ 1 æˆåŠŸçš„çº¿ç¨‹ï¼Œè¿”å› nullï¼Œä»£è¡¨å¯ä»¥é€€å‡º\r\n              if (compareAndDecrementWorkerCount(c))\r\n                  return null;\r\n              continue;\r\n          }\r\n  \r\n          try {\r\n              // æ ¹æ®å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦è¶…æ—¶å›æ”¶ï¼Œã€é€‰æ‹©ä»é˜Ÿåˆ—è·å–ä»»åŠ¡çš„æ–¹æ³•ã€‘æ˜¯è¶…æ—¶è·å–æˆ–è€…é˜»å¡è·å–\r\n              Runnable r = timed ?\r\n                  workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take();\r\n              // è·å–åˆ°ä»»åŠ¡è¿”å›ä»»åŠ¡ï¼Œã€é˜»å¡è·å–ä¼šé˜»å¡åˆ°è·å–ä»»åŠ¡ä¸ºæ­¢ã€‘ï¼Œä¸ä¼šè¿”å› null\r\n              if (r != null)\r\n                  return r;\r\n              // è·å–ä»»åŠ¡ä¸º null è¯´æ˜è¶…æ—¶äº†ï¼Œå°†è¶…æ—¶æ ‡è®°è®¾ç½®ä¸º trueï¼Œä¸‹æ¬¡è‡ªæ—‹æ—¶è¿”å› null\r\n              timedOut = true;\r\n          } catch (InterruptedException retry) {\r\n              // é˜»å¡çº¿ç¨‹è¢«æ‰“æ–­åè¶…æ—¶æ ‡è®°ç½®ä¸º falseï¼Œã€è¯´æ˜è¢«æ‰“æ–­ä¸ç®—è¶…æ—¶ã€‘ï¼Œè¦ç»§ç»­è·å–ï¼Œç›´åˆ°è¶…æ—¶æˆ–è€…è·å–åˆ°ä»»åŠ¡\r\n              // å¦‚æœçº¿ç¨‹æ±  SHUTDOWNï¼ˆSTOP!ï¼‰ çŠ¶æ€ä¸‹çš„æ‰“æ–­ï¼Œä¼šåœ¨å¾ªç¯è·å–ä»»åŠ¡å‰åˆ¤æ–­ï¼Œè¿”å› null\r\n              timedOut = false;\r\n          }\r\n      }\r\n  }\r\n  ```\r\n\r\n  > æ ¸å¿ƒçº¿ç¨‹é˜»å¡è·å–é˜Ÿåˆ—ä»»åŠ¡ï¼Œæ•‘æ€¥çº¿ç¨‹è¶…æ—¶è·å–é˜Ÿåˆ—ä»»åŠ¡ï¼›è®¾ç½®allowCoreThreadTimeOutä¸ºtrueï¼Œéƒ½è¶…æ—¶è·å–é˜Ÿåˆ—ä»»åŠ¡\r\n\r\n- `processWorkerExit()`ï¼š**çº¿ç¨‹é€€å‡ºçº¿ç¨‹æ± **ï¼Œä¹Ÿæœ‰æ‹…ä¿æœºåˆ¶ï¼Œä¿è¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¢«æ‰§è¡Œ\r\n\r\n  ```java\r\n  // æ­£å¸¸é€€å‡º completedAbruptly = falseï¼Œå¼‚å¸¸é€€å‡ºä¸º true\r\n  private void processWorkerExit(Worker w, boolean completedAbruptly) {\r\n      // æ¡ä»¶æˆç«‹ä»£è¡¨å½“å‰ worker æ˜¯å‘ç”Ÿå¼‚å¸¸é€€å‡ºçš„ï¼Œtask ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸äº†\r\n      if (completedAbruptly) \r\n          // ä»å¼‚å¸¸æ—¶åˆ°è¿™é‡Œ ctl ä¸€ç›´æ²¡æœ‰ -1ï¼Œéœ€è¦åœ¨è¿™é‡Œ -1\r\n          decrementWorkerCount();\r\n  \r\n      final ReentrantLock mainLock = this.mainLock;\r\n      // åŠ é”\r\n      mainLock.lock();\r\n      try {\r\n          // å°†å½“å‰ worker å®Œæˆçš„ task æ•°é‡ï¼Œæ±‡æ€»åˆ°çº¿ç¨‹æ± çš„ completedTaskCount\r\n          completedTaskCount += w.completedTasks;\r\n  \t\t// å°† worker ä»çº¿ç¨‹æ± ä¸­ç§»é™¤\r\n          workers.remove(w);\r\n      } finally {\r\n          mainLock.unlock();\t// è§£é”\r\n      }\r\n  \t// å°è¯•åœæ­¢çº¿ç¨‹æ± ï¼Œå”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹\r\n      tryTerminate();\r\n  \r\n      int c = ctl.get();\r\n      // çº¿ç¨‹æ± ä¸æ˜¯åœæ­¢çŠ¶æ€å°±åº”è¯¥æœ‰çº¿ç¨‹è¿è¡Œã€æ‹…ä¿æœºåˆ¶ã€‘\r\n      if (runStateLessThan(c, STOP)) {\r\n          // æ­£å¸¸é€€å‡ºçš„é€»è¾‘ï¼Œæ˜¯å¯¹ç©ºé—²çº¿ç¨‹å›æ”¶ï¼Œä¸æ˜¯æ‰§è¡Œå‡ºé”™\r\n          if (!completedAbruptly) {\r\n              // æ ¹æ®æ˜¯å¦å›æ”¶æ ¸å¿ƒçº¿ç¨‹ç¡®å®šã€çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡æœ€å°å€¼ã€‘\r\n              int min = allowCoreThreadTimeOut ? 0 : corePoolSize;\r\n              // æœ€å°å€¼ä¸º 0ï¼Œä½†æ˜¯çº¿ç¨‹é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œéœ€è¦ä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆä»»åŠ¡æ‹…ä¿æœºåˆ¶\r\n              if (min == 0 && !workQueue.isEmpty())\r\n                  min = 1;\r\n              // çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äºæœ€å°å€¼å¯ä»¥ç›´æ¥è¿”å›\r\n              if (workerCountOf(c) >= min)\r\n                  return;\r\n          }\r\n          // æ‰§è¡Œ task æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œæœ‰ä¸ªçº¿ç¨‹å› ä¸ºå¼‚å¸¸ç»ˆæ­¢äº†ï¼Œéœ€è¦æ·»åŠ \r\n          // æˆ–è€…çº¿ç¨‹æ± ä¸­çš„æ•°é‡å°äºæœ€å°å€¼ï¼Œè¿™é‡Œè¦åˆ›å»ºä¸€ä¸ªæ–° worker åŠ è¿›çº¿ç¨‹æ± \r\n          addWorker(null, false);\r\n      }\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n****\r\n\r\n\r\n\r\n##### åœæ­¢æ–¹æ³•\r\n\r\n- `shutdown()`ï¼šåœæ­¢çº¿ç¨‹æ± \r\n\r\n  ```java\r\n  public void shutdown() {\r\n      final ReentrantLock mainLock = this.mainLock;\r\n      // è·å–çº¿ç¨‹æ± å…¨å±€é”\r\n      mainLock.lock();\r\n      try {\r\n          checkShutdownAccess();\r\n          // è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWNï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€å¤§äº SHUTDOWNï¼Œå°±ä¸ä¼šè®¾ç½®ç›´æ¥è¿”å›\r\n          advanceRunState(SHUTDOWN);\r\n          // ä¸­æ–­ç©ºé—²çº¿ç¨‹\r\n          interruptIdleWorkers();\r\n          // ç©ºæ–¹æ³•ï¼Œå­ç±»å¯ä»¥æ‰©å±•\r\n          onShutdown(); \r\n      } finally {\r\n          // é‡Šæ”¾çº¿ç¨‹æ± å…¨å±€é”\r\n          mainLock.unlock();\r\n      }\r\n      tryTerminate();\r\n  }\r\n  ```\r\n\r\n- `interruptIdleWorkers()`ï¼šshutdown æ–¹æ³•ä¼š**ä¸­æ–­æ‰€æœ‰ç©ºé—²çº¿ç¨‹**ï¼Œæ ¹æ®æ˜¯å¦å¯ä»¥è·å– AQS ç‹¬å é”åˆ¤æ–­æ˜¯å¦å¤„äºå·¥ä½œçŠ¶æ€ã€‚çº¿ç¨‹ä¹‹æ‰€ä»¥ç©ºé—²æ˜¯å› ä¸ºé˜»å¡é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡ï¼Œä¸ä¼šä¸­æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œæ‰€ä»¥ shutdown æ–¹æ³•ä¼šè®©æ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•\r\n\r\n  ```java\r\n  // onlyOne == true è¯´æ˜åªä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ ï¼Œfalse åˆ™ä¸­æ–­æ‰€æœ‰çº¿ç¨‹\r\n  private void interruptIdleWorkers(boolean onlyOne) {\r\n      final ReentrantLock mainLock = this.mainLock;\r\n      //æŒæœ‰å…¨å±€é”\r\n      mainLock.lock();\r\n      try {\r\n          // éå†æ‰€æœ‰ worker\r\n          for (Worker w : workers) {\r\n              // è·å–å½“å‰ worker çš„çº¿ç¨‹\r\n              Thread t = w.thread;\r\n              // æ¡ä»¶ä¸€æˆç«‹ï¼šè¯´æ˜å½“å‰è¿­ä»£çš„è¿™ä¸ªçº¿ç¨‹å°šæœªä¸­æ–­\r\n              // æ¡ä»¶äºŒæˆç«‹ï¼šè¯´æ˜ã€å½“å‰workerå¤„äºç©ºé—²çŠ¶æ€ã€‘ï¼Œé˜»å¡åœ¨pollæˆ–è€…takeï¼Œå› ä¸ºworkeræ‰§è¡Œtaskæ—¶æ˜¯è¦åŠ é”çš„\r\n              //           æ¯ä¸ªworkeræœ‰ä¸€ä¸ªç‹¬å é”ï¼Œw.tryLock()å°è¯•åŠ é”ï¼ŒåŠ é”æˆåŠŸè¿”å› true\r\n              if (!t.isInterrupted() && w.tryLock()) {\r\n                  try {\r\n                      // ä¸­æ–­çº¿ç¨‹ï¼Œå¤„äº queue é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡è‡ªæ—‹ï¼Œè¿”å› nullï¼Œæ‰§è¡Œé€€å‡ºé€»è¾‘\r\n                      t.interrupt();\r\n                  } catch (SecurityException ignore) {\r\n                  } finally {\r\n                      // é‡Šæ”¾workerçš„ç‹¬å é”\r\n                      w.unlock();\r\n                  }\r\n              }\r\n              // falseï¼Œä»£è¡¨ä¸­æ–­æ‰€æœ‰çš„çº¿ç¨‹\r\n              if (onlyOne)\r\n                  break;\r\n          }\r\n  \r\n      } finally {\r\n          // é‡Šæ”¾å…¨å±€é”\r\n          mainLock.unlock();\r\n      }\r\n  }\r\n  ```\r\n\r\n- `shutdownNow()`ï¼šç›´æ¥å…³é—­çº¿ç¨‹æ± ï¼Œä¸ä¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ\r\n\r\n  ```java\r\n  public List<Runnable> shutdownNow() {\r\n      // è¿”å›å€¼å¼•ç”¨\r\n      List<Runnable> tasks;\r\n      final ReentrantLock mainLock = this.mainLock;\r\n      // è·å–çº¿ç¨‹æ± å…¨å±€é”\r\n      mainLock.lock();\r\n      try {\r\n          checkShutdownAccess();\r\n          // è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOP\r\n          advanceRunState(STOP);\r\n          // ä¸­æ–­çº¿ç¨‹æ± ä¸­ã€æ‰€æœ‰çº¿ç¨‹ã€‘\r\n          interruptWorkers();\r\n          // ä»é˜»å¡é˜Ÿåˆ—ä¸­å¯¼å‡ºæœªå¤„ç†çš„task\r\n          tasks = drainQueue();\r\n      } finally {\r\n          mainLock.unlock();\r\n      }\r\n  \r\n      tryTerminate();\r\n      // è¿”å›å½“å‰ä»»åŠ¡é˜Ÿåˆ—ä¸­ æœªå¤„ç†çš„ä»»åŠ¡ã€‚\r\n      return tasks;\r\n  }\r\n  ```\r\n\r\n- `tryTerminate()`ï¼šè®¾ç½®ä¸º TERMINATED çŠ¶æ€ `if either (SHUTDOWN and pool and queue empty) or (STOP and pool empty)`\r\n\r\n  ```java\r\n  final void tryTerminate() {\r\n      for (;;) {\r\n          // è·å– ctl çš„å€¼\r\n          int c = ctl.get();\r\n          // çº¿ç¨‹æ± æ­£å¸¸ï¼Œæˆ–è€…æœ‰å…¶ä»–çº¿ç¨‹æ‰§è¡Œäº†çŠ¶æ€è½¬æ¢çš„æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹ç›´æ¥è¿”å›\r\n          if (isRunning(c) || runStateAtLeast(c, TIDYING) ||\r\n              // çº¿ç¨‹æ± æ˜¯ SHUTDOWN å¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¸æ˜¯ç©ºï¼Œéœ€è¦å»å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡\r\n              (runStateOf(c) == SHUTDOWN && ! workQueue.isEmpty()))\r\n              return;\r\n          \r\n          // æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜çº¿ç¨‹æ± çŠ¶æ€ä¸º STOP æˆ–è€…çº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWN å¹¶ä¸”é˜Ÿåˆ—å·²ç»æ˜¯ç©º\r\n          // åˆ¤æ–­çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡\r\n          if (workerCountOf(c) != 0) {\r\n              // ã€ä¸­æ–­ä¸€ä¸ªç©ºé—²çº¿ç¨‹ã€‘ï¼Œåœ¨ queue.take() | queue.poll() é˜»å¡ç©ºé—²\r\n              // å”¤é†’åçš„çº¿ç¨‹ä¼šåœ¨getTask()æ–¹æ³•è¿”å›nullï¼Œ\r\n              // æ‰§è¡Œ processWorkerExit é€€å‡ºé€»è¾‘æ—¶ä¼šå†æ¬¡è°ƒç”¨ tryTerminate() å”¤é†’ä¸‹ä¸€ä¸ªç©ºé—²çº¿ç¨‹\r\n              interruptIdleWorkers(ONLY_ONE);\r\n              return;\r\n          }\r\n  \t\t// æ± ä¸­çš„çº¿ç¨‹æ•°é‡ä¸º 0 æ¥åˆ°è¿™é‡Œ\r\n          final ReentrantLock mainLock = this.mainLock;\r\n          // åŠ å…¨å±€é”\r\n          mainLock.lock();\r\n          try {\r\n              // è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸º TIDYING çŠ¶æ€ï¼Œçº¿ç¨‹æ•°é‡ä¸º 0\r\n              if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) {\r\n                  try {\r\n                      // ç»“æŸçº¿ç¨‹æ± \r\n                      terminated();\r\n                  } finally {\r\n                      // è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºTERMINATEDçŠ¶æ€ã€‚\r\n                      ctl.set(ctlOf(TERMINATED, 0));\r\n                      // ã€å”¤é†’æ‰€æœ‰è°ƒç”¨ awaitTermination() æ–¹æ³•çš„çº¿ç¨‹ã€‘\r\n                      termination.signalAll();\r\n                  }\r\n                  return;\r\n              }\r\n          } finally {\r\n  \t\t\t// é‡Šæ”¾çº¿ç¨‹æ± å…¨å±€é”\r\n              mainLock.unlock();\r\n          }\r\n      }\r\n  }\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### Future\r\n\r\n##### çº¿ç¨‹ä½¿ç”¨\r\n\r\nFutureTask æœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œç»§æ‰¿ Runnableã€Future æ¥å£ï¼Œç”¨äºåŒ…è£… Callable å¯¹è±¡ï¼Œå®ç°ä»»åŠ¡çš„æäº¤\r\n\r\n```java\r\npublic static void main(String[] args) throws ExecutionException, InterruptedException {\r\n    FutureTask<String> task = new FutureTask<>(new Callable<String>() {\r\n        @Override\r\n        public String call() throws Exception {\r\n            return \"Hello World\";\r\n        }\r\n    });\r\n    new Thread(task).start();\t//å¯åŠ¨çº¿ç¨‹\r\n    String msg = task.get();\t//è·å–è¿”å›ä»»åŠ¡æ•°æ®\r\n    System.out.println(msg);\r\n}\r\n```\r\n\r\næ„é€ æ–¹æ³•ï¼š\r\n\r\n```java\r\npublic FutureTask(Callable<V> callable){\r\n\tthis.callable = callable;\t// å±æ€§æ³¨å…¥\r\n    this.state = NEW; \t\t\t// ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸º new\r\n}\r\n```\r\n\r\n```java\r\npublic FutureTask(Runnable runnable, V result) {\r\n    // é€‚é…å™¨æ¨¡å¼\r\n    this.callable = Executors.callable(runnable, result);\r\n    this.state = NEW;       \r\n}\r\npublic static <T> Callable<T> callable(Runnable task, T result) {\r\n    if (task == null) throw new NullPointerException();\r\n    // ä½¿ç”¨é€‚é…å™¨æ¨¡å¼å°† runnable è½¬æ¢æˆ callable æ¥å£ï¼Œå¤–éƒ¨çº¿ç¨‹é€šè¿‡ get è·å–\r\n    // å½“å‰ä»»åŠ¡æ‰§è¡Œç»“æœæ—¶ï¼Œç»“æœå¯èƒ½ä¸º null ä¹Ÿå¯èƒ½ä¸ºä¼ è¿›æ¥çš„å€¼ï¼Œã€ä¼ è¿›æ¥ä»€ä¹ˆè¿”å›ä»€ä¹ˆã€‘\r\n    return new RunnableAdapter<T>(task, result);\r\n}\r\nstatic final class RunnableAdapter<T> implements Callable<T> {\r\n    final Runnable task;\r\n    final T result;\r\n    // æ„é€ æ–¹æ³•\r\n    RunnableAdapter(Runnable task, T result) {\r\n        this.task = task;\r\n        this.result = result;\r\n    }\r\n    public T call() {\r\n        // å®åˆ™è°ƒç”¨ Runnable#run æ–¹æ³•\r\n        task.run();\r\n        // è¿”å›å€¼ä¸ºæ„é€  FutureTask å¯¹è±¡æ—¶ä¼ å…¥çš„è¿”å›å€¼æˆ–è€…æ˜¯ null\r\n        return result;\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æˆå‘˜å±æ€§\r\n\r\nFutureTask ç±»çš„æˆå‘˜å±æ€§ï¼š\r\n\r\n- ä»»åŠ¡çŠ¶æ€ï¼š\r\n\r\n  ```java\r\n  // è¡¨ç¤ºå½“å‰taskçŠ¶æ€\r\n  private volatile int state;\r\n  // å½“å‰ä»»åŠ¡å°šæœªæ‰§è¡Œ\r\n  private static final int NEW          = 0;\r\n  // å½“å‰ä»»åŠ¡æ­£åœ¨ç»“æŸï¼Œå°šæœªå®Œå…¨ç»“æŸï¼Œä¸€ç§ä¸´ç•ŒçŠ¶æ€\r\n  private static final int COMPLETING   = 1;\r\n  // å½“å‰ä»»åŠ¡æ­£å¸¸ç»“æŸ\r\n  private static final int NORMAL       = 2;\r\n  // å½“å‰ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå†…éƒ¨å°è£…çš„ callable.run() å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸äº†\r\n  private static final int EXCEPTIONAL  = 3;\r\n  // å½“å‰ä»»åŠ¡è¢«å–æ¶ˆ\r\n  private static final int CANCELLED    = 4;\r\n  // å½“å‰ä»»åŠ¡ä¸­æ–­ä¸­\r\n  private static final int INTERRUPTING = 5;\r\n  // å½“å‰ä»»åŠ¡å·²ä¸­æ–­\r\n  private static final int INTERRUPTED  = 6;\r\n  ```\r\n\r\n- ä»»åŠ¡å¯¹è±¡ï¼š\r\n\r\n  ```java\r\n  private Callable<V> callable;\t// Runnable ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ä¼ªè£…æˆ Callable\r\n  ```\r\n\r\n- **å­˜å‚¨ä»»åŠ¡æ‰§è¡Œçš„ç»“æœ**ï¼Œè¿™æ˜¯ run æ–¹æ³•è¿”å›å€¼æ˜¯ void ä¹Ÿå¯ä»¥è·å–åˆ°æ‰§è¡Œç»“æœçš„åŸå› ï¼š\r\n\r\n  ```java\r\n  // æ­£å¸¸æƒ…å†µä¸‹ï¼šä»»åŠ¡æ­£å¸¸æ‰§è¡Œç»“æŸï¼Œoutcome ä¿å­˜æ‰§è¡Œç»“æœï¼Œcallable è¿”å›å€¼\r\n  // éæ­£å¸¸æƒ…å†µï¼šcallable å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼Œoutcome ä¿å­˜å¼‚å¸¸\r\n  private Object outcome; \r\n  ```\r\n\r\n- æ‰§è¡Œå½“å‰ä»»åŠ¡çš„çº¿ç¨‹å¯¹è±¡ï¼š\r\n\r\n  ```java\r\n  private volatile Thread runner;\t// å½“å‰ä»»åŠ¡è¢«çº¿ç¨‹æ‰§è¡ŒæœŸé—´ï¼Œä¿å­˜å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å¯¹è±¡å¼•ç”¨\r\n  ```\r\n\r\n- **çº¿ç¨‹é˜»å¡é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹**ï¼š\r\n\r\n  ```java\r\n  // ä¼šæœ‰å¾ˆå¤šçº¿ç¨‹å» get å½“å‰ä»»åŠ¡çš„ç»“æœï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ç§æ•°æ®ç»“æ„å¤´æ’å¤´å–ï¼ˆç±»ä¼¼æ ˆï¼‰çš„ä¸€ä¸ªé˜Ÿåˆ—æ¥ä¿å­˜æ‰€æœ‰çš„ get çº¿ç¨‹\r\n  private volatile WaitNode waiters;\r\n  ```\r\n\r\n- å†…éƒ¨ç±»ï¼š\r\n\r\n  ```java\r\n  static final class WaitNode {\r\n      // å•å‘é“¾è¡¨\r\n      volatile Thread thread;\r\n      volatile WaitNode next;\r\n      WaitNode() { thread = Thread.currentThread(); }\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æˆå‘˜æ–¹æ³•\r\n\r\nFutureTask ç±»çš„æˆå‘˜æ–¹æ³•ï¼š\r\n\r\n- `FutureTask#run`ï¼šä»»åŠ¡æ‰§è¡Œå…¥å£\r\n\r\n  ```java\r\n  public void run() {\r\n      //æ¡ä»¶ä¸€ï¼šæˆç«‹è¯´æ˜å½“å‰ task å·²ç»è¢«æ‰§è¡Œè¿‡äº†æˆ–è€…è¢« cancel äº†ï¼Œé NEW çŠ¶æ€çš„ä»»åŠ¡ï¼Œçº¿ç¨‹å°±ä¸éœ€è¦å¤„ç†äº†\r\n      //æ¡ä»¶äºŒï¼šçº¿ç¨‹æ˜¯ NEW çŠ¶æ€ï¼Œå°è¯•è®¾ç½®å½“å‰ä»»åŠ¡å¯¹è±¡çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ï¼Œè®¾ç½®å¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹æŠ¢å äº†è¯¥ä»»åŠ¡ï¼Œç›´æ¥è¿”å›\r\n      if (state != NEW ||\r\n          !UNSAFE.compareAndSwapObject(this, runnerOffset, null, Thread.currentThread()))\r\n          return;\r\n      try {\r\n          // æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå½“å‰ task ä¸€å®šæ˜¯ NEW çŠ¶æ€ï¼Œè€Œä¸”ã€å½“å‰çº¿ç¨‹ä¹ŸæŠ¢å  task æˆåŠŸã€‘\r\n          Callable<V> c = callable;\r\n          // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ä¸ºç©ºï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼›åˆ¤æ–­ state çŠ¶æ€ï¼Œé˜²æ­¢å¤–éƒ¨çº¿ç¨‹åœ¨æ­¤æœŸé—´ cancel æ‰å½“å‰ä»»åŠ¡\r\n          // ã€å› ä¸º task çš„æ‰§è¡Œè€…å·²ç»è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‘\r\n          if (c != null && state == NEW) {\r\n              V result;\r\n              // true è¡¨ç¤º callable.run ä»£ç å—æ‰§è¡ŒæˆåŠŸ æœªæŠ›å‡ºå¼‚å¸¸\r\n              // false è¡¨ç¤º callable.run ä»£ç å—æ‰§è¡Œå¤±è´¥ æŠ›å‡ºå¼‚å¸¸\r\n              boolean ran;\r\n              try {\r\n  \t\t\t\t// ã€è°ƒç”¨è‡ªå®šä¹‰çš„æ–¹æ³•ï¼Œæ‰§è¡Œç»“æœèµ‹å€¼ç»™ resultã€‘\r\n                  result = c.call();\r\n                  // æ²¡æœ‰å‡ºç°å¼‚å¸¸\r\n                  ran = true;\r\n              } catch (Throwable ex) {\r\n                  // å‡ºç°å¼‚å¸¸ï¼Œè¿”å›å€¼ç½®ç©ºï¼Œran ç½®ä¸º false\r\n                  result = null;\r\n                  ran = false;\r\n                  // è®¾ç½®è¿”å›çš„å¼‚å¸¸\r\n                  setException(ex);\r\n              }\r\n              // ä»£ç å—æ‰§è¡Œæ­£å¸¸\r\n              if (ran)\r\n                  // è®¾ç½®è¿”å›çš„ç»“æœ\r\n                  set(result);\r\n          }\r\n      } finally {\r\n          // ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå–æ¶ˆçº¿ç¨‹çš„å¼•ç”¨ï¼Œhelp GC\r\n          runner = null;\r\n          int s = state;\r\n          // åˆ¤æ–­ä»»åŠ¡æ˜¯ä¸æ˜¯è¢«ä¸­æ–­\r\n          if (s >= INTERRUPTING)\r\n              // æ‰§è¡Œä¸­æ–­å¤„ç†æ–¹æ³•\r\n              handlePossibleCancellationInterrupt(s);\r\n      }\r\n  }\r\n  ```\r\n\r\n  `FutureTask#set`ï¼šè®¾ç½®æ­£å¸¸è¿”å›å€¼ï¼Œé¦–å…ˆå°†ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸º COMPLETING çŠ¶æ€ä»£è¡¨å®Œæˆä¸­ï¼Œé€»è¾‘æ‰§è¡Œå®Œè®¾ç½®ä¸º NORMAL çŠ¶æ€ä»£è¡¨ä»»åŠ¡æ­£å¸¸æ‰§è¡Œå®Œæˆï¼Œæœ€åå”¤é†’ get() é˜»å¡çº¿ç¨‹\r\n\r\n  ```java\r\n  protected void set(V v) {\r\n      // CAS æ–¹å¼è®¾ç½®å½“å‰ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆä¸­ï¼Œè®¾ç½®å¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹å–æ¶ˆäº†è¯¥ä»»åŠ¡\r\n      if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) {\r\n          // ã€å°†ç»“æœèµ‹å€¼ç»™ outcomeã€‘\r\n          outcome = v;\r\n          // å°†å½“å‰ä»»åŠ¡çŠ¶æ€ä¿®æ”¹ä¸º NORMAL æ­£å¸¸ç»“æŸçŠ¶æ€ã€‚\r\n          UNSAFE.putOrderedInt(this, stateOffset, NORMAL);\r\n          finishCompletion();\r\n      }\r\n  }\r\n  ```\r\n\r\n  `FutureTask#setException`ï¼šè®¾ç½®å¼‚å¸¸è¿”å›å€¼\r\n\r\n  ```java\r\n  protected void setException(Throwable t) {\r\n      if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) {\r\n          // èµ‹å€¼ç»™è¿”å›ç»“æœï¼Œç”¨æ¥å‘ä¸Šå±‚æŠ›å‡ºæ¥çš„å¼‚å¸¸\r\n          outcome = t;\r\n          // å°†å½“å‰ä»»åŠ¡çš„çŠ¶æ€ ä¿®æ”¹ä¸º EXCEPTIONAL\r\n          UNSAFE.putOrderedInt(this, stateOffset, EXCEPTIONAL);\r\n          finishCompletion();\r\n      }\r\n  }\r\n  ```\r\n\r\n  `FutureTask#finishCompletion`ï¼š**å”¤é†’ get() é˜»å¡çº¿ç¨‹**\r\n\r\n  ```java\r\n  private void finishCompletion() {\r\n      // éå†æ‰€æœ‰çš„ç­‰å¾…çš„èŠ‚ç‚¹ï¼Œq æŒ‡å‘å¤´èŠ‚ç‚¹\r\n      for (WaitNode q; (q = waiters) != null;) {\r\n          // ä½¿ç”¨casè®¾ç½® waiters ä¸º nullï¼Œé˜²æ­¢å¤–éƒ¨çº¿ç¨‹ä½¿ç”¨cancelå–æ¶ˆå½“å‰ä»»åŠ¡ï¼Œè§¦å‘finishCompletionæ–¹æ³•é‡å¤æ‰§è¡Œ\r\n          if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) {\r\n              // è‡ªæ—‹\r\n              for (;;) {\r\n                  // è·å–å½“å‰ WaitNode èŠ‚ç‚¹å°è£…çš„ thread\r\n                  Thread t = q.thread;\r\n                  // å½“å‰çº¿ç¨‹ä¸ä¸º nullï¼Œå”¤é†’å½“å‰ get() ç­‰å¾…è·å–æ•°æ®çš„çº¿ç¨‹\r\n                  if (t != null) {\r\n                      q.thread = null;\r\n                      LockSupport.unpark(t);\r\n                  }\r\n                  // è·å–å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r\n                  WaitNode next = q.next;\r\n                  // å½“å‰èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹äº†\r\n                  if (next == null)\r\n                      break;\r\n                  // æ–­å¼€é“¾è¡¨\r\n                  q.next = null; // help gc\r\n                  q = next;\r\n              }\r\n              break;\r\n          }\r\n      }\r\n      done();\r\n      callable = null;\t// help GC\r\n  }\r\n  ```\r\n\r\n  `FutureTask#handlePossibleCancellationInterrupt`ï¼šä»»åŠ¡ä¸­æ–­å¤„ç†\r\n\r\n  ```java\r\n  private void handlePossibleCancellationInterrupt(int s) {\r\n      if (s == INTERRUPTING)\r\n          // ä¸­æ–­çŠ¶æ€ä¸­\r\n          while (state == INTERRUPTING)\r\n              // ç­‰å¾…ä¸­æ–­å®Œæˆ\r\n              Thread.yield();\r\n  }\r\n  ```\r\n\r\n- `FutureTask#get`ï¼šè·å–ä»»åŠ¡æ‰§è¡Œçš„è¿”å›å€¼ï¼Œæ‰§è¡Œ run å’Œ get çš„ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€èˆ¬æœ‰å¤šä¸ªçº¿ç¨‹ getï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ run\r\n\r\n  ```java\r\n  public V get() throws InterruptedException, ExecutionException {\r\n      // è·å–å½“å‰ä»»åŠ¡çŠ¶æ€\r\n      int s = state;\r\n      // æ¡ä»¶æˆç«‹è¯´æ˜ä»»åŠ¡è¿˜æ²¡æ‰§è¡Œå®Œæˆ\r\n      if (s <= COMPLETING)\r\n          // è¿”å› task å½“å‰çŠ¶æ€ï¼Œå¯èƒ½å½“å‰çº¿ç¨‹åœ¨é‡Œé¢å·²ç»ç¡äº†ä¸€ä¼š\r\n          s = awaitDone(false, 0L);\r\n      return report(s);\r\n  }\r\n  ```\r\n\r\n  `FutureTask#awaitDone`ï¼š**get çº¿ç¨‹å°è£…æˆ WaitNode å¯¹è±¡è¿›å…¥é˜»å¡é˜Ÿåˆ—é˜»å¡ç­‰å¾…**\r\n\r\n  ```java\r\n  private int awaitDone(boolean timed, long nanos) throws InterruptedException {\r\n      // 0 ä¸å¸¦è¶…æ—¶\r\n      final long deadline = timed ? System.nanoTime() + nanos : 0L;\r\n      // å¼•ç”¨å½“å‰çº¿ç¨‹ï¼Œå°è£…æˆ WaitNode å¯¹è±¡\r\n      WaitNode q = null;\r\n      // è¡¨ç¤ºå½“å‰çº¿ç¨‹ waitNode å¯¹è±¡ï¼Œæ˜¯å¦è¿›å…¥é˜»å¡é˜Ÿåˆ—\r\n      boolean queued = false;\r\n      // ã€ä¸‰æ¬¡è‡ªæ—‹å¼€å§‹ä¼‘çœ ã€‘\r\n      for (;;) {\r\n          // åˆ¤æ–­å½“å‰ get() çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ‰“æ–­è¿”å› trueï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°\r\n          if (Thread.interrupted()) {\r\n              // å½“å‰çº¿ç¨‹å¯¹åº”çš„ç­‰å¾… node å‡ºé˜Ÿï¼Œ\r\n              removeWaiter(q);\r\n              throw new InterruptedException();\r\n          }\r\n  \t\t// è·å–ä»»åŠ¡çŠ¶æ€\r\n          int s = state;\r\n          // æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæˆå·²ç»æœ‰ç»“æœäº†\r\n          if (s > COMPLETING) {\r\n              // æ¡ä»¶æˆç«‹è¯´æ˜å·²ç»ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºäº† WaitNodeï¼Œç½®ç©º help GC\r\n              if (q != null)\r\n                  q.thread = null;\r\n              // è¿”å›å½“å‰çš„çŠ¶æ€\r\n              return s;\r\n          }\r\n          // æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ä»»åŠ¡æ¥è¿‘å®ŒæˆçŠ¶æ€ï¼Œè¿™é‡Œè®©å½“å‰çº¿ç¨‹é‡Šæ”¾ä¸€ä¸‹ cpu ï¼Œç­‰å¾…è¿›è¡Œä¸‹ä¸€æ¬¡æŠ¢å  cpu\r\n          else if (s == COMPLETING) \r\n              Thread.yield();\r\n          // ã€ç¬¬ä¸€æ¬¡è‡ªæ—‹ã€‘ï¼Œå½“å‰çº¿ç¨‹è¿˜æœªåˆ›å»º WaitNode å¯¹è±¡ï¼Œæ­¤æ—¶ä¸ºå½“å‰çº¿ç¨‹åˆ›å»º WaitNodeå¯¹è±¡\r\n          else if (q == null)\r\n              q = new WaitNode();\r\n          // ã€ç¬¬äºŒæ¬¡è‡ªæ—‹ã€‘ï¼Œå½“å‰çº¿ç¨‹å·²ç»åˆ›å»º WaitNode å¯¹è±¡äº†ï¼Œä½†æ˜¯nodeå¯¹è±¡è¿˜æœªå…¥é˜Ÿ\r\n          else if (!queued)\r\n              // waiters æŒ‡å‘é˜Ÿé¦–ï¼Œè®©å½“å‰ WaitNode æˆä¸ºæ–°çš„é˜Ÿé¦–ï¼Œã€å¤´æ’æ³•ã€‘ï¼Œå¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†æ–°çš„é˜Ÿé¦–\r\n              queued = UNSAFE.compareAndSwapObject(this, waitersOffset, q.next = waiters, q);\r\n          // ã€ç¬¬ä¸‰æ¬¡è‡ªæ—‹ã€‘ï¼Œä¼šåˆ°è¿™é‡Œï¼Œæˆ–è€… else å†…\r\n          else if (timed) {\r\n              nanos = deadline - System.nanoTime();\r\n              if (nanos <= 0L) {\r\n                  removeWaiter(q);\r\n                  return state;\r\n              }\r\n              // é˜»å¡æŒ‡å®šçš„æ—¶é—´\r\n              LockSupport.parkNanos(this, nanos);\r\n          }\r\n          // æ¡ä»¶æˆç«‹ï¼šè¯´æ˜éœ€è¦é˜»å¡\r\n          else\r\n              // ã€å½“å‰ get æ“ä½œçš„çº¿ç¨‹è¢« park é˜»å¡ã€‘ï¼Œé™¤éæœ‰å…¶å®ƒçº¿ç¨‹å°†å”¤é†’æˆ–è€…å°†å½“å‰çº¿ç¨‹ä¸­æ–­\r\n              LockSupport.park(this);\r\n      }\r\n  }\r\n  ```\r\n\r\n  `FutureTask#report`ï¼šå°è£…è¿è¡Œç»“æœï¼Œå¯ä»¥è·å– run() æ–¹æ³•ä¸­è®¾ç½®çš„æˆå‘˜å˜é‡ outcomeï¼Œ**è¿™æ˜¯ run æ–¹æ³•çš„è¿”å›å€¼æ˜¯ void ä¹Ÿå¯ä»¥è·å–åˆ°ä»»åŠ¡æ‰§è¡Œçš„ç»“æœçš„åŸå› **\r\n\r\n  ```java\r\n  private V report(int s) throws ExecutionException {\r\n      // è·å–æ‰§è¡Œç»“æœï¼Œæ˜¯åœ¨ä¸€ä¸ª futuretask å¯¹è±¡ä¸­çš„å±æ€§ï¼Œå¯ä»¥ç›´æ¥è·å–\r\n      Object x = outcome;\r\n      // å½“å‰ä»»åŠ¡çŠ¶æ€æ­£å¸¸ç»“æŸ\r\n      if (s == NORMAL)\r\n          return (V)x;\t// ç›´æ¥è¿”å› callable çš„é€»è¾‘ç»“æœ\r\n      // å½“å‰ä»»åŠ¡è¢«å–æ¶ˆæˆ–è€…ä¸­æ–­\r\n      if (s >= CANCELLED)\r\n          throw new CancellationException();\t\t// æŠ›å‡ºå¼‚å¸¸\r\n      // æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜è‡ªå®šä¹‰çš„ callable ä¸­çš„æ–¹æ³•æœ‰å¼‚å¸¸ï¼Œä½¿ç”¨ outcome ä¸Šå±‚æŠ›å‡ºå¼‚å¸¸\r\n      throw new ExecutionException((Throwable)x);\t\r\n  }\r\n  ```\r\n\r\n- `FutureTask#cancel`ï¼šä»»åŠ¡å–æ¶ˆï¼Œæ‰“æ–­æ­£åœ¨æ‰§è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹\r\n\r\n  ```java\r\n  public boolean cancel(boolean mayInterruptIfRunning) {\r\n      // æ¡ä»¶ä¸€ï¼šè¡¨ç¤ºå½“å‰ä»»åŠ¡å¤„äºè¿è¡Œä¸­æˆ–è€…å¤„äºçº¿ç¨‹æ± ä»»åŠ¡é˜Ÿåˆ—ä¸­\r\n      // æ¡ä»¶äºŒï¼šè¡¨ç¤ºä¿®æ”¹çŠ¶æ€ï¼ŒæˆåŠŸå¯ä»¥å»æ‰§è¡Œä¸‹é¢é€»è¾‘ï¼Œå¦åˆ™è¿”å› false è¡¨ç¤º cancel å¤±è´¥\r\n      if (!(state == NEW &&\r\n            UNSAFE.compareAndSwapInt(this, stateOffset, NEW,\r\n                                     mayInterruptIfRunning ? INTERRUPTING : CANCELLED)))\r\n          return false;\r\n      try {\r\n          // å¦‚æœä»»åŠ¡å·²ç»è¢«æ‰§è¡Œï¼Œæ˜¯å¦å…è®¸æ‰“æ–­\r\n          if (mayInterruptIfRunning) {\r\n              try {\r\n                  // è·å–æ‰§è¡Œå½“å‰ FutureTask çš„çº¿ç¨‹\r\n                  Thread t = runner;\r\n                  if (t != null)\r\n                      // æ‰“æ–­æ‰§è¡Œçš„çº¿ç¨‹\r\n                      t.interrupt();\r\n              } finally {\r\n                  // è®¾ç½®ä»»åŠ¡çŠ¶æ€ä¸ºã€ä¸­æ–­å®Œæˆã€‘\r\n                  UNSAFE.putOrderedInt(this, stateOffset, INTERRUPTED);\r\n              }\r\n          }\r\n      } finally {\r\n          // å”¤é†’æ‰€æœ‰ get() é˜»å¡çš„çº¿ç¨‹\r\n          finishCompletion();\r\n      }\r\n      return true;\r\n  }\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### ä»»åŠ¡è°ƒåº¦\r\n\r\n#### Timer\r\n\r\nTimer å®ç°å®šæ—¶åŠŸèƒ½ï¼ŒTimer çš„ä¼˜ç‚¹åœ¨äºç®€å•æ˜“ç”¨ï¼Œä½†ç”±äºæ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥è°ƒåº¦ï¼Œå› æ­¤æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼Œå‰ä¸€ä¸ªä»»åŠ¡çš„å»¶è¿Ÿæˆ–å¼‚å¸¸éƒ½å°†ä¼šå½±å“åˆ°ä¹‹åçš„ä»»åŠ¡\r\n\r\n```java\r\nprivate static void method1() {\r\n    Timer timer = new Timer();\r\n    TimerTask task1 = new TimerTask() {\r\n        @Override\r\n        public void run() {\r\n            System.out.println(\"task 1\");\r\n            //int i = 1 / 0;//ä»»åŠ¡ä¸€çš„å‡ºé”™ä¼šå¯¼è‡´ä»»åŠ¡äºŒæ— æ³•æ‰§è¡Œ\r\n            Thread.sleep(2000);\r\n        }\r\n    };\r\n    TimerTask task2 = new TimerTask() {\r\n        @Override\r\n        public void run() {\r\n            System.out.println(\"task 2\");\r\n        }\r\n    };\r\n    // ä½¿ç”¨ timer æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ\r\n\t// ä½†ç”±äº timer å†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå› æ­¤ä»»åŠ¡1çš„å»¶æ—¶ï¼Œå½±å“äº†ä»»åŠ¡2çš„æ‰§è¡Œ\r\n    timer.schedule(task1, 1000);//17:45:56 c.ThreadPool [Timer-0] - task 1\r\n    timer.schedule(task2, 1000);//17:45:58 c.ThreadPool [Timer-0] - task 2\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### Scheduled\r\n\r\nä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ±  ScheduledThreadPoolExecutor ç»§æ‰¿ ThreadPoolExecutorï¼š\r\n\r\n- ä½¿ç”¨å†…éƒ¨ç±» ScheduledFutureTask å°è£…ä»»åŠ¡\r\n- ä½¿ç”¨å†…éƒ¨ç±» DelayedWorkQueue ä½œä¸ºçº¿ç¨‹æ± é˜Ÿåˆ—\r\n- é‡å†™ onShutdown æ–¹æ³•å»å¤„ç† shutdown åçš„ä»»åŠ¡\r\n- æä¾› decorateTask æ–¹æ³•ä½œä¸º ScheduledFutureTask çš„ä¿®é¥°æ–¹æ³•ï¼Œä»¥ä¾¿å¼€å‘è€…è¿›è¡Œæ‰©å±•\r\n\r\næ„é€ æ–¹æ³•ï¼š`Executors.newScheduledThreadPool(int corePoolSize)`\r\n\r\n```java\r\npublic ScheduledThreadPoolExecutor(int corePoolSize) {\r\n    // æœ€å¤§çº¿ç¨‹æ•°å›ºå®šä¸º Integer.MAX_VALUEï¼Œä¿æ´»æ—¶é—´ keepAliveTime å›ºå®šä¸º 0\r\n    super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,\r\n          // é˜»å¡é˜Ÿåˆ—æ˜¯ DelayedWorkQueue\r\n          new DelayedWorkQueue());\r\n}\r\n```\r\n\r\nå¸¸ç”¨ APIï¼š\r\n\r\n- `ScheduledFuture<?> schedule(Runnable/Callable<V>, long delay, TimeUnit u)`ï¼šå»¶è¿Ÿæ‰§è¡Œä»»åŠ¡\r\n- `ScheduledFuture<?> scheduleAtFixedRate(Runnable/Callable<V>, long initialDelay, long period, TimeUnit unit)`ï¼šå®šæ—¶æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼Œä¸è€ƒè™‘æ‰§è¡Œçš„è€—æ—¶ï¼Œå‚æ•°ä¸ºåˆå§‹å»¶è¿Ÿæ—¶é—´ã€é—´éš”æ—¶é—´ã€å•ä½\r\n- `ScheduledFuture<?> scheduleWithFixedDelay(Runnable/Callable<V>, long initialDelay, long delay, TimeUnit unit)`ï¼šå®šæ—¶æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼Œè€ƒè™‘æ‰§è¡Œçš„è€—æ—¶ï¼Œå‚æ•°ä¸ºåˆå§‹å»¶è¿Ÿæ—¶é—´ã€é—´éš”æ—¶é—´ã€å•ä½\r\n\r\nåŸºæœ¬ä½¿ç”¨ï¼š\r\n\r\n- å»¶è¿Ÿä»»åŠ¡ï¼Œä½†æ˜¯å‡ºç°å¼‚å¸¸å¹¶ä¸ä¼šåœ¨æ§åˆ¶å°æ‰“å°ï¼Œä¹Ÿä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„æ‰§è¡Œ\r\n\r\n  ```java\r\n  public static void main(String[] args){\r\n      // çº¿ç¨‹æ± å¤§å°ä¸º1æ—¶ä¹Ÿæ˜¯ä¸²è¡Œæ‰§è¡Œ\r\n      ScheduledExecutorService executor = Executors.newScheduledThreadPool(2);\r\n      // æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œéƒ½åœ¨ 1s ååŒæ—¶æ‰§è¡Œ\r\n      executor.schedule(() -> {\r\n      \tSystem.out.println(\"ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼š\" + new Date());\r\n          //int i = 1 / 0;\r\n      \ttry { Thread.sleep(2000); } catch (InterruptedException e) { }\r\n      }, 1000, TimeUnit.MILLISECONDS);\r\n      \r\n      executor.schedule(() -> {\r\n      \tSystem.out.println(\"ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼š\" + new Date());\r\n      }, 1000, TimeUnit.MILLISECONDS);\r\n  }\r\n  ```\r\n\r\n- å®šæ—¶ä»»åŠ¡ scheduleAtFixedRateï¼š**ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨åˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨**ä¹‹é—´åªè¦å¤§äºç­‰äºé—´éš”æ—¶é—´ï¼ŒæŠ¢å åˆ° CPU å°±ä¼šç«‹å³æ‰§è¡Œ\r\n\r\n  ```java\r\n  public static void main(String[] args) {\r\n      ScheduledExecutorService pool = Executors.newScheduledThreadPool(1);\r\n      System.out.println(\"start...\" + new Date());\r\n      \r\n      pool.scheduleAtFixedRate(() -> {\r\n          System.out.println(\"running...\" + new Date());\r\n          Thread.sleep(2000);\r\n      }, 1, 1, TimeUnit.SECONDS);\r\n  }\r\n  \r\n  /*start...Sat Apr 24 18:08:12 CST 2021\r\n  running...Sat Apr 24 18:08:13 CST 2021\r\n  running...Sat Apr 24 18:08:15 CST 2021\r\n  running...Sat Apr 24 18:08:17 CST 2021\r\n  ```\r\n\r\n- å®šæ—¶ä»»åŠ¡ scheduleWithFixedDelayï¼š**ä¸€æ¬¡ä»»åŠ¡çš„ç»“æŸåˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨ä¹‹é—´**ç­‰äºé—´éš”æ—¶é—´ï¼ŒæŠ¢å åˆ° CPU å°±ä¼šç«‹å³æ‰§è¡Œï¼Œè¿™ä¸ªæ–¹æ³•æ‰æ˜¯çœŸæ­£çš„è®¾ç½®ä¸¤ä¸ªä»»åŠ¡ä¹‹é—´çš„é—´éš”\r\n\r\n  ```java\r\n  public static void main(String[] args){\r\n      ScheduledExecutorService pool = Executors.newScheduledThreadPool(3);\r\n      System.out.println(\"start...\" + new Date());\r\n      \r\n      pool.scheduleWithFixedDelay(() -> {\r\n          System.out.println(\"running...\" + new Date());\r\n          Thread.sleep(2000);\r\n      }, 1, 1, TimeUnit.SECONDS);\r\n  }\r\n  /*start...Sat Apr 24 18:11:41 CST 2021\r\n  running...Sat Apr 24 18:11:42 CST 2021\r\n  running...Sat Apr 24 18:11:45 CST 2021\r\n  running...Sat Apr 24 18:11:48 CST 2021\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æˆå‘˜å±æ€§\r\n\r\n##### æˆå‘˜å˜é‡\r\n\r\n- shutdown åæ˜¯å¦ç»§ç»­æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼š\r\n\r\n  ```java\r\n  private volatile boolean continueExistingPeriodicTasksAfterShutdown;\r\n  ```\r\n\r\n- shutdown åæ˜¯å¦ç»§ç»­æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡ï¼š\r\n\r\n  ```java\r\n  private volatile boolean executeExistingDelayedTasksAfterShutdown = true;\r\n  ```\r\n\r\n- å–æ¶ˆæ–¹æ³•æ˜¯å¦å°†è¯¥ä»»åŠ¡ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼š\r\n\r\n  ```java\r\n  // é»˜è®¤ falseï¼Œä¸ç§»é™¤ï¼Œç­‰åˆ°çº¿ç¨‹æ‹¿åˆ°ä»»åŠ¡ä¹‹åæŠ›å¼ƒ\r\n  private volatile boolean removeOnCancel = false;\r\n  ```\r\n\r\n- ä»»åŠ¡çš„åºåˆ—å·ï¼Œå¯ä»¥ç”¨æ¥æ¯”è¾ƒä¼˜å…ˆçº§ï¼š\r\n\r\n  ```java\r\n  private static final AtomicLong sequencer = new AtomicLong();\r\n  ```\r\n\r\n  \r\n\r\n***\r\n\r\n\r\n\r\n##### å»¶è¿Ÿä»»åŠ¡\r\n\r\nScheduledFutureTask ç»§æ‰¿ FutureTaskï¼Œå®ç° RunnableScheduledFuture æ¥å£ï¼Œå…·æœ‰å»¶è¿Ÿæ‰§è¡Œçš„ç‰¹ç‚¹ï¼Œè¦†ç›– FutureTask çš„ run æ–¹æ³•æ¥å®ç°å¯¹**å»¶æ—¶æ‰§è¡Œã€å‘¨æœŸæ‰§è¡Œ**çš„æ”¯æŒã€‚å¯¹äºå»¶æ—¶ä»»åŠ¡è°ƒç”¨ `FutureTask#run`ï¼Œè€Œå¯¹äºå‘¨æœŸæ€§ä»»åŠ¡åˆ™è°ƒç”¨ `FutureTask#runAndReset` å¹¶ä¸”åœ¨æˆåŠŸä¹‹åæ ¹æ® `fixed-delay/fixed-rate` æ¨¡å¼æ¥è®¾ç½®ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´å¹¶é‡æ–°å°†ä»»åŠ¡å¡åˆ°å·¥ä½œé˜Ÿåˆ—\r\n\r\nåœ¨è°ƒåº¦çº¿ç¨‹æ± ä¸­æ— è®ºæ˜¯ runnable è¿˜æ˜¯ callableï¼Œæ— è®ºæ˜¯å¦éœ€è¦å»¶è¿Ÿå’Œå®šæ—¶ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¼šè¢«å°è£…æˆ ScheduledFutureTask\r\n\r\næˆå‘˜å˜é‡ï¼š\r\n\r\n- ä»»åŠ¡åºåˆ—å·ï¼š\r\n\r\n  ```java\r\n  private final long sequenceNumber;\r\n  ```\r\n\r\n- æ‰§è¡Œæ—¶é—´ï¼š\r\n\r\n  ```java\r\n  private long time;\t\t\t// ä»»åŠ¡å¯ä»¥è¢«æ‰§è¡Œçš„æ—¶é—´ï¼Œäº¤ä»˜æ—¶é—´ï¼Œä»¥çº³ç§’è¡¨ç¤º\r\n  private final long period;\t// 0 è¡¨ç¤ºéå‘¨æœŸä»»åŠ¡ï¼Œæ­£æ•°è¡¨ç¤º fixed-rate æ¨¡å¼çš„å‘¨æœŸï¼Œè´Ÿæ•°è¡¨ç¤º fixed-delay æ¨¡å¼\r\n  ```\r\n\r\n  `fixed-rate`ï¼šä¸¤æ¬¡å¼€å§‹å¯åŠ¨çš„é—´éš”ï¼Œ`fixed-delay`ï¼šä¸€æ¬¡æ‰§è¡Œç»“æŸåˆ°ä¸‹ä¸€æ¬¡å¼€å§‹å¯åŠ¨\r\n\r\n- å®é™…çš„ä»»åŠ¡å¯¹è±¡ï¼š\r\n\r\n  ```java\r\n  RunnableScheduledFuture<V> outerTask = this;\r\n  ```\r\n\r\n- ä»»åŠ¡åœ¨é˜Ÿåˆ—æ•°ç»„ä¸­çš„ç´¢å¼•ä¸‹æ ‡ï¼š\r\n\r\n  ```java\r\n  // DelayedWorkQueue åº•å±‚ä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯æœ€å°å †ï¼Œè®°å½•å½“å‰ä»»åŠ¡åœ¨å †ä¸­çš„ç´¢å¼•ï¼Œ-1 ä»£è¡¨åˆ é™¤\r\n  int heapIndex;\r\n  ```\r\n\r\næˆå‘˜æ–¹æ³•ï¼š\r\n\r\n- æ„é€ æ–¹æ³•ï¼š\r\n\r\n  ```java\r\n  ScheduledFutureTask(Runnable r, V result, long ns, long period) {\r\n      super(r, result);\r\n      // ä»»åŠ¡çš„è§¦å‘æ—¶é—´\r\n      this.time = ns;\r\n      // ä»»åŠ¡çš„å‘¨æœŸï¼Œå¤šé•¿æ—¶é—´æ‰§è¡Œä¸€æ¬¡\r\n      this.period = period;\r\n      // ä»»åŠ¡çš„åºå·\r\n      this.sequenceNumber = sequencer.getAndIncrement();\r\n  }\r\n  ```\r\n\r\n- `compareTo()`ï¼šScheduledFutureTask æ ¹æ®æ‰§è¡Œæ—¶é—´ time æ­£åºæ’åˆ—ï¼Œå¦‚æœæ‰§è¡Œæ—¶é—´ç›¸åŒï¼Œåœ¨æŒ‰ç…§åºåˆ—å· sequenceNumber æ­£åºæ’åˆ—ï¼Œä»»åŠ¡éœ€è¦æ”¾å…¥ DelayedWorkQueueï¼Œå»¶è¿Ÿé˜Ÿåˆ—ä¸­ä½¿ç”¨è¯¥æ–¹æ³•æŒ‰ç…§ä»å°åˆ°å¤§è¿›è¡Œæ’åº\r\n\r\n  ```java\r\n  public int compareTo(Delayed other) {\r\n      if (other == this) // compare zero if same object\r\n          return 0;\r\n      if (other instanceof ScheduledFutureTask) {\r\n          // ç±»å‹å¼ºè½¬\r\n          ScheduledFutureTask<?> x = (ScheduledFutureTask<?>)other;\r\n          // æ¯”è¾ƒè€… - è¢«æ¯”è¾ƒè€…çš„æ‰§è¡Œæ—¶é—´\r\n          long diff = time - x.time;\r\n          // æ¯”è¾ƒè€…å…ˆæ‰§è¡Œ\r\n          if (diff < 0)\r\n              return -1;\r\n          // è¢«æ¯”è¾ƒè€…å…ˆæ‰§è¡Œ\r\n          else if (diff > 0)\r\n              return 1;\r\n          // æ¯”è¾ƒè€…çš„åºåˆ—å·å°\r\n          else if (sequenceNumber < x.sequenceNumber)\r\n              return -1;\r\n          else\r\n              return 1;\r\n      }\r\n      // ä¸æ˜¯ ScheduledFutureTask ç±»å‹æ—¶ï¼Œæ ¹æ®å»¶è¿Ÿæ—¶é—´æ’åº\r\n      long diff = getDelay(NANOSECONDS) - other.getDelay(NANOSECONDS);\r\n      return (diff < 0) ? -1 : (diff > 0) ? 1 : 0;\r\n  }\r\n  ```\r\n\r\n- `run()`ï¼šæ‰§è¡Œä»»åŠ¡ï¼Œéå‘¨æœŸä»»åŠ¡ç›´æ¥å®Œæˆç›´æ¥ç»“æŸï¼Œ**å‘¨æœŸä»»åŠ¡æ‰§è¡Œå®Œåä¼šè®¾ç½®ä¸‹ä¸€æ¬¡çš„æ‰§è¡Œæ—¶é—´ï¼Œé‡æ–°æ”¾å…¥çº¿ç¨‹æ± çš„é˜»å¡é˜Ÿåˆ—**ï¼Œå¦‚æœçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å°‘äºæ ¸å¿ƒçº¿ç¨‹ï¼Œå°±ä¼šæ·»åŠ  Worker å¼€å¯æ–°çº¿ç¨‹\r\n\r\n  ```java\r\n  public void run() {\r\n      // æ˜¯å¦å‘¨æœŸæ€§ï¼Œå°±æ˜¯åˆ¤æ–­ period æ˜¯å¦ä¸º 0\r\n      boolean periodic = isPeriodic();\r\n      // æ ¹æ®æ˜¯å¦æ˜¯å‘¨æœŸä»»åŠ¡æ£€æŸ¥å½“å‰çŠ¶æ€èƒ½å¦æ‰§è¡Œä»»åŠ¡ï¼Œä¸èƒ½æ‰§è¡Œå°±å–æ¶ˆä»»åŠ¡\r\n      if (!canRunInCurrentRunState(periodic))\r\n          cancel(false);\r\n      // éå‘¨æœŸä»»åŠ¡ï¼Œç›´æ¥è°ƒç”¨ FutureTask#run æ‰§è¡Œ\r\n      else if (!periodic)\r\n          ScheduledFutureTask.super.run();\r\n      // å‘¨æœŸä»»åŠ¡çš„æ‰§è¡Œï¼Œè¿”å› true è¡¨ç¤ºæ‰§è¡ŒæˆåŠŸ\r\n      else if (ScheduledFutureTask.super.runAndReset()) {\r\n          // è®¾ç½®å‘¨æœŸä»»åŠ¡çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´\r\n          setNextRunTime();\r\n          // ä»»åŠ¡çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œå®‰æ’ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ± çŠ¶æ€å¯ä»¥æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼ŒåŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶å¼€å¯æ–°çº¿ç¨‹\r\n          reExecutePeriodic(outerTask);\r\n      }\r\n  }\r\n  ```\r\n\r\n  å‘¨æœŸä»»åŠ¡æ­£å¸¸å®Œæˆå**ä»»åŠ¡çš„çŠ¶æ€ä¸ä¼šå˜åŒ–**ï¼Œä¾æ—§æ˜¯ NEWï¼Œä¸ä¼šè®¾ç½® outcome å±æ€§ã€‚ä½†æ˜¯å¦‚æœæœ¬æ¬¡ä»»åŠ¡æ‰§è¡Œå‡ºç°å¼‚å¸¸ï¼Œä¼šè¿›å…¥ setException æ–¹æ³•å°†ä»»åŠ¡çŠ¶æ€ç½®ä¸ºå¼‚å¸¸ï¼ŒæŠŠå¼‚å¸¸ä¿å­˜åœ¨ outcome ä¸­ï¼Œæ–¹æ³•è¿”å› falseï¼Œåç»­çš„è¯¥ä»»åŠ¡å°†ä¸ä¼šå†å‘¨æœŸçš„æ‰§è¡Œ\r\n\r\n  ```java\r\n  protected boolean runAndReset() {\r\n      // ä»»åŠ¡ä¸æ˜¯æ–°å»ºçš„çŠ¶æ€äº†ï¼Œæˆ–è€…è¢«åˆ«çš„çº¿ç¨‹æ‰§è¡Œäº†ï¼Œç›´æ¥è¿”å› false\r\n      if (state != NEW ||\r\n          !UNSAFE.compareAndSwapObject(this, runnerOffset, null, Thread.currentThread()))\r\n          return false;\r\n      boolean ran = false;\r\n      int s = state;\r\n      try {\r\n          Callable<V> c = callable;\r\n          if (c != null && s == NEW) {\r\n              try {\r\n                  // æ‰§è¡Œæ–¹æ³•ï¼Œæ²¡æœ‰è¿”å›å€¼\r\n                  c.call();\r\n                  ran = true;\r\n              } catch (Throwable ex) {\r\n                  // å‡ºç°å¼‚å¸¸ï¼ŒæŠŠä»»åŠ¡è®¾ç½®ä¸ºå¼‚å¸¸çŠ¶æ€ï¼Œå”¤é†’æ‰€æœ‰çš„ get é˜»å¡çº¿ç¨‹\r\n                  setException(ex);\r\n              }\r\n          }\r\n      } finally {\r\n  \t\t// æ‰§è¡Œå®ŒæˆæŠŠæ‰§è¡Œçº¿ç¨‹å¼•ç”¨ç½®ä¸º null\r\n          runner = null;\r\n          s = state;\r\n          // å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­è¿›è¡Œä¸­æ–­å¤„ç†\r\n          if (s >= INTERRUPTING)\r\n              handlePossibleCancellationInterrupt(s);\r\n      }\r\n      // å¦‚æœæ­£å¸¸æ‰§è¡Œï¼Œè¿”å› trueï¼Œå¹¶ä¸”ä»»åŠ¡çŠ¶æ€æ²¡æœ‰è¢«å–æ¶ˆ\r\n      return ran && s == NEW;\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // ä»»åŠ¡ä¸‹ä¸€æ¬¡çš„è§¦å‘æ—¶é—´\r\n  private void setNextRunTime() {\r\n      long p = period;\r\n      if (p > 0)\r\n          // fixed-rate æ¨¡å¼ï¼Œã€æ—¶é—´è®¾ç½®ä¸ºä¸Šä¸€æ¬¡æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ + pã€‘ï¼Œä¸¤æ¬¡ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´å·®\r\n          time += p;\r\n      else\r\n          // fixed-delay æ¨¡å¼ï¼Œä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´æ˜¯ã€å½“å‰è¿™æ¬¡ä»»åŠ¡ç»“æŸçš„æ—¶é—´ï¼ˆå°±æ˜¯ç°åœ¨ï¼‰ + delay å€¼ã€‘\r\n          time = triggerTime(-p);\r\n  }\r\n  ```\r\n\r\n- `reExecutePeriodic()`**ï¼šå‡†å¤‡ä»»åŠ¡çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œï¼Œé‡æ–°æ”¾å…¥é˜»å¡ä»»åŠ¡é˜Ÿåˆ—**\r\n\r\n  ```java\r\n  // ScheduledThreadPoolExecutor#reExecutePeriodic\r\n  void reExecutePeriodic(RunnableScheduledFuture<?> task) {\r\n      if (canRunInCurrentRunState(true)) {\r\n          // ã€æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‘\r\n          super.getQueue().add(task);\r\n          // å¦‚æœæäº¤å®Œä»»åŠ¡ä¹‹åï¼Œçº¿ç¨‹æ± çŠ¶æ€å˜ä¸ºäº† shutdown çŠ¶æ€ï¼Œéœ€è¦å†æ¬¡æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œï¼Œ\r\n          // å¦‚æœä¸èƒ½æ‰§è¡Œä¸”ä»»åŠ¡è¿˜åœ¨é˜Ÿåˆ—ä¸­æœªè¢«å–èµ°ï¼Œåˆ™å–æ¶ˆä»»åŠ¡\r\n          if (!canRunInCurrentRunState(true) && remove(task))\r\n              task.cancel(false);\r\n          else\r\n              // å½“å‰çº¿ç¨‹æ± çŠ¶æ€å¯ä»¥æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼ŒåŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶ã€æ ¹æ®çº¿ç¨‹æ•°é‡æ˜¯å¦å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ç¡®å®šæ˜¯å¦å¼€å¯æ–°çº¿ç¨‹ã€‘\r\n              ensurePrestart();\r\n      }\r\n  }\r\n  ```\r\n\r\n- `cancel()`ï¼šå–æ¶ˆä»»åŠ¡\r\n\r\n  ```java\r\n  public boolean cancel(boolean mayInterruptIfRunning) {\r\n      // è°ƒç”¨çˆ¶ç±» FutureTask#cancel æ¥å–æ¶ˆä»»åŠ¡\r\n      boolean cancelled = super.cancel(mayInterruptIfRunning);\r\n      // removeOnCancel ç”¨äºæ§åˆ¶ä»»åŠ¡å–æ¶ˆåæ˜¯å¦åº”è¯¥ä»é˜»å¡é˜Ÿåˆ—ä¸­ç§»é™¤\r\n      if (cancelled && removeOnCancel && heapIndex >= 0)\r\n          // ä»ç­‰å¾…é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥ä»»åŠ¡ï¼Œå¹¶è°ƒç”¨ tryTerminate() åˆ¤æ–­æ˜¯å¦éœ€è¦åœæ­¢çº¿ç¨‹æ± \r\n          remove(this);\r\n      return cancelled;\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å»¶è¿Ÿé˜Ÿåˆ—\r\n\r\nDelayedWorkQueue æ˜¯æ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œå†…éƒ¨é‡‡ç”¨ä¼˜å…ˆé˜Ÿåˆ— PriorityQueueï¼ˆå°æ ¹å †ã€æ»¡äºŒå‰æ ‘ï¼‰å­˜å‚¨å…ƒç´ \r\n\r\nå…¶ä»–é˜»å¡é˜Ÿåˆ—å­˜å‚¨èŠ‚ç‚¹çš„æ•°æ®ç»“æ„å¤§éƒ½æ˜¯é“¾è¡¨ï¼Œ**å»¶è¿Ÿé˜Ÿåˆ—æ˜¯æ•°ç»„**ï¼Œæ‰€ä»¥å»¶è¿Ÿé˜Ÿåˆ—å‡ºé˜Ÿå¤´å…ƒç´ åéœ€è¦**è®©å…¶ä»–å…ƒç´ ï¼ˆå°¾ï¼‰æ›¿æ¢åˆ°å¤´èŠ‚ç‚¹**ï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸\r\n\r\næˆå‘˜å˜é‡ï¼š\r\n\r\n- å®¹é‡ï¼š\r\n\r\n  ```java\r\n  private static final int INITIAL_CAPACITY = 16;\t\t\t// åˆå§‹å®¹é‡\r\n  private int size = 0;\t\t\t\t\t\t\t\t\t// èŠ‚ç‚¹æ•°é‡\r\n  private RunnableScheduledFuture<?>[] queue = \r\n      new RunnableScheduledFuture<?>[INITIAL_CAPACITY];\t// å­˜æ”¾èŠ‚ç‚¹\r\n  ```\r\n\r\n- é”ï¼š\r\n\r\n  ```java\r\n  private final ReentrantLock lock = new ReentrantLock();\t// æ§åˆ¶å¹¶å‘\r\n  private final Condition available = lock.newCondition();// æ¡ä»¶é˜Ÿåˆ—\r\n  ```\r\n\r\n- é˜»å¡ç­‰å¾…å¤´èŠ‚ç‚¹çš„çº¿ç¨‹ï¼šçº¿ç¨‹æ± å†…çš„æŸä¸ªçº¿ç¨‹å» take() è·å–ä»»åŠ¡æ—¶ï¼Œå¦‚æœå»¶è¿Ÿé˜Ÿåˆ—é¡¶å±‚èŠ‚ç‚¹ä¸ä¸º nullï¼ˆé˜Ÿåˆ—å†…æœ‰ä»»åŠ¡ï¼‰ï¼Œä½†æ˜¯èŠ‚ç‚¹ä»»åŠ¡è¿˜ä¸åˆ°è§¦å‘æ—¶é—´ï¼Œçº¿ç¨‹å°±å»æ£€æŸ¥**é˜Ÿåˆ—çš„ leaderå­—æ®µ**æ˜¯å¦è¢«å ç”¨\r\n\r\n  - å¦‚æœæœªè¢«å ç”¨ï¼Œåˆ™å½“å‰çº¿ç¨‹å ç”¨è¯¥å­—æ®µï¼Œç„¶åå½“å‰çº¿ç¨‹åˆ° available æ¡ä»¶é˜Ÿåˆ—æŒ‡å®šè¶…æ—¶æ—¶é—´ `å †é¡¶ä»»åŠ¡.time - now()` æŒ‚èµ·\r\n  - å¦‚æœè¢«å ç”¨ï¼Œå½“å‰çº¿ç¨‹ç›´æ¥åˆ° available æ¡ä»¶é˜Ÿåˆ—ä¸æŒ‡å®šè¶…æ—¶æ—¶é—´çš„æŒ‚èµ·\r\n\r\n  ```java\r\n  // leader åœ¨ available æ¡ä»¶é˜Ÿåˆ—å†…æ˜¯é¦–å…ƒç´ ï¼Œå®ƒè¶…æ—¶ä¹‹åä¼šé†’è¿‡æ¥ï¼Œç„¶åå†æ¬¡å°†å †é¡¶å…ƒç´ è·å–èµ°ï¼Œè·å–èµ°ä¹‹åï¼Œtake()ç»“æŸä¹‹å‰ï¼Œä¼šè°ƒç”¨æ˜¯ available.signal() å”¤é†’ä¸‹ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—å†…çš„ç­‰å¾…è€…ï¼Œç„¶åé‡Šæ”¾ lockï¼Œä¸‹ä¸€ä¸ªç­‰å¾…è€…è¢«å”¤é†’åå»åˆ° AQS é˜Ÿåˆ—ï¼Œåš acquireQueue(node) é€»è¾‘\r\n  private Thread leader = null;\r\n  ```\r\n\r\næˆå‘˜æ–¹æ³•\r\n\r\n- `offer()`ï¼šæ’å…¥èŠ‚ç‚¹\r\n\r\n  ```java\r\n  public boolean offer(Runnable x) {\r\n      // åˆ¤ç©º\r\n      if (x == null)\r\n          throw new NullPointerException();\r\n      RunnableScheduledFuture<?> e = (RunnableScheduledFuture<?>)x;\r\n      // é˜Ÿåˆ—é”ï¼Œå¢åŠ åˆ é™¤æ•°æ®æ—¶éƒ½è¦åŠ é”\r\n      final ReentrantLock lock = this.lock;\r\n      lock.lock();\r\n      try {\r\n          int i = size;\r\n          // é˜Ÿåˆ—æ•°é‡å¤§äºå­˜æ”¾èŠ‚ç‚¹çš„æ•°ç»„é•¿åº¦ï¼Œéœ€è¦æ‰©å®¹\r\n          if (i >= queue.length)\r\n              // æ‰©å®¹ä¸ºåŸæ¥é•¿åº¦çš„ 1.5 å€\r\n              grow();\r\n          size = i + 1;\r\n          // å½“å‰æ˜¯ç¬¬ä¸€ä¸ªè¦æ’å…¥çš„èŠ‚ç‚¹\r\n          if (i == 0) {\r\n              queue[0] = e;\r\n              // ä¿®æ”¹ ScheduledFutureTask çš„ heapIndex å±æ€§ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡åœ¨é˜Ÿåˆ—é‡Œçš„ä¸‹æ ‡\r\n              setIndex(e, 0);\r\n          } else {\r\n              // å‘ä¸Šè°ƒæ•´å…ƒç´ çš„ä½ç½®ï¼Œå¹¶æ›´æ–° heapIndex \r\n              siftUp(i, e);\r\n          }\r\n          // æƒ…å†µ1ï¼šå½“å‰ä»»åŠ¡æ˜¯ç¬¬ä¸€ä¸ªåŠ å…¥åˆ° queue å†…çš„ä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨å½“å‰ä»»åŠ¡åŠ å…¥åˆ° queue ä¹‹å‰ï¼Œtake() çº¿ç¨‹ä¼šç›´æ¥\r\n          //\t\tåˆ° available é˜Ÿåˆ—ä¸è®¾ç½®è¶…æ—¶çš„æŒ‚èµ·ï¼Œå¹¶ä¸ä¼šå»å ç”¨ leader å­—æ®µï¼Œè¿™æ—¶éœ€ä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ è®©å®ƒå»æ¶ˆè´¹\r\n         \t// æƒ…å†µ2ï¼šå½“å‰ä»»åŠ¡ã€ä¼˜å…ˆçº§æœ€é«˜ã€‘ï¼ŒåŸå †é¡¶ä»»åŠ¡å¯èƒ½è¿˜æœªåˆ°è§¦å‘æ—¶é—´ï¼Œleader çº¿ç¨‹è®¾ç½®è¶…æ—¶çš„åœ¨ available æŒ‚èµ·\r\n          //\t\tåŸå…ˆçš„ leader ç­‰å¾…çš„æ˜¯åŸå…ˆçš„å¤´èŠ‚ç‚¹ï¼Œæ‰€ä»¥ leader å·²ç»æ— æ•ˆï¼Œéœ€è¦å°† leader çº¿ç¨‹å”¤é†’ï¼Œ\r\n          //\t\tå”¤é†’ä¹‹åå®ƒä¼šæ£€æŸ¥å †é¡¶ï¼Œå¦‚æœå †é¡¶ä»»åŠ¡å¯ä»¥è¢«æ¶ˆè´¹ï¼Œåˆ™ç›´æ¥è·å–èµ°ï¼Œå¦åˆ™ç»§ç»­æˆä¸º leader ç­‰å¾…æ–°å †é¡¶ä»»åŠ¡\r\n          if (queue[0] == e) {\r\n              // å°† leader è®¾ç½®ä¸º null\r\n              leader = null;\r\n              // ç›´æ¥éšä¾¿å”¤é†’ç­‰å¾…å¤´ç»“ç‚¹çš„é˜»å¡çº¿ç¨‹\r\n              available.signal();\r\n          }\r\n      } finally {\r\n          lock.unlock();\r\n      }\r\n      return true;\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // æ’å…¥æ–°èŠ‚ç‚¹åå¯¹å †è¿›è¡Œè°ƒæ•´ï¼Œè¿›è¡ŒèŠ‚ç‚¹ä¸Šç§»ï¼Œä¿æŒå…¶ç‰¹æ€§ã€èŠ‚ç‚¹çš„å€¼å°äºå­èŠ‚ç‚¹çš„å€¼ã€‘ï¼Œå°é¡¶å †\r\n  private void siftUp(int k, RunnableScheduledFuture<?> key) {\r\n      while (k > 0) {\r\n          // çˆ¶èŠ‚ç‚¹ï¼Œå°±æ˜¯å †æ’åº\r\n          int parent = (k - 1) >>> 1;\r\n          RunnableScheduledFuture<?> e = queue[parent];\r\n          // key å’Œçˆ¶èŠ‚ç‚¹æ¯”ï¼Œå¦‚æœå¤§äºçˆ¶èŠ‚ç‚¹å¯ä»¥ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±ç»§ç»­ä¸Šæµ®\r\n          if (key.compareTo(e) >= 0)\r\n              break;\r\n          queue[k] = e;\r\n          setIndex(e, k);\r\n          k = parent;\r\n      }\r\n      queue[k] = key;\r\n      setIndex(key, k);\r\n  }\r\n  ```\r\n\r\n- `poll()`ï¼šéé˜»å¡è·å–å¤´ç»“ç‚¹ï¼Œ**è·å–æ‰§è¡Œæ—¶é—´æœ€è¿‘å¹¶ä¸”å¯ä»¥æ‰§è¡Œçš„**\r\n\r\n  ```java\r\n  // éé˜»å¡è·å–\r\n  public RunnableScheduledFuture<?> poll() {\r\n      final ReentrantLock lock = this.lock;\r\n      lock.lock();\r\n      try {\r\n          // è·å–é˜Ÿå¤´èŠ‚ç‚¹ï¼Œå› ä¸ºæ˜¯å°é¡¶å †\r\n          RunnableScheduledFuture<?> first = queue[0];\r\n          // å¤´ç»“ç‚¹ä¸ºç©ºæˆ–è€…çš„å»¶è¿Ÿæ—¶é—´æ²¡åˆ°è¿”å› null\r\n          if (first == null || first.getDelay(NANOSECONDS) > 0)\r\n              return null;\r\n          else\r\n              // å¤´ç»“ç‚¹è¾¾åˆ°å»¶è¿Ÿæ—¶é—´ï¼Œã€å°¾èŠ‚ç‚¹æˆä¸ºæ›¿ä»£èŠ‚ç‚¹ä¸‹ç§»è°ƒæ•´å †ç»“æ„ã€‘ï¼Œè¿”å›å¤´ç»“ç‚¹\r\n              return finishPoll(first);\r\n      } finally {\r\n          lock.unlock();\r\n      }\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  private RunnableScheduledFuture<?> finishPoll(RunnableScheduledFuture<?> f) {\r\n      // è·å–å°¾ç´¢å¼•\r\n      int s = --size;\r\n      // è·å–å°¾èŠ‚ç‚¹\r\n      RunnableScheduledFuture<?> x = queue[s];\r\n      // å°†å †ç»“æ„æœ€åä¸€ä¸ªèŠ‚ç‚¹å ç”¨çš„ slot è®¾ç½®ä¸º nullï¼Œå› ä¸ºè¯¥èŠ‚ç‚¹è¦å°è¯•å‡çº§æˆå †é¡¶ï¼Œä¼šæ ¹æ®ç‰¹æ€§ä¸‹è°ƒ\r\n      queue[s] = null;\r\n      // s == 0 è¯´æ˜ å½“å‰å †ç»“æ„åªæœ‰å †é¡¶ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ­¤æ—¶ä¸éœ€è¦åšä»»ä½•çš„äº‹æƒ…\r\n      if (s != 0)\r\n          // ä»ç´¢å¼•å¤„ 0 å¼€å§‹å‘ä¸‹è°ƒæ•´\r\n          siftDown(0, x);\r\n      // å‡ºé˜Ÿçš„å…ƒç´ ç´¢å¼•è®¾ç½®ä¸º -1\r\n      setIndex(f, -1);\r\n      return f;\r\n  }\r\n  ```\r\n\r\n- `take()`ï¼šé˜»å¡è·å–å¤´èŠ‚ç‚¹ï¼Œè¯»å–å½“å‰å †ä¸­æœ€å°çš„ä¹Ÿå°±æ˜¯è§¦å‘æ—¶é—´æœ€è¿‘çš„ä»»åŠ¡\r\n\r\n  ```java\r\n  public RunnableScheduledFuture<?> take() throws InterruptedException {\r\n      final ReentrantLock lock = this.lock;\r\n      // ä¿è¯çº¿ç¨‹å®‰å…¨\r\n      lock.lockInterruptibly();\r\n      try {\r\n          for (;;) {\r\n              // å¤´èŠ‚ç‚¹\r\n              RunnableScheduledFuture<?> first = queue[0];\r\n              if (first == null)\r\n                  // ç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œç›´è‡³æœ‰ä»»åŠ¡é€šè¿‡ offer å…¥é˜Ÿå¹¶å”¤é†’\r\n                  available.await();\r\n              else {\r\n                  // è·å–å¤´èŠ‚ç‚¹çš„å»¶è¿Ÿæ—¶é—´æ˜¯å¦åˆ°æ—¶\r\n                  long delay = first.getDelay(NANOSECONDS);\r\n                  if (delay <= 0)\r\n                      // åˆ°è¾¾è§¦å‘æ—¶é—´ï¼Œè·å–å¤´èŠ‚ç‚¹å¹¶è°ƒæ•´å †ï¼Œé‡æ–°é€‰æ‹©å»¶è¿Ÿæ—¶é—´æœ€å°çš„èŠ‚ç‚¹æ”¾å…¥å¤´éƒ¨\r\n                      return finishPoll(first);\r\n                  \r\n                  // é€»è¾‘åˆ°è¿™è¯´æ˜å¤´èŠ‚ç‚¹çš„å»¶è¿Ÿæ—¶é—´è¿˜æ²¡åˆ°\r\n                  first = null;\r\n                  // è¯´æ˜æœ‰ leader çº¿ç¨‹åœ¨ç­‰å¾…è·å–å¤´èŠ‚ç‚¹ï¼Œå½“å‰çº¿ç¨‹ç›´æ¥å»é˜»å¡ç­‰å¾…\r\n                  if (leader != null)\r\n                      available.await();\r\n                  else {\r\n                      // æ²¡æœ‰ leader çº¿ç¨‹ï¼Œã€å½“å‰çº¿ç¨‹ä½œä¸ºleaderçº¿ç¨‹ï¼Œå¹¶è®¾ç½®å¤´ç»“ç‚¹çš„å»¶è¿Ÿæ—¶é—´ä½œä¸ºé˜»å¡æ—¶é—´ã€‘\r\n                      Thread thisThread = Thread.currentThread();\r\n                      leader = thisThread;\r\n                      try {\r\n                          // åœ¨æ¡ä»¶é˜Ÿåˆ— available ä½¿ç”¨å¸¦è¶…æ—¶çš„æŒ‚èµ·ï¼ˆå †é¡¶ä»»åŠ¡.time - now() çº³ç§’å€¼..ï¼‰\r\n                          available.awaitNanos(delay);\r\n                          // åˆ°è¾¾é˜»å¡æ—¶é—´æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šä»è¿™é‡Œé†’æ¥æ¥\r\n                      } finally {\r\n                          // tå †é¡¶æ›´æ–°ï¼Œleader ç½®ä¸º nullï¼Œoffer æ–¹æ³•é‡Šæ”¾é”åï¼Œ\r\n                          // æœ‰å…¶å®ƒçº¿ç¨‹é€šè¿‡ take/poll æ‹¿åˆ°é”,è¯»åˆ° leader == nullï¼Œç„¶åå°†è‡ªèº«æ›´æ–°ä¸ºleaderã€‚\r\n                          if (leader == thisThread)\r\n                              // leader ç½®ä¸º null ç”¨ä»¥æ¥ä¸‹æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å”¤é†’åç»§çº¿ç¨‹\r\n                              leader = null;\r\n                      }\r\n                  }\r\n              }\r\n          }\r\n      } finally {\r\n          // æ²¡æœ‰ leader çº¿ç¨‹ï¼Œå¤´ç»“ç‚¹ä¸ä¸º nullï¼Œå”¤é†’é˜»å¡è·å–å¤´èŠ‚ç‚¹çš„çº¿ç¨‹ï¼Œ\r\n          // ã€å¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥ï¼Œå°±ä¼šå‡ºç°æœ‰äº†éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä½†æ˜¯æ²¡æœ‰çº¿ç¨‹å»æ‰§è¡Œã€‘\r\n          if (leader == null && queue[0] != null)\r\n              available.signal();\r\n          lock.unlock();\r\n      }\r\n  }\r\n  ```\r\n\r\n- `remove()`ï¼šåˆ é™¤èŠ‚ç‚¹ï¼Œå †ç§»é™¤ä¸€ä¸ªå…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯ `O(log n)`ï¼Œ**å»¶è¿Ÿä»»åŠ¡ç»´æŠ¤äº† heapIndex**ï¼Œç›´æ¥è®¿é—®çš„æ—¶é—´å¤æ‚åº¦æ˜¯ `O(1)`ï¼Œä»è€Œå¯ä»¥æ›´å¿«çš„ç§»é™¤å…ƒç´ ï¼Œä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­è¢«å–æ¶ˆåä¼šè¿›å…¥è¯¥é€»è¾‘\r\n\r\n  ```java\r\n  public boolean remove(Object x) {\r\n      final ReentrantLock lock = this.lock;\r\n      lock.lock();\r\n      try {\r\n          // æŸ¥æ‰¾å¯¹è±¡åœ¨é˜Ÿåˆ—æ•°ç»„ä¸­çš„ä¸‹æ ‡\r\n          int i = indexOf(x);\r\n          // èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œè¿”å› false\r\n          if (i < 0)\r\n              return false;\r\n  \t\t// ä¿®æ”¹å…ƒç´ çš„ heapIndexï¼Œ-1 ä»£è¡¨åˆ é™¤\r\n          setIndex(queue[i], -1);\r\n          // å°¾ç´¢å¼•æ˜¯é•¿åº¦-1\r\n          int s = --size;\r\n          // å°¾èŠ‚ç‚¹ä½œä¸ºæ›¿ä»£èŠ‚ç‚¹\r\n          RunnableScheduledFuture<?> replacement = queue[s];\r\n          queue[s] = null;\r\n          // s == i è¯´æ˜å¤´èŠ‚ç‚¹å°±æ˜¯å°¾èŠ‚ç‚¹ï¼Œé˜Ÿåˆ—ç©ºäº†\r\n          if (s != i) {\r\n              // å‘ä¸‹è°ƒæ•´\r\n              siftDown(i, replacement);\r\n              // è¯´æ˜æ²¡å‘ç”Ÿè°ƒæ•´\r\n              if (queue[i] == replacement)\r\n                  // ä¸Šç§»å’Œä¸‹ç§»ä¸å¯èƒ½åŒæ—¶å‘ç”Ÿï¼Œæ›¿ä»£èŠ‚ç‚¹å¤§äºå­èŠ‚ç‚¹æ—¶ä¸‹ç§»ï¼Œå¦åˆ™ä¸Šç§»\r\n                  siftUp(i, replacement);\r\n          }\r\n          return true;\r\n      } finally {\r\n          lock.unlock();\r\n      }\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n****\r\n\r\n\r\n\r\n#### æˆå‘˜æ–¹æ³•\r\n\r\n##### æäº¤ä»»åŠ¡\r\n\r\n- `schedule()`ï¼šå»¶è¿Ÿæ‰§è¡Œæ–¹æ³•ï¼Œå¹¶æŒ‡å®šæ‰§è¡Œçš„æ—¶é—´ï¼Œé»˜è®¤æ˜¯å½“å‰æ—¶é—´\r\n\r\n  ```java\r\n  public void execute(Runnable command) {\r\n      // ä»¥é›¶å»¶æ—¶ä»»åŠ¡çš„å½¢å¼å®ç°\r\n      schedule(command, 0, NANOSECONDS);\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  public ScheduledFuture<?> schedule(Runnable command, long delay, TimeUnit unit) {\r\n      // åˆ¤ç©º\r\n      if (command == null || unit == null) throw new NullPointerException();\r\n      // æ²¡æœ‰åšä»»ä½•æ“ä½œï¼Œç›´æ¥å°† task è¿”å›ï¼Œè¯¥æ–¹æ³•ä¸»è¦ç›®çš„æ˜¯ç”¨äºå­ç±»æ‰©å±•ï¼Œå¹¶ä¸”ã€æ ¹æ®å»¶è¿Ÿæ—¶é—´è®¾ç½®ä»»åŠ¡è§¦å‘çš„æ—¶é—´ç‚¹ã€‘\r\n      RunnableScheduledFuture<?> t = decorateTask(command, new ScheduledFutureTask<Void>(\r\n          \t\t\t\t\t\t\t\t\t\t\tcommand, null, triggerTime(delay, unit)));\r\n      // å»¶è¿Ÿæ‰§è¡Œ\r\n      delayedExecute(t);\r\n      return t;\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  // è¿”å›ã€å½“å‰æ—¶é—´ + å»¶è¿Ÿæ—¶é—´ã€‘ï¼Œå°±æ˜¯è§¦å‘å½“å‰ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´\r\n  private long triggerTime(long delay, TimeUnit unit) {\r\n      // è®¾ç½®è§¦å‘çš„æ—¶é—´\r\n      return triggerTime(unit.toNanos((delay < 0) ? 0 : delay));\r\n  }\r\n  long triggerTime(long delay) {\r\n      // å¦‚æœ delay < Long.Max_VALUE/2ï¼Œåˆ™ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ä¸ºå½“å‰æ—¶é—´ +delay\r\n      // å¦åˆ™ä¸ºäº†é¿å…é˜Ÿåˆ—ä¸­å‡ºç°ç”±äºæº¢å‡ºå¯¼è‡´çš„æ’åºç´Šä¹±,éœ€è¦è°ƒç”¨overflowFreeæ¥ä¿®æ­£ä¸€ä¸‹delay\r\n      return now() + ((delay < (Long.MAX_VALUE >> 1)) ? delay : overflowFree(delay));\r\n  }\r\n  ```\r\n\r\n  overflowFree çš„åŸå› ï¼šå¦‚æœæŸä¸ªä»»åŠ¡çš„ delay ä¸ºè´Ÿæ•°ï¼Œè¯´æ˜å½“å‰å¯ä»¥æ‰§è¡Œï¼ˆå…¶å®æ—©è¯¥æ‰§è¡Œäº†ï¼‰ã€‚é˜»å¡é˜Ÿåˆ—ä¸­ç»´æŠ¤ä»»åŠ¡é¡ºåºæ˜¯åŸºäº compareTo æ¯”è¾ƒçš„ï¼Œæ¯”è¾ƒä¸¤ä¸ªä»»åŠ¡çš„é¡ºåºä¼šç”¨ time ç›¸å‡ã€‚é‚£ä¹ˆå¯èƒ½å‡ºç°ä¸€ä¸ª delay ä¸ºæ­£æ•°å‡å»å¦ä¸€ä¸ªä¸ºè´Ÿæ•°çš„ delayï¼Œç»“æœä¸Šæº¢ä¸ºè´Ÿæ•°ï¼Œåˆ™ä¼šå¯¼è‡´ compareTo äº§ç”Ÿé”™è¯¯çš„ç»“æœ\r\n\r\n  ```java\r\n  private long overflowFree(long delay) {\r\n      Delayed head = (Delayed) super.getQueue().peek();\r\n      if (head != null) {\r\n          long headDelay = head.getDelay(NANOSECONDS);\r\n          // åˆ¤æ–­ä¸€ä¸‹é˜Ÿé¦–çš„delayæ˜¯ä¸æ˜¯è´Ÿæ•°ï¼Œå¦‚æœæ˜¯æ­£æ•°å°±ä¸ç”¨ç®¡ï¼Œæ€ä¹ˆå‡éƒ½ä¸ä¼šæº¢å‡º\r\n          // å¦åˆ™æ‹¿å½“å‰ delay å‡å»é˜Ÿé¦–çš„ delay æ¥æ¯”è¾ƒçœ‹ï¼Œå¦‚æœä¸å‡ºç°ä¸Šæº¢ï¼Œæ’åºä¸ä¼šä¹±\r\n  \t\t// ä¸ç„¶å°±æŠŠå½“å‰ delay å€¼ç»™è°ƒæ•´ä¸º Long.MAX_VALUE + é˜Ÿé¦– delay\r\n          if (headDelay < 0 && (delay - headDelay < 0))\r\n              delay = Long.MAX_VALUE + headDelay;\r\n      }\r\n      return delay;\r\n  }\r\n  ```\r\n\r\n- `scheduleAtFixedRate()`ï¼šå®šæ—¶æ‰§è¡Œï¼Œä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨åˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨çš„é—´éš”\r\n\r\n  ```java\r\n  public ScheduledFuture<?> scheduleAtFixedRate(Runnable command, long initialDelay, long period,\r\n                                                TimeUnit unit) {\r\n      if (command == null || unit == null)\r\n          throw new NullPointerException();\r\n      if (period <= 0)\r\n          throw new IllegalArgumentException();\r\n      // ä»»åŠ¡å°è£…ï¼Œã€æŒ‡å®šåˆå§‹çš„å»¶è¿Ÿæ—¶é—´å’Œå‘¨æœŸæ—¶é—´ã€‘\r\n      ScheduledFutureTask<Void> sft =new ScheduledFutureTask<Void>(command, null,\r\n                                        triggerTime(initialDelay, unit), unit.toNanos(period));\r\n      // é»˜è®¤è¿”å›æœ¬èº«\r\n      RunnableScheduledFuture<Void> t = decorateTask(command, sft);\r\n      sft.outerTask = t;\r\n      // å¼€å§‹æ‰§è¡Œè¿™ä¸ªä»»åŠ¡\r\n      delayedExecute(t);\r\n      return t;\r\n  }\r\n  ```\r\n\r\n- `scheduleWithFixedDelay()`ï¼šå®šæ—¶æ‰§è¡Œï¼Œä¸€æ¬¡ä»»åŠ¡çš„ç»“æŸåˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨çš„é—´éš”\r\n\r\n  ```java\r\n  public ScheduledFuture<?> scheduleWithFixedDelay(Runnable command, long initialDelay, long delay,\r\n                                                   TimeUnit unit) {\r\n      if (command == null || unit == null) \r\n          throw new NullPointerException();\r\n      if (delay <= 0)\r\n          throw new IllegalArgumentException();\r\n      // ä»»åŠ¡å°è£…ï¼Œã€æŒ‡å®šåˆå§‹çš„å»¶è¿Ÿæ—¶é—´å’Œå‘¨æœŸæ—¶é—´ã€‘ï¼Œå‘¨æœŸæ—¶é—´ä¸º - è¡¨ç¤ºæ˜¯ fixed-delay æ¨¡å¼\r\n      ScheduledFutureTask<Void> sft = new ScheduledFutureTask<Void>(command, null,\r\n                                        triggerTime(initialDelay, unit), unit.toNanos(-delay));\r\n      RunnableScheduledFuture<Void> t = decorateTask(command, sft);\r\n      sft.outerTask = t;\r\n      delayedExecute(t);\r\n      return t;\r\n  }\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### è¿è¡Œä»»åŠ¡\r\n\r\n- `delayedExecute()`ï¼š**æ ¡éªŒçº¿ç¨‹æ± çŠ¶æ€**ï¼Œå»¶è¿Ÿæˆ–å‘¨æœŸæ€§ä»»åŠ¡çš„ä¸»è¦æ‰§è¡Œæ–¹æ³•\r\n\r\n  ```java\r\n  private void delayedExecute(RunnableScheduledFuture<?> task) {\r\n      // çº¿ç¨‹æ± æ˜¯ SHUTDOWN çŠ¶æ€ï¼Œéœ€è¦æ‰§è¡Œæ‹’ç»ç­–ç•¥\r\n      if (isShutdown())\r\n          reject(task);\r\n      else {\r\n          // æŠŠå½“å‰ä»»åŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå› ä¸ºéœ€è¦ã€è·å–æ‰§è¡Œæ—¶é—´æœ€è¿‘çš„ã€‘ï¼Œå½“å‰ä»»åŠ¡éœ€è¦æ¯”è¾ƒ\r\n          super.getQueue().add(task);\r\n          // çº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWN å¹¶ä¸”ä¸å…è®¸æ‰§è¡Œä»»åŠ¡äº†ï¼Œå°±ä»é˜Ÿåˆ—åˆ é™¤è¯¥ä»»åŠ¡ï¼Œå¹¶è®¾ç½®ä»»åŠ¡çš„çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€\r\n          if (isShutdown() && !canRunInCurrentRunState(task.isPeriodic()) && remove(task))\r\n              task.cancel(false);\r\n          else\r\n              // å¯ä»¥æ‰§è¡Œ\r\n              ensurePrestart();\r\n      }\r\n  }\r\n  ```\r\n\r\n- `ensurePrestart()`ï¼š**å¼€å¯çº¿ç¨‹æ‰§è¡Œä»»åŠ¡**\r\n\r\n  ```java\r\n  // ThreadPoolExecutor#ensurePrestart\r\n  void ensurePrestart() {\r\n      int wc = workerCountOf(ctl.get());\r\n      // workeræ•°ç›®å°äºcorePoolSizeï¼Œåˆ™æ·»åŠ ä¸€ä¸ªworkerã€‚\r\n      if (wc < corePoolSize)\r\n          // ç¬¬äºŒä¸ªå‚æ•° true è¡¨ç¤ºé‡‡ç”¨æ ¸å¿ƒçº¿ç¨‹æ•°é‡é™åˆ¶ï¼Œfalse è¡¨ç¤ºé‡‡ç”¨ maximumPoolSize\r\n          addWorker(null, true);\r\n      // corePoolSize = 0çš„æƒ…å†µï¼Œè‡³å°‘å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œã€æ‹…ä¿æœºåˆ¶ã€‘\r\n      else if (wc == 0)\r\n          addWorker(null, false);\r\n  }\r\n  ```\r\n\r\n- `canRunInCurrentRunState()`ï¼šä»»åŠ¡è¿è¡Œæ—¶éƒ½ä¼šè¢«è°ƒç”¨ä»¥æ ¡éªŒå½“å‰çŠ¶æ€æ˜¯å¦å¯ä»¥è¿è¡Œä»»åŠ¡\r\n\r\n  ```java\r\n  boolean canRunInCurrentRunState(boolean periodic) {\r\n      // æ ¹æ®æ˜¯å¦æ˜¯å‘¨æœŸä»»åŠ¡åˆ¤æ–­ï¼Œåœ¨çº¿ç¨‹æ±  shutdown åæ˜¯å¦ç»§ç»­æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œé»˜è®¤éå‘¨æœŸä»»åŠ¡æ˜¯ç»§ç»­æ‰§è¡Œçš„\r\n      return isRunningOrShutdown(periodic ? continueExistingPeriodicTasksAfterShutdown :\r\n                                 executeExistingDelayedTasksAfterShutdown);\r\n  }\r\n  ```\r\n\r\n- `onShutdown()`ï¼šåˆ é™¤å¹¶å–æ¶ˆå·¥ä½œé˜Ÿåˆ—ä¸­çš„ä¸éœ€è¦å†æ‰§è¡Œçš„ä»»åŠ¡\r\n\r\n  ```java\r\n  void onShutdown() {\r\n      BlockingQueue<Runnable> q = super.getQueue();\r\n      // shutdown åæ˜¯å¦ä»ç„¶æ‰§è¡Œå»¶æ—¶ä»»åŠ¡\r\n      boolean keepDelayed = getExecuteExistingDelayedTasksAfterShutdownPolicy();\r\n      // shutdown åæ˜¯å¦ä»ç„¶æ‰§è¡Œå‘¨æœŸä»»åŠ¡\r\n      boolean keepPeriodic = getContinueExistingPeriodicTasksAfterShutdownPolicy();\r\n      // å¦‚æœä¸¤è€…çš†ä¸å¯ï¼Œåˆ™å¯¹é˜Ÿåˆ—ä¸­ã€æ‰€æœ‰ä»»åŠ¡ã€‘è°ƒç”¨ cancel å–æ¶ˆå¹¶æ¸…ç©ºé˜Ÿåˆ—\r\n      if (!keepDelayed && !keepPeriodic) {\r\n          for (Object e : q.toArray())\r\n              if (e instanceof RunnableScheduledFuture<?>)\r\n                  ((RunnableScheduledFuture<?>) e).cancel(false);\r\n          q.clear();\r\n      }\r\n      else {\r\n          for (Object e : q.toArray()) {\r\n              if (e instanceof RunnableScheduledFuture) {\r\n                  RunnableScheduledFuture<?> t = (RunnableScheduledFuture<?>)e;\r\n                  // ä¸éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡åˆ é™¤å¹¶å–æ¶ˆï¼Œå·²ç»å–æ¶ˆçš„ä»»åŠ¡ä¹Ÿéœ€è¦ä»é˜Ÿåˆ—ä¸­åˆ é™¤\r\n                  if ((t.isPeriodic() ? !keepPeriodic : !keepDelayed) ||\r\n                      t.isCancelled()) {\r\n                      if (q.remove(t))\r\n                          t.cancel(false);\r\n                  }\r\n              }\r\n          }\r\n      }\r\n      // å› ä¸ºä»»åŠ¡è¢«ä»é˜Ÿåˆ—ä¸­æ¸…ç†æ‰ï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨ tryTerminate å°è¯•ã€æ”¹å˜çº¿ç¨‹æ± çš„çŠ¶æ€ã€‘\r\n      tryTerminate();\r\n  }\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### ForkJoin\r\n\r\n`Fork/Join`ï¼šçº¿ç¨‹æ± çš„å®ç°ï¼Œä½“ç°æ˜¯åˆ†æ²»æ€æƒ³ï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿›è¡Œä»»åŠ¡æ‹†åˆ†çš„ CPU å¯†é›†å‹è¿ç®—ï¼Œç”¨äº**å¹¶è¡Œè®¡ç®—**\r\n\r\nä»»åŠ¡æ‹†åˆ†ï¼šå°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†ä¸ºç®—æ³•ä¸Šç›¸åŒçš„å°ä»»åŠ¡ï¼Œç›´è‡³ä¸èƒ½æ‹†åˆ†å¯ä»¥ç›´æ¥æ±‚è§£ã€‚è·Ÿé€’å½’ç›¸å…³çš„ä¸€äº›è®¡ç®—ï¼Œå¦‚å½’å¹¶æ’åºã€æ–æ³¢é‚£å¥‘æ•°åˆ—éƒ½å¯ä»¥ç”¨åˆ†æ²»æ€æƒ³è¿›è¡Œæ±‚è§£\r\n\r\n- `Fork/Join` åœ¨**åˆ†æ²»çš„åŸºç¡€ä¸ŠåŠ å…¥äº†å¤šçº¿ç¨‹**ï¼ŒæŠŠæ¯ä¸ªä»»åŠ¡çš„åˆ†è§£å’Œåˆå¹¶äº¤ç»™ä¸åŒçš„çº¿ç¨‹æ¥å®Œæˆï¼Œæå‡äº†è¿ç®—æ•ˆç‡\r\n\r\n- ForkJoin ä½¿ç”¨ ForkJoinPool æ¥å¯åŠ¨ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹æ± ï¼Œé»˜è®¤ä¼šåˆ›å»ºä¸ CPU æ ¸å¿ƒæ•°å¤§å°ç›¸åŒçš„çº¿ç¨‹æ± \r\n- ä»»åŠ¡æœ‰è¿”å›å€¼ç»§æ‰¿ RecursiveTaskï¼Œæ²¡æœ‰è¿”å›å€¼ç»§æ‰¿ RecursiveAction\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    ForkJoinPool pool = new ForkJoinPool(4);\r\n    System.out.println(pool.invoke(new MyTask(5)));\r\n    //æ‹†åˆ†  5 + MyTask(4) --> 4 + MyTask(3) -->\r\n}\r\n\r\n// 1~ n ä¹‹é—´æ•´æ•°çš„å’Œ\r\nclass MyTask extends RecursiveTask<Integer> {\r\n    private int n;\r\n\r\n    public MyTask(int n) {\r\n        this.n = n;\r\n    }\r\n\r\n    @Override\r\n    public String toString() {\r\n        return \"MyTask{\" + \"n=\" + n + '}';\r\n    }\r\n\r\n    @Override\r\n    protected Integer compute() {\r\n        // å¦‚æœ n å·²ç»ä¸º 1ï¼Œå¯ä»¥æ±‚å¾—ç»“æœäº†\r\n        if (n == 1) {\r\n            return n;\r\n        }\r\n        // å°†ä»»åŠ¡è¿›è¡Œæ‹†åˆ†(fork)\r\n        MyTask t1 = new MyTask(n - 1);\r\n        t1.fork();\r\n        // åˆå¹¶(join)ç»“æœ\r\n        int result = n + t1.join();\r\n        return result;\r\n    }\r\n}\r\n```\r\n\r\nç»§ç»­æ‹†åˆ†ä¼˜åŒ–ï¼š\r\n\r\n```java\r\nclass AddTask extends RecursiveTask<Integer> {\r\n    int begin;\r\n    int end;\r\n    public AddTask(int begin, int end) {\r\n        this.begin = begin;\r\n        this.end = end;\r\n    }\r\n    \r\n    @Override\r\n    public String toString() {\r\n        return \"{\" + begin + \",\" + end + '}';\r\n    }\r\n    \r\n    @Override\r\n    protected Integer compute() {\r\n        // 5, 5\r\n        if (begin == end) {\r\n            return begin;\r\n        }\r\n        // 4, 5  é˜²æ­¢å¤šä½™çš„æ‹†åˆ†  æé«˜æ•ˆç‡\r\n        if (end - begin == 1) {\r\n            return end + begin;\r\n        }\r\n        // 1 5\r\n        int mid = (end + begin) / 2; // 3\r\n        AddTask t1 = new AddTask(begin, mid); // 1,3\r\n        t1.fork();\r\n        AddTask t2 = new AddTask(mid + 1, end); // 4,5\r\n        t2.fork();\r\n        int result = t1.join() + t2.join();\r\n        return result;\r\n    }\r\n}\r\n```\r\n\r\nForkJoinPool å®ç°äº†**å·¥ä½œçªƒå–ç®—æ³•**æ¥æé«˜ CPU çš„åˆ©ç”¨ç‡ï¼š\r\n\r\n- æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ª**åŒç«¯é˜Ÿåˆ—**ï¼Œç”¨æ¥å­˜å‚¨éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡\r\n- å·¥ä½œçªƒå–ç®—æ³•å…è®¸ç©ºé—²çš„çº¿ç¨‹ä»å…¶å®ƒçº¿ç¨‹çš„åŒç«¯é˜Ÿåˆ—ä¸­çªƒå–ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œ\r\n- çªƒå–çš„å¿…é¡»æ˜¯**æœ€æ™šçš„ä»»åŠ¡**ï¼Œé¿å…å’Œé˜Ÿåˆ—æ‰€å±çº¿ç¨‹å‘ç”Ÿç«äº‰ï¼Œä½†æ˜¯é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶è¿˜æ˜¯ä¼šå‘ç”Ÿç«äº‰\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### äº«å…ƒæ¨¡å¼\r\n\r\näº«å…ƒæ¨¡å¼ï¼ˆFlyweight patternï¼‰ï¼š ç”¨äºå‡å°‘åˆ›å»ºå¯¹è±¡çš„æ•°é‡ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨å’Œæé«˜æ€§èƒ½ï¼Œè¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºç»“æ„å‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†å‡å°‘å¯¹è±¡æ•°é‡ä»è€Œæ”¹å–„åº”ç”¨æ‰€éœ€çš„å¯¹è±¡ç»“æ„çš„æ–¹å¼\r\n\r\nå¼‚æ­¥æ¨¡å¼ï¼šè®©æœ‰é™çš„å·¥ä½œçº¿ç¨‹ï¼ˆWorker Threadï¼‰æ¥è½®æµå¼‚æ­¥å¤„ç†æ— é™å¤šçš„ä»»åŠ¡ï¼Œä¹Ÿå¯å°†å…¶å½’ç±»ä¸ºåˆ†å·¥æ¨¡å¼ï¼Œå…¸å‹å®ç°å°±æ˜¯çº¿ç¨‹æ± \r\n\r\nå·¥ä½œæœºåˆ¶ï¼šäº«å…ƒæ¨¡å¼å°è¯•é‡ç”¨ç°æœ‰çš„åŒç±»å¯¹è±¡ï¼Œå¦‚æœæœªæ‰¾åˆ°åŒ¹é…çš„å¯¹è±¡ï¼Œåˆ™åˆ›å»ºæ–°å¯¹è±¡\r\n\r\nè‡ªå®šä¹‰è¿æ¥æ± ï¼š\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    Pool pool = new Pool(2);\r\n    for (int i = 0; i < 5; i++) {\r\n        new Thread(() -> {\r\n            Connection con = pool.borrow();\r\n            try {\r\n                Thread.sleep(new Random().nextInt(1000));\r\n            } catch (InterruptedException e) {\r\n                e.printStackTrace();\r\n            }\r\n            pool.free(con);\r\n        }).start();\r\n    }\r\n}\r\nclass Pool {\r\n    //è¿æ¥æ± çš„å¤§å°\r\n    private final int poolSize;\r\n    //è¿æ¥å¯¹è±¡çš„æ•°ç»„\r\n    private Connection[] connections;\r\n    //è¿æ¥çŠ¶æ€æ•°ç»„ 0è¡¨ç¤ºç©ºé—²  1è¡¨ç¤ºç¹å¿™\r\n    private AtomicIntegerArray states;  //int[] -> AtomicIntegerArray\r\n\r\n    //æ„é€ æ–¹æ³•\r\n    public Pool(int poolSize) {\r\n        this.poolSize = poolSize;\r\n        this.connections = new Connection[poolSize];\r\n        this.states = new AtomicIntegerArray(new int[poolSize]);\r\n        for (int i = 0; i < poolSize; i++) {\r\n            connections[i] = new MockConnection(\"è¿æ¥\" + (i + 1));\r\n        }\r\n    }\r\n\r\n    //ä½¿ç”¨è¿æ¥\r\n    public Connection borrow() {\r\n        while (true) {\r\n            for (int i = 0; i < poolSize; i++) {\r\n                if (states.get(i) == 0) {\r\n                    if (states.compareAndSet(i, 0, 1)) {\r\n                        System.out.println(Thread.currentThread().getName() + \" borrow \" +  connections[i]);\r\n                        return connections[i];\r\n                    }\r\n                }\r\n            }\r\n            //å¦‚æœæ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œå½“å‰çº¿ç¨‹ç­‰å¾…\r\n            synchronized (this) {\r\n                try {\r\n                    System.out.println(Thread.currentThread().getName() + \" wait...\");\r\n                    this.wait();\r\n                } catch (InterruptedException e) {\r\n                    e.printStackTrace();\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    //å½’è¿˜è¿æ¥\r\n    public void free(Connection con) {\r\n        for (int i = 0; i < poolSize; i++) {\r\n            if (connections[i] == con) {//åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡\r\n                states.set(i, 0);//ä¸ç”¨casçš„åŸå› æ˜¯åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨è¯¥è¿æ¥\r\n                synchronized (this) {\r\n                    System.out.println(Thread.currentThread().getName() + \" free \" + con);\r\n                    this.notifyAll();\r\n                }\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n}\r\n\r\nclass MockConnection implements Connection {\r\n    private String name;\r\n    //.....\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"è®¾è®¡æ¨¡å¼ä¹‹æŠ½è±¡è´£ä»»é“¾æ¨¡å¼-Chain","tags":["Spring Boot","ç­–ç•¥æ¨¡å¼"],"categories":["Java","è®¾è®¡æ¨¡å¼"],"author":"imklaus","excerpt":"\r\n\r\n## è´£ä»»é“¾æ¨¡å¼\r\n\r\n### 1. ä»€ä¹ˆæ˜¯è´£ä»»é“¾\r\n\r\nè´£ä»»é“¾è®¾è®¡æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯è§£è€¦è¯·æ±‚å‘é€è€…å’Œè¯·æ±‚æ¥æ”¶è€…ï¼Œè®©å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œä»è€Œé¿å…è¯·æ±‚å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„ç´§è€¦åˆã€‚\r\n\r\n","link":"/posts/Design_Patterns-Chain","content":"\r\n\r\n## è´£ä»»é“¾æ¨¡å¼\r\n\r\n### 1. ä»€ä¹ˆæ˜¯è´£ä»»é“¾\r\n\r\nè´£ä»»é“¾è®¾è®¡æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯è§£è€¦è¯·æ±‚å‘é€è€…å’Œè¯·æ±‚æ¥æ”¶è€…ï¼Œè®©å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œä»è€Œé¿å…è¯·æ±‚å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„ç´§è€¦åˆã€‚\r\n\r\n<!-- more -->\r\n\r\nè´£ä»»é“¾æ¨¡å¼çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªé“¾å¼ç»“æ„ï¼Œé“¾ä¸­æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªå¤„ç†è€…å¯¹è±¡ï¼Œè¯·æ±‚å…ˆç»è¿‡ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¤„ç†ï¼Œå¦‚æœè¯¥èŠ‚ç‚¹èƒ½å¤Ÿå¤„ç†è¯·æ±‚ï¼Œåˆ™ç›´æ¥è¿”å›å¤„ç†ç»“æœï¼›å¦åˆ™ï¼Œè¯·æ±‚ç»§ç»­å¾€ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¼ é€’ï¼Œç›´åˆ°æ‰¾åˆ°èƒ½å¤Ÿå¤„ç†è¯¥è¯·æ±‚çš„èŠ‚ç‚¹ä¸ºæ­¢ã€‚æ•´ä¸ªè¿‡ç¨‹ç±»ä¼¼äºæµæ°´çº¿ä¸Šçš„å¤šä¸ªå·¥ä½œç«™ï¼Œæ¯ä¸ªå·¥ä½œç«™è´Ÿè´£ä¸€é¡¹å·¥ä½œï¼Œå¦‚æœè‡ªå·±å¤„ç†ä¸äº†ï¼Œå°±å°†å·¥ä½œäº¤ç»™ä¸‹ä¸€ä¸ªå·¥ä½œç«™ï¼Œç›´åˆ°æ•´ä¸ªå·¥ä½œå®Œæˆã€‚\r\n\r\nåœ¨è´£ä»»é“¾æ¨¡å¼ä¸­ï¼Œæ¯ä¸ªå¤„ç†è€…å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªå¤„ç†è€…å¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªå¤„ç†è€…é“¾ã€‚è¯·æ±‚å‘é€è€…åªéœ€è¦å°†è¯·æ±‚å‘é€ç»™ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å³å¯ï¼Œè€Œä¸ç”¨å…³å¿ƒè¯·æ±‚ä¼šè¢«å“ªä¸ªå¤„ç†è€…å¯¹è±¡å¤„ç†ã€‚ç”±äºæ¯ä¸ªå¤„ç†è€…å¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œå› æ­¤è´£ä»»é“¾æ¨¡å¼å¯ä»¥å®ç°è¯·æ±‚çš„åŠ¨æ€åˆ†é…ã€‚\r\n\r\n### 2. ä¼˜ç¼ºç‚¹\r\n\r\nè´£ä»»é“¾æ¨¡å¼çš„ä¼˜ç‚¹åœ¨äºï¼Œå®ƒå¯ä»¥åŠ¨æ€åœ°æ·»åŠ ã€åˆ é™¤å’Œè°ƒæ•´å¤„ç†è€…å¯¹è±¡ï¼Œä»è€Œçµæ´»åœ°æ„å»ºå¤„ç†é“¾ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿé¿å…äº†è¯·æ±‚å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„ç´§è€¦åˆï¼Œå¢å¼ºäº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚\r\n\r\nä¸è¿‡ï¼Œè´£ä»»é“¾æ¨¡å¼ä¹Ÿæœ‰ä¸€å®šçš„ç¼ºç‚¹ï¼Œä¾‹å¦‚å¦‚æœå¤„ç†é“¾è¿‡é•¿æˆ–è€…å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½ä¼šå¯¹ç³»ç»Ÿæ€§èƒ½äº§ç”Ÿä¸€å®šçš„å½±å“ã€‚\r\n\r\n### 3. åº”ç”¨åœºæ™¯\r\n\r\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè´£ä»»é“¾æ¨¡å¼å¸¸ç”¨äºè¯·æ±‚çš„é¢„å¤„ç†ã€è¯·æ±‚çš„è¿‡æ»¤ã€è¯·æ±‚çš„åˆ†å‘ç­‰åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼æ¥å®ç°æƒé™æ ¡éªŒã€æ—¥å¿—è®°å½•ã€å¼‚å¸¸å¤„ç†ã€è¯·æ±‚é‡è¯•ç­‰åŠŸèƒ½ã€‚åŒæ—¶ï¼Œä¹Ÿå¯ä»¥å°†è´£ä»»é“¾æ¨¡å¼ä¸å…¶ä»–è®¾è®¡æ¨¡å¼ç»“åˆèµ·æ¥ï¼Œä¾‹å¦‚è£…é¥°å™¨æ¨¡å¼ã€å·¥å‚æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼ç­‰ï¼Œä»è€Œå®ç°æ›´å¤æ‚çš„åŠŸèƒ½ã€‚\r\n\r\n## ä¸‹å•åœºæ™¯å®æˆ˜\r\n\r\n### 1. ä¸‹å•å‰ç½®æ ¡éªŒ\r\n\r\nåœ¨ç”µå•†ç³»ç»Ÿä¸‹å•æ¥å£ä¸­ï¼Œå‰ç½®æ ¡éªŒæ˜¯éå¸¸é‡è¦çš„ç¯èŠ‚ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¯èƒ½çš„æ ¡éªŒæ­¥éª¤åˆ—è¡¨ï¼š\r\n\r\n- æ£€æŸ¥å•†å“ä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼ŒåŒ…æ‹¬å•†å“åç§°ã€ä»·æ ¼ã€è§„æ ¼ç­‰ä¿¡æ¯ã€‚\r\n- æ£€æŸ¥è´­ä¹°æ•°é‡æ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦è¶…å‡ºäº†æœ€å¤§è´­ä¹°æ•°é‡æˆ–æœ€å°è´­ä¹°æ•°é‡çš„é™åˆ¶ã€‚\r\n- æ£€æŸ¥å•†å“åº“å­˜æ˜¯å¦å……è¶³ï¼Œä»¥ç¡®ä¿åº“å­˜è¶³å¤Ÿæ»¡è¶³è´­ä¹°è€…çš„éœ€æ±‚ã€‚\r\n- æ£€æŸ¥è´­ä¹°è€…çš„ä¼˜æƒ åˆ¸ã€ç§¯åˆ†ç­‰æ˜¯å¦å¯ä»¥ä½¿ç”¨ï¼Œä»¥ç¡®ä¿è´­ä¹°è€…èƒ½å¤Ÿäº«å—ç›¸åº”çš„ä¼˜æƒ æˆ–ç§¯åˆ†å¥–åŠ±ã€‚\r\n- æ£€æŸ¥æ”¶è´§åœ°å€ä¿¡æ¯æ˜¯å¦å®Œæ•´å’Œå‡†ç¡®ï¼Œä»¥ç¡®ä¿å•†å“èƒ½å¤Ÿé¡ºåˆ©åœ°é€è¾¾ç»™è´­ä¹°è€…ã€‚\r\n- æ£€æŸ¥ä¸‹å•æ—¶é—´æ˜¯å¦åˆæ³•ï¼Œä¾‹å¦‚æ£€æŸ¥è´­ä¹°è€…æ˜¯å¦åœ¨é™å®šçš„æ—¶é—´èŒƒå›´å†…ä¸‹å•ã€‚\r\n\r\nçœŸå®ç”µå•†åœºæ™¯ä¸­ï¼ŒéªŒè¯é€»è¾‘ç»å¯¹ä¸ä»…ä»…æ˜¯è¿™äº›ï¼Œè¿‡ä¹‹è€Œæ— ä¸åŠã€‚\r\n\r\nå¯¹äºå®Œæˆè¿™äº›å‰ç½®æ ¡éªŒé€»è¾‘ï¼Œå¤§éƒ¨åˆ†ç¨‹åºå‘˜å¯èƒ½çš„ä»£ç æ€è·¯å¦‚ä¸‹ï¼š\r\n\r\n```java\r\npublic String createOrder(CreateOrderReqDTO xxx) {\r\n    // æ£€æŸ¥å•†å“ä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼ŒåŒ…æ‹¬å•†å“åç§°ã€ä»·æ ¼ã€è§„æ ¼ç­‰ä¿¡æ¯\r\n  \t// æ£€æŸ¥è´­ä¹°æ•°é‡æ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦è¶…å‡ºäº†æœ€å¤§è´­ä¹°æ•°é‡æˆ–æœ€å°è´­ä¹°æ•°é‡çš„é™åˆ¶\r\n    // æ£€æŸ¥å•†å“åº“å­˜æ˜¯å¦å……è¶³ï¼Œä»¥ç¡®ä¿åº“å­˜è¶³å¤Ÿæ»¡è¶³è´­ä¹°è€…çš„éœ€æ±‚\r\n    // æ£€æŸ¥è´­ä¹°è€…çš„ä¼˜æƒ åˆ¸ã€ç§¯åˆ†ç­‰æ˜¯å¦å¯ä»¥ä½¿ç”¨ï¼Œä»¥ç¡®ä¿è´­ä¹°è€…èƒ½å¤Ÿäº«å—ç›¸åº”çš„ä¼˜æƒ æˆ–ç§¯åˆ†å¥–åŠ±\r\n    // æ£€æŸ¥æ”¶è´§åœ°å€ä¿¡æ¯æ˜¯å¦å®Œæ•´å’Œå‡†ç¡®ï¼Œä»¥ç¡®ä¿å•†å“èƒ½å¤Ÿé¡ºåˆ©åœ°é€è¾¾ç»™è´­ä¹°è€…\r\n    // æ£€æŸ¥ä¸‹å•æ—¶é—´æ˜¯å¦åˆæ³•ï¼Œä¾‹å¦‚æ£€æŸ¥è´­ä¹°è€…æ˜¯å¦åœ¨é™å®šçš„æ—¶é—´èŒƒå›´å†…ä¸‹å•\r\n    // ......\r\n}\r\n\r\npublic String createOrder(CreateOrderReqDTO xxx) {\r\n    // æ£€æŸ¥å•†å“ä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼ŒåŒ…æ‹¬å•†å“åç§°ã€ä»·æ ¼ã€è§„æ ¼ç­‰ä¿¡æ¯\r\n  \t// æ£€æŸ¥è´­ä¹°æ•°é‡æ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦è¶…å‡ºäº†æœ€å¤§è´­ä¹°æ•°é‡æˆ–æœ€å°è´­ä¹°æ•°é‡çš„é™åˆ¶\r\n    // æ£€æŸ¥å•†å“åº“å­˜æ˜¯å¦å……è¶³ï¼Œä»¥ç¡®ä¿åº“å­˜è¶³å¤Ÿæ»¡è¶³è´­ä¹°è€…çš„éœ€æ±‚\r\n    // æ£€æŸ¥è´­ä¹°è€…çš„ä¼˜æƒ åˆ¸ã€ç§¯åˆ†ç­‰æ˜¯å¦å¯ä»¥ä½¿ç”¨ï¼Œä»¥ç¡®ä¿è´­ä¹°è€…èƒ½å¤Ÿäº«å—ç›¸åº”çš„ä¼˜æƒ æˆ–ç§¯åˆ†å¥–åŠ±\r\n    // æ£€æŸ¥æ”¶è´§åœ°å€ä¿¡æ¯æ˜¯å¦å®Œæ•´å’Œå‡†ç¡®ï¼Œä»¥ç¡®ä¿å•†å“èƒ½å¤Ÿé¡ºåˆ©åœ°é€è¾¾ç»™è´­ä¹°è€…\r\n    // æ£€æŸ¥ä¸‹å•æ—¶é—´æ˜¯å¦åˆæ³•ï¼Œä¾‹å¦‚æ£€æŸ¥è´­ä¹°è€…æ˜¯å¦åœ¨é™å®šçš„æ—¶é—´èŒƒå›´å†…ä¸‹å•\r\n    // ......\r\n}\r\n```\r\n\r\nè§£å†³å‰ç½®æ ¡éªŒéœ€æ±‚éœ€è¦å®ç°ä¸€å †é€»è¾‘ï¼Œå¸¸å¸¸éœ€è¦å†™ä¸Šå‡ ç™¾ä¸Šåƒè¡Œä»£ç ã€‚\r\n\r\nä¸ºäº†é¿å…è¿™ç§ä»£ç è‡ƒè‚¿çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥è¿ç”¨è´£ä»»é“¾è®¾è®¡æ¨¡å¼ï¼Œå¯¹ä¸‹å•éªŒè¯é€»è¾‘è¿›è¡ŒæŠ½è±¡ã€‚\r\n\r\n### 2. è´£ä»»é“¾é‡æ„\r\n\r\nå®šä¹‰ä¸€ä¸ªè´£ä»»é“¾å¤„ç†å™¨æ¥å£ï¼Œæ‰€æœ‰å­ä»»åŠ¡éƒ½å®ç°è¯¥æ¥å£ä»¥å¤„ç†å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚\r\n\r\nåŒæ—¶ï¼Œä¸ºäº†æ–¹ä¾¿å¯¹è´£ä»»é“¾æµç¨‹ä¸­çš„ä»»åŠ¡è¿›è¡Œé¡ºåºå¤„ç†ï¼Œæˆ‘ä»¬éœ€è¦ç»§æ‰¿ Spring æ¡†æ¶ä¸­çš„æ’åºæ¥å£ Orderedã€‚è¿™å°†æœ‰åŠ©äºä¿è¯è´£ä»»é“¾ä¸­çš„ä»»åŠ¡é¡ºåºæ‰§è¡Œã€‚\r\n\r\n```java\r\npublic interface OrderCreateChainHandler<T> extends Ordered {\r\n    \r\n    /**\r\n     * æ‰§è¡Œè´£ä»»é“¾é€»è¾‘\r\n     *\r\n     * @param requestParam è´£ä»»é“¾æ‰§è¡Œå…¥å‚\r\n     */\r\n    void handler(T requestParam);\r\n}\r\n\r\npublic interface OrderCreateChainHandler<T> extends Ordered {\r\n    \r\n    /**\r\n     * æ‰§è¡Œè´£ä»»é“¾é€»è¾‘\r\n     *\r\n     * @param requestParam è´£ä»»é“¾æ‰§è¡Œå…¥å‚\r\n     */\r\n    void handler(T requestParam);\r\n}\r\n```\r\n\r\nåˆ›å»ºä¸€ä¸ªè´£ä»»é“¾ä¸Šä¸‹æ–‡å®¹å™¨ï¼Œç”¨äºå­˜å‚¨ä¸è´£ä»»é“¾ç›¸åº”çš„å­ä»»åŠ¡ã€‚\r\n\r\n```java\r\npublic final class OrderCreateChainContext<T> implements CommandLineRunner {\r\n    \r\n    private final List<OrderCreateChainHandler> orderCreateChainHandlerContainer = new ArrayList();\r\n    \r\n    /**\r\n     * è´£ä»»é“¾ç»„ä»¶æ‰§è¡Œ\r\n     *\r\n     * @param requestParam è¯·æ±‚å‚æ•°\r\n     */\r\n    public void handler(T requestParam) {\r\n        // æ­¤å¤„æ ¹æ® Ordered å®é™…å€¼è¿›è¡Œæ’åºå¤„ç†\r\n        orderCreateChainHandlerContainer.stream()\r\n                .sorted(Comparator.comparing(Ordered::getOrder)).forEach(each -> each.handler(requestParam));\r\n    }\r\n    \r\n    @Override\r\n    public void run(String... args) throws Exception {\r\n      \t// é€šè¿‡ Spring ä¸Šä¸‹æ–‡å®¹å™¨ï¼Œè·å–æ‰€æœ‰ CreateOrderChainContext Bean\r\n        Map<String, OrderCreateChainHandler> chainFilterMap = ApplicationContextHolder.getBeansOfType(OrderCreateChainHandler.class);\r\n      \t// å°†å¯¹åº” Bean æ”¾å…¥è´£ä»»é“¾ä¸Šä¸‹æ–‡å®¹å™¨ä¸­\r\n        chainFilterMap.forEach((beanName, bean) -> orderCreateChainHandlerContainer.add(bean););\r\n    }\r\n}\r\n\r\npublic final class OrderCreateChainContext<T> implements CommandLineRunner {\r\n    \r\n    private final List<OrderCreateChainHandler> orderCreateChainHandlerContainer = new ArrayList();\r\n    \r\n    /**\r\n     * è´£ä»»é“¾ç»„ä»¶æ‰§è¡Œ\r\n     *\r\n     * @param requestParam è¯·æ±‚å‚æ•°\r\n     */\r\n    public void handler(T requestParam) {\r\n        // æ­¤å¤„æ ¹æ® Ordered å®é™…å€¼è¿›è¡Œæ’åºå¤„ç†\r\n        orderCreateChainHandlerContainer.stream()\r\n                .sorted(Comparator.comparing(Ordered::getOrder)).forEach(each -> each.handler(requestParam));\r\n    }\r\n    \r\n    @Override\r\n    public void run(String... args) throws Exception {\r\n      \t// é€šè¿‡ Spring ä¸Šä¸‹æ–‡å®¹å™¨ï¼Œè·å–æ‰€æœ‰ CreateOrderChainContext Bean\r\n        Map<String, OrderCreateChainHandler> chainFilterMap = ApplicationContextHolder.getBeansOfType(OrderCreateChainHandler.class);\r\n      \t// å°†å¯¹åº” Bean æ”¾å…¥è´£ä»»é“¾ä¸Šä¸‹æ–‡å®¹å™¨ä¸­\r\n        chainFilterMap.forEach((beanName, bean) -> orderCreateChainHandlerContainer.add(bean););\r\n    }\r\n}\r\n```\r\n\r\nå®ç° `OrderCreateChainHandler` æ¥å£ä½œä¸ºè´£ä»»é“¾å¤„ç†å™¨ï¼Œæ¯ä¸ªå…·ä½“çš„å®ç°ç±»è´Ÿè´£æ‰§è¡Œç‰¹å®šçš„é€»è¾‘ã€‚\r\n\r\n```java\r\n// è®¢å•åˆ›å»ºå‚æ•°å¿…å¡«æ£€éªŒ\r\n@Component\r\npublic final class OrderCreateParamNotNullChainHandler implements OrderCreateChainHandler<OrderCreateCommand> {\r\n    \r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 0;\r\n    }\r\n}\r\n\r\n// è®¢å•åˆ›å»ºå‚æ•°æ­£ç¡®æ€§æ£€éªŒ\r\n@Component\r\npublic final class OrderCreateParamVerificationChainHandler implements OrderCreateChainHandler<OrderCreateCommand> {\r\n    \r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 1;\r\n    }\r\n}\r\n\r\n// è®¢å•åˆ›å»ºå•†å“ SKU åº“å­˜éªŒè¯\r\n@Component\r\npublic final class OrderCreateProductSkuStockChainHandler implements OrderCreateChainHandler<OrderCreateCommand> {\r\n\r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 2;\r\n    }\r\n}\r\n\r\n// è®¢å•åˆ›å»ºå‚æ•°å¿…å¡«æ£€éªŒ\r\n@Component\r\npublic final class OrderCreateParamNotNullChainHandler implements OrderCreateChainHandler<OrderCreateCommand> {\r\n    \r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 0;\r\n    }\r\n}\r\n\r\n// è®¢å•åˆ›å»ºå‚æ•°æ­£ç¡®æ€§æ£€éªŒ\r\n@Component\r\npublic final class OrderCreateParamVerificationChainHandler implements OrderCreateChainHandler<OrderCreateCommand> {\r\n    \r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 1;\r\n    }\r\n}\r\n\r\n// è®¢å•åˆ›å»ºå•†å“ SKU åº“å­˜éªŒè¯\r\n@Component\r\npublic final class OrderCreateProductSkuStockChainHandler implements OrderCreateChainHandler<OrderCreateCommand> {\r\n\r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 2;\r\n    }\r\n}\r\n```\r\n\r\né€šè¿‡è´£ä»»é“¾æ¨¡å¼ä¼˜åŒ–ï¼Œåˆ›å»ºè®¢å•æ¥å£å‰ç½®æ ¡éªŒä»£ç ä»ä¸Šåƒè¡Œç¼©å‡ä¸ºä¸€è¡Œã€‚\r\n\r\n```java\r\n@RequiredArgsConstructor\r\npublic class OrderServiceImpl implements OrderService {\r\n\r\n    private final OrderCreateChainContext<OrderCreateCommand> orderCreateChainContext;\r\n  \r\n    public String createOrder(OrderCreateCommand requestParam) {\r\n        // è´£ä»»é“¾æ¨¡å¼: æ‰§è¡Œè®¢å•åˆ›å»ºå‚æ•°éªŒè¯\r\n        orderCreateChainContext.handler(requestParam);\r\n    }\r\n}\r\n\r\n@RequiredArgsConstructor\r\npublic class OrderServiceImpl implements OrderService {\r\n\r\n    private final OrderCreateChainContext<OrderCreateCommand> orderCreateChainContext;\r\n  \r\n    public String createOrder(OrderCreateCommand requestParam) {\r\n        // è´£ä»»é“¾æ¨¡å¼: æ‰§è¡Œè®¢å•åˆ›å»ºå‚æ•°éªŒè¯\r\n        orderCreateChainContext.handler(requestParam);\r\n    }\r\n}\r\n```\r\n\r\nç»è¿‡è´£ä»»é“¾æ¨¡å¼çš„é‡æ„ï¼Œä½ æ˜¯å¦å‘ç°ä¸šåŠ¡é€»è¾‘å˜å¾—æ›´åŠ æ¸…æ™°æ˜“æ‡‚äº†ï¼Ÿé‡‡ç”¨è¿™ç§è®¾è®¡æ¨¡å¼åï¼Œå¢åŠ æˆ–åˆ é™¤ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å˜å¾—éå¸¸æ–¹ä¾¿ï¼Œä¸å†éœ€è¦æ‹…å¿ƒæ›´æ”¹ä¸Šåƒè¡Œä»£ç çš„å‡ è¡Œä»£ç ï¼Œå¯¼è‡´æ•´ä¸ªä¸šåŠ¡é€»è¾‘å—åˆ°å½±å“çš„æƒ…å†µã€‚\r\n\r\n## è´£ä»»é“¾æŠ½è±¡\r\n\r\nå¯èƒ½ç»†å¿ƒçš„å°ä¼™ä¼´ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå½“ä¸šåŠ¡ä½¿ç”¨è¶Šæ¥è¶Šå¤šçš„æƒ…å†µä¸‹ï¼Œé‡å¤å®šä¹‰ `OrderCreateChainHandler` ä»¥åŠ `OrderCreateChainContext` ä¼šå¢åŠ ç³»ç»Ÿå†—ä½™ä»£ç é‡ã€‚\r\n\r\nå¯ä»¥è€ƒè™‘å°†è¿™ä¸¤ä¸ªåŸºç¡€ç±»æŠ½è±¡å‡ºæ¥ï¼Œä½œä¸ºåŸºç¡€ç»„ä»¶åº“ä¸­çš„é€šç”¨ç»„ä»¶ï¼Œä¾›æ‰€æœ‰ç³»ç»Ÿä¸‹çš„ä¸šåŠ¡ä½¿ç”¨ï¼Œä»è€Œé¿å…ä»£ç å†—ä½™ã€‚\r\n\r\nå¦‚æœæƒ³äº†è§£å¦‚ä½•å®ç°è¿™ä¸€æ“ä½œï¼Œè¯·è·Ÿéšé©¬å“¥çš„æ€è·¯ç»§ç»­å¾€ä¸‹é˜…è¯»ã€‚\r\n\r\n### 1. æŠ½è±¡åŸºç¡€ç±»\r\n\r\nå®šä¹‰æŠ½è±¡è´£ä»»é“¾å¤„ç†æ¥å£ï¼Œç­‰åŒäº `OrderCreateChainHandler`ã€‚\r\n\r\n```java\r\npublic interface AbstractChainHandler<T> extends Ordered {\r\n    \r\n    /**\r\n     * æ‰§è¡Œè´£ä»»é“¾é€»è¾‘\r\n     *\r\n     * @param requestParam è´£ä»»é“¾æ‰§è¡Œå…¥å‚\r\n     */\r\n    void handler(T requestParam);\r\n    \r\n    /**\r\n     * @return è´£ä»»é“¾ç»„ä»¶æ ‡è¯†\r\n     */\r\n    String mark();\r\n}\r\n\r\npublic interface AbstractChainHandler<T> extends Ordered {\r\n    \r\n    /**\r\n     * æ‰§è¡Œè´£ä»»é“¾é€»è¾‘\r\n     *\r\n     * @param requestParam è´£ä»»é“¾æ‰§è¡Œå…¥å‚\r\n     */\r\n    void handler(T requestParam);\r\n    \r\n    /**\r\n     * @return è´£ä»»é“¾ç»„ä»¶æ ‡è¯†\r\n     */\r\n    String mark();\r\n}\r\n```\r\n\r\n`mark` æ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿæ¥å£å¢åŠ  `mark` æ–¹æ³•ï¼Œä»¥ä¾¿ä¸åŒä¸šåŠ¡ä½¿ç”¨ä¸åŒçš„æ ‡è¯†ã€‚\r\n\r\nå‡è®¾é¡¹ç›®ä¸­æœ‰ä¸¤ä¸ªä¸šåŠ¡åœºæ™¯ï¼šè®¢å•ä¸‹å•å’Œç”¨æˆ·åˆ›å»ºéƒ½éœ€è¦è´£ä»»é“¾æ¨¡å¼å»éªŒè¯ï¼Œé‚£ä¹ˆåœ¨ä¸šåŠ¡ä¸­è¿›è¡Œè°ƒç”¨è´£ä»»é“¾æ—¶ä¼ é€’ä¸åŒçš„ `mark` æ–¹æ³•å‚æ•°å³å¯ã€‚\r\n\r\nå®šä¹‰æŠ½è±¡è´£ä»»é“¾ä¸Šä¸‹æ–‡ï¼Œç­‰åŒäº `OrderCreateChainContext`ã€‚å¯ä»¥çœ‹åˆ°ä¿å­˜è´£ä»»é“¾å¤„ç†ç±»çš„å®¹å™¨ä» List æ”¹ä¸ºäº† Mapï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿æ‰©å±•æ›´å¤šçš„ä¸åŒä¸šåŠ¡è´£ä»»é“¾å­ç±»ã€‚\r\n\r\nå‡è®¾é¡¹ç›®ä¸­æœ‰ä¸¤ä¸ªä¸šåŠ¡åœºæ™¯ï¼šè®¢å•ä¸‹å•å’Œç”¨æˆ·åˆ›å»ºéƒ½éœ€è¦è´£ä»»é“¾æ¨¡å¼å»éªŒè¯ï¼Œ`mark` å°±æ˜¯ç”¨æ¥è¿›è¡Œåˆ†ç»„ï¼Œåœ¨ä¸šåŠ¡ä¸­è¿›è¡Œè°ƒç”¨è´£ä»»é“¾æ—¶ä¼ é€’ä¸åŒçš„ `mark` æ–¹æ³•å‚æ•°ï¼Œé€šè¿‡è¯¥å‚æ•°æ‰¾åˆ°å¯¹åº”çš„ä¸€ç»„è´£ä»»é“¾å…·ä½“å®ç°ç±»é›†åˆã€‚\r\n\r\n```java\r\npublic final class AbstractChainContext<T> implements CommandLineRunner {\r\n    \r\n    private final Map<String, List<AbstractChainHandler>> abstractChainHandlerContainer = Maps.newHashMap();\r\n    \r\n    /**\r\n     * è´£ä»»é“¾ç»„ä»¶æ‰§è¡Œ\r\n     *\r\n     * @param requestParam è¯·æ±‚å‚æ•°\r\n     */\r\n    public void handler(String mark, T requestParam) {\r\n        abstractChainHandlerContainer.get(mark).stream()\r\n                .sorted(Comparator.comparing(Ordered::getOrder)).forEach(each -> each.handler(requestParam));\r\n    }\r\n    \r\n    @Override\r\n    public void run(String... args) throws Exception {\r\n        // è·å– Spring IOC å®¹å™¨ä¸­æ‰€æœ‰ AbstractChainHandler æ¥å£å®ç°\r\n        Map<String, AbstractChainHandler> chainFilterMap = ApplicationContextHolder.getBeansOfType(AbstractChainHandler.class);\r\n        chainFilterMap.forEach((beanName, bean) -> {\r\n            List<AbstractChainHandler> abstractChainHandlers = abstractChainHandlerContainer.get(bean.mark());\r\n            if (abstractChainHandlers == null) {\r\n                abstractChainHandlers = new ArrayList();\r\n            }\r\n            abstractChainHandlers.add(bean);\r\n            // æ ¹æ® mark æ ‡è¯†å°†è´£ä»»é“¾æ¨¡å¼åˆ†ç±»ï¼Œæ”¾å…¥è´£ä»»é“¾å®¹å™¨ä¸Šä¸‹æ–‡ä¸­\r\n            abstractChainHandlerContainer.put(bean.mark(), abstractChainHandlers);\r\n        });\r\n    }\r\n}\r\n```\r\n\r\nè¿™ä¸¤ä¸ªæ¥å£å·²ç»è¢«æ”¾ç½®åœ¨åŸºç¡€ç»„ä»¶åº“ä¸­ï¼Œå¦‚æœä¸šåŠ¡éœ€è¦ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼ï¼Œåˆ™æ— éœ€é‡æ–°å®šä¹‰ã€‚\r\n\r\nç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸šåŠ¡ä»£ç éœ€è¦ç¼–å†™å“ªäº›é€»è¾‘ã€‚\r\n\r\n### 2. æŠ½è±¡ä¸šåŠ¡æ¥å£\r\n\r\nè®©æˆ‘ä»¬å…ˆè¿›è¡Œå¤´è„‘é£æš´ï¼Œæ€è€ƒä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ\r\n\r\n```java\r\n// è®¢å•åˆ›å»ºè´£ä»»é“¾è¿‡æ»¤å™¨\r\npublic interface OrderCreateChainFilter<T extends OrderCreateCommand> extends AbstractChainHandler<OrderCreateCommand> {\r\n    \r\n    @Override\r\n    default String mark() {\r\n        return OrderChainMarkEnum.ORDER_CREATE_FILTER.name();\r\n    }\r\n}\r\n\r\n// è®¢å•åˆ›å»ºè´£ä»»é“¾è¿‡æ»¤å™¨\r\npublic interface OrderCreateChainFilter<T extends OrderCreateCommand> extends AbstractChainHandler<OrderCreateCommand> {\r\n    \r\n    @Override\r\n    default String mark() {\r\n        return OrderChainMarkEnum.ORDER_CREATE_FILTER.name();\r\n    }\r\n}\r\n```\r\n\r\né¦–å…ˆï¼Œå¦‚æœæ²¡æœ‰ `OrderCreateChainFilter` æ¥å£ï¼Œä¼šæ˜¯ä»€ä¹ˆæ ·çš„åœºæ™¯ï¼Ÿ\r\n\r\n- ç”±äºè´£ä»»é“¾å¤„ç†å­ç±»éƒ½éœ€è¦ä¾èµ–é¡¶çº§æŠ½è±¡æ¥å£ï¼Œå› æ­¤è¦æƒ³çŸ¥é“æŸä¸ªä¸šåŠ¡åœºæ™¯ä¸‹æœ‰å¤šå°‘å…·ä½“å­ç±»æ˜¯ç›¸å½“å›°éš¾çš„ã€‚\r\n- ç”±äºè´£ä»»é“¾å¤„ç†å­ç±»éƒ½éœ€è¦å®ç° Mark æ–¹æ³•ï¼Œå®é™…ä¸ŠæŸä¸€ç±»è´£ä»»é“¾å­ç±»çš„ Mark æ–¹æ³•è¿”å›å€¼æ˜¯ç›¸åŒçš„ã€‚\r\n\r\né€šè¿‡åœ¨ä¸šåŠ¡å±‚é¢ä¸ŠæŠ½è±¡å‡ºä¸€ä¸ªå…·ä½“ä¸šåŠ¡è´£ä»»é“¾æ¥å£ï¼Œå°±èƒ½å¾ˆå¥½åœ°è§£å†³ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ã€‚\r\n\r\nç°åœ¨ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ¢è®¨è´£ä»»é“¾å­ç±»çš„ç¼–å†™ã€‚å®é™…ä¸Šï¼Œæ”¹åŠ¨å¹¶ä¸å¤šï¼Œåªéœ€è¦å°†ä¹‹å‰çš„ `OrderCreateChainHandler` å®ç°æ¥å£æ”¹ä¸º `OrderCreateChainFilter` å³å¯ã€‚\r\n\r\n```java\r\n// è®¢å•åˆ›å»ºå‚æ•°å¿…å¡«æ£€éªŒ\r\n@Component\r\npublic final class OrderCreateParamNotNullChainHandler implements OrderCreateChainFilter<OrderCreateCommand> {\r\n    \r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 0;\r\n    }\r\n}\r\n\r\n// è®¢å•åˆ›å»ºå‚æ•°æ­£ç¡®æ€§æ£€éªŒ\r\n@Component\r\npublic final class OrderCreateParamVerificationChainHandler implements OrderCreateChainFilter<OrderCreateCommand> {\r\n    \r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 1;\r\n    }\r\n}\r\n\r\n// è®¢å•åˆ›å»ºå•†å“ SKU åº“å­˜éªŒè¯\r\n@Component\r\npublic final class OrderCreateProductSkuStockChainHandler implements OrderCreateChainFilter<OrderCreateCommand> {\r\n\r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 2;\r\n    }\r\n}\r\n\r\n// è®¢å•åˆ›å»ºå‚æ•°å¿…å¡«æ£€éªŒ\r\n@Component\r\npublic final class OrderCreateParamNotNullChainHandler implements OrderCreateChainFilter<OrderCreateCommand> {\r\n    \r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 0;\r\n    }\r\n}\r\n\r\n// è®¢å•åˆ›å»ºå‚æ•°æ­£ç¡®æ€§æ£€éªŒ\r\n@Component\r\npublic final class OrderCreateParamVerificationChainHandler implements OrderCreateChainFilter<OrderCreateCommand> {\r\n    \r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 1;\r\n    }\r\n}\r\n\r\n// è®¢å•åˆ›å»ºå•†å“ SKU åº“å­˜éªŒè¯\r\n@Component\r\npublic final class OrderCreateProductSkuStockChainHandler implements OrderCreateChainFilter<OrderCreateCommand> {\r\n\r\n    @Override\r\n    public void handler(OrderCreateCommand requestParam) {\r\n\t\t\t\t// é€»è¾‘æ‰§è¡Œ\r\n    }\r\n    \r\n    @Override\r\n    public int getOrder() {\r\n        return 2;\r\n    }\r\n}\r\n```\r\n\r\n### 3. ä¸šåŠ¡ä½¿ç”¨\r\n\r\nåœ¨å…·ä½“ä¸šåŠ¡åœºæ™¯ä¸­ä½¿ç”¨æ—¶ï¼Œä¸ä¹‹å‰ç›¸æ¯”å¹¶æ²¡æœ‰å¤ªå¤§çš„å·®åˆ«ã€‚é™¤äº†å¢åŠ äº† Mark æ ‡è¯†å¤–ï¼Œæ²¡æœ‰è¿›è¡Œå…¶ä»–å˜æ›´ã€‚\r\n\r\n```java\r\n@RequiredArgsConstructor\r\npublic class OrderServiceImpl implements OrderService {\r\n\r\n    private final AbstractChainContext<OrderCreateCommand> abstractChainContext;\r\n  \r\n    public String createOrder(OrderCreateCommand requestParam) {\r\n        // è´£ä»»é“¾æ¨¡å¼: æ‰§è¡Œè®¢å•åˆ›å»ºå‚æ•°éªŒè¯\r\n        abstractChainContext.handler(OrderChainMarkEnum.ORDER_CREATE_FILTER.name(), requestParam);\r\n    }\r\n}\r\n\r\n@RequiredArgsConstructor\r\npublic class OrderServiceImpl implements OrderService {\r\n\r\n    private final AbstractChainContext<OrderCreateCommand> abstractChainContext;\r\n  \r\n    public String createOrder(OrderCreateCommand requestParam) {\r\n        // è´£ä»»é“¾æ¨¡å¼: æ‰§è¡Œè®¢å•åˆ›å»ºå‚æ•°éªŒè¯\r\n        abstractChainContext.handler(OrderChainMarkEnum.ORDER_CREATE_FILTER.name(), requestParam);\r\n    }\r\n}\r\n```\r\n\r\n## æ–‡æœ«æ€»ç»“\r\n\r\næœ¬æ–‡è¯¦ç»†ä»‹ç»äº†è´£ä»»é“¾æ¨¡å¼çš„æ¦‚å¿µï¼Œå¹¶é€šè¿‡ç”µå•†ä¸‹å•åœºæ™¯æ¨¡æ‹Ÿäº†çœŸå®ä½¿ç”¨åœºæ™¯ã€‚\r\n\r\nä¸ºäº†å¤ç”¨è´£ä»»é“¾æ¥å£å®šä¹‰å’Œä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬é€šè¿‡æŠ½è±¡çš„æ–¹å¼å°†è´£ä»»é“¾é—¨é¢æ¥å£åŠ å…¥åˆ°åŸºç¡€ç»„ä»¶åº“ä¸­ï¼Œå®ç°å¿«é€Ÿæ¥å…¥è´£ä»»é“¾çš„ç›®çš„ã€‚\r\n\r\nè™½ç„¶åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ boolean ç±»å‹çš„è¿”å›å€¼ï¼Œè€Œæ˜¯é€šè¿‡å¼‚å¸¸æ¥ç»ˆæ­¢æµç¨‹ï¼Œä½†åœ¨åç»­çš„å¢å¼ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘æ·»åŠ å¸ƒå°”ç±»å‹çš„è¿”å›å€¼ã€‚\r\n\r\næ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨ `AbstractChainHandler` ä¸­å¢åŠ æ˜¯å¦å¼‚æ­¥æ‰§è¡Œçš„æ–¹æ³•ï¼Œä»¥æé«˜æ–¹æ³•æ‰§è¡Œæ€§èƒ½å’Œå‡å°‘æ¥å£å“åº”æ—¶é—´ã€‚\r\n\r\næ¶æ„è®¾è®¡æ€»æ˜¯åœ¨ä¸æ–­æ¼”è¿›ï¼Œæœ¬æ–‡çš„è®¾è®¡ä¹Ÿæœ‰ä¼˜åŒ–å’Œè¿›æ­¥çš„ç©ºé—´ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ¢ç´¢è´£ä»»é“¾æ¨¡å¼çš„æ›´å¤šå¯èƒ½æ€§ã€‚"},{"title":"è®¾è®¡æ¨¡å¼ä¹‹æŠ½è±¡ç­–ç•¥æ¨¡å¼-Strategy","tags":["Spring Boot","ç­–ç•¥æ¨¡å¼"],"categories":["Java","è®¾è®¡æ¨¡å¼"],"author":"imklaus","excerpt":"\r\n## ç­–ç•¥æ¨¡å¼æ˜¯ä»€ä¹ˆ\r\n\r\nç­–ç•¥æ¨¡å¼åœ¨ GoF çš„ã€Šè®¾è®¡æ¨¡å¼ã€‹ä¸€ä¹¦ä¸­ï¼Œæ˜¯è¿™æ ·å®šä¹‰çš„ï¼š\r\n\r\n> Define a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently from clients that use it.\r\n>\r\n\r\nç­–ç•¥è®¾è®¡æ¨¡å¼ï¼ˆStrategy Patternï¼‰æ˜¯ä¸€ç§é¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼ï¼Œå®ƒå®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚è¿™ç§æ¨¡å¼ä½¿å¾—ç®—æ³•å¯ä»¥ç‹¬ç«‹äºä½¿ç”¨å®ƒä»¬çš„å®¢æˆ·ç«¯è€Œå˜åŒ–ã€‚\r\n\r\n","link":"/posts/Design_Patterns-Strategy","content":"\r\n## ç­–ç•¥æ¨¡å¼æ˜¯ä»€ä¹ˆ\r\n\r\nç­–ç•¥æ¨¡å¼åœ¨ GoF çš„ã€Šè®¾è®¡æ¨¡å¼ã€‹ä¸€ä¹¦ä¸­ï¼Œæ˜¯è¿™æ ·å®šä¹‰çš„ï¼š\r\n\r\n> Define a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently from clients that use it.\r\n>\r\n\r\nç­–ç•¥è®¾è®¡æ¨¡å¼ï¼ˆStrategy Patternï¼‰æ˜¯ä¸€ç§é¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼ï¼Œå®ƒå®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚è¿™ç§æ¨¡å¼ä½¿å¾—ç®—æ³•å¯ä»¥ç‹¬ç«‹äºä½¿ç”¨å®ƒä»¬çš„å®¢æˆ·ç«¯è€Œå˜åŒ–ã€‚\r\n\r\n<!-- more -->\r\n\r\nç­–ç•¥è®¾è®¡æ¨¡å¼åŒ…å«ä¸‰ä¸ªä¸»è¦çš„è§’è‰²ï¼š\r\n\r\n> 1. ç¯å¢ƒï¼ˆContextï¼‰ï¼šæŒæœ‰ä¸€ä¸ªç­–ç•¥å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶ç®—æ³•ã€‚\r\n> 2. ç­–ç•¥ï¼ˆStrategyï¼‰ï¼šå®šä¹‰äº†ä¸€ç»„ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚\r\n> 3. å…·ä½“ç­–ç•¥ï¼ˆConcreteStrategyï¼‰ï¼šå®ç°äº†ç­–ç•¥æ¥å£ï¼Œæä¾›äº†å…·ä½“çš„ç®—æ³•å®ç°ã€‚\r\n>\r\n\r\nåœ¨ç­–ç•¥è®¾è®¡æ¨¡å¼ä¸­ï¼Œç¯å¢ƒæŒæœ‰ä¸€ä¸ªç­–ç•¥å¯¹è±¡ï¼Œå¹¶é€šè¿‡è°ƒç”¨ç­–ç•¥çš„ç®—æ³•æ¥å®Œæˆå…·ä½“çš„ä»»åŠ¡ã€‚ç­–ç•¥å¯¹è±¡å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œæ›¿æ¢ï¼Œä»è€Œå®ç°ä¸åŒçš„ç®—æ³•å®ç°ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°æ›´æ”¹ç­–ç•¥å¯¹è±¡ã€‚\r\n\r\nçœ‹åˆ°ä¸Šé¢çš„ä»‹ç»å¯èƒ½ä¸å¤ªæ˜ç™½ç­–ç•¥æ¨¡å¼å…·ä½“ä¸ºä½•ç‰©ï¼Œè¿™é‡Œä¼šä»æœ€åŸºæœ¬çš„ä»£ç è¯´èµ·ï¼Œä¸€æ­¥ä¸€æ­¥å½»åº•æŒæ¡æ­¤æ¨¡å¼ã€‚\r\n\r\n## ä¼˜æƒ ç±»å‹å®æˆ˜\r\n\r\nä¸‹è¿°ä»£ç å¯èƒ½å¤§å®¶éƒ½èƒ½è”æƒ³å‡ºå¯¹åº”çš„ä¸šåŠ¡ï¼Œ**æ ¹æ®å¯¹åº”çš„ä¼˜æƒ ç±»å‹ï¼Œå¯¹ä»·æ ¼ä½œå‡ºç›¸åº”çš„ä¼˜æƒ ã€‚**\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1672473955617-630ff21a-2791-428d-bebd-bb953989f57d.png)\r\n\r\nè¿™æ®µä»£ç æ˜¯èƒ½å¤Ÿæ»¡è¶³é¡¹ç›®ä¸­ä¸šåŠ¡éœ€æ±‚çš„ï¼Œè€Œä¸”å¾ˆå¤šå·²ä¸Šçº¿ç”Ÿäº§ç¯å¢ƒçš„ä»£ç ä¹Ÿæœ‰è¿™ç±»ä»£ç ã€‚ä½†æ˜¯ï¼Œè¿™ä¸€æ®µä»£ç å­˜åœ¨å­˜åœ¨ä¸¤ä¸ªå¼Šç«¯ï¼š\r\n\r\n1. ä»£ç çš„å¤æ‚æ€§ï¼Œæ­£å¸¸ä¸šåŠ¡ä»£ç é€»è¾‘è‚¯å®šä¼šæ¯”è¿™ä¸ªä»£ç å—å¤æ‚å¾ˆå¤šï¼Œè¿™ä¹Ÿå°± **å¯¼è‡´äº† if-else çš„åˆ†æ”¯ä»¥åŠä»£ç æ•°é‡è¿‡å¤š**ã€‚è¿™ç§æ–¹å¼å¯ä»¥é€šè¿‡å°†ä»£ç æ‹†åˆ†æˆç‹¬ç«‹å‡½æ•°æˆ–è€…æ‹†åˆ†æˆç±»æ¥è§£å†³ã€‚\r\n2. å¼€é—­åŸåˆ™ï¼Œä»·æ ¼ä¼˜æƒ è‚¯å®šä¼š **éšç€ä¸åŒçš„æ—¶æœŸä½œå‡ºä¸åŒçš„æ”¹å˜**ï¼Œæˆ–è®¸æ–°å¢ã€åˆ é™¤æˆ–ä¿®æ”¹ã€‚å¦‚æœåœ¨ä¸€ä¸ªå‡½æ•°ä¸­ä¿®æ”¹æ— ç–‘æ˜¯ä»¶ææ€–çš„äº‹æƒ…ï¼Œæƒ³æƒ³å¯èƒ½å¤šä¸ªå¼€å‘è€…åˆ†åˆ«è¿›è¡Œå¼€å‘ï¼Œæ‚ä¹±æ— ç« çš„æ³¨é‡Šï¼Œæ··ä¹±çš„ä»£ç é€»è¾‘ç­‰æƒ…å†µåæœ‰å…«ä¹ä¼šå‘ç”Ÿã€‚\r\n\r\nå¦‚ä½•è¿ç”¨ç­–ç•¥æ¨¡å¼ä¼˜åŒ–ä¸Šè¿°ä»£ç ï¼Œä½¿ç¨‹åºè®¾è®¡çœ‹ç€ç®€çº¦ã€å¯æ‰©å±•ç­‰ç‰¹æ€§ã€‚\r\n\r\n1. ç®€åŒ–ä»£ç çš„å¤æ‚æ€§ï¼Œå°†ä¸åŒçš„ä¼˜æƒ ç±»å‹å®šä¹‰ä¸ºä¸åŒçš„ç­–ç•¥ç®—æ³•å®ç°ç±»ã€‚\r\n2. ä¿è¯å¼€é—­åŸåˆ™ï¼Œå¢åŠ ç¨‹åºçš„å¥å£®æ€§ä»¥åŠå¯æ‰©å±•æ€§ã€‚\r\n\r\nå°†ä¸Šè¿°ä»£ç å—æ”¹é€ ä¸ºç­–ç•¥è®¾è®¡æ¨¡å¼ï¼Œå¤§è‡´éœ€è¦ä¸‰ä¸ªæ­¥éª¤ã€‚\r\n\r\n1. å®šä¹‰æŠ½è±¡ç­–ç•¥æ¥å£ï¼Œå› ä¸ºä¸šåŠ¡ä½¿ç”¨æ¥å£è€Œä¸æ˜¯å…·ä½“çš„å®ç°ç±»çš„è¯ï¼Œä¾¿å¯ä»¥çµæ´»çš„æ›¿æ¢ä¸åŒçš„ç­–ç•¥ï¼›\r\n2. å®šä¹‰å…·ä½“ç­–ç•¥å®ç°ç±»ï¼Œå®ç°è‡ªæŠ½è±¡ç­–ç•¥æ¥å£ï¼Œå…¶å†…éƒ¨å°è£…å…·ä½“çš„ä¸šåŠ¡å®ç°ï¼›\r\n3. å®šä¹‰ç­–ç•¥å·¥å‚ï¼Œå°è£…åˆ›å»ºç­–ç•¥å®ç°ï¼ˆç®—æ³•ï¼‰ï¼Œå¯¹å®¢æˆ·ç«¯å±è”½å…·ä½“çš„åˆ›å»ºç»†èŠ‚ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1672473992392-4b6d78d6-47ab-4d98-afe7-110143827b6b.png)\r\n\r\nç›®å‰æŠŠæŠ½è±¡ç­–ç•¥æ¥å£ã€å…·ä½“çš„ç­–ç•¥å®ç°ç±»ä»¥åŠç­–ç•¥å·¥å‚éƒ½å·²ç»åˆ›å»ºäº†ï¼Œç°åœ¨å¯ä»¥çœ‹ä¸€ä¸‹å®¢æˆ·ç«¯éœ€è¦å¦‚ä½•è°ƒç”¨ï¼Œåˆæ˜¯å¦‚ä½•å¯¹å®¢æˆ·ç«¯å±è”½å…·ä½“å®ç°ç»†èŠ‚çš„ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1672474008299-8d04739e-21e7-4c18-bf06-ca39a837ed9b.png)\r\n\r\næ ¹æ®ä»£ç å—å›¾ç‰‡å¾—çŸ¥ï¼Œå…·ä½“ç­–ç•¥ç±»æ˜¯ä»ç­–ç•¥å·¥å‚ä¸­è·å–ï¼Œç¡®å®æ˜¯å–æ¶ˆäº† if-else è®¾è®¡ï¼Œ**åœ¨å·¥å‚ä¸­ä½¿ç”¨ Map å­˜å‚¨ç­–ç•¥å®ç°**ã€‚è·å–åˆ°ç­–ç•¥ç±»åæ‰§è¡Œå…·ä½“çš„ä¼˜æƒ ç­–ç•¥æ–¹æ³•å°±å¯ä»¥è·å–ä¼˜æƒ åçš„é‡‘é¢ã€‚\r\n\r\né€šè¿‡åˆ†æå¤§å®¶å¾—çŸ¥ï¼Œç›®å‰è¿™ç§è®¾è®¡ç¡®å®å°†åº”ç”¨ä»£ç çš„å¤æ‚æ€§é™ä½äº†ã€‚**å¦‚æœæ–°å¢ä¸€ä¸ªä¼˜æƒ ç­–ç•¥ï¼Œåªéœ€è¦æ–°å¢ä¸€ä¸ªç­–ç•¥ç®—æ³•å®ç°ç±»å³å¯**ã€‚ä½†æ˜¯ï¼Œæ·»åŠ ä¸€ä¸ªç­–ç•¥ç®—æ³•å®ç°ï¼Œ**æ„å‘³ç€éœ€è¦æ”¹åŠ¨ç­–ç•¥å·¥å‚ä¸­çš„ä»£ç **ï¼Œè¿˜æ˜¯ä¸ç¬¦åˆå¼€é—­åŸåˆ™ã€‚\r\n\r\nå¦‚ä½•å®Œæ•´å®ç°ç¬¦åˆå¼€é—­åŸåˆ™çš„ç­–ç•¥æ¨¡å¼ï¼Œéœ€è¦å€ŸåŠ© Spring çš„å¸®åŠ©ï¼Œè¯¦ç»†æ¡ˆä¾‹è¯·ç»§ç»­å¾€ä¸‹çœ‹ã€‚\r\n\r\n## ç­–ç•¥æ¨¡å¼ç»“åˆ Spring\r\n\r\næœ€è¿‘é¡¹ç›®ä¸­è®¾è®¡çš„ä¸€ä¸ªåŠŸèƒ½ç”¨åˆ°äº†ç­–ç•¥æ¨¡å¼ï¼Œåˆ†ä¸ºä¸¤ç±»è§’è‰²ï¼Œç¬”è€…è´Ÿè´£å®šä¹‰æŠ½è±¡ç­–ç•¥æ¥å£ä»¥åŠç­–ç•¥å·¥å‚ï¼Œä¸åŒçš„ç­–ç•¥ç®—æ³•éœ€è¦å„ä¸ªä¸šåŠ¡æ–¹å»å®ç°ï¼Œå¯ä»¥è”æƒ³åˆ°ä¸Šæ–‡ä¸­çš„ä¼˜æƒ åˆ¸åŠŸèƒ½ã€‚å› ä¸ºæ˜¯ Spring é¡¹ç›®ï¼Œæ‰€ä»¥éƒ½æ˜¯æŒ‰ç…§ Spring çš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1672474038315-5988975f-07d4-452f-95d9-f8e7921915fe.png)\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œæ¯”å¯¹ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œæœ‰ä¸¤å¤„æ˜æ˜¾çš„å˜åŒ–ï¼š\r\n\r\n1. æŠ½è±¡ç­–ç•¥æ¥å£ä¸­ï¼Œæ–°å®šä¹‰äº† mark() æ¥å£ï¼Œæ­¤æ¥å£ç”¨æ¥æ ‡ç¤ºç®—æ³•çš„å”¯ä¸€æ€§ï¼›\r\n2. å…·ä½“ç­–ç•¥å®ç°ç±»ï¼Œä½¿ç”¨ @Component ä¿®é¥°ï¼Œå°†å¯¹è±¡æœ¬èº«äº¤ç”± Spring è¿›è¡Œç®¡ç† ã€‚\r\n\r\nå°è´´å£«ï¼šä¸ºäº†é˜…è¯»æ–¹ä¾¿ï¼Œmark() è¿”å›ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²æ›¿ä»£ï¼Œè¯»è€…æœ‹å‹åœ¨è¿”å›æ ‡ç¤ºæ—¶æœ€å¥½ä½¿ç”¨æšä¸¾å®šä¹‰ã€‚\r\n\r\næ¥ä¸‹æ¥ç»§ç»­æŸ¥çœ‹æŠ½è±¡ç­–ç•¥å·¥å‚å¦‚ä½•æ”¹é€ ï¼Œæ‰èƒ½æ»¡è¶³å¼€é—­åŸåˆ™ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1672474063847-3dacf3d3-dcdc-4219-9b74-47191e535764.png)\r\n\r\né€šè¿‡ InitializingBean æ¥å£å®ç°ä¸­è°ƒç”¨ IOC å®¹å™¨æŸ¥æ‰¾å¯¹åº”ç­–ç•¥å®ç°ï¼Œéšåå°†ç­–ç•¥å®ç° mark() æ–¹æ³•è¿”å›å€¼ä½œä¸º keyï¼Œ ç­–ç•¥å®ç°æœ¬èº«ä½œä¸º value æ·»åŠ åˆ° Map å®¹å™¨ä¸­ç­‰å¾…å®¢æˆ·ç«¯çš„è°ƒç”¨ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1672474079146-767a091f-05ec-4dd8-9d3d-379981a8d0bb.png)\r\n\r\nè¿™é‡Œä½¿ç”¨çš„ SpringBoot æµ‹è¯•ç±»ï¼Œæ³¨å…¥ç­–ç•¥å·¥å‚ Beanï¼Œé€šè¿‡ç­–ç•¥å·¥å‚é€‰æ‹©å‡ºå…·ä½“çš„ç­–ç•¥ç®—æ³•ç±»ï¼Œç»§è€Œé€šè¿‡ç®—æ³•è·å–åˆ°ä¼˜æƒ åçš„ä»·æ ¼ã€‚\r\n\r\næ€»ç»“ä¸‹æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬é€šè¿‡å’Œ Spring ç»“åˆçš„æ–¹å¼ï¼Œé€šè¿‡ç­–ç•¥è®¾è®¡æ¨¡å¼å¯¹æ–‡åˆçš„ä»£ç å—è¿›è¡Œäº†ä¸¤å—ä¼˜åŒ–ï¼šåº”å¯¹ä»£ç çš„å¤æ‚æ€§ï¼Œè®©å…¶æ»¡è¶³å¼€é—­åŸåˆ™ã€‚\r\n\r\næ›´å…·ä½“ä¸€äº›å‘¢å°±æ˜¯ **é€šè¿‡æŠ½è±¡ç­–ç•¥ç®—æ³•ç±»å‡å°‘ä»£ç çš„å¤æ‚æ€§ï¼Œç»§è€Œé€šè¿‡ Spring çš„ä¸€äº›ç‰¹æ€§åŒæ—¶æ»¡è¶³äº†å¼€é—­åŸåˆ™**ï¼Œç°åœ¨æ¥äº†æ–°éœ€æ±‚åªè¦æ·»åŠ æ–°çš„ç­–ç•¥ç±»å³å¯ï¼Œå¥å£®æ˜“æ‰©å±•ã€‚\r\n\r\n## ç­–ç•¥æ¨¡å¼ä¼˜ç¼ºç‚¹\r\n\r\nç­–ç•¥è®¾è®¡æ¨¡å¼çš„ä¼˜ç‚¹åŒ…æ‹¬ï¼š\r\n\r\n1. æé«˜äº†ä»£ç çš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼šç”±äºç®—æ³•çš„å®ç°ä¸ä½¿ç”¨ç›¸åˆ†ç¦»ï¼Œä½¿å¾—ä»£ç çš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§å¾—åˆ°æé«˜ã€‚å½“éœ€è¦ä¿®æ”¹æˆ–æ·»åŠ æ–°çš„ç®—æ³•æ—¶ï¼Œåªéœ€è¦å®šä¹‰æ–°çš„ç­–ç•¥ç±»ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ç¯å¢ƒç±»å³å¯ï¼Œè€Œæ— éœ€ä¿®æ”¹ç¯å¢ƒç±»çš„ä»£ç ã€‚\r\n2. æé«˜äº†ä»£ç çš„å¤ç”¨æ€§ï¼šç­–ç•¥è®¾è®¡æ¨¡å¼å°†ç®—æ³•çš„å®ç°å°è£…åœ¨ç­–ç•¥ç±»ä¸­ï¼Œä½¿å¾—ç®—æ³•å¯ä»¥è¢«å¤šä¸ªå®¢æˆ·ç«¯é‡å¤ä½¿ç”¨ï¼Œä»è€Œæé«˜äº†ä»£ç çš„å¤ç”¨æ€§ã€‚\r\n3. å¯ä»¥åŠ¨æ€åœ°åˆ‡æ¢ç®—æ³•ï¼šç­–ç•¥è®¾è®¡æ¨¡å¼å°†ç®—æ³•å°è£…åœ¨ç­–ç•¥ç±»ä¸­ï¼Œä½¿å¾—å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°æ›´æ”¹ç®—æ³•ï¼Œä»è€Œå®ç°ä¸åŒçš„åŠŸèƒ½å’Œè¡Œä¸ºã€‚è¿™æ ·å¯ä»¥ä½¿å¾—ç¨‹åºæ›´åŠ çµæ´»ï¼Œé€‚åº”ä¸åŒçš„éœ€æ±‚å’Œå˜åŒ–ã€‚\r\n4. ç®—æ³•å®ç°ä¸ä½¿ç”¨ç›¸åˆ†ç¦»ï¼šç­–ç•¥è®¾è®¡æ¨¡å¼å°†ç®—æ³•çš„å®ç°ä¸ä½¿ç”¨ç›¸åˆ†ç¦»ï¼Œä½¿å¾—ä»£ç æ›´åŠ æ¸…æ™°ã€ç®€æ´ã€æ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚ç”±äºç®—æ³•çš„å®ç°è¢«å°è£…åœ¨ç­–ç•¥ç±»ä¸­ï¼Œå®¢æˆ·ç«¯åªéœ€è¦å…³æ³¨å¦‚ä½•é€‰æ‹©å’Œä½¿ç”¨ä¸åŒçš„ç®—æ³•å³å¯ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—ä»£ç æ›´åŠ æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚\r\n5. å¯ä»¥é¿å…ä½¿ç”¨å¤§é‡çš„æ¡ä»¶è¯­å¥ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œéœ€è¦æ ¹æ®ä¸åŒçš„æ¡ä»¶æ¥é€‰æ‹©ä¸åŒçš„ç®—æ³•ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä»£ç ä¸­å‡ºç°å¤§é‡çš„æ¡ä»¶è¯­å¥ï¼Œä½¿å¾—ä»£ç éš¾ä»¥ç»´æŠ¤å’Œæ‰©å±•ã€‚è€Œç­–ç•¥è®¾è®¡æ¨¡å¼å¯ä»¥é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œä½¿å¾—ä»£ç æ›´åŠ ç®€æ´å’Œæ˜“äºç»´æŠ¤ã€‚\r\n\r\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨ç­–ç•¥è®¾è®¡æ¨¡å¼æ—¶éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š\r\n\r\n1. ç­–ç•¥ç±»ä¹‹é—´åº”è¯¥æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå½¼æ­¤ä¹‹é—´ä¸åº”è¯¥æœ‰ä»»ä½•ä¾èµ–å…³ç³»ã€‚è¿™æ ·æ‰èƒ½ç¡®ä¿ç®—æ³•çš„é€‰æ‹©å’Œæ›¿æ¢å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è¿›è¡Œï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é¿å…ä»£ç çš„è€¦åˆåº¦è¿‡é«˜ã€‚\r\n2. ç­–ç•¥æ¥å£åº”è¯¥å°½å¯èƒ½åœ°ç®€å•å’Œé€šç”¨ï¼Œä»¥ä¾¿äºä¸åŒçš„ç­–ç•¥å®ç°ç±»å¯ä»¥å…±ç”¨åŒä¸€ä¸ªæ¥å£ã€‚è¿™æ ·å¯ä»¥æé«˜ä»£ç çš„å¤ç”¨æ€§å’Œçµæ´»æ€§ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é¿å…æ¥å£è¿‡äºå¤æ‚å’Œéš¾ä»¥ç»´æŠ¤ã€‚\r\n3. ç­–ç•¥è®¾è®¡æ¨¡å¼é€‚ç”¨äºéœ€è¦åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢ç®—æ³•çš„åœºæ™¯ï¼Œå¦‚æœç®—æ³•çš„å®ç°ä¸éœ€è¦åŠ¨æ€åˆ‡æ¢ï¼Œæˆ–è€…ç®—æ³•çš„å®ç°è¾ƒä¸ºç®€å•ï¼Œç­–ç•¥è®¾è®¡æ¨¡å¼å¯èƒ½ä¼šæ˜¾å¾—è¿‡äºå¤æ‚ã€‚å› æ­¤ï¼Œåœ¨é€‰æ‹©ä½¿ç”¨ç­–ç•¥è®¾è®¡æ¨¡å¼æ—¶ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„éœ€æ±‚å’Œåœºæ™¯è¿›è¡Œåˆ¤æ–­å’Œé€‰æ‹©ã€‚\r\n4. ç­–ç•¥è®¾è®¡æ¨¡å¼å¯ä»¥ä¸å…¶ä»–è®¾è®¡æ¨¡å¼ç»“åˆä½¿ç”¨ï¼Œä¾‹å¦‚å·¥å‚æ–¹æ³•æ¨¡å¼ã€å•ä¾‹æ¨¡å¼ç­‰ã€‚è¿™æ ·å¯ä»¥è¿›ä¸€æ­¥æé«˜ä»£ç çš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é¿å…ä»£ç çš„å¤æ‚åº¦è¿‡é«˜ã€‚\r\n\r\n## æ¡†æ¶æºç åº”ç”¨\r\n\r\nè‡ªå·±ç”¨è‚¯å®šè§‰å¾—ä¸å¤Ÿï¼Œå¿…è¦æ—¶å€™è¿˜å¾—çœ‹çœ‹è®¾è®¡å¼€æºæ¡†æ¶æºç çš„å¤§ä½¬ä»¬å¦‚ä½•åœ¨ä»£ç ä¸­è¿ç”¨ç­–ç•¥æ¨¡å¼çš„ã€‚\r\n\r\nåœ¨é©¬å“¥äº†è§£ä¸­ï¼ŒJDKã€Springã€SpringMvcã€Mybatisã€Dubbo ç­‰ç­‰éƒ½è¿ç”¨äº†ç­–ç•¥è®¾è®¡æ¨¡å¼ï¼Œè¿™é‡Œå°±ä»¥ Mybatis ä¸¾ä¾‹è¯´æ˜ã€‚\r\n\r\nMybatis ä¸­ Executor ä»£è¡¨æ‰§è¡Œå™¨ï¼Œè´Ÿè´£å¢åˆ æ”¹æŸ¥çš„å…·ä½“æ“ä½œã€‚å…¶ä¸­ç”¨åˆ°äº†ä¸¤ç§è®¾è®¡æ¨¡å¼ï¼Œæ¨¡ç‰ˆæ–¹æ³•ä»¥åŠç­–ç•¥æ¨¡å¼ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1672474104169-3317d8bf-5313-470e-9626-4a317ccaf396.png)\r\n\r\n- Executor ä»£è¡¨äº†æŠ½è±¡ç­–ç•¥æ¥å£ï¼Œåˆšæ‰è¯´åˆ°çš„æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼æºè‡ª BaseExecutorã€‚\r\n- Configuration ä»£è¡¨ç­–ç•¥å·¥å‚ï¼Œè´Ÿè´£åˆ›å»ºå…·ä½“çš„ç­–ç•¥ç®—æ³•å®ç°ç±»ã€‚\r\n- SimpleExecutoã€ReuseExecutor... è¡¨ç¤ºå°è£…äº†å…·ä½“çš„ç­–ç•¥ç®—æ³•å®ç°ç±»ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1672474128984-76fc2c9a-91b8-4f34-8643-a64bd58bc4bf.png)\r\n\r\nä¸Šè¿°ä»£ç å—å‘ç”Ÿåœ¨ Configuration ç±»ä¸­åˆ›å»ºæ‰§è¡Œå™¨ Executorï¼Œé€šè¿‡ executorType åˆ¤æ–­åˆ›å»ºä¸åŒçš„ç­–ç•¥ç®—æ³•ã€‚\r\n\r\nä¸Šè¿°ä»£ç å—å¹¶æ²¡æœ‰å½»åº•æ¶ˆé™¤ if-elseï¼Œå› ä¸º Mybatis ä¸­æ‰§è¡Œå™¨ç­–ç•¥åŸºæœ¬æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒåªä¼šæœ‰è¿™äº› if-else åˆ¤æ–­ï¼ŒåŸºæœ¬ä¸ä¼šæ–°å¢æˆ–ä¿®æ”¹ã€‚å¦‚æœéè¦æ¶ˆé™¤ if-elseï¼Œå¯ä»¥è¿™ä¹ˆæï¼Œè¿™é‡Œå†™ä¸€ä¸‹ä¼ªä»£ç ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1672474150395-2d817442-442a-4e13-9df8-1642324d57d8.png)\r\n\r\nè¿™ç§æ–¹å¼å«åš **\"æŸ¥è¡¨æ³•\"**ï¼Œé€šè¿‡ç­–ç•¥å·¥å‚å®ç°æ¶ˆé™¤ if-else åˆ†æ”¯ã€‚æœ€åï¼ŒMybatis å¤ªè¿‡è¯¦ç»†çš„è®¾è®¡è¿™é‡Œä¸å†èµ˜è¿°ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å»æŠŠæºç ä¸‹è½½å•ƒä¸€å•ƒã€‚\r\n\r\nåˆ°äº†è¿™é‡Œå¯èƒ½æœ‰è¯»è€…çœ‹å‡ºäº†é—®é¢˜ï¼Œ**ç­–ç•¥æ¨¡å¼å°±ç®—æ¶ˆé™¤äº† if-else ä½†æ˜¯å¦‚æœæ·»åŠ æ–°çš„ç­–ç•¥ç±»ï¼Œä¸è¿˜æ˜¯ä¼šè¿åå¼€é—­åŸåˆ™ä¹ˆï¼Ÿ**\r\n\r\næ²¡é”™ï¼Œå› ä¸º Mybatis æœ¬èº«æ²¡æœ‰å¼•å…¥ Spring ä¾èµ–ï¼Œ**æ‰€ä»¥æ²¡æœ‰åŠæ³•å€ŸåŠ© IOC å®¹å™¨å®ç°å¼€é—­åŸåˆ™**ã€‚Spring æ˜¯ä¸€ç§å¼€é—­åŸåˆ™è§£å†³æ–¹å¼ï¼Œé‚£è¿˜æœ‰æ²¡æœ‰åˆ«çš„è§£å†³æ–¹å¼ï¼Ÿ\r\n\r\nè§£å†³æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¼€é—­åŸåˆ™æ ¸å¿ƒå°±æ˜¯ **å¯¹åŸæœ‰ä»£ç ä¿®æ”¹å…³é—­ï¼Œå¯¹æ–°å¢ä»£ç å¼€æ”¾**ã€‚å¯ä»¥é€šè¿‡æ‰«ææŒ‡å®šåŒ…ä¸‹çš„è‡ªå®šä¹‰æ³¨è§£äº¦æˆ–è€…é€šè¿‡ instanceof åˆ¤æ–­æ˜¯å¦ç»§æ‰¿è‡ªæŸæ¥å£éƒ½å¯ä»¥ã€‚\r\n\r\n## ç­–ç•¥æ¨¡å¼æŠ½è±¡\r\n\r\nå¯èƒ½ç»†å¿ƒçš„å°ä¼™ä¼´ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå½“ä¸šåŠ¡ä½¿ç”¨è¶Šæ¥è¶Šå¤šçš„æƒ…å†µä¸‹ï¼Œé‡å¤å®šä¹‰ `DiscountStrategy` ä»¥åŠ `DiscountStrategyFactory` ä¼šå¢åŠ ç³»ç»Ÿå†—ä½™ä»£ç é‡ã€‚\r\n\r\nå¯ä»¥è€ƒè™‘å°†è¿™ä¸¤ä¸ªåŸºç¡€ç±»æŠ½è±¡å‡ºæ¥ï¼Œä½œä¸ºåŸºç¡€ç»„ä»¶åº“ä¸­çš„é€šç”¨ç»„ä»¶ï¼Œä¾›æ‰€æœ‰ç³»ç»Ÿä¸‹çš„ä¸šåŠ¡ä½¿ç”¨ï¼Œä»è€Œé¿å…ä»£ç å†—ä½™ã€‚\r\n\r\nå®šä¹‰æŠ½è±¡ç­–ç•¥å¤„ç†æ¥å£ï¼Œæ·»åŠ æœ‰è¿”å›å€¼å’Œæ— è¿”å›å€¼æ¥å£ã€‚\r\n\r\n```java\r\n/**\r\n * ç­–ç•¥æ‰§è¡ŒæŠ½è±¡\r\n */\r\npublic interface AbstractExecuteStrategy<REQUEST, RESPONSE> {\r\n    \r\n    /**\r\n     * æ‰§è¡Œç­–ç•¥æ ‡è¯†\r\n     */\r\n    String mark();\r\n    \r\n    /**\r\n     * æ‰§è¡Œç­–ç•¥\r\n     *\r\n     * @param requestParam æ‰§è¡Œç­–ç•¥å…¥å‚\r\n     */\r\n    default void execute(REQUEST requestParam) {\r\n        \r\n    }\r\n    \r\n    /**\r\n     * æ‰§è¡Œç­–ç•¥ï¼Œå¸¦è¿”å›å€¼\r\n     *\r\n     * @param requestParam æ‰§è¡Œç­–ç•¥å…¥å‚\r\n     * @return æ‰§è¡Œç­–ç•¥åè¿”å›å€¼\r\n     */\r\n    default RESPONSE executeResp(REQUEST requestParam) {\r\n        return null;\r\n    }\r\n}\r\n```\r\n\r\næ·»åŠ ç­–ç•¥é€‰æ‹©å™¨ï¼Œé€šè¿‡è®¢é˜… Spring åˆå§‹åŒ–äº‹ä»¶æ‰§è¡Œæ‰«ææ‰€æœ‰ç­–ç•¥æ¨¡å¼æ¥å£æ‰§è¡Œå™¨ï¼Œå¹¶æ ¹æ® mark æ–¹æ³•å®šä¹‰æ ‡è¯†æ·»åŠ åˆ° `abstractExecuteStrategyMap` å®¹å™¨ä¸­ã€‚\r\n\r\nå®¢æˆ·ç«¯åœ¨å®é™…ä¸šåŠ¡ä¸­ä½¿ç”¨ `AbstractStrategyChoose#choose` å³å¯å®Œæˆç­–ç•¥æ¨¡å¼å®ç°ã€‚\r\n\r\n```java\r\n/**\r\n * ç­–ç•¥é€‰æ‹©å™¨\r\n */\r\npublic class AbstractStrategyChoose implements ApplicationListener<ApplicationInitializingEvent> {\r\n    \r\n    /**\r\n     * æ‰§è¡Œç­–ç•¥é›†åˆ\r\n     */\r\n    private final Map<String, AbstractExecuteStrategy> abstractExecuteStrategyMap = new HashMap<>();\r\n    \r\n    /**\r\n     * æ ¹æ® mark æŸ¥è¯¢å…·ä½“ç­–ç•¥\r\n     *\r\n     * @param mark ç­–ç•¥æ ‡è¯†\r\n     * @return å®é™…æ‰§è¡Œç­–ç•¥\r\n     */\r\n    public AbstractExecuteStrategy choose(String mark) {\r\n        return Optional.ofNullable(abstractExecuteStrategyMap.get(mark)).orElseThrow(() -> new ServiceException(String.format(\"[%s] ç­–ç•¥æœªå®šä¹‰\", mark)));\r\n    }\r\n    \r\n    /**\r\n     * æ ¹æ® mark æŸ¥è¯¢å…·ä½“ç­–ç•¥å¹¶æ‰§è¡Œ\r\n     *\r\n     * @param mark         ç­–ç•¥æ ‡è¯†\r\n     * @param requestParam æ‰§è¡Œç­–ç•¥å…¥å‚\r\n     * @param <REQUEST>    æ‰§è¡Œç­–ç•¥å…¥å‚èŒƒå‹\r\n     */\r\n    public <REQUEST> void chooseAndExecute(String mark, REQUEST requestParam) {\r\n        AbstractExecuteStrategy executeStrategy = choose(mark);\r\n        executeStrategy.execute(requestParam);\r\n    }\r\n    \r\n    /**\r\n     * æ ¹æ® mark æŸ¥è¯¢å…·ä½“ç­–ç•¥å¹¶æ‰§è¡Œï¼Œå¸¦è¿”å›ç»“æœ\r\n     *\r\n     * @param mark         ç­–ç•¥æ ‡è¯†\r\n     * @param requestParam æ‰§è¡Œç­–ç•¥å…¥å‚\r\n     * @param <REQUEST>    æ‰§è¡Œç­–ç•¥å…¥å‚èŒƒå‹\r\n     * @param <RESPONSE>   æ‰§è¡Œç­–ç•¥å‡ºå‚èŒƒå‹\r\n     * @return\r\n     */\r\n    public <REQUEST, RESPONSE> RESPONSE chooseAndExecuteResp(String mark, REQUEST requestParam) {\r\n        AbstractExecuteStrategy executeStrategy = choose(mark);\r\n        return (RESPONSE) executeStrategy.executeResp(requestParam);\r\n    }\r\n    \r\n    @Override\r\n    public void onApplicationEvent(ApplicationInitializingEvent event) {\r\n        Map<String, AbstractExecuteStrategy> actual = ApplicationContextHolder.getBeansOfType(AbstractExecuteStrategy.class);\r\n        actual.forEach((beanName, bean) -> {\r\n            AbstractExecuteStrategy beanExist = abstractExecuteStrategyMap.get(bean.mark());\r\n            if (beanExist != null) {\r\n                throw new ServiceException(String.format(\"[%s] Duplicate execution policy\", bean.mark()));\r\n            }\r\n            abstractExecuteStrategyMap.put(bean.mark(), bean);\r\n        });\r\n    }\r\n}\r\n```\r\n\r\nè¿™ä¸¤ä¸ªå®ç°å·²ç»è¢«æ”¾ç½®åœ¨åŸºç¡€ç»„ä»¶åº“ä¸­ï¼Œå¦‚æœä¸šåŠ¡éœ€è¦ä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Œåˆ™æ— éœ€é‡æ–°å®šä¹‰ã€‚\r\n\r\n\r\n\r\n## ç­–ç•¥æ¨¡å¼å®ç°\r\n\r\n### åˆ—è½¦åº§ä½é€‰æ‹©å™¨\r\n\r\n#### è´­ç¥¨æ—¶åˆ—è½¦åº§ä½é€‰æ‹©å™¨\r\n\r\n```java\r\n@Slf4j\r\n@Component\r\n@RequiredArgsConstructor\r\npublic final class TrainSeatTypeSelector {\r\n\r\n    ......\r\n    private final AbstractStrategyChoose abstractStrategyChoose;\r\n\r\n    public List<TrainPurchaseTicketRespDTO> select(Integer trainType, PurchaseTicketReqDTO requestParam) {\r\n       ......\r\n            List<TrainPurchaseTicketRespDTO> aggregationResult = abstractStrategyChoose.chooseAndExecuteResp(buildStrategyKey, selectSeatDTO);\r\n\t   ......\r\n    }\r\n}\r\n```\r\n\r\n#### æŠ½è±¡é«˜é“è´­ç¥¨æ¨¡æ¿åŸºç¡€æœåŠ¡\r\n\r\n```java\r\n@FunctionalInterface\r\npublic interface CommandLineRunner {\r\n    void run(String... args) throws Exception;\r\n}\r\n/**\r\n * è´­ç¥¨é¡¶çº§æŠ½è±¡æ¥å£ï¼Œä¸ºåç»­ç«è½¦ã€é«˜é“ã€æ±½è½¦ã€é£æœºç­‰å‡ºè¡Œå·¥å…·è§„å®šè¡Œä¸ºçº¦æŸ\r\n */\r\npublic interface IPurchaseTicket {\r\n}\r\n\r\n\r\npublic abstract class AbstractTrainPurchaseTicketTemplate implements IPurchaseTicket, CommandLineRunner, AbstractExecuteStrategy<SelectSeatDTO, List<TrainPurchaseTicketRespDTO>> {\r\n\r\n    private DistributedCache distributedCache;\r\n    private String ticketAvailabilityCacheUpdateType;\r\n\r\n    /**\r\n     * é€‰æ‹©åº§ä½\r\n     *\r\n     * @param requestParam è´­ç¥¨è¯·æ±‚å…¥å‚\r\n     * @return ä¹˜è½¦äººåº§ä½\r\n     */\r\n    protected abstract List<TrainPurchaseTicketRespDTO> selectSeats(SelectSeatDTO requestParam);\r\n\r\n    protected TrainSeatBaseDTO buildTrainSeatBaseDTO(SelectSeatDTO requestParam) {\r\n        return TrainSeatBaseDTO.builder()\r\n                .trainId(requestParam.getRequestParam().getTrainId())\r\n                .departure(requestParam.getRequestParam().getDeparture())\r\n                .arrival(requestParam.getRequestParam().getArrival())\r\n                .chooseSeatList(requestParam.getRequestParam().getChooseSeats())\r\n                .passengerSeatDetails(requestParam.getPassengerSeatDetails())\r\n                .build();\r\n    }\r\n\r\n    @Override\r\n    public List<TrainPurchaseTicketRespDTO> executeResp(SelectSeatDTO requestParam) {\r\n        List<TrainPurchaseTicketRespDTO> actualResult = selectSeats(requestParam);\r\n        // æ‰£å‡è½¦å¢ä½™ç¥¨ç¼“å­˜ï¼Œæ‰£å‡ç«™ç‚¹ä½™ç¥¨ç¼“å­˜\r\n        if (CollUtil.isNotEmpty(actualResult) && !StrUtil.equals(ticketAvailabilityCacheUpdateType, \"binlog\")) {\r\n            String trainId = requestParam.getRequestParam().getTrainId();\r\n            String departure = requestParam.getRequestParam().getDeparture();\r\n            String arrival = requestParam.getRequestParam().getArrival();\r\n            String keySuffix = StrUtil.join(\"_\", trainId, departure, arrival);\r\n            StringRedisTemplate stringRedisTemplate = (StringRedisTemplate) distributedCache.getInstance();\r\n            stringRedisTemplate.opsForHash().increment(TRAIN_STATION_REMAINING_TICKET + keySuffix, String.valueOf(requestParam.getSeatType()), -actualResult.size());\r\n        }\r\n        return actualResult;\r\n    }\r\n\r\n    @Override\r\n    public void run(String... args) throws Exception {\r\n        distributedCache = ApplicationContextHolder.getBean(DistributedCache.class);\r\n        ConfigurableEnvironment configurableEnvironment = ApplicationContextHolder.getBean(ConfigurableEnvironment.class);\r\n        ticketAvailabilityCacheUpdateType = configurableEnvironment.getProperty(\"ticket.availability.cache-update.type\", \"\");\r\n    }\r\n}\r\n```\r\n\r\n#### é«˜é“å„åº§ä½ç±»å‹è´­ç¥¨ç»„ä»¶\r\n\r\n```java\r\n/**\r\n * é«˜é“å•†åŠ¡åº§è´­ç¥¨ç»„ä»¶\r\n */\r\n@Component\r\n@RequiredArgsConstructor\r\npublic class TrainBusinessClassPurchaseTicketHandler extends AbstractTrainPurchaseTicketTemplate {\r\n\r\n    private final SeatService seatService;\r\n\r\n    private static final Map<Character, Integer> SEAT_Y_INT = Map.of('A', 0, 'C', 1, 'F', 2);\r\n\r\n    @Override\r\n    public String mark() {\r\n        return VehicleTypeEnum.HIGH_SPEED_RAIN.getName() + VehicleSeatTypeEnum.BUSINESS_CLASS.getName();\r\n    }\r\n\r\n    @Override\r\n    protected List<TrainPurchaseTicketRespDTO> selectSeats(SelectSeatDTO requestParam) {\r\n        ......\r\n    }\r\n\t......\r\n}\r\n\r\n/**\r\n * é«˜é“ä¸€ç­‰åº§è´­ç¥¨ç»„ä»¶\r\n */\r\n@Component\r\n@RequiredArgsConstructor\r\npublic class TrainFirstClassPurchaseTicketHandler extends AbstractTrainPurchaseTicketTemplate {\r\n\r\n    private final SeatService seatService;\r\n\r\n    private static final Map<Character, Integer> SEAT_Y_INT = Map.of('A', 0, 'C', 1, 'D', 2, 'F', 3);\r\n\r\n    @Override\r\n    public String mark() {\r\n        return VehicleTypeEnum.HIGH_SPEED_RAIN.getName() + VehicleSeatTypeEnum.FIRST_CLASS.getName();\r\n    }\r\n\r\n    @Override\r\n    protected List<TrainPurchaseTicketRespDTO> selectSeats(SelectSeatDTO requestParam) {\r\n         ......\r\n    }\r\n\t......\r\n}\r\n/**\r\n * é«˜é“äºŒç­‰åº§è´­ç¥¨ç»„ä»¶\r\n */\r\n@Component\r\n@RequiredArgsConstructor\r\npublic class TrainSecondClassPurchaseTicketHandler extends AbstractTrainPurchaseTicketTemplate {\r\n\r\n    private final SeatService seatService;\r\n    private final DistributedCache distributedCache;\r\n\r\n    @Override\r\n    public String mark() {\r\n        return VehicleTypeEnum.HIGH_SPEED_RAIN.getName() + VehicleSeatTypeEnum.SECOND_CLASS.getName();\r\n    }\r\n\r\n    @Override\r\n    protected List<TrainPurchaseTicketRespDTO> selectSeats(SelectSeatDTO requestParam) {\r\n          ......\r\n    }\r\n\t......\r\n}\r\n```\r\n\r\n#### åº”ç”¨é€‰æ‹©å™¨é€‰æ‹©å¹¶æ‰§è¡Œå…·ä½“ç­–ç•¥å¤„ç†å™¨\r\n\r\n```java\r\n/**\r\n * è½¦ç¥¨æ¥å£å®ç°\r\n */\r\n@Slf4j\r\n@Service\r\n@RequiredArgsConstructor\r\npublic class TicketServiceImpl extends ServiceImpl<TicketMapper, TicketDO> implements TicketService {\r\n    private final TrainSeatTypeSelector trainSeatTypeSelector;\r\n    ......\r\n    @Override\r\n    @Transactional(rollbackFor = Throwable.class)\r\n    public TicketPurchaseRespDTO executePurchaseTickets(PurchaseTicketReqDTO requestParam) \t   {\r\n        ......\r\n        List<TrainPurchaseTicketRespDTO> trainPurchaseTicketResults = trainSeatTypeSelector.select(trainDO.getTrainType(), requestParam);\r\n        ......\r\n    }\r\n    ......\r\n}\r\n        \r\n```\r\n\r\n### ç™»å½•é€‰æ‹©\r\n\r\n#### è´¦å·ç™»å½•\r\n\r\n##### ç™»å½•ç­–ç•¥æ‰§è¡Œå¤„ç†å™¨\r\n\r\n```java\r\n@Component\r\n@AllArgsConstructor\r\npublic class AccountLoginCommandHandler implements AbstractExecuteStrategy<UserLoginCommand, UserLoginRespDTO> {\r\n    \r\n    private final DistributedCache distributedCache;\r\n    private final CustomerUserRepository customerUserRepository;\r\n    \r\n    @Override\r\n    public String mark() {\r\n        return UserLoginTypeEnum.USER_LOGIN_ACCOUNT.toString();\r\n    }\r\n    \r\n    @Override\r\n    public UserLoginRespDTO executeResp(UserLoginCommand requestParam) {\r\n        CustomerUser customerUser = CustomerUser.builder()\r\n                .accountNumber(new CustomerUserAccountNumber(requestParam.getAccountNumber()))\r\n                .password(new CustomerUserPassword(requestParam.getPassword()))\r\n                .build();\r\n        CustomerUser actual = customerUserRepository.findByAccountNumber(requestParam.getAccountNumber());\r\n        if (actual == null) {\r\n            throw new ClientException(\"ç”¨æˆ·åä¸å­˜åœ¨\");\r\n        }\r\n        if (!Objects.equals(customerUser.getPassword(), actual.getPassword())) {\r\n            throw new ClientException(\"ç”¨æˆ·åå¯†ç é”™è¯¯\");\r\n        }\r\n        String accessToken = actual.generateAccessToken();\r\n        distributedCache.put(accessToken, JSON.toJSONString(actual), 30, TimeUnit.MINUTES);\r\n        return new UserLoginRespDTO(actual.getCustomerUserId(), actual.getUsername(), actual.getAccountNumber(), accessToken);\r\n    }\r\n}\r\n```\r\n\r\n#### é‚®ç®±ç™»å½•\r\n\r\n##### ç™»å½•ç­–ç•¥æ‰§è¡Œå¤„ç†å™¨\r\n\r\n```java\r\n@Component\r\n@AllArgsConstructor\r\npublic class MailLoginCommandHandler implements AbstractExecuteStrategy<UserLoginCommand, UserLoginRespDTO> {\r\n    \r\n    private final DistributedCache distributedCache;\r\n    \r\n    private final CustomerUserRepository customerUserRepository;\r\n    \r\n    @Override\r\n    public String mark() {\r\n        return UserLoginTypeEnum.USER_LOGIN_MAIL.name();\r\n    }\r\n    \r\n    @Override\r\n    public UserLoginRespDTO executeResp(UserLoginCommand requestParam) {\r\n        CustomerUser customerUser = CustomerUser.builder().verifyCode(requestParam.getMailValidCode()).build();\r\n        // è·å–ç¼“å­˜ä¸­çš„éªŒè¯ç \r\n        String verifyCode = distributedCache.get(CacheUtil.buildKey(LOGIN_USER_VERIFY_CODE, requestParam.getMail()), String.class);\r\n        // æ£€æŸ¥éªŒè¯ç æ­£ç¡®æ€§\r\n        customerUser.checkoutValidCode(verifyCode);\r\n        CustomerUser actual = customerUserRepository.findByMail(requestParam.getMail());\r\n        String accessToken = actual.generateAccessToken();\r\n        //todo\r\n        distributedCache.put(accessToken, JSON.toJSONString(actual), 30, TimeUnit.MINUTES);\r\n        return new UserLoginRespDTO(actual.getCustomerUserId(), actual.getUsername(), actual.getAccountNumber(), accessToken);\r\n    }\r\n}\r\n```\r\n\r\n##### æŠ½è±¡é‚®ç®±éªŒè¯ç å‘é€\r\n\r\n```java\r\npublic abstract class AbstractMailVerifySender {\r\n    \r\n    @Value(\"${customer.user.register.verify.sender}\")\r\n    private String sender;\r\n    \r\n    @Value(\"${customer.user.register.verify.template-id}\")\r\n    private String templateId;\r\n    \r\n    @Resource\r\n    private MessageSendRemoteService messageSendRemoteService;\r\n    \r\n    @Resource\r\n    private DistributedCache distributedCache;\r\n    \r\n    /**\r\n     * ç”¨æˆ·æ³¨å†ŒéªŒè¯ç è¶…æ—¶æ—¶é—´\r\n     */\r\n    private static final long REGISTER_USER_VERIFY_CODE_TIMEOUT = 300000;\r\n    \r\n    /**\r\n     * è·å–ç¼“å­˜å‰ç½® Key\r\n     *\r\n     * @return\r\n     */\r\n    protected abstract String getCachePrefixKey();\r\n    \r\n    /**\r\n     * é‚®ç®±éªŒè¯å‘é€\r\n     *\r\n     * @param requestParam\r\n     */\r\n    public void mailVerifySend(UserVerifyCodeCommand requestParam) {\r\n        String verifyCode = RandomUtil.randomNumbers(6);\r\n        // æ¨¡æ¿æ–¹æ³•æ¨¡å¼: éªŒè¯ç æ”¾å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´\r\n        distributedCache.put(CacheUtil.buildKey(getCachePrefixKey(), requestParam.getReceiver()), verifyCode, REGISTER_USER_VERIFY_CODE_TIMEOUT);\r\n        MailSendRemoteCommand remoteCommand = new MailSendRemoteCommand();\r\n        remoteCommand.setTitle(\"é‚®ç®±éªŒè¯ç æé†’\")\r\n                .setReceiver(requestParam.getReceiver())\r\n                .setSender(sender)\r\n                .setTemplateId(templateId)\r\n                .setParamList(Lists.newArrayList(verifyCode));\r\n        messageSendRemoteService.mailMessageSend(remoteCommand);\r\n    }\r\n}\r\n```\r\n\r\n##### ç”¨æˆ·æ³¨å†Œä½¿ç”¨é‚®ç®±éªŒè¯ç­–ç•¥æ‰§è¡Œå¤„ç†å™¨\r\n\r\n```java\r\n@Component\r\n@RequiredArgsConstructor\r\npublic class MailRegisterVerifyCommandHandler extends AbstractMailVerifySender implements AbstractExecuteStrategy<UserVerifyCodeCommand, Void> {\r\n    \r\n    @Override\r\n    public String mark() {\r\n        return \"customer_user_register_mail\";\r\n    }\r\n    \r\n    @Override\r\n    public void execute(UserVerifyCodeCommand requestParam) {\r\n        mailVerifySend(requestParam);\r\n    }\r\n    \r\n    @Override\r\n    protected String getCachePrefixKey() {\r\n        return CacheConstant.REGISTER_USER_VERIFY_CODE;\r\n    }\r\n}\r\n```\r\n\r\n##### ç”¨æˆ·ç™»å½•ä½¿ç”¨é‚®ç®±éªŒè¯ç­–ç•¥æ‰§è¡Œå¤„ç†å™¨\r\n\r\n```java\r\n@Component\r\npublic class MailLoginVerifyCommandHandler extends AbstractMailVerifySender implements AbstractExecuteStrategy<UserVerifyCodeCommand, Void> {\r\n    \r\n    @Override\r\n    public String mark() {\r\n        return \"customer_user_login_verify_mail\";\r\n    }\r\n    \r\n    @Override\r\n    public void execute(UserVerifyCodeCommand requestParam) {\r\n        mailVerifySend(requestParam);\r\n    }\r\n    \r\n    @Override\r\n    protected String getCachePrefixKey() {\r\n        return CacheConstant.LOGIN_USER_VERIFY_CODE;\r\n    }\r\n}\r\n```\r\n\r\n##### C ç«¯ç”¨æˆ·æ¥å£é€‰æ‹©å¹¶æ‰§è¡Œå…·ä½“ç­–ç•¥å¤„ç†å™¨\r\n\r\n```java\r\n@Service\r\n@AllArgsConstructor\r\npublic class CustomerUserServiceImpl implements CustomerUserService {\r\n    \r\n    private final DistributedCache distributedCache;\r\n    private final AbstractStrategyChoose abstractStrategyChoose;\r\n    private final CommandHandler<UserRegisterCommand, UserRegisterRespDTO> customerUserRegisterCommandHandler;\r\n    \r\n    @Override\r\n    public void verifyCodeSend(UserVerifyCodeCommand requestParam) {\r\n        String mark = requestParam.getType() + \"_\" + requestParam.getPlatform();\r\n        /**\r\n         * site\r\n         * {@link MailLoginVerifyCommandHandler}\r\n         * {@link MailRegisterVerifyCommandHandler}\r\n         * ...\r\n         */\r\n        // ç­–ç•¥æ¨¡å¼: æ ¹æ® mark é€‰æ‹©ç”¨æˆ·ç™»å½•æˆ–è€…æ³¨å†Œé€»è¾‘\r\n        abstractStrategyChoose.chooseAndExecute(mark, requestParam);\r\n    }\r\n    \r\n    @Override\r\n    public UserRegisterRespDTO register(UserRegisterCommand requestParam) {\r\n        UserRegisterRespDTO result = customerUserRegisterCommandHandler.handler(requestParam);\r\n        return result;\r\n    }\r\n    \r\n    @Override\r\n    public UserLoginRespDTO login(UserLoginCommand requestParam) {\r\n        /**\r\n         * site\r\n         * {@link MailLoginCommandHandler}\r\n         */\r\n        return abstractStrategyChoose.chooseAndExecuteResp(requestParam.getLoginType(), requestParam);\r\n    }\r\n    \r\n    @Override\r\n    public UserLoginRespDTO checkLogin(String accessToken) {\r\n        return distributedCache.get(accessToken, UserLoginRespDTO.class);\r\n    }\r\n    \r\n    @Override\r\n    public void logout(String accessToken) {\r\n        if (StrUtil.isNotBlank(accessToken)) {\r\n            distributedCache.delete(accessToken);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n**C ç«¯ç”¨æˆ·æ³¨å†Œå¤„ç†å™¨**\r\n\r\n```java\r\n@Component\r\n@AllArgsConstructor\r\npublic class CustomerUserRegisterCommandHandler implements CommandHandler<UserRegisterCommand, UserRegisterRespDTO> {\r\n    \r\n    private final CustomerUserRepository customerUserRepository;\r\n    \r\n    private final CustomerUserToDTOAssembler customerUserAssembler;\r\n    \r\n    private final DistributedCache distributedCache;\r\n    \r\n    @Override\r\n    public UserRegisterRespDTO handler(UserRegisterCommand requestParam) {\r\n        CustomerUser customerUser = CustomerUser.builder()\r\n                .username(new CustomerUserName(requestParam.getUsername()))\r\n                .phone(new CustomerUserPhone(requestParam.getPhone()))\r\n                .accountNumber(new CustomerUserAccountNumber(requestParam.getAccountNumber()))\r\n                .password(new CustomerUserPassword(requestParam.getPassword()))\r\n                .mail(new CustomerUserMail(requestParam.getMail()))\r\n                .receiver(requestParam.getMail())\r\n                .verifyCode(requestParam.getMailValidCode())\r\n                .build();\r\n        // è·å–ç¼“å­˜ä¸­çš„éªŒè¯ç \r\n        String buildKey = CacheUtil.buildKey(REGISTER_USER_VERIFY_CODE, customerUser.getReceiver());\r\n        String verifyCode = distributedCache.get(buildKey, String.class);\r\n        // æ£€æŸ¥éªŒè¯ç æ­£ç¡®æ€§\r\n        customerUser.checkoutValidCode(verifyCode);\r\n        CustomerUser result = customerUserRepository.register(customerUser);\r\n        // åˆ é™¤ç¼“å­˜éªŒè¯ç \r\n        distributedCache.delete(buildKey);\r\n        return customerUserAssembler.customerUserToUserRegisterRespDTO(result);\r\n    }\r\n}\r\n```\r\n\r\n## æ–‡æœ«æ€»ç»“\r\n\r\næ€»çš„æ¥è¯´ï¼Œç­–ç•¥æ¨¡å¼æ˜¯ä¸€ç§éå¸¸æœ‰ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°é€‰æ‹©ä¸åŒçš„ç®—æ³•å®ç°ï¼Œä»è€Œæé«˜ä»£ç çš„çµæ´»æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚\r\n\r\né€šè¿‡å°†ç®—æ³•å®ç°å°è£…åœ¨ä¸åŒçš„ç­–ç•¥ç±»ä¸­ï¼Œå¹¶å®šä¹‰ä¸€ä¸ªç­–ç•¥æ¥å£æ¥æè¿°ç®—æ³•ï¼Œç­–ç•¥æ¨¡å¼ä½¿å¾—å®¢æˆ·ç«¯å¯ä»¥ç‹¬ç«‹äºç®—æ³•å®ç°è¿›è¡Œç¼–ç¨‹ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ–¹ä¾¿åœ°æ›´æ¢ç®—æ³•å®ç°æˆ–è€…æ·»åŠ æ–°çš„ç®—æ³•å®ç°ã€‚\r\n\r\nç­–ç•¥æ¨¡å¼çš„ä¼˜ç‚¹åŒ…æ‹¬æé«˜ä»£ç çš„çµæ´»æ€§ã€å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œå¤ç”¨æ€§ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é¿å…ä½¿ç”¨å¤§é‡çš„æ¡ä»¶è¯­å¥å’Œæé«˜ä»£ç çš„å¯è¯»æ€§ã€‚\r\n\r\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ—¶éœ€è¦éµå¾ªä¸€äº›è®¾è®¡åŸåˆ™ï¼Œä¾‹å¦‚å¼€é—­åŸåˆ™ã€å•ä¸€èŒè´£åŸåˆ™å’Œä¾èµ–å€’ç½®åŸåˆ™ç­‰ï¼Œä»¥ç¡®ä¿ä»£ç çš„é«˜å†…èšæ€§å’Œä½è€¦åˆåº¦ã€‚\r\n\r\næ­¤å¤–ï¼Œç­–ç•¥æ¨¡å¼é€‚ç”¨äºéœ€è¦åœ¨è¿è¡Œæ—¶åŠ¨æ€é€‰æ‹©ä¸åŒç®—æ³•å®ç°çš„åœºæ™¯ï¼Œå¦‚æœç®—æ³•å®ç°ä¸éœ€è¦åŠ¨æ€åˆ‡æ¢æˆ–è€…ç®—æ³•å®ç°è¾ƒä¸ºç®€å•ï¼Œç­–ç•¥æ¨¡å¼å¯èƒ½ä¼šæ˜¾å¾—è¿‡äºå¤æ‚ã€‚\r\n\r\nå› æ­¤ï¼Œåœ¨ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ—¶éœ€è¦æ ¹æ®å…·ä½“çš„éœ€æ±‚å’Œåœºæ™¯è¿›è¡Œåˆ¤æ–­å’Œé€‰æ‹©ã€‚"},{"title":"å¦‚ä½•ä½¿ç”¨çº¿ç¨‹æ± ä¸å®¹æ˜“å‡ºæ•…éšœ","tags":["çº¿ç¨‹æ± ","BlockingQueue","ThreadPoolExecutor"],"categories":["Java","å¾®ç³»ç»Ÿä¸ç¬¬ä¸‰æ–¹æ¡†æ¶"],"author":"imklaus","excerpt":"\r\n\r\nä½ æ˜¯å¦åœ¨é¡¹ç›®ä¸­ä½¿ç”¨çº¿ç¨‹æ± é‡åˆ°è¿‡ä»¥ä¸‹é—®é¢˜ï¼Ÿ\r\n\r\n- åˆ›å»ºçº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°ä¸å¥½è¯„ä¼°ï¼Œéšç€ä¸šåŠ¡æµé‡çš„æ³¢åŠ¨ï¼Œææœ‰å¯èƒ½å‡ºç°ç”Ÿäº§æ•…éšœã€‚\r\n- ä¸æ”¯æŒä¼˜é›…å…³é—­ï¼Œå½“é¡¹ç›®å…³é—­æ—¶ï¼Œå¤§é‡æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ± ä»»åŠ¡è¢«ä¸¢å¼ƒã€‚\r\n- ä¸æ”¯æŒè¿è¡Œæ—¶ç›‘æ§ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­ä¸šåŠ¡æ— å“åº”ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯çº¿ç¨‹æ± å¼•èµ·ã€‚\r\n- ä¸‰æ–¹æ¡†æ¶ RocketMQã€Dubbo ç­‰çº¿ç¨‹æ± æ— æ³•åŠ¨æ€ä¿®æ”¹å‚æ•°ï¼Œä¿®æ”¹ååªèƒ½é‡å¯åº”ç”¨ã€‚\r\n","link":"/posts/DynamicThreadPool","content":"\r\n\r\nä½ æ˜¯å¦åœ¨é¡¹ç›®ä¸­ä½¿ç”¨çº¿ç¨‹æ± é‡åˆ°è¿‡ä»¥ä¸‹é—®é¢˜ï¼Ÿ\r\n\r\n- åˆ›å»ºçº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°ä¸å¥½è¯„ä¼°ï¼Œéšç€ä¸šåŠ¡æµé‡çš„æ³¢åŠ¨ï¼Œææœ‰å¯èƒ½å‡ºç°ç”Ÿäº§æ•…éšœã€‚\r\n- ä¸æ”¯æŒä¼˜é›…å…³é—­ï¼Œå½“é¡¹ç›®å…³é—­æ—¶ï¼Œå¤§é‡æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ± ä»»åŠ¡è¢«ä¸¢å¼ƒã€‚\r\n- ä¸æ”¯æŒè¿è¡Œæ—¶ç›‘æ§ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­ä¸šåŠ¡æ— å“åº”ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯çº¿ç¨‹æ± å¼•èµ·ã€‚\r\n- ä¸‰æ–¹æ¡†æ¶ RocketMQã€Dubbo ç­‰çº¿ç¨‹æ± æ— æ³•åŠ¨æ€ä¿®æ”¹å‚æ•°ï¼Œä¿®æ”¹ååªèƒ½é‡å¯åº”ç”¨ã€‚\r\n<!-- more -->\r\nåœ¨çœŸå®ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œçº¿ç¨‹æ± å¯èƒ½é‡åˆ°çš„é—®é¢˜æ¯”è¿™é‡Œæè¿°çš„è¿˜è¦å¤šï¼Œç¨€å¥‡å¤æ€ªã€‚\r\n\r\nç¬”è€…æ‰€ç»å†è¿‡çš„é¡¹ç›®ï¼Œå› ä¸ºä¸šåŠ¡å¯¹çº¿ç¨‹æ± å‚æ•°æ²¡æœ‰åˆç†é…ç½®ï¼Œå°±è§¦å‘è¿‡å‡ èµ·ç”Ÿäº§äº‹æ•…ã€‚å¤§æ¦‚åœ¨ 21 å¹´ 6 æœˆä»½å·¦å³ï¼Œå¼€å§‹åœ¨ç½‘ä¸Šæœç´¢åŠ¨æ€çº¿ç¨‹æ± çš„é¡¹ç›®ã€‚\r\n\r\nåœ¨å¼€æºå¹³å°æ‰¾äº†æŒºå¤šåŠ¨æ€çº¿ç¨‹æ± é¡¹ç›®ï¼Œä»åŠŸèƒ½æ€§ä»¥åŠå¥å£®æ€§è€Œè¨€ï¼Œä¸ªäººæ„Ÿè§‰ä¸æ»¡è¶³ä¼ä¸šçº§åº”ç”¨ã€‚\r\n\r\nå†åŠ ä¸Šå½“æ—¶çœ‹äº†ç¾å›¢åŠ¨æ€çº¿ç¨‹çš„æ–‡ç« ï¼Œå°±å¯¹è¿™ä¸ªæŠ€æœ¯æ–¹å‘æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œæ‰€ä»¥å†³å®šè‡ªå·±æ¥é€ ä¸€ä¸ªè½»é‡çº§çš„è½®å­ã€‚\r\n\r\n> æˆ‘è§‰å¾—å†™ä¸€ä¸ªåä¸­é—´ä»¶çš„æ¡†æ¶ï¼Œè¿˜èƒ½å¸®åŠ©ç”¨æˆ·è§£å†³å®é™…é—®é¢˜ï¼Œæ˜¯ä¸€ä»¶å¾ˆé…·çš„äº‹æƒ…ã€‚\r\n\r\nGitHubï¼š[https://github.com/opengoofy/hippo4j(opens new window)](https://github.com/opengoofy/hippo4j)\r\n\r\nGiteeï¼š[https://gitee.com/opengoofy/hippo4j(opens new window)](https://gitee.com/opengoofy/hippo4j)\r\n\r\n## æ ¸å¿ƒåŠŸèƒ½\r\n\r\né€šè¿‡å¯¹ JDK çº¿ç¨‹æ± çš„å¢å¼ºï¼Œä»¥åŠæ‰©å±•ä¸‰æ–¹æ¡†æ¶åº•å±‚çº¿ç¨‹æ± ç­‰åŠŸèƒ½ï¼Œä¸ºä¸šåŠ¡ç³»ç»Ÿæé«˜çº¿ä¸Šè¿è¡Œä¿éšœèƒ½åŠ›ã€‚\r\n\r\nHippo4j æ¡†æ¶æä¾›ä»¥ä¸‹åŠŸèƒ½æ”¯æŒï¼š\r\n\r\n1. å®¢æˆ·ç«¯åº”ç”¨è¿è¡Œæ—¶å®æ—¶å˜æ›´æŒ‡å®šçº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°ï¼Œå˜æ›´ç”Ÿæ•ˆæ”¯æŒé›†ç¾¤å’Œå•å®ä¾‹ä¸¤ç§æ–¹å¼ã€‚\r\n2. çº¿ç¨‹æ± è¿è¡Œæ—¶å¼‚å¸¸æŠ¥è­¦ï¼Œæ¯”å¦‚ï¼šçº¿ç¨‹æ± æ´»è·ƒåº¦ã€é˜»å¡é˜Ÿåˆ—å®¹é‡æ°´ä½è¾ƒé«˜ï¼Œè§¦å‘äº†æ‹’ç»ç­–ç•¥ä»¥åŠä»»åŠ¡è¿è¡Œæ—¶é—´è¶…é•¿ç­‰ã€‚\r\n3. å®šæ—¶ä»»åŠ¡ï¼ˆé»˜è®¤5ç§’ï¼‰é‡‡é›†çº¿ç¨‹æ± è¿è¡Œæ•°æ®ï¼Œå¯ä¸ŠæŠ¥ Prometheusã€InfluxDB ç­‰æ•°æ®åº“ï¼Œæ­é… Grafana åšå¤§å±å±•ç¤ºã€‚\r\n4. è¿è¡Œè¿‡ç¨‹ä¸­æ”¯æŒå®æ—¶æŸ¥çœ‹çº¿ç¨‹æ± å½“å‰è¿è¡ŒçŠ¶æ€ä»¥åŠçº¿ç¨‹æ± å†…çº¿ç¨‹çš„å †æ ˆä¿¡æ¯ã€‚\r\n5. æ”¯æŒ Tomcatã€Undertow å’Œ Jetty å®¹å™¨çº¿ç¨‹æ± è¿è¡Œæ—¶æŸ¥çœ‹å’ŒåŠ¨æ€å˜æ›´çº¿ç¨‹æ± é…ç½®ã€‚\r\n6. æ”¯æŒ Dubboã€Hystrixã€Kafkaã€RabbitMQã€RocketMQ ç­‰å®¢æˆ·ç«¯çº¿ç¨‹æ± è¿è¡Œæ—¶æ•°æ®æŸ¥çœ‹å’ŒåŠ¨æ€å˜æ›´çº¿ç¨‹æ± é…ç½®ã€‚\r\n\r\n## åº”ç”¨åœºæ™¯\r\n\r\n### 1. åŠ¨æ€è°ƒå‚\r\n\r\nGoogle æˆ–è€…ç™¾åº¦æœç´¢çº¿ç¨‹æ± å’Œç”Ÿäº§äº‹æ•…å…³é”®å­—ï¼Œå‡ é¡µéƒ½æ”¾ä¸ä¸‹ï¼Œè¿™ä¹Ÿé—´æ¥è¯´æ˜äº†çº¿ç¨‹æ± æ˜¯ä¸ªå¾ˆè€ƒéªŒä½¿ç”¨è€…æŠ€æœ¯åŠŸåº•çš„æŠ€æœ¯ç‚¹ã€‚\r\n\r\né‚£æœ‰æ²¡æœ‰ä¸€äº›æŠ€å·§æˆ–è€…æŠ€æœ¯æ¥å°½é‡è§„é¿çº¿ç¨‹æ± ä½¿ç”¨ä¸Šçš„é—®é¢˜ï¼Ÿæ¯”å¦‚ï¼šçº¿ç¨‹æ± çš„é…ç½®åº”è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230329231743302.png)\r\n\r\næˆ‘è§‰å¾—å¤§å®¶å¯¹äºçº¿ç¨‹æ± å‚æ•°çš„çº ç»“ç‚¹ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œæ— å¤–ä¹è®¾ç½®çš„çº¿ç¨‹æ•°å¤šäº†æˆ–è€…å°‘äº†ã€‚\r\n\r\n- å¦‚æœé¢„è®¾çš„çº¿ç¨‹æ•°æˆ–é˜»å¡é˜Ÿåˆ—æ•°é‡å°‘äº†ï¼Œå½“ä¸šåŠ¡é‡ä¸Šæ¥ï¼Œä»»åŠ¡éƒ½åœ¨æ’é˜Ÿæˆ–è€…æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚\r\n- å¦‚æœè¶…é‡è®¾ç½®çº¿ç¨‹æ± çš„å‚æ•°ï¼Œæ— ç–‘ä¼šé€ æˆèµ„æºæµªè´¹ã€‚\r\n\r\nå¦‚æœè¦ä¿®æ”¹è¿è¡Œä¸­åº”ç”¨çº¿ç¨‹æ± å‚æ•°ï¼Œéœ€è¦åœæ­¢çº¿ä¸Šåº”ç”¨ï¼Œè°ƒæ•´æˆåŠŸåå†å‘å¸ƒï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹å¼‚å¸¸çš„ç¹çï¼Œå¦‚æœèƒ½åœ¨è¿è¡Œä¸­åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± çš„å‚æ•°æ— ç–‘ä¼šæé«˜é—®é¢˜è§£å†³æ•ˆç‡ã€‚\r\n\r\n![image-20250320014617260](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320014617260.png)\r\n\r\nHippo4j æä¾›äº†åº”ç”¨çº¿ç¨‹æ± è¿è¡Œæ—¶å˜æ›´æ ¸å¿ƒå‚æ•°çš„åŠŸèƒ½ã€‚è€Œä¸”ï¼Œå¦‚æœåº”ç”¨æ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œå¯ä»¥é€‰æ‹©ä¿®æ”¹çº¿ç¨‹æ± æŸä¸€å®ä¾‹ï¼Œæˆ–è€…ä¿®æ”¹é›†ç¾¤å…¨éƒ¨å®ä¾‹ï¼Œè¿è¡Œæ—¶ç”Ÿæ•ˆï¼Œä¸éœ€è¦å†é‡å¯æœåŠ¡ã€‚\r\n\r\nå‹æµ‹æ—¶å¯ä»¥ä½¿ç”¨ Hippo4j åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ï¼Œåˆ¤æ–­çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°è®¾ç½®æ˜¯å¦åˆç†ã€‚å¯¹äºå¼€å‘æµ‹è¯•æ¥è¯´ï¼Œå¦‚æœä¸æ»¡è¶³å¯ä»¥éšæ—¶è°ƒæ•´ã€‚\r\n\r\n![image-20250320014821256](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320014821256.png)\r\n\r\n### 2. å‘Šè­¦ç­–ç•¥\r\n\r\nå¾ˆå¤šæ—¶å€™ï¼Œçº¿ç¨‹æ± å‡ºæ•…éšœçš„æ—¶å€™ï¼Œç³»ç»Ÿå·²ç»å‘ç”Ÿäº†å¾ˆä¸¥é‡çš„æŸå¤±ã€‚æœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼ï¼Œåœ¨ä½¿ç”¨çš„çº¿ç¨‹æ± å³å°†å‡ºç°é—®é¢˜ï¼Œä½†è¿˜ç®—æ¯”è¾ƒå¯æ§æ—¶ï¼Œè§¦å‘ç›¸å…³æŠ¥è­¦æç¤ºç»™ç”¨æˆ·ï¼Œè¿›è€Œè§„é¿è¯¥é—®é¢˜ï¼Ÿ\r\n\r\nHippo4j åŸºäºä¸Šè¿°é—®é¢˜æ€è€ƒï¼Œé›†æˆäº†å››ç§æŠ¥è­¦ç­–ç•¥ï¼š\r\n\r\n- æ´»è·ƒåº¦ï¼šå‡è®¾é˜ˆå€¼è®¾ç½® 80%ï¼Œçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•° 10ï¼Œå½“çº¿ç¨‹æ•°è¾¾åˆ° 8 å‘èµ·æŠ¥è­¦ã€‚\r\n- é˜»å¡é˜Ÿåˆ—å®¹é‡ï¼šå‡è®¾é˜ˆå€¼è®¾ç½® 80%ï¼Œé˜»å¡é˜Ÿåˆ—å®¹é‡ 100ï¼Œå½“å®¹é‡è¾¾åˆ° 80 å‘èµ·æŠ¥è­¦ã€‚\r\n- è§¦å‘æ‹’ç»ç­–ç•¥ï¼šå½“çº¿ç¨‹æ± ä»»åŠ¡è§¦å‘äº†æ‹’ç»ç­–ç•¥æ—¶ï¼Œå‘èµ·æ‹’ç»ç­–ç•¥æŠ¥è­¦ã€‚\r\n- ä»»åŠ¡è¿è¡Œè¶…æ—¶ï¼šå‡è®¾ç”¨æˆ·è®¾ç½®å•ä¸ªä»»åŠ¡æ­£å¸¸æ‰§è¡Œæ˜¯ 1000msï¼Œå®é™…æ‰§è¡Œè¶…è¿‡è¯¥æ—¶é—´å‘èµ·æŠ¥è­¦ã€‚\r\n\r\næ”¯æŒé’‰é’‰ã€ä¼ä¸šå¾®ä¿¡å’Œé£ä¹¦è½¯ä»¶é€šçŸ¥ï¼Œä¸‹å›¾ä»¥çº¿ç¨‹æ± ä»»åŠ¡è¿è¡Œè¶…æ—¶æŠ¥è­¦ä¸¾ä¾‹ï¼š\r\n\r\n![image-20250320014910434](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320014910434.png)\r\n\r\n### 3. çº¿ç¨‹æ± ç›‘æ§\r\n\r\nHippo4j çº¿ç¨‹æ± æä¾›äº†ä¸¤ç§ç›‘æ§æ–¹å¼ï¼šçº¿ç¨‹æ± è¿è¡Œæ—¶æ•°æ®é‡‡é›†ç›‘æ§ä»¥åŠå®¢æˆ·ç«¯çº¿ç¨‹æ± è¿è¡Œå®æ—¶çŠ¶æ€æŸ¥çœ‹ã€‚\r\n\r\n1ï¼‰çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°ç›‘æ§ã€‚\r\n\r\n![image-20250320014940650](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320014940650.png)\r\n\r\n2ï¼‰çº¿ç¨‹æ± å®ä¾‹è¿è¡Œæ—¶çŠ¶æ€ã€‚\r\n\r\n![image-20250320015015485](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320015015485.png)\r\n\r\nçº¿ç¨‹æ± è¿è¡Œæ—¶æ•°æ®é‡‡é›†é€‚åˆåº”ç”¨è´Ÿè´£äººå·¡æŸ¥åº”ç”¨å¥åº·çŠ¶æ€å’Œæ’æŸ¥é—®é¢˜æ—¶ä½¿ç”¨ï¼Œå®æ—¶çŠ¶æ€é€‚åˆæ’æŸ¥å¤šå®ä¾‹ä¹‹é—´çš„è¿è¡Œæ•°æ®çŠ¶æ€ã€‚\r\n\r\n### 4. æ¡†æ¶åº•å±‚çº¿ç¨‹æ± \r\n\r\nä¸Šé¢è®²çš„åŠ¨æ€çº¿ç¨‹æ± æ˜¯ä¸šåŠ¡ä¸­å¼€å‘äººå‘˜æ‰‹åŠ¨åˆ›å»ºçš„çº¿ç¨‹æ± ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªï¼š\r\n\r\n```java\r\n@Bean\r\n@DynamicThreadPool\r\npublic ThreadPoolExecutor messageConsumeDynamicExecutor() {\r\n  String threadPoolId = \"message-consume\";\r\n  return ThreadPoolBuilder.builder()\r\n    .threadFactory(threadPoolId)\r\n    .threadPoolId(threadPoolId)\r\n    .dynamicPool()\r\n    .build();\r\n}\r\n```\r\n\r\nè€Œæ¡†æ¶çº¿ç¨‹æ± æŒ‡çš„æ˜¯æŸäº›ä¸‰æ–¹ä¸­é—´ä»¶åº•å±‚ä½¿ç”¨åˆ°çš„çº¿ç¨‹æ± ï¼Œæ¯”å¦‚ Dubboã€RocketMQ ç­‰æ¡†æ¶ï¼Œè¿™äº›åº•å±‚æ¡†æ¶ä¸ºäº†å¢å¼ºæ€§èƒ½é€‰æ‹©ä½¿ç”¨çº¿ç¨‹æ± è¿›è¡Œæ‰©å±•ã€‚\r\n\r\nä¸ºä»€ä¹ˆè¦é€‚é…è¿™äº›ä¸­é—´ä»¶æ¡†æ¶çš„çº¿ç¨‹æ± ï¼Ÿ\r\n\r\nç›¸ä¿¡è¿™æ˜¯å¾ˆå¤šå°ä¼™ä¼´çš„ç–‘é—®ã€‚ä»¥ Dubbo ä¸¾ä¾‹ï¼Œå½“æœåŠ¡é«˜å¹¶å‘è°ƒç”¨æ—¶ï¼Œå¦‚æœ Dubbo åº•å±‚çº¿ç¨‹æ± æ²¡æœ‰ç»è¿‡ä¸ªæ€§åŒ–é…ç½®ï¼Œææœ‰å¯èƒ½å¯¼è‡´çº¿ç¨‹æ± æ‰“æ»¡ï¼Œæœ€ç»ˆå¯¼è‡´æ— æ³•æä¾›æœåŠ¡ã€‚\r\n\r\nå½“é‡åˆ°è¿™ç§æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ Hippo4j å¯¹ Dubbo çº¿ç¨‹æ± è¿›è¡Œæ ¸å¿ƒå‚æ•°è°ƒæ•´ï¼Œé¿å…ç”Ÿäº§æ•…éšœæ—¶é—´æŒç»­ã€‚\r\n\r\nå†ä¸¾ä¸ªä¾‹å­ï¼Œå½“ RocketMQ æ¶ˆæ¯ç§¯å‹æ—¶ï¼Œå¯èƒ½å¤§éƒ¨åˆ†å…¬å¸çš„è§£å†³æ–¹æ¡ˆæ˜¯æ·»åŠ å®¢æˆ·ç«¯åº”ç”¨èŠ‚ç‚¹ã€‚è€Œè¿™ç§æ–¹å¼è™½ç„¶å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¤ªå¤æ‚ä¸”èµ„æºæµªè´¹ã€‚å®Œå…¨å¯ä»¥è°ƒæ•´ RocketMQ SDK åº•å±‚çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°æ¥è¾¾åˆ°å¿«é€Ÿæ¶ˆè´¹çš„é€»è¾‘ï¼Œæœ‰æ•ˆè§£å†³ MQ æ¶ˆæ¯å †ç§¯é—®é¢˜ã€‚\r\n\r\nç›®å‰ Hippo4j å·²æ”¯æŒçš„ä¸‰æ–¹ä¸­é—´ä»¶çº¿ç¨‹æ± åˆ—è¡¨ï¼š\r\n\r\n- Apache Dubbo\r\n- Alibaba Dubbo\r\n- Apache Kafka\r\n- Apache RocketMQ\r\n- RabbitMQ\r\n- SpringCloud Stream RocketMQ\r\n- SpringCloud Hystrix\r\n- Tomcat\r\n- Jetty\r\n- Undertow\r\n\r\nä¸Šè¿°ä¸­é—´ä»¶çº¿ç¨‹æ± éƒ½å¯ä»¥åœ¨ Hippo4j é¡µé¢ä¸Šæ“ä½œæ ¸å¿ƒå‚æ•°åŠ¨æ€å˜æ›´ä»¥åŠç›‘æ§åŠŸèƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\r\n\r\n![image-20250320015038332](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320015038332.png)\r\n\r\næœªæ¥ Hippo4j ä¼šæ”¯æŒæ›´å¤šä¸‰æ–¹æ¡†æ¶çº¿ç¨‹æ± ï¼Œå¦‚æœä½ æœ‰å¥½çš„æƒ³æ³•ä¹Ÿå¯ä»¥å’Œæˆ‘æ²Ÿé€šï¼Œä¸€èµ·å®Œå–„ä¸­é—´ä»¶æ¡†æ¶é€‚é…ã€‚\r\n\r\n## æ¨¡å—ä»‹ç»\r\n\r\n![image-20250320015105972](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320015105972.png)\r\n\r\n## æ·±å…¥åŸç†\r\n\r\nå¦‚æœä¸€ä¸Šæ¥å°±ä¸‹è½½ Hippo4j çš„æºç æ¥çœ‹ï¼Œå¾ˆå®¹æ˜“è¿·å¤±è¿›å»ã€‚è¿™é‡Œç»™å¤§å®¶ç”»äº†å‡ å¼ å›¾ï¼Œå¸®åŠ©å¤§å®¶åœ¨é˜…è¯»æºç æ—¶ï¼Œèƒ½å¤ŸæŠ“ç´§ä¸»å¹²åˆ†æ”¯ï¼Œæ›´å¿«ä¸Šæ‰‹ Hippo4j æ¡†æ¶æºç ã€‚\r\n\r\n### 1. é…ç½®ä¸­å¿ƒæ¨¡å¼å˜æ›´åŸç†\r\n\r\n![image-20250320015122815](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320015122815.png)\r\n\r\n### 2. é€‚é… SpringBoot 1.5 & 2.x\r\n\r\n![image-20250320015143941](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320015143941.png)\r\n\r\n### 3. é˜…è¯»æºç ä¼˜ç‚¹\r\n\r\nå¦‚æœæ‚¨å…¬å¸æ²¡æœ‰ä½¿ç”¨ Hippo4j åœºæ™¯çš„è¯ï¼Œæˆ‘ä¹Ÿå»ºè®®å»é˜…è¯»ä¸‹é¡¹ç›®çš„åº•å±‚åŸç†ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š\r\n\r\n- ä¸ºäº†æé«˜ä»£ç è´¨é‡ä»¥åŠåç»­çš„æ‰©å±•è¡Œä¸ºï¼Œè¿ç”¨å¤šç§è®¾è®¡æ¨¡å¼å®ç°é«˜å†…èšã€ä½è€¦åˆã€‚\r\n- æ¡†æ¶åº•å±‚ä¾èµ– Spring æ¡†æ¶è¿è¡Œï¼Œå¹¶åœ¨æºç ä¸­å¤§é‡ä½¿ç”¨ Spring ç›¸å…³åŠŸèƒ½ã€‚\r\n- è¿ç”¨ JUC å¹¶å‘åŒ…ä¸‹å¤šç§å·¥å…·ä¿éšœå¤šçº¿ç¨‹è¿è¡Œå®‰å…¨ï¼Œé€šè¿‡å®é™…åœºæ™¯ç†è§£å¹¶å‘ç¼–ç¨‹ã€‚\r\n- å€Ÿé‰´ä¸»æµå¼€æºæ¡†æ¶ Nacosã€Eureka å®ç°è½»é‡çº§é…ç½®ä¸­å¿ƒå’Œæ³¨å†Œä¸­å¿ƒåŠŸèƒ½ã€‚\r\n- è‡ªå®šä¹‰ RPC æ¡†æ¶å®ç°ï¼Œå°è£… Netty å®Œæˆå®¢æˆ·ç«¯/æœåŠ¡ç«¯ç½‘ç»œé€šä¿¡ä¼˜åŒ–ã€‚\r\n- é€šè¿‡ CheckStyleã€Spotless ç­‰æ’ä»¶è§„èŒƒä»£ç ç¼–å†™ï¼Œä¿éšœé«˜è´¨é‡ä»£ç è¡Œä¸ºå’Œä»£ç æ ·å¼ã€‚"},{"title":"ç§’æ€","tags":["Spring Boot","Spring Cloud","token","Redis","Redisson","Schedule","RabbitMQ"],"categories":["Java","å¾®ç³»ç»Ÿä¸ç¬¬ä¸‰æ–¹æ¡†æ¶"],"author":"imklaus","excerpt":"\r\n\r\n\r\n## å¦‚ä½•è®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿï¼Ÿ\r\n\r\n- é«˜å¹¶å‘ä¸‹å¦‚ä½•è®¾è®¡ç§’æ€ç³»ç»Ÿï¼Ÿè¿™æ˜¯ä¸€ä¸ªé«˜é¢‘é¢è¯•é¢˜ã€‚è¿™ä¸ªé—®é¢˜çœ‹ä¼¼ç®€å•ï¼Œä½†æ˜¯é‡Œé¢çš„æ°´å¾ˆæ·±ï¼Œå®ƒè€ƒæŸ¥çš„æ˜¯é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä»å‰ç«¯åˆ°åç«¯å¤šæ–¹é¢çš„çŸ¥è¯†ã€‚\r\n\r\n\r\n\r\n- ç§’æ€ä¸€èˆ¬å‡ºç°åœ¨å•†åŸçš„ä¿ƒé”€æ´»åŠ¨ä¸­ï¼ŒæŒ‡å®šäº†ä¸€å®šæ•°é‡ï¼ˆæ¯”å¦‚ï¼š10ä¸ªï¼‰çš„å•†å“ï¼ˆæ¯”å¦‚ï¼šæ‰‹æœºï¼‰ï¼Œä»¥æä½çš„ä»·æ ¼ï¼ˆæ¯”å¦‚ï¼š0.1å…ƒï¼‰ï¼Œè®©å¤§é‡ç”¨æˆ·å‚ä¸æ´»åŠ¨ï¼Œä½†åªæœ‰æå°‘æ•°ç”¨æˆ·èƒ½å¤Ÿè´­ä¹°æˆåŠŸã€‚è¿™ç±»æ´»åŠ¨å•†å®¶ç»å¤§éƒ¨åˆ†æ˜¯ä¸èµšé’±çš„ï¼Œè¯´ç™½äº†æ˜¯æ‰¾ä¸ªå™±å¤´å®£ä¼ è‡ªå·±ã€‚\r\n\r\n\r\n\r\n- è™½è¯´ç§’æ€åªæ˜¯ä¸€ä¸ªä¿ƒé”€æ´»åŠ¨ï¼Œä½†å¯¹æŠ€æœ¯è¦æ±‚ä¸ä½ã€‚ä¸‹é¢ç»™å¤§å®¶æ€»ç»“ä¸€ä¸‹è®¾è®¡ç§’æ€ç³»ç»Ÿéœ€è¦æ³¨æ„çš„9ä¸ªç»†èŠ‚ã€‚\r\n\r\n![image-20230429153744600](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429153744600.png)\r\n","link":"/posts/Flash_killing","content":"\r\n\r\n\r\n## å¦‚ä½•è®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿï¼Ÿ\r\n\r\n- é«˜å¹¶å‘ä¸‹å¦‚ä½•è®¾è®¡ç§’æ€ç³»ç»Ÿï¼Ÿè¿™æ˜¯ä¸€ä¸ªé«˜é¢‘é¢è¯•é¢˜ã€‚è¿™ä¸ªé—®é¢˜çœ‹ä¼¼ç®€å•ï¼Œä½†æ˜¯é‡Œé¢çš„æ°´å¾ˆæ·±ï¼Œå®ƒè€ƒæŸ¥çš„æ˜¯é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä»å‰ç«¯åˆ°åç«¯å¤šæ–¹é¢çš„çŸ¥è¯†ã€‚\r\n\r\n\r\n\r\n- ç§’æ€ä¸€èˆ¬å‡ºç°åœ¨å•†åŸçš„ä¿ƒé”€æ´»åŠ¨ä¸­ï¼ŒæŒ‡å®šäº†ä¸€å®šæ•°é‡ï¼ˆæ¯”å¦‚ï¼š10ä¸ªï¼‰çš„å•†å“ï¼ˆæ¯”å¦‚ï¼šæ‰‹æœºï¼‰ï¼Œä»¥æä½çš„ä»·æ ¼ï¼ˆæ¯”å¦‚ï¼š0.1å…ƒï¼‰ï¼Œè®©å¤§é‡ç”¨æˆ·å‚ä¸æ´»åŠ¨ï¼Œä½†åªæœ‰æå°‘æ•°ç”¨æˆ·èƒ½å¤Ÿè´­ä¹°æˆåŠŸã€‚è¿™ç±»æ´»åŠ¨å•†å®¶ç»å¤§éƒ¨åˆ†æ˜¯ä¸èµšé’±çš„ï¼Œè¯´ç™½äº†æ˜¯æ‰¾ä¸ªå™±å¤´å®£ä¼ è‡ªå·±ã€‚\r\n\r\n\r\n\r\n- è™½è¯´ç§’æ€åªæ˜¯ä¸€ä¸ªä¿ƒé”€æ´»åŠ¨ï¼Œä½†å¯¹æŠ€æœ¯è¦æ±‚ä¸ä½ã€‚ä¸‹é¢ç»™å¤§å®¶æ€»ç»“ä¸€ä¸‹è®¾è®¡ç§’æ€ç³»ç»Ÿéœ€è¦æ³¨æ„çš„9ä¸ªç»†èŠ‚ã€‚\r\n\r\n![image-20230429153744600](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429153744600.png)\r\n<!-- more -->\r\n\r\n\r\n\r\n### 1 ç¬æ—¶é«˜å¹¶å‘ \r\n\r\n- ä¸€èˆ¬åœ¨ç§’æ€æ—¶é—´ç‚¹ï¼ˆæ¯”å¦‚ï¼š12ç‚¹ï¼‰å‰å‡ åˆ†é’Ÿï¼Œç”¨æˆ·å¹¶å‘é‡æ‰çœŸæ­£çªå¢ï¼Œè¾¾åˆ°ç§’æ€æ—¶é—´ç‚¹æ—¶ï¼Œå¹¶å‘é‡ä¼šè¾¾åˆ°é¡¶å³°ã€‚\r\n\r\n\r\n\r\n- ä½†ç”±äºè¿™ç±»æ´»åŠ¨æ˜¯å¤§é‡ç”¨æˆ·æŠ¢å°‘é‡å•†å“çš„åœºæ™¯ï¼Œå¿…å®šä¼šå‡ºç°ç‹¼å¤šè‚‰å°‘çš„æƒ…å†µï¼Œæ‰€ä»¥å…¶å®ç»å¤§éƒ¨åˆ†ç”¨æˆ·ç§’æ€ä¼šå¤±è´¥ï¼Œåªæœ‰æå°‘éƒ¨åˆ†ç”¨æˆ·èƒ½å¤ŸæˆåŠŸã€‚\r\n\r\n\r\n\r\n- æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¤§éƒ¨åˆ†ç”¨æˆ·ä¼šæ”¶åˆ°å•†å“å·²ç»æŠ¢å®Œçš„æé†’ï¼Œæ”¶åˆ°è¯¥æé†’åï¼Œä»–ä»¬å¤§æ¦‚ç‡ä¸ä¼šåœ¨é‚£ä¸ªæ´»åŠ¨é¡µé¢åœç•™äº†ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œç”¨æˆ·å¹¶å‘é‡åˆä¼šæ€¥å‰§ä¸‹é™ã€‚æ‰€ä»¥è¿™ä¸ªå³°å€¼æŒç»­çš„æ—¶é—´å…¶å®æ˜¯éå¸¸çŸ­çš„ï¼Œè¿™æ ·å°±ä¼šå‡ºç°ç¬æ—¶é«˜å¹¶å‘çš„æƒ…å†µï¼Œä¸‹é¢ç”¨ä¸€å¼ å›¾ç›´è§‚çš„æ„Ÿå—ä¸€ä¸‹æµé‡çš„å˜åŒ–ï¼š\r\n\r\n\r\n\r\n![image-20230429154129604](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429154129604.png)\r\n\r\n\r\n\r\n\r\n\r\n- åƒè¿™ç§ç¬æ—¶é«˜å¹¶å‘çš„åœºæ™¯ï¼Œä¼ ç»Ÿçš„ç³»ç»Ÿå¾ˆéš¾åº”å¯¹ï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€å¥—å…¨æ–°çš„ç³»ç»Ÿã€‚å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…¥æ‰‹ï¼š\r\n  1. é¡µé¢é™æ€åŒ–\r\n  2. CDNåŠ é€Ÿ\r\n  3. ç¼“å­˜\r\n  4. mqå¼‚æ­¥å¤„ç†\r\n  5. é™æµ\r\n  6. åˆ†å¸ƒå¼é”\r\n\r\n\r\n\r\n### 2 é¡µé¢é™æ€åŒ– \r\n\r\n\r\n\r\n- æ´»åŠ¨é¡µé¢æ˜¯ç”¨æˆ·æµé‡çš„ç¬¬ä¸€å…¥å£ï¼Œæ‰€ä»¥æ˜¯å¹¶å‘é‡æœ€å¤§çš„åœ°æ–¹ã€‚\r\n\r\n\r\n\r\n- å¦‚æœè¿™äº›æµé‡éƒ½èƒ½ç›´æ¥è®¿é—®æœåŠ¡ç«¯ï¼Œææ€•æœåŠ¡ç«¯ä¼šå› ä¸ºæ‰¿å—ä¸ä½è¿™ä¹ˆå¤§çš„å‹åŠ›ï¼Œè€Œç›´æ¥æŒ‚æ‰ã€‚\r\n\r\n![image-20230429154425207](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429154425207.png)\r\n\r\n\r\n\r\n- æ´»åŠ¨é¡µé¢ç»å¤§å¤šæ•°å†…å®¹æ˜¯å›ºå®šçš„ï¼Œæ¯”å¦‚ï¼šå•†å“åç§°ã€å•†å“æè¿°ã€å›¾ç‰‡ç­‰ã€‚ä¸ºäº†å‡å°‘ä¸å¿…è¦çš„æœåŠ¡ç«¯è¯·æ±‚ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œä¼šå¯¹æ´»åŠ¨é¡µé¢åš`é™æ€åŒ–`å¤„ç†ã€‚ç”¨æˆ·æµè§ˆå•†å“ç­‰å¸¸è§„æ“ä½œï¼Œå¹¶ä¸ä¼šè¯·æ±‚åˆ°æœåŠ¡ç«¯ã€‚åªæœ‰åˆ°äº†ç§’æ€æ—¶é—´ç‚¹ï¼Œå¹¶ä¸”ç”¨æˆ·ä¸»åŠ¨ç‚¹äº†ç§’æ€æŒ‰é’®æ‰å…è®¸è®¿é—®æœåŠ¡ç«¯ã€‚\r\n\r\n\r\n\r\n![image-20230429154505896](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429154505896.png)\r\n\r\n\r\n\r\n- è¿™æ ·èƒ½è¿‡æ»¤å¤§éƒ¨åˆ†æ— æ•ˆè¯·æ±‚ã€‚\r\n\r\n\r\n\r\n- ä½†åªåšé¡µé¢é™æ€åŒ–è¿˜ä¸å¤Ÿï¼Œå› ä¸ºç”¨æˆ·åˆ†å¸ƒåœ¨å…¨å›½å„åœ°ï¼Œæœ‰äº›äººåœ¨åŒ—äº¬ï¼Œæœ‰äº›äººåœ¨æˆéƒ½ï¼Œæœ‰äº›äººåœ¨æ·±åœ³ï¼Œåœ°åŸŸç›¸å·®å¾ˆè¿œï¼Œç½‘é€Ÿå„ä¸ç›¸åŒã€‚\r\n\r\n\r\n\r\n- å¦‚ä½•æ‰èƒ½è®©ç”¨æˆ·æœ€å¿«è®¿é—®åˆ°æ´»åŠ¨é¡µé¢å‘¢ï¼Ÿ\r\n  - è¿™å°±éœ€è¦ä½¿ç”¨CDNï¼Œå®ƒçš„å…¨ç§°æ˜¯Content Delivery Networkï¼Œå³å†…å®¹åˆ†å‘ç½‘ç»œã€‚\r\n\r\n\r\n\r\n![image-20230429154557367](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429154557367.png)\r\n\r\n\r\n\r\n> ä½¿ç”¨æˆ·å°±è¿‘è·å–æ‰€éœ€å†…å®¹ï¼Œé™ä½ç½‘ç»œæ‹¥å¡ï¼Œæé«˜ç”¨æˆ·è®¿é—®å“åº”é€Ÿåº¦å’Œå‘½ä¸­ç‡ã€‚\r\n\r\n\r\n\r\n\r\n\r\n### 3 ç§’æ€æŒ‰é’® \r\n\r\n\r\n\r\n- å¤§éƒ¨åˆ†ç”¨æˆ·æ€•é”™è¿‡ç§’æ€æ—¶é—´ç‚¹ï¼Œä¸€èˆ¬ä¼šæå‰è¿›å…¥æ´»åŠ¨é¡µé¢ã€‚æ­¤æ—¶çœ‹åˆ°çš„ç§’æ€æŒ‰é’®æ˜¯ç½®ç°ï¼Œä¸å¯ç‚¹å‡»çš„ã€‚åªæœ‰åˆ°äº†ç§’æ€æ—¶é—´ç‚¹é‚£ä¸€æ—¶åˆ»ï¼Œç§’æ€æŒ‰é’®æ‰ä¼šè‡ªåŠ¨ç‚¹äº®ï¼Œå˜æˆå¯ç‚¹å‡»çš„ã€‚\r\n\r\n\r\n\r\n- ä½†æ­¤æ—¶å¾ˆå¤šç”¨æˆ·å·²ç»è¿«ä¸åŠå¾…äº†ï¼Œé€šè¿‡ä¸åœåˆ·æ–°é¡µé¢ï¼Œäº‰å–åœ¨ç¬¬ä¸€æ—¶é—´çœ‹åˆ°ç§’æ€æŒ‰é’®çš„ç‚¹äº®ã€‚\r\n\r\n\r\n\r\n- ä»å‰é¢å¾—çŸ¥ï¼Œè¯¥æ´»åŠ¨é¡µé¢æ˜¯é™æ€çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨é™æ€é¡µé¢ä¸­å¦‚ä½•æ§åˆ¶ç§’æ€æŒ‰é’®ï¼Œåªåœ¨ç§’æ€æ—¶é—´ç‚¹æ—¶æ‰ç‚¹äº®å‘¢ï¼Ÿ\r\n  - æ²¡é”™ï¼Œä½¿ç”¨jsæ–‡ä»¶æ§åˆ¶ã€‚\r\n\r\n\r\n\r\n- ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œä¸€èˆ¬ä¼šå°†cssã€jså’Œå›¾ç‰‡ç­‰é™æ€èµ„æºæ–‡ä»¶æå‰ç¼“å­˜åˆ°CDNä¸Šï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿå°±è¿‘è®¿é—®ç§’æ€é¡µé¢ã€‚\r\n\r\n\r\n\r\n- çœ‹åˆ°è¿™é‡Œï¼Œæœ‰äº›èªæ˜çš„å°ä¼™ä¼´ï¼Œå¯èƒ½ä¼šé—®ï¼šCDNä¸Šçš„jsæ–‡ä»¶æ˜¯å¦‚ä½•æ›´æ–°çš„ï¼Ÿ\r\n  - ç§’æ€å¼€å§‹ä¹‹å‰ï¼Œjsæ ‡å¿—ä¸ºfalseï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªéšæœºå‚æ•°ã€‚\r\n\r\n![image-20230429154759471](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429154759471.png)\r\n\r\n\r\n\r\n- å½“ç§’æ€å¼€å§‹çš„æ—¶å€™ç³»ç»Ÿä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„jsæ–‡ä»¶ï¼Œæ­¤æ—¶æ ‡å¿—ä¸ºtrueï¼Œå¹¶ä¸”éšæœºå‚æ•°ç”Ÿæˆä¸€ä¸ªæ–°å€¼ï¼Œç„¶ååŒæ­¥ç»™CDNã€‚ç”±äºæœ‰äº†è¿™ä¸ªéšæœºå‚æ•°ï¼ŒCDNä¸ä¼šç¼“å­˜æ•°æ®ï¼Œæ¯æ¬¡éƒ½èƒ½ä»CDNä¸­è·å–æœ€æ–°çš„jsä»£ç ã€‚\r\n\r\n![image-20230429154818790](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429154818790.png)\r\n\r\n\r\n\r\n> æ­¤å¤–ï¼Œå‰ç«¯è¿˜å¯ä»¥åŠ ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ§åˆ¶æ¯”å¦‚ï¼š10ç§’ä¹‹å†…ï¼Œåªå…è®¸å‘èµ·ä¸€æ¬¡è¯·æ±‚ã€‚å¦‚æœç”¨æˆ·ç‚¹å‡»äº†ä¸€æ¬¡ç§’æ€æŒ‰é’®ï¼Œåˆ™åœ¨10ç§’ä¹‹å†…ç½®ç°ï¼Œä¸å…è®¸å†æ¬¡ç‚¹å‡»ï¼Œç­‰åˆ°è¿‡äº†æ—¶é—´é™åˆ¶ï¼Œåˆå…è®¸é‡æ–°ç‚¹å‡»è¯¥æŒ‰é’®ã€‚\r\n\r\n\r\n\r\n\r\n\r\n### 4 è¯»å¤šå†™å°‘ \r\n\r\n\r\n\r\n- åœ¨ç§’æ€çš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¸€èˆ¬ä¼šå…ˆæŸ¥ä¸€ä¸‹åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœè¶³å¤Ÿæ‰å…è®¸ä¸‹å•ï¼Œå†™æ•°æ®åº“ã€‚å¦‚æœä¸å¤Ÿï¼Œåˆ™ç›´æ¥è¿”å›è¯¥å•†å“å·²ç»æŠ¢å®Œã€‚\r\n\r\n\r\n\r\n- ç”±äºå¤§é‡ç”¨æˆ·æŠ¢å°‘é‡å•†å“ï¼Œåªæœ‰æå°‘éƒ¨åˆ†ç”¨æˆ·èƒ½å¤ŸæŠ¢æˆåŠŸï¼Œæ‰€ä»¥ç»å¤§éƒ¨åˆ†ç”¨æˆ·åœ¨ç§’æ€æ—¶ï¼Œåº“å­˜å…¶å®æ˜¯ä¸è¶³çš„ï¼Œç³»ç»Ÿä¼šç›´æ¥è¿”å›è¯¥å•†å“å·²ç»æŠ¢å®Œã€‚\r\n\r\n\r\n\r\n- è¿™æ˜¯éå¸¸å…¸å‹çš„ï¼šè¯»å¤šå†™å°‘ çš„åœºæ™¯ã€‚\r\n\r\n\r\n\r\n![image-20230429155156269](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429155156269.png)\r\n\r\n\r\n\r\n- å¦‚æœæœ‰æ•°åä¸‡çš„è¯·æ±‚è¿‡æ¥ï¼ŒåŒæ—¶é€šè¿‡æ•°æ®åº“æŸ¥ç¼“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œæ­¤æ—¶æ•°æ®åº“å¯èƒ½ä¼šæŒ‚æ‰ã€‚å› ä¸ºæ•°æ®åº“çš„è¿æ¥èµ„æºéå¸¸æœ‰é™ï¼Œæ¯”å¦‚ï¼šmysqlï¼Œæ— æ³•åŒæ—¶æ”¯æŒè¿™ä¹ˆå¤šçš„è¿æ¥ã€‚\r\n\r\n\r\n\r\n- è€Œåº”è¯¥æ”¹ç”¨ç¼“å­˜ï¼Œæ¯”å¦‚ï¼šredisã€‚\r\n\r\n\r\n\r\n- å³ä¾¿ç”¨äº†redisï¼Œä¹Ÿéœ€è¦éƒ¨ç½²å¤šä¸ªèŠ‚ç‚¹ã€‚\r\n\r\n![image-20230429155327734](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429155327734.png)\r\n\r\n\r\n\r\n\r\n\r\n### 5 ç¼“å­˜é—®é¢˜ \r\n\r\n\r\n\r\n- é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨redisä¸­ä¿å­˜å•†å“ä¿¡æ¯ï¼Œé‡Œé¢åŒ…å«ï¼šå•†å“idã€å•†å“åç§°ã€è§„æ ¼å±æ€§ã€åº“å­˜ç­‰ä¿¡æ¯ï¼ŒåŒæ—¶æ•°æ®åº“ä¸­ä¹Ÿè¦æœ‰ç›¸å…³ä¿¡æ¯ï¼Œæ¯•ç«Ÿç¼“å­˜å¹¶ä¸å®Œå…¨å¯é ã€‚\r\n\r\n\r\n\r\n- ç”¨æˆ·åœ¨ç‚¹å‡»ç§’æ€æŒ‰é’®ï¼Œè¯·æ±‚ç§’æ€æ¥å£çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä¼ å…¥çš„å•†å“idå‚æ•°ï¼Œç„¶åæœåŠ¡ç«¯éœ€è¦æ ¡éªŒè¯¥å•†å“æ˜¯å¦åˆæ³•ã€‚\r\n\r\n\r\n\r\n- å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\r\n\r\n![image-20230429155407944](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429155407944.png)\r\n\r\n\r\n\r\n> - æ ¹æ®å•†å“idï¼Œå…ˆä»ç¼“å­˜ä¸­æŸ¥è¯¢å•†å“ï¼Œå¦‚æœå•†å“å­˜åœ¨ï¼Œåˆ™å‚ä¸ç§’æ€ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å•†å“ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å°†å•†å“ä¿¡æ¯æ”¾å…¥ç¼“å­˜ï¼Œç„¶åå‚ä¸ç§’æ€ã€‚å¦‚æœå•†å“ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥æç¤ºå¤±è´¥ã€‚\r\n>\r\n> - è¿™ä¸ªè¿‡ç¨‹è¡¨é¢ä¸Šçœ‹èµ·æ¥æ˜¯OKçš„ï¼Œä½†æ˜¯å¦‚æœæ·±å…¥åˆ†æä¸€ä¸‹ä¼šå‘ç°ä¸€äº›é—®é¢˜ã€‚\r\n\r\n\r\n\r\n#### 5.1 ç¼“å­˜å‡»ç©¿ \r\n\r\n\r\n\r\n- æ¯”å¦‚å•†å“Aç¬¬ä¸€æ¬¡ç§’æ€æ—¶ï¼Œç¼“å­˜ä¸­æ˜¯æ²¡æœ‰æ•°æ®çš„ï¼Œä½†æ•°æ®åº“ä¸­æœ‰ã€‚è™½è¯´ä¸Šé¢æœ‰å¦‚æœä»æ•°æ®åº“ä¸­æŸ¥åˆ°æ•°æ®ï¼Œåˆ™æ”¾å…¥ç¼“å­˜çš„é€»è¾‘ã€‚\r\n\r\n\r\n\r\n- ç„¶è€Œï¼Œåœ¨é«˜å¹¶å‘ä¸‹ï¼ŒåŒä¸€æ—¶åˆ»ä¼šæœ‰å¤§é‡çš„è¯·æ±‚ï¼Œéƒ½åœ¨ç§’æ€åŒä¸€ä»¶å•†å“ï¼Œè¿™äº›è¯·æ±‚åŒæ—¶å»æŸ¥ç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼Œç„¶ååˆåŒæ—¶è®¿é—®æ•°æ®åº“ã€‚ç»“æœæ‚²å‰§äº†ï¼Œæ•°æ®åº“å¯èƒ½æ‰›ä¸ä½å‹åŠ›ï¼Œç›´æ¥æŒ‚æ‰ã€‚\r\n\r\n\r\n\r\n- å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ\r\n  - è¿™å°±éœ€è¦åŠ é”ï¼Œæœ€å¥½ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚\r\n\r\n\r\n\r\n![image-20230429155613279](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429155613279.png)\r\n\r\n\r\n\r\n> - å½“ç„¶ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæœ€å¥½åœ¨é¡¹ç›®å¯åŠ¨ä¹‹å‰ï¼Œå…ˆæŠŠç¼“å­˜è¿›è¡Œé¢„çƒ­ã€‚å³äº‹å…ˆæŠŠæ‰€æœ‰çš„å•†å“ï¼ŒåŒæ­¥åˆ°ç¼“å­˜ä¸­ï¼Œè¿™æ ·å•†å“åŸºæœ¬éƒ½èƒ½ç›´æ¥ä»ç¼“å­˜ä¸­è·å–åˆ°ï¼Œå°±ä¸ä¼šå‡ºç°ç¼“å­˜å‡»ç©¿çš„é—®é¢˜äº†ã€‚\r\n> - æ˜¯ä¸æ˜¯ä¸Šé¢åŠ é”è¿™ä¸€æ­¥å¯ä»¥ä¸éœ€è¦äº†ï¼Ÿ\r\n>   - è¡¨é¢ä¸Šçœ‹èµ·æ¥ï¼Œç¡®å®å¯ä»¥ä¸éœ€è¦ã€‚ä½†å¦‚æœç¼“å­˜ä¸­è®¾ç½®çš„è¿‡æœŸæ—¶é—´ä¸å¯¹ï¼Œç¼“å­˜æå‰è¿‡æœŸäº†ï¼Œæˆ–è€…ç¼“å­˜è¢«ä¸å°å¿ƒåˆ é™¤äº†ï¼Œå¦‚æœä¸åŠ é€ŸåŒæ ·å¯èƒ½å‡ºç°ç¼“å­˜å‡»ç©¿ã€‚\r\n>   - å…¶å®è¿™é‡ŒåŠ é”ï¼Œç›¸å½“äºä¹°äº†ä¸€ä»½ä¿é™©ã€‚\r\n\r\n\r\n\r\n#### 5.2 ç¼“å­˜ç©¿é€ \r\n\r\n\r\n\r\n- å¦‚æœæœ‰å¤§é‡çš„è¯·æ±‚ä¼ å…¥çš„å•†å“idï¼Œåœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œè¿™äº›è¯·æ±‚ä¸å°±æ¯æ¬¡éƒ½ä¼šç©¿é€è¿‡ç¼“å­˜ï¼Œè€Œç›´æ¥è®¿é—®æ•°æ®åº“äº†ã€‚\r\n\r\n\r\n\r\n- ç”±äºå‰é¢å·²ç»åŠ äº†é”ï¼Œæ‰€ä»¥å³ä½¿è¿™é‡Œçš„å¹¶å‘é‡å¾ˆå¤§ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´æ•°æ®åº“ç›´æ¥æŒ‚æ‰ã€‚\r\n\r\n\r\n\r\n- ä½†å¾ˆæ˜¾ç„¶è¿™äº›è¯·æ±‚çš„å¤„ç†æ€§èƒ½å¹¶ä¸å¥½ï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼Ÿ\r\n  - è¿™æ—¶å¯ä»¥æƒ³åˆ°å¸ƒéš†è¿‡æ»¤å™¨ã€‚\r\n\r\n\r\n\r\n![image-20230429160015188](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429160015188.png)\r\n\r\n\r\n\r\n- ç³»ç»Ÿæ ¹æ®å•†å“idï¼Œå…ˆä»å¸ƒéš†è¿‡æ»¤å™¨ä¸­æŸ¥è¯¢è¯¥idæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™å…è®¸ä»ç¼“å­˜ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›å¤±è´¥ã€‚\r\n\r\n\r\n\r\n- è™½è¯´è¯¥æ–¹æ¡ˆå¯ä»¥è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜ï¼Œä½†æ˜¯åˆä¼šå¼•å‡ºå¦å¤–ä¸€ä¸ªé—®é¢˜ï¼šå¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„æ•°æ®å¦‚ä½•è·Ÿç¼“å­˜ä¸­çš„æ•°æ®ä¿æŒä¸€è‡´ï¼Ÿ\r\n\r\n\r\n\r\n- è¿™å°±è¦æ±‚ï¼Œå¦‚æœç¼“å­˜ä¸­æ•°æ®æœ‰æ›´æ–°ï¼Œåˆ™è¦åŠæ—¶åŒæ­¥åˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚å¦‚æœæ•°æ®åŒæ­¥å¤±è´¥äº†ï¼Œè¿˜éœ€è¦å¢åŠ é‡è¯•æœºåˆ¶ï¼Œè€Œä¸”è·¨æ•°æ®æºï¼Œèƒ½ä¿è¯æ•°æ®çš„å®æ—¶ä¸€è‡´æ€§å—ï¼Ÿ\r\n  - æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ã€‚\r\n\r\n- æ‰€ä»¥å¸ƒéš†è¿‡æ»¤å™¨ç»å¤§éƒ¨åˆ†ä½¿ç”¨åœ¨ç¼“å­˜æ•°æ®æ›´æ–°å¾ˆå°‘çš„åœºæ™¯ä¸­ã€‚\r\n\r\n- å¦‚æœç¼“å­˜æ•°æ®æ›´æ–°éå¸¸é¢‘ç¹ï¼Œåˆè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ\r\n\r\n- è¿™æ—¶ï¼Œå°±éœ€è¦æŠŠä¸å­˜åœ¨çš„å•†å“idä¹Ÿç¼“å­˜èµ·æ¥ã€‚\r\n\r\n\r\n\r\n![image-20230429160205059](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429160205059.png)\r\n\r\n\r\n\r\n> ä¸‹æ¬¡ï¼Œå†æœ‰è¯¥å•†å“idçš„è¯·æ±‚è¿‡æ¥ï¼Œåˆ™ä¹Ÿèƒ½ä»ç¼“å­˜ä¸­æŸ¥åˆ°æ•°æ®ï¼Œåªä¸è¿‡è¯¥æ•°æ®æ¯”è¾ƒç‰¹æ®Šï¼Œè¡¨ç¤ºå•†å“ä¸å­˜åœ¨ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§ç‰¹æ®Šç¼“å­˜è®¾ç½®çš„è¶…æ—¶æ—¶é—´åº”è¯¥å°½é‡çŸ­ä¸€ç‚¹ã€‚\r\n\r\n\r\n\r\n\r\n\r\n### 6 åº“å­˜é—®é¢˜ \r\n\r\n\r\n\r\n- å¯¹äºåº“å­˜é—®é¢˜çœ‹ä¼¼ç®€å•ï¼Œå®åˆ™é‡Œé¢è¿˜æ˜¯æœ‰äº›ä¸œè¥¿ã€‚\r\n\r\n\r\n\r\n- çœŸæ­£çš„ç§’æ€å•†å“çš„åœºæ™¯ï¼Œä¸æ˜¯è¯´æ‰£å®Œåº“å­˜ï¼Œå°±å®Œäº‹äº†ï¼Œå¦‚æœç”¨æˆ·åœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œè¿˜æ²¡å®Œæˆæ”¯ä»˜ï¼Œæ‰£å‡çš„åº“å­˜æ˜¯è¦åŠ å›å»çš„ã€‚\r\n\r\n\r\n\r\n- æ‰€ä»¥ï¼Œåœ¨è¿™é‡Œå¼•å‡ºäº†ä¸€ä¸ªé¢„æ‰£åº“å­˜çš„æ¦‚å¿µï¼Œé¢„æ‰£åº“å­˜çš„ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n\r\n\r\n![image-20230429160545360](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429160545360.png)\r\n\r\n\r\n\r\n> æ‰£å‡åº“å­˜ä¸­é™¤äº†ä¸Šé¢è¯´åˆ°çš„é¢„æ‰£åº“å­˜å’Œå›é€€åº“å­˜ä¹‹å¤–ï¼Œè¿˜éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯åº“å­˜ä¸è¶³å’Œåº“å­˜è¶…å–é—®é¢˜ã€‚\r\n\r\n\r\n\r\n#### 6.1 æ•°æ®åº“æ‰£å‡åº“å­˜ \r\n\r\n\r\n\r\n- ä½¿ç”¨æ•°æ®åº“æ‰£å‡åº“å­˜ï¼Œæ˜¯æœ€ç®€å•çš„å®ç°æ–¹æ¡ˆäº†ï¼Œå‡è®¾æ‰£å‡åº“å­˜çš„sqlå¦‚ä¸‹ï¼š\r\n\r\n```sql\r\nupdate product set stock=stock-1 where id=123;\r\n```\r\n\r\n- è¿™ç§å†™æ³•å¯¹äºæ‰£å‡åº“å­˜æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†å¦‚ä½•æ§åˆ¶åº“å­˜ä¸è¶³çš„æƒ…å†µä¸‹ï¼Œä¸è®©ç”¨æˆ·æ“ä½œå‘¢ï¼Ÿ\r\n\r\n  - è¿™å°±éœ€è¦åœ¨updateä¹‹å‰ï¼Œå…ˆæŸ¥ä¸€ä¸‹åº“å­˜æ˜¯å¦è¶³å¤Ÿäº†ã€‚\r\n\r\n  - ä¼ªä»£ç å¦‚ä¸‹ï¼š\r\n  \r\n  ```java\r\n  int stock = mapper.getStockById(123);\r\n  if(stock > 0) {\r\n    int count = mapper.updateStock(123);\r\n    if(count > 0) {\r\n      addOrder(123);\r\n    }\r\n  }\r\n  ```\r\n\r\n\r\n\r\n- å¤§å®¶æœ‰æ²¡æœ‰å‘ç°è¿™æ®µä»£ç çš„é—®é¢˜ï¼Ÿ\r\n\r\n  - æ²¡é”™ï¼ŒæŸ¥è¯¢æ“ä½œå’Œæ›´æ–°æ“ä½œä¸æ˜¯åŸå­æ€§çš„ï¼Œä¼šå¯¼è‡´åœ¨å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå‡ºç°åº“å­˜è¶…å–çš„æƒ…å†µã€‚\r\n\r\n\r\n  - æœ‰äººå¯èƒ½ä¼šè¯´ï¼Œè¿™æ ·å¥½åŠï¼ŒåŠ æŠŠé”ï¼Œä¸å°±æå®šäº†ï¼Œæ¯”å¦‚ä½¿ç”¨synchronizedå…³é”®å­—ã€‚\r\n\r\n\r\n  - ç¡®å®ï¼Œå¯ä»¥ï¼Œä½†æ˜¯æ€§èƒ½ä¸å¤Ÿå¥½ã€‚\r\n\r\n\r\n  - è¿˜æœ‰æ›´ä¼˜é›…çš„å¤„ç†æ–¹æ¡ˆï¼Œå³åŸºäºæ•°æ®åº“çš„ä¹è§‚é”ï¼Œè¿™æ ·ä¼šå°‘ä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼Œè€Œä¸”èƒ½å¤Ÿå¤©ç„¶çš„ä¿è¯æ•°æ®æ“ä½œçš„åŸå­æ€§ã€‚\r\n\r\n\r\n  - åªéœ€å°†ä¸Šé¢çš„sqlç¨å¾®è°ƒæ•´ä¸€ä¸‹ï¼š\r\n\r\n  ```sql\r\n  update product set stock=stock-1 where id=product and stock > 0;\r\n  ```\r\n\r\n> - åœ¨sqlæœ€ååŠ ä¸Šï¼šstock > 0ï¼Œå°±èƒ½ä¿è¯ä¸ä¼šå‡ºç°è¶…å–çš„æƒ…å†µã€‚\r\n>\r\n> - ä½†éœ€è¦é¢‘ç¹è®¿é—®æ•°æ®åº“ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ•°æ®åº“è¿æ¥æ˜¯éå¸¸æ˜‚è´µçš„èµ„æºã€‚åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå¯èƒ½ä¼šé€ æˆç³»ç»Ÿé›ªå´©ã€‚è€Œä¸”ï¼Œå®¹æ˜“å‡ºç°å¤šä¸ªè¯·æ±‚ï¼ŒåŒæ—¶ç«äº‰è¡Œé”çš„æƒ…å†µï¼Œé€ æˆç›¸äº’ç­‰å¾…ï¼Œä»è€Œå‡ºç°æ­»é”çš„é—®é¢˜ã€‚\r\n>\r\n\r\n\r\n\r\n####  6.2 redisæ‰£å‡åº“å­˜ \r\n\r\n\r\n\r\n- redisçš„`incr`æ–¹æ³•æ˜¯åŸå­æ€§çš„ï¼Œå¯ä»¥ç”¨è¯¥æ–¹æ³•æ‰£å‡åº“å­˜ã€‚ ä¼ªä»£ç å¦‚ä¸‹ï¼š\r\n\r\n\r\n```java\r\n  boolean exist = redisClient.query(productId,userId);\r\n  if(exist) {\r\n    return -1;\r\n  }\r\n  int stock = redisClient.queryStock(productId);\r\n  if(stock <=0) {\r\n    return 0;\r\n  }\r\n  redisClient.incrby(productId, -1);\r\n  redisClient.add(productId,userId);\r\n  return 1;\r\n```\r\n\r\n\r\n\r\n- ä»£ç æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n1. å…ˆåˆ¤æ–­è¯¥ç”¨æˆ·æœ‰æ²¡æœ‰ç§’æ€è¿‡è¯¥å•†å“ï¼Œå¦‚æœå·²ç»ç§’æ€è¿‡ï¼Œåˆ™ç›´æ¥è¿”å›-1ã€‚\r\n2. æŸ¥è¯¢åº“å­˜ï¼Œå¦‚æœåº“å­˜å°äºç­‰äº0ï¼Œåˆ™ç›´æ¥è¿”å›0ï¼Œè¡¨ç¤ºåº“å­˜ä¸è¶³ã€‚\r\n\r\n3. å¦‚æœåº“å­˜å……è¶³ï¼Œåˆ™æ‰£å‡åº“å­˜ï¼Œç„¶åå°†æœ¬æ¬¡ç§’æ€è®°å½•ä¿å­˜èµ·æ¥ã€‚ç„¶åè¿”å›1ï¼Œè¡¨ç¤ºæˆåŠŸã€‚\r\n\r\n\r\n\r\n- ä¼°è®¡å¾ˆå¤šå°ä¼™ä¼´ï¼Œä¸€å¼€å§‹éƒ½ä¼šæŒ‰è¿™æ ·çš„æ€è·¯å†™ä»£ç ã€‚ä½†å¦‚æœä»”ç»†æƒ³æƒ³ä¼šå‘ç°ï¼Œè¿™æ®µä»£ç æœ‰é—®é¢˜ã€‚\r\n\r\n\r\n- æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ\r\n\r\n  - å¦‚æœåœ¨é«˜å¹¶å‘ä¸‹ï¼Œæœ‰å¤šä¸ªè¯·æ±‚åŒæ—¶æŸ¥è¯¢åº“å­˜ï¼Œå½“æ—¶éƒ½å¤§äº0ã€‚ç”±äºæŸ¥è¯¢åº“å­˜å’Œæ›´æ–°åº“å­˜éåŸåˆ™æ“ä½œï¼Œåˆ™ä¼šå‡ºç°åº“å­˜ä¸ºè´Ÿæ•°çš„æƒ…å†µï¼Œå³`åº“å­˜è¶…å–`ã€‚\r\n\r\n\r\n- å½“ç„¶æœ‰äººå¯èƒ½ä¼šè¯´ï¼ŒåŠ ä¸ª`synchronized`ä¸å°±è§£å†³é—®é¢˜ï¼Ÿ\r\n\r\n\r\n- è°ƒæ•´åä»£ç å¦‚ä¸‹ï¼š\r\n\r\n\r\n```java\r\nboolean exist = redisClient.query(productId,userId);\r\n   if(exist) {\r\n    return -1;\r\n   }\r\n   synchronized(this) {\r\n       int stock = redisClient.queryStock(productId);\r\n       if(stock <=0) {\r\n         return 0;\r\n       }\r\n       redisClient.incrby(productId, -1);\r\n       redisClient.add(productId,userId);\r\n   }\r\nreturn 1;\r\n```\r\n\r\n\r\n\r\n- åŠ `synchronized`ç¡®å®èƒ½è§£å†³åº“å­˜ä¸ºè´Ÿæ•°é—®é¢˜ï¼Œä½†æ˜¯è¿™æ ·ä¼šå¯¼è‡´æ¥å£æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦ç«äº‰åŒä¸€æŠŠé”ï¼Œæ˜¾ç„¶ä¸å¤ªåˆç†ã€‚\r\n\r\n\r\n- ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œä»£ç ä¼˜åŒ–å¦‚ä¸‹ï¼š\r\n\r\n\r\n```java\r\nboolean exist = redisClient.query(productId,userId);\r\nif(exist) {\r\n  return -1;\r\n}\r\nif(redisClient.incrby(productId, -1)<0) {\r\n  return 0;\r\n}\r\nredisClient.add(productId,userId);\r\nreturn 1;\r\n```\r\n\r\n\r\n\r\n- è¯¥ä»£ç ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n\r\n1. å…ˆåˆ¤æ–­è¯¥ç”¨æˆ·æœ‰æ²¡æœ‰ç§’æ€è¿‡è¯¥å•†å“ï¼Œå¦‚æœå·²ç»ç§’æ€è¿‡ï¼Œåˆ™ç›´æ¥è¿”å›-1ã€‚\r\n2. æ‰£å‡åº“å­˜ï¼Œåˆ¤æ–­è¿”å›å€¼æ˜¯å¦å°äº0ï¼Œå¦‚æœå°äº0ï¼Œåˆ™ç›´æ¥è¿”å›0ï¼Œè¡¨ç¤ºåº“å­˜ä¸è¶³ã€‚\r\n\r\n3. å¦‚æœæ‰£å‡åº“å­˜åï¼Œè¿”å›å€¼å¤§äºæˆ–ç­‰äº0ï¼Œåˆ™å°†æœ¬æ¬¡ç§’æ€è®°å½•ä¿å­˜èµ·æ¥ã€‚ç„¶åè¿”å›1ï¼Œè¡¨ç¤ºæˆåŠŸã€‚\r\n\r\n\r\n\r\n> - è¯¥æ–¹æ¡ˆå’‹ä¸€çœ‹ï¼Œå¥½åƒæ²¡é—®é¢˜ã€‚\r\n>\r\n>   - ä½†å¦‚æœåœ¨é«˜å¹¶å‘åœºæ™¯ä¸­ï¼Œæœ‰å¤šä¸ªè¯·æ±‚åŒæ—¶æ‰£å‡åº“å­˜ï¼Œå¤§å¤šæ•°è¯·æ±‚çš„incrbyæ“ä½œä¹‹åï¼Œç»“æœéƒ½ä¼šå°äº0ã€‚\r\n>\r\n>\r\n> - è™½è¯´ï¼Œåº“å­˜å‡ºç°è´Ÿæ•°ï¼Œä¸ä¼šå‡ºç°è¶…å–çš„é—®é¢˜ã€‚ä½†ç”±äºè¿™é‡Œæ˜¯é¢„å‡åº“å­˜ï¼Œå¦‚æœè´Ÿæ•°å€¼è´Ÿçš„å¤ªå¤šçš„è¯ï¼Œåé¢ä¸‡ä¸€è¦å›é€€åº“å­˜æ—¶ï¼Œå°±ä¼šå¯¼è‡´åº“å­˜ä¸å‡†ã€‚\r\n>\r\n>\r\n> - é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ¡ˆå‘¢ï¼Ÿ\r\n>\r\n\r\n\r\n\r\n####  6.3 luaè„šæœ¬æ‰£å‡åº“å­˜ \r\n\r\n\r\n\r\n- æˆ‘ä»¬éƒ½çŸ¥é“luaè„šæœ¬ï¼Œæ˜¯èƒ½å¤Ÿä¿è¯åŸå­æ€§çš„ï¼Œå®ƒè·Ÿredisä¸€èµ·é…åˆä½¿ç”¨ï¼Œèƒ½å¤Ÿå®Œç¾è§£å†³ä¸Šé¢çš„é—®é¢˜ã€‚\r\n\r\n\r\n- luaè„šæœ¬æœ‰æ®µéå¸¸ç»å…¸çš„ä»£ç ï¼š\r\n\r\n\r\n```java\r\nStringBuilder lua = new StringBuilder();\r\n  lua.append(\"if (redis.call('exists', KEYS[1]) == 1) then\");\r\n  lua.append(\"    local stock = tonumber(redis.call('get', KEYS[1]));\");\r\n  lua.append(\"    if (stock == -1) then\");\r\n  lua.append(\"        return 1;\");\r\n  lua.append(\"    end;\");\r\n  lua.append(\"    if (stock > 0) then\");\r\n  lua.append(\"        redis.call('incrby', KEYS[1], -1);\");\r\n  lua.append(\"        return stock;\");\r\n  lua.append(\"    end;\");\r\n  lua.append(\"    return 0;\");\r\n  lua.append(\"end;\");\r\n  lua.append(\"return -1;\");\r\n```\r\n\r\n\r\n\r\n- è¯¥ä»£ç çš„ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n\r\n1. å…ˆåˆ¤æ–­å•†å“idæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚\r\n2. è·å–è¯¥å•†å“idçš„åº“å­˜ï¼Œåˆ¤æ–­åº“å­˜å¦‚æœæ˜¯-1ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œè¡¨ç¤ºä¸é™åˆ¶åº“å­˜ã€‚\r\n\r\n3. å¦‚æœåº“å­˜å¤§äº0ï¼Œåˆ™æ‰£å‡åº“å­˜ã€‚\r\n\r\n4. å¦‚æœåº“å­˜ç­‰äº0ï¼Œæ˜¯ç›´æ¥è¿”å›ï¼Œè¡¨ç¤ºåº“å­˜ä¸è¶³ã€‚\r\n\r\n\r\n\r\n###  7 åˆ†å¸ƒå¼é” \r\n\r\n\r\n\r\n- ä¹‹å‰æˆ‘æåˆ°è¿‡ï¼Œåœ¨ç§’æ€çš„æ—¶å€™ï¼Œéœ€è¦å…ˆä»ç¼“å­˜ä¸­æŸ¥å•†å“æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¼šä»æ•°æ®åº“ä¸­æŸ¥å•†å“ã€‚å¦‚æœæ•°æ®åº“ä¸­æœ‰ï¼Œåˆ™å°†è¯¥å•†å“æ”¾å…¥ç¼“å­˜ä¸­ï¼Œç„¶åè¿”å›ã€‚å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œåˆ™ç›´æ¥è¿”å›å¤±è´¥ã€‚\r\n\r\n\r\n- å¤§å®¶è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœåœ¨é«˜å¹¶å‘ä¸‹ï¼Œæœ‰å¤§é‡çš„è¯·æ±‚éƒ½å»æŸ¥ä¸€ä¸ªç¼“å­˜ä¸­ä¸å­˜åœ¨çš„å•†å“ï¼Œè¿™äº›è¯·æ±‚éƒ½ä¼šç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚æ•°æ®åº“ç”±äºæ‰¿å—ä¸ä½å‹åŠ›ï¼Œè€Œç›´æ¥æŒ‚æ‰ã€‚\r\n\r\n\r\n- é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ\r\n\r\n  - è¿™å°±éœ€è¦ç”¨redisåˆ†å¸ƒå¼é”äº†ã€‚\r\n\r\n\r\n\r\n\r\n####  7.1 setNxåŠ é” \r\n\r\n\r\n\r\n- ä½¿ç”¨redisçš„åˆ†å¸ƒå¼é”ï¼Œé¦–å…ˆæƒ³åˆ°çš„æ˜¯setNxå‘½ä»¤ã€‚\r\n\r\n\r\n```java\r\nif (jedis.setnx(lockKey, val) == 1) {\r\n   jedis.expire(lockKey, timeout);\r\n}\r\n```\r\n\r\n\r\n\r\n- ç”¨è¯¥å‘½ä»¤å…¶å®å¯ä»¥åŠ é”ï¼Œä½†å’Œåé¢çš„è®¾ç½®è¶…æ—¶æ—¶é—´æ˜¯åˆ†å¼€çš„ï¼Œå¹¶éåŸå­æ“ä½œã€‚\r\n\r\n\r\n\r\n\r\n- å‡å¦‚åŠ é”æˆåŠŸäº†ï¼Œä½†æ˜¯è®¾ç½®è¶…æ—¶æ—¶é—´å¤±è´¥äº†ï¼Œè¯¥lockKeyå°±å˜æˆæ°¸ä¸å¤±æ•ˆçš„äº†ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸­ï¼Œè¯¥é—®é¢˜ä¼šå¯¼è‡´éå¸¸ä¸¥é‡çš„åæœã€‚\r\n\r\n\r\n\r\n\r\n- é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä¿è¯åŸå­æ€§çš„åŠ é”å‘½ä»¤å‘¢ï¼Ÿ\r\n\r\n\r\n\r\n\r\n####  7.2 setåŠ é” \r\n\r\n\r\n\r\n- ä½¿ç”¨redisçš„setå‘½ä»¤ï¼Œå®ƒå¯ä»¥æŒ‡å®šå¤šä¸ªå‚æ•°ã€‚\r\n\r\n\r\n```java\r\nString result = jedis.set(lockKey, requestId, \"NX\", \"PX\", expireTime);\r\nif (\"OK\".equals(result)) {\r\n    return true;\r\n}\r\nreturn false;\r\n```\r\n\r\nå…¶ä¸­ï¼š\r\n\r\n- lockKeyï¼šé”çš„æ ‡è¯†\r\n\r\n- requestIdï¼šè¯·æ±‚id\r\n\r\n- NXï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œã€‚\r\n\r\n- PXï¼šè®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´ä¸º millisecond æ¯«ç§’ã€‚\r\n\r\n- expireTimeï¼šè¿‡æœŸæ—¶é—´ ç”±äºè¯¥å‘½ä»¤åªæœ‰ä¸€æ­¥ï¼Œæ‰€ä»¥å®ƒæ˜¯åŸå­æ“ä½œã€‚\r\n\r\n\r\n\r\n\r\n####  7.3 é‡Šæ”¾é” \r\n\r\n\r\n\r\n- æ¥ä¸‹æ¥ï¼Œæœ‰äº›æœ‹å‹å¯èƒ½ä¼šé—®ï¼šåœ¨åŠ é”æ—¶ï¼Œæ—¢ç„¶å·²ç»æœ‰äº†lockKeyé”æ ‡è¯†ï¼Œä¸ºä»€ä¹ˆè¦éœ€è¦è®°å½•requestIdå‘¢ï¼Ÿ\r\n\r\n  - ç­”ï¼šrequestIdæ˜¯åœ¨é‡Šæ”¾é”çš„æ—¶å€™ç”¨çš„ã€‚\r\n\r\n\r\n\r\n\r\n- åœ¨é‡Šæ”¾é”çš„æ—¶å€™ï¼Œåªèƒ½é‡Šæ”¾è‡ªå·±åŠ çš„é”ï¼Œä¸å…è®¸é‡Šæ”¾åˆ«äººåŠ çš„é”ã€‚\r\n\r\n\r\n\r\n\r\n- è¿™é‡Œä¸ºä»€ä¹ˆè¦ç”¨requestIdï¼Œç”¨userIdä¸è¡Œå—ï¼Ÿ\r\n\r\n  - ç­”ï¼šå¦‚æœç”¨userIdçš„è¯ï¼Œå‡è®¾æœ¬æ¬¡è¯·æ±‚æµç¨‹èµ°å®Œäº†ï¼Œå‡†å¤‡åˆ é™¤é”ã€‚æ­¤æ—¶ï¼Œå·§åˆé”åˆ°äº†è¿‡æœŸæ—¶é—´å¤±æ•ˆäº†ã€‚è€Œå¦å¤–ä¸€ä¸ªè¯·æ±‚ï¼Œå·§åˆä½¿ç”¨çš„ç›¸åŒuserIdåŠ é”ï¼Œä¼šæˆåŠŸã€‚è€Œæœ¬æ¬¡è¯·æ±‚åˆ é™¤é”çš„æ—¶å€™ï¼Œåˆ é™¤çš„å…¶å®æ˜¯åˆ«äººçš„é”äº†ã€‚\r\n\r\n\r\n\r\n\r\n- å½“ç„¶ä½¿ç”¨luaè„šæœ¬ä¹Ÿèƒ½é¿å…è¯¥é—®é¢˜ï¼š\r\n\r\n\r\n```shell\r\nif redis.call('get', KEYS[1]) == ARGV[1] then \r\n return redis.call('del', KEYS[1]) \r\nelse \r\n  return 0 \r\nend\r\n```\r\n\r\n\r\n\r\n> å®ƒèƒ½ä¿è¯æŸ¥è¯¢é”æ˜¯å¦å­˜åœ¨å’Œåˆ é™¤é”æ˜¯åŸå­æ“ä½œã€‚\r\n>\r\n\r\n\r\n\r\n####  7.4 è‡ªæ—‹é” \r\n\r\n\r\n\r\n- ä¸Šé¢çš„åŠ é”æ–¹æ³•çœ‹èµ·æ¥å¥½åƒæ²¡æœ‰é—®é¢˜ï¼Œä½†å¦‚æœä½ ä»”ç»†æƒ³æƒ³ï¼Œå¦‚æœæœ‰1ä¸‡çš„è¯·æ±‚åŒæ—¶å»ç«äº‰é‚£æŠŠé”ï¼Œå¯èƒ½åªæœ‰ä¸€ä¸ªè¯·æ±‚æ˜¯æˆåŠŸçš„ï¼Œå…¶ä½™çš„9999ä¸ªè¯·æ±‚éƒ½ä¼šå¤±è´¥ã€‚\r\n\r\n\r\n\r\n\r\n- åœ¨ç§’æ€åœºæ™¯ä¸‹ï¼Œä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ\r\n\r\n  - ç­”ï¼šæ¯1ä¸‡ä¸ªè¯·æ±‚ï¼Œæœ‰1ä¸ªæˆåŠŸã€‚å†1ä¸‡ä¸ªè¯·æ±‚ï¼Œæœ‰1ä¸ªæˆåŠŸã€‚å¦‚æ­¤ä¸‹å»ï¼Œç›´åˆ°åº“å­˜ä¸è¶³ã€‚è¿™å°±å˜æˆå‡åŒ€åˆ†å¸ƒçš„ç§’æ€äº†ï¼Œè·Ÿæˆ‘ä»¬æƒ³è±¡ä¸­çš„ä¸ä¸€æ ·ã€‚\r\n\r\n\r\n\r\n\r\n- å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ\r\n\r\n  - ç­”ï¼šä½¿ç”¨è‡ªæ—‹é”ã€‚\r\n\r\n\r\n```java\r\ntry {\r\n  Long start = System.currentTimeMillis();\r\n  while(true) {\r\n      String result = jedis.set(lockKey, requestId, \"NX\", \"PX\", expireTime);\r\n     if (\"OK\".equals(result)) {\r\n        return true;\r\n     }\r\n     \r\n     long time = System.currentTimeMillis() - start;\r\n      if (time>=timeout) {\r\n          return false;\r\n      }\r\n      try {\r\n          Thread.sleep(50);\r\n      } catch (InterruptedException e) {\r\n          e.printStackTrace();\r\n      }\r\n  }\r\n} finally{\r\n    unlock(lockKey,requestId);\r\n}  \r\nreturn false;\r\n```\r\n\r\n\r\n\r\n> åœ¨è§„å®šçš„æ—¶é—´ï¼Œæ¯”å¦‚500æ¯«ç§’å†…ï¼Œè‡ªæ—‹ä¸æ–­å°è¯•åŠ é”ï¼Œå¦‚æœæˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚å¦‚æœå¤±è´¥ï¼Œåˆ™ä¼‘çœ 50æ¯«ç§’ï¼Œå†å‘èµ·æ–°ä¸€è½®çš„å°è¯•ã€‚å¦‚æœåˆ°äº†è¶…æ—¶æ—¶é—´ï¼Œè¿˜æœªåŠ é”æˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›å¤±è´¥ã€‚\r\n>\r\n\r\n\r\n\r\n####  7.5 redisson \r\n\r\n\r\n\r\n- é™¤äº†ä¸Šé¢çš„é—®é¢˜ä¹‹å¤–ï¼Œä½¿ç”¨redisåˆ†å¸ƒå¼é”ï¼Œè¿˜æœ‰é”ç«äº‰é—®é¢˜ã€ç»­æœŸé—®é¢˜ã€é”é‡å…¥é—®é¢˜ã€å¤šä¸ªrediså®ä¾‹åŠ é”é—®é¢˜ç­‰ã€‚\r\n\r\n- [Redissonåˆ†å¸ƒå¼é”çš„ä½¿ç”¨](https://imlklaus.github.io/posts/%E7%BC%93%E5%AD%98+%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%9C%A8java%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8#_3%E3%80%81redisson-%E5%AE%8C%E6%88%90%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81)\r\n\r\n\r\n\r\n\r\n\r\n\r\n###  8 mqå¼‚æ­¥å¤„ç† \r\n\r\n\r\n\r\n- æˆ‘ä»¬éƒ½çŸ¥é“åœ¨çœŸå®çš„ç§’æ€åœºæ™¯ä¸­ï¼Œæœ‰ä¸‰ä¸ªæ ¸å¿ƒæµç¨‹ï¼š\r\n\r\n\r\n![image-20230429164405754](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429164405754.png)\r\n\r\n\r\n\r\n- è€Œè¿™ä¸‰ä¸ªæ ¸å¿ƒæµç¨‹ä¸­ï¼ŒçœŸæ­£å¹¶å‘é‡å¤§çš„æ˜¯ç§’æ€åŠŸèƒ½ï¼Œä¸‹å•å’Œæ”¯ä»˜åŠŸèƒ½å®é™…å¹¶å‘é‡å¾ˆå°ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨è®¾è®¡ç§’æ€ç³»ç»Ÿæ—¶ï¼Œæœ‰å¿…è¦æŠŠä¸‹å•å’Œæ”¯ä»˜åŠŸèƒ½ä»ç§’æ€çš„ä¸»æµç¨‹ä¸­æ‹†åˆ†å‡ºæ¥ï¼Œç‰¹åˆ«æ˜¯ä¸‹å•åŠŸèƒ½è¦åšæˆmqå¼‚æ­¥å¤„ç†çš„ã€‚è€Œæ”¯ä»˜åŠŸèƒ½ï¼Œæ¯”å¦‚æ”¯ä»˜å®æ”¯ä»˜ï¼Œæ˜¯ä¸šåŠ¡åœºæ™¯æœ¬èº«ä¿è¯çš„å¼‚æ­¥ã€‚\r\n\r\n\r\n\r\n\r\n- äºæ˜¯ï¼Œç§’æ€åä¸‹å•çš„æµç¨‹å˜æˆå¦‚ä¸‹ï¼š\r\n\r\n\r\n![image-20230429164509701](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429164509701.png)\r\n\r\n\r\n\r\n- å¦‚æœä½¿ç”¨mqï¼Œéœ€è¦å…³æ³¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š\r\n\r\n\r\n\r\n\r\n\r\n\r\n####  8.1 æ¶ˆæ¯ä¸¢å¤±é—®é¢˜ \r\n\r\n\r\n\r\n- ç§’æ€æˆåŠŸäº†ï¼Œå¾€mqå‘é€ä¸‹å•æ¶ˆæ¯çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½ä¼šå¤±è´¥ã€‚åŸå› æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼šç½‘ç»œé—®é¢˜ã€brokeræŒ‚äº†ã€mqæœåŠ¡ç«¯ç£ç›˜é—®é¢˜ç­‰ã€‚è¿™äº›æƒ…å†µï¼Œéƒ½å¯èƒ½ä¼šé€ æˆæ¶ˆæ¯ä¸¢å¤±ã€‚\r\n\r\n\r\n\r\n\r\n- é‚£ä¹ˆï¼Œå¦‚ä½•é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±å‘¢ï¼Ÿ\r\n\r\n  - ç­”ï¼šåŠ ä¸€å¼ æ¶ˆæ¯å‘é€è¡¨ã€‚\r\n\r\n\r\n\r\n\r\n![image-20230429164617994](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429164617994.png)\r\n\r\n\r\n\r\n- åœ¨ç”Ÿäº§è€…å‘é€mqæ¶ˆæ¯ä¹‹å‰ï¼Œå…ˆæŠŠè¯¥æ¡æ¶ˆæ¯å†™å…¥æ¶ˆæ¯å‘é€è¡¨ï¼Œåˆå§‹çŠ¶æ€æ˜¯å¾…å¤„ç†ï¼Œç„¶åå†å‘é€mqæ¶ˆæ¯ã€‚æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œå¤„ç†å®Œä¸šåŠ¡é€»è¾‘ä¹‹åï¼Œå†å›è°ƒç”Ÿäº§è€…çš„ä¸€ä¸ªæ¥å£ï¼Œä¿®æ”¹æ¶ˆæ¯çŠ¶æ€ä¸ºå·²å¤„ç†ã€‚\r\n\r\n\r\n\r\n\r\n- å¦‚æœç”Ÿäº§è€…æŠŠæ¶ˆæ¯å†™å…¥æ¶ˆæ¯å‘é€è¡¨ä¹‹åï¼Œå†å‘é€mqæ¶ˆæ¯åˆ°mqæœåŠ¡ç«¯çš„è¿‡ç¨‹ä¸­å¤±è´¥äº†ï¼Œé€ æˆäº†æ¶ˆæ¯ä¸¢å¤±ã€‚\r\n\r\n\r\n\r\n\r\n- è¿™æ—¶å€™ï¼Œè¦å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ\r\n\r\n  - ç­”ï¼šä½¿ç”¨jobï¼Œå¢åŠ é‡è¯•æœºåˆ¶ã€‚\r\n\r\n\r\n\r\n\r\n![image-20230429164724585](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429164724585.png)\r\n\r\n\r\n\r\n> ç”¨jobæ¯éš”ä¸€æ®µæ—¶é—´å»æŸ¥è¯¢æ¶ˆæ¯å‘é€è¡¨ä¸­çŠ¶æ€ä¸ºå¾…å¤„ç†çš„æ•°æ®ï¼Œç„¶åé‡æ–°å‘é€mqæ¶ˆæ¯ã€‚\r\n>\r\n\r\n\r\n\r\n\r\n\r\n####  8.2 é‡å¤æ¶ˆè´¹é—®é¢˜ \r\n\r\n\r\n\r\n- æœ¬æ¥æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œåœ¨ackåº”ç­”çš„æ—¶å€™ï¼Œå¦‚æœç½‘ç»œè¶…æ—¶ï¼Œæœ¬èº«å°±å¯èƒ½ä¼šæ¶ˆè´¹é‡å¤çš„æ¶ˆæ¯ã€‚ä½†ç”±äºæ¶ˆæ¯å‘é€è€…å¢åŠ äº†é‡è¯•æœºåˆ¶ï¼Œä¼šå¯¼è‡´æ¶ˆè´¹è€…é‡å¤æ¶ˆæ¯çš„æ¦‚ç‡å¢å¤§ã€‚\r\n\r\n\r\n\r\n\r\n- é‚£ä¹ˆï¼Œå¦‚ä½•è§£å†³é‡å¤æ¶ˆæ¯é—®é¢˜å‘¢ï¼Ÿ\r\n\r\n  - ç­”ï¼šåŠ ä¸€å¼ æ¶ˆæ¯å¤„ç†è¡¨ã€‚\r\n\r\n\r\n![image-20230429164817906](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429164817906.png)\r\n\r\n\r\n\r\n\r\n\r\n> - æ¶ˆè´¹è€…è¯»åˆ°æ¶ˆæ¯ä¹‹åï¼Œå…ˆåˆ¤æ–­ä¸€ä¸‹æ¶ˆæ¯å¤„ç†è¡¨ï¼Œæ˜¯å¦å­˜åœ¨è¯¥æ¶ˆæ¯ï¼Œå¦‚æœå­˜åœ¨ï¼Œè¡¨ç¤ºæ˜¯é‡å¤æ¶ˆè´¹ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œä¸‹å•æ“ä½œï¼Œæ¥ç€å°†è¯¥æ¶ˆæ¯å†™å…¥æ¶ˆæ¯å¤„ç†è¡¨ä¸­ï¼Œå†è¿”å›ã€‚\r\n>\r\n>\r\n> - æœ‰ä¸ªæ¯”è¾ƒå…³é”®çš„ç‚¹æ˜¯ï¼šä¸‹å•å’Œå†™æ¶ˆæ¯å¤„ç†è¡¨ï¼Œè¦æ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä¿è¯åŸå­æ“ä½œã€‚\r\n>\r\n\r\n\r\n\r\n####  8.3 åƒåœ¾æ¶ˆæ¯é—®é¢˜ \r\n\r\n\r\n\r\n- è¿™å¥—æ–¹æ¡ˆè¡¨é¢ä¸Šçœ‹èµ·æ¥æ²¡æœ‰é—®é¢˜ï¼Œä½†å¦‚æœå‡ºç°äº†æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥çš„æƒ…å†µã€‚æ¯”å¦‚ï¼šç”±äºæŸäº›åŸå› ï¼Œæ¶ˆæ¯æ¶ˆè´¹è€…ä¸‹å•ä¸€ç›´å¤±è´¥ï¼Œä¸€ç›´ä¸èƒ½å›è°ƒçŠ¶æ€å˜æ›´æ¥å£ï¼Œè¿™æ ·jobä¼šä¸åœçš„é‡è¯•å‘æ¶ˆæ¯ã€‚æœ€åï¼Œä¼šäº§ç”Ÿå¤§é‡çš„åƒåœ¾æ¶ˆæ¯ã€‚\r\n\r\n\r\n- é‚£ä¹ˆï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ\r\n\r\n\r\n![image-20230429164937078](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429164937078.png)\r\n\r\n\r\n\r\n> - æ¯æ¬¡åœ¨jobé‡è¯•æ—¶ï¼Œéœ€è¦å…ˆåˆ¤æ–­ä¸€ä¸‹æ¶ˆæ¯å‘é€è¡¨ä¸­è¯¥æ¶ˆæ¯çš„å‘é€æ¬¡æ•°æ˜¯å¦è¾¾åˆ°æœ€å¤§é™åˆ¶ï¼Œå¦‚æœè¾¾åˆ°äº†ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚å¦‚æœæ²¡æœ‰è¾¾åˆ°ï¼Œåˆ™å°†æ¬¡æ•°åŠ 1ï¼Œç„¶åå‘é€æ¶ˆæ¯ã€‚\r\n>\r\n> - è¿™æ ·å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œåªä¼šäº§ç”Ÿå°‘é‡çš„åƒåœ¾æ¶ˆæ¯ï¼Œä¸ä¼šå½±å“åˆ°æ­£å¸¸çš„ä¸šåŠ¡ã€‚\r\n>\r\n\r\n\r\n\r\n####  8.4 å»¶è¿Ÿæ¶ˆè´¹é—®é¢˜ \r\n\r\n\r\n\r\n- é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœç”¨æˆ·ç§’æ€æˆåŠŸäº†ï¼Œä¸‹å•ä¹‹åï¼Œåœ¨15åˆ†é’Ÿä¹‹å†…è¿˜æœªå®Œæˆæ”¯ä»˜çš„è¯ï¼Œè¯¥è®¢å•ä¼šè¢«è‡ªåŠ¨å–æ¶ˆï¼Œå›é€€åº“å­˜ã€‚\r\n\r\n\r\n\r\n\r\n- é‚£ä¹ˆï¼Œåœ¨15åˆ†é’Ÿå†…æœªå®Œæˆæ”¯ä»˜ï¼Œè®¢å•è¢«è‡ªåŠ¨å–æ¶ˆçš„åŠŸèƒ½ï¼Œè¦å¦‚ä½•å®ç°å‘¢ï¼Ÿ\r\n\r\n  - æˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„å¯èƒ½æ˜¯jobï¼Œå› ä¸ºå®ƒæ¯”è¾ƒç®€å•ã€‚\r\n\r\n\r\n  - ä½†jobæœ‰ä¸ªé—®é¢˜ï¼Œéœ€è¦æ¯éš”ä¸€æ®µæ—¶é—´å¤„ç†ä¸€æ¬¡ï¼Œå®æ—¶æ€§ä¸å¤ªå¥½ã€‚\r\n\r\n\r\n\r\n\r\n- è¿˜æœ‰æ›´å¥½çš„æ–¹æ¡ˆï¼Ÿ\r\n\r\n  - ç­”ï¼šä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—ã€‚\r\n\r\n\r\n- æˆ‘ä»¬éƒ½çŸ¥é“rocketmqï¼Œè‡ªå¸¦äº†å»¶è¿Ÿé˜Ÿåˆ—çš„åŠŸèƒ½ã€‚\r\n\r\n\r\n\r\n\r\n![image-20230429165104965](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429165104965.png)\r\n\r\n\r\n\r\n- ä¸‹å•æ—¶æ¶ˆæ¯ç”Ÿäº§è€…ä¼šå…ˆç”Ÿæˆè®¢å•ï¼Œæ­¤æ—¶çŠ¶æ€ä¸ºå¾…æ”¯ä»˜ï¼Œç„¶åä¼šå‘å»¶è¿Ÿé˜Ÿåˆ—ä¸­å‘ä¸€æ¡æ¶ˆæ¯ã€‚è¾¾åˆ°äº†å»¶è¿Ÿæ—¶é—´ï¼Œæ¶ˆæ¯æ¶ˆè´¹è€…è¯»å–æ¶ˆæ¯ä¹‹åï¼Œä¼šæŸ¥è¯¢è¯¥è®¢å•çš„çŠ¶æ€æ˜¯å¦ä¸ºå¾…æ”¯ä»˜ã€‚å¦‚æœæ˜¯å¾…æ”¯ä»˜çŠ¶æ€ï¼Œåˆ™ä¼šæ›´æ–°è®¢å•çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€ã€‚å¦‚æœä¸æ˜¯å¾…æ”¯ä»˜çŠ¶æ€ï¼Œè¯´æ˜è¯¥è®¢å•å·²ç»æ”¯ä»˜è¿‡äº†ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚\r\n\r\n\r\n\r\n\r\n- è¿˜æœ‰ä¸ªå…³é”®ç‚¹ï¼Œç”¨æˆ·å®Œæˆæ”¯ä»˜ä¹‹åï¼Œä¼šä¿®æ”¹è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜ã€‚\r\n\r\n\r\n\r\n\r\n![image-20230429165137323](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429165137323.png)\r\n\r\n\r\n\r\n\r\n\r\n###  9 å¦‚ä½•é™æµï¼Ÿ \r\n\r\n\r\n\r\n- é€šè¿‡ç§’æ€æ´»åŠ¨ï¼Œå¦‚æœæˆ‘ä»¬è¿æ°”çˆ†æ£šï¼Œå¯èƒ½ä¼šç”¨éå¸¸ä½çš„ä»·æ ¼ä¹°åˆ°ä¸é”™çš„å•†å“ï¼ˆè¿™ç§æ¦‚ç‡å ªæ¯”ä¹°ç¦åˆ©å½©ç¥¨ä¸­å¤§å¥–ï¼‰ã€‚\r\n\r\n\r\n\r\n\r\n- ä½†æœ‰äº›é«˜æ‰‹ï¼Œå¹¶ä¸ä¼šåƒæˆ‘ä»¬ä¸€æ ·è€è€å®å®ï¼Œé€šè¿‡ç§’æ€é¡µé¢ç‚¹å‡»ç§’æ€æŒ‰é’®ï¼ŒæŠ¢è´­å•†å“ã€‚ä»–ä»¬å¯èƒ½åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šï¼Œæ¨¡æ‹Ÿæ­£å¸¸ç”¨æˆ·ç™»å½•ç³»ç»Ÿï¼Œè·³è¿‡ç§’æ€é¡µé¢ï¼Œç›´æ¥è°ƒç”¨ç§’æ€æ¥å£ã€‚\r\n\r\n\r\n\r\n\r\n- å¦‚æœæ˜¯æˆ‘ä»¬æ‰‹åŠ¨æ“ä½œï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ç§’é’Ÿåªèƒ½ç‚¹å‡»ä¸€æ¬¡ç§’æ€æŒ‰é’®ã€‚\r\n\r\n\r\n![image-20230429165212649](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429165212649.png)\r\n\r\n\r\n\r\n- ä½†æ˜¯å¦‚æœæ˜¯æœåŠ¡å™¨ï¼Œä¸€ç§’é’Ÿå¯ä»¥è¯·æ±‚æˆä¸Šåƒæ¥å£ã€‚\r\n\r\n\r\n![image-20230429165302898](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429165302898.png)\r\n\r\n\r\n\r\n> - è¿™ç§å·®è·å®åœ¨å¤ªæ˜æ˜¾äº†ï¼Œå¦‚æœä¸åšä»»ä½•é™åˆ¶ï¼Œç»å¤§éƒ¨åˆ†å•†å“å¯èƒ½æ˜¯è¢«æœºå™¨æŠ¢åˆ°ï¼Œè€Œéæ­£å¸¸çš„ç”¨æˆ·ï¼Œæœ‰ç‚¹ä¸å¤ªå…¬å¹³ã€‚\r\n>\r\n> - æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ‰å¿…è¦è¯†åˆ«è¿™äº›éæ³•è¯·æ±‚ï¼Œåšä¸€äº›é™åˆ¶ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç°åœ¨è¿™äº›éæ³•è¯·æ±‚å‘¢ï¼Ÿ\r\n>\r\n> - ç›®å‰æœ‰ä¸¤ç§å¸¸ç”¨çš„é™æµæ–¹å¼ï¼š\r\n>\r\n>   - 1åŸºäºnginxé™æµ\r\n>   - 2åŸºäºredisé™æµ\r\n\r\n\r\n\r\n####  9.1 å¯¹åŒä¸€ç”¨æˆ·é™æµ \r\n\r\n\r\n\r\n- ä¸ºäº†é˜²æ­¢æŸä¸ªç”¨æˆ·ï¼Œè¯·æ±‚æ¥å£æ¬¡æ•°è¿‡äºé¢‘ç¹ï¼Œå¯ä»¥åªé’ˆå¯¹è¯¥ç”¨æˆ·åšé™åˆ¶ã€‚\r\n\r\n\r\n![image-20230429165408344](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429165408344.png)\r\n\r\n\r\n\r\n> é™åˆ¶åŒä¸€ä¸ªç”¨æˆ·idï¼Œæ¯”å¦‚æ¯åˆ†é’Ÿåªèƒ½è¯·æ±‚5æ¬¡æ¥å£ã€‚\r\n>\r\n\r\n\r\n\r\n\r\n\r\n####  9.2 å¯¹åŒä¸€ipé™æµ \r\n\r\n\r\n\r\n- æœ‰æ—¶å€™åªå¯¹æŸä¸ªç”¨æˆ·é™æµæ˜¯ä¸å¤Ÿçš„ï¼Œæœ‰äº›é«˜æ‰‹å¯ä»¥æ¨¡æ‹Ÿå¤šä¸ªç”¨æˆ·è¯·æ±‚ï¼Œè¿™ç§nginxå°±æ²¡æ³•è¯†åˆ«äº†ã€‚\r\n\r\n\r\n\r\n\r\n- è¿™æ—¶éœ€è¦åŠ åŒä¸€ipé™æµåŠŸèƒ½ã€‚\r\n\r\n\r\n![image-20230429165439488](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429165439488.png)\r\n\r\n\r\n\r\n> - é™åˆ¶åŒä¸€ä¸ªipï¼Œæ¯”å¦‚æ¯åˆ†é’Ÿåªèƒ½è¯·æ±‚5æ¬¡æ¥å£ã€‚\r\n>\r\n> - ä½†è¿™ç§é™æµæ–¹å¼å¯èƒ½ä¼šæœ‰è¯¯æ€çš„æƒ…å†µï¼Œæ¯”å¦‚åŒä¸€ä¸ªå…¬å¸æˆ–ç½‘å§çš„å‡ºå£ipæ˜¯ç›¸åŒçš„ï¼Œå¦‚æœé‡Œé¢æœ‰å¤šä¸ªæ­£å¸¸ç”¨æˆ·åŒæ—¶å‘èµ·è¯·æ±‚ï¼Œæœ‰äº›ç”¨æˆ·å¯èƒ½ä¼šè¢«é™åˆ¶ä½ã€‚\r\n>\r\n\r\n\r\n\r\n####  9.3 å¯¹æ¥å£é™æµ \r\n\r\n\r\n\r\n- åˆ«ä»¥ä¸ºé™åˆ¶äº†ç”¨æˆ·å’Œipå°±ä¸‡äº‹å¤§å‰ï¼Œæœ‰äº›é«˜æ‰‹ç”šè‡³å¯ä»¥ä½¿ç”¨ä»£ç†ï¼Œæ¯æ¬¡éƒ½è¯·æ±‚éƒ½æ¢ä¸€ä¸ªipã€‚\r\n\r\n\r\n\r\n\r\n- è¿™æ—¶å¯ä»¥é™åˆ¶è¯·æ±‚çš„æ¥å£æ€»æ¬¡æ•°ã€‚\r\n\r\n\r\n![image-20230429165519105](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429165519105.png)\r\n\r\n\r\n\r\n> åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¿™ç§é™åˆ¶å¯¹äºç³»ç»Ÿçš„ç¨³å®šæ€§æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚ä½†å¯èƒ½ç”±äºæœ‰äº›éæ³•è¯·æ±‚æ¬¡æ•°å¤ªå¤šï¼Œè¾¾åˆ°äº†è¯¥æ¥å£çš„è¯·æ±‚ä¸Šé™ï¼Œè€Œå½±å“å…¶ä»–çš„æ­£å¸¸ç”¨æˆ·è®¿é—®è¯¥æ¥å£ã€‚çœ‹èµ·æ¥æœ‰ç‚¹å¾—ä¸å¿å¤±ã€‚\r\n>\r\n\r\n\r\n\r\n\r\n\r\n####  9.4 åŠ éªŒè¯ç  \r\n\r\n\r\n\r\n- ç›¸å¯¹äºä¸Šé¢ä¸‰ç§æ–¹å¼ï¼ŒåŠ éªŒè¯ç çš„æ–¹å¼å¯èƒ½æ›´ç²¾å‡†ä¸€äº›ï¼ŒåŒæ ·èƒ½é™åˆ¶ç”¨æˆ·çš„è®¿é—®é¢‘æ¬¡ï¼Œä½†å¥½å¤„æ˜¯ä¸ä¼šå­˜åœ¨è¯¯æ€çš„æƒ…å†µã€‚\r\n\r\n\r\n\r\n\r\n![image-20230429165554440](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429165554440.png)\r\n\r\n\r\n\r\n> - é€šå¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·åœ¨è¯·æ±‚ä¹‹å‰ï¼Œéœ€è¦å…ˆè¾“å…¥éªŒè¯ç ã€‚ç”¨æˆ·å‘èµ·è¯·æ±‚ä¹‹åï¼ŒæœåŠ¡ç«¯ä¼šå»æ ¡éªŒè¯¥éªŒè¯ç æ˜¯å¦æ­£ç¡®ã€‚åªæœ‰æ­£ç¡®æ‰å…è®¸è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œå¦åˆ™ç›´æ¥è¿”å›ï¼Œå¹¶ä¸”æç¤ºéªŒè¯ç é”™è¯¯ã€‚\r\n>\r\n> - æ­¤å¤–ï¼ŒéªŒè¯ç ä¸€èˆ¬æ˜¯ä¸€æ¬¡æ€§çš„ï¼ŒåŒä¸€ä¸ªéªŒè¯ç åªå…è®¸ä½¿ç”¨ä¸€æ¬¡ï¼Œä¸å…è®¸é‡å¤ä½¿ç”¨ã€‚\r\n>\r\n> - æ™®é€šéªŒè¯ç ï¼Œç”±äºç”Ÿæˆçš„æ•°å­—æˆ–è€…å›¾æ¡ˆæ¯”è¾ƒç®€å•ï¼Œå¯èƒ½ä¼šè¢«ç ´è§£ã€‚ä¼˜ç‚¹æ˜¯ç”Ÿæˆé€Ÿåº¦æ¯”è¾ƒå¿«ï¼Œç¼ºç‚¹æ˜¯æœ‰å®‰å…¨éšæ‚£ã€‚\r\n>\r\n> - è¿˜æœ‰ä¸€ä¸ªéªŒè¯ç å«åšï¼šç§»åŠ¨æ»‘å—ï¼Œå®ƒç”Ÿæˆé€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œä½†æ¯”è¾ƒå®‰å…¨ï¼Œæ˜¯ç›®å‰å„å¤§äº’è”ç½‘å…¬å¸çš„é¦–é€‰ã€‚\r\n>\r\n\r\n\r\n\r\n####  9.5 æé«˜ä¸šåŠ¡é—¨æ§› \r\n\r\n\r\n\r\n> - ä¸Šé¢è¯´çš„åŠ éªŒè¯ç è™½ç„¶å¯ä»¥é™åˆ¶éæ³•ç”¨æˆ·è¯·æ±‚ï¼Œä½†æ˜¯æœ‰äº›å½±å“ç”¨æˆ·ä½“éªŒã€‚ç”¨æˆ·ç‚¹å‡»ç§’æ€æŒ‰é’®å‰ï¼Œè¿˜è¦å…ˆè¾“å…¥éªŒè¯ç ï¼Œæµç¨‹æ˜¾å¾—æœ‰ç‚¹ç¹çï¼Œç§’æ€åŠŸèƒ½çš„æµç¨‹ä¸æ˜¯åº”è¯¥è¶Šç®€å•è¶Šå¥½å—ï¼Ÿ\r\n>\r\n> - å…¶å®ï¼Œæœ‰æ—¶å€™è¾¾åˆ°æŸä¸ªç›®çš„ï¼Œä¸ä¸€å®šéè¦é€šè¿‡æŠ€æœ¯æ‰‹æ®µï¼Œé€šè¿‡ä¸šåŠ¡æ‰‹æ®µä¹Ÿä¸€æ ·ã€‚\r\n>\r\n> - 12306åˆšå¼€å§‹çš„æ—¶å€™ï¼Œå…¨å›½äººæ°‘éƒ½åœ¨åŒä¸€æ—¶åˆ»æŠ¢ç«è½¦ç¥¨ï¼Œç”±äºå¹¶å‘é‡å¤ªå¤§ï¼Œç³»ç»Ÿç»å¸¸æŒ‚ã€‚åæ¥ï¼Œé‡æ„ä¼˜åŒ–ä¹‹åï¼Œå°†è´­ä¹°å‘¨æœŸæ”¾é•¿äº†ï¼Œå¯ä»¥æå‰20å¤©è´­ä¹°ç«è½¦ç¥¨ï¼Œå¹¶ä¸”å¯ä»¥åœ¨9ç‚¹ã€10ã€11ç‚¹ã€12ç‚¹ç­‰æ•´ç‚¹è´­ä¹°ç«è½¦ç¥¨ã€‚è°ƒæ•´ä¸šåŠ¡ä¹‹åï¼ˆå½“ç„¶æŠ€æœ¯ä¹Ÿæœ‰å¾ˆå¤šè°ƒæ•´ï¼‰ï¼Œå°†ä¹‹å‰é›†ä¸­çš„è¯·æ±‚ï¼Œåˆ†æ•£å¼€äº†ï¼Œä¸€ä¸‹å­é™ä½äº†ç”¨æˆ·å¹¶å‘é‡ã€‚\r\n> - å›åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡æé«˜ä¸šåŠ¡é—¨æ§›ï¼Œæ¯”å¦‚åªæœ‰ä¼šå‘˜æ‰èƒ½å‚ä¸ç§’æ€æ´»åŠ¨ï¼Œæ™®é€šæ³¨å†Œç”¨æˆ·æ²¡æœ‰æƒé™ã€‚æˆ–è€…ï¼Œåªæœ‰ç­‰çº§åˆ°è¾¾3çº§ä»¥ä¸Šçš„æ™®é€šç”¨æˆ·ï¼Œæ‰æœ‰èµ„æ ¼å‚åŠ è¯¥æ´»åŠ¨ã€‚\r\n>\r\n> - è¿™æ ·ç®€å•çš„æé«˜ä¸€ç‚¹é—¨æ§›ï¼Œå³ä½¿æ˜¯é»„ç‰›å…šä¹ŸæŸæ‰‹æ— ç­–ï¼Œä»–ä»¬æ€»ä¸å¯èƒ½ä¸ºäº†å‚åŠ ä¸€æ¬¡ç§’æ€æ´»åŠ¨ï¼Œè¿˜å¦å¤–èŠ±é’±å……å€¼ä¼šå‘˜å§ï¼Ÿ\r\n>\r\n\r\n\r\n\r\n\r\n\r\n## ç§’æ€ç³»ç»Ÿé¡¹ç›®å®æˆ˜\r\n\r\n### 1 ç§’æ€ä¸šåŠ¡æ¦‚è¦\r\n\r\n\r\n\r\n- ç§’æ€å…·æœ‰ç¬é—´é«˜å¹¶å‘çš„ç‰¹ç‚¹ï¼Œé’ˆå¯¹è¿™ä¸€ç‰¹ç‚¹ï¼Œå¿…é¡»è¦åšåˆ°é™æµ + å¼‚æ­¥ + ç¼“å­˜ï¼ˆé¡µé¢é™æ€åŒ–ï¼‰ + ç‹¬ç«‹éƒ¨ç½²\r\n- é™æµæ–¹å¼ï¼š\r\n  1. å‰ç«¯é™æµï¼Œä¸€äº›é«˜å¹¶å‘çš„ç½‘ç«™ç›´æ¥åœ¨å‰ç«¯é¡µé¢å¼€å§‹é™æµï¼Œåˆ—å¦‚ï¼šå°ç±³çš„éªŒè¯ç \r\n  2. nginxé™æµï¼Œç›´æ¥è´Ÿè½½éƒ¨åˆ†è¯·æ±‚åˆ°é”™è¯¯çš„é™æ€é¡µé¢ï¼Œä»¤ç‰Œç®—æ³•ã€æ¼æ–—ç®—æ³•\r\n  3. ç½‘å…³é™æµã€é™æµçš„è¿‡æ»¤å™¨\r\n  4. ä»£ç ä¸­ä½¿ç”¨åˆ†å¸ƒå¼ä¿¡å·é‡\r\n  5. rabbitmqé™æµï¼ˆèƒ½è€…å¤šåŠ³ channel.basicQos(1)ï¼‰ä¿è¯å‘æŒ¥æœåŠ¡å™¨çš„æ‰€ç”¨æ€§èƒ½\r\n\r\n- ç§’æ€æ¶æ„å›¾\r\n\r\n![image-20230429224850779](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429224850779.png)\r\n\r\n\r\n\r\n### 2 ç§’æ€æµç¨‹\r\n\r\n- å‚è€ƒäº¬ä¸œç§’æ€æµç¨‹\r\n- è§ç§’æ€æµç¨‹å›¾\r\n\r\n\r\n\r\n- **ç§’æ€æ–¹å¼ä¸€**\r\n\r\n![image-20230430003804352](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430003804352.png)\r\n\r\n\r\n\r\n- **ç§’æ€æ–¹å¼äºŒ**\r\n\r\n![image-20230430003907398](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430003907398.png)\r\n\r\n\r\n\r\n\r\n\r\n### 3 ç§’æ€æ ¸å¿ƒä¸šåŠ¡\r\n\r\n#### 3.1 åå°æ·»åŠ ç§’æ€å•†å“\r\n\r\n![image-20230430133519183](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430133519183.png)\r\n\r\n- å…³è”å•†å“\r\n\r\n![image-20230430133622474](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430133622474.png)\r\n\r\n- åˆ†é¡µæŸ¥è¯¢å…³è”å•†å“\r\n\r\n```java\r\n@Service(\"seckillSkuRelationService\")\r\npublic class SeckillSkuRelationServiceImpl extends ServiceImpl<SeckillSkuRelationDao, SeckillSkuRelationEntity> implements SeckillSkuRelationService {\r\n\r\n    @Override\r\n    public PageUtils queryPage(Map<String, Object> params) {\r\n        QueryWrapper<SeckillSkuRelationEntity> queryWrapper = new QueryWrapper<SeckillSkuRelationEntity>();\r\n        String promotionSessionId = (String) params.get(\"promotionSessionId\");\r\n        String key = (String) params.get(\"key\");\r\n        if (!StringUtils.isEmpty(key)){\r\n            queryWrapper.eq(\"sku_id\", key).or().eq(\"seckill_price\", key);\r\n        }\r\n        if (!StringUtils.isEmpty(promotionSessionId)){\r\n            //æ ¹æ®åœºæ¬¡idè¿›è¡ŒæŸ¥è¯¢\r\n            queryWrapper.eq(\"promotion_session_id\", promotionSessionId);\r\n        }\r\n\r\n        IPage<SeckillSkuRelationEntity> page = this.page(\r\n                new Query<SeckillSkuRelationEntity>().getPage(params),\r\n                queryWrapper\r\n        );\r\n\r\n        return new PageUtils(page);\r\n    }\r\n\r\n}\r\n```\r\n\r\n![image-20230430134014948](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430134014948.png)\r\n\r\n![image-20230430134032296](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430134032296.png)\r\n\r\n![image-20230430134056247](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430134056247.png)\r\n\r\n![image-20230430134613785](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430134613785.png)\r\n\r\n![image-20230430134650173](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430134650173.png)\r\n\r\n\r\n\r\n#### å®šæ—¶ä»»åŠ¡\r\n\r\n##### 1.cronè¡¨è¾¾å¼\r\n\r\nè¯­æ³•ï¼šç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨ å¹´ï¼ˆSpringä¸æ”¯æŒï¼‰\r\n\r\nhttps://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html\r\n\r\n![image-20230430135420949](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430135420949.png)\r\n\r\nç‰¹æ®Šå­—ç¬¦ï¼š\r\n\r\n- *ï¼ˆ â€œæ‰€æœ‰å€¼â€ï¼‰-ç”¨äºé€‰æ‹©å­—æ®µä¸­çš„æ‰€æœ‰å€¼ã€‚ä¾‹å¦‚ï¼Œåˆ†é’Ÿå­—æ®µä¸­çš„â€œ  â€è¡¨ç¤ºâ€œæ¯åˆ†é’Ÿâ€*ã€‚\r\n- ï¼Ÿï¼ˆ â€œæ— ç‰¹å®šå€¼â€ï¼‰-å½“æ‚¨éœ€è¦åœ¨å…è®¸ä½¿ç”¨å­—ç¬¦çš„ä¸¤ä¸ªå­—æ®µä¹‹ä¸€ä¸­æŒ‡å®šæŸä¸ªå†…å®¹è€Œåœ¨å¦ä¸€ä¸ªä¸å…è®¸çš„å­—æ®µä¸­æŒ‡å®šæŸäº›å†…å®¹æ—¶å¾ˆæœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘å¸Œæœ›åœ¨æŸä¸ªæœˆçš„æŸä¸ªç‰¹å®šæ—¥æœŸï¼ˆä¾‹å¦‚ï¼Œç¬¬10å¤©ï¼‰è§¦å‘è§¦å‘å™¨ï¼Œä½†ä¸åœ¨ä¹ä¸€å‘¨ä¸­çš„å“ªä¸€å¤©å‘ç”Ÿï¼Œåˆ™å°†â€œ 10â€è®¾ç½®ä¸ºæœˆå­—æ®µï¼Œä»¥åŠâ€œï¼Ÿâ€ åœ¨â€œæ˜ŸæœŸå‡ â€å­—æ®µä¸­ã€‚è¯·å‚é˜…ä¸‹é¢çš„ç¤ºä¾‹ä»¥è¿›è¡Œæ¾„æ¸…ã€‚\r\n- --ç”¨äºæŒ‡å®šèŒƒå›´ã€‚ä¾‹å¦‚ï¼Œå°æ—¶å­—æ®µä¸­çš„â€œ 10-12â€è¡¨ç¤ºâ€œå°æ—¶10ã€11å’Œ12â€ã€‚\r\n- ï¼Œ -ç”¨äºæŒ‡å®šå…¶ä»–å€¼ã€‚ä¾‹å¦‚ï¼Œâ€œæ˜ŸæœŸå‡ â€å­—æ®µä¸­çš„â€œ MONï¼ŒWEDï¼ŒFRIâ€è¡¨ç¤ºâ€œæ˜ŸæœŸä¸€ï¼Œæ˜ŸæœŸä¸‰å’Œæ˜ŸæœŸäº”çš„æ—¥å­â€ã€‚\r\n- / -ç”¨äºæŒ‡å®šå¢é‡ã€‚ä¾‹å¦‚ï¼Œç§’å­—æ®µä¸­çš„â€œ 0/15â€è¡¨ç¤ºâ€œç§’0ã€15ã€30å’Œ45â€ã€‚ç§’å­—æ®µä¸­çš„â€œ 5/15â€è¡¨ç¤ºâ€œç§’5ã€20ã€35å’Œ50â€ã€‚æ‚¨è¿˜å¯ä»¥åœ¨â€œ â€å­—ç¬¦åæŒ‡å®šâ€œ /â€ -åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œâ€œ â€ç­‰æ•ˆäºåœ¨â€œ /â€ä¹‹å‰ä½¿ç”¨â€œ 0â€ã€‚æ¯æœˆæ—¥æœŸå­—æ®µä¸­çš„â€œ 1/3â€è¡¨ç¤ºâ€œä»è¯¥æœˆçš„ç¬¬ä¸€å¤©å¼€å§‹æ¯ä¸‰å¤©è§¦å‘ä¸€æ¬¡â€ã€‚\r\n- Lï¼ˆ â€œæœ€åä¸€ä¸ªâ€ï¼‰-åœ¨å…è®¸ä½¿ç”¨çš„ä¸¤ä¸ªå­—æ®µä¸­éƒ½æœ‰ä¸åŒçš„å«ä¹‰ã€‚ä¾‹å¦‚ï¼Œâ€œæœˆâ€å­—æ®µä¸­çš„å€¼â€œ Lâ€è¡¨ç¤ºâ€œæœˆçš„æœ€åä¸€å¤©â€ï¼Œå³éJanuaryå¹´çš„1æœˆ31æ—¥ï¼Œ2æœˆ28æ—¥ã€‚å¦‚æœå•ç‹¬ç”¨äºæ˜ŸæœŸå‡ å­—æ®µï¼Œåˆ™ä»…è¡¨ç¤ºâ€œ 7â€æˆ–â€œ SATâ€ã€‚ä½†æ˜¯ï¼Œå¦‚æœåœ¨æ˜ŸæœŸå‡ å­—æ®µä¸­ä½¿ç”¨å¦ä¸€ä¸ªå€¼ï¼Œåˆ™è¡¨ç¤ºâ€œè¯¥æœˆçš„æœ€åxxxå¤©â€ï¼Œä¾‹å¦‚â€œ 6Lâ€è¡¨ç¤ºâ€œè¯¥æœˆçš„æœ€åä¸€ä¸ªæ˜ŸæœŸäº”â€ã€‚æ‚¨è¿˜å¯ä»¥æŒ‡å®šä¸è¯¥æœˆæœ€åä¸€å¤©çš„åç§»é‡ï¼Œä¾‹å¦‚â€œ L-3â€ï¼Œè¿™è¡¨ç¤ºæ—¥å†æœˆçš„å€’æ•°ç¬¬ä¸‰å¤©ã€‚ ä½¿ç”¨â€œ Lâ€é€‰é¡¹æ—¶ï¼Œä¸è¦æŒ‡å®šåˆ—è¡¨æˆ–å€¼çš„èŒƒå›´å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™æ ·ä¼šå¯¼è‡´æ··æ·†/æ„å¤–ç»“æœã€‚\r\n- Wï¼ˆ â€œå·¥ä½œæ—¥â€ï¼‰-ç”¨äºæŒ‡å®šæœ€æ¥è¿‘ç»™å®šæ—¥æœŸçš„å·¥ä½œæ—¥ï¼ˆæ˜ŸæœŸä¸€è‡³æ˜ŸæœŸäº”ï¼‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨è¦æŒ‡å®šâ€œ 15Wâ€ä½œä¸ºâ€œæœˆæ—¥â€å­—æ®µçš„å€¼ï¼Œåˆ™å«ä¹‰æ˜¯ï¼š â€œç¦»æœˆ15æ—¥æœ€è¿‘çš„å·¥ä½œæ—¥â€ã€‚å› æ­¤ï¼Œå¦‚æœ15å·æ˜¯æ˜ŸæœŸå…­ï¼Œåˆ™è§¦å‘å™¨å°†åœ¨14å·æ˜ŸæœŸäº”è§¦å‘ã€‚å¦‚æœ15æ—¥æ˜¯æ˜ŸæœŸæ—¥ï¼Œåˆ™è§¦å‘å™¨å°†åœ¨16æ—¥æ˜ŸæœŸä¸€è§¦å‘ã€‚å¦‚æœ15å·æ˜¯æ˜ŸæœŸäºŒï¼Œé‚£ä¹ˆå®ƒå°†åœ¨15å·æ˜ŸæœŸäºŒè§¦å‘ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨å°†â€œ 1Wâ€æŒ‡å®šä¸ºæœˆä»½çš„å€¼ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªæ˜¯æ˜ŸæœŸå…­ï¼Œåˆ™è§¦å‘å™¨å°†åœ¨ç¬¬3ä¸ªæ˜ŸæœŸä¸€è§¦å‘ï¼Œå› ä¸ºå®ƒä¸ä¼šâ€œè·³è¿‡â€ä¸€ä¸ªæœˆæ—¥çš„è¾¹ç•Œã€‚ä»…å½“æœˆä»½ä¸­çš„æŸå¤©æ˜¯ä¸€å¤©ï¼Œè€Œä¸æ˜¯èŒƒå›´æˆ–å¤©æ•°åˆ—è¡¨æ—¶ï¼Œæ‰å¯ä»¥æŒ‡å®šâ€œ Wâ€å­—ç¬¦ã€‚\r\n\r\n> â€œ Lâ€å’Œâ€œ Wâ€å­—ç¬¦ä¹Ÿå¯ä»¥åœ¨â€œæœˆæ—¥â€å­—æ®µä¸­ç»„åˆä»¥äº§ç”Ÿâ€œ LWâ€ï¼Œè¿™è¡¨ç¤ºâ€œæ¯æœˆçš„æœ€åä¸€ä¸ªå·¥ä½œæ—¥â€ ã€‚\r\n\r\n- ï¼ƒ -ç”¨äºæŒ‡å®šæ¯æœˆçš„ç¬¬â€œ XXXâ€å¤©ã€‚ä¾‹å¦‚ï¼Œâ€œæ˜ŸæœŸå‡ â€å­—æ®µä¸­çš„å€¼â€œ 6ï¼ƒ3â€è¡¨ç¤ºâ€œè¯¥æœˆçš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”â€ï¼ˆç¬¬6å¤©=æ˜ŸæœŸäº”ï¼Œâ€œï¼ƒ3â€ =è¯¥æœˆçš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”ï¼‰ã€‚å…¶ä»–ç¤ºä¾‹ï¼šâ€œ 2ï¼ƒ1â€ =è¯¥æœˆçš„ç¬¬ä¸€ä¸ªæ˜ŸæœŸä¸€ï¼Œâ€œ 4ï¼ƒ5â€ =è¯¥æœˆçš„ç¬¬äº”ä¸ªæ˜ŸæœŸä¸‰ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨æŒ‡å®šâ€œï¼ƒ5â€ï¼Œå¹¶ä¸”è¯¥æœˆçš„æŒ‡å®šæ˜ŸæœŸå‡ ä¸­æ²¡æœ‰5ä¸ªï¼Œåˆ™è¯¥æœˆå°†ä¸ä¼šè§¦å‘ã€‚\r\n\r\n> æ³•å®šå­—ç¬¦ä»¥åŠæœˆä»½å’Œæ˜ŸæœŸå‡ çš„åç§°ä¸åŒºåˆ†å¤§å°å†™ã€‚MON ä¸monç›¸åŒã€‚\r\n\r\n\r\n\r\n\r\n\r\n##### 2.cron ç¤ºä¾‹\r\n\r\n| **Expression**             | **Meaning**                                                  |\r\n| -------------------------- | ------------------------------------------------------------ |\r\n| `0 0 12 * * ?`             | Fire at 12pm (noon) every day                                |\r\n| `0 15 10 ? * *`            | Fire at 10:15am every day                                    |\r\n| `0 15 10 * * ?`            | Fire at 10:15am every day                                    |\r\n| `0 15 10 * * ? *`          | Fire at 10:15am every day                                    |\r\n| `0 15 10 * * ? 2005`       | Fire at 10:15am every day during the year 2005               |\r\n| `0 * 14 * * ?`             | Fire every minute starting at 2pm and ending at 2:59pm, every day |\r\n| `0 0/5 14 * * ?`           | Fire every 5 minutes starting at 2pm and ending at 2:55pm, every day |\r\n| `0 0/5 14,18 * * ?`        | Fire every 5 minutes starting at 2pm and ending at 2:55pm, AND fire every 5 minutes starting at 6pm and ending at 6:55pm, every day |\r\n| `0 0-5 14 * * ?`           | Fire every minute starting at 2pm and ending at 2:05pm, every day |\r\n| `0 10,44 14 ? 3 WED`       | Fire at 2:10pm and at 2:44pm every Wednesday in the month of March. |\r\n| `0 15 10 ? * MON-FRI`      | Fire at 10:15am every Monday, Tuesday, Wednesday, Thursday and Friday |\r\n| `0 15 10 15 * ?`           | Fire at 10:15am on the 15th day of every month               |\r\n| `0 15 10 L * ?`            | Fire at 10:15am on the last day of every month               |\r\n| `0 15 10 L-2 * ?`          | Fire at 10:15am on the 2nd-to-last last day of every month   |\r\n| `0 15 10 ? * 6L`           | Fire at 10:15am on the last Friday of every month            |\r\n| `0 15 10 ? * 6L`           | Fire at 10:15am on the last Friday of every month            |\r\n| `0 15 10 ? * 6L 2002-2005` | Fire at 10:15am on every last friday of every month during the years 2002, 2003, 2004 and 2005 |\r\n| `0 15 10 ? * 6#3`          | Fire at 10:15am on the third Friday of every month           |\r\n| `0 0 12 1/5 * ?`           | Fire at 12pm (noon) every 5 days every month, starting on the first day of the month. |\r\n| `0 11 11 11 11 ?`          | Fire every November 11th at 11:11am.                         |\r\n\r\n\r\n\r\n##### 3.SpringBootæ•´åˆå®šæ—¶ä»»åŠ¡\r\n\r\nå®šæ—¶ä»»åŠ¡ç›¸å…³æ³¨è§£:\r\n\r\n```java\r\n@EnableAsync // å¯ç”¨Springå¼‚æ­¥ä»»åŠ¡æ”¯æŒ\r\n@EnableScheduling // å¯ç”¨Springçš„è®¡åˆ’ä»»åŠ¡æ‰§è¡ŒåŠŸèƒ½\r\n@Async å¼‚æ­¥\r\n@Scheduled(cron = \"* * * * * ?\")\r\n```\r\n\r\nä»£ç ï¼š\r\n\r\n```java\r\n/**\r\n *\r\n * å®šæ—¶ä»»åŠ¡\r\n *      1ã€@EnableScheduling å¼€å¯å®šæ—¶ä»»åŠ¡\r\n *      2ã€Scheduled å¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡\r\n *      3ã€è‡ªåŠ¨é…ç½®ç±» TaskSchedulingAutoConfiguration å±æ€§ç»‘å®šåœ¨TaskExecutionProperties\r\n *\r\n * å¼‚æ­¥ä»»åŠ¡\r\n *      1ã€@EnableAsync å¼€å¯å¼‚æ­¥ä»»åŠ¡åŠŸèƒ½\r\n *      2ã€@Async ç»™å¸Œæœ›å¼‚æ­¥æ‰§è¡Œçš„æ–¹æ³•ä¸Šæ ‡æ³¨\r\n *      3ã€è‡ªåŠ¨é…ç½®ç±» TaskExecutionAutoConfiguration\r\n *\r\n */\r\n@Slf4j\r\n@Component\r\n@EnableAsync // å¯ç”¨Springå¼‚æ­¥ä»»åŠ¡æ”¯æŒ\r\n@EnableScheduling // å¯ç”¨Springçš„è®¡åˆ’ä»»åŠ¡æ‰§è¡ŒåŠŸèƒ½\r\npublic class HelloSchedule {\r\n\r\n    /**\r\n     * 1ã€Springä¸­6ä½ç»„æˆï¼Œä¸å…è®¸ç¬¬7ä½çš„å¹´\r\n     * 2ã€åœ¨å‘¨å‡ çš„ä½ç½®ï¼Œ1-7ä»£è¡¨å‘¨ä¸€åˆ°å‘¨æ—¥ï¼šMON-SUN\r\n     * 3ã€å®šæ—¶ä»»åŠ¡åº”è¯¥é˜»å¡ï¼Œé»˜è®¤æ˜¯é˜»å¡çš„\r\n     *      1ã€å¯ä»¥è®©ä¸šåŠ¡ä»¥å¼‚æ­¥çš„æ–¹å¼è¿è¡Œï¼Œè‡ªå·±æäº¤åˆ°çº¿ç¨‹æ± \r\n     *          CompletableFuture.runAsync(() -> {\r\n     *              xxxService.hello();\r\n     *          })\r\n     *      2ã€æ”¯æŒå®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± ï¼Œè®¾ç½® TaskSchedulingProperties\r\n     *          spring.task.scheduling.pool.size=5\r\n     *      3ã€è®©å®šæ—¶ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ\r\n     *          å¼‚æ­¥æ‰§è¡Œ\r\n     *     è§£å†³ï¼šä½¿ç”¨å¼‚æ­¥ + å®šæ—¶ä»»åŠ¡æ¥å®Œæˆå®šæ—¶ä»»åŠ¡ä¸é˜»å¡çš„åŠŸèƒ½\r\n     */\r\n//    @Async å¼‚æ­¥\r\n//    @Scheduled(cron = \"* * * * * ?\")\r\n//    public void hello() {\r\n//        log.info(\"hello...\");\r\n//    }\r\n}\r\n```\r\n\r\n```properties\r\nspring.task.execution.pool.core-size=5\r\nspring.task.execution.pool.max-size=50\r\n```\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n#### 3.2 ç§’æ€å•†å“ä¸Šæ¶\r\n\r\n- å®šæ—¶ä¸Šæ¶ç§’æ€å•†å“\r\n\r\n```java\r\n/**\r\n *  * ç§’æ€å•†å“çš„å®šæ—¶ä¸Šæ¶ï¼›\r\n *  *      æ¯å¤©æ™šä¸Š3ç‚¹ï¼›ä¸Šæ¶æœ€è¿‘ä¸‰å¤©éœ€è¦ç§’æ€çš„å•†å“\r\n *  *      å½“å¤©00:00:00 - 23:59:59\r\n *  *      æ˜å¤©å¤©00:00:00 - 23:59:59\r\n *  *      åå¤©00:00:00 - 23:59:59\r\n * @author Klaus\r\n * @date 2022/9/27\r\n */\r\n@Slf4j\r\n@Service\r\npublic class SeckillSkuScheduled {\r\n\r\n    @Autowired\r\n    SeckillService seckillService;\r\n\r\n    @Scheduled(cron = \"0 0 1/1 * * ? \")\r\n    public void uploadSeckillSkuLatest3Days(){\r\n         seckillService.uploadSeckillSkuLatest3Days();\r\n    }\r\n}\r\n```\r\n\r\n- è¿œç¨‹è·å–è¿‘ä¸‰å¤©ç§’æ€å•†å“\r\n\r\n```java\r\n@FeignClient(\"gulimall-coupon\")\r\npublic interface CouponFeignService {\r\n\r\n    @GetMapping(\"/coupon/seckillsession/latest3DaySession\")\r\n    R getLatest3DaySession();\r\n}\r\n```\r\n\r\n- è·å–æœ€è¿‘3å¤©çš„ç§’æ€æ´»åŠ¨åœºæ¬¡æ¥å£\r\n- `org.klaus.zgg01mall.coupon.controller.SeckillSessionController#getLatest3DaySession`\r\n\r\n```java\r\n/**\r\n * è·å–æœ€è¿‘3å¤©çš„ç§’æ€æ´»åŠ¨åœºæ¬¡\r\n * @return\r\n */\r\n@GetMapping(\"/latest3DaySession\")\r\npublic R getLatest3DaySession(){\r\n    List<SeckillSessionEntity> sessionEntities = seckillSessionService.getLatest3DaySession();\r\n    return R.ok().setData(sessionEntities);\r\n}\r\n```\r\n\r\n- è·å–æœ€è¿‘3å¤©çš„ç§’æ€æ´»åŠ¨åœºæ¬¡æ–¹æ³•å®ç°åŠæ—¶é—´æ—¥æœŸå¤„ç†\r\n\r\n```java\r\n    @Autowired\r\n    SeckillSkuRelationService seckillSkuRelationService;\r\n\t/**\r\n     * è·å–æœ€è¿‘3å¤©çš„ç§’æ€æ´»åŠ¨åœºæ¬¡\r\n     *\r\n     * @return\r\n     */\r\n    @Override\r\n    public List<SeckillSessionEntity> getLatest3DaySession() {\r\n        //è·å–æœ€è¿‘ä¸‰å¤©ä¿¡æ¯\r\n\r\n        List<SeckillSessionEntity> list = this.list(new QueryWrapper<SeckillSessionEntity>\t().between(\"start_time\", startTime(), endTime()));\r\n        \r\n        return null;\r\n    }\r\n\tprivate String startTime() {\r\n        LocalDate now = LocalDate.now();\r\n        LocalTime min = LocalTime.MIN;\r\n        LocalDateTime start = LocalDateTime.of(now, min);\r\n        String format = start.format(DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\"));\r\n        return format;\r\n    }\r\n\r\n    private String endTime() {\r\n        LocalDate now = LocalDate.now();\r\n        LocalDate localDate = now.plusDays(2);\r\n        LocalTime max = LocalTime.MAX;\r\n        LocalDateTime end = LocalDateTime.of(localDate, max);\r\n        String format = end.format(DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\"));\r\n        return format;\r\n    }\r\n```\r\n\r\n\r\n\r\n\r\n\r\n- ç§’æ€æ´»åŠ¨åœºæ¬¡æ·»åŠ å•†å“å…³è”ï¼ˆä¸è®°å…¥æ•°æ®åº“ï¼‰\r\n\r\n```java\r\n/**\r\n * ç§’æ€æ´»åŠ¨åœºæ¬¡\r\n * \r\n * @author klaus\r\n * @email klaus@gmail.com\r\n * @date 2022-08-22 13:18:54\r\n */\r\n@Data\r\n@TableName(\"sms_seckill_session\")\r\npublic class SeckillSessionEntity implements Serializable {\r\n\t......\r\n\r\n   /**\r\n    * æ‰€æœ‰ç§’æ€æ´»åŠ¨å•†å“å…³è”\r\n    */\r\n   @TableField(exist = false)\r\n   private List<SeckillSkuRelationEntity> relationSkus;\r\n\r\n}\r\n```\r\n\r\n- å®Œå–„è·å–æœ€è¿‘3å¤©çš„ç§’æ€æ´»åŠ¨åœºæ¬¡æ–¹æ³•å®ç°\r\n- `org.klaus.zgg01mall.coupon.service.impl.SeckillSessionServiceImpl#getLatest3DaySession`\r\n\r\n![image-20230430142137405](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430142137405.png)\r\n\r\n```java\r\n/**\r\n * è·å–æœ€è¿‘3å¤©çš„ç§’æ€æ´»åŠ¨åœºæ¬¡\r\n *\r\n * @return\r\n */\r\n@Override\r\npublic List<SeckillSessionEntity> getLatest3DaySession() {\r\n    //è·å–æœ€è¿‘ä¸‰å¤©ä¿¡æ¯\r\n\r\n    List<SeckillSessionEntity> list = this.list(new QueryWrapper<SeckillSessionEntity>().between(\"start_time\", startTime(), endTime()));\r\n    if (list != null && list.size() > 0) {\r\n        List<SeckillSessionEntity> collect = list.stream().map(session -> {\r\n            //è·å–ç§’æ€åœºæ¬¡id\r\n            Long id = session.getId();\r\n            //æ ¹æ®ç§’æ€åœºæ¬¡idè·å–ç§’æ€å…³è”å•†å“é›†åˆ\r\n            List<SeckillSkuRelationEntity> skuRelationEntities = seckillSkuRelationService.list(new QueryWrapper<SeckillSkuRelationEntity>().eq(\"promotion_session_id\", id));\r\n            if (skuRelationEntities != null && skuRelationEntities.size() > 0) {\r\n                session.setRelationSkus(skuRelationEntities);\r\n            }\r\n            return session;\r\n        }).collect(Collectors.toList());\r\n        return collect;\r\n    }\r\n    return null;\r\n}\r\n```\r\n\r\n\r\n\r\n- æ·»åŠ æ•°æ®ä¼ è¾“vo\r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2022/9/28\r\n */\r\n@Data\r\npublic class SeckillSessionWithSkus {\r\n\r\n    private Long id;\r\n    /**\r\n     * åœºæ¬¡åç§°\r\n     */\r\n    private String name;\r\n    /**\r\n     * æ¯æ—¥å¼€å§‹æ—¶é—´\r\n     */\r\n    private Date startTime;\r\n    /**\r\n     * æ¯æ—¥ç»“æŸæ—¶é—´\r\n     */\r\n    private Date endTime;\r\n    /**\r\n     * å¯ç”¨çŠ¶æ€\r\n     */\r\n    private Integer status;\r\n    /**\r\n     * åˆ›å»ºæ—¶é—´\r\n     */\r\n    private Date createTime;\r\n\r\n\r\n    private List<SeckillSkuVo> relationSkus;\r\n}\r\n```\r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2022/9/28\r\n */\r\n@Data\r\npublic class SeckillSkuVo {\r\n\r\n    private Long id;\r\n    /**\r\n     * æ´»åŠ¨id\r\n     */\r\n    private Long promotionId;\r\n    /**\r\n     * æ´»åŠ¨åœºæ¬¡id\r\n     */\r\n    private Long promotionSessionId;\r\n    /**\r\n     * å•†å“id\r\n     */\r\n    private Long skuId;\r\n    /**\r\n     * ç§’æ€ä»·æ ¼\r\n     */\r\n    private BigDecimal seckillPrice;\r\n    /**\r\n     * ç§’æ€æ€»é‡\r\n     */\r\n    private BigDecimal seckillCount;\r\n    /**\r\n     * æ¯äººé™è´­æ•°é‡\r\n     */\r\n    private BigDecimal seckillLimit;\r\n    /**\r\n     * æ’åº\r\n     */\r\n    private Integer seckillSort;\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n- ç§’æ€å•†å“å®šæ—¶ä¸Šæ¶æµç¨‹\r\n\r\n![image-20230430004237857](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430004237857.png)\r\n\r\n- ç§’æ€æœåŠ¡è¿œç¨‹è°ƒç”¨æ‰«ææœ€è¿‘ä¸‰å¤©éœ€è¦å‚ä¸ç§’æ€çš„æ´»åŠ¨æ–¹æ³•å®ç°\r\n- `org.klaus.zgg01mall.seckill.service.impl.SeckillServiceImpl#uploadSeckillSkuLatest3Days`\r\n\r\n```java\r\n@Override\r\npublic void uploadSeckillSkuLatest3Days() {\r\n    //1ã€æ‰«ææœ€è¿‘ä¸‰å¤©éœ€è¦å‚ä¸ç§’æ€çš„æ´»åŠ¨\r\n    R r = couponFeignService.getLatest3DaySession();\r\n    if (r.getCode() == 0) {\r\n        //è¿œç¨‹è°ƒç”¨æˆåŠŸï¼Œä¸Šæ¶å•†å“\r\n        List<SeckillSessionWithSkus> sessionData = r.getData(new TypeReference<List<SeckillSessionWithSkus>>() {\r\n        });\r\n        if (sessionData != null && sessionData.size() > 0) {\r\n            //ç¼“å­˜åˆ°redis\r\n            //1ã€ç¼“å­˜æ´»åŠ¨ä¿¡æ¯\r\n            saveSessionInfos(sessionData);\r\n            //2ã€ç¼“å­˜æ´»åŠ¨çš„å…³è”å•†å“ä¿¡æ¯\r\n            saveSessionSkuInfos(sessionData);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n##### 1ã€ç¼“å­˜æ´»åŠ¨ä¿¡æ¯æ–¹æ³•\r\n\r\n```java\r\n\tprivate final String SESSIONS_CACHE_PREFOX = \"seckill:sessions:\";\r\n\tprivate void saveSessionInfos(List<SeckillSessionWithSkus> sessions) {\r\n        if (sessions != null && sessions.size() > 0) {\r\n\r\n            sessions.stream().forEach(session -> {\r\n                long startTime = session.getStartTime().getTime();\r\n                long endTime = session.getEndTime().getTime();\r\n                String key = SESSIONS_CACHE_PREFOX + startTime + \"_\" + endTime;\r\n                    //keyä¸å­˜åœ¨è¿›è¡Œç¼“å­˜æ“ä½œ\r\n                    List<String> skuIds = session.getRelationSkus().stream().map(item -> item.getPromotionSessionId().toString() + \"_\" + item.getSkuId().toString()).collect(Collectors.toList());\r\n                    //ç¼“å­˜æ‰€æœ‰æ´»åŠ¨ä¿¡æ¯\r\n                    redisTemplate.opsForList().leftPushAll(key, skuIds);\r\n            });\r\n        }\r\n    }\r\n```\r\n\r\n\r\n\r\n- skuçš„è¯¦ç»†ä¿¡æ¯åŠç§’æ€æ´»åŠ¨åœºæ¬¡ä¿¡æ¯æ•°æ®ä¼ è¾“to\r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2022/9/28\r\n */\r\n@Data\r\npublic class SeckillSkuRedisTo {\r\n\r\n    /**\r\n     * æ´»åŠ¨id\r\n     */\r\n    private Long promotionId;\r\n    /**\r\n     * æ´»åŠ¨åœºæ¬¡id\r\n     */\r\n    private Long promotionSessionId;\r\n    /**\r\n     * å•†å“id\r\n     */\r\n    private Long skuId;\r\n\r\n    /**\r\n     * å•†å“ç§’æ€éšæœºç \r\n     */\r\n    private String randomCode;\r\n\r\n    /**\r\n     * ç§’æ€ä»·æ ¼\r\n     */\r\n    private BigDecimal seckillPrice;\r\n    /**\r\n     * ç§’æ€æ€»é‡\r\n     */\r\n    private BigDecimal seckillCount;\r\n    /**\r\n     * æ¯äººé™è´­æ•°é‡\r\n     */\r\n    private BigDecimal seckillLimit;\r\n    /**\r\n     * æ’åº\r\n     */\r\n    private Integer seckillSort;\r\n\r\n\r\n    /**\r\n     * å½“å‰å•†å“ç§’æ€çš„å¼€å§‹æ—¶é—´\r\n     */\r\n    private Long startTime;\r\n\r\n    /**\r\n     * å½“å‰å•†å“ç§’æ€çš„ç»“æŸæ—¶é—´\r\n     */\r\n    private Long endTime;\r\n    /**\r\n     * skuçš„è¯¦ç»†ä¿¡æ¯\r\n     */\r\n    private SkuInfoVo skuInfoVo;\r\n}\r\n```\r\n\r\n- skuçš„è¯¦ç»†ä¿¡æ¯æ•°æ®ä¼ è¾“vo\r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2022/9/28\r\n */\r\n@Data\r\npublic class SkuInfoVo {\r\n    private Long skuId;\r\n    /**\r\n     * spuId\r\n     */\r\n    private Long spuId;\r\n    /**\r\n     * skuåç§°\r\n     */\r\n    private String skuName;\r\n    /**\r\n     * skuä»‹ç»æè¿°\r\n     */\r\n    private String skuDesc;\r\n    /**\r\n     * æ‰€å±åˆ†ç±»id\r\n     */\r\n    private Long catalogId;\r\n    /**\r\n     * å“ç‰Œid\r\n     */\r\n    private Long brandId;\r\n    /**\r\n     * é»˜è®¤å›¾ç‰‡\r\n     */\r\n    private String skuDefaultImg;\r\n    /**\r\n     * æ ‡é¢˜\r\n     */\r\n    private String skuTitle;\r\n    /**\r\n     * å‰¯æ ‡é¢˜\r\n     */\r\n    private String skuSubtitle;\r\n    /**\r\n     * ä»·æ ¼\r\n     */\r\n    private BigDecimal price;\r\n    /**\r\n     * é”€é‡\r\n     */\r\n    private Long saleCount;\r\n}\r\n```\r\n\r\n\r\n\r\n- è¿œç¨‹è·å–skuè¯¦ç»†ä¿¡æ¯\r\n\r\n```java\r\n@FeignClient(\"gulimall-product\")\r\npublic interface ProductFeignService {\r\n\r\n    @RequestMapping(\"/product/skuinfo/info/{skuId}\")\r\n    R getSkuInfo(@PathVariable(\"skuId\") Long skuId);\r\n}\r\n```\r\n\r\n- è·å–skuè¯¦ç»†ä¿¡æ¯æ¥å£\r\n\r\n```java\r\n/**\r\n   * ä¿¡æ¯\r\n   */\r\n  @RequestMapping(\"/info/{skuId}\")\r\n  //@RequiresPermissions(\"product:skuinfo:info\")\r\n  public R info(@PathVariable(\"skuId\") Long skuId){\r\nSkuInfoEntity skuInfo = skuInfoService.getById(skuId);\r\n\r\n      return R.ok().put(\"skuInfo\", skuInfo);\r\n  }\r\n```\r\n\r\n\r\n\r\n\r\n\r\n##### 2ã€ç¼“å­˜æ´»åŠ¨çš„å…³è”å•†å“ä¿¡æ¯\r\n\r\n- å¼•å…¥redissonä¾èµ–ä½¿ç”¨åˆ†å¸ƒå¼ä¿¡å·é‡\r\n\r\n```xml\r\n<!--ä»¥åä½¿ç”¨redissonä½œä¸ºæ‰€æœ‰åˆ†å¸ƒå¼é”ï¼Œåˆ†å¸ƒå¼å¯¹è±¡ç­‰åŠŸèƒ½æ¡†æ¶ -->\r\n<dependency>\r\n    <groupId>org.redisson</groupId>\r\n    <artifactId>redisson</artifactId>\r\n    <version>3.12.0</version>\r\n</dependency>\r\n```\r\n\r\n- ç›¸å…³é…ç½®\r\n\r\n```properties\r\nspring.redis.host=192.168.10.103\r\n```\r\n\r\n- é…ç½®ç±»\r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2022/9/7\r\n */\r\n@Configuration\r\npublic class MyRedissonConfig {\r\n\r\n    /**\r\n     * æ‰€æœ‰å¯¹Redissonçš„ä½¿ç”¨éƒ½æ˜¯é€šè¿‡RedissonClientå¯¹è±¡\r\n     * @return\r\n     * @throws IOException\r\n     */\r\n    @Bean(destroyMethod=\"shutdown\")\r\n    public RedissonClient redisson() throws IOException {\r\n        //1ã€åˆ›å»ºé…ç½®\r\n        //Redis url should start with redis:// or rediss://\r\n        Config config = new Config();\r\n        config.useSingleServer().setAddress(\"redis://192.168.10.103:6379\");\r\n\r\n        //2ã€æ ¹æ®configåˆ›å»ºå‡ºRedissonå®ä¾‹\r\n        RedissonClient redissonClient = Redisson.create(config);\r\n        return redissonClient;\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n```java\r\nprivate final String SKUKILL_CACHE_PREFOX = \"seckill:skus:\";\r\n\r\nprivate final String SKU_STOCK_SEMAPHORE = \"seckill:stock:\";//+å•†å“éšæœºç \r\nprivate void saveSessionSkuInfos(List<SeckillSessionWithSkus> sessions) {\r\n\r\n    //å‡†å¤‡hashæ“ä½œ\r\n    BoundHashOperations<String, Object, Object> ops = redisTemplate.boundHashOps(SKUKILL_CACHE_PREFOX);\r\n\r\n    if (sessions != null && sessions.size() > 0) {\r\n\r\n        sessions.stream().forEach(session -> {\r\n\r\n            String token = UUID.randomUUID().toString().replace(\"-\", \"\");\r\n\r\n\r\n            session.getRelationSkus().stream().forEach(seckillSkuVo -> {\r\n\r\n                    //keyä¸å­˜åœ¨è¿›è¡Œç¼“å­˜å•†å“\r\n                    SeckillSkuRedisTo redisTo = new SeckillSkuRedisTo();\r\n                    //1ã€skuçš„åŸºæœ¬æ•°æ®\r\n                    R r = productFeignService.getSkuInfo(seckillSkuVo.getSkuId());\r\n                    if (r.getCode() == 0) {\r\n                        //è¿œç¨‹è°ƒç”¨æˆåŠŸ\r\n                        SkuInfoVo skuInfo = r.getData(\"skuInfo\", new TypeReference<SkuInfoVo>() {\r\n                        });\r\n                        redisTo.setSkuInfoVo(skuInfo);\r\n                    }\r\n                    //2ã€skuçš„ç§’æ€ä¿¡æ¯\r\n                    BeanUtils.copyProperties(seckillSkuVo, redisTo);\r\n\r\n                    //3ã€è®¾ç½®ä¸Šå½“å‰å•†å“çš„ç§’æ€æ—¶é—´ä¿¡æ¯\r\n                    redisTo.setStartTime(session.getStartTime().getTime());\r\n                    redisTo.setEndTime(session.getEndTime().getTime());\r\n\r\n                    //4ã€éšæœºç    seckill?skuId=1&key=fewqfwrgvrw\r\n                    redisTo.setRandomCode(token);\r\n\r\n                    String jsonString = JSON.toJSONString(redisTo);\r\n                    ops.put(seckillSkuVo.getPromotionSessionId().toString() + \"_\" + seckillSkuVo.getSkuId().toString(), jsonString);\r\n\r\n\r\n                    //ç§’æ€è¯·æ±‚è¿›æ¥å…ˆè·å–ä¿¡å·é‡ï¼Œè·å–ä¸åˆ°å°±æ— æ³•æ‰§è¡Œæ•°æ®åº“çš„æ‰€æœ‰æ–¹æ³•äº†\r\n                    //å¦‚æœå½“å‰è¿™ä¸ªåœºæ¬¡çš„å•†å“çš„åº“å­˜ä¿¡æ¯å·²ç»ä¸Šæ¶å°±ä¸éœ€è¦ä¸Šæ¶\r\n                    //5ã€ä½¿ç”¨åº“å­˜ä½œä¸ºåˆ†å¸ƒå¼çš„ä¿¡å·é‡ -> é™æµï¼›\r\n                    RSemaphore semaphore = redissonClient.getSemaphore(SKU_STOCK_SEMAPHORE + token);\r\n                    //å•†å“å¯ä»¥ç§’æ€çš„æ•°é‡ä½œä¸ºä¿¡å·é‡\r\n                    semaphore.trySetPermits(seckillSkuVo.getSeckillCount().intValue());\r\n                \r\n            });\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n- ä¿®æ”¹ä¸Šæ¶æ—¶é—´\r\n\r\n![image-20230430145943910](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430145943910.png)\r\n\r\n![image-20230430150003699](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430150003699.png)\r\n\r\n- æœªåšå¹‚ç­‰æ€§å¤„ç†å‡ºç°é‡å¤ä¸Šæ¶æƒ…å†µ\r\n\r\n![image-20230430150132974](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430150132974.png)\r\n\r\n- æ´»åŠ¨ä¿¡æ¯æ”¶é›†çš„æ˜¯æˆ‘ä»¬çš„skuIdä¸æ˜¯æ´»åŠ¨è®°å½•id\r\n\r\n```java\r\nList<String> skuIds = session.getRelationSkus().stream().map(item -> item.getSkuId().toString()).collect(Collectors.toList());\r\n```\r\n\r\n![image-20230430150728958](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430150728958.png)\r\n\r\n- æ´»åŠ¨çš„å…³è”å•†å“ä¿¡æ¯keyä¹Ÿä¸ºskuId\r\n\r\n```java\r\nops.put(seckillSkuVo.getSkuId().toString(), jsonString);\r\n```\r\n\r\n\r\n\r\n\r\n\r\n#### åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ \r\n\r\n\r\n\r\n##### 1.å®šæ—¶ä»»åŠ¡çš„é—®é¢˜ \r\n\r\n![image-20230429224924881](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429224924881.png)\r\n\r\n- 1ï¼‰ã€åŒæ—¶æ‰§è¡Œå¯¼è‡´çš„é‡å¤\r\n  - ç”±äºåŒæ ·çš„æœåŠ¡ä¼šéƒ¨ç½²å¤šä¸ªèŠ‚ç‚¹ï¼Œå¤šä¸ªèŠ‚ç‚¹çš„å®šæ—¶ä»»åŠ¡ä»£ç å¯èƒ½åŒæ—¶å¯åŠ¨ã€‚å°†åŒæ ·çš„äº‹æƒ…åšäº†å¤šæ¬¡ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚\r\n\r\n- 2ï¼‰ã€ä»»åŠ¡æ‹†åˆ†å¹¶å‘æ‰§è¡Œ\r\n  - ä½¿ç”¨ ElasticJob\r\n\r\n\r\n\r\n##### 2.æ‰©å±• - åˆ†å¸ƒå¼è°ƒæ•´\r\n\r\nhttps://elasticjob.io/docs/elastic-job-cloud/00-overview/\r\n\r\n\r\n\r\n\r\n\r\n#### 3.3 å¹‚ç­‰æ€§ä¿è¯\r\n\r\n```java\r\n/**\r\n *  * ç§’æ€å•†å“çš„å®šæ—¶ä¸Šæ¶ï¼›\r\n *  *      æ¯å¤©æ™šä¸Š3ç‚¹ï¼›ä¸Šæ¶æœ€è¿‘ä¸‰å¤©éœ€è¦ç§’æ€çš„å•†å“\r\n *  *      å½“å¤©00:00:00 - 23:59:59\r\n *  *      æ˜å¤©å¤©00:00:00 - 23:59:59\r\n *  *      åå¤©00:00:00 - 23:59:59\r\n * @author Klaus\r\n * @date 2022/9/27\r\n */\r\n@Slf4j\r\n@Service\r\npublic class SeckillSkuScheduled {\r\n\r\n    @Autowired\r\n    SeckillService seckillService;\r\n\r\n    @Autowired\r\n    RedissonClient redissonClient;\r\n\r\n    private final String UPLOAD_LOCK = \"seckill:upload:lock\";\r\n\r\n    /**\r\n     * todo å¹‚ç­‰æ€§å¤„ç†\r\n     */\r\n//     @Scheduled(cron = \"*/5 * * * * ? \")\r\n    @Scheduled(cron = \"0 0 1/1 * * ? \")\r\n    public void uploadSeckillSkuLatest3Days(){\r\n        //1ã€é‡å¤ä¸Šæ¶æ— éœ€å¤„ç†\r\n        log.info(\"ä¸Šæ¶ç§’æ€çš„å•†å“ä¿¡æ¯...\");\r\n        //åˆ†å¸ƒå¼é”ã€‚é”çš„ä¸šåŠ¡æ‰§è¡Œå®Œæˆï¼ŒçŠ¶æ€å·²ç»æ›´æ–°å®Œæˆï¼Œé‡Šæ”¾é”ä»¥åï¼Œå…¶ä»–äººè·å–åˆ°å°±ä¼šæ‹¿åˆ°æœ€æ–°çš„çŠ¶æ€\r\n        RLock lock = redissonClient.getLock(UPLOAD_LOCK);\r\n        lock.lock(10, TimeUnit.SECONDS);\r\n        try {\r\n            seckillService.uploadSeckillSkuLatest3Days();\r\n\r\n        } finally {\r\n            lock.unlock();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n- å®Œå–„ç¼“å­˜æ´»åŠ¨ä¿¡æ¯æ–¹æ³•\r\n\r\n```java\r\nprivate void saveSessionInfos(List<SeckillSessionWithSkus> sessions) {\r\n    if (sessions != null && sessions.size() > 0) {\r\n\r\n        sessions.stream().forEach(session -> {\r\n            long startTime = session.getStartTime().getTime();\r\n            long endTime = session.getEndTime().getTime();\r\n            String key = SESSIONS_CACHE_PREFOX + startTime + \"_\" + endTime;\r\n            Boolean hasKey = redisTemplate.hasKey(key);\r\n            if (!hasKey) {\r\n                //keyä¸å­˜åœ¨è¿›è¡Œç¼“å­˜æ“ä½œ\r\n                List<String> skuIds = session.getRelationSkus().stream().map(item -> item.getPromotionSessionId().toString() + \"_\" + item.getSkuId().toString()).collect(Collectors.toList());\r\n                //ç¼“å­˜æ‰€æœ‰æ´»åŠ¨ä¿¡æ¯\r\n                redisTemplate.opsForList().leftPushAll(key, skuIds);\r\n            }\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n- å®Œå–„ç¼“å­˜æ´»åŠ¨çš„å…³è”å•†å“ä¿¡æ¯\r\n\r\n```java\r\nprivate void saveSessionSkuInfos(List<SeckillSessionWithSkus> sessions) {\r\n\r\n    //å‡†å¤‡hashæ“ä½œ\r\n    BoundHashOperations<String, Object, Object> ops = redisTemplate.boundHashOps(SKUKILL_CACHE_PREFOX);\r\n\r\n    if (sessions != null && sessions.size() > 0) {\r\n\r\n        sessions.stream().forEach(session -> {\r\n\r\n            String token = UUID.randomUUID().toString().replace(\"-\", \"\");\r\n\r\n\r\n            session.getRelationSkus().stream().forEach(seckillSkuVo -> {\r\n                if (!ops.hasKey(seckillSkuVo.getPromotionSessionId().toString() + \"_\" + seckillSkuVo.getSkuId().toString())) {\r\n                    //keyä¸å­˜åœ¨è¿›è¡Œç¼“å­˜å•†å“\r\n                    SeckillSkuRedisTo redisTo = new SeckillSkuRedisTo();\r\n                    //1ã€skuçš„åŸºæœ¬æ•°æ®\r\n                    R r = productFeignService.getSkuInfo(seckillSkuVo.getSkuId());\r\n                    if (r.getCode() == 0) {\r\n                        //è¿œç¨‹è°ƒç”¨æˆåŠŸ\r\n                        SkuInfoVo skuInfo = r.getData(\"skuInfo\", new TypeReference<SkuInfoVo>() {\r\n                        });\r\n                        redisTo.setSkuInfoVo(skuInfo);\r\n                    }\r\n                    //2ã€skuçš„ç§’æ€ä¿¡æ¯ vo->to\r\n                    BeanUtils.copyProperties(seckillSkuVo, redisTo);\r\n\r\n                    //3ã€è®¾ç½®ä¸Šå½“å‰å•†å“çš„ç§’æ€æ—¶é—´ä¿¡æ¯\r\n                    redisTo.setStartTime(session.getStartTime().getTime());\r\n                    redisTo.setEndTime(session.getEndTime().getTime());\r\n\r\n                    //4ã€éšæœºç    seckill?skuId=1&key=fewqfwrgvrw\r\n                    redisTo.setRandomCode(token);\r\n\r\n                    String jsonString = JSON.toJSONString(redisTo);\r\n                    ops.put(seckillSkuVo.getPromotionSessionId().toString() + \"_\" + seckillSkuVo.getSkuId().toString(), jsonString);\r\n\r\n\r\n                    //ç§’æ€è¯·æ±‚è¿›æ¥å…ˆè·å–ä¿¡å·é‡ï¼Œè·å–ä¸åˆ°å°±æ— æ³•æ‰§è¡Œæ•°æ®åº“çš„æ‰€æœ‰æ–¹æ³•äº†\r\n                    //å¦‚æœå½“å‰è¿™ä¸ªåœºæ¬¡çš„å•†å“çš„åº“å­˜ä¿¡æ¯å·²ç»ä¸Šæ¶å°±ä¸éœ€è¦ä¸Šæ¶\r\n                    //5ã€ä½¿ç”¨åº“å­˜ä½œä¸ºåˆ†å¸ƒå¼çš„ä¿¡å·é‡ -> é™æµï¼›\r\n                    RSemaphore semaphore = redissonClient.getSemaphore(SKU_STOCK_SEMAPHORE + token);\r\n                    //å•†å“å¯ä»¥ç§’æ€çš„æ•°é‡ä½œä¸ºä¿¡å·é‡\r\n                    semaphore.trySetPermits(seckillSkuVo.getSeckillCount().intValue());\r\n                }\r\n\r\n            });\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n#### 3.4 æŸ¥è¯¢ç§’æ€å•†å“+é¡µé¢æ¸²æŸ“\r\n\r\n- è¿”å›å½“å‰æ—¶é—´å¯ä»¥å‚ä¸çš„ç§’æ€å•†å“ä¿¡æ¯æ¥å£\r\n\r\n```java\r\n@Controller\r\npublic class SeckillController {\r\n\r\n    @Autowired\r\n    SeckillService seckillService;\r\n\r\n    /**\r\n     * è¿”å›å½“å‰æ—¶é—´å¯ä»¥å‚ä¸çš„ç§’æ€å•†å“ä¿¡æ¯\r\n     * @return\r\n     */\r\n    @ResponseBody\r\n    @GetMapping(\"/currentSeckillSkus\")\r\n    public R getCurrentSeckillSkus(){\r\n        List<SeckillSkuRedisTo> tos = seckillService.getCurrentSeckillSkus();\r\n        return R.ok().setData(tos);\r\n    }\r\n```\r\n\r\n- è¿”å›å½“å‰æ—¶é—´å¯ä»¥å‚ä¸çš„ç§’æ€å•†å“ä¿¡æ¯æ–¹æ³•å®ç°\r\n\r\n```java\r\n/**\r\n     * è¿”å›å½“å‰æ—¶é—´å¯ä»¥å‚ä¸çš„ç§’æ€å•†å“ä¿¡æ¯\r\n     */\r\n    @Override\r\n    public List<SeckillSkuRedisTo> getCurrentSeckillSkus() {\r\n        //1ã€ç¡®å®šå½“å‰æ—¶é—´å±äºå“ªä¸ªç§’æ€åœºæ¬¡\r\n        long time = System.currentTimeMillis();\r\n\r\n        Set<String> keys = redisTemplate.keys(SESSIONS_CACHE_PREFOX + \"*\");\r\n        for (String key : keys) {\r\n            //seckill:sessions:1664301600000_1664305200000->1664301600000_1664305200000\r\n            String replace = key.replace(SESSIONS_CACHE_PREFOX, \"\");\r\n            //[1664301600000 _ 1664305200000]\r\n            //        0             1\r\n            String[] s = replace.split(\"_\");\r\n            Long start = Long.parseLong(s[0]);\r\n            Long end = Long.parseLong(s[1]);\r\n            if (time >= start && time <= end) {\r\n                //å½“å‰æ—¶é—´åœ¨ç§’æ€æ—¶é—´èŒƒå›´å†…\r\n                //2ã€è·å–è¿™ä¸ªç§’æ€åœºæ¬¡éœ€è¦çš„æ‰€æœ‰å•†å“ä¿¡æ¯\r\n                List<String> range = redisTemplate.opsForList().range(key, -100, 100);\r\n                BoundHashOperations<String, String, String> hashOps = redisTemplate.boundHashOps(SKUKILL_CACHE_PREFOX);\r\n                assert range != null;\r\n                List<String> list = hashOps.multiGet(range);\r\n                if (list != null && list.size() > 0) {\r\n                    List<SeckillSkuRedisTo> collect = list.stream().map(item -> {\r\n                        SeckillSkuRedisTo skuRedisTo = JSON.parseObject((String) item, SeckillSkuRedisTo.class);\r\n//                        skuRedisTo.setRandomCode(null);å½“å‰ç§’æ€å¼€å§‹å°±éœ€è¦éšæœºç \r\n\r\n                        return skuRedisTo;\r\n                    }).collect(Collectors.toList());\r\n                    return collect;\r\n                }\r\n                break;\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n```\r\n\r\n![image-20230430152815352](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430152815352.png)\r\n\r\n\r\n\r\n![image-20230428202232121](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428202232121.png)\r\n\r\n\r\n\r\n- å•†å“æœåŠ¡è¿œç¨‹æŸ¥è¯¢ç§’æ€ä¿¡æ¯\r\n- è¿œç¨‹æ¥å£\r\n\r\n```java\r\n@FeignClient(value = \"gulimall-seckill\", fallback = SeckillFeignServiceFallBack.class )\r\npublic interface SeckillFeignService {\r\n\r\n    @GetMapping(\"/sku/seckill/{skuId}\")\r\n    R getSkuSeckillInfo(@PathVariable(\"skuId\")Long skuId);\r\n}\r\n```\r\n\r\n- è·å–ç§’æ€ä¿¡æ¯æ¥å£\r\n\r\n```java\r\n@ResponseBody\r\n@GetMapping(\"/sku/seckill/{skuId}\")\r\npublic R getSkuSeckillInfo(@PathVariable(\"skuId\")Long skuId){\r\n    SeckillSkuRedisTo to = seckillService.getSkuSeckillInfo(skuId);\r\n\r\n    return R.ok().setData(to);\r\n}\r\n```\r\n\r\n- è·å–ç§’æ€ä¿¡æ¯æ–¹æ³•å®ç°ï¼ˆæ­£åˆ™åŒ¹é…BUGå·²ä¿®å¤ï¼‰\r\n\r\n```java\r\n@Override\r\n    public SeckillSkuRedisTo getSkuSeckillInfo(Long skuId) {\r\n        //1ã€æ‰¾åˆ°æ‰€æœ‰éœ€è¦å‚ä¸ç§’æ€çš„å•†å“çš„key\r\n        BoundHashOperations<String, String, String> hashOps = redisTemplate.boundHashOps(SKUKILL_CACHE_PREFOX);\r\n        Set<String> keys = hashOps.keys();\r\n        if (keys != null && keys.size() > 0) {\r\n            //todo æ­£åˆ™åŒ¹é…2ä½æ•°\r\n            String regx = \"\\\\d\\\\d_\" + skuId;\r\n            //åˆ›å»ºåŒ¹é…æ¨¡å¼\r\n//            Pattern pattern = Pattern.compile(\"\\\\d_\");//åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªæ•°å­—å­—ç¬¦\r\n            //2.é€‰æ‹©åŒ¹é…å¯¹è±¡\r\n//            Matcher matcher = pattern.matcher(skuId.toString());\r\n\r\n            for (String key : keys) {\r\n                log.info(\"test:{}\",  Pattern.matches(regx, key));\r\n                // 6_4\r\n                if (Pattern.matches(regx, key)) {\r\n//                if (regx.matches(key)) {\r\n//                if (matcher.find()) {\r\n                    String json = hashOps.get(key);\r\n                    SeckillSkuRedisTo skuRedisTo = JSON.parseObject(json, SeckillSkuRedisTo.class);\r\n\r\n                    //å¤„ç†éšæœºç \r\n                    long current = System.currentTimeMillis();\r\n                    if (current >= skuRedisTo.getStartTime() && current <= skuRedisTo.getEndTime()) {\r\n\r\n                    } else {\r\n                        //åœ¨æ—¶é—´èŒƒå›´å¤–ç›´æ¥ç½®ç©º\r\n                        skuRedisTo.setRandomCode(null);\r\n                    }\r\n                    return skuRedisTo;\r\n                }\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n```\r\n\r\n- skuè¯¦æƒ…é¡µè·å–å•†å“ï¼ˆç§’æ€ï¼‰è¯¦æƒ…æ¥å£\r\n\r\n```java\r\n/**\r\n * å±•ç¤ºå½“å‰skuçš„è¯¦æƒ…\r\n * @param skuId\r\n * @return\r\n */\r\n@GetMapping(\"/{skuId}.html\")\r\npublic String skuItem(@PathVariable(\"skuId\")Long skuId, Model model) throws ExecutionException, InterruptedException {\r\n\r\n\r\n    System.out.println(\"å‡†å¤‡æŸ¥è¯¢\" + skuId + \"è¯¦æƒ…\");\r\n    SkuItemVo vo = skuInfoService.item(skuId);\r\n    //é¡µé¢æ¸²æŸ“\r\n    model.addAttribute(\"item\", vo);\r\n\r\n    return \"item\";\r\n}\r\n```\r\n\r\n- è·å–å•†å“ï¼ˆç§’æ€ï¼‰è¯¦æƒ…æ–¹æ³•å®ç°\r\n\r\n  - ç§’æ€è¯¦æƒ…æ•°æ®ä¼ è¾“vo\r\n\r\n  ```java\r\n  /**\r\n   * @author Klaus\r\n   * @date 2022/9/28\r\n   */\r\n  @Data\r\n  public class SeckillInfoVo {\r\n  \r\n      /**\r\n       * æ´»åŠ¨id\r\n       */\r\n      private Long promotionId;\r\n      /**\r\n       * æ´»åŠ¨åœºæ¬¡id\r\n       */\r\n      private Long promotionSessionId;\r\n      /**\r\n       * å•†å“id\r\n       */\r\n      private Long skuId;\r\n  \r\n      /**\r\n       * å•†å“ç§’æ€éšæœºç \r\n       */\r\n      private String randomCode;\r\n  \r\n      /**\r\n       * ç§’æ€ä»·æ ¼\r\n       */\r\n      private BigDecimal seckillPrice;\r\n      /**\r\n       * ç§’æ€æ€»é‡\r\n       */\r\n      private BigDecimal seckillCount;\r\n      /**\r\n       * æ¯äººé™è´­æ•°é‡\r\n       */\r\n      private BigDecimal seckillLimit;\r\n      /**\r\n       * æ’åº\r\n       */\r\n      private Integer seckillSort;\r\n  \r\n  \r\n  \r\n      /**\r\n       * å½“å‰å•†å“ç§’æ€çš„å¼€å§‹æ—¶é—´\r\n       */\r\n      private Long startTime;\r\n  \r\n      /**\r\n       * å½“å‰å•†å“ç§’æ€çš„ç»“æŸæ—¶é—´\r\n       */\r\n      private Long endTime;\r\n  }\r\n  ```\r\n\r\n```java\r\n\t@Resource\r\n    SeckillFeignService seckillFeignService;\r\n\t@Override\r\n    public SkuItemVo item(Long skuId) throws ExecutionException, InterruptedException {\r\n        SkuItemVo skuItemVo = new SkuItemVo();\r\n\r\n        ......\r\n\r\n        CompletableFuture<Void> seckillFuture = CompletableFuture.runAsync(() -> {\r\n            // ç§’æ€ä¿¡æ¯\r\n            R r = seckillFeignService.getSkuSeckillInfo(skuId);\r\n            if (r.getCode() == 0) {\r\n                //è¿œç¨‹è°ƒç”¨æˆåŠŸ\r\n                SeckillInfoVo data = r.getData(new TypeReference<SeckillInfoVo>() {\r\n                });\r\n                if (data != null) {\r\n                    skuItemVo.setSeckillInfo(data);\r\n                }\r\n            }\r\n        }, productThreadPoolExecutor);\r\n\r\n        //ç­‰å¾…æ‰€æœ‰çš„ä»»åŠ¡éƒ½å®Œæˆ\r\n        CompletableFuture.allOf(saleAttrFuture, descFuture, baseAttrFuture, imageFuture, seckillFuture).get();\r\n\r\n        return skuItemVo;\r\n    }\r\n```\r\n\r\n\r\n\r\n![image-20230428202310827](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428202310827.png)\r\n\r\n![image-20230428202403297](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428202403297.png)\r\n\r\n\r\n\r\n\r\n\r\n#### 3.5 ç§’æ€ç³»ç»Ÿè®¾è®¡\r\n\r\n\r\n\r\n![image-20230429225031339](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429225031339.png)\r\n\r\n![image-20230429225211015](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429225211015.png)\r\n\r\n#### 3.6 ç™»å½•æ£€æŸ¥\r\n\r\n- å¼•å…¥Spring Sessionä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>org.springframework.session</groupId>\r\n    <artifactId>spring-session-data-redis</artifactId>\r\n</dependency>\r\n```\r\n\r\n- Sessioné…ç½®ç±»\r\n\r\n```java\r\n@EnableRedisHttpSession\r\n@Configuration\r\npublic class GulimallSessionConfig {\r\n\r\n    @Bean\r\n    public CookieSerializer cookieSerializer(){\r\n        DefaultCookieSerializer cookieSerializer = new DefaultCookieSerializer();\r\n\r\n        cookieSerializer.setDomainName(\"gulimall.com\");\r\n        cookieSerializer.setCookieName(\"KLAUSSESSION\");\r\n        return cookieSerializer;\r\n    }\r\n\r\n    @Bean\r\n    public RedisSerializer<Object> springSessionDefaultRedisSerializer() {\r\n        return new GenericJackson2JsonRedisSerializer();\r\n    }\r\n}\r\n```\r\n\r\n- ç›¸å…³é…ç½®\r\n\r\n```properties\r\nspring.session.store-type=REDIS\r\n```\r\n\r\n- æ·»åŠ ç™»å½•æ‹¦æˆªå™¨\r\n\r\n```java\r\n@Component\r\npublic class LoginUserInterceptor implements HandlerInterceptor {\r\n\r\n\r\n    public static ThreadLocal<MemberRespVo> loginUser = new ThreadLocal<>();\r\n\r\n    @Override\r\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\r\n\r\n        ///order/order/status/{orderSn}\r\n        String uri = request.getRequestURI();//  /order/order/status/\r\n        //                  è·¯å¾„åŒ¹é…å™¨\r\n        boolean match = new AntPathMatcher().match(\"/kill\", uri);\r\n\r\n        if (match){\r\n            //è·¯å¾„åŒ¹é…è¿›è¡Œç™»å½•æ‹¦æˆª\r\n            MemberRespVo attribute = (MemberRespVo) request.getSession().getAttribute(AuthServerConstant.LOGIN_USER);\r\n            //åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•\r\n            if (attribute != null){\r\n                //ç™»å½•äº†\r\n                loginUser.set(attribute);\r\n                return true;\r\n            }else {\r\n                //æœªç™»å½•å°±å»ç™»å½•\r\n                request.getSession().setAttribute(\"msg\", \"è¯·å…ˆè¿›è¡Œç™»å½•\");\r\n                response.sendRedirect(\"http://auth.gulimall.com/login.html\");\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n}\r\n```\r\n\r\n- æ‹¦æˆªå™¨æ³¨å†Œ\r\n\r\n```java\r\n@Configuration\r\npublic class SeckillWebConfig implements WebMvcConfigurer {\r\n    @Autowired\r\n    LoginUserInterceptor loginUserInterceptor;\r\n\r\n\r\n    @Override\r\n    public void addInterceptors(InterceptorRegistry registry) {\r\n        registry.addInterceptor(loginUserInterceptor).addPathPatterns(\"/**\");\r\n    }\r\n}\r\n```\r\n\r\n- ç§’æ€æŠ¢è´­æœªç™»å½•æç¤º\r\n\r\n![image-20230430155945442](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430155945442.png)\r\n\r\n- æœªç™»å½•è·³è½¬åˆ°ç™»å½•é¡µ\r\n\r\n![image-20230430160017370](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430160017370.png)\r\n\r\n\r\n\r\n\r\n\r\n#### 3.7 ç§’æ€æµç¨‹\r\n\r\n![image-20230430003907398](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430003907398.png)\r\n\r\n\r\n\r\n- ç§’æ€æˆåŠŸé¡µæ¥å£\r\n\r\n```java\r\n@GetMapping(\"/kill\")\r\npublic String secKill(@RequestParam(\"killId\") String killId,\r\n                      @RequestParam(\"key\") String key,\r\n                      @RequestParam(\"num\") Integer num,\r\n                      Model model){\r\n    String orderSn = seckillService.kill(killId, key, num);\r\n    \r\n    model.addAttribute(\"orderSn\", orderSn);\r\n    //1ã€åˆ¤æ–­æ˜¯å¦ç™»å½•\r\n    return \"success\";\r\n}\r\n```\r\n\r\n- ç§’æ€è®¢å•ä¿¡æ¯æ•°æ®ä¼ è¾“å…¬å…±to`org.klaus.common.to.mq.SeckillOrderTo`\r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2022/9/29\r\n */\r\n@Data\r\npublic class SeckillOrderTo {\r\n\r\n    private String orderSn;//è®¢å•å·\r\n\r\n    private Long promotionSessionId;//æ´»åŠ¨åœºæ¬¡id\r\n\r\n    private Long skuId;//å•†å“id\r\n\r\n\r\n    private BigDecimal seckillPrice;//ç§’æ€ä»·\r\n\r\n    private Integer num;//è´­ä¹°æ•°é‡\r\n\r\n    private Long memberId;//ä¼šå‘˜id\r\n\r\n//    private List<String> skuAttrs;//å•†å“å±æ€§é›†\r\n\r\n}\r\n```\r\n\r\n- ç§’æ€æ–¹æ³•å®ç°\r\n\r\n```java\r\n@Override\r\npublic String kill(String killId, String key, Integer num) {\r\n    long s1 = System.currentTimeMillis();\r\n    //è·å–å½“å‰ç™»å½•çš„ä¿¡æ¯\r\n    MemberRespVo respVo = LoginUserInterceptor.loginUser.get();\r\n\r\n    //è·å–å½“å‰ç§’æ€å•†å“çš„è¯¦ç»†ä¿¡æ¯\r\n    BoundHashOperations<String, String, String> hashOps = redisTemplate.boundHashOps(SKUKILL_CACHE_PREFOX);\r\n\r\n    String json = hashOps.get(killId);\r\n    if (StringUtils.isEmpty(json)) {\r\n        return null;\r\n    } else {\r\n        SeckillSkuRedisTo redis = JSON.parseObject(json, SeckillSkuRedisTo.class);\r\n        //1ã€æ ¡éªŒåˆæ³•æ€§\r\n        Long startTime = redis.getStartTime();\r\n        Long endTime = redis.getEndTime();\r\n        long current = System.currentTimeMillis();\r\n\r\n        //è¿‡æœŸæ—¶é—´\r\n        long ttl = endTime - current;\r\n        if (current >= startTime && current <= endTime) {\r\n            //2ã€æ ¡éªŒéšæœºç å’Œå•†å“id\r\n            String randomCode = redis.getRandomCode();\r\n            //   1_49\r\n            String seckillSkuId = redis.getPromotionSessionId() + \"_\" + redis.getSkuId();\r\n            if (randomCode.equals(key) && killId.equals(seckillSkuId)) {\r\n                //3ã€éªŒè¯è´­ç‰©æ•°é‡æ˜¯å¦åˆç†\r\n                if (num <= redis.getSeckillLimit().intValue()) {\r\n                    //4ã€éªŒè¯è¿™ä¸ªäººæ˜¯å¦å·²ç»è´­ä¹°è¿‡ã€‚å¹‚ç­‰æ€§ï¼›å¦‚æœç§’æ€æˆåŠŸï¼Œå°±å»å ä½ï¼ŒuserId_sessionId_skuId\r\n                    String redisKey = respVo.getId() + \"_\" + seckillSkuId;\r\n                    //è‡ªåŠ¨è¿‡æœŸ                     SEINX åŸå­æ€§\r\n                    Boolean aBoolean = redisTemplate.opsForValue().setIfAbsent(redisKey, num.toString(), ttl, TimeUnit.MILLISECONDS);\r\n                    if (aBoolean) {\r\n                        //å ä½æˆåŠŸè¯´æ˜ä»æ¥æ²¡æœ‰ä¹°è¿‡\r\n                        RSemaphore semaphore = redissonClient.getSemaphore(SKU_STOCK_SEMAPHORE + randomCode);\r\n\r\n                        //120 ms ->  20ms\r\n                        boolean b = semaphore.tryAcquire(num);\r\n                        if (b) {\r\n                            //ç§’æ€æˆåŠŸï¼›\r\n                            //å¿«é€Ÿä¸‹å•ï¼Œå‘é€MQæ¶ˆæ¯ 10ms\r\n                            //åˆ›å»ºéšæœºè®¢å•å·\r\n                            String timeId = IdWorker.getTimeId();\r\n                            SeckillOrderTo orderTo = new SeckillOrderTo();\r\n                            orderTo.setOrderSn(timeId);\r\n                            orderTo.setMemberId(respVo.getId());\r\n                            orderTo.setNum(num);\r\n                            orderTo.setPromotionSessionId(redis.getPromotionSessionId());\r\n                            orderTo.setSkuId(redis.getSkuId());\r\n                            orderTo.setSeckillPrice(redis.getSeckillPrice());\r\n\r\n                            //String exchange, String routingKey, Object message, MessagePostProcessor messagePostProcessor\r\n                            rabbitTemplate.convertAndSend(\"order-event-exchange\", \"order.seckill.order\", orderTo);\r\n                            long s2 = System.currentTimeMillis();\r\n                            log.info(\"è€—æ—¶...{}\", (s2 - s1));\r\n                            //è¿”å›è®¢å•å·\r\n                            return timeId;\r\n                        }\r\n                        //ä¿¡å·é‡ä¸º0æ—¶ï¼Œè™½ç„¶dataä¸ºç©ºï¼Œä½†ç¼“å­˜è¿˜ä¼šå­˜ä¸€ä»½\r\n                        redisTemplate.opsForValue().get(redisKey);\r\n                        return null;\r\n                    } else {\r\n                        //è¯´æ˜å·²ç»ä¹°è¿‡äº†\r\n                        return null;\r\n                    }\r\n\r\n                }\r\n            } else {\r\n                return null;\r\n            }\r\n        } else {\r\n            return null;\r\n        }\r\n    }\r\n    return null;\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n#### 3.8 ç§’æ€æ•ˆæœ+ç§’æ€é¡µé¢\r\n\r\n![image-20230430161527281](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230430161527281.png)\r\n\r\n- å¼•å…¥RabbitMQä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>org.springframework.boot</groupId>\r\n    <artifactId>spring-boot-starter-amqp</artifactId>\r\n</dependency>\r\n```\r\n\r\n- ç›¸å…³é…ç½®\r\n\r\n```properties\r\nspring.rabbitmq.virtual-host=/\r\nspring.rabbitmq.host=192.168.10.103\r\n```\r\n\r\n- é…ç½®RabbitMQçš„Jsonåºåˆ—åŒ–\r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2022/9/20\r\n */\r\n@Configuration\r\npublic class MyRabbitConfig {\r\n\r\n    @Autowired\r\n    RabbitTemplate rabbitTemplate;\r\n\r\n    /**\r\n     * ä½¿ç”¨JSONåºåˆ—åŒ–æœºåˆ¶ï¼Œè¿›è¡Œæ¶ˆæ¯è½¬æ¢\r\n     * @return\r\n     */\r\n    @Bean\r\n    public MessageConverter messageConverter(){\r\n        return new Jackson2JsonMessageConverter();\r\n    }\r\n\r\n\r\n}\r\n```\r\n\r\n- å‘é€ç§’æ€æˆåŠŸæ¶ˆæ¯ç»™è®¢å•æœåŠ¡\r\n\r\n```java\r\n//String exchange, String routingKey, Object message, MessagePostProcessor messagePostProcessor\r\nrabbitTemplate.convertAndSend(\"order-event-exchange\", \"order.seckill.order\", orderTo);\r\n```\r\n\r\n- è®¢å•æœåŠ¡åˆ›å»ºç§’æ€è®¢å•æ¶ˆæ¯é˜Ÿåˆ—\r\n\r\n```java\r\n@Configuration\r\npublic class MyMQConfig {\r\n    \r\n    ......\r\n    \r\n    @Bean\r\n    public Exchange orderEventExchange(){\r\n        //String name, boolean durable, boolean autoDelete, Map<String, Object> arguments\r\n        return new TopicExchange(\"order-event-exchange\", true, false);\r\n    }\r\n    \r\n    ......\r\n    \r\n    /**\r\n     * ç§’æ€å‰Šå³°é˜Ÿåˆ—\r\n     * @return\r\n     */\r\n    @Bean\r\n    public Queue orderSeckillOrderQueue(){\r\n        return new Queue(\"order.seckill.order.queue\", true, false, false);\r\n    }\r\n\r\n    @Bean\r\n    public Binding orderSeckillOrderBinding(){\r\n        return new Binding(\"order.seckill.order.queue\",\r\n                Binding.DestinationType.QUEUE,\r\n                \"order-event-exchange\",\r\n                \"order.seckill.order\", null);\r\n\r\n    }\r\n}\r\n```\r\n\r\n- å‰Šå³°é˜Ÿåˆ—ç›‘å¬å™¨`org.klaus.zgg01mall.order.listener.OrderSeckillListener`\r\n\r\n```java\r\n/**\r\n * å‰Šå³°é˜Ÿåˆ—ç›‘å¬å™¨\r\n * @author Klaus\r\n * @date 2023/4/28\r\n */\r\n@Slf4j\r\n@RabbitListener(queues = \"order.seckill.order.queue\")\r\n@Component\r\npublic class OrderSeckillListener {\r\n\r\n    @Autowired\r\n    OrderService orderService;\r\n\r\n    @RabbitHandler\r\n    public void listener(SeckillOrderTo seckillOrder, Channel channel, Message message) throws IOException {\r\n\r\n        try {\r\n            log.info(\"å‡†å¤‡åˆ›å»ºç§’æ€å•çš„è¯¦ç»†ä¿¡æ¯....\");\r\n            orderService.createSeckillOrder(seckillOrder);\r\n            //æ‰‹åŠ¨è°ƒç”¨æ”¯ä»˜å®æ”¶å•\r\n\r\n            //ç­¾æ”¶è®¢å•\r\n            channel.basicAck(message.getMessageProperties().getDeliveryTag(), false);\r\n        } catch (Exception e) {\r\n\r\n            channel.basicReject(message.getMessageProperties().getDeliveryTag(), true);\r\n        }\r\n\r\n    }\r\n}\r\n```\r\n\r\n- åˆ›å»ºç§’æ€è®¢å•æ–¹æ³•å®ç°`org.klaus.zgg01mall.order.service.impl.OrderServiceImpl#createSeckillOrder`\r\n\r\n```java\r\n\t@Override\r\n    public void createSeckillOrder(SeckillOrderTo seckillOrder) {\r\n        //todo ä¿å­˜è®¢å•ä¿¡æ¯\r\n        OrderEntity orderEntity = new OrderEntity();\r\n        orderEntity.setOrderSn(seckillOrder.getOrderSn());\r\n        orderEntity.setMemberId(seckillOrder.getMemberId());\r\n\r\n        orderEntity.setStatus(OrderStatusEnum.CREATE_NEW.getCode());\r\n\r\n        BigDecimal amount = seckillOrder.getSeckillPrice().multiply(new BigDecimal(\"\" + seckillOrder.getNum()));\r\n        orderEntity.setPayAmount(amount);\r\n        orderEntity.setTotalAmount(amount);//todo\r\n\r\n        //ä¿å­˜è®¢å•\r\n        this.save(orderEntity);\r\n        //todo ä¿å­˜è®¢å•é¡¹ä¿¡æ¯\r\n        OrderItemEntity itemEntity = new OrderItemEntity();\r\n        itemEntity.setOrderSn(seckillOrder.getOrderSn());\r\n        itemEntity.setRealAmount(amount);\r\n        //todo è·å–å½“å‰skuçš„è¯¦ç»†ä¿¡æ¯è¿›è¡Œè®¾ç½® seckillservice-> productFeignService.getSpuInfoBySkuId()\r\n        R r = productFeignService.getSpuInfoBySkuId(seckillOrder.getSkuId());\r\n        if (r.getCode() == 0) {\r\n            SpuInfoVo data = r.getData(new TypeReference<SpuInfoVo>() {\r\n            });\r\n            itemEntity.setSpuId(data.getId());\r\n            itemEntity.setSpuName(data.getSpuName());\r\n            itemEntity.setSpuBrand(data.getBrandId().toString());\r\n            itemEntity.setCategoryId(data.getCatalogId());\r\n\r\n\r\n\r\n        }\r\n        //1ã€æ‰¾åˆ°æ‰€æœ‰éœ€è¦å‚ä¸ç§’æ€çš„å•†å“ä¿¡æ¯\r\n        R info = seckillFeignService.getSkuSeckillInfo(seckillOrder.getSkuId());\r\n        if (info.getCode() == 0){\r\n            SeckillSkuRedisTo data = info.getData(new TypeReference<SeckillSkuRedisTo>() {\r\n            });\r\n            itemEntity.setSkuName(data.getSkuInfoVo().getSkuTitle());\r\n            itemEntity.setSkuPic(data.getSkuInfoVo().getSkuDefaultImg());\r\n            //todo é”€å”®å±æ€§ç»„åˆ\r\n\r\n        }\r\n\r\n\r\n        itemEntity.setSkuId(seckillOrder.getSkuId());\r\n        itemEntity.setSkuQuantity(seckillOrder.getNum());\r\n\r\n        //ä¿å­˜è®¢å•é¡¹\r\n        orderItemService.save(itemEntity);\r\n    }\r\n/**\r\n     * ä¿å­˜è®¢å•æ•°æ®\r\n     * @param order\r\n     */\r\n    private void saveOrder(OrderCreateTo order) {\r\n        OrderEntity orderEntity = order.getOrder();\r\n        orderEntity.setModifyTime(new Date());\r\n        //æ’å…¥è®¢å•\r\n        this.save(orderEntity);\r\n\r\n        List<OrderItemEntity> orderItems = order.getOrderItems();\r\n        //seataä¸æ”¯æŒæ‰¹é‡ä¿å­˜...ä¸”åœ¨é«˜å¹¶å‘ç¯å¢ƒæ­¤ä¸šåŠ¡ä¸é€‚ç”¨Seata\r\n        orderItemService.saveBatch(orderItems);\r\n//        for (OrderItemEntity orderItem : orderItems) {\r\n//            orderItemService.save(orderItem);\r\n//        }\r\n    }\r\n```\r\n\r\n- å‡†å¤‡ç§’æ€ï¼ˆå·²ç™»å½•ï¼‰\r\n\r\n![image-20230428202310827](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428202310827.png)\r\n\r\n- ç§’æ€æˆåŠŸé¡µ\r\n\r\n![image-20230428203902875](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428203902875.png)\r\n\r\n- å»æ”¯ä»˜\r\n\r\n![image-20230428204012516](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428204012516.png)\r\n\r\n![image-20230428204042723](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428204042723.png)\r\n\r\n- æ”¯ä»˜æˆåŠŸ\r\n\r\n![image-20230428204055365](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428204055365.png)\r\n\r\n\r\n\r\n- é¡µé¢è·³è½¬åŒæ­¥é€šçŸ¥é¡µé¢è·¯å¾„ éœ€`http://`æ ¼å¼çš„å®Œæ•´è·¯å¾„ï¼Œä¸èƒ½åŠ ?id=123è¿™ç±»è‡ªå®šä¹‰å‚æ•°ï¼Œå¿…é¡»å¤–ç½‘å¯ä»¥æ­£å¸¸è®¿é—®ï¼ˆé…ç½®å†…ç½‘ç©¿é€ï¼‰\r\n\r\n![image-20230428204105232](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428204105232.png)\r\n\r\n- åŒæ­¥é€šçŸ¥ï¼Œæ”¯ä»˜æˆåŠŸï¼Œä¸€èˆ¬è·³è½¬åˆ°æˆåŠŸé¡µ\r\n\r\n![image-20230428204113061](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428204113061.png)\r\n\r\n> æœªå¼€å‘ç§’æ€è®¢å•è¶…æ—¶/æœªä»˜æ¬¾/å·²å–æ¶ˆ\r\n>\r\n\r\n\r\n\r\n- ç§’æ€å¤±è´¥é¡µé¢è¿”å›ï¼ˆç§’æ€å ä½keyï¼šuserId_sessionId_skuIdæœªè¿‡æœŸï¼Œå·²è¢«åˆ«äººæŠ¢è´­äº†ï¼‰\r\n\r\n`http://seckill.gulimall.com/kill?killId=20_61&key=83e8d796d84d4048b3c93608b30f8493&num=1`\r\n\r\n![image-20230428202441771](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428202441771.png)\r\n\r\n\r\n\r\n![image-20230428202629284](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428202629284.png)\r\n\r\n- ä¿¡å·é‡é™åˆ¶æŠ¢è´­æ•°é‡\r\n\r\n- ä¿¡å·é‡æ¯ç§’æ€æˆåŠŸä¸€æ¬¡ï¼Œä¿¡å·é‡å‡ä¸€ï¼Œseckill_count -> seckill_count - 1\r\n\r\n![image-20230428202717075](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428202717075.png)\r\n\r\n- ç§’æ€é”çš„è¿‡æœŸæ˜¯ä¸ºlong ttl = endTime - current;\r\n\r\n![image-20230428203528296](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230428203528296.png)\r\n\r\n\r\n\r\n \r\n\r\n\r\n\r\n\r\n\r\n### 4 ç§’æ€ï¼ˆé«˜å¹¶å‘ï¼‰ç³»ç»Ÿå…³æ³¨çš„é—®é¢˜ \r\n\r\n\r\n\r\n\r\n\r\n#### 4.1 æœåŠ¡å•ä¸€èŒè´£+ç‹¬ç«‹éƒ¨ç½² \r\n\r\n\r\n\r\n- ç§’æ€æœåŠ¡å³ä½¿è‡ªå·±æ‰›ä¸ä½å‹åŠ›ï¼ŒæŒ‚æ‰ï¼Œä¸è¦å½±å“åˆ«äºº\r\n\r\n\r\n\r\n#### 4.2 ç§’æ€é“¾æ¥åŠ å¯† \r\n\r\n\r\n\r\n- é˜²æ­¢æ¶æ„æ”»å‡»æ¨¡æ‹Ÿç§’æ€è¯·æ±‚ï¼Œ1000æ¬¡/sæ”»å‡» é˜²æ­¢è¿æ¥æš´éœ²ï¼Œè‡ªå·±å·¥ä½œäººå‘˜ï¼Œæå‰ç§’æ€å•†å“\r\n\r\n\r\n\r\n#### 4.3 åº“å­˜é¢„çƒ­ + å¿«é€Ÿæ‰£å‡ \r\n\r\n\r\n\r\n- æå‰æŠŠæ•°æ®åŠ è½½ç¼“å­˜ä¸­\r\n\r\n\r\n\r\n#### 4.4 åŠ¨é™åˆ†ç¦» \r\n\r\n\r\n\r\n- nginxåšå¥½åŠ¨é™åˆ†ç¦»ï¼Œä¿è¯ç§’æ€å’Œå•†å“è¯¦æƒ…é¡µçš„åŠ¨æ€è¯·æ±‚æ‰æ‰“åˆ°åç«¯çš„æœåŠ¡é›†ç¾¤\r\n\r\n\r\n\r\n- ä½¿ç”¨ CDN ç½‘ç»œï¼Œåˆ†æ‹…æœåŠ¡å™¨å‹åŠ›\r\n\r\n\r\n\r\n#### 4.5 æ¶æ„è¯·æ±‚æ‹¦æˆª \r\n\r\n\r\n\r\n- è¯†åˆ«éæ³•æ”»å‡»çš„è¯·æ±‚å¹¶è¿›è¡Œæ‹¦æˆª\tï¼Œç½‘å…³å±‚\r\n\r\n\r\n\r\n#### 4.6 æµé‡é”™å³° \r\n\r\n\r\n\r\n- ä½¿ç”¨å„ç§æ‰‹æ®µï¼Œå°†æµé‡åˆ†æ‹…åˆ°æ›´å¤§å®½åº¦çš„æ—¶é—´ç‚¹ï¼Œæ¯”å¦‚éªŒè¯ç ï¼ŒåŠ å…¥è´­ç‰©è½¦\r\n\r\n\r\n\r\n#### 4.7 é™æµ & ç†”æ–­ & é™çº§ \r\n\r\n\r\n\r\n- å‰ç«¯é™æµ + åç«¯é™æµ\r\n\r\n\r\n\r\n- é™åˆ¶æ¬¡æ•°ï¼Œé™åˆ¶æ€»é‡ï¼Œå¿«é€Ÿå¤±è´¥é™çº§è¿è¡Œï¼Œç†”æ–­éš”ç¦»é˜²æ­¢é›ªå´©\r\n\r\n\r\n\r\n#### 4.8 é˜Ÿåˆ—æ¶ˆå³° \r\n\r\n\r\n\r\n- 1ä¸‡ä¸ªè¯·æ±‚ï¼Œæ¯ä¸ª1000ä»¶è¢«ç§’æ€ï¼ŒåŒ11æ‰€æœ‰ç§’æ€æˆåŠŸçš„è¯·æ±‚ï¼Œè¿›å…¥é˜Ÿåˆ—ï¼Œæ…¢æ…¢åˆ›å»ºè®¢å•ï¼Œæ‰£å‡åº“å­˜å³å¯\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n### 5 é™æµ & ç†”æ–­ & é™çº§ \r\n\r\n"},{"title":"Valaxy+github-pageséƒ¨ç½²é—®é¢˜","tags":["valaxy"],"categories":["Valaxy Notes"],"author":"","excerpt":"\r\n## Using Valaxy+github to create a personal blog showing 404 errors{lang=\"en\"}\r\n\r\n::: en\r\nWhen setting up a personal blog, because the project name is not case sensitive when creating the repository, then deploy access to 404 as shown in the image belowï¼š![1](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20190917114816230.png)\r\n:::\r\n\r\n::: en\r\n\r\nBut if you set the project name in the repository to your github username +.github+.io, you'll be able to access it immediately It must be your github user name, which should be consistent with the github user name. If you do not want to access the address with the suffix.io, you can purchase a personal domain and deploy it in your github project settings\r\n\r\n:::\r\n\r\n# åˆ©ç”¨Valaxy+githubæ­å»ºä¸ªäººåšå®¢æ˜¾ç¤º404é”™è¯¯? {lang=\"zh-CN\"}\r\n\r\n::: zh-CN\r\nåœ¨æ­å»ºä¸ªäººåšå®¢çš„æ—¶å€™ï¼Œå› ä¸ºåˆ›å»ºä»“åº“è®¾ç½®é¡¹ç›®åæ—¶æ²¡æ³¨æ„å¤§å°å†™ï¼Œç„¶åéƒ¨ç½²è®¿é—®ä¸€ç›´404ã€‚åƒä¸‹å›¾è¿™æ ·ï¼š![1](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20190917114816230.png)\r\n\r\n:::\r\n\r\n\r\n\r\n::: zh-CN\r\n\r\nåæ¥å…¨éƒ¨æ”¹æˆå°å†™ä¹Ÿæ²¡æœ‰ç”¨ï¼Œç¿»ç›˜é‡æ–°å®‰è£…ä¹Ÿæ²¡æœ‰ç”¨ã€‚\r\nä½†æ˜¯å¦‚æœæŠŠä»“åº“ä¸­è®¾ç½®çš„é¡¹ç›®åè®¾ç½®ä¸ºï¼šä½ çš„githubçš„ç”¨æˆ·å+.github+.io,é©¬ä¸Šå°±å¯ä»¥è®¿é—®å•¦ã€‚ä¸€å®šè¦æ˜¯ä½ githubçš„ç”¨æˆ·åï¼Œè¦å’Œgithubçš„ç”¨æˆ·åä¿æŒä¸€è‡´ï¼Œå¦‚æœä¸æƒ³è¦è¿™ç§åç¼€ä¸º.ioçš„è®¿é—®åœ°å€ï¼ŒåæœŸå¯ä»¥è´­ä¹°ä¸€ä¸ªä¸ªäººåŸŸåéƒ¨ç½²ä¸Šå»ã€‚åœ¨ä½ githubé¡¹ç›®çš„settingsé‡Œé¢è®¾ç½®ä¸€ä¸‹å°±å¥½äº†ã€‚\r\n\r\n:::\r\n\r\n","link":"/posts/GitHub_Pages_Problem1","content":"\r\n## Using Valaxy+github to create a personal blog showing 404 errors{lang=\"en\"}\r\n\r\n::: en\r\nWhen setting up a personal blog, because the project name is not case sensitive when creating the repository, then deploy access to 404 as shown in the image belowï¼š![1](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20190917114816230.png)\r\n:::\r\n\r\n::: en\r\n\r\nBut if you set the project name in the repository to your github username +.github+.io, you'll be able to access it immediately It must be your github user name, which should be consistent with the github user name. If you do not want to access the address with the suffix.io, you can purchase a personal domain and deploy it in your github project settings\r\n\r\n:::\r\n\r\n# åˆ©ç”¨Valaxy+githubæ­å»ºä¸ªäººåšå®¢æ˜¾ç¤º404é”™è¯¯? {lang=\"zh-CN\"}\r\n\r\n::: zh-CN\r\nåœ¨æ­å»ºä¸ªäººåšå®¢çš„æ—¶å€™ï¼Œå› ä¸ºåˆ›å»ºä»“åº“è®¾ç½®é¡¹ç›®åæ—¶æ²¡æ³¨æ„å¤§å°å†™ï¼Œç„¶åéƒ¨ç½²è®¿é—®ä¸€ç›´404ã€‚åƒä¸‹å›¾è¿™æ ·ï¼š![1](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20190917114816230.png)\r\n\r\n:::\r\n\r\n\r\n\r\n::: zh-CN\r\n\r\nåæ¥å…¨éƒ¨æ”¹æˆå°å†™ä¹Ÿæ²¡æœ‰ç”¨ï¼Œç¿»ç›˜é‡æ–°å®‰è£…ä¹Ÿæ²¡æœ‰ç”¨ã€‚\r\nä½†æ˜¯å¦‚æœæŠŠä»“åº“ä¸­è®¾ç½®çš„é¡¹ç›®åè®¾ç½®ä¸ºï¼šä½ çš„githubçš„ç”¨æˆ·å+.github+.io,é©¬ä¸Šå°±å¯ä»¥è®¿é—®å•¦ã€‚ä¸€å®šè¦æ˜¯ä½ githubçš„ç”¨æˆ·åï¼Œè¦å’Œgithubçš„ç”¨æˆ·åä¿æŒä¸€è‡´ï¼Œå¦‚æœä¸æƒ³è¦è¿™ç§åç¼€ä¸º.ioçš„è®¿é—®åœ°å€ï¼ŒåæœŸå¯ä»¥è´­ä¹°ä¸€ä¸ªä¸ªäººåŸŸåéƒ¨ç½²ä¸Šå»ã€‚åœ¨ä½ githubé¡¹ç›®çš„settingsé‡Œé¢è®¾ç½®ä¸€ä¸‹å°±å¥½äº†ã€‚\r\n\r\n:::\r\n\r\n<!-- more -->\r\n"},{"title":"åˆ©ç”¨valaxy+github+PicGoæ­å»ºgithubå›¾åºŠé—®é¢˜","tags":["valaxy"],"categories":["Valaxy Notes"],"author":"","excerpt":":::warning NEW CDN!!!\r\n\r\n> `https://gcore.jsdelivr.net/gh/ {{owner}}/{{repo}}@{{branch}}/{{path}}`\r\n\r\n\r\n:::\r\n\r\n\r\n\r\n::: details å·²å¤±æ•ˆè§£å†³æ–¹æ³•\r\n\r\n1. åˆ©ç”¨valaxy+githubæ­å»ºä¸ªäººåšå®¢å›¾ç‰‡ä¸æ˜¾ç¤º?\r\n\r\n  - ä½¿ç”¨å›¾åºŠä¼ è¾“å›¾ç‰‡\r\n    - é—®é¢˜ï¼šä½¿ç”¨ç‰›ä¸ƒã€Giteeå›¾åºŠå‡æœ‰é—®é¢˜\r\n\r\n2. 2023ä½¿ç”¨picgo + githubæ­å»ºå›¾åºŠï¼ˆtyporaï¼‰,è§£å†³jsdelivré—®é¢˜\r\n\r\n:::\r\n\r\n","link":"/posts/GitHub_Pages_Problem2","content":":::warning NEW CDN!!!\r\n\r\n> `https://gcore.jsdelivr.net/gh/ {{owner}}/{{repo}}@{{branch}}/{{path}}`\r\n\r\n\r\n:::\r\n\r\n\r\n\r\n::: details å·²å¤±æ•ˆè§£å†³æ–¹æ³•\r\n\r\n1. åˆ©ç”¨valaxy+githubæ­å»ºä¸ªäººåšå®¢å›¾ç‰‡ä¸æ˜¾ç¤º?\r\n\r\n  - ä½¿ç”¨å›¾åºŠä¼ è¾“å›¾ç‰‡\r\n    - é—®é¢˜ï¼šä½¿ç”¨ç‰›ä¸ƒã€Giteeå›¾åºŠå‡æœ‰é—®é¢˜\r\n\r\n2. 2023ä½¿ç”¨picgo + githubæ­å»ºå›¾åºŠï¼ˆtyporaï¼‰,è§£å†³jsdelivré—®é¢˜\r\n\r\n:::\r\n\r\n<!-- more -->\r\n\r\n## ä¸€ã€å›¾åºŠæ˜¯ä»€ä¹ˆ\r\n\r\n> **å›¾åºŠä¸€èˆ¬æ˜¯æŒ‡å‚¨å­˜å›¾ç‰‡çš„æœåŠ¡å™¨**\r\n>\r\n> æœ‰å›½å†…å’Œå›½å¤–ä¹‹åˆ†ã€‚å›½å¤–çš„å›¾åºŠç”±äºæœ‰ç©ºé—´è·ç¦»ç­‰å› ç´ å†³å®šè®¿é—®é€Ÿåº¦å¾ˆæ…¢å½±å“å›¾ç‰‡æ˜¾ç¤ºé€Ÿåº¦ã€‚å›½å†…ä¹Ÿåˆ†ä¸ºå•çº¿ç©ºé—´ã€å¤šçº¿ç©ºé—´å’ŒcdnåŠ é€Ÿä¸‰ç§ã€‚\r\n>\r\n\r\n- è¯´äººè¯ï¼š å°±æ˜¯æŠŠä½ åšå®¢ï¼Œæˆ–è€…ç¬”è®°ä¸­çš„å›¾ç‰‡å­˜åˆ°äº‘ç«¯ä¸Šå»ï¼Œè¿™æ ·æ–‡æœ¬é‡Œé¢åªç•™å­˜å›¾ç‰‡é“¾æ¥\r\n\r\n\r\n- ä¸¾ä¸ªä¾‹å­ï¼š\r\n\r\n  - â€ƒâ€ƒå†™markdownç¬”è®°æ—¶ï¼Œå›¾ç‰‡å­˜å‚¨åœ¨æœ¬åœ°ï¼Œç”¨ç›¸å¯¹è·¯å¾„æˆ–è€…ç»å¯¹è·¯å¾„åŠ è½½å›¾ç‰‡ï¼Œå¦‚æœè¦åŒæ­¥ç¬”è®°æˆ–è€…è¿ç§»ç¬”è®°çš„è¯ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯è¦æŠŠå›¾ç‰‡ä¹Ÿè¿›è¡Œè¿ç§»ï¼Œå¾ˆéº»çƒ¦ã€‚\r\n  - â€ƒâ€ƒæœ‰äººä¼šè¯´å¯ä»¥ç›´æ¥å¤åˆ¶æ•´ä¸ªç›®å½•ç»“æ„ï¼Œä¹Ÿéº»çƒ¦ä¸äº†å¤ªå¤šã€‚ä½†æ˜¯è¿™æ ·æ˜¯ä¸æ˜¯å°†æ¥åœ¨ä¸¤ä¸ªè®¾å¤‡å†™markdownæ—¶ï¼Œå°±éœ€è¦æ€»æ˜¯åŒæ­¥å›¾ç‰‡ï¼Œç‰¹åˆ«æ˜¯å¦‚æœæœ¬åœ°å†™å¥½åšå®¢ï¼Œå»å‘å¸ƒæ—¶ï¼Œå›¾ç‰‡é“¾æ¥åˆè¯¥å¦‚ä½•è®©å»è§£å†³ï¼Œä¸€å¼ ä¸€å¼ å¤„ç†ï¼Œæ•ˆç‡æ˜¾ç„¶å¤ªæ…¢äº†ã€‚\r\n\r\n- **å›¾åºŠæœ‰ä»€ä¹ˆæ•ˆæœ**ï¼šä¾‹å­ä¸­é‚£äº›é—®é¢˜ï¼Œå›¾åºŠå°±å¯ä»¥å¾ˆå¥½çš„è§£å†³\r\n\r\n  - åŒæ­¥ç¬”è®°æ—¶ï¼Œåˆ©ç”¨iCloudï¼Œæˆ–è€…å…¶ä»–äº‘ç›˜ï¼Œå°±å¯ä»¥ç›´æ¥åŒæ­¥markdownçº¯æ–‡æœ¬æ–‡ä»¶ï¼Œä¸éœ€è¦å†è€ƒè™‘å›¾ç‰‡é—®é¢˜ï¼Œç¬”è®°çš„ä½“ç§¯è¿˜å°ï¼Œåªéœ€è¦å­˜å‚¨markdownæ–‡æœ¬æ–‡ä»¶ï¼Œå»å¤„ç†å›¾ç‰‡çš„ä½“ç§¯ã€‚\r\n\r\n\r\n  - åšå®¢ä¹Ÿåªéœ€è¦ï¼Œå°†markdownå…¨é€‰ + å¤åˆ¶ + ç²˜è´´ + å‘å¸ƒå°±å¥½äº†\r\n\r\n## äºŒã€æ€ä¹ˆæ­å»º\r\n\r\næ–¹æ³•æœ‰å¾ˆå¤šï¼Œä½†æ˜¯è¯´åˆ°åº•è¿˜æ˜¯é€‰æ‹©ç”¨ä»€ä¹ˆæ ·çš„äº‘å­˜å‚¨ï¼Œå¯ä»¥æ˜¯è‡ªå·±ç”¨æœåŠ¡å™¨å†™APIæ¥æ­å»ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¤§å‚å•†æä¾›çš„å¯¹è±¡å­˜å‚¨ï¼Œè¿˜æœ‰å°±æ˜¯æœ¬æ–‡çš„ç™½å«–ï¼Œç™½å«–**GitHub**ã€‚\r\n\r\nè€Œ**picgo**åªæ˜¯ä¸€ä¸ªå›¾åºŠç®¡ç†å·¥å…·ï¼Œå¸®åŠ©æˆ‘ä»¬ä¸Šä¼ å›¾ç‰‡åˆ°å›¾åºŠã€‚åŒæ ·çš„åº”ç”¨è¿˜æœ‰upicï¼Œä»¥åŠå…¶ä»–ï¼Œéƒ½æ˜¯åŒæ ·çš„åŠŸèƒ½ï¼Œä½†å›¾åºŠçš„æ–¹ä¾¿ä¸€å®šå°‘ä¸äº†å›¾åºŠç®¡ç†å·¥å…·ã€‚picgoåˆ™æ˜¯å¯ä»¥é…åˆtyporaä½¿ç”¨ã€‚\r\n\r\n### 1ã€é…ç½®GitHub\r\n\r\n- **ï¼ˆ1ï¼‰åˆ›å»ºä»“åº“**\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/c791d4e795611f0342ab5c879867dea2.png)\r\n\r\n- **ï¼ˆ2ï¼‰ç”Ÿæˆtokenç§é’¥**\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/902ddd25b9976089fed18d3650d2c98d.png)\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/a86707f29b24f8e2e847dea8016bdcf4.png)\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/c866998186ee8f45c0ad5a58a157fcbe.png)\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/170e1d5c60cd35e54eabf62e150737e0.png)\r\n\r\n\r\n\r\n**ps: å¾—åˆ°çš„ç§é’¥è¦ä¿å­˜ä¸‹æ¥ï¼Œåé¢githubä¸Šæ— æ³•æŸ¥çœ‹**\r\n\r\n### 2ã€é…ç½®picgo\r\n\r\n[picgoä¸‹è½½](https://github.com/Molunerfinn/PicGo/releases)\r\n\r\nè¿˜éœ€è¦é…ç½®node.jsç¯å¢ƒæ‰å¯ä»¥ä½¿ç”¨ã€‚[node.jså®‰è£…åŠç¯å¢ƒé…ç½®](https://blog.csdn.net/weixin_44893902/article/details/121788104?ops_request_misc=%7B%22request%5Fid%22%3A%22167245108816782425141530%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&request_id=167245108816782425141530&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-121788104-null-null.142%5Ev68%5Econtrol,201%5Ev4%5Eadd_ask,213%5Ev2%5Et3_esquery_v1&utm_term=nodejs%E5%AE%89%E8%A3%85%E5%8F%8A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE&spm=1018.2226.3001.4187)\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/f7fe908fcc004715cbf803737008a3cd.png)\r\n\r\n|      **åç§°**      |                     **å¡«å†™**                     |\r\n| :----------------: | :----------------------------------------------: |\r\n|     è®¾å®šä»“åº“å     |                  ç”¨æˆ·å/ä»“åº“å                   |\r\n|     è®¾å®šåˆ†æ”¯å     |              åˆ†æ”¯åï¼Œç”¨æˆ·mainå°±å¯ä»¥              |\r\n|     è®¾å®šToken      |          è¿™ä¸ªå°±æ˜¯GitHubé…ç½®çš„tokenç§é’¥           |\r\n|    è®¾å®šå­˜å‚¨è·¯å¾„    |            ç›¸å¯¹äºä»“åº“æ¥è¯´ï¼Œè‡ªå®šä¹‰å¡«å†™            |\r\n| **è®¾å®šè‡ªå®šä¹‰åŸŸå** | **é‡è¦ï¼ï¼ï¼è§£å†³jsdelivr CDNåŠ é€Ÿé—®é¢˜ å¦‚ä¸‹å¡«å†™.** |\r\n\r\n**è§£å†³jsdelivr CDNåŠ é€Ÿé—®é¢˜**\r\n**è¿™ä¸ªç°åœ¨å¤±æ•ˆäº†**ï¼šhttps://gcore.jsdelivr.net/gh/[githubç”¨æˆ·å]/[ä»“åº“å]@main\r\n\r\næ”¹æˆï¼š\r\n\r\n`https://gcore.jsdelivr.net/gh/[githubç”¨æˆ·å]/[ä»“åº“å]@main`\r\n@åé¢è·Ÿçš„æ˜¯å¡«å†™çš„åˆ†æ”¯åï¼Œä¸€å®šè¦ä¸€è‡´\r\n\r\n### 3ã€é…ç½®typora\r\n\r\næ‰“å¼€ï¼š**æ–‡ä»¶ -> åå¥½è®¾ç½® -> å›¾åƒ**\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/275d2affc2d30b38d5f7289cb503d93c.png)\r\n\r\nä½¿ç”¨ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/70709553f8512ad6322a703c40bee0ec.png)\r\n\r\næ•ˆæœï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/707661c51dc34abd8a515b3e14dba868.png)\r\n\r\n> ä»æ˜¨å¤©å¼€å§‹Staticalyå°±æç¤ºè¿‡æœŸäº†ï¼Œå¯¼è‡´æˆ‘çš„ä¸€äº›ç«™ç‚¹ä¸­å›¾ç‰‡æ— æ³•åŠ è½½ï¼Œç´¢æ€§ä»Šå¤©å°±æ›¿æ¢ä¸‹\r\n>\r\n> ç”±äºæˆ‘çš„å›¾åºŠéƒ½æ˜¯åœ¨githubä¸­ï¼Œæ‰€ä»¥é“¾æ¥æ›¿æ¢ä¸Šè¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ï¼Œä»¥ä¸‹æ˜¯æˆ‘æ‰¾çš„å‡ ä¸ªå¯ä»¥æ›¿æ¢çš„å…è´¹CDNï¼š\r\n>\r\n> å®˜æ–¹ï¼šhttps://cdnjs.shssedu.ac.cn/github ã€CDNJSCN æ˜¯ä¸€é¡¹å…è´¹å¼€æº CDN (å›½å†…)æœç´¢æœåŠ¡ï¼ŒCDNJSå—åˆ°è¶…è¿‡ å…¨çƒ 12.5% ç½‘ç«™çš„ä¿¡ä»», å¤šè¾¾ 2000 äº¿è¯·æ±‚/æœˆ, ç”± Cloudflareã€loli.netã€onmicrosoft.cnã€cdn.chuqis.comã€cdn.staticfile.orgæä¾›æœåŠ¡æ”¯æŒã€‚ã€‘\r\n>\r\n> æ›¿æ¢ï¼š\r\n>\r\n> https://cdn.chuqis.com/\r\n>\r\n> https://gcore.jsdelivr.net/\r\n>\r\n> è¿˜æœ‰ä¸€ä¸ªå›½å†…çš„å¥—Cloudflareçš„Staticalyï¼šhttps://gcore.jsdelivr.net\r\n>\r\n> å¦‚æœä½ è·Ÿæˆ‘ä¸€æ ·å›¾ç‰‡æ˜¯åœ¨githubä¸Šçš„åˆ™æ›¿æ¢æ ¼å¼ä¸º\r\n>\r\n> ```http\r\n> https://cdn.chuqis.com/gh/ {{owner}}/{{repo}}@{{branch}}/{{path}}\r\n> ```\r\n"},{"title":"Hello, Valaxy!","tags":["valaxy"],"categories":["Valaxy Notes"],"author":"","excerpt":"\r\n## What is Valaxy? {lang=\"en\"}\r\n\r\n::: en\r\nValaxy aims to be a next generation of static blogging frameworks/generators.\r\n:::\r\n\r\n## ä»€ä¹ˆæ˜¯ Valaxy? {lang=\"zh-CN\"}\r\n\r\n::: zh-CN\r\nValaxy çš„ç›®æ ‡æ˜¯æˆä¸ºæ–°ä¸€ä»£çš„é™æ€åšå®¢æ¡†æ¶/ç”Ÿæˆå™¨ã€‚\r\n:::\r\n\r\nMore info see [valaxy.site](https://valaxy.site).\r\n\r\n```ts\r\n/**\r\n * User Config\r\n * do not use export const, because c12 will set as child property\r\n */\r\nexport default defineValaxyConfig<ThemeConfig>({\r\n  theme: 'yun',\r\n\r\n  themeConfig: {\r\n    banner: {\r\n      enable: true,\r\n      title: 'äº‘æ¸¸å›çš„å°ç«™',\r\n    },\r\n  },\r\n})\r\n```\r\n\r\n\r\n\r\n## é…ç½®{lang=\"zh-CN\"}\r\n\r\n::: zh-CN\r\n\r\nç»“åˆhttps://valaxy.site/ ä¸ [è¶…å¯çˆ±ï¼ä½¿ç”¨ Valaxy æ­å»ºè‡ªå·±çš„åšå®¢ - -Yuumi's Blog-](https://www.yuumi.link/posts/valaxy)æ¥çœ‹\r\n\r\n:::\r\n\r\n## Config{lang=\"en\"}\r\n\r\n::: en\r\n\r\nCombinedhttps://valaxy.site/ with [Super cute! Build your own Blog with Valaxy -Yuumi's Blog-](https://www.yuumi.link/posts/valaxy)\r\n\r\n:::\r\n","link":"/posts/hello-valaxy","content":"\r\n## What is Valaxy? {lang=\"en\"}\r\n\r\n::: en\r\nValaxy aims to be a next generation of static blogging frameworks/generators.\r\n:::\r\n\r\n## ä»€ä¹ˆæ˜¯ Valaxy? {lang=\"zh-CN\"}\r\n\r\n::: zh-CN\r\nValaxy çš„ç›®æ ‡æ˜¯æˆä¸ºæ–°ä¸€ä»£çš„é™æ€åšå®¢æ¡†æ¶/ç”Ÿæˆå™¨ã€‚\r\n:::\r\n\r\nMore info see [valaxy.site](https://valaxy.site).\r\n\r\n```ts\r\n/**\r\n * User Config\r\n * do not use export const, because c12 will set as child property\r\n */\r\nexport default defineValaxyConfig<ThemeConfig>({\r\n  theme: 'yun',\r\n\r\n  themeConfig: {\r\n    banner: {\r\n      enable: true,\r\n      title: 'äº‘æ¸¸å›çš„å°ç«™',\r\n    },\r\n  },\r\n})\r\n```\r\n\r\n\r\n\r\n## é…ç½®{lang=\"zh-CN\"}\r\n\r\n::: zh-CN\r\n\r\nç»“åˆhttps://valaxy.site/ ä¸ [è¶…å¯çˆ±ï¼ä½¿ç”¨ Valaxy æ­å»ºè‡ªå·±çš„åšå®¢ - -Yuumi's Blog-](https://www.yuumi.link/posts/valaxy)æ¥çœ‹\r\n\r\n:::\r\n\r\n## Config{lang=\"en\"}\r\n\r\n::: en\r\n\r\nCombinedhttps://valaxy.site/ with [Super cute! Build your own Blog with Valaxy -Yuumi's Blog-](https://www.yuumi.link/posts/valaxy)\r\n\r\n:::\r\n<!-- more -->"},{"title":"ç¬¬ä¸€ç« . åç«¯ä¹‹äºå‰ç«¯ - HTML ä¸ CSS","tags":["HTML","CSS"],"categories":["å‰ç«¯"],"author":"imklaus","excerpt":"\r\n\r\n\r\n\r\n\r\nHTML æ˜¯ä»€ä¹ˆï¼šå³ HyperText Markup language è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ï¼Œå’±ä»¬ç†ŸçŸ¥çš„ç½‘é¡µå°±æ˜¯ç”¨å®ƒç¼–å†™çš„ï¼ŒHTML çš„ä½œç”¨æ˜¯å®šä¹‰ç½‘é¡µçš„å†…å®¹å’Œç»“æ„ã€‚\r\n\r\n* HyperText æ˜¯æŒ‡ç”¨è¶…é“¾æ¥çš„æ–¹å¼ç»„ç»‡ç½‘é¡µï¼ŒæŠŠç½‘é¡µè”ç³»èµ·æ¥\r\n* Markup æ˜¯æŒ‡ç”¨ `<æ ‡ç­¾>` çš„æ–¹å¼èµ‹äºˆå†…å®¹ä¸åŒçš„åŠŸèƒ½å’Œå«ä¹‰\r\n\r\nCSS æ˜¯ä»€ä¹ˆï¼šå³ Cascading  Style  Sheets çº§è”ï¼ˆå±‚å ï¼‰æ ·å¼è¡¨ï¼Œå®ƒæè¿°äº†ç½‘é¡µçš„è¡¨ç°ä¸å±•ç¤ºæ•ˆæœ\r\n\r\n","link":"/posts/HTML-CSS","content":"\r\n\r\n\r\n\r\n\r\nHTML æ˜¯ä»€ä¹ˆï¼šå³ HyperText Markup language è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ï¼Œå’±ä»¬ç†ŸçŸ¥çš„ç½‘é¡µå°±æ˜¯ç”¨å®ƒç¼–å†™çš„ï¼ŒHTML çš„ä½œç”¨æ˜¯å®šä¹‰ç½‘é¡µçš„å†…å®¹å’Œç»“æ„ã€‚\r\n\r\n* HyperText æ˜¯æŒ‡ç”¨è¶…é“¾æ¥çš„æ–¹å¼ç»„ç»‡ç½‘é¡µï¼ŒæŠŠç½‘é¡µè”ç³»èµ·æ¥\r\n* Markup æ˜¯æŒ‡ç”¨ `<æ ‡ç­¾>` çš„æ–¹å¼èµ‹äºˆå†…å®¹ä¸åŒçš„åŠŸèƒ½å’Œå«ä¹‰\r\n\r\nCSS æ˜¯ä»€ä¹ˆï¼šå³ Cascading  Style  Sheets çº§è”ï¼ˆå±‚å ï¼‰æ ·å¼è¡¨ï¼Œå®ƒæè¿°äº†ç½‘é¡µçš„è¡¨ç°ä¸å±•ç¤ºæ•ˆæœ\r\n\r\n<!-- more -->\r\n\r\n### 1. HTML å…ƒç´ \r\n\r\nHTML ç”±ä¸€ç³»åˆ—å…ƒç´  `elements` ç»„æˆï¼Œä¾‹å¦‚\r\n\r\n```html\r\n<p>Hello, world!</p>\r\n```\r\n\r\n* æ•´ä½“ç§°ä¹‹ä¸ºå…ƒç´ \r\n* `<p>` å’Œ `</p>` åˆ†åˆ«ç§°ä¸ºèµ·å§‹å’Œç»“æŸæ ‡ç­¾\r\n* æ ‡ç­¾åŒ…å›´èµ·æ¥çš„ Hello, world ç§°ä¹‹ä¸ºå†…å®¹\r\n\r\n* p æ˜¯é¢„å…ˆå®šä¹‰å¥½çš„ html æ ‡ç­¾ï¼Œä½œç”¨æ˜¯å°†å†…å®¹ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„æ®µè½\r\n\r\n\r\n\r\nå…ƒç´ è¿˜å¯ä»¥æœ‰å±æ€§ï¼Œå¦‚\r\n\r\n```html\r\n<p id=\"p1\">Hello, world!</p>\r\n```\r\n\r\n* å±æ€§ä¸€èˆ¬æ˜¯é¢„å…ˆå®šä¹‰å¥½çš„ï¼Œè¿™é‡Œçš„ id å±æ€§æ˜¯ç»™å…ƒç´ ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†\r\n\r\n\r\n\r\nå…ƒç´ ä¹‹é—´å¯ä»¥åµŒå¥—ï¼Œå¦‚\r\n\r\n```html\r\n<p>HTML æ˜¯ä¸€é—¨éå¸¸<b>å¼ºå¤§</b>çš„è¯­è¨€</p>\r\n```\r\n\r\né”™è¯¯åµŒå¥—å†™æ³•ï¼š\r\n\r\n```html\r\n<p>HTML æ˜¯ä¸€é—¨éå¸¸<b>å¼ºå¤§çš„è¯­è¨€</p></b>\r\n```\r\n\r\n\r\n\r\nä¸åŒ…å«å†…å®¹çš„å…ƒç´ ç§°ä¹‹ä¸ºç©ºå…ƒç´ ï¼Œå¦‚\r\n\r\n```html\r\n<img src=\"1.png\">\r\n<img src=\"1.png\"/>\r\n```\r\n\r\n* img ä½œç”¨æ˜¯ç”¨æ¥å±•ç¤ºå›¾ç‰‡\r\n* src å±æ€§ç”¨æ¥æŒ‡æ˜å›¾ç‰‡è·¯å¾„\r\n\r\n\r\n\r\n### 2. HTML é¡µé¢\r\n\r\nå‰é¢ä»‹ç»çš„åªæ˜¯å•ç‹¬çš„ HTML å…ƒç´ ï¼Œå®ƒä»¬å¯ä»¥å……å½“ä¸€ä»½å®Œæ•´çš„ HTML é¡µé¢çš„ç»„æˆéƒ¨åˆ†\r\n\r\n```html\r\n<!DOCTYPE html>\r\n<html>\r\n  <head>\r\n    <meta charset=\"utf-8\">\r\n    <title>æµ‹è¯•é¡µé¢</title>\r\n  </head>\r\n  <body>\r\n    <p id=\"p1\">Hello, world!</p>\r\n    <img src=\"1.png\">\r\n  </body>\r\n</html>\r\n```\r\n\r\n* `html` å…ƒç´ å›Šæ‹¬äº†é¡µé¢ä¸­æ‰€æœ‰å…¶å®ƒå…ƒç´ ï¼Œæ•´ä¸ªé¡µé¢åªéœ€ä¸€ä¸ªï¼Œç§°ä¸ºæ ¹å…ƒç´ \r\n* `head` å…ƒç´ åŒ…å«çš„æ˜¯é‚£äº›ä¸ç”¨äºå±•ç°å†…å®¹çš„å…ƒç´ ï¼Œå¦‚ `title`ï¼Œ`link`ï¼Œ`meta` ç­‰\r\n* `body` å…ƒç´ åŒ…å«äº†å¯¹ç”¨æˆ·å±•ç°å†…å®¹çš„å…ƒç´ ï¼Œä¾‹å¦‚åé¢ä¼šå­¦åˆ°çš„ç”¨äºå±•ç¤ºæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘çš„å„ç§å…ƒç´ \r\n\r\n\r\n\r\n### 3. å¸¸è§å…ƒç´ \r\n\r\n#### 1) æ–‡æœ¬\r\n\r\n##### Heading\r\n\r\n```html\r\n<h1>1å·æ ‡é¢˜</h1>\r\n<h2>2å·æ ‡é¢˜</h2>\r\n<h3>3å·æ ‡é¢˜</h3>\r\n<h4>4å·æ ‡é¢˜</h4>\r\n<h5>5å·æ ‡é¢˜</h5>\r\n<h6>6å·æ ‡é¢˜</h6>\r\n```\r\n\r\n\r\n\r\n##### Paragraph\r\n\r\n```html\r\n<p>æ®µè½</p>\r\n```\r\n\r\n\r\n\r\n##### List\r\n\r\næ— åºåˆ—è¡¨ unordered list\r\n\r\n```html\r\n<ul>\r\n    <li>åˆ—è¡¨é¡¹1</li>\r\n    <li>åˆ—è¡¨é¡¹2</li>\r\n    <li>åˆ—è¡¨é¡¹3</li>\r\n</ul>\r\n```\r\n\r\næœ‰åºåˆ—è¡¨\r\n\r\n```html\r\n<ol>\r\n    <li>åˆ—è¡¨é¡¹1</li>\r\n    <li>åˆ—è¡¨é¡¹2</li>\r\n    <li>åˆ—è¡¨é¡¹3</li>\r\n</ol>\r\n```\r\n\r\nå¤šçº§åˆ—è¡¨\r\n\r\n```html\r\n<ul>\r\n    <li>\r\n    \tåŒ—äº¬å¸‚\r\n        <ul>\r\n            <li>æµ·æ·€åŒº</li>\r\n            <li>æœé˜³åŒº</li>\r\n            <li>æ˜Œå¹³åŒº</li>\r\n        </ul>\r\n    </li>\r\n    <li>\r\n    \tæ²³åŒ—çœ\r\n        <ul>\r\n            <li>çŸ³å®¶åº„</li>\r\n            <li>ä¿å®š</li>\r\n        </ul>\r\n    </li>\r\n</ul>\r\n```\r\n\r\n\r\n\r\n##### Anchor\r\n\r\né”šï¼Œè¶…é“¾æ¥\r\n\r\n```html\r\n<a href=\"ç½‘é¡µåœ°å€\">è¶…é“¾æ¥æ–‡æœ¬</a>\r\n```\r\n\r\n\r\n\r\n#### 2) å¤šåª’ä½“\r\n\r\n##### Image\r\n\r\n```html\r\n<img src=\"æ–‡ä»¶è·¯å¾„\">\r\n```\r\n\r\nsrc æ ¼å¼æœ‰ 3 ç§\r\n\r\n* æ–‡ä»¶åœ°å€\r\n\r\n* data URLï¼Œæ ¼å¼å¦‚ä¸‹\r\n\r\n  ```\r\n  data:åª’ä½“ç±»å‹;base64,æ•°æ®\r\n  ```\r\n\r\n* object URLï¼Œéœ€è¦é…åˆ javascript ä½¿ç”¨\r\n\r\n##### Video\r\n\r\n```html\r\n<video src=\"æ–‡ä»¶è·¯å¾„\"></video>\r\n```\r\n\r\n##### Audio\r\n\r\n```html\r\n<audio src=\"æ–‡ä»¶è·¯å¾„\"></audio>\r\n```\r\n\r\n\r\n\r\n#### 3) è¡¨å•\r\n\r\n##### ä½œç”¨ä¸è¯­æ³•\r\n\r\nè¡¨å•çš„ä½œç”¨ï¼š**æ”¶é›†**ç”¨æˆ·å¡«å…¥çš„**æ•°æ®**ï¼Œå¹¶å°†è¿™äº›æ•°æ®**æäº¤ç»™æœåŠ¡å™¨**\r\n\r\nè¡¨å•çš„è¯­æ³•\r\n\r\n```html\r\n<form action=\"æœåŠ¡å™¨åœ°å€\" method=\"è¯·æ±‚æ–¹å¼\" enctype=\"æ•°æ®æ ¼å¼\">\r\n    <!-- è¡¨å•é¡¹ -->\r\n    \r\n    <input type=\"submit\" value=\"æäº¤æŒ‰é’®\">\r\n</form>\r\n```\r\n\r\n* method è¯·æ±‚æ–¹å¼æœ‰ \r\n  * get ï¼ˆé»˜è®¤ï¼‰æäº¤æ—¶ï¼Œæ•°æ®è·Ÿåœ¨ URL åœ°å€ä¹‹å\r\n  * post æäº¤æ—¶ï¼Œæ•°æ®åœ¨è¯·æ±‚ä½“å†…\r\n* enctype åœ¨ post è¯·æ±‚æ—¶ï¼ŒæŒ‡å®šè¯·æ±‚ä½“çš„æ•°æ®æ ¼å¼\r\n  * application/x-www-form-urlencodedï¼ˆé»˜è®¤ï¼‰\r\n  * multipart/form-data\r\n* å…¶ä¸­è¡¨å•é¡¹æä¾›å¤šç§æ”¶é›†æ•°æ®çš„æ–¹å¼\r\n  * æœ‰ name å±æ€§çš„è¡¨å•é¡¹æ•°æ®ï¼Œæ‰ä¼šè¢«å‘é€ç»™æœåŠ¡å™¨\r\n\r\n\r\n\r\n##### å¸¸è§çš„è¡¨å•é¡¹\r\n\r\næ–‡æœ¬æ¡†\r\n\r\n```html\r\n<input type=\"text\" name=\"uesrname\">\r\n```\r\n\r\nå¯†ç æ¡†\r\n\r\n```html\r\n<input type=\"password\" name=\"password\">\r\n```\r\n\r\néšè—æ¡†\r\n\r\n```html\r\n<input type=\"hidden\" name=\"id\">\r\n```\r\n\r\næ—¥æœŸæ¡†\r\n\r\n```html\r\n<input type=\"date\" name=\"birthday\">\r\n```\r\n\r\nå•é€‰\r\n\r\n```html\r\n<input type=\"radio\" name=\"sex\" value=\"ç”·\" checked>\r\n<input type=\"radio\" name=\"sex\" value=\"å¥³\">\r\n```\r\n\r\nå¤šé€‰\r\n\r\n```html\r\n<input type=\"checkbox\" name=\"fav\" value=\"å”±æ­Œ\">\r\n<input type=\"checkbox\" name=\"fav\" value=\"é€›è¡—\">\r\n<input type=\"checkbox\" name=\"fav\" value=\"æ¸¸æˆ\">\r\n```\r\n\r\næ–‡ä»¶ä¸Šä¼ \r\n\r\n```html\r\n<input type=\"file\" name=\"avatar\">\r\n```\r\n\r\n\r\n\r\n### 4. HTTP è¯·æ±‚\r\n\r\n#### 1) è¯·æ±‚ç»„æˆ\r\n\r\nè¯·æ±‚ç”±ä¸‰éƒ¨åˆ†ç»„æˆ\r\n\r\n1. è¯·æ±‚è¡Œ\r\n2. è¯·æ±‚å¤´\r\n3. è¯·æ±‚ä½“\r\n\r\nå¯ä»¥ç”¨ telnet ç¨‹åºæµ‹è¯•\r\n\r\n#### 2) è¯·æ±‚æ–¹å¼ä¸æ•°æ®æ ¼å¼\r\n\r\n##### get è¯·æ±‚ç¤ºä¾‹\r\n\r\n```\r\nGET /test2?name=%E5%BC%A0&age=20 HTTP/1.1\r\nHost: localhost\r\n```\r\n\r\n* %E5%BC%A0 æ˜¯ã€å¼ ã€‘ç»è¿‡ URL ç¼–ç åçš„ç»“æœ\r\n\r\n##### post è¯·æ±‚ç¤ºä¾‹\r\n\r\n```\r\nPOST /test2 HTTP/1.1\r\nHost: localhost\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: 21\r\n\r\nname=%E5%BC%A0&age=18\r\n```\r\n\r\napplication/x-www-form-urlencoed æ ¼å¼ç»†èŠ‚ï¼š\r\n\r\n* å‚æ•°åˆ†æˆåå­—å’Œå€¼ï¼Œä¸­é—´ç”¨ = åˆ†éš”\r\n* å¤šä¸ªå‚æ•°ä½¿ç”¨ & è¿›è¡Œåˆ†éš”\r\n* ã€å¼ ã€‘ç­‰ç‰¹æ®Šå­—ç¬¦éœ€è¦ç”¨ encodeURIComponent() ç¼–ç ä¸º ã€%E5%BC%A0ã€‘åæ‰èƒ½å‘é€\r\n\r\n\r\n\r\n##### json è¯·æ±‚ç¤ºä¾‹\r\n\r\n```\r\nPOST /test3 HTTP/1.1\r\nHost: localhost\r\nContent-Type: application/json\r\nContent-Length: 25\r\n\r\n{\"name\":\"zhang\",\"age\":18}\r\n```\r\n\r\n\r\n\r\njson å¯¹è±¡æ ¼å¼\r\n\r\n```\r\n{\"å±æ€§å\":å±æ€§å€¼}\r\n```\r\n\r\nå…¶ä¸­å±æ€§å€¼å¯ä»¥æ˜¯\r\n\r\n* å­—ç¬¦ä¸² \"\"\r\n* æ•°å­—\r\n* true, false\r\n* null\r\n* å¯¹è±¡\r\n* æ•°ç»„\r\n\r\njson æ•°ç»„æ ¼å¼\r\n\r\n```\r\n[å…ƒç´ 1, å…ƒç´ 2, ...]\r\n```\r\n\r\n\r\n\r\n##### multipart è¯·æ±‚ç¤ºä¾‹\r\n\r\n```\r\nPOST /test2 HTTP/1.1\r\nHost: localhost\r\nContent-Type: multipart/form-data; boundary=123\r\nContent-Length: 125\r\n\r\n--123\r\nContent-Disposition: form-data; name=\"name\"\r\n\r\nlisi\r\n--123\r\nContent-Disposition: form-data; name=\"age\"\r\n\r\n30\r\n--123--\r\n```\r\n\r\n* boundary=123 ç”¨æ¥å®šä¹‰åˆ†éš”ç¬¦\r\n* èµ·å§‹åˆ†éš”ç¬¦æ˜¯ `--åˆ†éš”ç¬¦`\r\n* ç»“æŸåˆ†éš”ç¬¦æ˜¯ `--åˆ†éš”ç¬¦--`\r\n\r\n\r\n\r\n##### æ•°æ®æ ¼å¼å°ç»“\r\n\r\nå®¢æˆ·ç«¯å‘é€\r\n\r\n* ç¼–ç  \r\n  * application/x-www-form-urlencoded ï¼šurl ç¼–ç \r\n  * application/jsonï¼šutf-8 ç¼–ç \r\n  * multipart/form-dataï¼šæ¯éƒ¨åˆ†ç¼–ç å¯ä»¥ä¸åŒ\r\n* è¡¨å•åªæ”¯æŒä»¥ application/x-www-form-urlencoded å’Œ multipart/form-data æ ¼å¼å‘é€æ•°æ®\r\n* æ–‡ä»¶ä¸Šä¼ éœ€è¦ç”¨ multipart/form-data æ ¼å¼\r\n* js ä»£ç å¯ä»¥æ”¯æŒä»»æ„æ ¼å¼å‘é€æ•°æ® \r\n\r\næœåŠ¡ç«¯æ¥æ”¶\r\n\r\n* å¯¹ application/x-www-form-urlencoded å’Œ multipart/form-data æ ¼å¼çš„æ•°æ®ï¼ŒSpring æ¥æ”¶æ–¹å¼æ˜¯ç»Ÿä¸€çš„ï¼Œåªéœ€è¦ç”¨ java bean çš„å±æ€§åå¯¹åº”è¯·æ±‚å‚æ•°åå³å¯\r\n* å¯¹äº applicaiton/json æ ¼å¼çš„æ•°æ®ï¼ŒSpring æ¥æ”¶éœ€è¦ä½¿ç”¨ @RequestBody æ³¨è§£ + java bean çš„æ–¹å¼\r\n\r\n\r\n\r\n#### 3) session åŸç†\r\n\r\nHttp æ— çŠ¶æ€ï¼Œæœ‰ä¼šè¯\r\n\r\n* æ— çŠ¶æ€æ˜¯æŒ‡ï¼Œè¯·æ±‚ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ•°æ®ï¼Œç¬¬äºŒæ¬¡è¯·æ±‚ä¸èƒ½é‡ç”¨\r\n* æœ‰ä¼šè¯æ˜¯æŒ‡ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½æœ‰ç›¸åº”çš„æŠ€æœ¯ï¼Œå¯ä»¥æš‚å­˜æ•°æ®ï¼Œè®©æ•°æ®åœ¨è¯·æ±‚é—´å…±äº«\r\n\r\næœåŠ¡ç«¯ä½¿ç”¨äº† session æŠ€æœ¯æ¥æš‚å­˜æ•°æ®\r\n\r\nå­˜\r\n\r\n```\r\nGET /s1?name=zhang HTTP/1.1\r\nHost: localhost\r\n```\r\n\r\nå–\r\n\r\n```\r\nGET /s2 HTTP/1.1\r\nHost: localhost\r\nCookie: JSESSIONID=560FA845D02AE09B176E1BC5D9816A5D\r\n```\r\n\r\n\r\n\r\nsession æŠ€æœ¯å®ç°èº«ä»½éªŒè¯\r\n\r\n```mermaid\r\nsequenceDiagram\r\nparticipant Client\r\nparticipant L as LoginController\r\nparticipant i as LoginInterceptor\r\nparticipant Session\r\nrect rgb(200, 223, 255)\r\nClient ->> +L : ç™»å½•è¯·æ±‚\r\nL ->> L : æ£€æŸ¥ç”¨æˆ·åï¼Œå¯†ç ï¼ŒéªŒè¯é€šè¿‡\r\nL ->> +Session : å­˜å…¥ç”¨æˆ·å\r\nSession -->> -L: \r\nL -->> -Client: ç™»å½•æˆåŠŸ\r\nend\r\nrect rgb(200, 190, 255)\r\nClient ->> +i : å…¶å®ƒè¯·æ±‚\r\ni ->> +Session : è·å–ç”¨æˆ·å\r\nSession -->> -i : \r\ni ->> i: ç”¨æˆ·åå­˜åœ¨ï¼Œæ”¾è¡Œ\r\ni -->> -Client : \r\nend\r\n```\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n#### 4) jwt åŸç†\r\n\r\njwt æŠ€æœ¯å®ç°èº«ä»½éªŒè¯\r\n\r\n```mermaid\r\nsequenceDiagram\r\nparticipant Client\r\nparticipant L as LoginController\r\nparticipant i as LoginInterceptor\r\n\r\nrect rgb(200, 223, 255)\r\nClient ->> +L : ç™»å½•è¯·æ±‚\r\nL ->> L : æ£€æŸ¥ç”¨æˆ·åï¼Œå¯†ç ï¼ŒéªŒè¯é€šè¿‡\r\nL -->> -Client : ç™»å½•æˆåŠŸï¼Œè¿”å›token\r\nend\r\n\r\nrect rgb(150, 190, 155)\r\nClient ->> +i : å…¶å®ƒè¯·æ±‚ï¼Œæºå¸¦token\r\ni ->> i : æ ¡éªŒtokenï¼Œæ ¡éªŒæ— è¯¯ï¼Œæ”¾è¡Œ\r\ni -->> -Client : \r\nend\r\n```\r\n\r\nç”Ÿæˆ token\r\n\r\n```\r\nGET /j1?name=zhang&pass=123 HTTP/1.1\r\nHost: localhost\r\n```\r\n\r\næ ¡éªŒ token\r\n\r\n```\r\nGET /j2 HTTP/1.1\r\nHost: localhost\r\nAuthorization: eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiJ9._1-P_TLlzQPb1_lCyGwplMZaKQ8Mcw_plBbYPZ3OX28\r\n```\r\n\r\n\r\n\r\n### 5. CSS\r\n\r\nå³ Cascading  Style  Sheetsï¼Œå®ƒæè¿°äº†ç½‘é¡µçš„è¡¨ç°ä¸å±•ç¤ºæ•ˆæœ\r\n\r\n#### 1) é€‰æ‹©å™¨\r\n\r\n* type é€‰æ‹©å™¨ - æ ¹æ®æ ‡ç­¾åè¿›è¡ŒåŒ¹é…ï¼ˆå…ƒç´ é€‰æ‹©å™¨ï¼‰\r\n* class é€‰æ‹©å™¨ - æ ¹æ®å…ƒç´ çš„ class å±æ€§è¿›è¡ŒåŒ¹é…\r\n\r\n* id é€‰æ‹©å™¨  - æ ¹æ®å…ƒç´ çš„ id å±æ€§è¿›è¡ŒåŒ¹é…\r\n\r\n#### 2) å±æ€§å’Œå€¼\r\n\r\n* background-color : red;\r\n* ...\r\n* display\r\n\r\n#### 3) å¸ƒå±€\r\n\r\nä¸å¸ƒå±€ç›¸å…³çš„ html å…ƒç´ \r\n\r\n* div\r\n* template"},{"title":"æ¥å£å¹‚ç­‰æ€§","tags":["Spring Boot","token","Redis"],"categories":["Java","æœªåˆ†ç±»"],"author":"imklaus","excerpt":"\r\n\r\n\r\n## ä¸€ã€å¹‚ç­‰æ€§çš„æ„ä¹‰\r\n\r\n### **1ã€ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§**\r\n\r\n- çœ‹ä¸€ä¸‹ç»´åŸºç™¾ç§‘æ€ä¹ˆè¯´çš„ï¼š\r\n\r\n![image-20230429205227388](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429205227388.png)\r\n\r\n- **æ¥å£å¹‚ç­‰æ€§å°±æ˜¯ç”¨æˆ·å¯¹äºåŒä¸€æ“ä½œå‘èµ·çš„ä¸€æ¬¡è¯·æ±‚æˆ–è€…å¤šæ¬¡è¯·æ±‚çš„ç»“æœæ˜¯ä¸€è‡´çš„**ï¼Œä¸ä¼šå› ä¸ºå¤šæ¬¡ç‚¹å‡»è€Œäº§ç”Ÿäº†å‰¯ä½œç”¨ï¼›æ¯”å¦‚è¯´æ”¯ä»˜åœºæ™¯ï¼Œç”¨æˆ·è´­ä¹°äº†å•†å“æ”¯ä»˜æ‰£æ¬¾æˆåŠŸï¼Œä½†æ˜¯è¿”å›ç»“æœçš„æ—¶å€™ç½‘ç»œå¼‚å¸¸ï¼Œæ­¤æ—¶é’±å·²ç»æ‰£äº†ï¼Œç”¨æˆ·å†æ¬¡ç‚¹å‡»æŒ‰é’®ï¼Œæ­¤æ—¶ä¼šè¿›è¡Œç¬¬äºŒæ¬¡æ‰£æ¬¾ï¼Œè¿”å›ç»“æœæˆåŠŸï¼Œç”¨æˆ·æŸ¥è¯¢ä½™é¢è¿”å‘ç°å¤šæ‰£é’±äº†ï¼Œæµæ°´è®°å½•ä¹Ÿå˜æˆäº†ä¸¤æ¡......ï¼Œè¿™å°±æ²¡æœ‰ä¿è¯æ¥å£çš„å¹‚ç­‰æ€§ã€‚\r\n","link":"/posts/Idempotence_of_interfaces","content":"\r\n\r\n\r\n## ä¸€ã€å¹‚ç­‰æ€§çš„æ„ä¹‰\r\n\r\n### **1ã€ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§**\r\n\r\n- çœ‹ä¸€ä¸‹ç»´åŸºç™¾ç§‘æ€ä¹ˆè¯´çš„ï¼š\r\n\r\n![image-20230429205227388](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429205227388.png)\r\n\r\n- **æ¥å£å¹‚ç­‰æ€§å°±æ˜¯ç”¨æˆ·å¯¹äºåŒä¸€æ“ä½œå‘èµ·çš„ä¸€æ¬¡è¯·æ±‚æˆ–è€…å¤šæ¬¡è¯·æ±‚çš„ç»“æœæ˜¯ä¸€è‡´çš„**ï¼Œä¸ä¼šå› ä¸ºå¤šæ¬¡ç‚¹å‡»è€Œäº§ç”Ÿäº†å‰¯ä½œç”¨ï¼›æ¯”å¦‚è¯´æ”¯ä»˜åœºæ™¯ï¼Œç”¨æˆ·è´­ä¹°äº†å•†å“æ”¯ä»˜æ‰£æ¬¾æˆåŠŸï¼Œä½†æ˜¯è¿”å›ç»“æœçš„æ—¶å€™ç½‘ç»œå¼‚å¸¸ï¼Œæ­¤æ—¶é’±å·²ç»æ‰£äº†ï¼Œç”¨æˆ·å†æ¬¡ç‚¹å‡»æŒ‰é’®ï¼Œæ­¤æ—¶ä¼šè¿›è¡Œç¬¬äºŒæ¬¡æ‰£æ¬¾ï¼Œè¿”å›ç»“æœæˆåŠŸï¼Œç”¨æˆ·æŸ¥è¯¢ä½™é¢è¿”å‘ç°å¤šæ‰£é’±äº†ï¼Œæµæ°´è®°å½•ä¹Ÿå˜æˆäº†ä¸¤æ¡......ï¼Œè¿™å°±æ²¡æœ‰ä¿è¯æ¥å£çš„å¹‚ç­‰æ€§ã€‚\r\n<!-- more -->\r\n\r\n> - å¹‚ç­‰æ˜¯ä¸€ä¸ªæ•°å­¦ä¸è®¡ç®—æœºå­¦æ¦‚å¿µï¼Œåœ¨æ•°å­¦ä¸­æŸä¸€å…ƒè¿ç®—ä¸ºå¹‚ç­‰æ—¶ï¼Œå…¶ä½œç”¨åœ¨ä»»ä¸€å…ƒç´ ä¸¤æ¬¡åä¼šå’Œå…¶ä½œç”¨ä¸€æ¬¡çš„ç»“æœç›¸åŒã€‚\r\n> - åœ¨è®¡ç®—æœºä¸­ç¼–ç¨‹ä¸­ï¼Œä¸€ä¸ªå¹‚ç­‰æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚å¹‚ç­‰å‡½æ•°æˆ–å¹‚ç­‰æ–¹æ³•æ˜¯æŒ‡å¯ä»¥ä½¿ç”¨ç›¸åŒå‚æ•°é‡å¤æ‰§è¡Œï¼Œå¹¶èƒ½è·å¾—ç›¸åŒç»“æœçš„å‡½æ•°ã€‚è¿™äº›å‡½æ•°ä¸ä¼šå½±å“ç³»ç»ŸçŠ¶æ€ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒé‡å¤æ‰§è¡Œä¼šå¯¹ç³»ç»Ÿé€ æˆæ”¹å˜ã€‚\r\n\r\n### **2ã€ä»€ä¹ˆæ˜¯æ¥å£å¹‚ç­‰æ€§**\r\n\r\n- åœ¨HTTP/1.1ä¸­ï¼Œå¯¹å¹‚ç­‰æ€§è¿›è¡Œäº†å®šä¹‰ã€‚å®ƒæè¿°äº†ä¸€æ¬¡å’Œå¤šæ¬¡è¯·æ±‚æŸä¸€ä¸ªèµ„æºå¯¹äºèµ„æºæœ¬èº«åº”è¯¥å…·æœ‰åŒæ ·çš„ç»“æœï¼ˆç½‘ç»œè¶…æ—¶ç­‰é—®é¢˜é™¤å¤–ï¼‰ï¼Œå³ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™å¯¹èµ„æºäº§ç”Ÿäº†å‰¯ä½œç”¨ï¼Œä½†æ˜¯ä»¥åçš„å¤šæ¬¡è¯·æ±‚éƒ½ä¸ä¼šå†å¯¹èµ„æºäº§ç”Ÿå‰¯ä½œç”¨ã€‚\r\n- è¿™é‡Œçš„å‰¯ä½œç”¨æ˜¯ä¸ä¼šå¯¹ç»“æœäº§ç”Ÿç ´åæˆ–è€…äº§ç”Ÿä¸å¯é¢„æ–™çš„ç»“æœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œå¯¹èµ„æºæœ¬èº«æ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚\r\n\r\n\r\n\r\n### **3ã€ä¸ºä»€ä¹ˆéœ€è¦å®ç°å¹‚ç­‰æ€§**\r\n\r\nåœ¨æ¥å£è°ƒç”¨æ—¶ä¸€èˆ¬æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸è¿”å›ä¿¡æ¯ä¸ä¼šé‡å¤æäº¤ï¼Œä¸è¿‡åœ¨é‡è§ä»¥ä¸‹æƒ…å†µæ—¶å¯ä»¥å°±ä¼šå‡ºç°é—®é¢˜ï¼Œå¦‚ï¼š\r\n\r\n1. **å‰ç«¯é‡å¤æäº¤è¡¨å•ï¼š** åœ¨å¡«å†™ä¸€äº›è¡¨æ ¼æ—¶å€™ï¼Œç”¨æˆ·å¡«å†™å®Œæˆæäº¤ï¼Œå¾ˆå¤šæ—¶å€™ä¼šå› ç½‘ç»œæ³¢åŠ¨æ²¡æœ‰åŠæ—¶å¯¹ç”¨æˆ·åšå‡ºæäº¤æˆåŠŸå“åº”ï¼Œè‡´ä½¿ç”¨æˆ·è®¤ä¸ºæ²¡æœ‰æˆåŠŸæäº¤ï¼Œç„¶åä¸€ç›´ç‚¹æäº¤æŒ‰é’®ï¼Œè¿™æ—¶å°±ä¼šå‘ç”Ÿé‡å¤æäº¤è¡¨å•è¯·æ±‚ã€‚\r\n2. **ç”¨æˆ·æ¶æ„è¿›è¡Œåˆ·å•ï¼š** ä¾‹å¦‚åœ¨å®ç°ç”¨æˆ·æŠ•ç¥¨è¿™ç§åŠŸèƒ½æ—¶ï¼Œå¦‚æœç”¨æˆ·é’ˆå¯¹ä¸€ä¸ªç”¨æˆ·è¿›è¡Œé‡å¤æäº¤æŠ•ç¥¨ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ¥å£æ¥æ”¶åˆ°ç”¨æˆ·é‡å¤æäº¤çš„æŠ•ç¥¨ä¿¡æ¯ï¼Œè¿™æ ·ä¼šä½¿æŠ•ç¥¨ç»“æœä¸äº‹å®ä¸¥é‡ä¸ç¬¦ã€‚\r\n3. **æ¥å£è¶…æ—¶é‡å¤æäº¤ï¼š** å¾ˆå¤šæ—¶å€™ HTTP å®¢æˆ·ç«¯å·¥å…·éƒ½é»˜è®¤å¼€å¯è¶…æ—¶é‡è¯•çš„æœºåˆ¶ï¼Œå°¤å…¶æ˜¯ç¬¬ä¸‰æ–¹è°ƒç”¨æ¥å£æ—¶å€™ï¼Œä¸ºäº†é˜²æ­¢ç½‘ç»œæ³¢åŠ¨è¶…æ—¶ç­‰é€ æˆçš„è¯·æ±‚å¤±è´¥ï¼Œéƒ½ä¼šæ·»åŠ é‡è¯•æœºåˆ¶ï¼Œå¯¼è‡´ä¸€ä¸ªè¯·æ±‚æäº¤å¤šæ¬¡ã€‚\r\n4. **æ¶ˆæ¯è¿›è¡Œé‡å¤æ¶ˆè´¹ï¼š** å½“ä½¿ç”¨ MQ æ¶ˆæ¯ä¸­é—´ä»¶æ—¶å€™ï¼Œå¦‚æœå‘ç”Ÿæ¶ˆæ¯ä¸­é—´ä»¶å‡ºç°é”™è¯¯æœªåŠæ—¶æäº¤æ¶ˆè´¹ä¿¡æ¯ï¼Œå¯¼è‡´å‘ç”Ÿé‡å¤æ¶ˆè´¹ã€‚\r\n\r\n> ä½¿ç”¨å¹‚ç­‰æ€§æœ€å¤§çš„ä¼˜åŠ¿åœ¨äºä½¿æ¥å£ä¿è¯ä»»ä½•å¹‚ç­‰æ€§æ“ä½œï¼Œå…å»å› é‡è¯•ç­‰é€ æˆç³»ç»Ÿäº§ç”Ÿçš„æœªçŸ¥çš„é—®é¢˜ã€‚\r\n\r\n\r\n\r\n### **4ã€å¼•å…¥å¹‚ç­‰æ€§åå¯¹ç³»ç»Ÿçš„å½±å“**\r\n\r\nå¹‚ç­‰æ€§æ˜¯ä¸ºäº†ç®€åŒ–å®¢æˆ·ç«¯é€»è¾‘å¤„ç†ï¼Œèƒ½æ”¾ç½®é‡å¤æäº¤ç­‰æ“ä½œï¼Œä½†å´å¢åŠ äº†æœåŠ¡ç«¯çš„é€»è¾‘å¤æ‚æ€§å’Œæˆæœ¬ï¼Œå…¶ä¸»è¦æ˜¯ï¼š\r\n\r\n1. æŠŠå¹¶è¡Œæ‰§è¡Œçš„åŠŸèƒ½æ”¹ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œé™ä½äº†æ‰§è¡Œæ•ˆç‡ã€‚\r\n2. å¢åŠ äº†é¢å¤–æ§åˆ¶å¹‚ç­‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¤æ‚åŒ–äº†ä¸šåŠ¡åŠŸèƒ½ï¼›\r\n\r\n> æ‰€ä»¥åœ¨ä½¿ç”¨æ—¶å€™éœ€è¦è€ƒè™‘æ˜¯å¦å¼•å…¥å¹‚ç­‰æ€§çš„å¿…è¦æ€§ï¼Œæ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯å…·ä½“åˆ†æï¼Œé™¤äº†ä¸šåŠ¡ä¸Šçš„ç‰¹æ®Šè¦æ±‚å¤–ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦å¼•å…¥çš„æ¥å£å¹‚ç­‰æ€§ã€‚\r\n\r\n\r\n\r\n## äºŒã€Restful API æ¥å£çš„å¹‚ç­‰æ€§\r\n\r\nç°åœ¨æµè¡Œçš„ Restful æ¨èçš„å‡ ç§ HTTP æ¥å£æ–¹æ³•ä¸­ï¼Œåˆ†åˆ«å­˜åœ¨å¹‚ç­‰è¡Œä¸ä¸èƒ½ä¿è¯å¹‚ç­‰çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n1. âˆš æ»¡è¶³å¹‚ç­‰\r\n2. x ä¸æ»¡è¶³å¹‚ç­‰\r\n3. \\- å¯èƒ½æ»¡è¶³ä¹Ÿå¯èƒ½ä¸æ»¡è¶³å¹‚ç­‰ï¼Œæ ¹æ®å®é™…ä¸šåŠ¡é€»è¾‘æœ‰å…³\r\n\r\n> Get\r\n>\r\n> âˆš\r\n>\r\n> Get æ–¹æ³•ç”¨äºè·å–èµ„æºã€‚å…¶ä¸€èˆ¬ä¸ä¼šä¹Ÿä¸åº”å½“å¯¹ç³»ç»Ÿèµ„æºè¿›è¡Œæ”¹å˜ï¼Œæ‰€ä»¥æ˜¯å¹‚ç­‰çš„ã€‚\r\n\r\n> Post\r\n>\r\n> Ã—\r\n>\r\n> Post æ–¹æ³•ä¸€èˆ¬ç”¨äºåˆ›å»ºæ–°çš„èµ„æºã€‚å…¶æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šæ–°å¢æ•°æ®ï¼Œæ‰€ä»¥ä¸æ˜¯å¹‚ç­‰çš„ã€‚\r\n\r\n> Put\r\n>\r\n> \\-\r\n>\r\n> Put æ–¹æ³•ä¸€èˆ¬ç”¨äºä¿®æ”¹èµ„æºã€‚è¯¥æ“ä½œåˆ™åˆ†æƒ…å†µæ¥åˆ¤æ–­æ˜¯ä¸æ˜¯æ»¡è¶³å¹‚ç­‰ï¼Œæ›´æ–°æ“ä½œä¸­ç›´æ¥æ ¹æ®æŸä¸ªå€¼è¿›è¡Œæ›´æ–°ï¼Œä¹Ÿèƒ½ä¿æŒå¹‚ç­‰ã€‚ä¸è¿‡æ‰§è¡Œç´¯åŠ æ“ä½œçš„æ›´æ–°æ˜¯éå¹‚ç­‰ã€‚\r\n\r\n> Delete\r\n>\r\n> \\-\r\n>\r\n> Delete æ–¹æ³•ä¸€èˆ¬ç”¨äºåˆ é™¤èµ„æºã€‚è¯¥æ“ä½œåˆ™åˆ†æƒ…å†µæ¥åˆ¤æ–­æ˜¯ä¸æ˜¯æ»¡è¶³å¹‚ç­‰ï¼Œå½“æ ¹æ®å”¯ä¸€å€¼è¿›è¡Œåˆ é™¤æ—¶ï¼Œåˆ é™¤åŒä¸€ä¸ªæ•°æ®å¤šæ¬¡æ‰§è¡Œæ•ˆæœä¸€æ ·ã€‚ä¸è¿‡éœ€è¦æ³¨æ„ï¼Œå¸¦æŸ¥è¯¢æ¡ä»¶çš„åˆ é™¤åˆ™å°±ä¸ä¸€å®šæ»¡è¶³å¹‚ç­‰äº†ã€‚ä¾‹å¦‚åœ¨æ ¹æ®æ¡ä»¶åˆ é™¤ä¸€æ‰¹æ•°æ®åï¼Œè¿™æ—¶å€™æ–°å¢åŠ äº†ä¸€æ¡æ•°æ®ä¹Ÿæ»¡è¶³æ¡ä»¶ï¼Œç„¶ååˆæ‰§è¡Œäº†ä¸€æ¬¡åˆ é™¤ï¼Œé‚£ä¹ˆå°†ä¼šå¯¼è‡´æ–°å¢åŠ çš„è¿™æ¡æ»¡è¶³æ¡ä»¶æ•°æ®ä¹Ÿè¢«åˆ é™¤ã€‚\r\n\r\n\r\n\r\n## ä¸‰ã€å“ªäº›æƒ…å†µéœ€è¦é˜²æ­¢\r\n\r\n- ç”¨æˆ·å¤šæ¬¡ç‚¹å‡»æŒ‰é’®\r\n- ç”¨æˆ·é¡µé¢å›é€€å†æ¬¡æäº¤\r\n- å¾®æœåŠ¡äº’ç›¸è°ƒç”¨ï¼Œç”±äºç½‘ç»œé—®é¢˜ï¼Œå¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚feign è§¦å‘é‡è¯•æœºåˆ¶å…¶ä»–ä¸šåŠ¡æƒ…å†µ\r\n\r\n### 1ã€å‰ç«¯é‡å¤æäº¤ \r\n\r\n- ç”¨æˆ·æ³¨å†Œï¼Œç”¨æˆ·åˆ›å»ºå•†å“ç­‰æ“ä½œï¼Œå‰ç«¯éƒ½ä¼šæäº¤ä¸€äº›æ•°æ®ç»™åå°æœåŠ¡ï¼Œåå°éœ€è¦æ ¹æ®ç”¨æˆ·æäº¤çš„æ•°æ®åœ¨æ•°æ®åº“ä¸­åˆ›å»ºè®°å½•ã€‚å¦‚æœç”¨æˆ·ä¸å°å¿ƒå¤šç‚¹äº†å‡ æ¬¡ï¼Œåç«¯æ”¶åˆ°äº†å¥½å‡ æ¬¡æäº¤ï¼Œè¿™æ—¶å°±ä¼šåœ¨æ•°æ®åº“ä¸­é‡å¤åˆ›å»ºäº†å¤šæ¡è®°å½•ã€‚è¿™å°±æ˜¯æ¥å£æ²¡æœ‰å¹‚ç­‰æ€§å¸¦æ¥çš„ bugã€‚\r\n\r\n\r\n\r\n### 2ã€æ¥å£è¶…æ—¶é‡è¯• \r\n\r\n- å¯¹äºç»™ç¬¬ä¸‰æ–¹è°ƒç”¨çš„æ¥å£ï¼Œæœ‰å¯èƒ½ä¼šå› ä¸ºç½‘ç»œåŸå› è€Œè°ƒç”¨å¤±è´¥ï¼Œè¿™æ—¶ï¼Œä¸€èˆ¬åœ¨è®¾è®¡çš„æ—¶å€™ä¼šå¯¹æ¥å£è°ƒç”¨åŠ ä¸Šå¤±è´¥é‡è¯•çš„æœºåˆ¶ã€‚å¦‚æœç¬¬ä¸€æ¬¡è°ƒç”¨å·²ç»æ‰§è¡Œäº†ä¸€åŠæ—¶ï¼Œå‘ç”Ÿäº†ç½‘ç»œå¼‚å¸¸ã€‚è¿™æ—¶å†æ¬¡è°ƒç”¨æ—¶å°±ä¼šå› ä¸ºè„æ•°æ®çš„å­˜åœ¨è€Œå‡ºç°è°ƒç”¨å¼‚å¸¸ã€‚\r\n\r\n\r\n\r\n### 3ã€æ¶ˆæ¯é‡å¤æ¶ˆè´¹ \r\n\r\n- åœ¨ä½¿ç”¨æ¶ˆæ¯ä¸­é—´ä»¶æ¥å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸”æ‰‹åŠ¨ ack ç¡®è®¤æ¶ˆæ¯è¢«æ­£å¸¸æ¶ˆè´¹æ—¶ã€‚å¦‚æœæ¶ˆè´¹è€…çªç„¶æ–­å¼€è¿æ¥ï¼Œé‚£ä¹ˆå·²ç»æ‰§è¡Œäº†ä¸€åŠçš„æ¶ˆæ¯ä¼šé‡æ–°æ”¾å›é˜Ÿåˆ—ã€‚\r\n- å½“æ¶ˆæ¯è¢«å…¶ä»–æ¶ˆè´¹è€…é‡æ–°æ¶ˆè´¹æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¹‚ç­‰æ€§ï¼Œå°±ä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹æ—¶ç»“æœå¼‚å¸¸ï¼Œå¦‚æ•°æ®åº“é‡å¤æ•°æ®ï¼Œæ•°æ®åº“æ•°æ®å†²çªï¼Œèµ„æºé‡å¤ç­‰ã€‚\r\n\r\n\r\n\r\n## å››ã€ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å¹‚ç­‰\r\n\r\nä»¥ SQL ä¸ºä¾‹ï¼Œæœ‰äº›æ“ä½œæ˜¯å¤©ç„¶å¹‚ç­‰çš„ã€‚\r\n\r\n- `SELECT * FROM table WHER id=?`ï¼Œæ— è®ºæ‰§è¡Œå¤šå°‘æ¬¡éƒ½ä¸ä¼šæ”¹å˜çŠ¶æ€ï¼Œæ˜¯å¤©ç„¶çš„å¹‚ç­‰ã€‚\r\n\r\n- `UPDATE tab1 SET col1=1 WHERE col2=2`ï¼Œæ— è®ºæ‰§è¡ŒæˆåŠŸå¤šå°‘æ¬¡çŠ¶æ€éƒ½æ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿæ˜¯å¹‚ç­‰æ“ä½œã€‚\r\n- `delete from user where userid=1`ï¼Œå¤šæ¬¡æ“ä½œï¼Œç»“æœä¸€æ ·ï¼Œå…·å¤‡å¹‚ç­‰æ€§\r\n- `insert into user(userid,name) values(1,'a')` å¦‚ userid ä¸ºå”¯ä¸€ä¸»é”®ï¼Œå³é‡å¤æ“ä½œä¸Šé¢çš„ä¸šåŠ¡ï¼Œåªä¼šæ’å…¥ä¸€æ¡ç”¨æˆ·æ•°æ®ï¼Œå…·å¤‡å¹‚ç­‰æ€§ã€‚\r\n\r\n------\r\n\r\n- `UPDATE tab1 SET col1=col1+1 WHERE col2=2`ï¼Œæ¯æ¬¡æ‰§è¡Œçš„ç»“æœéƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¸æ˜¯å¹‚ç­‰çš„ã€‚\r\n- `insert into user(userid,name) values(1,'a')` å¦‚ userid ä¸æ˜¯ä¸»é”®ï¼Œå¯ä»¥é‡å¤ï¼Œé‚£ä¸Šé¢ä¸šåŠ¡å¤šæ¬¡æ“ä½œï¼Œæ•°æ®éƒ½ä¼šæ–°å¢å¤šæ¡ï¼Œä¸å…·å¤‡å¹‚ç­‰æ€§ã€‚\r\n\r\n\r\n\r\n## äº”ã€å¹‚ç­‰è§£å†³æ–¹æ¡ˆ\r\n\r\n### **1ã€token æœºåˆ¶**\r\n\r\n- 1ã€æœåŠ¡ç«¯æä¾›äº†å‘é€ token çš„æ¥å£ã€‚æˆ‘ä»¬åœ¨åˆ†æä¸šåŠ¡çš„æ—¶å€™ï¼Œå“ªäº›ä¸šåŠ¡æ˜¯å­˜åœ¨å¹‚ç­‰é—®é¢˜çš„ï¼Œå°±å¿…é¡»åœ¨æ‰§è¡Œä¸šåŠ¡å‰ï¼Œå…ˆå»è·å– tokenï¼ŒæœåŠ¡å™¨ä¼šæŠŠ token ä¿å­˜åˆ° redis ä¸­ã€‚\r\n\r\n- 2ã€ç„¶åè°ƒç”¨ä¸šåŠ¡æ¥å£è¯·æ±‚æ—¶ï¼ŒæŠŠ token æºå¸¦è¿‡å»ï¼Œä¸€èˆ¬æ”¾åœ¨è¯·æ±‚å¤´éƒ¨ã€‚\r\n\r\n- 3ã€æœåŠ¡å™¨åˆ¤æ–­ token æ˜¯å¦å­˜åœ¨ redis ä¸­ï¼Œå­˜åœ¨è¡¨ç¤ºç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œç„¶ååˆ é™¤ token,ç»§ç»­æ‰§è¡Œä¸šåŠ¡ã€‚\r\n\r\n- 4ã€å¦‚æœåˆ¤æ–­ token ä¸å­˜åœ¨ redis ä¸­ï¼Œå°±è¡¨ç¤ºæ˜¯é‡å¤æ“ä½œï¼Œç›´æ¥è¿”å›é‡å¤æ ‡è®°ç»™ clientï¼Œè¿™æ ·å°±ä¿è¯äº†ä¸šåŠ¡ä»£ç ï¼Œä¸è¢«é‡å¤æ‰§è¡Œã€‚\r\n\r\n- å±é™©æ€§ï¼š\r\n\r\n  - 1ã€å…ˆåˆ é™¤ token è¿˜æ˜¯ååˆ é™¤ tokenï¼›\r\n\r\n    - (1)ã€å…ˆåˆ é™¤å¯èƒ½å¯¼è‡´ï¼Œä¸šåŠ¡ç¡®å®æ²¡æœ‰æ‰§è¡Œï¼Œé‡è¯•è¿˜å¸¦ä¸Šä¹‹å‰ tokenï¼Œç”±äºé˜²é‡è®¾è®¡å¯¼è‡´ï¼Œè¯·æ±‚è¿˜æ˜¯ä¸èƒ½æ‰§è¡Œã€‚\r\n    - (2)ã€ååˆ é™¤å¯èƒ½å¯¼è‡´ï¼Œä¸šåŠ¡å¤„ç†æˆåŠŸï¼Œä½†æ˜¯æœåŠ¡é—ªæ–­ï¼Œå‡ºç°è¶…æ—¶ï¼Œæ²¡æœ‰åˆ é™¤ tokenï¼Œåˆ«äººç»§ç»­é‡è¯•ï¼Œå¯¼è‡´ä¸šåŠ¡è¢«æ‰§è¡Œä¸¤è¾¹\r\n    - (3)ã€æˆ‘ä»¬æœ€å¥½è®¾è®¡ä¸ºå…ˆåˆ é™¤ tokenï¼Œå¦‚æœä¸šåŠ¡è°ƒç”¨å¤±è´¥ï¼Œå°±é‡æ–°è·å– token å†æ¬¡è¯·æ±‚ã€‚\r\n\r\n  - 2ã€Token è·å–ã€æ¯”è¾ƒå’Œåˆ é™¤å¿…é¡»æ˜¯åŸå­æ€§\r\n\r\n    - (1)ã€redis.get(token) ã€token.equalsã€redis.del(token)å¦‚æœè¿™ä¸¤ä¸ªæ“ä½œä¸æ˜¯åŸå­ï¼Œå¯èƒ½å¯¼è‡´ï¼Œé«˜å¹¶å‘ä¸‹ï¼Œéƒ½ get åˆ°åŒæ ·çš„æ•°æ®ï¼Œåˆ¤æ–­éƒ½æˆåŠŸï¼Œç»§ç»­ä¸šåŠ¡å¹¶å‘æ‰§è¡Œ\r\n    - (2)ã€å¯ä»¥åœ¨ redis ä½¿ç”¨ lua è„šæœ¬å®Œæˆè¿™ä¸ªæ“ä½œ\r\n\r\n    ```shell\r\n    if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\r\n    ```\r\n\r\n\r\n\r\n\r\n> - é€šè¿‡token æœºåˆ¶å®ç°æ¥å£çš„å¹‚ç­‰æ€§,è¿™æ˜¯ä¸€ç§æ¯”è¾ƒé€šç”¨æ€§çš„å®ç°æ–¹æ³•ã€‚\r\n>\r\n> - ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\r\n>\r\n> ![image-20230429171130711](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429171130711.png)\r\n>\r\n> \r\n>\r\n> - å…·ä½“æµç¨‹æ­¥éª¤ï¼š\r\n>\r\n>   - 1å®¢æˆ·ç«¯ä¼šå…ˆå‘é€ä¸€ä¸ªè¯·æ±‚å»è·å– tokenï¼ŒæœåŠ¡ç«¯ä¼šç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ ID ä½œä¸º token ä¿å­˜åœ¨ redis ä¸­ï¼ŒåŒæ—¶æŠŠè¿™ä¸ª ID è¿”å›ç»™å®¢æˆ·ç«¯\r\n>\r\n>   - 2å®¢æˆ·ç«¯ç¬¬äºŒæ¬¡è°ƒç”¨ä¸šåŠ¡è¯·æ±‚çš„æ—¶å€™å¿…é¡»æºå¸¦è¿™ä¸ª token\r\n>\r\n>   - 3æœåŠ¡ç«¯ä¼šæ ¡éªŒè¿™ä¸ª tokenï¼Œå¦‚æœæ ¡éªŒæˆåŠŸï¼Œåˆ™æ‰§è¡Œä¸šåŠ¡ï¼Œå¹¶åˆ é™¤ redis ä¸­çš„ token\r\n>\r\n>   - 4å¦‚æœæ ¡éªŒå¤±è´¥ï¼Œè¯´æ˜ redis ä¸­å·²ç»æ²¡æœ‰å¯¹åº”çš„ tokenï¼Œåˆ™è¡¨ç¤ºé‡å¤æ“ä½œï¼Œç›´æ¥è¿”å›æŒ‡å®šçš„ç»“æœç»™å®¢æˆ·ç«¯\r\n>\r\n> - æ³¨æ„ï¼š\r\n>\r\n>   - 1å¯¹ redis ä¸­æ˜¯å¦å­˜åœ¨ token ä»¥åŠåˆ é™¤çš„ä»£ç é€»è¾‘å»ºè®®ç”¨ Lua è„šæœ¬å®ç°ï¼Œä¿è¯åŸå­æ€§\r\n>\r\n>   - 2å…¨å±€å”¯ä¸€ ID å¯ä»¥ç”¨ç™¾åº¦çš„ uid-generatorã€ç¾å›¢çš„ Leaf å»ç”Ÿæˆ\r\n\r\n\r\n\r\n### **2ã€å„ç§é”æœºåˆ¶**\r\n\r\n#### **1ï¼‰ã€æ•°æ®åº“æ‚²è§‚é”**\r\n\r\n`select * from xxxx where id = 1 for update;`\r\næ‚²è§‚é”ä½¿ç”¨æ—¶ä¸€èˆ¬ä¼´éšäº‹åŠ¡ä¸€èµ·ä½¿ç”¨ï¼Œæ•°æ®é”å®šæ—¶é—´å¯èƒ½ä¼šå¾ˆé•¿ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µé€‰ç”¨ã€‚\r\nå¦å¤–è¦æ³¨æ„çš„æ˜¯ï¼Œid å­—æ®µä¸€å®šæ˜¯ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•ï¼Œä¸ç„¶å¯èƒ½é€ æˆé”è¡¨çš„ç»“æœï¼Œå¤„ç†èµ·æ¥ä¼š\r\néå¸¸éº»çƒ¦ã€‚\r\n\r\n\r\n\r\n#### **2ï¼‰ã€æ•°æ®åº“ä¹è§‚é”**\r\n\r\nè¿™ç§æ–¹æ³•é€‚åˆåœ¨æ›´æ–°çš„åœºæ™¯ä¸­ï¼š\r\n\r\n`update t_goods set count = count -1 , version = version + 1 where good_id=2 and version = 1`\r\n\r\n- æ ¹æ® version ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯åœ¨æ“ä½œåº“å­˜å‰å…ˆè·å–å½“å‰å•†å“çš„ version ç‰ˆæœ¬å·ï¼Œç„¶åæ“ä½œçš„æ—¶å€™å¸¦ä¸Šæ­¤ version å·ã€‚æˆ‘ä»¬æ¢³ç†ä¸‹ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡æ“ä½œåº“å­˜æ—¶ï¼Œå¾—åˆ° version ä¸º 1ï¼Œè°ƒç”¨åº“å­˜æœåŠ¡version å˜æˆäº† 2ï¼›ä½†è¿”å›ç»™è®¢å•æœåŠ¡å‡ºç°äº†é—®é¢˜ï¼Œè®¢å•æœåŠ¡åˆä¸€æ¬¡å‘èµ·è°ƒç”¨åº“å­˜æœåŠ¡ï¼Œå½“è®¢å•æœåŠ¡ä¼ å¦‚çš„ version è¿˜æ˜¯ 1ï¼Œå†æ‰§è¡Œä¸Šé¢çš„ sql è¯­å¥æ—¶ï¼Œå°±ä¸ä¼šæ‰§è¡Œï¼›å› ä¸º version å·²ç»å˜ä¸º 2 äº†ï¼Œwhere æ¡ä»¶å°±ä¸æˆç«‹ã€‚è¿™æ ·å°±ä¿è¯äº†ä¸ç®¡è°ƒç”¨å‡ æ¬¡ï¼Œåªä¼šçœŸæ­£çš„å¤„ç†ä¸€æ¬¡ã€‚\r\n- ä¹è§‚é”ä¸»è¦ä½¿ç”¨äºå¤„ç†è¯»å¤šå†™å°‘çš„é—®é¢˜\r\n\r\n\r\n\r\n#### **3ï¼‰ã€ä¸šåŠ¡å±‚åˆ†å¸ƒå¼é”**\r\n\r\nå¦‚æœå¤šä¸ªæœºå™¨å¯èƒ½åœ¨åŒä¸€æ—¶é—´åŒæ—¶å¤„ç†ç›¸åŒçš„æ•°æ®ï¼Œæ¯”å¦‚å¤šå°æœºå™¨å®šæ—¶ä»»åŠ¡éƒ½æ‹¿åˆ°äº†ç›¸åŒæ•°\r\næ®å¤„ç†ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŠ åˆ†å¸ƒå¼é”ï¼Œé”å®šæ­¤æ•°æ®ï¼Œå¤„ç†å®Œæˆåé‡Šæ”¾é”ã€‚è·å–åˆ°é”çš„å¿…é¡»å…ˆåˆ¤æ–­\r\nè¿™ä¸ªæ•°æ®æ˜¯å¦è¢«å¤„ç†è¿‡ã€‚\r\n\r\n\r\n\r\n### **3ã€å„ç§å”¯ä¸€çº¦æŸ**\r\n\r\n#### **1ï¼‰ã€æ•°æ®åº“å”¯ä¸€çº¦æŸ**\r\n\r\n- æ’å…¥æ•°æ®ï¼Œåº”è¯¥æŒ‰ç…§å”¯ä¸€ç´¢å¼•è¿›è¡Œæ’å…¥ï¼Œæ¯”å¦‚è®¢å•å·ï¼Œç›¸åŒçš„è®¢å•å°±ä¸å¯èƒ½æœ‰ä¸¤æ¡è®°å½•æ’å…¥ã€‚æˆ‘ä»¬åœ¨æ•°æ®åº“å±‚é¢é˜²æ­¢é‡å¤ã€‚\r\n- è¿™ä¸ªæœºåˆ¶æ˜¯åˆ©ç”¨äº†æ•°æ®åº“çš„ä¸»é”®å”¯ä¸€çº¦æŸçš„ç‰¹æ€§ï¼Œè§£å†³äº†åœ¨ insert åœºæ™¯æ—¶å¹‚ç­‰é—®é¢˜ã€‚ä½†ä¸»é”®çš„è¦æ±‚ä¸æ˜¯è‡ªå¢çš„ä¸»é”®ï¼Œè¿™æ ·å°±éœ€è¦ä¸šåŠ¡ç”Ÿæˆå…¨å±€å”¯ä¸€çš„ä¸»é”®ã€‚\r\n- å¦‚æœæ˜¯åˆ†åº“åˆ†è¡¨åœºæ™¯ä¸‹ï¼Œè·¯ç”±è§„åˆ™è¦ä¿è¯ç›¸åŒè¯·æ±‚ä¸‹ï¼Œè½åœ°åœ¨åŒä¸€ä¸ªæ•°æ®åº“å’ŒåŒä¸€è¡¨ä¸­ï¼Œè¦ä¸ç„¶æ•°æ®åº“ä¸»é”®çº¦æŸå°±ä¸èµ·æ•ˆæœäº†ï¼Œå› ä¸ºæ˜¯ä¸åŒçš„æ•°æ®åº“å’Œè¡¨ä¸»é”®ä¸ç›¸å…³ã€‚\r\n\r\n> è¿™ç§å®ç°æ–¹å¼æ˜¯åˆ©ç”¨ mysql å”¯ä¸€ç´¢å¼•çš„ç‰¹æ€§ã€‚\r\n>\r\n> ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\r\n>\r\n> ![image-20230429171314375](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429171314375.png)\r\n>\r\n> \r\n>\r\n> - å…·ä½“æµç¨‹æ­¥éª¤ï¼š\r\n>   - 1å»ºç«‹ä¸€å¼ å»é‡è¡¨ï¼Œå…¶ä¸­æŸä¸ªå­—æ®µéœ€è¦å»ºç«‹å”¯ä¸€ç´¢å¼•\r\n>   - 2å®¢æˆ·ç«¯å»è¯·æ±‚æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ä¼šå°†è¿™æ¬¡è¯·æ±‚çš„ä¸€äº›ä¿¡æ¯æ’å…¥è¿™å¼ å»é‡è¡¨ä¸­\r\n>   - 3å› ä¸ºè¡¨ä¸­æŸä¸ªå­—æ®µå¸¦æœ‰å”¯ä¸€ç´¢å¼•ï¼Œå¦‚æœæ’å…¥æˆåŠŸï¼Œè¯æ˜è¡¨ä¸­æ²¡æœ‰è¿™æ¬¡è¯·æ±‚çš„ä¿¡æ¯ï¼Œåˆ™æ‰§è¡Œåç»­çš„ä¸šåŠ¡é€»è¾‘\r\n>   - 4å¦‚æœæ’å…¥å¤±è´¥ï¼Œåˆ™ä»£è¡¨å·²ç»æ‰§è¡Œè¿‡å½“å‰è¯·æ±‚ï¼Œç›´æ¥è¿”å›\r\n\r\n\r\n\r\n#### **2ï¼‰ã€redis set é˜²é‡**\r\n\r\nå¾ˆå¤šæ•°æ®éœ€è¦å¤„ç†ï¼Œåªèƒ½è¢«å¤„ç†ä¸€æ¬¡ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥è®¡ç®—æ•°æ®çš„ MD5 å°†å…¶æ”¾å…¥ redis çš„ setï¼Œæ¯æ¬¡å¤„ç†æ•°æ®ï¼Œå…ˆçœ‹è¿™ä¸ª MD5 æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå­˜åœ¨å°±ä¸å¤„ç†ã€‚\r\n\r\n\r\n\r\n> - è¿™ç§å®ç°æ–¹å¼æ˜¯åŸºäº SETNX å‘½ä»¤å®ç°çš„\r\n> - SETNX key valueï¼šå°† key çš„å€¼è®¾ä¸º value ï¼Œå½“ä¸”ä»…å½“ key ä¸å­˜åœ¨ã€‚è‹¥ç»™å®šçš„ key å·²ç»å­˜åœ¨ï¼Œåˆ™ SETNX ä¸åšä»»ä½•åŠ¨ä½œã€‚\r\n> - è¯¥å‘½ä»¤åœ¨è®¾ç½®æˆåŠŸæ—¶è¿”å› 1ï¼Œè®¾ç½®å¤±è´¥æ—¶è¿”å› 0ã€‚\r\n>\r\n> ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\r\n>\r\n> ![image-20230429171445789](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230429171445789.png)\r\n>\r\n> \r\n>\r\n> - å…·ä½“æµç¨‹æ­¥éª¤ï¼š\r\n>   - 1å®¢æˆ·ç«¯å…ˆè¯·æ±‚æœåŠ¡ç«¯ï¼Œä¼šæ‹¿åˆ°ä¸€ä¸ªèƒ½ä»£è¡¨è¿™æ¬¡è¯·æ±‚ä¸šåŠ¡çš„å”¯ä¸€å­—æ®µ\r\n>   - 2å°†è¯¥å­—æ®µä»¥ SETNX çš„æ–¹å¼å­˜å…¥ redis ä¸­ï¼Œå¹¶æ ¹æ®ä¸šåŠ¡è®¾ç½®ç›¸åº”çš„è¶…æ—¶æ—¶é—´\r\n>   - 3å¦‚æœè®¾ç½®æˆåŠŸï¼Œè¯æ˜è¿™æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œåˆ™æ‰§è¡Œåç»­çš„ä¸šåŠ¡é€»è¾‘\r\n>   - 4å¦‚æœè®¾ç½®å¤±è´¥ï¼Œåˆ™ä»£è¡¨å·²ç»æ‰§è¡Œè¿‡å½“å‰è¯·æ±‚ï¼Œç›´æ¥è¿”å›\r\n\r\n\r\n\r\n### **4ã€é˜²é‡è¡¨**\r\n\r\n- ä½¿ç”¨è®¢å•å· orderNo åšä¸ºå»é‡è¡¨çš„å”¯ä¸€ç´¢å¼•ï¼ŒæŠŠå”¯ä¸€ç´¢å¼•æ’å…¥å»é‡è¡¨ï¼Œå†è¿›è¡Œä¸šåŠ¡æ“ä½œï¼Œä¸”ä»–ä»¬åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚è¿™ä¸ªä¿è¯äº†é‡å¤è¯·æ±‚æ—¶ï¼Œå› ä¸ºå»é‡è¡¨æœ‰å”¯ä¸€çº¦æŸï¼Œå¯¼è‡´è¯·æ±‚å¤±è´¥ï¼Œé¿å…äº†å¹‚ç­‰é—®é¢˜ã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œå»é‡è¡¨å’Œä¸šåŠ¡è¡¨åº”è¯¥åœ¨åŒä¸€åº“ä¸­ï¼Œè¿™æ ·å°±ä¿è¯äº†åœ¨åŒä¸€ä¸ªäº‹åŠ¡ï¼Œå³ä½¿ä¸šåŠ¡æ“ä½œå¤±è´¥äº†ï¼Œä¹Ÿä¼šæŠŠå»é‡è¡¨çš„æ•°æ®å›æ»šã€‚è¿™ä¸ªå¾ˆå¥½çš„ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§ã€‚\r\n\r\n- ä¹‹å‰è¯´çš„ redis é˜²é‡ä¹Ÿç®—\r\n\r\n\r\n\r\n### **5ã€å…¨å±€è¯·æ±‚å”¯ä¸€ id**\r\n\r\n- è°ƒç”¨æ¥å£æ—¶ï¼Œç”Ÿæˆä¸€ä¸ªå”¯ä¸€ idï¼Œredis å°†æ•°æ®ä¿å­˜åˆ°é›†åˆä¸­ï¼ˆå»é‡ï¼‰ï¼Œå­˜åœ¨å³å¤„ç†è¿‡ã€‚\r\n- å¯ä»¥ä½¿ç”¨ nginx è®¾ç½®æ¯ä¸€ä¸ªè¯·æ±‚çš„å”¯ä¸€ idï¼›\r\n- `proxy_set_header X-Request-Id $request_id;`\r\n\r\n\r\n\r\n### 6ã€æ€»ç»“\r\n\r\n> - è¿™å‡ ç§å®ç°å¹‚ç­‰çš„æ–¹å¼å…¶å®éƒ½æ˜¯å¤§åŒå°å¼‚çš„ï¼Œç±»ä¼¼çš„è¿˜æœ‰ä½¿ç”¨çŠ¶æ€æœºã€æ‚²è§‚é”ã€ä¹è§‚é”çš„æ–¹å¼æ¥å®ç°ï¼Œéƒ½æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚\r\n> - æ€»ä¹‹ï¼Œå½“ä½ å»è®¾è®¡ä¸€ä¸ªæ¥å£çš„æ—¶å€™ï¼Œå¹‚ç­‰éƒ½æ˜¯é¦–è¦è€ƒè™‘çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å½“ä½ è´Ÿè´£è®¾è®¡è½¬è´¦ã€æ”¯ä»˜è¿™ç§æ¶‰åŠåˆ° money çš„æ¥å£ï¼Œä½ è¦æ ¼å¤–æ³¨æ„å–½ï¼\r\n\r\n\r\n\r\n## å…­ã€å¦‚ä½•å®ç°å¹‚ç­‰æ€§\r\n\r\n### **æ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“å”¯ä¸€ä¸»é”®**\r\n\r\n**æ–¹æ¡ˆæè¿°**\r\n\r\næ•°æ®åº“å”¯ä¸€ä¸»é”®çš„å®ç°ä¸»è¦æ˜¯åˆ©ç”¨æ•°æ®åº“ä¸­ä¸»é”®å”¯ä¸€çº¦æŸçš„ç‰¹æ€§ï¼Œä¸€èˆ¬æ¥è¯´å”¯ä¸€ä¸»é”®æ¯”è¾ƒé€‚ç”¨äºâ€œæ’å…¥â€æ—¶çš„å¹‚ç­‰æ€§ï¼Œå…¶èƒ½ä¿è¯ä¸€å¼ è¡¨ä¸­åªèƒ½å­˜åœ¨ä¸€æ¡å¸¦è¯¥å”¯ä¸€ä¸»é”®çš„è®°å½•ã€‚\r\n\r\nä½¿ç”¨æ•°æ®åº“å”¯ä¸€ä¸»é”®å®Œæˆå¹‚ç­‰æ€§æ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥ä¸»é”®ä¸€èˆ¬æ¥è¯´å¹¶ä¸æ˜¯ä½¿ç”¨æ•°æ®åº“ä¸­è‡ªå¢ä¸»é”®ï¼Œè€Œæ˜¯ä½¿ç”¨åˆ†å¸ƒå¼ ID å……å½“ä¸»é”®ï¼ˆå¯ä»¥å‚è€ƒ Java ä¸­åˆ†å¸ƒå¼ ID çš„è®¾è®¡æ–¹æ¡ˆ è¿™ç¯‡æ–‡ç« ï¼‰ï¼Œè¿™æ ·æ‰èƒ½èƒ½ä¿è¯åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ ID çš„å…¨å±€å”¯ä¸€æ€§ã€‚\r\n\r\n**é€‚ç”¨æ“ä½œï¼š**\r\n\r\n- æ’å…¥æ“ä½œ\r\n- åˆ é™¤æ“ä½œ\r\n\r\n**ä½¿ç”¨é™åˆ¶ï¼š**\r\n\r\n- éœ€è¦ç”Ÿæˆå…¨å±€å”¯ä¸€ä¸»é”® IDï¼›\r\n\r\n**ä¸»è¦æµç¨‹ï¼š**\r\n\r\n![image-20230427153539838](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230427153539838.png)\r\n\r\nä¸»è¦æµç¨‹ï¼š\r\n\r\n1. â‘  å®¢æˆ·ç«¯æ‰§è¡Œåˆ›å»ºè¯·æ±‚ï¼Œè°ƒç”¨æœåŠ¡ç«¯æ¥å£ã€‚\r\n2. â‘¡ æœåŠ¡ç«¯æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç”Ÿæˆä¸€ä¸ªåˆ†å¸ƒå¼ IDï¼Œå°†è¯¥ ID å……å½“å¾…æ’å…¥æ•°æ®çš„ä¸»é”®ï¼Œç„¶åæ‰§æ•°æ®æ’å…¥æ“ä½œï¼Œè¿è¡Œå¯¹åº”çš„ SQL è¯­å¥ã€‚\r\n3. â‘¢ æœåŠ¡ç«¯å°†è¯¥æ¡æ•°æ®æ’å…¥æ•°æ®åº“ä¸­ï¼Œå¦‚æœæ’å…¥æˆåŠŸåˆ™è¡¨ç¤ºæ²¡æœ‰é‡å¤è°ƒç”¨æ¥å£ã€‚å¦‚æœæŠ›å‡ºä¸»é”®é‡å¤å¼‚å¸¸ï¼Œåˆ™è¡¨ç¤ºæ•°æ®åº“ä¸­å·²ç»å­˜åœ¨è¯¥æ¡è®°å½•ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯åˆ°å®¢æˆ·ç«¯ã€‚\r\n\r\n\r\n\r\n### **æ–¹æ¡ˆäºŒï¼šæ•°æ®åº“ä¹è§‚é”**\r\n\r\n**æ–¹æ¡ˆæè¿°ï¼š**\r\n\r\næ•°æ®åº“ä¹è§‚é”æ–¹æ¡ˆä¸€èˆ¬åªèƒ½é€‚ç”¨äºæ‰§è¡Œâ€œæ›´æ–°æ“ä½œâ€çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æå‰åœ¨å¯¹åº”çš„æ•°æ®è¡¨ä¸­å¤šæ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œå……å½“å½“å‰æ•°æ®çš„ç‰ˆæœ¬æ ‡è¯†ã€‚è¿™æ ·æ¯æ¬¡å¯¹è¯¥æ•°æ®åº“è¯¥è¡¨çš„è¿™æ¡æ•°æ®æ‰§è¡Œæ›´æ–°æ—¶ï¼Œéƒ½ä¼šå°†è¯¥ç‰ˆæœ¬æ ‡è¯†ä½œä¸ºä¸€ä¸ªæ¡ä»¶ï¼Œå€¼ä¸ºä¸Šæ¬¡å¾…æ›´æ–°æ•°æ®ä¸­çš„ç‰ˆæœ¬æ ‡è¯†çš„å€¼ã€‚\r\n\r\n**é€‚ç”¨æ“ä½œï¼š**\r\n\r\n- æ›´æ–°æ“ä½œ\r\n\r\n**ä½¿ç”¨é™åˆ¶ï¼š**\r\n\r\n- éœ€è¦æ•°æ®åº“å¯¹åº”ä¸šåŠ¡è¡¨ä¸­æ·»åŠ é¢å¤–å­—æ®µï¼›\r\n\r\n**æè¿°ç¤ºä¾‹ï¼š**\r\n\r\n![image-20230427153641136](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230427153641136.png)\r\n\r\nä¾‹å¦‚ï¼Œå­˜åœ¨å¦‚ä¸‹çš„æ•°æ®è¡¨ä¸­ï¼š\r\n\r\n1\r\n\r\nå°ç±³æ‰‹æœº\r\n\r\n1000\r\n\r\n\r\n\r\n2\r\n\r\nè‹¹æœæ‰‹æœº\r\n\r\n2500\r\n\r\n\r\n\r\n3\r\n\r\nåä¸ºæ‰‹æœº\r\n\r\n1600\r\n\r\n> ä¸ºäº†æ¯æ¬¡æ‰§è¡Œæ›´æ–°æ—¶é˜²æ­¢é‡å¤æ›´æ–°ï¼Œç¡®å®šæ›´æ–°çš„ä¸€å®šæ˜¯è¦æ›´æ–°çš„å†…å®¹ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½ä¼šæ·»åŠ ä¸€ä¸ª version å­—æ®µè®°å½•å½“å‰çš„è®°å½•ç‰ˆæœ¬ï¼Œè¿™æ ·åœ¨æ›´æ–°æ—¶å€™å°†è¯¥å€¼å¸¦ä¸Šï¼Œé‚£ä¹ˆåªè¦æ‰§è¡Œæ›´æ–°æ“ä½œå°±èƒ½ç¡®å®šä¸€å®šæ›´æ–°çš„æ˜¯æŸä¸ªå¯¹åº”ç‰ˆæœ¬ä¸‹çš„ä¿¡æ¯ã€‚\r\n\r\n1\r\n\r\nå°ç±³æ‰‹æœº\r\n\r\n1000\r\n\r\n10\r\n\r\n\r\n\r\n2\r\n\r\nè‹¹æœæ‰‹æœº\r\n\r\n2500\r\n\r\n21\r\n\r\n\r\n\r\n3\r\n\r\nåä¸ºæ‰‹æœº\r\n\r\n1600\r\n\r\n5\r\n\r\n> è¿™æ ·æ¯æ¬¡æ‰§è¡Œæ›´æ–°æ—¶å€™ï¼Œéƒ½è¦æŒ‡å®šè¦æ›´æ–°çš„ç‰ˆæœ¬å·ï¼Œå¦‚ä¸‹æ“ä½œå°±èƒ½å‡†ç¡®æ›´æ–° version=5 çš„ä¿¡æ¯ï¼š\r\n>\r\n> `UPDATE my_table SET price=price+50,version=version+1 WHERE id=1 AND version=5`\r\n>\r\n> ä¸Šé¢ WHERE åé¢è·Ÿç€æ¡ä»¶ id=1 AND version=5 è¢«æ‰§è¡Œåï¼Œid=1 çš„ version è¢«æ›´æ–°ä¸º 6ï¼Œæ‰€ä»¥å¦‚æœé‡å¤æ‰§è¡Œè¯¥æ¡ SQL è¯­å¥å°†ä¸ç”Ÿæ•ˆï¼Œå› ä¸º id=1 AND version=5 çš„æ•°æ®å·²ç»ä¸å­˜åœ¨ï¼Œè¿™æ ·å°±èƒ½ä¿ä½æ›´æ–°çš„å¹‚ç­‰ï¼Œå¤šæ¬¡æ›´æ–°å¯¹ç»“æœä¸ä¼šäº§ç”Ÿå½±å“ã€‚\r\n\r\n\r\n\r\n### **æ–¹æ¡ˆä¸‰ï¼šé˜²é‡ Token ä»¤ç‰Œ**\r\n\r\n**æ–¹æ¡ˆæè¿°ï¼š**\r\n\r\né’ˆå¯¹å®¢æˆ·ç«¯è¿ç»­ç‚¹å‡»æˆ–è€…è°ƒç”¨æ–¹çš„è¶…æ—¶é‡è¯•ç­‰æƒ…å†µï¼Œä¾‹å¦‚æäº¤è®¢å•ï¼Œæ­¤ç§æ“ä½œå°±å¯ä»¥ç”¨ Token çš„æœºåˆ¶å®ç°é˜²æ­¢é‡å¤æäº¤ã€‚ç®€å•çš„è¯´å°±æ˜¯è°ƒç”¨æ–¹åœ¨è°ƒç”¨æ¥å£çš„æ—¶å€™å…ˆå‘åç«¯è¯·æ±‚ä¸€ä¸ªå…¨å±€ IDï¼ˆTokenï¼‰ï¼Œè¯·æ±‚çš„æ—¶å€™æºå¸¦è¿™ä¸ªå…¨å±€ ID ä¸€èµ·è¯·æ±‚ï¼ˆToken æœ€å¥½å°†å…¶æ”¾åˆ° Headers ä¸­ï¼‰ï¼Œåç«¯éœ€è¦å¯¹è¿™ä¸ª Token ä½œä¸º Keyï¼Œç”¨æˆ·ä¿¡æ¯ä½œä¸º Value åˆ° Redis ä¸­è¿›è¡Œé”®å€¼å†…å®¹æ ¡éªŒï¼Œå¦‚æœ Key å­˜åœ¨ä¸” Value åŒ¹é…å°±æ‰§è¡Œåˆ é™¤å‘½ä»¤ï¼Œç„¶åæ­£å¸¸æ‰§è¡Œåé¢çš„ä¸šåŠ¡é€»è¾‘ã€‚å¦‚æœä¸å­˜åœ¨å¯¹åº”çš„ Key æˆ– Value ä¸åŒ¹é…å°±è¿”å›é‡å¤æ‰§è¡Œçš„é”™è¯¯ä¿¡æ¯ï¼Œè¿™æ ·æ¥ä¿è¯å¹‚ç­‰æ“ä½œã€‚\r\n\r\n**é€‚ç”¨æ“ä½œï¼š**\r\n\r\n1. æ’å…¥æ“ä½œ\r\n2. æ›´æ–°æ“ä½œ\r\n3. åˆ é™¤æ“ä½œ\r\n\r\n**ä½¿ç”¨é™åˆ¶ï¼š**\r\n\r\n1. éœ€è¦ç”Ÿæˆå…¨å±€å”¯ä¸€ Token ä¸²ï¼›\r\n2. éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹ç»„ä»¶ Redis è¿›è¡Œæ•°æ®æ•ˆéªŒï¼›\r\n\r\n**ä¸»è¦æµç¨‹ï¼š**\r\n\r\n![image-20230427153655823](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230427153655823.png)\r\n\r\n1. â‘  æœåŠ¡ç«¯æä¾›è·å– Token çš„æ¥å£ï¼Œè¯¥ Token å¯ä»¥æ˜¯ä¸€ä¸ªåºåˆ—å·ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ ID æˆ–è€… UUID ä¸²ã€‚\r\n2. â‘¡ å®¢æˆ·ç«¯è°ƒç”¨æ¥å£è·å– Tokenï¼Œè¿™æ—¶å€™æœåŠ¡ç«¯ä¼šç”Ÿæˆä¸€ä¸ª Token ä¸²ã€‚\r\n3. â‘¢ ç„¶åå°†è¯¥ä¸²å­˜å…¥ Redis æ•°æ®åº“ä¸­ï¼Œä»¥è¯¥ Token ä½œä¸º Redis çš„é”®ï¼ˆæ³¨æ„è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰ã€‚\r\n4. â‘£ å°† Token è¿”å›åˆ°å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ‹¿åˆ°ååº”å­˜åˆ°è¡¨å•éšè—åŸŸä¸­ã€‚\r\n5. â‘¤ å®¢æˆ·ç«¯åœ¨æ‰§è¡Œæäº¤è¡¨å•æ—¶ï¼ŒæŠŠ Token å­˜å…¥åˆ° Headers ä¸­ï¼Œæ‰§è¡Œä¸šåŠ¡è¯·æ±‚å¸¦ä¸Šè¯¥ Headersã€‚\r\n6. â‘¥ æœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚åä» Headers ä¸­æ‹¿åˆ° Tokenï¼Œç„¶åæ ¹æ® Token åˆ° Redis ä¸­æŸ¥æ‰¾è¯¥ key æ˜¯å¦å­˜åœ¨ã€‚\r\n7. â‘¦ æœåŠ¡ç«¯æ ¹æ® Redis ä¸­æ˜¯å¦å­˜è¯¥ key è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨å°±å°†è¯¥ key åˆ é™¤ï¼Œç„¶åæ­£å¸¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚å¦‚æœä¸å­˜åœ¨å°±æŠ›å¼‚å¸¸ï¼Œè¿”å›é‡å¤æäº¤çš„é”™è¯¯ä¿¡æ¯ã€‚\r\n\r\n> æ³¨æ„ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ Redis æŸ¥æ‰¾æ•°æ®ä¸åˆ é™¤éœ€è¦ä¿è¯åŸå­æ€§ï¼Œå¦åˆ™å¾ˆå¯èƒ½åœ¨å¹¶å‘ä¸‹æ— æ³•ä¿è¯å¹‚ç­‰æ€§ã€‚å…¶å®ç°æ–¹æ³•å¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼é”æˆ–è€…ä½¿ç”¨ Lua è¡¨è¾¾å¼æ¥æ³¨é”€æŸ¥è¯¢ä¸åˆ é™¤æ“ä½œã€‚\r\n\r\n\r\n\r\n### **æ–¹æ¡ˆå››ã€ä¸‹æ¸¸ä¼ é€’å”¯ä¸€åºåˆ—å·**\r\n\r\n**æ–¹æ¡ˆæè¿°ï¼š**\r\n\r\n- æ‰€è°“è¯·æ±‚åºåˆ—å·ï¼Œå…¶å®å°±æ˜¯æ¯æ¬¡å‘æœåŠ¡ç«¯è¯·æ±‚æ—¶å€™é™„å¸¦ä¸€ä¸ªçŸ­æ—¶é—´å†…å”¯ä¸€ä¸é‡å¤çš„åºåˆ—å·ï¼Œè¯¥åºåˆ—å·å¯ä»¥æ˜¯ä¸€ä¸ªæœ‰åº IDï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè®¢å•å·ï¼Œä¸€èˆ¬ç”±ä¸‹æ¸¸ç”Ÿæˆï¼Œåœ¨è°ƒç”¨ä¸Šæ¸¸æœåŠ¡ç«¯æ¥å£æ—¶é™„åŠ è¯¥åºåˆ—å·å’Œç”¨äºè®¤è¯çš„ IDã€‚\r\n\r\n- å½“ä¸Šæ¸¸æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚ä¿¡æ¯åæ‹¿å–è¯¥ åºåˆ—å· å’Œä¸‹æ¸¸ è®¤è¯ID è¿›è¡Œç»„åˆï¼Œå½¢æˆç”¨äºæ“ä½œ Redis çš„ Keyï¼Œç„¶ååˆ° Redis ä¸­æŸ¥è¯¢æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ Key çš„é”®å€¼å¯¹ï¼Œæ ¹æ®å…¶ç»“æœï¼š\r\n  1. å¦‚æœå­˜åœ¨ï¼Œå°±è¯´æ˜å·²ç»å¯¹è¯¥ä¸‹æ¸¸çš„è¯¥åºåˆ—å·çš„è¯·æ±‚è¿›è¡Œäº†ä¸šåŠ¡å¤„ç†ï¼Œè¿™æ—¶å¯ä»¥ç›´æ¥å“åº”é‡å¤è¯·æ±‚çš„é”™è¯¯ä¿¡æ¯ã€‚\r\n  2. å¦‚æœä¸å­˜åœ¨ï¼Œå°±ä»¥è¯¥ Key ä½œä¸º Redis çš„é”®ï¼Œä»¥ä¸‹æ¸¸å…³é”®ä¿¡æ¯ä½œä¸ºå­˜å‚¨çš„å€¼ï¼ˆä¾‹å¦‚ä¸‹æ¸¸å•†ä¼ é€’çš„ä¸€äº›ä¸šåŠ¡é€»è¾‘ä¿¡æ¯ï¼‰ï¼Œå°†è¯¥é”®å€¼å¯¹å­˜å‚¨åˆ° Redis ä¸­ ï¼Œç„¶åå†æ­£å¸¸æ‰§è¡Œå¯¹åº”çš„ä¸šåŠ¡é€»è¾‘å³å¯ã€‚\r\n\r\n**é€‚ç”¨æ“ä½œï¼š**\r\n\r\n1. æ’å…¥æ“ä½œ\r\n2. æ›´æ–°æ“ä½œ\r\n3. åˆ é™¤æ“ä½œ\r\n\r\n**ä½¿ç”¨é™åˆ¶ï¼š**\r\n\r\n1. è¦æ±‚ç¬¬ä¸‰æ–¹ä¼ é€’å”¯ä¸€åºåˆ—å·ï¼›\r\n2. éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹ç»„ä»¶ Redis è¿›è¡Œæ•°æ®æ•ˆéªŒï¼›\r\n\r\n**ä¸»è¦æµç¨‹ï¼š**\r\n\r\n\r\n\r\n![image-20230427153719484](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230427153719484.png)\r\n\r\n\r\n\r\nä¸»è¦æ­¥éª¤ï¼š\r\n\r\n1. â‘  ä¸‹æ¸¸æœåŠ¡ç”Ÿæˆåˆ†å¸ƒå¼ ID ä½œä¸ºåºåˆ—å·ï¼Œç„¶åæ‰§è¡Œè¯·æ±‚è°ƒç”¨ä¸Šæ¸¸æ¥å£ï¼Œå¹¶é™„å¸¦â€œå”¯ä¸€åºåˆ—å·â€ä¸è¯·æ±‚çš„â€œè®¤è¯å‡­æ®IDâ€ã€‚\r\n2. â‘¡ ä¸Šæ¸¸æœåŠ¡è¿›è¡Œå®‰å…¨æ•ˆéªŒï¼Œæ£€æµ‹ä¸‹æ¸¸ä¼ é€’çš„å‚æ•°ä¸­æ˜¯å¦å­˜åœ¨â€œåºåˆ—å·â€å’Œâ€œå‡­æ®IDâ€ã€‚\r\n3. â‘¢ ä¸Šæ¸¸æœåŠ¡åˆ° Redis ä¸­æ£€æµ‹æ˜¯å¦å­˜åœ¨å¯¹åº”çš„â€œåºåˆ—å·â€ä¸â€œè®¤è¯IDâ€ç»„æˆçš„ Keyï¼Œå¦‚æœå­˜åœ¨å°±æŠ›å‡ºé‡å¤æ‰§è¡Œçš„å¼‚å¸¸ä¿¡æ¯ï¼Œç„¶åå“åº”ä¸‹æ¸¸å¯¹åº”çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœä¸å­˜åœ¨å°±ä»¥è¯¥â€œåºåˆ—å·â€å’Œâ€œè®¤è¯IDâ€ç»„åˆä½œä¸º Keyï¼Œä»¥ä¸‹æ¸¸å…³é”®ä¿¡æ¯ä½œä¸º Valueï¼Œè¿›è€Œå­˜å‚¨åˆ° Redis ä¸­ï¼Œç„¶åæ­£å¸¸æ‰§è¡Œæ¥æ¥æ¥çš„ä¸šåŠ¡é€»è¾‘ã€‚\r\n\r\n> ä¸Šé¢æ­¥éª¤ä¸­æ’å…¥æ•°æ®åˆ° Redis ä¸€å®šè¦è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚è¿™æ ·èƒ½ä¿è¯åœ¨è¿™ä¸ªæ—¶é—´èŒƒå›´å†…ï¼Œå¦‚æœé‡å¤è°ƒç”¨æ¥å£ï¼Œåˆ™èƒ½å¤Ÿè¿›è¡Œåˆ¤æ–­è¯†åˆ«ã€‚å¦‚æœä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¾ˆå¯èƒ½å¯¼è‡´æ•°æ®æ— é™é‡çš„å­˜å…¥ Redisï¼Œè‡´ä½¿ Redis ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚\r\n\r\n\r\n\r\n## ä¸ƒã€åœ¨é¡¹ç›®ä¸­å®ç°æ¥å£å¹‚ç­‰\r\n\r\nè¿™é‡Œä½¿ç”¨é˜²é‡ Token ä»¤ç‰Œæ–¹æ¡ˆï¼Œè¯¥æ–¹æ¡ˆèƒ½ä¿è¯åœ¨ä¸åŒè¯·æ±‚åŠ¨ä½œä¸‹çš„å¹‚ç­‰æ€§ï¼Œå®ç°é€»è¾‘å¯ä»¥çœ‹ä¸Šé¢å†™çš„â€é˜²é‡ Token ä»¤ç‰Œâ€æ–¹æ¡ˆï¼Œæ¥ä¸‹æ¥å†™ä¸‹å®ç°è¿™ä¸ªé€»è¾‘çš„ä»£ç ã€‚\r\n\r\n\r\n\r\n### **1ã€Maven å¼•å…¥ç›¸å…³ä¾èµ–**\r\n\r\nè¿™é‡Œä½¿ç”¨ Maven å·¥å…·ç®¡ç†ä¾èµ–ï¼Œè¿™é‡Œåœ¨ [pom.xml](https://pom.xml/) ä¸­å¼•å…¥ SpringBootã€Redisã€lombok ç›¸å…³ä¾èµ–ã€‚\r\n\r\n```xml\r\n\t<!--springboot web-->\r\n    <dependency>\r\n      <groupId>org.springframework.boot</groupId>\r\n      <artifactId>spring-boot-starter-web</artifactId>\r\n    </dependency>\r\n\r\n    <!--springboot data redis-->\r\n    <dependency>\r\n     <groupId>org.springframework.boot</groupId>\r\n     <artifactId>spring-boot-starter-data-redis</artifactId>\r\n    </dependency>\r\n\r\n\t<!--lombok-->\r\n    <dependency>\r\n      <groupId>org.projectlombok</groupId>\r\n      <artifactId>lombok</artifactId>\r\n    </dependency>\r\n```\r\n\r\n\r\n\r\n### **2ã€é…ç½®è¿æ¥ Redis çš„å‚æ•°**\r\n\r\nåœ¨ application é…ç½®æ–‡ä»¶ä¸­é…ç½®è¿æ¥ Redis çš„å‚æ•°ã€‚Spring Boot åŸºç¡€å°±ä¸ä»‹ç»äº†ï¼Œæœ€æ–°æ•™ç¨‹æ¨èçœ‹ä¸‹é¢çš„æ•™ç¨‹ã€‚\r\n\r\n```properties\r\nspring.redis.host=192.168.10.103\r\nspring.redis.port=6379\r\n```\r\n\r\n\r\n\r\n### **3ã€åˆ›å»ºä¸éªŒè¯ Token** \r\n\r\nåˆ›å»ºç”¨äºæ“ä½œ Token ç›¸å…³çš„ Service ç±»ï¼Œé‡Œé¢å­˜åœ¨ Token åˆ›å»ºä¸éªŒè¯æ–¹æ³•ï¼Œå…¶ä¸­ï¼š\r\n\r\n1. **Token åˆ›å»ºæ–¹æ³•ï¼š** ä½¿ç”¨ UUID å·¥å…·åˆ›å»º Token ä¸²ï¼Œè®¾ç½®ä»¥ â€œorder:token:â€œ+â€œTokenä¸²â€ ä½œä¸º Keyï¼Œä»¥ç”¨æˆ·idå½“æˆ Valueï¼Œå°†ä¿¡æ¯å­˜å…¥ Redis ä¸­ã€‚\r\n2. **Token éªŒè¯æ–¹æ³•ï¼š** æ¥æ”¶ Token ä¸²å‚æ•°ï¼ŒåŠ ä¸Š Key å‰ç¼€å½¢æˆ Keyï¼Œå†ä¼ å…¥ value å€¼ï¼Œæ‰§è¡Œ Lua è¡¨è¾¾å¼ï¼ˆLua è¡¨è¾¾å¼èƒ½ä¿è¯å‘½ä»¤æ‰§è¡Œçš„åŸå­æ€§ï¼‰è¿›è¡ŒæŸ¥æ‰¾å¯¹åº” Key ä¸åˆ é™¤æ“ä½œã€‚æ‰§è¡Œå®ŒæˆåéªŒè¯å‘½ä»¤çš„è¿”å›ç»“æœï¼Œå¦‚æœç»“æœä¸ä¸ºç©ºä¸”é0ï¼Œåˆ™éªŒè¯æˆåŠŸï¼Œå¦åˆ™å¤±è´¥ã€‚\r\n\r\n```java\r\n/**\r\n * è®¢å•ç¡®è®¤é¡µè¿”å›éœ€è¦ç”¨åˆ°çš„æ•°æ®\r\n *\r\n * @return\r\n */\r\n@Override\r\npublic OrderConfirmVo confirmOrder() throws ExecutionException, InterruptedException {\r\n    ...\r\n    //todo 5ã€é˜²é‡ä»¤ç‰Œ\r\n    String token = UUID.randomUUID().toString().replace(\"-\", \"\");\r\n    //ç»™æœåŠ¡å™¨ä¸€ä¸ªä»¤ç‰Œ\r\n    redisTemplate.opsForValue().set(OrderConstant.USER_ORDER_TOKEN_PREFIX + \t\t             memberRespVo.getId(), token, 30, TimeUnit.MINUTES);\r\n    //ç»™é¡µé¢ä¸€ä¸ªä»¤ç‰Œ\r\n    confirmVo.setOrderToken(token);\r\n    ...\r\n}    \r\n```\r\n\r\n```java\r\n/**\r\n * ä¸‹å•\r\n */\r\n@Transactional\r\n@Override\r\npublic SubmitOrderResponseVo submitOrder(OrderSubmitVo vo) {\r\n    ...\r\n    //1ã€éªŒè¯ä»¤ç‰Œã€ä»¤ç‰Œçš„å¯¹æ¯”å’Œåˆ é™¤å¿…é¡»ä¿è¯åŸå­æ€§ã€‘\r\n    //0ä»¤ç‰Œå¤±è´¥ - 1åˆ é™¤æˆåŠŸ(æ ¡éªŒæˆåŠŸ)\r\n    String script = \"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\";\r\n    String orderToken = vo.getOrderToken();\r\n    //åŸå­éªŒè¯ä»¤ç‰Œå’Œåˆ é™¤ä»¤ç‰Œ\r\n    Long result = redisTemplate.execute(\r\n                //è„šæœ¬è¿”å›ç±»å‹->0,1\r\n                new DefaultRedisScript<Long>(script, Long.class),\r\n                //å°†ç¼“å­˜ä¸­å°†è¦æ¯”å¯¹çš„keyè½¬ä¸ºé›†åˆ\r\n                Arrays.asList(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberRespVo.getId()),\r\n                //ä¼ å…¥è¦æ ¡éªŒçš„å€¼\r\n                orderToken);\r\n    if (result == 0L) {\r\n        //éªŒè¯å¤±è´¥ï¼Œè®¾ç½®é”™è¯¯çŠ¶æ€ç ä¸º1ï¼Œkeyè¿‡æœŸç­‰æƒ…å†µ\r\n        responseVo.setCode(1);\r\n        return responseVo;\r\n    } else {\r\n        //éªŒè¯æˆåŠŸ\r\n        ...\r\n    }\r\n}    \r\n```\r\n\r\n\r\n\r\n## å…«ã€æœ€åæ€»ç»“\r\n\r\n- å¹‚ç­‰æ€§æ˜¯å¼€å‘å½“ä¸­å¾ˆå¸¸è§ä¹Ÿå¾ˆé‡è¦çš„ä¸€ä¸ªéœ€æ±‚ï¼Œå°¤å…¶æ˜¯æ”¯ä»˜ã€è®¢å•ç­‰ä¸é‡‘é’±æŒ‚é’©çš„æœåŠ¡ï¼Œä¿è¯æ¥å£å¹‚ç­‰æ€§å°¤å…¶é‡è¦ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸åŒçš„ä¸šåŠ¡åœºæ™¯æˆ‘ä»¬éœ€è¦çµæ´»çš„é€‰æ‹©å¹‚ç­‰æ€§çš„å®ç°æ–¹å¼ï¼š\r\n\r\n1. å¯¹äºä¸‹å•ç­‰å­˜åœ¨å”¯ä¸€ä¸»é”®çš„ï¼Œå¯ä»¥ä½¿ç”¨â€œå”¯ä¸€ä¸»é”®æ–¹æ¡ˆâ€çš„æ–¹å¼å®ç°ã€‚\r\n2. å¯¹äºæ›´æ–°è®¢å•çŠ¶æ€ç­‰ç›¸å…³çš„æ›´æ–°åœºæ™¯æ“ä½œï¼Œä½¿ç”¨â€œä¹è§‚é”æ–¹æ¡ˆâ€å®ç°æ›´ä¸ºç®€å•ã€‚\r\n3. å¯¹äºä¸Šä¸‹æ¸¸è¿™ç§ï¼Œä¸‹æ¸¸è¯·æ±‚ä¸Šæ¸¸ï¼Œä¸Šæ¸¸æœåŠ¡å¯ä»¥ä½¿ç”¨â€œä¸‹æ¸¸ä¼ é€’å”¯ä¸€åºåˆ—å·æ–¹æ¡ˆâ€æ›´ä¸ºåˆç†ã€‚\r\n4. ç±»ä¼¼äºå‰ç«¯é‡å¤æäº¤ã€é‡å¤ä¸‹å•ã€æ²¡æœ‰å”¯ä¸€IDå·çš„åœºæ™¯ï¼Œå¯ä»¥é€šè¿‡ Token ä¸ Redis é…åˆçš„â€œé˜²é‡ Token æ–¹æ¡ˆâ€å®ç°æ›´ä¸ºå¿«æ·ã€‚\r\n\r\n> ä¸Šé¢åªæ˜¯ç»™ä¸ä¸€äº›å»ºè®®ï¼Œå†æ¬¡å¼ºè°ƒä¸€ä¸‹ï¼Œå®ç°å¹‚ç­‰æ€§éœ€è¦å…ˆç†è§£è‡ªèº«ä¸šåŠ¡éœ€æ±‚ï¼Œæ ¹æ®ä¸šåŠ¡é€»è¾‘æ¥å®ç°è¿™æ ·æ‰åˆç†ï¼Œå¤„ç†å¥½å…¶ä¸­çš„æ¯ä¸€ä¸ªç»“ç‚¹ç»†èŠ‚ï¼Œå®Œå–„æ•´ä½“çš„ä¸šåŠ¡æµç¨‹è®¾è®¡ï¼Œæ‰èƒ½æ›´å¥½çš„ä¿è¯ç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œã€‚æœ€ååšä¸€ä¸ªç®€å•æ€»ç»“\r\n\r\n> æ•°æ®åº“å”¯ä¸€ä¸»é”®\r\n>\r\n> æ’å…¥æ“ä½œ åˆ é™¤æ“ä½œ\r\n>\r\n> ç®€å•\r\n>\r\n> \\- åªèƒ½ç”¨äºæ’å…¥æ“ä½œï¼›- åªèƒ½ç”¨äºå­˜åœ¨å”¯ä¸€ä¸»é”®åœºæ™¯ï¼›\r\n\r\n> æ•°æ®åº“ä¹è§‚é”\r\n>\r\n> æ›´æ–°æ“ä½œ\r\n>\r\n> ç®€å•\r\n>\r\n> \\- åªèƒ½ç”¨äºæ›´æ–°æ“ä½œï¼›- è¡¨ä¸­éœ€è¦é¢å¤–æ·»åŠ å­—æ®µï¼›\r\n\r\n> è¯·æ±‚åºåˆ—å·\r\n>\r\n> æ’å…¥æ“ä½œ æ›´æ–°æ“ä½œ åˆ é™¤æ“ä½œ\r\n>\r\n> ç®€å•\r\n>\r\n> \\- éœ€è¦ä¿è¯ä¸‹æ¸¸ç”Ÿæˆå”¯ä¸€åºåˆ—å·ï¼›- éœ€è¦ Redis ç¬¬ä¸‰æ–¹å­˜å‚¨å·²ç»è¯·æ±‚çš„åºåˆ—å·ï¼›\r\n\r\n> é˜²é‡ Token ä»¤ç‰Œ\r\n>\r\n> æ’å…¥æ“ä½œ æ›´æ–°æ“ä½œ åˆ é™¤æ“ä½œ\r\n>\r\n> é€‚ä¸­\r\n>\r\n> \\- éœ€è¦ Redis ç¬¬ä¸‰æ–¹å­˜å‚¨ç”Ÿæˆçš„ Token ä¸²ï¼›\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"ç¬¬äºŒç« . åç«¯ä¹‹äºå‰ç«¯ - Javascript","tags":["Javascript"],"categories":["å‰ç«¯"],"author":"imklaus","excerpt":"\r\n\r\n\r\n\r\nå®ƒæ˜¯ä¸€ç§è„šæœ¬è¯­è¨€ï¼Œå¯ä»¥ç”¨æ¥æ›´æ”¹é¡µé¢å†…å®¹ï¼Œæ§åˆ¶å¤šåª’ä½“ï¼Œåˆ¶ä½œå›¾åƒã€åŠ¨ç”»ç­‰ç­‰\r\n\r\n","link":"/posts/Javascript","content":"\r\n\r\n\r\n\r\nå®ƒæ˜¯ä¸€ç§è„šæœ¬è¯­è¨€ï¼Œå¯ä»¥ç”¨æ¥æ›´æ”¹é¡µé¢å†…å®¹ï¼Œæ§åˆ¶å¤šåª’ä½“ï¼Œåˆ¶ä½œå›¾åƒã€åŠ¨ç”»ç­‰ç­‰\r\n\r\n<!-- more -->\r\n\r\nä¾‹å­\r\n\r\n* ä¿®æ”¹é¡µé¢å†…å®¹\r\n\r\n\r\n\r\njs ä»£ç ä½ç½®\r\n\r\n```html\r\n<script>\r\n\t// js ä»£ç \r\n</script>\r\n```\r\n\r\nå¼•å…¥ js è„šæœ¬\r\n\r\n```html\r\n<script src=\"jsè„šæœ¬è·¯å¾„\"></script>\r\n```\r\n\r\n* æ³¨æ„ï¼Œåˆ°äº†æ¡†æ¶ä¹‹åï¼Œå¼•å…¥æ–¹å¼ä¼šæœ‰ä¸åŒ\r\n\r\n\r\n\r\n\r\n\r\n## 1. å˜é‡ä¸æ•°æ®ç±»å‹\r\n\r\n### å£°æ˜å˜é‡\r\n\r\n#### 1) let :star:\r\n\r\n```js\r\nlet å˜é‡å = å€¼;\r\n```\r\n\r\n* let å£°æ˜çš„å˜é‡å¯ä»¥è¢«å¤šæ¬¡èµ‹å€¼ï¼Œä¾‹å¦‚\r\n\r\n```js\r\nlet a = 100;  // åˆå§‹å€¼æ˜¯ 100\r\na = 200;\t  // ok, è¢«é‡æ–°èµ‹å€¼ä¸º 200\r\n```\r\n\r\n#### 2) const :star:\r\n\r\n* const ä¿®é¥°çš„å«å¸¸é‡ï¼Œåªèƒ½èµ‹å€¼ä¸€æ¬¡\r\n\r\n```js\r\nconst b = 300; // åˆå§‹å€¼æ˜¯ 300\r\nb = 400;\t   // error, ä¸èƒ½å†æ¬¡èµ‹å€¼\r\n```\r\n\r\n* const å¹¶ä¸æ„å‘³ç€å®ƒå¼•ç”¨çš„å†…å®¹ä¸å¯ä¿®æ”¹ï¼Œä¾‹å¦‚\r\n\r\n```js\r\nconst c = [1,2,3];\r\nc[2] = 4; \t        // ok, æ•°ç»„å†…å®¹è¢«ä¿®æ”¹æˆ [1,2,4]\r\nc = [5,6];\t\t\t// error, ä¸èƒ½å†æ¬¡èµ‹å€¼\r\n```\r\n\r\n#### 3) var\r\n\r\nvar å£°æ˜çš„å˜é‡å¯ä»¥è¢«å¤šæ¬¡èµ‹å€¼ï¼Œä¾‹å¦‚\r\n\r\n```js\r\nvar f = 100;\r\nf = 200;\r\n```\r\n\r\n\r\n\r\n### åŸºæœ¬ç±»å‹\r\n\r\n#### 1,2) undefined å’Œ null\r\n\r\n* æ‰§è¡Œè¡¨è¾¾å¼æˆ–å‡½æ•°ï¼Œæ²¡æœ‰è¿”å›ç»“æœï¼Œå‡ºç° undefined\r\n* è®¿é—®æ•°ç»„ä¸å­˜åœ¨çš„å…ƒç´ ï¼Œè®¿é—®å¯¹è±¡ä¸å­˜åœ¨çš„å±æ€§ï¼Œå‡ºç° undefined\r\n* å®šä¹‰å˜é‡ï¼Œæ²¡æœ‰åˆå§‹åŒ–ï¼Œå‡ºç° undefined\r\n\r\nä¾‹\r\n\r\n```js\r\nconsole.log(1);  \t// å‡½æ•°æ²¡æœ‰è¿”å›å€¼, ç»“æœæ˜¯  undefined\r\nlet a = 10;\t\t \t// è¡¨è¾¾å¼æ²¡æœ‰è¿”å›å€¼, ç»“æœæ˜¯ undefined\r\nlet b = [1,2,3];\r\nconsole.log(b[10]); // æ•°ç»„æœªå®šä¹‰å…ƒç´ æ˜¯ undefined\r\nlet c = {\"name\":\"å¼ ä¸‰\"};\r\nconsole.log(c.age); // å¯¹è±¡æœªå®šä¹‰å±æ€§æ˜¯ undefined\r\nlet d;\r\nconsole.log(d);\t\t// å˜é‡æœªåˆå§‹åŒ–æ˜¯ undefined\r\n```\r\n\r\näºŒè€…å…±åŒç‚¹\r\n\r\n* éƒ½æ²¡æœ‰å±æ€§ã€æ–¹æ³•\r\n* äºŒè€…åˆç§° Nullish\r\n\r\näºŒè€…åŒºåˆ«\r\n\r\n* undefined ç”± js äº§ç”Ÿ\r\n* null ç”±ç¨‹åºå‘˜æä¾›\r\n\r\n\r\n\r\n#### 3) string :star:\r\n\r\njs å­—ç¬¦ä¸²ä¸‰ç§å†™æ³•\r\n\r\n```js\r\nlet a = \"hello\";  // åŒå¼•å·\r\nlet b = \"world\";  // å•å¼•å·\r\nlet c = `hello`;  // åå¼•å·\r\n```\r\n\r\n\r\n\r\nhtml ä»£ç å¦‚ä¸‹ï¼Œç”¨ java å’Œ js ä¸­çš„å­—ç¬¦ä¸²å¦‚ä½•è¡¨ç¤ºï¼Ÿ\r\n\r\n```html\r\n<a href=\"1.html\">è¶…é“¾æ¥</a>\r\n```\r\n\r\njava æ˜¾å¾—æ¯”è¾ƒç¹ç\r\n\r\n```java\r\nString s1 = \"<a href=\\\"1.html\\\">è¶…é“¾æ¥</a>\";\r\n\r\nString s2 = \"\"\"\r\n    <a href=\"1.html\">è¶…é“¾æ¥</a>\"\"\";\r\n```\r\n\r\njs å°±æ¯”è¾ƒçµæ´»\r\n\r\n```js\r\nlet s1 = '<a href=\"1.html\">è¶…é“¾æ¥</a>';\r\n\r\nlet s2 = `<a href=\"1.html\">è¶…é“¾æ¥</a>`;\r\n```\r\n\r\n\r\n\r\næ¨¡æ¿å­—ç¬¦ä¸²ï¼ˆTemplate stringsï¼‰\r\n\r\néœ€æ±‚ï¼šæ‹¼æ¥ URI çš„è¯·æ±‚å‚æ•°ï¼Œå¦‚\r\n\r\n```\r\n/test?name=zhang&age=18\r\n/test?name=li&age=20\r\n```\r\n\r\nä¼ ç»Ÿæ–¹æ³•æ‹¼æ¥\r\n\r\n```js\r\nlet name = ; // zhang li ...\r\nlet age = ; // 18 20 ...\r\n\r\nlet uri = \"/test?name=\" + name + \"&age=\" + age;\r\n```\r\n\r\næ¨¡æ¿å­—ç¬¦ä¸²æ–¹å¼\r\n\r\n```js\r\nlet name = ; // zhang li ...\r\nlet age = ; // 18 20 ...\r\n\r\nlet uri = `/test?name=${name}&age=${age}`;\r\n```\r\n\r\n\r\n\r\n#### 4,5) number å’Œ bigint:star:\r\n\r\nnumber ç±»å‹æ ‡è¯†çš„æ˜¯åŒç²¾åº¦æµ®åŠ¨å°æ•°ï¼Œä¾‹å¦‚\r\n\r\n```js\r\n10 / 3;   // ç»“æœ 3.3333333333333335\r\n```\r\n\r\næ—¢ç„¶æ˜¯æµ®ç‚¹å°æ•°ï¼Œé‚£ä¹ˆå¯ä»¥é™¤é›¶\r\n\r\n```js\r\n10 / 0;\t  // ç»“æœ Infinity æ­£æ— ç©·å¤§\r\n-10 / 0;  // ç»“æœ -Infinity è´Ÿæ— ç©·å¤§\r\n```\r\n\r\næµ®ç‚¹å°æ•°éƒ½æœ‰è¿ç®—ç²¾åº¦é—®é¢˜ï¼Œä¾‹å¦‚\r\n\r\n```js\r\n2.0 - 1.1; // ç»“æœ 0.8999999999999999\r\n```\r\n\r\nå­—ç¬¦ä¸²è½¬æ•°å­—\r\n\r\n```js\r\nparseInt(\"10\"); \t// ç»“æœæ˜¯æ•°å­— 10 \r\nparseInt(\"10.5\");\t// ç»“æœæ˜¯æ•°å­— 10, å»é™¤äº†å°æ•°éƒ¨åˆ†\r\nparseInt(\"10\") / 3; // ç»“æœä»è§†ä¸º number æµ®ç‚¹æ•°, å› æ­¤ç»“æœä¸º 3.3333333333333335\r\n\r\nparseInt(\"abc\");\t// è½¬æ¢å¤±è´¥ï¼Œç»“æœæ˜¯ç‰¹æ®Šå€¼ NaN (Not a Number)\r\n```\r\n\r\nè¦è¡¨ç¤ºçœŸæ­£çš„æ•´æ•°ï¼Œéœ€è¦ç”¨ bigintï¼Œæ•°å­—çš„ç»“å°¾ç”¨ n è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ª bigint ç±»å‹\r\n\r\n```js\r\n10n / 3n;\t\t\t// ç»“æœ 3n, æŒ‰æ•´æ•°é™¤æ³•å¤„ç†\r\n```\r\n\r\n\r\n\r\n#### 6) boolean :star:\r\n\r\n* Truthy\r\n* Falsy\r\n\r\nåœ¨ js ä¸­ï¼Œå¹¶ä¸æ˜¯ boolean æ‰èƒ½ç”¨äºæ¡ä»¶åˆ¤æ–­ï¼Œä½ å¯ä»¥åœ¨ if è¯­å¥ä¸­ä½¿ç”¨ã€æ•°å­—ã€‘ã€ã€å­—ç¬¦ä¸²ã€‘... ä½œä¸ºåˆ¤æ–­æ¡ä»¶\r\n\r\n```js\r\nlet b = 1;\r\n\r\nif(b) { // true\r\n    console.log(\"è¿›å…¥äº†\");\r\n}\r\n```\r\n\r\n\r\n\r\nè¿™æ—¶å°±æœ‰ä¸€ä¸ªè§„åˆ™ï¼Œå½“éœ€è¦æ¡ä»¶åˆ¤æ–­æ—¶ï¼Œè¿™ä¸ªå€¼è¢«å½“ä½œ true è¿˜æ˜¯ falseï¼Œå½“ä½œ true çš„å€¼å½’ç±»ä¸º truthyï¼Œå½“ä½œ false çš„å€¼å½’ç±»ä¸º falsy\r\n\r\nä¸‹é¢å€¼éƒ½æ˜¯ falsy\r\n\r\n* `false`\r\n* `Nullish (null, undefined)`\r\n* `0, 0n, NaN`\r\n* ``` \"\" '' `` ```  å³é•¿åº¦ä¸ºé›¶çš„å­—ç¬¦ä¸²\r\n\r\nå‰©ä½™çš„å€¼ç»å¤§éƒ¨åˆ†éƒ½æ˜¯ truthy\r\n\r\næœ‰å‡ ä¸ªå®¹æ˜“è¢«å½“ä½œ falsy å®é™…æ˜¯ truthy çš„\r\n\r\n* `\"false\", \"0\"` å³å­—ç¬¦ä¸²çš„ false å’Œ å­—ç¬¦ä¸²çš„é›¶\r\n* `[]` ç©ºæ•°ç»„\r\n* `{}` ç©ºå¯¹è±¡\r\n\r\n\r\n\r\n#### 7) symbol\r\n\r\n* å¾ˆå°‘ä½¿ç”¨\r\n\r\n\r\n\r\n### å¯¹è±¡ç±»å‹\r\n\r\n#### 1) Function :star::star:\r\n\r\n##### å®šä¹‰å‡½æ•°\r\n\r\n```js\r\nfunction å‡½æ•°å(å‚æ•°) {\r\n    // å‡½æ•°ä½“\r\n    return ç»“æœ;\r\n}\r\n```\r\n\r\nä¾‹\r\n\r\n```js\r\nfunction add(a, b) {\r\n    return a + b;\r\n}\r\n```\r\n\r\n##### è°ƒç”¨å‡½æ•°\r\n\r\n```js\r\nå‡½æ•°å(å®å‚);\r\n```\r\n\r\nä¾‹\r\n\r\n```js\r\nadd(1, 2);     // è¿”å› 3\r\n```\r\n\r\njs ä¸­çš„å‡½æ•°è°ƒç”¨ç‰¹ç‚¹ï¼šå¯¹å‚æ•°çš„**ç±»å‹**å’Œ**ä¸ªæ•°**éƒ½æ²¡æœ‰é™åˆ¶ï¼Œä¾‹å¦‚\r\n\r\n```js\r\nadd('a', 'b');  // è¿”å› ab\r\nadd(4, 5, 6);   // è¿”å› 9, ç¬¬ä¸‰ä¸ªå‚æ•°æ²¡æœ‰è¢«ç”¨åˆ°, ä¸ä¼šæŠ¥é”™\r\nadd(1);\t\t\t// è¿”å› NaN, è¿™æ—¶ b æ²¡æœ‰å®šä¹‰æ˜¯ undefined, undefined åšæ•°å­¦è¿ç®—ç»“æœå°±æ˜¯ NaN\r\n```\r\n\r\n\r\n\r\n##### é»˜è®¤å‚æ•°\r\n\r\njava ä¸­ï¼ˆspringï¼‰è¦å®ç°é»˜è®¤å‚æ•°çš„æ•ˆæœå¾—è¿™ä¹ˆåšï¼š\r\n\r\n```java\r\n@RestController \r\npublic class MyController {\r\n    \r\n    @RequestMapping(\"/page\")\r\n    @ResponseBody\r\n    public void page(\r\n        @RequestParam(defaultValue=\"1\") int page, \r\n        @RequestParam(defaultValue=\"10\") int size\r\n    ){\r\n        // ...\r\n    }\r\n}\r\n```\r\n\r\njs\r\n\r\n```js\r\nfunction pagination(page = 1, size = 10) {\r\n    console.log(page, size);\r\n}\r\n```\r\n\r\n\r\n\r\n##### åŒ¿åå‡½æ•°\r\n\r\nè¯­æ³•\r\n\r\n```js\r\n(function (å‚æ•°) {\r\n    // å‡½æ•°ä½“\r\n    return ç»“æœ;\r\n})\r\n```\r\n\r\nä¾‹\r\n\r\n```js\r\n(function(a,b){\r\n    return a + b;\r\n})\r\n```\r\n\r\nç¬¬ä¸€ç§åœºæ™¯ï¼šå®šä¹‰å®Œæ¯•åç«‹åˆ»è°ƒç”¨\r\n\r\n```js\r\n(function(a,b){\r\n    return a + b;\r\n})(1,2)\r\n```\r\n\r\nç¬¬äºŒç§åœºæ™¯ï¼šä½œä¸ºå…¶å®ƒå¯¹è±¡çš„æ–¹æ³•ï¼Œä¾‹å¦‚\r\n\r\né¡µé¢æœ‰å…ƒç´ \r\n\r\n```html\r\n<p id=\"p1\">ç‚¹æˆ‘å•Š</p>\r\n```\r\n\r\næ­¤å…ƒç´ æœ‰ä¸€ä¸ª onclick æ–¹æ³•ï¼Œä¼šåœ¨é¼ æ ‡å•å‡»è¿™ä¸ªå…ƒç´ åè¢«æ‰§è¡Œï¼Œonclick æ–¹æ³•åˆšå¼€å§‹æ˜¯ nullï¼Œéœ€è¦èµ‹å€¼åæ‰èƒ½ä½¿ç”¨\r\n\r\n```js\r\ndocument.getElementById(\"p1\").onclick = (function(){\r\n    console.log(\"é¼ æ ‡å•å‡»äº†...\");\r\n});\r\n```\r\n\r\n\r\n\r\n##### ç®­å¤´å‡½æ•°\r\n\r\n```js\r\n(å‚æ•°) => {\r\n    // å‡½æ•°ä½“\r\n    return ç»“æœ;\r\n}\r\n```\r\n\r\n* å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œ() è¿˜æ˜¯è¦ä¿ç•™\r\n* å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œ() å¯ä»¥çœç•¥\r\n* å¦‚æœå‡½æ•°ä½“å†…åªæœ‰ä¸€è¡Œä»£ç ï¼Œ{} å¯ä»¥çœç•¥\r\n* å¦‚æœè¿™ä¸€è¡Œä»£ç å°±æ˜¯ç»“æœï¼Œreturn å¯ä»¥çœç•¥\r\n\r\nä¾‹\r\n\r\n```js\r\ndocument.getElementById(\"p1\").onclick = () =>  console.log(\"aa\");\r\n```\r\n\r\n\r\n\r\n##### å‡½æ•°æ˜¯å¯¹è±¡\r\n\r\nä»¥ä¸‹å½¢å¼åœ¨ js ä¸­éå¸¸å¸¸è§ï¼\r\n\r\n1. å¯ä»¥å‚ä¸èµ‹å€¼ï¼Œä¾‹ï¼Œå…·åå‡½æ•°ä¹Ÿèƒ½å‚ä¸èµ‹å€¼\r\n\r\n```js\r\nfunction abc() {\r\n    console.log(\"bb\");\r\n}\r\n\r\ndocument.getElementById(\"p1\").onclick = abc;\r\n```\r\n\r\n\r\n\r\n2. æœ‰å±æ€§ã€æœ‰æ–¹æ³•ï¼Œæ‰§è¡Œ `console.dir(abc)`ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹\r\n\r\n```\r\nÆ’ abc()\r\n    arguments: null\r\n    caller: null\r\n    length: 0\r\n    name: \"abc\"\r\n    â¡prototype: {constructor: Æ’}\r\n    [[FunctionLocation]]: VM1962:1\r\n    â¡[[Prototype]]: Æ’ ()\r\n    â¡[[Scopes]]: Scopes[1]\r\n```\r\n\r\n* å…¶ä¸­å¸¦æœ‰ f æ ‡è®°çš„æ˜¯æ–¹æ³•ï¼Œä¸å¸¦çš„æ˜¯å±æ€§\r\n* å¸¦æœ‰ â¡ ç¬¦å·çš„å¯ä»¥ç»§ç»­å±•å¼€ï¼Œé™äºç¯‡å¹…çœç•¥äº†\r\n\r\n* å¸¦æœ‰ `[[ ]]` çš„æ˜¯å†…ç½®å±æ€§ï¼Œä¸èƒ½è®¿é—®ï¼Œåªèƒ½æŸ¥çœ‹\r\n* ç›¸å¯¹é‡è¦çš„æ˜¯ `[[Prototype]]` å’Œ `[[Scopes]]` ä¼šåœ¨åé¢ç»§æ‰¿å’Œä½œç”¨åŸŸæ—¶è®²åˆ°\r\n\r\n\r\n\r\n3. å¯ä»¥ä½œä¸ºæ–¹æ³•å‚æ•°\r\n\r\n```js\r\nfunction a() {\r\n    console.log('a')\r\n}\r\n\r\nfunction b(fn) {          // fn å°†æ¥å¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡\r\n    console.log('b')\r\n    fn();                 // è°ƒç”¨å‡½æ•°å¯¹è±¡\r\n}\r\n\r\nb(a)\r\n```\r\n\r\n\r\n\r\n4. å¯ä»¥ä½œä¸ºæ–¹æ³•è¿”å›å€¼\r\n\r\n```js\r\nfunction c() {\r\n    console.log(\"c\");\r\n    function d() {\r\n        console.log(\"d\");\r\n    }\r\n    return d;\r\n}\r\n\r\nc()()\r\n```\r\n\r\n\r\n\r\n##### å‡½æ•°ä½œç”¨åŸŸ\r\n\r\nå‡½æ•°å¯ä»¥åµŒå¥—ï¼ˆjs ä»£ç ä¸­å¾ˆå¸¸è§ï¼Œåªæ˜¯åµŒå¥—çš„å½¢å¼æ›´å¤šæ˜¯åŒ¿åå‡½æ•°ï¼Œç®­å¤´å‡½æ•°ï¼‰\r\n\r\n```js\r\nfunction a() {\r\n    function b() {        \r\n    }\r\n}\r\n```\r\n\r\nçœ‹ä¸‹é¢çš„ä¾‹å­\r\n\r\n```js\r\nfunction c() {\r\n    var z = 30;\r\n}\r\n\r\nvar x = 10;\r\nfunction a() {\r\n    var y = 20;\r\n    function b() {\r\n        // çœ‹è¿™é‡Œ\r\n        console.log(x, y);\r\n    }\r\n    b();\r\n}\r\na();\r\n```\r\n\r\n* ä»¥å‡½æ•°ä¸ºåˆ†ç•Œçº¿åˆ’å®šä½œç”¨åŸŸï¼Œæ‰€æœ‰å‡½æ•°ä¹‹å¤–æ˜¯å…¨å±€ä½œç”¨åŸŸ\r\n* æŸ¥æ‰¾å˜é‡æ—¶ï¼Œç”±å†…å‘å¤–æŸ¥æ‰¾\r\n  * åœ¨å†…å±‚ä½œç”¨åŸŸæ‰¾åˆ°å˜é‡ï¼Œå°±ä¼šåœæ­¢æŸ¥æ‰¾ï¼Œä¸ä¼šå†æ‰¾å¤–å±‚\r\n  * æ‰€æœ‰ä½œç”¨åŸŸéƒ½æ‰¾ä¸åˆ°å˜é‡ï¼ŒæŠ¥é”™\r\n* ä½œç”¨åŸŸæœ¬è´¨ä¸Šæ˜¯å‡½æ•°å¯¹è±¡çš„å±æ€§ï¼Œå¯ä»¥é€šè¿‡ console.dir æ¥æŸ¥çœ‹è°ƒè¯•\r\n\r\n\r\n\r\n##### é—­åŒ…\r\n\r\n```js\r\nvar x = 10;\r\nfunction a() {\r\n    var y = 20;\r\n    function b() {\r\n        console.log(x,y);\r\n    }\r\n    return b;\r\n}\r\na()();  // åœ¨å¤–é¢æ‰§è¡Œäº† b\r\n```\r\n\r\n* å‡½æ•°å®šä¹‰æ—¶ï¼Œå®ƒçš„ä½œç”¨åŸŸå·²ç»ç¡®å®šå¥½äº†ï¼Œå› æ­¤æ— è®ºå‡½æ•°å°†æ¥å»äº†å“ªï¼Œéƒ½èƒ½ä»å®ƒçš„ä½œç”¨åŸŸä¸­æ‰¾åˆ°å½“æ—¶é‚£äº›å˜é‡\r\n* åˆ«è¢«æ¦‚å¿µå¿½æ‚ äº†ï¼Œé—­åŒ…å°±æ˜¯æŒ‡**å‡½æ•°èƒ½å¤Ÿè®¿é—®è‡ªå·±çš„ä½œç”¨åŸŸä¸­å˜é‡**\r\n\r\n\r\n\r\n##### letã€var ä¸ä½œç”¨åŸŸ\r\n\r\nå¦‚æœå‡½æ•°å¤–å±‚å¼•ç”¨çš„æ˜¯ let å˜é‡ï¼Œé‚£ä¹ˆå¤–å±‚æ™®é€šçš„ {} ä¹Ÿä¼šä½œä¸ºä½œç”¨åŸŸè¾¹ç•Œï¼Œæœ€å¤–å±‚çš„ let ä¹Ÿå ä¸€ä¸ª script ä½œç”¨åŸŸ\r\n\r\n```js\r\nlet x = 10; \r\nif(true) {\r\n    let y = 20;\r\n    function b() {\r\n        console.log(x,y);\r\n    }\r\n    console.dir(b);\r\n}\r\n```\r\n\r\nå¦‚æœå‡½æ•°å¤–å±‚å¼•ç”¨çš„æ˜¯ var å˜é‡ï¼Œå¤–å±‚æ™®é€šçš„ {} ä¸ä¼šè§†ä¸ºè¾¹ç•Œ\r\n\r\n```js\r\nvar x = 10; \r\nif(true) {\r\n    var y = 20;\r\n    function b() {\r\n        console.log(x,y);\r\n    }\r\n    console.dir(b);\r\n}\r\n```\r\n\r\nå¦‚æœ var å˜é‡å‡ºç°äº†é‡åï¼Œåˆ™ä»–ä¿©ä¼šè¢«è§†ä¸ºåŒä¸€ä½œç”¨åŸŸä¸­çš„åŒä¸€ä¸ªå˜é‡\r\n\r\n```js\r\nvar e = 10; \r\nif(true) {\r\n    var e = 20;\r\n    console.log(e);\t// æ‰“å° 20\r\n}\r\nconsole.log(e);\t\t// å› ä¸ºæ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œè¿˜æ˜¯æ‰“å° 20\r\n```\r\n\r\nå¦‚æœæ˜¯ letï¼Œåˆ™è§†ä¸ºä¸¤ä¸ªä½œç”¨åŸŸä¸­çš„ä¸¤ä¸ªå˜é‡\r\n\r\n```js\r\nlet e = 10; \r\nif(true) {\r\n    let e = 20;\t\r\n    console.log(e);\t// æ‰“å° 20\r\n}\r\nconsole.log(e);\t\t// æ‰“å° 10\r\n```\r\n\r\nè¦æƒ³é‡Œé¢çš„ e å’Œå¤–é¢çš„ e èƒ½åŒºåˆ†å¼€æ¥ï¼Œæœ€ç®€å•çš„åŠæ³•æ˜¯æ”¹æˆ letï¼Œæˆ–è€…ç”¨å‡½æ•°æ¥ç•Œå®šä½œç”¨åŸŸèŒƒå›´\r\n\r\n```js\r\nvar e = 10; \r\nif(true) {\r\n    function b() {\r\n        var e = 20;\r\n    \tconsole.log(e);\r\n    }\r\n    b();\r\n}\r\nconsole.log(e);\t\r\n```\r\n\r\n\r\n\r\n#### 2) Array :star:\r\n\r\nè¯­æ³•\r\n\r\n```js\r\n// åˆ›å»ºæ•°ç»„\r\nlet arr = [1,2,3]; \r\n\r\n// è·å–æ•°ç»„å…ƒç´ \r\nconsole.log(arr[0]); // è¾“å‡º 1\r\n\r\n// ä¿®æ”¹æ•°ç»„å…ƒç´ \r\narray[0] = 5;\t\t // æ•°ç»„å…ƒç´ å˜æˆäº† [5,2,3]\r\n\r\n// éå†æ•°ç»„å…ƒç´ ï¼Œå…¶ä¸­ length æ˜¯æ•°ç»„å±æ€§ï¼Œä»£è¡¨æ•°ç»„é•¿åº¦\r\nfor(let i = 0; i < arr.length; i++) {\r\n    console.log(arr[i]);\r\n}\r\n```\r\n\r\nAPI\r\n\r\n* pushã€shiftã€splice\r\n\r\n```js\r\nlet arr = [1,2,3]; \r\n\r\narr.push(4);    \t// å‘æ•°ç»„å°¾éƒ¨(å³ä¾§)æ·»åŠ å…ƒç´ , ç»“æœ [1,2,3,4]\r\narr.shift();\t\t// ä»æ•°ç»„å¤´éƒ¨(å·¦ä¾§)ç§»é™¤å…ƒç´ , ç»“æœ [2,3,4]\r\narr.splice(1,1);\t// åˆ é™¤ã€å‚æ•°1ã€‘ç´¢å¼•ä½ç½®çš„ã€å‚æ•°2ã€‘ä¸ªå…ƒç´ ï¼Œç»“æœ [2,4]\r\n```\r\n\r\n* join\r\n\r\n```js\r\nlet arr = ['a','b','c'];\r\n\r\narr.join(); \t\t// é»˜è®¤ä½¿ç”¨ã€,ã€‘ä½œä¸ºè¿æ¥ç¬¦ï¼Œç»“æœ 'a,b,c'\r\narr.join('');\t\t// ç»“æœ 'abc'\r\narr.join('-');\t\t// ç»“æœ 'a-b-c'\r\n```\r\n\r\n* mapã€filterã€forEach\r\n\r\n```js\r\nlet arr = [1,2,3,6];\r\n\r\nfunction a(i) {   // ä»£è¡¨çš„æ–°æ—§å…ƒç´ ä¹‹é—´çš„å˜æ¢è§„åˆ™\r\n    return i * 10\r\n}\r\n\r\n// arr.map(a) // å…·åå‡½æ•°ï¼Œç»“æœ [10,20,30,60]\r\n\r\n// arr.map( (i) => {return i * 10} ); // ç®­å¤´å‡½æ•°\r\narr.map( i => i * 10 ); // ç®­å¤´å‡½æ•°\r\n```\r\n\r\n* ä¼ ç»™ map çš„å‡½æ•°ï¼Œå‚æ•°ä»£è¡¨æ—§å…ƒç´ ï¼Œè¿”å›å€¼ä»£è¡¨æ–°å…ƒç´ \r\n\r\nmap çš„å†…éƒ¨å®ç°ï¼ˆä¼ªä»£ç ï¼‰\r\n\r\n```js\r\nfunction map(a) { // å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°\r\n    let narr = [];\r\n    for(let i = 0; i < arr.length; i++) {\r\n        let o = arr[i]; // æ—§å…ƒç´ \r\n        let n = a(o);   // æ–°å…ƒç´ \r\n        narr.push(n);\r\n    }\r\n    return narr;\r\n} \r\n```\r\n\r\nfilter ä¾‹å­\r\n\r\n```js\r\nlet arr = [1,2,3,6];\r\narr.filter( (i)=> i % 2 == 1 ); // ç»“æœ [1,3]\r\n```\r\n\r\n* ä¼ ç»™ filter çš„å‡½æ•°ï¼Œå‚æ•°ä»£è¡¨æ—§å…ƒç´ ï¼Œè¿”å› true è¡¨ç¤ºè¦ç•™ä¸‹çš„å…ƒç´ \r\n\r\nforEach ä¾‹å­\r\n\r\n```js\r\nlet arr = [1,2,3,6];\r\n\r\n/*for(let i = 0; i < arr.length; i++) {\r\n    console.log(arr[i]);\r\n}*/\r\n\r\narr.forEach( (i) => console.log(i) );\r\n```\r\n\r\nä¸¤ä¸ªç§°å‘¼\r\n\r\n* é«˜é˜¶å‡½æ•°ï¼Œmapï¼Œfilterï¼ŒforEach\r\n* å›è°ƒå‡½æ•°ï¼Œä¾‹å¦‚ä½œä¸ºå‚æ•°ä¼ å…¥çš„å‡½æ•°\r\n\r\n\r\n\r\n#### 3) Object :star::star:\r\n\r\n##### è¯­æ³•\r\n\r\n```js\r\nlet obj = {\r\n    å±æ€§å: å€¼,\r\n    æ–¹æ³•å: å‡½æ•°,\r\n    get å±æ€§å() {},\r\n    set å±æ€§å(æ–°å€¼) {}\r\n}\r\n```\r\n\r\nä¾‹1\r\n\r\n```js\r\nlet stu1 = {\r\n    name: \"å°æ˜\",\r\n    age: 18,\r\n    study: function(){\r\n        console.log(this.name + \"çˆ±å­¦ä¹ \");\r\n    }    \r\n}\r\n```\r\n\r\nä¾‹2\r\n\r\n```js\r\nlet name = \"å°é»‘\";\r\nlet age = 20;\r\nlet study = function(){\r\n    console.log(this.name + \"çˆ±å­¦ä¹ \");\r\n}\r\n\r\nlet stu2 = { name, age, study }\r\n```\r\n\r\nä¾‹3ï¼ˆé‡ç‚¹ï¼‰\r\n\r\n```js\r\nlet stu3 = {\r\n    name: \"å°ç™½\",\r\n    age: 18,\r\n    study(){\r\n        console.log(this.name + \"çˆ±å­¦ä¹ \");\r\n    }    \r\n}\r\n```\r\n\r\n* **æ³¨æ„**ï¼šå¯¹è±¡æ–¹æ³•è¿™ä¹ˆå†™ï¼Œä»…é™äºå¯¹è±¡å†…éƒ¨\r\n\r\nä¾‹4\r\n\r\n```js\r\nlet stu4 = {\r\n    _name: null, /*ç±»ä¼¼äºjavaä¸­ç§æœ‰æˆå‘˜å˜é‡*/\r\n    get name() {\r\n        console.log(\"è¿›å…¥äº†get\");\r\n        return this._name;\r\n    },\r\n    set name(name) {\r\n        console.log(\"è¿›å…¥äº†set\");\r\n        this._name = name;\r\n    }\r\n}\r\n```\r\n\r\nè°ƒç”¨ getï¼Œset\r\n\r\n```js\r\nstu4.name = \"å°ç™½\"\r\n\r\nconsole.log(stu4.name)\r\n```\r\n\r\n\r\n\r\n##### ç‰¹è‰²ï¼šå±æ€§å¢åˆ \r\n\r\nå¯¹æ¯”ä¸€ä¸‹ Java ä¸­çš„ Object\r\n\r\n* Java çš„ Object æ˜¯ä»¥ç±»ä½œä¸ºæ¨¡æ¿æ¥åˆ›å»ºï¼Œå¯¹è±¡ä¸èƒ½è„±ç¦»ç±»æ¨¡æ¿çš„èŒƒå›´ï¼Œä¸€ä¸ªå¯¹è±¡çš„å±æ€§ã€èƒ½ç”¨çš„æ–¹æ³•éƒ½æ˜¯ç¡®å®šå¥½çš„\r\n* js çš„å¯¹è±¡ï¼Œä¸éœ€è¦ä»€ä¹ˆæ¨¡æ¿ï¼Œå®ƒçš„å±æ€§å’Œæ–¹æ³•å¯ä»¥éšæ—¶åŠ å‡\r\n\r\n```js\r\nlet stu = {name:'å¼ ä¸‰'};\r\nstu.age = 18;\t\t\t\t\t// æ·»åŠ å±æ€§\r\ndelete stu.age;\t\t\t\t\t// åˆ é™¤å±æ€§\r\n\r\nstu.study = function() {\t\t// æ·»åŠ æ–¹æ³•\r\n    console.log(this.name + \"åœ¨å­¦ä¹ \");\r\n}\r\n```\r\n\r\næ·»åŠ  getï¼Œsetï¼Œéœ€è¦å€ŸåŠ© Object.definePropery\r\n\r\n```js\r\nlet stu = {_name:null};\r\n\r\nObject.defineProperty(stu, \"name\", {\r\n    get(){\r\n        return this._name;\r\n    },\r\n    set(name){\r\n        this._name = name;\r\n    }\r\n});\r\n```\r\n\r\n* å‚æ•°1ï¼šç›®æ ‡å¯¹è±¡\r\n* å‚æ•°2ï¼šå±æ€§å\r\n* å‚æ•°3ï¼šgetï¼Œset çš„å®šä¹‰\r\n\r\n\r\n\r\n##### ç‰¹è‰²ï¼šthis\r\n\r\nå…ˆæ¥å¯¹ Java ä¸­çš„ this æœ‰ä¸ªç†è§£\r\n\r\n```java\r\npublic class TestMethod {\r\n\r\n    static class Student {\r\n        private String name;\r\n\r\n        public Student(String name) {\r\n            this.name = name;\r\n        }\r\n\r\n        public void study(Student this, String subject) {\r\n            System.out.println(this.name + \"åœ¨å­¦ä¹  \" + subject);\r\n        }\r\n    }\r\n\r\n    public static void main(String[] args) {\r\n        Student stu = new Student(\"å°æ˜\");\r\n        \r\n        // ä¸‹é¢çš„ä»£ç ï¼Œæœ¬è´¨ä¸Šæ˜¯æ‰§è¡Œ study(stu, \"java\")ï¼Œå› æ­¤ this å°±æ˜¯ stu\r\n        stu.study(\"java\"); \r\n    }\r\n}\r\n```\r\n\r\n* Java ä¸­çš„ this æ˜¯ä¸ªéšå¼å‚æ•°\r\n* Java ä¸­ï¼Œæˆ‘ä»¬è¯´ this ä»£è¡¨çš„å°±æ˜¯è°ƒç”¨æ–¹æ³•çš„é‚£ä¸ªå¯¹è±¡\r\n\r\n\r\n\r\njs ä¸­çš„ this ä¹Ÿæ˜¯éšå¼å‚æ•°ï¼Œä½†å®ƒä¸å‡½æ•°è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ç›¸å…³\r\n\r\nä¾‹å¦‚ï¼Œä¸€ä¸ªâ€œè½å•â€çš„å‡½æ•°\r\n\r\n```js\r\nfunction study(subject) {\r\n    console.log(this.name + \"åœ¨å­¦ä¹  \" + subject)\r\n}\r\n```\r\n\r\næµ‹è¯•ä¸€ä¸‹\r\n\r\n```js\r\nstudy(\"js\");  // è¾“å‡º åœ¨å­¦ä¹  js\r\n```\r\n\r\nè¿™æ˜¯å› ä¸ºæ­¤æ—¶å‡½æ•°æ‰§è¡Œï¼Œå…¨å±€å¯¹è±¡ window è¢«å½“ä½œäº† thisï¼Œwindow å¯¹è±¡çš„ name å±æ€§æ˜¯ç©ºä¸²\r\n\r\n\r\n\r\nåŒæ ·çš„å‡½æ•°ï¼Œå¦‚æœä½œä¸ºå¯¹è±¡çš„æ–¹æ³•\r\n\r\n```js\r\nlet stu = {\r\n    name:\"å°ç™½\",\r\n    study\r\n}\r\n```\r\n\r\nè¿™ç§æƒ…å†µä¸‹ï¼Œä¼šå°†å½“å‰å¯¹è±¡ä½œä¸º this\r\n\r\n```js\r\nstu.study('js'); \t// è¾“å‡º å°ç™½åœ¨å­¦ä¹  js\r\n```\r\n\r\n\r\n\r\nè¿˜å¯ä»¥åŠ¨æ€æ”¹å˜ this\r\n\r\n```js\r\nlet stu = {name:\"å°é»‘\"};\r\nstudy.call(stu, \"js\");\t// è¾“å‡º å°é»‘åœ¨å­¦ä¹  js\r\n```\r\n\r\nè¿™å› study æ‰§è¡Œæ—¶ï¼Œå°±æŠŠ call çš„ç¬¬ä¸€ä¸ªå‚æ•° stu ä½œä¸º this\r\n\r\n\r\n\r\nä¸€ä¸ªä¾‹å¤–æ˜¯ï¼Œåœ¨**ç®­å¤´å‡½æ•°**å†…å‡ºç°çš„ thisï¼Œä»¥å¤–å±‚ this ç†è§£ \r\n\r\nç”¨åŒ¿åå‡½æ•°\r\n\r\n```js\r\nlet stu = {\r\n    name: \"å°èŠ±\",\r\n    friends: [\"å°ç™½\",\"å°é»‘\",\"å°æ˜\"],\r\n    play() {\r\n        this.friends.forEach(function(e){\r\n            console.log(this.name + \"ä¸\" + e + \"åœ¨ç©è€\");\r\n        });\r\n    }\r\n}\r\nstu.play()\r\n```\r\n\r\n* this.name æ‰€åœ¨çš„å‡½æ•°æ˜¯ã€è½å•ã€‘çš„å‡½æ•°ï¼Œå› æ­¤ this ä»£è¡¨ window\r\n\r\nè¾“å‡ºç»“æœä¸º\r\n\r\n```\r\nä¸å°ç™½åœ¨ç©è€\r\nä¸å°é»‘åœ¨ç©è€\r\nä¸å°æ˜åœ¨ç©è€\r\n```\r\n\r\nç”¨ç®­å¤´å‡½æ•°\r\n\r\n```js\r\nlet stu = {\r\n    name: \"å°èŠ±\",\r\n    friends: [\"å°ç™½\",\"å°é»‘\",\"å°æ˜\"],\r\n    play() {\r\n        this.friends.forEach(e => {\r\n            console.log(this.name + \"ä¸\" + e + \"åœ¨ç©è€\");\r\n        })\r\n    }    \r\n}\r\n```\r\n\r\n* this.name æ‰€åœ¨çš„å‡½æ•°æ˜¯ç®­å¤´å‡½æ•°ï¼Œå› æ­¤ this è¦çœ‹å®ƒå¤–å±‚çš„ play å‡½æ•°ï¼Œplay åˆæ˜¯å±äº stu çš„æ–¹æ³•ï¼Œå› æ­¤ this ä»£è¡¨ stu å¯¹è±¡\r\n\r\nè¾“å‡ºç»“æœä¸º\r\n\r\n```\r\nå°èŠ±ä¸å°ç™½åœ¨ç©è€\r\nå°èŠ±ä¸å°é»‘åœ¨ç©è€\r\nå°èŠ±ä¸å°æ˜åœ¨ç©è€\r\n```\r\n\r\nä¸ç”¨ç®­å¤´å‡½æ•°çš„åšæ³•\r\n\r\n```js\r\nlet stu = {\r\n    name: \"å°èŠ±\",\r\n    friends: [\"å°ç™½\",\"å°é»‘\",\"å°æ˜\"],\r\n    play() {\r\n        let me = this;\r\n        this.friends.forEach(function(e){\r\n            console.log(me.name + \"ä¸\" + e + \"åœ¨ç©è€\");\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n##### ç‰¹è‰²ï¼šåŸå‹ç»§æ‰¿\r\n\r\n```js\r\nlet father = {\r\n    f1: 'çˆ¶å±æ€§',\r\n    m1: function() {\r\n        console.log(\"çˆ¶æ–¹æ³•\");\r\n    }\r\n}\r\n\r\nlet son = Object.create(father);\r\n\r\nconsole.log(son.f1);  // æ‰“å° çˆ¶å±æ€§\r\nson.m1();\t\t\t  // æ‰“å° çˆ¶æ–¹æ³•\r\n```\r\n\r\n* father æ˜¯çˆ¶å¯¹è±¡ï¼Œson å»è°ƒç”¨ .m1 æˆ– .f1 æ—¶ï¼Œè‡ªèº«å¯¹è±¡æ²¡æœ‰ï¼Œå°±åˆ°çˆ¶å¯¹è±¡æ‰¾\r\n* son è‡ªå·±å¯ä»¥æ·»åŠ è‡ªå·±çš„å±æ€§å’Œæ–¹æ³•\r\n* son é‡Œæœ‰ç‰¹æ®Šå±æ€§ `__proto__` ä»£è¡¨å®ƒçš„çˆ¶å¯¹è±¡ï¼Œjs æœ¯è¯­ï¼š son çš„åŸå‹å¯¹è±¡\r\n* ä¸åŒæµè§ˆå™¨å¯¹æ‰“å° son çš„ `__proto__` å±æ€§æ—¶æ˜¾ç¤ºä¸åŒ\r\n  * Edge æ‰“å° console.dir(son) æ˜¾ç¤º `[[Prototype]]`\r\n  * Firefox æ‰“å° console.dir(son) æ˜¾ç¤º `<prototype>`\r\n\r\n\r\n\r\n##### ç‰¹è‰²ï¼šåŸºäºå‡½æ•°çš„åŸå‹ç»§æ‰¿\r\n\r\nå‡ºäºæ–¹ä¾¿çš„åŸå› ï¼Œjs åˆæä¾›äº†ä¸€ç§åŸºäºå‡½æ•°çš„åŸå‹ç»§æ‰¿\r\n\r\n> **å‡½æ•°èŒè´£**\r\n>\r\n> 1. è´Ÿè´£åˆ›å»ºå­å¯¹è±¡ï¼Œç»™å­å¯¹è±¡æä¾›å±æ€§ã€æ–¹æ³•ï¼ŒåŠŸèƒ½ä¸Šç›¸å½“äºæ„é€ æ–¹æ³•\r\n>\r\n> 3. å‡½æ•°æœ‰ä¸ªç‰¹æ®Šçš„å±æ€§ prototypeï¼Œå®ƒå°±æ˜¯å‡½æ•°åˆ›å»ºçš„å­å¯¹è±¡çš„çˆ¶å¯¹è±¡\r\n>\r\n>    **æ³¨æ„ï¼**åå­—æœ‰å·®å¼‚ï¼Œè¿™ä¸ªå±æ€§çš„ä½œç”¨å°±æ˜¯ä¸ºæ–°å¯¹è±¡æä¾›åŸå‹\r\n\r\n```js\r\nfunction cons(f2) {\r\n    // åˆ›å»ºå­å¯¹è±¡(this), ç»™å­å¯¹è±¡æä¾›å±æ€§å’Œæ–¹æ³•\r\n    this.f2 = f2;\r\n    this.m2 = function () {\r\n        console.log(\"å­æ–¹æ³•\");\r\n    }\r\n}\r\n// cons.prototype å°±æ˜¯çˆ¶å¯¹è±¡\r\ncons.prototype.f1 = \"çˆ¶å±æ€§\";\r\ncons.prototype.m1 = function() {\r\n    console.log(\"çˆ¶æ–¹æ³•\");\r\n}\r\n```\r\n\r\né…åˆ new å…³é”®å­—ï¼Œåˆ›å»ºå­å¯¹è±¡\r\n\r\n```js\r\nlet son = new cons(\"å­å±æ€§\")\r\n```\r\n\r\nå­å¯¹è±¡çš„ `__proto__` å°±æ˜¯å‡½æ•°çš„ `prototype` å±æ€§\r\n\r\n\r\n\r\n##### JSON\r\n\r\nä¹‹å‰æˆ‘ä»¬è®² http è¯·æ±‚æ ¼å¼æ—¶ï¼Œè®²è¿‡ json è¿™ç§æ•°æ®æ ¼å¼ï¼Œå®ƒçš„è¯­æ³•çœ‹èµ·æ¥ä¸ js å¯¹è±¡éå¸¸ç›¸ä¼¼ï¼Œä¾‹å¦‚ï¼š\r\n\r\nä¸€ä¸ª json å¯¹è±¡å¯ä»¥é•¿è¿™æ ·ï¼š\r\n\r\n```json\r\n{\r\n    \"name\":\"å¼ ä¸‰\",\r\n    \"age\":18\r\n}\r\n```\r\n\r\nä¸€ä¸ª js å¯¹è±¡é•¿è¿™æ ·ï¼š\r\n\r\n```js\r\n{\r\n    name:\"å¼ ä¸‰\",\r\n    age:18\r\n}\r\n```\r\n\r\né‚£ä¹ˆä»–ä»¬çš„åŒºåˆ«åœ¨å“ªå„¿å‘¢ï¼Ÿæˆ‘æ€»ç»“äº†è¿™ä¹ˆå‡ ç‚¹\r\n\r\n1. æœ¬è´¨ä¸åŒ\r\n   * json å¯¹è±¡æœ¬è´¨ä¸Šæ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒçš„èŒè´£æ˜¯ä½œä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ é€’æ•°æ®çš„ä¸€ç§æ ¼å¼ï¼Œå®ƒçš„å±æ€§åªæ˜¯æ ·å­è´§\r\n   * js å¯¹è±¡æ˜¯åˆ‡åˆ‡å®å®çš„å¯¹è±¡ï¼Œå¯ä»¥æœ‰å±æ€§æ–¹æ³•\r\n2. è¯­æ³•ç»†èŠ‚ä¸åŒ\r\n   * json ä¸­åªèƒ½æœ‰ nullã€true|falseã€æ•°å­—ã€å­—ç¬¦ä¸²ï¼ˆåªæœ‰åŒå¼•å·ï¼‰ã€å¯¹è±¡ã€æ•°ç»„\r\n   * json ä¸­ä¸èƒ½æœ‰é™¤ä»¥ä¸Šçš„å…¶å®ƒ js å¯¹è±¡çš„ç‰¹æ€§ï¼Œå¦‚æ–¹æ³•ç­‰\r\n   * json ä¸­çš„å±æ€§å¿…é¡»ç”¨åŒå¼•å·å¼•èµ·æ¥\r\n\r\n\r\n\r\njson å­—ç¬¦ä¸²ä¸ js å¯¹è±¡çš„è½¬æ¢\r\n\r\n```js\r\nJSON.parse(jsonå­—ç¬¦ä¸²);  // è¿”å›jså¯¹è±¡\r\nJSON.stringify(jså¯¹è±¡);  // è¿”å›jsonå­—ç¬¦ä¸²\r\n```\r\n\r\n\r\n\r\n### åŠ¨æ€ç±»å‹\r\n\r\né™æ€ç±»å‹è¯­è¨€ï¼Œå¦‚ Javaï¼Œå€¼æœ‰ç±»å‹ï¼Œå˜é‡ä¹Ÿæœ‰ç±»å‹ã€èµ‹å€¼ç»™å˜é‡æ—¶ï¼Œç±»å‹è¦ç›¸ç¬¦\r\n\r\n```java\r\nint a = 10;\r\nString b = \"abc\";\r\n\r\nint c = \"abc\";  // é”™è¯¯\r\n```\r\n\r\nè€Œ js å±äºåŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå€¼æœ‰ç±»å‹ï¼Œä½†å˜é‡æ²¡æœ‰ç±»å‹ï¼Œèµ‹å€¼ç»™å˜é‡æ—¶ï¼Œæ²¡è¦æ±‚\r\n\r\nä¾‹å¦‚\r\n\r\n```js\r\nlet a = 200;\r\n\r\nlet b = 100;\r\nb = 'abc';\r\nb = true;\r\n```\r\n\r\nåŠ¨æ€ç±»å‹çœ‹èµ·æ¥æ¯”è¾ƒçµæ´»ï¼Œä½†å˜é‡æ²¡æœ‰ç±»å‹ï¼Œä¼šç»™åæœŸç»´æŠ¤å¸¦æ¥å›°éš¾ï¼Œä¾‹å¦‚\r\n\r\n```js\r\nfunction test(obj) {\r\n    // obj çš„ç±»å‹æœªçŸ¥ï¼Œå¿…é¡»æ ¹æ®ä¸åŒç±»å‹åšå‡ºç›¸åº”çš„å®¹é”™å¤„ç†\r\n}\r\n```\r\n\r\n\r\n\r\n## 2. è¿ç®—ç¬¦ä¸è¡¨è¾¾å¼\r\n\r\n* `+ - * / % ** `\r\n* `+= -= *= /= %= **=`\r\n* `++ --`\r\n* ä½è¿ç®—ã€ç§»ä½è¿ç®—\r\n* `== != > >= < <=`\r\n* `=== !==` :star:\r\n* `&& || !` :star:\r\n* `?? ?.` :star:\r\n* `...` :star:\r\n* è§£æ„èµ‹å€¼ :star:\r\n\r\n\r\n\r\n### 1) ===\r\n\r\nä¸¥æ ¼ç›¸ç­‰è¿ç®—ç¬¦ï¼Œç”¨ä½œé€»è¾‘åˆ¤ç­‰\r\n\r\n```js\r\n1 == 1    \t// è¿”å› true \r\n1 == '1'\t// è¿”å› trueï¼Œä¼šå…ˆå°†å³ä¾§çš„å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—ï¼Œå†åšæ¯”è¾ƒ\r\n1 === '1'\t// è¿”å› falseï¼Œç±»å‹ä¸ç­‰ï¼Œç›´æ¥è¿”å› false\r\n```\r\n\r\ntypeof æŸ¥çœ‹æŸä¸ªå€¼çš„ç±»å‹\r\n\r\n```js\r\ntypeof 1\t// è¿”å› 'number'\r\ntypeof '1'\t// è¿”å› 'string'\r\n```\r\n\r\n\r\n\r\n### 2) ||\r\n\r\néœ€æ±‚ï¼Œå¦‚æœå‚æ•° n æ²¡æœ‰ä¼ é€’ï¼Œç»™å®ƒä¸€ä¸ªã€ç”·ã€‘\r\n\r\n**æ¨è**åšæ³•\r\n\r\n```js\r\nfunction test(n = 'ç”·') {\r\n    console.log(n);\r\n}\r\n```\r\n\r\nä½ å¯èƒ½çš„åšæ³•\r\n\r\n```js\r\nfunction test(n) {\r\n    if(n === undefined) {\r\n        n = 'ç”·';\r\n    }\r\n    console.log(n);\r\n}\r\n```\r\n\r\nè¿˜å¯èƒ½æ˜¯è¿™æ ·\r\n\r\n```js\r\nfunction test(n) {\r\n    n = (n === undefined) ? 'ç”·' : n;\r\n    console.log(n);\r\n}\r\n```\r\n\r\nä¸€äº›è€æ—§ä»£ç ä¸­å¯èƒ½çš„åšæ³•ï¼ˆä¸æ¨èï¼‰\r\n\r\n```js\r\nfunction test(n) {\r\n    n = n || 'ç”·';\r\n    console.log(n);\r\n}\r\n```\r\n\r\nå®ƒçš„è¯­æ³•æ˜¯\r\n\r\n```js\r\nå€¼1 || å€¼2\r\n```\r\n\r\nå¦‚æœå€¼1 æ˜¯ Truthyï¼Œè¿”å›å€¼1ï¼Œå¦‚æœå€¼1 æ˜¯ Falsy è¿”å›å€¼ 2\r\n\r\n\r\n\r\n### 3) ?? ä¸ ?.\r\n\r\n#### ??\r\n\r\néœ€æ±‚ï¼Œå¦‚æœå‚æ•° n æ²¡æœ‰ä¼ é€’æˆ–æ˜¯ nullï¼Œç»™å®ƒä¸€ä¸ªã€ç”·ã€‘\r\n\r\nå¦‚æœç”¨ä¼ ç»ŸåŠæ³•\r\n\r\n```js\r\nfunction test(n) {\r\n    if(n === undefined || n === null) {\r\n        n = 'ç”·';\r\n    }\r\n    console.log(n);\r\n}\r\n```\r\n\r\nç”¨ ??\r\n\r\n```js\r\nfunction test(n) {\r\n    n = n ?? 'ç”·';\r\n    console.log(n);\r\n}\r\n```\r\n\r\nè¯­æ³•\r\n\r\n```\r\nå€¼1 ?? å€¼2\r\n```\r\n\r\n* å€¼1 æ˜¯ nullishï¼Œè¿”å›å€¼2\r\n* å€¼1 ä¸æ˜¯ nullishï¼Œè¿”å›å€¼1\r\n\r\n\r\n\r\n#### ?.\r\n\r\néœ€æ±‚ï¼Œå‡½æ•°å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯èƒ½åŒ…å«æœ‰å­å±æ€§\r\n\r\nä¾‹å¦‚ï¼Œå‚æ•°å¯èƒ½æ˜¯\r\n\r\n```js\r\nlet stu1 = {\r\n    name:\"å¼ ä¸‰\",\r\n    address: {\r\n        city: 'åŒ—äº¬'\r\n    }\r\n};\r\n\r\nlet stu2 = {\r\n    name:\"æå››\"\r\n}\r\n\r\nlet stu3 = {\r\n    name:\"æå››\",\r\n    address: null\r\n}\r\n```\r\n\r\nç°åœ¨è¦è®¿é—®å­å±æ€§ï¼ˆæœ‰é—®é¢˜ï¼‰\r\n\r\n```js\r\nfunction test(stu) {\r\n    console.log(stu.address.city)\r\n}\r\n```\r\n\r\nç°åœ¨å¸Œæœ›å½“æŸä¸ªå±æ€§æ˜¯ nullish æ—¶ï¼ŒçŸ­è·¯å¹¶è¿”å› undefinedï¼Œå¯ä»¥ç”¨ ?.\r\n\r\n```js\r\nfunction test(stu) {\r\n    console.log(stu.address?.city)\r\n}\r\n```\r\n\r\nç”¨ä¼ ç»ŸåŠæ³• \r\n\r\n```js\r\nfunction test(stu) {\r\n    if(stu.address === undefined || stu.address === null) {\r\n        console.log(undefined);\r\n        return;\r\n    }\r\n    console.log(stu.address.city)\r\n}\r\n```\r\n\r\n\r\n\r\n### 4) ...\r\n\r\nå±•å¼€è¿ç®—ç¬¦\r\n\r\nä½œç”¨1ï¼šæ‰“æ•£æ•°ç»„ï¼ŒæŠŠå…ƒç´ ä¼ é€’ç»™å¤šä¸ªå‚æ•°\r\n\r\n```js\r\nlet arr = [1,2,3];\r\n\r\nfunction test(a,b,c) {\r\n    console.log(a,b,c);\r\n}\r\n```\r\n\r\néœ€æ±‚ï¼ŒæŠŠæ•°ç»„å…ƒç´ ä¾æ¬¡ä¼ é€’ç»™å‡½æ•°å‚æ•°\r\n\r\nä¼ ç»Ÿå†™æ³•\r\n\r\n```js\r\ntest(arr[0],arr[1],arr[2]);\t\t// è¾“å‡º 1,2,3\r\n```\r\n\r\nå±•å¼€è¿ç®—ç¬¦å†™æ³•\r\n\r\n```js\r\ntest(...arr);\t\t\t\t\t// è¾“å‡º 1,2,3\r\n```\r\n\r\n* æ‰“æ•£å¯ä»¥ç†è§£ä¸ºã€å»æ‰äº†ã€‘æ•°ç»„å¤–ä¾§çš„ä¸­æ‹¬å·ï¼Œåªå‰©ä¸‹æ•°ç»„å…ƒç´ \r\n\r\n\r\n\r\nä½œç”¨2ï¼šå¤åˆ¶æ•°ç»„æˆ–å¯¹è±¡\r\n\r\næ•°ç»„\r\n\r\n```js\r\nlet arr1 = [1,2,3];\r\nlet arr2 = [...arr1];\t\t// å¤åˆ¶æ•°ç»„\r\n```\r\n\r\nå¯¹è±¡\r\n\r\n```js\r\nlet obj1 = {name:'å¼ ä¸‰', age: 18};\r\n\r\nlet obj2 = {...obj1};\t\t// å¤åˆ¶å¯¹è±¡\r\n```\r\n\r\n**æ³¨æ„**ï¼šå±•å¼€è¿ç®—ç¬¦å¤åˆ¶å±äºæµ…æ‹·è´ï¼Œä¾‹å¦‚\r\n\r\n```js\r\nlet o1 = {name:'å¼ ä¸‰', address: {city: 'åŒ—äº¬'} }\r\n\r\nlet o2 = {...o1};\r\n```\r\n\r\n\r\n\r\nä½œç”¨3ï¼šåˆå¹¶æ•°ç»„æˆ–å¯¹è±¡\r\n\r\nåˆå¹¶æ•°ç»„\r\n\r\n```js\r\nlet a1 = [1,2];\r\nlet a2 = [3,4];\r\n\r\nlet b1 = [...a1,...a2];\t\t// ç»“æœ [1,2,3,4]\r\nlet b2 = [...a2,5,...a1]\t// ç»“æœ [3,4,5,1,2]\r\n```\r\n\r\nåˆå¹¶å¯¹è±¡\r\n\r\n```js\r\nlet o1 = {name:'å¼ ä¸‰'};\r\nlet o2 = {age:18};\r\nlet o3 = {name:'æå››'};\r\n\r\nlet n1 = {...o1, ...o2};\t// ç»“æœ {name:'å¼ ä¸‰',age:18}\r\n\r\nlet n2 = {...o3, ...o2, ...o1}; // ç»“æœ{name:'æå››',age:18}\r\n```\r\n\r\n* å¤åˆ¶å¯¹è±¡æ—¶å‡ºç°åŒåå±æ€§ï¼Œåé¢çš„ä¼šè¦†ç›–å‰é¢çš„\r\n\r\n\r\n\r\n### 5) [] {}\r\n\r\nè§£æ„èµ‹å€¼\r\n\r\n#### []\r\n\r\nç”¨åœ¨å£°æ˜å˜é‡æ—¶\r\n\r\n```js\r\nlet arr = [1,2,3];\r\n\r\nlet [a, b, c] = arr;\t// ç»“æœ a=1, b=2, c=3\r\n```\r\n\r\nç”¨åœ¨å£°æ˜å‚æ•°æ—¶\r\n\r\n```js\r\nlet arr = [1,2,3];\r\n\r\nfunction test([a,b,c]) {\r\n    console.log(a,b,c) \t// ç»“æœ a=1, b=2, c=3\r\n}\r\n\r\ntest(arr);\t\t\t\t\r\n```\r\n\r\n\r\n\r\n#### {}\r\n\r\nç”¨åœ¨å£°æ˜å˜é‡æ—¶\r\n\r\n```js\r\nlet obj = {name:\"å¼ ä¸‰\", age:18};\r\n\r\nlet {name,age} = obj;\t// ç»“æœ name=å¼ ä¸‰, age=18\r\n```\r\n\r\nç”¨åœ¨å£°æ˜å‚æ•°æ—¶\r\n\r\n```js\r\nlet obj = {name:\"å¼ ä¸‰\", age:18};\r\n\r\nfunction test({name, age}) {\r\n    console.log(name, age); // ç»“æœ name=å¼ ä¸‰, age=18\r\n}\r\n\r\ntest(obj)\r\n```\r\n\r\n\r\n\r\n## 3. æ§åˆ¶è¯­å¥\r\n\r\n* `if ... else`\r\n* `switch`\r\n* `while`\r\n* `do ... while`\r\n* `for` \r\n* `for ... in` :star:\r\n* `for ... of` :star:\r\n* `try ... catch` :star:\r\n\r\n\r\n\r\n### 1) for in\r\n\r\nä¸»è¦ç”¨æ¥éå†å¯¹è±¡\r\n\r\n```js\r\nlet father = {name:'å¼ ä¸‰', age:18, study:function(){}};\r\n\r\nfor(const n in father) {\r\n    console.log(n);\r\n}\r\n```\r\n\r\n* å…¶ä¸­ const n ä»£è¡¨éå†å‡ºæ¥çš„å±æ€§å\r\n* æ³¨æ„1ï¼šæ–¹æ³•åä¹Ÿèƒ½è¢«éå†å‡ºæ¥ï¼ˆå®ƒå…¶å®ä¹Ÿç®—ä¸€ç§ç‰¹æ®Šå±æ€§ï¼‰\r\n* æ³¨æ„2ï¼šéå†å­å¯¹è±¡æ—¶ï¼Œçˆ¶å¯¹è±¡çš„å±æ€§ä¼šè·Ÿç€éå†å‡ºæ¥\r\n\r\n```js\r\nlet son = Object.create(father);\r\nson.sex = \"ç”·\";\r\n\r\nfor(const n in son) {\r\n    console.log(n);\r\n}\r\n```\r\n\r\n* æ³¨æ„3ï¼šåœ¨ for in å†…è·å–å±æ€§å€¼ï¼Œè¦ä½¿ç”¨ [] è¯­æ³•ï¼Œè€Œä¸èƒ½ç”¨ . è¯­æ³•\r\n\r\n```js\r\nfor(const n in son) {\r\n    console.log(n, son[n]);\r\n}\r\n```\r\n\r\n\r\n\r\n### 2) for of\r\n\r\nä¸»è¦ç”¨æ¥éå†æ•°ç»„ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒå¯è¿­ä»£å¯¹è±¡ï¼Œå¦‚ Mapï¼ŒSet ç­‰\r\n\r\n```js\r\nlet a1 = [1,2,3];\r\n\r\nfor(const i of a1) {\r\n    console.log(i);\r\n}\r\n\r\nlet a2 = [\r\n    {name:'å¼ ä¸‰', age:18},\r\n    {name:'æå››', age:20},\r\n    {name:'ç‹äº”', age:22}\r\n];\r\n\r\nfor(const obj of a2) {\r\n    console.log(obj.name, obj.age);\r\n}\r\n\r\nfor(const {name,age} of a2) {\r\n    console.log(name, age);\r\n}\r\n```\r\n\r\n\r\n\r\n### 3) try catch\r\n\r\n```js\r\nlet stu1 = {name:'å¼ ä¸‰', age:18, address: {city:'åŒ—äº¬'}};\r\nlet stu2 = {name:'å¼ ä¸‰', age:18};\r\n\r\nfunction test(stu) {\r\n    try {\r\n        console.log(stu.address.city)   \r\n    } catch(e) {\r\n        console.log('å‡ºç°äº†å¼‚å¸¸', e.message)\r\n    } finally {\r\n        console.log('finally');\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n## 4. API\r\n\r\n### ç¯å¢ƒå‡†å¤‡\r\n\r\n#### 1) å®‰è£… nvm\r\n\r\nnvm å³ (node version manager)ï¼Œå¥½å¤„æ˜¯æ–¹ä¾¿åˆ‡æ¢ node.js ç‰ˆæœ¬\r\n\r\nå®‰è£…æ³¨æ„äº‹é¡¹\r\n\r\n1. è¦å¸è½½æ‰ç°æœ‰çš„ nodejs\r\n2. æç¤ºé€‰æ‹© nvm å’Œ nodejs ç›®å½•æ—¶ï¼Œä¸€å®šè¦é¿å…ç›®å½•ä¸­å‡ºç°ç©ºæ ¼\r\n3. é€‰ç”¨ã€ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œã€‘cmd ç¨‹åºæ¥æ‰§è¡Œ nvm å‘½ä»¤\r\n4. é¦–æ¬¡è¿è¡Œå‰è®¾ç½®å¥½å›½å†…é•œåƒåœ°å€\r\n\r\n```\r\nnvm node_mirror http://npm.taobao.org/mirrors/node/\r\nnvm npm_mirror https://npm.taobao.org/mirrors/npm/\r\n```\r\n\r\né¦–å…ˆæŸ¥çœ‹æœ‰å“ªäº›å¯ç”¨ç‰ˆæœ¬\r\n\r\n```\r\nnvm list available\r\n```\r\n\r\nè¾“å‡º\r\n\r\n```\r\n\r\n|   CURRENT    |     LTS      |  OLD STABLE  | OLD UNSTABLE |\r\n|--------------|--------------|--------------|--------------|\r\n|    18.7.0    |   16.16.0    |   0.12.18    |   0.11.16    |\r\n|    18.6.0    |   16.15.1    |   0.12.17    |   0.11.15    |\r\n|    18.5.0    |   16.15.0    |   0.12.16    |   0.11.14    |\r\n|    18.4.0    |   16.14.2    |   0.12.15    |   0.11.13    |\r\n|    18.3.0    |   16.14.1    |   0.12.14    |   0.11.12    |\r\n|    18.2.0    |   16.14.0    |   0.12.13    |   0.11.11    |\r\n|    18.1.0    |   16.13.2    |   0.12.12    |   0.11.10    |\r\n|    18.0.0    |   16.13.1    |   0.12.11    |    0.11.9    |\r\n|    17.9.1    |   16.13.0    |   0.12.10    |    0.11.8    |\r\n|    17.9.0    |   14.20.0    |    0.12.9    |    0.11.7    |\r\n|    17.8.0    |   14.19.3    |    0.12.8    |    0.11.6    |\r\n|    17.7.2    |   14.19.2    |    0.12.7    |    0.11.5    |\r\n|    17.7.1    |   14.19.1    |    0.12.6    |    0.11.4    |\r\n|    17.7.0    |   14.19.0    |    0.12.5    |    0.11.3    |\r\n|    17.6.0    |   14.18.3    |    0.12.4    |    0.11.2    |\r\n|    17.5.0    |   14.18.2    |    0.12.3    |    0.11.1    |\r\n|    17.4.0    |   14.18.1    |    0.12.2    |    0.11.0    |\r\n|    17.3.1    |   14.18.0    |    0.12.1    |    0.9.12    |\r\n|    17.3.0    |   14.17.6    |    0.12.0    |    0.9.11    |\r\n|    17.2.0    |   14.17.5    |   0.10.48    |    0.9.10    |\r\n```\r\n\r\nå»ºè®®å®‰è£… LTSï¼ˆé•¿æœŸæ”¯æŒç‰ˆï¼‰\r\n\r\n```\r\nnvm install 16.16.0\r\nnvm install 14.20.0\r\n```\r\n\r\næ‰§è¡Œ `nvm list` ä¼šåˆ—å‡ºå·²å®‰è£…ç‰ˆæœ¬\r\n\r\nåˆ‡æ¢åˆ° 16.16.0\r\n\r\n```\r\nnvm use 16.16.0\r\n```\r\n\r\nåˆ‡æ¢åˆ° 14.20.0\r\n\r\n```\r\nnvm use 14.20.0\r\n```\r\n\r\nå®‰è£…å nvm è‡ªå·±çš„ç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨æ·»åŠ ï¼Œä½†å¯èƒ½éœ€è¦æ‰‹å·¥æ·»åŠ  nodejs çš„ PATH ç¯å¢ƒå˜é‡\r\n\r\n\r\n\r\n#### 2) æ£€æŸ¥ npm\r\n\r\nnpm æ˜¯ js çš„åŒ…ç®¡ç†å™¨ï¼Œå°±ç±»ä¼¼äº java ç•Œçš„ mavenï¼Œè¦ç¡®ä¿å®ƒä½¿ç”¨çš„æ˜¯å›½å†…é•œåƒ\r\n\r\næ£€æŸ¥é•œåƒ\r\n\r\n```\r\nnpm get registry\r\n```\r\n\r\nå¦‚æœè¿”å›çš„ä¸æ˜¯ `https://registry.npm.taobao.org/`ï¼Œéœ€è¦åšå¦‚ä¸‹è®¾ç½®\r\n\r\n```\r\nnpm config set registry https://registry.npm.taobao.org/\r\n```\r\n\r\n\r\n\r\n#### 3) æ­å»ºå‰ç«¯æœåŠ¡å™¨\r\n\r\næ–°å»ºä¸€ä¸ªä¿å­˜é¡¹ç›®çš„ client æ–‡ä»¶å¤¹ï¼Œè¿›å…¥æ–‡ä»¶å¤¹æ‰§è¡Œ\r\n\r\n```\r\nnpm install express --save-dev\r\n```\r\n\r\nä¿®æ”¹ package.json æ–‡ä»¶\r\n\r\n```json\r\n{\r\n  \"type\": \"module\",\r\n  \"devDependencies\": {\r\n    \"express\": \"^4.18.1\"\r\n  }\r\n}\r\n```\r\n\r\n* å…¶ä¸­ devDependencies æ˜¯ npm install --save-dev æ·»åŠ çš„\r\n\r\nç¼–å†™ main.js ä»£ç \r\n\r\n```js\r\nimport express from 'express'\r\nconst app = express()\r\n\r\napp.use(express.static('./'))\r\napp.listen(7070)\r\n```\r\n\r\næ‰§è¡Œ js ä»£ç ï¼ˆè¿è¡Œå‰ç«¯æœåŠ¡å™¨ï¼‰\r\n\r\n```\r\nnode main.js\r\n```\r\n\r\n\r\n\r\n### å‰ç«¯æ¡ˆä¾‹\r\n\r\nåˆæ­¥æ•ˆæœ\r\n\r\n![image-20220812103323220](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220812103323220.png)\r\n\r\næ¶æ„\r\n\r\n![image-20220812103219916](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220812103219916.png)\r\n\r\n* å‰ç«¯åªæœ‰é™æ€é¡µé¢ï¼Œä½¿ç”¨ Express æœåŠ¡å™¨\r\n* åç«¯ä½¿ç”¨ Tomcat æœåŠ¡å™¨ï¼Œé€šè¿‡ SpringBootã€MyBatis ç­‰æ¡†æ¶è·å–æ•°æ®åº“æ•°æ®\r\n\r\n\r\n\r\n#### 1) æŸ¥æ‰¾å…ƒç´ \r\n\r\n* document.getElementById - æ ¹æ® id å€¼æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ \r\n* [document|å…ƒç´ ].querySelector - æ ¹æ®é€‰æ‹©å™¨æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…å…ƒç´ \r\n* [document|å…ƒç´ ].querySelectorAll - æ ¹æ®é€‰æ‹©å™¨æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…å…ƒç´ \r\n\r\nä¾‹å¦‚ï¼Œæœ‰ä¸‹é¢çš„ html ä»£ç \r\n\r\n```html\r\n<div>\r\n    <div class=\"title\">å­¦ç”Ÿåˆ—è¡¨</div>\r\n    <div class=\"thead\">\r\n        <div class=\"row bold\">\r\n            <div class=\"col\">ç¼–å·</div>\r\n            <div class=\"col\">å§“å</div>\r\n            <div class=\"col\">æ€§åˆ«</div>\r\n            <div class=\"col\">å¹´é¾„</div>\r\n        </div>\r\n    </div>\r\n    <div class=\"tbody\">\r\n        <div class=\"row\">\r\n            <div class=\"col\">1</div>\r\n            <div class=\"col\">å¼ ä¸‰</div>\r\n            <div class=\"col\">ç”·</div>\r\n            <div class=\"col\">18</div>\r\n        </div>\r\n    </div>\r\n</div>\r\n```\r\n\r\næ‰§è¡Œ\r\n\r\n```js\r\ndocument.querySelector('.title'); // æ‰¾åˆ° <div class=\"title\">å­¦ç”Ÿåˆ—è¡¨</div>\r\n```\r\n\r\næ‰§è¡Œ\r\n\r\n```js\r\ndocument.querySelector('.col'); // æ‰¾åˆ° <div class=\"col\">ç¼–å·</div>\r\n```\r\n\r\næ‰§è¡Œ\r\n\r\n```js\r\ndocument.querySelectorAll('.col');\r\n\r\n/*\r\n  æ‰¾åˆ°çš„æ˜¯ä¸€ä¸ªé›†åˆ\r\n  <div class=\"col\">ç¼–å·</div>\r\n  <div class=\"col\">å§“å</div>\r\n  <div class=\"col\">æ€§åˆ«</div>\r\n  <div class=\"col\">å¹´é¾„</div>\r\n  <div class=\"col\">1</div>\r\n  <div class=\"col\">å¼ ä¸‰</div>\r\n  <div class=\"col\">ç”·</div>\r\n  <div class=\"col\">18</div>\r\n*/\r\n```\r\n\r\næ‰§è¡Œ\r\n\r\n```js\r\nconst thead = document.querySelector('.thead');\r\n\r\n// åªåœ¨ thead å…ƒç´ èŒƒå›´å†…æ‰¾\r\nthead.querySelectorAll('.col');\r\n\r\n/*\r\n  æ‰¾åˆ°çš„æ˜¯ä¸€ä¸ªé›†åˆ\r\n  <div class=\"col\">ç¼–å·</div>\r\n  <div class=\"col\">å§“å</div>\r\n  <div class=\"col\">æ€§åˆ«</div>\r\n  <div class=\"col\">å¹´é¾„</div>\r\n*/\r\n```\r\n\r\næ ¹æ® id å±æ€§æŸ¥æ‰¾æ—¢å¯ä»¥ç”¨\r\n\r\n```js\r\ndocument.getElementById(\"idå€¼\")\r\n```\r\n\r\nä¹Ÿå¯ä»¥ç”¨ \r\n\r\n```js\r\ndocument.querySelector(\"#idå€¼\")\r\n```\r\n\r\n\r\n\r\n#### 2) ä¿®æ”¹å…ƒç´ å†…å®¹\r\n\r\n* å…ƒç´ .innerHTML\r\n* å…ƒç´ .textContent\r\n\r\nä¾‹å¦‚\r\n\r\n```js\r\ndocument.querySelector('.title').innerHTML = 'ä¾ å®¢åˆ—è¡¨'\r\n```\r\n\r\næ•ˆæœ\r\n\r\n![image-20220812161003958](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220812161003958.png)\r\n\r\ninnerHTML  ä¼šè§£æå†…å®¹ä¸­çš„æ ‡ç­¾ï¼Œä¾‹å¦‚\r\n\r\n![image-20220812161137912](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220812161137912.png)\r\n\r\ntextContext ä¸ä¼šè§£æå†…å®¹ä¸­çš„æ ‡ç­¾\r\n\r\n![image-20220812161341825](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220812161341825.png)\r\n\r\nç»™ innerHTML æˆ– textContent èµ‹å€¼ç©ºä¸²ï¼Œå¯ä»¥å®ç°æ¸…ç©ºæ ‡ç­¾å†…å®¹çš„æ•ˆæœ\r\n\r\n\r\n\r\n#### 3) åˆ©ç”¨æ¨¡æ¿\r\n\r\n```html\r\n<div>\r\n    <div class=\"title\">å­¦ç”Ÿåˆ—è¡¨</div>\r\n    <div class=\"thead\">\r\n        <div class=\"row bold\">\r\n            <div class=\"col\">ç¼–å·</div>\r\n            <div class=\"col\">å§“å</div>\r\n            <div class=\"col\">æ€§åˆ«</div>\r\n            <div class=\"col\">å¹´é¾„</div>\r\n        </div>\r\n    </div>\r\n    <div class=\"tbody\">\r\n    </div>\r\n</div>\r\n\r\n<template id=\"tp\">\r\n    <div class=\"row\">\r\n        <div class=\"col\">xx</div>\r\n        <div class=\"col\">xx</div>\r\n        <div class=\"col\">xx</div>\r\n        <div class=\"col\">xx</div>\r\n    </div>\r\n</template>\r\n\r\n<script>\r\n    // å°†æ¥è¿™äº›æ•°æ®ä» java ç«¯è¿”å›\r\n    let array = [\r\n        { id: 1, name: 'å¼ ä¸‰', sex: 'ç”·', age: 18 },\r\n        { id: 2, name: 'æå››', sex: 'å¥³', age: 17 }\r\n    ];\r\n\r\n    const tp = document.getElementById(\"tp\");\r\n    const row = tp.content;\r\n    const [c1,c2,c3,c4] = row.querySelectorAll(\".col\");\r\n    const tbody = document.querySelector('.tbody');\r\n    for(const {id,name,sex,age} of array) {\r\n        c1.textContent = id;\r\n        c2.textContent = name;\r\n        c3.textContent = sex;\r\n        c4.textContent = age;\r\n        // å¤åˆ¶å…ƒç´ \r\n        const newRow = document.importNode(row, true);\r\n        // å»ºç«‹çˆ¶å­å…³ç³»ï¼Œå·¦è¾¹çˆ¶ï¼Œå³è¾¹å­\r\n        tbody.appendChild(newRow);\r\n    }\r\n</script>\r\n```\r\n\r\n\r\n\r\n#### 4) Fetch API\r\n\r\nFetch API å¯ä»¥ç”¨æ¥è·å–è¿œç¨‹æ•°æ®ï¼Œå®ƒæœ‰ä¸¤ç§æ–¹å¼æ¥æ”¶ç»“æœï¼ŒåŒæ­¥æ–¹å¼ä¸å¼‚æ­¥æ–¹å¼\r\n\r\næ ¼å¼\r\n\r\n```js\r\nfetch(url, options) // è¿”å› Promise\r\n```\r\n\r\nåŒæ­¥æ–¹å¼\r\n\r\n```js\r\nconst ç»“æœ = await Promise\r\n// åç»­ä»£ç \r\n```\r\n\r\n* await å…³é”®å­—å¿…é¡»åœ¨ä¸€ä¸ªæ ‡è®°äº† async çš„ function å†…æ¥ä½¿ç”¨\r\n* åç»­ä»£ç ä¸ä¼šåœ¨ç»“æœè¿”å›å‰æ‰§è¡Œ\r\n\r\nå¼‚æ­¥æ–¹å¼\r\n\r\n```js\r\nPromise\r\n\t.then(ç»“æœ => { ... })\r\n// åç»­ä»£ç                  \r\n```\r\n\r\n* åç»­ä»£ç ä¸å¿…ç­‰å¾…ç»“æœè¿”å›å°±å¯ä»¥æ‰§è¡Œ\r\n\r\n\r\n\r\nä¾‹ï¼š\r\n\r\nåœ¨ express æœåŠ¡å™¨ä¸Šæœ‰ students.json æ–‡ä»¶\r\n\r\n```json\r\n[\r\n    { \"id\": 1, \"name\": \"å¼ ä¸‰\", \"sex\": \"ç”·\", \"age\": 18 },\r\n    { \"id\": 2, \"name\": \"æå››\", \"sex\": \"å¥³\", \"age\": 17 }\r\n]\r\n```\r\n\r\nç°åœ¨ç”¨ fetch api è·å–è¿™äº›æ•°æ®ï¼Œå¹¶å±•ç¤º\r\n\r\nåŒæ­¥æ–¹å¼\r\n\r\n```html\r\n<script>\r\n    async function findStudents() {\r\n        try {\r\n            // è·å–å“åº”å¯¹è±¡\r\n            const resp = await fetch('students.json')\r\n\r\n            // è·å–å“åº”ä½“, æŒ‰jsonæ ¼å¼è½¬æ¢ä¸ºjsæ•°ç»„\r\n            const array = await resp.json();\r\n\r\n            // æ˜¾ç¤ºæ•°æ®\r\n            const tp = document.getElementById(\"tp\");\r\n            const row = tp.content;\r\n            const [c1,c2,c3,c4] = row.querySelectorAll(\".col\");\r\n            const tbody = document.querySelector('.tbody');\r\n            for(const {id,name,sex,age} of array) {\r\n                c1.textContent = id;\r\n                c2.textContent = name;\r\n                c3.textContent = sex;\r\n                c4.textContent = age;\r\n                // å¤åˆ¶å…ƒç´ \r\n                const newRow = document.importNode(row, true);\r\n                // å»ºç«‹çˆ¶å­å…³ç³»\r\n                tbody.appendChild(newRow);\r\n            }\r\n        } catch (e) {\r\n            console.log(e);\r\n        }\r\n\r\n    }\r\n    findStudents()\r\n</script>\r\n```\r\n\r\n* fetch('students.json') å†…éƒ¨ä¼šå‘é€è¯·æ±‚ï¼Œä½†å“åº”ç»“æœä¸èƒ½ç«‹åˆ»è¿”å›ï¼Œå› æ­¤ await å°±æ˜¯ç­‰å¾…å“åº”ç»“æœè¿”å›\r\n* å…¶ä¸­ resp.json() ä¹Ÿä¸æ˜¯ç«‹åˆ»èƒ½è¿”å›ç»“æœï¼Œå®ƒè¿”å›çš„ä¹Ÿæ˜¯ Promise å¯¹è±¡ï¼Œä¹Ÿè¦é…åˆ await å–ç»“æœ\r\n\r\nå¼‚æ­¥æ–¹å¼\r\n\r\n```html\r\n<script>\r\n    fetch('students.json')\r\n        .then( resp => resp.json() )\r\n        .then( array => {\r\n        \t// æ˜¾ç¤ºæ•°æ®\r\n            const tp = document.getElementById(\"tp\");\r\n            const row = tp.content;\r\n            const [c1,c2,c3,c4] = row.querySelectorAll(\".col\");\r\n            const tbody = document.querySelector('.tbody');\r\n            for(const {id,name,sex,age} of array) {\r\n                c1.textContent = id;\r\n                c2.textContent = name;\r\n                c3.textContent = sex;\r\n                c4.textContent = age;\r\n                // å¤åˆ¶å…ƒç´ \r\n                const newRow = document.importNode(row, true);\r\n                // å»ºç«‹çˆ¶å­å…³ç³»\r\n                tbody.appendChild(newRow);\r\n            }\r\n        })\r\n        .catch( e => console.log(e) )\r\n\r\n\r\n</script>\r\n```\r\n\r\n* ç¬¬ä¸€ä¸ª then æ˜¯åœ¨å“åº”è¿”å›åï¼Œæ‰ä¼šè°ƒç”¨å®ƒé‡Œé¢çš„ç®­å¤´å‡½æ•°ï¼Œç®­å¤´å‡½æ•°å‚æ•°å³ resp  å“åº”å¯¹è±¡\r\n* ç¬¬äºŒä¸ª then æ˜¯åœ¨ json è§£æå®Œæˆåï¼Œæ‰ä¼šè°ƒç”¨å®ƒé‡Œé¢çš„ç®­å¤´å‡½æ•°ï¼Œç®­å¤´å‡½æ•°å‚æ•°å³è§£æç»“æœï¼ˆæœ¬ä¾‹æ˜¯ array æ•°ç»„ï¼‰\r\n* ä¸Šä¸€ä¸ª then è¿”å›çš„æ˜¯ Promise å¯¹è±¡æ—¶ï¼Œæ‰èƒ½é“¾å¼è°ƒç”¨ä¸‹ä¸€ä¸ª then\r\n\r\n\r\n\r\n##### è·¨åŸŸé—®é¢˜\r\n\r\n![image-20220814105448882](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220814105448882.png)\r\n\r\n* åªè¦åè®®ã€ä¸»æœºã€ç«¯å£ä¹‹ä¸€ä¸åŒï¼Œå°±ä¸åŒæºï¼Œä¾‹å¦‚\r\n  * http://localhost:7070/a å’Œ https://localhost:7070/b å°±ä¸åŒæº\r\n* åŒæºæ£€æŸ¥æ˜¯æµè§ˆå™¨çš„è¡Œä¸ºï¼Œè€Œä¸”åªé’ˆå¯¹ fetchã€xhr è¯·æ±‚\r\n  * å¦‚æœæ˜¯å…¶å®ƒå®¢æˆ·ç«¯ï¼Œä¾‹å¦‚ java http clientï¼Œpostmanï¼Œå®ƒä»¬æ˜¯ä¸åšåŒæºæ£€æŸ¥çš„\r\n  * é€šè¿‡è¡¨å•æäº¤ã€æµè§ˆå™¨ç›´æ¥è¾“å…¥ url åœ°å€è¿™äº›æ–¹å¼å‘é€çš„è¯·æ±‚ï¼Œä¹Ÿä¸ä¼šåšåŒæºæ£€æŸ¥\r\n* æ›´å¤šç›¸å…³çŸ¥è¯†è¯·å‚è€ƒ\r\n  * [è·¨æºèµ„æºå…±äº«ï¼ˆCORSï¼‰ - HTTP | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS)\r\n\r\n\r\n\r\nè¯·æ±‚å“åº”å¤´è§£å†³\r\n\r\n![image-20220814144040703](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220814144040703.png)\r\n\r\n* fetch è¯·æ±‚è·¨åŸŸï¼Œä¼šæºå¸¦ä¸€ä¸ª Origin å¤´ï¼Œä»£è¡¨ã€å‘è¯·æ±‚çš„èµ„æºæºè‡ªä½•å¤„ã€‘ï¼Œç›®æ ‡é€šè¿‡å®ƒå°±èƒ½è¾¨åˆ«æ˜¯å¦å‘ç”Ÿè·¨åŸŸ\r\n  * æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼šstudent.html å‘é€ fetch è¯·æ±‚ï¼Œå‘Šè¯‰ tomcatï¼Œæˆ‘æºè‡ª localhost:7070\r\n* ç›®æ ‡èµ„æºé€šè¿‡è¿”å› Access-Control-Allow-Origin å¤´ï¼Œå‘Šè¯‰æµè§ˆå™¨ã€å…è®¸å“ªäº›æºä½¿ç”¨æ­¤å“åº”ã€‘\r\n  * æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼štomcat è¿”å› fetch å“åº”ï¼Œå‘Šè¯‰æµè§ˆå™¨ï¼Œè¿™ä¸ªå“åº”å…è®¸æºè‡ª localhost:7070 çš„èµ„æºä½¿ç”¨\r\n\r\n\r\n\r\nä»£ç†è§£å†³\r\n\r\n![image-20220814161532141](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220814161532141.png)\r\n\r\n```cmd\r\nnpm install http-proxy-middleware --save-dev\r\n```\r\n\r\nåœ¨ express æœåŠ¡å™¨å¯åŠ¨ä»£ç ä¸­åŠ å…¥\r\n\r\n```js\r\nimport {createProxyMiddleware} from 'http-proxy-middleware'\r\n\r\n// ...\r\n\r\napp.use('/api', createProxyMiddleware({ target: 'http://localhost:8080', changeOrigin: true }));\r\n```\r\n\r\nfetch ä»£ç æ”¹ä¸º\r\n\r\n```js\r\nconst resp = await fetch('http://localhost:7070/api/students')\r\n```\r\n\r\næˆ–\r\n\r\n```js\r\nconst resp = await fetch('/api/students')\r\n```\r\n\r\n\r\n\r\n#### 5) æ¨¡å—åŒ–\r\n\r\nå•ä¸ªå¯¼å‡º constã€letã€function\r\n\r\n```js\r\nexport const a = 10;\r\nexport let b = 20;\r\nexport function c() {\r\n    console.log('c');\r\n}\r\n```\r\n\r\nä¸€é½å¯¼å‡º\r\n\r\n```js\r\nconst a = 10;\r\nlet b = 20;\r\nfunction c() {\r\n    console.log('c')\r\n}\r\n\r\nexport {a,b,c}\r\n```\r\n\r\nå¯¼å‡º defaultï¼Œåªèƒ½æœ‰ä¸€ä¸ª\r\n\r\n```js\r\nexport const a = 10;\r\nexport let b = 20;\r\nexport function c() {\r\n    console.log('c')\r\n}\r\n\r\nexport default b;\r\n```\r\n\r\n\r\n\r\nimport è¯­æ³•\r\n\r\n```html\r\n<script type=\"module\">\r\n\timport è¯­å¥\r\n</script>\r\n```\r\n\r\n* import éœ€è¦éµå¾ªåŒæºç­–ç•¥\r\n\r\næ•´ä¸ªå¯¼å…¥\r\n\r\n```js\r\nimport * as module from '/1.js'\r\nconsole.log(module.a)\t\t// è¾“å‡º10\r\nconsole.log(module.b)\t\t// è¾“å‡º20\r\nmodule.c()\t\t\t\t\t// è¾“å‡ºc\r\n```\r\n\r\nå•ä¸ªå¯¼å…¥\r\n\r\n```js\r\nimport {a,c} from '/1.js'\r\nconsole.log(a)\t\t\t\t// è¾“å‡º10\r\nc()\t\t\t\t\t\t\t// è¾“å‡ºc\r\n```\r\n\r\nå¯¼å…¥é»˜è®¤\r\n\r\n```js\r\nimport x from '/1.js'\r\nconsole.log(x)\t\t\t\t// è¾“å‡º20\r\n```\r\n\r\n"},{"title":"Javaé¢è¯•ä¸“é¢˜-åŸºç¡€ç¯‡","tags":["ArrayList","LinkedList","HashMap","Hashtable","Singleton"],"categories":["Java","é¢è¯•"],"author":"","excerpt":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥Javaé¢è¯•ä¸“é¢˜](https://www.bilibili.com/video/BV15b4y117RJ)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n","link":"/posts/Java_Interview_Topics-Basic","content":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥Javaé¢è¯•ä¸“é¢˜](https://www.bilibili.com/video/BV15b4y117RJ)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n<!-- more -->\r\n\r\n\r\n## 1. ArrayList\r\n\r\n**è¦æ±‚**\r\n\r\n- æŒæ¡ ArrayList æ‰©å®¹è§„åˆ™\r\n\r\n**æ‰©å®¹è§„åˆ™**\r\n\r\n1. **ArrayList()** ä¼šä½¿ç”¨**é•¿åº¦ä¸ºé›¶**çš„æ•°ç»„\r\n\r\n![image-20230418114304421](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418114304421.png)\r\n\r\n2. **ArrayList(int initialCapacity)** ä¼šä½¿ç”¨**æŒ‡å®šå®¹é‡**çš„æ•°ç»„\r\n\r\n![image-20230418114403174](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418114403174.png)\r\n\r\n3. public ArrayList(Collection<? extends E> c) ä¼šä½¿ç”¨ c çš„å¤§å°ä½œä¸ºæ•°ç»„å®¹é‡\r\n\r\n![image-20230418114502997](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418114502997.png)\r\n\r\n4. add(Object o) é¦–æ¬¡æ‰©å®¹ä¸º 10ï¼Œå†æ¬¡æ‰©å®¹ä¸ºä¸Šæ¬¡å®¹é‡çš„ 1.5 å€\r\n\r\n- ç¬¬ä¸€æ¬¡æ·»åŠ æ•°ç»„ï¼Œæ•°ç»„ä¸º0ï¼Œå‘ç”Ÿç¬¬ä¸€æ¬¡æ‰©å®¹\r\n- ç¬¬ä¸€ä¸ªå…ƒç´ æ”¾å…¥æ–°æ•°ç»„ç´¢å¼•0ï¼Œæ–°æ•°ç»„æ›¿æ¢æ—§æ•°ç»„(é¦–æ¬¡ä¸º0)\r\n\r\n![image-20230418115017704](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418115017704.png)\r\n\r\n- å†æ¬¡æ‰©å®¹ä¸ºä¸Šæ¬¡å®¹é‡çš„ 1.5 å€ï¼Œå®Œæˆæ‰©å®¹å¹¶æ·»åŠ å…ƒç´ ï¼Œæ–°æ•°ç»„æ›¿æ¢æ—§æ•°ç»„ï¼Œæ—§æ•°ç»„æ²¡äººå¼•ç”¨å°±ä¼šè¢«åƒåœ¾å›æ”¶\r\n\r\n![image-20230418115545132](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418115545132.png)\r\n\r\n- ä»¥åæ‰©å®¹æŒ‰ä¸Šæ¬¡å®¹é‡+ä¸Šæ¬¡å®¹é‡å³ç§»1ä½\r\n\r\n![image-20230418115811928](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418115811928.png)\r\n\r\n- æ­¤æ–¹å¼ä¸ºè°ƒç”¨çš„addæ–¹æ³•å¾—åˆ°çš„æ‰©å®¹ç»“æœ\r\n\r\n![image-20230418120314176](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418120314176.png)\r\n\r\n5.  addAll(Collection c) æ²¡æœ‰å…ƒç´ æ—¶ï¼Œæ‰©å®¹ä¸º Math.max(10, å®é™…å…ƒç´ ä¸ªæ•°)ï¼Œæœ‰å…ƒç´ æ—¶ä¸º Math.max(åŸå®¹é‡ 1.5 å€, å®é™…å…ƒç´ ä¸ªæ•°)\r\n\r\n![image-20230418120611741](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418120611741.png)\r\n\r\n- ç¬¬ä¸€æ¬¡ç©ºæ•°ç»„æ‰©å®¹(å…ƒç´ ä¸ªæ•°<10)\r\n\r\n![image-20230418120727097](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418120727097.png)\r\n\r\n- ç¬¬ä¸€æ¬¡ç©ºæ•°ç»„æ‰©å®¹(10<å…ƒç´ ä¸ªæ•°<15ï¼Œæ­¤æ—¶ä¼šæ‹¿å½“å‰å…ƒç´ ä¸ªæ•°ä¸å½“å‰å®¹é‡ä¸‹æ¬¡æ‰©å®¹çš„å®¹é‡äºŒè€…ä¹‹é—´çš„è¾ƒå¤§å€¼ä½œä¸ºå½“å‰å®¹é‡)\r\n\r\n![image-20230418121100137](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418121100137.png)\r\n\r\n- ç¬¬ä¸€æ¬¡éç©ºæ•°ç»„æ‰©å®¹(è§„åˆ™ä¸€æ ·)\r\n\r\n![image-20230418121501578](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418121501578.png)\r\n\r\n![image-20230418121608015](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418121608015.png)\r\n\r\nå…¶ä¸­ç¬¬ 4 ç‚¹å¿…é¡»çŸ¥é“ï¼Œå…¶å®ƒå‡ ç‚¹è§†ä¸ªäººæƒ…å†µè€Œå®š\r\n\r\n**æç¤º**\r\n\r\n- æµ‹è¯•ä»£ç è§ `day01.list.TestArrayList` ï¼Œè¿™é‡Œä¸å†åˆ—å‡º\r\n- è¦**æ³¨æ„**çš„æ˜¯ï¼Œç¤ºä¾‹ä¸­ç”¨åå°„æ–¹å¼æ¥æ›´ç›´è§‚åœ°åæ˜  ArrayList çš„æ‰©å®¹ç‰¹å¾ï¼Œä½†ä» JDK 9 ç”±äºæ¨¡å—åŒ–çš„å½±å“ï¼Œå¯¹åå°„åšäº†è¾ƒå¤šé™åˆ¶ï¼Œéœ€è¦åœ¨è¿è¡Œæµ‹è¯•ä»£ç æ—¶æ·»åŠ  VM å‚æ•° `--add-opens java.base/java.util=ALL-UNNAMED` æ–¹èƒ½è¿è¡Œé€šè¿‡ï¼Œåé¢çš„ä¾‹å­éƒ½æœ‰ç›¸åŒé—®é¢˜\r\n\r\n> ***ä»£ç è¯´æ˜***\r\n>\r\n> - day01.list.TestArrayList#arrayListGrowRule æ¼”ç¤ºäº† add(Object) æ–¹æ³•çš„æ‰©å®¹è§„åˆ™ï¼Œè¾“å…¥å‚æ•° n ä»£è¡¨æ‰“å°å¤šå°‘æ¬¡æ‰©å®¹åçš„æ•°ç»„é•¿åº¦\r\n\r\n### è¡¥å……\r\n\r\n> **addAllæ‰©å®¹æœºåˆ¶**ï¼šæ·»åŠ å…ƒç´ åçš„å…ƒç´ ä¸ªæ•°ä¸ä¸‹ä¸€æ¬¡æ‰©å®¹æ•°ä½œæ¯”è¾ƒ\r\n> 0->10:3ä¸ª->10,11->11;10->15:13->15,16->16\r\n\r\n## 2. Iterator\r\n\r\n**è¦æ±‚**\r\n\r\n- æŒæ¡ä»€ä¹ˆæ˜¯ Fail-Fastã€ä»€ä¹ˆæ˜¯ Fail-Safe\r\n\r\nFail-Fast ä¸ Fail-Safe\r\n\r\n- ArrayList æ˜¯ fail-fast çš„å…¸å‹ä»£è¡¨ï¼Œéå†çš„åŒæ—¶ä¸èƒ½ä¿®æ”¹ï¼Œå°½å¿«å¤±è´¥\r\n- fail-fast ä¸€æ—¦å‘ç°éå†çš„åŒæ—¶å…¶å®ƒäººæ¥ä¿®æ”¹ï¼Œåˆ™ç«‹åˆ»æŠ›å¼‚å¸¸\r\n\r\n![image-20230418133457466](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418133457466.png)\r\n\r\n- fail-fastå®ç°åŸç†\r\n\r\n![image-20230418135557765](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418135557765.png)\r\n\r\n- CopyOnWriteArrayList æ˜¯ fail-safe çš„å…¸å‹ä»£è¡¨ï¼Œéå†çš„åŒæ—¶å¯ä»¥ä¿®æ”¹ï¼ŒåŸç†æ˜¯è¯»å†™åˆ†ç¦»\r\n- fail-safe å‘ç°éå†çš„åŒæ—¶å…¶å®ƒäººæ¥ä¿®æ”¹ï¼Œåº”å½“èƒ½æœ‰åº”å¯¹ç­–ç•¥ï¼Œä¾‹å¦‚ç‰ºç‰²ä¸€è‡´æ€§æ¥è®©æ•´ä¸ªéå†è¿è¡Œå®Œæˆ\r\n\r\n![image-20230418133702722](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418133702722.png)\r\n\r\n- fail-safeå®ç°åŸç†\r\n\r\n![image-20230418142258054](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418142258054.png)\r\n\r\n**æç¤º**\r\n\r\n- æµ‹è¯•ä»£ç è§ `day01.list.FailFastVsFailSafe`ï¼Œè¿™é‡Œä¸å†åˆ—å‡º\r\n\r\n- ç¬¬ä¸€æ¬¡ç¬”è®°ï¼š\r\n\r\n  - **fail-fast:**\r\n\r\n    - â€‹    1.è°ƒç”¨è¿­ä»£å™¨Iteratoræ„é€ æ–¹æ³•å¹¶åˆå§‹åŒ–æˆå‘˜å˜é‡\r\n\r\n    - â€‹    2.æ£€æŸ¥ï¼šexpectedModCount(è¿­ä»£ä¸€å¼€å§‹è®°å½•çš„ä¿®æ”¹æ¬¡æ•°)ä¸modCount(å¤–é¢listçš„ä¿®æ”¹æ¬¡æ•°)åšå¯¹æ¯”ï¼Œä¸ç­‰åˆ™æŠ›å¼‚å¸¸\r\n\r\n  - **fail-safe:**\r\n    - â€‹    list.addä¸­æ¯æ¬¡è°ƒç”¨addæ–¹æ³•æ—¶éƒ½ä¼šæŠŠæ—§çš„æ•°ç»„æ‹·è´ä¸€ä»½ï¼Œå¹¶è®©é•¿åº¦åŠ ä¸€ï¼ŒæŠŠæ–°åŠ çš„å…ƒç´ æ”¾åˆ°æ‰©å®¹æ•°ç»„(æ–°æ•°ç»„)æœ€åä¸€ä¸ªä½ç½®ï¼Œå³æ·»åŠ å’Œéå†çš„æ•°ç»„ä¸åŒï¼Œäº’ä¸å¹²æ‰°\r\n\r\n- ç¬¬äºŒæ¬¡ç¬”è®°ï¼š\r\n\r\n  - **failfast**ï¼š\r\n    - å¢å¼ºforå¾ªç¯å¼€å§‹å‰çš„ä¿®æ”¹æ¬¡æ•°ï¼ˆcrudï¼‰modCount\r\n    - expectedModCountåˆå§‹å€¼=modCount\r\n    - æ¯æ¬¡éå†å…ƒç´ å‰ï¼ˆè¿­ä»£ï¼‰éƒ½æ£€æŸ¥ä»¥ä¸Šçš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œåœ¨éå†æœŸé—´å¹¶å‘ä¿®æ”¹äº†ï¼Œç­‰éå†ä¸‹ä¸ªå…ƒç´ æ—¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸\r\n\r\n  - **failsafe**ï¼š\r\n    - iteratoréå†é›†åˆï¼Œlist.addæ–¹æ³•æ¯æ¬¡æ·»åŠ å…ƒç´ ï¼Œéƒ½ä¼šæ‹·è´ä¸€ä»½åŸé›†åˆå¹¶è®©å®¹é‡åŠ ä¸€ï¼Œåœ¨å¹¶å‘ä¿®æ”¹æ—¶è¿­ä»£å™¨æ˜¯ä¸çŸ¥é“ï¼Œéå†çš„è¿˜æ˜¯åŸé›†åˆï¼Œå³æ·»åŠ æ˜¯ä¸€ä¸ªé›†åˆï¼Œéå†æ˜¯å¦ä¸€ä¸ªé›†åˆ\r\n\r\n## 3. LinkedList VS **ArrayList**\r\n\r\n**è¦æ±‚**\r\n\r\n- èƒ½å¤Ÿè¯´æ¸…æ¥š LinkedList å¯¹æ¯” ArrayList çš„åŒºåˆ«ï¼Œå¹¶é‡è§†çº æ­£éƒ¨åˆ†é”™è¯¯çš„è®¤çŸ¥\r\n\r\n![image-20230418144031416](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418144031416.png)\r\n\r\n- ä¸¤è€…æŸ¥è¯¢å…ƒç´ å†…å®¹çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(n)ï¼Œéƒ½ä¸å¤ªé€‚åˆç”¨æ¥æŸ¥è¯¢ï¼ŒæŸ¥è¯¢å¯ä»¥é€‰æ‹©æ›´é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå¦‚HashMapã€TreeMapç­‰\r\n\r\n\r\n**LinkedList**\r\n\r\n1. åŸºäºåŒå‘é“¾è¡¨ï¼Œæ— éœ€è¿ç»­å†…å­˜\r\n\r\n![image-20230418143629513](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418143629513.png)\r\n\r\n2. éšæœºè®¿é—®æ…¢ï¼ˆè¦æ²¿ç€é“¾è¡¨éå†ï¼‰\r\n\r\n![image-20230418143509162](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418143509162.png)\r\n\r\n3. å¤´å°¾æ’å…¥åˆ é™¤æ€§èƒ½é«˜\r\n4. å ç”¨å†…å­˜å¤š\r\n\r\n**ArrayList**\r\n\r\n1. åŸºäºæ•°ç»„ï¼Œéœ€è¦è¿ç»­å†…å­˜\r\n\r\n![image-20230418143617488](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418143617488.png)\r\n\r\n2. éšæœºè®¿é—®å¿«ï¼ˆæŒ‡æ ¹æ®ä¸‹æ ‡è®¿é—®ï¼‰\r\n\r\n![image-20230418143527810](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418143527810.png)\r\n\r\n3. å°¾éƒ¨æ’å…¥ã€åˆ é™¤æ€§èƒ½å¯ä»¥ï¼Œå…¶å®ƒéƒ¨åˆ†æ’å…¥ã€åˆ é™¤éƒ½ä¼šç§»åŠ¨æ•°æ®ï¼Œå› æ­¤æ€§èƒ½ä¼šä½\r\n\r\n![image-20230418144640481](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418144640481.png)\r\n\r\n4. å¯ä»¥åˆ©ç”¨ cpu ç¼“å­˜ï¼Œå±€éƒ¨æ€§åŸç†ï¼ˆå°†è¯»å–å˜é‡å’Œå…¶ç›¸é‚»çš„å˜é‡ä¹Ÿä¸€æ¬¡è¯»åˆ°CPUç¼“å­˜ä¸­ï¼‰\r\n\r\n\r\n\r\n\r\n\r\n> ***ä»£ç è¯´æ˜***\r\n>\r\n> - day01.list.ArrayListVsLinkedList#randomAccess å¯¹æ¯”éšæœºè®¿é—®æ€§èƒ½\r\n>\r\n> ![image-20230418143722912](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418143722912.png)\r\n>\r\n> - day01.list.ArrayListVsLinkedList#addMiddle å¯¹æ¯”å‘ä¸­é—´æ’å…¥æ€§èƒ½\r\n> - day01.list.ArrayListVsLinkedList#addFirst å¯¹æ¯”å¤´éƒ¨æ’å…¥æ€§èƒ½\r\n> - day01.list.ArrayListVsLinkedList#addLast å¯¹æ¯”å°¾éƒ¨æ’å…¥æ€§èƒ½\r\n>\r\n> ![image-20230418145338167](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418145338167.png)\r\n>\r\n> - day01.list.ArrayListVsLinkedList#linkedListSize æ‰“å°ä¸€ä¸ª LinkedList å ç”¨å†…å­˜\r\n> - day01.list.ArrayListVsLinkedList#arrayListSize æ‰“å°ä¸€ä¸ª ArrayList å ç”¨å†…å­˜\r\n>\r\n> ![image-20230418153454935](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418153454935.png)\r\n>\r\n> ![image-20230418150308326](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418150308326.png)\r\n>\r\n> - CPUè¿›è¡Œè®¡ç®—çš„æ•°æ®è¿˜æ˜¯æ¥è‡ªå†…å­˜ä¸­çš„ï¼Œæ¯”å¦‚è¿›è¡ŒåŠ æ³•è¿ç®—ï¼Œé¦–å…ˆå°†å†…å­˜ä¸­açš„å˜é‡çš„è¯»å–åˆ°CPUçš„å¯„å­˜å™¨ä¸­ï¼Œç„¶åå°†bçš„å€¼è¯»åˆ°å¦ä¸€ä¸ªå¯„å­˜å™¨ä¸­ï¼Œæ•°æ®éƒ½æœ‰äº†å°±è¿›è¡Œæ¥ä¸‹æ¥çš„åŠ æ³•è¿ç®—ï¼Œè®¡ç®—åçš„ç»“æœä¹Ÿä¼šå†™åˆ°å†…å­˜ä¸­çš„cå˜é‡ï¼Œè¿™æ ·å°±å®Œæˆäº†ä¸€æ¬¡åŠ æ³•è¿ç®—çš„è®¡ç®—è¿‡ç¨‹ï¼Œåœ¨è¿™ä¸ªè®¡ç®—è¿‡ç¨‹é‡Œç“¶é¢ˆåœ¨äºå†…å­˜å˜é‡çš„è¯»å’Œå†™ä¸Šï¼Œå› ä¸ºå†…å­˜çš„è¯»å†™æ•ˆç‡æ˜¯éå¸¸ä½çš„ï¼Œè¯»ä¸€æ¬¡ã€å†™ä¸€æ¬¡å¤§çº¦éœ€è¦èŠ±å‡ ç™¾çº³ç§’ï¼Œå¯¹äºCPUæ¥è®²è¿™ä¸ªæ—¶é—´æ˜¯éå¸¸æ¼«é•¿çš„ï¼ŒCPUæ‰§è¡Œä¸€æ¬¡è®¡ç®—æ˜¯å°‘äºçº³ç§’çº§åˆ«çš„ï¼Œä¹Ÿè®¸èŠ±äº†ä¸åˆ°1çº³ç§’å°±å®Œæˆäº†ï¼Œä½†ç­‰å¾…æ•°æ®è¯»è¿›æ¥å†™å‡ºå»å°±è¦èŠ±è´¹æˆç™¾å€çš„æ—¶é—´ï¼Œæ˜¾ç„¶æ˜¯ä¸å¯æ¥å—çš„ï¼›\r\n>\r\n> - å› æ­¤éœ€è¦åœ¨CPUä¸å†…å­˜ä¹‹é—´åŠ å…¥CPUç¼“å­˜ï¼Œè¿™ä¸ªç¼“å­˜çš„è¯»å†™æ€§èƒ½å°±æ¯”å†…å­˜é«˜å¾ˆå¤šäº†ï¼ŒCPUç¼“å­˜åˆåˆ†ä¸º1çº§ã€2çº§ã€3çº§ç¼“å­˜ï¼Œé€Ÿåº¦å¿«çš„èƒ½è¾¾åˆ°10çº³ç§’ï¼Œé€Ÿåº¦æ…¢çš„ä¹Ÿèƒ½åˆ°è¾¾å‡ åçº³ç§’ï¼Œå¯¹æ¯”å†…å­˜çš„å‡ ç™¾çº³ç§’å°±å¿«äº†å¾ˆå¤š\r\n>\r\n> ![image-20230418151824705](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418151824705.png)\r\n>\r\n> - å±€éƒ¨æ€§åŸç†\r\n>   - å¾€ç¼“å­˜ä¸­è¯»æ•°æ®æ—¶çš„ä¸€ç§è§„åˆ™ï¼Œä¸€ç§ä¼˜åŒ–æªæ–½\r\n>   - å°†æŸä¸ªæ•°æ®ä»¥åŠå®ƒç›¸é‚»çš„æ•°æ®éƒ½è¯»å–åˆ°ç¼“å­˜ä¸­ï¼Œå®ƒä¼šå‡ºäºè¿™æ ·ä¸€ç§å‡è®¾ï¼Œå½“è¯»å–æŸä¸ªå˜é‡æ—¶ï¼Œå®ƒç›¸é‚»çš„å˜é‡ä¹Ÿä¼šæœ‰å¾ˆå¤§å‡ ç‡è¢«è®¿é—®åˆ°ï¼Œå³æ‹¿åˆ°æŸä¸ªå…ƒç´ åï¼Œæœ‰å¾ˆå¤§å‡ ç‡ä¼šéå†æ•°ç»„ï¼Œå³å¯ä»¥ç›´æ¥åœ¨ç¼“å­˜ä¸­éå†äº†ï¼Œæ— éœ€å†åˆ°å†…å­˜ä¸­éå†\r\n>\r\n> ![image-20230418152143557](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418152143557.png)\r\n>\r\n> - é“¾è¡¨çš„å±€éƒ¨æ€§åŸç†å°±ä¸å¯è¡Œï¼Œå› ä¸ºç¬¬ä¸€ä¸ªå…ƒç´ ä¸ç¬¬äºŒä¸ªå…ƒç´ ç›¸é‚»çš„æœ‰ç‚¹è¿œ\r\n>\r\n> ![image-20230418152725657](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418152725657.png)\r\n>\r\n> - CPUç¼“å­˜çš„ç©ºé—´ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œå¦‚æœå°†2å’Œ3ä¹Ÿè¯»åˆ°ç¼“å­˜ï¼Œå°±ä¼šæŠŠä¹‹å‰çš„æ•°æ®æ¸…ç©ºæ‰äº†ï¼Œå› æ­¤é“¾è¡¨å°±ä¸èƒ½å¾ˆå¥½çš„é…åˆCPUç¼“å­˜(å±€éƒ¨æ€§åŸç†)æ¥æå‡æ€§èƒ½\r\n>\r\n> ![image-20230418152845212](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418152845212.png)\r\n\r\n## 4. HashMap\r\n\r\n**è¦æ±‚**\r\n\r\n- æŒæ¡ HashMap çš„åŸºæœ¬æ•°æ®ç»“æ„\r\n- æŒæ¡æ ‘åŒ–\r\n- ç†è§£ç´¢å¼•è®¡ç®—æ–¹æ³•ã€äºŒæ¬¡ hash çš„æ„ä¹‰ã€å®¹é‡å¯¹ç´¢å¼•è®¡ç®—çš„å½±å“\r\n- æŒæ¡ put æµç¨‹ã€æ‰©å®¹ã€æ‰©å®¹å› å­\r\n- ç†è§£å¹¶å‘ä½¿ç”¨ HashMap å¯èƒ½å¯¼è‡´çš„é—®é¢˜\r\n- ç†è§£ key çš„è®¾è®¡\r\n\r\n### 1ï¼‰åŸºæœ¬æ•°æ®ç»“æ„\r\n\r\n- 1.7 æ•°ç»„ + é“¾è¡¨\r\n- 1.8 æ•°ç»„ + ï¼ˆé“¾è¡¨ | çº¢é»‘æ ‘ï¼‰\r\n\r\n> æ›´å½¢è±¡çš„æ¼”ç¤ºï¼Œè§èµ„æ–™ä¸­çš„ hash-demo.jarï¼Œè¿è¡Œéœ€è¦ jdk14 ä»¥ä¸Šç¯å¢ƒï¼Œè¿›å…¥ jar åŒ…ç›®å½•ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤\r\n>\r\n> ```\r\n> java -jar --add-exports java.base/jdk.internal.misc=ALL-UNNAMED hash-demo.jar\r\n> ```\r\n\r\n### 2ï¼‰æ ‘åŒ–ä¸é€€åŒ–\r\n\r\n**æ ‘åŒ–æ„ä¹‰**\r\n\r\n- çº¢é»‘æ ‘ç”¨æ¥é¿å… DoS æ”»å‡»ï¼Œé˜²æ­¢é“¾è¡¨è¶…é•¿æ—¶æ€§èƒ½ä¸‹é™ï¼Œæ ‘åŒ–åº”å½“æ˜¯å¶ç„¶æƒ…å†µï¼Œæ˜¯ä¿åº•ç­–ç•¥\r\n- hash è¡¨çš„æŸ¥æ‰¾ï¼Œæ›´æ–°çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(1)$ï¼Œè€Œçº¢é»‘æ ‘çš„æŸ¥æ‰¾ï¼Œæ›´æ–°çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(log_2n)$ ï¼ŒTreeNode å ç”¨ç©ºé—´ä¹Ÿæ¯”æ™®é€š Node çš„å¤§ï¼Œå¦‚éå¿…è¦ï¼Œå°½é‡è¿˜æ˜¯ä½¿ç”¨é“¾è¡¨\r\n- hash å€¼å¦‚æœè¶³å¤Ÿéšæœºï¼Œåˆ™åœ¨ hash è¡¨å†…æŒ‰æ³Šæ¾åˆ†å¸ƒï¼Œåœ¨è´Ÿè½½å› å­ 0.75 çš„æƒ…å†µä¸‹ï¼Œé•¿åº¦è¶…è¿‡ 8 çš„é“¾è¡¨å‡ºç°æ¦‚ç‡æ˜¯ 0.00000006ï¼Œæ ‘åŒ–é˜ˆå€¼é€‰æ‹© 8 å°±æ˜¯ä¸ºäº†è®©æ ‘åŒ–å‡ ç‡è¶³å¤Ÿå°\r\n\r\n**æ ‘åŒ–è§„åˆ™**\r\n\r\n- å½“é“¾è¡¨é•¿åº¦è¶…è¿‡æ ‘åŒ–é˜ˆå€¼ 8 æ—¶ï¼Œå…ˆå°è¯•æ‰©å®¹æ¥å‡å°‘é“¾è¡¨é•¿åº¦ï¼Œå¦‚æœæ•°ç»„å®¹é‡å·²ç» >=64ï¼Œæ‰ä¼šè¿›è¡Œæ ‘åŒ–\r\n\r\n**é€€åŒ–è§„åˆ™**\r\n\r\n- æƒ…å†µ1ï¼šåœ¨æ‰©å®¹æ—¶å¦‚æœæ‹†åˆ†æ ‘æ—¶ï¼Œæ ‘å…ƒç´ ä¸ªæ•° <= 6 åˆ™ä¼šé€€åŒ–é“¾è¡¨\r\n- æƒ…å†µ2ï¼šremove æ ‘èŠ‚ç‚¹æ—¶ï¼Œè‹¥ rootã€root.leftã€root.rightã€root.left.left æœ‰ä¸€ä¸ªä¸º null ï¼Œä¹Ÿä¼šé€€åŒ–ä¸ºé“¾è¡¨\r\n\r\n### 3ï¼‰ç´¢å¼•è®¡ç®—\r\n\r\n- å‰ç½®çŸ¥è¯†\r\n\r\n  - ä¸è¿ç®—ï¼ˆ&ï¼‰\r\n  \r\n  ```java\r\n  å‚åŠ è¿ç®—çš„ä¸¤ä¸ªæ•°æ®ï¼ŒæŒ‰äºŒè¿›åˆ¶ä½è¿›è¡Œâ€œä¸â€è¿ç®—ã€‚\r\n  \r\n  è¿ç®—è§„åˆ™ï¼š0&0=0;   0&1=0;    1&0=0;     1&1=1;\r\n  \r\n  å³ï¼šä¸¤ä½åŒæ—¶ä¸ºâ€œ1â€ï¼Œç»“æœæ‰ä¸ºâ€œ1â€ï¼Œå¦åˆ™ä¸º0\r\n  \r\n  ä¾‹å¦‚ï¼š3&5  å³ 0000 0011 & 0000 0101 = 0000 0001   å› æ­¤ï¼Œ3&5çš„å€¼å¾—1ã€‚\r\n  \r\n  ä¾‹å¦‚ï¼š9&5  å³ 0000 1001 (9çš„äºŒè¿›åˆ¶è¡¥ç )&00000101 (5çš„äºŒè¿›åˆ¶è¡¥ç ) =00000001 (1çš„äºŒè¿›åˆ¶è¡¥ç )å¯è§9&5=1ã€‚\r\n  ```\r\n  \r\n  - æˆ–è¿ç®—ï¼ˆ|ï¼‰\r\n  \r\n    ```\r\n    å‚åŠ è¿ç®—çš„ä¸¤ä¸ªå¯¹è±¡ï¼ŒæŒ‰äºŒè¿›åˆ¶ä½è¿›è¡Œâ€œæˆ–â€è¿ç®—ã€‚\r\n    \r\n    è¿ç®—è§„åˆ™ï¼š0|0=0ï¼›   0|1=1ï¼›   1|0=1ï¼›    1|1=1ï¼›\r\n    \r\n    å³ ï¼šå‚åŠ è¿ç®—çš„ä¸¤ä¸ªå¯¹è±¡åªè¦æœ‰ä¸€ä¸ªä¸º1ï¼Œå…¶å€¼ä¸º1ã€‚\r\n    \r\n    ä¾‹å¦‚:3|5ã€€å³ 0000 0011 | 0000 0101 = 0000 0111   å› æ­¤ï¼Œ3|5çš„å€¼å¾—7ã€‚ã€€\r\n    \r\n    ä¾‹å¦‚ï¼š9|5å¯å†™ç®—å¼å¦‚ä¸‹ï¼š 00001001|00000101 =00001101 (åè¿›åˆ¶ä¸º13)å¯è§9|5=13\r\n    ```\r\n  \r\n    \r\n  \r\n  - å¼‚æˆ–è¿ç®—ï¼ˆ^ï¼‰\r\n  \r\n  ```java\r\n  å‚åŠ è¿ç®—çš„ä¸¤ä¸ªæ•°æ®ï¼ŒæŒ‰äºŒè¿›åˆ¶ä½è¿›è¡Œâ€œå¼‚æˆ–â€è¿ç®—ã€‚\r\n  \r\n  è¿ç®—è§„åˆ™ï¼š0^0=0ï¼›   0^1=1ï¼›   1^0=1ï¼›   1^1=0ï¼›\r\n  \r\n  å³ï¼šå‚åŠ è¿ç®—çš„ä¸¤ä¸ªå¯¹è±¡ï¼Œå¦‚æœä¸¤ä¸ªç›¸åº”ä½ä¸ºâ€œå¼‚â€ï¼ˆå€¼ä¸åŒï¼‰ï¼Œåˆ™è¯¥ä½ç»“æœä¸º1ï¼Œå¦åˆ™ä¸º0ã€‚\r\n  \r\n  ä¾‹å¦‚ï¼š9^5å¯å†™æˆç®—å¼å¦‚ä¸‹ï¼š 00001001^00000101=00001100 (åè¿›åˆ¶ä¸º12)å¯è§9^5=12   \r\n  ```\r\n\r\n\r\n\r\n  ```java\r\n   01010(10)\r\n   10000(16)\r\n   11010(26)\r\n  ----------(10&16 = 0)\r\n  ----------(26&16 = 16)\r\n  newHash = 16+10     \r\n  ```\r\n\r\n```java\r\n8421ç æŒ‡çš„æ˜¯å››ä½äºŒè¿›åˆ¶æ•°ï¼Œä»0000~1001ï¼Œåˆ†åˆ«ä»£è¡¨åè¿›åˆ¶0~9ï¼Œå…¶æ¯ä½çš„æƒåˆ†åˆ«ä¸º$2^3$ï¼ˆ8ï¼‰ã€$2^2$ï¼ˆ4ï¼‰ã€$2^1$ï¼ˆ2ï¼‰ã€$2^0$ï¼ˆ1ï¼‰ã€‚é™¤äº†8421ç å¤–ï¼Œç±»ä¼¼çš„è¿˜æœ‰5421ç ã€‚\r\n```\r\n\r\n  - ç´¢å¼•å¦‚ä½•è®¡ç®—ï¼ŸhashCodeéƒ½æœ‰äº†ï¼Œä¸ºä½•è¿˜è¦æä¾›hash()æ–¹æ³•ï¼Ÿæ•°ç»„å®¹é‡ä¸ºä½•æ˜¯2çš„næ¬¡å¹‚ï¼Ÿ\r\n\r\n\r\n**ç´¢å¼•è®¡ç®—æ–¹æ³•**ï¼ˆ**ä¸ºäº†é…åˆå®¹é‡æ˜¯ 2 çš„ n æ¬¡å¹‚çš„ä¼˜åŒ–æ‰‹æ®µ** ï¼‰\r\n\r\n- é¦–å…ˆï¼Œè®¡ç®—å¯¹è±¡çš„ hashCode()\r\n\r\n- å†è¿›è¡Œè°ƒç”¨ HashMap çš„ hash() æ–¹æ³•è¿›è¡ŒäºŒæ¬¡å“ˆå¸Œ\r\n  - äºŒæ¬¡ hash() æ˜¯ä¸ºäº†ç»¼åˆé«˜ä½æ•°æ®ï¼Œè®©å“ˆå¸Œåˆ†å¸ƒæ›´ä¸ºå‡åŒ€ï¼›**è®¡ç®—hashCodeçš„å€¼è¶Šéšæœºï¼ŒhashCodeåˆ†å¸ƒå¾—è¶Šå‡åŒ€ï¼Œé“¾è¡¨å°±è¶Šä¸ä¼šæœ‰è¿‡é•¿çš„æƒ…å†µ**\r\n  \r\n    - HashMap1.8äºŒæ¬¡hash\r\n  \r\n    ![image-20230418201334955](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418201334955.png)\r\n  \r\n    - HashMap1.7äºŒæ¬¡hash\r\n  \r\n    ![image-20230418201418625](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418201418625.png)\r\n  \r\n  - hashCodeè¶³å¤Ÿå‡åŒ€\r\n  \r\n  ![image-20230418202517544](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418202517544.png)\r\n  \r\n  - hashCodeé€‰å–ä¸å¤Ÿå¥½ï¼Œä¸å¤Ÿéšæœº\r\n  \r\n  ![image-20230418202727603](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418202727603.png)\r\n  \r\n  ![image-20230418202829734](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418202829734.png)\r\n  \r\n  - è¿›è¡ŒäºŒæ¬¡hashæ‰°åŠ¨å‡½æ•°ï¼Œä½¿å¾—hashCodeåˆ†å¸ƒæ›´å‡åŒ€ï¼Œé˜²æ­¢è¶…é•¿é“¾è¡¨çš„äº§ç”Ÿ\r\n  \r\n  ![image-20230418203040744](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418203040744.png)\r\n  \r\n  ![image-20230418203513964](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418203513964.png)\r\n  \r\n- æœ€å & (capacity â€“ 1) å¾—åˆ°ç´¢å¼•ï¼ˆå®¹é‡capacityå¿…é¡»ä¸º2çš„næ¬¡å¹‚ï¼‰\r\n\r\n![image-20230418195049973](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418195049973.png)\r\n\r\n**æ•°ç»„å®¹é‡ä¸ºä½•æ˜¯ 2 çš„ n æ¬¡å¹‚**\r\n\r\n![image-20230418195337120](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418195337120.png)\r\n\r\n1. è®¡ç®—ç´¢å¼•æ—¶æ•ˆç‡æ›´é«˜ï¼šå¦‚æœæ˜¯ 2 çš„ n æ¬¡å¹‚å¯ä»¥ä½¿ç”¨ä½ä¸è¿ç®—ä»£æ›¿å–æ¨¡\r\n2. æ‰©å®¹æ—¶é‡æ–°è®¡ç®—ç´¢å¼•æ•ˆç‡æ›´é«˜ï¼š hash & oldCap == 0 çš„å…ƒç´ ç•™åœ¨åŸæ¥ä½ç½® ï¼Œå¦åˆ™æ–°ä½ç½® = æ—§ä½ç½® + oldCap =  10  + 16\r\n\r\n![image-20230418204559461](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418204559461.png)\r\n\r\n**æ³¨æ„**\r\n\r\n- äºŒæ¬¡ hash æ˜¯ä¸ºäº†é…åˆ **å®¹é‡æ˜¯ 2 çš„ n æ¬¡å¹‚** è¿™ä¸€è®¾è®¡å‰æï¼Œå¦‚æœ hash è¡¨çš„å®¹é‡ä¸æ˜¯ 2 çš„ n æ¬¡å¹‚ï¼Œåˆ™ä¸å¿…äºŒæ¬¡ hashï¼Œå³æƒ³è¦æ›´å¥½çš„hashåˆ†å¸ƒæ€§ï¼Œå®¹é‡å€¼å°±é€‰æ‹©è´¨æ•°\r\n\r\n![image-20230418210235261](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418210235261.png)\r\n\r\n- **å®¹é‡æ˜¯ 2 çš„ n æ¬¡å¹‚** è¿™ä¸€è®¾è®¡è®¡ç®—ç´¢å¼•æ•ˆç‡æ›´å¥½ï¼ˆè¿½æ±‚æ€§èƒ½ï¼‰ï¼Œä½† hash çš„åˆ†æ•£æ€§å°±ä¸å¥½ï¼Œéœ€è¦äºŒæ¬¡ hash æ¥ä½œä¸ºè¡¥å¿ï¼Œæ²¡æœ‰é‡‡ç”¨è¿™ä¸€è®¾è®¡çš„å…¸å‹ä¾‹å­æ˜¯ Hashtableï¼Œä»¥ä¸‹ä¸º Hashtable çš„æ‰©å®¹è§„å¾‹\r\n\r\n![image-20230418210834027](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418210834027.png)\r\n\r\n### 4ï¼‰put ä¸æ‰©å®¹\r\n\r\n**put æµç¨‹**\r\n\r\n- 1.8putæµç¨‹\r\n\r\n![image-20230419110228837](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419110228837.png)\r\n\r\n1. HashMap æ˜¯æ‡’æƒ°åˆ›å»ºæ•°ç»„çš„ï¼Œé¦–æ¬¡ä½¿ç”¨æ‰åˆ›å»ºæ•°ç»„\r\n2. è®¡ç®—ç´¢å¼•ï¼ˆæ¡¶ä¸‹æ ‡ï¼‰\r\n3. å¦‚æœæ¡¶ä¸‹æ ‡è¿˜æ²¡äººå ç”¨ï¼Œåˆ›å»º Node å ä½è¿”å›\r\n4. å¦‚æœæ¡¶ä¸‹æ ‡å·²ç»æœ‰äººå ç”¨\r\n   1. å·²ç»æ˜¯ TreeNode èµ°çº¢é»‘æ ‘çš„æ·»åŠ æˆ–æ›´æ–°é€»è¾‘\r\n   2. æ˜¯æ™®é€š Nodeï¼Œèµ°é“¾è¡¨çš„æ·»åŠ æˆ–æ›´æ–°é€»è¾‘ï¼Œå¦‚æœé“¾è¡¨é•¿åº¦è¶…è¿‡æ ‘åŒ–é˜ˆå€¼ï¼Œèµ°æ ‘åŒ–é€»è¾‘\r\n5. è¿”å›å‰æ£€æŸ¥å®¹é‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼ï¼Œä¸€æ—¦è¶…è¿‡è¿›è¡Œæ‰©å®¹\r\n\r\n**1.7 ä¸ 1.8 çš„åŒºåˆ«**\r\n\r\n1. é“¾è¡¨æ’å…¥èŠ‚ç‚¹æ—¶\r\n\r\n   1. 1.7 æ˜¯å¤´æ’æ³•\r\n\r\n   ![image-20230419110745737](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419110745737.png)\r\n\r\n   2. 1.8 æ˜¯å°¾æ’æ³•\r\n\r\n   ![image-20230419110538952](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419110538952.png)\r\n\r\n2. 1.7 æ˜¯å¤§äºç­‰äºé˜ˆå€¼ä¸”æ²¡æœ‰ç©ºä½æ—¶æ‰æ‰©å®¹\r\n\r\n   ![image-20230419112014919](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419112014919.png)\r\n\r\n3. è€Œ 1.8 æ˜¯å¤§äºé˜ˆå€¼å°±æ‰©å®¹\r\n\r\n4. 1.8 åœ¨æ‰©å®¹è®¡ç®— Node ç´¢å¼•æ—¶ï¼Œä¼šä¼˜åŒ–\r\n\r\n   - hash & oldCap == 0 çš„å…ƒç´ ç•™åœ¨åŸæ¥ä½ç½® ï¼Œå¦åˆ™æ–°ä½ç½® = æ—§ä½ç½® + oldCap =  10  + 16\r\n\r\n**æ‰©å®¹ï¼ˆåŠ è½½ï¼‰å› å­ä¸ºä½•é»˜è®¤æ˜¯ 0.75f**\r\n\r\n1. åœ¨ç©ºé—´å ç”¨ä¸æŸ¥è¯¢æ—¶é—´ä¹‹é—´å–å¾—è¾ƒå¥½çš„æƒè¡¡\r\n2. å¤§äºè¿™ä¸ªå€¼ï¼Œç©ºé—´èŠ‚çœäº†ï¼Œä½†é“¾è¡¨å°±ä¼šæ¯”è¾ƒé•¿å½±å“æ€§èƒ½\r\n\r\n   ![image-20230419112518996](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419112518996.png)\r\n\r\n3. å°äºè¿™ä¸ªå€¼ï¼Œå†²çªå‡å°‘äº†ï¼Œä½†æ‰©å®¹å°±ä¼šæ›´é¢‘ç¹ï¼Œç©ºé—´å ç”¨ä¹Ÿæ›´å¤š\r\n\r\n![image-20230419112817313](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419112817313.png)\r\n\r\n> è®¡ç®—æ¡¶ä¸‹æ ‡ï¼šhash()â†’`(hashcode >>> 16 ^ hashcode )&(capacity-1)`\r\n> capacityä¸º2çš„næ¬¡å¹‚ï¼Œè®¡ç®—ç´¢å¼•æ•ˆç‡æ›´é«˜ï¼Œä½†å“ˆå¸Œåˆ†å¸ƒä¸å‡åŒ€ï¼›capacityä¸ºè´¨æ•°æ—¶å“ˆå¸Œåˆ†å¸ƒå‡åŒ€ï¼ˆhashtableï¼‰ã€‚\r\n> hashmap1.8:è¶…è¿‡å®¹é‡æ‰©å®¹é˜ˆå€¼ï¼ˆï¼Â¾ï¼‰ï¼Œå…ˆåˆ›å»ºæ‰©å®¹æ–°æ•°ç»„å†å°†æ•°æ®è¿ç§»åˆ°æ–°æ•°ç»„ï¼›é“¾è¡¨æ’å…¥æ–¹å¼ä¸ºå°¾æ’æ³•\r\n> 1.7:é“¾è¡¨æ’å…¥æ–¹å¼ä¸ºå¤´æ’æ³•ï¼›\r\n\r\n### 5ï¼‰å¹¶å‘é—®é¢˜\r\n\r\n1.7é“¾è¡¨è¿ç§»è¿‡ç¨‹(aå’Œbè¿ç§»å‰åéƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œåªæ˜¯æ”¹å˜äº†å®ƒä»¬çš„ä¸€äº›å¼•ç”¨åœ°å€ï¼Œå¹¶æ²¡æœ‰å‘ç”Ÿå¯¹è±¡çš„åˆ›å»º)\r\n\r\n![image-20230419121302636](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419121302636.png)\r\n\r\n**æ‰©å®¹æ­»é“¾ï¼ˆ1.7 ä¼šå­˜åœ¨ï¼‰**\r\n\r\n1.7 æºç å¦‚ä¸‹ï¼š\r\n\r\n```java\r\nvoid transfer(Entry[] newTable, boolean rehash) {\r\n    int newCapacity = newTable.length;\r\n    for (Entry<K,V> e : table) {\r\n        while(null != e) {\r\n            Entry<K,V> next = e.next;\r\n            if (rehash) {\r\n                e.hash = null == e.key ? 0 : hash(e.key);\r\n            }\r\n            int i = indexFor(e.hash, newCapacity);\r\n            e.next = newTable[i];\r\n            newTable[i] = e;\r\n            e = next;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n- e å’Œ next éƒ½æ˜¯å±€éƒ¨å˜é‡ï¼Œç”¨æ¥æŒ‡å‘å½“å‰èŠ‚ç‚¹å’Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r\n- çº¿ç¨‹1ï¼ˆç»¿è‰²ï¼‰çš„ä¸´æ—¶å˜é‡ e å’Œ next åˆšå¼•ç”¨äº†è¿™ä¿©èŠ‚ç‚¹ï¼Œè¿˜æœªæ¥å¾—åŠç§»åŠ¨èŠ‚ç‚¹ï¼Œå‘ç”Ÿäº†çº¿ç¨‹åˆ‡æ¢ï¼Œç”±çº¿ç¨‹2ï¼ˆè“è‰²ï¼‰å®Œæˆæ‰©å®¹å’Œè¿ç§»\r\n\r\n![image-20210831084325075](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831084325075.png)\r\n\r\n- çº¿ç¨‹2 æ‰©å®¹å®Œæˆï¼Œç”±äºå¤´æ’æ³•ï¼Œé“¾è¡¨é¡ºåºé¢ å€’ã€‚ä½†çº¿ç¨‹1 çš„ä¸´æ—¶å˜é‡ e å’Œ next è¿˜å¼•ç”¨äº†è¿™ä¿©èŠ‚ç‚¹ï¼Œè¿˜è¦å†æ¥ä¸€éè¿ç§»\r\n\r\n![image-20210831084723383](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831084723383.png)\r\n\r\n- ç¬¬ä¸€æ¬¡å¾ªç¯\r\n  - å¾ªç¯æ¥ç€çº¿ç¨‹åˆ‡æ¢å‰è¿è¡Œï¼Œæ³¨æ„æ­¤æ—¶ e æŒ‡å‘çš„æ˜¯èŠ‚ç‚¹ aï¼Œnext æŒ‡å‘çš„æ˜¯èŠ‚ç‚¹ b\r\n  - e å¤´æ’ a èŠ‚ç‚¹ï¼Œæ³¨æ„å›¾ä¸­ç”»äº†ä¸¤ä»½ a èŠ‚ç‚¹ï¼Œä½†äº‹å®ä¸Šåªæœ‰ä¸€ä¸ªï¼ˆä¸ºäº†ä¸è®©ç®­å¤´ç‰¹åˆ«ä¹±ç”»äº†ä¸¤ä»½ï¼‰\r\n\r\n  ![image-20210831084855348](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831084855348.png)\r\n\r\n  - å½“å¾ªç¯ç»“æŸæ˜¯ e ä¼šæŒ‡å‘ next ä¹Ÿå°±æ˜¯ b èŠ‚ç‚¹\r\n\r\n![image-20230419121935915](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419121935915.png)\r\n\r\n\r\n\r\n\r\n\r\n- ç¬¬äºŒæ¬¡å¾ªç¯\r\n  - ç¬¬äºŒè½®å¼€å§‹ï¼Œnext æŒ‡å‘äº†èŠ‚ç‚¹ a\r\n  - e å¤´æ’èŠ‚ç‚¹ b\r\n  \r\n  ![image-20210831085329449](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831085329449.png)\r\n  \r\n  - å½“å¾ªç¯ç»“æŸæ—¶ï¼Œe æŒ‡å‘ next ä¹Ÿå°±æ˜¯èŠ‚ç‚¹ a\r\n\r\n![image-20230419122220312](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419122220312.png)\r\n\r\n\r\n\r\n- ç¬¬ä¸‰æ¬¡å¾ªç¯\r\n  - next æŒ‡å‘äº† null\r\n  \r\n  ![image-20230419133332478](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419133332478.png)\r\n  \r\n  - e å¤´æ’èŠ‚ç‚¹ aï¼Œ**a çš„ next æŒ‡å‘äº† b**ï¼ˆä¹‹å‰ a.next ä¸€ç›´æ˜¯ nullï¼‰ï¼Œb çš„ next æŒ‡å‘ aï¼Œæ­»é“¾å·²æˆ\r\n  \r\n  ![image-20210831085543224](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831085543224.png)\r\n  \r\n  - å½“å¾ªç¯ç»“æŸæ—¶ï¼Œe æŒ‡å‘ next ä¹Ÿå°±æ˜¯ nullï¼Œå› æ­¤ç¬¬å››æ¬¡å¾ªç¯æ—¶ä¼šæ­£å¸¸é€€å‡º\r\n\r\n![image-20230419133643654](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419133643654.png)\r\n\r\n**æ•°æ®é”™ä¹±ï¼ˆ1.7ï¼Œ1.8 éƒ½ä¼šå­˜åœ¨ï¼‰**\r\n\r\n- ä»£ç å‚è€ƒ `day01.map.HashMapMissData`ï¼Œå…·ä½“è°ƒè¯•æ­¥éª¤å‚è€ƒè§†é¢‘\r\n\r\n![image-20230419115103985](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419115103985.png)\r\n\r\n> ***è¡¥å……ä»£ç è¯´æ˜***\r\n>\r\n> - day01.map.HashMapDistribution æ¼”ç¤º map ä¸­é“¾è¡¨é•¿åº¦ç¬¦åˆæ³Šæ¾åˆ†å¸ƒ\r\n> - day01.map.DistributionAffectedByCapacity æ¼”ç¤ºå®¹é‡åŠ hashCode å–å€¼å¯¹åˆ†å¸ƒçš„å½±å“\r\n>   - day01.map.DistributionAffectedByCapacity#hashtableGrowRule æ¼”ç¤ºäº† Hashtable çš„æ‰©å®¹è§„å¾‹\r\n>   - day01.sort.Utils#randomArray å¦‚æœ hashCode è¶³å¤Ÿéšæœºï¼Œå®¹é‡æ˜¯å¦æ˜¯ 2 çš„ n æ¬¡å¹‚å½±å“ä¸å¤§\r\n>   - day01.sort.Utils#lowSameArray å¦‚æœ hashCode ä½ä½ä¸€æ ·çš„å¤šï¼Œå®¹é‡æ˜¯ 2 çš„ n æ¬¡å¹‚ä¼šå¯¼è‡´åˆ†å¸ƒä¸å‡åŒ€\r\n>   - day01.sort.Utils#evenArray å¦‚æœ hashCode å¶æ•°çš„å¤šï¼Œå®¹é‡æ˜¯ 2 çš„ n æ¬¡å¹‚ä¼šå¯¼è‡´åˆ†å¸ƒä¸å‡åŒ€\r\n>   - ç”±æ­¤å¾—å‡ºå¯¹äºå®¹é‡æ˜¯ 2 çš„ n æ¬¡å¹‚çš„è®¾è®¡æ¥è®²ï¼ŒäºŒæ¬¡ hash éå¸¸é‡è¦\r\n> - day01.map.HashMapVsHashtable æ¼”ç¤ºäº†å¯¹äºåŒæ ·æ•°é‡çš„å•è¯å­—ç¬¦ä¸²æ”¾å…¥ HashMap å’Œ Hashtable åˆ†å¸ƒä¸Šçš„åŒºåˆ«\r\n\r\n### 6ï¼‰key çš„è®¾è®¡\r\n\r\n**key çš„è®¾è®¡è¦æ±‚**\r\n\r\n1. HashMap çš„ key å¯ä»¥ä¸º nullï¼Œä½† Map çš„å…¶ä»–å®ç°åˆ™ä¸ç„¶\r\n2. ä½œä¸º key çš„å¯¹è±¡ï¼Œå¿…é¡»å®ç° hashCode å’Œ equalsï¼Œå¹¶ä¸” **key çš„å†…å®¹ä¸èƒ½ä¿®æ”¹ï¼ˆä¸å¯å˜ï¼‰**\r\n   - é‡å†™hashCodeæ–¹æ³•æ˜¯ä¸ºäº†è®©æˆ‘ä»¬çš„keyåœ¨æ•´ä¸ªHashMapä¸­æœ‰æ›´å¥½çš„åˆ†å¸ƒæ€§ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½\r\n   - é‡å†™equalsæ–¹æ³•æ˜¯ä¸ºäº†å°†æ¥å¦‚æœè®¡ç®—ä¸¤ä¸ªå¯¹è±¡çš„keyçš„ç´¢å¼•éƒ½ä¸€æ ·ï¼Œè¿›ä¸€æ­¥éœ€è¦ç”¨equalsè¿›è¡Œæ¯”è¾ƒï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ä¸¤ä¸ªç›¸åŒçš„å¯¹è±¡\r\n   - ä¸¤ä¸ªå¯¹è±¡çš„hashCodeç›¸ç­‰ï¼Œequalsä¸ä¸€å®šç›¸ç­‰ï¼›ä¸¤ä¸ªå¯¹è±¡çš„equalsç›¸ç­‰ï¼ŒhashCodeä¸€å®šç›¸ç­‰\r\n\r\n3. key çš„ hashCode åº”è¯¥æœ‰è‰¯å¥½çš„æ•£åˆ—æ€§\r\n\r\nå¦‚æœ key å¯å˜ï¼Œä¾‹å¦‚ä¿®æ”¹äº† age ä¼šå¯¼è‡´å†æ¬¡æŸ¥è¯¢æ—¶æŸ¥è¯¢ä¸åˆ°ï¼Œå› æ­¤å¹³æ—¶ç”¨æ•´æ•°ã€å­—ç¬¦ä¸²ç­‰ä½œä¸ºkeyï¼Œè¿™äº›ç±»çš„å†…å®¹ä¸å¯å˜\r\n\r\n![image-20230419134838699](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419134838699.png)\r\n\r\n```java\r\npublic class HashMapMutableKey {\r\n    public static void main(String[] args) {\r\n        HashMap<Student, Object> map = new HashMap<>();\r\n        Student stu = new Student(\"å¼ ä¸‰\", 18);\r\n        map.put(stu, new Object());\r\n\r\n        System.out.println(map.get(stu));\r\n\r\n        stu.age = 19;\r\n        System.out.println(map.get(stu));\r\n    }\r\n\r\n    static class Student {\r\n        String name;\r\n        int age;\r\n\r\n        public Student(String name, int age) {\r\n            this.name = name;\r\n            this.age = age;\r\n        }\r\n\r\n        public String getName() {\r\n            return name;\r\n        }\r\n\r\n        public void setName(String name) {\r\n            this.name = name;\r\n        }\r\n\r\n        public int getAge() {\r\n            return age;\r\n        }\r\n\r\n        public void setAge(int age) {\r\n            this.age = age;\r\n        }\r\n\r\n        @Override\r\n        public boolean equals(Object o) {\r\n            if (this == o) return true;\r\n            if (o == null || getClass() != o.getClass()) return false;\r\n            Student student = (Student) o;\r\n            return age == student.age && Objects.equals(name, student.name);\r\n        }\r\n\r\n        @Override\r\n        public int hashCode() {\r\n            return Objects.hash(name, age);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n**String å¯¹è±¡çš„ hashCode() è®¾è®¡**\r\n\r\n- ç›®æ ‡æ˜¯è¾¾åˆ°è¾ƒä¸ºå‡åŒ€çš„æ•£åˆ—æ•ˆæœï¼Œæ¯ä¸ªå­—ç¬¦ä¸²çš„ hashCode è¶³å¤Ÿç‹¬ç‰¹\r\n- å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦éƒ½å¯ä»¥è¡¨ç°ä¸ºä¸€ä¸ªæ•°å­—ï¼Œç§°ä¸º $S_i$ï¼Œå…¶ä¸­ i çš„èŒƒå›´æ˜¯ 0 ~ n - 1\r\n- æ•£åˆ—å…¬å¼ä¸ºï¼š$S_0âˆ—31^{n-1}+S_1âˆ—31^{n-2}+â€¦ S_iâˆ—31^{n-1-i}+â€¦S_{n-1}âˆ—31^0$\r\n- 31 ä»£å…¥å…¬å¼æœ‰è¾ƒå¥½çš„æ•£åˆ—ç‰¹æ€§ï¼Œå¹¶ä¸” 31 * h å¯ä»¥è¢«ä¼˜åŒ–ä¸º\r\n  - å³ $32 âˆ—h -h$\r\n  - å³ $2^5 âˆ—h -h$\r\n  - å³ $hâ‰ª5 -h$\r\n\r\n![image-20230419135639704](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419135639704.png)\r\n\r\n## 4.1. HashMap-å¿«é€ŸæŸ¥æ‰¾\r\n\r\n- ArrayListæŸ¥æ‰¾æ•ˆç‡è¾ƒä½\r\n\r\n![image-20230418161635803](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418161635803.png)\r\n\r\n- HashMapé€šè¿‡ç´¢å¼•è®¡ç®—ç›´æ¥æ‰¾åˆ°å…ƒç´ (hashè¿ç®—)ï¼Œæ— é“¾è¡¨æƒ…å†µæŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œæœ‰é“¾è¡¨æƒ…å†µå°±çœ‹é“¾è¡¨é•¿åº¦äº†ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)\r\n\r\n![image-20230418161857746](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418161857746.png)\r\n\r\n## 4.2. HashMap-é“¾è¡¨è¿‡é•¿çš„è§£å†³æ–¹æ¡ˆ\r\n\r\n- å½¢æˆé“¾è¡¨ï¼škeysç›¸åŒçš„å›ºå®šhashï¼›keysçš„hash%å®¹é‡ç›¸åŒ\r\n\r\n### 4.2.1.æ‰©å®¹\r\n\r\n- æ­£å¸¸æƒ…å†µ\r\n\r\n![image-20230418162855531](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418162855531.png)\r\n\r\n![image-20230418162904156](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418162904156.png)\r\n\r\n![image-20230418162909932](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418162909932.png)\r\n\r\n- æç«¯æƒ…å†µï¼Œåªèƒ½æ ‘åŒ–ä¸ºçº¢é»‘æ ‘äº†\r\n\r\n![image-20230418162935840](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418162935840.png)\r\n\r\n### 4.2.2. æ ‘åŒ–\r\n\r\n- é“¾è¡¨->çº¢é»‘æ ‘ï¼šå½“å®¹é‡ä¸º16ï¼Œåœ¨æŸä¸ªæ¡¶ä¸‹æ ‡å½¢æˆé“¾è¡¨çš„8ä¸ªå…ƒç´ æ·»åŠ å…ƒç´ ï¼Œä»…è¿›è¡Œæ‰©å®¹ä¸º32ï¼Œå†æ·»åŠ æ‰©å®¹åˆ°64æ‰ä¼šæ ‘åŒ–\r\n\r\n![image-20230418164530243](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418164530243.png)\r\n\r\n![image-20230418165555721](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418165555721.png)\r\n\r\n- æ»¡è¶³æ ‘åŒ–æ¡ä»¶(å®¹é‡>=64ä¸”é“¾è¡¨é•¿åº¦>8)ï¼Œçº¢é»‘æ ‘çˆ¶èŠ‚ç‚¹å·¦ä¾§éƒ½æ˜¯æ¯”å®ƒå°çš„å…ƒç´ ï¼Œå³ä¾§éƒ½æ˜¯æ¯”å®ƒå¤§çš„å…ƒç´ ï¼Œå­èŠ‚ç‚¹åŒç†ï¼Œhashç ç›¸åŒæ—¶æ‰æ¯”è¾ƒï¼ŒæŒ‰ç…§keyçš„å­—ç¬¦ä¸²å€¼æ¯”è¾ƒï¼ŒæŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(log2(n))\r\n\r\n![image-20230418165707584](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418165707584.png)\r\n\r\n- é“¾è¡¨é•¿åº¦æ˜¯å¯èƒ½å‡ºç°è¶…è¿‡8çš„æƒ…å†µ\r\n\r\n![image-20230418170758857](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418170758857.png)\r\n\r\n\r\n\r\n#### çº¢é»‘æ ‘çš„æ„ä¹‰-æ ‘åŒ–é˜ˆå€¼\r\n\r\n- ä¸ºä½•è¦ç”¨çº¢é»‘æ ‘ï¼Œä¸ºä½•ä¸€ä¸Šæ¥ä¸æ ‘åŒ–ï¼Œæ ‘åŒ–é˜ˆå€¼ä¸ºä½•æ˜¯8ï¼Œä½•æ—¶ä¼šæ ‘åŒ–ï¼Œä½•æ—¶ä¼šé€€åŒ–ä¸ºé“¾è¡¨ï¼Ÿ\r\n\r\n  - å› ä¸ºé“¾è¡¨è¾ƒé•¿æ—¶ä¼šå½±å“æ•´ä¸ªHashMapçš„æ€§èƒ½ï¼Œ1.8ä¹‹åå¼•å…¥çº¢é»‘æ ‘ï¼Œå³ä½¿é“¾è¡¨è¾ƒé•¿ä¹Ÿä¸ä¼šå¯¹æ€§èƒ½æœ‰å¤ªå¤§çš„å½±å“\r\n\r\n  - é“¾è¡¨->çº¢é»‘æ ‘ï¼šå½“å®¹é‡ä¸º16ï¼Œåœ¨æŸä¸ªæ¡¶ä¸‹æ ‡å½¢æˆé“¾è¡¨çš„8ä¸ªå…ƒç´ æ·»åŠ å…ƒç´ ï¼Œä»…è¿›è¡Œæ‰©å®¹ä¸º32ï¼Œå†æ·»åŠ æ‰©å®¹åˆ°64æ‰ä¼šæ ‘åŒ–\r\n  - é“¾è¡¨çŸ­çš„æ—¶å€™ï¼Œé“¾è¡¨æ€§èƒ½å¤§äºçº¢é»‘æ ‘ï¼Œé“¾è¡¨é•¿æ—¶æ€§èƒ½æ‰è¿œè¿œä¸å¦‚çº¢é»‘æ ‘ï¼Œä¸”çº¢é»‘æ ‘å ç”¨å†…å­˜æ¯”é“¾è¡¨å¤§å¾—å¤šï¼Œéå¿…è¦ä¸æ ‘åŒ–\r\n  - çº¢é»‘æ ‘æ˜¯ä¸€ç§éæ­£å¸¸æƒ…å†µï¼Œä¸‹å›¾ä¸º23Wå¤šä¸ªæ­£å¸¸å•è¯çš„hashåˆ†å¸ƒæƒ…å†µï¼Œè‹¥æ²¡æœ‰åˆ»æ„æ„é€ hashç ï¼Œåœ¨è´Ÿè½½å› å­0.75çš„æƒ…å†µä¸‹ï¼Œé“¾è¡¨å‡ºç°8çš„æ¦‚ç‡éå¸¸ä½ï¼Œä¸º0.00000006\r\n\r\n  ![image-20230418181214309](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418181214309.png)\r\n\r\n  - çº¢é»‘æ ‘ç”¨æ¥é¿å… DoS æ”»å‡»ï¼Œé˜²æ­¢é“¾è¡¨è¶…é•¿æ—¶æ€§èƒ½ä¸‹é™ï¼Œæ ‘åŒ–åº”å½“æ˜¯å¶ç„¶æƒ…å†µï¼Œæ˜¯ä¿åº•ç­–ç•¥\r\n\r\n\r\n\r\n#### æ ‘é€€åŒ–é“¾è¡¨-æƒ…å†µ1\r\n\r\n- åœ¨æ‰©å®¹æ—¶å¦‚æœæ‹†åˆ†æ ‘æ—¶ï¼Œæ ‘å…ƒç´ ä¸ªæ•° <= 6 åˆ™ä¼šé€€åŒ–é“¾è¡¨\r\n\r\n![image-20230418183806555](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418183806555.png)\r\n\r\n- åœ¨æ‰©å®¹æ—¶å¦‚æœæ‹†åˆ†æ ‘æ—¶ï¼Œæ ‘å…ƒç´ ä¸ªæ•° > 6 åˆ™ä¸ä¼šé€€åŒ–é“¾è¡¨\r\n\r\n![image-20230418184454141](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418184454141.png)\r\n\r\n\r\n\r\n#### æ ‘é€€åŒ–é“¾è¡¨-æƒ…å†µ2\r\n\r\n- remove æ ‘èŠ‚ç‚¹æ—¶ï¼Œè‹¥ root(çˆ·)ã€root.left(å·¦å­©å­)ã€root.right(å³å­©å­)ã€root.left.left(å·¦å­™å­) æœ‰ä¸€ä¸ªä¸º null ï¼Œä¹Ÿä¼šé€€åŒ–ä¸ºé“¾è¡¨\r\n\r\n![image-20230418192832140](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418192832140.png)\r\n\r\n- ä¾‹å­2\r\n\r\n![image-20230418193518600](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230418193518600.png)\r\n\r\n\r\n\r\n\r\n\r\n## 5. å•ä¾‹æ¨¡å¼\r\n\r\n**è¦æ±‚**\r\n\r\n- æŒæ¡äº”ç§å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼\r\n- ç†è§£ä¸ºä½• DCL å®ç°æ—¶è¦ä½¿ç”¨ volatile ä¿®é¥°é™æ€å˜é‡\r\n- äº†è§£ jdk ä¸­ç”¨åˆ°å•ä¾‹çš„åœºæ™¯\r\n\r\n### **é¥¿æ±‰å¼**\r\n\r\n- æå‰åˆ›å»ºå•ä¾‹å¯¹è±¡\r\n\r\n![image-20230419141144975](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419141144975.png)\r\n\r\n- å®ç°Serializableæ¥å£åˆ©ç”¨åå°„ç ´åå•ä¾‹\r\n\r\n![image-20230419141539054](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419141539054.png)\r\n\r\n- ååºåˆ—åŒ–ç ´åå•ä¾‹\r\n\r\n![image-20230419142100218](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419142100218.png)\r\n\r\n```java\r\npublic class Singleton1 implements Serializable {\r\n    private Singleton1() {\r\n        if (INSTANCE != null) {\r\n            throw new RuntimeException(\"å•ä¾‹å¯¹è±¡ä¸èƒ½é‡å¤åˆ›å»º\");\r\n        }\r\n        System.out.println(\"private Singleton1()\");\r\n    }\r\n\r\n    private static final Singleton1 INSTANCE = new Singleton1();\r\n\r\n    public static Singleton1 getInstance() {\r\n        return INSTANCE;\r\n    }\r\n\r\n    public static void otherMethod() {\r\n        System.out.println(\"otherMethod()\");\r\n    }\r\n\r\n    public Object readResolve() {\r\n        return INSTANCE;\r\n    }\r\n}\r\n```\r\n\r\n- æ„é€ æ–¹æ³•æŠ›å‡ºå¼‚å¸¸æ˜¯é˜²æ­¢åå°„ç ´åå•ä¾‹\r\n\r\n![image-20230419141740516](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419141740516.png)\r\n\r\n- `readResolve()` æ˜¯é˜²æ­¢ååºåˆ—åŒ–ç ´åå•ä¾‹\r\n\r\n![image-20230419142253512](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419142253512.png)\r\n\r\n- unsafeç ´åå•ä¾‹\r\n\r\n![image-20230419142613493](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419142613493.png)\r\n\r\n### **æšä¸¾é¥¿æ±‰å¼**\r\n\r\n- æšä¸¾ç±»ä¸€åŠ è½½å¹¶åˆå§‹åŒ–ï¼Œå°±ä¼šæŠŠæšä¸¾å¯¹è±¡åˆ›å»ºå‡ºæ¥\r\n\r\n![image-20230419143438750](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419143438750.png)\r\n\r\n![image-20230419143148474](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419143148474.png)\r\n\r\n```java\r\npublic enum Singleton2 {\r\n    INSTANCE;\r\n\r\n    private Singleton2() {\r\n        System.out.println(\"private Singleton2()\");\r\n    }\r\n\r\n    @Override\r\n    public String toString() {\r\n        return getClass().getName() + \"@\" + Integer.toHexString(hashCode());\r\n    }\r\n\r\n    public static Singleton2 getInstance() {\r\n        return INSTANCE;\r\n    }\r\n\r\n    public static void otherMethod() {\r\n        System.out.println(\"otherMethod()\");\r\n    }\r\n}\r\n```\r\n\r\n- æšä¸¾é¥¿æ±‰å¼èƒ½å¤©ç„¶é˜²æ­¢åå°„ã€ååºåˆ—åŒ–ç ´åå•ä¾‹\r\n\r\n![image-20230419144121454](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419144121454.png)\r\n\r\n![image-20230419143856798](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419143856798.png)\r\n\r\n![image-20230419143639529](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419143639529.png)\r\n\r\n- unsafeä¾æ—§å¯ä»¥ç ´åæšä¸¾å•ä¾‹\r\n\r\n![image-20230419144327173](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419144327173.png)\r\n\r\n![image-20230419144146527](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419144146527.png)\r\n\r\n### **æ‡’æ±‰å¼**\r\n\r\n- ç¬¬ä¸€æ¬¡è°ƒç”¨getInstanceæ–¹æ³•æ—¶æ‰åˆ›å»ºå•ä¾‹å¯¹è±¡(éçº¿ç¨‹å®‰å…¨)\r\n\r\n![image-20230419144620623](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419144620623.png)\r\n\r\n```java\r\npublic class Singleton3 implements Serializable {\r\n    private Singleton3() {\r\n        System.out.println(\"private Singleton3()\");\r\n    }\r\n\r\n    private static Singleton3 INSTANCE = null;\r\n\r\n    // Singleton3.class  synchronizedåŠ åœ¨æ–¹æ³•ä¸Šï¼Œæ€§èƒ½ä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œå› ä¸ºå•ä¾‹å¯¹è±¡åˆ›å»ºå¥½ä»¥åï¼Œå…¶ä»–çº¿ç¨‹æ¥è®¿é—®è¯¥åŒæ­¥æ–¹æ³•æ—¶æ— éœ€å†åŠ é”äº†ï¼Œåç»­çš„æ“ä½œä¸ç”¨å†è¿›è¡ŒåŒæ­¥å’Œäº’æ–¥ä¿æŠ¤äº†ï¼Œä¸ç„¶å°±å½±å“æ€§èƒ½äº†ï¼Œåªæœ‰é¦–æ¬¡åˆ›å»ºå•ä¾‹æ˜¯æ‰è¿›è¡Œçº¿ç¨‹å®‰å…¨çš„ä¿æŠ¤\r\n    public static synchronized Singleton3 getInstance() {\r\n        if (INSTANCE == null) {\r\n            INSTANCE = new Singleton3();\r\n        }\r\n        return INSTANCE;\r\n    }\r\n\r\n    public static void otherMethod() {\r\n        System.out.println(\"otherMethod()\");\r\n    }\r\n\r\n}\r\n```\r\n\r\n- å…¶å®åªæœ‰é¦–æ¬¡åˆ›å»ºå•ä¾‹å¯¹è±¡æ—¶æ‰éœ€è¦åŒæ­¥ï¼Œä½†è¯¥ä»£ç å®é™…ä¸Šæ¯æ¬¡è°ƒç”¨éƒ½ä¼šåŒæ­¥\r\n- å› æ­¤æœ‰äº†ä¸‹é¢çš„åŒæ£€é”æ”¹è¿›\r\n\r\n### **åŒæ£€é”æ‡’æ±‰å¼**\r\n\r\n- å°‘äº†å†…å±‚åˆ¤æ–­è¿˜æ˜¯ä¼šé‡å¤åˆ›å»ºå¯¹è±¡\r\n\r\n![image-20230419145814990](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419145814990.png)\r\n\r\n```java\r\npublic class Singleton4 implements Serializable {\r\n    private Singleton4() {\r\n        System.out.println(\"private Singleton4()\");\r\n    }\r\n\r\n    private static volatile Singleton4 INSTANCE = null; // å¯è§æ€§ï¼Œæœ‰åºæ€§\r\n\r\n    public static Singleton4 getInstance() {\r\n        if (INSTANCE == null) {\r\n            synchronized (Singleton4.class) {\r\n                if (INSTANCE == null) {\r\n                    INSTANCE = new Singleton4();\r\n                }\r\n            }\r\n        }\r\n        return INSTANCE;\r\n    }\r\n\r\n    public static void otherMethod() {\r\n        System.out.println(\"otherMethod()\");\r\n    }\r\n}\r\n```\r\n\r\n![image-20230419145942353](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419145942353.png)\r\n\r\n\r\n\r\n![image-20230419151419398](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419151419398.png)\r\n\r\nä¸ºä½•å¿…é¡»åŠ  volatileï¼š\r\n\r\n- `INSTANCE = new Singleton4()` ä¸æ˜¯åŸå­çš„ï¼Œåˆ†æˆ 3 æ­¥ï¼šåˆ›å»ºå¯¹è±¡ã€è°ƒç”¨æ„é€ ã€ç»™é™æ€å˜é‡èµ‹å€¼ï¼Œå…¶ä¸­åä¸¤æ­¥å¯èƒ½è¢«æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ï¼Œå˜æˆå…ˆèµ‹å€¼ã€å†è°ƒç”¨æ„é€ \r\n- å¦‚æœçº¿ç¨‹1 å…ˆæ‰§è¡Œäº†èµ‹å€¼ï¼Œçº¿ç¨‹2 æ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ª `INSTANCE == null` æ—¶å‘ç° INSTANCE å·²ç»ä¸ä¸º nullï¼Œæ­¤æ—¶å°±ä¼šè¿”å›ä¸€ä¸ªæœªå®Œå…¨æ„é€ çš„å¯¹è±¡\r\n\r\n![image-20230419153459527](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419153459527.png)\r\n\r\n### **å†…éƒ¨ç±»æ‡’æ±‰å¼**\r\n\r\n```java\r\npublic class Singleton5 implements Serializable {\r\n    private Singleton5() {\r\n        System.out.println(\"private Singleton5()\");\r\n    }\r\n\r\n    private static class Holder {\r\n        static Singleton5 INSTANCE = new Singleton5();\r\n    }\r\n\r\n    public static Singleton5 getInstance() {\r\n        return Holder.INSTANCE;\r\n    }\r\n\r\n    public static void otherMethod() {\r\n        System.out.println(\"otherMethod()\");\r\n    }\r\n}\r\n```\r\n\r\n![image-20230419154215932](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419154215932.png)\r\n\r\n- é¿å…äº†åŒæ£€é”çš„ç¼ºç‚¹\r\n\r\n> volatileä¿®é¥°å…±äº«å˜é‡å¯ä»¥è§£å†³æŒ‡ä»¤é‡æ’åº(æ‡’æ±‰å•ä¾‹-DCL(åŒæ£€ç´¢))\r\n> ç»™é™æ€å˜é‡èµ‹å€¼è‚¯å®šä¼šæ”¾åˆ°é™æ€ä»£ç å—é‡Œæ‰§è¡Œï¼Œé™æ€ä»£ç å—é‡Œçš„ä»£ç ç”±JVMæ¥ä¿è¯ï¼Œåˆ™é¥¿æ±‰å¼ä¸ç”¨è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œæšä¸¾é¥¿æ±‰å¼åŒç†\r\n\r\n### **JDK ä¸­å•ä¾‹çš„ä½“ç°**\r\n\r\n- Runtime ä½“ç°äº†é¥¿æ±‰å¼å•ä¾‹\r\n\r\n![image-20230419154748392](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419154748392.png)\r\n\r\n- Console ä½“ç°äº†åŒæ£€é”æ‡’æ±‰å¼å•ä¾‹\r\n\r\n![image-20230419154859774](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419154859774.png)\r\n\r\n- Collections ä¸­çš„ EmptyNavigableSet å†…éƒ¨ç±»æ‡’æ±‰å¼å•ä¾‹\r\n\r\n![image-20230419155254327](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419155254327.png)\r\n\r\n![image-20230419155346324](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419155346324.png)\r\n\r\n- å…¶ä»–å†…éƒ¨ç±»æ‡’æ±‰å¼ä¾‹å­\r\n\r\n![image-20230419155525101](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419155525101.png)\r\n\r\n![image-20230419155558145](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419155558145.png)\r\n\r\n- ReverseComparator.REVERSE_ORDER å†…éƒ¨ç±»æ‡’æ±‰å¼å•ä¾‹\r\n\r\n![image-20230419155823830](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419155823830.png)\r\n\r\n- Comparators.NaturalOrderComparator.INSTANCE æšä¸¾é¥¿æ±‰å¼å•ä¾‹\r\n\r\n![image-20230419160119770](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419160119770.png)"},{"title":"Javaé¢è¯•ä¸“é¢˜-å¹¶å‘ç¯‡","tags":["çº¿ç¨‹æ± ","JUC","Lock","Synchronized","volatile","ConcurrentHashMap","ThreadLocal"],"categories":["Java","é¢è¯•"],"author":"","excerpt":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥Javaé¢è¯•ä¸“é¢˜](https://www.bilibili.com/video/BV15b4y117RJ)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n","link":"/posts/Java_Interview_Topics-Concurrent","content":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥Javaé¢è¯•ä¸“é¢˜](https://www.bilibili.com/video/BV15b4y117RJ)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n<!-- more -->\r\n\r\n## 1. çº¿ç¨‹çŠ¶æ€\r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡ Java çº¿ç¨‹å…­ç§çŠ¶æ€\r\n* æŒæ¡ Java çº¿ç¨‹çŠ¶æ€è½¬æ¢\r\n* èƒ½ç†è§£äº”ç§çŠ¶æ€ä¸å…­ç§çŠ¶æ€ä¸¤ç§è¯´æ³•çš„åŒºåˆ«\r\n\r\n### **å…­ç§çŠ¶æ€åŠè½¬æ¢**\r\n\r\n![image-20210831090722658](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831090722658.png)\r\n\r\nåˆ†åˆ«æ˜¯\r\n\r\n* æ–°å»º\r\n  * å½“ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡è¢«åˆ›å»ºï¼Œä½†è¿˜æœªè°ƒç”¨ start æ–¹æ³•æ—¶å¤„äº**æ–°å»º**çŠ¶æ€\r\n  * æ­¤æ—¶æœªä¸æ“ä½œç³»ç»Ÿåº•å±‚çº¿ç¨‹å…³è”ï¼Œä»…ä»…æ˜¯ä¸€ä¸ªJavaå¯¹è±¡ï¼Œæ²¡æœ‰è·ŸçœŸæ­£çš„çº¿ç¨‹å…³è”ï¼Œæ‰€ä»¥æ­¤æ—¶è¿™ä¸ªçº¿ç¨‹ä¸ä¼šè¢«æ“ä½œç³»ç»Ÿåˆ†é…CPUå»æ‰§è¡Œä»£ç \r\n* **å¯è¿è¡Œ**(åªæœ‰è¯¥çŠ¶æ€æ‰ä¼šè¢«æ“ä½œç³»ç»Ÿåˆ†é…CPUå»æ‰§è¡Œä»£ç ï¼Œå…¶ä»–çŠ¶æ€éƒ½ä¸è¡Œ)\r\n  * è°ƒç”¨äº† start æ–¹æ³•ï¼Œå°±ä¼šç”±**æ–°å»º**è¿›å…¥**å¯è¿è¡Œ**\r\n  * æ­¤æ—¶ä¸åº•å±‚çº¿ç¨‹å…³è”ï¼Œç”±æ“ä½œç³»ç»Ÿåˆ†é…CPUè°ƒåº¦æ‰§è¡Œ\r\n* ç»ˆç»“\r\n  * çº¿ç¨‹å†…ä»£ç å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”±**å¯è¿è¡Œ**è¿›å…¥**ç»ˆç»“**ï¼Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸèµ°åˆ°å°½å¤´\r\n  * æ­¤æ—¶ä¼šå–æ¶ˆä¸åº•å±‚çº¿ç¨‹å…³è”ï¼Œç›¸å…³èµ„æºå¾—åˆ°é‡Šæ”¾\r\n\r\n![image-20230419193409233](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419193409233.png)\r\n\r\n* é˜»å¡\r\n  * å½“è·å–é”å¤±è´¥åï¼Œç”±**å¯è¿è¡Œ**è¿›å…¥ Monitor çš„é˜»å¡é˜Ÿåˆ—**é˜»å¡**ï¼Œæ­¤æ—¶ä¸å ç”¨ cpu æ—¶é—´\r\n  * å½“æŒé”çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œä¼šæŒ‰ç…§ä¸€å®šè§„åˆ™å”¤é†’é˜»å¡é˜Ÿåˆ—ä¸­çš„**é˜»å¡**çº¿ç¨‹ï¼Œå”¤é†’åçš„çº¿ç¨‹è¿›å…¥**å¯è¿è¡Œ**çŠ¶æ€\r\n\r\n![image-20230419200454852](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419200454852.png)\r\n\r\n* ç­‰å¾…\r\n  * å½“è·å–é”æˆåŠŸåï¼Œä½†ç”±äºæ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨äº† wait() æ–¹æ³•ï¼Œæ­¤æ—¶ä»**å¯è¿è¡Œ**çŠ¶æ€é‡Šæ”¾é”è¿›å…¥ Monitor ç­‰å¾…é›†åˆ**ç­‰å¾…**ï¼ŒåŒæ ·ä¸å ç”¨ cpu æ—¶é—´\r\n  * å½“å…¶å®ƒæŒé”çº¿ç¨‹è°ƒç”¨ notify() æˆ– notifyAll() æ–¹æ³•ï¼Œä¼šæŒ‰ç…§ä¸€å®šè§„åˆ™å”¤é†’ç­‰å¾…é›†åˆä¸­çš„**ç­‰å¾…**çº¿ç¨‹ï¼Œæ¢å¤ä¸º**å¯è¿è¡Œ**çŠ¶æ€\r\n\r\n![image-20230419202459021](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419202459021.png)\r\n\r\n* æœ‰æ—¶é™ç­‰å¾…\r\n  * å½“è·å–é”æˆåŠŸåï¼Œä½†ç”±äºæ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨äº† wait(long) æ–¹æ³•ï¼Œæ­¤æ—¶ä»**å¯è¿è¡Œ**çŠ¶æ€é‡Šæ”¾é”è¿›å…¥ Monitor ç­‰å¾…é›†åˆè¿›è¡Œ**æœ‰æ—¶é™ç­‰å¾…**ï¼ŒåŒæ ·ä¸å ç”¨ cpu æ—¶é—´\r\n  * å½“å…¶å®ƒæŒé”çº¿ç¨‹è°ƒç”¨ notify() æˆ– notifyAll() æ–¹æ³•ï¼Œä¼šæŒ‰ç…§ä¸€å®šè§„åˆ™å”¤é†’ç­‰å¾…é›†åˆä¸­çš„**æœ‰æ—¶é™ç­‰å¾…**çº¿ç¨‹ï¼Œæ¢å¤ä¸º**å¯è¿è¡Œ**çŠ¶æ€ï¼Œå¹¶é‡æ–°å»ç«äº‰é”\r\n  * å¦‚æœç­‰å¾…è¶…æ—¶ï¼Œä¹Ÿä¼šä»**æœ‰æ—¶é™ç­‰å¾…**çŠ¶æ€æ¢å¤ä¸º**å¯è¿è¡Œ**çŠ¶æ€ï¼Œå¹¶é‡æ–°å»ç«äº‰é”\r\n  * è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯è°ƒç”¨ sleep(long) æ–¹æ³•ä¹Ÿä¼šä»**å¯è¿è¡Œ**çŠ¶æ€è¿›å…¥**æœ‰æ—¶é™ç­‰å¾…**çŠ¶æ€ï¼Œä½†ä¸ Monitor æ— å…³ï¼Œä¸éœ€è¦ä¸»åŠ¨å”¤é†’ï¼Œè¶…æ—¶æ—¶é—´åˆ°è‡ªç„¶æ¢å¤ä¸º**å¯è¿è¡Œ**çŠ¶æ€\r\n\r\n> ***å…¶å®ƒæƒ…å†µï¼ˆåªéœ€äº†è§£ï¼‰***\r\n>\r\n> * å¯ä»¥ç”¨ interrupt() æ–¹æ³•æ‰“æ–­**ç­‰å¾…**ã€**æœ‰æ—¶é™ç­‰å¾…**çš„çº¿ç¨‹ï¼Œè®©å®ƒä»¬æ¢å¤ä¸º**å¯è¿è¡Œ**çŠ¶æ€\r\n> * parkï¼Œunpark ç­‰æ–¹æ³•ä¹Ÿå¯ä»¥è®©çº¿ç¨‹ç­‰å¾…å’Œå”¤é†’\r\n\r\n### **äº”ç§çŠ¶æ€**\r\n\r\näº”ç§çŠ¶æ€çš„è¯´æ³•æ¥è‡ªäºæ“ä½œç³»ç»Ÿå±‚é¢çš„åˆ’åˆ†\r\n\r\n![image-20210831092652602](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831092652602.png)\r\n\r\n* è¿è¡Œæ€ï¼šåˆ†åˆ° cpu æ—¶é—´ï¼Œèƒ½çœŸæ­£æ‰§è¡Œçº¿ç¨‹å†…ä»£ç çš„\r\n* å°±ç»ªæ€ï¼šæœ‰èµ„æ ¼åˆ†åˆ° cpu æ—¶é—´ï¼Œä½†è¿˜æœªè½®åˆ°å®ƒçš„\r\n* é˜»å¡æ€ï¼šæ²¡èµ„æ ¼åˆ†åˆ° cpu æ—¶é—´çš„\r\n  * æ¶µç›–äº† java çŠ¶æ€ä¸­æåˆ°çš„**é˜»å¡**ã€**ç­‰å¾…**ã€**æœ‰æ—¶é™ç­‰å¾…**\r\n  * å¤šå‡ºäº†é˜»å¡ I/Oï¼ŒæŒ‡çº¿ç¨‹åœ¨è°ƒç”¨é˜»å¡ I/O æ—¶ï¼Œå®é™…æ´»ç”± I/O è®¾å¤‡å®Œæˆï¼Œæ­¤æ—¶çº¿ç¨‹æ— äº‹å¯åšï¼Œåªèƒ½å¹²ç­‰\r\n* æ–°å»ºä¸ç»ˆç»“æ€ï¼šä¸ java ä¸­åŒåçŠ¶æ€ç±»ä¼¼ï¼Œä¸å†å•°å—¦\r\n\r\n> æ³¨æ„ï¼šJavaä¸­çš„RUNNABLEæ¶µç›–äº†å°±ç»ªã€è¿è¡Œã€é˜»å¡I/O\r\n>\r\n\r\n## 2. çº¿ç¨‹æ± \r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡çº¿ç¨‹æ± çš„ 7 å¤§æ ¸å¿ƒå‚æ•°\r\n\r\n**ä¸ƒå¤§å‚æ•°**\r\n\r\n1. corePoolSize æ ¸å¿ƒçº¿ç¨‹æ•°ç›® - æ± ä¸­ä¼šä¿ç•™çš„æœ€å¤šçº¿ç¨‹æ•°(æ ¸å¿ƒçº¿ç¨‹æ˜¯å¯ä»¥ä¸º0çš„ï¼Œå³æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åéƒ½ä¸ä¿ç•™ï¼Œéƒ½å±äºæ•‘æ€¥çº¿ç¨‹)\r\n2. maximumPoolSize æœ€å¤§çº¿ç¨‹æ•°ç›® - æ ¸å¿ƒçº¿ç¨‹+æ•‘æ€¥çº¿ç¨‹çš„æœ€å¤§æ•°ç›®\r\n3. keepAliveTime ç”Ÿå­˜æ—¶é—´ - æ•‘æ€¥çº¿ç¨‹çš„ç”Ÿå­˜æ—¶é—´ï¼Œç”Ÿå­˜æ—¶é—´å†…æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œæ­¤çº¿ç¨‹èµ„æºä¼šé‡Šæ”¾\r\n4. unit æ—¶é—´å•ä½ - æ•‘æ€¥çº¿ç¨‹çš„ç”Ÿå­˜æ—¶é—´å•ä½ï¼Œå¦‚ç§’ã€æ¯«ç§’ç­‰\r\n5. workQueue - å½“æ²¡æœ‰ç©ºé—²æ ¸å¿ƒçº¿ç¨‹æ—¶ï¼Œæ–°æ¥ä»»åŠ¡ä¼šåŠ å…¥åˆ°æ­¤é˜Ÿåˆ—æ’é˜Ÿï¼Œé˜Ÿåˆ—æ»¡ä¼šåˆ›å»ºæ•‘æ€¥çº¿ç¨‹æ‰§è¡Œä»»åŠ¡\r\n6. threadFactory çº¿ç¨‹å·¥å‚ - å¯ä»¥å®šåˆ¶çº¿ç¨‹å¯¹è±¡çš„åˆ›å»ºï¼Œä¾‹å¦‚è®¾ç½®çº¿ç¨‹åå­—ã€æ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹ç­‰\r\n7. handler æ‹’ç»ç­–ç•¥ - å½“æ‰€æœ‰çº¿ç¨‹éƒ½åœ¨ç¹å¿™ï¼ŒworkQueue ä¹Ÿæ”¾æ»¡æ—¶ï¼Œä¼šè§¦å‘æ‹’ç»ç­–ç•¥\r\n   1. æŠ›å¼‚å¸¸ java.util.concurrent.ThreadPoolExecutor.AbortPolicy\r\n   \r\n   ![image-20230419211920493](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419211920493.png)\r\n   \r\n   2. ç”±è°ƒç”¨è€…æ‰§è¡Œä»»åŠ¡ java.util.concurrent.ThreadPoolExecutor.CallerRunsPolicy\r\n   \r\n   ![image-20230419211952479](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419211952479.png)\r\n   \r\n   3. ä¸¢å¼ƒä»»åŠ¡ java.util.concurrent.ThreadPoolExecutor.DiscardPolicy\r\n   \r\n   ![image-20230419212004898](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419212004898.png)\r\n   \r\n   4. ä¸¢å¼ƒæœ€æ—©æ’é˜Ÿä»»åŠ¡ java.util.concurrent.ThreadPoolExecutor.DiscardOldestPolicy\r\n   \r\n   ![image-20230419212017158](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419212017158.png)\r\n\r\n![image-20210831093204388](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831093204388.png)\r\n\r\n> ***ä»£ç è¯´æ˜***\r\n>\r\n> day02.TestThreadPoolExecutor ä»¥è¾ƒä¸ºå½¢è±¡çš„æ–¹å¼æ¼”ç¤ºäº†çº¿ç¨‹æ± çš„æ ¸å¿ƒç»„æˆ\r\n\r\n![image-20230419212807609](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419212807609.png)\r\n\r\n## 3. wait vs sleep\r\n\r\n**è¦æ±‚**\r\n\r\n* èƒ½å¤Ÿè¯´å‡ºäºŒè€…åŒºåˆ«\r\n\r\n**ä¸€ä¸ªå…±åŒç‚¹ï¼Œä¸‰ä¸ªä¸åŒç‚¹**\r\n\r\nå…±åŒç‚¹\r\n\r\n* wait() ï¼Œwait(long) å’Œ sleep(long) çš„æ•ˆæœéƒ½æ˜¯è®©å½“å‰çº¿ç¨‹æš‚æ—¶æ”¾å¼ƒ CPU çš„ä½¿ç”¨æƒï¼Œè¿›å…¥é˜»å¡çŠ¶æ€\r\n\r\nä¸åŒç‚¹\r\n\r\n* æ–¹æ³•å½’å±ä¸åŒ\r\n  * sleep(long) æ˜¯ Thread çš„é™æ€æ–¹æ³•\r\n  * è€Œ wait()ï¼Œwait(long) éƒ½æ˜¯ Object çš„æˆå‘˜æ–¹æ³•ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰\r\n\r\n* é†’æ¥æ—¶æœºä¸åŒ\r\n  * æ‰§è¡Œ sleep(long) å’Œ wait(long) çš„çº¿ç¨‹éƒ½ä¼šåœ¨ç­‰å¾…ç›¸åº”æ¯«ç§’åé†’æ¥\r\n  * wait(long) å’Œ wait() è¿˜å¯ä»¥è¢« notify å”¤é†’ï¼Œwait() å¦‚æœä¸å”¤é†’å°±ä¸€ç›´ç­‰ä¸‹å»\r\n  * å®ƒä»¬éƒ½å¯ä»¥è¢«æ‰“æ–­å”¤é†’ï¼ˆThreadè°ƒç”¨interruptæ–¹æ³•è¿›è¡Œæ‰“æ–­ï¼‰\r\n\r\n  ![image-20230419215548435](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419215548435.png)\r\n  \r\n* é”ç‰¹æ€§ä¸åŒï¼ˆé‡ç‚¹ï¼‰\r\n  * wait æ–¹æ³•çš„è°ƒç”¨å¿…é¡»å…ˆè·å– wait å¯¹è±¡çš„é”ï¼Œè€Œ sleep åˆ™æ— æ­¤é™åˆ¶\r\n  \r\n  ![image-20230419214540929](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419214540929.png)\r\n  \r\n  * wait æ–¹æ³•æ‰§è¡Œåä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œå…è®¸å…¶å®ƒçº¿ç¨‹è·å¾—è¯¥å¯¹è±¡é”ï¼ˆæˆ‘æ”¾å¼ƒ cpuï¼Œä½†ä½ ä»¬è¿˜å¯ä»¥ç”¨ï¼‰\r\n  \r\n  ![image-20230419214940875](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419214940875.png)\r\n  \r\n  * è€Œ sleep å¦‚æœåœ¨ synchronized ä»£ç å—ä¸­æ‰§è¡Œï¼Œå¹¶ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼ˆæˆ‘æ”¾å¼ƒ cpuï¼Œä½ ä»¬ä¹Ÿç”¨ä¸äº†ï¼‰\r\n\r\n![image-20230419215217674](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230419215217674.png)\r\n\r\n## 4. lock vs synchronized\r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡ lock ä¸ synchronized çš„åŒºåˆ«\r\n* ç†è§£ ReentrantLock çš„å…¬å¹³ã€éå…¬å¹³é”\r\n* ç†è§£ ReentrantLock ä¸­çš„æ¡ä»¶å˜é‡\r\n\r\n**ä¸‰ä¸ªå±‚é¢**\r\n\r\nä¸åŒç‚¹\r\n\r\n* è¯­æ³•å±‚é¢\r\n  * synchronized æ˜¯å…³é”®å­—ï¼Œæºç åœ¨ jvm ä¸­ï¼Œç”¨ c++ è¯­è¨€å®ç°\r\n  * Lock æ˜¯æ¥å£ï¼Œæºç ç”± jdk æä¾›ï¼Œç”¨ java è¯­è¨€å®ç°\r\n  * ä½¿ç”¨ synchronized æ—¶ï¼Œé€€å‡ºåŒæ­¥ä»£ç å—é”ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä½¿ç”¨ Lock æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨ unlock æ–¹æ³•é‡Šæ”¾é”\r\n* åŠŸèƒ½å±‚é¢\r\n  * äºŒè€…å‡å±äºæ‚²è§‚é”ã€éƒ½å…·å¤‡åŸºæœ¬çš„äº’æ–¥ã€åŒæ­¥ã€é”é‡å…¥åŠŸèƒ½\r\n  * Lock æä¾›äº†è®¸å¤š synchronized ä¸å…·å¤‡çš„åŠŸèƒ½ï¼Œä¾‹å¦‚è·å–ç­‰å¾…çŠ¶æ€ã€å…¬å¹³é”(é€šå¸¸æƒ…å†µï¼Œååé‡å¹¶ä¸å¦‚éå…¬å¹³é”ï¼Œæ’é˜Ÿæ•ˆç‡æ›´é«˜)ã€å¯æ‰“æ–­ã€å¯è¶…æ—¶ã€å¤šæ¡ä»¶å˜é‡\r\n  * Lock æœ‰é€‚åˆä¸åŒåœºæ™¯çš„å®ç°ï¼Œå¦‚ ReentrantLockï¼Œ ReentrantReadWriteLockï¼ˆè¯»å¤šå†™å°‘åœºæ™¯ï¼‰\r\n* æ€§èƒ½å±‚é¢\r\n  * åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼Œsynchronized åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œå¦‚åå‘é”ã€è½»é‡çº§é”ï¼Œæ€§èƒ½ä¸èµ–\r\n  * åœ¨ç«äº‰æ¿€çƒˆæ—¶ï¼ŒLock çš„å®ç°é€šå¸¸ä¼šæä¾›æ›´å¥½çš„æ€§èƒ½\r\n\r\n**å…¬å¹³é”**\r\n\r\n* å…¬å¹³é”çš„å…¬å¹³ä½“ç°\r\n  * **å·²ç»å¤„åœ¨é˜»å¡é˜Ÿåˆ—**ä¸­çš„çº¿ç¨‹ï¼ˆä¸è€ƒè™‘è¶…æ—¶ï¼‰å§‹ç»ˆéƒ½æ˜¯å…¬å¹³çš„ï¼Œå…ˆè¿›å…ˆå‡º\r\n  * å…¬å¹³é”æ˜¯æŒ‡**æœªå¤„äºé˜»å¡é˜Ÿåˆ—**ä¸­çš„çº¿ç¨‹æ¥äº‰æŠ¢é”ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™è€å®åˆ°é˜Ÿå°¾ç­‰å¾…\r\n  * éå…¬å¹³é”æ˜¯æŒ‡**æœªå¤„äºé˜»å¡é˜Ÿåˆ—**ä¸­çš„çº¿ç¨‹æ¥äº‰æŠ¢é”ï¼Œä¸é˜Ÿåˆ—å¤´å”¤é†’çš„çº¿ç¨‹å»ç«äº‰ï¼Œè°æŠ¢åˆ°ç®—è°çš„\r\n* å…¬å¹³é”ä¼šé™ä½ååé‡ï¼Œä¸€èˆ¬ä¸ç”¨\r\n\r\n**æ¡ä»¶å˜é‡**\r\n\r\n* ReentrantLock ä¸­çš„æ¡ä»¶å˜é‡åŠŸèƒ½ç±»ä¼¼äºæ™®é€š synchronized çš„ waitï¼Œnotifyï¼Œç”¨åœ¨å½“çº¿ç¨‹è·å¾—é”åï¼Œå‘ç°æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œä¸´æ—¶ç­‰å¾…çš„é“¾è¡¨ç»“æ„\r\n* ä¸ synchronized çš„ç­‰å¾…é›†åˆä¸åŒä¹‹å¤„åœ¨äºï¼ŒReentrantLock ä¸­çš„æ¡ä»¶å˜é‡å¯ä»¥æœ‰å¤šä¸ªï¼Œå¯ä»¥å®ç°æ›´ç²¾ç»†çš„ç­‰å¾…ã€å”¤é†’æ§åˆ¶\r\n\r\n> ***ä»£ç è¯´æ˜***\r\n>\r\n> * day02.TestReentrantLock ç”¨è¾ƒä¸ºå½¢è±¡çš„æ–¹å¼æ¼”ç¤º ReentrantLock çš„å†…éƒ¨ç»“æ„\r\n> * éƒ¨åˆ†æºç \r\n>\r\n> ```java\r\n> // --add-opens java.base/java.util.concurrent=ALL-UNNAMED --add-opens java.base/java.util.concurrent.locks=ALL-UNNAMED\r\n> public class TestReentrantLock {\r\n>     static final MyReentrantLock LOCK = new MyReentrantLock(true);\r\n> \r\n>     static Condition c1 = LOCK.newCondition(\"c1\");\r\n>     static Condition c2 = LOCK.newCondition(\"c2\");\r\n> \r\n>     static volatile boolean stop = false;\r\n> \r\n>     public static void main(String[] args) throws InterruptedException, IOException {\r\n>         learnLock();\r\n>     }\r\n> \r\n>     private static void learnLock() throws InterruptedException {\r\n>         System.out.println(LOCK);\r\n>         new MyThread(() -> {\r\n>             LOCK.lock();\r\n>             get(\"t\").debug(\"acquire lock...\");\r\n>         }, \"t1\").start();\r\n> \r\n>         Thread.sleep(100);\r\n>         new MyThread(() -> {\r\n>             LOCK.lock();\r\n>             get(\"t\").debug(\"acquire lock...\");\r\n>         }, \"t2\").start();\r\n> \r\n>         Thread.sleep(100);\r\n>         new MyThread(() -> {\r\n>             LOCK.lock();\r\n>             get(\"t\").debug(\"acquire lock...\");\r\n>         }, \"t3\").start();\r\n> \r\n>         Thread.sleep(100);\r\n>         new MyThread(() -> {\r\n>             LOCK.lock();\r\n>             get(\"t\").debug(\"acquire lock...\");\r\n>         }, \"t4\").start();\r\n>     }\r\n> \r\n>     private static void fairVsUnfair() throws InterruptedException {\r\n>         new MyThread(() -> {\r\n>             LOCK.lock();\r\n>             get(\"t\").debug(\"acquire lock...\");\r\n>             sleep1s();\r\n>             LOCK.unlock();\r\n>         }, \"t1\").start();\r\n> \r\n>         Thread.sleep(100);\r\n>         new MyThread(() -> {\r\n>             LOCK.lock();\r\n>             get(\"t\").debug(\"acquire lock...\");\r\n>             sleep1s();\r\n>             LOCK.unlock();\r\n>         }, \"t2\").start();\r\n> \r\n>         Thread.sleep(100);\r\n>         new MyThread(() -> {\r\n>             LOCK.lock();\r\n>             get(\"t\").debug(\"acquire lock...\");\r\n>             sleep1s();\r\n>             LOCK.unlock();\r\n>         }, \"t3\").start();\r\n> \r\n>         Thread.sleep(100);\r\n>         new MyThread(() -> {\r\n>             LOCK.lock();\r\n>             get(\"t\").debug(\"acquire lock...\");\r\n>             sleep1s();\r\n>             LOCK.unlock();\r\n>         }, \"t4\").start();\r\n> \r\n>         get(\"t\").debug(\"{}\", LOCK);\r\n> \r\n>         while (!stop) {\r\n>             new Thread(() -> {\r\n>                 try {\r\n>                     //\t\t\t\ttryLockåº•å±‚æ€»æ˜¯éå…¬å¹³é”\r\n>                     boolean b = LOCK.tryLock(10, TimeUnit.MILLISECONDS);\r\n>                     if (b) {\r\n>                         System.out.println(Thread.currentThread().getName() + \" acquire lock...\");\r\n>                         stop = true;\r\n>                         sleep1s();\r\n>                         LOCK.unlock();\r\n>                     }\r\n>                 } catch (InterruptedException e) {\r\n>                     e.printStackTrace();\r\n>                 }\r\n>             }).start();\r\n>         }\r\n>     }\r\n> \r\n>     private static void sleep1s() {\r\n>         try {\r\n>             Thread.sleep(1000);\r\n>         } catch (InterruptedException e) {\r\n>             e.printStackTrace();\r\n>         }\r\n>     }\r\n> \t\r\n>     \r\n>     private static class MyReentrantLock extends ReentrantLock {\r\n>         private final Map<String, Condition> conditions = new HashMap<>();\r\n> \r\n>         public MyReentrantLock(boolean fair) {\r\n>             super(fair);\r\n>         }\r\n>         \r\n> \t\t//æ¡ä»¶å˜é‡æ–¹æ³•\r\n>         public Condition newCondition(String name) {\r\n>             Condition condition = super.newCondition();\r\n>             conditions.put(name, condition);\r\n>             return condition;\r\n>         }\r\n>         ...\r\n>     }\r\n>     ...\r\n> }\r\n> ```\r\n\r\n### locké˜»å¡\r\n\r\n![image-20230420144129519](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420144129519.png)\r\n\r\n### lockå¯é‡å…¥é”\r\n\r\n![image-20230420150140265](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420150140265.png)\r\n\r\n### lockéå…¬å¹³é”ï¼ˆå…¶ä»–çº¿ç¨‹æ’é˜Ÿç­‰å¾…é˜Ÿåˆ—é‡Œçš„çº¿ç¨‹ï¼‰\r\n\r\n![image-20230420151242795](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420151242795.png)\r\n\r\n### lockå…¬å¹³é”ï¼ˆçº¿ç¨‹æ­£å¸¸æ’é˜Ÿç­‰å¾…ï¼‰\r\n\r\n![image-20230420151341412](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420151341412.png)\r\n\r\n### lockæ¡ä»¶å˜é‡\r\n\r\n![image-20230420153536495](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420153536495.png)\r\n\r\n## 5. volatile\r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡çº¿ç¨‹å®‰å…¨è¦è€ƒè™‘çš„ä¸‰ä¸ªé—®é¢˜\r\n  * çº¿ç¨‹å®‰å…¨è¦è€ƒè™‘ä¸‰ä¸ªæ–¹é¢:å¯è§æ€§ã€æœ‰åºæ€§ã€åŸå­æ€§\r\n    * å¯è§æ€§æŒ‡ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡ä¿®æ”¹ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹èƒ½çœ‹åˆ°æœ€æ–°çš„ç»“æœ\r\n    * æœ‰åºæ€§æŒ‡ï¼Œä¸€ä¸ªçº¿ç¨‹å†…ä»£ç æŒ‰ç¼–å†™é¡ºåºæ‰§è¡Œ\r\n    * åŸå­æ€§æŒ‡ï¼Œä¸€ä¸ªçº¿ç¨‹å†…å¤šè¡Œä»£ç ä»¥ä¸€ä¸ªæ•´ä½“è¿è¡Œï¼ŒæœŸé—´ä¸èƒ½æœ‰å…¶å®ƒçº¿ç¨‹çš„ä»£ç æ’é˜Ÿ\r\n\r\n* æŒæ¡ volatile èƒ½è§£å†³å“ªäº›é—®é¢˜\r\n\r\n### **åŸå­æ€§**\r\n\r\n* èµ·å› ï¼šå¤šçº¿ç¨‹ä¸‹ï¼Œä¸åŒçº¿ç¨‹çš„**æŒ‡ä»¤å‘ç”Ÿäº†äº¤é”™**å¯¼è‡´çš„å…±äº«å˜é‡çš„è¯»å†™æ··ä¹±\r\n* è§£å†³ï¼šç”¨æ‚²è§‚é”æˆ–ä¹è§‚é”è§£å†³\r\n* volatile å¹¶ä¸èƒ½è§£å†³åŸå­æ€§\r\n\r\n![image-20230420155844698](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420155844698.png)\r\n\r\n### **å¯è§æ€§**\r\n\r\n- ç½‘ä¸Šå¯¹å¯è§æ€§çš„è¯´æ³•\r\n\r\n![image-20230420160254650](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420160254650.png)\r\n\r\n- ä¸Šå›¾è¯´æ³•æ˜¾ç„¶æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºçº¿ç¨‹1ã€2éƒ½èƒ½è¯»å–åˆ°çº¿ç¨‹0çš„ä¿®æ”¹stopçš„æœ€æ–°å€¼\r\n\r\n![image-20230420163639173](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420163639173.png)\r\n\r\n* èµ·å› ï¼šç”±äº**ç¼–è¯‘å™¨ä¼˜åŒ–ã€æˆ–ç¼“å­˜ä¼˜åŒ–ã€æˆ– CPU æŒ‡ä»¤é‡æ’åºä¼˜åŒ–**å¯¼è‡´çš„å¯¹å…±äº«å˜é‡æ‰€åšçš„ä¿®æ”¹å¦å¤–çš„çº¿ç¨‹çœ‹ä¸åˆ°\r\n* è§£å†³ï¼šç”¨ volatile ä¿®é¥°å…±äº«å˜é‡ï¼Œèƒ½å¤Ÿé˜²æ­¢ç¼–è¯‘å™¨ç­‰ä¼˜åŒ–å‘ç”Ÿï¼Œè®©ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§\r\n* JITï¼šJavaçš„å³æ—¶ç¼–è¯‘å™¨ï¼Œæ˜¯JVMçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä¸»è¦è´£ä»»æ˜¯è´Ÿè´£ä»£ç ä¼˜åŒ–ï¼Œä»»ä½•ä¸€æ¡JAVAä»£ç æœ€ç»ˆä¼šç¿»è¯‘æˆJAVAçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œä½†è¿™ä¸ªJAVAçš„å­—èŠ‚ç æŒ‡ä»¤è¿˜ä¸èƒ½å¤Ÿäº¤ç»™CPUæ¥æ‰§è¡Œï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªå«åšè§£é‡Šå™¨çš„ç»„ä»¶ï¼Œè¿™ä¸ªè§£é‡Šå™¨çš„ç»„ä»¶ä¼šæŠŠJAVAçš„å­—èŠ‚ç æŒ‡ä»¤é€è¡Œç¿»è¯‘æˆæœºå™¨ç ï¼Œè¿™ä¸ªæœºå™¨ç æ‰äº¤ç»™CPUï¼ŒCPUæ‰èƒ½è®¤è¯†ï¼Œè¿™æ ·æ•ˆç‡è¾ƒä½ï¼Œå› æ­¤JITçš„ç»„ä»¶å¯¹ä¸€äº›**çƒ­ç‚¹**çš„å­—èŠ‚ç è¿›è¡Œä¼˜åŒ–ï¼Œä¾‹å¦‚**é¢‘ç¹è°ƒç”¨çš„ä»£ç **ï¼Œ**åå¤æ‰§è¡Œçš„å¾ªç¯**ç­‰ã€‚ä½¿ç”¨volatileä¿®é¥°å˜é‡ï¼Œå°±æ˜¯è¶…è¿‡å¾ªç¯é˜ˆå€¼æˆ–æ–¹æ³•è°ƒç”¨æ¬¡æ•°ä¹Ÿä¸è¿›è¡Œä¼˜åŒ–ï¼Œç›´æ¥æ”¾è¡Œ\r\n\r\n![image-20230420163540235](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420163540235.png)\r\n\r\n### **æœ‰åºæ€§**\r\n\r\n![image-20230420165059904](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420165059904.png)\r\n\r\n* èµ·å› ï¼šç”±äº**ç¼–è¯‘å™¨ä¼˜åŒ–ã€æˆ–ç¼“å­˜ä¼˜åŒ–ã€æˆ– CPU æŒ‡ä»¤é‡æ’åºä¼˜åŒ–**å¯¼è‡´æŒ‡ä»¤çš„å®é™…æ‰§è¡Œé¡ºåºä¸ç¼–å†™é¡ºåºä¸ä¸€è‡´\r\n* è§£å†³ï¼šç”¨ volatile ä¿®é¥°å…±äº«å˜é‡ä¼šåœ¨è¯»ã€å†™å…±äº«å˜é‡æ—¶åŠ å…¥ä¸åŒçš„å±éšœï¼Œé˜»æ­¢å…¶ä»–è¯»å†™æ“ä½œè¶Šè¿‡å±éšœï¼Œä»è€Œè¾¾åˆ°é˜»æ­¢é‡æ’åºçš„æ•ˆæœ\r\n* æ³¨æ„ï¼š\r\n  * **volatile å˜é‡å†™**åŠ çš„å±éšœæ˜¯é˜»æ­¢ä¸Šæ–¹å…¶å®ƒå†™æ“ä½œè¶Šè¿‡å±éšœæ’åˆ° **volatile å˜é‡å†™**ä¹‹ä¸‹\r\n  * **volatile å˜é‡è¯»**åŠ çš„å±éšœæ˜¯é˜»æ­¢ä¸‹æ–¹å…¶å®ƒè¯»æ“ä½œè¶Šè¿‡å±éšœæ’åˆ° **volatile å˜é‡è¯»**ä¹‹ä¸Š\r\n  * volatile è¯»å†™åŠ å…¥çš„å±éšœåªèƒ½é˜²æ­¢åŒä¸€çº¿ç¨‹å†…çš„æŒ‡ä»¤é‡æ’\r\n\r\n![image-20230420170038976](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420170038976.png)\r\n\r\n![image-20230420165605009](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420165605009.png)\r\n\r\n> ***ä»£ç è¯´æ˜***\r\n>\r\n> * day02.threadsafe.AddAndSubtract æ¼”ç¤ºåŸå­æ€§\r\n> * day02.threadsafe.ForeverLoop æ¼”ç¤ºå¯è§æ€§\r\n>   * æ³¨æ„ï¼šæœ¬ä¾‹ç»å®è·µæ£€éªŒæ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–å¯¼è‡´çš„å¯è§æ€§é—®é¢˜\r\n> * day02.threadsafe.Reordering æ¼”ç¤ºæœ‰åºæ€§\r\n>   * éœ€è¦æ‰“æˆ jar åŒ…åæµ‹è¯•\r\n>\r\n> ![image-20230420165537915](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230420165537915.png)\r\n>\r\n> * è¯·åŒæ—¶å‚è€ƒè§†é¢‘è®²è§£\r\n\r\n### è¡¥å……\r\n\r\n> - å¯è§æ€§é—®é¢˜è¡¥å……\r\n>\r\n>   - ç›¸æ¯”synchronizedçš„åŠ é”æ–¹å¼æ¥è§£å†³å…±äº«å˜é‡çš„å†…å­˜å¯è§æ€§é—®é¢˜ï¼Œvolatileå°±æ˜¯æ›´è½»é‡çš„é€‰æ‹©ï¼Œå®ƒæ²¡æœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢çš„é¢å¤–å¼€é”€æˆæœ¬ã€‚\r\n>\r\n>   - volatileå¯ä»¥ç¡®ä¿å¯¹æŸä¸ªå˜é‡çš„æ›´æ–°å¯¹å…¶ä»–çº¿ç¨‹é©¬ä¸Šå¯è§ï¼Œä¸€ä¸ªå˜é‡è¢«å£°æ˜ä¸ºvolatile æ—¶ï¼Œçº¿ç¨‹åœ¨å†™å…¥å˜é‡æ—¶ä¸ä¼šæŠŠå€¼ç¼“å­˜åœ¨å¯„å­˜å™¨æˆ–è€…å…¶ä»–åœ°æ–¹ï¼Œè€Œæ˜¯ä¼šæŠŠå€¼åˆ·æ–°å›ä¸»å†…å­˜ å½“å…¶å®ƒçº¿ç¨‹è¯»å–è¯¥å…±äº«å˜é‡ï¼Œä¼šä»ä¸»å†…å­˜é‡æ–°è·å–æœ€æ–°å€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å½“å‰çº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¸­çš„å€¼ã€‚\r\n>\r\n>   - ä¾‹å¦‚ï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ª volatile å˜é‡ volatile int x = 0ï¼Œçº¿Aä¿®æ”¹x=1ï¼Œä¿®æ”¹å®Œä¹‹åå°±ä¼šæŠŠæ–°çš„å€¼åˆ·æ–°å›ä¸»å†…å­˜ï¼Œçº¿ç¨‹Bè¯»å–xçš„æ—¶å€™ï¼Œå°±ä¼šæ¸…ç©ºæœ¬åœ°å†…å­˜å˜é‡ï¼Œç„¶åå†ä»ä¸»å†…å­˜è·å–æœ€æ–°å€¼ã€‚\r\n>\r\n>   ![image-20230421001513641](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421001513641.png)\r\n>\r\n> - æœ‰åºæ€§é—®é¢˜è¡¥å……\r\n>\r\n>   - é‡æ’åºå¯ä»¥åˆ†ä¸ºç¼–è¯‘å™¨é‡æ’åºå’Œå¤„ç†å™¨é‡æ’åºï¼Œvalatileä¿è¯æœ‰åºæ€§ï¼Œå°±æ˜¯é€šè¿‡åˆ†åˆ«é™åˆ¶è¿™ä¸¤ç§ç±»å‹çš„é‡æ’åºã€‚\r\n>\r\n>   ![image-20230421001703874](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421001703874.png)\r\n>\r\n>   - ä¸ºäº†å®ç°volatileçš„å†…å­˜è¯­ä¹‰ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­æ’å…¥å†…å­˜å±éšœæ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚\r\n>\r\n>     - 1.åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ª StoreStore å±éšœ\r\n>     - 2.åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª StoreLoad å±éšœ\r\n>     - 3.åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª LoadLoad å±éšœ\r\n>     - 4.åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª LoadStore å±éšœ\r\n>\r\n>     ![image-20230421001911421](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421001911421.png)\r\n>\r\n>     ![image-20230421001923758](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421001923758.png)\r\n\r\n\r\n\r\n## 6. æ‚²è§‚é” vs ä¹è§‚é”\r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡æ‚²è§‚é”å’Œä¹è§‚é”çš„åŒºåˆ«\r\n\r\n**å¯¹æ¯”æ‚²è§‚é”ä¸ä¹è§‚é”**\r\n\r\n* æ‚²è§‚é”çš„ä»£è¡¨æ˜¯ synchronized å’Œ Lock é”\r\n  * å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ã€çº¿ç¨‹åªæœ‰å æœ‰äº†é”ï¼Œæ‰èƒ½å»æ“ä½œå…±äº«å˜é‡ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å é”æˆåŠŸï¼Œ**è·å–é”å¤±è´¥çš„çº¿ç¨‹ï¼Œéƒ½å¾—åœä¸‹æ¥ç­‰å¾…**ã€‘\r\n  * çº¿ç¨‹ä»è¿è¡Œåˆ°é˜»å¡ã€å†ä»é˜»å¡åˆ°å”¤é†’ï¼Œæ¶‰åŠçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¦‚æœé¢‘ç¹å‘ç”Ÿï¼Œå½±å“æ€§èƒ½\r\n    * çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šçº¿ç¨‹ä»è¿è¡Œéƒ½é˜»å¡ï¼ŒæŠŠçº¿ç¨‹å½“å‰è¿è¡Œçš„çŠ¶æ€è®°å½•ä¸‹æ¥ï¼Œçº¿ç¨‹æ‰§è¡Œåˆ°ç¬¬å‡ è¡Œä»£ç äº†ï¼Œå½“å‰æœ‰å“ªäº›å±€éƒ¨å˜é‡ç­‰éƒ½å¾—è®°å½•ï¼Œä¸‹æ¬¡å†æŠŠä½ ä»é˜»å¡çŠ¶æ€å”¤é†’æ—¶ï¼Œä¼šæŠŠè¿™äº›ä¿¡æ¯è¿›è¡Œæ¢å¤ï¼Œæ¥ç€ä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹ç»§ç»­å‘ä¸‹è¿è¡Œï¼Œæ•´ä¸ªè¿‡ç¨‹ç§°ä¸ºçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢\r\n  * å®é™…ä¸Šï¼Œçº¿ç¨‹åœ¨è·å– synchronized å’Œ Lock é”æ—¶ï¼Œå¦‚æœé”å·²è¢«å ç”¨ï¼Œéƒ½ä¼šåšå‡ æ¬¡é‡è¯•æ“ä½œï¼Œå‡å°‘é˜»å¡çš„æœºä¼š\r\n    *  çº¿ç¨‹åœ¨è·å–synchronizedå’ŒLocké”æ—¶ï¼Œè‹¥é”å·²è¢«å ç”¨ï¼Œéƒ½ä¼šåšå‡ æ¬¡é‡è¯•æ“ä½œï¼Œé‡è¯•æœŸé—´ï¼Œé”æœªè¢«é‡Šæ”¾ï¼Œå°±ä¸ç”¨è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå‡å°‘ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå³å‡å°‘é˜»å¡çš„æœºä¼š  \r\n* ä¹è§‚é”çš„ä»£è¡¨æ˜¯ AtomicIntegerï¼Œä½¿ç”¨ cas æ¥ä¿è¯åŸå­æ€§\r\n  * å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ã€æ— éœ€åŠ é”ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸä¿®æ”¹å…±äº«å˜é‡ï¼Œ**å…¶å®ƒå¤±è´¥çš„çº¿ç¨‹ä¸éœ€è¦åœæ­¢ï¼Œä¸æ–­é‡è¯•ç›´è‡³æˆåŠŸ**ã€‘\r\n  * ç”±äºçº¿ç¨‹ä¸€ç›´è¿è¡Œï¼Œä¸éœ€è¦é˜»å¡ï¼Œå› æ­¤ä¸æ¶‰åŠçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢\r\n  * å®ƒéœ€è¦å¤šæ ¸ cpu æ”¯æŒï¼Œä¸”çº¿ç¨‹æ•°ä¸åº”è¶…è¿‡ cpu æ ¸æ•°ï¼ˆå¿…é¡»æœ‰ç‹¬ç«‹CPUæ¥æ‰§è¡Œä½ çš„å¾ªç¯æˆ–ä¸æ–­é‡è¯•çš„ä»£ç ï¼‰\r\n    * è‹¥æ²¡æœ‰å¤šæ ¸CPUæ‰§è¡Œï¼Œå³ä½¿æŠ¢å é”å¤±è´¥çš„çº¿ç¨‹ä¸æƒ³åœä¸‹æ¥ä¹Ÿå¾—åœä¸‹æ¥ï¼Œå› ä¸ºæ²¡æœ‰å¤šä½™CPUæ‰§è¡Œï¼Œè™½ç„¶ä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä½†ä¼šè¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåˆ°ä¸€è¾¹æ­‡ç€å»\r\n\r\n> ***ä»£ç è¯´æ˜***\r\n>\r\n> * day02.SyncVsCas æ¼”ç¤ºäº†åˆ†åˆ«ä½¿ç”¨ä¹è§‚é”å’Œæ‚²è§‚é”è§£å†³åŸå­èµ‹å€¼\r\n>\r\n> * è¯·åŒæ—¶å‚è€ƒè§†é¢‘è®²è§£ï¼ˆä½¿ç”¨AtomicIntegeræ›´åº•å±‚çš„Unsafeæ¥è®²è§£ä¹è§‚é”ï¼Œå¯¹äºä¹è§‚é”æ¥è®²ï¼Œèƒ½å¤Ÿä¿è¯åœ¨ä¿®æ”¹çš„å…±äº«å˜é‡æ—¶çš„ä¿®æ”¹æ“ä½œæ˜¯åŸå­æ“ä½œï¼‰\r\n>\r\n> * CASä¹è§‚é”éœ€è¦å’Œvolatileé…åˆä½¿ç”¨ï¼Œé€šè¿‡å¯è§æ€§æ¥åˆ¤æ–­å˜é‡æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼Œè™½ç„¶caså¯ä»¥ä¿è¯åŸå­æ€§ï¼Œä½†è¿˜è¦é€šè¿‡volatileæ¥ä¿è¯ä½ èƒ½çœ‹åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼\r\n>\r\n>  ```java\r\n>   \t...\r\n>       //AtomicIntegerçš„åº•å±‚\r\n>   \tstatic final Unsafe U = Unsafe.getUnsafe();\r\n>   \t//è®¡ç®—åç§»é‡\r\n>       static final long BALANCE = U.objectFieldOffset(Account.class, \"balance\");\r\n> \r\n>       static class Account {\r\n>           volatile int balance = 10;\r\n>       }\r\n>   ...\r\n>   Account account = new Account();\r\n>   int o = account.balance;\r\n>   int n = o + 5;\r\n>   //é€‰æ‹©æ•´å‹ç±»å‹ï¼Œè‹¥æ²¡æœ‰å…¶ä»–çº¿ç¨‹å¹²æ‰°ï¼Œåªè¦åœ¨10çš„åŸºç¡€ä¸ŠåŠ 5å°±æˆåŠŸäº†ï¼›è‹¥åœ¨ä¿®æ”¹çš„è¿‡ç¨‹ä¸­æœ‰å…¶ä»–çº¿ç¨‹å¹²æ‰°(æŠŠå…±äº«å˜é‡balanceçš„æœ€æ–°å€¼ä¿®æ”¹æˆäº†100)ï¼Œé‚£å¦‚æœåœ¨10çš„åŸºç¡€ä¸ŠåŠ 5äº†å°±ä¼šæŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼(100)ç»™è¦†ç›–äº†ï¼Œæ‰€ä»¥æ­¤æ–¹æ³•ä¼šåœ¨ä¿®æ”¹å…±äº«å˜é‡ä¹‹å‰å°†æ—§å€¼ä¸å…±äº«å˜é‡çš„æœ€æ–°å€¼è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰åˆ™æ²¡æœ‰åˆ«çš„çº¿ç¨‹å¹²æ‰°å°±ä¿®æ”¹æˆåŠŸï¼Œåä¹‹åˆ™ä¿®æ”¹å¤±è´¥\r\n>   U.compareAndSetInt(accountï¼ŒBALANCEï¼Œoï¼Œn));\r\n>   =>compareAndSetInt(Object o,//è¦ä¿®æ”¹çš„å¯¹è±¡ \r\n>                     long offset,//åç§»é‡\r\n>                     int expected,//æ—§å€¼\r\n>                     //æ–°å€¼\r\n>                     int x);\r\n> \r\n>  ```\r\n>\r\n> ![image-20230421135939880](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421135939880.png)\r\n>\r\n> - æ‚²è§‚é”synchronizedè§£å†³æŒ‡ä»¤çš„äº¤é”™é—®é¢˜ï¼ˆæŒ‡ä»¤é‡æ’åºï¼‰ï¼Œç”¨é˜»æ­¢æŒ‡ä»¤äº¤é”™çš„æ–¹å¼æ¥ä¿è¯æˆ‘ä»¬å¯¹å…±äº«å˜é‡çš„å®‰å…¨è®¿é—®ï¼›synchronizedç”¨äº’æ–¥çš„æ–¹å¼è®©æ•´ä¸ªåŒæ­¥ä»£ç å—ä»¥æ•´ä½“çš„å½¢å¼æ‰§è¡Œï¼Œæ‰§è¡ŒæœŸé—´å…¶ä»–çº¿ç¨‹ä¸èƒ½æ‰§è¡Œï¼Œéƒ½è¢«é˜»å¡ä½\r\n>\r\n> ![image-20230421140903810](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421140903810.png)\r\n>\r\n> - ä¹è§‚é”casä¼šäº§ç”ŸæŒ‡ä»¤äº¤é”™ç°è±¡ï¼Œå¤šçº¿ç¨‹ä¸‹ï¼Œæœ‰ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡10ä¸º15ï¼Œè¿™æ—¶çº¿ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªï¼Œå¾ªç¯ç¬¬ä¸€æ¬¡åˆ¤æ–­å‡ºæ¥å…±äº«å˜é‡ä¸åˆå§‹å€¼10ä¸ä¸€æ ·ï¼Œé€€å‡ºå½“å‰å¾ªç¯å†è¿›è¡Œå¾ªç¯ï¼Œæ­¤æ—¶å¯ä»¥è·å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼15ï¼Œå€¼ä¿®æ”¹å¯ä»¥æˆåŠŸä¸º10ç»“æŸå¾ªç¯ï¼›\r\n> - ä¹è§‚é”(cas)æ²¡æœ‰äº’æ–¥ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œè°å…ˆæ‰§è¡Œè°åæ‰§è¡Œéƒ½æ— æ‰€è°“ï¼ŒæŒ‡ä»¤äº¤é”™ä¹Ÿæ— æ‰€æ‰€è°“ï¼Œä½†å®ƒå¯ä»¥é€šè¿‡æ¯”è¾ƒå¹¶äº¤æ¢çš„åŸåˆ™ï¼Œçœ‹çœ‹ä½ æ›´æ–°æ—¶ï¼Œåˆ¤æ–­è¿™ä¸ªå€¼æœ‰æ²¡æœ‰è¢«åˆ«äººä¿®æ”¹è¿‡ï¼Œæœªä¿®æ”¹æ‰ä¿®æ”¹æˆåŠŸï¼Œåä¹‹è¿™æ¬¡æ›´æ–°å¤±è´¥ï¼Œå¤±è´¥åé‡è¯•(å†æ¬¡å¾ªç¯)ï¼Œå†è·å–æœ€æ–°å€¼ï¼Œåœ¨æœ€æ–°å€¼çš„åŸºç¡€ä¸Šè¿›è¡Œæ“ä½œï¼Œè¿™æ ·å°±èƒ½ä¿è¯å…±äº«å˜é‡çš„æ­£ç¡®æ€§\r\n>\r\n> ![image-20230421142308669](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421142308669.png)\r\n\r\n\r\n\r\n## 7. Hashtable vs ConcurrentHashMap\r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡ Hashtable ä¸ ConcurrentHashMap çš„åŒºåˆ«\r\n* æŒæ¡ ConcurrentHashMap åœ¨ä¸åŒç‰ˆæœ¬çš„å®ç°åŒºåˆ«\r\n\r\n> æ›´å½¢è±¡çš„æ¼”ç¤ºï¼Œè§èµ„æ–™ä¸­çš„ hash-demo.jarï¼Œè¿è¡Œéœ€è¦ jdk14 ä»¥ä¸Šç¯å¢ƒï¼Œè¿›å…¥ jar åŒ…ç›®å½•ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤\r\n>\r\n> ```\r\n> java -jar --add-exports java.base/jdk.internal.misc=ALL-UNNAMED hash-demo.jar\r\n> ```\r\n\r\n**Hashtable å¯¹æ¯” ConcurrentHashMap**\r\n\r\n* Hashtable ä¸ ConcurrentHashMap éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ Map é›†åˆ\r\n* Hashtable å¹¶å‘åº¦ä½ï¼Œæ•´ä¸ª Hashtable å¯¹åº”ä¸€æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ“ä½œå®ƒ\r\n\r\n  - hashtableæ‰©å®¹å› å­ä¸º0.75ï¼Œæ‰©å®¹åä¸ºåŸå®¹é‡*2+1ï¼Œè€Œä¸”å®¹é‡ä¸€èˆ¬ä¸ºè´¨æ•°ï¼Œæœ‰å¾ˆå¥½çš„hashåˆ†å¸ƒæ€§ï¼Œå³ä¸ä¼šè¿›è¡ŒäºŒæ¬¡hashï¼ˆhashå–æ­£å†æ±‚æ¨¡ï¼‰\r\n\r\n  ![image-20230421144116018](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421144116018.png)\r\n\r\n* ConcurrentHashMap å¹¶å‘åº¦é«˜ï¼Œæ•´ä¸ª ConcurrentHashMap å¯¹åº”å¤šæŠŠé”ï¼Œåªè¦çº¿ç¨‹è®¿é—®çš„æ˜¯ä¸åŒé”ï¼Œé‚£ä¹ˆä¸ä¼šå†²çª\r\n\r\n### **ConcurrentHashMap 1.7**\r\n\r\n* æ•°æ®ç»“æ„ï¼š`Segment(å¤§æ•°ç»„) + HashEntry(å°æ•°ç»„) + é“¾è¡¨`ï¼Œæ¯ä¸ª Segment å¯¹åº”ä¸€æŠŠé”ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„ Segmentï¼Œåˆ™ä¸ä¼šå†²çª\r\n* å¹¶å‘åº¦ï¼šSegment æ•°ç»„å¤§å°å³å¹¶å‘åº¦ï¼Œå†³å®šäº†åŒä¸€æ—¶åˆ»æœ€å¤šèƒ½æœ‰å¤šå°‘ä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®ã€‚Segment æ•°ç»„ä¸èƒ½æ‰©å®¹ï¼Œæ„å‘³ç€å¹¶å‘åº¦åœ¨ ConcurrentHashMap åˆ›å»ºæ—¶å°±å›ºå®šäº†\r\n* ç´¢å¼•è®¡ç®—\r\n  * å‡è®¾å¤§æ•°ç»„é•¿åº¦æ˜¯ $2^m$ï¼Œkey åœ¨å¤§æ•°ç»„å†…çš„ç´¢å¼•æ˜¯ key çš„äºŒæ¬¡ hash å€¼çš„é«˜ m ä½\r\n  * å‡è®¾å°æ•°ç»„é•¿åº¦æ˜¯ $2^n$ï¼Œkey åœ¨å°æ•°ç»„å†…çš„ç´¢å¼•æ˜¯ key çš„äºŒæ¬¡ hash å€¼çš„ä½ n ä½\r\n* æ‰©å®¹ï¼šæ¯ä¸ªå°æ•°ç»„çš„æ‰©å®¹ç›¸å¯¹ç‹¬ç«‹ï¼Œ**å°æ•°ç»„åœ¨è¶…è¿‡æ‰©å®¹å› å­æ—¶ä¼šè§¦å‘æ‰©å®¹ï¼Œæ¯æ¬¡æ‰©å®¹ç¿»å€**\r\n* Segment[0] åŸå‹ï¼šé¦–æ¬¡åˆ›å»ºå…¶å®ƒå°æ•°ç»„æ—¶ï¼Œä¼šä»¥æ­¤åŸå‹ä¸ºä¾æ®ï¼Œæ•°ç»„é•¿åº¦ï¼Œæ‰©å®¹å› å­éƒ½ä¼šä»¥åŸå‹ä¸ºå‡†\r\n\r\n> - concurrenthashmap1.7ï¼šå¤–é¢æ•´ä¸ªæ•°ç»„ä¸ºä¸€ä¸ªsegmentæ•°ç»„ï¼Œé‡Œé¢æ¯ä¸ªå…ƒç´ å¥—ä¸€ä¸ªå°æ•°ç»„hashentryï¼Œç­‰ä»·äºæ™®é€šhashmapçš„æ•°æ®ç»“æ„ï¼Œå°†æ¥å¦‚æœç´¢å¼•å†²çªäº†å°±æ„æˆä¸€ä¸ªé“¾è¡¨\r\n>\r\n> ![image-20230421145625451](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421145625451.png)\r\n>\r\n> - å¹¶å‘åº¦clevelå€¼çš„å¤šå°‘å†³å®šcurrentHashMapçš„å¹¶å‘æ€§ï¼Œå®¹é‡capacityçš„å¤§å°å†³å®šå°æ•°ç»„HashEntryçš„åˆå§‹å¤§å°ï¼ˆcapacity/clevel,æœ€å°å€¼ä¸º2ï¼‰ï¼Œæ‰©å®¹å› å­factorå†³å®šçš„æ˜¯å°æ•°ç»„HashEntryçš„æ‰©å®¹ï¼ˆè¶…è¿‡0.75è§¦å‘æ‰©å®¹ï¼‰ï¼›\r\n>\r\n> ![image-20230421145926326](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421145926326.png)\r\n>\r\n> ![image-20230421145801226](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421145801226.png)\r\n>\r\n> - keyçš„ç´¢å¼•æ ¹æ®äºŒæ¬¡hashçš„é«˜å››ä½ä½œä¸ºï¼ˆ1100->12ï¼‰ç´¢å¼•å€¼ï¼Œç´¢å¼•æ˜¯æŒ‡segmentçš„ç´¢å¼•ï¼›clevelä¸º32å°±é«˜äº”ä½å–å€¼ï¼›ä»¥äºŒæ¬¡hashçš„æœ€ä½ä½ä½œä¸ºentryæ•°ç»„ä¸­çš„ç´¢å¼•\r\n>\r\n> ![image-20230421153206829](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421153206829.png)\r\n>\r\n> ![image-20230421152252653](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421152252653.png)\r\n>\r\n> ![image-20230421152804268](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421152804268.png)\r\n>\r\n> - segmentæ•°ç»„çš„å¹¶å‘åº¦clevelä¸€æ—¦ç¡®å®šï¼Œå°±ä¸ä¼šæ‰©å®¹ï¼Œä¸ç®¡å…ƒç´ ä¸ªæ•°æ˜¯å¤šå°‘ï¼Œå°æ•°ç»„ä¼šæ ¹æ®æ‰©å®¹å› å­æ¥æ‰©å®¹ï¼Œæ‰©å®¹å®¹é‡ç¿»å€ï¼Œé“¾è¡¨æ’å…¥æ–¹å¼ä¸ºå¤´æ’æ³•ï¼Œè¿™é‡Œçš„å¤´æ’æ³•å¹¶ä¸ä¼šé€ æˆæ­»é“¾ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹æ“ä½œSegmentæ•°ç»„éƒ½ä¼šåŠ ä¸Šé”ï¼Œåˆ«çš„çº¿ç¨‹ä¸èƒ½è®¿é—®ï¼Œæ¯ä¸ªå°æ•°ç»„ä¼šæ ¹æ®å„è‡ªçš„å…ƒç´ ä¸ªæ•°æ¥å„è‡ªæ‰©å®¹ï¼Œäº’ä¸å¹²æ‰°\r\n>\r\n> ![image-20230421153848810](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421153848810.png)\r\n>\r\n> - segment[0]åŸå‹æ˜¯åˆ›å»ºsegmentæ•°ç»„çš„åˆå§‹entryï¼Œå¤§å°æ ¹æ®capacityå’Œclevelå†³å®šï¼ˆcapacity/clevelï¼Œæœ€å°å€¼ä¸º2ï¼‰ï¼Œåªè¦æ˜¯åˆ›å»ºå‡ºæ¥çš„HashEntryå°æ•°ç»„éƒ½ä¼šæ ¹æ®Segment[0]ä¸­çš„å°æ•°ç»„ä½œä¸ºåŸå‹ï¼ŒæŠŠå®ƒçš„å¤§å°ã€æ‰©å®¹å› å­ç­‰æ‹¿æ¥å€Ÿç”¨ï¼Œè¿™ä¹Ÿä½“ç°äº†è®¾è®¡æ¨¡å¼ä¸­çš„åŸå‹æ¨¡å¼\r\n>\r\n> ![image-20230421154813557](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421154813557.png)\r\n>\r\n> - é¥¿æ±‰å¼åˆå§‹åŒ–ï¼šåº•å±‚å·²ç»è°ƒç”¨äº†æ„é€ æ–¹æ³•ï¼Œæ„é€ æ–¹æ³•ä¸€è°ƒç”¨ï¼ŒSegmentæ•°ç»„åŒ…æ‹¬é‡Œé¢çš„Segment[0]HashEntryå°æ•°ç»„å°±å·²ç»è¢«åˆ›å»ºæ¥äº†ï¼Œæ˜¯ä¸€ä¸ªé¥¿æ±‰å¼çš„åˆå§‹åŒ–ï¼ˆå¹¶æ²¡æœ‰putå…ƒç´ ï¼‰\r\n\r\n### **ConcurrentHashMap 1.8**\r\n\r\n* æ•°æ®ç»“æ„ï¼š`Node æ•°ç»„ + é“¾è¡¨æˆ–çº¢é»‘æ ‘`ï¼Œæ•°ç»„çš„æ¯ä¸ªå¤´èŠ‚ç‚¹ä½œä¸ºé”ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®çš„å¤´èŠ‚ç‚¹ä¸åŒï¼Œåˆ™ä¸ä¼šå†²çªã€‚é¦–æ¬¡ç”Ÿæˆå¤´èŠ‚ç‚¹æ—¶å¦‚æœå‘ç”Ÿç«äº‰ï¼Œåˆ©ç”¨ cas è€Œé syncronizedï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½\r\n* å¹¶å‘åº¦ï¼šNode æ•°ç»„æœ‰å¤šå¤§ï¼Œå¹¶å‘åº¦å°±æœ‰å¤šå¤§ï¼Œä¸ 1.7 ä¸åŒï¼ŒNode æ•°ç»„å¯ä»¥æ‰©å®¹\r\n* æ‰©å®¹æ¡ä»¶ï¼šNode æ•°ç»„æ»¡ 3/4 æ—¶å°±ä¼šæ‰©å®¹\r\n* è°ƒç”¨æ— å‚æ„é€ åˆ›å»ºæ•°ç»„ï¼Œé»˜è®¤å®¹é‡ä¸º16ï¼›æ’å…¥æ–¹å¼ä¸ºå°¾æ’æ³•\r\n\r\n![image-20230421160157919](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421160157919.png)\r\n\r\n* æ‰©å®¹å•ä½ï¼šä»¥é“¾è¡¨ä¸ºå•ä½ä»åå‘å‰è¿ç§»é“¾è¡¨ï¼Œè¿ç§»å®Œæˆçš„å°†æ—§æ•°ç»„å¤´èŠ‚ç‚¹æ›¿æ¢ä¸º ForwardingNode\r\n* æ‰©å®¹æ—¶å¹¶å‘ get\r\n  * æ ¹æ®æ˜¯å¦ä¸º ForwardingNode æ¥å†³å®šæ˜¯åœ¨æ–°æ•°ç»„æŸ¥æ‰¾è¿˜æ˜¯åœ¨æ—§æ•°ç»„æŸ¥æ‰¾ï¼Œä¸ä¼šé˜»å¡\r\n  * å¦‚æœé“¾è¡¨é•¿åº¦è¶…è¿‡ 1ï¼Œåˆ™éœ€è¦å¯¹èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ï¼ˆåˆ›å»ºæ–°èŠ‚ç‚¹ï¼‰ï¼Œæ€•çš„æ˜¯èŠ‚ç‚¹è¿ç§»å next æŒ‡é’ˆæ”¹å˜\r\n  * å¦‚æœé“¾è¡¨æœ€åå‡ ä¸ªå…ƒç´ æ‰©å®¹åç´¢å¼•ä¸å˜ï¼Œåˆ™èŠ‚ç‚¹æ— éœ€å¤åˆ¶\r\n* æ‰©å®¹æ—¶å¹¶å‘ put\r\n  * å¦‚æœ put çš„çº¿ç¨‹ä¸æ‰©å®¹çº¿ç¨‹æ“ä½œçš„é“¾è¡¨æ˜¯åŒä¸€ä¸ªï¼Œput çº¿ç¨‹ä¼šé˜»å¡\r\n  * å¦‚æœ put çš„çº¿ç¨‹æ“ä½œçš„é“¾è¡¨è¿˜æœªè¿ç§»å®Œæˆï¼Œå³å¤´èŠ‚ç‚¹ä¸æ˜¯ ForwardingNodeï¼Œåˆ™å¯ä»¥å¹¶å‘æ‰§è¡Œ\r\n  * å¦‚æœ put çš„çº¿ç¨‹æ“ä½œçš„é“¾è¡¨å·²ç»è¿ç§»å®Œæˆï¼Œå³å¤´ç»“ç‚¹æ˜¯ ForwardingNodeï¼Œåˆ™å¯ä»¥ååŠ©æ‰©å®¹\r\n* ä¸ 1.7 ç›¸æ¯”æ˜¯æ‡’æ±‰å¼åˆå§‹åŒ–ï¼ˆç¬¬ä¸€æ¬¡putå…ƒç´ æ—¶æ‰ä¼šåˆ›å»ºåº•å±‚çš„æ•°æ®ç»“æ„ï¼‰\r\n* capacity ä»£è¡¨é¢„ä¼°çš„å…ƒç´ ä¸ªæ•°ï¼Œcapacity / factory æ¥è®¡ç®—å‡ºåˆå§‹æ•°ç»„å¤§å°ï¼Œéœ€è¦è´´è¿‘ $2^n$ \r\n* loadFactor åªåœ¨è®¡ç®—åˆå§‹æ•°ç»„å¤§å°æ—¶è¢«ä½¿ç”¨ï¼Œä¹‹åæ‰©å®¹å›ºå®šä¸º 3/4\r\n* è¶…è¿‡æ ‘åŒ–é˜ˆå€¼æ—¶çš„æ‰©å®¹é—®é¢˜ï¼Œå¦‚æœå®¹é‡å·²ç»æ˜¯ 64ï¼Œç›´æ¥æ ‘åŒ–ï¼Œå¦åˆ™åœ¨åŸæ¥å®¹é‡åŸºç¡€ä¸Šåš 3 è½®æ‰©å®¹\r\n\r\n> - ä¸€å¼€å§‹è°ƒç”¨æ„é€ æ–¹æ³•æ—¶ï¼Œæ•°ç»„è¿˜æ²¡åˆ›å»ºå‡ºæ¥ï¼Œå½“æ’å…¥å…ƒç´ æ—¶æ•°ç»„æ‰ä¼šåˆ›å»ºï¼Œå³æ˜¯ä¸€ç§æ‡’æ±‰å¼åˆå§‹åŒ–ï¼Œåªè¦>=æ‰©å®¹å› å­0.75æ‰ä¼šæ‰©å®¹ï¼Œ\r\n> - æœ‰å‚æ„é€ è®¾å®šcapacityåˆå§‹å€¼ä¸º16ï¼Œå®ƒå‡å®šä½ åˆå§‹æ—¶æ”¾å…¥16ä¸ªå…ƒç´ ï¼Œæ•°ç»„å¤šå¤§ä½ çœ‹ç€åŠï¼Œæ•°ç»„é•¿åº¦æ»¡è¶³$2^n$ï¼Œæ­¤æ—¶æ’å…¥å…ƒç´ æ—¶ï¼Œå®ƒä¼šä½ æ’å…¥16/16>0.75ï¼Œè¶…è¿‡æ‰©å®¹é˜ˆå€¼ï¼Œè¿™æ—¶è§¦å‘æ‰©å®¹ï¼Œæ•°ç»„é•¿åº¦ä¸º32ï¼ˆ*Â¾=24ï¼‰ï¼Œè¿™æ ·å°±æ»¡è¶³æ¡ä»¶16/32<0.75ï¼Œå³åªè¦capacityåˆå§‹å€¼ä¸º12ï¼ˆ12/16=0.75ï¼‰<=capacity<=16æ’å…¥å…ƒç´ å°±ä¼šè§¦å‘æ‰©å®¹ä¸º32ï¼Œ0<=capacity<12å°±æ˜¯åˆå§‹å®¹é‡16ï¼Œcapacityçš„å¤§å°å†³å®šåˆå§‹æ•°ç»„çš„å¤§å°\r\n> - åˆå§‹æ•°ç»„æ‰©å®¹å› å­factoråªæ˜¯ç”¨æ¥åˆå§‹åŒ–çš„ï¼Œè°ƒç”¨currentHashMapçš„æ„é€ æ–¹æ³•æ—¶æ‰ä¼šç”¨æ¥é…åˆè®¡ç®—æˆ‘ä»¬çš„æ•°ç»„é•¿åº¦è¯¥æœ‰å¤šå¤§ï¼Œå³åœ¨åˆ›å»ºæ•°ç»„æ—¶ï¼Œæ‰©å®¹å› å­factorä¸º0.5ï¼ˆcapacity=8 / åˆå§‹æ•°ç»„é•¿åº¦å›ºå®š=16ï¼‰ï¼Œæ•°ç»„åˆ›å»ºå‡ºæ¥åå°†æ¥æ’å…¥å…ƒç´ è¿˜æ˜¯æŒ‰ç…§0.75æ¥æ‰©å®¹ï¼ˆfactoråªæ˜¯ç¬¬ä¸€æ¬¡æ„é€ æ—¶ç”¨æ¥è®¡ç®—ä¸€ä¸‹ï¼Œä»¥åå°±ä¸ç”¨å®ƒäº†ï¼Œè¿˜æ˜¯æŒ‰ç…§æ»¡0.75æ¥æ‰©å®¹ï¼‰\r\n>\r\n> ![image-20230421170444242](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421170444242.png)\r\n>\r\n> - å¤šçº¿ç¨‹ä¸‹putå…ƒç´ ï¼ˆåŒä¸€ä¸ªindexï¼‰ï¼Œåœ¨bçº¿ç¨‹putåæŠ¢å é”åsleep10sï¼Œcçº¿ç¨‹è¦æƒ³putå¹¶æŠ¢å é”éœ€è¦ç­‰å¾…bä¼‘çœ ç»“æŸï¼ˆé˜»å¡ï¼‰ï¼Œæ˜¯ä¸€ç§äº’æ–¥é”ï¼›\r\n>\r\n> ![image-20230421174746167](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421174746167.png)\r\n>\r\n> - putä¸åŒçš„indexå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œäº’ä¸å¹²æ‰°\r\n>\r\n> ![image-20230421174944947](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421174944947.png)\r\n>\r\n> - æ‰©å®¹æ—¶ï¼Œæ˜¯ä»åå¾€å‰å¤„ç†å…ƒç´ çš„è¿ç§»ï¼Œè¿ç§»å®Œæ ‡è®°forwardingNodeï¼ˆæ²¡å…ƒç´ ä¹Ÿæ ‡è®°ï¼‰ï¼Œå…¨éƒ¨è¿ç§»å®Œï¼Œæ—§æ•°ç»„ç´¢å¼•å°±å…¨æ˜¯æ ‡è®°è¡¨ç¤ºè¿ç§»ç»“æŸ\r\n>\r\n> ![image-20230421175854195](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421175854195.png)\r\n>\r\n> - è¿ç§»è¿‡ç¨‹ä¸­ï¼Œgetå…ƒç´ ï¼ˆéé“¾è¡¨ï¼‰ï¼Œåªè¦æ ‡è®°äº†forwardingNodeçš„ç´¢å¼•ä¸”è¿ç§»è¿‡å…ƒç´ ï¼Œå°±å»æ–°æ•°ç»„å»è·å–ï¼Œå³ä¸ä¼šè¢«é˜»å¡ï¼Œå¯ä»¥å¹¶å‘è¿è¡Œï¼›å½“åœ¨è¿ç§»é“¾è¡¨è¿‡ç¨‹ä¸­å»getå…ƒç´ ï¼Œæ­¤æ—¶è¿ç§»å‰åçš„å…ƒç´ æ˜¯ä¸ä¸€æ ·çš„ï¼Œå…ƒç´ çš„å‰åæŒ‡é’ˆå’Œç´¢å¼•å‘ç”Ÿæ”¹å˜ï¼Œå› æ­¤åœ¨è¿ç§»æ—¶å¤§å¤šæ•°æƒ…å†µéƒ½ä¼šæŠŠé“¾è¡¨å…ƒç´ é‡æ–°åˆ›å»ºï¼Œä¸èƒ½ç”¨åŒä¸€ä¸ªå¯¹è±¡ï¼ˆé“¾è¡¨æŒ‡å‘å‘ç”Ÿå˜åŒ–ï¼‰ï¼Œä½†æ˜¯currentHashMapå¯¹é“¾è¡¨è¿ç§»å·¥ä½œåšäº†ä¼˜åŒ–ï¼Œå¯¹äºé“¾è¡¨æœ€åå‡ ä¸ªå…ƒç´ ä½ç½®ç›¸åŒï¼ˆhashç›¸åŒ/indexç›¸åŒï¼‰ï¼Œå°±ä¸ç”¨é‡æ–°åˆ›å»ºèŠ‚ç‚¹çš„å·¥ä½œï¼Œæ‰©å®¹åçš„ä½ç½®å°±ä¸ç”¨åŠ¨ç›´æ¥ç”¨å°±è¡Œï¼Œé“¾è¡¨å‰é¢çš„å…ƒç´ éƒ½å¿…é¡»åˆ›å»ºæ–°çš„èŠ‚ç‚¹å¯¹è±¡æ¥è§£å†³æ‰©å®¹å¹¶åŒæ—¶æŸ¥è¯¢çš„é—®é¢˜ï¼ˆå°¾æ’æ³•ï¼Œåé¢å…ƒç´ æ’å…¥å¤´éƒ¨ï¼Œå‰é¢å…ƒç´ æ’å…¥å°¾éƒ¨ï¼‰\r\n> - è¿ç§»è¿‡ç¨‹ä¸­putå…ƒç´ ï¼Œéé“¾è¡¨å¯ä»¥å¹¶å‘putï¼Œé“¾è¡¨åœ¨è¿ç§»è¿‡ç¨‹ä¸­ä¼šåŠ é”ï¼Œputæ“ä½œåªèƒ½é˜»å¡ä½äº†ï¼›\r\n> - å½“putçš„æ˜¯forwardingNodeè¿™äº›å·²æ ‡è®°ä¸ºè¿ç§»å®Œæˆçš„ç´¢å¼•ï¼Œputä¸å¯èƒ½ä¼šåˆ°æ–°æ•°ç»„å»æ“ä½œï¼Œåªèƒ½ç­‰è¿ç§»å®Œæ•´ä¸ªæ•°ç»„æ‰èƒ½åˆ°æ–°æ•°ç»„å»æ“ä½œï¼Œä½†æ˜¯currentHashMapä¹Ÿåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œé“¾è¡¨è¿ç§»å·¥ä½œä¹Ÿä¸æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸‹å­è¿ç§»å®Œæ‰€æœ‰çš„é“¾è¡¨ï¼Œæ˜¯åˆ’åˆ†äº†å¤šä¸ªåŒºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥ä¸€æ¬¡è¿ç§»16ä¸ªé“¾è¡¨ï¼Œå¦‚å½“å‰æ‰©å®¹çº¿ç¨‹å¯ä»¥è¿ç§»0-15çš„é“¾è¡¨ï¼Œè¿™ä¸ªæ—¶å€™æ¥ä¸ªä¸€ä¸ªputçº¿ç¨‹ï¼Œæ²¡äº‹å¹²å°±è¿›å…¥ç©ºé—²çŠ¶æ€ï¼Œä½†å¦‚æœæ—§çš„æ•°ç»„å®¹é‡ä¸º32æ—¶ï¼Œæ‰©å®¹çº¿ç¨‹æ˜¯å¤„ç†16-31çš„é“¾è¡¨ï¼Œæ­¤æ—¶æ–°åŠ å…¥çš„putçº¿ç¨‹å‘ç°16-31çš„æ•°æ®å·²ç»å¤„ç†å®Œäº†ï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¼šå¸®å¿™æ‰©å®¹ï¼Œå¤„ç†0-15æœªæ ‡è®°çš„å…ƒç´ é“¾è¡¨çš„è¿ç§»ï¼ˆå¹¶å‘åˆ†ç»„è¿ç§»æœªè¿ç§»çš„å…ƒç´ ï¼‰ï¼Œå‡å°‘é˜»å¡æœºä¼šï¼Œè®©å®ƒä¹Ÿåˆ«é—²ç€ï¼Œè®©å®ƒä¹Ÿæœ‰æ´»å¯å¹²\r\n>\r\n> ![image-20230421183310345](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421183310345.png)\r\n\r\n\r\n\r\n## 8. ThreadLocal\r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡ ThreadLocal çš„ä½œç”¨ä¸åŸç†\r\n* æŒæ¡ ThreadLocal çš„å†…å­˜é‡Šæ”¾æ—¶æœº\r\n\r\n### **ä½œç”¨**\r\n\r\n* ThreadLocal å¯ä»¥å®ç°ã€èµ„æºå¯¹è±¡ã€‘çš„çº¿ç¨‹éš”ç¦»ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å„ç”¨å„çš„ã€èµ„æºå¯¹è±¡ã€‘ï¼Œé¿å…äº‰ç”¨å¼•å‘çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›æ–¹æ³•å†…çš„å±€éƒ¨å˜é‡ä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œä¸ç‰µæ‰¯åˆ°èµ„æºå…±äº«ï¼Œè™½ç„¶ä¹Ÿä¸ä¼šå¼•å‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½†æœ‰ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯ä¸èƒ½è·¨è¶Šæ–¹æ³•ï¼Œå¦‚åŒä¸€çº¿ç¨‹å†…è¦è°ƒç”¨æ–¹æ³•1ã€2ã€3ã€4ï¼Œé‚£å±€éƒ¨å˜é‡çš„ç”Ÿå‘½å‘¨æœŸå°±å±€é™åœ¨ä¸€ä¸ªæ–¹æ³•å†…ï¼Œæ–¹æ³•2å°±ä¸èƒ½ä½¿ç”¨åˆ°æ–¹æ³•1çš„å±€éƒ¨å˜é‡\r\n* ThreadLocal åŒæ—¶å®ç°äº†ã€**çº¿ç¨‹å†…**ã€‘çš„èµ„æºå…±äº«\r\n\r\n![image-20230421192339867](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421192339867.png)\r\n\r\n### **åŸç†**\r\n\r\næ¯ä¸ªçº¿ç¨‹å†…æœ‰ä¸€ä¸ª ThreadLocalMap ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œç”¨æ¥å­˜å‚¨èµ„æºå¯¹è±¡\r\n\r\n* è°ƒç”¨ set æ–¹æ³•ï¼Œå°±æ˜¯ä»¥ ThreadLocal è‡ªå·±ä½œä¸º keyï¼Œèµ„æºå¯¹è±¡ä½œä¸º valueï¼Œæ”¾å…¥å½“å‰çº¿ç¨‹çš„ ThreadLocalMap é›†åˆä¸­ï¼›è§£å†³ç´¢å¼•å†²çªç”¨çš„æ˜¯å¼€æ”¾å¯»å€¼æ³•æ–¹å¼\r\n\r\n* è°ƒç”¨ get æ–¹æ³•ï¼Œå°±æ˜¯ä»¥ ThreadLocal è‡ªå·±ä½œä¸º keyï¼Œåˆ°å½“å‰çº¿ç¨‹ä¸­æŸ¥æ‰¾å…³è”çš„èµ„æºå€¼\r\n\r\n![image-20230421193232792](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421193232792.png)\r\n\r\n* è°ƒç”¨ remove æ–¹æ³•ï¼Œå°±æ˜¯ä»¥ ThreadLocal è‡ªå·±ä½œä¸º keyï¼Œç§»é™¤å½“å‰çº¿ç¨‹å…³è”çš„èµ„æºå€¼\r\n\r\nThreadLocalMap çš„ä¸€äº›ç‰¹ç‚¹\r\n\r\n* key çš„ hash å€¼ç»Ÿä¸€åˆ†é…\r\n* åˆå§‹å®¹é‡ 16ï¼Œ**æ‰©å®¹å› å­ 2/3ï¼Œæ‰©å®¹å®¹é‡ç¿»å€**\r\n* key ç´¢å¼•å†²çªåç”¨å¼€æ”¾å¯»å€æ³•è§£å†³å†²çª\r\n\r\n### **å¼±å¼•ç”¨ key**\r\n\r\nThreadLocalMap ä¸­çš„ key è¢«è®¾è®¡ä¸ºå¼±å¼•ç”¨ï¼ŒåŸå› å¦‚ä¸‹\r\n\r\n* Thread å¯èƒ½éœ€è¦é•¿æ—¶é—´è¿è¡Œï¼ˆå¦‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼‰ï¼Œå¦‚æœ key ä¸å†ä½¿ç”¨ï¼Œéœ€è¦åœ¨å†…å­˜ä¸è¶³ï¼ˆGCï¼‰æ—¶é‡Šæ”¾å…¶å ç”¨çš„å†…å­˜\r\n\r\n![image-20230421194454713](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421194454713.png)\r\n\r\n### **å†…å­˜é‡Šæ”¾æ—¶æœº**\r\n\r\n* è¢«åŠ¨ GC é‡Šæ”¾ key\r\n  * ä»…æ˜¯è®© key çš„å†…å­˜é‡Šæ”¾ï¼Œå…³è” value çš„å†…å­˜å¹¶ä¸ä¼šé‡Šæ”¾\r\n* æ‡’æƒ°è¢«åŠ¨é‡Šæ”¾ value\r\n  * get key æ—¶ï¼Œå‘ç°æ˜¯ null keyï¼Œåˆ™é‡Šæ”¾å…¶ value å†…å­˜\r\n  * set key æ—¶ï¼Œä¼šä½¿ç”¨å¯å‘å¼æ‰«æï¼Œæ¸…é™¤ä¸´è¿‘çš„ null key çš„ value å†…å­˜ï¼Œå¯å‘æ¬¡æ•°ä¸å…ƒç´ ä¸ªæ•°ï¼Œæ˜¯å¦å‘ç° null key æœ‰å…³\r\n* ä¸»åŠ¨ remove é‡Šæ”¾ keyï¼Œvalue\r\n  * ä¼šåŒæ—¶é‡Šæ”¾ keyï¼Œvalue çš„å†…å­˜ï¼Œä¹Ÿä¼šæ¸…é™¤ä¸´è¿‘çš„ null key çš„ value å†…å­˜\r\n  * æ¨èä½¿ç”¨å®ƒï¼Œå› ä¸ºä¸€èˆ¬ä½¿ç”¨ ThreadLocal æ—¶éƒ½æŠŠå®ƒä½œä¸ºé™æ€å˜é‡ï¼ˆå³å¼ºå¼•ç”¨ï¼‰ï¼Œå› æ­¤æ— æ³•è¢«åŠ¨ä¾é  GC å›æ”¶\r\n\r\n> - threadLocalæ˜¯å¼±å¼•ç”¨ä½œä¸ºkeyæ¥å­˜å‚¨çš„ï¼Œå½“ä¸‹é¢çº¿ç¨‹1ä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œä¸æ–­çš„æ’å…¥å…ƒç´ ï¼Œè¿™æ ·é”®å€¼å°±ä¼šè¶Šæ¥è¶Šå¤šï¼Œè¿™æ—¶åªèƒ½ç­‰GCåƒåœ¾å›æ”¶äº†ï¼Œå¦‚æœthreadLocalè®¾è®¡æˆå¼ºå¼•ç”¨å°±ä¸èƒ½è¢«åƒåœ¾å›æ”¶äº†ï¼ˆå³ä½¿åˆ«çš„åœ°æ–¹éƒ½æ²¡æœ‰å¼•ç”¨threadLocalï¼Œåªè¦threadLocalMapä½¿ç”¨å¼ºå¼•ç”¨å¼•ç”¨èµ„æºï¼Œé‚£è¢«å¼•ç”¨çš„èµ„æºå°±å¾—ä¸åˆ°é‡Šæ”¾ï¼‰ï¼Œæ‰€ä»¥å¼±å¼•ç”¨å¼•ç”¨èµ„æºå°†æ¥æ²¡äººå¼•ç”¨äº†å°±ä¼šè¢«å›æ”¶ï¼Œä½†å€¼æ˜¯å¼ºå¼•ç”¨çš„ï¼ŒGCä»…æ˜¯è®©keyçš„å†…å­˜é‡Šæ”¾ï¼Œåç»­è¿˜è¦æ ¹æ® key æ˜¯å¦ä¸º nullæ¥è¿›ä¸€æ­¥é‡Šæ”¾å€¼çš„å†…å­˜ï¼Œ\r\n> - GCåƒåœ¾å›æ”¶æ—¶ï¼ŒæŠŠæœªè¢«å¼•ç”¨çš„threadLocalï¼ˆaï¼‰æ¸…ç†æ‰ï¼Œå˜ä¸ºnullï¼Œå€¼è¿˜åœ¨ï¼›å½“æ–°çš„threadLocalï¼ˆcï¼‰å»getè¿™ä¸ªkeyä¸ºNullçš„ä½ç½®æ—¶ï¼Œæ­¤æ—¶å€¼å°±ä¼šè¢«åƒåœ¾å›æ”¶æ‰ï¼Œå˜ä¸ºNullï¼›å½“getä¸€ä¸ªç©ºé—²ä½ç½®æ—¶ï¼Œmapå°±ä¼šæŠŠå½“å‰æ–°çš„threadLocalï¼ˆdï¼‰ä½œä¸ºkeyï¼Œä½†å€¼ä¸ºNull\r\n>\r\n> ![image-20230421195247137](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421195247137.png)\r\n>\r\n> - å½“åœ¨è¢«åƒåœ¾å›æ”¶æ‰keyçš„ä½ç½®setï¼ˆ8ï¼‰æ—¶ï¼Œä¸å…‰æ¸…ç†æ‰å½“å‰ä½ç½®çš„å€¼ï¼ˆæ¸…ç†å¹¶å­˜å‚¨ï¼‰ï¼Œè¿˜ä¼šæŠŠç›¸é‚»ä½ç½®ä¹Ÿä¸€èµ·æ¸…ç†æ‰ï¼ˆ9,10 çš„ k vï¼‰ï¼Œä½†ç¦»å¾—æ¯”è¾ƒè¿œçš„ä½ç½®å°±ä¸ä¼šå»æ¸…ç†ï¼ˆ14ï¼‰\r\n>\r\n> ![image-20230421195536553](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421195536553.png)\r\n>\r\n> - ä¸€èˆ¬æƒ…å†µæ˜¯æ²¡æœ‰å…¶ä»–åœ°æ–¹å¼•ç”¨threadLocalå°±ä¼šè¢«åƒåœ¾å›æ”¶ï¼Œkey=Nullï¼Œgetï¼Œsetå‘ç°Nullkeyæ‰ä¼šè¿›ä¸€æ­¥æ¸…ç†value\r\n> - å®é™…æƒ…å†µæ˜¯ç”¨é™æ€å˜é‡æ¥å¼•ç”¨threadLocalå¯¹è±¡ï¼Œå³é™æ€å˜é‡è·Ÿè¿™ä¸ªå¯¹è±¡ä¸ºå¼ºå¼•ç”¨ï¼Œæ‰€ä»¥é™æ€å˜é‡ä¸€ç›´å¼ºå¼•ç”¨ä½¿ç”¨å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶ä¸äº†ï¼Œå³ä½¿threadLocalæ˜¯å¼±å¼•ç”¨ï¼Œä½†æ˜¯é™æ€å˜é‡å¯¹threadLocalä¸€ç›´ä¿æŒå¼ºå¼•ç”¨çŠ¶æ€ï¼Œæ‰€ä»¥æ‡’æƒ°è¢«åŠ¨é‡Šæ”¾ valueçš„ä¸¤ç§æ–¹å¼æ˜¯è¡Œä¸é€šçš„\r\n> - ä½¿ç”¨removeä¸»åŠ¨æ¸…ç†ç›´æ¥å°†mapçš„é”®å€¼æ¸…ç†æ‰ï¼Œå‰ä¸¤ç§æ–¹å¼æ¸…ç†ï¼ˆget setï¼‰ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ï¼Œéœ€è¦ç”¨removeæ¥åŠæ—¶æ¸…ç†ï¼›å‡è®¾é•¿æ—¶é—´è¿è¡Œçš„çº¿ç¨‹æ± èµ„æºï¼ˆå«threadLocalå…³è”é™æ€èµ„æºï¼‰æ²¡æœ‰å³ä½¿æ¸…ç†çš„è¯ï¼Œå°±ä¼šç§¯ç´¯è¶Šæ¥è¶Šå¤šçš„é”®å€¼èµ„æºï¼Œè¿˜æœ‰å…¶ä»–çš„é™æ€å˜é‡å¼ºå¼•ç”¨keyï¼ŒGCä¹Ÿæ²¡åŠæ³•æŠŠå®ƒä»¬å›æ”¶ï¼Œä¹…è€Œä¹…ä¹‹å°±ä¼šé€ æˆå†…å­˜æ³„æ¼\r\n>\r\n> ![image-20230421200401064](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421200401064.png)\r\n"},{"title":"Javaé¢è¯•ä¸“é¢˜-æ¡†æ¶ç¯‡","tags":["Spring Refresh","Spring Bean","Spring MVC","Spring Boot"],"categories":["Java","é¢è¯•"],"author":"","excerpt":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥Javaé¢è¯•ä¸“é¢˜](https://www.bilibili.com/video/BV15b4y117RJ)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n","link":"/posts/Java_Interview_Topics-Framework","content":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥Javaé¢è¯•ä¸“é¢˜](https://www.bilibili.com/video/BV15b4y117RJ)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n<!-- more -->\r\n\r\n## 1. Spring refresh æµç¨‹\r\n\r\n### **Spring refresh æ¦‚è¿°**\r\n\r\nrefresh æ˜¯ AbstractApplicationContext ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œè´Ÿè´£åˆå§‹åŒ– ApplicationContext å®¹å™¨ï¼Œå®¹å™¨å¿…é¡»è°ƒç”¨ refresh æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚å®ƒçš„å†…éƒ¨ä¸»è¦ä¼šè°ƒç”¨ 12 ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬ç§°ä¸º refresh çš„ 12 ä¸ªæ­¥éª¤ï¼š\r\n\r\n1. prepareRefresh\r\n\r\n2. obtainFreshBeanFactory\r\n\r\n3. prepareBeanFactory\r\n\r\n4. postProcessBeanFactory\r\n\r\n5. invokeBeanFactoryPostProcessors\r\n\r\n6. registerBeanPostProcessors\r\n\r\n7. initMessageSource\r\n\r\n8. initApplicationEventMulticaster\r\n\r\n9. onRefresh\r\n\r\n10. registerListeners\r\n\r\n11. finishBeanFactoryInitialization\r\n\r\n12. finishRefresh\r\n\r\n`org.springframework.context.support.AbstractApplicationContext#refresh`\r\n\r\n```java\r\n    @Override\r\n    public void refresh() throws BeansException, IllegalStateException {\r\n    \tsynchronized (this.startupShutdownMonitor) {\r\n\t\t\t// Prepare this context for refreshing.\r\n\t\t\tprepareRefresh();\r\n\r\n\t\t\t// Tell the subclass to refresh the internal bean factory.\r\n\t\t\tConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();\r\n\r\n\t\t\t// Prepare the bean factory for use in this context.\r\n\t\t\tprepareBeanFactory(beanFactory);\r\n\r\n\t\t\ttry {\r\n\t\t\t\t// Allows post-processing of the bean factory in context subclasses.\r\n\t\t\t\tpostProcessBeanFactory(beanFactory);\r\n\r\n\t\t\t\t// Invoke factory processors registered as beans in the context.\r\n\t\t\t\tinvokeBeanFactoryPostProcessors(beanFactory);\r\n\r\n\t\t\t\t// Register bean processors that intercept bean creation.\r\n\t\t\t\tregisterBeanPostProcessors(beanFactory);\r\n\r\n\t\t\t\t// Initialize message source for this context.\r\n\t\t\t\tinitMessageSource();\r\n\r\n\t\t\t\t// Initialize event multicaster for this context.\r\n\t\t\t\tinitApplicationEventMulticaster();\r\n\r\n\t\t\t\t// Initialize other special beans in specific context subclasses.\r\n\t\t\t\tonRefresh();\r\n\r\n\t\t\t\t// Check for listener beans and register them.\r\n\t\t\t\tregisterListeners();\r\n\r\n\t\t\t\t// Instantiate all remaining (non-lazy-init) singletons.\r\n\t\t\t\tfinishBeanFactoryInitialization(beanFactory);\r\n\r\n\t\t\t\t// Last step: publish corresponding event.\r\n\t\t\t\tfinishRefresh();\r\n\t\t\t}\r\n\r\n\t\t\tcatch (BeansException ex) {\r\n\t\t\t\tif (logger.isWarnEnabled()) {\r\n\t\t\t\t\tlogger.warn(\"Exception encountered during context initialization - \" +\r\n\t\t\t\t\t\t\t\"cancelling refresh attempt: \" + ex);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Destroy already created singletons to avoid dangling resources.\r\n\t\t\t\tdestroyBeans();\r\n\r\n\t\t\t\t// Reset 'active' flag.\r\n\t\t\t\tcancelRefresh(ex);\r\n\r\n\t\t\t\t// Propagate exception to caller.\r\n\t\t\t\tthrow ex;\r\n\t\t\t}\r\n\r\n\t\t\tfinally {\r\n\t\t\t\t// Reset common introspection caches in Spring's core, since we\r\n\t\t\t\t// might not ever need metadata for singleton beans anymore...\r\n\t\t\t\tresetCommonCaches();\r\n\t\t\t}\r\n\t\t}\r\n    }\r\n```\r\n\r\n\r\n\r\n> ***åŠŸèƒ½åˆ†ç±»***\r\n>\r\n> * 1 ä¸ºå‡†å¤‡ç¯å¢ƒ\r\n>\r\n> * 2 3 4 5 6 ä¸ºå‡†å¤‡ BeanFactory\r\n>   * ApplicationContextåªæ˜¯ä¸€ä¸ªå¤–éƒ¨çš„å®¹å™¨ï¼Œå®ƒçš„ä¸€äº›æ ¸å¿ƒåŠŸèƒ½è¿˜å¾—å¦å¤–äº¤ç»™è¿™ä¸ªå«BeanFactoryå®¹å™¨æ¥å®Œæˆï¼Œå³Beançš„åˆ›å»ºï¼ŒBeançš„ä¾èµ–æ³¨å…¥ï¼ŒBeançš„åˆå§‹åŒ–ï¼ŒApplicationContextä¼šå€ŸåŠ©å…¶æˆå‘˜å˜é‡BeanFactoryæ¥å®ŒæˆBeançš„åˆ›å»ºï¼ŒBeançš„ä¾èµ–æ³¨å…¥ï¼ŒBeançš„åˆå§‹åŒ–ç­‰åŠŸèƒ½\r\n>\r\n> * 7 8 9 10 12 ä¸ºå‡†å¤‡ ApplicationContext\r\n>\r\n> * 11 ä¸ºåˆå§‹åŒ– BeanFactory ä¸­éå»¶è¿Ÿå•ä¾‹ bean\r\n\r\n\r\n\r\n### **1. prepareRefresh**\r\n\r\n* è¿™ä¸€æ­¥åˆ›å»ºå’Œå‡†å¤‡äº† Environment å¯¹è±¡ï¼Œå®ƒä½œä¸º ApplicationContext çš„ä¸€ä¸ªæˆå‘˜å˜é‡\r\n\r\n* Environment å¯¹è±¡çš„ä½œç”¨ä¹‹ä¸€æ˜¯ä¸ºåç»­ @Valueï¼Œå€¼æ³¨å…¥æ—¶æä¾›é”®å€¼\r\n* Environment åˆ†æˆä¸‰ä¸ªä¸»è¦éƒ¨åˆ†\r\n  * systemProperties - ä¿å­˜ java ç¯å¢ƒé”®å€¼\r\n  * systemEnvironment - ä¿å­˜ç³»ç»Ÿç¯å¢ƒé”®å€¼ï¼ˆæ“ä½œç³»ç»Ÿçš„é”®å€¼ï¼Œå¦‚JAVA_HOMEã€PATHã€CLASS_PATHç­‰ï¼‰\r\n  * è‡ªå®šä¹‰ PropertySource - ä¿å­˜è‡ªå®šä¹‰é”®å€¼ï¼Œä¾‹å¦‚æ¥è‡ªäº *.properties æ–‡ä»¶çš„é”®å€¼\r\n\r\n![image-20210902181639048](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902181639048.png)\r\n\r\n- è§£æ@Valueã€${}ã€#{}\r\n\r\n![image-20230421212541621](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421212541621.png)\r\n\r\n\r\n\r\n```java\r\n    /**\r\n     * Prepare this context for refreshing, setting its startup date and\r\n     * active flag as well as performing any initialization of property sources.\r\n     * å‡†å¤‡æ­¤ä¸Šä¸‹æ–‡ä»¥è¿›è¡Œåˆ·æ–°ã€è®¾ç½®å…¶å¯åŠ¨æ—¥æœŸå’Œæ´»åŠ¨æ ‡å¿—ä»¥åŠæ‰§è¡Œå±æ€§æºçš„ä»»ä½•åˆå§‹åŒ–ã€‚\r\n     */\r\n    protected void prepareRefresh() {\r\n       ...\r\n\r\n       // Initialize any placeholder property sources in the context environment.\r\n       initPropertySources();\r\n\r\n       // Validate that all properties marked as required are resolvable:\r\n       // see ConfigurablePropertyResolver#setRequiredProperties\r\n       getEnvironment().validateRequiredProperties();\r\n\r\n       ...\r\n    }\r\n```\r\n\r\n\r\n\r\n\r\n\r\n------\r\n\r\n### **2. obtainFreshBeanFactory**\r\n\r\n* è¿™ä¸€æ­¥è·å–ï¼ˆæˆ–åˆ›å»ºï¼‰ BeanFactoryï¼Œå®ƒä¹Ÿæ˜¯ä½œä¸º ApplicationContext çš„ä¸€ä¸ªæˆå‘˜å˜é‡\r\n* ApplicationContext+BeanFactoryï¼šApplicationContextåœ¨Beançš„ç®¡ç†ä¸Šå€ŸåŠ©BeanFactoryçš„åŠŸèƒ½\r\n* BeanFactory çš„ä½œç”¨æ˜¯è´Ÿè´£ bean çš„åˆ›å»ºã€ä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–ï¼Œbean çš„å„é¡¹ç‰¹å¾ç”± BeanDefinition å®šä¹‰\r\n  * BeanDefinition ä½œä¸º bean çš„è®¾è®¡è“å›¾ï¼Œè§„å®šäº† bean çš„ç‰¹å¾ï¼Œå¦‚å•ä¾‹å¤šä¾‹ã€ä¾èµ–å…³ç³»ã€åˆå§‹é”€æ¯æ–¹æ³•ç­‰\r\n  * BeanDefinition çš„æ¥æºæœ‰å¤šç§å¤šæ ·ï¼Œå¯ä»¥æ˜¯é€šè¿‡ xml è·å¾—ã€é…ç½®ç±»è·å¾—ã€ç»„ä»¶æ‰«æè·å¾—ï¼Œä¹Ÿå¯ä»¥æ˜¯ç¼–ç¨‹æ·»åŠ \r\n* æ‰€æœ‰çš„ BeanDefinition ä¼šå­˜å…¥ BeanFactory ä¸­çš„ beanDefinitionMap é›†åˆï¼›\r\n\r\n![image-20210902182004819](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902182004819.png)\r\n\r\n![image-20230421223009256](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421223009256.png)\r\n\r\n> - BeanFactoryä¸­ä¹Ÿæœ‰å¾ˆå¤šæˆå‘˜å˜é‡è¦åˆå§‹åŒ–ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„beanDefinitionMapï¼ŒBeanFactoryå¹¶ä¸æ˜¯ä¸€ä¸Šæ¥å°±åˆ›å»ºè¿™äº›Beanï¼Œå®ƒå¿…é¡»å…ˆæœ‰äº›Beançš„å®šä¹‰ï¼Œå®ƒå¾—çŸ¥é“è¿™ä¸ªBeané•¿ä»€ä¹ˆæ ·å­ï¼ŒBeanæ˜¯å•ä¾‹è¿˜æ˜¯å¤šä¾‹ï¼Œå®ƒçš„åˆå§‹åŒ–æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Œå®ƒæœ‰å“ªäº›å±æ€§éœ€è¦ä¾èµ–æ³¨å…¥ï¼Œè¿™äº›ä¿¡æ¯åœ¨Springä¸­éƒ½æ˜¯ç”¨beanDefinitionMapè¿™ä¸ªç±»æ¥æè¿°çš„ï¼Œè€Œè¿™ä¸ªbeanDefinitionMapæ˜¯ç”¨æ¥å­˜å‚¨æ‰€æœ‰çš„BeanDefinition\r\n> - BeanFactoryä¸æ˜¯ä¸€ä¸‹å­å°±æŠŠBeanåˆ›å»ºå‡ºæ¥ï¼Œå¾—å€ŸåŠ©BeanDefinitionï¼ˆBeançš„è®¾è®¡è“å›¾ï¼‰ï¼Œåˆšå¼€å§‹éƒ½æ˜¯æ”¶é›†BeanDefinitionçš„å„ç§ä¿¡æ¯\r\n\r\n- æ­¤æ–¹æ³•ä»…åœ¨AbstractApplicationContextç±»å†…è¢«è°ƒç”¨ä¸”æœªè¢«é‡å†™\r\n\r\n```java\r\n    protected ConfigurableListableBeanFactory obtainFreshBeanFactory() {\r\n       refreshBeanFactory();\r\n       return getBeanFactory();\r\n    }\r\n```\r\n\r\n- ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ç”±AbstractRefreshableApplicationContextå’ŒGenericApplicationContextä¸¤ä¸ªç±»é‡å†™ï¼Œä¸”åˆ›å»ºæˆ–è·å–çš„BeanFactoryç±»å‹éƒ½ä¸ºDefaultListableBeanFactory\r\n\r\n```java\r\n\r\n    protected abstract void refreshBeanFactory() throws BeansException, IllegalStateException;\r\n\r\n\r\n\r\n\t@Override\r\n\tpublic abstract ConfigurableListableBeanFactory getBeanFactory() throws IllegalStateException;\r\n```\r\n\r\n\r\n\r\n\r\n\r\n------\r\n\r\n### **3. prepareBeanFactory**\r\n\r\n```java\r\n/**\r\n * Configure the factory's standard context characteristics,\r\n * such as the context's ClassLoader and post-processors.\r\n * @param beanFactory the BeanFactory to configure\r\n */\r\nprotected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) {\r\n   ......\r\n}\r\n```\r\n\r\n* è¿™ä¸€æ­¥ä¼šè¿›ä¸€æ­¥å®Œå–„ BeanFactoryï¼Œä¸ºå®ƒçš„å„é¡¹æˆå‘˜å˜é‡èµ‹å€¼\r\n* beanExpressionResolver ç”¨æ¥è§£æ SpELï¼Œå¸¸è§å®ç°ä¸º StandardBeanExpressionResolver\r\n\r\n```java\r\nbeanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));\r\n```\r\n\r\n* propertyEditorRegistrar ä¼šæ³¨å†Œç±»å‹è½¬æ¢å™¨\r\n  * å®ƒåœ¨è¿™é‡Œä½¿ç”¨äº† ResourceEditorRegistrar å®ç°ç±»\r\n  * å¹¶åº”ç”¨ ApplicationContext æä¾›çš„ Environment å®Œæˆ ${ } è§£æ\r\n\r\n  ```java\r\n  beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment()));\r\n  ```\r\n* registerResolvableDependency æ¥æ³¨å†Œ beanFactory ä»¥åŠ ApplicationContextï¼Œè®©å®ƒä»¬ä¹Ÿèƒ½ç”¨äºä¾èµ–æ³¨å…¥\r\n\r\n```java\r\n// BeanFactory interface not registered as resolvable type in a plain factory.\r\n// MessageSource registered (and found for autowiring) as a bean.\r\nbeanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);\r\nbeanFactory.registerResolvableDependency(ResourceLoader.class, this);\r\nbeanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this);\r\nbeanFactory.registerResolvableDependency(ApplicationContext.class, this);\r\n```\r\n\r\n* beanPostProcessors æ˜¯ bean åå¤„ç†å™¨é›†åˆï¼Œä¼šå·¥ä½œåœ¨ bean çš„ç”Ÿå‘½å‘¨æœŸå„ä¸ªé˜¶æ®µï¼Œæ­¤å¤„ä¼šæ·»åŠ ä¸¤ä¸ªï¼š\r\n  * ApplicationContextAwareProcessor ç”¨æ¥è§£æ Aware æ¥å£\r\n\r\n  ```java\r\n  // Configure the bean factory with context callbacks.\r\n  beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this));\r\n  ```\r\n\r\n  * ApplicationListenerDetector ç”¨æ¥è¯†åˆ«å®¹å™¨ä¸­ ApplicationListener ç±»å‹çš„ bean\r\n\r\n  ```java\r\n  // Register early post-processor for detecting inner beans as ApplicationListeners.\r\n  beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(this));\r\n  ```\r\n\r\n  * ç²‰çº¢æ­£æ–¹å½¢ä»£è¡¨å†…ç½®çš„Beanåå¤„ç†å™¨\r\n\r\n![image-20210902182541925](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902182541925.png)\r\n\r\n> - beanExpressionResolveræ˜¯ç”¨æ¥è§£æSpringELè¡¨è¾¾å¼(SpEL)ï¼Œå³`#{}`\r\n> - propertyEditorRegistraræ˜¯æ³¨å†Œä¸€äº›ç±»å‹è½¬æ¢å™¨ï¼Œå› ä¸ºSpringæ¥ä¸‹æ¥å°¤å…¶æ˜¯åšå€¼æ³¨å…¥ï¼Œéœ€è¦æŠŠå­—ç¬¦ä¸²ç±»å‹è½¬æ¢ä¸ºä¸€äº›å…¶ä»–ç±»å‹ï¼Œæ­¤æ—¶éœ€è¦æ³¨å†Œä¸€äº›propertyEditorè½¬æ¢å™¨æ¥å®Œæˆè½¬æ¢\r\n> - resolvableDependenciesæ˜¯ç®¡ç†ä¸€äº›ç‰¹æ®Šçš„å¯¹è±¡ç”¨æ¥è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œå› ä¸ºå°†æ¥å¤§éƒ¨åˆ†çš„Beanéƒ½æ˜¯æ”¾åœ¨singletonObjectså•ä¾‹Beanå·¥å‚é‡Œå»å®Œæˆä¾èµ–æ³¨å…¥ï¼Œä½†æ˜¯æœ‰äº›æ¯”è¾ƒç‰¹æ®Šçš„å¯¹è±¡ï¼Œå¦‚æ³¨å…¥BeanFactoryæœ¬èº«æˆ–è€…æ³¨å…¥ApplicationContextæœ¬èº«ï¼Œè¿™äº›å¯¹è±¡ä¸æ˜¯çœŸæ­£çš„Beanï¼ˆç‰¹æ®Šå¯¹è±¡è€Œå·²ï¼Œè¿˜ç®—ä¸ä¸ŠBeanï¼‰ï¼Œå®ƒä»¬æ²¡æœ‰åœ¨è¿™ä¸ªå•ä¾‹æ± é‡Œï¼Œæ²¡æœ‰åœ¨è¿™ä¸ªBeanDefinitioné‡Œå»å®šä¹‰ï¼Œé‚£ä¹ˆæŸ¥è¯¢è¿™äº›ç‰¹æ®ŠBeanå°±æ˜¯åœ¨è¿™ä¸ªresolvableDependenciesé‡ŒæŸ¥\r\n> - beanPostProcessorsæ˜¯åœ¨æˆ‘ä»¬Beanåˆ›å»ºæ—¶ï¼Œå¯¹è¿™ä¸ªBeançš„å„é¡¹åŠŸèƒ½åšä¸€äº›æ‰©å±•ï¼Œå¯¹é‡Œé¢çš„ä¸€äº›æ³¨è§£è¿›è¡Œè¯†åˆ«ï¼ŒSpringæ ‡å‡†çš„åŠŸèƒ½é‡ŒåŠŸèƒ½æ˜¯éå¸¸æœ‰é™çš„ï¼Œå®ƒå¯¹Beançš„åˆ›å»ºè¿‡ç¨‹åšå„ç§å„æ ·çš„æ‰©å±•æ—¶å¿…é¡»å€ŸåŠ©äºå¾ˆå¤šçš„beanPostProcessor\r\n\r\n\r\n\r\n\r\n\r\n------\r\n\r\n### **4. postProcessBeanFactory**\r\n\r\n* è¿™ä¸€æ­¥æ˜¯ç©ºå®ç°ï¼Œç•™ç»™å­ç±»æ‰©å±•ã€‚ï¼ˆBeanå·¥å‚çš„ä¸€ç§æ‰©å±•æ–¹å¼ï¼‰\r\n\r\n  ```java\r\n  /**\r\n   * Modify the application context's internal bean factory after its standard\r\n   * initialization. All bean definitions will have been loaded, but no beans\r\n   * will have been instantiated yet. This allows for registering special\r\n   * BeanPostProcessors etc in certain ApplicationContext implementations.\r\n   * @param beanFactory the bean factory used by the application context\r\n   */\r\n  protected void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) {\r\n  }\r\n  ```\r\n  \r\n  * ä¸€èˆ¬ Web ç¯å¢ƒçš„ ApplicationContext éƒ½è¦åˆ©ç”¨å®ƒæ³¨å†Œæ–°çš„ Scopeï¼Œå®Œå–„ Web ä¸‹çš„ BeanFactory\r\n  \r\n* è¿™é‡Œä½“ç°çš„æ˜¯æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼\r\n\r\n> ApplicationContextå°†æ¥å¯èƒ½æœ‰ä¸åŒçš„å­ç±»ï¼Œæœ‰ä¸€ç§æ˜¯éwebç¯å¢ƒä¸‹çš„å­ç±»ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯webç¯å¢ƒä¸‹çš„å­ç±»ï¼Œé‚£webç¯å¢ƒä¸‹çš„å­ç±»åˆå§‹åŒ–beanFactoryï¼Œå°±éœ€è¦æ›´å¤šçš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¦æ³¨å†Œä¸€äº›æ–°çš„scopeï¼Œéwebç¯å¢ƒä¸‹çš„å­ç±»ï¼Œåªéœ€è¦æœ‰singletonå’Œprototypeè¿™ä¸¤ç§scope,webç¯å¢ƒä¸‹å¯èƒ½è¿˜éœ€è¦request,sessionè¿™æ ·çš„scopeï¼Œæ‰€ä»¥è¯¥æ–¹æ³•å°±æ²¡æœ‰å®ç°ï¼Œç•™ç»™å­ç±»æ‰©å±•\r\n\r\n\r\n\r\n------\r\n\r\n### **5. invokeBeanFactoryPostProcessors**\r\n\r\n```java\r\n/**\r\n * Instantiate and invoke all registered BeanFactoryPostProcessor beans,\r\n * respecting explicit order if given.\r\n * <p>Must be called before singleton instantiation.\r\n * å®ä¾‹åŒ–å¹¶è°ƒç”¨æ‰€æœ‰å·²æ³¨å†Œçš„ BeanFactoryPostProcessor beanï¼Œå¦‚æœç»™å®šåˆ™éµå¾ªæ˜¾å¼é¡ºåºã€‚å¿…é¡»åœ¨å•ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ã€‚\r\n */\r\nprotected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) {\r\n   PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());\r\n\r\n   // Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime\r\n   // (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)\r\n   if (beanFactory.getTempClassLoader() == null && beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) {\r\n      beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));\r\n      beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));\r\n   }\r\n}\r\n```\r\n\r\n* è¿™ä¸€æ­¥ä¼šè°ƒç”¨ beanFactory åå¤„ç†å™¨ï¼ˆBeanå·¥å‚çš„å¦ä¸€ç§æ‰©å±•æ–¹å¼ï¼‰\r\n  * å®é™…ä¸Šå°†æ¥çœŸæ­£å·¥ä½œçš„æ—¶å€™ä¸å¯èƒ½ä¸ºäº†æ‰©å±•åŠŸèƒ½å°±å»å®ç°æ–°çš„ApplicationContextå­ç±»ï¼Œæ‰€ä»¥æ›´å¥½çš„æ‰©å±•æ–¹å¼å°±æ˜¯é€šè¿‡Beanå·¥å‚åå¤„ç†å™¨çš„æ–¹å¼æ¥æ‰©å±•BeanFactoryçš„åŠŸèƒ½\r\n\r\n* **beanFactory åå¤„ç†å™¨**ï¼Œ**å……å½“ beanFactory çš„æ‰©å±•ç‚¹**ï¼Œå¯ä»¥ç”¨æ¥è¡¥å……æˆ–ä¿®æ”¹ BeanDefinition\r\n\r\n```java\r\npublic static void invokeBeanFactoryPostProcessors(\r\n      ConfigurableListableBeanFactory beanFactory, List<BeanFactoryPostProcessor> beanFactoryPostProcessors) {\r\n    ...\r\n\tSet<String> processedBeans = new HashSet<>();\r\n\r\n\tif (beanFactory instanceof BeanDefinitionRegistry) {    \r\n        BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;\r\n        ...\r\n        // Do not initialize FactoryBeans here: We need to leave all regular beans\r\n        // uninitialized to let the bean factory post-processors apply to them!\r\n        // Separate between BeanDefinitionRegistryPostProcessors that implement\r\n        // PriorityOrdered, Ordered, and the rest.\r\n        List<BeanDefinitionRegistryPostProcessor> currentRegistryProcessors = new ArrayList<>();\r\n        // First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.\r\n        String[] postProcessorNames =\r\n                beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);\r\n        for (String ppName : postProcessorNames) {\r\n            if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {\r\n                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));\r\n                processedBeans.add(ppName);\r\n            }\r\n        }\r\n    ...\r\n    }\r\n}\r\n```\r\n\r\n* å¸¸è§çš„ beanFactory åå¤„ç†å™¨æœ‰\r\n  * ConfigurationClassPostProcessor â€“ è§£æ @Configurationã€@Beanã€@Importã€@PropertySource ç­‰\r\n\r\n  ```java\r\n  public class ConfigurationClassPostProcessor implements BeanDefinitionRegistryPostProcessor,\r\n        PriorityOrdered, ResourceLoaderAware, BeanClassLoaderAware, EnvironmentAware {...}\r\n  ```\r\n\r\n  * PropertySourcesPlaceHolderConfigurer â€“ æ›¿æ¢ BeanDefinition ä¸­çš„ `${}`ï¼ˆXMLçš„ApplicationContextå®ç°ç”¨çš„å¤šï¼‰\r\n  * MapperScannerConfigurer â€“ è¡¥å…… Mapper æ¥å£å¯¹åº”çš„ BeanDefinition\r\n\r\n![image-20230421232304434](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421232304434.png)\r\n\r\n> beanFactory åå¤„ç†å™¨åœ¨refreshæ–¹æ³•è°ƒç”¨ä¹‹å‰å°±æœ‰ä¸€éƒ¨åˆ†åå¤„ç†å™¨åŠ å…¥åˆ°å®¹å™¨äº†\r\n\r\n```java\r\npublic ConfigurableApplicationContext run(String... args) {\r\n    ...\r\n\tprepareContext(context, environment, listeners, applicationArguments, printedBanner);\r\n\trefreshContext(context);\r\n\tafterRefresh(context, applicationArguments);    \r\n    ...\r\n\r\n}\r\n```\r\n\r\n\r\n\r\n------\r\n\r\n### **6. registerBeanPostProcessors**\r\n\r\n```java\r\n/**\r\n * Instantiate and register all BeanPostProcessor beans,\r\n * respecting explicit order if given.\r\n * <p>Must be called before any instantiation of application beans.\r\n * å®ä¾‹åŒ–å¹¶æ³¨å†Œæ‰€æœ‰ BeanPostProcessor beanï¼Œå¦‚æœç»™å®šåˆ™éµå®ˆæ˜¾å¼é¡ºåºã€‚å¿…é¡»åœ¨ä»»ä½•åº”ç”¨ç¨‹åº bean å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ã€‚\r\n */\r\nprotected void registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) {\r\n   PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this);\r\n}\r\n```\r\n\r\n* è¿™ä¸€æ­¥æ˜¯ç»§ç»­ä» beanFactory ä¸­æ‰¾å‡º bean åå¤„ç†å™¨ï¼Œæ·»åŠ è‡³ beanPostProcessors é›†åˆä¸­\r\n\r\n```java\r\npublic static void registerBeanPostProcessors(\r\n      ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) {\r\n\r\n   String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false);\r\n\r\n   // Register BeanPostProcessorChecker that logs an info message when\r\n   // a bean is created during BeanPostProcessor instantiation, i.e. when\r\n   // a bean is not eligible for getting processed by all BeanPostProcessors.\r\n   int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length;\r\n   beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));\r\n\r\n   // Separate between BeanPostProcessors that implement PriorityOrdered,\r\n   // Ordered, and the rest.\r\n   List<BeanPostProcessor> priorityOrderedPostProcessors = new ArrayList<>();\r\n   List<BeanPostProcessor> internalPostProcessors = new ArrayList<>();\r\n   List<String> orderedPostProcessorNames = new ArrayList<>();\r\n   List<String> nonOrderedPostProcessorNames = new ArrayList<>();\r\n   for (String ppName : postProcessorNames) {\r\n      if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {\r\n         BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);\r\n         priorityOrderedPostProcessors.add(pp);\r\n         if (pp instanceof MergedBeanDefinitionPostProcessor) {\r\n            internalPostProcessors.add(pp);\r\n         }\r\n      }\r\n      else if (beanFactory.isTypeMatch(ppName, Ordered.class)) {\r\n         orderedPostProcessorNames.add(ppName);\r\n      }\r\n      else {\r\n         nonOrderedPostProcessorNames.add(ppName);\r\n      }\r\n   }\r\n\r\n   // First, register the BeanPostProcessors that implement PriorityOrdered.\r\n   sortPostProcessors(priorityOrderedPostProcessors, beanFactory);\r\n   registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);\r\n\r\n   // Next, register the BeanPostProcessors that implement Ordered.\r\n   List<BeanPostProcessor> orderedPostProcessors = new ArrayList<>(orderedPostProcessorNames.size());\r\n   for (String ppName : orderedPostProcessorNames) {\r\n      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);\r\n      orderedPostProcessors.add(pp);\r\n      if (pp instanceof MergedBeanDefinitionPostProcessor) {\r\n         internalPostProcessors.add(pp);\r\n      }\r\n   }\r\n   sortPostProcessors(orderedPostProcessors, beanFactory);\r\n   registerBeanPostProcessors(beanFactory, orderedPostProcessors);\r\n\r\n   // Now, register all regular BeanPostProcessors.\r\n   List<BeanPostProcessor> nonOrderedPostProcessors = new ArrayList<>(nonOrderedPostProcessorNames.size());\r\n   for (String ppName : nonOrderedPostProcessorNames) {\r\n      BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);\r\n      nonOrderedPostProcessors.add(pp);\r\n      if (pp instanceof MergedBeanDefinitionPostProcessor) {\r\n         internalPostProcessors.add(pp);\r\n      }\r\n   }\r\n   registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);\r\n\r\n   // Finally, re-register all internal BeanPostProcessors.\r\n   sortPostProcessors(internalPostProcessors, beanFactory);\r\n   registerBeanPostProcessors(beanFactory, internalPostProcessors);\r\n\r\n   // Re-register post-processor for detecting inner beans as ApplicationListeners,\r\n   // moving it to the end of the processor chain (for picking up proxies etc).\r\n   beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext));\r\n}\r\n```\r\n\r\n* **bean åå¤„ç†å™¨**ï¼Œ**å……å½“ bean çš„æ‰©å±•ç‚¹**ï¼Œå¯ä»¥å·¥ä½œåœ¨ bean çš„å®ä¾‹åŒ–ã€ä¾èµ–æ³¨å…¥ã€åˆå§‹åŒ–é˜¶æ®µï¼Œå¸¸è§çš„æœ‰ï¼š\r\n\r\n  * AutowiredAnnotationBeanPostProcessor åŠŸèƒ½æœ‰ï¼šè§£æ @Autowiredï¼Œ@Value \r\n\r\n  ![image-20231128221603715](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231128221603715.png)\r\n\r\n  * CommonAnnotationBeanPostProcessor åŠŸèƒ½æœ‰ï¼šè§£æ @Resourceï¼Œ@PostConstructï¼Œ@PreDestroy\r\n\r\n  ![image-20231128222113889](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231128222113889.png)\r\n\r\n  * AnnotationAwareAspectJAutoProxyCreator åŠŸèƒ½æœ‰ï¼šä¸ºç¬¦åˆåˆ‡ç‚¹çš„ç›®æ ‡ bean è‡ªåŠ¨åˆ›å»ºä»£ç†\r\n\r\n  ![image-20231128221128903](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231128221128903.png)\r\n\r\n  \r\n\r\n![image-20230421232557342](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421232557342.png)\r\n\r\n![image-20230421232957513](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421232957513.png)\r\n\r\n> Beançš„åå¤„ç†å™¨æ˜¯å¯¹æˆ‘ä»¬Beanåˆ›å»ºçš„è¿‡ç¨‹ä¸­åšå„ç§åŠŸèƒ½çš„å¢å¼ºï¼Œè€ŒBeançš„åå¤„ç†å™¨å…¶å®éƒ½æ˜¯ä»beanDefinitionMapä¸­å»æœç´¢ï¼Œçœ‹çœ‹é‡Œé¢è¿™äº›BeanDefinitionæœ‰æ²¡æœ‰å®ç°BeanPostProcessoræ¥å£ï¼Œå¦‚æœå®ç°äº†æ¥å£å°±ä¼šè¯†åˆ«å‡ºæ¥æ˜¯ä¸ªç‰¹æ®Šçš„Beanï¼Œæ˜¯ä¸ªBeançš„åå¤„ç†å™¨ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠè¿™æ ·çš„Beanåˆ›å»ºå‡ºæ¥ï¼Œåˆ›å»ºå‡ºæ¥ä»¥åï¼ŒæŠŠè¿™ä¸ªBeançš„åå¤„ç†å™¨å¯¹è±¡åŠ äººåˆ°è¿™ä¸ªbeanPostProcessorsé›†åˆé‡Œï¼Œé‚£åœ¨BençœŸæ­£åˆ›å»ºçš„æ—¶å€™å°±ä¼šç”¨åˆ°è¿™äº›åå¤„ç†å™¨\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n### **7. initMessageSource**\r\n\r\n* è¿™ä¸€æ­¥æ˜¯ä¸º ApplicationContext æ·»åŠ  messageSource æˆå‘˜ï¼Œå®ç°å›½é™…åŒ–åŠŸèƒ½\r\n* å» beanFactory å†…æ‰¾åä¸º messageSource çš„ beanï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æä¾›ç©ºçš„ MessageSource å®ç°\r\n\r\n```java\r\n/**\r\n * Initialize the MessageSource.\r\n * Use parent's if none defined in this context.\r\n */\r\nprotected void initMessageSource() {\r\n   ConfigurableListableBeanFactory beanFactory = getBeanFactory();\r\n   if (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) {\r\n      this.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);\r\n      // Make MessageSource aware of parent MessageSource.\r\n      if (this.parent != null && this.messageSource instanceof HierarchicalMessageSource) {\r\n         HierarchicalMessageSource hms = (HierarchicalMessageSource) this.messageSource;\r\n         if (hms.getParentMessageSource() == null) {\r\n            // Only set parent context as parent MessageSource if no parent MessageSource\r\n            // registered already.\r\n            hms.setParentMessageSource(getInternalParentMessageSource());\r\n         }\r\n      }\r\n      if (logger.isTraceEnabled()) {\r\n         logger.trace(\"Using MessageSource [\" + this.messageSource + \"]\");\r\n      }\r\n   }\r\n   else {\r\n      // Use empty MessageSource to be able to accept getMessage calls.\r\n      DelegatingMessageSource dms = new DelegatingMessageSource();\r\n      dms.setParentMessageSource(getInternalParentMessageSource());\r\n      this.messageSource = dms;\r\n      beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, this.messageSource);\r\n      if (logger.isTraceEnabled()) {\r\n         logger.trace(\"No '\" + MESSAGE_SOURCE_BEAN_NAME + \"' bean, using [\" + this.messageSource + \"]\");\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n![image-20210902183819984](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902183819984.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **8. initApplicationContextEventMulticaster**\r\n\r\n* è¿™ä¸€æ­¥ä¸º ApplicationContext æ·»åŠ äº‹ä»¶å¹¿æ’­å™¨æˆå‘˜ï¼Œå³ applicationContextEventMulticaster\r\n* å®ƒçš„ä½œç”¨æ˜¯å‘å¸ƒäº‹ä»¶ç»™ç›‘å¬å™¨\r\n* å» beanFactory æ‰¾åä¸º applicationEventMulticaster çš„ bean ä½œä¸ºäº‹ä»¶å¹¿æ’­å™¨ï¼Œè‹¥æ²¡æœ‰ï¼Œä¼šåˆ›å»ºé»˜è®¤çš„äº‹ä»¶å¹¿æ’­å™¨\r\n* ä¹‹åå°±å¯ä»¥è°ƒç”¨ ApplicationContext.publishEvent(äº‹ä»¶å¯¹è±¡) æ¥å‘å¸ƒäº‹ä»¶\r\n\r\n```java\r\n/**\r\n * Initialize the ApplicationEventMulticaster.\r\n * Uses SimpleApplicationEventMulticaster if none defined in the context.\r\n * @see org.springframework.context.event.SimpleApplicationEventMulticaster\r\n */\r\nprotected void initApplicationEventMulticaster() {\r\n   ConfigurableListableBeanFactory beanFactory = getBeanFactory();\r\n   if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) {\r\n      this.applicationEventMulticaster =\r\n            beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);\r\n      if (logger.isTraceEnabled()) {\r\n         logger.trace(\"Using ApplicationEventMulticaster [\" + this.applicationEventMulticaster + \"]\");\r\n      }\r\n   }\r\n   else {\r\n      this.applicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory);\r\n      beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, this.applicationEventMulticaster);\r\n      if (logger.isTraceEnabled()) {\r\n         logger.trace(\"No '\" + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + \"' bean, using \" +\r\n               \"[\" + this.applicationEventMulticaster.getClass().getSimpleName() + \"]\");\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n![image-20210902183943469](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902183943469.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **9. onRefresh**\r\n\r\n```java\r\n/**\r\n * Template method which can be overridden to add context-specific refresh work.\r\n * Called on initialization of special beans, before instantiation of singletons.\r\n * <p>This implementation is empty.\r\n * @throws BeansException in case of errors\r\n * @see #refresh()\r\n */\r\nprotected void onRefresh() throws BeansException {\r\n   // For subclasses: do nothing by default.\r\n}\r\n```\r\n\r\n* è¿™ä¸€æ­¥æ˜¯ç©ºå®ç°ï¼Œç•™ç»™å­ç±»æ‰©å±•\r\n  * SpringBoot ä¸­çš„å­ç±»åœ¨è¿™é‡Œå‡†å¤‡äº† WebServerï¼Œå³å†…åµŒ web å®¹å™¨\r\n* ä½“ç°çš„æ˜¯æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼\r\n\r\n\r\n\r\n------\r\n\r\n### **10. registerListeners**\r\n\r\n* è¿™ä¸€æ­¥ä¼šä»å¤šç§é€”å¾„æ‰¾åˆ°äº‹ä»¶ç›‘å¬å™¨ï¼Œå¹¶æ·»åŠ è‡³ applicationEventMulticaster\r\n* äº‹ä»¶ç›‘å¬å™¨é¡¾åæ€ä¹‰ï¼Œç”¨æ¥æ¥æ”¶äº‹ä»¶å¹¿æ’­å™¨å‘å¸ƒçš„äº‹ä»¶ï¼Œæœ‰å¦‚ä¸‹æ¥æº\r\n  * äº‹å…ˆç¼–ç¨‹æ·»åŠ çš„\r\n  * æ¥è‡ªå®¹å™¨ä¸­çš„ bean\r\n  * æ¥è‡ªäº @EventListener çš„è§£æ\r\n* è¦å®ç°äº‹ä»¶ç›‘å¬å™¨ï¼Œåªéœ€è¦å®ç° ApplicationListener æ¥å£ï¼Œé‡å†™å…¶ä¸­ onApplicationEvent(E e) æ–¹æ³•å³å¯\r\n\r\n```java\r\n/**\r\n * Add beans that implement ApplicationListener as listeners.\r\n * Doesn't affect other listeners, which can be added without being beans.\r\n */\r\nprotected void registerListeners() {\r\n   // Register statically specified listeners first.\r\n   for (ApplicationListener<?> listener : getApplicationListeners()) {\r\n      getApplicationEventMulticaster().addApplicationListener(listener);\r\n   }\r\n\r\n   // Do not initialize FactoryBeans here: We need to leave all regular beans\r\n   // uninitialized to let post-processors apply to them!\r\n   String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false);\r\n   for (String listenerBeanName : listenerBeanNames) {\r\n      getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);\r\n   }\r\n\r\n   // Publish early application events now that we finally have a multicaster...\r\n   Set<ApplicationEvent> earlyEventsToProcess = this.earlyApplicationEvents;\r\n   this.earlyApplicationEvents = null;\r\n   if (earlyEventsToProcess != null) {\r\n      for (ApplicationEvent earlyEvent : earlyEventsToProcess) {\r\n         getApplicationEventMulticaster().multicastEvent(earlyEvent);\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n- å¾®ç³»ç»Ÿä¸ç¬¬ä¸‰æ–¹æ¡†æ¶licationEventMulticaster çš„å®ç°ç±»æ‰§è¡Œæ‰€æœ‰ç›‘å¬å™¨çš„ onApplicationEvent æ–¹æ³•\r\n\r\n```java\r\npublic class SimpleApplicationEventMulticaster extends AbstractApplicationEventMulticaster {\r\n\r\n\t......\r\n\r\n\t@SuppressWarnings({\"rawtypes\", \"unchecked\"})\r\n\tprivate void doInvokeListener(ApplicationListener listener, ApplicationEvent event) {\r\n\t\ttry {\r\n\t\t\tlistener.onApplicationEvent(event);\r\n\t\t}\r\n\t\tcatch (ClassCastException ex) {\r\n\t\t\tString msg = ex.getMessage();\r\n\t\t\tif (msg == null || matchesClassCastMessage(msg, event.getClass())) {\r\n\t\t\t\t// Possibly a lambda-defined listener which we could not resolve the generic event type for\r\n\t\t\t\t// -> let's suppress the exception and just log a debug message.\r\n\t\t\t\tLog logger = LogFactory.getLog(getClass());\r\n\t\t\t\tif (logger.isTraceEnabled()) {\r\n\t\t\t\t\tlogger.trace(\"Non-matching event type for listener: \" + listener, ex);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthrow ex;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t......\r\n\r\n}\r\n\r\n```\r\n\r\n\r\n\r\n![image-20210902184343872](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902184343872.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **11. finishBeanFactoryInitialization**\r\n\r\n* è¿™ä¸€æ­¥ä¼šå°† beanFactory çš„æˆå‘˜è¡¥å……å®Œæ¯•ï¼Œå¹¶åˆå§‹åŒ–æ‰€æœ‰éå»¶è¿Ÿå•ä¾‹ bean\r\n* conversionService ä¹Ÿæ˜¯ä¸€å¥—è½¬æ¢æœºåˆ¶ï¼Œä½œä¸ºå¯¹ PropertyEditor çš„è¡¥å……\r\n* embeddedValueResolvers å³å†…åµŒå€¼è§£æå™¨ï¼Œç”¨æ¥è§£æ @Value ä¸­çš„ `${}`ï¼Œå€Ÿç”¨çš„æ˜¯ Environment çš„åŠŸèƒ½\r\n* singletonObjects å³å•ä¾‹æ± ï¼Œç¼“å­˜æ‰€æœ‰å•ä¾‹å¯¹è±¡\r\n  * å¯¹è±¡çš„åˆ›å»ºéƒ½åˆ†ä¸‰ä¸ªé˜¶æ®µï¼Œæ¯ä¸€é˜¶æ®µéƒ½æœ‰ä¸åŒçš„ bean åå¤„ç†å™¨å‚ä¸è¿›æ¥ï¼Œæ‰©å±•åŠŸèƒ½\r\n\r\n```java\r\n/**\r\n * Finish the initialization of this context's bean factory,\r\n * initializing all remaining singleton beans.\r\n */\r\nprotected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) {\r\n   // Initialize conversion service for this context.\r\n   if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &&\r\n         beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) {\r\n      beanFactory.setConversionService(\r\n            beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));\r\n   }\r\n\r\n   // Register a default embedded value resolver if no bean post-processor\r\n   // (such as a PropertyPlaceholderConfigurer bean) registered any before:\r\n   // at this point, primarily for resolution in annotation attribute values.\r\n   if (!beanFactory.hasEmbeddedValueResolver()) {\r\n      beanFactory.addEmbeddedValueResolver(strVal -> getEnvironment().resolvePlaceholders(strVal));\r\n   }\r\n\r\n   // Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.\r\n   String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false);\r\n   for (String weaverAwareName : weaverAwareNames) {\r\n      getBean(weaverAwareName);\r\n   }\r\n\r\n   // Stop using the temporary ClassLoader for type matching.\r\n   beanFactory.setTempClassLoader(null);\r\n\r\n   // Allow for caching all bean definition metadata, not expecting further changes.\r\n   beanFactory.freezeConfiguration();\r\n\r\n   // Instantiate all remaining (non-lazy-init) singletons.\r\n   beanFactory.preInstantiateSingletons();\r\n}\r\n```\r\n\r\n![image-20210902184641623](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902184641623.png)\r\n\r\n> - conversionService ä¹Ÿæ˜¯åšç±»å‹è½¬æ¢çš„ï¼Œç”±äº Spring çš„å†å²åŸå› ï¼Œæœ€æ—©æ˜¯ propertyEditorRegistrars æ¥è½¬æ¢çš„ï¼Œåæ¥å‘ç°åŠŸèƒ½ä¸Šã€å®ç°ä¸Šæœ‰äº›æ¬ è€ƒè™‘ï¼Œå› æ­¤è®¾è®¡äº† conversionService æ¥å£ï¼Œè¿™ä¸¤ä¸ªè½¬æ¢å™¨æ˜¯å¹¶å­˜çš„\r\n> - embeddedValueResolvers æ˜¯åš `${}` è¿™ç§å†…åµŒå€¼çš„è§£æï¼Œé—´æ¥åœ°è°ƒç”¨ Environment çš„åŠŸèƒ½æ¥å®Œæˆ `${}` çš„è§£æï¼Œåªä¸è¿‡æ˜¯ä»å±äº BeanFactory ä¸­çš„æˆå‘˜\r\n> - singletonObjects (å•ä¾‹æ± ï¼Œç”¨æ¥ç¼“å­˜æ‰€æœ‰å•ä¾‹å¯¹è±¡)æ˜¯å•ä¾‹å¯¹è±¡é›†åˆï¼Œå®ƒä¼šæ‰¾åˆ° beanDefinitionMap ä¸­æ‰€æœ‰ä½¿ç”¨åˆ°å•ä¾‹çš„å¯¹è±¡ï¼Œçœ‹æœ‰æ²¡æœ‰åˆå§‹åŒ–æ–¹æ³•ï¼Œæœ‰æ²¡æœ‰ä¾èµ–æ³¨å…¥ä¿¡æ¯ç­‰ï¼Œæ ¹æ®è¿™äº›æ¥åˆ›å»ºBeanï¼Œå‰ææ˜¯éå»¶è¿Ÿå•ä¾‹å¯¹è±¡ï¼Œå¦‚æœæ˜¯éå»¶è¿Ÿå•ä¾‹å¯¹è±¡ï¼Œè¿™ä¸€æ­¥å®ƒå°±ä¼šæŠŠ Bean çš„å®ä¾‹å¯¹è±¡åˆ›å»ºå‡ºæ¥ï¼Œå¦‚æœæ˜¯å»¶è¿Ÿå•ä¾‹å¯¹è±¡ï¼Œä½ ç¬¬ä¸€æ¬¡ç”¨åˆ°å®ƒçš„æ—¶å€™æ‰ä¼šåˆ›å»ºï¼Œåœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œä¹‹å‰çš„ beanPostProcessors éƒ½å¯ä»¥æ´¾ä¸Šç”¨åœºï¼Œå®ƒä»¬ä¼šå·¥ä½œåœ¨ Bean åˆ›å»ºçš„å„ä¸ªé˜¶æ®µï¼Œåˆ†ä¸ºä¸‰ä¸ªå¤§çš„é˜¶æ®µï¼ŒBean çš„åˆ›å»ºã€Bean çš„ä¾èµ–æ³¨å…¥ã€Bean çš„åˆå§‹åŒ–ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰ä¸åŒçš„ Bean åå¤„ç†å™¨å‚ä¸è¿›æ¥ï¼Œæ‰©å±•åŠŸèƒ½\r\n\r\n\r\n\r\n------\r\n\r\n### **12. finishRefresh**\r\n\r\n* è¿™ä¸€æ­¥ä¼šä¸º ApplicationContext æ·»åŠ  lifecycleProcessor æˆå‘˜ï¼Œç”¨æ¥æ§åˆ¶å®¹å™¨å†…éœ€è¦ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„ bean\r\n* å¦‚æœå®¹å™¨ä¸­æœ‰åç§°ä¸º lifecycleProcessor çš„ bean å°±ç”¨å®ƒï¼Œå¦åˆ™åˆ›å»ºé»˜è®¤çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨\r\n* å‡†å¤‡å¥½ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨ï¼Œå°±å¯ä»¥å®ç°\r\n  * è°ƒç”¨ context çš„ startï¼Œå³å¯è§¦å‘æ‰€æœ‰å®ç° LifeCycle æ¥å£ bean çš„ start\r\n  * è°ƒç”¨ context çš„ stopï¼Œå³å¯è§¦å‘æ‰€æœ‰å®ç° LifeCycle æ¥å£ bean çš„ stop\r\n* å‘å¸ƒ ContextRefreshed äº‹ä»¶ï¼Œæ•´ä¸ª refresh æ‰§è¡Œå®Œæˆ\r\n\r\n```java\r\n/**\r\n * Finish the refresh of this context, invoking the LifecycleProcessor's\r\n * onRefresh() method and publishing the\r\n * {@link org.springframework.context.event.ContextRefreshedEvent}.\r\n */\r\nprotected void finishRefresh() {\r\n   // Clear context-level resource caches (such as ASM metadata from scanning).\r\n   clearResourceCaches();\r\n\r\n   // Initialize lifecycle processor for this context.\r\n   initLifecycleProcessor();\r\n\r\n   // Propagate refresh to lifecycle processor first.\r\n   getLifecycleProcessor().onRefresh();\r\n\r\n   // Publish the final event.\r\n   publishEvent(new ContextRefreshedEvent(this));\r\n\r\n   // Participate in LiveBeansView MBean, if active.\r\n   LiveBeansView.registerApplicationContext(this);\r\n}\r\n```\r\n\r\n![image-20210902185052433](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210902185052433.png)\r\n\r\n> lifecycleProcessor (ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨): æ•´ä¸ª Spring å®¹å™¨ä¸­æœ‰å¾ˆå¤šçš„ Beanï¼Œå®ƒä»¬éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œéƒ½æœ‰ä¸€ä¸ªåœæ­¢ï¼Œå¯åŠ¨ä¹‹ç±»çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†ï¼Œè¿™é‡Œçš„ç”Ÿå‘½å‘¨æœŸå¹¶ä¸æ˜¯æŒ‡åˆå§‹åŒ–é”€æ¯ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ç§æœåŠ¡ï¼Œå¯ä»¥åœæ­¢å’Œå¯åŠ¨ï¼ŒåŒæ ·çš„ä» beanDefinitionMap ä¸­æ‰¾åˆ°ä¸€ä¸ª lifecycleProcessor çš„ Beanï¼Œå¦‚æœæœ‰å°±ç›´æ¥ç”¨ï¼Œæ²¡æœ‰å®ƒå°±ç”¨è‡ªå·±é»˜è®¤çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ï¼Œè¿™ä¸ª lifecycleProcessor é‡Œé¢æœ‰ start æ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨ Bean å·¥å‚ä¸­å…¶ä»–å®ç° lifecycleProcessor æ¥å£çš„Beançš„ start æ–¹æ³•ï¼Œè°ƒç”¨ stop æ–¹æ³•ä¹Ÿä¸€æ ·ï¼Œèµ·åˆ°ä¸€ä¸ªæ€»æ§çš„ä½œç”¨ï¼Œè¿™ä¸ªç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨åˆ›å»ºå¥½ä»¥åå¯ä»¥å‘å¸ƒ ContextRefreshed äº‹ä»¶ï¼Œè¡¨ç¤ºæ•´ä¸ª Spring å®¹å™¨å·²ç»åˆå§‹åŒ–( Refresh )å®Œæˆ\r\n\r\n\r\n\r\n------\r\n\r\n### **æ€»ç»“**\r\n\r\n![image-20230422003035699](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422003035699.png)\r\n\r\n\r\n\r\n------\r\n\r\n## 2. Spring bean ç”Ÿå‘½å‘¨æœŸ\r\n\r\n**bean ç”Ÿå‘½å‘¨æœŸ æ¦‚è¿°**\r\n\r\n![image-20230422003651658](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422003651658.png)\r\n\r\n- é‡Œé¢çš„è¿™äº›Beanç¬¦åˆæ‡’æƒ°å¼åˆå§‹åŒ–ï¼Œå¼€å§‹å¹¶ä¸ä¼šåˆ›å»ºè¿™äº›Beanï¼Œå½“ä½ ç¬¬ä¸€æ¬¡è·å–æ—¶ï¼Œæ‰ä¼šåˆ›å»ºè¿™äº›Beançš„å®ä¾‹ï¼Œç„¶åè¿›è¡Œä¾èµ–æ³¨å…¥åˆå§‹åŒ–ç­‰æ“ä½œï¼Œä»¥doGetBeanä½œä¸ºèµ·ç‚¹\r\n\r\nbean çš„ç”Ÿå‘½å‘¨æœŸä»è°ƒç”¨ beanFactory çš„ getBean å¼€å§‹ï¼Œåˆ°è¿™ä¸ª bean è¢«é”€æ¯ï¼Œå¯ä»¥æ€»ç»“ä¸ºä»¥ä¸‹ä¸ƒä¸ªé˜¶æ®µï¼š\r\n\r\n1. å¤„ç†åç§°ï¼Œæ£€æŸ¥ç¼“å­˜\r\n2. å¤„ç†çˆ¶å­å®¹å™¨\r\n3. å¤„ç† dependsOn\r\n4. é€‰æ‹© scope ç­–ç•¥\r\n5. åˆ›å»º bean\r\n6. ç±»å‹è½¬æ¢å¤„ç†\r\n7. é”€æ¯ bean\r\n\r\n> ***æ³¨æ„***\r\n>\r\n> * åˆ’åˆ†çš„é˜¶æ®µå’Œåç§°å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ç†è§£æ•´ä¸ªè¿‡ç¨‹ä¸­åšäº†å“ªäº›äº‹æƒ…\r\n\r\n\r\n\r\n\r\n\r\n------\r\n\r\n### **1. å¤„ç†åç§°ï¼Œæ£€æŸ¥ç¼“å­˜**\r\n\r\n* è¿™ä¸€æ­¥ä¼šå¤„ç†åˆ«åï¼Œå°†åˆ«åè§£æä¸ºå®é™…åç§°\r\n* å¯¹ FactoryBean ä¹Ÿä¼šç‰¹æ®Šå¤„ç†ï¼Œå¦‚æœä»¥ & å¼€å¤´è¡¨ç¤ºè¦è·å– FactoryBean æœ¬èº«ï¼Œå¦åˆ™è¡¨ç¤ºè¦è·å–å…¶äº§å“\r\n* è¿™é‡Œé’ˆå¯¹å•ä¾‹å¯¹è±¡ä¼šæ£€æŸ¥ä¸€çº§ã€äºŒçº§ã€ä¸‰çº§ç¼“å­˜\r\n  * singletonFactories ä¸‰çº§ç¼“å­˜ï¼Œå­˜æ”¾å•ä¾‹å·¥å‚å¯¹è±¡\r\n  * earlySingletonObjects äºŒçº§ç¼“å­˜ï¼Œå­˜æ”¾å•ä¾‹å·¥å‚çš„äº§å“å¯¹è±¡\r\n    * å¦‚æœå‘ç”Ÿå¾ªç¯ä¾èµ–ï¼Œäº§å“æ˜¯ä»£ç†ï¼›æ— å¾ªç¯ä¾èµ–ï¼Œäº§å“æ˜¯åŸå§‹å¯¹è±¡\r\n  * singletonObjects ä¸€çº§ç¼“å­˜ï¼Œå­˜æ”¾å•ä¾‹æˆå“å¯¹è±¡\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean\r\n{\r\n    ...\r\n    final String beanName = transformedBeanName(name);\r\n    Object bean;\r\n\r\n    // Eagerly check singleton cache for manually registered singletons.\r\n    Object sharedInstance = getSingleton(beanName);\r\n    if (sharedInstance != null && args == null) {\r\n       if (logger.isTraceEnabled()) {\r\n          if (isSingletonCurrentlyInCreation(beanName)) {\r\n             logger.trace(\"Returning eagerly cached instance of singleton bean '\" + beanName +\r\n                   \"' that is not fully initialized yet - a consequence of a circular reference\");\r\n          }\r\n          else {\r\n             logger.trace(\"Returning cached instance of singleton bean '\" + beanName + \"'\");\r\n          }\r\n       }\r\n       bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);\r\n    }\r\n\t...\r\n}\r\n```\r\n\r\n![image-20230422005021610](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422005021610.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **2. å¤„ç†çˆ¶å­å®¹å™¨**\r\n\r\n* å¦‚æœå½“å‰å®¹å™¨æ ¹æ®åå­—æ‰¾ä¸åˆ°è¿™ä¸ª beanï¼Œæ­¤æ—¶è‹¥çˆ¶å®¹å™¨å­˜åœ¨ï¼Œåˆ™æ‰§è¡Œçˆ¶å®¹å™¨çš„ getBean æµç¨‹\r\n* ä¼˜å…ˆæ‰¾å­å®¹å™¨çš„ beanï¼Œæ‰¾åˆ°äº†ç›´æ¥è¿”å›ï¼Œæ‰¾ä¸åˆ°ç»§ç»­åˆ°çˆ¶å®¹å™¨æ‰¾\r\n* çˆ¶å­å®¹å™¨çš„ bean åç§°å¯ä»¥é‡å¤\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean\r\n{\r\n    ...\r\n    // Check if bean definition exists in this factory.\r\n    BeanFactory parentBeanFactory = getParentBeanFactory();\r\n    if (parentBeanFactory != null && !containsBeanDefinition(beanName)) {\r\n       // Not found -> check parent.\r\n       String nameToLookup = originalBeanName(name);\r\n       if (parentBeanFactory instanceof AbstractBeanFactory) {\r\n          return ((AbstractBeanFactory) parentBeanFactory).doGetBean(\r\n                nameToLookup, requiredType, args, typeCheckOnly);\r\n       }\r\n       else if (args != null) {\r\n          // Delegation to parent with explicit args.\r\n          return (T) parentBeanFactory.getBean(nameToLookup, args);\r\n       }\r\n       else if (requiredType != null) {\r\n          // No args -> delegate to standard getBean method.\r\n          return parentBeanFactory.getBean(nameToLookup, requiredType);\r\n       }\r\n       else {\r\n          return (T) parentBeanFactory.getBean(nameToLookup);\r\n       }\r\n    }\r\n    ...\r\n}\r\n```\r\n\r\n> é¦–å…ˆæŸ¥æ‰¾ç¼“å­˜ï¼Œç¼“å­˜é‡Œæœ‰å°±ç›´æ¥è¿”å›ï¼Œç¼“å­˜é‡Œå¦‚æœæ²¡æœ‰ï¼Œä¹Ÿä¸ä¼šç«‹åˆ»å»åˆ›å»ºè¿™ä¸ªBeanï¼Œå¦‚æœå®¹å™¨ä¸­åˆé…ç½®äº†çˆ¶å®¹å™¨çš„è¯ï¼Œç¼“å­˜é‡Œæ²¡æœ‰å®ƒä¼šåˆ°çˆ¶å®¹å™¨é‡ŒæŸ¥æ‰¾ï¼Œçœ‹çœ‹é‡Œé¢æœ‰æ²¡æœ‰åˆ›å»ºå¥½çš„Beanï¼Œå¦‚æœæœ‰å°±ç”¨çˆ¶å®¹å™¨çš„Beanï¼Œå°±ä¸ç”¨èµ°åˆ›å»ºæµç¨‹ï¼Œå¦‚æœè¿˜æ²¡æœ‰æ‰èµ°åç»­æµç¨‹\r\n\r\n\r\n\r\n------\r\n\r\n### **3. å¤„ç† dependsOn**\r\n\r\n* å¦‚æœå½“å‰ bean æœ‰é€šè¿‡ dependsOn æŒ‡å®šäº†éæ˜¾å¼ä¾èµ–çš„ beanï¼Œè¿™ä¸€æ­¥ä¼šæå‰åˆ›å»ºè¿™äº› dependsOn çš„ bean \r\n* æ‰€è°“éæ˜¾å¼ä¾èµ–ï¼Œå°±æ˜¯æŒ‡ä¸¤ä¸ª bean ä¹‹é—´ä¸å­˜åœ¨ç›´æ¥ä¾èµ–å…³ç³»ï¼Œä½†éœ€è¦æ§åˆ¶å®ƒä»¬çš„åˆ›å»ºå…ˆåé¡ºåº\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean\r\n{\r\n    ...\r\n    final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);\r\n    checkMergedBeanDefinition(mbd, beanName, args);\r\n\r\n    // Guarantee initialization of beans that the current bean depends on.\r\n    String[] dependsOn = mbd.getDependsOn();\r\n    if (dependsOn != null) {\r\n       for (String dep : dependsOn) {\r\n          if (isDependent(beanName, dep)) {\r\n             throw new BeanCreationException(mbd.getResourceDescription(), beanName,\r\n                   \"Circular depends-on relationship between '\" + beanName + \"' and '\" + dep + \"'\");\r\n          }\r\n          registerDependentBean(dep, beanName);\r\n          try {\r\n             getBean(dep);\r\n          }\r\n          catch (NoSuchBeanDefinitionException ex) {\r\n             throw new BeanCreationException(mbd.getResourceDescription(), beanName,\r\n                   \"'\" + beanName + \"' depends on missing bean '\" + dep + \"'\", ex);\r\n          }\r\n       }\r\n    }\r\n    ...\r\n}\r\n```\r\n\r\n![image-20230422005341839](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422005341839.png)\r\n\r\n> å¤§éƒ¨åˆ†çš„Beanéƒ½æœ‰ä¾èµ–å…³ç³»ï¼Œè¿™äº›æœ‰ä¾èµ–å…³ç³»çš„Beanå®ƒä»¬åˆ›å»ºçš„æ¬¡åºæ˜¯å¯ä»¥ä¿éšœçš„ï¼Œé‚£äº›æ²¡æœ‰ä¾èµ–å…³ç³»çš„Beanå¯ä»¥ä½¿ç”¨dependsOnæ¥æ§åˆ¶æ¬¡åº\r\n\r\n\r\n\r\n------\r\n\r\n### **4. é€‰æ‹© scope ç­–ç•¥**\r\n\r\n* å¯¹äº singleton scopeï¼Œé¦–å…ˆåˆ°å•ä¾‹æ± å»è·å– beanï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¿”å›ï¼Œæ²¡æœ‰å†è¿›å…¥åˆ›å»ºæµç¨‹\r\n* å¯¹äº prototype scopeï¼Œæ¯æ¬¡éƒ½ä¼šè¿›å…¥åˆ›å»ºæµç¨‹\r\n* å¯¹äºè‡ªå®šä¹‰ scopeï¼Œä¾‹å¦‚ requestï¼Œé¦–å…ˆåˆ° request åŸŸè·å– beanï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºå¹¶æ”¾å…¥ request\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean\r\n{\r\n    ...\r\n    // Create bean instance.\r\n       if (mbd.isSingleton()) {\r\n          sharedInstance = getSingleton(beanName, () -> {\r\n             try {\r\n                return createBean(beanName, mbd, args);\r\n             }\r\n             catch (BeansException ex) {\r\n                // Explicitly remove instance from singleton cache: It might have been put there\r\n                // eagerly by the creation process, to allow for circular reference resolution.\r\n                // Also remove any beans that received a temporary reference to the bean.\r\n                destroySingleton(beanName);\r\n                throw ex;\r\n             }\r\n          });\r\n          bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);\r\n       }\r\n\r\n       else if (mbd.isPrototype()) {\r\n          // It's a prototype -> create a new instance.\r\n          Object prototypeInstance = null;\r\n          try {\r\n             beforePrototypeCreation(beanName);\r\n             prototypeInstance = createBean(beanName, mbd, args);\r\n          }\r\n          finally {\r\n             afterPrototypeCreation(beanName);\r\n          }\r\n          bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);\r\n       }\r\n\r\n       else {\r\n          String scopeName = mbd.getScope();\r\n          final Scope scope = this.scopes.get(scopeName);\r\n          if (scope == null) {\r\n             throw new IllegalStateException(\"No Scope registered for scope name '\" + scopeName + \"'\");\r\n          }\r\n          try {\r\n             Object scopedInstance = scope.get(beanName, () -> {\r\n                beforePrototypeCreation(beanName);\r\n                try {\r\n                   return createBean(beanName, mbd, args);\r\n                }\r\n                finally {\r\n                   afterPrototypeCreation(beanName);\r\n                }\r\n             });\r\n             bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);\r\n          }\r\n          catch (IllegalStateException ex) {\r\n             throw new BeanCreationException(beanName,\r\n                   \"Scope '\" + scopeName + \"' is not active for the current thread; consider \" +\r\n                   \"defining a scoped proxy for this bean if you intend to refer to it from a singleton\",\r\n                   ex);\r\n          }\r\n       }\r\n    }\r\n    ...\r\n}\r\n```\r\n\r\n![image-20230422011157499](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422011157499.png)\r\n\r\n\r\n\r\n------\r\n\r\n### 5 åˆ›å»º bean\r\n\r\n![image-20230422013329269](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422013329269.png)\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBean\r\n@Override\r\nprotected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)\r\n      throws BeanCreationException {\r\n\t...\r\n      // Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.\r\n      Object bean = resolveBeforeInstantiation(beanName, mbdToUse);\r\n\t...\r\n      Object beanInstance = doCreateBean(beanName, mbdToUse, args);\r\n\t...\r\n}\r\n```\r\n\r\n\r\n\r\n------\r\n\r\n#### **5.1 åˆ›å»º bean - åˆ›å»º bean å®ä¾‹**\r\n\r\n| **è¦ç‚¹**                             | **æ€»ç»“**                                                     |\r\n| ------------------------------------ | ------------------------------------------------------------ |\r\n| æœ‰è‡ªå®šä¹‰ TargetSource çš„æƒ…å†µ         | ç”± AnnotationAwareAspectJAutoProxyCreator åˆ›å»ºä»£ç†è¿”å›       |\r\n| Supplier æ–¹å¼åˆ›å»º bean å®ä¾‹          | ä¸º Spring 5.0 æ–°å¢åŠŸèƒ½ï¼Œæ–¹ä¾¿ç¼–ç¨‹æ–¹å¼åˆ›å»º  bean  å®ä¾‹         |\r\n| FactoryMethod æ–¹å¼  åˆ›å»º bean  å®ä¾‹  | â‘  åˆ†æˆé™æ€å·¥å‚ä¸å®ä¾‹å·¥å‚ï¼›â‘¡ å·¥å‚æ–¹æ³•è‹¥æœ‰å‚æ•°ï¼Œéœ€è¦å¯¹å·¥å‚æ–¹æ³•å‚æ•°è¿›è¡Œè§£æï¼Œåˆ©ç”¨  resolveDependencyï¼›â‘¢ å¦‚æœæœ‰å¤šä¸ªå·¥å‚æ–¹æ³•å€™é€‰è€…ï¼Œè¿˜è¦è¿›ä¸€æ­¥æŒ‰æƒé‡ç­›é€‰ |\r\n| AutowiredAnnotationBeanPostProcessor | â‘  ä¼˜å…ˆé€‰æ‹©å¸¦  @Autowired  æ³¨è§£çš„æ„é€ ï¼›â‘¡ è‹¥æœ‰å”¯ä¸€çš„å¸¦å‚æ„é€ ï¼Œä¹Ÿä¼šå…¥é€‰ |\r\n| mbd.getPreferredConstructors         | é€‰æ‹©æ‰€æœ‰å…¬å…±æ„é€ ï¼Œè¿™äº›æ„é€ ä¹‹é—´æŒ‰æƒé‡ç­›é€‰                     |\r\n| é‡‡ç”¨é»˜è®¤æ„é€                          | å¦‚æœä¸Šé¢çš„åå¤„ç†å™¨å’Œ BeanDefinition éƒ½æ²¡æ‰¾åˆ°æ„é€ ï¼Œé‡‡ç”¨é»˜è®¤æ„é€ ï¼Œå³ä½¿æ˜¯ç§æœ‰çš„ ( ç§æœ‰æ„é€ æ–¹æ³•ä¹Ÿä¼šç”¨ç§æœ‰çš„æ„é€ åˆ›å»º Bean çš„å®ä¾‹ï¼Œä½¿ç”¨æš´åŠ›åå°„å¹¶é€šè¿‡ç§æœ‰æ„é€ æ–¹æ³•è¿›è¡Œæ–¹æ³•è°ƒç”¨ ) |\r\n\r\n- **åˆ›å»º bean å®ä¾‹ä¹‹å‰**ï¼Œæœ‰è‡ªå®šä¹‰ TargetSource çš„æƒ…å†µ\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#\r\n@Nullable\r\nprotected Object resolveBeforeInstantiation(String beanName, RootBeanDefinition mbd) {\r\n   \t...\r\n \tbean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName);\r\n\t...\r\n\tbean = applyBeanPostProcessorsAfterInitialization(bean, beanName);\r\n\t...\r\n}\r\n\r\n@Nullable\r\nprotected Object applyBeanPostProcessorsBeforeInstantiation(Class<?> beanClass, String beanName) {\r\n   ...\r\n         Object result = ibp.postProcessBeforeInstantiation(beanClass, beanName);\r\n   ...\r\n}\r\n\r\n@Override\r\npublic Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName)\r\n\tthrows BeansException {\r\n \t...\r\n\tObject current = processor.postProcessAfterInitialization(result, beanName);\r\n\t...\r\n}\r\n```\r\n\r\n```java\r\n\t//org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator\r\n\t//åˆ›å»º bean å®ä¾‹ä¹‹å‰\r\n\t@Override\r\n    public Object postProcessBeforeInstantiation(Class<?> beanClass, String beanName) {\r\n       Object cacheKey = getCacheKey(beanClass, beanName);\r\n\r\n       if (!StringUtils.hasLength(beanName) || !this.targetSourcedBeans.contains(beanName)) {\r\n          if (this.advisedBeans.containsKey(cacheKey)) {\r\n             return null;\r\n          }\r\n          if (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) {\r\n             this.advisedBeans.put(cacheKey, Boolean.FALSE);\r\n             return null;\r\n          }\r\n       }\r\n\r\n       // Create proxy here if we have a custom TargetSource.\r\n       // Suppresses unnecessary default instantiation of the target bean:\r\n       // The TargetSource will handle target instances in a custom fashion.\r\n       TargetSource targetSource = getCustomTargetSource(beanClass, beanName);\r\n       if (targetSource != null) {\r\n          if (StringUtils.hasLength(beanName)) {\r\n             this.targetSourcedBeans.add(beanName);\r\n          }\r\n          Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource);\r\n          Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource);\r\n          this.proxyTypes.put(cacheKey, proxy.getClass());\r\n          return proxy;\r\n       }\r\n\r\n       return null;\r\n    }\r\n\t//bean åˆå§‹åŒ–å®Œæˆä¹‹å\r\n\t@Override\r\n\tpublic Object postProcessAfterInitialization(@Nullable Object bean, String beanName) {\r\n\t\tif (bean != null) {\r\n\t\t\tObject cacheKey = getCacheKey(bean.getClass(), beanName);\r\n\t\t\tif (this.earlyProxyReferences.remove(cacheKey) != bean) {\r\n\t\t\t\treturn wrapIfNecessary(bean, beanName, cacheKey);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn bean;\r\n\t}\r\n```\r\n\r\n- é»˜è®¤æƒ…å†µ\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean\r\nprotected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)\r\n\t\t\tthrows BeanCreationException {\r\n\r\n\t\t// Instantiate the bean.\r\n\t\tBeanWrapper instanceWrapper = null;\r\n\t\tif (mbd.isSingleton()) {\r\n\t\t\tinstanceWrapper = this.factoryBeanInstanceCache.remove(beanName);\r\n\t\t}\r\n\t\tif (instanceWrapper == null) {\r\n\t\t\tinstanceWrapper = createBeanInstance(beanName, mbd, args);\r\n\t\t}\r\n\t\tfinal Object bean = instanceWrapper.getWrappedInstance();\r\n\t\tClass<?> beanType = instanceWrapper.getWrappedClass();\r\n\t\tif (beanType != NullBean.class) {\r\n\t\t\tmbd.resolvedTargetType = beanType;\r\n\t\t}\r\n    ...\r\n}\r\n```\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBeanInstance\r\nprotected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) {\r\n   ...\r\n\r\n   Supplier<?> instanceSupplier = mbd.getInstanceSupplier();\r\n   if (instanceSupplier != null) {\r\n      return obtainFromSupplier(instanceSupplier, beanName);\r\n   }\r\n\r\n   if (mbd.getFactoryMethodName() != null) {\r\n      return instantiateUsingFactoryMethod(beanName, mbd, args);\r\n   }\r\n\r\n   // Shortcut when re-creating the same bean...\r\n   boolean resolved = false;\r\n   boolean autowireNecessary = false;\r\n   if (args == null) {\r\n      synchronized (mbd.constructorArgumentLock) {\r\n         if (mbd.resolvedConstructorOrFactoryMethod != null) {\r\n            resolved = true;\r\n            autowireNecessary = mbd.constructorArgumentsResolved;\r\n         }\r\n      }\r\n   }\r\n   if (resolved) {\r\n      if (autowireNecessary) {\r\n         return autowireConstructor(beanName, mbd, null, null);\r\n      }\r\n      else {\r\n         return instantiateBean(beanName, mbd);\r\n      }\r\n   }\r\n\r\n   // Candidate constructors for autowiring?\r\n   Constructor<?>[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);\r\n   if (ctors != null || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||\r\n         mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) {\r\n      return autowireConstructor(beanName, mbd, ctors, args);\r\n   }\r\n\r\n   // Preferred constructors for default construction?\r\n   ctors = mbd.getPreferredConstructors();\r\n   if (ctors != null) {\r\n      return autowireConstructor(beanName, mbd, ctors, null);\r\n   }\r\n\r\n   // No special handling: simply use no-arg constructor.\r\n   return instantiateBean(beanName, mbd);\r\n}\r\n```\r\n\r\n\r\n\r\n------\r\n\r\n#### **5.2 åˆ›å»º bean - ä¾èµ–æ³¨å…¥**\r\n\r\n![image-20230422013843155](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422013843155.png)\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean\r\n{\r\n        ...\r\n        // Allow post-processors to modify the merged bean definition.\r\n\t\tsynchronized (mbd.postProcessingLock) {\r\n\t\t\tif (!mbd.postProcessed) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tapplyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);\r\n\t\t\t\t}\r\n\t\t\t\tcatch (Throwable ex) {\r\n\t\t\t\t\tthrow new BeanCreationException(mbd.getResourceDescription(), beanName,\r\n\t\t\t\t\t\t\t\"Post-processing of merged bean definition failed\", ex);\r\n\t\t\t\t}\r\n\t\t\t\tmbd.postProcessed = true;\r\n\t\t\t}\r\n\t\t}\r\n    \t// Eagerly cache singletons to be able to resolve circular references\r\n\t\t// even when triggered by lifecycle interfaces like BeanFactoryAware.\r\n\t\tboolean earlySingletonExposure = (mbd.isSingleton() && this.allowCircularReferences &&\r\n\t\t\t\tisSingletonCurrentlyInCreation(beanName));\r\n\t\tif (earlySingletonExposure) {\r\n\t\t\tif (logger.isTraceEnabled()) {\r\n\t\t\t\tlogger.trace(\"Eagerly caching bean '\" + beanName +\r\n\t\t\t\t\t\t\"' to allow for resolving potential circular references\");\r\n\t\t\t}\r\n             //æ·»åŠ å•ä¾‹å·¥å‚\r\n\t\t\taddSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));\r\n\t\t}\r\n    \t...\r\n        \tpopulateBean(beanName, mbd, instanceWrapper);\r\n \t...\r\n}\r\n```\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#applyMergedBeanDefinitionPostProcessors\r\nprotected void applyMergedBeanDefinitionPostProcessors(RootBeanDefinition mbd, Class<?> beanType, String beanName) {\r\n   for (BeanPostProcessor bp : getBeanPostProcessors()) {\r\n      if (bp instanceof MergedBeanDefinitionPostProcessor) {\r\n         MergedBeanDefinitionPostProcessor bdp = (MergedBeanDefinitionPostProcessor) bp;\r\n         bdp.postProcessMergedBeanDefinition(mbd, beanType, beanName);\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n- AutowiredAnnotationBeanPostProcessor\r\n\r\n```java\r\n//org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor#postProcessMergedBeanDefinition\r\n@Override\r\npublic void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class<?> beanType, String beanName) {\r\n   InjectionMetadata metadata = findAutowiringMetadata(beanName, beanType, null);\r\n   metadata.checkConfigMembers(beanDefinition);\r\n}\r\n```\r\n\r\n- CommonAnnotationBeanPostProcessor\r\n\r\n```java\r\n//org.springframework.context.annotation.CommonAnnotationBeanPostProcessor#postProcessMergedBeanDefinition\r\n@Override\r\npublic void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class<?> beanType, String beanName) {\r\n   super.postProcessMergedBeanDefinition(beanDefinition, beanType, beanName);\r\n   InjectionMetadata metadata = findResourceMetadata(beanName, beanType, null);\r\n   metadata.checkConfigMembers(beanDefinition);\r\n}\r\n```\r\n\r\n- `AUTOWIRE_BY_NAME;AUTOWIRE_BY_TYPE;resolveDependency;applyPropertyValues`\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#populateBean\r\nprotected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) {\r\n   ...\r\n\r\n   PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null);\r\n\r\n   int resolvedAutowireMode = mbd.getResolvedAutowireMode();\r\n   if (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) {\r\n      ...\r\n   }\r\n\r\n   ...\r\n   if (needsDepCheck) {\r\n      if (filteredPds == null) {\r\n         filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);\r\n      }\r\n      checkDependencies(beanName, mbd, filteredPds, pvs);\r\n   }\r\n\r\n   if (pvs != null) {\r\n      applyPropertyValues(beanName, mbd, bw, pvs);\r\n   }\r\n}\r\n```\r\n\r\n| **è¦ç‚¹**                             | **æ€»ç»“**                                                     |\r\n| ------------------------------------ | ------------------------------------------------------------ |\r\n| AutowiredAnnotationBeanPostProcessor | è¯†åˆ«   @Autowired  åŠ @Value  æ ‡æ³¨çš„æˆå‘˜ï¼Œå°è£…ä¸º  InjectionMetadata è¿›è¡Œä¾èµ–æ³¨å…¥ |\r\n| CommonAnnotationBeanPostProcessor    | è¯†åˆ«   @Resource  æ ‡æ³¨çš„æˆå‘˜ï¼Œå°è£…ä¸º  InjectionMetadata è¿›è¡Œä¾èµ–æ³¨å…¥ |\r\n| resolveDependency                    | ç”¨æ¥æŸ¥æ‰¾è¦è£…é…çš„å€¼ï¼Œå¯ä»¥è¯†åˆ«ï¼šâ‘  Optionalï¼›â‘¡ ObjectFactory åŠ ObjectProviderï¼›â‘¢ @Lazy  æ³¨è§£ï¼›â‘£ @Value  æ³¨è§£ï¼ˆ`${}`, `#{}`, ç±»å‹è½¬æ¢ï¼‰ï¼›â‘¤ é›†åˆç±»å‹ï¼ˆCollectionï¼ŒMapï¼Œæ•°ç»„ç­‰ï¼‰ï¼›â‘¥ æ³›å‹å’Œ  @Qualifierï¼ˆç”¨æ¥åŒºåˆ†ç±»å‹æ­§ä¹‰ï¼‰ï¼›â‘¦ primary  åŠåå­—åŒ¹é…ï¼ˆç”¨æ¥åŒºåˆ†ç±»å‹æ­§ä¹‰ï¼‰ |\r\n| AUTOWIRE_BY_NAME                     | æ ¹æ®æˆå‘˜åå­—æ‰¾ bean å¯¹è±¡ï¼Œä¿®æ”¹ mbd çš„ propertyValuesï¼Œä¸ä¼šè€ƒè™‘ç®€å•ç±»å‹çš„æˆå‘˜ |\r\n| AUTOWIRE_BY_TYPE                     | æ ¹æ®æˆå‘˜ç±»å‹æ‰§è¡Œ resolveDependency æ‰¾åˆ°ä¾èµ–æ³¨å…¥çš„å€¼ï¼Œä¿®æ”¹  mbd çš„ propertyValues |\r\n| applyPropertyValues                  | æ ¹æ® mbd çš„ propertyValues è¿›è¡Œä¾èµ–æ³¨å…¥ï¼ˆå³xmlä¸­ `<property name ref|value/>`ï¼‰ |\r\n\r\n- ç›¸åŒæˆå‘˜ä¾èµ–æ³¨å…¥ä¼˜å…ˆçº§ï¼šç²¾å‡†åŒ¹é…>æŒ‰ç±»å‹/åå­—åŒ¹é…>æ³¨è§£æ–¹å¼åŒ¹é…\r\n\r\n![image-20230422014541831](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422014541831.png)\r\n\r\n> Beançš„å®ä¾‹å¯¹è±¡åˆšåˆšåˆ›å»ºæ—¶é‡Œé¢æ˜¯ç©ºç©ºå¦‚ä¹Ÿçš„ï¼Œéœ€è¦ä¸æ–­è¡¥å……å’Œå®Œå–„å®ƒï¼Œæ¥ä¸‹æ¥å°±å¯¹å½“å‰è¿™ä¸ªBeançš„å®ä¾‹è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œå³å»ºç«‹å½“å‰è¿™ä¸ªBeançš„å®ä¾‹è·Ÿå®¹å™¨ä¸­å…¶ä»–Beanä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¯ä»¥é€šè¿‡æ³¨è§£åŒ¹é…å’Œæ ¹æ®ç±»å‹ä»¥åŠåå­—åŒ¹é…\r\n>\r\n> - åœ¨ä¾èµ–æ³¨å…¥é˜¶æ®µï¼Œæœ‰ä¸ªæ¡ä»¶æ˜¯äº§ç”Ÿå¾ªç¯ä¾èµ–ï¼Œäº§ç”Ÿå¾ªç¯ä¾èµ–ä»¥åï¼Œå®ƒä¼šåœ¨å•ä¾‹å·¥å‚æ± ä¸­é€šè¿‡ä¸€ä¸ªå·¥å‚å¯¹è±¡æ¥é—´æ¥çš„è°ƒç”¨åˆ°æˆ‘ä»¬çš„è‡ªåŠ¨ä»£ç†åå¤„ç†å™¨ç±»æ¥åˆ›å»ºä»£ç†\r\n>\r\n> ```java\r\n> //org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#getEarlyBeanReference\r\n>       ...\r\n>          exposedObject = bp.getEarlyBeanReference(exposedObject, beanName);\r\n>       ...\r\n> //org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#getEarlyBeanReference         \r\n> \t@Override\r\n> \tpublic Object getEarlyBeanReference(Object bean, String beanName) {\r\n> \t\tObject cacheKey = getCacheKey(bean.getClass(), beanName);\r\n> \t\tthis.earlyProxyReferences.put(cacheKey, bean);\r\n>          //åˆ›å»ºä»£ç†æ–¹æ³•\r\n> \t\treturn wrapIfNecessary(bean, beanName, cacheKey);\r\n> \t}\r\n> ```\r\n\r\n\r\n\r\n------\r\n\r\n#### **5.3 åˆ›å»º bean - åˆå§‹åŒ–**\r\n\r\n![image-20230422014943738](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422014943738.png)\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean\r\n{    \r\n    ...\r\n    // Initialize the bean instance.\r\n    Object exposedObject = bean;\r\n    ...\r\n       exposedObject = initializeBean(beanName, exposedObject, mbd);\r\n    ...\r\n\r\n}\t\r\n```\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean\r\nprotected Object initializeBean(final String beanName, final Object bean, @Nullable RootBeanDefinition mbd) {\r\n   if (System.getSecurityManager() != null) {\r\n      AccessController.doPrivileged((PrivilegedAction<Object>) () -> {\r\n         invokeAwareMethods(beanName, bean);\r\n         return null;\r\n      }, getAccessControlContext());\r\n   }\r\n   else {\r\n      invokeAwareMethods(beanName, bean);\r\n   }\r\n\r\n   Object wrappedBean = bean;\r\n   if (mbd == null || !mbd.isSynthetic()) {\r\n      wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);\r\n   }\r\n\r\n   ...\r\n      invokeInitMethods(beanName, wrappedBean, mbd);\r\n   ...\r\n   if (mbd == null || !mbd.isSynthetic()) {\r\n      //æœ‰è‡ªå®šä¹‰ TargetSource çš„æƒ…å†µç”± AnnotationAwareAspectJAutoProxyCreator åˆ›å»ºä»£ç†è¿”å›\r\n      wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);\r\n   }\r\n\r\n   return wrappedBean;\r\n}\r\n```\r\n\r\n| **è¦ç‚¹**              | **æ€»ç»“**                                                     |\r\n| --------------------- | ------------------------------------------------------------ |\r\n| å†…ç½® Aware æ¥å£çš„è£…é… | åŒ…æ‹¬ BeanNameAwareï¼ŒBeanFactoryAware ç­‰                      |\r\n| æ‰©å±• Aware æ¥å£çš„è£…é… | ç”± ApplicationContextAwareProcessor è§£æï¼Œæ‰§è¡Œæ—¶æœºåœ¨  postProcessBeforeInitialization |\r\n| @PostConstruct        | ç”± CommonAnnotationBeanPostProcessor è§£æï¼Œæ‰§è¡Œæ—¶æœºåœ¨  postProcessBeforeInitialization |\r\n| InitializingBean      | é€šè¿‡æ¥å£å›è°ƒæ‰§è¡Œåˆå§‹åŒ–                                       |\r\n| initMethod            | æ ¹æ® BeanDefinition å¾—åˆ°çš„åˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œåˆå§‹åŒ–ï¼Œå³ `<bean init-method>` æˆ– @Bean(initMethod) |\r\n| åˆ›å»º aop ä»£ç†         | ç”± AnnotationAwareAspectJAutoProxyCreator åˆ›å»ºï¼Œæ‰§è¡Œæ—¶æœºåœ¨  postProcessAfterInitialization |\r\n\r\n- åˆå§‹åŒ–é¡ºåºï¼š\r\n  - 1.æ‰§è¡ŒBeanFactoryAwareæ¥å£çš„å®šä¹‰çš„åˆå§‹åŒ–æ–¹æ³•setBeanFactory\r\n  - 2.æ‰§è¡Œæ ‡æ³¨@PostConstructçš„æ–¹æ³•init\r\n  - 3.æ‰§è¡ŒInitializingBeanæ¥å£çš„é‡å†™æ–¹æ³•åˆå§‹åŒ–afterPorpertiesSet\r\n  - 4.æ‰§è¡Œç”¨BeanDefinitionæŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•\r\n\r\n![image-20230422015021268](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422015021268.png)\r\n\r\n> åˆå§‹åŒ–é˜¶æ®µï¼šå¤„ç†ä¸€äº›Awareæ¥å£ã€è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ã€åˆ›å»ºaopä»£ç†(å¦‚æœä½ çš„Beanè·Ÿåˆ‡é¢è¡¨è¾¾å¼åŒ¹é…ä¸Šï¼Œå°±å¸®ä½ åˆ›å»ºä»£ç†)ï¼Œåœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œç”±Springçš„BeanFactoryå®¹å™¨æ¥å›è°ƒAwareæ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¦‚ä½ å®ç°äº†BeanFactoryAwareæ¥å£ï¼Œå°±ä¼šç›¸åº”åœ°æŠŠBeanFactoryå¯¹è±¡é€šè¿‡å›è°ƒæ­¤æ¥å£çš„æ–¹æ³•ç»™ä½ ä¼ é€’è¿›æ¥\r\n> åˆå§‹åŒ–æ–¹æ³•ï¼š@PostConstructæ˜¯é€šè¿‡ä¸€ä¸ªBeançš„åå¤„ç†å™¨æ¥è¿›è¡Œè°ƒç”¨çš„\r\n\r\n\r\n\r\n------\r\n\r\n#### **5.4 åˆ›å»º bean - æ³¨å†Œå¯é”€æ¯ bean**\r\n\r\n![image-20230422015302186](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422015302186.png)\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean\r\n...\r\n// Register bean as disposable.\r\ntry {\r\n   registerDisposableBeanIfNecessary(beanName, bean, mbd);\r\n}\r\ncatch (BeanDefinitionValidationException ex) {\r\n   throw new BeanCreationException(\r\n         mbd.getResourceDescription(), beanName, \"Invalid destruction signature\", ex);\r\n}\r\n...\r\n```\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractBeanFactory#registerDisposableBeanIfNecessary\r\nprotected void registerDisposableBeanIfNecessary(String beanName, Object bean, RootBeanDefinition mbd) {\r\n   AccessControlContext acc = (System.getSecurityManager() != null ? getAccessControlContext() : null);\r\n   if (!mbd.isPrototype() && requiresDestruction(bean, mbd)) {\r\n      if (mbd.isSingleton()) {\r\n         // Register a DisposableBean implementation that performs all destruction\r\n         // work for the given bean: DestructionAwareBeanPostProcessors,\r\n         // DisposableBean interface, custom destroy method.\r\n         registerDisposableBean(beanName,\r\n               new DisposableBeanAdapter(bean, beanName, mbd, getBeanPostProcessors(), acc));\r\n      }\r\n      else {\r\n         // A bean with a custom scope...\r\n         Scope scope = this.scopes.get(mbd.getScope());\r\n         if (scope == null) {\r\n            throw new IllegalStateException(\"No Scope registered for scope name '\" + mbd.getScope() + \"'\");\r\n         }\r\n         scope.registerDestructionCallback(beanName,\r\n               new DisposableBeanAdapter(bean, beanName, mbd, getBeanPostProcessors(), acc));\r\n      }\r\n   }\r\n}\r\n```\r\n\r\nåœ¨è¿™ä¸€æ­¥åˆ¤æ–­å¹¶ç™»è®°å¯é”€æ¯ bean\r\n\r\n* åˆ¤æ–­ä¾æ®\r\n  * å¦‚æœå®ç°äº† DisposableBean æˆ– AutoCloseable æ¥å£ï¼Œåˆ™ä¸ºå¯é”€æ¯ bean\r\n  * å¦‚æœè‡ªå®šä¹‰äº† destroyMethodï¼Œåˆ™ä¸ºå¯é”€æ¯ bean\r\n  * å¦‚æœé‡‡ç”¨ @Bean æ²¡æœ‰æŒ‡å®š destroyMethodï¼Œåˆ™é‡‡ç”¨è‡ªåŠ¨æ¨æ–­æ–¹å¼è·å–é”€æ¯æ–¹æ³•åï¼ˆcloseï¼Œshutdownï¼‰\r\n  * å¦‚æœæœ‰ @PreDestroy æ ‡æ³¨çš„æ–¹æ³•\r\n* å­˜å‚¨ä½ç½®\r\n  * singleton scope çš„å¯é”€æ¯ bean ä¼šå­˜å‚¨äº beanFactory çš„æˆå‘˜å½“ä¸­\r\n  * è‡ªå®šä¹‰ scope çš„å¯é”€æ¯ bean ä¼šå­˜å‚¨äºå¯¹åº”çš„åŸŸå¯¹è±¡å½“ä¸­\r\n  * prototype scope ä¸ä¼šå­˜å‚¨ï¼Œéœ€è¦è‡ªå·±æ‰¾åˆ°æ­¤å¯¹è±¡é”€æ¯\r\n* å­˜å‚¨æ—¶éƒ½ä¼šå°è£…ä¸º DisposableBeanAdapter ç±»å‹å¯¹é”€æ¯æ–¹æ³•çš„è°ƒç”¨è¿›è¡Œé€‚é…\r\n\r\n\r\n\r\n------\r\n\r\n### **6. ç±»å‹è½¬æ¢å¤„ç†**\r\n\r\n* å¦‚æœ getBean çš„ requiredType å‚æ•°ä¸å®é™…å¾—åˆ°çš„å¯¹è±¡ç±»å‹ä¸åŒï¼Œä¼šå°è¯•è¿›è¡Œç±»å‹è½¬æ¢\r\n* è¿™æ—¶Beanå·²ç»è¢«åˆ›å»ºå¹¶ä½œä¸ºç»“æœè¿”å›\r\n\r\n![image-20230422015511898](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422015511898.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **7. é”€æ¯ bean**\r\n\r\n* é”€æ¯æ—¶æœº\r\n  * singleton bean çš„é”€æ¯åœ¨ ApplicationContext.close æ—¶ï¼Œæ­¤æ—¶ä¼šæ‰¾åˆ°æ‰€æœ‰ DisposableBean çš„åå­—ï¼Œé€ä¸€é”€æ¯\r\n  * è‡ªå®šä¹‰ scope bean çš„é”€æ¯åœ¨ä½œç”¨åŸŸå¯¹è±¡ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼ˆè¿™ç±»Beançš„é”€æ¯æ—¶æœºåœ¨requeståŸŸç”Ÿå‘½å‘¨æœŸç»“æŸçš„æ—¶å€™ï¼Œåœ¨å®ƒç»“æŸä¹‹å‰è°ƒç”¨request scope beançš„ä¸€ä¸ªé”€æ¯ï¼‰\r\n  * prototype bean çš„é”€æ¯å¯ä»¥é€šè¿‡è‡ªå·±æ‰‹åŠ¨è°ƒç”¨ AutowireCapableBeanFactory.destroyBean æ–¹æ³•æ‰§è¡Œé”€æ¯\r\n* åŒä¸€ bean ä¸­ä¸åŒå½¢å¼é”€æ¯æ–¹æ³•çš„è°ƒç”¨æ¬¡åº\r\n  * ä¼˜å…ˆåå¤„ç†å™¨é”€æ¯ï¼Œå³ @PreDestroy\r\n  * å…¶æ¬¡ DisposableBean æ¥å£é”€æ¯\r\n  * æœ€å destroyMethod é”€æ¯ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰åç§°ï¼Œæ¨æ–­åç§°ï¼ŒAutoCloseable æ¥å£ å¤šé€‰ä¸€ï¼‰\r\n\r\n\r\n\r\n------\r\n\r\n### **æ€»ç»“**\r\n\r\n![image-20230422015825420](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422015825420.png)\r\n\r\n\r\n\r\n------\r\n\r\n## 3. Spring bean å¾ªç¯ä¾èµ–\r\n\r\n### è¡¥å……ï¼šåˆ›å»ºä»£ç†\r\n\r\n**è¦ç‚¹**\r\n\r\n- è¦å®Œå…¨ç†è§£å¾ªç¯ä¾èµ–ï¼Œéœ€è¦ç†è§£ä»£ç†å¯¹è±¡çš„åˆ›å»ºæ—¶æœº\r\n- æŒæ¡ ProxyFactory åˆ›å»ºä»£ç†çš„è¿‡ç¨‹ï¼Œç†è§£ Advisorï¼ŒAdviceï¼ŒPointcut ä¸ Aspect\r\n- æŒæ¡ AnnotationAwareAspectJAutoProxyCreator ç­›é€‰ Advisor åˆæ ¼è€…ï¼Œåˆ›å»ºä»£ç†çš„è¿‡ç¨‹\r\n  - bean çš„åå¤„ç†å™¨ï¼Œä½œç”¨æ˜¯ä¸ºæˆ‘ä»¬å®¹å™¨ä¸­çš„ beanï¼Œé‚£äº›ç›®æ ‡ bean éœ€ä¸éœ€è¦ä¸ºä¹‹åˆ›å»ºä»£ç†ï¼Œå®ƒå†…éƒ¨ä¹Ÿä¼šé—´æ¥è°ƒç”¨ ProxyFactory æ¥åˆ›å»ºä»£ç†\r\n\r\n**ä»£ç†å·¥å‚**\r\n\r\n- åªåŠ äº†é€šçŸ¥ï¼ˆç¯ç»•é€šçŸ¥ï¼‰æ¥è¿›è¡ŒåŠŸèƒ½å¢å¼º\r\n\r\n![image-20230423122730735](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423122730735.png)\r\n\r\n![image-20231202153033525](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231202153033525.png)\r\n\r\n- åŠ å…¥åˆ‡ç‚¹ï¼Œè§‚å¯ŸCGLIBåŠ¨æ€ä»£ç†å’ŒJDKåŠ¨æ€ä»£ç†çš„åŒºåˆ«\r\n\r\n![image-20230423123833981](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423123833981.png)\r\n\r\n> **è¯´è¯´ JDK åŠ¨æ€ä»£ç†å’Œ CGLIB ä»£ç† ï¼Ÿ**\r\n>\r\n> Spring çš„ AOP æ˜¯é€šè¿‡[åŠ¨æ€ä»£ç†open in new window](https://mp.weixin.qq.com/s/aZtfwik0weJN5JzYc-JxYg)æ¥å®ç°çš„ï¼ŒåŠ¨æ€ä»£ç†ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ JDK åŠ¨æ€ä»£ç†å’Œ Cglib åŠ¨æ€ä»£ç†ï¼Œè¿™ä¸¤ç§åŠ¨æ€ä»£ç†çš„ä½¿ç”¨å’ŒåŸç†æœ‰äº›ä¸åŒã€‚\r\n>\r\n> **JDK åŠ¨æ€ä»£ç†**\r\n>\r\n> 1. **Interface**ï¼šå¯¹äº JDK åŠ¨æ€ä»£ç†ï¼Œç›®æ ‡ç±»éœ€è¦å®ç°ä¸€ä¸ª Interfaceã€‚\r\n> 2. **InvocationHandler**ï¼šInvocationHandler æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥é€šè¿‡å®ç°è¿™ä¸ªæ¥å£ï¼Œå®šä¹‰æ¨ªåˆ‡é€»è¾‘ï¼Œå†é€šè¿‡åå°„æœºåˆ¶ï¼ˆinvokeï¼‰è°ƒç”¨ç›®æ ‡ç±»çš„ä»£ç ï¼Œåœ¨æ­¤è¿‡ç¨‹ï¼Œå¯èƒ½åŒ…è£…é€»è¾‘ï¼Œå¯¹ç›®æ ‡æ–¹æ³•è¿›è¡Œå‰ç½®åç½®å¤„ç†ã€‚\r\n> 3. **Proxy**ï¼šProxy åˆ©ç”¨ InvocationHandler åŠ¨æ€åˆ›å»ºä¸€ä¸ªç¬¦åˆç›®æ ‡ç±»å®ç°çš„æ¥å£çš„å®ä¾‹ï¼Œç”Ÿæˆç›®æ ‡ç±»çš„ä»£ç†å¯¹è±¡ã€‚\r\n>\r\n> **CgLib åŠ¨æ€ä»£ç†**\r\n>\r\n> 1. ä½¿ç”¨ JDK åˆ›å»ºä»£ç†æœ‰ä¸€å¤§é™åˆ¶ï¼Œå®ƒåªèƒ½ä¸ºæ¥å£åˆ›å»ºä»£ç†å®ä¾‹ï¼Œè€Œ CgLib åŠ¨æ€ä»£ç†å°±æ²¡æœ‰è¿™ä¸ªé™åˆ¶ã€‚\r\n> 2. CgLib åŠ¨æ€ä»£ç†æ˜¯ä½¿ç”¨å­—èŠ‚ç å¤„ç†æ¡†æ¶ **ASM**ï¼Œå…¶åŸç†æ˜¯é€šè¿‡å­—èŠ‚ç æŠ€æœ¯ä¸ºä¸€ä¸ªç±»åˆ›å»ºå­ç±»ï¼Œå¹¶åœ¨å­ç±»ä¸­é‡‡ç”¨æ–¹æ³•æ‹¦æˆªçš„æŠ€æœ¯æ‹¦æˆªæ‰€æœ‰çˆ¶ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œé¡ºåŠ¿ç»‡å…¥æ¨ªåˆ‡é€»è¾‘ã€‚\r\n> 3. **CgLib** åˆ›å»ºçš„åŠ¨æ€ä»£ç†å¯¹è±¡æ€§èƒ½æ¯” JDK åˆ›å»ºçš„åŠ¨æ€ä»£ç†å¯¹è±¡çš„æ€§èƒ½é«˜ä¸å°‘ï¼Œä½†æ˜¯ CGLib åœ¨åˆ›å»ºä»£ç†å¯¹è±¡æ—¶æ‰€èŠ±è´¹çš„æ—¶é—´å´æ¯” JDK å¤šå¾—å¤šï¼Œæ‰€ä»¥å¯¹äºå•ä¾‹çš„å¯¹è±¡ï¼Œå› ä¸ºæ— éœ€é¢‘ç¹åˆ›å»ºå¯¹è±¡ï¼Œç”¨ CGLib åˆé€‚ï¼Œåä¹‹ï¼Œä½¿ç”¨ JDK æ–¹å¼è¦æ›´ä¸ºåˆé€‚ä¸€äº›ã€‚åŒæ—¶ï¼Œç”±äº CGLib æ˜¯é‡‡ç”¨åŠ¨æ€åˆ›å»ºå­ç±»çš„æ–¹æ³•ï¼Œå¯¹äº final æ–¹æ³•ï¼Œæ— æ³•è¿›è¡Œä»£ç†ã€‚\r\n>\r\n> æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå¸¸è§çš„å°åœºæ™¯ï¼Œå®¢æœä¸­è½¬ï¼Œè§£å†³ç”¨æˆ·é—®é¢˜ï¼š\r\n>\r\n> ![ç”¨æˆ·å‘å®¢æœæé—®é¢˜](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/spring-c5c4b247-62dd-43a2-a043-da51c58f77c8.png)\r\n>\r\n> **JDK åŠ¨æ€ä»£ç†å®ç°ï¼š**\r\n>\r\n> ![JDKåŠ¨æ€ä»£ç†ç±»å›¾](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/spring-65b14a3f-2653-463e-af77-a8875d3d635c.png)\r\n>\r\n> - æ¥å£\r\n>\r\n>   \r\n>\r\n>   ```java\r\n>   public interface ISolver {\r\n>       void solve();\r\n>   }\r\n>   ```\r\n>\r\n> - ç›®æ ‡ç±»:éœ€è¦å®ç°å¯¹åº”æ¥å£\r\n>\r\n>   \r\n>\r\n>   ```java\r\n>   public class Solver implements ISolver {\r\n>       @Override\r\n>       public void solve() {\r\n>           System.out.println(\"ç–¯ç‹‚æ‰å¤´å‘è§£å†³é—®é¢˜â€¦â€¦\");\r\n>       }\r\n>   }\r\n>   ```\r\n>\r\n> - æ€ä»£ç†å·¥å‚:ProxyFactoryï¼Œç›´æ¥ç”¨åå°„æ–¹å¼ç”Ÿæˆä¸€ä¸ªç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œç”¨äº†ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»æ–¹å¼é‡å†™ InvocationHandler æ–¹æ³•ï¼Œå®ç°æ¥å£é‡å†™ä¹Ÿå·®ä¸å¤š\r\n>\r\n>   \r\n>\r\n>   ```java\r\n>   public class ProxyFactory {\r\n>   \r\n>       // ç»´æŠ¤ä¸€ä¸ªç›®æ ‡å¯¹è±¡\r\n>       private Object target;\r\n>   \r\n>       public ProxyFactory(Object target) {\r\n>           this.target = target;\r\n>       }\r\n>   \r\n>       // ä¸ºç›®æ ‡å¯¹è±¡ç”Ÿæˆä»£ç†å¯¹è±¡\r\n>       public Object getProxyInstance() {\r\n>           return Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(),\r\n>                   new InvocationHandler() {\r\n>                       @Override\r\n>                       public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\r\n>                           System.out.println(\"è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°æ‚¨ï¼Ÿ\");\r\n>   \r\n>                           // è°ƒç”¨ç›®æ ‡å¯¹è±¡æ–¹æ³•\r\n>                           Object returnValue = method.invoke(target, args);\r\n>   \r\n>                           System.out.println(\"é—®é¢˜å·²ç»è§£å†³å•¦ï¼\");\r\n>                           return null;\r\n>                       }\r\n>                   });\r\n>       }\r\n>   }\r\n>   ```\r\n>\r\n> - å®¢æˆ·ç«¯ï¼šClientï¼Œç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡å®ä¾‹ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ç›®æ ‡å¯¹è±¡æ–¹æ³•\r\n>\r\n>   \r\n>\r\n>   ```java\r\n>   public class Client {\r\n>       public static void main(String[] args) {\r\n>           //ç›®æ ‡å¯¹è±¡:ç¨‹åºå‘˜\r\n>           ISolver developer = new Solver();\r\n>           //ä»£ç†ï¼šå®¢æœå°å§å§\r\n>           ISolver csProxy = (ISolver) new ProxyFactory(developer).getProxyInstance();\r\n>           //ç›®æ ‡æ–¹æ³•ï¼šè§£å†³é—®é¢˜\r\n>           csProxy.solve();\r\n>       }\r\n>   }\r\n>   ```\r\n>\r\n> **Cglib åŠ¨æ€ä»£ç†å®ç°ï¼š**\r\n>\r\n> ![CglibåŠ¨æ€ä»£ç†ç±»å›¾](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/spring-74da87af-20d1-4a5b-a212-3837a15f0bab.png)\r\n>\r\n> - ç›®æ ‡ç±»ï¼šSolverï¼Œè¿™é‡Œç›®æ ‡ç±»ä¸ç”¨å†å®ç°æ¥å£ã€‚\r\n>\r\n>   \r\n>\r\n>   ```java\r\n>   public class Solver {\r\n>   \r\n>       public void solve() {\r\n>           System.out.println(\"ç–¯ç‹‚æ‰å¤´å‘è§£å†³é—®é¢˜â€¦â€¦\");\r\n>       }\r\n>   }\r\n>   ```\r\n>\r\n> - åŠ¨æ€ä»£ç†å·¥å‚ï¼š\r\n>\r\n>   \r\n>\r\n>   ```java\r\n>   public class ProxyFactory implements MethodInterceptor {\r\n>   \r\n>      //ç»´æŠ¤ä¸€ä¸ªç›®æ ‡å¯¹è±¡\r\n>       private Object target;\r\n>   \r\n>       public ProxyFactory(Object target) {\r\n>           this.target = target;\r\n>       }\r\n>   \r\n>       //ä¸ºç›®æ ‡å¯¹è±¡ç”Ÿæˆä»£ç†å¯¹è±¡\r\n>       public Object getProxyInstance() {\r\n>           //å·¥å…·ç±»\r\n>           Enhancer en = new Enhancer();\r\n>           //è®¾ç½®çˆ¶ç±»\r\n>           en.setSuperclass(target.getClass());\r\n>           //è®¾ç½®å›è°ƒå‡½æ•°\r\n>           en.setCallback(this);\r\n>           //åˆ›å»ºå­ç±»å¯¹è±¡ä»£ç†\r\n>           return en.create();\r\n>       }\r\n>   \r\n>       @Override\r\n>       public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {\r\n>           System.out.println(\"è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°æ‚¨ï¼Ÿ\");\r\n>           // æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³•\r\n>           Object returnValue = method.invoke(target, args);\r\n>           System.out.println(\"é—®é¢˜å·²ç»è§£å†³å•¦ï¼\");\r\n>           return null;\r\n>       }\r\n>   \r\n>   }\r\n>   ```\r\n>\r\n> - å®¢æˆ·ç«¯ï¼šClient\r\n>\r\n>   \r\n>\r\n>   ```java\r\n>   public class Client {\r\n>       public static void main(String[] args) {\r\n>           //ç›®æ ‡å¯¹è±¡:ç¨‹åºå‘˜\r\n>           Solver developer = new Solver();\r\n>           //ä»£ç†ï¼šå®¢æœå°å§å§\r\n>           Solver csProxy = (Solver) new ProxyFactory(developer).getProxyInstance();\r\n>           //ç›®æ ‡æ–¹æ³•ï¼šè§£å†³é—®é¢˜\r\n>           csProxy.solve();\r\n>       }\r\n>   }\r\n>   ```\r\n\r\n**ä»£ç†å¯¹è±¡ä¸advisorçš„å…³ç³»**\r\n\r\n- ä»£ç†å¯¹è±¡ä¼šé—´æ¥å»å¼•ç”¨è¿™äº›Advisoråˆ‡é¢\r\n\r\n![image-20230423124430187](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423124430187.png)\r\n\r\n**@Aspectä¸advisorçš„å…³ç³»**\r\n\r\n- æ³¨è§£æ–¹å¼ï¼Œæ•´ä¸ªç±»æ˜¯ä¸€ä¸ªåˆ‡é¢ï¼Œæ–¹æ³•æ˜¯é€šçŸ¥ï¼Œæ³¨è§£é‡Œçš„è¡¨è¾¾å¼æ˜¯åˆ‡ç‚¹ï¼Œè¿™äº›æ³¨è§£çš„æ–¹å¼æœ€ç»ˆè¿˜æ˜¯ä¼šè½¬æ¢æˆMethodInterceptorå’ŒAdvisorè¿™ç§æ–¹å¼çš„ï¼Œè€Œä¸”è½¬æ¢çš„æ–¹å¼æ˜¯ä»¥è¿™ç§é€šçŸ¥æ–¹æ³•ä¸ºå•ä½æ¥è¿›è¡Œè½¬æ¢çš„ï¼Œå¦‚æœ‰ä¸€ä¸ªAspect1çš„ç±»å®ƒé‡Œé¢æœ‰ä¸€ä¸ªç¯ç»•é€šçŸ¥ï¼Œæœ€ç»ˆä¼šè½¬æ¢æˆä¸€ä¸ªadvisorçš„åˆ‡é¢ï¼Œä¸€ä¸ªé€šçŸ¥æ–¹æ³•å¯¹åº”ä¸€ä¸ªadvisoråˆ‡é¢ï¼Œä¸€ä¸ªç±»ä¸­æœ‰å¤šä¸ªé€šçŸ¥æ–¹æ³•å°±åˆ†åˆ«å¯¹åº”ä¸€ä¸ªadvisoråˆ‡é¢ï¼Œadvisoråˆ‡é¢ç›¸å½“äºæ˜¯ä¸€ç§æ›´åŸºæœ¬çš„æˆ–æ˜¯Springå†…ç½®çš„è¿™ç§åˆ‡é¢å½¢å¼ï¼Œå¯¹äºè¿™äº›ç¯ç»•é€šçŸ¥ï¼Œå‰ç½®é€šçŸ¥ï¼Œåç½®é€šçŸ¥ä¹Ÿå¥½ï¼Œå®ƒä»¬æœ€ç»ˆéƒ½ä¼šè½¬æ¢æˆSpringå†…ç½®çš„MethodInterceptorçš„è¿™ç§ç¯ç»•é€šçŸ¥çš„è°ƒç”¨æ–¹å¼\r\n\r\n![image-20230423143827599](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423143827599.png)\r\n\r\n**AnnotationAwareAspectJAutoProxyCreator è‡ªåŠ¨ä»£ç†åå¤„ç†å™¨**\r\n\r\n![image-20231202162832299](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231202162832299.png)\r\n\r\n- wrapIfNecessary\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean\r\n...\r\n      wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);//â†“â†“\r\n...\r\n//org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#postProcessAfterInitialization\r\n...\r\n    return wrapIfNecessary(bean, beanName, cacheKey);//â†“â†“\r\n...\r\n//AbstractAutoProxyCreator#wrapIfNecessary  \r\n    // Create proxy if we have advice.\r\n    ...\r\n        Object proxy = createProxy(\r\n                bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));\r\n    ...\r\n//AbstractAutoProxyCreator#createProxy\r\n...\r\n\treturn proxyFactory.getProxy(classLoader);\r\n...\r\n```\r\n\r\n\r\n\r\n![image-20230423144839058](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423144839058.png)\r\n\r\n- wrapIfNecessary-DEBUG\r\n\r\n![image-20230423150240536](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423150240536.png)\r\n\r\n- ä»£ç†åˆ›å»ºæ—¶æœº\r\n  - åˆ›å»º bean å®ä¾‹ä¹‹å‰ï¼Œå¦‚æœä½ çš„beanè‡ªå®šä¹‰äº† TargetSourceï¼Œå°±ä¼šè°ƒç”¨åˆ°è‡ªåŠ¨ä»£ç†åå¤„ç†å™¨æ¥åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆç”¨å¾—è¾ƒå°‘ï¼Œäº†è§£å³å¯ï¼‰ï¼›\r\n  - åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œä¼šè°ƒç”¨åˆ°è¿™ä¸ªè‡ªåŠ¨ä»£ç†åå¤„ç†å™¨ï¼Œåœ¨åˆå§‹åŒ–æ‰§è¡Œå®Œä»¥åï¼Œå°±è¦è°ƒç”¨åå¤„ç†å™¨çš„ PostProcessAfterInitialization æ–¹æ³•ï¼Œè¿™æ—¶å€™å°±ä¼šç”¨åˆ°è¿™ä¸ªè‡ªåŠ¨ä»£ç†åå¤„ç†å™¨æ¥åˆ›å»ºä»£ç†å¯¹è±¡ï¼›\r\n  - åœ¨ä¾èµ–æ³¨å…¥é˜¶æ®µï¼Œæœ‰ä¸ªæ¡ä»¶æ˜¯äº§ç”Ÿå¾ªç¯ä¾èµ–ï¼Œäº§ç”Ÿå¾ªç¯ä¾èµ–ä»¥åï¼Œå®ƒä¼šåœ¨å•ä¾‹å·¥å‚æ± ä¸­é€šè¿‡ä¸€ä¸ªå·¥å‚å¯¹è±¡æ¥é—´æ¥çš„è°ƒç”¨åˆ°æˆ‘ä»¬çš„è‡ªåŠ¨ä»£ç†åå¤„ç†å™¨ç±»æ¥åˆ›å»ºä»£ç†\r\n    - `org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#postProcessObjectFromFactoryBean`\r\n  \r\n  ```java\r\n  /**\r\n   * Applies the {@code postProcessAfterInitialization} callback of all\r\n   * registered BeanPostProcessors, giving them a chance to post-process the\r\n   * object obtained from FactoryBeans (for example, to auto-proxy them).\r\n   * @see #applyBeanPostProcessorsAfterInitialization\r\n   */\r\n  @Override\r\n  protected Object postProcessObjectFromFactoryBean(Object object, String beanName) {\r\n     return applyBeanPostProcessorsAfterInitialization(object, beanName);\r\n  }\r\n  ```\r\n\r\n![image-20230423150540283](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423150540283.png)\r\n\r\n![image-20230423150918284](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423150918284.png)\r\n\r\n**æ€»ç»“**\r\n\r\n- æœ€åŸºæœ¬çš„åˆ‡é¢æ˜¯ Advisorï¼Œä¸€ä¸ªAspect åˆ‡é¢å¯¹åº”ä¸€åˆ°å¤šä¸ª Advisor\r\n- æœ€åŸºæœ¬çš„ Advice æ˜¯ Methodinterceptorï¼Œå…¶å®ƒ Advice æœ€ç»ˆéƒ½å°†é€‚é…ä¸º Methodinterceptor\r\n- åˆ›å»ºä»£ç†çš„æ–¹å¼\r\n  - å®ç°äº†ç”¨æˆ·è‡ªå®šä¹‰æ¥å£ï¼Œé‡‡ç”¨jdk åŠ¨æ€ä»£ç†\r\n  - æ²¡æœ‰å®ç°ç”¨æˆ·è‡ªå®šä¹‰æ¥å£ï¼Œé‡‡ç”¨ cglib ä»£ç†\r\n  - è®¾ç½®äº† setProxyTargetClass(true)ï¼Œç»Ÿä¸€é‡‡ç”¨ cglib ä»£ç†\r\n- åˆ‡é¢ã€åˆ‡ç‚¹ã€é€šçŸ¥ç­‰ä¸ä¼šè¢«ä»£ç†\r\n- AnnotationAwareAspectJAutoProxyCreator è°ƒç”¨æ—¶æœº: åˆ›å»ºé˜¶æ®µã€ä¾èµ–æ³¨å…¥é˜¶æ®µã€**åˆå§‹åŒ–é˜¶æ®µ**\r\n\r\n\r\n\r\n------\r\n\r\n### **å¾ªç¯ä¾èµ–çš„äº§ç”Ÿ**\r\n\r\n* é¦–å…ˆè¦æ˜ç™½ï¼Œbean çš„åˆ›å»ºè¦éµå¾ªä¸€å®šçš„æ­¥éª¤ï¼Œå¿…é¡»æ˜¯åˆ›å»ºã€æ³¨å…¥ã€åˆå§‹åŒ–ä¸‰æ­¥ï¼Œè¿™äº›é¡ºåºä¸èƒ½ä¹±\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903085238916.png\" alt=\"image-20210903085238916\" class=\"scale-50\" />\r\n\r\n* set æ–¹æ³•ï¼ˆåŒ…æ‹¬æˆå‘˜å˜é‡ï¼‰çš„å¾ªç¯ä¾èµ–å¦‚å›¾æ‰€ç¤º\r\n\r\n  * å¯ä»¥åœ¨ã€a åˆ›å»ºã€‘å’Œã€a set æ³¨å…¥ bã€‘ä¹‹é—´åŠ å…¥ b çš„æ•´ä¸ªæµç¨‹æ¥è§£å†³\r\n  * ã€b set æ³¨å…¥ aã€‘ æ—¶å¯ä»¥æˆåŠŸï¼Œå› ä¸ºä¹‹å‰ a çš„å®ä¾‹ï¼ˆæœªåˆå§‹åŒ–ï¼‰å·²ç»åˆ›å»ºå®Œæ¯•\r\n\r\n  * a çš„é¡ºåºï¼ŒåŠ b çš„é¡ºåºéƒ½èƒ½å¾—åˆ°ä¿éšœ\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903085454603.png\" alt=\"image-20210903085454603\" class=\"scale-33\" />\r\n\r\n* æ„é€ æ–¹æ³•çš„å¾ªç¯ä¾èµ–å¦‚å›¾æ‰€ç¤ºï¼Œæ˜¾ç„¶æ— æ³•ç”¨å‰é¢çš„æ–¹æ³•è§£å†³\r\n\r\n![image-20230423164711640](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423164711640.png)\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n### **æ„é€ å¾ªç¯ä¾èµ–çš„è§£å†³**\r\n\r\n* æ€è·¯1\r\n  * a æ³¨å…¥ b çš„ä»£ç†å¯¹è±¡ï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯ a çš„æµç¨‹èµ°é€š\r\n  * åç»­éœ€è¦ç”¨åˆ° b çš„çœŸå®å¯¹è±¡æ—¶ï¼Œå¯ä»¥é€šè¿‡ä»£ç†é—´æ¥è®¿é—®\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903091627659.png\" alt=\"image-20210903091627659\" class=\"scale-50\" />\r\n\r\n* æ€è·¯2\r\n  * a æ³¨å…¥ b çš„å·¥å‚å¯¹è±¡ï¼Œè®© b çš„å®ä¾‹åˆ›å»ºè¢«æ¨è¿Ÿï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯ a çš„æµç¨‹å…ˆèµ°é€š\r\n  * åç»­éœ€è¦ç”¨åˆ° b çš„çœŸå®å¯¹è±¡æ—¶ï¼Œå†é€šè¿‡ ObjectFactory å·¥å‚é—´æ¥è®¿é—®\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903091743366.png\" alt=\"image-20210903091743366\" class=\"scale-50\" />\r\n\r\n![image-20230423164819587](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423164819587.png)\r\n\r\n* ç¤ºä¾‹1ï¼šç”¨ @Lazy ä¸ºæ„é€ æ–¹æ³•å‚æ•°ç”Ÿæˆä»£ç†\r\n\r\n![image-20230423165237989](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423165237989.png)\r\n\r\n> @Lazy å¯ä»¥åŠ åœ¨æˆå‘˜å˜é‡ä¸Šæˆ–æ–¹æ³•å‚æ•°ä¸Šï¼Œä¹ŸåŒ…æ‹¬æ„é€ æ–¹æ³•çš„å‚æ•°ä¸Šï¼ŒåŠ äº†ä¹‹å Spring å°±å»æŸ¥æ‰¾ä¾èµ–æ³¨å…¥çš„å€¼æ—¶ï¼Œå°±æ ¹æ®æ­¤æ³¨è§£è¿›è¡Œè§£æï¼ŒæŸ¥æ‰¾ä¾èµ–æ³¨å…¥çš„å€¼ä¼šè°ƒç”¨åˆ° beanFactory ä¸­çš„ä¸€ä¸ª resolveDependency çš„æ–¹æ³•åˆ¤æ–­æ˜¯å¦è¯¥å€¼åŠ äº† @Lazy æ³¨è§£ï¼ŒåŠ äº†å°±ä¼šè¿›è¡Œä»£ç†å¯¹è±¡çš„åˆ›å»ºï¼Œå¦åˆ™è¿”å›åŸå§‹å¯¹è±¡\r\n\r\n* ç¤ºä¾‹2ï¼šç”¨ ObjectFactory æˆ– ObjectProvider å»¶è¿Ÿä¾èµ–å¯¹è±¡çš„åˆ›å»º\r\n\r\n![image-20230423165816753](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423165816753.png)\r\n>\r\n> ObjectFactory å’Œ ObjectProvider éƒ½æ˜¯ Spring æä¾›çš„å·¥å‚æ¥å£\r\n\r\n* ç¤ºä¾‹3ï¼šç”¨ @Scope äº§ç”Ÿä»£ç†\r\n\r\n![image-20230423170840218](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423170840218.png)\r\n\r\n> åœ¨ @Lazy å’Œ @Scope è¿™ä¸¤ç§ä»£ç†ä¸­é€‰æ‹©åˆ›å»ºä»£ç†çš„è¯ï¼Œä¼šé€‰æ‹© @Lazyï¼Œå› ä¸º @Scope æ˜¯ä¸€ç§æ¯”è¾ƒ low çš„è§£å†³æ–¹å¼ï¼Œå› ä¸ºå®ƒæ˜¯ç”±ä»£ç†å·¥å‚æ¥ç”Ÿäº§ä»£ç†å¯¹è±¡çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±ç»•äº†ä¸€ä¸ªå¼¯ï¼Œè€Œä¸”çœŸæ­£çš„ç›®æ ‡ä¹Ÿä¼šåœ¨æˆ‘ä»¬çš„å•ä¾‹æ± é‡Œå­˜ä¸€ä»½(scopeTarget.b)\r\n\r\n* ç¤ºä¾‹4ï¼šç”¨ Provider æ¥å£è§£å†³ï¼ŒåŸç†ä¸Šä¸ ObjectProvider ä¸€æ ·ï¼ŒProvider æ¥å£æ˜¯ç‹¬ç«‹çš„ jar åŒ…ï¼Œéœ€è¦åŠ å…¥ä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>javax.inject</groupId>\r\n    <artifactId>javax.inject</artifactId>\r\n    <version>1</version>\r\n</dependency>\r\n```\r\n\r\n![image-20230423170300385](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423170300385.png)\r\n\r\n> Providerè¿™ä¸ªæ¥å£æ˜¯javaå®˜æ–¹æä¾›çš„ä¸€å¥—å·¥å‚æ¥å£ï¼Œåœ¨pomæ–‡ä»¶åŠ å…¥javax.injectçš„ä¾èµ–ï¼Œå®ƒçš„ä½œç”¨è·Ÿå‰é¢çš„ä¸¤ä¸ªå·¥å‚æ¥å£çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œå³å¯ä»¥æ¨è¿Ÿäº§å“å¯¹è±¡çš„è·å–\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n### è§£å†³ set å¾ªç¯ä¾èµ–çš„åŸç†\r\n\r\n**ä¸€çº§ç¼“å­˜ singletonObjects **\r\n\r\n![image-20230423152153455](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423152153455.png)\r\n\r\nä½œç”¨æ˜¯ä¿è¯å•ä¾‹å¯¹è±¡ä»…è¢«åˆ›å»ºä¸€æ¬¡\r\n\r\n* ç¬¬ä¸€æ¬¡èµ° `getBean(\"a\")` æµç¨‹åï¼Œæœ€åä¼šå°†æˆå“ a æ”¾å…¥ singletonObjects ä¸€çº§ç¼“å­˜\r\n* åç»­å†èµ° `getBean(\"a\")` æµç¨‹æ—¶ï¼Œå…ˆä»ä¸€çº§ç¼“å­˜ä¸­æ‰¾ï¼Œè¿™æ—¶å·²ç»æœ‰æˆå“ aï¼Œå°±æ— éœ€å†æ¬¡åˆ›å»º\r\n\r\n**ä¸€çº§ç¼“å­˜ä¸å¾ªç¯ä¾èµ–**\r\n\r\n![image-20230423152409029](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423152409029.png)\r\n\r\nä¸€çº§ç¼“å­˜æ— æ³•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œåˆ†æå¦‚ä¸‹\r\n\r\n* æ— è®ºæ˜¯è·å– bean a è¿˜æ˜¯è·å– bean bï¼Œèµ°çš„æ–¹æ³•éƒ½æ˜¯åŒä¸€ä¸ª getBean æ–¹æ³•ï¼Œå‡è®¾å…ˆèµ° `getBean(\"a\")`\r\n* å½“ a çš„å®ä¾‹å¯¹è±¡åˆ›å»ºï¼Œæ¥ä¸‹æ¥æ‰§è¡Œ `a.setB()` æ—¶ï¼Œéœ€è¦èµ° `getBean(\"b\")` æµç¨‹ï¼Œçº¢è‰²ç®­å¤´ 1\r\n* å½“ b çš„å®ä¾‹å¯¹è±¡åˆ›å»ºï¼Œæ¥ä¸‹æ¥æ‰§è¡Œ `b.setA()` æ—¶ï¼Œåˆå›åˆ°äº† `getBean(\"a\")` çš„æµç¨‹ï¼Œçº¢è‰²ç®­å¤´ 2\r\n* ä½†æ­¤æ—¶ singletonObjects ä¸€çº§ç¼“å­˜å†…æ²¡æœ‰æˆå“çš„ aï¼Œé™·å…¥äº†æ­»å¾ªç¯\r\n\r\n**äºŒçº§ç¼“å­˜ singletonFactoriesï¼ˆå®˜æ–¹ä¸‰çº§ç¼“å­˜ï¼‰ **\r\n\r\n![image-20230423152834032](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423152834032.png)\r\n\r\nè§£å†³æ€è·¯å¦‚ä¸‹ï¼š\r\n\r\n* å†å¢åŠ ä¸€ä¸ª singletonFactories ç¼“å­˜\r\n* åœ¨ä¾èµ–æ³¨å…¥å‰ï¼Œå³ `a.setB()` ä»¥åŠ `b.setA()` å°† a åŠ b çš„åŠæˆå“å¯¹è±¡ï¼ˆæœªå®Œæˆä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–ï¼‰æ”¾å…¥æ­¤ç¼“å­˜\r\n* æ‰§è¡Œä¾èµ–æ³¨å…¥æ—¶ï¼Œå…ˆçœ‹çœ‹ singletonFactories ç¼“å­˜ä¸­æ˜¯å¦æœ‰åŠæˆå“çš„å¯¹è±¡ï¼Œå¦‚æœæœ‰æ‹¿æ¥æ³¨å…¥ï¼Œé¡ºåˆ©èµ°å®Œæµç¨‹\r\n\r\nå¯¹äºä¸Šé¢çš„å›¾\r\n\r\n* `a = new A()` æ‰§è¡Œä¹‹åå°±ä¼šæŠŠè¿™ä¸ªåŠæˆå“çš„ a æ”¾å…¥ singletonFactories ç¼“å­˜ï¼Œå³ `factories.put(a)`\r\n* æ¥ä¸‹æ¥æ‰§è¡Œ `a.setB()`ï¼Œèµ°å…¥ `getBean(\"b\")` æµç¨‹ï¼Œçº¢è‰²ç®­å¤´ 3\r\n* è¿™å›å†æ‰§è¡Œåˆ° `b.setA()` æ—¶ï¼Œéœ€è¦ä¸€ä¸ª a å¯¹è±¡ï¼Œæœ‰æ²¡æœ‰å‘¢ï¼Ÿæœ‰ï¼\r\n* `factories.get()` åœ¨ singletonFactories  ç¼“å­˜ä¸­å°±å¯ä»¥æ‰¾åˆ°ï¼Œçº¢è‰²ç®­å¤´ 4 å’Œ 5\r\n* b çš„æµç¨‹èƒ½å¤Ÿé¡ºåˆ©èµ°å®Œï¼Œå°† b æˆå“æ”¾å…¥ singletonObject ä¸€çº§ç¼“å­˜ï¼Œè¿”å›åˆ° a çš„ä¾èµ–æ³¨å…¥æµç¨‹ï¼Œçº¢è‰²ç®­å¤´ 6\r\n\r\n**äºŒçº§ç¼“å­˜ä¸åˆ›å»ºä»£ç†**\r\n\r\n![image-20230423153224037](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423153224037.png)\r\n\r\näºŒçº§ç¼“å­˜æ— æ³•æ­£ç¡®å¤„ç†å¾ªç¯ä¾èµ–å¹¶ä¸”åŒ…å«æœ‰ä»£ç†åˆ›å»ºçš„åœºæ™¯ï¼Œåˆ†æå¦‚ä¸‹\r\n\r\n* spring é»˜è®¤è¦æ±‚ï¼Œåœ¨ `a.init` å®Œæˆä¹‹åæ‰èƒ½åˆ›å»ºä»£ç† `pa = proxy(a)`\r\n* ç”±äº a çš„ä»£ç†åˆ›å»ºæ—¶æœºé åï¼Œåœ¨æ‰§è¡Œ `factories.put(a)` å‘ singletonFactories ä¸­æ”¾å…¥çš„è¿˜æ˜¯åŸå§‹å¯¹è±¡\r\n* æ¥ä¸‹æ¥ç®­å¤´ 3ã€4ã€5 è¿™å‡ æ­¥ b å¯¹è±¡æ‹¿åˆ°å’Œæ³¨å…¥çš„éƒ½æ˜¯åŸå§‹å¯¹è±¡\r\n\r\n> äºŒçº§ç¼“å­˜çš„é—®é¢˜(singletonFactories)ï¼šä¾èµ–æ³¨å…¥å…ˆå‘ç”Ÿï¼Œåˆ›å»ºä»£ç†åå‘ç”Ÿï¼Œåˆ›å»ºå¯¹è±¡æ—¶ä»£ç†å¯¹è±¡è¿˜æ²¡æœ‰ï¼Œå³å®ƒåªèƒ½æ³¨å…¥é‚£ä¸ªåŸå§‹çš„ç›®æ ‡å¯¹è±¡\r\n>\r\n> è§£å†³åŠæ³•ï¼šæŠŠä»£ç†å¯¹è±¡æå‰åˆ›å»ºï¼Œä½†Springæ²¡æœ‰è¿™ä¹ˆåšï¼Œå®ƒè¿˜æ˜¯æƒ³ä»£ç†å¯¹è±¡å°½å¯èƒ½åœ¨æœ€åæ¥åˆ›å»ºï¼Œå³åˆå§‹åŒ–åæ‰åˆ›å»ºï¼Œåªæœ‰å‘ç”Ÿäº†å¾ªç¯ä¾èµ–æ—¶å®ƒæ‰æå‰åˆ›å»ºä»£ç†\r\n\r\n**ä¸‰çº§ç¼“å­˜ earlySingletonObjectsï¼ˆå®˜æ–¹äºŒçº§ç¼“å­˜ï¼‰ **\r\n\r\n![image-20230423154033542](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423154033542.png)\r\n\r\nç®€å•åˆ†æçš„è¯ï¼Œåªéœ€è¦å°†ä»£ç†çš„åˆ›å»ºæ—¶æœºæ”¾åœ¨ä¾èµ–æ³¨å…¥ä¹‹å‰å³å¯ï¼Œä½† spring ä»ç„¶å¸Œæœ›ä»£ç†çš„åˆ›å»ºæ—¶æœºåœ¨ init ä¹‹åï¼Œåªæœ‰å‡ºç°å¾ªç¯ä¾èµ–æ—¶ï¼Œæ‰ä¼šå°†ä»£ç†çš„åˆ›å»ºæ—¶æœºæå‰ã€‚æ‰€ä»¥è§£å†³æ€è·¯ç¨æ˜¾å¤æ‚ï¼š\r\n\r\n* å›¾ä¸­ `factories.put(fa)` æ”¾å…¥çš„æ—¢ä¸æ˜¯åŸå§‹å¯¹è±¡ï¼Œä¹Ÿä¸æ˜¯ä»£ç†å¯¹è±¡è€Œæ˜¯å·¥å‚å¯¹è±¡ fa\r\n* å½“æ£€æŸ¥å‡ºå‘ç”Ÿå¾ªç¯ä¾èµ–æ—¶ï¼Œfa çš„äº§å“å°±æ˜¯ä»£ç† paï¼Œæ²¡æœ‰å‘ç”Ÿå¾ªç¯ä¾èµ–ï¼Œfa çš„äº§å“æ˜¯åŸå§‹å¯¹è±¡ a\r\n* å‡è®¾å‡ºç°äº†å¾ªç¯ä¾èµ–ï¼Œæ‹¿åˆ°äº† singletonFactories ä¸­çš„å·¥å‚å¯¹è±¡ï¼Œé€šè¿‡åœ¨ä¾èµ–æ³¨å…¥å‰è·å¾—äº† paï¼Œçº¢è‰²ç®­å¤´ 5\r\n* è¿™å› `b.setA()` æ³¨å…¥çš„å°±æ˜¯ä»£ç†å¯¹è±¡ï¼Œä¿è¯äº†æ­£ç¡®æ€§ï¼Œçº¢è‰²ç®­å¤´ 7\r\n* è¿˜éœ€è¦æŠŠ pa å­˜å…¥æ–°åŠ çš„ earlySingletonObjects ç¼“å­˜ï¼Œçº¢è‰²ç®­å¤´ 6\r\n* `a.init` å®Œæˆåï¼Œæ— éœ€äºŒæ¬¡åˆ›å»ºä»£ç†ï¼Œä»å“ªå„¿æ‰¾åˆ° pa å‘¢ï¼ŸearlySingletonObjects å·²ç»ç¼“å­˜ï¼Œè“è‰²ç®­å¤´ 9\r\n* å½“æˆå“å¯¹è±¡äº§ç”Ÿï¼Œæ”¾å…¥ singletonObjects åï¼ŒsingletonFactories å’Œ earlySingletonObjects ä¸­çš„å¯¹è±¡å°±æ²¡æœ‰ç”¨å¤„ï¼Œæ¸…é™¤å³å¯\r\n\r\n> å¼•å…¥ä¸‰çº§ç¼“å­˜(earlySingletonObjects)ï¼Œå¹¶ä¸”è¿˜è¦å¼•å…¥ä¸€ä¸ªå·¥å‚æ‰èƒ½å®ç°åˆšæ‰çš„ç›®çš„ï¼Œè¿™ä¸ªå·¥å‚(ç†è§£ä¸ºä¸€ä¸ªLambdaè¡¨è¾¾å¼fa-> pa || a)çš„ä½œç”¨æ˜¯äº§ç”Ÿä»£ç†å¯¹è±¡æˆ–åŸå§‹å¯¹è±¡ï¼Œå®ƒä¼šæ£€æŸ¥å¦‚æœä½ å°†æ¥å‘ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼Œå®ƒå°±ä¼šæå‰åˆ›å»ºç”Ÿæˆä»£ç†å¯¹è±¡å¹¶è¿”å›ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå¾ªç¯ä¾èµ–ï¼Œå®ƒè¿˜æ˜¯è¿”å›åŸå§‹å¯¹è±¡\r\n>\r\n\r\n\r\n\r\n**setå¾ªç¯ä¾èµ–æ¼”ç¤º**\r\n\r\n![image-20230423154514318](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423154514318.png)\r\n\r\n- DEBUG - getSingleton\r\n\r\n![image-20230423160842182](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423160842182.png)\r\n\r\n![image-20230423160934610](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423160934610.png)\r\n\r\n![image-20230423160952450](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423160952450.png)\r\n\r\n> èµ·ç‚¹ç”± refresh ç¬¬åä¸€æ­¥ï¼ˆfinishBeanFactoryInitializationï¼‰å¼€å§‹ï¼Œåˆå§‹åŒ–æ‰€æœ‰éå»¶è¿Ÿå•ä¾‹ bean\r\n>\r\n> ```java\r\n> protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) {\r\n>     ...\r\n> \tbeanFactory.preInstantiateSingletons();    \r\n> }\r\n> @Override\r\n> public void preInstantiateSingletons() throws BeansException {\r\n> \t...\r\n> \tList<String> beanNames = new ArrayList<>(this.beanDefinitionNames);\r\n> \t// Trigger initialization of all non-lazy singleton beans...\r\n> \tfor (String beanName : beanNames) {\r\n>          ...\r\n>          //éå»¶è¿Ÿå•ä¾‹ bean è·å–   \r\n> \t\tgetBean(beanName);\r\n> \t\t...\r\n> \t}\r\n> }\r\n> //æ ¸å¿ƒæ–¹æ³•1\r\n> protected <T> T doGetBean(String name, @Nullable Class<T> requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException {\r\n>     //ä»1ã€2ã€3çº§ç¼“å­˜è§£å†³setå¾ªç¯ä¾èµ–çš„æ ¸å¿ƒæ–¹æ³•ï¼ŒallowEarlyReference=trueï¼›debugæ ¸å¿ƒç‚¹ï¼Œè®¾ç½®é¢å‘allçš„beanName.equals(\"a\");å“ªä¸ªbeanå…ˆæ³¨å†Œå°±è®¾ç½®å“ªä¸ª\r\n>     //ç¬¬ä¸€æ¬¡getBean(\"a\")ï¼ŒsharedInstance=nullï¼Œå› ä¸ºä¸€çº§äºŒçº§ç¼“å­˜éƒ½æ²¡æœ‰å­˜å‚¨aæˆ–å…¶ä»£ç†å¯¹è±¡ï¼Œä¸‰çº§ç¼“å­˜è¿˜æœªæ·»åŠ \r\n> \tObject sharedInstance = getSingleton(beanName);\r\n>     //è¿›å…¥å•ä¾‹beançš„åˆ›å»ºæ­¥éª¤\r\n>     ...\r\n>     return createBean(beanName, mbd, args);\r\n>     ...\r\n> }\r\n> @Override\r\n> protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException {\r\n>     ...\r\n> \tObject beanInstance = doCreateBean(beanName, mbdToUse, args);\r\n>     ...\r\n> }\r\n> //beançš„åˆ›å»ºä¸‰é˜¶æ®µæ ¸å¿ƒæ–¹æ³•\r\n> protected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) throws BeanCreationException {\r\n>     ...\r\n>     //beançš„å®ä¾‹åŒ–\r\n>     Object bean = instanceWrapper.getWrappedInstance();\r\n>     ...\r\n> \t//æ·»åŠ beançš„ä¸‰çº§ç¼“å­˜æ ¸å¿ƒæ–¹æ³•ï¼Œå­˜å‚¨Lambdaè¡¨è¾¾å¼ï¼Œåç»­è°ƒç”¨getObjectæ—¶ä¼šå›è°ƒ\r\n> \taddSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));\r\n>     //è®°å½•åŸå§‹beanï¼Œåç»­åˆ¤æ–­åˆå§‹åŒ–é˜¶æ®µæˆ–ä¹‹å‰æœ‰æ²¡æœ‰åˆ›å»ºä»£ç†\r\n> \tObject exposedObject = bean;\r\n> \ttry {\r\n>          //ä¾èµ–æ³¨å…¥é˜¶æ®µ\r\n> \t\tpopulateBean(beanName, mbd, instanceWrapper);\r\n> \t\t//åˆå§‹åŒ–é˜¶æ®µ\r\n>          exposedObject = initializeBean(beanName, exposedObject, mbd);\r\n> \t}\r\n>     ...\r\n> }\r\n> protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) {\r\n>     ...\r\n>     for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) {\r\n>         //éå†beançš„åå¤„ç†åˆ°AutowiredAnnotationBeanPostProcessorè¿›è¡Œæ³¨è§£è§£æ\r\n> \t\tPropertyValues pvsToUse = bp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);\r\n>         ...\r\n>     }\r\n>     ...\r\n> }\r\n> ```\r\n>\r\n> - å¾ªç¯ä¾èµ–åœ¨ä¾èµ–æ³¨å…¥çš„å…³é”®ç‚¹\r\n>   `postProcessProperties(...) -> inject(...):AutowiredMethodElement -> resolveMethodArguments(...) -> resolveDependency(...) -> doResolveDependency(...) -> resolveCandidate(...) -> getBean(\"b\")ï¼›`\r\n> - è¿›å…¥ b çš„åˆ›å»ºè¿‡ç¨‹ï¼Œä¸ a ç¬¬ä¸€æ¬¡ getBean ä¸€æ ·ï¼Œç„¶åä¾èµ–æ³¨å…¥èµ°åˆ° `getBean(\"a\")`\r\n> - ç¬¬äºŒæ¬¡getBean(\"a\")ï¼Œå°±ä¼šè¿›å…¥ä¸‰çº§ç¼“å­˜è·å– bean çš„æµç¨‹\r\n>\r\n> ```java\r\n> public Object getSingleton(String beanName) {\r\n> \treturn getSingleton(beanName, true);\r\n> }\r\n> //getSingletonä¸‰çº§ç¼“å­˜è·å–å¯¹è±¡å·¥å‚çš„æ ¸å¿ƒæµç¨‹\r\n> ...\r\n> synchronized (this.singletonObjects) {\r\n> \t// Consistent creation of early reference within full singleton lock\r\n> \tsingletonObject = this.singletonObjects.get(beanName);\r\n> \tif (singletonObject == null) {\r\n> \t\tsingletonObject = this.earlySingletonObjects.get(beanName);\r\n> \t\tif (singletonObject == null) {\r\n> \t\t\tObjectFactory<?> singletonFactory = this.singletonFactories.get(beanName);\r\n> \t\t\tif (singletonFactory != null) {\r\n>                   //aç¬¬ä¸€æ¬¡getBeanæ—¶å°†è‡ªå·±åˆ°ä¸‰çº§ç¼“å­˜é‡Œï¼ŒsingletonFactories=[{\"a\",()->{...}}]ï¼Œæ‰€ä»¥å½“è·å–åˆ°açš„å·¥å‚å¯¹è±¡åè°ƒç”¨getObjectæ–¹æ³•å°±ä¼šå›è°ƒLambdaè¡¨è¾¾å¼é‡Œçš„ä»£ç å—æ–¹æ³•getEarlyBeanReference(beanName, mbd, bean)\r\n> \t\t\t\tsingletonObject = singletonFactory.getObject();\r\n> \t\t\t\tthis.earlySingletonObjects.put(beanName, singletonObject);\r\n> \t\t\t\tthis.singletonFactories.remove(beanName);\r\n> \t\t\t}\r\n> \t\t}\r\n> \t}\r\n> }\r\n> ...\r\n> ```\r\n>\r\n> ```java\r\n> protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {\r\n>    Object exposedObject = bean;\r\n>    ...\r\n>          exposedObject = bp.getEarlyBeanReference(exposedObject, beanName);\r\n>    ...\r\n>    return exposedObject;\r\n> }\r\n> //org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#getEarlyBeanReference\r\n> @Override\r\n> public Object getEarlyBeanReference(Object bean, String beanName) {\r\n>  \tObject cacheKey = getCacheKey(bean.getClass(), beanName);\r\n>     //å°†å‡†å¤‡è¿›å…¥ä»£ç†çš„å¯¹è±¡å¼•å…¥å­˜å…¥äºŒçº§ç¼“å­˜ï¼Œåç»­åœ¨åˆå§‹åŒ–å®Œæˆåè¿›è¡Œä»£ç†å¢å¼ºçš„åˆ¤æ–­ï¼Œæ— éœ€å†æ¬¡åˆ›å»ºä»£ç†\r\n>  \tthis.earlyProxyReferences.put(cacheKey, bean);\r\n>     //å°†è¿”å›ä»£ç†åçš„å¯¹è±¡ï¼šåŒ…å.$ç±»å$$EnhancerBySpringCGLIB$$å¼•ç”¨åœ°å€\r\n>  \treturn wrapIfNecessary(bean, beanName, cacheKey);\r\n> }\r\n> ```\r\n>\r\n> ```java\r\n> //#doGetBean\r\n> ...\r\n> if (sharedInstance != null && args == null) {\r\n>    ...\r\n>    beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, null);\r\n> }\r\n> ...\r\n> return adaptBeanInstance(name, beanInstance, requiredType);\r\n> //æ–¹æ³•è·³å‡º -> resolveCandidate(...) -> resolveDependency -> resolveMethodArguments(...) -> inject(...)\r\n> //#doResolveDependency\r\n>     ...\r\n>     instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, this);\r\n>     ...\r\n>     return result;\r\n> \t}\r\n> \tfinally {\r\n>         //æ–¹æ³•è¿”å›å‰æ‰§è¡Œ\r\n> \t    ConstructorResolver.setCurrentInjectionPoint(previousInjectionPoint);\r\n> \t}\r\n> }\r\n> //#resolveDependency\r\n> ...\r\n>     if (result == null) {\r\n>       //resultä¸ºaçš„ä»£ç†å¯¹è±¡\r\n> \t  result = doResolveDependency(descriptor, requestingBeanName, autowiredBeanNames, typeConverter);\r\n> \t}\r\n> \treturn result;\r\n> ...\r\n>     \r\n> //#inject\r\n>     else {\r\n>         arguments = resolveMethodArguments(method, bean, beanName);\r\n>     }\r\n>     if (arguments != null) {\r\n>         try {\r\n>             ReflectionUtils.makeAccessible(method);\r\n>             //åå°„æ‰§è¡ŒsetAæ³¨å…¥ç»™B\r\n>             method.invoke(bean, arguments);\r\n>             //è¾“å‡ºï¼š- setA(class åŒ…å.$A$$EnhancerBySpringCGLIB$$5fbc14f4) \r\n>         }\r\n>         catch (...) {...}\r\n>     }\r\n> ...\r\n> ```\r\n>\r\n> - bä¾èµ–æ³¨å…¥å®Œåè·³å‡º populateBean è¿›å…¥bçš„åˆå§‹åŒ–è¿‡ç¨‹\r\n> - bæ•´ä¸ªåˆ›å»ºæµç¨‹èµ°å®Œæœ€åä¹Ÿæ˜¯æ–¹æ³•è·³å‡ºåˆ°resolveCandidateæ–¹æ³•ï¼Œè¿›è¡Œaçš„ä¾èµ–æ³¨å…¥æµç¨‹ï¼Œåå°„æ‰§è¡ŒsetBæ³¨å…¥ç»™a\r\n> - açš„åˆå§‹åŒ–èµ°å®Œï¼Œè¿›å…¥ç¬¬äºŒæ¬¡ç¼“å­˜æ£€æŸ¥ï¼Œé˜²æ­¢ä»£ç†å¯¹è±¡çš„é—æ¼\r\n>\r\n> ```java\r\n> //doCreateBean\r\n> ...\r\n> //åŸå§‹å¯¹è±¡\r\n> Object exposedObject = bean;\r\n> \ttry {\r\n> \t\tpopulateBean(beanName, mbd, instanceWrapper);\r\n>          //åˆå§‹åŒ–åå¯¹è±¡ï¼Œå› ä¸ºåœ¨åˆå§‹åŒ–é˜¶æ®µaæ²¡æœ‰è¿›è¡Œä»£ç†åˆ›å»ºï¼Œä½†æ˜¯bæ³¨å…¥aæ—¶æå‰æŠŠaçš„ä»£ç†å¯¹è±¡åˆ›å»ºå¹¶è¿›è¡Œå€¼æ³¨å…¥ï¼Œæ‰€ä»¥åé¢è¿›è¡Œç¬¬äºŒæ¬¡ç¼“å­˜æ£€æŸ¥è·å–ä»£ç†å¯¹è±¡ï¼Œé˜²æ­¢é—æ¼\r\n> \t\texposedObject = initializeBean(beanName, exposedObject, mbd);\r\n> \t}\r\n> ...\r\n> if (earlySingletonExposure) {\r\n>     //ä»äºŒçº§ç¼“å­˜è·å–açš„ä»£ç†å¯¹è±¡\r\n>    Object earlySingletonReference = getSingleton(beanName, false);\r\n>    if (earlySingletonReference != null) {\r\n>       if (exposedObject == bean) {\r\n>           //å°†açš„åŸå§‹å¼•ç”¨æŒ‡å‘ä»£ç†å¯¹è±¡å¼•ç”¨\r\n>          exposedObject = earlySingletonReference;\r\n>       }\r\n>       ...\r\n>    }\r\n> }\r\n> ...\r\n> ```\r\n\r\n\r\n\r\n- setå¾ªç¯ä¾èµ– - äºŒçº§ç¼“å­˜ä½œç”¨1\r\n\r\n![image-20230423162034164](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423162034164.png)\r\n\r\n```java\r\n//org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean\r\n...\r\n    \t//beanä¸ºåŸå§‹å¯¹è±¡\r\n    \tObject bean = instanceWrapper.getWrappedInstance();\r\n\t\t...\r\n             //å‘ç”Ÿå¾ªç¯ä¾èµ–ï¼Œå°†å¯¹è±¡åŠ å…¥ä¸‰çº§ç¼“å­˜singletonFactories\r\n\t\t\taddSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));\r\n\t\t...\r\n\t\t// Initialize the bean instance.\r\n\t\tObject exposedObject = bean;\r\n\t\ttry {\r\n             //ä¾èµ–æ³¨å…¥\r\n\t\t\tpopulateBean(beanName, mbd, instanceWrapper);\r\n\t\t\t//åˆå§‹åŒ–åçš„bean\r\n             exposedObject = initializeBean(beanName, exposedObject, mbd);\r\n\t\t}\r\n\t\tcatch (Throwable ex) {...}\r\n\r\n\t\tif (earlySingletonExposure) {\r\n             //è·å–ä¸€çº§å’ŒäºŒçº§ç¼“å­˜æ˜¯å¦æœ‰è¯¥ç›®å‰çš„beanï¼Œä½†ä¸ä¼šåˆ°ä¸‰çº§ç¼“å­˜ä¸­è·å–ï¼Œç›®çš„æ˜¯é˜²æ­¢beanæå‰åˆ›å»ºä»£ç†ååœ¨äºŒçº§ç¼“å­˜ä¸­çš„é—æ¼\r\n\t\t\tObject earlySingletonReference = getSingleton(beanName, false);\r\n\t\t\tif (earlySingletonReference != null) {\r\n\t\t\t\tif (exposedObject == bean) {\r\n                      //é˜²æ­¢äºŒçº§ç¼“å­˜é—æ¼ï¼Œè‹¥æå‰åˆ›å»ºäº†ä»£ç†ç›´æ¥æ”¹å˜å¼•ç”¨å³å¯ï¼Œå¦åˆ™å°±æ˜¯åŸå§‹å¯¹è±¡äº†ï¼ˆæå‰åˆ›å»ºä»£ç†å‘ç”Ÿåœ¨doGetBeanä¸€å¼€å§‹è°ƒç”¨çš„getSingleton(beanName)ï¼Œæ­¤æ–¹æ³•å°±ä¼šåœ¨ä¸‰çº§ç¼“å­˜singletonFactorieså¯¹è¦æ³¨å…¥çš„beanè¿›è¡Œæå‰åˆ›å»ºä»£ç†ï¼Œæˆ–è€…è¯´Bè¦æ³¨å…¥Aæ—¶ï¼Œï¼‰\r\n\t\t\t\t\texposedObject = earlySingletonReference;\r\n\t\t\t\t}\r\n                 //åˆå§‹åŒ–é˜¶æ®µå°±åˆ›å»ºä»£ç†äº†ï¼Œç›´æ¥è¿”å›ä»£ç†å¯¹è±¡\r\n\t\t\t\telse if (!this.allowRawInjectionDespiteWrapping && hasDependentBean(beanName)) {\r\n\t\t\t\t\t...\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n...\r\n```\r\n\r\n\r\n\r\n- setå¾ªç¯ä¾èµ– - äºŒçº§ç¼“å­˜ä½œç”¨2\r\n\r\n![image-20230423163506278](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423163506278.png)\r\n\r\n- setå¾ªç¯ä¾èµ– - å¦‚ä½•é¿å…é‡å¤åˆ›å»ºä»£ç†\r\n\r\n![image-20230423163952262](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423163952262.png)\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n### æ€»ç»“\r\n\r\n- å•ä¾‹ set æ–¹æ³•(åŒ…æ‹¬æˆå‘˜å˜é‡)å¾ªç¯ä¾èµ–ï¼ŒSpring ä¼šåˆ©ç”¨ä¸‰çº§ç¼“å­˜è§£å†³ï¼Œæ— éœ€é¢å¤–é…ç½®\r\n  - ä¸€çº§ç¼“å­˜å­˜æ”¾æˆå“å¯¹è±¡\r\n  - äºŒçº§ç¼“å­˜å­˜æ”¾å‘ç”Ÿäº†å¾ªç¯ä¾èµ–æ—¶çš„äº§å“å¯¹è±¡ (å¯èƒ½æ˜¯åŸå§‹ beanï¼Œä¹Ÿå¯èƒ½æ˜¯ä»£ç† bean)\r\n  - ä¸‰çº§ç¼“å­˜å­˜æ”¾å·¥å‚å¯¹è±¡ï¼Œå‘ç”Ÿå¾ªç¯ä¾èµ–æ—¶ï¼Œä¼šè°ƒç”¨å·¥å‚è·å–äº§å“\r\n  - Spring æœŸæœ›åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºä»£ç†ï¼Œä½†å¦‚æœå‘ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼Œä¼šç”±å·¥å‚æå‰åˆ›å»ºä»£ç†ï¼Œåç»­åˆå§‹åŒ–æ—¶å°±ä¸å¿…é‡å¤åˆ›å»ºä»£ç†\r\n  - äºŒçº§ç¼“å­˜çš„æ„ä¹‰åœ¨äºï¼Œå¦‚æœæå‰åˆ›å»ºäº†ä»£ç†å¯¹è±¡ï¼Œåœ¨æœ€åçš„é˜¶æ®µéœ€è¦ä»äºŒçº§ç¼“å­˜ä¸­è·å–æ­¤ä»£ç†å¯¹è±¡ï¼Œä½œä¸ºæœ€ç»ˆç»“æœ\r\n- æ„é€ æ–¹æ³•åŠå¤šä¾‹å¾ªç¯ä¾èµ–è§£å†³åŠæ³•\r\n  - @Lazy\r\n  - @Scope\r\n  - ObjectFactory & ObjectProvider\r\n  - Provider\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n## 4. Spring äº‹åŠ¡å¤±æ•ˆ\r\n\r\n### **1. æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸å¯¼è‡´äº‹åŠ¡ä¸èƒ½æ­£ç¡®å›æ»š**\r\n\r\n* é—®é¢˜ï¼šå‡ºç°äº†æ•°æ®ä¸ä¸€è‡´æƒ…å†µï¼ˆæ€»é‡‘é¢2000=>1500ï¼Œè¢«ç³»ç»Ÿåƒäº†500ï¼‰\r\n\r\n* åŸå› ï¼šSpring é»˜è®¤åªä¼šå›æ»šéæ£€æŸ¥å¼‚å¸¸\r\n\r\n* è§£æ³•ï¼šé…ç½® rollbackFor å±æ€§\r\n  * `@Transactional(rollbackFor = Exception.class)`\r\n\r\n![image-20230422140026927](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422140026927.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **2. ä¸šåŠ¡æ–¹æ³•å†…è‡ªå·± try-catch å¼‚å¸¸å¯¼è‡´äº‹åŠ¡ä¸èƒ½æ­£ç¡®å›æ»š**\r\n\r\n* é—®é¢˜ï¼šå‡ºç°äº†æ•°æ®ä¸ä¸€è‡´æƒ…å†µï¼ˆæ€»é‡‘é¢2000=>1500ï¼Œè¢«ç³»ç»Ÿåƒäº†500ï¼‰\r\n\r\n* åŸå› ï¼šäº‹åŠ¡é€šçŸ¥åªæœ‰æ‰åˆ°äº†ç›®æ ‡æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„å›æ»šå¤„ç†ï¼Œå¦‚æœç›®æ ‡è‡ªå·±å¤„ç†æ‰å¼‚å¸¸ï¼Œäº‹åŠ¡é€šçŸ¥æ— æ³•çŸ¥æ‚‰\r\n\r\n* è§£æ³•1ï¼šå¼‚å¸¸åŸæ ·æŠ›å‡º\r\n  * åœ¨ catch å—æ·»åŠ  `throw new RuntimeException(e);`\r\n\r\n* è§£æ³•2ï¼šæ‰‹åŠ¨è®¾ç½® `TransactionStatus.setRollbackOnly()`\r\n  * åœ¨ catch å—æ·»åŠ  `TransactionInterceptor.currentTransactionStatus().setRollbackOnly();`\r\n\r\n![image-20230422140710210](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422140710210.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **3. aop åˆ‡é¢é¡ºåºå¯¼è‡´å¯¼è‡´äº‹åŠ¡ä¸èƒ½æ­£ç¡®å›æ»š**\r\n\r\n* åŸå› ï¼šäº‹åŠ¡åˆ‡é¢ä¼˜å…ˆçº§æœ€ä½ï¼Œä½†å¦‚æœè‡ªå®šä¹‰çš„åˆ‡é¢ä¼˜å…ˆçº§å’Œä»–ä¸€æ ·ï¼Œåˆ™è¿˜æ˜¯è‡ªå®šä¹‰åˆ‡é¢åœ¨å†…å±‚ï¼Œè¿™æ—¶è‹¥è‡ªå®šä¹‰åˆ‡é¢æ²¡æœ‰æ­£ç¡®æŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡ä¹Ÿä¸ä¼šå›æ»š\r\n\r\n* è§£æ³•1ã€2ï¼šåŒæƒ…å†µ2 ä¸­çš„è§£æ³•:1ã€2\r\n* è§£æ³•3ï¼šè°ƒæ•´åˆ‡é¢é¡ºåºï¼Œåœ¨ MyAspect ä¸Šæ·»åŠ  `@Order(Ordered.LOWEST_PRECEDENCE - 1)` ï¼ˆä¸æ¨èï¼‰\r\n\r\n![image-20230422141539702](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422141539702.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **4. é public æ–¹æ³•å¯¼è‡´çš„äº‹åŠ¡å¤±æ•ˆ**\r\n\r\n* åŸå› ï¼šSpring ä¸ºæ–¹æ³•åˆ›å»ºä»£ç†ã€æ·»åŠ äº‹åŠ¡é€šçŸ¥ã€å‰ææ¡ä»¶éƒ½æ˜¯è¯¥æ–¹æ³•æ˜¯ public çš„ï¼›å› ä¸ºSpringä¸­æœ‰ä¸ªæ£€æŸ¥ï¼Œå®ƒå‘ç°ä½ çš„æ–¹æ³•ä¸æ˜¯publicï¼Œå»è¯»å–äº‹åŠ¡çš„å±æ€§æ—¶å°±ä¼šè¿”å›nullï¼Œå³ä¸ä¼šè¿”å›äº‹åŠ¡çš„å±æ€§ï¼Œä»è€Œä¸ä¼šåŠ è¿™äº›äº‹åŠ¡çš„ç›¸å…³é…ç½®\r\n\r\n* è§£æ³•1ï¼šæ”¹ä¸º public æ–¹æ³•\r\n* è§£æ³•2ï¼šæ·»åŠ  bean é…ç½®å¦‚ä¸‹ï¼ˆä¸æ¨èï¼‰\r\n\r\n```java\r\n@Bean\r\npublic TransactionAttributeSource transactionAttributeSource() {\r\n    return new AnnotationTransactionAttributeSource(false);\r\n}\r\n```\r\n\r\n![image-20230422141914663](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422141914663.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **5. çˆ¶å­å®¹å™¨å¯¼è‡´çš„äº‹åŠ¡å¤±æ•ˆ**\r\n\r\nç°åœ¨é…ç½®äº†çˆ¶å­å®¹å™¨ï¼ŒWebConfig å¯¹åº”å­å®¹å™¨ï¼ŒAppConfig å¯¹åº”çˆ¶å®¹å™¨ï¼Œå‘ç°äº‹åŠ¡ä¾ç„¶å¤±æ•ˆ\r\n\r\n* åŸå› ï¼šå­å®¹å™¨æ‰«æèŒƒå›´è¿‡å¤§ï¼Œæœ¬æ¥åªéœ€æ‰«æcontrollerï¼Œä½†æ˜¯æŠŠserviceä¹Ÿæ‰«äº†è¿›æ¥ï¼Œserviceè™½ç„¶æœ‰äº‹åŠ¡æ³¨è§£ï¼Œä½†æ˜¯å­å®¹å™¨é…ç½®ç±»å¹¶æ²¡æœ‰å¼€å¯äº‹åŠ¡é…ç½®ï¼Œå› æ­¤äº‹åŠ¡å¤±æ•ˆ\r\n\r\n![image-20231205214825213](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231205214825213.png)\r\n\r\n* è§£æ³•1ï¼šå„æ‰«æå„çš„ï¼Œä¸è¦å›¾ç®€ä¾¿\r\n\r\n* è§£æ³•2ï¼šä¸è¦ç”¨çˆ¶å­å®¹å™¨ï¼Œæ‰€æœ‰ bean æ”¾åœ¨åŒä¸€å®¹å™¨\r\n\r\n![image-20230422143148085](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422143148085.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **6. â˜…è°ƒç”¨æœ¬ç±»æ–¹æ³•å¯¼è‡´ä¼ æ’­è¡Œä¸ºå¤±æ•ˆâ˜…**\r\n\r\n```java\r\n@Transactional\r\npublic void foo(){\r\n    bar();\r\n}\r\n@Transactional\r\npublic void bar(){\r\n}\r\n```\r\n\r\n* åŸå› ï¼šæœ¬ç±»æ–¹æ³•è°ƒç”¨ä¸ç»è¿‡ä»£ç†ï¼Œå› æ­¤æ— æ³•å¢å¼º\r\n\r\n* è§£æ³•1ï¼šä¾èµ–æ³¨å…¥è‡ªå·±ï¼ˆä»£ç†ï¼‰æ¥è°ƒç”¨\r\n\r\n* è§£æ³•2ï¼šé€šè¿‡ AopContext æ‹¿åˆ°ä»£ç†å¯¹è±¡ï¼Œæ¥è°ƒç”¨ï¼ˆä»£ç†æ¨¡å¼æ˜¯åœ¨è¿è¡ŒæœŸé—´ç”Ÿæˆä¸€äº›ä»£ç†çš„æ–°çš„å­—èŠ‚ç æ¥å®ç°åŠŸèƒ½çš„å¢å¼ºï¼‰\r\n\r\n* è§£æ³•3ï¼šé€šè¿‡ CTWï¼ˆç¼–è¯‘æ—¶ç»‡å…¥ï¼‰ï¼ŒLTW ï¼ˆåŠ è½½æ—¶ç»‡å…¥ï¼‰å®ç°åŠŸèƒ½å¢å¼ºï¼ˆåŸç†éƒ½æ˜¯ä¿®æ”¹ç±»çš„å­—èŠ‚ç æ¥å®ç°åŠŸèƒ½å¢å¼ºï¼‰\r\n\r\nè§£æ³•1\r\n\r\n```java\r\n@Service\r\npublic class Service6 {\r\n\t@Autowired\r\n\tprivate Service6 proxy; // æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å¾ªç¯ä¾èµ–\r\n    @Transactional\r\n    public void foo()  {\r\n\t\tproxy.bar();\r\n    }\r\n    @Transactional\r\n    public void bar() {\r\n    }\r\n}\r\n```\r\n\r\nè§£æ³•2ï¼Œè¿˜éœ€è¦åœ¨ AppConfig ä¸Šæ·»åŠ  `@EnableAspectJAutoProxy(exposeProxy = true)`\r\n\r\n```java\r\n@Service\r\npublic class Service6 {\r\n    @Transactional\r\n    public void foo(){\r\n\t\t((Service6) AopContext.currentProxy()).bar();\r\n    }\r\n    @Transactional\r\n    public void bar(){\r\n    }\r\n}\r\n```\r\n\r\n![image-20230422143959797](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422143959797.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **7. @Transactional æ²¡æœ‰ä¿è¯åŸå­è¡Œä¸º**\r\n\r\n```java\r\n@Transactional(rollbackFor = Exception.class)\r\npublic void transfer(int from, int to, int amount) {\r\n    int fromBalance = accountMapper.findBalanceBy(from);\r\n    logger.debug(\"æ›´æ–°å‰æŸ¥è¯¢ä½™é¢ä¸º: {}\", fromBalance);\r\n    if (fromBalance - amount >= 0) {\r\n        accountMapper.update(from, -1 * amount);\r\n        accountMapper.update(to, amount);\r\n    }\r\n}\r\n```\r\n\r\nä¸Šé¢çš„ä»£ç å®é™…ä¸Šæ˜¯æœ‰ bug çš„ï¼Œå‡è®¾ from ä½™é¢ä¸º 1000ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½æ¥è½¬è´¦ 1000ï¼Œå¯èƒ½ä¼šå‡ºç°æ‰£å‡ä¸ºè´Ÿæ•°çš„æƒ…å†µ\r\n\r\n* åŸå› ï¼šäº‹åŠ¡çš„åŸå­æ€§ä»…æ¶µç›– insertã€updateã€deleteã€select â€¦ for update è¯­å¥ï¼Œselect æ–¹æ³•å¹¶ä¸é˜»å¡\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903120436365.png\" alt=\"image-20210903120436365\" class=\"scale-50\" />\r\n\r\n* å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œçº¢è‰²çº¿ç¨‹å’Œè“è‰²çº¿ç¨‹çš„æŸ¥è¯¢éƒ½å‘ç”Ÿåœ¨æ‰£å‡ä¹‹å‰ï¼Œéƒ½ä»¥ä¸ºè‡ªå·±æœ‰è¶³å¤Ÿçš„ä½™é¢åšæ‰£å‡\r\n\r\n![image-20230422144457753](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422144457753.png)\r\n\r\n\r\n\r\n------\r\n\r\n### **8. â˜…@Transactional æ–¹æ³•å¯¼è‡´çš„ synchronized å¤±æ•ˆâ˜…**\r\n\r\né’ˆå¯¹ä¸Šé¢çš„é—®é¢˜ï¼Œèƒ½å¦åœ¨æ–¹æ³•ä¸ŠåŠ  synchronized é”æ¥è§£å†³å‘¢ï¼Ÿ\r\n\r\nç­”æ¡ˆæ˜¯ä¸è¡Œï¼ŒåŸå› å¦‚ä¸‹ï¼š\r\n\r\n* synchronized ä¿è¯çš„ä»…æ˜¯ç›®æ ‡æ–¹æ³•çš„åŸå­æ€§ï¼Œç¯ç»•ç›®æ ‡æ–¹æ³•çš„è¿˜æœ‰ commit ç­‰æ“ä½œï¼Œå®ƒä»¬å¹¶æœªå¤„äº sync å—å†…\r\n* å¯ä»¥å‚è€ƒä¸‹å›¾å‘ç°ï¼Œè“è‰²çº¿ç¨‹çš„æŸ¥è¯¢åªè¦åœ¨çº¢è‰²çº¿ç¨‹æäº¤ä¹‹å‰æ‰§è¡Œï¼Œé‚£ä¹ˆä¾ç„¶ä¼šæŸ¥è¯¢åˆ°æœ‰ 1000 è¶³å¤Ÿä½™é¢æ¥è½¬è´¦ï¼ˆå®é™…å·²ç»æ‰£è¿‡1000äº†ï¼Œé‚£ä¹ˆæœ€ç»ˆç»“æœå°±æ˜¯ -1000ï¼‰\r\n\r\n![image-20210903120800185](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903120800185.png)\r\n\r\n* è§£æ³•1ï¼šsynchronized èŒƒå›´åº”æ‰©å¤§è‡³ä»£ç†æ–¹æ³•è°ƒç”¨ï¼ˆDEBUGæ¥Commitï¼‰\r\n\r\n![image-20230422145400664](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422145400664.png)\r\n\r\n* è§£æ³•2ï¼šä½¿ç”¨ select â€¦ for update æ›¿æ¢ selectï¼ˆæ¨èä½¿ç”¨æ•°æ®åº“å±‚é¢æ¥è§£å†³ï¼‰\r\n\r\n![image-20230422145452610](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422145452610.png)\r\n\r\n\r\n\r\n------\r\n\r\n## 5. Spring MVC æ‰§è¡Œæµç¨‹\r\n\r\n**æ¦‚è¦**\r\n\r\næˆ‘æŠŠæ•´ä¸ªæµç¨‹åˆ†æˆä¸‰ä¸ªé˜¶æ®µ\r\n\r\n- åˆå§‹åŒ–é˜¶æ®µ\r\n- åŒ¹é…é˜¶æ®µ\r\n- æ‰§è¡Œé˜¶æ®µ\r\n\r\n### **åˆå§‹åŒ–é˜¶æ®µ**\r\n\r\n![image-20231206162537789](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231206162537789.png)\r\n\r\n1. åœ¨ Web å®¹å™¨ç¬¬ä¸€æ¬¡ç”¨åˆ° DispatcherServlet çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºå…¶å¯¹è±¡å¹¶æ‰§è¡Œ init æ–¹æ³•\r\n\r\n2. init æ–¹æ³•å†…ä¼šåˆ›å»º Spring Web å®¹å™¨ï¼Œå¹¶è°ƒç”¨å®¹å™¨ refresh æ–¹æ³•\r\n\r\n3. refresh è¿‡ç¨‹ä¸­ä¼šåˆ›å»ºå¹¶åˆå§‹åŒ– SpringMVC ä¸­çš„é‡è¦ç»„ä»¶ï¼Œ ä¾‹å¦‚ MultipartResolverï¼ŒHandlerMappingï¼ŒHandlerAdapterï¼ŒHandlerExceptionResolverã€ViewResolver ç­‰\r\n\r\n4. å®¹å™¨åˆå§‹åŒ–åï¼Œä¼šå°†ä¸Šä¸€æ­¥åˆå§‹åŒ–å¥½çš„é‡è¦ç»„ä»¶ï¼Œèµ‹å€¼ç»™ DispatcherServlet çš„æˆå‘˜å˜é‡ï¼Œä¾›åç»­ä½¿ç”¨\r\n\r\n![](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903140657163.png)\r\n\r\n![image-20230422150617027](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422150617027.png)\r\n\r\n> - **DispatcherServlet** æ˜¯ SpringMVC ä¸­çš„ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„ç±»ï¼Œç”± web å®¹å™¨(tomcat)åˆ›å»ºå’Œåˆå§‹åŒ–ï¼Œä¼ ç»Ÿçš„ SpringMVC è·Ÿ Spring æ•´åˆçš„æ—¶å€™è¿˜æ˜¯ç”± Tomcat æ¥åˆ›å»ºå®ƒçš„ï¼Œå½“ç„¶ï¼Œåˆ°äº† SpringBoot é‡Œï¼Œè¿™ä¸ª DispatcherServlet å°±æœ‰å¯èƒ½ç”± Spring å®¹å™¨è‡ªèº«æ¥åˆ›å»ºå’Œåˆå§‹åŒ–\r\n> - é™¤ MultipartResovler å¯èƒ½åªæœ‰ä¸€ä¸ªå®ä¾‹ä»¥å¤–ï¼Œå…¶ä»–çš„é‡è¦ç»„ä»¶åŒä¸€ä¸ªç±»å‹å¯èƒ½æœ‰å¤šä¸ªå®ä¾‹å¯¹è±¡å­˜åœ¨è¿™ä¸ª Spring å®¹å™¨ä¸­\r\n> - **HandlerMapping** æ˜¯åšè¯·æ±‚æ˜ å°„çš„ï¼Œå°±æ˜¯æ ¹æ®ä½ çš„è¯·æ±‚è·¯å¾„æ‰¾åˆ°ä¸€ä¸ªå¯¹åº”çš„æ§åˆ¶å™¨å’Œå®ƒç›¸å…³çš„æ–¹æ³•æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œå°±æ˜¯æŠŠæµè§ˆå™¨çš„è¯·æ±‚æ˜ å°„åˆ°æˆ‘ä»¬ Spring ä¸­ä¸€ä¸ªæ§åˆ¶å™¨çš„æ–¹æ³•è°ƒç”¨ä¸Š\r\n> - **HandlerAdapter** å°±æ˜¯è´Ÿè´£çœŸæ­£å»è°ƒç”¨è¿™ä¸ªæ§åˆ¶å™¨çš„æ§åˆ¶æ–¹æ³•æ¥å¤„ç†è¯·æ±‚ï¼Œå¦‚æœåœ¨è°ƒç”¨è¿™ä¸ªæ§åˆ¶å™¨çš„æ§åˆ¶æ–¹æ³•çš„è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸æ—¶ç”±**HandlerExceptionResovler**æ¥å¤„ç†å¼‚å¸¸ï¼Œæœ€ç»ˆè¿™ä¸ªæ§åˆ¶æ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼Œå°±ä¼šå°è£…æˆä¸€ä¸ª ModelAndView å¯¹è±¡ï¼Œä½†è¿™ä¸ªå¯¹è±¡ä¸­çš„è§†å›¾å¯èƒ½åªåŒ…å«ä¸€ä¸ªå­—ç¬¦ä¸²çš„åå­—ï¼Œé‚£æˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªå­—ç¬¦ä¸²çš„åå­—å»è§£ææˆä¸€ä¸ªè§†å›¾å¯¹è±¡ç”± **ViewResovler** è´Ÿè´£æŠŠåå­—è§£ææˆè§†å›¾å¯¹è±¡ï¼Œè§†å›¾å¯¹è±¡å†…éƒ¨å°±å¯ä»¥æ ¹æ®ä¸åŒçš„å®ç°å»é€‰æ‹©æ˜¯è·³è½¬åˆ°JSPè¿˜æ˜¯è·³è½¬åˆ°ä¸€äº›æ¨¡æ¿å¼•æ“ï¼Œå»æ‰§è¡Œè¿™ä¸ªè§†å›¾çš„æ¸²æŸ“å·¥ä½œ\r\n> - æœ€åçš„è¿™ä¸ª **MultipartResovler** å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œå®ƒæ˜¯ç”¨åœ¨æ–‡ä»¶çš„ä¸Šä¼ æ—¶å¤„ç†è¿™ç§ Multipart æ ¼å¼çš„è¡¨å•æ•°æ®\r\n>\r\n> **Spring MVC çš„æ ¸å¿ƒç»„ä»¶**ï¼Ÿ\r\n>\r\n> 1. **DispatcherServlet**ï¼šå‰ç½®æ§åˆ¶å™¨ï¼Œæ˜¯æ•´ä¸ªæµç¨‹æ§åˆ¶çš„**æ ¸å¿ƒ**ï¼Œæ§åˆ¶å…¶ä»–ç»„ä»¶çš„æ‰§è¡Œï¼Œè¿›è¡Œç»Ÿä¸€è°ƒåº¦ï¼Œé™ä½ç»„ä»¶ä¹‹é—´çš„è€¦åˆæ€§ï¼Œç›¸å½“äºæ€»æŒ‡æŒ¥ã€‚\r\n> 2. **Handler**ï¼šå¤„ç†å™¨ï¼Œå®Œæˆå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œç›¸å½“äº Servlet æˆ– Actionã€‚\r\n> 3. **HandlerMapping**ï¼šDispatcherServlet æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œé€šè¿‡ HandlerMapping å°†ä¸åŒçš„è¯·æ±‚æ˜ å°„åˆ°ä¸åŒçš„ Handlerã€‚\r\n> 4. **HandlerInterceptor**ï¼šå¤„ç†å™¨æ‹¦æˆªå™¨ï¼Œæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¦‚æœéœ€è¦å®Œæˆä¸€äº›æ‹¦æˆªå¤„ç†ï¼Œå¯ä»¥å®ç°è¯¥æ¥å£ã€‚\r\n> 5. **HandlerExecutionChain**ï¼šå¤„ç†å™¨æ‰§è¡Œé“¾ï¼ŒåŒ…æ‹¬ä¸¤éƒ¨åˆ†å†…å®¹ï¼šHandler å’Œ HandlerInterceptorï¼ˆç³»ç»Ÿä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„ HandlerInterceptorï¼Œå¦‚æœéœ€è¦é¢å¤–è®¾ç½®æ‹¦æˆªï¼Œå¯ä»¥æ·»åŠ æ‹¦æˆªå™¨ï¼‰ã€‚\r\n> 6. **HandlerAdapter**ï¼šå¤„ç†å™¨é€‚é…å™¨ï¼ŒHandler æ‰§è¡Œä¸šåŠ¡æ–¹æ³•ä¹‹å‰ï¼Œéœ€è¦è¿›è¡Œä¸€ç³»åˆ—çš„æ“ä½œï¼ŒåŒ…æ‹¬è¡¨å•æ•°æ®çš„éªŒè¯ã€æ•°æ®ç±»å‹çš„è½¬æ¢ã€å°†è¡¨å•æ•°æ®å°è£…åˆ° JavaBean ç­‰ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯ç”± HandlerApater æ¥å®Œæˆï¼Œå¼€å‘è€…åªéœ€å°†æ³¨æ„åŠ›é›†ä¸­ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ä¸Šï¼ŒDispatcherServlet é€šè¿‡ HandlerAdapter æ‰§è¡Œä¸åŒçš„ Handlerã€‚\r\n> 7. **ModelAndView**ï¼šè£…è½½äº†æ¨¡å‹æ•°æ®å’Œè§†å›¾ä¿¡æ¯ï¼Œä½œä¸º Handler çš„å¤„ç†ç»“æœï¼Œè¿”å›ç»™ DispatcherServletã€‚\r\n> 8. **ViewResolver**ï¼šè§†å›¾è§£æå™¨ï¼ŒDispatcheServlet é€šè¿‡å®ƒå°†é€»è¾‘è§†å›¾è§£æä¸ºç‰©ç†è§†å›¾ï¼Œæœ€ç»ˆå°†æ¸²æŸ“ç»“æœå“åº”ç»™å®¢æˆ·ç«¯ã€‚\r\n\r\n\r\n\r\n------\r\n\r\n### **åŒ¹é…é˜¶æ®µ**\r\n\r\n1. ç”¨æˆ·å‘é€çš„è¯·æ±‚ç»Ÿä¸€åˆ°è¾¾å‰ç«¯æ§åˆ¶å™¨ DispatcherServlet\r\n\r\n2. DispatcherServlet éå†æ‰€æœ‰ HandlerMapping ï¼Œæ‰¾åˆ°ä¸è·¯å¾„åŒ¹é…çš„å¤„ç†å™¨\r\n\r\n   â‘  HandlerMapping æœ‰å¤šä¸ªï¼Œæ¯ä¸ª HandlerMapping ä¼šè¿”å›ä¸åŒçš„å¤„ç†å™¨å¯¹è±¡ï¼Œè°å…ˆåŒ¹é…ï¼Œè¿”å›è°çš„å¤„ç†å™¨ã€‚å…¶ä¸­èƒ½è¯†åˆ« @RequestMapping çš„ä¼˜å…ˆçº§æœ€é«˜\r\n\r\n   â‘¡ å¯¹åº” @RequestMapping çš„å¤„ç†å™¨æ˜¯ HandlerMethodï¼Œå®ƒåŒ…å«äº†æ§åˆ¶å™¨å¯¹è±¡å’Œæ§åˆ¶å™¨æ–¹æ³•ä¿¡æ¯\r\n\r\n   â‘¢ å…¶ä¸­è·¯å¾„ä¸å¤„ç†å™¨çš„æ˜ å°„å…³ç³»åœ¨ HandlerMapping åˆå§‹åŒ–æ—¶å°±ä¼šå»ºç«‹å¥½\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141017502.png\" alt=\"image-20210903141017502\" class=\"scale-80\" />\r\n\r\n3. å°† HandlerMethod è¿åŒåŒ¹é…åˆ°çš„æ‹¦æˆªå™¨ï¼Œç”Ÿæˆè°ƒç”¨é“¾å¯¹è±¡ HandlerExecutionChain è¿”å›\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141124911.png\" alt=\"image-20210903141124911\" class=\"scale-80\" />\r\n\r\n4. éå†HandlerAdapter å¤„ç†å™¨é€‚é…å™¨ï¼Œæ‰¾åˆ°èƒ½å¤„ç† HandlerMethod çš„é€‚é…å™¨å¯¹è±¡ï¼Œå¼€å§‹è°ƒç”¨\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141204799.png\" alt=\"image-20210903141204799\" class=\"scale-80\" />\r\n\r\n![image-20230422151134584](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422151134584.png)\r\n\r\n> - DispatcherServletä¸»è¦èŒè´£æ˜¯ä½œä¸ºä¸€ä¸ªå·¦è¯·æ±‚çš„å…¥å£ï¼Œä½†æ˜¯æ¥ä¸‹æ¥å¤„ç†è¯·æ±‚æ˜¯äº¤ç»™å…¶ä»–ä¸€äº›å¤„ç†å™¨å¯¹è±¡æ¥å®Œæˆï¼Œå®ƒå¹¶ä¸è´Ÿè´£å¤„ç†å…·ä½“çš„è¯·æ±‚ï¼Œå› æ­¤æ¥ä¸‹æ¥ä¼šéå†æ‰€æœ‰çš„HandlerMappingï¼Œå€ŸåŠ©è¿™ä¸ªHandlerMappingæ‰¾åˆ°ä¸å½“å‰è·¯å¾„èƒ½å¤ŸåŒ¹é…çš„å¤„ç†å™¨ï¼Œç”±å¤„ç†å™¨å¯¹è±¡æ¥å¤„ç†è¯·æ±‚ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªè¯·æ±‚è¿”å›å¤šä¸ªå¤„ç†å™¨ï¼Œæœ€ç»ˆåªèƒ½ä¸€ä¸ªè¯·æ±‚ç”±ä¸€ä¸ªå¤„ç†å™¨å¯¹è±¡è¿›è¡Œå¤„ç†ï¼Œå³è°å…ˆä¸å½“å‰è·¯å¾„åŒ¹é…ä¸Šï¼Œå°±è¿”å›è°çš„å¤„ç†\r\n> - @RequestMappingå¯¹åº”çš„å¤„ç†å™¨å¯¹è±¡HandlerMethodï¼Œå®ƒåŒ…å«äº†å®ƒå±äºå“ªä¸ªcontrollerå¯¹è±¡ä»¥åŠå¯¹åº”çš„controlleræ–¹æ³•çš„è¿™äº›ä¿¡æ¯ï¼Œé€šè¿‡HandlerMethodå¯ä»¥å¾—åˆ°å®ƒå°†æ¥è¦è°ƒç”¨å“ªä¸ªcontrollerå¯¹è±¡å’Œè°ƒç”¨å“ªä¸ªcontrolleræ–¹æ³•ï¼Œå³åå°„è°ƒç”¨\r\n\r\n\r\n\r\n------\r\n\r\n### **è°ƒç”¨é˜¶æ®µ**\r\n\r\n1. æ‰§è¡Œæ‹¦æˆªå™¨ preHandle\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141445870.png\" alt=\"image-20210903141445870\" class=\"scale-67\" />\r\n\r\n2. ç”± HandlerAdapter è°ƒç”¨ HandlerMethod\r\n\r\n   â‘  è°ƒç”¨å‰å¤„ç†ä¸åŒç±»å‹çš„å‚æ•°\r\n\r\n   â‘¡ è°ƒç”¨åå¤„ç†ä¸åŒç±»å‹çš„è¿”å›å€¼\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141658199.png\" alt=\"image-20210903141658199\" class=\"scale-67\" />\r\n\r\n3. ç¬¬ 2 æ­¥æ²¡æœ‰å¼‚å¸¸\r\n\r\n   â‘  è¿”å› ModelAndView\r\n\r\n   â‘¡ æ‰§è¡Œæ‹¦æˆªå™¨ postHandle æ–¹æ³•\r\n\r\n   â‘¢ è§£æè§†å›¾ï¼Œå¾—åˆ° View å¯¹è±¡ï¼Œè¿›è¡Œè§†å›¾æ¸²æŸ“\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141749830.png\" alt=\"image-20210903141749830\" class=\"scale-67\" />\r\n\r\n4. ç¬¬ 2 æ­¥æœ‰å¼‚å¸¸ï¼Œè¿›å…¥ HandlerExceptionResolver å¼‚å¸¸å¤„ç†æµç¨‹\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210903141844185.png\" alt=\"image-20210903141844185\" class=\"scale-67\" />\r\n\r\n5. æœ€åéƒ½ä¼šæ‰§è¡Œæ‹¦æˆªå™¨çš„ afterCompletion æ–¹æ³•\r\n\r\n6. å¦‚æœæ§åˆ¶å™¨æ–¹æ³•æ ‡æ³¨äº† @ResponseBody æ³¨è§£ï¼Œåˆ™åœ¨ç¬¬ 2 æ­¥ï¼Œå°±ä¼šç”Ÿæˆ json ç»“æœï¼Œå¹¶æ ‡è®° ModelAndView å·²å¤„ç†ï¼Œè¿™æ ·å°±ä¸ä¼šæ‰§è¡Œç¬¬ 3 æ­¥çš„è§†å›¾æ¸²æŸ“\r\n\r\n![image-20230426024421958](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426024421958.png)\r\n\r\n> - æ‰§è¡Œé˜¶æ®µé¦–å…ˆä¼šè°ƒç”¨æ‰§è¡Œé“¾ä¸­çš„æ‹¦æˆªå™¨çš„ preHandle æ–¹æ³•ï¼Œ**ç”±å¤–åˆ°å†…ä¾æ¬¡è°ƒç”¨**ï¼Œè°ƒç”¨è¿™ä¸ª preHandle æ–¹æ³•çš„æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæœ‰ä¸€ä¸ªè¿”å›å€¼ï¼Œè¿”å›å€¼ä¸ºçœŸè¡¨ç¤ºæ”¾è¡Œï¼Œä¼šè¿›è¡Œåç»­çš„è°ƒç”¨ï¼Œä¸ºå‡è¡¨ç¤ºè¢«æ‹¦æˆªå™¨æ‹¦æˆªä¸‹æ¥äº†ï¼Œå°±ä¸ä¼šå¾€åèµ°äº†\r\n> - HandlerAdapter è°ƒç”¨ HandlerMethodï¼Œè™½ç„¶çŸ¥é“å“ªä¸ªbeançš„å“ªä¸ªæ–¹æ³•ï¼Œä½†æ˜¯æ–¹æ³•è°ƒç”¨ä¹‹å‰å¾—ç»™æ–¹æ³•å‡†å¤‡æ‰€æœ‰çš„å‚æ•°ï¼Œå› ä¸ºæ§åˆ¶å™¨æ–¹æ³•çš„å‚æ•°æ˜¯ååˆ†å¤æ‚çš„ï¼Œå¤šç§å¤šæ ·ï¼Œæ—¢å¯ä»¥æ˜¯ Requestã€Responeã€Sessionä¹‹ç±»ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€äº›æ¨¡å‹ï¼Œmodel å¯¹è±¡ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯æ–¹æ³•çš„å‚æ•°æ¥è‡ªäºè¯·æ±‚å‚æ•°ï¼Œè·¯å¾„å‚æ•°ï¼Œå„ç§æƒ…å†µéƒ½æœ‰ï¼Œä½ å¾—æŠŠè¿™äº›å‚æ•°è¿›è¡Œä¸€ä¸ªè§£æï¼ŒæŠŠå‚æ•°éƒ½å‡†å¤‡å¥½äº†ï¼Œå°±å¯ä»¥åå°„è°ƒç”¨è¿™ä¸ª HandlerMethod ä¸­çš„ method æ–¹æ³•ï¼Œé€šè¿‡ method çš„åå°„è°ƒç”¨æ‰§è¡Œ invoke æ–¹æ³•ï¼Œç„¶åæŠŠ bean ä¼ è¿›å»ï¼ŒæŠŠåˆšæ‰å‡†å¤‡å¥½çš„å‚æ•°ä¼ å…¥ invoke æ–¹æ³•å¹¶æ‰§è¡Œï¼Œè¿™æ ·å°±å®Œæˆäº†æ§åˆ¶å™¨æ–¹æ³•çš„ä¸€ä¸ªè°ƒç”¨ï¼Œç­‰è°ƒç”¨ç»“æŸåè¿˜è¦å¤„ç†è¿”å›å€¼ï¼Œè¿™ä¸ªæ§åˆ¶å™¨æ–¹æ³•çš„è¿”å›å€¼ä¹Ÿæ˜¯å¤šç§å¤šæ ·ï¼Œæœ‰å¯èƒ½è¿”å›çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼ŒMap é›†åˆï¼ŒList é›†åˆï¼Œæˆ–è€… JavaBeanï¼Œéƒ½æœ‰å¯èƒ½ï¼Œå› æ­¤è¿˜è¦å¯¹è¿™ä¸ªè¿”å›å€¼è¿›è¡Œä¸€ä¸ªå¤„ç†ï¼Œé‚£è¿”å›å€¼å¤„ç†å®Œäº†ï¼Œè¿™ä¸ªè°ƒç”¨å°±æš‚æ—¶ç»“æŸäº†\r\n> - ç»“æŸä¹‹ååˆ†æˆä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æ²¡æœ‰å¼‚å¸¸ï¼Œä¸€ç§æ˜¯æœ‰å¼‚å¸¸\r\n>   - æ²¡æœ‰å¼‚å¸¸\r\n>     1. æŠŠä¸Šä¸€æ­¥ç»“æœè¿”å›ç»Ÿä¸€å°è£…æˆ ModelAndViewï¼Œä¸ç®¡ä¹‹å‰æ˜¯ä»€ä¹ˆç±»å‹(å­—ç¬¦ä¸²..)ï¼Œæœ€ç»ˆéƒ½ä¼šå°è£…æˆ ModelAndView å¯¹è±¡ï¼Œæ­¤å¯¹è±¡é‡Œé¢å°±åŒ…å«æ¨¡å‹æ•°æ®ï¼Œè§†å›¾ç›¸å…³çš„ä¿¡æ¯\r\n>     2. è¿”å›äº† ModelAndView å¯¹è±¡ä¹‹ååˆå›åˆ°æ‹¦æˆªå™¨ï¼Œè¿™å›æ˜¯è°ƒç”¨æ‹¦æˆªå™¨çš„ postHandle æ–¹æ³•ï¼Œè¿™ä¸ª postHandle æ–¹æ³•è°ƒç”¨çš„æ¬¡åºæ­£å¥½å’Œ preHandle æ–¹æ³•è°ƒç”¨çš„æ¬¡åºç›¸åï¼Œå³ç”±å†…è‡³å¤–ï¼ŒæŠŠæ‰€æœ‰çš„ postHandle ä¹Ÿè°ƒç”¨ä¸€éåï¼Œæœ€ç»ˆæ‰å¤„ç†è¿™ä¸ª ModelAndView\r\n>     3. ModelAndView å¤„ç†çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªè¦å¤„ç†çš„æ˜¯è¿™ä¸ªè§†å›¾ï¼Œå› ä¸ºå‰é¢çš„è°ƒç”¨ä»…ä»…è¿”å›çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„è§†å›¾åç§°ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè§†å›¾å¯¹è±¡ï¼Œå› æ­¤è¦å€ŸåŠ©ä¸€ä¸ªå«åš ViewResovler è§†å›¾è§£æå™¨ï¼ŒæŠŠè¿™ç§å­—ç¬¦ä¸²åå­—è§£ææˆä¸€ä¸ªçœŸæ­£çš„è§†å›¾å¯¹è±¡ï¼Œå½“ç„¶ï¼Œå¦‚æœè¿”å›çš„ç›´æ¥æ˜¯è§†å›¾å¯¹è±¡ï¼Œå®ƒå°±ç›´æ¥ç”¨äº†\r\n>     4. è§£æå¥½è§†å›¾ä¹‹åï¼Œå®ƒå°±å¯ä»¥è¿›å…¥è¿™ä¸ªè§†å›¾çš„æ¸²æŸ“ï¼Œå®ƒä¼šæŠŠæ¨¡å‹æ•°æ®æ ¹æ®è§†å›¾çš„å®ç°ä¸åŒå…ˆå­˜å‚¨åˆ°ä¸åŒçš„ä½ç½®ï¼Œå¦‚ JSP çš„å®ç°ï¼Œå®ƒå°±æŠŠæ¨¡å‹æ•°æ®å–å‡ºæ¥æ”¾å…¥åˆ° Request ä½œç”¨åŸŸï¼Œæ¥ä¸‹æ¥è½¬å‘åˆ° JSP çš„è§†å›¾ï¼ŒJSP è§†å›¾é‡Œå°±å¯ä»¥ä»ä½œç”¨åŸŸä¸­å–å‡ºæ¨¡å‹æ•°æ®ï¼Œæœ€åæ¸²æŸ“ç”Ÿæˆä¸€ä¸ª html å¹¶è¿”å›\r\n>     5. ç­‰è¿™ä¸ªè§†å›¾å¤„ç†å®Œåï¼Œè¿˜æœ‰ä¸€ä¸ªæ”¶å°¾å·¥ä½œï¼Œå®ƒæœ€ç»ˆè¿˜ä¼šå›åˆ°æˆ‘ä»¬çš„æ‹¦æˆªå™¨ï¼Œç”±å†…åˆ°å¤–çš„é¡ºåºè°ƒç”¨ afterCompletion æ–¹æ³•ï¼Œç­‰æ‰€æœ‰çš„ afterCompletion è°ƒç”¨å®Œåï¼Œæ•´ä¸ªçš„æ‰§è¡Œæµç¨‹å°±ç»“æŸäº†\r\n>   - å‡ºç°äº†å¼‚å¸¸\r\n>     1. å‡ºç°å¼‚å¸¸ä¹‹åï¼ŒModelAndView å°±æ²¡æœ‰äº†ï¼Œè€Œæ˜¯æ‹¿åˆ°ä¸€ä¸ª Exception çš„å¼‚å¸¸å¯¹è±¡ï¼Œå®ƒæœ‰ä¸€ä¸ª catch å—å¯ä»¥æ•æ‰åˆ°å¼‚å¸¸å¯¹è±¡\r\n>     2. æ‰ä½åˆ°å¼‚å¸¸å¯¹è±¡ä»¥åï¼ŒDispatcherServlet é‡Œè¿˜æœ‰ä¸€ä¸ª HandlerExceptionResolver æˆå‘˜ï¼Œå®ƒä»¬å°±æ˜¯ç”¨æ¥å¤„ç†å¼‚å¸¸çš„ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§æ¬¡åºï¼Œè°å…ˆåŒ¹é…åˆ°è¿™ä¸ªå¼‚å¸¸å¯¹è±¡è°å°±æ¥å¤„ç†ï¼ŒæŒ‘å‡ºä¸€ä¸ª HandlerExceptionResolver æ¥å¤„ç†å¼‚å¸¸\r\n>     3. å½“ç„¶ï¼Œå¤„ç†å®Œå¼‚å¸¸ï¼Œå®ƒä¹Ÿä¼šèµ°åˆ°æœ€åçš„ afterCompletion æ–¹æ³•æ–¹æ³•ç”±å†…å‘å¤–å»é€ä¸€è°ƒç”¨ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸ä¼šè°ƒç”¨ postHandle æ–¹æ³•ï¼Œå› ä¸ºå‡ºç°å¼‚å¸¸äº†ï¼Œå®ƒå°±æ²¡æœºä¼šæ‰§è¡Œè¿™ä¸ª postHandle\r\n> - æ— è®ºä»¥åæœ‰æ²¡æœ‰å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œåˆ°æ‹¦æˆªå™¨çš„ afterCompletion æ–¹æ³•\r\n> - è¿˜æœ‰ä¸€ç‚¹ï¼Œå°±æ˜¯å¦‚æœæˆ‘ä»¬çš„æ§åˆ¶å™¨æ–¹æ³•æ ‡æ³¨äº† @ResponseBody æ³¨è§£ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸æ˜¯è·³è½¬åˆ°è§†å›¾äº†ï¼Œå®ƒæ˜¯è¦è¿”å›è¿™ç§ Json æ•°æ®ï¼Œå³åœ¨ HandlerAdapter è°ƒç”¨ HandlerMethod æ—¶ï¼Œæœ‰ä¸€ä¸ªé˜¶æ®µæ˜¯å¤„ç†è¿”å›å€¼ï¼Œå³åœ¨å¤„ç†è¿”å›å€¼çš„é˜¶æ®µå»æ£€æŸ¥æ˜¯ä¸æ˜¯è¿™ä¸ªæ–¹æ³•ä¸Šæ ‡æ³¨äº† @ResponseBody æ³¨è§£ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå®ƒå°±ä¼šæ ‡è®° ModelAndView å·²å¤„ç†ï¼Œåç»­å°±ä¸ä¼šå»æ‰§è¡Œè§†å›¾æ¸²æŸ“äº†ï¼Œå³åœ¨å¤„ç†è¿”å›å€¼é˜¶æ®µçš„æ—¶å€™ç”Ÿæˆä¸€ä¸ªå« MessageConverter çš„æ¶ˆæ¯è½¬æ¢å™¨ï¼Œç”Ÿæˆ Json ä½œä¸ºæœ€ç»ˆç»“æœè¿”å›ï¼Œå°±ä¸ä¼šèµ°è§†å›¾æ¸²æŸ“çš„æµç¨‹ï¼Œå½“ç„¶ï¼Œè¿™é‡Œçš„ postHandle å’Œ afterCompletion è¿™äº›æ‹¦æˆªå™¨çš„å¤„ç†æ“ä½œè¿˜æ˜¯ä¼šæ‰§è¡Œ\r\n\r\n\r\n\r\n------\r\n\r\n### **æ€»ç»“**\r\n\r\n![Spring MVCçš„å·¥ä½œæµç¨‹](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/spring-e29a122b-db07-48b8-8289-7251032e87a1.png)\r\n\r\n1. å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå…ˆåˆ°å‰ç«¯æ§åˆ¶å™¨ DispatcherServlet(ä¹Ÿå«ä¸­å¤®æ§åˆ¶å™¨)ã€‚\r\n2. DispatcherServlet æ¥æ”¶åˆ°è¯·æ±‚åä¼šè°ƒç”¨ HandlerMapping å¤„ç†å™¨æ˜ å°„å™¨ã€‚ç”±æ­¤å¾—çŸ¥ï¼Œè¯¥è¯·æ±‚è¯¥ç”±å“ªä¸ª Controller æ¥å¤„ç†ï¼ˆå¹¶æœªè°ƒç”¨ Controllerï¼Œåªæ˜¯å¾—çŸ¥ï¼‰\r\n3. DispatcherServlet è°ƒç”¨ HandlerAdapter å¤„ç†å™¨é€‚é…å™¨ï¼Œå‘Šè¯‰å¤„ç†å™¨é€‚é…å™¨åº”è¯¥è¦å»æ‰§è¡Œå“ªä¸ª Controller\r\n4. HandlerAdapter å¤„ç†å™¨é€‚é…å™¨å»æ‰§è¡Œ Controller å¹¶å¾—åˆ° ModelAndView(æ•°æ®å’Œè§†å›¾)ï¼Œå¹¶å±‚å±‚è¿”å›ç»™ DispatcherServlet\r\n5. DispatcherServlet å°† ModelAndView äº¤ç»™ ViewReslover è§†å›¾è§£æå™¨è§£æï¼Œç„¶åè¿”å›çœŸæ­£çš„è§†å›¾ã€‚\r\n6. DispatcherServlet å°†æ¨¡å‹æ•°æ®å¡«å……åˆ°è§†å›¾ä¸­\r\n7. DispatcherServlet å°†ç»“æœå“åº”ç»™å®¢æˆ·ç«¯\r\n\r\n**Spring MVC** è™½ç„¶æ•´ä½“æµç¨‹å¤æ‚ï¼Œä½†æ˜¯å®é™…å¼€å‘ä¸­å¾ˆç®€å•ï¼Œå¤§éƒ¨åˆ†çš„ç»„ä»¶ä¸éœ€è¦å¼€å‘äººå‘˜åˆ›å»ºå’Œç®¡ç†ï¼Œåªéœ€è¦é€šè¿‡é…ç½®æ–‡ä»¶çš„æ–¹å¼å®Œæˆé…ç½®å³å¯ï¼ŒçœŸæ­£éœ€è¦å¼€å‘äººå‘˜è¿›è¡Œå¤„ç†çš„åªæœ‰ **Handlerï¼ˆControllerï¼‰** ã€**View** ã€**Model**ã€‚\r\n\r\nå½“ç„¶æˆ‘ä»¬ç°åœ¨å¤§éƒ¨åˆ†çš„å¼€å‘éƒ½æ˜¯å‰åç«¯åˆ†ç¦»ï¼ŒRestful é£æ ¼æ¥å£ï¼Œåç«¯åªéœ€è¦è¿”å› Json æ•°æ®å°±è¡Œäº†ã€‚\r\n\r\n\r\n\r\n------\r\n\r\n\r\n\r\n## 5.1 SpringMVC Restful æ‰§è¡Œæµç¨‹\r\n\r\nPS:è¿™æ˜¯ä¸€é“å…¨æ–°çš„å…«è‚¡ï¼Œæ¯•ç«Ÿ ModelAndView è¿™ç§æ–¹å¼åº”è¯¥æ²¡äººç”¨äº†å§ï¼Ÿç°åœ¨éƒ½æ˜¯å‰åç«¯åˆ†ç¦»æ¥å£ï¼Œå…«è‚¡ä¹Ÿè¯¥æ›´æ–°æ¢ä»£äº†ã€‚\r\n\r\næˆ‘ä»¬éƒ½çŸ¥é“ Restful æ¥å£ï¼Œå“åº”æ ¼å¼æ˜¯ jsonï¼Œè¿™å°±ç”¨åˆ°äº†ä¸€ä¸ªå¸¸ç”¨æ³¨è§£ï¼š**@ResponseBody**\r\n\r\n\r\n\r\n```java\r\n    @GetMapping(\"/user\")\r\n    @ResponseBody\r\n    public User user(){\r\n        return new User(1,\"å¼ ä¸‰\");\r\n    }\r\n```\r\n\r\nåŠ å…¥äº†è¿™ä¸ªæ³¨è§£åï¼Œæ•´ä½“çš„æµç¨‹ä¸Šå’Œä½¿ç”¨ ModelAndView å¤§ä½“ä¸Šç›¸åŒï¼Œä½†æ˜¯ç»†èŠ‚ä¸Šæœ‰ä¸€äº›ä¸åŒï¼š\r\n\r\n![image-20231206192404673](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20231206192404673.png)\r\n\r\n1. å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå…ˆåˆ°å‰ç«¯æ§åˆ¶å™¨ DispatcherServlet\r\n\r\n2. DispatcherServlet æ¥æ”¶åˆ°è¯·æ±‚åä¼šè°ƒç”¨ HandlerMapping å¤„ç†å™¨æ˜ å°„å™¨ã€‚ç”±æ­¤å¾—çŸ¥ï¼Œè¯¥è¯·æ±‚è¯¥ç”±å“ªä¸ª Controller æ¥å¤„ç†\r\n\r\n3. DispatcherServlet è°ƒç”¨ HandlerAdapter å¤„ç†å™¨é€‚é…å™¨ï¼Œå‘Šè¯‰å¤„ç†å™¨é€‚é…å™¨åº”è¯¥è¦å»æ‰§è¡Œå“ªä¸ª Controller\r\n\r\n4. Controller è¢«å°è£…æˆäº† ServletInvocableHandlerMethodï¼ŒHandlerAdapter å¤„ç†å™¨é€‚é…å™¨å»æ‰§è¡Œ invokeAndHandle æ–¹æ³•ï¼Œå®Œæˆå¯¹ Controller çš„è¯·æ±‚å¤„ç†\r\n\r\n5. HandlerAdapter æ‰§è¡Œå®Œå¯¹ Controller çš„è¯·æ±‚ï¼Œä¼šè°ƒç”¨ HandlerMethodReturnValueHandler å»å¤„ç†è¿”å›å€¼ï¼Œä¸»è¦çš„è¿‡ç¨‹ï¼š\r\n\r\n   5.1. è°ƒç”¨ RequestResponseBodyMethodProcessorï¼Œåˆ›å»º ServletServerHttpResponseï¼ˆSpring å¯¹åŸç”Ÿ ServerHttpResponse çš„å°è£…ï¼‰å®ä¾‹\r\n\r\n   5.2.ä½¿ç”¨ HttpMessageConverter çš„ write æ–¹æ³•ï¼Œå°†è¿”å›å€¼å†™å…¥ ServletServerHttpResponse çš„ OutputStream è¾“å‡ºæµä¸­\r\n\r\n   5.3.åœ¨å†™å…¥çš„è¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨ JsonGeneratorï¼ˆé»˜è®¤ä½¿ç”¨ Jackson æ¡†æ¶ï¼‰å¯¹è¿”å›å€¼è¿›è¡Œ Json åºåˆ—åŒ–\r\n\r\n6. æ‰§è¡Œå®Œè¯·æ±‚åï¼Œè¿”å›çš„ ModealAndView ä¸º nullï¼ŒServletServerHttpResponse é‡Œä¹Ÿå·²ç»å†™å…¥äº†å“åº”ï¼Œæ‰€ä»¥ä¸ç”¨å…³å¿ƒ View çš„å¤„ç†\r\n\r\n\r\n\r\n------\r\n\r\n## 6. Spring æ³¨è§£\r\n\r\n**lang**\r\n\r\nlang ä¸­çš„æ³¨è§£æ˜¯ Spring æ¡†æ¶å†…éƒ¨è‡ªå·±ä½¿ç”¨çš„ä¸€äº›æ³¨è§£\r\n\r\n- @NonNull\r\n- @NonNullApi\r\n- @NonNullFields\r\n- @Nullable\r\n- @UsesSunMisc\r\n\r\n\r\n\r\n------\r\n\r\n### **äº‹åŠ¡æ³¨è§£**\r\n\r\n* **@EnableTransactionManagement**ï¼Œä¼šé¢å¤–åŠ è½½ 4 ä¸ª bean\r\n  * BeanFactoryTransactionAttributeSourceAdvisor äº‹åŠ¡åˆ‡é¢ç±»\r\n  * TransactionAttributeSource ç”¨æ¥è§£æäº‹åŠ¡å±æ€§\r\n  * TransactionInterceptor äº‹åŠ¡æ‹¦æˆªå™¨\r\n  * TransactionalEventListenerFactory äº‹åŠ¡ç›‘å¬å™¨å·¥å‚\r\n  \r\n  ![image-20230422152841010](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422152841010.png)\r\n* **@Transactional**\r\n\r\n\r\n\r\n------\r\n\r\n**ç›‘æ§**\r\n\r\n- @EnableMBeanExport\r\n- @ManagedAttribute\r\n- @ManagedMetric\r\n- @ManagedNotification\r\n- @ManagedNotifications\r\n- @ManagedOperation\r\n- @ManagedOperationParameter\r\n- @ManagedOperationParameters\r\n- @ManagedResource\r\n\r\n**æ ¸å¿ƒ**\r\n\r\n- @AliasForæ˜¯ç»™æ³¨è§£èµ·åˆ«å(äº†è§£)\r\n\r\n* **@Order**æ˜¯ç”¨æ¥æ§åˆ¶ä¸€äº›beanå®ƒä»¬çš„ä¸€äº›æ‰§è¡Œé¡ºåºï¼Œæœ€ä½ä¼˜å…ˆçº§=æ•´æ•°æœ€å¤§å€¼\r\n\r\n**äº‹ä»¶ã€è°ƒåº¦ã€å¼‚æ­¥**\r\n\r\n- @EventListener\r\n- @TransactionalEventListener\r\n- @EnableAsync\r\n- @Async\r\n- @EnableScheduling\r\n- @Scheduled\r\n- @Schedules\r\n\r\n------\r\n\r\n### **åˆ‡é¢**\r\n\r\n* **@EnableAspectJAutoProxy**\r\n  * ä¼šåŠ è½½ AnnotationAwareAspectJAutoProxyCreatorï¼Œå®ƒæ˜¯ä¸€ä¸ª bean åå¤„ç†å™¨ï¼Œç”¨æ¥åˆ›å»ºä»£ç†\r\n  * å¦‚æœæ²¡æœ‰é…ç½® @EnableAspectJAutoProxyï¼Œåˆéœ€è¦ç”¨åˆ°ä»£ç†ï¼ˆå¦‚äº‹åŠ¡ï¼‰åˆ™ä¼šä½¿ç”¨ InfrastructureAdvisorAutoProxyCreator è¿™ä¸ª bean åå¤„ç†å™¨\r\n\r\n![image-20230422154010262](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422154010262.png)\r\n\r\n> - @EnableAspectJAutoProxyæ˜¯å¯ç”¨æˆ‘ä»¬çš„AOPè¿™ç§è‡ªåŠ¨ä»£ç†ï¼Œçœ‹çœ‹å®ƒ@Importçš„å®ç°ï¼Œåé¢çš„ç±»å‹åŠ å…¥ AnnotationAwareAspectJAutoProxyCreator çš„ bean åå¤„ç†å™¨ï¼Œè¿™ä¸ªåå¤„ç†ä¼šåœ¨ bean çš„åˆå§‹åŒ–åæœŸå¸®åŠ©æˆ‘ä»¬æ£€æŸ¥çœ‹çœ‹éœ€ä¸éœ€æ·»åŠ ä¸€ä¸ªä»£ç†ï¼Œå¦‚æœä½ çš„ bean è·ŸæŸä¸ªåˆ‡ç‚¹è¡¨è¾¾å¼åŒ¹é…ä¸Šäº†ï¼Œå®ƒå°±ä¼šä¸ºä½ çš„ bean ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œæœ€ç»ˆå°†ä»£ç†å¯¹è±¡æ”¾å…¥å•ä¾‹æ± å»ä»£æ›¿æ‰ç›®æ ‡çš„ target å¯¹è±¡ï¼Œè¯´ç™½äº†ï¼Œå®ƒå°±æ˜¯å¸®åŠ©æˆ‘ä»¬äº§ç”Ÿè¿™ä¸ªä»£ç†æ¥ååŠ© AOP å¢å¼ºçš„ï¼Œå½“ç„¶ï¼Œè¿™ä¸ªä»£ç†çš„æ‰§è¡Œæ—¶æœºç»å¤§å¤šæ•°æƒ…å†µéƒ½æ˜¯åœ¨åˆå§‹åŒ–ä¹‹åç”Ÿæˆä»£ç†çš„ï¼Œå¦‚æœé‡åˆ°äº†å¾ªç¯ä¾èµ–åˆéœ€è¦ä»£ç†çš„æƒ…å†µï¼Œå®ƒä¼šè®©ä»£ç†çš„ç”Ÿæˆæå‰ï¼Œåœ¨è¿™ä¸ªä¾èµ–æ³¨å…¥ä¹‹å‰å°±ç”Ÿæˆä»£ç†\r\n> - @Aroundã€@Beforeã€@After è¿™äº›ä¸åˆ‡é¢é€šçŸ¥ç›¸å…³æ³¨è§£å®é™…ä¸Šæ˜¯å±äºç¬¬ä¸‰æ–¹åº“ AspectJ æä¾›çš„ï¼ŒSpring åªæ˜¯å€Ÿç”¨äº†äººå®¶ç¬¬ä¸‰æ–¹çš„æ³¨è§£ï¼Œå¹¶ä¸æ˜¯ Spring è‡ªå·±çš„\r\n\r\n### **ç»„ä»¶æ‰«æä¸é…ç½®ç±»**\r\n\r\n* @Component\r\n\r\n* @Controller\r\n\r\n* @Service\r\n\r\n* @Repository\r\n\r\n> @Componentã€@Controllerã€@Serviceã€@Repository è¿™å››ä¸ªæ˜¯é…åˆåšç»„ä»¶æ‰«æçš„ï¼Œæ ‡æ³¨äº†è¿™äº›æ³¨è§£çš„ç±»å°†æ¥ä¸€æ—¦ç»„ä»¶æ‰«æåˆ°å®ƒäº†ï¼Œå°±ä¼šæŠŠå®ƒçº³å…¥åˆ° Spring çš„å®¹å™¨ç®¡ç†ï¼Œè·Ÿå®ƒä»¬é…åˆä½¿ç”¨çš„è¿˜æœ‰ @ComponentScanï¼Œå®ƒå¯ä»¥æŒ‡å®šä¸€ä¸ªèµ·å§‹åŒ…åï¼Œå®ƒå°±ä¼šä»¥è¿™ä¸ªèµ·å§‹åŒ…åå¼€å§‹å»æ‰«æè¿™ä¸ªåŒ…ä»¥åŠè¿™ä¸ªåŒ…çš„æ‰€æœ‰å­å­™åä»£åŒ…ï¼Œæ‰«æè¿™äº›æ³¨è§£ï¼Œæ‰«æåˆ°å°±æŠŠå®ƒä»¬åŠ å…¥åˆ° Spring çš„å®¹å™¨ç®¡ç†ä¸­\r\n\r\n* @ComponentScan\r\n\r\n* @Conditionalï¼ˆSpring è‡ªèº«å°±æœ‰çš„åŠŸèƒ½ï¼Œå¹¶ä¸æ˜¯åªæœ‰ SpringBootï¼‰æ˜¯åœ¨è¿™ä¸ªç»„ä»¶æ‰«ææ—¶åšä¸€äº›æ¡ä»¶è£…é…ï¼Œç¬¦åˆæ¡ä»¶çš„å°±åŠ å…¥åˆ° Spring å®¹å™¨ä¸­ï¼Œå¦‚æœåˆ¤æ–­æ¡ä»¶ä¸æˆç«‹ï¼Œå³ä½¿æ‰«æåˆ°äº†ï¼Œå®ƒä¹Ÿä¸ä¼šåŠ å…¥çš„ï¼Œå®ƒé™¤äº†å’Œæˆ‘ä»¬ç»„ä»¶æ‰«ææ—¶å€™é…åˆä»¥å¤–ï¼Œè¿˜å¯ä»¥è·Ÿè¿™ä¸ªé…ç½®ç±»è§£æ @Beanæ—¶é…åˆä½¿ç”¨ï¼Œä¹Ÿä¼šåˆ¤æ–­æ˜¯å¦æ»¡è¶³æ¡ä»¶\r\n\r\n* **@Configuration**\r\n\r\n  * é…ç½®ç±»å…¶å®ç›¸å½“äºä¸€ä¸ªå·¥å‚ï¼Œæ ‡æ³¨ @Bean æ³¨è§£çš„æ–¹æ³•ç›¸å½“äºå·¥å‚æ–¹æ³•\r\n\r\n  ![image-20230422190940503](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422190940503.png)\r\n\r\n  * @Bean ä¸æ”¯æŒæ–¹æ³•é‡è½½ï¼Œå¦‚æœæœ‰å¤šä¸ªé‡è½½æ–¹æ³•ï¼Œä»…æœ‰ä¸€ä¸ªèƒ½å…¥é€‰ä¸ºå·¥å‚æ–¹æ³•\r\n\r\n  ![image-20230422191323803](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422191323803.png)\r\n\r\n  * @Configuration é»˜è®¤ä¼šä¸ºæ ‡æ³¨çš„ç±»ç”Ÿæˆä»£ç†ï¼Œå…¶ç›®çš„æ˜¯ä¿è¯ @Bean æ–¹æ³•ç›¸äº’è°ƒç”¨æ—¶ï¼Œä»ç„¶èƒ½ä¿è¯å…¶å•ä¾‹ç‰¹æ€§\r\n\r\n  ![image-20230422191956615](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422191956615.png)\r\n\r\n  * @Configuration ä¸­å¦‚æœå«æœ‰ BeanFactory åå¤„ç†å™¨çš„ bean è¦åˆ›å»ºï¼Œåˆ™å®ä¾‹å·¥å‚æ–¹æ³•ä¼šå¯¼è‡´ MyConfig æå‰åˆ›å»ºï¼Œé€ æˆå…¶ä¾èµ–æ³¨å…¥å¤±è´¥ï¼Œè§£å†³æ–¹æ³•æ˜¯æ”¹ç”¨é™æ€å·¥å‚æ–¹æ³•æˆ–ç›´æ¥ä¸º @Bean çš„æ–¹æ³•å‚æ•°ä¾èµ–æ³¨å…¥ï¼Œé’ˆå¯¹ Mapper æ‰«æå¯ä»¥æ”¹ç”¨æ³¨è§£æ–¹å¼\r\n\r\n  ![image-20230422192558594](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422192558594.png)\r\n\r\n* @Bean æ˜¯æ ‡æ³¨åœ¨é…ç½®ç±»é‡Œçš„é‚£äº›æ–¹æ³•ï¼ˆå·¥å‚æ–¹æ³•ï¼‰ï¼Œæ ‡æ³¨ @Configuration çš„é…ç½®ç±»ï¼ˆå·¥å‚ç±»ï¼‰æ¥å®šä¹‰ @Bean æ–¹æ³•è¿”å›çš„ bean \r\n\r\n* @Import \r\n\r\n  * å››ç§ç”¨æ³•\r\n\r\n    â‘  å¼•å…¥å•ä¸ª bean\r\n\r\n    â‘¡ å¼•å…¥ä¸€ä¸ªé…ç½®ç±»\r\n\r\n    â‘¢ é€šè¿‡ Selector å¼•å…¥å¤šä¸ªç±»\r\n\r\n    â‘£ é€šè¿‡ beanDefinition æ³¨å†Œå™¨å¼•å…¥å¤šä¸ªç±»\r\n\r\n  ![image-20230422193333726](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422193333726.png)\r\n\r\n  * è§£æè§„åˆ™\r\n\r\n    * åŒä¸€é…ç½®ç±»ä¸­ï¼Œ@Import å…ˆè§£æ  @Bean åè§£æ\r\n    * åŒåå®šä¹‰ï¼Œé»˜è®¤åé¢è§£æçš„ä¼šè¦†ç›–å‰é¢è§£æçš„\r\n    * ä¸å…è®¸è¦†ç›–çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•èƒ½å¤Ÿè®© MyConfig(ä¸»é…ç½®ç±») çš„é…ç½®ä¼˜å…ˆ? (è™½ç„¶è¦†ç›–æ–¹å¼èƒ½è§£å†³)\r\n    * é‡‡ç”¨ DeferredImportSelectorï¼Œå› ä¸ºå®ƒæœ€åå·¥ä½œï¼Œå¯ä»¥ç®€å•è®¤ä¸ºå…ˆè§£æ @Beanï¼Œå† Import\r\n\r\n  ![image-20230422215656267](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422215656267.png)\r\n\r\n  > @Importæ˜¯å¯¼å…¥å…¶ä»–çš„é…ç½®ç±»æˆ–æ™®é€šç±»ï¼›å¯¼å…¥å…¶ä»–çš„ä¸€äº›Selectoræ ¹æ®å®ƒä»¬è¿”å›çš„beançš„åå­—æŠŠå®ƒä»¬åŠ å…¥åˆ°å½“å‰çš„Springå®¹å™¨ä¸­\r\n\r\n* @Lazy\r\n\r\n  * åŠ åœ¨ç±»ä¸Šï¼Œè¡¨ç¤ºæ­¤ç±»å»¶è¿Ÿå®ä¾‹åŒ–ã€åˆå§‹åŒ–\r\n  * åŠ åœ¨æ–¹æ³•å‚æ•°ä¸Šï¼Œæ­¤å‚æ•°ä¼šä»¥ä»£ç†æ–¹å¼æ³¨å…¥\r\n\r\n  > æœ‰ä¸¤ä¸ªç”¨é€”ï¼Œä¸€ä¸ªç”¨é€”æ˜¯æ ‡æ³¨åœ¨ç±»ä¸Šï¼Œè¡¨ç¤ºè¿™ä¸ªç±»æ˜¯å»¶è¿Ÿåˆå§‹åŒ–å’Œå®ä¾‹åŒ–çš„ï¼Œå³ä¸€å¼€å§‹ä½ æ²¡æœ‰ç”¨åˆ°çš„æ—¶å€™ï¼Œå®ƒæ˜¯ä¸ä¼šåˆ›å»ºè¿™ä¸ªæ ‡æ³¨äº† @Lazy çš„ bean çš„å®ä¾‹ï¼Œå½“ä½ ç¬¬ä¸€æ¬¡ç”¨åˆ°çš„æ—¶å€™ï¼Œæ‰ä¼šå»åˆ›å»ºè¿™ä¸ªæ ‡æ³¨äº† @Lazy çš„ beanï¼›è¿˜æœ‰ä¸€ä¸ªæ›´é‡è¦çš„ç”¨æ³•æ˜¯ç”¨åœ¨æ–¹æ³•å‚æ•°ä¸Šå’Œæˆå‘˜å˜é‡ä¸Šï¼Œå®ƒå¯ä»¥è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œå³è®©ä½ çš„è¿™ä¸ªä¾èµ–æ³¨å…¥åŒ…æ‹¬å‚æ•°çš„æ³¨å…¥ï¼Œå®ƒæ˜¯æ¨è¿Ÿæ‰§è¡Œï¼Œä¼šæ³¨å…¥ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡æ³¨å…¥ä»¥åå°±è§£å†³äº†å¾ªç¯ä¾èµ–ï¼Œå°†æ¥ç­‰å¾ªç¯ä¾èµ–è¿™ä¸ªè¿‡ç¨‹èµ°å®Œï¼Œä½ å°†æ¥çœŸæ­£ç”¨åˆ°è¿™ä¸ª bean æ—¶ï¼Œå®ƒæ‰ä¼šçœŸæ­£åˆ›å»ºè¿™ä¸ª beanï¼Œå®ƒæ˜¯ç”¨ä»£ç†è§£å†³äº†å¾ªç¯ä¾èµ–ï¼Œè¿™æ˜¯å®ƒæ›´é‡è¦çš„ä¸€ä¸ªç”¨é€”\r\n\r\n* @PropertySource æ˜¯ç”¨æ¥è¯»å–ä¸€äº›è‡ªå®šä¹‰çš„ properties æ–‡ä»¶ï¼ŒæŠŠå®ƒä»¬ä½œä¸ºé”®å€¼ä¿¡æ¯åŠ å…¥åˆ°æˆ‘ä»¬ environment å¯¹è±¡é‡Œæ¥ï¼Œ environment å°±æ˜¯åŒ…å«äº†æ•´ä¸ªåº”ç”¨ç¨‹åºåœ¨è¿è¡ŒæœŸé—´éœ€è¦çš„æ‰€æœ‰é”®å€¼ä¿¡æ¯\r\n\r\n**ä¾èµ–æ³¨å…¥**\r\n\r\n* **@Autowired** åŠ åœ¨æ–¹æ³•å‚æ•°ä¸Šæˆ–æˆå‘˜å˜é‡ä¸Šéƒ½å¯ä»¥å®Œæˆä¾èµ–æ³¨å…¥\r\n* **@Qualifier** æ˜¯åœ¨ä¾èµ–æ³¨å…¥æ—¶ï¼Œå¦‚æœåŒä¸€ç±»å‹æœ‰å¤šä¸ª beanï¼Œå°±ä¼šæ ¹æ®åå­—è¿›è¡ŒåŒºåˆ†\r\n* **@Value** æ˜¯åšå€¼æ³¨å…¥çš„ï¼Œå¯ä»¥å¯¹`${}`ï¼Œ`#{}`è¿™ç§å†…åµŒå¼çš„ç¬¦å·å®ç°å†…åµŒå¼çš„æ³¨å…¥\r\n\r\n**ç¼“å­˜**\r\n\r\n- @EnableCaching\r\n- @CacheConfig\r\n- @CacheEvict\r\n- @CachePut\r\n- @Cacheable\r\n- @Caching\r\n\r\n------\r\n\r\n### **mvc mapping**\r\n\r\n* @RequestMapping ä½œç”¨æ˜¯å»ºç«‹æˆ‘ä»¬è¯·æ±‚è·¯å¾„è·Ÿæ§åˆ¶å™¨æ–¹æ³•ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œå°†æ¥æœ‰ä¸€ä¸ªè¯·æ±‚è¿‡æ¥çš„æ—¶å€™å®ƒå°±ä¼šæ ¹æ®è¿™ä¸ªè¯·æ±‚è·¯å¾„ä¸æˆ‘ä»¬ @RequestMapping ä¸­çš„è·¯å¾„è¿›è¡Œä¸€ä¸ªåŒ¹é…ï¼ŒåŒ¹é…ä¸Šäº†å®ƒå°±çŸ¥é“ï¼Œæ¥ä¸‹æ¥åº”è¯¥ç”±åŒ¹é…æˆåŠŸçš„æ ‡æ³¨äº† @RequestMapping æ³¨è§£çš„æ–¹æ³•æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œè¿™æ˜¯å®ƒçš„ä¸€ä¸ªæœ€é‡è¦çš„ç”¨é€”ï¼Œå½“ç„¶è¿™ä¸ªæ³¨è§£ä¹Ÿå¯ä»¥åŠ åœ¨ç±»ä¸Šï¼ŒåŠ åœ¨ç±»ä¸Šæ—¶å½“ä½ çš„è¿™ä¸ªç±»æœ‰å¤šä¸ªæ§åˆ¶å™¨æ–¹æ³•å®ƒä»¬æœ‰ä¸€ä¸ªç›¸åŒçš„è·¯å¾„å‰ç¼€æ—¶ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠè¿™ä¸ªç›¸åŒçš„è·¯å¾„å‰ç¼€ç»™å®ƒæå–å‡ºæ¥ï¼Œæ”¾åœ¨ç±»ä¸Šçš„ @RequestMapping \r\n  * å¯ä»¥æ´¾ç”Ÿå¤šä¸ªæ³¨è§£å¦‚  @GetMapping  ç­‰ï¼Œ@GetMapping åŠŸèƒ½è·Ÿ @RequestMapping ç›¸åŒï¼Œåªä¸è¿‡ method åªèƒ½æ˜¯GETè¯·æ±‚ï¼Œå®ƒä¸ä¼šå»å¤„ç†å…¶ä»–çš„ POSTï¼ŒPUTï¼ŒDELETE ä¹‹ç±»çš„è¯·æ±‚ï¼Œåªè®¤ GET è¯·æ±‚\r\n\r\n\r\n**mvc rest**\r\n\r\n* @RequestBody æ˜¯å¤„ç†è¯·æ±‚ä½“ä¸­çš„ Json æ•°æ®çš„ï¼ŒæŠŠ Json æ•°æ®è½¬æ¢ä¸º Java å¯¹è±¡\r\n* @ResponseBody æ˜¯æŠŠæ§åˆ¶å™¨ä¸Šè¿”å›çš„ Java å¯¹è±¡è½¬æ¢æˆ Json æ•°æ®ï¼Œç„¶åå†™å…¥åˆ°å“åº”ä½“ï¼Œç»„åˆ @ResponseBody + @Controller =  @RestController\r\n* @ResponseStatus æ˜¯å¯ä»¥æ§åˆ¶å“åº”çš„çŠ¶æ€ç \r\n\r\n**mvc ç»Ÿä¸€å¤„ç†**\r\n\r\n* **@ControllerAdvice** ï¼šå¦‚æœä½ åšä¸€äº›ç»Ÿä¸€å¤„ç†çš„å¼‚å¸¸æ–¹æ³•ï¼Œæˆ–è¿™ä¸ªè½¬æ¢å™¨æ–¹æ³•ï¼Œè¿˜æœ‰è¿™ä¸ªæ ‡æ³¨äº† @ModelAttribute çš„æ–¹æ³• ï¼Œéƒ½å¯ä»¥æ”¾åœ¨é‚£ç§æ ‡æ³¨äº† @ControllerAdvice çš„ç±»æ¥è¾¾åˆ°ä¸€ä¸ªç»Ÿä¸€å¤„ç†çš„ç›®çš„ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„æ˜¯æŠŠä¸€äº›å¤„ç†å¼‚å¸¸çš„æ–¹æ³•æ”¾åœ¨æ ‡æ³¨äº† @ControllerAdvice çš„æ–¹æ³•ä¸­æ¥å®ç°ä¸€ä¸ªå¼‚å¸¸çš„ç»Ÿä¸€å¤„ç†ï¼Œå¯ä»¥è®©ä¸€ä¸ªæ ‡æ³¨äº† @ExceptionHandler çš„æ–¹æ³•æ¥å¤„ç†å¼‚å¸¸ï¼Œå®ƒæ˜¯ä¸“é—¨æ¥å¤„ç†å¼‚å¸¸æ–¹æ³•çš„ï¼Œå½“ç„¶ï¼Œè¿™ä¸¤ä¸ªæ³¨è§£ç»“åˆä½¿ç”¨çš„æ¯”è¾ƒå¤š\r\n* æ ‡æ³¨äº† **@ExceptionHandler** çš„æ–¹æ³•ä¸ä¸€å®šæ˜¯æ”¾åœ¨æ ‡æ³¨äº† @ControllerAdvice çš„æ–¹æ³•ä¸­ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨ä¸€ä¸ªæ™®é€šçš„æ§åˆ¶å™¨ä¸­ï¼Œæ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„æ§åˆ¶å™¨ä¸­å°±ç›¸å½“äºæ˜¯ä¸€ä¸ªå±€éƒ¨çš„å¼‚å¸¸å¤„ç†ï¼Œå¦‚æœæ–¹æ³•åœ¨ä¸€ä¸ªæ ‡æ³¨ @ControllerAdvice çš„ç±»ä¸­ï¼Œå°±è¡¨ç¤ºæ˜¯ä¸€ä¸ªå…¨å±€çš„å¼‚å¸¸å¤„ç†\r\n*  @RestControllerAdvice æ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œå³ @ControllerAdvice + @ResponseBodyï¼Œå°†æ¥æ ‡æ³¨äº† @ControllerAdvice çš„**æ–¹æ³•**åšäº†å¼‚å¸¸å¤„ç†ï¼Œä¹Ÿä¼šè½¬æ¢ä¸º Json æ•°æ®å†™åˆ°å“åº”ä½“é‡Œ\r\n\r\n**mvc å‚æ•°**\r\n\r\n* @RequestHeader æ˜¯è·å–è¯·æ±‚å¤´ä¸­çš„å‚æ•°ä¿¡æ¯\r\n* @CookieValue æ˜¯è·å–Cookieçš„å€¼\r\n* **@PathVariable** æ˜¯è·å–è¯·æ±‚è·¯å¾„çš„å‚æ•°å€¼\r\n* **@RequestParam** æ˜¯è·å–çœŸæ­£çš„è¯·æ±‚å‚æ•°å€¼ï¼Œå°±æ˜¯ä¹‹åçš„é”®å€¼ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥æ˜¯è¡¨å•ä¸­çš„è¯·æ±‚å‚æ•°ï¼Œåªè¦ä½ çš„è¯·æ±‚å‚æ•°è·Ÿæ–¹æ³•åç§°å¯¹åº”ä¸Šï¼Œå°±å¯ä»¥çœç•¥è¿™ä¸ª@RequestParamï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å¯ä»¥è®¾ç½®é»˜è®¤å€¼ï¼Œå³defaultValueå±æ€§ï¼Œå¦‚æœæ²¡æœ‰ä¼ è¿™ä¸ªè¯·æ±‚å‚æ•°ï¼Œå¯ä»¥ç»™å®ƒè®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼\r\n\r\n**è½¬æ¢ä¸æ ¼å¼åŒ–**\r\n\r\n- @DateTimeFormatæ˜¯è½¬æ¢æ—¥æœŸå’Œæ—¶é—´æ ¼å¼\r\n- @NumberFormatæ˜¯è½¬æ¢æ•°å­—æ ¼å¼çš„\r\n- @InitBinderæ˜¯æ³¨å†Œä¸€äº›è‡ªå®šä¹‰çš„ç±»å‹è½¬æ¢å™¨çš„\r\n\r\n**validation**æ˜¯åšè¿™ä¸ªbeançš„æ ¡éªŒçš„\r\n\r\n- @Validated åŠ åœ¨ Javabean ä¸Šï¼Œè¡¨ç¤ºè¿™ä¸ª Javabean å°†æ¥è¦åšæ•°æ®æ ¡éªŒï¼Œè‡³äºè¿™ä¸ªæ ¡éªŒè§„åˆ™ä¹Ÿæ˜¯åŠ åœ¨ Javabean çš„å±æ€§ä¸Šï¼Œå®ƒæ˜¯å€ŸåŠ©ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„æ³¨è§£ï¼Œæ¯”å¦‚ @NotEmptyï¼Œ@NotBlankï¼Œ@NotNullç­‰ï¼Œè¿™äº›æ³¨è§£æ‰çœŸæ­£å®Œæˆæ ¡éªŒè§„åˆ™çš„ï¼Œè€Œ @Validated åªæ˜¯ä½œä¸ºä¸€ä¸ªæ ¡éªŒçš„å…¥å£\r\n\r\n**scope**\r\n\r\n- æ ‡æ³¨äº†@ApplicationScopï¼Œ@RequestScopeï¼Œ@SessionScopeè¿™ç±»çš„æ³¨è§£çš„ç±»ï¼Œå°±å¯ä»¥åœ¨Springå®¹å™¨ä¸­é‡Œé¢æ§åˆ¶å®ƒä»¬çš„ä½œç”¨åŸŸ\r\n\r\n**mvc ajax**\r\n\r\n* @CrossOriginæ˜¯è§£å†³ajaxè¯·æ±‚çš„ä¸€ä¸ªè·¨åŸŸé—®é¢˜ï¼ŒåŸç†æ˜¯åœ¨å“åº”å¤´ä¸ŠåŠ ä¸€äº›ç‰¹æ®Šçš„å¤´ï¼Œå…è®¸ä½ çš„è¿™ä¸ªajaxè·¨åŸŸçš„è¿™ç§è¯·æ±‚ï¼Œå½“ç„¶ï¼Œå¦‚æœä½ ç”¨çš„HttpClientçš„è¿™ç§å®¢æˆ·ç«¯å°±æ²¡æœ‰è¿™ç§è·¨åŸŸé—®é¢˜ï¼Œå®ƒåªé€‚åˆç”¨äºjavaScripé‡Œé¢ä½¿ç”¨ajaxè®¿é—®æ—¶æ‰ä¼šå­˜åœ¨è·¨åŸŸé—®é¢˜\r\n\r\n------\r\n\r\n### **boot**\r\n\r\n **auto**\r\n\r\n* @SpringBootApplicationï¼ˆæ¯ä¸ªSpringBootç¨‹åºéƒ½è¦åŠ çš„æ³¨è§£)æ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œå³@EnableAutoConfigurationï¼Œ@SpringBootConfiguration å’Œ@ ComponentScanï¼‰\r\n* @EnableAutoConfiguration æ˜¯å»æ‰¾åˆ°ä¸€äº›è‡ªåŠ¨é…ç½®ç±»ï¼ŒæŠŠè¿™äº›è‡ªåŠ¨é…ç½®ç±»å…³è”çš„ Bean éƒ½è¦æ³¨å†Œåˆ° Spring å®¹å™¨å½“ä¸­ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œ@AutoConfigurationPackage å’Œ @Importï¼Œ@AutoConfigurationPackage çš„ä½œç”¨æ˜¯å®ƒæ‰€æ ‡æ³¨çš„ç±»çš„åŒ…åä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œæ”¾åˆ°å®¹å™¨ä¸­ï¼Œå°†æ¥ä½ è¦ç”¨åˆ°è¿™ä¸ªåŒ…åçš„æ—¶å€™ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ä¸€ä¸ªå·¥å…·ç±»åˆ°å®¹å™¨ä¸­æ‰¾åˆ°è¿™ä¸ªåŒ…å\r\n* @SpringBootConfiguration æ˜¯è¡¨ç¤ºä¸€ä¸ªé’ˆå¯¹ SpringBoot çš„é…ç½®ç±»ï¼Œè·ŸåŸç”Ÿçš„ @Configuration å‡ ä¹ç­‰ä»·ï¼Œå®ƒè·Ÿ @Configuration åŒºåˆ«åœ¨å“ªå‘¢ï¼Œå…¶å®ç”¨ @Configuration æ ‡æ³¨çš„ï¼Œå°†æ¥ä¸€ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥æœ‰å¤šä¸ªçš„é…ç½®ç±»ï¼Œä½†æ˜¯ @SpringBootConfiguration å®ƒå¯¹åº”çš„é…ç½®ç±»å‘¢ï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºåªå¯ä»¥æœ‰è¿™ä¹ˆä¸€ä¸ªé…ç½®ç±»ï¼ˆåº”ç”¨ç¨‹åºç±»ï¼‰ï¼Œå› ä¸ºå®ƒè¦æ ¹æ®å®ƒæ–­å®šä½ çš„ä¸»é…ç½®ï¼Œæ ¹æ®ä½ çš„ä¸»é…ç½®ç±»æ‰¾åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œç®—æ˜¯ä¸€ä¸ªå…¥å£\r\n\r\n![image-20230422190402081](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422190402081.png)\r\n\r\n**condition**ï¼ˆå¯¹@Conditionalçš„ä¸€ä¸ªæ‰©å±•ï¼‰\r\n\r\n* @ConditionalOnClassæ˜¯å½“ä½ çš„ç±»è·¯å¾„ä¸‹åŒ…å«æŸä¸ªç±»æ—¶ï¼Œè¿™ä¸ªæ¡ä»¶æ‰ç®—æˆç«‹ï¼Œæ¯”å¦‚è¯´æˆ‘è¦é…ç½®æ•°æ®æºï¼Œå¯èƒ½å¸Œæœ›ç±»è·¯å¾„ä¸‹æœ‰å…·ä½“çš„æ•°æ®æºå®ç°ç±»ï¼Œå¦‚æœ‰ä¸€ä¸ªdriuidçš„DataSourceï¼Œè¿™ä¸ªæ¡ä»¶æ‰æˆç«‹ï¼Œå¦åˆ™ä¸æˆç«‹ï¼Œå³æ£€æŸ¥ç±»è·¯å¾„ä¸‹å¦‚æœæœ‰æŸä¸ªç±»å­˜åœ¨æ¡ä»¶æ‰æˆç«‹ï¼Œæ‰ä¼šæ‰§è¡Œåç»­çš„è£…é…ï¼›**classpath ä¸‹å­˜åœ¨æŸä¸ª class æ—¶ï¼Œæ¡ä»¶æ‰æˆç«‹**\r\n\r\n![image-20230422190325299](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230422190325299.png)\r\n\r\n* @ConditionalOnMissingBean æ˜¯å½“ä½ çš„å®¹å™¨ä¸­ç¼ºå¤±æŸä¸ª bean æ—¶ï¼Œæ¡ä»¶æ‰æˆç«‹ï¼Œå®ƒç»å¸¸ä½œä¸ºä¸€äº›åè¡¥çš„æ“ä½œï¼Œå¦‚ä½ æ²¡æœ‰æä¾›æŸä¸ª beanï¼Œå³å½“ä½ ç¼ºå¤±é…ç½®æŸä¸ª bean æ—¶æ¡ä»¶å°±ä¼šæˆç«‹ï¼ŒæŠŠä¸€ä¸ªé»˜è®¤çš„åè¡¥çš„ bean æ·»åŠ åˆ° Spring å®¹å™¨ä¸­ï¼Œè¿™ä¸ªç¼ºå¤±çš„æ¡ä»¶æ˜¯æ ¹æ® bean çš„åå­—æ¥åŒ¹é…çš„ï¼Œå¦‚æœå®¹å™¨ä¸­æ²¡æœ‰è¿™ä¸ª bean æ—¶æ¡ä»¶å°±æˆç«‹ï¼Œå¦‚æœè¿™ä¸ª bean çš„åå­—å·²ç»å­˜åœ¨äº†ï¼Œæ¡ä»¶å°±ä¸æˆç«‹ï¼›**beanFactory å†…ä¸å­˜åœ¨æŸä¸ª bean æ—¶ï¼Œæ¡ä»¶æ‰æˆç«‹**\r\n* @ConditionalOnProperty æ˜¯æ ¹æ® properties æ–‡ä»¶çš„é”®å€¼ä¿¡æ¯ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯åšäº†æŸäº›é”®å€¼çš„é…ç½®ï¼Œå¦‚æœè¿™äº›é”®å€¼é…ç½®äº†ï¼Œå¹¶ä¸”æ¡ä»¶ç›¸ç¬¦ï¼Œæ¡ä»¶æ‰ç®—æˆç«‹ï¼Œæ¯”å¦‚ä½ çš„æŸä¸ªé”®æˆ–å€¼è·Ÿè¿™ä¸ª @ConditionalOnProperty ä¸­å€¼ä¹Ÿä¸€è‡´äº†ï¼Œæ¡ä»¶æ‰ç®—æˆç«‹ï¼Œå¦‚æœä½ æ²¡æœ‰è¿™ä¸ªç›¸åº”çš„é”®å€¼ï¼Œæ¡ä»¶å°±ä¸æˆç«‹ï¼›**é…ç½®æ–‡ä»¶ä¸­å­˜åœ¨æŸä¸ª propertyï¼ˆé”®ã€å€¼ï¼‰æ—¶ï¼Œæ¡ä»¶æ‰æˆç«‹**\r\n\r\n**properties**\r\n\r\n* @ConfigurationPropertiesï¼Œä¼šå°†å½“å‰ bean çš„å±æ€§ä¸é…ç½®æ–‡ä»¶ä¸­çš„é”®å€¼è¿›è¡Œç»‘å®š\r\n  * @ConfigurationProperties æ˜¯æŠŠæˆ‘ä»¬ properties æ–‡ä»¶ä¸­çš„é”®å€¼ä¿¡æ¯è·Ÿ JavaBean çš„å±æ€§è¿›è¡Œç»‘å®šï¼Œå±æ€§åç§°ä¸è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­é”®çš„åç§°ç›¸åŒï¼Œå¯¹åº”çš„å€¼å°±ä¼šèµ‹å€¼ç»™æˆ‘ä»¬æ ‡æ³¨äº† @ConfigurationProperties çš„ Javabean çš„å±æ€§ï¼Œç›¸å½“äºç®€åŒ–äº†ä¸€äº› bean çš„åˆå§‹åŒ–ï¼Œå¦‚æœç”¨ @Value è™½ç„¶ä¹Ÿå¯ä»¥å¯¹è¿™ä¸ªå€¼è¿›è¡Œåˆå§‹åŒ–ï¼Œä½†æ˜¯æ¯”è¾ƒå¤æ‚ï¼Œ@ConfigurationProperties åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥å»ç®€åŒ– @Value çš„ä¸€äº›èµ‹å€¼æ“ä½œ\r\n\r\n* @EnableConfigurationProperties å°±æ˜¯å¯ç”¨ @ConfigurationProperties åŠŸèƒ½ï¼Œå®ƒä¹Ÿæ˜¯åœ¨ bean å·¥å‚åŠ äº†ä¸€äº›åå¤„ç†å™¨ï¼Œè¿™äº›åå¤„ç†å™¨èƒ½å¤Ÿè¯†åˆ« @ConfigurationProperties ï¼Œä¸€æ—¦è¯†åˆ«åˆ°å®ƒå°±ä¼šæ‰§è¡Œè¿™ä¸ªç»‘å®šæ“ä½œï¼Œ**ä¼šæ·»åŠ ä»¥ä¸‹ä¸¤ä¸ªè¾ƒä¸ºé‡è¦çš„ bean**\r\n  * ConfigurationPropertiesBindingPostProcessorï¼Œbean åå¤„ç†å™¨ï¼Œåœ¨ bean åˆå§‹åŒ–å‰è°ƒç”¨ä¸‹é¢çš„ binder\r\n  * ConfigurationPropertiesBinderï¼ŒçœŸæ­£æ‰§è¡Œç»‘å®šæ“ä½œ\r\n\r\n\r\n\r\n------\r\n\r\n## 7. SpringBoot è‡ªåŠ¨é…ç½®åŸç†\r\n\r\n**è‡ªåŠ¨é…ç½®åŸç†**\r\n\r\n![image-20230423003501071](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423003501071.png)\r\n\r\n@SpringBootApplication æ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œç”± @ComponentScanã€@EnableAutoConfiguration å’Œ @SpringBootConfiguration ç»„æˆ\r\n\r\n1. @SpringBootConfiguration ä¸æ™®é€š @Configuration ç›¸æ¯”ï¼Œå”¯ä¸€åŒºåˆ«æ˜¯å‰è€…è¦æ±‚æ•´ä¸ª app ä¸­åªå‡ºç°ä¸€æ¬¡\r\n2. @ComponentScan\r\n   * excludeFilters - ç”¨æ¥åœ¨ç»„ä»¶æ‰«ææ—¶è¿›è¡Œæ’é™¤ï¼Œä¹Ÿä¼šæ’é™¤è‡ªåŠ¨é…ç½®ç±»\r\n\r\n   ![image-20230423003533333](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423003533333.png)\r\n   \r\n3. @EnableAutoConfiguration ä¹Ÿæ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œç”±ä¸‹é¢æ³¨è§£ç»„æˆ\r\n   * @AutoConfigurationPackage â€“ ç”¨æ¥è®°ä½æ‰«æçš„èµ·å§‹åŒ…ï¼Œæ”¾åˆ°å®¹å™¨ä¸­ï¼Œå°†æ¥è¦ç”¨åˆ°åŒ…åæ—¶å¯ä»¥ç”¨ä¸€ä¸ªå·¥å…·ç±»åˆ°å®¹å™¨ä¸­æ‰¾åˆ°\r\n   * @Import(AutoConfigurationImportSelector.class) ç”¨æ¥åŠ è½½ `META-INF/spring.factories` ä¸­çš„è‡ªåŠ¨é…ç½®ç±»\r\n   \r\n   ![image-20230423004955603](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230423004955603.png)\r\n\r\n**ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ @Import ç›´æ¥å¼•å…¥è‡ªåŠ¨é…ç½®ç±»**\r\n\r\næœ‰ä¸¤ä¸ªåŸå› ï¼š\r\n\r\n1. è®©ä¸»é…ç½®ç±»å’Œè‡ªåŠ¨é…ç½®ç±»å˜æˆäº†å¼ºè€¦åˆï¼Œä¸»é…ç½®ç±»ä¸åº”è¯¥çŸ¥é“æœ‰å“ªäº›ä»å±é…ç½®\r\n2. ç›´æ¥ç”¨ `@Import(è‡ªåŠ¨é…ç½®ç±».class)`ï¼Œå¼•å…¥çš„é…ç½®è§£æä¼˜å…ˆçº§è¾ƒé«˜ï¼Œè‡ªåŠ¨é…ç½®ç±»çš„è§£æåº”è¯¥åœ¨ä¸»é…ç½®æ²¡æä¾›æ—¶ä½œä¸ºé»˜è®¤é…ç½®\r\n\r\nå› æ­¤ï¼Œé‡‡ç”¨äº† `@Import(AutoConfigurationImportSelector.class)`\r\n\r\n* ç”± `AutoConfigurationImportSelector.class` å»è¯»å– `META-INF/spring.factories` ä¸­çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œå®ç°äº†å¼±è€¦åˆã€‚\r\n* å¦å¤– `AutoConfigurationImportSelector.class` å®ç°äº† DeferredImportSelector æ¥å£ï¼Œè®©è‡ªåŠ¨é…ç½®çš„è§£ææ™šäºä¸»é…ç½®çš„è§£æ\r\n\r\n\r\n\r\n\r\n\r\n------\r\n\r\n## 8. Spring ä¸­çš„è®¾è®¡æ¨¡å¼\r\n\r\n### **1. Spring ä¸­çš„ Singleton**\r\n\r\n**è¯·å¤§å®¶åŒºåˆ† singleton pattern ä¸ Spring ä¸­çš„ singleton bean**\r\n\r\n* æ ¹æ®å•ä¾‹æ¨¡å¼çš„ç›®çš„ *Ensure a class only has one instance, and provide a global point of access to it* \r\n* æ˜¾ç„¶ Spring ä¸­çš„ singleton bean å¹¶éå®ç°äº†å•ä¾‹æ¨¡å¼ï¼Œsingleton bean åªèƒ½ä¿è¯æ¯ä¸ªå®¹å™¨å†…ï¼Œç›¸åŒ id çš„ bean å•å®ä¾‹\r\n* å½“ç„¶ Spring ä¸­ä¹Ÿç”¨åˆ°äº†å•ä¾‹æ¨¡å¼ï¼Œä¾‹å¦‚\r\n  * `org.springframework.transaction.TransactionDefinition#withDefaults`\r\n  * `org.springframework.aop.TruePointcut#INSTANCE`\r\n  * `org.springframework.aop.interceptor.ExposeInvocationInterceptor#ADVISOR`\r\n  * `org.springframework.core.annotation.AnnotationAwareOrderComparator#INSTANCE`\r\n  * `org.springframework.core.OrderComparator#INSTANCE`\r\n\r\n> å•ä¾‹æ¨¡å¼çš„åŸå§‹å®šä¹‰æ˜¯ç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶ä¸”æåˆ°ä¸€ä¸ªå…¨å±€çš„è®¿é—®ç‚¹ï¼Œåˆ™Springä¸­çš„ Singleton bean æ˜¯ä¸ç¬¦åˆçš„ï¼Œå› ä¸ºä½ ä¸€ä¸ª Spring å®¹å™¨ä¸­å¯ä»¥ä¸€ä¸ªç±»å‹å®šä¹‰å¤šä¸ªå®ä¾‹ï¼Œåªè¦å¤šä¸ª bean å®ƒä»¬çš„ id å’Œåå­—æœ‰å¯èƒ½ä¸ä¸€æ ·ï¼Œåˆ™å¯èƒ½æœ‰å¤šä¸ªå®ä¾‹ï¼Œè€Œä¸” Spring å¯ä»¥æœ‰å¤šä¸ªå®¹å™¨çš„ï¼Œå¤šä¸ªå®¹å™¨åŒä¸€ä¸ªç±»ä¹Ÿå¯èƒ½æœ‰ä¸åŒçš„å®ä¾‹ï¼ŒåŒæ ·çš„ propertype bean ä¹Ÿä¸æ˜¯åŸå‹æ¨¡å¼\r\n\r\n\r\n\r\n------\r\n\r\n### **2. Spring ä¸­çš„ Builder**\r\n\r\nå®šä¹‰ï¼š *Separate the construction of a complex object from its representation so that the same construction process can create different representations* \r\n\r\nå®ƒä¸»è¦çš„äº®ç‚¹æœ‰ä¸‰å¤„ï¼š\r\n\r\n1. è¾ƒä¸ºçµæ´»çš„æ„å»ºäº§å“å¯¹è±¡\r\n\r\n2. åœ¨ä¸æ‰§è¡Œæœ€å build æ–¹æ³•å‰ï¼Œäº§å“å¯¹è±¡éƒ½ä¸å¯ç”¨\r\n\r\n3. æ„å»ºè¿‡ç¨‹é‡‡ç”¨é“¾å¼è°ƒç”¨ï¼Œçœ‹èµ·æ¥æ¯”è¾ƒçˆ½\r\n\r\nSpring ä¸­ä½“ç° Builder æ¨¡å¼çš„åœ°æ–¹ï¼šï¼ˆè¿™ç§ä»¥Builderç»“å°¾çš„å‘½åçš„ï¼Œä¸€èˆ¬æ¥è®²éƒ½å¯ä»¥çœ‹ä½œå®ƒæ˜¯å®ç°äº†è¿™ç§æ„å»ºå™¨å¯¹è±¡ï¼Œå¯ä»¥å¯¹ç…§ç€å®ƒçš„å®šä¹‰çœ‹ä¸€ä¸‹ï¼‰\r\n\r\n* org.springframework.beans.factory.support.BeanDefinitionBuilder\r\n\r\n* org.springframework.web.util.UriComponentsBuilder\r\n\r\n* org.springframework.http.ResponseEntity.HeadersBuilder\r\n\r\n* org.springframework.http.ResponseEntity.BodyBuilder\r\n\r\n> Builder å»ºé€ å™¨æ¨¡å¼ï¼Œå®ƒç”¨åœ¨ä¸€ä¸ªå¯¹è±¡å»ºé€ è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥ç”¨è¿™ä¸ªæ„å»ºå™¨è·Ÿå¯¹è±¡æŠŠå®ƒä¿©åˆ†ç¦»å¼€æ¥ï¼Œè¿™ä¸ªæ„å»ºå™¨è´Ÿè´£å¯¹è±¡åˆ›å»ºå‰çš„å‡†å¤‡ï¼Œæœ€ç»ˆè°ƒç”¨å®ƒçš„Builderæ–¹æ³•åˆ›å»ºæœ€ç»ˆçš„äº§å“å¯¹è±¡\r\n\r\n\r\n\r\n------\r\n\r\n### **3. Spring ä¸­çš„ Factory Method**\r\n\r\nå®šä¹‰ï¼š *Define an interface for creating an object, but let subclasses decide which class to instantiate. Factory Method lets a class defer instantiation to subclasses* \r\n\r\næ ¹æ®ä¸Šé¢çš„å®šä¹‰ï¼ŒSpring ä¸­çš„ ApplicationContext ä¸ BeanFactory ä¸­çš„ getBean éƒ½å¯ä»¥è§†ä¸ºå·¥å‚æ–¹æ³•ï¼Œå®ƒéšè—äº† bean ï¼ˆäº§å“ï¼‰çš„åˆ›å»ºè¿‡ç¨‹å’Œå…·ä½“å®ç°ï¼›\r\n\r\n> å› ä¸ºä½  getBean å‡ºæ¥æœ‰å¯èƒ½æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä½†æ˜¯å…·ä½“å®ç°ä½ ä¹Ÿä¸çŸ¥é“ï¼Œå®ƒéƒ½æ˜¯åœ¨ Spring çš„é…ç½®æ–‡ä»¶æˆ–é…ç½®ç±» bean (äº§å“)çš„åˆ›å»ºè¿‡ç¨‹å’Œå…·ä½“å®ç°å·²ç»å®šä¹‰å¥½äº†ï¼Œå¹¶ä¸”ä½ æ€ä¹ˆæ„å»ºä¹Ÿä¸çŸ¥é“ï¼Œä¹Ÿä¸ç”¨å»å…³å¿ƒï¼Œç”šè‡³ä½ ä¸ç”¨æ¥å£å» getBean å®ƒæœ‰å¯èƒ½ç»™ä½ è¿”å›çš„æ˜¯ä¸€ä¸ª**ä»£ç†**ï¼Œå³éšè—äº† bean åˆ›å»ºè¿‡ç¨‹å’Œå…·ä½“å®ç°\r\n\r\nSpring ä¸­å…¶å®ƒå·¥å‚ï¼š\r\n\r\n* org.springframework.beans.factory.FactoryBean\r\n\r\n* @Bean æ ‡æ³¨çš„é™æ€æ–¹æ³•åŠå®ä¾‹æ–¹æ³•\r\n\r\n* ObjectFactory åŠ ObjectProvider\r\n\r\nå‰ä¸¤ç§å·¥å‚ä¸»è¦å°è£…ç¬¬ä¸‰æ–¹çš„ bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œåä¸¤ç§å·¥å‚å¯ä»¥æ¨è¿Ÿ bean åˆ›å»ºï¼Œè§£å†³å¾ªç¯ä¾èµ–åŠå•ä¾‹æ³¨å…¥å¤šä¾‹ç­‰é—®é¢˜\r\n\r\n> Factory Methodå·¥å‚æ–¹æ³•æ¨¡å¼ï¼ŒæŠ›å¼€å®ƒçš„å®šä¹‰ï¼Œå®ƒçš„æ ¸å¿ƒå°±æ˜¯å»è®©æˆ‘ä»¬çš„æ¥å£å’Œå®ç°ç›¸åˆ†ç¦»ï¼Œå»é™ä½è€¦åˆï¼Œè¿™æ˜¯å®ƒæœ€é‡è¦çš„ç›®çš„\r\n\r\n\r\n\r\n------\r\n\r\n### **4. Spring ä¸­çš„ Adapter**\r\n\r\nå®šä¹‰ï¼š *Convert the interface of a class into another interface clients expect. Adapter lets classes work together that couldn't otherwise because of incompatible interfaces* \r\n\r\nå…¸å‹çš„å®ç°æœ‰ä¸¤å¤„ï¼š\r\n\r\n* `org.springframework.web.servlet.HandlerAdapter` â€“ å› ä¸ºæ§åˆ¶å™¨å®ç°æœ‰å„ç§å„æ ·ï¼Œæ¯”å¦‚æœ‰\r\n  * å¤§å®¶ç†Ÿæ‚‰çš„ @RequestMapping æ ‡æ³¨çš„æ§åˆ¶å™¨å®ç°\r\n  * ä¼ ç»Ÿçš„åŸºäº Controller æ¥å£ï¼ˆä¸æ˜¯ @Controller æ³¨è§£å•Šï¼‰çš„å®ç°\r\n  * è¾ƒæ–°çš„åŸºäº RouterFunction æ¥å£çš„å®ç°\r\n  * å®ƒä»¬çš„å¤„ç†æ–¹æ³•éƒ½ä¸ä¸€æ ·ï¼Œä¸ºäº†ç»Ÿä¸€è°ƒç”¨ï¼Œå¿…é¡»é€‚é…ä¸º HandlerAdapter æ¥å£\r\n* `org.springframework.beans.factory.support.DisposableBeanAdapter` â€“ å› ä¸ºé”€æ¯æ–¹æ³•å¤šç§å¤šæ ·ï¼Œå› æ­¤éƒ½è¦é€‚é…ä¸º DisposableBean æ¥ç»Ÿä¸€è°ƒç”¨é”€æ¯æ–¹æ³• \r\n\r\n> Adapteré€‚é…å™¨æ¨¡å¼ï¼Œé€‚é…å™¨æ¨¡å¼çš„å®šä¹‰æ˜¯æŠŠä¸€ä¸ªæˆ–ä¸€å¥—æ¥å£è½¬æ¢æˆå¦ä¸€å¥—è°ƒç”¨è€…æ‰€æœŸæœ›çš„æ¥å£\r\n\r\n\r\n\r\n------\r\n\r\n### **5. Spring ä¸­çš„ Composite**\r\n\r\nå®šä¹‰ï¼š *Compose objects into tree structures to represent part-whole hierarchies. Composite lets clients treat individual objects and compositions of objects uniformly* \r\n\r\nå…¸å‹å®ç°æœ‰ï¼š\r\n\r\n* org.springframework.web.method.support.HandlerMethodArgumentResolverComposite\r\n* org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite\r\n* org.springframework.web.servlet.handler.HandlerExceptionResolverComposite\r\n* org.springframework.web.servlet.view.ViewResolverComposite\r\n\r\ncomposite å¯¹è±¡çš„ä½œç”¨æ˜¯ï¼Œå°†åˆ†æ•£çš„è°ƒç”¨é›†ä¸­èµ·æ¥ï¼Œç»Ÿä¸€è°ƒç”¨å…¥å£ï¼Œå®ƒçš„ç‰¹å¾æ˜¯ï¼Œä¸å…·ä½“å¹²æ´»çš„å®ç°å®ç°çš„æ˜¯åŒä¸€ä¸ªæ¥å£ï¼Œå½“è°ƒç”¨ composite å¯¹è±¡çš„æ¥å£æ–¹æ³•æ—¶ï¼Œå…¶å®æ˜¯å§”æ‰˜å…·ä½“å¹²æ´»çš„å®ç°æ¥å®Œæˆ\r\n\r\n> Composite ç»„åˆæ¨¡å¼ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†åˆ†æ•£çš„è°ƒç”¨é›†ä¸­èµ·æ¥ï¼Œç»Ÿä¸€è°ƒç”¨å…¥å£ï¼Œå¦‚åœ¨ SpringMVC ä¸­ï¼Œåœ¨è°ƒç”¨æŸä¸ªæ§åˆ¶å™¨æ–¹æ³•å‰éƒ½è¦ç»™å®ƒå‡†å¤‡å„ç§å„æ ·çš„å‚æ•°ï¼Œä¸åŒçš„å‚æ•°å®ƒçš„æ¥æºæ˜¯ä¸ä¸€æ ·çš„ï¼Œè·å–æ–¹å¼ä¹Ÿä¸ä¸€æ ·ï¼Œå¦‚æœ‰çš„æ˜¯ä»è·¯å¾„ä¸­è·å–å‚æ•°ï¼Œæœ‰çš„æ˜¯ä»è¯·æ±‚å‚æ•°è·å–ä¿¡æ¯ï¼Œæœ‰çš„æ˜¯è¦ç”Ÿæˆä¸€ä¸ª Model æ¨¡å‹å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œæœ‰çš„æ˜¯ä»ä¼ ç»Ÿçš„ requestï¼Œresponse ä¸­è·å–å‚æ•°ï¼Œæ‰€ä»¥è¿™ç§ä¸åŒçš„å‚æ•°çš„è§£æä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™ä¹ˆå¤šå‚æ•°çš„è§£æå™¨ï¼Œæˆ‘ä»¬è¦æŠŠå®ƒä»¬çš„è°ƒç”¨ç»Ÿä¸€èµ·æ¥ï¼Œæˆ‘ä»¬å°±æä¾›ä¸€ä¸ª HandlerMethodArgumentResloverCompositeï¼Œå³å‚æ•°è§£æå™¨çš„ç»„åˆå™¨ï¼Œå°†æ¥åªéœ€è¦è°ƒç”¨ç»„åˆå™¨å°±è¡Œï¼Œç»„åˆå™¨é‡Œæœ‰ä¸ªé›†åˆï¼Œè¿™ä¸ªé›†åˆé‡Œæœ‰å„ç§å„æ ·çš„å‚æ•°è§£æå™¨ï¼Œè¿™æ ·å°±æŠŠåˆ†æ•£çš„è°ƒç”¨é›†ä¸­èµ·æ¥ï¼Œç»Ÿä¸€è°ƒç”¨å…¥å£ï¼Œå®ƒçš„ç‰¹å¾æ˜¯ä¸å…·ä½“å¹²æ´»çš„å®ç°å®ç°çš„æ˜¯åŒä¸€ä¸ª HandlerMethodArgumentReslover æ¥å£ï¼Œå½“è°ƒç”¨ composite ç»„åˆå™¨å¯¹è±¡çš„æ¥å£æ–¹æ³•æ—¶ï¼Œå…¶å®æ˜¯å§”æ‰˜å…·ä½“å¹²æ´»çš„å®ç°æ¥å®Œæˆçš„\r\n\r\n\r\n\r\n------\r\n\r\n### **6. Spring ä¸­çš„ Decorator**\r\n\r\nå®šä¹‰ï¼š *Attach additional responsibilities to an object dynamically. Decorators provide a flexible alternative to subclassing for extending functionality* \r\n\r\nå…¸å‹å®ç°ï¼š\r\n\r\n* org.springframework.web.util.ContentCachingRequestWrapper\r\n\r\n> Decorator è£…é¥°å™¨æ¨¡å¼ï¼Œå®ƒçš„å®šä¹‰æ˜¯å¯¹ä¸€ä¸ªå¯¹è±¡åŠ¨æ€åœ°å»å¢åŠ ä¸€äº›èŒè´£å’ŒåŠŸèƒ½ï¼Œå®ƒä¸»è¦è§£å†³è¿™ç§ç”¨å­ç±»æ‰©å±•æ–¹å¼æ¥å®ç°è¿™ç§åŠŸèƒ½å¢å¼ºçš„é—®é¢˜ï¼Œå› ä¸ºå­ç±»å»å®ç°åŠŸèƒ½å¢å¼ºæœ€å¤§çš„é—®é¢˜æ˜¯å­ç±»ä¸ç®¡ç”¨ä¸ç”¨çš„åˆ°ï¼Œå®ƒéƒ½å¾—æŠŠçˆ¶ç±»çš„æ–¹æ³•ç»§æ‰¿è¿‡æ¥ï¼Œå³ç»§æ‰¿äº†å¾ˆå¤šå®ƒç”¨ä¸ä¸Šçš„çˆ¶ç±»æ–¹æ³•ï¼Œè£…é¥°å™¨å°±å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå®ƒè·Ÿä»£ç†æ¨¡å¼çš„å®šä¹‰å¾ˆåƒï¼Œä¹Ÿæ˜¯åšåŠŸèƒ½å¢å¼ºï¼Œä½†åšåŠŸèƒ½å¢å¼ºçš„å®é™…ä¸Šä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ˜¯é‚£äº›é€šçŸ¥(ç¯ç»•é€šçŸ¥ä¹‹ç±»çš„)ï¼Œä»£ç†å…¶å®åªèµ·åˆ°ä¸€ä¸ªå…¥å£çš„ä½œç”¨ï¼Œä»£ç†åªèµ·åˆ°å¯¹ç›®æ ‡å¯¹è±¡å’Œç›®æ ‡æ–¹æ³•æä¾›ä¸€ä¸ªç»Ÿä¸€å…¥å£çš„ä½œç”¨ï¼ŒæŠŠå®ƒä»¬ç»“åˆèµ·æ¥\r\n\r\n\r\n\r\n------\r\n\r\n### **7. Spring ä¸­çš„ Proxy**\r\n\r\nå®šä¹‰ï¼š *Provide a surrogate or placeholder for another object to control access to it* \r\n\r\nè£…é¥°å™¨æ¨¡å¼æ³¨é‡çš„æ˜¯åŠŸèƒ½å¢å¼ºï¼Œé¿å…å­ç±»ç»§æ‰¿æ–¹å¼è¿›è¡ŒåŠŸèƒ½æ‰©å±•ï¼Œè€Œä»£ç†æ¨¡å¼æ›´æ³¨é‡æ§åˆ¶ç›®æ ‡çš„è®¿é—®\r\n\r\nå…¸å‹å®ç°ï¼š\r\n\r\n* org.springframework.aop.framework.JdkDynamicAopProxy\r\n  * ç”¨jdkåŠ¨æ€ä»£ç†çš„æ–¹å¼ç”Ÿæˆæœ€ç»ˆçš„ä»£ç†å¯¹è±¡ï¼Œå®ƒçš„é™åˆ¶æ˜¯è¦æ±‚ä½ çš„ç›®æ ‡å¯¹è±¡å¿…é¡»å®ç°ä¸€ä¸ªæ¥å£ï¼Œé‚£ç”Ÿæˆçš„ä»£ç†ä¹Ÿæ˜¯é’ˆå¯¹è¿™ä¸ªæ¥å£ä»£ç†\r\n\r\n* org.springframework.aop.framework.ObjenesisCglibAopProxy\r\n  * æ—¢å¯ä»¥é’ˆå¯¹æ¥å£ä»£ç†ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆä¸€ä¸ªå­ç±»ä½œä¸ºä»£ç†ï¼Œ**Objenesisæ˜¯åšè¡¥å……çš„ï¼ˆæä¾›ä¸€ä¸ªæ— å‚æ„é€ ï¼‰**ï¼Œè¿™ç§å¦‚æœä½ çš„ç›®æ ‡å®ƒæ²¡æœ‰æ— å‚æ„é€ ï¼Œé‚£å®ƒåœ¨åˆ›å»ºè¿™ä¸ªç›®æ ‡å¯¹è±¡æ—¶å°±åˆ›å»ºä¸äº†ï¼Œå®ƒå¿…é¡»è®©ç›®æ ‡æä¾›ä¸€ä¸ªæ— å‚æ„é€ \r\n  * Objenesisç›¸å½“äºä¸€ä¸ªå°å·¥å…·ï¼Œå³ä½¿ä½ çš„ç›®æ ‡åªæœ‰ä¸€äº›å¸¦å‚æ„é€ ï¼Œæ²¡æœ‰æ— å‚æ„é€ ï¼Œå®ƒä¹Ÿå¯ä»¥ç”Ÿæˆä¸€ä¸ªç©ºç©ºå¦‚ä¹Ÿçš„å¯¹è±¡ï¼Œè®©è¿™ä¸ªä»£ç†èƒ½å¤Ÿåˆ›å»ºæˆåŠŸ\r\n\r\n> Proxyä»£ç†æ¨¡å¼ï¼Œå®ƒåŸæœ¬çš„å®šä¹‰æ˜¯å¯¹å¦å¤–çš„å¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†æˆ–è€…å ä½ç”¨æ¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ï¼Œå³ä¾§é‡äºå¯¹è¿™ä¸ªç›®æ ‡å¯¹è±¡çš„æ§åˆ¶å’Œè®¿é—®ï¼Œè€Œä¸æ˜¯ä¾§é‡äºå¯¹ç›®æ ‡å¯¹è±¡åšåŠŸèƒ½å¢å¼ºçš„\r\n\r\n\r\n\r\n------\r\n\r\n### **8. Spring ä¸­çš„ Chain of Responsibility**\r\n\r\nå®šä¹‰ï¼š *Avoid coupling the sender of a request to its receiver by giving more than one object a chance to handle the request. Chain the receiving objects and pass the request along the chain until an object handles it* \r\n\r\nå…¸å‹å®ç°ï¼š\r\n\r\n* org.springframework.web.servlet.HandlerInterceptor\r\n\r\n> Chain of Responsibilityè´£ä»»é“¾æ¨¡å¼ï¼Œå®ƒçš„å®šä¹‰æ˜¯å°†æ¥å¯ä»¥æœ‰å¤šä¸ªè¯·æ±‚çš„å¤„ç†å¯¹è±¡ï¼ŒæŠŠè¿™å¤šä¸ªè¯·æ±‚çš„å¤„ç†å¯¹è±¡ä¸²æˆä¸€ä¸ªé“¾ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚å°±ä¼šæ²¿ç€è¿™ä¸ªå¤„ç†é“¾ä¾æ¬¡å‘åä¼ é€’ï¼Œç›´åˆ°é‡åˆ°ä¸€ä¸ªèƒ½å¤Ÿå¤„ç†å®ƒçš„å¯¹è±¡ä¸ºæ­¢ï¼Œæ ¹æ®è¿™ä¸ªå®šä¹‰ï¼ŒSpringMVCçš„HandlerInterceptoræ‹¦æˆªå™¨æ˜¯ç¬¦åˆè¿™ä¸ªå®šä¹‰çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨æ‹¦æˆªå™¨çš„æ—¶å€™éƒ½çŸ¥é“ï¼Œå¤šä¸ªæ‹¦æˆªå™¨éƒ½ä¼šå’Œæœ€ç»ˆçš„è¿™ä¸ªæ§åˆ¶å™¨æ–¹æ³•å½¢æˆä¸€ä¸ªè°ƒç”¨é“¾ï¼Œè¿™ä¸ªè°ƒç”¨é“¾å…¶å®å°±æ˜¯æˆ‘ä»¬è¿™é‡Œçš„è´£ä»»é“¾ï¼Œè¯·æ±‚ä¼šæ²¿ç€è¿™ä¸ªè°ƒç”¨é“¾ï¼Œå…ˆç»™è°ƒç”¨é“¾é‡Œç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨å¤„ç†å®Œåæ”¾è¡Œäº†å°±äº¤ç»™ç¬¬äºŒä¸ªæ‹¦æˆªå™¨ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæœ€ç»ˆåˆ°è¾¾æˆ‘ä»¬çš„è¿™ä¸ªæ§åˆ¶å™¨æ–¹æ³•æ¥è°ƒç”¨å®ƒï¼Œè¿™å°±æ˜¯æ‹¦æˆªå™¨çš„ä¸€ä¸ªå…¸å‹ä½“ç°\r\n\r\n\r\n\r\n------\r\n\r\n### **9. Spring ä¸­çš„ Observer**\r\n\r\nå®šä¹‰ï¼š *Define a one-to-many dependency between objects so that when one object changes state, all its dependents are notified and updated automatically* \r\n\r\nå…¸å‹å®ç°ï¼š\r\n\r\n* org.springframework.context.ApplicationListener\r\n* org.springframework.context.event.ApplicationEventMulticaster\r\n* org.springframework.context.ApplicationEvent\r\n\r\n> Observerè§‚å¯Ÿè€…æ¨¡å¼ï¼Œä½œç”¨å°±æ˜¯ç”¨æ¥è§£è€¦çš„ï¼Œå®ƒä¸»è¦ä½“ç°åœ¨Springå®ƒå®ç°äº†è¿™ç§ApplicationListenerç›‘å¬å™¨(æ¥æ”¶äº‹ä»¶)ï¼ŒApplicationEventMulticasteräº‹ä»¶å¹¿æ’­å™¨(å‘ç”Ÿäº‹ä»¶)ï¼Œæƒ³å½“äºæŠŠå‘é€è€…å’Œæ¥æ”¶è€…è¿›è¡Œä¸€ä¸ªè§£è€¦ï¼Œè¿˜æœ‰ä¸€ä¸ªApplicationEventå¯¹è±¡\r\n\r\n\r\n\r\n------\r\n\r\n### **10. Spring ä¸­çš„ Strategy**\r\n\r\nå®šä¹‰ï¼š *Define a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently from clients that use it* \r\n\r\nå…¸å‹å®ç°ï¼š\r\n\r\n* org.springframework.beans.factory.support.InstantiationStrategy\r\n* org.springframework.core.annotation.MergedAnnotations.SearchStrategy\r\n  * æŸ¥æ‰¾æ³¨è§£çš„æ—¶å€™,å®ƒæ˜¯è¦åˆ°å½“å‰ç±»æŸ¥æ‰¾è¿˜æ˜¯è¦è€ƒè™‘å®ƒçš„çˆ¶ç±»å‘¢ï¼Œå°±ç”¨åˆ°å¤šç§ç­–ç•¥æ–¹å¼\r\n\r\n* org.springframework.boot.autoconfigure.condition.SearchStrategy\r\n  * åšæ¡ä»¶åˆ¤æ–­çš„æ—¶å€™ï¼ŒåŒæ ·çš„æ¡ä»¶åˆ¤æ–­æ˜¯çœ‹çœ‹ä½ çš„è¿™ä¸ªbeanæ˜¯å½“å‰å®¹å™¨é‡Œè¿˜æ˜¯åœ¨è¿™ä¸ªçˆ¶å®¹å™¨é‡Œå‘¢ï¼Œè¿˜æ˜¯åœ¨æ‰€æœ‰å®¹å™¨é‡Œéƒ½å»æ‰¾å‘¢ï¼Œä¹Ÿæ˜¯æœ‰ä¸€ä¸ªæœç´¢çš„ç­–ç•¥\r\n\r\n\r\n\r\n------\r\n\r\n\r\n### **11. Spring ä¸­çš„ Template Method**\r\n\r\nå®šä¹‰ï¼š *Define the skeleton of an algorithm in an operation, deferring some steps to subclasses. Template Method lets subclasses redefine certain steps of an algorithm without changing the algorithm's structure* \r\n\r\nå…¸å‹å®ç°ï¼š\r\n\r\n* å¤§éƒ¨åˆ†ä»¥ Template å‘½åçš„ç±»ï¼Œå¦‚ JdbcTemplateï¼ŒTransactionTemplate\r\n* å¾ˆå¤šä»¥ Abstract å‘½åçš„ç±»ï¼Œå¦‚ AbstractApplicationContext"},{"title":"Javaé¢è¯•ä¸“é¢˜-è™šæ‹Ÿæœºç¯‡","tags":["JVM"],"categories":["Java","é¢è¯•"],"author":"","excerpt":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥Javaé¢è¯•ä¸“é¢˜](https://www.bilibili.com/video/BV15b4y117RJ)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n","link":"/posts/Java_Interview_Topics-JVM","content":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥Javaé¢è¯•ä¸“é¢˜](https://www.bilibili.com/video/BV15b4y117RJ)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n<!-- more -->\r\n\r\n## 1. JVM å†…å­˜ç»“æ„\r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡ JVM å†…å­˜ç»“æ„åˆ’åˆ†\r\n* å°¤å…¶è¦çŸ¥é“æ–¹æ³•åŒºã€æ°¸ä¹…ä»£ã€å…ƒç©ºé—´çš„å…³ç³»\r\n\r\n**ç»“åˆä¸€æ®µ java ä»£ç çš„æ‰§è¡Œç†è§£å†…å­˜åˆ’åˆ†**\r\n\r\n![image-20210831165728217](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831165728217.png)\r\n\r\n* æ‰§è¡Œ javac å‘½ä»¤ç¼–è¯‘æºä»£ç ä¸ºå­—èŠ‚ç \r\n* æ‰§è¡Œ java å‘½ä»¤\r\n  1. åˆ›å»º JVMï¼Œè°ƒç”¨ç±»åŠ è½½å­ç³»ç»ŸåŠ è½½ classï¼Œå°†ç±»çš„ä¿¡æ¯å­˜å…¥**æ–¹æ³•åŒº**\r\n  2. åˆ›å»º main çº¿ç¨‹ï¼Œä½¿ç”¨çš„å†…å­˜åŒºåŸŸæ˜¯ **JVM è™šæ‹Ÿæœºæ ˆ**ï¼Œå¼€å§‹æ‰§è¡Œ main æ–¹æ³•ä»£ç \r\n  3. å¦‚æœé‡åˆ°äº†æœªè§è¿‡çš„ç±»ï¼Œä¼šç»§ç»­è§¦å‘ç±»åŠ è½½è¿‡ç¨‹ï¼ŒåŒæ ·ä¼šå­˜å…¥**æ–¹æ³•åŒº**\r\n  4. éœ€è¦åˆ›å»ºå¯¹è±¡ï¼Œä¼šä½¿ç”¨**å †**å†…å­˜æ¥å­˜å‚¨å¯¹è±¡\r\n  5. ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œä¼šç”±**åƒåœ¾å›æ”¶å™¨**åœ¨å†…å­˜ä¸è¶³æ—¶å›æ”¶å…¶å†…å­˜\r\n  6. è°ƒç”¨æ–¹æ³•æ—¶ï¼Œæ–¹æ³•å†…çš„å±€éƒ¨å˜é‡ã€æ–¹æ³•å‚æ•°æ‰€ä½¿ç”¨çš„æ˜¯  **JVM è™šæ‹Ÿæœºæ ˆ**ä¸­çš„æ ˆå¸§å†…å­˜\r\n  7. è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå…ˆè¦åˆ°**æ–¹æ³•åŒº**è·å¾—åˆ°è¯¥æ–¹æ³•çš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œç”±**è§£é‡Šå™¨**å°†å­—èŠ‚ç æŒ‡ä»¤è§£é‡Šä¸ºæœºå™¨ç æ‰§è¡Œ\r\n  8. è°ƒç”¨æ–¹æ³•æ—¶ï¼Œä¼šå°†è¦æ‰§è¡Œçš„æŒ‡ä»¤è¡Œå·è¯»åˆ°**ç¨‹åºè®¡æ•°å™¨**ï¼Œè¿™æ ·å½“å‘ç”Ÿäº†çº¿ç¨‹åˆ‡æ¢ï¼Œæ¢å¤æ—¶å°±å¯ä»¥ä»ä¸­æ–­çš„ä½ç½®ç»§ç»­\r\n  9. å¯¹äºé java å®ç°çš„æ–¹æ³•è°ƒç”¨ï¼Œä½¿ç”¨å†…å­˜ç§°ä¸º**æœ¬åœ°æ–¹æ³•æ ˆ**ï¼ˆè§è¯´æ˜ï¼‰\r\n  10. å¯¹äºçƒ­ç‚¹æ–¹æ³•è°ƒç”¨ï¼Œæˆ–è€…é¢‘ç¹çš„å¾ªç¯ä»£ç ï¼Œç”± **JIT å³æ—¶ç¼–è¯‘å™¨**å°†è¿™äº›ä»£ç ç¼–è¯‘æˆæœºå™¨ç ç¼“å­˜ï¼Œæé«˜æ‰§è¡Œæ€§èƒ½\r\n\r\nè¯´æ˜\r\n\r\n* åŠ ç²—å­—ä½“ä»£è¡¨äº† JVM è™šæ‹Ÿæœºç»„ä»¶\r\n* å¯¹äº Oracle çš„ Hotspot è™šæ‹Ÿæœºå®ç°ï¼Œä¸åŒºåˆ†è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆ\r\n\r\n**ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºçš„åŒºåŸŸ**\r\n\r\n* ä¸ä¼šå‡ºç°å†…å­˜æº¢å‡ºçš„åŒºåŸŸ â€“ ç¨‹åºè®¡æ•°å™¨\r\n* å‡ºç° OutOfMemoryError çš„æƒ…å†µ\r\n  * å †å†…å­˜è€—å°½ â€“ å¯¹è±¡è¶Šæ¥è¶Šå¤šï¼Œåˆä¸€ç›´åœ¨ä½¿ç”¨ï¼Œä¸èƒ½è¢«åƒåœ¾å›æ”¶\r\n  * æ–¹æ³•åŒºå†…å­˜è€—å°½ â€“ åŠ è½½çš„ç±»è¶Šæ¥è¶Šå¤šï¼Œå¾ˆå¤šæ¡†æ¶éƒ½ä¼šåœ¨è¿è¡ŒæœŸé—´åŠ¨æ€äº§ç”Ÿæ–°çš„ç±»\r\n  * è™šæ‹Ÿæœºæ ˆç´¯ç§¯ â€“ æ¯ä¸ªçº¿ç¨‹æœ€å¤šä¼šå ç”¨ 1 M å†…å­˜ï¼Œçº¿ç¨‹ä¸ªæ•°è¶Šæ¥è¶Šå¤šï¼Œè€Œåˆé•¿æ—¶é—´è¿è¡Œä¸é”€æ¯æ—¶\r\n* å‡ºç° StackOverflowError çš„åŒºåŸŸ\r\n  * JVM è™šæ‹Ÿæœºæ ˆï¼ŒåŸå› æœ‰æ–¹æ³•é€’å½’è°ƒç”¨æœªæ­£ç¡®ç»“æŸã€ååºåˆ—åŒ– json æ—¶å¾ªç¯å¼•ç”¨\r\n\r\n**æ–¹æ³•åŒºã€æ°¸ä¹…ä»£ã€å…ƒç©ºé—´**\r\n\r\n* **æ–¹æ³•åŒº**æ˜¯ JVM è§„èŒƒä¸­å®šä¹‰çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œç”¨æ¥å­˜å‚¨ç±»å…ƒæ•°æ®ã€æ–¹æ³•å­—èŠ‚ç ã€å³æ—¶ç¼–è¯‘å™¨éœ€è¦çš„ä¿¡æ¯ç­‰\r\n* **æ°¸ä¹…ä»£**æ˜¯ Hotspot è™šæ‹Ÿæœºå¯¹ JVM è§„èŒƒçš„å®ç°ï¼ˆ1.8 ä¹‹å‰ï¼‰\r\n* **å…ƒç©ºé—´**æ˜¯ Hotspot è™šæ‹Ÿæœºå¯¹ JVM è§„èŒƒçš„å¦ä¸€ç§å®ç°ï¼ˆ1.8 ä»¥åï¼‰ï¼Œä½¿ç”¨æœ¬åœ°å†…å­˜ä½œä¸ºè¿™äº›ä¿¡æ¯çš„å­˜å‚¨ç©ºé—´\r\n\r\n![image-20210831170457337](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831170457337.png)\r\n\r\nä»è¿™å¼ å›¾å­¦åˆ°ä¸‰ç‚¹\r\n\r\n* å½“ç¬¬ä¸€æ¬¡ç”¨åˆ°æŸä¸ªç±»æ˜¯ï¼Œç”±ç±»åŠ è½½å™¨å°† class æ–‡ä»¶çš„ç±»å…ƒä¿¡æ¯è¯»å…¥ï¼Œå¹¶å­˜å‚¨äºå…ƒç©ºé—´\r\n* Xï¼ŒY çš„ç±»å…ƒä¿¡æ¯æ˜¯å­˜å‚¨äºå…ƒç©ºé—´ä¸­ï¼Œæ— æ³•ç›´æ¥è®¿é—®\r\n* å¯ä»¥ç”¨ X.classï¼ŒY.class é—´æ¥è®¿é—®ç±»å…ƒä¿¡æ¯ï¼Œå®ƒä»¬ä¿©å±äº java å¯¹è±¡ï¼Œæˆ‘ä»¬çš„ä»£ç ä¸­å¯ä»¥ä½¿ç”¨\r\n\r\n![image-20210831170512418](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831170512418.png)\r\n\r\nä»è¿™å¼ å›¾å¯ä»¥å­¦åˆ°\r\n\r\n* å †å†…å­˜ä¸­ï¼šå½“ä¸€ä¸ª**ç±»åŠ è½½å™¨å¯¹è±¡**ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨å¯¹è±¡åŠ è½½çš„æ‰€æœ‰**ç±»å¯¹è±¡**ï¼Œè¿™äº›ç±»å¯¹è±¡å¯¹åº”çš„æ‰€æœ‰**å®ä¾‹å¯¹è±¡**éƒ½æ²¡äººå¼•ç”¨æ—¶ï¼ŒGC æ—¶å°±ä¼šå¯¹å®ƒä»¬å ç”¨çš„å¯¹å†…å­˜è¿›è¡Œé‡Šæ”¾\r\n* å…ƒç©ºé—´ä¸­ï¼šå†…å­˜é‡Šæ”¾**ä»¥ç±»åŠ è½½å™¨ä¸ºå•ä½**ï¼Œå½“å †ä¸­ç±»åŠ è½½å™¨å†…å­˜é‡Šæ”¾æ—¶ï¼Œå¯¹åº”çš„å…ƒç©ºé—´ä¸­çš„ç±»å…ƒä¿¡æ¯ä¹Ÿä¼šé‡Šæ”¾\r\n\r\n\r\n\r\n## 2. JVM å†…å­˜å‚æ•°\r\n\r\n**è¦æ±‚** \r\n\r\n* ç†Ÿæ‚‰å¸¸è§çš„ JVM å‚æ•°ï¼Œå°¤å…¶å’Œå¤§å°ç›¸å…³çš„\r\n\r\n**å †å†…å­˜ï¼ŒæŒ‰å¤§å°è®¾ç½®**\r\n\r\n![image-20210831173130717](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831173130717.png)\r\n\r\nè§£é‡Šï¼š\r\n\r\n* -Xms æœ€å°å †å†…å­˜ï¼ˆåŒ…æ‹¬æ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼‰\r\n* -Xmx æœ€å¤§å¯¹å†…å­˜ï¼ˆåŒ…æ‹¬æ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼‰\r\n* é€šå¸¸å»ºè®®å°† -Xms ä¸ -Xmx è®¾ç½®ä¸ºå¤§å°ç›¸ç­‰ï¼Œå³ä¸éœ€è¦ä¿ç•™å†…å­˜ï¼Œä¸éœ€è¦ä»å°åˆ°å¤§å¢é•¿ï¼Œè¿™æ ·æ€§èƒ½è¾ƒå¥½\r\n* -XX:NewSize ä¸ -XX:MaxNewSize è®¾ç½®æ–°ç”Ÿä»£çš„æœ€å°ä¸æœ€å¤§å€¼ï¼Œä½†ä¸€èˆ¬ä¸å»ºè®®è®¾ç½®ï¼Œç”± JVM è‡ªå·±æ§åˆ¶\r\n* -Xmn è®¾ç½®æ–°ç”Ÿä»£å¤§å°ï¼Œç›¸å½“äºåŒæ—¶è®¾ç½®äº† -XX:NewSize ä¸ -XX:MaxNewSize å¹¶ä¸”å–å€¼ç›¸ç­‰\r\n* ä¿ç•™æ˜¯æŒ‡ï¼Œä¸€å¼€å§‹ä¸ä¼šå ç”¨é‚£ä¹ˆå¤šå†…å­˜ï¼Œéšç€ä½¿ç”¨å†…å­˜è¶Šæ¥è¶Šå¤šï¼Œä¼šé€æ­¥ä½¿ç”¨è¿™éƒ¨åˆ†ä¿ç•™å†…å­˜ã€‚ä¸‹åŒ\r\n\r\n\r\n\r\n**å †å†…å­˜ï¼ŒæŒ‰æ¯”ä¾‹è®¾ç½®**\r\n\r\n![image-20210831173045700](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831173045700.png)\r\n\r\nè§£é‡Šï¼š\r\n\r\n* -XX:NewRatio=2:1 è¡¨ç¤ºè€å¹´ä»£å ä¸¤ä»½ï¼Œæ–°ç”Ÿä»£å ä¸€ä»½\r\n* -XX:SurvivorRatio=4:1 è¡¨ç¤ºæ–°ç”Ÿä»£åˆ†æˆå…­ä»½ï¼Œä¼Šç”¸å›­å å››ä»½ï¼Œfrom å’Œ to å„å ä¸€ä»½\r\n\r\n\r\n\r\n**å…ƒç©ºé—´å†…å­˜è®¾ç½®**\r\n\r\n![image-20210831173118634](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831173118634.png)\r\n\r\nè§£é‡Šï¼š\r\n\r\n* class space å­˜å‚¨ç±»çš„åŸºæœ¬ä¿¡æ¯ï¼Œæœ€å¤§å€¼å— -XX:CompressedClassSpaceSize æ§åˆ¶\r\n* non-class space å­˜å‚¨é™¤ç±»çš„åŸºæœ¬ä¿¡æ¯ä»¥å¤–çš„å…¶å®ƒä¿¡æ¯ï¼ˆå¦‚æ–¹æ³•å­—èŠ‚ç ã€æ³¨è§£ç­‰ï¼‰\r\n* class space å’Œ non-class space æ€»å¤§å°å— -XX:MaxMetaspaceSize æ§åˆ¶\r\n\r\næ³¨æ„ï¼š\r\n\r\n* è¿™é‡Œ -XX:CompressedClassSpaceSize è¿™æ®µç©ºé—´è¿˜ä¸æ˜¯å¦å¼€å¯äº†æŒ‡é’ˆå‹ç¼©æœ‰å…³ï¼Œè¿™é‡Œæš‚ä¸æ·±å…¥å±•å¼€ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºæŒ‡é’ˆå‹ç¼©é»˜è®¤å¼€å¯\r\n\r\n\r\n\r\n**ä»£ç ç¼“å­˜å†…å­˜è®¾ç½®**\r\n\r\n![image-20210831173148816](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831173148816.png)\r\n\r\nè§£é‡Šï¼š\r\n\r\n* å¦‚æœ -XX:ReservedCodeCacheSize < 240mï¼Œæ‰€æœ‰ä¼˜åŒ–æœºå™¨ä»£ç ä¸åŠ åŒºåˆ†å­˜åœ¨ä¸€èµ·\r\n* å¦åˆ™ï¼Œåˆ†æˆä¸‰ä¸ªåŒºåŸŸï¼ˆå›¾ä¸­ç¬”è¯¯ mthod æ‹¼å†™é”™è¯¯ï¼Œå°‘ä¸€ä¸ª eï¼‰\r\n  * non-nmethods - JVM è‡ªå·±ç”¨çš„ä»£ç \r\n  * profiled nmethods - éƒ¨åˆ†ä¼˜åŒ–çš„æœºå™¨ç \r\n  * non-profiled nmethods - å®Œå…¨ä¼˜åŒ–çš„æœºå™¨ç \r\n\r\n\r\n\r\n**çº¿ç¨‹å†…å­˜è®¾ç½®**\r\n\r\n![image-20210831173155481](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831173155481.png)\r\n\r\n> ***å®˜æ–¹å‚è€ƒæ–‡æ¡£***\r\n>\r\n> * https://docs.oracle.com/en/java/javase/11/tools/java.html#GUID-3B1CE181-CD30-4178-9602-230B800D4FAE\r\n\r\n\r\n\r\n## 3. JVM åƒåœ¾å›æ”¶\r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡åƒåœ¾å›æ”¶ç®—æ³•\r\n* æŒæ¡åˆ†ä»£å›æ”¶æ€æƒ³\r\n* ç†è§£ä¸‰è‰²æ ‡è®°åŠæ¼æ ‡å¤„ç†\r\n* äº†è§£å¸¸è§åƒåœ¾å›æ”¶å™¨\r\n\r\n**ä¸‰ç§åƒåœ¾å›æ”¶ç®—æ³•**\r\n\r\næ ‡è®°æ¸…é™¤æ³•\r\n\r\n![image-20210831211008162](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831211008162.png)\r\n\r\nè§£é‡Šï¼š\r\n\r\n1. æ‰¾åˆ° GC Root å¯¹è±¡ï¼Œå³é‚£äº›ä¸€å®šä¸ä¼šè¢«å›æ”¶çš„å¯¹è±¡ï¼Œå¦‚æ­£æ‰§è¡Œæ–¹æ³•å†…å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡ã€é™æ€å˜é‡å¼•ç”¨çš„å¯¹è±¡\r\n2. æ ‡è®°é˜¶æ®µï¼šæ²¿ç€ GC Root å¯¹è±¡çš„å¼•ç”¨é“¾æ‰¾ï¼Œç›´æ¥æˆ–é—´æ¥å¼•ç”¨åˆ°çš„å¯¹è±¡åŠ ä¸Šæ ‡è®°\r\n3. æ¸…é™¤é˜¶æ®µï¼šé‡Šæ”¾æœªåŠ æ ‡è®°çš„å¯¹è±¡å ç”¨çš„å†…å­˜\r\n\r\nè¦ç‚¹ï¼š\r\n\r\n* æ ‡è®°é€Ÿåº¦ä¸å­˜æ´»å¯¹è±¡çº¿æ€§å…³ç³»\r\n* æ¸…é™¤é€Ÿåº¦ä¸å†…å­˜å¤§å°çº¿æ€§å…³ç³»\r\n* ç¼ºç‚¹æ˜¯ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡\r\n\r\n\r\n\r\næ ‡è®°æ•´ç†æ³•\r\n\r\n![image-20210831211641241](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831211641241.png)\r\n\r\nè§£é‡Šï¼š\r\n\r\n1. å‰é¢çš„æ ‡è®°é˜¶æ®µã€æ¸…ç†é˜¶æ®µä¸æ ‡è®°æ¸…é™¤æ³•ç±»ä¼¼\r\n2. å¤šäº†ä¸€æ­¥æ•´ç†çš„åŠ¨ä½œï¼Œå°†å­˜æ´»å¯¹è±¡å‘ä¸€ç«¯ç§»åŠ¨ï¼Œå¯ä»¥é¿å…å†…å­˜ç¢ç‰‡äº§ç”Ÿ\r\n\r\nç‰¹ç‚¹ï¼š\r\n\r\n* æ ‡è®°é€Ÿåº¦ä¸å­˜æ´»å¯¹è±¡çº¿æ€§å…³ç³»\r\n\r\n* æ¸…é™¤ä¸æ•´ç†é€Ÿåº¦ä¸å†…å­˜å¤§å°æˆçº¿æ€§å…³ç³»\r\n* ç¼ºç‚¹æ˜¯æ€§èƒ½ä¸Šè¾ƒæ…¢\r\n\r\n\r\n\r\næ ‡è®°å¤åˆ¶æ³•\r\n\r\n![image-20210831212125813](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831212125813.png)\r\n\r\nè§£é‡Šï¼š\r\n\r\n1. å°†æ•´ä¸ªå†…å­˜åˆ†æˆä¸¤ä¸ªå¤§å°ç›¸ç­‰çš„åŒºåŸŸï¼Œfrom å’Œ toï¼Œå…¶ä¸­ to æ€»æ˜¯å¤„äºç©ºé—²ï¼Œfrom å­˜å‚¨æ–°åˆ›å»ºçš„å¯¹è±¡\r\n2. æ ‡è®°é˜¶æ®µä¸å‰é¢çš„ç®—æ³•ç±»ä¼¼\r\n3. åœ¨æ‰¾å‡ºå­˜æ´»å¯¹è±¡åï¼Œä¼šå°†å®ƒä»¬ä» from å¤åˆ¶åˆ° to åŒºåŸŸï¼Œå¤åˆ¶çš„è¿‡ç¨‹ä¸­è‡ªç„¶å®Œæˆäº†ç¢ç‰‡æ•´ç†\r\n4. å¤åˆ¶å®Œæˆåï¼Œäº¤æ¢ from å’Œ to çš„ä½ç½®å³å¯\r\n\r\nç‰¹ç‚¹ï¼š\r\n\r\n* æ ‡è®°ä¸å¤åˆ¶é€Ÿåº¦ä¸å­˜æ´»å¯¹è±¡æˆçº¿æ€§å…³ç³»\r\n* ç¼ºç‚¹æ˜¯ä¼šå ç”¨æˆå€çš„ç©ºé—´\r\n\r\n\r\n\r\n**GC ä¸åˆ†ä»£å›æ”¶ç®—æ³•**\r\n\r\nGC çš„ç›®çš„åœ¨äºå®ç°æ— ç”¨å¯¹è±¡å†…å­˜è‡ªåŠ¨é‡Šæ”¾ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ã€åŠ å¿«åˆ†é…é€Ÿåº¦\r\n\r\nGC è¦ç‚¹ï¼š\r\n\r\n* å›æ”¶åŒºåŸŸæ˜¯**å †å†…å­˜**ï¼Œä¸åŒ…æ‹¬è™šæ‹Ÿæœºæ ˆ\r\n* åˆ¤æ–­æ— ç”¨å¯¹è±¡ï¼Œä½¿ç”¨**å¯è¾¾æ€§åˆ†æç®—æ³•**ï¼Œ**ä¸‰è‰²æ ‡è®°æ³•**æ ‡è®°å­˜æ´»å¯¹è±¡ï¼Œå›æ”¶æœªæ ‡è®°å¯¹è±¡\r\n* GC å…·ä½“çš„å®ç°ç§°ä¸º**åƒåœ¾å›æ”¶å™¨**\r\n* GC å¤§éƒ½é‡‡ç”¨äº†**åˆ†ä»£å›æ”¶æ€æƒ³**\r\n  * ç†è®ºä¾æ®æ˜¯å¤§éƒ¨åˆ†å¯¹è±¡æœç”Ÿå¤•ç­ï¼Œç”¨å®Œç«‹åˆ»å°±å¯ä»¥å›æ”¶ï¼Œå¦æœ‰å°‘éƒ¨åˆ†å¯¹è±¡ä¼šé•¿æ—¶é—´å­˜æ´»ï¼Œæ¯æ¬¡å¾ˆéš¾å›æ”¶\r\n  * æ ¹æ®è¿™ä¸¤ç±»å¯¹è±¡çš„ç‰¹æ€§å°†å›æ”¶åŒºåŸŸåˆ†ä¸º**æ–°ç”Ÿä»£**å’Œ**è€å¹´ä»£**ï¼Œæ–°ç”Ÿä»£é‡‡ç”¨æ ‡è®°å¤åˆ¶æ³•ã€è€å¹´ä»£ä¸€èˆ¬é‡‡ç”¨æ ‡è®°æ•´ç†æ³•\r\n* æ ¹æ® GC çš„è§„æ¨¡å¯ä»¥åˆ†æˆ **Minor GC**ï¼Œ**Mixed GC**ï¼Œ**Full GC**\r\n\r\n\r\n\r\n**åˆ†ä»£å›æ”¶**\r\n\r\n1. ä¼Šç”¸å›­ edenï¼Œæœ€åˆå¯¹è±¡éƒ½åˆ†é…åˆ°è¿™é‡Œï¼Œä¸å¹¸å­˜åŒº survivorï¼ˆåˆ†æˆ from å’Œ toï¼‰åˆç§°æ–°ç”Ÿä»£ï¼Œ\r\n\r\n![image-20210831213622704](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831213622704.png)\r\n\r\n2. å½“ä¼Šç”¸å›­å†…å­˜ä¸è¶³ï¼Œæ ‡è®°ä¼Šç”¸å›­ä¸ fromï¼ˆç°é˜¶æ®µæ²¡æœ‰ï¼‰çš„å­˜æ´»å¯¹è±¡\r\n\r\n![image-20210831213640110](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831213640110.png)\r\n\r\n3. å°†å­˜æ´»å¯¹è±¡é‡‡ç”¨å¤åˆ¶ç®—æ³•å¤åˆ¶åˆ° to ä¸­ï¼Œå¤åˆ¶å®Œæ¯•åï¼Œä¼Šç”¸å›­å’Œ from å†…å­˜éƒ½å¾—åˆ°é‡Šæ”¾\r\n\r\n![image-20210831213657861](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831213657861.png)\r\n\r\n4. å°† from å’Œ to äº¤æ¢ä½ç½®\r\n\r\n![image-20210831213708776](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831213708776.png)\r\n\r\n5. ç»è¿‡ä¸€æ®µæ—¶é—´åä¼Šç”¸å›­çš„å†…å­˜åˆå‡ºç°ä¸è¶³\r\n\r\n![image-20210831213724858](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831213724858.png)\r\n\r\n6. æ ‡è®°ä¼Šç”¸å›­ä¸ fromï¼ˆç°é˜¶æ®µæ²¡æœ‰ï¼‰çš„å­˜æ´»å¯¹è±¡\r\n\r\n![image-20210831213737669](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831213737669.png)\r\n\r\n7. å°†å­˜æ´»å¯¹è±¡é‡‡ç”¨å¤åˆ¶ç®—æ³•å¤åˆ¶åˆ° to ä¸­\r\n\r\n![image-20210831213804315](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831213804315.png)\r\n\r\n8. å¤åˆ¶å®Œæ¯•åï¼Œä¼Šç”¸å›­å’Œ from å†…å­˜éƒ½å¾—åˆ°é‡Šæ”¾\r\n\r\n![image-20210831213815371](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831213815371.png)\r\n\r\n9. å°† from å’Œ to äº¤æ¢ä½ç½®\r\n\r\n![image-20210831213826017](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831213826017.png)\r\n\r\n10. è€å¹´ä»£ oldï¼Œå½“å¹¸å­˜åŒºå¯¹è±¡ç†¬è¿‡å‡ æ¬¡å›æ”¶ï¼ˆæœ€å¤š15æ¬¡ï¼‰ï¼Œæ™‹å‡åˆ°è€å¹´ä»£ï¼ˆå¹¸å­˜åŒºå†…å­˜ä¸è¶³æˆ–å¤§å¯¹è±¡ä¼šå¯¼è‡´æå‰æ™‹å‡ï¼‰\r\n\r\n\r\n\r\n**GC è§„æ¨¡**\r\n\r\n* Minor GC å‘ç”Ÿåœ¨æ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ï¼Œæš‚åœæ—¶é—´çŸ­\r\n\r\n* Mixed GC æ–°ç”Ÿä»£ + è€å¹´ä»£éƒ¨åˆ†åŒºåŸŸçš„åƒåœ¾å›æ”¶ï¼ŒG1 æ”¶é›†å™¨ç‰¹æœ‰\r\n\r\n* Full GC æ–°ç”Ÿä»£ + è€å¹´ä»£å®Œæ•´åƒåœ¾å›æ”¶ï¼Œæš‚åœæ—¶é—´é•¿ï¼Œ**åº”å°½åŠ›é¿å…**\r\n\r\n\r\n\r\n**ä¸‰è‰²æ ‡è®°**\r\n\r\nå³ç”¨ä¸‰ç§é¢œè‰²è®°å½•å¯¹è±¡çš„æ ‡è®°çŠ¶æ€\r\n\r\n* é»‘è‰² â€“ å·²æ ‡è®°\r\n* ç°è‰² â€“ æ ‡è®°ä¸­\r\n* ç™½è‰² â€“ è¿˜æœªæ ‡è®°\r\n\r\n\r\n\r\n1. èµ·å§‹çš„ä¸‰ä¸ªå¯¹è±¡è¿˜æœªå¤„ç†å®Œæˆï¼Œç”¨ç°è‰²è¡¨ç¤º\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831215016566.png\" alt=\"image-20210831215016566\" class=\"scale-50\" />\r\n\r\n2. è¯¥å¯¹è±¡çš„å¼•ç”¨å·²ç»å¤„ç†å®Œæˆï¼Œç”¨é»‘è‰²è¡¨ç¤ºï¼Œé»‘è‰²å¼•ç”¨çš„å¯¹è±¡å˜ä¸ºç°è‰²\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831215033510.png\" alt=\"image-20210831215033510\" class=\"scale-50\" />\r\n\r\n3. ä¾æ¬¡ç±»æ¨\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831215105280.png\" alt=\"image-20210831215105280\" class=\"scale-50\" />\r\n\r\n4. æ²¿ç€å¼•ç”¨é“¾éƒ½æ ‡è®°äº†ä¸€é\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831215146276.png\" alt=\"image-20210831215146276\" class=\"scale-50\" />\r\n\r\n5. æœ€åä¸ºæ ‡è®°çš„ç™½è‰²å¯¹è±¡ï¼Œå³ä¸ºåƒåœ¾\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831215158311.png\" alt=\"image-20210831215158311\" class=\"scale-50\" />\r\n\r\n**å¹¶å‘æ¼æ ‡é—®é¢˜**\r\n\r\næ¯”è¾ƒå…ˆè¿›çš„åƒåœ¾å›æ”¶å™¨éƒ½æ”¯æŒ**å¹¶å‘æ ‡è®°**ï¼Œå³åœ¨æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·çº¿ç¨‹ä»ç„¶èƒ½å·¥ä½œã€‚ä½†è¿™æ ·å¸¦æ¥ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œå¦‚æœç”¨æˆ·çº¿ç¨‹ä¿®æ”¹äº†å¯¹è±¡å¼•ç”¨ï¼Œé‚£ä¹ˆå°±å­˜åœ¨æ¼æ ‡é—®é¢˜ã€‚ä¾‹å¦‚ï¼š\r\n\r\n1. å¦‚å›¾æ‰€ç¤ºæ ‡è®°å·¥ä½œå°šæœªå®Œæˆ\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831215846876.png\" alt=\"image-20210831215846876\" class=\"scale-50\" />\r\n\r\n2. ç”¨æˆ·çº¿ç¨‹åŒæ—¶åœ¨å·¥ä½œï¼Œæ–­å¼€äº†ç¬¬ä¸€å±‚ 3ã€4 ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„å¼•ç”¨ï¼Œè¿™æ—¶å¯¹äºæ­£åœ¨å¤„ç† 3 å·å¯¹è±¡çš„åƒåœ¾å›æ”¶çº¿ç¨‹æ¥è®²ï¼Œå®ƒä¼šå°† 4 å·å¯¹è±¡å½“åšæ˜¯ç™½è‰²åƒåœ¾\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831215904073.png\" alt=\"image-20210831215904073\" class=\"scale-50\" />\r\n\r\n3. ä½†å¦‚æœå…¶ä»–ç”¨æˆ·çº¿ç¨‹åˆå»ºç«‹äº† 2ã€4 ä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™æ—¶å› ä¸º 2 å·å¯¹è±¡æ˜¯é»‘è‰²å·²å¤„ç†å¯¹è±¡äº†ï¼Œå› æ­¤åƒåœ¾å›æ”¶çº¿ç¨‹ä¸ä¼šå¯Ÿè§‰åˆ°è¿™ä¸ªå¼•ç”¨å…³ç³»çš„å˜åŒ–ï¼Œä»è€Œäº§ç”Ÿäº†æ¼æ ‡\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831215919493.png\" alt=\"image-20210831215919493\" class=\"scale-50\" />\r\n\r\n4. å¦‚æœç”¨æˆ·çº¿ç¨‹è®©é»‘è‰²å¯¹è±¡å¼•ç”¨äº†ä¸€ä¸ªæ–°å¢å¯¹è±¡ï¼Œä¸€æ ·ä¼šå­˜åœ¨æ¼æ ‡é—®é¢˜\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831220004062.png\" alt=\"image-20210831220004062\" class=\"scale-50\" />\r\n\r\nå› æ­¤å¯¹äº**å¹¶å‘æ ‡è®°**è€Œè¨€ï¼Œå¿…é¡»è§£å†³æ¼æ ‡é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¦è®°å½•æ ‡è®°è¿‡ç¨‹ä¸­çš„å˜åŒ–ã€‚æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š\r\n\r\n1. Incremental Update å¢é‡æ›´æ–°æ³•ï¼ŒCMS åƒåœ¾å›æ”¶å™¨é‡‡ç”¨\r\n   * æ€è·¯æ˜¯æ‹¦æˆªæ¯æ¬¡èµ‹å€¼åŠ¨ä½œï¼Œåªè¦èµ‹å€¼å‘ç”Ÿï¼Œè¢«èµ‹å€¼çš„å¯¹è±¡å°±ä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œåœ¨é‡æ–°æ ‡è®°é˜¶æ®µå†ç¡®è®¤ä¸€é\r\n2. Snapshot At The Beginningï¼ŒSATB åŸå§‹å¿«ç…§æ³•ï¼ŒG1 åƒåœ¾å›æ”¶å™¨é‡‡ç”¨\r\n   * æ€è·¯ä¹Ÿæ˜¯æ‹¦æˆªæ¯æ¬¡èµ‹å€¼åŠ¨ä½œï¼Œä¸è¿‡è®°å½•çš„å¯¹è±¡ä¸åŒï¼Œä¹Ÿéœ€è¦åœ¨é‡æ–°æ ‡è®°é˜¶æ®µå¯¹è¿™äº›å¯¹è±¡äºŒæ¬¡å¤„ç†\r\n   * æ–°åŠ å¯¹è±¡ä¼šè¢«è®°å½•\r\n   * è¢«åˆ é™¤å¼•ç”¨å…³ç³»çš„å¯¹è±¡ä¹Ÿè¢«è®°å½•\r\n\r\n\r\n\r\n**åƒåœ¾å›æ”¶å™¨ - Parallel GC**\r\n\r\n* eden å†…å­˜ä¸è¶³å‘ç”Ÿ Minor GCï¼Œé‡‡ç”¨æ ‡è®°å¤åˆ¶ç®—æ³•ï¼Œéœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹\r\n* old å†…å­˜ä¸è¶³å‘ç”Ÿ Full GCï¼Œé‡‡ç”¨æ ‡è®°æ•´ç†ç®—æ³•ï¼Œéœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹\r\n\r\n* **æ³¨é‡ååé‡**\r\n\r\n**åƒåœ¾å›æ”¶å™¨ - ConcurrentMarkSweep GC**\r\n\r\n* å®ƒæ˜¯å·¥ä½œåœ¨ old è€å¹´ä»£ï¼Œæ”¯æŒ**å¹¶å‘æ ‡è®°**çš„ä¸€æ¬¾å›æ”¶å™¨ï¼Œé‡‡ç”¨**å¹¶å‘æ¸…é™¤**ç®—æ³•\r\n  * å¹¶å‘æ ‡è®°æ—¶ä¸éœ€æš‚åœç”¨æˆ·çº¿ç¨‹\r\n  * é‡æ–°æ ‡è®°æ—¶ä»éœ€æš‚åœç”¨æˆ·çº¿ç¨‹\r\n\r\n* å¦‚æœå¹¶å‘å¤±è´¥ï¼ˆå³å›æ”¶é€Ÿåº¦èµ¶ä¸ä¸Šåˆ›å»ºæ–°å¯¹è±¡é€Ÿåº¦ï¼‰ï¼Œä¼šè§¦å‘ Full GC\r\n\r\n* **æ³¨é‡å“åº”æ—¶é—´**\r\n\r\n**åƒåœ¾å›æ”¶å™¨ - G1 GC**\r\n\r\n* **å“åº”æ—¶é—´ä¸ååé‡å…¼é¡¾**\r\n* åˆ’åˆ†æˆå¤šä¸ªåŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸéƒ½å¯ä»¥å……å½“ edenï¼Œsurvivorï¼Œoldï¼Œ humongousï¼Œå…¶ä¸­ humongous ä¸“ä¸ºå¤§å¯¹è±¡å‡†å¤‡\r\n* åˆ†æˆä¸‰ä¸ªé˜¶æ®µï¼šæ–°ç”Ÿä»£å›æ”¶ã€å¹¶å‘æ ‡è®°ã€æ··åˆæ”¶é›†\r\n* å¦‚æœå¹¶å‘å¤±è´¥ï¼ˆå³å›æ”¶é€Ÿåº¦èµ¶ä¸ä¸Šåˆ›å»ºæ–°å¯¹è±¡é€Ÿåº¦ï¼‰ï¼Œä¼šè§¦å‘ Full GC\r\n\r\n\r\n\r\n**G1 å›æ”¶é˜¶æ®µ - æ–°ç”Ÿä»£å›æ”¶**\r\n\r\n1. åˆå§‹æ—¶ï¼Œæ‰€æœ‰åŒºåŸŸéƒ½å¤„äºç©ºé—²çŠ¶æ€\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222639754.png\" alt=\"image-20210831222639754\" class=\"scale-50\" />\r\n\r\n2. åˆ›å»ºäº†ä¸€äº›å¯¹è±¡ï¼ŒæŒ‘å‡ºä¸€äº›ç©ºé—²åŒºåŸŸä½œä¸ºä¼Šç”¸å›­åŒºå­˜å‚¨è¿™äº›å¯¹è±¡\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222653802.png\" alt=\"image-20210831222653802\" class=\"scale-50\" />\r\n\r\n3. å½“ä¼Šç”¸å›­éœ€è¦åƒåœ¾å›æ”¶æ—¶ï¼ŒæŒ‘å‡ºä¸€ä¸ªç©ºé—²åŒºåŸŸä½œä¸ºå¹¸å­˜åŒºï¼Œç”¨å¤åˆ¶ç®—æ³•å¤åˆ¶å­˜æ´»å¯¹è±¡ï¼Œéœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222705814.png\" alt=\"image-20210831222705814\" class=\"scale-50\" />\r\n\r\n4. å¤åˆ¶å®Œæˆï¼Œå°†ä¹‹å‰çš„ä¼Šç”¸å›­å†…å­˜é‡Šæ”¾\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222724999.png\" alt=\"image-20210831222724999\" class=\"scale-50\" />\r\n\r\n5. éšç€æ—¶é—´æµé€ï¼Œä¼Šç”¸å›­çš„å†…å­˜åˆæœ‰ä¸è¶³\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222737928.png\" alt=\"image-20210831222737928\" class=\"scale-50\" />\r\n\r\n6. å°†ä¼Šç”¸å›­ä»¥åŠä¹‹å‰å¹¸å­˜åŒºä¸­çš„å­˜æ´»å¯¹è±¡ï¼Œé‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œå¤åˆ¶åˆ°æ–°çš„å¹¸å­˜åŒºï¼Œå…¶ä¸­è¾ƒè€å¯¹è±¡æ™‹å‡è‡³è€å¹´ä»£\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222752787.png\" alt=\"image-20210831222752787\" class=\"scale-50\" />\r\n\r\n7. é‡Šæ”¾ä¼Šç”¸å›­ä»¥åŠä¹‹å‰å¹¸å­˜åŒºçš„å†…å­˜\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222803281.png\" alt=\"image-20210831222803281\" class=\"scale-50\" />\r\n\r\n**G1 å›æ”¶é˜¶æ®µ - å¹¶å‘æ ‡è®°ä¸æ··åˆæ”¶é›†**\r\n\r\n1. å½“è€å¹´ä»£å ç”¨å†…å­˜è¶…è¿‡é˜ˆå€¼åï¼Œè§¦å‘å¹¶å‘æ ‡è®°ï¼Œè¿™æ—¶æ— éœ€æš‚åœç”¨æˆ·çº¿ç¨‹\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222813959.png\" alt=\"image-20210831222813959\" class=\"scale-50\" />\r\n\r\n2. å¹¶å‘æ ‡è®°ä¹‹åï¼Œä¼šæœ‰é‡æ–°æ ‡è®°é˜¶æ®µè§£å†³æ¼æ ‡é—®é¢˜ï¼Œæ­¤æ—¶éœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹ã€‚è¿™äº›éƒ½å®Œæˆåå°±çŸ¥é“äº†è€å¹´ä»£æœ‰å“ªäº›å­˜æ´»å¯¹è±¡ï¼Œéšåè¿›å…¥æ··åˆæ”¶é›†é˜¶æ®µã€‚æ­¤æ—¶ä¸ä¼šå¯¹æ‰€æœ‰è€å¹´ä»£åŒºåŸŸè¿›è¡Œå›æ”¶ï¼Œè€Œæ˜¯æ ¹æ®**æš‚åœæ—¶é—´ç›®æ ‡**ä¼˜å…ˆå›æ”¶ä»·å€¼é«˜ï¼ˆå­˜æ´»å¯¹è±¡å°‘ï¼‰çš„åŒºåŸŸï¼ˆè¿™ä¹Ÿæ˜¯ Gabage First åç§°çš„ç”±æ¥ï¼‰ã€‚\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222828104.png\" alt=\"image-20210831222828104\" class=\"scale-50\" />\r\n\r\n3. æ··åˆæ”¶é›†é˜¶æ®µä¸­ï¼Œå‚ä¸å¤åˆ¶çš„æœ‰ edenã€survivorã€oldï¼Œä¸‹å›¾æ˜¾ç¤ºäº†ä¼Šç”¸å›­å’Œå¹¸å­˜åŒºçš„å­˜æ´»å¯¹è±¡å¤åˆ¶\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222841096.png\" alt=\"image-20210831222841096\" class=\"scale-50\" />\r\n\r\n4. ä¸‹å›¾æ˜¾ç¤ºäº†è€å¹´ä»£å’Œå¹¸å­˜åŒºæ™‹å‡çš„å­˜æ´»å¯¹è±¡çš„å¤åˆ¶\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222859760.png\" alt=\"image-20210831222859760\" class=\"scale-50\" />\r\n\r\n5. å¤åˆ¶å®Œæˆï¼Œå†…å­˜å¾—åˆ°é‡Šæ”¾ã€‚è¿›å…¥ä¸‹ä¸€è½®çš„æ–°ç”Ÿä»£å›æ”¶ã€å¹¶å‘æ ‡è®°ã€æ··åˆæ”¶é›†\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210831222919182.png\" alt=\"image-20210831222919182\" class=\"scale-50\" />\r\n\r\n## 4. å†…å­˜æº¢å‡º\r\n\r\n**è¦æ±‚**\r\n\r\n* èƒ½å¤Ÿè¯´å‡ºå‡ ç§å…¸å‹çš„å¯¼è‡´å†…å­˜æº¢å‡ºçš„æƒ…å†µ\r\n\r\n\r\n\r\n**å…¸å‹æƒ…å†µ**\r\n\r\n* è¯¯ç”¨çº¿ç¨‹æ± å¯¼è‡´çš„å†…å­˜æº¢å‡º\r\n  * å‚è€ƒ day03.TestOomThreadPool\r\n* æŸ¥è¯¢æ•°æ®é‡å¤ªå¤§å¯¼è‡´çš„å†…å­˜æº¢å‡º\r\n  * å‚è€ƒ day03.TestOomTooManyObject\r\n* åŠ¨æ€ç”Ÿæˆç±»å¯¼è‡´çš„å†…å­˜æº¢å‡º\r\n  * å‚è€ƒ day03.TestOomTooManyClass\r\n\r\n\r\n\r\n## 5. ç±»åŠ è½½\r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡ç±»åŠ è½½é˜¶æ®µ\r\n* æŒæ¡ç±»åŠ è½½å™¨\r\n* ç†è§£åŒäº²å§”æ´¾æœºåˆ¶\r\n\r\n\r\n\r\n**ç±»åŠ è½½è¿‡ç¨‹çš„ä¸‰ä¸ªé˜¶æ®µ**\r\n\r\n1. åŠ è½½\r\n\r\n   1. å°†ç±»çš„å­—èŠ‚ç è½½å…¥æ–¹æ³•åŒºï¼Œå¹¶åˆ›å»ºç±».class å¯¹è±¡\r\n\r\n   2. å¦‚æœæ­¤ç±»çš„çˆ¶ç±»æ²¡æœ‰åŠ è½½ï¼Œå…ˆåŠ è½½çˆ¶ç±»\r\n   3. åŠ è½½æ˜¯æ‡’æƒ°æ‰§è¡Œ\r\n\r\n2. é“¾æ¥\r\n   1. éªŒè¯ â€“ éªŒè¯ç±»æ˜¯å¦ç¬¦åˆ Class è§„èŒƒï¼Œåˆæ³•æ€§ã€å®‰å…¨æ€§æ£€æŸ¥\r\n   2. å‡†å¤‡ â€“ ä¸º static å˜é‡åˆ†é…ç©ºé—´ï¼Œè®¾ç½®é»˜è®¤å€¼\r\n   3. è§£æ â€“ å°†å¸¸é‡æ± çš„ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨\r\n\r\n3. åˆå§‹åŒ–\r\n   1. é™æ€ä»£ç å—ã€static ä¿®é¥°çš„å˜é‡èµ‹å€¼ã€static final ä¿®é¥°çš„å¼•ç”¨ç±»å‹å˜é‡èµ‹å€¼ï¼Œä¼šè¢«åˆå¹¶æˆä¸€ä¸ª `<cinit>` æ–¹æ³•ï¼Œåœ¨åˆå§‹åŒ–æ—¶è¢«è°ƒç”¨\r\n   2. static final ä¿®é¥°çš„åŸºæœ¬ç±»å‹å˜é‡èµ‹å€¼ï¼Œåœ¨é“¾æ¥é˜¶æ®µå°±å·²å®Œæˆ\r\n   3. åˆå§‹åŒ–æ˜¯æ‡’æƒ°æ‰§è¡Œ\r\n\r\n> ***éªŒè¯æ‰‹æ®µ***\r\n>\r\n> * ä½¿ç”¨ jps æŸ¥çœ‹è¿›ç¨‹å·\r\n> * ä½¿ç”¨ jhsdb è°ƒè¯•ï¼Œæ‰§è¡Œå‘½ä»¤ `jhsdb.exe hsdb` æ‰“å¼€å®ƒçš„å›¾å½¢ç•Œé¢\r\n>   * Class Browser å¯ä»¥æŸ¥çœ‹å½“å‰ jvm ä¸­åŠ è½½äº†å“ªäº›ç±»\r\n>   * æ§åˆ¶å°çš„ universe å‘½ä»¤æŸ¥çœ‹å †å†…å­˜èŒƒå›´\r\n>   * æ§åˆ¶å°çš„ g1regiondetails å‘½ä»¤æŸ¥çœ‹ region è¯¦æƒ…\r\n>   * `scanoops èµ·å§‹åœ°å€ ç»“æŸåœ°å€ å¯¹è±¡ç±»å‹` å¯ä»¥æ ¹æ®ç±»å‹æŸ¥æ‰¾æŸä¸ªåŒºé—´å†…çš„å¯¹è±¡åœ°å€\r\n>   * æ§åˆ¶å°çš„ `inspect åœ°å€` æŒ‡ä»¤èƒ½å¤ŸæŸ¥çœ‹è¿™ä¸ªåœ°å€å¯¹åº”çš„å¯¹è±¡è¯¦æƒ…\r\n> * ä½¿ç”¨ javap å‘½ä»¤å¯ä»¥æŸ¥çœ‹ class å­—èŠ‚ç \r\n\r\n\r\n\r\n>***ä»£ç è¯´æ˜***\r\n>\r\n>* day03.loader.TestLazy - éªŒè¯ç±»çš„åŠ è½½æ˜¯æ‡’æƒ°çš„ï¼Œç”¨åˆ°æ—¶æ‰è§¦å‘ç±»åŠ è½½\r\n>* day03.loader.TestFinal - éªŒè¯ä½¿ç”¨ final ä¿®é¥°çš„å˜é‡ä¸ä¼šè§¦å‘ç±»åŠ è½½\r\n\r\n\r\n\r\n**jdk 8 çš„ç±»åŠ è½½å™¨**\r\n\r\n| **åç§°**                | **åŠ è½½å“ªçš„ç±»**        | **è¯´æ˜**                       |\r\n| ----------------------- | --------------------- | ------------------------------ |\r\n| Bootstrap ClassLoader   | JAVA_HOME/jre/lib     | æ— æ³•ç›´æ¥è®¿é—®                   |\r\n| Extension ClassLoader   | JAVA_HOME/jre/lib/ext | ä¸Šçº§ä¸º Bootstrapï¼Œæ˜¾ç¤ºä¸º  null |\r\n| Application ClassLoader | classpath             | ä¸Šçº§ä¸º Extension               |\r\n| è‡ªå®šä¹‰ç±»åŠ è½½å™¨          | è‡ªå®šä¹‰                | ä¸Šçº§ä¸º Application             |\r\n\r\n\r\n\r\n**åŒäº²å§”æ´¾æœºåˆ¶**\r\n\r\næ‰€è°“çš„åŒäº²å§”æ´¾ï¼Œå°±æ˜¯æŒ‡ä¼˜å…ˆå§”æ´¾ä¸Šçº§ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå¦‚æœä¸Šçº§ç±»åŠ è½½å™¨\r\n\r\n* èƒ½æ‰¾åˆ°è¿™ä¸ªç±»ï¼Œç”±ä¸Šçº§åŠ è½½ï¼ŒåŠ è½½åè¯¥ç±»ä¹Ÿå¯¹ä¸‹çº§åŠ è½½å™¨å¯è§\r\n* æ‰¾ä¸åˆ°è¿™ä¸ªç±»ï¼Œåˆ™ä¸‹çº§ç±»åŠ è½½å™¨æ‰æœ‰èµ„æ ¼æ‰§è¡ŒåŠ è½½\r\n\r\nåŒäº²å§”æ´¾çš„ç›®çš„æœ‰ä¸¤ç‚¹\r\n\r\n1. è®©ä¸Šçº§ç±»åŠ è½½å™¨ä¸­çš„ç±»å¯¹ä¸‹çº§å…±äº«ï¼ˆåä¹‹ä¸è¡Œï¼‰ï¼Œå³èƒ½è®©ä½ çš„ç±»èƒ½ä¾èµ–åˆ° jdk æä¾›çš„æ ¸å¿ƒç±»\r\n\r\n2. è®©ç±»çš„åŠ è½½æœ‰ä¼˜å…ˆæ¬¡åºï¼Œä¿è¯æ ¸å¿ƒç±»ä¼˜å…ˆåŠ è½½\r\n\r\n\r\n\r\n**å¯¹åŒäº²å§”æ´¾çš„è¯¯è§£**\r\n\r\nä¸‹é¢é¢è¯•é¢˜çš„å›ç­”æ˜¯é”™è¯¯çš„\r\n\r\n![image-20210901110910016](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210901110910016.png)\r\n\r\né”™åœ¨å“ªäº†ï¼Ÿ\r\n\r\n* è‡ªå·±ç¼–å†™ç±»åŠ è½½å™¨å°±èƒ½åŠ è½½ä¸€ä¸ªå‡å†’çš„ java.lang.System å—? ç­”æ¡ˆæ˜¯ä¸è¡Œã€‚\r\n\r\n* å‡è®¾ä½ è‡ªå·±çš„ç±»åŠ è½½å™¨ç”¨åŒäº²å§”æ´¾ï¼Œé‚£ä¹ˆä¼˜å…ˆç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çœŸæ­£çš„ java.lang.Systemï¼Œè‡ªç„¶ä¸ä¼šåŠ è½½å‡å†’çš„\r\n\r\n* å‡è®¾ä½ è‡ªå·±çš„ç±»åŠ è½½å™¨ä¸ç”¨åŒäº²å§”æ´¾ï¼Œé‚£ä¹ˆä½ çš„ç±»åŠ è½½å™¨åŠ è½½å‡å†’çš„ java.lang.System æ—¶ï¼Œå®ƒéœ€è¦å…ˆåŠ è½½çˆ¶ç±» java.lang.Objectï¼Œè€Œä½ æ²¡æœ‰ç”¨å§”æ´¾ï¼Œæ‰¾ä¸åˆ° java.lang.Object æ‰€ä»¥åŠ è½½ä¼šå¤±è´¥\r\n\r\n* **ä»¥ä¸Šä¹Ÿä»…ä»…æ˜¯å‡è®¾**ã€‚äº‹å®ä¸Šæ“ä½œä½ å°±ä¼šå‘ç°ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½ä»¥ java. æ‰“å¤´çš„ç±»æ—¶ï¼Œä¼šæŠ›å®‰å…¨å¼‚å¸¸ï¼Œåœ¨ jdk9 ä»¥ä¸Šç‰ˆæœ¬è¿™äº›ç‰¹æ®ŠåŒ…åéƒ½ä¸æ¨¡å—è¿›è¡Œäº†ç»‘å®šï¼Œæ›´è¿ç¼–è¯‘éƒ½è¿‡ä¸äº†\r\n\r\n\r\n\r\n>***ä»£ç è¯´æ˜***\r\n>\r\n>* day03.loader.TestJdk9ClassLoader - æ¼”ç¤ºç±»åŠ è½½å™¨ä¸æ¨¡å—çš„ç»‘å®šå…³ç³»\r\n\r\n\r\n\r\n## 6. å››ç§å¼•ç”¨\r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡å››ç§å¼•ç”¨\r\n\r\n\r\n\r\n**å¼ºå¼•ç”¨**\r\n\r\n1. æ™®é€šå˜é‡èµ‹å€¼å³ä¸ºå¼ºå¼•ç”¨ï¼Œå¦‚ A a = new A();\r\n\r\n2. é€šè¿‡ GC Root çš„å¼•ç”¨é“¾ï¼Œå¦‚æœå¼ºå¼•ç”¨ä¸åˆ°è¯¥å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ‰èƒ½è¢«å›æ”¶\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210901111903574.png\" alt=\"image-20210901111903574\" class=\"scale-80\" />\r\n\r\n**è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰**\r\n\r\n1. ä¾‹å¦‚ï¼šSoftReference a = new SoftReference(new A());\r\n\r\n2. å¦‚æœä»…æœ‰è½¯å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œé¦–æ¬¡åƒåœ¾å›æ”¶ä¸ä¼šå›æ”¶è¯¥å¯¹è±¡ï¼Œå¦‚æœå†…å­˜ä»ä¸è¶³ï¼Œå†æ¬¡å›æ”¶æ—¶æ‰ä¼šé‡Šæ”¾å¯¹è±¡\r\n\r\n3. è½¯å¼•ç”¨è‡ªèº«éœ€è¦é…åˆå¼•ç”¨é˜Ÿåˆ—æ¥é‡Šæ”¾\r\n\r\n4. å…¸å‹ä¾‹å­æ˜¯åå°„æ•°æ®\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210901111957328.png\" alt=\"image-20210901111957328\" class=\"scale-80\" />\r\n\r\n\r\n\r\n**å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰**\r\n\r\n1. ä¾‹å¦‚ï¼šWeakReference a = new WeakReference(new A());\r\n\r\n2. å¦‚æœä»…æœ‰å¼±å¼•ç”¨å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œåªè¦å‘ç”Ÿåƒåœ¾å›æ”¶ï¼Œå°±ä¼šé‡Šæ”¾è¯¥å¯¹è±¡\r\n\r\n3. å¼±å¼•ç”¨è‡ªèº«éœ€è¦é…åˆå¼•ç”¨é˜Ÿåˆ—æ¥é‡Šæ”¾\r\n\r\n4. å…¸å‹ä¾‹å­æ˜¯ ThreadLocalMap ä¸­çš„ Entry å¯¹è±¡\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210901112107707.png\" alt=\"image-20210901112107707\" class=\"scale-80\" />\r\n\r\n\r\n\r\n**è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰**\r\n\r\n1. ä¾‹å¦‚ï¼š PhantomReference a = new PhantomReference(new A(), referenceQueue);\r\n\r\n2. å¿…é¡»é…åˆå¼•ç”¨é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨ï¼Œå½“è™šå¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œç”± Reference Handler çº¿ç¨‹å°†è™šå¼•ç”¨å¯¹è±¡å…¥é˜Ÿï¼Œè¿™æ ·å°±å¯ä»¥çŸ¥é“å“ªäº›å¯¹è±¡è¢«å›æ”¶ï¼Œä»è€Œå¯¹å®ƒä»¬å…³è”çš„èµ„æºåšè¿›ä¸€æ­¥å¤„ç†\r\n\r\n3. å…¸å‹ä¾‹å­æ˜¯ Cleaner é‡Šæ”¾ DirectByteBuffer å…³è”çš„ç›´æ¥å†…å­˜\r\n\r\n<img src=\"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210901112157901.png\" alt=\"image-20210901112157901\" class=\"scale-80\" />\r\n\r\n\r\n\r\n\r\n\r\n>***ä»£ç è¯´æ˜***\r\n>\r\n>* day03.reference.TestPhantomReference - æ¼”ç¤ºè™šå¼•ç”¨çš„åŸºæœ¬ç”¨æ³•\r\n>* day03.reference.TestWeakReference - æ¨¡æ‹Ÿ ThreadLocalMap, é‡‡ç”¨å¼•ç”¨é˜Ÿåˆ—é‡Šæ”¾ entry å†…å­˜\r\n\r\n\r\n\r\n## 7. finalize\r\n\r\n**è¦æ±‚**\r\n\r\n* æŒæ¡ finalize çš„å·¥ä½œåŸç†ä¸ç¼ºç‚¹\r\n\r\n\r\n\r\n**finalize**\r\n\r\n* å®ƒæ˜¯ Object ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚æœå­ç±»é‡å†™å®ƒï¼Œåƒåœ¾å›æ”¶æ—¶æ­¤æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå¯ä»¥åœ¨å…¶ä¸­è¿›è¡Œèµ„æºé‡Šæ”¾å’Œæ¸…ç†å·¥ä½œ\r\n* å°†èµ„æºé‡Šæ”¾å’Œæ¸…ç†æ”¾åœ¨ finalize æ–¹æ³•ä¸­éå¸¸ä¸å¥½ï¼Œéå¸¸å½±å“æ€§èƒ½ï¼Œä¸¥é‡æ—¶ç”šè‡³ä¼šå¼•èµ· OOMï¼Œä» Java9 å¼€å§‹å°±è¢«æ ‡æ³¨ä¸º @Deprecatedï¼Œä¸å»ºè®®è¢«ä½¿ç”¨äº†\r\n\r\n\r\n\r\n**finalize åŸç†**\r\n\r\n1. å¯¹ finalize æ–¹æ³•è¿›è¡Œå¤„ç†çš„æ ¸å¿ƒé€»è¾‘ä½äº java.lang.ref.Finalizer ç±»ä¸­ï¼Œå®ƒåŒ…å«äº†åä¸º unfinalized çš„é™æ€å˜é‡ï¼ˆåŒå‘é“¾è¡¨ç»“æ„ï¼‰ï¼ŒFinalizer ä¹Ÿå¯è¢«è§†ä¸ºå¦ä¸€ç§å¼•ç”¨å¯¹è±¡ï¼ˆåœ°ä½ä¸è½¯ã€å¼±ã€è™šç›¸å½“ï¼Œåªæ˜¯ä¸å¯¹å¤–ï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨ï¼‰\r\n2. å½“é‡å†™äº† finalize æ–¹æ³•çš„å¯¹è±¡ï¼Œåœ¨æ„é€ æ–¹æ³•è°ƒç”¨ä¹‹æ—¶ï¼ŒJVM éƒ½ä¼šå°†å…¶åŒ…è£…æˆä¸€ä¸ª Finalizer å¯¹è±¡ï¼Œå¹¶åŠ å…¥ unfinalized é“¾è¡¨ä¸­\r\n\r\n![image-20210901121032813](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210901121032813.png)\r\n\r\n3. Finalizer ç±»ä¸­è¿˜æœ‰å¦ä¸€ä¸ªé‡è¦çš„é™æ€å˜é‡ï¼Œå³ ReferenceQueue å¼•ç”¨é˜Ÿåˆ—ï¼Œåˆšå¼€å§‹å®ƒæ˜¯ç©ºçš„ã€‚å½“ç‹—å¯¹è±¡å¯ä»¥è¢«å½“ä½œåƒåœ¾å›æ”¶æ—¶ï¼Œå°±ä¼šæŠŠè¿™äº›ç‹—å¯¹è±¡å¯¹åº”çš„ Finalizer å¯¹è±¡åŠ å…¥æ­¤å¼•ç”¨é˜Ÿåˆ—\r\n4. ä½†æ­¤æ—¶ Dog å¯¹è±¡è¿˜æ²¡æ³•è¢«ç«‹åˆ»å›æ”¶ï¼Œå› ä¸º unfinalized -> Finalizer è¿™ä¸€å¼•ç”¨é“¾è¿˜åœ¨å¼•ç”¨å®ƒå˜›ï¼Œä¸ºçš„æ˜¯ã€å…ˆåˆ«ç€æ€¥å›æ”¶å•Šï¼Œç­‰æˆ‘è°ƒå®Œ finalize æ–¹æ³•ï¼Œå†å›æ”¶ã€‘\r\n5. FinalizerThread çº¿ç¨‹ä¼šä» ReferenceQueue ä¸­é€ä¸€å–å‡ºæ¯ä¸ª Finalizer å¯¹è±¡ï¼ŒæŠŠå®ƒä»¬ä»é“¾è¡¨æ–­å¼€å¹¶çœŸæ­£è°ƒç”¨ finallize æ–¹æ³•\r\n\r\n![image-20210901122228916](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210901122228916.png)\r\n\r\n6. ç”±äºæ•´ä¸ª Finalizer å¯¹è±¡å·²ç»ä» unfinalized é“¾è¡¨ä¸­æ–­å¼€ï¼Œè¿™æ ·æ²¡è°èƒ½å¼•ç”¨åˆ°å®ƒå’Œç‹—å¯¹è±¡ï¼Œæ‰€ä»¥ä¸‹æ¬¡ gc æ—¶å°±è¢«å›æ”¶äº†\r\n\r\n\r\n\r\n**finalize ç¼ºç‚¹**\r\n\r\n* æ— æ³•ä¿è¯èµ„æºé‡Šæ”¾ï¼šFinalizerThread æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œä»£ç å¾ˆæœ‰å¯èƒ½æ²¡æ¥å¾—åŠæ‰§è¡Œå®Œï¼Œçº¿ç¨‹å°±ç»“æŸäº†\r\n* æ— æ³•åˆ¤æ–­æ˜¯å¦å‘ç”Ÿé”™è¯¯ï¼šæ‰§è¡Œ finalize æ–¹æ³•æ—¶ï¼Œä¼šåæ‰ä»»æ„å¼‚å¸¸ï¼ˆThrowableï¼‰\r\n* å†…å­˜é‡Šæ”¾ä¸åŠæ—¶ï¼šé‡å†™äº† finalize æ–¹æ³•çš„å¯¹è±¡åœ¨ç¬¬ä¸€æ¬¡è¢« gc æ—¶ï¼Œå¹¶ä¸èƒ½åŠæ—¶é‡Šæ”¾å®ƒå ç”¨çš„å†…å­˜ï¼Œå› ä¸ºè¦ç­‰ç€ FinalizerThread è°ƒç”¨å®Œ finalizeï¼ŒæŠŠå®ƒä» unfinalized é˜Ÿåˆ—ç§»é™¤åï¼Œç¬¬äºŒæ¬¡ gc æ—¶æ‰èƒ½çœŸæ­£é‡Šæ”¾å†…å­˜\r\n* æœ‰çš„æ–‡ç« æåˆ°ã€Finalizer çº¿ç¨‹ä¼šå’Œæˆ‘ä»¬çš„ä¸»çº¿ç¨‹è¿›è¡Œç«äº‰ï¼Œä¸è¿‡ç”±äºå®ƒçš„ä¼˜å…ˆçº§è¾ƒä½ï¼Œè·å–åˆ°çš„CPUæ—¶é—´è¾ƒå°‘ï¼Œå› æ­¤å®ƒæ°¸è¿œä¹Ÿèµ¶ä¸ä¸Šä¸»çº¿ç¨‹çš„æ­¥ä¼ã€‘è¿™ä¸ªæ˜¾ç„¶æ˜¯é”™è¯¯çš„ï¼ŒFinalizerThread çš„ä¼˜å…ˆçº§è¾ƒæ™®é€šçº¿ç¨‹æ›´é«˜ï¼ŒåŸå› åº”è¯¥æ˜¯ finalize ä¸²è¡Œæ‰§è¡Œæ…¢ç­‰åŸå› ç»¼åˆå¯¼è‡´\r\n\r\n\r\n\r\n> ***ä»£ç è¯´æ˜***\r\n>\r\n> * day03.reference.TestFinalize - finalize çš„æµ‹è¯•ä»£ç "},{"title":"mallé¡¹ç›®æ€»ç»“","tags":["Spring Boot","Spring Cloud","Spring Cloud Alibaba","MySQL","MyBatis-Plus","Redis","RabbitMQ"],"categories":["Java","é¡¹ç›®"],"author":"imklaus","excerpt":"\n\nå‚è€ƒè§†é¢‘ï¼š[é›·ç¥è°·ç²’å•†åŸé¡¹ç›®](https://www.bilibili.com/video/BV1np4y1C7Yf/)\n\n\n\n\n ![mall](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230315150052611.png)\n\n![mall](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230315145952769.png)\n\n## é¡¹ç›®åç§°\n\n- ä¹¦é˜â€å›¾ä¹¦å•†åŸç®¡ç†ç³»ç»Ÿã€å¾®ç›Ÿç”µå­å•†åŸç½‘ç»œäº¤æ˜“ç³»ç»Ÿã€é«˜æ ¡é—²ç½®èµ„æºäº¤æ˜“ç³»ç»Ÿ\n- è´­ç‰©åœ¨â€œeâ€é›¶å”®å•†åŸå¹³å°ã€æƒ å†œé€šâ€”æ™ºæ…§å†œèµ„å•†åŸ ã€å†œäº§å“è½»é‡çº§å¾®å•†åŸç³»ç»Ÿ\n- ç²¾ç¾é‹ä¸šè´¸æ˜“ç³»ç»Ÿ\n\n## é¡¹ç›®ç®€ä»‹\n\n- æœ¬ç³»ç»Ÿé‡‡ç”¨å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹åˆ©ç”¨Spring Cloudæ¡†æ¶ï¼Œé€šè¿‡ä¸šåŠ¡åˆ’åˆ†ï¼Œè®¾è®¡ç‹¬ç«‹æ¨¡å—çš„å¾®æœåŠ¡ï¼Œæ‹†åˆ†ä¸ºè®¢å•æœåŠ¡ã€è´­ç‰©è½¦æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ã€ç”¨æˆ·ç®¡ç†æœåŠ¡ã€å•†å“ç®¡ç†æœåŠ¡ã€æ–‡ä»¶ä¸Šä¼ æœåŠ¡ç­‰æ¨¡å—ï¼Œç»“åˆäº†å½“å‰æ¯”è¾ƒæµè¡Œçš„äº’è”ç½‘ç”µå•†æ¨¡å¼ï¼Œä¸ºæ¶ˆè´¹è€…æä¾›å•†å“è´¸æ˜“å¹³å°ã€‚\n","link":"/posts/mall","content":"\n\nå‚è€ƒè§†é¢‘ï¼š[é›·ç¥è°·ç²’å•†åŸé¡¹ç›®](https://www.bilibili.com/video/BV1np4y1C7Yf/)\n\n\n\n\n ![mall](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230315150052611.png)\n\n![mall](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230315145952769.png)\n\n## é¡¹ç›®åç§°\n\n- ä¹¦é˜â€å›¾ä¹¦å•†åŸç®¡ç†ç³»ç»Ÿã€å¾®ç›Ÿç”µå­å•†åŸç½‘ç»œäº¤æ˜“ç³»ç»Ÿã€é«˜æ ¡é—²ç½®èµ„æºäº¤æ˜“ç³»ç»Ÿ\n- è´­ç‰©åœ¨â€œeâ€é›¶å”®å•†åŸå¹³å°ã€æƒ å†œé€šâ€”æ™ºæ…§å†œèµ„å•†åŸ ã€å†œäº§å“è½»é‡çº§å¾®å•†åŸç³»ç»Ÿ\n- ç²¾ç¾é‹ä¸šè´¸æ˜“ç³»ç»Ÿ\n\n## é¡¹ç›®ç®€ä»‹\n\n- æœ¬ç³»ç»Ÿé‡‡ç”¨å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹åˆ©ç”¨Spring Cloudæ¡†æ¶ï¼Œé€šè¿‡ä¸šåŠ¡åˆ’åˆ†ï¼Œè®¾è®¡ç‹¬ç«‹æ¨¡å—çš„å¾®æœåŠ¡ï¼Œæ‹†åˆ†ä¸ºè®¢å•æœåŠ¡ã€è´­ç‰©è½¦æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ã€ç”¨æˆ·ç®¡ç†æœåŠ¡ã€å•†å“ç®¡ç†æœåŠ¡ã€æ–‡ä»¶ä¸Šä¼ æœåŠ¡ç­‰æ¨¡å—ï¼Œç»“åˆäº†å½“å‰æ¯”è¾ƒæµè¡Œçš„äº’è”ç½‘ç”µå•†æ¨¡å¼ï¼Œä¸ºæ¶ˆè´¹è€…æä¾›å•†å“è´¸æ˜“å¹³å°ã€‚\n<!-- more -->\n\n## ç³»ç»Ÿæ¶æ„\n\n- è¯¥ç³»ç”¨é‡‡ç”¨SpringCloudæ¶æ„ï¼Œåˆ©ç”¨SpringBootæ„å»ºåº”ç”¨ï¼ŒNacosä½œä¸ºæœåŠ¡çš„æ³¨å†Œã€é…ç½®ä¸­å¿ƒï¼ŒOpenFeignå®ç°ä¸å…¶ä»–æ¨¡å—è¿›è¡Œäº¤äº’ï¼ŒSentinelå®ç°ç†”æ–­é™çº§å’Œé”™è¯¯å¤„ç†ï¼ŒSeataåˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼ŒGatewayä½œä¸ºæœåŠ¡ç½‘å…³ï¼ŒSleuthé“¾è·¯è¿½è¸ªï¼ŒRabbitMQå®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼ŒRedisä½œä¸ºç¼“å­˜è§£å†³è¯»å¤šå†™å°‘çš„åœºæ™¯ï¼ŒMySQLè¿›è¡ŒæŒä¹…åŒ–ï¼ŒMyBatisPlusä½œä¸ºæŒä¹…åŒ–æ¡†æ¶ã€‚\n\n## æˆ‘çš„èŒè´£\n\n- å®Œæˆå¹³å°**å•†å“ã€è´­ç‰©è½¦ã€è®¢å•ã€åº“å­˜ã€ä¼˜æƒ åˆ¸ã€æ”¯ä»˜ã€æ–‡ä»¶ä¸Šä¼ **ç­‰æœåŠ¡æ¨¡å—çš„æ¥å£å¼€å‘ï¼›\n- ä½¿ç”¨**RabbitMQå»¶æ—¶é˜Ÿåˆ—**å®ç°æœªä»˜æ¬¾è®¢å•ï¼Œè¶…è¿‡ä¸€å®šæ—¶é—´åï¼Œ**ç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆè®¢å•å¹¶è§£é”åº“å­˜ï¼›**\n- ä½¿ç”¨**redis+luaè„šæœ¬**é˜²æ­¢é‡å¤æäº¤æ”»å‡»ï¼Œ**è§£å†³äº†ç”¨æˆ·åˆ©ç”¨æµè§ˆå™¨åˆ·æ–°å’Œå›é€€é‡å¤æäº¤è®¢å•çš„é—®é¢˜ï¼›**\n- åŸºäº**Redissonåˆ†å¸ƒå¼é™æµï¼šSemaphoreä¿¡å·é‡**å®ç°**ç§’æ€å’Œä¸€äººä¸€å•åŠŸèƒ½**ï¼Œé€šè¿‡é€æ­¥**æ”¹è¿›åˆ†å¸ƒå¼é”**çš„æ–¹æ¡ˆï¼Œ**è§£å†³åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ç”¨æˆ·é‡å¤æäº¤è®¢å•çš„å¹‚ç­‰æ€§é—®é¢˜ï¼›**\n- åŸºäº **Token** çš„è®¤è¯æˆæƒæœºåˆ¶ï¼š**JWT**ï¼Œé€šè¿‡å¯¹ç™»å½•ç”¨æˆ·é¢å‘ç™»å½•å‡­è¯ï¼Œ**å®ç°ç™»å½•æ¨¡å—è®¤è¯æˆæƒåŠŸèƒ½ï¼›**\n- ä½¿ç”¨**ElasticSearchåˆ†å¸ƒå¼å…¨æ–‡æœç´¢å¼•æ“**ï¼Œå¯¹å†·æ•°æ®ï¼Œå•†å“ä¿¡æ¯æ•°æ®**å»ºç«‹ç´¢å¼•**ï¼Œ**ä¿è¯å†·æ•°æ®ï¼Œå•†å“æ•°æ®çš„æŸ¥è¯¢æ€§èƒ½ï¼›**\n- åˆ©ç”¨**Jmeterå·¥å…·**è¿›è¡Œå‹æµ‹ï¼Œæ‰¾åˆ°åœ¨**å¤šçº¿ç¨‹**æƒ…å†µä¸‹é€ æˆçš„**å†…å­˜æ³„æ¼ï¼Œå¹¶å‘ä¸åŒæ­¥**ç­‰é—®é¢˜ï¼Œ**ä¿è¯äº†ç³»ç»Ÿåœ¨çº¿ä¸Šçš„å¤„ç†èƒ½åŠ›å’Œç¨³å®šæ€§ç»´æŒåœ¨ä¸€ä¸ªæ ‡å‡†èŒƒå›´å†…ï¼›**\n- ä½¿ç”¨**Redis**è¿›è¡Œ**çƒ­ç‚¹ä¿¡æ¯ç¼“å­˜**ï¼Œæ¯”å¦‚é™„è¿‘è´­ç‰©è½¦ä¿¡æ¯å’Œç™»å½•ä¿¡æ¯,**æé«˜æœåŠ¡å™¨çš„æ€§èƒ½**ï¼›\n- ä½¿ç”¨**Spring Scheduleå®šæ—¶ä»»åŠ¡**æå‰ä¸Šæ¶æŠ¢è´­å•†å“ä¿¡æ¯åˆ°Redisç¼“å­˜ä¸­å®ç°**åº“å­˜é¢„çƒ­åŠŸèƒ½**\n- ä½¿ç”¨**Redissonåˆ†å¸ƒå¼é”**è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹å•†å“é‡å¤ä¸Šæ¶çš„**å¹‚ç­‰æ€§é—®é¢˜**ï¼›\n- ä½¿ç”¨**Spring Cacheæ–¹æ³•çº§åˆ«ç¼“å­˜æŠ€æœ¯**ï¼Œå®ç°å·²ç»è¢«è°ƒç”¨è¿‡çš„æŒ‡å®šçš„ç›®æ ‡æ–¹æ³•ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–æ–¹æ³•è°ƒç”¨åçš„ç»“æœè¿”å›ï¼Œ**æé«˜ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ï¼›**\n- ä½¿ç”¨**CompletableFuture å¼‚æ­¥ç¼–æ’**è§£å†³æŸ¥è¯¢å•†å“è¯¦æƒ…â»š**å“åº”é€Ÿåº¦æ…¢çš„é—®é¢˜**ï¼›\n- ä½¿ç”¨**Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒä¸é…ç½®ä¸­å¿ƒ**ï¼Œå°†æœåŠ¡åç§°åŠå…¶å¯¹åº”åœ°å€è¿›è¡Œå­˜å‚¨ï¼Œå®ç°æœåŠ¡åœ°å€çš„**æ³¨å†Œä¸å‘ç°**ä»¥åŠ**é…ç½®åŠ¨æ€åŠ è½½**ç­‰åŠŸèƒ½\n- ä½¿ç”¨**Seataä¸­çš„TCCäº‹åŠ¡æ¨¡å¼**ï¼ŒæŠŠä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡é€»è¾‘æ‹†åˆ†æˆä¸‰ä¸ªé˜¶æ®µ,é€šè¿‡äº‹åŠ¡ç®¡ç†å™¨è¿›è¡Œç®¡ç†ï¼Œ**ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼›**\n- æ•´åˆ**ç¬¬ä¸‰æ–¹æ–‡ä»¶ä¸Šä¼ æœåŠ¡**ï¼Œå¦‚é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨ï¼ŒåŸºäºæœåŠ¡ç«¯ç­¾ååç›´ä¼ ï¼Œ**ä¿è¯æ–‡ä»¶ä¼ è¾“çš„å®‰å…¨æ€§**ï¼›\n- æ•´åˆ**OAuth2.0åè®®æˆæƒ**ï¼Œä½¿ç”¨AccessTokenè°ƒç”¨å¼€å‘APIè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œ**æ”¯æŒå¾®ä¿¡ã€QQã€å¾®åšã€Giteeã€Githubç­‰ç¬¬ä¸‰æ–¹ç™»é™†ï¼›**\n- ä½¿ç”¨**RSAç®—æ³•ä¿è¯æ•°æ®åŠ å¯†å®‰å…¨**ï¼ŒæˆåŠŸå¯¹æ¥ç¬¬ä¸‰æ–¹æ”¯ä»˜åŠŸèƒ½ï¼Œè®¢å•ä»˜æ¬¾æ”¯æŒ**æ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜**ç­‰ç¬¬ä¸‰æ–¹æ”¯ä»˜æœåŠ¡ã€‚\n\n1ã€æ¢³ç†è‡ªå·±é¡¹ç›®çš„éš¾ç‚¹æˆ–äº®ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ\n2ã€é¡¹ç›®ä¸­ï¼Œä¸ºä»€ä¹ˆç”¨ xx æŠ€æœ¯ç‚¹ï¼Œç”¨ yy çš„å¯ä»¥å—ï¼Ÿæˆ–è€…ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿ\n\nå…³äºç¬¬ä¸€ç‚¹ï¼Œè¿™ä¸ªå†…å®¹å³ä½¿é¢è¯•å®˜æ²¡é—®ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è‡ªæˆ‘ä»‹ç»æ—¶å€™è¡¨è¿°å‡ºæ¥ã€‚\n\nå¦‚æœä½ è§‰å¾—è‡ªå·±çš„é¡¹ç›®çš„ç¡®æ²¡ä»€ä¹ˆå‰å®³çš„ä¸œè¥¿ï¼Œéƒ½æ˜¯ä¸šåŠ¡çš„ curdã€‚é‚£å°±æŒ‘ä¸€ä¸ªå€¼å¾—è¯´è¿‡çš„ä¼˜åŒ–ï¼Œæˆ–è€…è®¾è®¡æ–¹æ¡ˆä¹Ÿè¡Œã€‚\n\næ¯•ç«Ÿé«˜å¤§ä¸Šçš„ä¸œè¥¿çš„ç¡®åªæœ‰å°‘æ•°äººæ¥è§¦åˆ°ï¼Œéƒ½æ˜¯ç†è§£çš„ã€‚\n\næ¥ä¸‹æ¥å…³äºç¬¬äºŒç‚¹ï¼Œç›®çš„æ˜¯è€ƒå¯Ÿä½ å¯¹è‡ªå·±é¡¹ç›®çš„ç†è§£æ˜¯ä¸æ˜¯çœŸçš„çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œè¿˜æ˜¯è¯´è‡ªå·±åªæ˜¯ä¸€ä¸ªæ— æƒ…çš„ curd æœºå™¨ã€‚\n\né¡¹ç›®åˆ‡å…¥ç‚¹:åˆ†å¸ƒå¼é”çš„å®ç°ã€åˆ†å¸ƒå¼Sessionã€åˆ†å¸ƒå¼ç¼“å­˜ã€ç¼“å­˜ä¸€è‡´æ€§ã€è·¨åŸŸã€å¼‚æ­¥ç¼–æ’ç­‰ï¼Œé‡ç‚¹æŠŠæ¡ç§’æ€æ¨¡å—å’Œ\nè®¢å•æ¨¡å—çš„è®¾è®¡åŠæµç¨‹\n\n\n\n## é¡¹ç›®æ¦‚è¿°\n\nâ€‹    æœ¬ç³»ç»Ÿæ˜¯ä¸“é—¨ä¸ºç²¾ç¾é‹ä¸šæœ‰é™å…¬å¸åˆ¶å®šçš„å¯¹å¤–è´¸æ˜“ç³»ç»Ÿï¼Œå¤§éƒ¨åˆ†å•†å“å‡ºå”®ç»™è¶Šå—åœ°åŒºï¼Œä¾›é‚£è¾¹çš„å‚å•†è¿›è¡ŒäºŒæ¬¡åŠ å·¥ã€‚\nâ€‹    æœ¬ç³»ç»Ÿé‡‡ç”¨å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹åˆ©ç”¨Spring Cloudæ¡†æ¶ï¼Œé€šè¿‡ä¸šåŠ¡åˆ’åˆ†ï¼Œè®¾è®¡ç‹¬ç«‹æ¨¡å—çš„å¾®æœåŠ¡ï¼Œæ‹†åˆ†ä¸ºè®¢å•æœåŠ¡ã€è´­ç‰©è½¦æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ã€ç”¨æˆ·ç®¡ç†æœåŠ¡ã€å•†å“ç®¡ç†æœåŠ¡ã€æ–‡ä»¶ä¸Šä¼ æœåŠ¡ç­‰æ¨¡å—ï¼Œä¸ºå®¢æˆ·æä¾›åŠæˆå“å•†å“è´¸æ˜“å¹³å°ã€‚\n\n### æ ¸å¿ƒä¸šåŠ¡ä¸€ï¼šè´­ç‰©è½¦\n\n- è´­ç‰©è½¦Redisæ•°æ®ç»“æ„é€‰å‹ï¼š\n\n  - åŒå±‚ Mapï¼šMap<String,Map<String,String>>\n\n    - ç¬¬ä¸€å±‚ Mapï¼ŒKey æ˜¯ç”¨æˆ· id\n\n    - ç¬¬äºŒå±‚ Mapï¼ŒKey æ˜¯è´­ç‰©è½¦ä¸­å•†å“ idï¼Œå€¼æ˜¯è´­ç‰©é¡¹æ•°æ®\n\n- è´­ç‰©è½¦ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼šæ–°å¢å•†å“åˆ°è´­ç‰©è½¦ã€æŸ¥è¯¢è´­ç‰©è½¦\n\n  - æ–°å¢å•†å“ï¼šåˆ¤æ–­æ˜¯å¦ç™»å½•\n\n    - æ˜¯ï¼šåˆ™æ·»åŠ å•†å“åˆ°åå° Redis ä¸­ï¼ŒæŠŠ user çš„å”¯ä¸€æ ‡è¯†ç¬¦ä½œä¸º keyã€‚\n    - å¦ï¼šåˆ™æ·»åŠ å•†å“åˆ°åå° Redis ä¸­ï¼Œä½¿ç”¨éšæœºç”Ÿæˆçš„ user-key ä½œä¸º keyã€‚\n\n- æŸ¥è¯¢è´­ç‰©è½¦åˆ—è¡¨ï¼šåˆ¤æ–­æ˜¯å¦ç™»å½•\n\n  - å¦ï¼šç›´æ¥æ ¹æ® user-key æŸ¥è¯¢ Redis ä¸­æ•°æ®å¹¶å±•ç¤º\n  - æ˜¯ï¼šå·²ç™»å½•ï¼Œåˆ™éœ€è¦å…ˆæ ¹æ® user-key æŸ¥è¯¢ Redis æ˜¯å¦æœ‰æ•°æ®ã€‚\n  - æœ‰ï¼šéœ€è¦æäº¤åˆ°åå°æ·»åŠ åˆ° Redis ï¼Œåˆå¹¶æ•°æ®ï¼Œè€ŒåæŸ¥è¯¢ã€‚\n  - å¦ï¼šç›´æ¥å»åå°æŸ¥è¯¢ Redis ï¼Œè€Œåè¿”å›\n\n\n### æ ¸å¿ƒä¸šåŠ¡äºŒï¼šè®¢å•\n\n#### è®¢å•ä¸­å¿ƒ\n\n- ç”µå•†ç³»ç»Ÿæ¶‰åŠåˆ° 3 æµï¼Œåˆ†åˆ«æ—¶ä¿¡æ¯æµï¼Œèµ„é‡‘æµï¼Œç‰©æµï¼Œè€Œè®¢å•ç³»ç»Ÿä½œä¸ºä¸­æ¢å°†ä¸‰è€…æœ‰æœºçš„é›†\n  åˆèµ·æ¥ã€‚\n- è®¢å•æ¨¡å—æ˜¯ç”µå•†ç³»ç»Ÿçš„æ¢çº½ï¼Œåœ¨è®¢å•è¿™ä¸ªç¯èŠ‚ä¸Šéœ€æ±‚è·å–å¤šä¸ªæ¨¡å—çš„æ•°æ®å’Œä¿¡æ¯ï¼ŒåŒæ—¶å¯¹è¿™\n  äº›ä¿¡æ¯è¿›è¡ŒåŠ å·¥å¤„ç†åæµå‘ä¸‹ä¸ªç¯èŠ‚ï¼Œè¿™ä¸€ç³»åˆ—å°±æ„æˆäº†è®¢å•çš„ä¿¡æ¯æµé€šã€‚\n\n#### è®¢å•æ„æˆ\n\n![mall](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410153419456.png)\n\n#### è®¢å•çŠ¶æ€\n\n1. å¾…ä»˜æ¬¾\n   - ç”¨æˆ·æäº¤è®¢å•åï¼Œè®¢å•è¿›è¡Œé¢„ä¸‹å•ï¼Œç›®å‰ä¸»æµç”µå•†ç½‘ç«™éƒ½ä¼šå”¤èµ·æ”¯ä»˜ï¼Œä¾¿äºç”¨æˆ·å¿«é€Ÿå®Œæˆæ”¯\n     ä»˜ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¾…ä»˜æ¬¾çŠ¶æ€ä¸‹å¯ä»¥å¯¹åº“å­˜è¿›è¡Œé”å®šï¼Œé”å®šåº“å­˜éœ€è¦é…ç½®æ”¯ä»˜è¶…æ—¶æ—¶é—´ï¼Œè¶…\n     æ—¶åå°†è‡ªåŠ¨å–æ¶ˆè®¢å•ï¼Œè®¢å•å˜æ›´å…³é—­çŠ¶æ€ã€‚\n2. å·²ä»˜æ¬¾/ å¾…å‘è´§\n   - ç”¨æˆ·å®Œæˆè®¢å•æ”¯ä»˜ï¼Œè®¢å•ç³»ç»Ÿéœ€è¦è®°å½•æ”¯ä»˜æ—¶é—´ï¼Œæ”¯ä»˜æµæ°´å•å·ä¾¿äºå¯¹è´¦ï¼Œè®¢å•ä¸‹æ”¾åˆ° WMS\n     ç³»ç»Ÿï¼Œä»“åº“è¿›è¡Œè°ƒæ‹¨ï¼Œé…è´§ï¼Œåˆ†æ‹£ï¼Œå‡ºåº“ç­‰æ“ä½œã€‚\n3. å¾…æ”¶è´§/ å·²å‘è´§\n   - ä»“å‚¨å°†å•†å“å‡ºåº“åï¼Œè®¢å•è¿›å…¥ç‰©æµç¯èŠ‚ï¼Œè®¢å•ç³»ç»Ÿéœ€è¦åŒæ­¥ç‰©æµä¿¡æ¯ï¼Œä¾¿äºç”¨æˆ·å®æ—¶çŸ¥æ‚‰ç‰©\n     å“ç‰©æµçŠ¶æ€\n4. å·²å®Œæˆ\n   - ç”¨æˆ·ç¡®è®¤æ”¶è´§åï¼Œè®¢å•äº¤æ˜“å®Œæˆã€‚åç»­æ”¯ä»˜ä¾§è¿›è¡Œç»“ç®—ï¼Œå¦‚æœè®¢å•å­˜åœ¨é—®é¢˜è¿›å…¥å”®åçŠ¶æ€\n5. å·²å–æ¶ˆ\n   - ä»˜æ¬¾ä¹‹å‰å–æ¶ˆè®¢å•ã€‚åŒ…æ‹¬è¶…æ—¶æœªä»˜æ¬¾æˆ–ç”¨æˆ·å•†æˆ·å–æ¶ˆè®¢å•éƒ½ä¼šäº§ç”Ÿè¿™ç§è®¢å•çŠ¶æ€ã€‚\n\n#### è®¢å•æµç¨‹\n\n- æ­£å¸¸çš„ç½‘è´­æ­¥éª¤ï¼šè®¢å•ç”Ÿæˆâ€“>æ”¯ä»˜è®¢å•â€“>å–å®¶å‘è´§â€“>ç¡®è®¤æ”¶è´§â€“>äº¤æ˜“æˆåŠŸ\n\n##### 1.è®¢å•åˆ›å»ºä¸æ”¯ä»˜\n\n`http://order.gulimall.com/toTrade`\n\n![mall](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403130800413.png)\n\n`http://order.gulimall.com/submitOrder`\n\n- `com.klaus.gulimall.order.web.OrderWebController#submitOrder`\n\n```java\n\n     /**\n     * \n     * @param vo ä¸Šä¸€ä¸ªé¡µé¢æºå¸¦çš„æ•°æ®\n     * @param model\n     * @param redirectAttributes\n     * @return\n     */\n@PostMapping(\"/submitOrder\")\npublic String submitOrder(OrderSubmitVo vo, Model model, RedirectAttributes redirectAttributes){\n    //æ•è·å¼‚å¸¸\n    try {\n        SubmitOrderResponseVo responseVo = orderService.submitOrder(vo);\n        //ä¸‹å•ï¼šå»åˆ›å»ºè®¢å•ï¼ŒéªŒä»¤ç‰Œï¼ŒéªŒä»·æ ¼ï¼Œé”åº“å­˜....\n        System.out.println(\"è®¢å•æäº¤çš„æ•°æ®...\" + vo);\n        if (responseVo.getCode() == 0){\n            //ä¸‹å•æˆåŠŸæ¥åˆ°æ”¯ä»˜é€‰æ‹©é¡µ\n            model.addAttribute(\"submitOrderResponse\", responseVo);\n            return \"pay\";\n        }else {\n            //ä¸‹å•å¤±è´¥é‡å®šå‘åˆ°è®¢å•ç¡®è®¤é¡µ\n            String msg = \"ä¸‹å•å¤±è´¥ï¼š\";\n            switch (responseVo.getCode()){\n                case 1: msg+= \"è®¢å•ä¿¡æ¯è¿‡æœŸï¼Œè¯·åˆ·æ–°å†æ¬¡æäº¤\"; break;\n                case 2: msg+= \"è®¢å•å•†å“ä»·æ ¼å‘ç”Ÿäº†å˜åŒ–ï¼Œè¯·åˆ·æ–°å†æ¬¡æäº¤\"; break;\n                case 3: msg+= \"åº“å­˜é”å®šå¤±è´¥ï¼Œå•†å“åº“å­˜ä¸è¶³\"; break;\n            }\n            redirectAttributes.addFlashAttribute(\"msg\", msg);\n            return \"redirect:http://order.gulimall.com/toTrade\";\n        }\n    }catch (Exception e) {\n        if (e instanceof NoStockException) {\n            String message = ((NoStockException) e).getMessage();\n            //æŠ›å‡ºæ— åº“å­˜å¼‚å¸¸åé¡µé¢æ˜¾ç¤ºæ­¤å¼‚å¸¸ä¿¡æ¯NO_STOCK_EXCEPTION(21000, \"å•†å“åº“å­˜ä¸è¶³\");\n            redirectAttributes.addFlashAttribute(\"msg\", message);\n        }\n        //æŠ›å‡ºä»»ä½•å¼‚å¸¸åé‡å®šå‘ä¼šè®¢å•ç¡®è®¤é¡µ\n        return \"redirect:http://order.gulimall.com/toTrade\";\n    }\n}\n\n```\n\n- `com.klaus.gulimall.order.service.impl.OrderServiceImpl#submitOrder`\n\n```java\n /**\n     * ä¸‹å•\n     * åŠ å…¥ç»Ÿä¸€äº‹åŠ¡\n     * @param vo\n     * @return\n     * @Transactional æœ¬åœ°äº‹åŠ¡ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ï¼Œåªèƒ½æ§åˆ¶è‡ªå·±çš„å›æ»šï¼Œæ§åˆ¶ä¸äº†å…¶ä»–æœåŠ¡çš„å›æ»š\n     * (isolation = Isolation.REPEATABLE_READ)é»˜è®¤éš”ç¦»çº§åˆ«\n     * ->åˆ†å¸ƒå¼äº‹åŠ¡: æœ€å¤§åŸå› æ˜¯ç½‘ç»œé—®é¢˜+åˆ†å¸ƒå¼æœºå™¨\n     *\n     */\n//@GlobalTransactional é«˜å¹¶å‘ æ­¤æ³¨è§£ä¼šåŠ å¾ˆå¤šå…¨å±€é”ï¼Œå¯¼è‡´ä¸‹å•åªèƒ½ç­‰åˆ«äººå…ˆä¸‹å®Œå•æ‰èƒ½ä¸‹ï¼Œé«˜å¹¶å‘ç¯å¢ƒä¸å¯å–\n    @Transactional\n    @Override\n    public SubmitOrderResponseVo submitOrder(OrderSubmitVo vo) {\n        submitVoThreadLocal.set(vo);\n        SubmitOrderResponseVo responseVo = new SubmitOrderResponseVo();\n        //ä»æ‹¦æˆªå™¨é‡Œè·å–ç”¨æˆ·ä¿¡æ¯\n        MemberRespVo memberRespVo = LoginUserInterceptor.loginUser.get();\n        responseVo.setCode(0);\n        //1ã€éªŒè¯ä»¤ç‰Œã€ä»¤ç‰Œçš„å¯¹æ¯”å’Œåˆ é™¤å¿…é¡»ä¿è¯åŸå­æ€§ã€‘\n        //0ä»¤ç‰Œå¤±è´¥ - 1åˆ é™¤æˆåŠŸ(æ ¡éªŒæˆåŠŸ)\n        String script = \"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\";\n        String orderToken = vo.getOrderToken();\n        //åŸå­éªŒè¯ä»¤ç‰Œå’Œåˆ é™¤ä»¤ç‰Œ\n        Long result = redisTemplate.execute(\n                //è„šæœ¬è¿”å›ç±»å‹->0,1\n                new DefaultRedisScript<Long>(script, Long.class),\n                //å°†ç¼“å­˜ä¸­å°†è¦æ¯”å¯¹çš„keyè½¬ä¸ºé›†åˆ\n                Arrays.asList(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberRespVo.getId()),\n                //ä¼ å…¥è¦æ ¡éªŒçš„å€¼\n                orderToken);\n        if (result == 0L) {\n            //éªŒè¯å¤±è´¥ï¼Œè®¾ç½®é”™è¯¯çŠ¶æ€ç ä¸º1ï¼Œkeyè¿‡æœŸç­‰æƒ…å†µ\n            responseVo.setCode(1);\n            return responseVo;\n        } else {\n            //éªŒè¯æˆåŠŸ\n            //ä¸‹å•ï¼šå»åˆ›å»ºè®¢å•ï¼ŒéªŒä»¤ç‰Œï¼ŒéªŒä»·æ ¼ï¼Œé”åº“å­˜....\n            //1ã€åˆ›å»ºè®¢å•ï¼Œè®¢å•é¡¹ç­‰ä¿¡æ¯\n            OrderCreateTo order = createOrder();\n            // todo è§‚å¯Ÿè€…æ¨¡å¼: å‘å¸ƒå•†å“ä¸‹å•äº‹ä»¶\n            ApplicationContextHolder.getInstance().publishEvent(new OrderCreateEvent(this, order));\n            //2ã€éªŒä»·ï¼Œæ‹¿åˆ°åº”ä»˜é‡‘é¢ä¸é¡µé¢æäº¤çš„é‡‘é¢è¿›è¡Œæ ¡éªŒ\n            BigDecimal payAmount = order.getOrder().getPayAmount();\n            BigDecimal payPrice = vo.getPayPrice();\n            //ä¸¤è€…ç›¸å‡çš„ç»å¯¹å€¼å°äº0.01å°±ç®—æ ¡éªŒé€šè¿‡\n            if (Math.abs(payAmount.subtract(payPrice).doubleValue()) < 0.01){\n                //æ ¡éªŒé€šè¿‡\n                //TODO 3ã€ä¿å­˜è®¢å•\n                saveOrder(order);\n                //4ã€åº“å­˜é”å®šï¼Œè¿™æ ·èƒ½é¿å…åº“å­˜ä¸è¶³ç­‰ç°è±¡å‘ç”Ÿ\n                //åªè¦æœ‰å¼‚å¸¸å°±å›æ»šè®¢å•æ•°æ®(è®¢å•å·ï¼Œæ‰€æœ‰è®¢å•é¡¹ï¼ˆskuIdï¼ŒskuNameï¼Œnumï¼‰)\n                WareSkuLockVo lockVo = new WareSkuLockVo();\n                //è®¾ç½®æŒ‡å®šåº“å­˜çš„è®¢å•å·\n                lockVo.setOrderSn(order.getOrder().getOrderSn());\n                List<OrderItemVo> locks = order.getOrderItems().stream().map(item -> {\n                    OrderItemVo orderItemVo = new OrderItemVo();\n                    //è®¢å•å·²ç»ä¿å­˜äº†ï¼Œå¯ä»¥ç›´æ¥è®¾ç½®\n                    orderItemVo.setSkuId(item.getSkuId());\n                    orderItemVo.setCount(item.getSkuQuantity());\n                    orderItemVo.setTitle(item.getSkuName());\n                    return orderItemVo;\n                }).collect(Collectors.toList());\n                //é”å®šè®¢å•é¡¹æ•°æ®\n                lockVo.setLocks(locks);\n                //todo 4ã€è¿œç¨‹é”åº“å­˜\n                //åº“å­˜é”å®šæˆåŠŸäº†ï¼Œä½†æ˜¯ç½‘ç»œåŸå› è¶…æ—¶äº†ï¼Œè®¢å•å›æ»šï¼Œåº“å­˜ä¸å›æ»š\n                //ä¸ºäº†ä¿è¯é«˜å¹¶å‘ï¼Œåº“å­˜æœåŠ¡è‡ªå·±å›æ»šï¼Œå¯ä»¥å‘æ¶ˆæ¯ç»™åº“å­˜æœåŠ¡\n                //åº“å­˜æœåŠ¡æœ¬èº«ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªåŠ¨è§£é”æ¨¡å¼->æ¶ˆæ¯é˜Ÿåˆ—\n                R r = wmsFeignService.orderLockStock(lockVo);\n                //åˆ¤æ–­è¿œç¨‹è°ƒç”¨æ˜¯å¦æˆåŠŸ\n                if (r.getCode() == 0){\n                    //è¿œç¨‹è°ƒç”¨æˆåŠŸï¼Œé”æˆåŠŸäº†\n                    responseVo.setOrder(order.getOrder());\n //todo 5ã€è¿œç¨‹æ‰£å‡ç§¯åˆ†  å‡ºå¼‚å¸¸ å¼•å…¥seataåä¸šåŠ¡æ ‡æ³¨@GlobalTransactionalè®¢å•å›æ»šï¼Œåº“å­˜å›æ»š\n\t\t\t\t\t// int i = 10/0;//ä¸æ ‡æ³¨@GlobalTransactional è®¢å•å›æ»šï¼Œåº“å­˜ä¸å›æ»š\n                    //todo è®¢å•åˆ›å»ºæˆåŠŸå‘é€æ¶ˆæ¯ç»™MQ\n                    rabbitTemplate.convertAndSend(\"order-event-exchange\", \"order.create.order\", order.getOrder());\n                    return responseVo;\n                }else {\n                    //è¿œç¨‹è°ƒç”¨å¤±è´¥ï¼Œé”å®šå¤±è´¥\n                    //é”å®šå¤±è´¥\n                    String msg = (String) r.get(\"msg\");\n                    //æŠ›å‡ºå¼‚å¸¸å°±ä¸èƒ½è®¾ç½®é”™è¯¯çŠ¶æ€ç äº†\n                    throw new NoStockException(msg);\n//                    responseVo.setCode(3);\n//                    return responseVo;\n                }\n            }else {\n                //æ ¡éªŒå¤±è´¥\n                responseVo.setCode(2);\n                return responseVo;\n            }\n        }\n    }\n```\n\n- `com.klaus.gulimall.order.service.impl.OrderServiceImpl#createOrder`\n\n```java\n/**\n     * åˆ›å»ºè®¢å•èšåˆæ–¹æ³•ï¼Œå«æ„å»ºè®¢å•å’Œæ‰€æœ‰è®¢å•é¡¹\n     * @return\n     */\n    private OrderCreateTo createOrder() {\n        //è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯\n        MemberRespVo memberRespVo = LoginUserInterceptor.loginUser.get();\n        OrderCreateTo createTo = new OrderCreateTo();\n        //1ã€todo ç”Ÿæˆè®¢å•å·(ä½¿ç”¨é›ªèŠ±ç®—æ³•æ ¹æ®ç”¨æˆ·idåˆ›å»ºè®¢å•å·)\n//        String orderSn = IdWorker.getTimeId();\n        String orderSn = SnowflakeIdUtil.nextIdStrByService(memberRespVo.getId().toString());\n        //åˆ›å»ºè®¢å•\n        OrderEntity orderEntity = buildOrder(orderSn);\n        //2ã€è·å–åˆ°æ‰€æœ‰çš„è®¢å•é¡¹\n        List<OrderItemEntity> itemEntities = buildOrderItems(orderSn);\n        //3ã€éªŒä»·ï¼Œè®¡ç®—ä»·æ ¼ã€ç§¯åˆ†ç­‰ç›¸å…³\n        computePrice(orderEntity, itemEntities);\n//        createTo.setOrderItems(itemEntities);\n//        createTo.setOrder(orderEntity);\n        // æ„å»ºè®¢å•èšåˆæ ¹\n        OrderCreateTo order = createTo.builder()\n                .order(orderEntity)\n                .orderItems(itemEntities)\n                .fare(orderEntity.getFreightAmount())\n                .payPrice(orderEntity.getPayAmount())\n                .build();\n\n        return order;\n    }\n```\n\n![mall](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131446123.png)\n\n- æ”¯ä»˜æœåŠ¡ï¼Œæä¾›æ”¯ä»˜å®ã€å¾®ä¿¡ã€é“¶è¡Œå¡ç­‰æ”¯ä»˜æ–¹å¼ï¼Œæ”¯æŒæ”¯ä»˜æŸ¥è¯¢ä»¥åŠé€€æ¬¾ç­‰åŠŸèƒ½ã€‚\n\n\n- ###### **é…ç½®é¡¹ä¿®æ”¹**\n\nè¯¦æƒ…è§ **æ”¯ä»˜å®æ²™ç®±å¯¹æ¥** ä¸­éœ€è¦ä¿®æ”¹é…ç½®é¡¹ã€‚\n\n> - ###### **æ ¸å¿ƒæµç¨‹**\n>\n> **æ ¸å¿ƒæµç¨‹(åˆšæœå•†åŸé¡¹ç›®å‚è€ƒ)ï¼š**\n>\n> 1ï¼‰é€šè¿‡ç­–ç•¥æ¨¡å¼å°è£…æ”¯ä»˜æ¸ é“å’Œæ”¯ä»˜åœºæ™¯ï¼Œç”¨æˆ·æ”¯ä»˜æ—¶åŠ¨æ€é€‰æ‹©å¯¹åº”çš„æ”¯ä»˜ç»„ä»¶ã€‚\n>\n> - ä»£ç åœ°å€ï¼š`org.opengoofy.congomall.biz.pay.application.service.impl.PayServiceImpl#commonPay`\n>\n> 2ï¼‰é€šè¿‡ç­–ç•¥æ¨¡å¼å°è£…æ”¯ä»˜å›è°ƒåœºæ™¯ï¼Œä¸‰æ–¹æ”¯ä»˜å¹³å°å›è°ƒæ—¶åŠ¨æ€é€‰æ‹©å¯¹åº”çš„æ”¯ä»˜å›è°ƒç»„ä»¶ã€‚\n>\n> - ä»£ç åœ°å€ï¼š`org.opengoofy.congomall.biz.pay.application.service.impl.PayServiceImpl#callback`\n\n- ###### æ”¯ä»˜å®æ²™ç®±å¯¹æ¥\n\né¡¹ç›®ä¸­å·²å¯¹æ¥æ”¯ä»˜å®æ²™ç®±ç¯å¢ƒï¼Œä»¥ä¸‹ä»‹ç»å¦‚ä½•å¯¹æ¥æ”¯ä»˜å®æ²™ç®±ã€‚\n\n- 1. **æ³¨å†Œè´¦å·**\n\næ³¨å†Œæ”¯ä»˜å®å¼€å‘è€…è´¦æˆ·ï¼Œè¿›å…¥å¼€å‘è€…æ§åˆ¶å°ã€‚\n\n[https://openhome.alipay.com/platform/developerIndex.htmopen in new window](https://openhome.alipay.com/platform/developerIndex.htm)\n\nç›´æ¥è¿›å…¥æ²™ç®±ç¯å¢ƒåœ°å€ã€‚\n\n[https://open.alipay.com/develop/sandbox/appopen in new window](https://open.alipay.com/develop/sandbox/app)\n\næ²™ç®±åº”ç”¨é¡µé¢å¦‚ä¸‹ï¼š\n\n![mall](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1674111619522-82229cf7-482d-4a4e-81bd-637c55c3d6a9.png)\n\n- 2. **è·å–æ”¯ä»˜å‚æ•°**\n\næ‹¿åˆ° APPID æ›¿æ¢ `application.properties` æ–‡ä»¶ä¸­ `alipay.app-id`ã€‚\n\n![mall](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1674111838001-9ff075ce-e324-43a6-a6b6-e3d860970e6a.png)\n\nä¸ºäº†å›¾æ–¹ä¾¿ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨æ”¯ä»˜å®è‡ªå®šä¹‰å…¬é’¥å’Œç§é’¥ã€‚\n\næˆ‘è¿™é‡Œæ˜¯å·²ç»å¼€å¯è¿‡çš„ï¼Œæ‰€ä»¥å¯ç”¨æŒ‰é’®æ˜¯ç½®ç°çš„ã€‚ç¬¬ä¸€æ¬¡ä½¿ç”¨åº”è¯¥æ˜¯è“è‰²å¯ç‚¹å‡»çš„çŠ¶æ€ã€‚\n\n![mall](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1674112006561-4be2d9d4-ef90-4c49-aee6-1f6f6a988f2d.png)\n\nå¤åˆ¶æ”¯ä»˜å®å…¬é’¥æ›¿æ¢ `application.properties` æ–‡ä»¶ä¸­ `alipay.alipay_public_key`ã€‚\n\nå¤åˆ¶åº”ç”¨ç§é’¥æ›¿æ¢ `application.properties` æ–‡ä»¶ä¸­ `alipay.private_key`ã€‚\n\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1674112099708-2d1a70a2-6af5-4502-8192-f6bb587b302f.png)\n\nè‡³æ­¤ï¼Œå°±å¯ä»¥è°ƒç”¨æ”¯ä»˜æ¥å£è¿›è¡Œæ”¯ä»˜å®æ”¯ä»˜åŠŸèƒ½äº†ã€‚\n\n- 3. **è°ƒç”¨æ”¯ä»˜å®æ¥å£**\n\nè®¿é—®æ”¯ä»˜æœåŠ¡ APIï¼Œè°ƒç”¨æ”¯ä»˜å®æ”¯ä»˜æ¥å£ã€‚\n\nè°ƒç”¨æ”¯ä»˜æ¥å£`http://order.gulimall.com/payOrder?orderSn=202304031500558581642784227126714369`åï¼Œæ–°åˆ›å»º `pay.html` ç©ºæ–‡ä»¶ï¼Œå¤åˆ¶æ§åˆ¶å°æ—¥å¿—ä¸­å‰ç«¯æ–‡ä»¶ä»£ç åˆ° `pay.html`ã€‚\n\n- `com.klaus.gulimall.order.service.impl.OrderServiceImpl#getOrderPay`\n\n```java\n/**\n * è·å–å½“å‰è®¢å•çš„æ”¯ä»˜ä¿¡æ¯\n * @param orderSn\n * @return\n */\n@Override\npublic PayVo getOrderPay(String orderSn) {\n    PayVo payVo = new PayVo();\n    OrderEntity entity = this.getOrderByOrderSn(orderSn);\n\n    //ä¿ç•™2ä½å°æ•°ï¼Œæœ‰å°æ•°å°±æƒ³ä¸Šå–å€¼\n    BigDecimal bigDecimal = entity.getTotalAmount().setScale(2, BigDecimal.ROUND_UP);\n    payVo.setTotal_amount(bigDecimal.toString());\n    payVo.setOut_trade_no(entity.getOrderSn());\n\n    List<OrderItemEntity> itemEntities = orderItemService.list(new QueryWrapper<OrderItemEntity>().eq(\"order_sn\", orderSn));\n    OrderItemEntity item = itemEntities.get(0);\n    payVo.setSubject(item.getSkuName());\n    payVo.setBody(item.getSkuAttrsVals());\n\n    return payVo;\n}\n```\n\n- `com.klaus.gulimall.order.web.PayWebController#payOrder`\n\n```java\n /**\n     * 1ã€å°†æ”¯ä»˜é¡µè®©æµè§ˆå™¨å±•ç¤º\n     * 2ã€æ”¯ä»˜æˆåŠŸä»¥åï¼Œæˆ‘ä»¬è¦è·³åˆ°ç”¨æˆ·çš„è®¢å•åˆ—è¡¨é¡µ\n     * @param orderSn\n     * @return\n     * @throws AlipayApiException\n     */\n    @ResponseBody\n    @GetMapping(value = \"/payOrder\", produces = \"text/html\")\n    public String payOrder(@RequestParam(\"orderSn\") String orderSn) throws AlipayApiException {\n\n\n        PayVo payVo = orderService.getOrderPay(orderSn);\n        //è¿”å›çš„æ˜¯ä¸€ä¸ªé¡µé¢ï¼Œå°†æ­¤é¡µé¢ç›´æ¥äº¤ç»™æµè§ˆå™¨å°±è¡Œ\n        String pay = alipayTemplate.pay(payVo);\n//        System.out.println(pay);\n        return pay;\n    }\n```\n\n- `com.klaus.gulimall.order.config.AlipayTemplate#pay`\n\n```java\npublic  String pay(PayVo vo) throws AlipayApiException {\n\n    //AlipayClient alipayClient = new DefaultAlipayClient(AlipayTemplate.gatewayUrl, AlipayTemplate.app_id, AlipayTemplate.merchant_private_key, \"json\", AlipayTemplate.charset, AlipayTemplate.alipay_public_key, AlipayTemplate.sign_type);\n    //1ã€æ ¹æ®æ”¯ä»˜å®çš„é…ç½®ç”Ÿæˆä¸€ä¸ªæ”¯ä»˜å®¢æˆ·ç«¯\n    AlipayClient alipayClient = new DefaultAlipayClient(gatewayUrl,\n            app_id, merchant_private_key, \"json\",\n            charset, alipay_public_key, sign_type);\n\n    //2ã€åˆ›å»ºä¸€ä¸ªæ”¯ä»˜è¯·æ±‚ //è®¾ç½®è¯·æ±‚å‚æ•°\n    AlipayTradePagePayRequest alipayRequest = new AlipayTradePagePayRequest();\n    alipayRequest.setReturnUrl(return_url);\n    alipayRequest.setNotifyUrl(notify_url);\n\n    //å•†æˆ·è®¢å•å·ï¼Œå•†æˆ·ç½‘ç«™è®¢å•ç³»ç»Ÿä¸­å”¯ä¸€è®¢å•å·ï¼Œå¿…å¡«\n    String out_trade_no = vo.getOut_trade_no();\n    //ä»˜æ¬¾é‡‘é¢ï¼Œå¿…å¡«\n    String total_amount = vo.getTotal_amount();\n    //è®¢å•åç§°ï¼Œå¿…å¡«\n    String subject = vo.getSubject();\n    //å•†å“æè¿°ï¼Œå¯ç©º\n    String body = vo.getBody();\n\n    alipayRequest.setBizContent(\"{\\\"out_trade_no\\\":\\\"\"+ out_trade_no +\"\\\",\"\n            + \"\\\"total_amount\\\":\\\"\"+ total_amount +\"\\\",\"\n            + \"\\\"subject\\\":\\\"\"+ subject +\"\\\",\"\n            + \"\\\"body\\\":\\\"\"+ body +\"\\\",\"\n            + \"\\\"timeout_express\\\":\\\"\"+timeout+\"\\\",\"\n            + \"\\\"product_code\\\":\\\"FAST_INSTANT_TRADE_PAY\\\"}\");\n\n    String result = alipayClient.pageExecute(alipayRequest).getBody();\n\n    //ä¼šæ”¶åˆ°æ”¯ä»˜å®çš„å“åº”ï¼Œå“åº”çš„æ˜¯ä¸€ä¸ªé¡µé¢ï¼Œåªè¦æµè§ˆå™¨æ˜¾ç¤ºè¿™ä¸ªé¡µé¢ï¼Œå°±ä¼šè‡ªåŠ¨æ¥åˆ°æ”¯ä»˜å®çš„æ”¶é“¶å°é¡µé¢\n    System.out.println(\"æ”¯ä»˜å®çš„å“åº”ï¼š\"+result);\n\n    return result;\n\n}\n```\n\n![image](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403152134343.png)\n\né€šè¿‡è°·æ­Œæµè§ˆå™¨æ‰“å¼€ `pay.html`å³å¯ï¼Œçœ‹åˆ°ä»¥ä¸‹é¡µé¢å³ä¸ºæ­£å¸¸ç°è±¡ã€‚\n\n![image-20230403131612455](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131612455.png)\n\nè´¦æˆ·åå’Œæ”¯ä»˜å¯†ç ä»æ²™ç®±è´¦å·å¤„å¤åˆ¶ä¹°æ–¹ä¿¡æ¯ã€‚å¦‚æœä¹°æ–¹è´¦æˆ·ä½™é¢ä¸º 0ï¼Œå¯éšæ„å……å€¼é‡‘é¢ã€‚\n\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1674195718913-2cf0d08a-1bc0-4303-aef5-df51a662fadf.png)\n\nä½¿ç”¨è´¦æˆ·ä½™é¢æ”¯ä»˜å³å¯ã€‚\n\n![image-20230403131639507](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131639507.png)\n\næ”¯ä»˜ç»“æœæ˜¾ç¤ºæˆåŠŸã€‚\n\n![image-20230403131649890](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131649890.png)\n\n- 4. **æ”¯ä»˜ç»“æœå›è°ƒ**\n\nå¦‚æœå¸Œæœ›åœ¨æ²™ç®±ç¯å¢ƒä¸­å¾—çŸ¥å…·ä½“æ”¯ä»˜ç»“æœï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ Natapp å¼€é€šå†…ç½‘ç©¿é€ï¼Œå¼€é€šæ•™ç¨‹è¯¦ç»†æŸ¥çœ‹ä¸‹è¿°å®˜æ–¹æ–‡æ¡£ï¼š\n\n[https://natapp.cn/article/natapp_newbieopen in new window](https://natapp.cn/article/natapp_newbie)\n\nå¼€é€šåï¼Œå°†å†…ç½‘ç©¿é€ç«¯å£ä¸º 80ï¼Œæœ¬åœ°åœ°å€æ”¹ä¸ºè™šæ‹Ÿæœºæ˜ å°„æœ¬åœ°hostçš„åœ°å€(192.168.10.103=>order.gulimall.com)å³æ”¯ä»˜æœåŠ¡é¡¹ç›®ç«¯å£ã€‚\n\n![image-20230403152749004](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403152749004.png)\n\nå°† Natapp å†…ç½‘ç©¿é€åœ°å€æ›¿æ¢ `application.properties` æ–‡ä»¶ä¸‹ `alipay.notify_url` å±æ€§ã€‚\n\nå†é‡å¤è°ƒç”¨ä¸‹æ”¯ä»˜å®æ”¯ä»˜æ¥å£æµç¨‹ï¼Œå³å¯çœ‹åˆ°å›è°ƒæ•ˆæœã€‚\n\n- é…ç½®ä»¥ä¸Šå†…ç½‘ç©¿é€é…ç½®æ‰èƒ½å®Œæˆè®¢å•æ”¯ä»˜ï¼Œå¦åˆ™è®¢å•æ”¯ä»˜å¤±è´¥ï¼Œè®¢å•è‡ªåŠ¨å–æ¶ˆï¼Œåº“å­˜è‡ªåŠ¨è§£é”\n\n```properties\n#å¼‚æ­¥é€šçŸ¥ï¼šæ”¯ä»˜å®ä¼šæ‚„æ‚„çš„ç»™æˆ‘ä»¬å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå‘Šè¯‰æˆ‘ä»¬æ”¯ä»˜æˆåŠŸçš„ä¿¡æ¯\nalipay.notify_url=http://mqbb4a.natappfree.cc/paid/notify\n```\n\n![image-20230403131656175](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131656175.png)\n\n- `com.klaus.gulimall.order.service.impl.OrderServiceImpl#handlePayResult`\n\n\n```java\n/**\n     * å¤„ç†æ”¯ä»˜å®çš„æ”¯ä»˜ç»“æœ\n     * @param vo\n     * @return\n     */\n    @Override\n    public String handlePayResult(PayAsyncVo vo) {\n        //1ã€ä¿å­˜äº¤æ˜“æµæ°´\n        PaymentInfoEntity infoEntity = new PaymentInfoEntity();\n        infoEntity.setAlipayTradeNo(vo.getTrade_no());\n        infoEntity.setOrderSn(vo.getOut_trade_no());\n        infoEntity.setPaymentStatus(vo.getTrade_status());\n        infoEntity.setCallbackTime(vo.getNotify_time());\n\n        paymentInfoService.save(infoEntity);\n\n        //2ã€ä¿®æ”¹è®¢å•çš„çŠ¶æ€ä¿¡æ¯\n        if (vo.getTrade_status().equals(\"TRADE_SUCCESS\") || vo.getTrade_status().equals(\"TRADE_FINISHED\")){\n            //æ”¯ä»˜æˆåŠŸçŠ¶æ€\n            String outTradeNo = vo.getOut_trade_no();\n            this.baseMapper.updateOrderStatus(outTradeNo, OrderStatusEnum.PAYED.getCode());\n        }\n\n        return \"success\";\n    }\n```\n\n- `com.klaus.gulimall.order.listener.OrderPaidListener#handleAlipaid`\n\n```java\n /**\n     * æ”¯ä»˜æˆåŠŸå¼‚æ­¥é€šçŸ¥\n     * @param vo\n     * @param request\n     * @return\n     */\n    @PostMapping(\"/paid/notify\")\n    public String handleAlipaid(PayAsyncVo vo, HttpServletRequest request) throws Exception {\n\n        //åªè¦æˆ‘ä»¬æ”¶åˆ°äº†æ”¯ä»˜å®ç»™æˆ‘ä»¬å¼‚æ­¥çš„é€šçŸ¥ï¼Œå‘Šè¯‰æˆ‘ä»¬è®¢å•æ”¯ä»˜æˆåŠŸï¼Œè¿”å›successï¼Œæ”¯ä»˜å®å°±å†ä¹Ÿä¸é€šçŸ¥\n//        Map<String, String[]> map = request.getParameterMap();\n//        for (String key : map.keySet()) {\n//            String value = request.getParameter(key);\n//            System.out.println(\"å‚æ•°åï¼š\"+key+\"==>å‚æ•°å€¼ï¼š\"+ value);\n//        }\n//        System.out.println(\"æ”¯ä»˜å®é€šçŸ¥åˆ°ä½äº†...æ•°æ®ï¼š\"+map);\n        //éªŒç­¾\n        Map<String,String> params = new HashMap<String,String>();\n        Map<String,String[]> requestParams = request.getParameterMap();\n        for (Iterator<String> iter = requestParams.keySet().iterator(); iter.hasNext();) {\n            String name = (String) iter.next();\n            String[] values = (String[]) requestParams.get(name);\n            String valueStr = \"\";\n            for (int i = 0; i < values.length; i++) {\n                valueStr = (i == values.length - 1) ? valueStr + values[i]\n                        : valueStr + values[i] + \",\";\n            }\n            //ä¹±ç è§£å†³ï¼Œè¿™æ®µä»£ç åœ¨å‡ºç°ä¹±ç æ—¶ä½¿ç”¨\n//            valueStr = new String(valueStr.getBytes(\"ISO-8859-1\"), \"utf-8\");\n            params.put(name, valueStr);\n        }\n\n        boolean signVerified = AlipaySignature.rsaCheckV1(params, alipayTemplate.getAlipay_public_key(), alipayTemplate.getCharset(), alipayTemplate.getSign_type()); //\n        if (signVerified){\n            //éªŒç­¾æˆåŠŸ\n            System.out.println(\"ç­¾åéªŒè¯æˆåŠŸ.....\");\n            String result = orderService.handlePayResult(vo);\n            return result;\n        }else {\n            System.out.println(\"ç­¾åéªŒè¯å¤±è´¥.....\");\n            return \"error\";\n        }\n    }\n```\n\né¡µé¢è·³è½¬åŒæ­¥é€šçŸ¥é¡µé¢è·¯å¾„ éœ€`http://`æ ¼å¼çš„å®Œæ•´è·¯å¾„ï¼Œä¸èƒ½åŠ ?id=123è¿™ç±»è‡ªå®šä¹‰å‚æ•°ï¼Œå¿…é¡»å¤–ç½‘å¯ä»¥æ­£å¸¸è®¿é—®ï¼›è®¢å•æ”¯ä»˜å®ŒæˆæˆåŠŸè¿”å›ä»¥ä¸‹é¡µé¢(åŒæ­¥é€šçŸ¥ï¼Œæ”¯ä»˜æˆåŠŸï¼Œä¸€èˆ¬è·³è½¬åˆ°æˆåŠŸé¡µ)ï¼š\n\n```java\nprivate  String return_url = \"http://member.gulimall.com/memberOrder.html\";\n```\n\n- `com.klaus.gulimall.member.Web.MemberWebController#memberOrderPage`\n\n```java\n@GetMapping(\"/memberOrder.html\")\npublic String memberOrderPage(@RequestParam(value = \"pageNum\", defaultValue = \"1\") Integer pageNum,\n                              Model model) {\n\n    //æŸ¥å‡ºå½“å‰ç™»å½•çš„ç”¨æˆ·çš„æ‰€æœ‰è®¢å•åˆ—è¡¨æ•°æ®\n    Map<String, Object> page = new HashMap<>();\n    page.put(\"page\", pageNum.toString());\n    R r = orderFeignService.listWithItem(page);\n    System.out.println(JSON.toJSONString(r));\n    model.addAttribute(\"orders\", r);\n\n    return \"orderList\";\n}\n```\n\n- è¿œç¨‹è°ƒç”¨è®¢å•æœåŠ¡æŸ¥å‡ºå½“å‰ç™»å½•çš„ç”¨æˆ·çš„æ‰€æœ‰è®¢å•åˆ—è¡¨æ•°æ®\n- `com.klaus.gulimall.order.controller.OrderController#listWithItem`\n\n```java\n/**\n * todo è¿œç¨‹è°ƒç”¨éƒ½è¦å…¨ç”¨@POSTMapping+@RequestBody(è¯·æ±‚ä½“åªæ”¯æŒpost)\n * åˆ†é¡µæŸ¥è¯¢å½“å‰ç™»å½•ç”¨æˆ·çš„æ‰€æœ‰è®¢å•\n * @param params\n * @return\n */\n@PostMapping(\"/listWithItem\")\n//@RequiresPermissions(\"order:order:list\")\npublic R listWithItem(@RequestBody Map<String, Object> params){\n    PageUtils page = orderService.queryPageWithItem(params);\n\n    return R.ok().put(\"page\", page);\n}\n```\n\n- `com.klaus.gulimall.order.service.impl.OrderServiceImpl#queryPageWithItem`\n\n```java\n@Override\npublic PageUtils queryPageWithItem(Map<String, Object> params) {\n    //è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯\n    MemberRespVo memberRespVo = LoginUserInterceptor.loginUser.get();\n\n    IPage<OrderEntity> page = this.page(\n            new Query<OrderEntity>().getPage(params),                                            //æ ¹æ®idé™åº\n            new QueryWrapper<OrderEntity>().eq(\"member_id\", memberRespVo.getId()).orderByDesc(\"id\")\n    );\n\n    List<OrderEntity> orderEntities = page.getRecords().stream().map(order -> {\n        //å°è£…è®¢å•é¡¹åˆ°è®¢å•\n        List<OrderItemEntity> itemEntities = orderItemService.list(new QueryWrapper<OrderItemEntity>().eq(\"order_sn\", order.getOrderSn()));\n        order.setItemEntities(itemEntities);\n        return order;\n    }).collect(Collectors.toList());\n\n    page.setRecords(orderEntities);\n\n    return new PageUtils(page);\n}\n```\n\n![image-20230403131702203](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131702203.png)\n\n\n\n\n\n\n\n##### 2.è®¢å•åˆ›å»ºå‰éœ€è¦é¢„è§ˆè®¢å•ï¼Œé€‰æ‹©æ”¶è´§ä¿¡æ¯ç­‰\n\n`http://cart.gulimall.com/cart.html`\n\n![image-20230403130248691](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403130248691.png)\n\n`http://order.gulimall.com/toTrade`\n\n- `com.klaus.gulimall.order.web.OrderWebController#toTrade`\n\n```java\n/**\n     * OrderConfirmVo = [List<MemberAddressVo> address, //æ”¶è´§åœ°å€ï¼Œ \n     *                  List<OrderItemVo> items,      //æ‰€æœ‰é€‰ä¸­çš„è´­ç‰©é¡¹\n     *                 Integer integration,         //ç§¯åˆ†...\n     *                 Map<Long, Boolean> stocks, //åº“å­˜ä¿¡æ¯\n     *                 String orderToken        //é˜²é‡ä»¤ç‰Œ]\n*/\n@GetMapping(\"/toTrade\")\npublic String toTrade(Model model, HttpServletRequest request) throws ExecutionException, InterruptedException {\n    OrderConfirmVo confirmVo = orderService.confirmOrder();\n    model.addAttribute(\"orderConfirmData\", confirmVo);\n    //å±•ç¤ºè®¢å•ç¡®è®¤çš„æ•°æ®(é¡µé¢è·³è½¬)\n    return \"confirm\";\n}\n```\n\n- `com.klaus.gulimall.order.service.impl.OrderServiceImpl#confirmOrder`\n\n- > **æ³¨**ï¼šä½¿ç”¨å¼‚æ­¥ç¼–æ’æ—¶ç”¨åˆ°è¿œç¨‹è°ƒç”¨ï¼Œå¦‚æœä¸è¿›è¡Œè¯·æ±‚ä¸Šä¸‹æ–‡å…±äº«å°†é€ æˆFeignå¼‚æ­¥æƒ…å†µä¸¢å¤±ä¸Šä¸‹æ–‡é—®é¢˜\n\n```java\n/**\n * è®¢å•ç¡®è®¤é¡µè¿”å›éœ€è¦ç”¨åˆ°çš„æ•°æ®\n * @return\n */\n@Override\npublic OrderConfirmVo confirmOrder() throws ExecutionException, InterruptedException {\n    OrderConfirmVo confirmVo = new OrderConfirmVo();\n    //ä»æ‹¦æˆªå™¨é‡Œè·å–ç”¨æˆ·ä¿¡æ¯\n    MemberRespVo memberRespVo = LoginUserInterceptor.loginUser.get();\n    System.out.println(\"ä¸»çº¿ç¨‹....\" + Thread.currentThread().getId());\n\n    //è·å–åŸæ¥è¯·æ±‚ä¸Šä¸‹æ–‡è¯·æ±‚å±æ€§\n    RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();\n    //è¿›è¡Œå¼‚æ­¥ç¼–æ’\n    CompletableFuture<Void> getAddressFuture = CompletableFuture.runAsync(() -> {\n        //1ã€è¿œç¨‹æŸ¥è¯¢æ‰€æœ‰çš„æ”¶è´§åœ°å€åˆ—è¡¨\n        System.out.println(\"memberçº¿ç¨‹....\" + Thread.currentThread().getId());\n        //åœ¨Feignå¼‚æ­¥è°ƒç”¨å‰å°†è¯·æ±‚ä¸Šä¸‹æ–‡è¿›è¡Œå…±äº«æ“ä½œ(ä¹‹å‰çš„è¯·æ±‚æ•°æ®éƒ½æ¥å…±äº«æ¯ä¸€ä¸ªçº¿ç¨‹)\n        RequestContextHolder.setRequestAttributes(requestAttributes);\n        List<MemberAddressVo> address = memberFeignService.getAddress(memberRespVo.getId());\n        confirmVo.setAddress(address);\n    }, executor);\n\n    CompletableFuture<Void> cartFuture = CompletableFuture.runAsync(() -> {\n        //2ã€è¿œç¨‹æŸ¥è¯¢è´­ç‰©è½¦æ‰€æœ‰é€‰ä¸­çš„è´­ç‰©é¡¹\n        System.out.println(\"cartçº¿ç¨‹....\" + Thread.currentThread().getId());\n        //åœ¨Feignå¼‚æ­¥è°ƒç”¨å‰å°†è¯·æ±‚ä¸Šä¸‹æ–‡è¿›è¡Œå…±äº«æ“ä½œ\n        RequestContextHolder.setRequestAttributes(requestAttributes);\n        List<OrderItemVo> items = cartFeignService.currentUserCartItems();\n        confirmVo.setItems(items);\n        //feignåœ¨è¿œç¨‹è°ƒç”¨ä¹‹å‰è¦æ„é€ è¯·æ±‚ï¼Œè°ƒç”¨å¾ˆå¤šçš„æ‹¦æˆªå™¨\n        //for(RequestInterceptor interceptor:requestInterceptors)\n    }, executor).thenRunAsync(() -> {\n        List<OrderItemVo> items = confirmVo.getItems();\n        List<Long> skuIds = items.stream().map(item -> item.getSkuId()).collect(Collectors.toList());\n        //è¿œç¨‹æŸ¥è¯¢åº“å­˜\n        R r = wmsFeignService.getSkusHasStock(skuIds);\n        List<SkuStockVo> data = r.getData(new TypeReference<List<SkuStockVo>>() {\n        });\n        if (data != null) {\n            // Map<SkuId, hasStock> map\n            Map<Long, Boolean> map = data.stream().collect(Collectors.toMap(SkuStockVo::getSkuId, SkuStockVo::getHasStock));\n            // Map<Long, Boolean> stocks;\n            confirmVo.setStocks(map);\n        }\n    }, executor);\n\n    //3ã€æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†\n    Integer integration = memberRespVo.getIntegration();\n    confirmVo.setIntegration(integration);\n\n    //4ã€å…¶ä»–æ•°æ®è‡ªåŠ¨è®¡ç®—\n\n    //todo 5ã€é˜²é‡ä»¤ç‰Œ\n    String token = UUID.randomUUID().toString().replace(\"-\", \"\");\n    //ç»™æœåŠ¡å™¨ä¸€ä¸ªä»¤ç‰Œ\n    redisTemplate.opsForValue().set(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberRespVo.getId(), token, 30, TimeUnit.MINUTES);\n    //ç»™é¡µé¢ä¸€ä¸ªä»¤ç‰Œ\n    confirmVo.setOrderToken(token);\n    CompletableFuture.allOf(getAddressFuture, cartFuture).get();\n    return confirmVo;\n}\n```\n\n![image-20230403130554589](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403130554589.png)\n\n![image-20230416234636426](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230416234636426.png)\n\n\n\n##### 3.è®¢å•åˆ›å»ºéœ€è¦é”å®šåº“å­˜ï¼Œåº“å­˜æœ‰æ‰å¯åˆ›å»ºï¼Œå¦åˆ™ä¸èƒ½åˆ›å»º\n\n- æŸ¥è¯¢skuæ˜¯å¦æœ‰åº“å­˜\n- `com.klaus.gulimall.ware.controller.WareSkuController#getSkusHasStock`\n\n```java\n//æŸ¥è¯¢skuæ˜¯å¦æœ‰åº“å­˜\n    @PostMapping(\"/hasstock\")\n    public R getSkusHasStock(@RequestBody List<Long> skuIds) {\n        //sku_id stock\n        List<SkuHasStockVo> vos = wareSkuService.getSkusHasStock(skuIds);\n        return R.ok().setData(vos);\n    }\n```\n\n- `com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#getSkusHasStock`\n\n```java\n@Override\npublic List<SkuHasStockVo> getSkusHasStock(List<Long> skuIds) {\n\n    List<SkuHasStockVo> collect = skuIds.stream().map(skuId -> {\n        SkuHasStockVo vo = new SkuHasStockVo();\n        //æŸ¥è¯¢å½“å‰skuçš„æ€»åº“å­˜é‡\n        //SELECT SUM(stock-stock_locked) FROM `wms_ware_sku` WHERE sku_id=1\n        //è·å–æŸ¥è¯¢åˆ°çš„åº“å­˜è®°å½•æ•°\n        Long count = baseMapper.getSkuStock(skuId);\n        vo.setSkuId(skuId);\n        //è®°å½•æ•°å¤§äº0è¡¨ç¤ºæœ‰åº“å­˜\n        vo.setHasStock(count == null ? false : count > 0);\n        return vo;\n    }).collect(Collectors.toList());\n    return collect;\n}\n```\n\n- SQL\n\n```xml\n<select id=\"getSkuStock\" resultType=\"java.lang.Long\">\n    SELECT SUM(stock-stock_locked) FROM `wms_ware_sku` WHERE sku_id=#{skuId}\n</select>\n```\n\n![image-20230404010335539](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404010335539.png)\n\n- åˆ›å»ºè®¢å•è¿›è¡Œåº“å­˜é”å®š\n- `com.klaus.gulimall.ware.controller.WareSkuController#orderLockStock`\n\n```java\n@RequestMapping(\"/lock/order\")\npublic R orderLockStock(@RequestBody WareSkuLockVo vo){\n    Boolean lockStock = null;\n    try {\n        lockStock = wareSkuService.orderLockStock(vo);\n        return R.ok();\n    } catch (NoStockException e) {\n        //é€šè¿‡æµ‹è¯•å‘ç°å•†å“åº“å­˜ä¸è¶³å°†ä¼šåœ¨é¡µé¢æ˜¾ç¤ºä»¥ä¸‹é”™è¯¯ä¿¡æ¯(http://order.gulimall.com/toTrade)\n        return R.error(BizCodeEnum.NO_STOCK_EXCEPTION.getCode(), BizCodeEnum.NO_STOCK_EXCEPTION.getMsg());\n    }\n}\n```\n\n- `com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#orderLockStock`\n\n```java\n/**\n * ä¸ºæŸä¸ªè®¢å•é”å®šåº“å­˜\n * åŠ å…¥ç»Ÿä¸€äº‹åŠ¡\n * (rollbackFor = NoStockException.class )\n * é»˜è®¤åªè¦æ˜¯è¿è¡Œæ—¶å¼‚å¸¸éƒ½ä¼šå›æ»š\n * åº“å­˜è§£é”çš„åœºæ™¯\n * 1ï¼‰ã€ä¸‹è®¢å•æˆåŠŸï¼Œè®¢å•è¿‡æœŸæ²¡æœ‰æ”¯ä»˜è¢«ç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆã€è¢«ç”¨æˆ·æ‰‹åŠ¨å–æ¶ˆï¼Œéƒ½è¦è§£é”åº“å­˜\n * 2ï¼‰ã€ä¸‹è®¢å•æˆåŠŸï¼Œåº“å­˜é”å®šæˆåŠŸï¼Œæ¥ä¸‹æ¥çš„ä¸šåŠ¡è°ƒç”¨å¤±è´¥ï¼Œå¯¼è‡´è®¢å•å›æ»š\n * ä¹‹å‰é”å®šçš„åº“å­˜å°±è¦è‡ªåŠ¨è§£é”\n * @param vo\n * @return\n */\n@Transactional\n@Override\npublic Boolean orderLockStock(WareSkuLockVo vo) {\n    /**\n     * ä¿å­˜åº“å­˜å·¥ä½œå•çš„è¯¦æƒ…çš„ä¸¤å¼ è¡¨\n     * è¿½æº¯\n     */\n    WareOrderTaskEntity taskEntity = new WareOrderTaskEntity();\n    taskEntity.setOrderSn(vo.getOrderSn());\n    wareOrderTaskService.save(taskEntity);\n    //æŒ‰ç…§ä¸‹å•çš„æ”¶è´§åœ°å€ï¼Œæ‰¾åˆ°ä¸€ä¸ªå°±è¿‘ä»“åº“ï¼Œé”å®šåº“å­˜\n    //1ã€æ‰¾åˆ°æ¯ä¸ªå•†å“åœ¨å“ªä¸ªä»“åº“éƒ½æœ‰åº“å­˜\n    List<OrderItemVo> locks = vo.getLocks();\n    List<SkuWareHasStock> collect = locks.stream().map(item -> {\n        SkuWareHasStock stock = new SkuWareHasStock();\n        Long skuId = item.getSkuId();\n        stock.setSkuId(skuId);\n        stock.setNum(item.getCount());\n        //æŸ¥è¯¢è¿™ä¸ªå•†å“åœ¨å“ªé‡Œæœ‰åº“å­˜\n        List<Long> wareIds = wareSkuDao.listWareIdHasSkuStock(skuId);\n        stock.setWareIds(wareIds);\n        return stock;\n    }).collect(Collectors.toList());\n    //2ã€é”å®šåº“å­˜\n    for (SkuWareHasStock hasStock : collect) {\n        Boolean skuStocked = false;//lock_status=0\n        Long skuId = hasStock.getSkuId();\n        List<Long> wareIds = hasStock.getWareIds();\n        if (wareIds == null || wareIds.size() == 0) {\n            //æ²¡æœ‰ä»»ä½•ä»“åº“æœ‰è¿™ä¸ªå•†å“çš„åº“å­˜\n            throw new NoStockException(skuId);\n        }\n        //1ã€å¦‚æœæ¯ä¸€ä¸ªå•†å“éƒ½é”å®šæˆåŠŸï¼Œå°†å½“å‰å•†å“é”å®šäº†å‡ ä»¶çš„å·¥ä½œå•è®°å½•å‘ç»™MQ\n        //2ã€é”å®šå¤±è´¥ã€‚å‰é¢ä¿å­˜çš„å·¥ä½œå•ä¿¡æ¯å°±å›æ»šäº†ï¼Œå³ä½¿è¦è§£é”è®°å½•ï¼Œç”±äºå»æ•°æ®åº“æŸ¥ä¸åˆ°idï¼Œæ‰€ä»¥å°±ä¸ç”¨è§£é”\n        //  log:skuId-num-ware: 1:1-2-1(v) 2:2-1-3(v) 3:3-1-1(x)\n        //  æ—¢ç„¶é”æˆåŠŸäº†å°±åº”è¯¥æ‰£å‡ï¼Œä¹‹åå°±åº”è¯¥è§£é”ï¼Œå› ä¸º3è®°å½•é”å¤±è´¥ï¼Œ1,2è®°å½•å°±å›æ»šäº†ï¼Œç›¸å½“äºå·¥ä½œå•å›æ»šäº†ï¼Œåº“å­˜æ²¡å›æ»šåº“å­˜æ‰£å‡\n        // åªä¼ idå·¥ä½œå•æ˜¯ä¸çŸ¥é“å½“æ—¶åº“å­˜é”äº†å¤šå°‘ä¸ª\n        for (Long wareId : wareIds) {\n            //æˆåŠŸå°±è¿”å›1ï¼Œå¦åˆ™å°±æ˜¯0\n            Long count = wareSkuDao.lockSkuStock(skuId, wareId, hasStock.getNum());\n            if (count == 1) {\n                //é”æˆåŠŸäº†==>lock_status=1\n                skuStocked = true;\n                //é€€å‡ºå½“å‰å¾ªç¯\n                //todo å‘Šè¯‰MQåº“å­˜é”å®šæˆåŠŸ\n                WareOrderTaskDetailEntity detailEntity = new WareOrderTaskDetailEntity(null, skuId, \"\", hasStock.getNum(), taskEntity.getId(), wareId, 1);\n                //ä¿å­˜å·¥ä½œå•è¯¦æƒ…\n                wareOrderTaskDetailService.save(detailEntity);\n                StockLockedTo lockedTo = new StockLockedTo();\n                //å±æ€§æ‹·è´åˆ°to\n                StockDetailTo stockDetailTo = new StockDetailTo();\n                BeanUtils.copyProperties(detailEntity, stockDetailTo);\n                //åªä¼ å·¥ä½œå•idè¿˜ä¸å¤Ÿï¼Œé˜²æ­¢å›æ»šä»¥åæ‰¾ä¸åˆ°æ•°æ®\n                lockedTo.setId(taskEntity.getId());\n                lockedTo.setDetailTo(stockDetailTo);\n                //å‘é€é”å®šåº“å­˜æ¶ˆæ¯ï¼›æäº¤è®¢å•åï¼Œå‡ºç°å¼‚å¸¸ï¼Œè®¢å•å›æ»šï¼Œåº“å­˜ä¸å›æ»šï¼Œå»¶æ—¶é˜Ÿåˆ—æœ‰2ä¸ªä»»åŠ¡ç­‰å¾…æ­»ä¿¡æ—¶é—´ç»“æŸåå‘é€æ¶ˆæ¯\n                rabbitTemplate.convertAndSend(\"stock-event-exchange\", \"stock.locked\", lockedTo);\n                break;\n            } else {\n                //å½“å‰ä»“åº“é”å¤±è´¥äº†ï¼Œé‡è¯•ä¸‹ä¸€ä¸ªä»“åº“\n            }\n        }\n        if (skuStocked == false) {\n            //å½“å‰å•†å“æ‰€æœ‰ä»“åº“éƒ½æ²¡æœ‰é”ä½\n            throw new NoStockException(skuId);\n        }\n    }\n    //3ã€è‚¯å®šå…¨éƒ¨éƒ½æ˜¯é”å®šæˆåŠŸè¿‡çš„\n    return true;\n}\n```\n\n- åº“å­˜å·¥ä½œå•è¡¨`wms_ware_order_task`\n\n![image-20230404012221654](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404012221654.png)\n\n- åº“å­˜å·¥ä½œå•è¯¦æƒ…`wms_ware_order_task_detail`\n- ![image-20230404012535232](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404012535232.png)\n\n![image-20230404012359140](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404012359140.png)\n\n```java\n//æŸ¥è¯¢è¿™ä¸ªå•†å“åœ¨å“ªé‡Œæœ‰åº“å­˜\n//com.klaus.gulimall.ware.dao.WareSkuDao#listWareIdHasSkuStock\nList<Long> wareIds = wareSkuDao.listWareIdHasSkuStock(skuId);\n```\n\n - SQL\n\n```xml\n<select id=\"listWareIdHasSkuStock\" resultType=\"java.lang.Long\">\n    SELECT ware_id FROM `wms_ware_sku` WHERE sku_id=#{skuId} AND stock-stock_locked >0\n</select>\n```\n\n![image-20230404013003956](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404013003956.png)\n\n```java\n//åº“å­˜é”å®šæˆåŠŸå°±è¿”å›1ï¼Œå¦åˆ™å°±æ˜¯0\n//com.klaus.gulimall.ware.dao.WareSkuDao#lockSkuStock\nLong count = wareSkuDao.lockSkuStock(skuId, wareId, hasStock.getNum());\n```\n\n- SQL\n\n```xml\n<update id=\"lockSkuStock\">\n    UPDATE `wms_ware_sku` SET stock_locked = stock_locked + #{num}\n    WHERE sku_id =#{skuId} AND ware_id=#{wareId} AND stock-stock_locked>=#{num}\n</update>\n```\n\n![image-20230404014111150](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404014111150.png)\n\n\n\n\n\n\n\n\n\n##### 4.è®¢å•åˆ›å»ºåè¶…æ—¶æœªæ”¯ä»˜éœ€è¦è§£é”åº“å­˜\n\n- åº“å­˜è§£é”åˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯è®¢å•æ­£å¸¸æ”¯ä»˜è¶…æ—¶åº“å­˜è‡ªåŠ¨è§£é”ï¼›ä¸€ç§æ˜¯è®¢å•æœåŠ¡å¼‚å¸¸/å®•æœºåº“å­˜è‡ªåŠ¨è§£é”\n\n- `com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.StockLockedTo)`\n\n```java\n/**\n * 1ã€åº“å­˜è‡ªåŠ¨è§£é”\n *      ä¸‹è®¢å•æˆåŠŸï¼Œåº“å­˜é”å®šæˆåŠŸï¼Œæ¥ä¸‹æ¥çš„ä¸šåŠ¡è°ƒç”¨å¤±è´¥ï¼Œå¯¼è‡´è®¢å•å›æ»šã€‚ä¹‹å‰é”å®šçš„åº“å­˜å°±è¦è‡ªåŠ¨è§£é”\n * 2ã€ä¸‹è®¢å•å¤±è´¥\n * é”åº“å­˜å¤±è´¥\n * åªè¦è§£é”åº“å­˜çš„æ¶ˆæ¯å¤±è´¥ï¼Œä¸€å®šè¦å‘Šè¯‰æœåŠ¡å™¨è§£é”å¤±è´¥\n * @param to\n * @param message\n */\n@Override\npublic void unlockStock(StockLockedTo to) {\n    StockDetailTo detail = to.getDetailTo();\n    Long detailId = detail.getId();\n    //1ã€æŸ¥è¯¢æ•°æ®åº“å…³äºè¿™ä¸ªè®¢å•çš„é”å®šåº“å­˜ä¿¡æ¯\n    // æœ‰ï¼š è¯æ˜åº“å­˜é”å®šæˆåŠŸäº†\n    //     è§£é”ï¼šè®¢å•æƒ…å†µ\n    //          1ã€æ²¡æœ‰è¿™ä¸ªè®¢å•ï¼Œå¿…é¡»è§£é”\n    //          2ã€æœ‰è¿™ä¸ªè®¢å•ï¼Œå°±ä¸æ˜¯è§£é”åº“å­˜\n    //                  è®¢å•çŠ¶æ€ï¼š å·²å–æ¶ˆï¼šè§£é”åº“å­˜\n    //                           æ²¡å–æ¶ˆï¼šä¸èƒ½æ¥å—\n    // æ²¡æœ‰ï¼šåº“å­˜é”å®šå¤±è´¥äº†ï¼Œåº“å­˜å›æ»šäº†ã€‚è¿™ç§æƒ…å†µæ— éœ€è§£é”\n    WareOrderTaskDetailEntity taskDetailEntity = wareOrderTaskDetailService.getById(detailId);\n    if (taskDetailEntity != null) {\n        //æœ‰å·¥ä½œè¯¦æƒ…å•ï¼Œä½†åªèƒ½è¯æ˜åº“å­˜æœåŠ¡åœ¨é”åº“å­˜çš„æ—¶å€™é”æˆåŠŸåè¿”å›å‡ºå»çš„ï¼Œ\n        // è¦çœ‹æ•´ä¸ªè®¢å•æœ‰æ²¡æœ‰ä¸‹å•æˆåŠŸï¼Œå¦‚æœè®¢å•è¿œç¨‹è°ƒç”¨çš„å…¶ä»–æœåŠ¡å´©äº†å¯¼è‡´è®¢å•å›æ»šï¼Œè¿™è·Ÿåº“å­˜æœåŠ¡æ²¡æœ‰å…³ç³»ï¼Œç›´æ¥è§£é”æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºè®¢å•éƒ½æ²¡æœ‰\n        //è§£é”\n        Long id = to.getId();//åº“å­˜å·¥ä½œå•çš„id\n        //è·å–è®¢å•çŠ¶æ€\n        WareOrderTaskEntity taskEntity = wareOrderTaskService.getById(id);\n        String orderSn = taskEntity.getOrderSn();\n        //æ ¹æ®è®¢å•å·æŸ¥è¯¢è®¢å•çš„çŠ¶æ€\n        R r = orderFeignService.getOrderStatus(orderSn);\n        if (r.getCode() == 0) {\n            //è¿œç¨‹è°ƒç”¨æˆåŠŸï¼Œè®¢å•æ•°æ®è¿”å›æˆåŠŸ\n            OrderVo data = r.getData(new TypeReference<OrderVo>() {\n            });\n            if (data == null || data.getStatus() == 4) {\n                //è®¢å•å·²ç»è¢«å–æ¶ˆæˆ–è®¢å•ä¸å­˜åœ¨ï¼Œæ‰èƒ½è§£é”åº“å­˜\n                //é—®é¢˜ï¼šè®¢å•æœåŠ¡ç”±äºç½‘ç»œç­‰åŸå› è¿Ÿè¿Ÿæ²¡æœ‰å°†è®¢å•è§£é”(data.getStatus()==0)å¯¼è‡´åº“å­˜æ°¸è¿œé‡Šæ”¾ä¸äº†é”\n                if (taskDetailEntity.getLockStatus() == 1){\n                    //å½“å‰åº“å­˜å·¥ä½œå•è¯¦æƒ…ï¼ŒçŠ¶æ€ä¸º1 å·²é”å®šä½†æ˜¯æœªè§£é”æ‰å¯ä»¥è§£é”\n                    unLockStock(detail.getSkuId(), detail.getWareId(), detail.getSkuNum(), detailId);\n                }\n            }\n        } else {\n            //è¿œç¨‹è°ƒç”¨å¤±è´¥ç›´æ¥æŠ›å¼‚å¸¸\n            throw new RuntimeException(\"è¿œç¨‹æœåŠ¡å¤±è´¥\");\n        }\n    } else {\n        //æ— éœ€è§£é”\n    }\n}\n```\n\n- è¿œç¨‹è°ƒç”¨è®¢å•æœåŠ¡è·å–è®¢å•çŠ¶æ€\n\n- `com.klaus.gulimall.order.controller.OrderController#getOrderStatus`\n\n```java\n@GetMapping(\"/status/{orderSn}\")\npublic R getOrderStatus(@PathVariable(\"orderSn\") String orderSn){\n    OrderEntity orderEntity = orderService.getOrderByOrderSn(orderSn);\n    return R.ok().setData(orderEntity);\n}\n```\n\n```java\n@Override\npublic OrderEntity getOrderByOrderSn(String orderSn) {\n    OrderEntity orderEntity = this.getOne(new QueryWrapper<OrderEntity>().eq(\"order_sn\", orderSn));\n    return orderEntity;\n}\n```\n\n- `com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.OrderTo)`\n\n```java\n/**\n* é˜²æ­¢è®¢å•æœåŠ¡å¡é¡¿ï¼Œå¯¼è‡´æ›´æ”¹è®¢å•çŠ¶æ€çš„æ“ä½œæ— æ³•å®Œæˆä»¥åŠæ›´æ”¹çš„mqæ¶ˆæ¯æ²¡æœ‰å¾—åˆ°æ‰§è¡Œï¼Œè§£é”åº“å­˜çš„æ¶ˆæ¯ä¼˜å…ˆåˆ°æœŸï¼Œæ‰«æè®¢å•çŠ¶æ€æ˜¯æ–°å»ºçŠ¶æ€ï¼Œå°±ä¼šä»€ä¹ˆéƒ½ä¸åš\n * å¯¼è‡´å¡é¡¿çš„è®¢å•æ°¸è¿œä¸èƒ½è§£é”åº“å­˜\n * @param orderTo\n * åŠ å…¥ç»Ÿä¸€äº‹åŠ¡\n */\n@Transactional\n@Override\npublic void unlockStock(OrderTo orderTo) {\n    String orderSn = orderTo.getOrderSn();\n    //æŸ¥ä¸€ä¸‹æœ€æ–°åº“å­˜çš„çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤è§£é”åº“å­˜\n    WareOrderTaskEntity task = wareOrderTaskService.getOrderTaskByOrderSn(orderSn);\n    Long id = task.getId();\n    //æŒ‰ç…§å·¥ä½œå•æ‰¾åˆ°æ‰€æœ‰ æ²¡æœ‰è§£é”çš„åº“å­˜ï¼Œè¿›è¡Œè§£é”\n    List<WareOrderTaskDetailEntity> detailEntities = wareOrderTaskDetailService.list(new QueryWrapper<WareOrderTaskDetailEntity>().\n            eq(\"task_id\", id).\n            //æ–°å»ºçš„è¿˜æ²¡è¢«è§£é”çš„åº“å­˜\n            eq(\"lock_status\", 1));\n    for (WareOrderTaskDetailEntity entity : detailEntities) {\n        //æ­¤è§£é”æ–¹å¼å¯ä»¥è§£å†³é«˜å¹¶å‘é—®é¢˜å’Œæ•´ä¸ªç³»ç»Ÿçš„å¼‚æ„(ä¸¤ä¸ªæœåŠ¡å¼€å‘è¯­è¨€ä¸åŒã€‚å¦‚javaï¼Œphp)\n        unLockStock(entity.getSkuId(), entity.getWareId(), entity.getSkuNum(), entity.getId());\n    }\n}\n```\n\n- åº“å­˜è§£é”æ–¹æ³•`com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unLockStock`\n\n```java\nprivate void unLockStock(Long skuId, Long wareId, Integer num, Long taskDetailId) {\n    //åº“å­˜è§£é”\n    wareSkuDao.unLockStock(skuId, wareId, num);\n    //æ›´æ–°åº“å­˜å·¥ä½œå•çš„çŠ¶æ€\n    WareOrderTaskDetailEntity entity = new WareOrderTaskDetailEntity();\n    entity.setId(taskDetailId);\n    entity.setLockStatus(2);//å˜ä¸ºå·²è§£é”\n    wareOrderTaskDetailService.updateById(entity);\n}\n```\n\n- SQL\n\n```xml\n<update id=\"unLockStock\">\n    UPDATE `wms_ware_sku` SET stock_locked=stock_locked-#{num}\n    WHERE sku_id=#{skuId} AND ware_id=#{wareId}\n</update>\n```\n\n![image-20230404015601068](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404015601068.png)\n\n\n\n\n\n\n\n##### 5.æ”¯ä»˜æˆåŠŸåï¼Œéœ€è¦è¿›è¡Œæ‹†å•ï¼Œæ ¹æ®å•†å“æ‰“åŒ…æ–¹å¼ï¼Œæ‰€åœ¨ä»“åº“ï¼Œç‰©æµç­‰è¿›è¡Œæ‹†å•(å¾…å¼€å‘)\n\n##### 6.æ”¯ä»˜çš„æ¯ç¬”æµæ°´éƒ½éœ€è¦è®°å½•ï¼Œä»¥å¾…æŸ¥è´¦\n\n![image-20230403161913669](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403161913669.png)\n\n- `com.klaus.gulimall.order.service.impl.OrderServiceImpl#handlePayResult`\n\n```java\n/**\n * å¤„ç†æ”¯ä»˜å®çš„æ”¯ä»˜ç»“æœ\n * @param vo\n * @return\n */\n@Override\npublic String handlePayResult(PayAsyncVo vo) {\n    //1ã€ä¿å­˜äº¤æ˜“æµæ°´\n    PaymentInfoEntity infoEntity = new PaymentInfoEntity();\n    infoEntity.setAlipayTradeNo(vo.getTrade_no());\n    infoEntity.setOrderSn(vo.getOut_trade_no());\n    infoEntity.setPaymentStatus(vo.getTrade_status());\n    infoEntity.setCallbackTime(vo.getNotify_time());\n\n    paymentInfoService.save(infoEntity);\n\n    //2ã€ä¿®æ”¹è®¢å•çš„çŠ¶æ€ä¿¡æ¯\n    if (vo.getTrade_status().equals(\"TRADE_SUCCESS\") || vo.getTrade_status().equals(\"TRADE_FINISHED\")){\n        //æ”¯ä»˜æˆåŠŸçŠ¶æ€\n        String outTradeNo = vo.getOut_trade_no();\n        this.baseMapper.updateOrderStatus(outTradeNo, OrderStatusEnum.PAYED.getCode());\n    }\n\n    return \"success\";\n}\n```\n\n\n\n\n\n##### 7.è®¢å•åˆ›å»ºï¼Œæ”¯ä»˜æˆåŠŸ(å¾…å¼€å‘)ç­‰çŠ¶æ€éƒ½éœ€è¦ç»™ MQ å‘é€æ¶ˆæ¯ï¼Œæ–¹ä¾¿å…¶ä»–ç³»ç»Ÿæ„ŸçŸ¥è®¢é˜…\n\n- æ·»åŠ ä¾èµ–\n\n```xml\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-amqp</artifactId>\n</dependency>\n```\n\n- **è®¢å•åˆ›å»º**ï¼š(MQ)\n- è®¢å•åˆ›å»ºé‡‡ç”¨å»¶è¿Ÿé˜Ÿåˆ—\n- `com.klaus.gulimall.order.config.MyMQConfig`\n\n```java\n@Bean\npublic Queue orderDelayQueue(){\n\n    Map<String, Object> arguments = new HashMap<>();\n    /**\n     * x-dead-letter-exchange: order-event-exchange\n     * x-dead-letter-routing-key: order.release.order\n     * x-message-ttl: 60000\n     */\n    arguments.put(\"x-dead-letter-exchange\", \"order-event-exchange\");\n    arguments.put(\"x-dead-letter-routing-key\", \"order.release.order\");\n    arguments.put(\"x-message-ttl\", 60000);\n\n    //String name, boolean durable, boolean exclusive, boolean autoDelete, Map<String, Object> arguments\n    Queue queue = new Queue(\"order.delay.queue\", true, false, false, arguments);\n    return queue;\n}\n@Bean\npublic Exchange orderEventExchange(){\n    //String name, boolean durable, boolean autoDelete, Map<String, Object> arguments\n    return new TopicExchange(\"order-event-exchange\", true, false);\n}\n@Bean\npublic Binding orderCreateOrderBinding(){\n   //String destination, Binding.DestinationType destinationType, String exchange, String routingKey, Map<String, Object> arguments\n   return new Binding(\"order.delay.queue\",\n                Binding.DestinationType.QUEUE,\n                \"order-event-exchange\",\n                \"order.create.order\", null);\n}\n```\n\n> - åˆ›å»ºè®¢å• è¿›å…¥è·¯ç”±é”®-order.create.order- è¿›å…¥äº¤æ¢æœºorder-event-exchangeï¼Œ æ ¹æ®è·¯ç”±é”®ä¼šè½¬å‘åˆ°å»¶æ—¶é˜Ÿåˆ—order.delay.queue 30min(60s)è¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´åˆ°äº†ä¹‹åï¼Œæ ¹æ®**æ­»ä¿¡**è·¯ç”±é”®-order.release.order-åˆ°è¾¾é‡Šæ”¾è®¢å•é˜Ÿåˆ—order.release.order.queueï¼Œç›‘å¬è¿™ä¸ªé˜Ÿåˆ—çš„æ–¹æ³•åˆ¤æ–­è®¢å•æ˜¯ä¸æ˜¯å·²æ”¯ä»˜ã€‚\n\n![image-20230404121815115](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404121815115.png)\n\n- `com.klaus.gulimall.order.service.impl.OrderServiceImpl#submitOrder`\n\n```java\n@Transactional\n@Override\npublic SubmitOrderResponseVo submitOrder(OrderSubmitVo vo) {\n    ...\n    //todo è®¢å•åˆ›å»ºæˆåŠŸå‘é€æ¶ˆæ¯ç»™MQ\n    rabbitTemplate.convertAndSend(\"order-event-exchange\", \"order.create.order\", order.getOrder());\n\t...\n}\n```\n\n\n\n**åº“å­˜é”å®š**ï¼š(MQ)\n\n- åº“å­˜é”å®šé‡‡ç”¨å»¶è¿Ÿé˜Ÿåˆ—\n\n- `com.klaus.gulimall.ware.config.MyRabbitConfig`\n\n```java\n@Bean\npublic Exchange stockEventExchange(){\n    return new TopicExchange(\"stock-event-exchange\", true, false);\n}\n@Bean\npublic Queue stockDelayQueue(){\n    Map<String, Object> arguments = new HashMap<>();\n    arguments.put(\"x-dead-letter-exchange\", \"stock-event-exchange\");\n    arguments.put(\"x-dead-letter-routing-key\", \"stock.release\");\n    arguments.put(\"x-message-ttl\", 120000);\n\n    //String name, boolean durable, boolean exclusive, boolean autoDelete, Map<String, Object> arguments\n    return new Queue(\"stock.delay.queue\", true, false, false, arguments);\n}\n\n@Bean\npublic Binding stockLockedBinding(){\n    //String destination, Binding.DestinationType destinationType, String exchange, String routingKey, Map<String, Object> arguments\n    return new Binding(\"stock.delay.queue\",\n            Binding.DestinationType.QUEUE,\n            \"stock-event-exchange\",\n            \"stock.locked\", null);\n}\n```\n\n> - åº“å­˜é”å®šæˆåŠŸ è¿›å…¥è·¯ç”±é”®-stock.locked- è¿›å…¥äº¤æ¢æœºstock-event-exchangeï¼Œ æ ¹æ®è·¯ç”±é”®ä¼šè½¬å‘åˆ°å»¶æ—¶é˜Ÿåˆ—stock.delay.queue 50min(120s)è¿‡æœŸæ—¶é—´ï¼Œå»¶è¿Ÿæ—¶é—´åˆ°ï¼Œæ ¹æ®**æ­»ä¿¡**è·¯ç”±é”®-stock.release-åˆ°è¾¾é‡Šæ”¾è®¢å•é˜Ÿåˆ—stock.release.stock.queueï¼Œæ£€æŸ¥è®¢å•çŠ¶æ€ï¼Œç¡®è®¤æ˜¯å¦éœ€è¦è§£é”ã€‚\n\n![image-20230404122316210](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404122316210.png)\n\n- è®¢å•åˆ›å»ºæˆåŠŸååº“å­˜é”å®šä¹ŸæˆåŠŸå°±å‘é€æ¶ˆæ¯ç»™MQ\n\n- `com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#orderLockStock`\n\n```java\n@Transactional\n@Override\npublic Boolean orderLockStock(WareSkuLockVo vo) {\n    ...\n //å‘é€é”å®šåº“å­˜æ¶ˆæ¯ï¼›æäº¤è®¢å•åï¼Œå‡ºç°å¼‚å¸¸ï¼Œè®¢å•å›æ»šï¼Œåº“å­˜ä¸å›æ»šï¼Œå»¶æ—¶é˜Ÿåˆ—æœ‰2ä¸ªä»»åŠ¡ç­‰å¾…æ­»ä¿¡æ—¶é—´ç»“æŸåå‘é€æ¶ˆæ¯\n  rabbitTemplate.convertAndSend(\"stock-event-exchange\", \"stock.locked\", lockedTo);\n  ...\n}\n```\n\n\n\n\n\n**é˜²æ­¢è¶…å–**ï¼šæ•°æ®åº“ unsigned int åšæœ€åçš„ä¿è¯ã€‚ (èŒƒå›´0~65535)\n\n- åœ¨mysqlæ•°æ®åº“ä¸­ï¼Œunsignedè¡¨é¢å«ä¹‰æ˜¯ 'æ— ç¬¦å·'çš„æ„æ€ï¼Œunsignedæ—¢ä¸ºéè´Ÿæ•°ï¼Œç”¨æ­¤ç±»å‹å¯ä»¥å¢åŠ æ•°æ®é•¿åº¦ã€‚\n\n\n\n**è‡ªåŠ¨å…³å•**ï¼šè®¢å•è¶…æ—¶æœªæ”¯ä»˜ï¼Œéœ€è¦å–æ¶ˆè®¢å• (MQ)\n\n- `com.klaus.gulimall.order.config.MyMQConfig`\n\n```java\n\t@Bean\n    public Queue orderReleaseOrderQueue(){\n        Queue queue = new Queue(\"order.release.order.queue\", true, false, false);\n        return queue;\n    }\n \t@Bean\n    public Exchange orderEventExchange(){\n        //String name, boolean durable, boolean autoDelete, Map<String, Object> arguments\n        return new TopicExchange(\"order-event-exchange\", true, false);\n    }\n\t@Bean\n    public Binding orderReleaseOrderBinding(){\n        return new Binding(\"order.release.order.queue\",\n                Binding.DestinationType.QUEUE,\n                \"order-event-exchange\",\n                \"order.release.order\", null);\n    }\n```\n\n> - è®¢å•åˆ›å»ºå»¶è¿Ÿæ—¶é—´åˆ°äº†ä¹‹åï¼Œæ ¹æ®è·¯ç”±é”®-order.release.order-åˆ°è¾¾é‡Šæ”¾è®¢å•é˜Ÿåˆ—order.release.order.queueï¼Œ ç›‘å¬è¿™ä¸ªé˜Ÿåˆ—çš„æ–¹æ³• å…ˆæ˜¯åˆ¤æ–­è®¢å•æ˜¯ä¸æ˜¯å·²æ”¯ä»˜ï¼Œå¦‚æœä¸æ˜¯å°±å…³é—­è®¢å•ï¼Œ`å…³é—­è®¢å•ä¹‹åï¼Œæ ¹æ®è·¯ç”±é”®order.release.other å‘é€å…³é—­çš„è®¢å•æ•°æ®æ¶ˆæ¯åˆ°äº¤æ¢æœºorder-event-exchangeï¼Œäº¤æ¢æœºå†è½¬å‘åˆ°order.release.coupon.queueä¼˜æƒ åˆ¸é˜Ÿåˆ—ï¼Œè¿”å›ä¼˜æƒ åˆ¸ï¼Œä¸ä¹‹é€šè¿‡ ä¹Ÿæ˜¯æ ¹æ®è·¯ç”±é”®order.release.other(å¾…å¼€å‘)`\n\n![image-20230404124500812](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404124500812.png)\n\n- `com.klaus.gulimall.order.listener.OrderCloseListener`\n- æ·»åŠ é…ç½®æ–‡ä»¶`application.properties`ä¸­çš„RabbitMQé…ç½®é¡¹\n\n```properties\nspring.rabbitmq.host=192.168.10.103\nspring.rabbitmq.port=5672\nspring.rabbitmq.virtual-host=/\n# å¼€å¯å‘é€ç«¯ç¡®è®¤\nspring.rabbitmq.publisher-confirms=true\n# å¼€å¯å‘é€ç«¯æ¶ˆæ¯æŠµè¾¾é˜Ÿåˆ—çš„ç¡®è®¤\nspring.rabbitmq.publisher-returns=true\n# åªè¦æŠµè¾¾é˜Ÿåˆ—ï¼Œä»¥å¼‚æ­¥å‘é€ä¼˜å…ˆå›è°ƒæˆ‘ä»¬è¿™ä¸ªreturnConfirm\nspring.rabbitmq.template.mandatory=true\n# æ‰‹åŠ¨ackæ¶ˆæ¯\nspring.rabbitmq.listener.simple.acknowledge-mode=MANUAL\n```\n\n```java\n/**\n * è®¢å•é‡Šæ”¾(å…³å•)ç›‘å¬å™¨\n */\n@Service\n@RabbitListener(queues = \"order.release.order.queue\")\npublic class OrderCloseListener {\n\n    @Autowired\n    OrderService orderService;\n\n    @RabbitHandler\n    public void listener(OrderEntity entity, Channel channel, Message message) throws IOException {\n        //ç­‰å¾…æ­»ä¿¡æ—¶é—´åˆ°åæ”¶åˆ°è®¢å•æ¶ˆæ¯\n        System.out.println(\"æ”¶åˆ°è¿‡æœŸçš„è®¢å•ä¿¡æ¯ï¼Œå‡†å¤‡å…³é—­è®¢å•\"+entity.getOrderSn());\n        try {\n            orderService.closeOrder(entity);\n            //æ‰‹åŠ¨è°ƒç”¨æ”¯ä»˜å®æ”¶å•\n\n            //ç­¾æ”¶è®¢å•\n            channel.basicAck(message.getMessageProperties().getDeliveryTag(), false);\n        } catch (Exception e) {\n\n            channel.basicReject(message.getMessageProperties().getDeliveryTag(), true);\n        }\n    }\n}\n```\n\n- `com.klaus.gulimall.order.service.impl.OrderServiceImpl#closeOrder`\n\n```java\n/**\n   * å…³å•æ–¹æ³•ï¼Œå°†è®¢å•æ–°å»º(å¾…ä»˜æ¬¾)çŠ¶æ€è®¾ç½®ä¸ºå·²å–æ¶ˆçŠ¶æ€å¹¶å‘é€æ¶ˆæ¯ç»™MQç¡®è®¤å…³å•å®Œæˆ\n   * @param entity\n*/\n@Override\npublic void closeOrder(OrderEntity entity) {\n    //æŸ¥è¯¢å½“å‰è¿™ä¸ªè®¢å•çš„æœ€æ–°çŠ¶æ€\n    //å°†è¦å‘é€çš„æ¶ˆæ¯é˜Ÿåˆ—å®ä½“(é‡Šæ”¾è®¢å•æœåŠ¡å‰)\n    OrderEntity orderEntity = this.getById(entity.getId());\n    //status=0\n    if (orderEntity.getStatus() == OrderStatusEnum.CREATE_NEW.getCode()){\n        //åœ¨å¾…ä»˜æ¬¾çŠ¶æ€ä¸‹æ‰å…³å•(æ¶ˆæ¯é˜Ÿåˆ—çš„å®ä½“æœ‰å¯èƒ½è¿‡æœŸäº†ï¼Œæ‰€ä»¥åˆ›å»ºæ–°å®ä½“)\n        OrderEntity update = new OrderEntity();\n        update.setId(entity.getId());\n        // status=4\n        update.setStatus(OrderStatusEnum.CANCLED.getCode());\n        this.updateById(update);\n        OrderTo orderTo = new OrderTo();\n        BeanUtils.copyProperties(orderEntity, orderTo);\n        try {\n            //todo ä¿è¯æ¶ˆæ¯ä¸€å®šä¼šå‘é€å‡ºå»ï¼Œæ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½å¯ä»¥åšå¥½æ—¥å¿—è®°å½•ï¼ˆç»™æ•°æ®åº“ä¿å­˜æ¯ä¸€ä¸ªæ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯ï¼‰\n            //todo å®šæœŸæ‰«ææ•°æ®åº“å°†å¤±è´¥çš„æ¶ˆæ¯å†å‘é€ä¸€éï¼›\n            //åªè¦è§£é”æˆåŠŸäº†å°±ã€ç«‹å³ã€‘å‘æ¶ˆæ¯ç»™MQ\n            rabbitTemplate.convertAndSend(\"order-event-exchange\", \"order.release.other\", orderTo);\n        } catch (Exception e) {\n            //todo å°†æ²¡å‘é€æˆåŠŸçš„æ¶ˆæ¯è¿›è¡Œé‡è¯•å‘é€ ï¼ˆwhileï¼‰\n        }\n    }\n}\n```\n\n**è§£é”åº“å­˜**ï¼š (MQ)\n\n- `com.klaus.gulimall.ware.config.MyRabbitConfig`\n\n```java\n@Bean\npublic Exchange stockEventExchange(){\n    return new TopicExchange(\"stock-event-exchange\", true, false);\n}\n@Bean\npublic Queue stockReleaseStockQueue(){\n    return new Queue(\"stock.release.stock.queue\", true, false, false);\n}\n@Bean\npublic Binding stockReleaseBinding(){\n    return new Binding(\"stock.release.stock.queue\",\n                Binding.DestinationType.QUEUE,\n                \"stock-event-exchange\",\n                \"stock.release.#\", null);\n}\n```\n\n> - `å…³é—­è®¢å•ä¹‹åï¼Œæ ¹æ®è·¯ç”±é”®order.release.other å‘é€å…³é—­çš„è®¢å•æ•°æ®åˆ°äº¤æ¢æœºorder-event-exchangeï¼Œäº¤æ¢æœºå†è½¬å‘åˆ°order.release.coupon.queueä¼˜æƒ åˆ¸é˜Ÿåˆ—ï¼Œè¿”å›ä¼˜æƒ åˆ¸ï¼Œä¸ä¹‹é€šè¿‡ ä¹Ÿæ˜¯æ ¹æ®è·¯ç”±é”®order.release.otherï¼Œå’Œæ•°æ®ä¸€èµ·è½¬å‘åˆ°è§£é”åº“å­˜é˜Ÿåˆ—stock.release.stock.queue è§£é”åº“å­˜(å¾…å¼€å‘)ã€‚`\n\n![image-20230404134206092](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404134206092.png)\n\n- è®¢å•å…³é—­ï¼Œéœ€è¦è§£é”å·²ç»å ç”¨çš„åº“å­˜\n\n- `com.klaus.gulimall.ware.listener.StockReleaseListener`\n\n```java\n/**\n * ç›‘å¬åº“å­˜è§£é”é˜Ÿåˆ—\n */\n@RabbitListener(queues = \"stock.release.stock.queue\")\n@Service\npublic class StockReleaseListener {\n\n    @Autowired\n    WareSkuService wareSkuService;\n\n\t/**\n     * è®¢å•æ­£å¸¸å…³é—­(è®¢å•æœåŠ¡æ­£å¸¸è¿è¡Œ)ï¼Œéœ€è¦è§£é”å·²ç»å ç”¨çš„åº“å­˜\n     * @param to åº“å­˜å·¥ä½œå•(å«å·¥ä½œå•è¯¦æƒ…)\n     */\n    @RabbitHandler\n    public void handleStockLockedRelease(StockLockedTo to, Message message, Channel channel) throws IOException {\n        System.out.println(\"æ”¶åˆ°è§£é”åº“å­˜çš„æ¶ˆæ¯...\");\n        try {\n            //å½“å‰æ¶ˆæ¯æ˜¯å¦è¢«ç¬¬äºŒæ¬¡åŠä»¥å(é‡æ–°)æ´¾å‘è¿‡æ¥äº†\n//            Boolean redelivered = message.getMessageProperties().getRedelivered();\n            wareSkuService.unlockStock(to);\n            //åªè¦è§£é”æˆåŠŸäº†ï¼Œå°±ç­¾æ”¶æ¶ˆæ¯\n            channel.basicAck(message.getMessageProperties().getDeliveryTag(), false);\n        } catch (Exception e) {\n            //æœ‰ä»»ä½•å¼‚å¸¸ç›´æ¥æ‹’ç»ç­¾æ”¶;æ¶ˆæ¯æ‹’ç»ä»¥åé‡æ–°æ”¾åˆ°é˜Ÿåˆ—é‡Œé¢ï¼Œè®©åˆ«äººç»§ç»­æ¶ˆè´¹è§£é”\n            channel.basicReject(message.getMessageProperties().getDeliveryTag(), true);\n        }\n    }\n}\n```\n\n- `com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.StockLockedTo)`\n\n```java\n@Override\npublic void unlockStock(StockLockedTo to) {\n    ...\n    //é—®é¢˜ï¼šè®¢å•æœåŠ¡ç”±äºç½‘ç»œç­‰åŸå› è¿Ÿè¿Ÿæ²¡æœ‰å°†è®¢å•è§£é”(data.getStatus()==0)å¯¼è‡´åº“å­˜æ°¸è¿œé‡Šæ”¾ä¸äº†é”\n    if (taskDetailEntity.getLockStatus() == 1){\n    //å½“å‰åº“å­˜å·¥ä½œå•è¯¦æƒ…ï¼ŒçŠ¶æ€ä¸º1 å·²é”å®šä½†æ˜¯æœªè§£é”æ‰å¯ä»¥è§£é”\n    unLockStock(detail.getSkuId(), detail.getWareId(), detail.getSkuNum(), detailId);\n\t...\n}    \n```\n\n- åº“å­˜é”å®šæˆåŠŸï¼Œè®¢å•å›æ»šï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¹Ÿéœ€è¦åº“å­˜è‡ªåŠ¨è§£é”ï¼›åº“å­˜é”å®šæˆåŠŸï¼Œè®¢å•æœåŠ¡å…¨éƒ¨ç‚¸äº†ï¼Œè®¢å•éƒ½æ²¡æœ‰åˆ›å»ºå¥½ï¼Œå°±å¿…é¡»æœ‰è‡ªåŠ¨è§£é”åŠŸèƒ½\n- `com.klaus.gulimall.ware.listener.StockReleaseListener`\n\n```java\n/**\n * ç›‘å¬åº“å­˜è§£é”é˜Ÿåˆ—\n */\n@RabbitListener(queues = \"stock.release.stock.queue\")\n@Service\npublic class StockReleaseListener {\n\n    @Autowired\n    WareSkuService wareSkuService;\n\n    /**\n     * è®¢å•å¼‚å¸¸å…³é—­(è®¢å•æœåŠ¡å‘é€è¿è¡Œæ—¶å¼‚å¸¸æˆ–å®•æœº)ï¼Œéœ€è¦è§£é”å·²ç»å ç”¨çš„åº“å­˜\n     * å¦‚æœåº“å­˜é”å®šæˆåŠŸï¼Œè®¢å•æœåŠ¡å…¨éƒ¨ç‚¸äº†ï¼Œè®¢å•éƒ½æ²¡æœ‰åˆ›å»ºå¥½ï¼Œå°±å¿…é¡»æœ‰è‡ªåŠ¨è§£é”åŠŸèƒ½\n     * @param orderTo å®Œæ•´è®¢å•ä¿¡æ¯\n     * @param message\n     * @param channel\n     * @throws IOException\n     */\n    @RabbitHandler\n    public void handleOrderCloseRelease(OrderTo orderTo, Message message, Channel channel) throws IOException {\n        System.out.println(\"è®¢å•å…³é—­å‡†å¤‡è§£é”åº“å­˜....\");\n        try {\n            wareSkuService.unlockStock(orderTo);\n            //åªè¦è§£é”æˆåŠŸäº†ï¼Œå°±ç­¾æ”¶æ¶ˆæ¯\n            channel.basicAck(message.getMessageProperties().getDeliveryTag(), false);\n        } catch (Exception e) {\n            //æœ‰ä»»ä½•å¼‚å¸¸ç›´æ¥æ‹’ç»ç­¾æ”¶;æ¶ˆæ¯æ‹’ç»ä»¥åé‡æ–°æ”¾åˆ°é˜Ÿåˆ—é‡Œé¢ï¼Œè®©åˆ«äººç»§ç»­æ¶ˆè´¹è§£é”\n            channel.basicReject(message.getMessageProperties().getDeliveryTag(), true);\n        }\n    }\n}\n```\n\n- `com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.OrderTo)+#unLockStock`\n\n```java\n/**\n * é˜²æ­¢è®¢å•æœåŠ¡å¡é¡¿ï¼Œå¯¼è‡´æ›´æ”¹è®¢å•çŠ¶æ€çš„æ“ä½œæ— æ³•å®Œæˆä»¥åŠæ›´æ”¹çš„mqæ¶ˆæ¯æ²¡æœ‰å¾—åˆ°æ‰§è¡Œï¼Œè§£é”åº“å­˜çš„æ¶ˆæ¯ä¼˜å…ˆåˆ°æœŸï¼Œæ‰«æè®¢å•çŠ¶æ€æ˜¯æ–°å»ºçŠ¶æ€ï¼Œå°±ä¼šä»€ä¹ˆéƒ½ä¸åš\n * å¯¼è‡´å¡é¡¿çš„è®¢å•æ°¸è¿œä¸èƒ½è§£é”åº“å­˜\n * @param orderTo\n * åŠ å…¥ç»Ÿä¸€äº‹åŠ¡\n */\n@Transactional\n@Override\npublic void unlockStock(OrderTo orderTo) {\n    String orderSn = orderTo.getOrderSn();\n    //æŸ¥ä¸€ä¸‹æœ€æ–°åº“å­˜çš„çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤è§£é”åº“å­˜\n    WareOrderTaskEntity task = wareOrderTaskService.getOrderTaskByOrderSn(orderSn);\n    Long id = task.getId();\n    //æŒ‰ç…§å·¥ä½œå•æ‰¾åˆ°æ‰€æœ‰ æ²¡æœ‰è§£é”çš„åº“å­˜ï¼Œè¿›è¡Œè§£é”\n    List<WareOrderTaskDetailEntity> detailEntities = wareOrderTaskDetailService.list(new QueryWrapper<WareOrderTaskDetailEntity>().\n            eq(\"task_id\", id).\n            //æ–°å»ºçš„è¿˜æ²¡è¢«è§£é”çš„åº“å­˜\n            eq(\"lock_status\", 1));\n    for (WareOrderTaskDetailEntity entity : detailEntities) {\n        //æ­¤è§£é”æ–¹å¼å¯ä»¥è§£å†³é«˜å¹¶å‘é—®é¢˜å’Œæ•´ä¸ªç³»ç»Ÿçš„å¼‚æ„(ä¸¤ä¸ªæœåŠ¡å¼€å‘è¯­è¨€ä¸åŒã€‚å¦‚javaï¼Œphp)\n        unLockStock(entity.getSkuId(), entity.getWareId(), entity.getSkuNum(), entity.getId());\n    }\n}\nprivate void unLockStock(Long skuId, Long wareId, Integer num, Long taskDetailId) {\n    //åº“å­˜è§£é”\n    wareSkuDao.unLockStock(skuId, wareId, num);\n    //æ›´æ–°åº“å­˜å·¥ä½œå•çš„çŠ¶æ€\n    WareOrderTaskDetailEntity entity = new WareOrderTaskDetailEntity();\n    entity.setId(taskDetailId);\n    entity.setLockStatus(2);//å˜ä¸ºå·²è§£é”\n    wareOrderTaskDetailService.updateById(entity);\n}\n```\n\n\n\n##### è®¢å•ç¡®è®¤é¡µæµç¨‹\n\n![image-20230322151416874](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322151416874.png)\n\n##### ç”µå•†è®¢å•æµç¨‹å›¾\n\n![image-20230322151557139](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322151557139.png)\n\n##### æ¶ˆæ¯é˜Ÿåˆ—æµç¨‹å›¾\n\n![image-20230416235749443](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230416235749443.png)\n\n##### æ”¯ä»˜å®æ”¯ä»˜æµç¨‹å›¾\n\n![image-20230404162856264](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404162856264.png)\n\n\n\n### é¡¹ç›®éš¾ç‚¹\n\n- è®¢å•æœåŠ¡ä¸åº“å­˜çš„è”åŠ¨(å»¶æ—¶é˜Ÿåˆ—çš„ä½¿ç”¨)\n\n- è®¢å•é‡Šæ”¾&åº“å­˜è§£é”\n\n  ![image-20230322190959538](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322190959538.png)\n\n### è§£å†³é—®é¢˜\n\n- ä½¿ç”¨**CompletableFuture å¼‚æ­¥ç¼–æ’**è§£å†³æŸ¥è¯¢å•†å“è¯¦æƒ…â»š**å“åº”é€Ÿåº¦æ…¢çš„é—®é¢˜**ï¼›\n\n  - å‡å¦‚å•†å“è¯¦æƒ…é¡µçš„æ¯ä¸ªæŸ¥è¯¢ï¼Œéœ€è¦å¦‚ä¸‹æ ‡æ³¨çš„æ—¶é—´æ‰èƒ½å®Œæˆ\n    é‚£ä¹ˆï¼Œç”¨æˆ·éœ€è¦ 5.5s åæ‰èƒ½çœ‹åˆ°å•†å“è¯¦æƒ…é¡µçš„å†…å®¹ã€‚å¾ˆæ˜¾ç„¶æ˜¯ä¸èƒ½æ¥å—çš„ã€‚\n    å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å®Œæˆè¿™ 6 æ­¥æ“ä½œï¼Œä¹Ÿè®¸åªéœ€è¦ 1.5s å³å¯å®Œæˆå“åº”ã€‚\n\n- ä½¿ç”¨**Spring Cacheæ–¹æ³•çº§åˆ«ç¼“å­˜æŠ€æœ¯**ï¼Œå®ç°å·²ç»è¢«è°ƒç”¨è¿‡çš„æŒ‡å®šçš„ç›®æ ‡æ–¹æ³•ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–æ–¹æ³•è°ƒç”¨åçš„ç»“æœè¿”å›ï¼Œ**æé«˜ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ï¼›**\n\n- å¹‚ç­‰è§£å†³æ–¹æ¡ˆ\n\n  - token æœºåˆ¶\n\n    - 1ã€æœåŠ¡ç«¯æä¾›äº†å‘é€ token çš„æ¥å£ã€‚æˆ‘ä»¬åœ¨åˆ†æä¸šåŠ¡çš„æ—¶å€™ï¼Œå“ªäº›ä¸šåŠ¡æ˜¯å­˜åœ¨å¹‚ç­‰é—®é¢˜çš„ï¼Œå°±å¿…é¡»åœ¨æ‰§è¡Œä¸šåŠ¡å‰ï¼Œå…ˆå»è·å– tokenï¼ŒæœåŠ¡å™¨ä¼šæŠŠtoken ä¿å­˜åˆ° redis ä¸­ã€‚\n\n    - 2ã€ç„¶åè°ƒç”¨ä¸šåŠ¡æ¥å£è¯·æ±‚æ—¶ï¼ŒæŠŠ token æºå¸¦è¿‡å»ï¼Œä¸€èˆ¬æ”¾åœ¨è¯·æ±‚å¤´éƒ¨ã€‚\n\n    - 3ã€æœåŠ¡å™¨åˆ¤æ–­ token æ˜¯å¦å­˜åœ¨ redis ä¸­ï¼Œå­˜åœ¨è¡¨ç¤ºç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œç„¶ååˆ é™¤ token,ç»§ç»­æ‰§è¡Œä¸šåŠ¡ã€‚\n\n    - 4ã€å¦‚æœåˆ¤æ–­ token ä¸å­˜åœ¨ redis ä¸­ï¼Œå°±è¡¨ç¤ºæ˜¯é‡å¤æ“ä½œï¼Œç›´æ¥è¿”å›é‡å¤æ ‡è®°ç»™ clientï¼Œè¿™æ ·å°±ä¿è¯äº†ä¸šåŠ¡ä»£ç ï¼Œä¸è¢«é‡å¤æ‰§è¡Œã€‚\n\n    - å±é™©æ€§ï¼š\n\n      - 1ã€å…ˆåˆ é™¤ token è¿˜æ˜¯ååˆ é™¤ tokenï¼›\n\n      - (1) å…ˆåˆ é™¤å¯èƒ½å¯¼è‡´ï¼Œä¸šåŠ¡ç¡®å®æ²¡æœ‰æ‰§è¡Œï¼Œé‡è¯•è¿˜å¸¦ä¸Šä¹‹å‰ tokenï¼Œç”±äºé˜²é‡è®¾è®¡å¯¼è‡´ï¼Œè¯·æ±‚è¿˜æ˜¯ä¸èƒ½æ‰§è¡Œã€‚\n\n      - (2) ååˆ é™¤å¯èƒ½å¯¼è‡´ï¼Œä¸šåŠ¡å¤„ç†æˆåŠŸï¼Œä½†æ˜¯æœåŠ¡é—ªæ–­ï¼Œå‡ºç°è¶…æ—¶ï¼Œæ²¡æœ‰åˆ é™¤ tokenï¼Œåˆ«äººç»§ç»­é‡è¯•ï¼Œå¯¼è‡´ä¸šåŠ¡è¢«æ‰§è¡Œä¸¤é\n\n      - (3) æˆ‘ä»¬æœ€å¥½è®¾è®¡ä¸ºå…ˆåˆ é™¤ tokenï¼Œå¦‚æœä¸šåŠ¡è°ƒç”¨å¤±è´¥ï¼Œå°±é‡æ–°è·å– token å†æ¬¡è¯·æ±‚ã€‚\n\n      - 2ã€Token è·å–ã€æ¯”è¾ƒå’Œåˆ é™¤å¿…é¡»æ˜¯åŸå­æ€§\n\n      - (1) redis.get(token) ã€token.equalsã€redis.del(token)å¦‚æœè¿™ä¸¤ä¸ªæ“ä½œä¸æ˜¯åŸå­ï¼Œå¯èƒ½å¯¼è‡´ï¼Œé«˜å¹¶å‘ä¸‹ï¼Œéƒ½ get åˆ°åŒæ ·çš„æ•°æ®ï¼Œåˆ¤æ–­éƒ½æˆåŠŸï¼Œç»§ç»­ä¸šåŠ¡å¹¶å‘æ‰§è¡Œ\n\n      - (2) å¯ä»¥åœ¨ redis ä½¿ç”¨ lua è„šæœ¬å®Œæˆè¿™ä¸ªæ“ä½œ\n\n   ```shell\n   if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\n   ```\n\n- Sessionå…±äº«é—®é¢˜è§£å†³-ä¸åŒæœåŠ¡ï¼Œå­åŸŸsessionå…±äº«\n\n  - jsessionidè¿™ä¸ªcookieé»˜è®¤æ˜¯å½“å‰ç³»ç»ŸåŸŸåçš„ã€‚å½“æˆ‘ä»¬åˆ†æ‹†æœåŠ¡ï¼Œä¸åŒåŸŸåéƒ¨ç½²çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è§£å†³æ–¹æ¡ˆï¼›\n\n  ![image-20230323001610876](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230323001610876.png)\n\n\n  ```java\n  @Configuration\n  public class GulimallSessionConfig {\n  \n      @Bean\n      public CookieSerializer cookieSerializer(){\n          DefaultCookieSerializer cookieSerializer = new DefaultCookieSerializer();\n  \n          cookieSerializer.setDomainName(\"gulimall.com\");\n          cookieSerializer.setCookieName(\"KLAUSSESSION\");\n          return cookieSerializer;\n      }\n  \n      @Bean\n      public RedisSerializer<Object> springSessionDefaultRedisSerializer() {\n          return new GenericJackson2JsonRedisSerializer();\n      }\n  }\n  ```\n\n  - SpringSessionæ ¸å¿ƒåŸç†\n\n  ```java\n  /**\n   * åŠ å…¥ä¾èµ–\n   *          <dependency>\n   *             <groupId>org.springframework.boot</groupId>\n   *             <artifactId>spring-boot-starter-data-redis</artifactId>\n   *         </dependency>\n   *\n   *         <!--æ•´åˆSpringsessionå®Œæˆsessionå…±äº«é—®é¢˜-->\n   *         <dependency>\n   *             <groupId>org.springframework.session</groupId>\n   *             <artifactId>spring-session-data-redis</artifactId>\n   *         </dependency>\n   * æ ¸å¿ƒåŸç†\n   * 1ã€@EnableRedisHttpSessionå¯¼å…¥RedisHttpSessionConfigurationé…ç½®\n   *      1ï¼‰ã€ç»™å®¹å™¨ä¸­æ·»åŠ äº†ä¸€ä¸ªç»„ä»¶\n   *          ä¼ å…¥SessionRepository==ã€‹ã€RedisOperationsSessionRepositoryã€‘===ã€‹redisæ“ä½œsessionï¼Œsessionçš„å¢åˆ æ”¹æŸ¥å°è£…ç±»\n   *      2ï¼‰ã€SessionRepositoryFilter==ã€‹Filter(web)ï¼šsessionå­˜å‚¨è¿‡æ»¤å™¨ï¼›æ¯ä¸ªè¯·æ±‚è¿‡æ¥éƒ½å¿…é¡»ç»è¿‡Filter\n   *         Iï¼‰ã€åˆ›å»ºçš„æ—¶å€™ï¼Œå°±è‡ªåŠ¨ä»å®¹å™¨ä¸­è·å–äº†SessionRepository\n   *         IIï¼‰ã€åŸå§‹çš„HttpServletRequest request, HttpServletResponse responseéƒ½è¢«åˆ†åˆ«åŒ…è£…æˆäº†SessionRepositoryRequestWrapperï¼ŒSessionRepositoryResponseWrapper\n   *         IIIï¼‰ã€ä»¥åè·å–session-ã€‹request.getSession();ï¼ˆåŸå§‹çš„ï¼‰\n   *         //SessionRepositoryRequestWrapperé‡å†™getSessionæ–¹æ³•\n   *         IVï¼‰ã€wrapperRequest.getSession();==> SessionRepositoryä¸­è·å–çš„åˆ°\n   *  è£…é¥°è€…æ¨¡å¼ï¼›\n   *\n   *  è‡ªåŠ¨å»¶æœŸï¼›redisä¸­çš„æ•°æ®ä¹Ÿæ˜¯æœ‰è¿‡æœŸæ—¶é—´çš„\n   */\n  @EnableRedisHttpSession //æ•´åˆredisä½œä¸ºsessionå­˜å‚¨\n  @SpringBootApplication\n  public class GulimallAuthServerApplication {\n  \n      public static void main(String[] args) {\n          SpringApplication.run(GulimallAuthServerApplication.class, args);\n      }\n  \n  }\n  ```\n\n  ![image-20230323001706985](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230323001706985.png)\n\n- ThreadLocal-åŒä¸€ä¸ªçº¿ç¨‹å…±äº«æ•°æ®\n\n![image-20230323001857265](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230323001857265.png)\n\n- Feignè¿œç¨‹è°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´é—®é¢˜\n\n  ![image-20230323001742038](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230323001742038.png)\n\n  - `com.klaus.gulimall.member.config`\n\n\n```java\n@Configuration\npublic class GulimallFeignConfig {\n\n    @Bean(\"requestInterceptor\")\n    public RequestInterceptor requestInterceptor() {\n        // RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();\n        //RequestContextHolder.setRequestAttributes(requestAttributes);\n        // è¿›è¡Œå…±äº«æ“ä½œï¼Œæ‹¦æˆªå™¨æ‰ä¼šæœ‰è¯·æ±‚ä¸Šä¸‹æ–‡çš„æ‰€æœ‰æ•°æ®\n        return new RequestInterceptor() {\n\n            @Override\n            public void apply(RequestTemplate template) {\n                //1ã€RequestContextHolderæ‹¿åˆ°åˆšè¿›æ¥çš„è¿™ä¸ªè¯·æ±‚\n                ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();\n                if (attributes != null){\n                    System.out.println(\"RequestInterceptorçº¿ç¨‹....\"+Thread.currentThread().getId());\n                    HttpServletRequest request = attributes.getRequest();//è€è¯·æ±‚\n                    if (request != null){\n                        //è¯·æ±‚ä¸ä¸ºç©º\n                        //åŒæ­¥è¯·æ±‚å¤´æ•°æ®ï¼ŒCookie\n                        String cookie = request.getHeader(\"Cookie\");\n//                System.out.println(\"feignè¿œç¨‹ä¹‹å‰å…ˆè¿›è¡ŒRequestInterceptor.apply\");\n                        //ç»™æ–°è¯·æ±‚åŒæ­¥äº†è€è¯·æ±‚çš„Cookie\n                        template.header(\"Cookie\", cookie);\n                    }\n                }\n            }\n        };\n    }\n}\n```\n\n- Feignå¼‚æ­¥æƒ…å†µä¸¢å¤±ä¸Šä¸‹æ–‡é—®é¢˜\n\n  ![image-20230323001802654](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230323001802654.png)\n\n  - `com.klaus.gulimall.order.service.impl.OrderServiceImpl#confirmOrder`\n\n\n```java\n//è·å–åŸæ¥è¯·æ±‚ä¸Šä¸‹æ–‡è¯·æ±‚å±æ€§\nRequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();\n//è¿›è¡Œå¼‚æ­¥ç¼–æ’\nCompletableFuture<Void> getAddressFuture = CompletableFuture.runAsync(() -> {\n    //1ã€è¿œç¨‹æŸ¥è¯¢æ‰€æœ‰çš„æ”¶è´§åœ°å€åˆ—è¡¨\n    System.out.println(\"memberçº¿ç¨‹....\" + Thread.currentThread().getId());\n    //åœ¨Feignå¼‚æ­¥è°ƒç”¨å‰å°†è¯·æ±‚ä¸Šä¸‹æ–‡è¿›è¡Œå…±äº«æ“ä½œ(ä¹‹å‰çš„è¯·æ±‚æ•°æ®éƒ½æ¥å…±äº«æ¯ä¸€ä¸ªçº¿ç¨‹)\n    RequestContextHolder.setRequestAttributes(requestAttributes);\n    List<MemberAddressVo> address = memberFeignService.getAddress(memberRespVo.getId());\n    confirmVo.setAddress(address);\n}, executor);\n\nCompletableFuture<Void> cartFuture = CompletableFuture.runAsync(() -> {\n    //2ã€è¿œç¨‹æŸ¥è¯¢è´­ç‰©è½¦æ‰€æœ‰é€‰ä¸­çš„è´­ç‰©é¡¹\n    System.out.println(\"cartçº¿ç¨‹....\" + Thread.currentThread().getId());\n    //åœ¨Feignå¼‚æ­¥è°ƒç”¨å‰å°†è¯·æ±‚ä¸Šä¸‹æ–‡è¿›è¡Œå…±äº«æ“ä½œ\n    RequestContextHolder.setRequestAttributes(requestAttributes);\n    List<OrderItemVo> items = cartFeignService.currentUserCartItems();\n    confirmVo.setItems(items);\n    //feignåœ¨è¿œç¨‹è°ƒç”¨ä¹‹å‰è¦æ„é€ è¯·æ±‚ï¼Œè°ƒç”¨å¾ˆå¤šçš„æ‹¦æˆªå™¨\n    //for(RequestInterceptor interceptor:requestInterceptors)\n}, executor).thenRunAsync(() -> {\n    List<OrderItemVo> items = confirmVo.getItems();\n    List<Long> skuIds = items.stream().map(item -> item.getSkuId()).collect(Collectors.toList());\n    //è¿œç¨‹æŸ¥è¯¢åº“å­˜\n    R r = wmsFeignService.getSkusHasStock(skuIds);\n    List<SkuStockVo> data = r.getData(new TypeReference<List<SkuStockVo>>() {\n    });\n    if (data != null) {\n        // Map<SkuId, hasStock> map\n        Map<Long, Boolean> map = data.stream().collect(Collectors.toMap(SkuStockVo::getSkuId, SkuStockVo::getHasStock));\n        // Map<Long, Boolean> stocks;\n        confirmVo.setStocks(map);\n    }\n}, executor);\n```\n\n### é¡¹ç›®ä¼˜åŒ–\n\n- ä½¿ç”¨åŠ¨æ€çº¿ç¨‹æ± ç®¡ç†å’Œç›‘æ§ï¼Œå®šæ—¶è·å–çº¿ç¨‹æ± çš„è¿è¡Œæ•°æ®\n\nHippo4j æä¾›äº†åº”ç”¨çº¿ç¨‹æ± è¿è¡Œæ—¶å˜æ›´æ ¸å¿ƒå‚æ•°çš„åŠŸèƒ½ã€‚è€Œä¸”ï¼Œå¦‚æœåº”ç”¨æ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œå¯ä»¥é€‰æ‹©ä¿®æ”¹çº¿ç¨‹æ± æŸä¸€å®ä¾‹ï¼Œæˆ–è€…ä¿®æ”¹é›†ç¾¤å…¨éƒ¨å®ä¾‹ï¼Œè¿è¡Œæ—¶ç”Ÿæ•ˆï¼Œä¸éœ€è¦å†é‡å¯æœåŠ¡ã€‚\n\nå‹æµ‹æ—¶å¯ä»¥ä½¿ç”¨ Hippo4j åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ï¼Œåˆ¤æ–­çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°è®¾ç½®æ˜¯å¦åˆç†ã€‚å¯¹äºå¼€å‘æµ‹è¯•æ¥è¯´ï¼Œå¦‚æœä¸æ»¡è¶³å¯ä»¥éšæ—¶è°ƒæ•´ã€‚\n\n\n\n## CompletableFutureå¼‚æ­¥ç¼–æ’\n\n### æ¦‚å¿µ\n\n- CompletableFutureæ˜¯JDK1.8é‡Œé¢å¼•å…¥çš„ä¸€ä¸ªå¼‚æ­¥å›è°ƒç±»ï¼Œå°±æ˜¯è¯´å½“å‰ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹å»æ‰§è¡Œä¸€ä¸ªä»»åŠ¡æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨è¿™ä¸ªä»»åŠ¡ç»“æŸä»¥åï¼Œè§¦å‘ä¸€ä¸ªåç»­çš„åŠ¨ä½œï¼Œè€ŒCompletableFutureå°±å¯ä»¥å®ç°è¿™æ ·çš„åŠŸèƒ½ã€‚\n\n### ä¸šåŠ¡åœºæ™¯\n\n- æŸ¥è¯¢å•†å“è¯¦æƒ…é¡µçš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæœ‰äº›æ•°æ®è¿˜éœ€è¦è¿œç¨‹è°ƒç”¨ï¼Œå¿…ç„¶éœ€è¦èŠ±è´¹æ›´å¤šçš„æ—¶é—´ã€‚\n\n![image-20230322152108985](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322152108985.png)\n\n- å‡å¦‚å•†å“è¯¦æƒ…é¡µçš„æ¯ä¸ªæŸ¥è¯¢ï¼Œéœ€è¦å¦‚ä¸‹æ ‡æ³¨çš„æ—¶é—´æ‰èƒ½å®Œæˆ\n  é‚£ä¹ˆï¼Œç”¨æˆ·éœ€è¦ 5.5s åæ‰èƒ½çœ‹åˆ°å•†å“è¯¦æƒ…é¡µçš„å†…å®¹ã€‚å¾ˆæ˜¾ç„¶æ˜¯ä¸èƒ½æ¥å—çš„ã€‚\n  å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å®Œæˆè¿™ 6 æ­¥æ“ä½œï¼Œä¹Ÿè®¸åªéœ€è¦ 1.5s å³å¯å®Œæˆå“åº”ã€‚\n- åœ¨ Java 8 ä¸­, æ–°å¢åŠ äº†ä¸€ä¸ªåŒ…å« 50 ä¸ªæ–¹æ³•å·¦å³çš„ç±»: CompletableFutureï¼Œæä¾›äº†éå¸¸å¼ºå¤§çš„\n  Future çš„æ‰©å±•åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹çš„å¤æ‚æ€§ï¼Œæä¾›äº†å‡½æ•°å¼ç¼–ç¨‹çš„èƒ½åŠ›ï¼Œå¯ä»¥\n  é€šè¿‡å›è°ƒçš„æ–¹å¼å¤„ç†è®¡ç®—ç»“æœï¼Œå¹¶ä¸”æä¾›äº†è½¬æ¢å’Œç»„åˆ CompletableFuture çš„æ–¹æ³•ã€‚\n\n### é¡¹ç›®ä»£ç \n\n- `com.klaus.gulimall.product.service.impl.SkuInfoServiceImpl#item`\n\n\n```java\n    //å››ã€çº¿ç¨‹ä¸²è¡ŒåŒ–æ–¹æ³•\n    /*\n    thenApply æ–¹æ³•ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ä¾èµ–å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œè·å–ä¸Šä¸€ä¸ªä»»åŠ¡è¿”å›çš„ç»“æœï¼Œå¹¶è¿”å›å½“å‰\n    ä»»åŠ¡çš„è¿”å›å€¼ã€‚\n    thenAccept æ–¹æ³•ï¼šæ¶ˆè´¹å¤„ç†ç»“æœã€‚æ¥æ”¶ä»»åŠ¡çš„å¤„ç†ç»“æœï¼Œå¹¶æ¶ˆè´¹å¤„ç†ï¼Œæ— è¿”å›ç»“æœã€‚\n    thenRun æ–¹æ³•ï¼šåªè¦ä¸Šé¢çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå°±å¼€å§‹æ‰§è¡Œ thenRunï¼Œåªæ˜¯å¤„ç†å®Œä»»åŠ¡åï¼Œæ‰§è¡Œ\n    thenRun çš„åç»­æ“ä½œ\n    å¸¦æœ‰ Async é»˜è®¤æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚åŒä¹‹å‰ã€‚\n    ä»¥ä¸Šéƒ½è¦å‰ç½®ä»»åŠ¡æˆåŠŸå®Œæˆã€‚\n     */\n\t@Override\n    public SkuItemVo item(Long skuId) throws ExecutionException, InterruptedException {\n        SkuItemVo skuItemVo = new SkuItemVo();\n        //ä¸€ã€åˆ›å»ºå¼‚æ­¥å¯¹è±¡\n        /*\n         runAsyncå’ŒsupplyAsync  runXxxx éƒ½æ˜¯æ²¡æœ‰è¿”å›ç»“æœçš„ï¼ŒsupplyXxx éƒ½æ˜¯å¯ä»¥è·å–è¿”å›ç»“æœçš„\n         å¯ä»¥ä¼ å…¥è‡ªå®šä¹‰çš„çº¿ç¨‹æ± ï¼Œå¦åˆ™å°±ç”¨é»˜è®¤çš„çº¿ç¨‹æ± ï¼›\n         */\n        CompletableFuture<SkuInfoEntity> infoFuture = CompletableFuture.supplyAsync(() -> {\n            //1.skuåŸºæœ¬ä¿¡æ¯è·å– pms_sku_info\n            SkuInfoEntity info = this.getById(skuId);\n            skuItemVo.setInfo(info);\n            return info;\n        }, executor);\n    CompletableFuture<Void> saleAttrFuture = infoFuture.thenAcceptAsync((res) -> {\n        //3ã€ è·å–spuçš„é”€å”®å±æ€§ç»„åˆ\n        List<SkuItemSaleAttrVo> saleAttrVos = skuSaleAttrValueService.getSaleAttrBySpuId(res.getSpuId());\n        skuItemVo.setSaleAttr(saleAttrVos);\n    }, executor);\n\n    CompletableFuture<Void> descFuture = infoFuture.thenAcceptAsync((res) -> {\n        //4.è·å–spuçš„ä»‹ç» pms_spu_info_desc\n        SpuInfoDescEntity spuInfoDescEntity = spuInfoDescService.getById(res.getSpuId());\n        skuItemVo.setDesc(spuInfoDescEntity);\n    }, executor);\n\n    CompletableFuture<Void> baseAttrFuture = infoFuture.thenAcceptAsync((res) -> {\n        //5.è·å–spuçš„è§„æ ¼å‚æ•°ä¿¡æ¯\n        List<SpuItemAttrGroupVo> attrGroupVos = attrGroupService.getAttrGroupWithAttrsBySpuId(res.getSpuId(), res.getCatalogId());\n        skuItemVo.setGroupAttrs(attrGroupVos);\n    }, executor);\n\n    //ä¸€ã€åˆ›å»ºå¼‚æ­¥å¯¹è±¡\n    /*\n     runAsyncå’ŒsupplyAsync  runXxxx éƒ½æ˜¯æ²¡æœ‰è¿”å›ç»“æœçš„ï¼ŒsupplyXxx éƒ½æ˜¯å¯ä»¥è·å–è¿”å›ç»“æœçš„\n     å¯ä»¥ä¼ å…¥è‡ªå®šä¹‰çš„çº¿ç¨‹æ± ï¼Œå¦åˆ™å°±ç”¨é»˜è®¤çš„çº¿ç¨‹æ± ï¼›\n     */\n    //2.skuå›¾ç‰‡ä¿¡æ¯  pms_spu_images\n    CompletableFuture<Void> imageFuture = CompletableFuture.runAsync(() -> {\n        List<SkuImagesEntity> imagesEntities = skuImagesService.getImagesBySkuId(skuId);\n        skuItemVo.setImages(imagesEntities);\n    }, executor);\n\n    //TODO //3ã€è¿œç¨‹è°ƒç”¨æŸ¥è¯¢å½“å‰skuæ˜¯å¦å‚ä¸ç§’æ€ä¼˜æƒ æ´»åŠ¨\n    CompletableFuture<Void> seckillFuture = CompletableFuture.runAsync(() -> {\n        //3.è¿œç¨‹è°ƒç”¨æŸ¥è¯¢å½“å‰skuæ˜¯å¦å‚ä¸ç§’æ€ä¼˜æƒ æ´»åŠ¨\n        R skuSeckilInfo = seckillFeignService.getSkuSeckilInfo(skuId);\n        if (skuSeckilInfo.getCode() == 0) {\n            //æŸ¥è¯¢æˆåŠŸ\n            SeckillSkuVo skuSeckilInfoData = skuSeckilInfo.getData(\"data\", new TypeReference<SeckillSkuVo>() {\n            });\n            skuItemVo.setSeckillSkuVo(skuSeckilInfoData);\n\n            if (skuSeckilInfoData != null) {\n                long currentTime = System.currentTimeMillis();\n                if (currentTime > skuSeckilInfoData.getEndTime()) {\n                    skuItemVo.setSeckillSkuVo(null);\n                }\n            }\n        }\n    }, executor);\n\n    //ä¸ƒã€å¤šä»»åŠ¡ç»„åˆ\n    /*\n    allOfï¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ\n    anyOfï¼šåªè¦æœ‰ä¸€ä¸ªä»»åŠ¡å®Œæˆ\n     */\n    //ç­‰åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆ  //TODO ç§’æ€ä¼˜æƒ æ´»åŠ¨Future\n    CompletableFuture.allOf(saleAttrFuture,descFuture,baseAttrFuture,imageFuture,seckillFuture).get();\n    return skuItemVo;\n}\n```\n\n## RabbitMQå»¶æ—¶é˜Ÿåˆ—ï¼ˆå®ç°å®šæ—¶ä»»åŠ¡ï¼‰\n\n### åœºæ™¯ï¼š\n\n![image-20230322165119843](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322165119843.png)\n\n- æ¯”å¦‚æœªä»˜æ¬¾è®¢å•ï¼Œè¶…è¿‡ä¸€å®šæ—¶é—´åï¼Œç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆè®¢å•å¹¶é‡Šæ”¾å æœ‰ç‰©å“ã€‚\n\n- å¸¸ç”¨è§£å†³æ–¹æ¡ˆï¼šspringçš„ schedule å®šæ—¶ä»»åŠ¡è½®è¯¢æ•°æ®åº“\n\n  - ç¼ºç‚¹ï¼šæ¶ˆè€—ç³»ç»Ÿå†…å­˜ã€å¢åŠ äº†æ•°æ®åº“çš„å‹åŠ›ã€å­˜åœ¨è¾ƒå¤§çš„æ—¶é—´è¯¯å·®\n\n  - å®šæ—¶ä»»åŠ¡çš„æ—¶æ•ˆæ€§é—®é¢˜\n\n    å®šæ—¶ä»»åŠ¡å¼€å¯çš„ç¬¬ä¸€æ¬¡æ‰«æï¼Œè®¢å•æœªåˆ›å»ºï¼Œ1minååˆ›å»ºå®Œæˆï¼Œ30minç¬¬äºŒæ¬¡æ‰«æè®¢å•æœªè¿‡æœŸï¼Œæ— äº‹å‘ç”Ÿï¼Œ31minè®¢å•è¿‡æœŸï¼Œç›´åˆ°60minç¬¬ä¸‰æ¬¡æ‰«ææ‰æ‰«åˆ°è¿‡æœŸè®¢å•\n\n    ![image-20230322165931065](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322165931065.png)\n\n- è§£å†³ï¼šrabbitmqçš„æ¶ˆæ¯TTLå’Œæ­»ä¿¡Exchangeç»“åˆ\n\n- è®¢å•é‡Šæ”¾&åº“å­˜è§£é”\n\n![image-20230410190115962](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190115962.png)\n\n\n\n### æ¶ˆæ¯çš„TTLï¼ˆTime To Liveï¼‰\n\n- æ¶ˆæ¯çš„TTLå°±æ˜¯æ¶ˆæ¯çš„å­˜æ´»æ—¶é—´ã€‚\n- RabbitMQå¯ä»¥å¯¹é˜Ÿåˆ—å’Œæ¶ˆæ¯åˆ†åˆ«è®¾ç½®TTLã€‚\n- å¯¹é˜Ÿåˆ—è®¾ç½®å°±æ˜¯é˜Ÿåˆ—æ²¡æœ‰æ¶ˆè´¹è€…è¿ç€çš„ä¿ç•™æ—¶é—´ï¼Œ**ä¹Ÿå¯ä»¥å¯¹æ¯ä¸€ä¸ªå•ç‹¬çš„æ¶ˆæ¯åšå•ç‹¬çš„**\n  **è®¾ç½®ã€‚è¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™ä¸ªæ¶ˆæ¯å°±æ­»äº†ï¼Œç§°ä¹‹ä¸ºæ­»ä¿¡**ã€‚\n- å¦‚æœé˜Ÿåˆ—è®¾ç½®äº†ï¼Œæ¶ˆæ¯ä¹Ÿè®¾ç½®äº†ï¼Œé‚£ä¹ˆä¼š**å–å°çš„**ã€‚æ‰€ä»¥ä¸€ä¸ªæ¶ˆæ¯å¦‚æœè¢«è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿ\n  åˆ—ä¸­ï¼Œè¿™ä¸ªæ¶ˆæ¯æ­»äº¡çš„æ—¶é—´æœ‰å¯èƒ½ä¸ä¸€æ ·ï¼ˆä¸åŒçš„é˜Ÿåˆ—è®¾ç½®ï¼‰ã€‚è¿™é‡Œå•è®²å•ä¸ªæ¶ˆæ¯çš„\n  TTLï¼Œå› ä¸ºå®ƒæ‰æ˜¯å®ç°å»¶è¿Ÿä»»åŠ¡çš„å…³é”®ã€‚å¯ä»¥é€šè¿‡**è®¾ç½®æ¶ˆæ¯çš„expirationå­—æ®µæˆ–è€…x-**\n  **message-ttlå±æ€§æ¥è®¾ç½®æ—¶é—´**ï¼Œä¸¤è€…æ˜¯ä¸€æ ·çš„æ•ˆæœã€‚\n\n### Dead Letter Exchangesï¼ˆDLXï¼‰\n\n- ä¸€ä¸ªæ¶ˆæ¯åœ¨æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ä¸‹ï¼Œä¼šè¿›\n\n  æ­»ä¿¡è·¯ç”±\n\n  ï¼Œè®°ä½è¿™é‡Œæ˜¯è·¯ç”±è€Œä¸æ˜¯é˜Ÿåˆ—ï¼Œ\n\n  ä¸€ä¸ªè·¯ç”±å¯ä»¥å¯¹åº”å¾ˆå¤šé˜Ÿåˆ—ã€‚ï¼ˆä»€ä¹ˆæ˜¯æ­»ä¿¡ï¼‰\n\n  - ä¸€ä¸ªæ¶ˆæ¯è¢«Consumeræ‹’æ”¶äº†ï¼Œå¹¶ä¸”rejectæ–¹æ³•çš„å‚æ•°é‡Œrequeueæ˜¯falseã€‚ä¹Ÿå°±æ˜¯è¯´ä¸\n    ä¼šè¢«å†æ¬¡æ”¾åœ¨é˜Ÿåˆ—é‡Œï¼Œè¢«å…¶ä»–æ¶ˆè´¹è€…ä½¿ç”¨ã€‚ ï¼ˆ basic.reject/ basic.nack ï¼‰ requeue=false\n  - ä¸Šé¢çš„æ¶ˆæ¯çš„TTLåˆ°äº†ï¼Œæ¶ˆæ¯è¿‡æœŸäº†ã€‚\n  - é˜Ÿåˆ—çš„é•¿åº¦é™åˆ¶æ»¡äº†ã€‚æ’åœ¨å‰é¢çš„æ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒæˆ–è€…æ‰”åˆ°æ­»ä¿¡è·¯ç”±ä¸Š\n\n- Dead Letter Exchangeå…¶å®å°±æ˜¯ä¸€ç§æ™®é€šçš„exchangeï¼Œå’Œåˆ›å»ºå…¶ä»–\n  exchangeæ²¡æœ‰ä¸¤æ ·ã€‚åªæ˜¯åœ¨æŸä¸€ä¸ªè®¾ç½®Dead Letter Exchangeçš„é˜Ÿåˆ—ä¸­æœ‰\n  æ¶ˆæ¯è¿‡æœŸäº†ï¼Œä¼šè‡ªåŠ¨è§¦å‘æ¶ˆæ¯çš„è½¬å‘ï¼Œå‘é€åˆ°Dead Letter Exchangeä¸­å»ã€‚\n\n- æˆ‘ä»¬æ—¢å¯ä»¥æ§åˆ¶æ¶ˆæ¯åœ¨ä¸€æ®µæ—¶é—´åå˜æˆæ­»ä¿¡ï¼Œåˆå¯ä»¥æ§åˆ¶å˜æˆæ­»ä¿¡çš„æ¶ˆæ¯\n  è¢«è·¯ç”±åˆ°æŸä¸€ä¸ªæŒ‡å®šçš„äº¤æ¢æœºï¼Œç»“åˆäºŒè€…ï¼Œå…¶å®å°±å¯ä»¥å®ç°ä¸€ä¸ªå»¶æ—¶é˜Ÿåˆ—\n\n- æ‰‹åŠ¨ack&å¼‚å¸¸æ¶ˆæ¯ç»Ÿä¸€æ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—å¤„ç†å»ºè®®çš„ä¸¤ç§æ–¹å¼\n\n- catchå¼‚å¸¸åï¼Œæ‰‹åŠ¨å‘é€åˆ°æŒ‡å®šé˜Ÿåˆ—ï¼Œç„¶åä½¿ç”¨channelç»™rabbitmqç¡®è®¤æ¶ˆæ¯å·²æ¶ˆè´¹\n\n- ç»™Queueç»‘å®šæ­»ä¿¡é˜Ÿåˆ—ï¼Œä½¿ç”¨nackï¼ˆreququeä¸ºfalseï¼‰ç¡®è®¤æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥\n\n### å»¶æ—¶é˜Ÿåˆ—å®ç°\n\n- ç»™é˜Ÿåˆ—è®¾ç½®è¿‡æœŸæ—¶é—´\n\n![image-20230322152334742](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322152334742.png)\n\n- ç»™æ¶ˆæ¯è®¾ç½®è¿‡æœŸæ—¶é—´\n\n![image-20230322152358754](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322152358754.png)\n\n- æ¨èï¼šç»™é˜Ÿåˆ—è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå› ä¸ºç»™æ¶ˆæ¯è®¾ç½®è¿‡æœŸæ—¶é—´çš„è¯ï¼ŒRabbitMQé‡‡ç”¨çš„æ˜¯æƒ°æ€§æ£€æŸ¥æœºåˆ¶ï¼Œå‡è®¾é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯è¿‡æœŸæ—¶é—´ä¸åŒï¼Œåé¢çš„æ¶ˆæ¯å¿…é¡»ç­‰å‰é¢çš„æ¶ˆæ¯è¿‡æœŸï¼Œæœ€ç»ˆå¯¼è‡´æ¶ˆæ¯ä¸èƒ½æŒ‰ç…§è§„å®šçš„è¿‡æœŸæ—¶é—´è¿‡æœŸã€‚\n\n### SpringBootä¸­ä½¿ç”¨å»¶æ—¶é˜Ÿåˆ—\n\n- 1ã€Queueã€Exchangeã€Bindingå¯ä»¥@Beanè¿›å»\n- 2ã€ç›‘å¬æ¶ˆæ¯çš„æ–¹æ³•å¯ä»¥æœ‰ä¸‰ç§å‚æ•°ï¼ˆä¸åˆ†æ•°é‡ï¼Œé¡ºåºï¼‰\n  - Object content, Message message, Channel channel\n- 3ã€channelå¯ä»¥ç”¨æ¥æ‹’ç»æ¶ˆæ¯ï¼Œå¦åˆ™è‡ªåŠ¨ackï¼›\n\n### æ¶ˆæ¯é˜Ÿåˆ—æµç¨‹\n\n- ä½¿ç”¨RabbitMQå»¶æ—¶é˜Ÿåˆ—å®ç°æœªä»˜æ¬¾è®¢å•ï¼Œè¶…è¿‡ä¸€å®šæ—¶é—´åï¼Œç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆè®¢å•å¹¶è§£é”åº“å­˜ã€‚\n- PS:åˆ›å»ºè®¢å• è¿›å…¥è·¯ç”±é”®-order.create.order- è¿›å…¥äº¤æ¢æœºorder-event-exchangeï¼Œ æ ¹æ®è·¯ç”±é”®ä¼šè½¬å‘åˆ°å»¶æ—¶é˜Ÿåˆ—order.delay.queue 1minè¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´åˆ°äº†ä¹‹åï¼Œæ ¹æ®è·¯ç”±é”®order.release.order-åˆ°è¾¾é‡Šæ”¾è®¢å•é˜Ÿåˆ—order.release.order.queueï¼Œ ç›‘å¬è¿™ä¸ªé˜Ÿåˆ—çš„æ–¹æ³• å…ˆæ˜¯åˆ¤æ–­è®¢å•æ˜¯ä¸æ˜¯å·²æ”¯ä»˜ï¼Œå¦‚æœä¸æ˜¯ å°±å…³é—­è®¢å•ï¼Œå…³é—­è®¢å•ä¹‹åï¼Œæ ¹æ®è·¯ç”±é”®order.release.other å‘é€å…³é—­çš„è®¢å•æ•°æ®åˆ°äº¤æ¢æœºorder-event-exchangeï¼Œäº¤æ¢æœºå†è½¬å‘åˆ°order.release.coupon.queueä¼˜æƒ åˆ¸é˜Ÿåˆ—ï¼Œè¿”å›ä¼˜æƒ åˆ¸ï¼Œä¸ä¹‹é€šè¿‡ ä¹Ÿæ˜¯æ ¹æ®è·¯ç”±é”®order.release.otherï¼Œå’Œæ•°æ®ä¸€èµ·è½¬å‘åˆ°è§£é”åº“å­˜é˜Ÿåˆ—stock.release.stock.queue è§£é”åº“å­˜ã€‚\n\n![image-20230416235749443](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230416235749443.png)\n\n## Redisç¼“å­˜ä¸­çš„æ•°æ®ç»“æ„\n\n### åˆ†ç±»èœå•\n\n- ç±»å‹ï¼šString\n- value: èœå•ä¿¡æ¯\n\n### ç™»é™†ä¿¡æ¯-SpringSession\n\n### è´­ç‰©è½¦\n\n- ç±»å‹ï¼šHash\n- key: gulimall:cart:2 // 2ä¸ºç”¨æˆ·ID\n- field: å•†å“ id\n- value: è´­ç‰©é¡¹æ•°æ®\n- ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬çš„è´­ç‰©è½¦ç»“æ„æ˜¯ä¸€ä¸ªåŒå±‚ Mapï¼šMap<String,Map<String,String>>\n  - ç¬¬ä¸€å±‚ Mapï¼ŒKey æ˜¯ç”¨æˆ· id\n  - ç¬¬äºŒå±‚ Mapï¼ŒKey æ˜¯è´­ç‰©è½¦ä¸­å•†å“ idï¼Œå€¼æ˜¯è´­ç‰©é¡¹æ•°æ®\n\n### ç§’æ€ä¸Šæ¶ (å¹‚ç­‰æ€§å¤„ç†)\n\n- ç¼“å­˜ç§’æ€æ´»åŠ¨ä¿¡æ¯ (seckill:session:)\n  - ç±»å‹: List\n  - key: seckill:session:start_endtime // å¼€å§‹æ—¶é—´çš„æ—¶é—´æˆ³_ç»“æŸæ—¶é—´çš„æ—¶é—´æˆ³\n  - value: åœºæ¬¡ID_å•†å“ID\n- ç¼“å­˜ç§’æ€æ´»åŠ¨æ‰€å…³è”çš„å•†å“ä¿¡æ¯ (seckill:skus)\n  - ç±»å‹ï¼šHash\n  - key: seckill:skus\n  - field: åœºæ¬¡ID_å•†å“ID\n  - value: ç§’æ€å•†å“ä¿¡æ¯\n- ç§’æ€åº“å­˜ä¿¡å·é‡\n  - ç±»å‹ï¼š String\n  - key: seckIll:stock:UUID\n  - value: åº“å­˜æ•°é‡\n\n### å¹‚ç­‰æ€§ä¿è¯\n\n- ç¼“å­˜å•†å“ä¿¡æ¯å‰ï¼Œå…ˆåˆ¤æ–­æœ‰æ²¡æœ‰è¿™ä¸ªkey\n\n```java\n    String redisKey = seckillSkuVo.getPromotionSessionId().toString() + \"-\" + seckillSkuVo.getSkuId().toString();\n            if (!operations.hasKey(redisKey)) {\n              //åˆ¤æ–­Redisä¸­æ˜¯å¦æœ‰è¯¥ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰æ‰è¿›è¡Œæ·»åŠ \n                Boolean hasKey = redisTemplate.hasKey(key);\n                //ç¼“å­˜æ´»åŠ¨ä¿¡æ¯\n                if (!hasKey) {\n```\n\n### Redissionåˆ†å¸ƒå¼é”\n\n- è®¾ç½®åˆ†å¸ƒå¼é”ä»¥åŠä¿¡å·é‡-å…³é”®ä»£ç \n\n```java\n    //ç§’æ€å•†å“ä¸Šæ¶åŠŸèƒ½çš„é”\n    private final String upload_lock = \"seckill:upload:lock\";\n    \n  //åˆ†å¸ƒå¼é” .å¯é‡å…¥é”ï¼ˆReentrant Lockï¼‰\n        RLock lock = redissonClient.getLock(upload_lock);\n        try {\n            //åŠ é”\n            lock.lock(10, TimeUnit.SECONDS);\n            seckillService.uploadSeckillSkuLatest3Days();\n        }catch (Exception e){\n            e.printStackTrace();\n        }finally {\n            lock.unlock();\n        }\n          //å¦‚æœå½“å‰è¿™ä¸ªåœºæ¬¡çš„å•†å“åº“å­˜ä¿¡æ¯å·²ç»ä¸Šæ¶å°±ä¸éœ€è¦ä¸Šæ¶\n                        //5ã€ä½¿ç”¨åº“å­˜ä½œä¸ºåˆ†å¸ƒå¼Redissonä¿¡å·é‡ï¼ˆé™æµï¼‰\n                        // ä½¿ç”¨åº“å­˜ä½œä¸ºåˆ†å¸ƒå¼ä¿¡å·é‡\n                        RSemaphore semaphore = redissonClient.getSemaphore(SKU_STOCK_SEMAPHORE + token);\n                        // å•†å“å¯ä»¥ç§’æ€çš„æ•°é‡ä½œä¸ºä¿¡å·é‡\n                        semaphore.trySetPermits(seckillSkuVo.getSeckillCount());\n```\n\n## åˆ†å¸ƒå¼äº‹åŠ¡\n\n![image-20230322165148070](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322165148070.png)\n\n- **äº‹åŠ¡ä¿è¯ï¼š**\n\n1. è®¢å•æœåŠ¡å¼‚å¸¸ï¼Œåº“å­˜é”å®šä¸è¿è¡Œï¼Œå…¨éƒ¨å›æ»šï¼Œæ’¤é”€æ“ä½œ\n2. åº“å­˜æœåŠ¡äº‹åŠ¡è‡ªæ²»ï¼Œé”å®šå¤±è´¥å…¨éƒ¨å›æ»šï¼Œè®¢å•æ„Ÿå—åˆ°ï¼Œç»§ç»­å›æ»š\n3. åº“å­˜æœåŠ¡é”å®šæˆåŠŸäº†ï¼Œä½†æ˜¯ç½‘ç»œåŸå› è¿”å›æ•°æ®é€”ä¸­é—®é¢˜ï¼Ÿ\n4. åº“å­˜æœåŠ¡é”å®šæˆåŠŸäº†ï¼Œåº“å­˜æœåŠ¡ä¸‹é¢çš„é€»è¾‘å‘ç”Ÿæ•…éšœï¼Œè®¢å•å›æ»šäº†ï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿ\n\n- **åˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—å®ç°æœ€ç»ˆä¸€è‡´**\n\nåº“å­˜æœåŠ¡é”å®šæˆåŠŸåå‘ç»™æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯ï¼ˆå½“å‰åº“å­˜å·¥ä½œå•ï¼‰ï¼Œè¿‡æ®µæ—¶é—´è‡ªåŠ¨è§£é”ï¼Œè§£é”æ—¶å…ˆæŸ¥è¯¢è®¢å•çš„æ”¯ä»˜çŠ¶æ€ã€‚è§£é”æˆåŠŸä¿®æ”¹åº“å­˜å·¥ä½œå•è¯¦æƒ…é¡¹çŠ¶æ€ä¸ºå·²è§£é”\n\n- 1ã€è¿œç¨‹æœåŠ¡å‡å¤±è´¥ï¼š\n  - è¿œç¨‹æœåŠ¡å…¶å®æˆåŠŸäº†ï¼Œç”±äºç½‘ç»œæ•…éšœç­‰æ²¡æœ‰è¿”å›\n  - å¯¼è‡´ï¼šè®¢å•å›æ»šï¼Œåº“å­˜å´æ‰£å‡\n- 2ã€è¿œç¨‹æœåŠ¡æ‰§è¡Œå®Œæˆï¼Œä¸‹é¢çš„å…¶ä»–æ–¹æ³•å‡ºç°é—®é¢˜\n  - å¯¼è‡´ï¼šå·²æ‰§è¡Œçš„è¿œç¨‹è¯·æ±‚ï¼Œè‚¯å®šä¸èƒ½å›æ»š\n\n### äº‹åŠ¡çš„å‘\n\n- åœ¨åŒä¸€ä¸ªç±»é‡Œé¢ï¼Œç¼–å†™ä¸¤ä¸ªæ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´äº‹åŠ¡è®¾ç½®å¤±æ•ˆã€‚åŸå› æ˜¯æ²¡æœ‰ç”¨åˆ°ä»£ç†å¯¹è±¡çš„ç¼˜æ•…ã€‚\n- è§£å†³ï¼š\n  - 0ï¼‰ã€å¯¼å…¥ spring-boot-starter-aop\n  - 1ï¼‰ã€@EnableTransactionManagement(proxyTargetClass = true)\n  - 2ï¼‰ã€@EnableAspectJAutoProxy(exposeProxy=true)\n  - 3ï¼‰ã€AopContext.currentProxy() è°ƒç”¨æ–¹æ³•\n\n### CAPç†è®º\n\n- Cæ˜¯**ä¸€è‡´æ€§**ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„**æ•°æ®è¦ä¿æŒä¸€è‡´**\n- Aæ˜¯**å¯ç”¨æ€§**ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿèƒ½è¿›è¡Œ**æ•…éšœè½¬ç§»**\n- Pæ˜¯**åˆ†åŒºå®¹é”™æ€§**ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿ**å‡ºç°ç½‘ç»œé—®é¢˜èƒ½æ­£å¸¸è¿è¡Œ**\n- CAPç†è®ºæ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸èƒ½ä¿è¯ä¸‰è€…åŒæ—¶å­˜åœ¨ï¼Œåªèƒ½ä¸¤ä¸¤ç»„åˆ\n\n### BASE ç†è®º\n\n- æ˜¯å¯¹ CAP ç†è®ºçš„å»¶ä¼¸ï¼Œæ€æƒ³æ˜¯å³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼ˆCAP çš„ä¸€è‡´æ€§å°±æ˜¯å¼ºä¸€è‡´æ€§ï¼‰ï¼Œä½†å¯ ä»¥é‡‡ç”¨é€‚å½“çš„é‡‡å–å¼±ä¸€è‡´æ€§ï¼Œå³**æœ€ç»ˆä¸€è‡´æ€§ã€‚**\n\n### åˆ†å¸ƒå¼äº‹åŠ¡å‡ ç§æ–¹æ¡ˆ\n\n- 2PC æ¨¡å¼\n  - æ•°æ®åº“æ”¯æŒçš„ 2PCã€2 phase commit äºŒé˜¶æäº¤ã€‘ï¼Œåˆå«åš XA Transactionsã€‚\n    - ç¬¬ä¸€é˜¶æ®µï¼šäº‹åŠ¡åè°ƒå™¨è¦æ±‚æ¯ä¸ªæ¶‰åŠåˆ°äº‹åŠ¡çš„æ•°æ®åº“é¢„æäº¤(precommit)æ­¤æ“ä½œï¼Œå¹¶åæ˜ æ˜¯ å¦å¯ä»¥æäº¤.\n    - ç¬¬äºŒé˜¶æ®µï¼šäº‹åŠ¡åè°ƒå™¨è¦æ±‚æ¯ä¸ªæ•°æ®åº“æäº¤æ•°æ®ã€‚\n  - **æ€§èƒ½ä¸ç†æƒ³**\n- æŸ”æ€§äº‹åŠ¡-TCC äº‹åŠ¡è¡¥å¿å‹æ–¹æ¡ˆ\n  - ä¸€é˜¶æ®µ prepare è¡Œä¸ºï¼šè°ƒç”¨ è‡ªå®šä¹‰ çš„ prepare é€»è¾‘ã€‚\n  - äºŒé˜¶æ®µ commit è¡Œä¸ºï¼šè°ƒç”¨ è‡ªå®šä¹‰ çš„ commit é€»è¾‘ã€‚\n  - äºŒé˜¶æ®µ rollback è¡Œä¸ºï¼šè°ƒç”¨ è‡ªå®šä¹‰ çš„ rollback é€»è¾‘ã€‚\n  - æ‰€è°“ TCC æ¨¡å¼ï¼Œæ˜¯æŒ‡æ”¯æŒæŠŠ è‡ªå®šä¹‰ çš„åˆ†æ”¯äº‹åŠ¡çº³å…¥åˆ°å…¨å±€äº‹åŠ¡çš„ç®¡ç†ä¸­\n- æŸ”æ€§äº‹åŠ¡-æœ€å¤§åŠªåŠ›é€šçŸ¥å‹æ–¹æ¡ˆ\n  - æŒ‰è§„å¾‹è¿›è¡Œé€šçŸ¥ï¼Œ**ä¸ä¿è¯æ•°æ®ä¸€å®šèƒ½é€šçŸ¥æˆåŠŸï¼Œä½†ä¼šæä¾›å¯æŸ¥è¯¢æ“ä½œæ¥å£è¿›è¡Œæ ¸å¯¹**ã€‚\n  - è¿™ç§ æ–¹æ¡ˆä¸»è¦ç”¨åœ¨ä¸ç¬¬ä¸‰æ–¹ç³»ç»Ÿé€šè®¯æ—¶ï¼Œæ¯”å¦‚ï¼šè°ƒç”¨å¾®ä¿¡æˆ–æ”¯ä»˜å®æ”¯ä»˜åçš„æ”¯ä»˜ç»“æœé€šçŸ¥ã€‚\n  - è¿™ç§ æ–¹æ¡ˆä¹Ÿæ˜¯ç»“åˆ MQ è¿›è¡Œå®ç°ï¼Œä¾‹å¦‚ï¼šé€šè¿‡ MQ å‘é€ http è¯·æ±‚ï¼Œè®¾ç½®æœ€å¤§é€šçŸ¥æ¬¡æ•°ã€‚è¾¾åˆ°é€šçŸ¥æ¬¡æ•°åå³ä¸å†é€šçŸ¥ã€‚\n- æŸ”æ€§äº‹åŠ¡-**å¯é æ¶ˆæ¯**+æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆï¼ˆå¼‚æ­¥ç¡®ä¿å‹ï¼‰\n  - å®ç°ï¼šä¸šåŠ¡å¤„ç†æœåŠ¡åœ¨ä¸šåŠ¡äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œå‘å®æ—¶æ¶ˆæ¯æœåŠ¡è¯·æ±‚å‘é€æ¶ˆæ¯ï¼Œå®æ—¶æ¶ˆæ¯æœåŠ¡åª è®°å½•æ¶ˆæ¯æ•°æ®ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„å‘é€ã€‚ä¸šåŠ¡å¤„ç†æœåŠ¡åœ¨ä¸šåŠ¡äº‹åŠ¡æäº¤ä¹‹åï¼Œå‘å®æ—¶æ¶ˆæ¯æœåŠ¡ç¡® è®¤å‘é€ã€‚åªæœ‰åœ¨å¾—åˆ°ç¡®è®¤å‘é€æŒ‡ä»¤åï¼Œå®æ—¶æ¶ˆæ¯æœåŠ¡æ‰ä¼šçœŸæ­£å‘é€ã€‚\n  - é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼š\n    - 1ã€åšå¥½æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆpulisherï¼Œconsumerã€æ‰‹åŠ¨ ackã€‘ï¼‰\n    - 2ã€æ¯ä¸€ä¸ªå‘é€çš„æ¶ˆæ¯éƒ½åœ¨æ•°æ®åº“åšå¥½è®°å½•ã€‚å®šæœŸå°†å¤±è´¥çš„æ¶ˆæ¯å†æ¬¡å‘é€ä¸€ é\n\n> åˆšæ€§äº‹åŠ¡ï¼šéµå¾ª ACID åŸåˆ™ï¼Œå¼ºä¸€è‡´æ€§ã€‚\n>\n> æŸ”æ€§äº‹åŠ¡ï¼šéµå¾ª BASE ç†è®ºï¼Œæœ€ç»ˆä¸€è‡´æ€§ï¼›\n>\n> ä¸åˆšæ€§äº‹åŠ¡ä¸åŒï¼ŒæŸ”æ€§äº‹åŠ¡å…è®¸ä¸€å®šæ—¶é—´å†…ï¼Œä¸åŒèŠ‚ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†è¦æ±‚æœ€ç»ˆä¸€è‡´ã€‚\n\n## Seata\n\n[Seata æ˜¯ä»€ä¹ˆ](https://seata.io/zh-cn/docs/overview/what-is-seata.html)\n\n### Seataçš„ç†è§£\n\n- Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚\n  - ATæ¨¡å¼ã€‚æ˜¯ä¸€ç§åŸºäº**æœ¬åœ°äº‹åŠ¡+äºŒé˜¶æ®µåè®®**æ¥å®ç°çš„**æœ€ç»ˆæ•°æ®ä¸€è‡´æ€§æ–¹æ¡ˆ**ï¼Œä¹Ÿæ˜¯Seataé»˜è®¤çš„è§£å†³æ–¹æ¡ˆã€‚\n  - TCCæ¨¡å¼ï¼ŒTCCäº‹åŠ¡æ˜¯Try,Confirm,Cancel ä¸‰ä¸ªè¯è¯­çš„ç¼©å†™ï¼Œç®€å•ç†è§£å°±æ˜¯æŠŠ**ä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡é€»è¾‘æ‹†åˆ†æˆä¸‰ä¸ªé˜¶æ®µ**ï¼Œç„¶åé€šè¿‡äº‹åŠ¡ç®¡ç†å™¨åœ¨ä¸šåŠ¡é€»è¾‘å±‚é¢ï¼Œæ ¹æ®æ¯ä¸ªåˆ†æ”¯äº‹åŠ¡çš„æ‰§è¡Œæƒ…å†µåˆ†åˆ«è°ƒç”¨è¯¥ä¸šåŠ¡çš„Confirm æˆ–è€…Cacelæ–¹æ³•ã€‚\n  - Sagaæ¨¡å¼ï¼ŒSagaæ¨¡å¼æ˜¯SEATAæä¾›**é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆ**ï¼Œåœ¨Sagaæ¨¡å¼ä¸­ï¼Œä¸šåŠ¡æµç¨‹ä¸­æ¯ä¸ªå‚ä¸è€…éƒ½æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œå½“å‡ºç°æŸä¸€ä¸ªå‚ä¸è€…å¤±è´¥åˆ™è¡¥å¿å‰é¢å·²ç»æˆåŠŸçš„å‚ä¸è€…ã€‚\n  - XAæ¨¡å¼ï¼ŒXAå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§**å¼ºä¸€è‡´æ€§çš„äº‹åŠ¡è§£å†³æ–¹æ³•**ï¼Œå®ƒåˆ©ç”¨äº‹åŠ¡èµ„æºï¼ˆæ•°æ®åº“ï¼Œæ¶ˆæ¯æœåŠ¡ç­‰ï¼‰å¯¹XAåè®®çš„æ”¯æŒï¼Œä»¥XAåè®®çš„æœºåˆ¶æ¥ç®¡ç†åˆ†æ”¯äº‹åŠ¡çš„ä¸€ç§äº‹åŠ¡æ¨¡å¼ã€‚\n\n> [Seata æ˜¯ä»€ä¹ˆ](https://seata.io/zh-cn/docs/overview/what-is-seata.html)\n>\n> - #### TC (Transaction Coordinator) - äº‹åŠ¡åè°ƒè€…\n>\n>   - ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚\n>\n> - #### TM (Transaction Manager) - äº‹åŠ¡ç®¡ç†å™¨\n>\n>   - å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼šå¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚\n>\n> - #### RM (Resource Manager) - èµ„æºç®¡ç†å™¨\n>\n>   - ç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚\n>\n> ![image-20230322152804762](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322152804762.png)\n\n### Seataé¡¹ç›®æ•´åˆ\n\n- Seataæ§åˆ¶åˆ†å¸ƒå¼äº‹åŠ¡\n- 1ï¼‰ã€æ¯ä¸€ä¸ªå¾®æœåŠ¡å…ˆå¿…é¡»åˆ›å»º undo_logï¼›\n- 2ï¼‰ã€å®‰è£…äº‹åŠ¡åè°ƒå™¨ï¼›seata-serverï¼š https://github.com/seata/seata/releases\n- 3ï¼‰ã€æ•´åˆ\n  - 1ã€å¯¼å…¥ä¾èµ– spring-cloud-starter-alibaba-seata seata-all-0.7.1\n  - 2ã€è§£å‹å¹¶å¯åŠ¨seata-serverï¼›\n    - registry.conf: æ³¨å†Œä¸­å¿ƒé…ç½®ï¼› ä¿®æ”¹registry type=nacos\n    - file.confï¼š\n  - 3ã€æ‰€æœ‰æƒ³è¦ç”¨åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„å¾®æœåŠ¡ä½¿ç”¨seata DataSourceProxyä»£ç†è‡ªå·±çš„æ•°æ®æº\n  - 4ã€æ¯ä¸ªå¾®æœåŠ¡ï¼Œéƒ½å¿…é¡»å¯¼å…¥\n    - registry.conf\n    - file.conf vgroup_mapping.{application.name}-fescar-service-group = â€œdefaultâ€\n  - 5ã€å¯åŠ¨æµ‹è¯•åˆ†å¸ƒå¼äº‹åŠ¡\n  - 6ã€ç»™åˆ†å¸ƒå¼å¤§äº‹åŠ¡çš„å…¥å£æ ‡æ³¨@GlobalTransactional\n  - 7ã€æ¯ä¸€ä¸ªè¿œç¨‹çš„å°äº‹åŠ¡ç”¨ @Transactional\n\nåº”ç”¨åœºæ™¯ï¼š\n\n- è®¢å•æœåŠ¡æäº¤è®¢å•ï¼Œåº“å­˜æœåŠ¡æ‰£å‡åº“å­˜\n  - seta-æäº¤è®¢å•æ¥å£ OrderServiceImpl ç±»submitOrderï¼ˆï¼‰æ–¹æ³• åŠ  @GlobalTransactional\n  - ï¼ˆä¸‹å•æ˜¯é«˜å¹¶å‘åœºæ™¯ï¼Œä¸æ¨èseataåˆ†å¸ƒå¼äº‹åŠ¡ã€‚æ¨èç”¨æ¶ˆæ¯é˜Ÿåˆ— æœ€ç»ˆä¸€è‡´æ€§ï¼‰\n- å•†å“æœåŠ¡ä¿æŒå•†å“ä¿¡æ¯ï¼Œè¿œç¨‹è°ƒç”¨ä¼˜æƒ æœåŠ¡ä¿æŒå•†å“ä¼˜æƒ åˆ¸ä¿¡æ¯\n- - å¼€å¯setaå…¨å±€äº‹åŠ¡-SpuInfoServiceImplç±»saveSpuInfo()æ–¹æ³• ï¼ˆæ¨èï¼‰\n\n\n\n## Sentinel\n\n[ä»‹ç» Â· alibaba/Sentinel Wiki Â· GitHub](https://github.com/alibaba/Sentinel/wiki/ä»‹ç»)\n\n### Sentinelç†è§£\n\n- éšç€å¾®æœåŠ¡çš„æµè¡Œï¼ŒæœåŠ¡å’ŒæœåŠ¡ä¹‹é—´çš„ç¨³å®šæ€§å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚Sentinel ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»**æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§**ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚\n- æˆ‘ä»¬è¯´çš„èµ„æºï¼Œå¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿ï¼ŒæœåŠ¡ï¼ŒæœåŠ¡é‡Œçš„æ–¹æ³•ï¼Œç”šè‡³æ˜¯ä¸€æ®µä»£ç ã€‚ä½¿ç”¨ Sentinel æ¥è¿›è¡Œèµ„æºä¿æŠ¤ï¼Œä¸»è¦åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤:\n  1. å®šä¹‰èµ„æº\n  2. å®šä¹‰è§„åˆ™\n  3. æ£€éªŒè§„åˆ™æ˜¯å¦ç”Ÿæ•ˆ\n- Sentinel åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†:\n  - æ ¸å¿ƒåº“ï¼ˆJava å®¢æˆ·ç«¯ï¼‰ä¸ä¾èµ–ä»»ä½•æ¡†æ¶/åº“ï¼Œèƒ½å¤Ÿè¿è¡Œäºæ‰€æœ‰ Java è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒæ—¶ å¯¹ Dubbo / Spring Cloud ç­‰æ¡†æ¶ä¹Ÿæœ‰è¾ƒå¥½çš„æ”¯æŒã€‚\n  - æ§åˆ¶å°ï¼ˆDashboardï¼‰åŸºäº Spring Boot å¼€å‘ï¼Œæ‰“åŒ…åå¯ä»¥ç›´æ¥è¿è¡Œï¼Œä¸éœ€è¦é¢å¤–çš„ Tomcat ç­‰åº”ç”¨å®¹å™¨\n\n### ç†”æ–­é™çº§é™æµ\n\n- ç†”æ–­\n  - A æœåŠ¡è°ƒç”¨ B æœåŠ¡çš„æŸä¸ªåŠŸèƒ½ï¼ŒBæœåŠ¡å¡æ­»ï¼ŒåŠŸèƒ½æ—¶é—´è¶…é•¿ï¼Œæˆ‘ä»¬å°±å°†Bæ–­è·¯ï¼Œè¿”å›é™çº§æ•°æ®ã€‚\n- é™çº§\n  - æµé‡é«˜å³°æœŸï¼ŒæœåŠ¡å™¨å‹åŠ›å‰§å¢ï¼Œå¯¹ä¸€äº›é¡µé¢å’ŒæœåŠ¡åšç­–ç•¥çš„é™çº§ï¼ˆåœæ­¢æœåŠ¡ï¼Œè°ƒç”¨ç›´æ¥è¿”å›é™çº§æ•°æ®ï¼‰\n- ç†”æ–­ã€é™çº§åŒºåˆ«\n  - ç›¸åŒç‚¹\n    - ä¿è¯æœåŠ¡çš„å¯ç”¨æ€§\n  - ä¸åŒç‚¹\n    - 1ã€ç†”æ–­æ˜¯è¢«è°ƒç”¨æ–¹æ•…éšœï¼Œè§¦å‘çš„ç³»ç»Ÿä¸»åŠ¨è§„åˆ™\n    - 2ã€é™çº§æ˜¯åŸºäºå…¨å±€è€ƒè™‘ï¼Œåœæ­¢ä¸€äº›æ­£å¸¸æœåŠ¡ï¼Œé‡Šæ”¾èµ„æº\n- é™æµ\n  - å¯¹æ‰“å…¥æœåŠ¡çš„è¯·æ±‚æµé‡è¿›è¡Œæ§åˆ¶ï¼Œä½¿æœåŠ¡èƒ½å¤Ÿæ‰¿æ‹…ä¸è¶…è¿‡è‡ªå·±èƒ½åŠ›çš„æµé‡å‹åŠ›\n\n### é¡¹ç›®æ•´åˆæ­¥éª¤\n\n```java\n/**\n\n * 1ã€æ•´åˆSentinel\n * 1ï¼‰ã€å¯¼å…¥ä¾èµ– spring-cloud-starter-alibaba-sentinel\n * 2ï¼‰ã€ä¸‹è½½sentinelçš„æ§åˆ¶å°\n * 3ï¼‰ã€é…ç½®sentinelæ§åˆ¶å°åœ°å€ä¿¡æ¯\n * 4) ã€åœ¨æ§åˆ¶å°è°ƒæ•´å‚æ•°ã€‚ã€é»˜è®¤æ‰€æœ‰çš„æµæ§è®¾ç½®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œé‡å¯å¤±æ•ˆã€‘\n      *\n       *\n * 2ã€æ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½å¯¼å…¥ actuator ()ï¼›å¹¶é…åˆmanagement.endpoints.web.exposure.include=*\n * 3ã€è‡ªå®šä¹‰sentinelæµæ§è¿”å›æ•°æ®\n   *\n * 4ã€ä½¿ç”¨Sentinelæ¥ä¿æŠ¤feignè¿œç¨‹è°ƒç”¨ï¼šç†”æ–­ï¼›\n * 1ï¼‰ã€è°ƒç”¨æ–¹çš„ç†”æ–­ä¿æŠ¤ï¼šfeign.sentinel.enabled=true\n * 2ï¼‰ã€è°ƒç”¨æ–¹æ‰‹åŠ¨æŒ‡å®šè¿œç¨‹æœåŠ¡çš„é™çº§ç­–ç•¥ã€‚è¿œç¨‹æœåŠ¡è¢«é™çº§å¤„ç†ã€‚è§¦å‘æˆ‘ä»¬çš„ç†”æ–­å›è°ƒæ–¹æ³•\n * 3ï¼‰ã€è¶…å¤§æµè§ˆçš„æ—¶å€™ï¼Œå¿…é¡»ç‰ºç‰²ä¸€äº›è¿œç¨‹æœåŠ¡ã€‚åœ¨æœåŠ¡çš„æä¾›æ–¹ï¼ˆè¿œç¨‹æœåŠ¡ï¼‰æŒ‡å®šé™çº§ç­–ç•¥ï¼›\n * æä¾›æ–¹æ˜¯åœ¨è¿è¡Œã€‚ä½†æ˜¯ä¸è¿è¡Œè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿”å›çš„æ˜¯é»˜è®¤çš„é™çº§æ•°æ®ï¼ˆé™æµçš„æ•°æ®ï¼‰ï¼Œ\n    *\n * 5ã€è‡ªå®šä¹‰å—ä¿æŠ¤çš„èµ„æº\n * 1ï¼‰ã€ä»£ç \n * try(Entry entry = SphU.entry(\"seckillSkus\")){\n * //ä¸šåŠ¡é€»è¾‘\n * }\n * catch(Execption e){}\n    *\n * 2ï¼‰ã€åŸºäºæ³¨è§£ã€‚\n * @SentinelResource(value = \"getCurrentSeckillSkusResource\",blockHandler = \"blockHandler\")\n    *\n * æ— è®ºæ˜¯1,2æ–¹å¼ä¸€å®šè¦é…ç½®è¢«é™æµä»¥åçš„é»˜è®¤è¿”å›.\n * urlè¯·æ±‚å¯ä»¥è®¾ç½®ç»Ÿä¸€è¿”å›:WebCallbackManager\n    *\n    *\n    */\n```\n\n### æ•´åˆ Feign+Sentinel æµ‹è¯•ç†”æ–­é™çº§\n\n- å¼•å…¥ä¾èµ–ï¼š>spring-cloud-starter-openfeignã€spring-cloud-starter-alibaba-sentinel<\n\n- 2ã€ä½¿ç”¨ Nacos æ³¨å†Œä¸­å¿ƒ spring-cloud-starter-alibaba-nacos-discovery\n\n- å®šä¹‰ fallbackfactory å¹¶æ”¾åœ¨å®¹å™¨ä¸­\n\n  ```java\n     /**\n     \n      * @Author zly\n     \n      * @Date 2022/7/26 16:22\n        */\n        @Slf4j\n        @Component\n        public class SeckillFeignServiceFallBack implements SeckillFeignService {\n     \n        @Override\n        public R getSkuSeckilInfo(Long skuId) {\n            log.info(\"ç†”æ–­æ–¹æ³•è°ƒç”¨..\");\n            return R.error(BizCodeEnum.TO_MANY_REQUEST.getCode(),BizCodeEnum.TO_MANY_REQUEST.getMessage());\n        }\n    }\n  ```\n\n- è¿œç¨‹æ¥å£é…ç½® feign å®¢æˆ·ç«¯å®¹é”™\n\n  ```java\n    /**\n     * @Author zly\n     * @Date 2022/7/26 16:21\n     */\n    @FeignClient(value = \"gulimall-seckill\",fallback = SeckillFeignServiceFallBack.class)\n    public interface SeckillFeignService {\n    \n        /**\n         * æ ¹æ®skuIdæŸ¥è¯¢å•†å“æ˜¯å¦å‚åŠ ç§’æ€æ´»åŠ¨\n         * @param skuId\n         * @return\n         */\n        @GetMapping(value = \"/sku/seckill/{skuId}\")\n        R getSkuSeckilInfo(@PathVariable(\"skuId\") Long skuId);\n    \n    }\n  ```\n\n- å¼€å¯ sentinel ä»£ç† feign åŠŸèƒ½ï¼›åœ¨ application.properties ä¸­é…ç½®\n\n  - feign.sentinel.enabled=true\n\n  > [æ³¨è§£æ”¯æŒ Â· alibaba/Sentinel Wiki Â· GitHub](https://github.com/alibaba/Sentinel/wiki/æ³¨è§£æ”¯æŒ)\n  >\n  > 1ã€ä½¿ç”¨@SentinelResourceï¼Œå¹¶å®šä¹‰ fallback\n  >\n  > ```java\n  > com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl\n  > @SentinelResource(value = \"getCurrentSeckillSkusResource\",blockHandler = \"blockHandler\")\n  > @Override\n  > public List<SeckillSkuRedisTo> getCurrentSeckillSkus() {\n  > \n  > }\n  > ```\n  >\n  > \n\n  \n\n## Nacos\n\n> [Nacos Spring Cloud](https://nacos.io/zh-cn/docs/use-nacos-with-springcloud.html)\n\n### é¡¹ç›®æ•´åˆ\n\n```java\n/**\n * 1ã€å¦‚ä½•ä½¿ç”¨Nacosä½œä¸ºé…ç½®ä¸­å¿ƒç»Ÿä¸€ç®¡ç†é…ç½®\n *\n * 1ï¼‰ã€å¼•å…¥ä¾èµ–ï¼Œ\n *         <dependency>\n *             <groupId>com.alibaba.cloud</groupId>\n *             <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>\n *         </dependency>\n * 2ï¼‰ã€åˆ›å»ºä¸€ä¸ªbootstrap.propertiesã€‚\n *      spring.application.name=gulimall-coupon\n *      spring.cloud.nacos.config.server-addr=127.0.0.1:8848\n * 3ï¼‰ã€éœ€è¦ç»™é…ç½®ä¸­å¿ƒé»˜è®¤æ·»åŠ ä¸€ä¸ªå« æ•°æ®é›†ï¼ˆData Idï¼‰gulimall-coupon.propertiesã€‚é»˜è®¤è§„åˆ™ï¼Œåº”ç”¨å.properties\n * 4ï¼‰ã€ç»™ åº”ç”¨å.properties æ·»åŠ ä»»ä½•é…ç½®\n * 5ï¼‰ã€åŠ¨æ€è·å–é…ç½®ã€‚\n *      @RefreshScopeï¼šåŠ¨æ€è·å–å¹¶åˆ·æ–°é…ç½®\n *      @Value(\"${é…ç½®é¡¹çš„å}\")ï¼šè·å–åˆ°é…ç½®ã€‚\n *      å¦‚æœé…ç½®ä¸­å¿ƒå’Œå½“å‰åº”ç”¨çš„é…ç½®æ–‡ä»¶ä¸­éƒ½é…ç½®äº†ç›¸åŒçš„é¡¹ï¼Œä¼˜å…ˆä½¿ç”¨é…ç½®ä¸­å¿ƒçš„é…ç½®ã€‚\n *\n * 2ã€ç»†èŠ‚\n *  1ï¼‰ã€å‘½åç©ºé—´ï¼šé…ç½®éš”ç¦»ï¼›\n *      é»˜è®¤ï¼špublic(ä¿ç•™ç©ºé—´)ï¼›é»˜è®¤æ–°å¢çš„æ‰€æœ‰é…ç½®éƒ½åœ¨publicç©ºé—´ã€‚\n *      1ã€å¼€å‘ï¼Œæµ‹è¯•ï¼Œç”Ÿäº§ï¼šåˆ©ç”¨å‘½åç©ºé—´æ¥åšç¯å¢ƒéš”ç¦»ã€‚\n *         æ³¨æ„ï¼šåœ¨bootstrap.propertiesï¼›é…ç½®ä¸Šï¼Œéœ€è¦ä½¿ç”¨å“ªä¸ªå‘½åç©ºé—´ä¸‹çš„é…ç½®ï¼Œ\n *         spring.cloud.nacos.config.namespace=9de62e44-cd2a-4a82-bf5c-95878bd5e871\n *      2ã€æ¯ä¸€ä¸ªå¾®æœåŠ¡ä¹‹é—´äº’ç›¸éš”ç¦»é…ç½®ï¼Œæ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½åˆ›å»ºè‡ªå·±çš„å‘½åç©ºé—´ï¼ŒåªåŠ è½½è‡ªå·±å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰é…ç½®\n *\n *  2ï¼‰ã€é…ç½®é›†ï¼šæ‰€æœ‰çš„é…ç½®çš„é›†åˆ\n *\n *  3ï¼‰ã€é…ç½®é›†IDï¼šç±»ä¼¼æ–‡ä»¶åã€‚\n *      Data IDï¼šç±»ä¼¼æ–‡ä»¶å\n *\n *  4ï¼‰ã€é…ç½®åˆ†ç»„ï¼š\n *      é»˜è®¤æ‰€æœ‰çš„é…ç½®é›†éƒ½å±äºï¼šDEFAULT_GROUPï¼›\n *      1111ï¼Œ618ï¼Œ1212\n *\n * é¡¹ç›®ä¸­çš„ä½¿ç”¨ï¼šæ¯ä¸ªå¾®æœåŠ¡åˆ›å»ºè‡ªå·±çš„å‘½åç©ºé—´ï¼Œä½¿ç”¨é…ç½®åˆ†ç»„åŒºåˆ†ç¯å¢ƒï¼Œdevï¼Œtestï¼Œprod\n *\n * 3ã€åŒæ—¶åŠ è½½å¤šä¸ªé…ç½®é›†\n * 1)ã€å¾®æœåŠ¡ä»»ä½•é…ç½®ä¿¡æ¯ï¼Œä»»ä½•é…ç½®æ–‡ä»¶éƒ½å¯ä»¥æ”¾åœ¨é…ç½®ä¸­å¿ƒä¸­\n * 2ï¼‰ã€åªéœ€è¦åœ¨bootstrap.propertiesè¯´æ˜åŠ è½½é…ç½®ä¸­å¿ƒä¸­å“ªäº›é…ç½®æ–‡ä»¶å³å¯\n * 3ï¼‰ã€@Valueï¼Œ@ConfigurationPropertiesã€‚ã€‚ã€‚\n * ä»¥å‰SpringBootä»»ä½•æ–¹æ³•ä»é…ç½®æ–‡ä»¶ä¸­è·å–å€¼ï¼Œéƒ½èƒ½ä½¿ç”¨ã€‚\n * é…ç½®ä¸­å¿ƒæœ‰çš„ä¼˜å…ˆä½¿ç”¨é…ç½®ä¸­å¿ƒä¸­çš„ï¼Œ\n *\n /**\n * 1ã€å¼€å¯æœåŠ¡æ³¨å†Œå‘ç°\n *  (é…ç½®nacosçš„æ³¨å†Œä¸­å¿ƒåœ°å€)\n * 2ã€ç¼–å†™ç½‘å…³é…ç½®æ–‡ä»¶\n */\n```\n\n### Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼š\n\n- å°†å¾®æœåŠ¡æ³¨å†Œåˆ° nacos ä¸­\n\n- 1ã€é¦–å…ˆï¼Œä¿®æ”¹ pom.xml æ–‡ä»¶ï¼Œå¼•å…¥ Nacos Discovery Starterã€‚\n\n- 2ã€åœ¨åº”ç”¨çš„ /src/main/resources/application.properties é…ç½®æ–‡ ä»¶ä¸­é…ç½® Nacos Server åœ°å€\n\n   ```properties\n    spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848\n   ```\n\n- 3ã€ä½¿ç”¨@EnableDiscoveryClient å¼€å¯æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½\n\n- 4ã€å¯åŠ¨åº”ç”¨ï¼Œè§‚å¯Ÿ nacos æœåŠ¡åˆ—è¡¨æ˜¯å¦å·²ç»æ³¨å†Œä¸ŠæœåŠ¡\n\n  - > æ³¨æ„ï¼šæ¯ä¸€ä¸ªåº”ç”¨éƒ½åº”è¯¥æœ‰åå­—ï¼Œè¿™æ ·æ‰èƒ½æ³¨å†Œä¸Šå»ã€‚ä¿®æ”¹ application.properties æ–‡ä»¶\n    >\n    > spring.application.name=service-provider\n    >\n    > server.port=8000\n\n- 5ã€æ³¨å†Œæ›´å¤šçš„æœåŠ¡ä¸Šå»ï¼Œæµ‹è¯•ä½¿ç”¨ feign è¿œç¨‹è°ƒç”¨\n\n  - > Nacos ä½¿ç”¨ä¸‰æ­¥\n    >\n    > 1ã€å¯¼åŒ… nacos-discovery\n    >\n    > 2ã€å†™é…ç½®ï¼ŒæŒ‡å®š nacos åœ°å€ï¼ŒæŒ‡å®šåº”ç”¨çš„åå­—\n    >\n    > 3ã€å¼€å¯æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½@EnableDiscoveryClient\n    >\n    > Feign ä½¿ç”¨ä¸‰æ­¥\n    >\n    > 1ã€å¯¼åŒ… openfeign\n    >\n    > 2ã€å¼€å¯@EnableFeignClients åŠŸèƒ½\n    >\n    > 3ã€ç¼–å†™æ¥å£ï¼Œè¿›è¡Œè¿œç¨‹è°ƒç”¨\n\n### Nacosä½œä¸ºé…ç½®ä¸­å¿ƒ\n\n- 1ã€pom.xml å¼•å…¥ Nacos Config Starterã€‚\n\n- 2ã€åœ¨åº”ç”¨çš„ /src/main/resources/bootstrap.properties é… ç½®æ–‡ä»¶ä¸­é…ç½® Nacos Config å…ƒæ•°æ®\n\n  ```properties\n    spring.application.name=nacos-config-example\n    spring.cloud.nacos.config.server-addr=127.0.0.1:8848\n    #æŒ‡å®šå‘½åç©ºé—´\n    spring.cloud.nacos.config.namespace=af7b6638-68dd-43a0-8bef-19dbaf2ae5c3 \n    #æŒ‡å®šåˆ†ç»„  é»˜è®¤DEFAULT_GROUP\n    spring.cloud.nacos.config.group=dev\n    #ä¸»è¦é…ç½®åº”ç”¨åå’Œé…ç½®ä¸­å¿ƒåœ°å€\n  ```\n\n- 3ã€åœ¨ nacos ä¸­æ·»åŠ é…ç½®\n\n  - åœ¨ nacos ä¸­åˆ›å»ºä¸€ä¸ª **åº”ç”¨å.properties** é…ç½®æ–‡ä»¶å¹¶ç¼–å†™é…ç½®\n\n  - > **Nacos Config** **æ•°æ®ç»“æ„**\n    >\n    > Nacos Config ä¸»è¦é€šè¿‡ dataId å’Œ group æ¥å”¯ä¸€ç¡®å®šä¸€æ¡é…ç½®ã€‚\n    >\n    > Nacos Client ä» Nacos Server ç«¯è·å–æ•°æ®æ—¶ï¼Œè°ƒç”¨çš„æ˜¯æ­¤æ¥å£ ConfigService.getConfig(String dataId, String group, long timeoutMs)ã€‚\n    >\n    > **Spring Cloud** **åº”ç”¨è·å–æ•°æ®**\n    >\n    > **dataID**:\n    >\n    > åœ¨ Nacos Config Starter ä¸­ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å¦‚ä¸‹\n    >\n    > - ${prefix} - ${spring.profiles.active} . ${file-extension} prefix é»˜è®¤ä¸º spring.application.name çš„å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.prefix æ¥é…ç½®ã€‚\n    > - spring.profiles.active å³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profile\n    >\n    > æ³¨æ„ï¼Œå½“ activeprofile ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦ - ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å˜æˆ prefix . {prefix}.*p**re**f**i**x*.{file-extension}\n    >\n    > file-extension ä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.file-extension æ¥é…ç½®ã€‚ ç›®å‰åªæ”¯æŒ properties ç±»å‹ã€‚\n    >\n    > **Group**ï¼š\n    >\n    > Group é»˜è®¤ä¸º DEFAULT_GROUPï¼Œå¯ä»¥é€šè¿‡ spring.cloud.nacos.config.group é…ç½®ã€‚\n\n- 4ã€åœ¨åº”ç”¨ä¸­ä½¿ç”¨@Value å’Œ@RefreshScope\n\n  - > å®Œæˆä¸Šè¿°ä¸¤æ­¥åï¼Œåº”ç”¨ä¼šä» Nacos Config ä¸­è·å–ç›¸åº”çš„é…ç½®ï¼Œå¹¶æ·»åŠ åœ¨ Spring Environment\n    >\n    > çš„ PropertySources ä¸­ ã€‚ è¿™ é‡Œ æˆ‘ ä»¬ ä½¿ ç”¨ @Value æ³¨ è§£ æ¥ å°† å¯¹ åº” çš„ é… ç½® æ³¨ å…¥ åˆ°\n    >\n    > SampleController çš„ userName å’Œ age å­—æ®µï¼Œå¹¶æ·»åŠ  @RefreshScope æ‰“å¼€åŠ¨æ€åˆ·æ–°åŠŸèƒ½\n    >\n    > **@RefreshScope**\n    >\n    > class SampleController {\n    >\n    > **@Value(â€œ${user.name}â€)**\n    >\n    > String userName;\n    >\n    > **@Value(â€œ${user.age}â€)**\n    >\n    > int age;\n    >\n    > }\n\n### Nacosè¿›é˜¶\n\n- **æ ¸å¿ƒæ¦‚å¿µ**\n\n  - **å‘½åç©ºé—´ï¼šé…ç½®éš”ç¦»**\n\n    - ç”¨äºè¿›è¡Œç§Ÿæˆ·ç²’åº¦çš„é…ç½®éš”ç¦»ã€‚ä¸åŒçš„å‘½åç©ºé—´ä¸‹ï¼Œå¯ä»¥å­˜åœ¨ç›¸åŒçš„ **Group** æˆ– **Data ID** çš„\n\n      é…ç½®ã€‚**Namespace** çš„å¸¸ç”¨åœºæ™¯ä¹‹ä¸€æ˜¯ä¸åŒç¯å¢ƒçš„é…ç½®çš„åŒºåˆ†éš”ç¦»ï¼Œä¾‹å¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒå’Œç”Ÿ\n\n      äº§ç¯å¢ƒçš„èµ„æºï¼ˆå¦‚é…ç½®ã€æœåŠ¡ï¼‰éš”ç¦»ç­‰\n\n  - **é…ç½®é›†ï¼šæ‰€æœ‰é…ç½®çš„é›†åˆ**\n\n    - ä¸€ç»„ç›¸å…³æˆ–è€…ä¸ç›¸å…³çš„é…ç½®é¡¹çš„é›†åˆç§°ä¸ºé…ç½®é›†ã€‚åœ¨ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªé…ç½®æ–‡ä»¶é€šå¸¸å°±æ˜¯ä¸€ä¸ªé…\n\n      ç½®é›†ï¼ŒåŒ…å«äº†ç³»ç»Ÿå„ä¸ªæ–¹é¢çš„é…ç½®ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªé…ç½®é›†å¯èƒ½åŒ…å«äº†æ•°æ®æºã€çº¿ç¨‹æ± ã€æ—¥å¿—çº§\n\n      åˆ«ç­‰é…ç½®é¡¹ã€‚\n\n  - **é…ç½®é›†IDï¼šç±»ä¼¼æ–‡ä»¶åã€‚**\n\n    - Nacos ä¸­çš„æŸä¸ªé…ç½®é›†çš„ IDã€‚é…ç½®é›† ID æ˜¯ç»„ç»‡åˆ’åˆ†é…ç½®çš„ç»´åº¦ä¹‹ä¸€ã€‚**Data ID** é€šå¸¸ç”¨äºç»„\n\n      ç»‡åˆ’åˆ†ç³»ç»Ÿçš„é…ç½®é›†ã€‚ä¸€ä¸ªç³»ç»Ÿæˆ–è€…åº”ç”¨å¯ä»¥åŒ…å«å¤šä¸ªé…ç½®é›†ï¼Œæ¯ä¸ªé…ç½®é›†éƒ½å¯ä»¥è¢«ä¸€ä¸ªæœ‰\n\n      æ„ä¹‰çš„åç§°æ ‡è¯†ã€‚Data ID é€šå¸¸é‡‡ç”¨ç±» Java åŒ…ï¼ˆå¦‚ com.taobao.tc.refund.log.levelï¼‰çš„å‘½å\n\n      è§„åˆ™ä¿è¯å…¨å±€å”¯ä¸€æ€§ã€‚æ­¤å‘½åè§„åˆ™éå¼ºåˆ¶ã€‚\n\n  - **é…ç½®åˆ†ç»„ï¼šé»˜è®¤æ‰€æœ‰çš„é…ç½®é›†éƒ½å±äºï¼šDEFAULT_GROUPï¼›**\n\n    - Nacos ä¸­çš„ä¸€ç»„é…ç½®é›†ï¼Œæ˜¯ç»„ç»‡é…ç½®çš„ç»´åº¦ä¹‹ä¸€ã€‚é€šè¿‡ä¸€ä¸ªæœ‰æ„ä¹‰çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ Buy æˆ–\n\n      Trade ï¼‰å¯¹é…ç½®é›†è¿›è¡Œåˆ†ç»„ï¼Œä»è€ŒåŒºåˆ† Data ID ç›¸åŒçš„é…ç½®é›†ã€‚å½“æ‚¨åœ¨ Nacos ä¸Šåˆ›å»ºä¸€ä¸ª\n\n      é…ç½®æ—¶ï¼Œå¦‚æœæœªå¡«å†™é…ç½®åˆ†ç»„çš„åç§°ï¼Œåˆ™é…ç½®åˆ†ç»„çš„åç§°é»˜è®¤é‡‡ç”¨ DEFAULT_GROUP ã€‚é…ç½®\n\n      åˆ†ç»„çš„å¸¸è§åœºæ™¯ï¼šä¸åŒçš„åº”ç”¨æˆ–ç»„ä»¶ä½¿ç”¨äº†ç›¸åŒçš„é…ç½®ç±»å‹ï¼Œå¦‚ database_url é…ç½®å’Œ\n\n      MQ_topic é…ç½®ã€‚\n\n- **åŸç†**\n\n  - è‡ªåŠ¨æ³¨å…¥ï¼š\n    - NacosConfigStarter å®ç°äº† org.springframework.cloud.bootstrap.config.PropertySourceLocator æ¥å£ï¼Œå¹¶å°†ä¼˜å…ˆçº§è®¾ç½®æˆäº†æœ€é«˜ã€‚ åœ¨ Spring Cloud åº”ç”¨å¯åŠ¨é˜¶æ®µï¼Œä¼šä¸»åŠ¨ä» Nacos Server ç«¯è·å–å¯¹åº”çš„æ•°æ®ï¼Œå¹¶å°†è·å–åˆ°çš„ æ•°æ®è½¬æ¢æˆ PropertySource ä¸”æ³¨å…¥åˆ° Environment çš„ PropertySources å±æ€§ä¸­ï¼Œæ‰€ä»¥ä½¿ç”¨ @Value æ³¨è§£ä¹Ÿèƒ½ç›´æ¥è·å– Nacos Server ç«¯é…ç½®çš„å†…å®¹ã€‚\n  - åŠ¨æ€åˆ·æ–°ï¼š\n    - Nacos Config Starter é»˜è®¤ä¸ºæ‰€æœ‰è·å–æ•°æ®æˆåŠŸçš„ Nacos çš„é…ç½®é¡¹æ·»åŠ äº†ç›‘å¬åŠŸèƒ½ï¼Œåœ¨ç›‘å¬ åˆ°æœåŠ¡ç«¯é…ç½®å‘ç”Ÿå˜åŒ–æ—¶ä¼šå®æ—¶è§¦å‘ org.springframework.cloud.context.refresh.ContextRefresher çš„ refresh æ–¹æ³• ã€‚\n    - å¦‚æœéœ€è¦å¯¹ Bean è¿›è¡ŒåŠ¨æ€åˆ·æ–°ï¼Œè¯·å‚ç…§ Spring å’Œ Spring Cloud è§„èŒƒã€‚æ¨èç»™ç±»æ·»åŠ **@RefreshScope** **æˆ–** **@ConfigurationProperties** æ³¨è§£ï¼Œ\n\n- **3ã€åŠ è½½å¤šé…ç½®æ–‡ä»¶**\n\n   ```properties\n    spring.cloud.nacos.config.server-addr=127.0.0.1:8848\n    spring.cloud.nacos.config.namespace=31098de9-fa28-41c9-b0bd-c754ce319ed4 \n    spring.cloud.nacos.config.ext-config[0].data-id=gulimall-datasource.yml \n    #åŠ¨æ€åˆ·æ–°\n    spring.cloud.nacos.config.ext-config[0].refresh=false\n    spring.cloud.nacos.config.ext-config[0].group=dev\n   ```\n\n- **4ã€namespace ä¸ group æœ€ä½³å®è·µ**\n\n  - æ¯ä¸ªå¾®æœåŠ¡åˆ›å»ºè‡ªå·±çš„ namespace è¿›è¡Œéš”ç¦»ï¼Œgroup æ¥åŒºåˆ† devï¼Œbetaï¼Œprod ç­‰ç¯å¢ƒ\n\n## Gateway\n\n> [Spring Cloud Gateway](https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.3.RELEASE/single/spring-cloud-gateway.html)\n\n- ç®€ä»‹\n  - ç½‘å…³ä½œä¸ºæµé‡çš„å…¥å£ï¼Œå¸¸ç”¨åŠŸèƒ½åŒ…æ‹¬è·¯ç”±è½¬å‘ã€æƒé™æ ¡éªŒã€é™æµæ§åˆ¶ç­‰ã€‚\n- ç‰¹ç‚¹\n  - åŸºäº Spring5ï¼Œæ”¯æŒå“åº”å¼ç¼–ç¨‹å’Œ SpringBoot2.0\n  - æ”¯æŒä½¿ç”¨ä»»ä½•è¯·æ±‚å±æ€§è¿›è¡Œè·¯ç”±åŒ¹é…\n  - ç‰¹å®šäºè·¯ç”±çš„æ–­è¨€å’Œè¿‡æ»¤å™¨\n  - é›†æˆ Hystrix è¿›è¡Œæ–­è·¯ä¿æŠ¤\n  - é›†æˆæœåŠ¡å‘ç°åŠŸèƒ½\n  - æ˜“äºç¼–å†™ Predicates å’Œ Filters\n  - æ”¯æŒè¯·æ±‚é€Ÿç‡é™åˆ¶\n  - æ”¯æŒè·¯å¾„é‡å†™\n- APIç½‘å…³ä¼˜ç‚¹\n  - æ˜“äºç›‘æ§ã€‚å¯ä»¥åœ¨ç½‘å…³æ”¶é›†ç›‘æ§æ•°æ®å¹¶å°†å…¶æ¨é€åˆ°å¤–éƒ¨ç³»ç»Ÿè¿›è¡Œåˆ†æã€‚\n  - æ˜“äºè®¤è¯ã€‚å¯ä»¥åœ¨ç½‘å…³ä¸Šè¿›è¡Œè®¤è¯ï¼Œç„¶åå†å°†è¯·æ±‚è½¬å‘åˆ°åç«¯çš„å¾®æœåŠ¡ï¼Œè€Œæ— é¡»åœ¨ æ¯ä¸ªå¾®æœåŠ¡ä¸­è¿›è¡Œè®¤è¯ã€‚\n  - å‡å°‘äº†å®¢æˆ·ç«¯ä¸å„ä¸ªå¾®æœåŠ¡ä¹‹é—´çš„äº¤äº’æ¬¡æ•°ã€‚\n- æ ¸å¿ƒæ¦‚ç‡\n  - è·¯ç”±\n    - è·¯ç”±æ˜¯ç½‘å…³æœ€åŸºç¡€çš„éƒ¨åˆ†ï¼Œè·¯ç”±ä¿¡æ¯æœ‰ä¸€ä¸ª IDã€ä¸€ä¸ªç›®çš„ URLã€ä¸€ç»„æ–­è¨€å’Œä¸€ç»„ Filter ç»„æˆã€‚å¦‚æœæ–­è¨€è·¯ç”±ä¸ºçœŸï¼Œåˆ™è¯´æ˜è¯·æ±‚çš„ URL å’Œé…ç½®åŒ¹é…\n  - æ–­è¨€\n    - Java8 ä¸­çš„æ–­è¨€å‡½æ•°ã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°è¾“å…¥ç±»å‹æ˜¯ Spring5.0 æ¡† æ¶ä¸­çš„ ServerWebExchangeã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é… æ¥è‡ªäº http request ä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰ã€‚\n  - è¿‡æ»¤å™¨\n    - ä¸€ä¸ªæ ‡å‡†çš„ Spring webFilterã€‚Spring cloud gateway ä¸­çš„ filter åˆ†ä¸ºä¸¤ç§ç±»å‹çš„ Filterï¼Œåˆ†åˆ«æ˜¯ Gateway Filter å’Œ Global Filterã€‚è¿‡æ»¤å™¨ Filter å°†ä¼šå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œä¿®æ”¹ å¤„ç†\n  - **æ»¡è¶³æŸäº›æ–­è¨€ï¼ˆpredicatesï¼‰å°±è·¯ç”±åˆ°æŒ‡å®šçš„åœ°å€ï¼ˆuriï¼‰ï¼Œä½¿ç”¨æŒ‡å®šçš„è¿‡æ»¤å™¨ï¼ˆfilterï¼‰**\n\n> ```yaml\n> spring:\n> cloud:\n>  gateway:\n>    routes:\n>         - id: test_route\n>           uri: https://www.baidu.com\n>           predicates:\n>             - Query=url,baidu\n> \n>        - id: product_route\n>           uri: lb://gulimall-product\n>           predicates:\n>             - Path=/api/product/**\n>           filters:\n>             - RewritePath=/api/?(?<segment>.*),/$\\{segment}\n> \n>        - id: gulimall_host_route\n>           uri: lb://gulimall-product\n>           predicates:\n>             - Host=gulimall.com,item.gulimall.com\n> ```\n\n## Feign\n\n**Feign** **å£°æ˜å¼è¿œç¨‹è°ƒç”¨**\n\n- ç®€ä»‹\n\n  - Feign æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ HTTP å®¢æˆ·ç«¯ï¼Œå®ƒçš„ç›®çš„å°±æ˜¯è®©è¿œç¨‹è°ƒç”¨æ›´åŠ ç®€å•ã€‚\n  - Feign æ•´åˆäº† **Ribbonï¼ˆè´Ÿè½½å‡è¡¡ï¼‰å’Œ Hystrix(æœåŠ¡ç†”æ–­)ï¼Œ**\n\n- **ä½¿ç”¨**\n\n  - 1ã€å¼•å…¥ä¾èµ– spring-cloud-starter-openfeign\n\n  - 2ã€å¼€å¯ feign åŠŸèƒ½ @EnableFeignClients(basePackages = â€œcom.atguigu.gulimall.member.feignâ€)\n\n  - 3ã€å£°æ˜è¿œç¨‹æ¥å£\n\n    ```java\n    /**\n    * @Author zly\n    * @Date 2022/7/25 12:04\n    */\n    @FeignClient(\"gulimall-order\")\n    public interface OrderFeignService {\n    /**\n     * åˆ†é¡µæŸ¥è¯¢å½“å‰ç™»å½•ç”¨æˆ·çš„æ‰€æœ‰è®¢å•ä¿¡æ¯\n     * @param params\n     * @return\n     */\n    @PostMapping(\"/order/order/listWithItem\")\n    R listWithItem(@RequestBody Map<String, Object> params);\n    \n    }\n    ```\n\n### Feignè¿œç¨‹è°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´é—®é¢˜\n\n![image-20230410205425533](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410205425533.png)\n\n\n\n\n\n### Feignå¼‚æ­¥æƒ…å†µä¸¢å¤±ä¸Šä¸‹æ–‡é—®é¢˜\n\n![image-20230410205453081](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410205453081.png)\n\n\n\n\n\n\n\n## SpringCloud Alibaba å¸¸ç”¨ç»„ä»¶ç«¯å£å·æ€»ç»“\n\n- Nacos é»˜è®¤ç«¯å£å·ï¼š8848\n\n  ```properties\n  #*************** Spring Boot Related Configurations ***************#\n  ### Default web context path:\n  server.servlet.contextPath=/nacos\n  ### Default web server port:\n  server.port=8848\n  ```\n\n- Seataé»˜è®¤ç«¯å£å·ï¼š8091\n\n- Sentinelæ§åˆ¶å°é»˜è®¤è¿è¡Œåœ¨8080ç«¯å£ä¸Š\n\n> Elasticsearch é»˜è®¤ç«¯å£ 9200 æœç´¢å¼•æ“ ä¸å±äºSpringCloud Alibaba\n\n## æ”¯ä»˜\n\n### åŠ å¯†-å¯¹ç§°åŠ å¯†\n\n![image-20230410190257408](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190257408.png)\n\n### åŠ å¯†-éå¯¹ç§°åŠ å¯†\n\n![image-20230410190307734](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190307734.png)\n\n### æ”¯ä»˜å®éªŒç­¾\n\n![image-20230410201313818](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410201313818.png)\n\n### æ”¶å•\n\n- 1ã€è®¢å•åœ¨æ”¯ä»˜é¡µï¼Œä¸æ”¯ä»˜ï¼Œä¸€ç›´åˆ·æ–°ï¼Œè®¢å•è¿‡æœŸäº†æ‰æ”¯ä»˜ï¼Œè®¢å•çŠ¶æ€æ”¹ä¸ºå·²æ”¯ä»˜äº†ï¼Œä½†æ˜¯åº“å­˜è§£é”äº†ã€‚\n  - ä½¿ç”¨æ”¯ä»˜å®è‡ªåŠ¨æ”¶å•åŠŸèƒ½è§£å†³ã€‚åªè¦ä¸€æ®µæ—¶é—´ä¸æ”¯ä»˜ï¼Œå°±ä¸èƒ½æ”¯ä»˜äº†ã€‚\n- 2ã€ç”±äºæ—¶å»¶ç­‰é—®é¢˜ã€‚è®¢å•è§£é”å®Œæˆï¼Œæ­£åœ¨è§£é”åº“å­˜çš„æ—¶å€™ï¼Œå¼‚æ­¥é€šçŸ¥æ‰åˆ°\n  - è®¢å•è§£é”ï¼Œæ‰‹åŠ¨è°ƒç”¨æ”¶å•\n- 3ã€ç½‘ç»œé˜»å¡é—®é¢˜ï¼Œè®¢å•æ”¯ä»˜æˆåŠŸçš„å¼‚æ­¥é€šçŸ¥ä¸€ç›´ä¸åˆ°è¾¾\n  - æŸ¥è¯¢è®¢å•åˆ—è¡¨æ—¶ï¼Œajaxè·å–å½“å‰æœªæ”¯ä»˜çš„è®¢å•çŠ¶æ€ï¼ŒæŸ¥è¯¢è®¢å•çŠ¶æ€æ—¶ï¼Œå†è·å–ä¸€ä¸‹æ”¯ä»˜å®æ­¤è®¢å•çš„çŠ¶æ€\n- 4ã€å…¶ä»–å„ç§é—®é¢˜\n  - æ¯å¤©æ™šä¸Šé—²æ—¶ä¸‹è½½æ”¯ä»˜å®å¯¹è´¦å•ï¼Œä¸€ä¸€è¿›è¡Œå¯¹è´¦\n\n\n\n\n\n\n\n## MD5&MD5ç›å€¼åŠ å¯†\n\n- MD5\n  - Message Digest algorithm 5ï¼Œä¿¡æ¯æ‘˜è¦ç®—æ³•\n    - å‹ç¼©æ€§ï¼šä»»æ„é•¿åº¦çš„æ•°æ®ï¼Œç®—å‡ºçš„MD5å€¼é•¿åº¦éƒ½æ˜¯å›ºå®šçš„ã€‚\n    - å®¹æ˜“è®¡ç®—ï¼šä»åŸæ•°æ®è®¡ç®—å‡ºMD5å€¼å¾ˆå®¹æ˜“ã€‚\n    - æŠ—ä¿®æ”¹æ€§ï¼šå¯¹åŸæ•°æ®è¿›è¡Œä»»ä½•æ”¹åŠ¨ï¼Œå“ªæ€•åªä¿®æ”¹1ä¸ªå­—èŠ‚ï¼Œæ‰€å¾—åˆ°çš„MD5å€¼éƒ½æœ‰å¾ˆå¤§åŒºåˆ«ã€‚\n    - å¼ºæŠ—ç¢°æ’ï¼šæƒ³æ‰¾åˆ°ä¸¤ä¸ªä¸åŒçš„æ•°æ®ï¼Œä½¿å®ƒä»¬å…·æœ‰ç›¸åŒçš„MD5å€¼ï¼Œæ˜¯éå¸¸å›°éš¾çš„ã€‚\n    - ä¸å¯é€†\n- åŠ ç›ï¼š\n  - é€šè¿‡ç”Ÿæˆéšæœºæ•°ä¸MD5ç”Ÿæˆå­—ç¬¦ä¸²è¿›è¡Œç»„åˆ\n  - æ•°æ®åº“åŒæ—¶å­˜å‚¨MD5å€¼ä¸saltå€¼ã€‚éªŒè¯æ­£ç¡®æ€§æ—¶ä½¿ç”¨saltè¿›è¡ŒMD5å³å¯\n\n\n\n## é¡¹ç›®å¾®æœåŠ¡\n\n![image-20230410191352836](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191352836.png)\n\n## Nginx+Windowsæ­å»ºåŸŸåè®¿é—®ç¯å¢ƒ\n\n![image-20230410191454442](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191454442.png)\n\n### åŸŸåæ˜ å°„æ•ˆæœ\n\n- è¯·æ±‚æ¥å£ gulimall.com\n- è¯·æ±‚é¡µé¢ gulimall.com\n- nginxç›´æ¥ä»£ç†ç»™ç½‘å…³ï¼Œç½‘å…³åˆ¤æ–­\n- å¦‚æœ/api/****ï¼Œè½¬äº¤ç»™å¯¹åº”çš„æœåŠ¡å™¨\n- å¦‚æœæ˜¯ æ»¡è¶³åŸŸåï¼Œè½¬äº¤ç»™å¯¹åº”çš„æœåŠ¡\n\n### æ­£å‘ä»£ç†ä¸åå‘ä»£ç†\n\n- æ­£å‘ä»£ç†ï¼šå¦‚ç§‘å­¦ä¸Šç½‘ï¼Œéšè—å®¢æˆ·ç«¯ä¿¡æ¯\n\n![image-20230410191634342](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191634342.png)\n\n- åå‘ä»£ç†ï¼šå±è”½å†…ç½‘æœåŠ¡å™¨ä¿¡æ¯ï¼Œè´Ÿè½½å‡è¡¡è®¿é—®\n\n![image-20230410191643706](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191643706.png)\n\n### Nginxé…ç½®æ–‡ä»¶\n\n![image-20230410191710095](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191710095.png)\n\n### NginxåŠ¨é™åˆ†ç¦»\n\n![image-20230410191732131](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191732131.png)\n\n### Nginxè½¬å‘æ•ˆæœ\n\n![image-20230410191756149](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191756149.png)\n\n\n\n\n\n\n\n## å†…ç½‘ç©¿é€\n\n![image-20230410190339367](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190339367.png)\n\n![image-20230410190351905](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190351905.png)\n\n### å†…ç½‘ç©¿é€è”è°ƒ\n\n![image-20230410190422986](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190422986.png)\n\n### é…ç½®\n\n- Nginxé…ç½®\n\n...\n\nlisten 80;\nserver_name gulimall.com *.gulimall.com 497n86m7k7.52http.net;\n#charset koi8-r;\n#access_log /var/log/nginx/log/host.access.log main;\nlocation /static/ {\nroot /usr/share/nginx/html;\n}\nlocation /payed/ {\nproxy_set_header Host order.gulimall.com;\nproxy_pass http://gulimall;\n}\n\n...\n\n## ç¼“å­˜\n\n### æœ¬åœ°ç¼“å­˜\n\n\n\n![image-20230410191857648](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191857648.png)\n\n### åˆ†å¸ƒå¼ç¼“å­˜-æœ¬åœ°æ¨¡å¼åœ¨åˆ†å¸ƒå¼ä¸‹çš„é—®é¢˜\n\n![image-20230410191940056](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191940056.png)\n\n### åˆ†å¸ƒå¼ç¼“å­˜\n\n![image-20230410192021777](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192021777.png)\n\n#### é«˜å¹¶å‘ä¸‹ç¼“å­˜å¤±æ•ˆé—®é¢˜-ç¼“å­˜ç©¿é€\n\n![image-20230410192133778](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192133778.png)\n\n- **ç¼“å­˜ç©¿é€**ï¼š\n  - æŒ‡æŸ¥è¯¢ä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ï¼Œç”±äºç¼“å­˜æ˜¯ä¸å‘½ä¸­ï¼Œå°†å»æŸ¥è¯¢æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ä¹Ÿæ— æ­¤è®°å½•ï¼Œæˆ‘ä»¬æ²¡æœ‰å°†è¿™æ¬¡æŸ¥è¯¢çš„nullå†™å…¥ç¼“å­˜ï¼Œè¿™å°†å¯¼è‡´è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆ°å­˜å‚¨å±‚å»æŸ¥è¯¢ï¼Œå¤±å»äº†ç¼“å­˜çš„æ„ä¹‰\n- **é£é™©**ï¼š\n  - åˆ©ç”¨ä¸å­˜åœ¨çš„æ•°æ®è¿›è¡Œæ”»å‡»ï¼Œæ•°æ®åº“ç¬æ—¶å‹åŠ›å¢å¤§ï¼Œæœ€ç»ˆå¯¼è‡´å´©æºƒ\n- **è§£å†³**ï¼š\n  - nullç»“æœç¼“å­˜ï¼Œå¹¶åŠ å…¥çŸ­æš‚è¿‡æœŸæ—¶é—´\n\n#### é«˜å¹¶å‘ä¸‹ç¼“å­˜å¤±æ•ˆé—®é¢˜-ç¼“å­˜é›ªå´©\n\n![image-20230410192133778](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192133778.png)\n\n- **ç¼“å­˜é›ªå´©**ï¼š\n  - ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨æˆ‘ä»¬è®¾ç½®ç¼“å­˜æ—¶keyé‡‡ç”¨äº†ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯¼è‡´ç¼“å­˜åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å¤±æ•ˆï¼Œè¯·æ±‚å…¨éƒ¨è½¬å‘åˆ°DBï¼ŒDBç¬æ—¶å‹åŠ›è¿‡é‡é›ªå´©ã€‚\n\n- **è§£å†³**ï¼š\n  - åŸæœ‰çš„å¤±æ•ˆæ—¶é—´åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªéšæœºå€¼ï¼Œæ¯”å¦‚1-5åˆ†é’Ÿéšæœºï¼Œè¿™æ ·æ¯ä¸€ä¸ªç¼“å­˜çš„è¿‡æœŸæ—¶é—´çš„é‡å¤ç‡å°±ä¼šé™ä½ï¼Œå°±å¾ˆéš¾å¼•å‘é›†ä½“å¤±æ•ˆçš„äº‹ä»¶ã€‚\n\n#### é«˜å¹¶å‘ä¸‹ç¼“å­˜å¤±æ•ˆé—®é¢˜-ç¼“å­˜å‡»ç©¿\n\n![image-20230410192628947](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192628947.png)\n\n- **ç¼“å­˜ç©¿é€**ï¼š\n  - å¯¹äºä¸€äº›è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyï¼Œå¦‚æœè¿™äº›keyå¯èƒ½ä¼šåœ¨æŸäº›æ—¶é—´ç‚¹è¢«è¶…é«˜å¹¶å‘åœ°è®¿é—®ï¼Œæ˜¯ä¸€ç§éå¸¸\"**çƒ­ç‚¹**\"çš„æ•°æ®ã€‚å¦‚æœè¿™ä¸ªkeyåœ¨å¤§é‡è¯·æ±‚åŒæ—¶è¿›æ¥å‰æ­£å¥½å¤±æ•ˆï¼Œé‚£ä¹ˆæ‰€æœ‰å¯¹è¿™ä¸ªkeyçš„æ•°æ®æŸ¥è¯¢éƒ½è½åˆ°dbï¼Œæˆ‘ä»¬ç§°ä¸ºç¼“å­˜å‡»ç©¿ã€‚\n\n- **è§£å†³**ï¼š\n  - åŠ é”\n    - å¤§é‡å¹¶å‘åªè®©ä¸€ä¸ªå»æŸ¥ï¼Œå…¶ä»–äººç­‰å¾…ï¼ŒæŸ¥åˆ°ä»¥åé‡Šæ”¾é”ï¼Œå…¶ä»–äººè·å–åˆ°é”ï¼Œå…ˆæŸ¥ç¼“å­˜ï¼Œå°±ä¼šæœ‰æ•°æ®ï¼Œä¸ç”¨å»db\n\n### åˆ†å¸ƒå¼ä¸‹å¦‚ä½•åŠ é”ï¼Ÿ\n\n![image-20230410192940277](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192940277.png)\n\n- æœ¬åœ°é”ï¼Œåªèƒ½é”ä½å½“å‰è¿›ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ†å¸ƒå¼é”\n\n### é”-æ—¶åºé—®é¢˜\n\n![image-20230410193041285](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193041285.png)\n\n### åˆ†å¸ƒå¼é”æ¼”è¿›-åŸºæœ¬åŸç†\n\n![image-20230410193221079](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193221079.png)\n\n> æˆ‘ä»¬å¯ä»¥åŒæ—¶å»ä¸€ä¸ªåœ°æ–¹â€œå å‘â€ï¼Œå¦‚æœå åˆ°ï¼Œå°±æ‰§è¡Œé€»è¾‘ã€‚å¦åˆ™å°±å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°é‡Šæ”¾é”ã€‚\n> â€œå å‘â€å¯ä»¥å»redisï¼Œå¯ä»¥å»æ•°æ®åº“ï¼Œå¯ä»¥å»ä»»ä½•å¤§å®¶éƒ½èƒ½è®¿é—®çš„åœ°æ–¹ã€‚\n> ç­‰å¾…å¯ä»¥è‡ªæ—‹çš„æ–¹å¼ã€‚\n\n#### åˆ†å¸ƒå¼é”æ¼”è¿›-é˜¶æ®µä¸€\n\n![image-20230410193430589](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193430589.png)\n\n\n\n\n\n#### åˆ†å¸ƒå¼é”æ¼”è¿›-é˜¶æ®µäºŒ\n\n![image-20230410193552631](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193552631.png)\n\n\n\n\n\n#### åˆ†å¸ƒå¼é”æ¼”è¿›-é˜¶æ®µä¸‰\n\n![image-20230410193625611](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193625611.png)\n\n\n\n\n\n#### åˆ†å¸ƒå¼é”æ¼”è¿›-é˜¶æ®µå››\n\n![image-20230410193648301](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193648301.png)\n\n\n\n\n\n#### åˆ†å¸ƒå¼é”æ¼”è¿›-é˜¶æ®µäº”-æœ€ç»ˆå½¢æ€\n\n![image-20230410193719776](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193719776.png)\n\n\n\n\n\n### ç¼“å­˜æ•°æ®ä¸€è‡´æ€§-åŒå†™æ¨¡å¼\n\n![image-20230410193831064](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193831064.png)\n\n\n\n### ç¼“å­˜æ•°æ®ä¸€è‡´æ€§-å¤±æ•ˆæ¨¡å¼\n\n![image-20230410193909090](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193909090.png)\n\n\n\n### ç¼“å­˜æ•°æ®ä¸€è‡´æ€§-è§£å†³æ–¹æ¡ˆ\n\n-  æ— è®ºæ˜¯åŒå†™æ¨¡å¼è¿˜æ˜¯å¤±æ•ˆæ¨¡å¼ï¼Œéƒ½ä¼šå¯¼è‡´ç¼“å­˜çš„ä¸ä¸€è‡´é—®é¢˜ã€‚å³å¤šä¸ªå®ä¾‹åŒæ—¶æ›´æ–°ä¼šå‡ºäº‹ã€‚æ€ä¹ˆåŠï¼Ÿ\n   - 1ã€å¦‚æœæ˜¯ç”¨æˆ·çº¬åº¦æ•°æ®ï¼ˆè®¢å•æ•°æ®ã€ç”¨æˆ·æ•°æ®ï¼‰ï¼Œè¿™ç§å¹¶å‘å‡ ç‡éå¸¸å°ï¼Œä¸ç”¨è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œç¼“å­˜æ•°æ®åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´è§¦å‘è¯»çš„ä¸»åŠ¨æ›´æ–°å³å¯\n   - 2ã€å¦‚æœæ˜¯èœå•ï¼Œå•†å“ä»‹ç»ç­‰åŸºç¡€æ•°æ®ï¼Œä¹Ÿå¯ä»¥å»ä½¿ç”¨canalè®¢é˜…binlogçš„æ–¹å¼ã€‚\n   - 3ã€ç¼“å­˜æ•°æ®+è¿‡æœŸæ—¶é—´ä¹Ÿè¶³å¤Ÿè§£å†³å¤§éƒ¨åˆ†ä¸šåŠ¡å¯¹äºç¼“å­˜çš„è¦æ±‚ã€‚\n   - 4ã€é€šè¿‡åŠ é”ä¿è¯å¹¶å‘è¯»å†™ï¼Œå†™å†™çš„æ—¶å€™æŒ‰é¡ºåºæ’å¥½é˜Ÿã€‚è¯»è¯»æ— æ‰€è°“ã€‚æ‰€ä»¥é€‚åˆä½¿ç”¨è¯»å†™é”ã€‚ï¼ˆä¸šåŠ¡ä¸å…³å¿ƒè„æ•°æ®ï¼Œå…è®¸ä¸´æ—¶è„æ•°æ®å¯å¿½ç•¥ï¼‰ï¼›\n-  æ€»ç»“ï¼š\n   - æˆ‘ä»¬èƒ½æ”¾å…¥ç¼“å­˜çš„æ•°æ®æœ¬å°±ä¸åº”è¯¥æ˜¯å®æ—¶æ€§ã€ä¸€è‡´æ€§è¦æ±‚è¶…é«˜çš„ã€‚æ‰€ä»¥ç¼“å­˜æ•°æ®çš„æ—¶å€™åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œä¿è¯æ¯å¤©æ‹¿åˆ°å½“å‰æœ€æ–°æ•°æ®å³å¯ã€‚\n   - æˆ‘ä»¬ä¸åº”è¯¥è¿‡åº¦è®¾è®¡ï¼Œå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§\n   - é‡åˆ°å®æ—¶æ€§ã€ä¸€è‡´æ€§è¦æ±‚é«˜çš„æ•°æ®ï¼Œå°±åº”è¯¥æŸ¥æ•°æ®åº“ï¼Œå³ä½¿æ…¢ç‚¹ã€‚\n\n\n\n### ç¼“å­˜æ•°æ®ä¸€è‡´æ€§-è§£å†³-Canal\n\n![image-20230410194458435](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410194458435.png)\n\n\n\n\n\n## Sessionå…±äº«é—®é¢˜\n\n### sessionåŸç†\n\n![image-20230410195022298](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195022298.png)\n\n\n\n### åˆ†å¸ƒå¼ä¸‹sessionå…±äº«é—®é¢˜\n\n![image-20230410195051946](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195051946.png)\n\n\n\n### è§£å†³-sessionå¤åˆ¶\n\n![image-20230410195126743](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195126743.png)\n\n\n\n- ä¼˜ç‚¹\n  - web-serverï¼ˆTomcatï¼‰åŸç”Ÿæ”¯æŒï¼Œåªéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶\n- ç¼ºç‚¹\n  - sessionåŒæ­¥éœ€è¦æ•°æ®ä¼ è¾“ï¼Œå ç”¨å¤§é‡ç½‘ç»œå¸¦å®½ï¼Œé™ä½äº†æœåŠ¡å™¨ç¾¤çš„ä¸šåŠ¡å¤„ç†èƒ½åŠ›\n  - ä»»æ„ä¸€å°web-serverä¿å­˜çš„æ•°æ®éƒ½æ˜¯æ‰€æœ‰web-serverçš„sessionæ€»å’Œï¼Œå—åˆ°å†…å­˜é™åˆ¶æ— æ³•æ°´å¹³æ‰©å±•æ›´å¤šçš„web-server\n  - å¤§å‹åˆ†å¸ƒå¼é›†ç¾¤æƒ…å†µä¸‹ï¼Œç”±äºæ‰€æœ‰web-serveréƒ½å…¨é‡ä¿å­˜æ•°æ®ï¼Œæ‰€ä»¥æ­¤æ–¹æ¡ˆä¸å¯å–ã€‚\n\n\n\n### è§£å†³-å®¢æˆ·ç«¯å­˜å‚¨\n\n![image-20230410195314820](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195314820.png)\n\n\n\n- ä¼˜ç‚¹\n  - æœåŠ¡å™¨ä¸éœ€å­˜å‚¨sessionï¼Œç”¨æˆ·ä¿å­˜è‡ªå·±çš„sessionä¿¡æ¯åˆ°cookieä¸­ã€‚èŠ‚çœæœåŠ¡ç«¯èµ„æº\n\n- ç¼ºç‚¹\n  - éƒ½æ˜¯ç¼ºç‚¹ï¼Œè¿™åªæ˜¯ä¸€ç§æ€è·¯ã€‚\n  - å…·ä½“å¦‚ä¸‹ï¼š\n    - æ¯æ¬¡httpè¯·æ±‚ï¼Œæºå¸¦ç”¨æˆ·åœ¨cookieä¸­çš„å®Œæ•´ä¿¡æ¯ï¼Œæµªè´¹ç½‘ç»œå¸¦å®½\n    - sessionæ•°æ®æ”¾åœ¨cookieä¸­ï¼Œcookieæœ‰é•¿åº¦é™åˆ¶4Kï¼Œä¸èƒ½ä¿å­˜å¤§é‡ä¿¡æ¯\n    - sessionæ•°æ®æ”¾åœ¨cookieä¸­ï¼Œå­˜åœ¨æ³„æ¼ã€ç¯¡æ”¹ã€çªƒå–ç­‰å®‰å…¨éšæ‚£\n- è¿™ç§æ–¹å¼ä¸ä¼šä½¿ç”¨ã€‚\n\n\n\n### è§£å†³-hashä¸€è‡´æ€§\n\n![image-20230410195638892](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195638892.png)\n\n\n\n- ä¼˜ç‚¹ï¼š\n  - åªéœ€è¦æ”¹nginxé…ç½®ï¼Œä¸éœ€è¦ä¿®æ”¹åº”ç”¨ä»£ç \n  - è´Ÿè½½å‡è¡¡ï¼Œåªè¦hashå±æ€§çš„å€¼åˆ†å¸ƒæ˜¯å‡åŒ€çš„ï¼Œå¤šå°web-serverçš„è´Ÿè½½æ˜¯å‡è¡¡çš„\n  - å¯ä»¥æ”¯æŒweb-serveræ°´å¹³æ‰©å±•ï¼ˆsessionåŒæ­¥æ³•æ˜¯ä¸è¡Œçš„ï¼Œå—å†…å­˜é™åˆ¶ï¼‰\n- ç¼ºç‚¹\n  - sessionè¿˜æ˜¯å­˜åœ¨web-serverä¸­çš„ï¼Œæ‰€ä»¥web-serveré‡å¯å¯èƒ½å¯¼è‡´éƒ¨åˆ†sessionä¸¢å¤±ï¼Œå½±å“ä¸šåŠ¡ï¼Œå¦‚éƒ¨åˆ†ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•\n  - å¦‚æœweb-serveræ°´å¹³æ‰©å±•ï¼Œrehashåsessioné‡æ–°åˆ†å¸ƒï¼Œä¹Ÿä¼šæœ‰ä¸€éƒ¨åˆ†ç”¨æˆ·è·¯ç”±ä¸åˆ°æ­£ç¡®çš„session\n- ä½†æ˜¯ä»¥ä¸Šç¼ºç‚¹é—®é¢˜ä¹Ÿä¸æ˜¯å¾ˆå¤§ï¼Œå› ä¸ºsessionæœ¬æ¥éƒ½æ˜¯æœ‰æœ‰æ•ˆæœŸçš„ã€‚æ‰€ä»¥è¿™ä¸¤ç§åå‘ä»£ç†çš„æ–¹å¼å¯ä»¥ä½¿ç”¨\n\n\n\n### è§£å†³-ç»Ÿä¸€å­˜å‚¨\n\n![image-20230410195856602](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195856602.png)\n\n\n\n- ä¼˜ç‚¹ï¼š\n  - æ²¡æœ‰å®‰å…¨éšæ‚£\n  - å¯ä»¥æ°´å¹³æ‰©å±•ï¼Œæ•°æ®åº“/ç¼“å­˜æ°´å¹³åˆ‡åˆ†å³å¯\n  - web-serveré‡å¯æˆ–è€…æ‰©å®¹éƒ½ä¸ä¼šæœ‰sessionä¸¢å¤±\n- ä¸è¶³\n  - å¢åŠ äº†ä¸€æ¬¡ç½‘ç»œè°ƒç”¨ï¼Œå¹¶ä¸”éœ€è¦ä¿®æ”¹åº”ç”¨ä»£ç ï¼›å¦‚å°†æ‰€æœ‰çš„getSessionæ–¹æ³•æ›¿æ¢ä¸ºä»RedisæŸ¥æ•°æ®çš„æ–¹å¼ã€‚redisè·å–æ•°æ®æ¯”å†…å­˜æ…¢å¾ˆå¤š\n  - ä¸Šé¢ç¼ºç‚¹å¯ä»¥ç”¨SpringSessionå®Œç¾è§£å†³\n\n\n\n\n\n### è§£å†³-ä¸åŒæœåŠ¡ï¼Œå­åŸŸsessionå…±äº«\n\n> jsessionidè¿™ä¸ªcookieé»˜è®¤æ˜¯å½“å‰ç³»ç»ŸåŸŸåçš„ã€‚å½“æˆ‘ä»¬åˆ†æ‹†æœåŠ¡ï¼Œä¸åŒåŸŸåéƒ¨ç½²çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨\n> å¦‚ä¸‹è§£å†³æ–¹æ¡ˆï¼›\n\n![image-20230410200123345](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410200123345.png)\n\n\n\n\n\n### SpringSessionæ ¸å¿ƒåŸç†\n\n![image-20230410200156413](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410200156413.png)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n## è´­ç‰©è½¦\n\n### è´­ç‰©è½¦æ•°æ®ç»“æ„\n\n![image-20230410200320343](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410200320343.png)\n\n> - Map<String k1,Map<String k2,CartItemInfo>> \t\t\tåœ¨redisä¸­\n> - k1ï¼šæ ‡è¯†æ¯ä¸€ä¸ªç”¨æˆ·çš„è´­ç‰©è½¦\t\t\t\t\t\t\t\t\t\t\tkey:ç”¨æˆ·æ ‡è¯†\n> - k2ï¼šè´­ç‰©é¡¹çš„å•†å“id  \t\t\t\t\t\t\t\t\t\t\t\t\t\tvalue:Hashï¼ˆkï¼šå•†å“idï¼Œvï¼šè´­ç‰©é¡¹è¯¦æƒ…ï¼‰\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n## æ¶ˆæ¯é˜Ÿåˆ—RabbitMQ\n\n### RabbitMQæ¦‚å¿µ\n\n![image-20230410200724866](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410200724866.png)\n\n> rabbitmq æ˜¯ä¸€ä¸ªå¼€æºçš„æ¶ˆæ¯ä»£ç†å’Œé˜Ÿåˆ—æœåŠ¡å™¨ï¼Œé€šè¿‡æ™®é€šçš„åè®®ï¼ˆAmqp åè®®ï¼‰æ¥å®Œæˆä¸åŒåº”ç”¨ä¹‹é—´çš„æ•°æ®å…±äº«ï¼ŒrabbitMq æ˜¯é€šè¿‡ erlang è¯­è¨€æ¥å¼€å‘çš„åŸºäº amqp åè®®ã€‚\n\n### ä»€ä¹ˆAMQPåè®®\n\n1. æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶åè®®\n2. amqp æ˜¯ä¸€ä¸ªåº”ç”¨å±‚åè®®çš„è§„èŒƒï¼ˆå®šä¹‰äº†å¾ˆå¤šè§„èŒƒï¼‰ï¼Œå¯ä»¥æœ‰å¾ˆå¤šä¸åŒçš„æ¶ˆæ¯ä¸­é—´ä»¶äº§å“ï¼ˆéœ€è¦éµå¾ªè¯¥è§„èŒƒï¼‰\n\n- serverï¼š æ˜¯æ¶ˆæ¯é˜Ÿåˆ—èŠ‚ç‚¹\n\n- virtual hostï¼š è™šæ‹Ÿä¸»æœº\n\n- exchangeï¼š äº¤æ¢æœºï¼ˆæ¶ˆæ¯æŠ•é€’åˆ°äº¤æ¢æœºä¸Šï¼‰\n\n- message  queueï¼š è¢«æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯\n\n  `äº¤æ¢æœºå’Œé˜Ÿåˆ—æ˜¯æœ‰ä¸€ä¸ªç»‘å®šçš„å…³ç³»`\n\n![image-20230310210242731](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310210242731.png)\n\n### AMQPçš„æ ¸å¿ƒæ¦‚å¿µ\n\n1.  server ï¼š åˆç§°ä¸ºbrokerï¼Œæ¥å—å®¢æˆ·ç«¯è¿æ¥ï¼Œå®ç°amqpå®ä½“æœåŠ¡\n2.  connectionï¼š è¿æ¥ï¼Œåº”ç”¨ç¨‹åºä¸brokerå»ºç«‹ç½‘ç»œè¿æ¥\n3.  channelï¼š ç½‘ç»œé€šé“ï¼Œå‡ ä¹æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åœ¨ channel ä¸­è¿›è¡Œçš„ï¼Œæ˜¯è¿›è¡Œæ¶ˆæ¯å¯¹è±¡çš„é€šé“ï¼Œå®¢æˆ·ç«¯å¯ä»¥å»ºç«‹å¤šä¸ªé€šé“ï¼Œæ¯ä¸€ä¸ª channnel è¡¨ç¤ºä¸€ä¸ªä¼šè¯ä»»åŠ¡ã€‚\n4.  Messageï¼š æœåŠ¡å™¨å’Œåº”ç”¨ç¨‹åºä¹‹é—´ä¼ é€’æ•°æ®çš„è½½ä½“ï¼Œæœ‰ propertiesï¼ˆæ¶ˆæ¯å±æ€§ï¼Œç”¨æ¥ä¿®é¥°æ¶ˆæ¯ï¼Œæ¯”å¦‚æ¶ˆæ¯çš„ä¼˜å…ˆçº§ï¼Œå»¶æ—¶æŠ•é€’ï¼‰å’Œ Body ï¼ˆæ¶ˆæ¯ä½“ï¼‰\n5.  virtual hostï¼ˆè™šæ‹Ÿä¸»æœºï¼‰ï¼šæ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œæœ€ä¸Šå±‚çš„æ¶ˆæ¯è·¯ç”±ï¼Œä¸€ä¸ªè™šæ‹Ÿä¸»æœºä¸­å¯ä»¥åŒ…å«å¤šä¸ª exchange å’Œ queue ä½†æ˜¯ä¸€ä¸ªè™šæ‹Ÿä¸»æœºä¸­ä¸èƒ½æœ‰åç§°ç›¸åŒçš„ exchange å’Œ queue\n6.  exchange ï¼ˆäº¤æ¢æœºï¼‰ï¼š æ¶ˆæ¯ç›´æ¥æŠ•é€’åˆ°äº¤æ¢æœºä¸Šï¼Œç„¶åäº¤æ¢æœºæ ¹æ®æ¶ˆæ¯çš„è·¯ç”± key æ¥è·¯ç”±åˆ°å¯¹åº”ç»‘å®šçš„é˜Ÿåˆ—ä¸Šã€‚\n7.  binding  ï¼ˆç»‘å®šï¼‰ï¼š ç»‘å®š exchange ä¸ queue çš„è™šæ‹Ÿè¿æ¥ï¼Œ binding ä¸­å¯ä»¥åŒ…å«route_key\n8.  route_keyï¼ˆè·¯ç”±keyï¼‰ï¼šå®ƒçš„ä½œç”¨æ˜¯åœ¨äº¤æ¢æœºä¸Šé€šè¿‡ route_key æ¥æŠŠæ¶ˆæ¯è·¯ç”±åˆ°é‚£ä¸ªé˜Ÿåˆ—ä¸Šã€‚\n9.  queue é˜Ÿåˆ—ï¼ˆé˜Ÿåˆ—ï¼‰ï¼š ç”¨æ¥ä¿å­˜æ¶ˆæ¯çš„è½½ä½“ï¼Œæœ‰æ¶ˆè´¹è€…ç›‘å¬ï¼Œç„¶åæ¶ˆè´¹æ¶ˆæ¯ã€‚\n\n### RabbitMqçš„æ¶ˆæ¯æ˜¯å¦‚ä½•æµè½¬çš„ï¼Ÿ\n\n![image-20230310210409545](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310210409545.png)\n\n### RabbitMq äº¤æ¢æœºè¯¦è§£\n\n#### **ä½œç”¨**ï¼š \n\n- æ¥å—ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œç„¶åæ ¹æ®è·¯ç”±é”®æŠŠæ¶ˆæ¯æŠ•é€’åˆ°è·Ÿäº¤æ¢æœºç»‘å®šçš„å¯¹åº”çš„é˜Ÿåˆ—ä¸Šã€‚\n\n\n![image-20230310210717895](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310210717895.png)\n\n#### **äº¤æ¢æœºå±æ€§**\n\n- Nameï¼š äº¤æ¢æœºåç§°\n- Typeï¼š äº¤æ¢æœºç±»å‹ï¼ŒDirectã€topicã€fanoutã€headers\n- Durablityï¼šæ˜¯å¦éœ€è¦æŒä¹…åŒ–\n- autodeleteï¼š å‡å¦‚æ²¡æœ‰é˜Ÿåˆ—ç»‘å®šåˆ°è¯¥äº¤æ¢æœºï¼Œé‚£ä¹ˆäº¤æ¢æœºä¼šè‡ªåŠ¨åˆ é™¤ã€‚\n- internalï¼š å½“å‰äº¤æ¢æœºäº¤æ¢æœºæ˜¯å¦ç”¨æˆ· RabbitMq å†…éƒ¨ä½¿ç”¨ä¸å¸¸ç”¨ï¼Œé»˜è®¤ä¸ºfalse \n- Argurementsï¼š æ‰©å±•å‚æ•°ï¼Œç”¨æˆ·æ‰©å±•AMQPå®šåˆ¶åŒ–åè®®ã€‚\n\n \n\n#### äº¤æ¢æœºç±»å‹\n\n- **ç›´è¿äº¤æ¢æœºï¼ˆDirect exchangeï¼‰** \n\n> æ‰€æœ‰å‘é€çš„ Direct exchange çš„æ¶ˆæ¯éƒ½ä¼šè¢«æŠ•é€’åˆ°ä¸ Routekeyåç§°ï¼ˆä¸é˜Ÿåˆ—åç§°ï¼‰ç›¸åŒçš„queueä¸Š\n>\n> direct æ¨¡å¼ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ RabbitMq è‡ªå®šexchange ---> default exchange æ‰€ä»¥ä¸éœ€è¦äº¤æ¢æœºå’Œä»»ä½•é˜Ÿåˆ—ç»‘å®šï¼Œæ¶ˆæ¯å°†ä¼šæŠ•é€’åˆ°route_keyåç§°å’Œé˜Ÿåˆ—åç§°ç›¸åŒçš„é˜Ÿåˆ—ä¸Šã€‚\n\n![image-20230310211903967](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310211903967.png)\n\n- **ä¸»é¢˜äº¤æ¢æœº TopicExchange**\n\n> å°±æ˜¯åœ¨é˜Ÿåˆ—ä¸Šç»‘åˆ° top äº¤æ¢æœºä¸Šçš„è·¯ç”±key å¯ä»¥æ˜¯é€šè¿‡é€šé…ç¬¦æ¥åŒ¹é…çš„é€šé…ç¬¦çš„è§„åˆ™æ˜¯\n>\n> æ¯”å¦‚ï¼šlog.#: å¯ä»¥æ˜¯åŒ¹é…ä¸€ä¸ªå•è¯ ä¹Ÿå¯ä»¥åŒ¹é…å¤šä¸ªå•è¯  æ¯”å¦‚ log.# å¯ä»¥åŒ¹é…log.a log.a.b \n> log.* ï¼š å¯ä»¥åŒ¹é…ä¸€ä¸ªå•è¯ï¼Œæ¯”å¦‚log.* ï¼Œå¯ä»¥åŒ¹é…log.a ä½†æ˜¯ä¸å¯ä»¥åŒ¹é…log.a.bã€‚\n\n![image-20230310211944528](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310211944528.png)\n\n- **æ‰‡å½¢äº¤æ¢æœºï¼ˆfanout exchangeï¼‰**\n\n> å°±æ˜¯æ¶ˆæ¯é€šè¿‡ä¸›äº¤æ¢æœºåˆ°é˜Ÿåˆ—ä¸Šä¸ä¼šé€šè¿‡è·¯ç”±key  æ‰€ä»¥è¯¥æ¨¡å¼çš„é€Ÿåº¦æ˜¯æœ€å¿«çš„  åªè¦å’Œäº¤æ¢æœºç»‘å®šçš„é‚£ä¹ˆæ¶ˆæ¯å°±ä¼šè¢«åˆ†å‘åˆ°ä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—ä¸Šã€‚\n\n![mall](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310212034909.png)\n\n\n\n### **é˜Ÿåˆ—ã€ç»‘å®šä¸»æœºã€æ¶ˆæ¯**\n\n- ç»‘å®šï¼š exchange ä¸ ä¹‹é—´çš„è¿æ¥å…³ç³»ï¼ˆé€šè¿‡è·¯ç”±è§„åˆ™ï¼‰\n- é˜Ÿåˆ—ï¼š ç”¨æ¥å­˜å‚¨æ¶ˆæ¯çš„å®ä½“\n- é˜Ÿåˆ—çš„å±æ€§ï¼š durablility æ˜¯å¦è¢«æŒä¹…åŒ–\n- AutoDeleteï¼š è¡¨ç¤ºæœ€åä¸€ä¸ªç›‘å¬è¢«ç§»é™¤é‚£ä¹ˆè¯¥é˜Ÿåˆ—å°±ä¼šåˆ é™¤ã€‚\n\n- æ¶ˆæ¯ï¼š ç”¨æ¥ç”Ÿäº§è€… å’Œ æ¶ˆè´¹è€…ä¹‹é—´ä¼ é€’æ•°æ®çš„\n\n- æ¶ˆæ¯å±æ€§ï¼š åŒ…æ‹¬ æ¶ˆæ¯ä½“Body å’Œ å±æ€§ properties\n\n- å¸¸ç”¨å±æ€§ï¼š delivery mode,headers,content_type(æ¶ˆæ¯ç±»å‹) content_encodingï¼ˆæ¶ˆæ¯ç¼–ç ï¼‰ï¼Œpriportyï¼ˆæ¶ˆæ¯ä¼˜å…ˆçº§ï¼‰ correntlation_id( æœ€ç»ˆæ¶ˆæ¯å”¯ä¸€çš„ID)ã€reply_to(æ¶ˆæ¯å¤±è´¥é‡å›é˜Ÿåˆ—)ï¼Œexpiretion(æ¶ˆæ¯çš„è¿‡æœŸæ—¶ é—´),message_id(æ¶ˆæ¯id);timestamp,type,user_id ï¼Œapp_id,cluster_idç­‰ \n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"title":"åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ-minio","tags":["Spring Cloud","Spring Boot","minio"],"categories":["Java","å¾®ç³»ç»Ÿä¸ç¬¬ä¸‰æ–¹æ¡†æ¶"],"author":"imklaus","excerpt":"\r\n\r\nå‚è€ƒè§†é¢‘ï¼š[é»‘é©¬å­¦æˆåœ¨çº¿é¡¹ç›®](https://www.bilibili.com/video/BV1j8411N7Bm/)\r\n\r\n","link":"/posts/minio","content":"\r\n\r\nå‚è€ƒè§†é¢‘ï¼š[é»‘é©¬å­¦æˆåœ¨çº¿é¡¹ç›®](https://www.bilibili.com/video/BV1j8411N7Bm/)\r\n\r\n<!-- more -->\r\n\r\n## **ä¸€ åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ**\r\n\r\n### **1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ**\r\n\r\nè¦ç†è§£åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿé¦–å…ˆäº†è§£ä»€ä¹ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿã€‚\r\n\r\næŸ¥é˜…ç™¾åº¦ç™¾ç§‘ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps49.jpg) \r\n\r\nâ€‹    æ–‡ä»¶ç³»ç»Ÿæ˜¯è´Ÿè´£ç®¡ç†å’Œå­˜å‚¨æ–‡ä»¶çš„ç³»ç»Ÿè½¯ä»¶ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡æ–‡ä»¶ç³»ç»Ÿæä¾›çš„æ¥å£å»å­˜å–æ–‡ä»¶ï¼Œç”¨æˆ·é€šè¿‡æ“ä½œç³»ç»Ÿè®¿é—®ç£ç›˜ä¸Šçš„æ–‡ä»¶ã€‚\r\n\r\nä¸‹å›¾æŒ‡ç¤ºäº†æ–‡ä»¶ç³»ç»Ÿæ‰€å¤„çš„ä½ç½®ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps50.jpg) \r\n\r\nå¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿï¼šFAT16/FAT32ã€NTFSã€HFSã€UFSã€APFSã€XFSã€Ext4ç­‰ ã€‚\r\n\r\nç°åœ¨æœ‰ä¸ªé—®é¢˜ï¼Œä¸€æ­¤çŸ­è§†é¢‘å¹³å°æ‹¥æœ‰å¤§é‡çš„è§†é¢‘ã€å›¾ç‰‡ï¼Œè¿™äº›è§†é¢‘æ–‡ä»¶ã€å›¾ç‰‡æ–‡ä»¶è¯¥å¦‚ä½•å­˜å‚¨å‘¢ï¼Ÿå¦‚ä½•å­˜å‚¨å¯ä»¥æ»¡è¶³äº’è”ç½‘ä¸Šæµ·é‡ç”¨æˆ·çš„æµè§ˆã€‚\r\n\r\nä»Šå¤©è®²çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯æµ·é‡ç”¨æˆ·æŸ¥é˜…æµ·é‡æ–‡ä»¶çš„æ–¹æ¡ˆã€‚\r\n\r\næˆ‘ä»¬é˜…è¯»ç™¾åº¦ç™¾ç§‘å»ç†è§£åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„å®šä¹‰ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps51.jpg) \r\n\r\né€šè¿‡æ¦‚å¿µå¯ä»¥ç®€å•ç†è§£ä¸ºï¼šä¸€ä¸ªè®¡ç®—æœºæ— æ³•å­˜å‚¨æµ·é‡çš„æ–‡ä»¶ï¼Œé€šè¿‡ç½‘ç»œå°†è‹¥å¹²è®¡ç®—æœºç»„ç»‡èµ·æ¥å…±åŒå»å­˜å‚¨æµ·é‡çš„æ–‡ä»¶ï¼Œå»æ¥æ”¶æµ·é‡ç”¨æˆ·çš„è¯·æ±‚ï¼Œè¿™äº›ç»„ç»‡èµ·æ¥çš„è®¡ç®—æœºé€šè¿‡ç½‘ç»œè¿›è¡Œé€šä¿¡ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![image-20230704215201202](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230704215201202.png)\r\n\r\n å¥½å¤„ï¼š\r\n\r\n> 1ã€ä¸€å°è®¡ç®—æœºçš„æ–‡ä»¶ç³»ç»Ÿå¤„ç†èƒ½åŠ›æ‰©å……åˆ°å¤šå°è®¡ç®—æœºåŒæ—¶å¤„ç†ã€‚\r\n>\r\n> 2ã€ä¸€å°è®¡ç®—æœºæŒ‚äº†è¿˜æœ‰å¦å¤–å‰¯æœ¬è®¡ç®—æœºæä¾›æ•°æ®ã€‚\r\n>\r\n> 3ã€æ¯å°è®¡ç®—æœºå¯ä»¥æ”¾åœ¨ä¸åŒçš„åœ°åŸŸï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥å°±è¿‘è®¿é—®ï¼Œæé«˜è®¿é—®é€Ÿåº¦ã€‚\r\n\r\nå¸‚é¢ä¸Šæœ‰å“ªäº›åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„äº§å“å‘¢ï¼Ÿ\r\n\r\n1ã€NFS\r\n\r\né˜…è¯»ç™¾åº¦ç™¾ç§‘ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps53.jpg) \r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps54.jpg) \r\n\r\nç‰¹ç‚¹ï¼š\r\n\r\n1ï¼‰åœ¨å®¢æˆ·ç«¯ä¸Šæ˜ å°„NFSæœåŠ¡å™¨çš„é©±åŠ¨å™¨ã€‚\r\n\r\n2ï¼‰å®¢æˆ·ç«¯é€šè¿‡ç½‘ç»œè®¿é—®NFSæœåŠ¡å™¨çš„ç¡¬ç›˜å®Œå…¨é€æ˜ã€‚\r\n\r\n \r\n\r\n \r\n\r\n2ã€GFS\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps55.jpg) \r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps56.jpg) \r\n\r\n1ï¼‰GFSé‡‡ç”¨ä¸»ä»ç»“æ„ï¼Œä¸€ä¸ªGFSé›†ç¾¤ç”±ä¸€ä¸ªmasterå’Œå¤§é‡çš„chunkserverç»„æˆã€‚\r\n\r\n2ï¼‰masterå­˜å‚¨äº†æ•°æ®æ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œä¸€ä¸ªæ–‡ä»¶è¢«åˆ†æˆäº†è‹¥å¹²å—å­˜å‚¨åœ¨å¤šä¸ªchunkserverä¸­ã€‚\r\n\r\n3ï¼‰ç”¨æˆ·ä»masterä¸­è·å–æ•°æ®å…ƒä¿¡æ¯ï¼Œå‘chunkserverå­˜å‚¨æ•°æ®ã€‚\r\n\r\n \r\n\r\n3ã€HDFS\r\n\r\nHDFSï¼Œæ˜¯Hadoop Distributed File Systemçš„ç®€ç§°ï¼Œæ˜¯HadoopæŠ½è±¡æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ç§å®ç°ã€‚HDFSæ˜¯ä¸€ä¸ªé«˜åº¦å®¹é”™æ€§çš„ç³»ç»Ÿï¼Œé€‚åˆéƒ¨ç½²åœ¨å»‰ä»·çš„æœºå™¨ä¸Šã€‚HDFSèƒ½æä¾›é«˜ååé‡çš„æ•°æ®è®¿é—®ï¼Œéå¸¸é€‚åˆå¤§è§„æ¨¡æ•°æ®é›†ä¸Šçš„åº”ç”¨ã€‚ HDFSçš„æ–‡ä»¶åˆ†å¸ƒåœ¨é›†ç¾¤æœºå™¨ä¸Šï¼ŒåŒæ—¶æä¾›å‰¯æœ¬è¿›è¡Œå®¹é”™åŠå¯é æ€§ä¿è¯ã€‚ä¾‹å¦‚å®¢æˆ·ç«¯å†™å…¥è¯»å–æ–‡ä»¶çš„ç›´æ¥æ“ä½œéƒ½æ˜¯åˆ†å¸ƒåœ¨é›†ç¾¤å„ä¸ªæœºå™¨ä¸Šçš„ï¼Œæ²¡æœ‰å•ç‚¹æ€§èƒ½å‹åŠ›ã€‚\r\n\r\nä¸‹å›¾æ˜¯HDFSçš„æ¶æ„å›¾ï¼š\r\n\r\n![image-20230704215636100](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230704215636100.png) \r\n\r\n1ï¼‰HDFSé‡‡ç”¨ä¸»ä»ç»“æ„ï¼Œä¸€ä¸ªHDFSé›†ç¾¤ç”±ä¸€ä¸ªåç§°ç»“ç‚¹å’Œè‹¥å¹²æ•°æ®ç»“ç‚¹ç»„æˆã€‚\r\n\r\n2ï¼‰åç§°ç»“ç‚¹å­˜å‚¨æ•°æ®çš„å…ƒä¿¡æ¯ï¼Œä¸€ä¸ªå®Œæ•´çš„æ•°æ®æ–‡ä»¶åˆ†æˆè‹¥å¹²å—å­˜å‚¨åœ¨æ•°æ®ç»“ç‚¹ã€‚\r\n\r\n3ï¼‰å®¢æˆ·ç«¯ä»åç§°ç»“ç‚¹è·å–æ•°æ®çš„å…ƒä¿¡æ¯åŠæ•°æ®åˆ†å—çš„ä¿¡æ¯ï¼Œå¾—åˆ°ä¿¡æ¯å®¢æˆ·ç«¯å³å¯ä»æ•°æ®å—æ¥å­˜å–æ•°æ®ã€‚\r\n\r\n \r\n\r\n**4ã€äº‘è®¡ç®—å‚å®¶**\r\n\r\né˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼ˆObject Storage Serviceï¼Œç®€ç§° ï¼‰ï¼Œæ˜¯é˜¿é‡Œäº‘æä¾›çš„æµ·é‡ã€å®‰å…¨ã€ä½æˆæœ¬ã€é«˜å¯é çš„äº‘å­˜å‚¨æœåŠ¡ã€‚å…¶æ•°æ®è®¾è®¡æŒä¹…æ€§ä¸ä½äº 99.9999999999%ï¼ˆ12 ä¸ª 9ï¼‰ï¼ŒæœåŠ¡è®¾è®¡å¯ç”¨æ€§ï¼ˆæˆ–ä¸šåŠ¡è¿ç»­æ€§ï¼‰ä¸ä½äº 99.995%ã€‚\r\n\r\n*å®˜æ–¹ç½‘ç«™ï¼š*[*https://www.aliyun.com/product/*](https://www.aliyun.com/product/) \r\n\r\nç™¾åº¦å¯¹è±¡å­˜å‚¨BOSæä¾›ç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆã€é«˜å¯æ‰©å±•çš„äº‘å­˜å‚¨æœåŠ¡ã€‚æ‚¨å¯ä»¥å°†ä»»æ„æ•°é‡å’Œå½¢å¼çš„éç»“æ„åŒ–æ•°æ®å­˜å…¥BOSï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œç®¡ç†å’Œå¤„ç†ã€‚BOSæ”¯æŒæ ‡å‡†ã€ä½é¢‘ã€å†·å’Œå½’æ¡£å­˜å‚¨ç­‰å¤šç§å­˜å‚¨ç±»å‹ï¼Œæ»¡è¶³å¤šåœºæ™¯çš„å­˜å‚¨éœ€æ±‚ã€‚ \r\n\r\n*å®˜æ–¹ç½‘ç«™ï¼š*[*https://cloud.baidu.com/product/bos.html*](https://cloud.baidu.com/product/bos.html) \r\n\r\n### **1.2 MinIO**\r\n\r\n#### **1.2.1 ä»‹ç»**\r\n\r\næœ¬é¡¹ç›®é‡‡ç”¨MinIOæ„å»ºåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼ŒMinIO æ˜¯ä¸€ä¸ªéå¸¸è½»é‡çš„æœåŠ¡,å¯ä»¥å¾ˆç®€å•çš„å’Œå…¶ä»–åº”ç”¨çš„ç»“åˆä½¿ç”¨ï¼Œå®ƒå…¼å®¹äºšé©¬é€Š S3 äº‘å­˜å‚¨æœåŠ¡æ¥å£ï¼Œéå¸¸é€‚åˆäºå­˜å‚¨å¤§å®¹é‡éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½æ•°æ®å’Œå®¹å™¨/è™šæ‹Ÿæœºé•œåƒç­‰ã€‚\r\n\r\nå®ƒä¸€å¤§ç‰¹ç‚¹å°±æ˜¯è½»é‡ï¼Œä½¿ç”¨ç®€å•ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå„ç§å¹³å°ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§5TBï¼Œå…¼å®¹ Amazon S3æ¥å£ï¼Œæä¾›äº† Javaã€Pythonã€GOç­‰å¤šç‰ˆæœ¬SDKæ”¯æŒã€‚\r\n\r\nå®˜ç½‘ï¼šhttps://min.io\r\n\r\nä¸­æ–‡ï¼šhttps://www.minio.org.cn/ï¼Œhttp://docs.minio.org.cn/docs/\r\n\r\n \r\n\r\nMinIOé›†ç¾¤é‡‡ç”¨å»ä¸­å¿ƒåŒ–å…±äº«æ¶æ„ï¼Œæ¯ä¸ªç»“ç‚¹æ˜¯å¯¹ç­‰å…³ç³»ï¼Œé€šè¿‡Nginxå¯å¯¹MinIOè¿›è¡Œè´Ÿè½½å‡è¡¡è®¿é—®ã€‚\r\n\r\nå»ä¸­å¿ƒåŒ–æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ\r\n\r\nåœ¨å¤§æ•°æ®é¢†åŸŸï¼Œé€šå¸¸çš„è®¾è®¡ç†å¿µéƒ½æ˜¯æ— ä¸­å¿ƒå’Œåˆ†å¸ƒå¼ã€‚Minioåˆ†å¸ƒå¼æ¨¡å¼å¯ä»¥å¸®åŠ©ä½ æ­å»ºä¸€ä¸ªé«˜å¯ç”¨çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™äº›å­˜å‚¨è®¾å¤‡ï¼Œè€Œä¸ç”¨è€ƒè™‘å…¶çœŸå®ç‰©ç†ä½ç½®ã€‚\r\n\r\nå®ƒå°†åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡å™¨ä¸Šçš„å¤šå—ç¡¬ç›˜ç»„æˆä¸€ä¸ªå¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚ç”±äºç¡¬ç›˜åˆ†å¸ƒåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œåˆ†å¸ƒå¼Minioé¿å…äº†å•ç‚¹æ•…éšœã€‚å¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps58.jpg) \r\n\r\nMinioä½¿ç”¨çº åˆ ç æŠ€æœ¯æ¥ä¿æŠ¤æ•°æ®ï¼Œå®ƒæ˜¯ä¸€ç§æ¢å¤ä¸¢å¤±å’ŒæŸåæ•°æ®çš„æ•°å­¦ç®—æ³•ï¼Œå®ƒå°†æ•°æ®åˆ†å—å†—ä½™çš„åˆ†æ•£å­˜å‚¨åœ¨å„å„èŠ‚ç‚¹çš„ç£ç›˜ä¸Šï¼Œæ‰€æœ‰çš„å¯ç”¨ç£ç›˜ç»„æˆä¸€ä¸ªé›†åˆï¼Œä¸Šå›¾ç”±8å—ç¡¬ç›˜ç»„æˆä¸€ä¸ªé›†åˆï¼Œå½“ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶æ—¶ä¼šé€šè¿‡çº åˆ ç ç®—æ³•è®¡ç®—å¯¹æ–‡ä»¶è¿›è¡Œåˆ†å—å­˜å‚¨ï¼Œé™¤äº†å°†æ–‡ä»¶æœ¬èº«åˆ†æˆ4ä¸ªæ•°æ®å—ï¼Œè¿˜ä¼šç”Ÿæˆ4ä¸ªæ ¡éªŒå—ï¼Œæ•°æ®å—å’Œæ ¡éªŒå—ä¼šåˆ†æ•£çš„å­˜å‚¨åœ¨è¿™8å—ç¡¬ç›˜ä¸Šã€‚\r\n\r\nä½¿ç”¨çº åˆ ç çš„å¥½å¤„æ˜¯å³ä¾¿ä¸¢å¤±ä¸€åŠæ•°é‡ï¼ˆN/2ï¼‰çš„ç¡¬ç›˜ï¼Œä»ç„¶å¯ä»¥æ¢å¤æ•°æ®ã€‚ æ¯”å¦‚ä¸Šè¾¹é›†åˆä¸­æœ‰4ä¸ªä»¥å†…çš„ç¡¬ç›˜æŸå®³ä»å¯ä¿è¯æ•°æ®æ¢å¤ï¼Œä¸å½±å“ä¸Šä¼ å’Œä¸‹è½½ï¼Œå¦‚æœå¤šäºä¸€åŠçš„ç¡¬ç›˜åäº†åˆ™æ— æ³•æ¢å¤ã€‚\r\n\r\n \r\n\r\n#### **1.2.2 æ•°æ®æ¢å¤æ¼”ç¤º**\r\n\r\nä¸‹è¾¹åœ¨æœ¬æœºæ¼”ç¤ºMinIOæ¢å¤æ•°æ®çš„è¿‡ç¨‹ï¼Œåœ¨æœ¬åœ°åˆ›å»º4ä¸ªç›®å½•è¡¨ç¤º4ä¸ªç¡¬ç›˜ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps59.jpg) \r\n\r\nä¸‹è½½minioï¼Œä¸‹è½½åœ°å€åœ¨https://dl.min.io/server/minio/release/ï¼Œå¯ä»è¯¾ç¨‹èµ„æ–™æ‰¾åˆ°MinIOçš„å®‰è£…æ–‡ä»¶minio.zipè§£å‹å³å¯ä½¿ç”¨ï¼ŒCMDè¿›å…¥æœ‰minio.exeçš„ç›®å½•ï¼Œè¿è¡Œä¸‹è¾¹çš„å‘½ä»¤ï¼š\r\n\r\n```shell\r\nminio.exe server D:\\develop\\minio_data\\data1  D:\\develop\\minio_data\\data2  D:\\develop\\minio_data\\data3  D:\\develop\\minio_data\\data4\r\n```\r\n\r\nå¯åŠ¨ç»“æœå¦‚ä¸‹ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps60.jpg) \r\n\r\nè¯´æ˜å¦‚ä¸‹ï¼š\r\n\r\n`WARNING: MINIO_ACCESS_KEY and MINIO_SECRET_KEY are deprecated.      Please use MINIO_ROOT_USER and MINIO_ROOT_PASSWORD Formatting 1st pool, 1 set(s), 4 drives per set. WARNING: Host local has more than 2 drives of set. A host failure will result in data becoming unavailable. WARNING: Detected default credentials 'minioadmin:minioadmin', we recommend that you change these values with 'MINIO_ROOT_USER' and 'MINIO_ROOT_PASSWORD' environment variables`\r\n\r\n1ï¼‰è€ç‰ˆæœ¬ä½¿ç”¨çš„MINIO_ACCESS_KEY å’Œ MINIO_SECRET_KEYä¸æ¨èä½¿ç”¨ï¼Œæ¨èä½¿ç”¨MINIO_ROOT_USER å’ŒMINIO_ROOT_PASSWORDè®¾ç½®è´¦å·å’Œå¯†ç ã€‚\r\n\r\n2ï¼‰poolå³minioèŠ‚ç‚¹ç»„æˆçš„æ± å­ï¼Œå½“å‰æœ‰ä¸€ä¸ªpoolå’Œ4ä¸ªç¡¬ç›˜ç»„æˆçš„seté›†åˆ\r\n\r\n3ï¼‰å› ä¸ºé›†åˆæ˜¯4ä¸ªç¡¬ç›˜ï¼Œå¤§äº2çš„ç¡¬ç›˜æŸåæ•°æ®å°†æ— æ³•æ¢å¤ã€‚\r\n\r\n4ï¼‰è´¦å·å’Œå¯†ç é»˜è®¤ä¸ºminioadminã€minioadminï¼Œå¯ä»¥åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®é€šè¿‡'MINIO_ROOT_USER' and 'MINIO_ROOT_PASSWORD' è¿›è¡Œè®¾ç½®ã€‚\r\n\r\nä¸‹è¾¹è¾“å…¥`http://localhost:9000`è¿›è¡Œç™»å½•ï¼Œè´¦å·å’Œå¯†ç ä¸ºï¼šminioadmin/minioadmin\r\n\r\n \r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps61.jpg) \r\n\r\n \r\n\r\nç™»å½•æˆåŠŸï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps62.jpg) \r\n\r\nä¸‹ä¸€æ­¥åˆ›å»ºbucketï¼Œæ¡¶ï¼Œå®ƒç›¸å½“äºå­˜å‚¨æ–‡ä»¶çš„ç›®å½•ï¼Œå¯ä»¥åˆ›å»ºè‹¥å¹²çš„æ¡¶ã€‚\r\n\r\n![image-20230704220604232](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230704220604232.png) \r\n\r\nè¾“å…¥bucketçš„åç§°ï¼Œç‚¹å‡»â€œCreateBucketâ€ï¼Œåˆ›å»ºæˆåŠŸ\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps64.jpg) \r\n\r\nç‚¹å‡»â€œuploadâ€ä¸Šä¼ æ–‡ä»¶ã€‚\r\n\r\nä¸‹è¾¹ä¸Šä¼ å‡ ä¸ªæ–‡ä»¶ \r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps65.jpg) \r\n\r\n \r\n\r\nä¸‹è¾¹å»å››ä¸ªç›®å½•è§‚å¯Ÿæ–‡ä»¶çš„å­˜å‚¨æƒ…å†µ\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps66.jpg) \r\n\r\næˆ‘ä»¬å‘ç°ä¸Šä¼ çš„1.mp4æ–‡ä»¶å­˜å‚¨åœ¨äº†å››ä¸ªç›®å½•ï¼Œå³å››ä¸ªç¡¬ç›˜ä¸Šã€‚\r\n\r\nä¸‹è¾¹æµ‹è¯•minioçš„æ•°æ®æ¢å¤è¿‡ç¨‹ï¼š\r\n\r\n1ã€é¦–å…ˆåˆ é™¤ä¸€ä¸ªç›®å½•ã€‚\r\n\r\nåˆ é™¤ç›®å½•åä»ç„¶å¯ä»¥åœ¨webæ§åˆ¶å°ä¸Šä¼ æ–‡ä»¶å’Œä¸‹è½½æ–‡ä»¶ã€‚\r\n\r\nç¨ç­‰ç‰‡åˆ»åˆ é™¤çš„ç›®å½•è‡ªåŠ¨æ¢å¤ã€‚\r\n\r\n2ã€åˆ é™¤ä¸¤ä¸ªç›®å½•ã€‚\r\n\r\nåˆ é™¤ä¸¤ä¸ªç›®å½•ä¹Ÿä¼šè‡ªåŠ¨æ¢å¤ã€‚\r\n\r\n3ã€åˆ é™¤ä¸‰ä¸ªç›®å½• ã€‚\r\n\r\nç”±äº é›†åˆä¸­å…±æœ‰4å—ç¡¬ç›˜ï¼Œæœ‰å¤§äºä¸€åŠçš„ç¡¬ç›˜æŸåæ•°æ®æ— æ³•æ¢å¤ã€‚\r\n\r\næ­¤æ—¶æŠ¥é”™ï¼š`We encountered an internal error, please try again.  (Read failed.  Insufficient number of drives online)`åœ¨çº¿é©±åŠ¨å™¨æ•°é‡ä¸è¶³ã€‚\r\n\r\n \r\n\r\n#### **1.2.3 æµ‹è¯•Dockerç¯å¢ƒ**\r\n\r\nå¼€å‘é˜¶æ®µå’Œç”Ÿäº§é˜¶æ®µç»Ÿä¸€ä½¿ç”¨Dockerä¸‹çš„MINIOã€‚\r\n\r\nåœ¨ä¸‹å‘çš„è™šæ‹Ÿæœºä¸­å·²å®‰è£…äº†MinIOçš„é•œåƒå’Œå®¹å™¨ï¼Œæ‰§è¡Œsh /data/soft /restart.shå¯åŠ¨Dockerä¸‹çš„MinIO\r\n\r\nå¯åŠ¨å®Œæˆç™»å½•MinIOæŸ¥çœ‹æ˜¯å¦æ­£å¸¸ã€‚\r\n\r\nè®¿é—®`http://192.168.2.203:9000`\r\n\r\n![image-20230704221009748](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230704221009748.png)\r\n\r\næœ¬é¡¹ç›®åˆ›å»ºä¸¤ä¸ªbucketsï¼š\r\n\r\nmediafilesï¼š æ™®é€šæ–‡ä»¶\r\n\r\nvideoï¼šè§†é¢‘æ–‡ä»¶\r\n\r\n \r\n\r\n#### **1.2.4 SDK**\r\n\r\n##### **1.2.4.1ä¸Šä¼ æ–‡ä»¶**\r\n\r\nMinIOæä¾›å¤šä¸ªè¯­è¨€ç‰ˆæœ¬SDKçš„æ”¯æŒï¼Œä¸‹è¾¹æ‰¾åˆ°javaç‰ˆæœ¬çš„æ–‡æ¡£ï¼š\r\n\r\nåœ°å€ï¼šhttps://docs.min.io/docs/java-client-quickstart-guide.html\r\n\r\næœ€ä½éœ€æ±‚Java 1.8æˆ–æ›´é«˜ç‰ˆæœ¬:\r\n\r\nmavenä¾èµ–å¦‚ä¸‹ï¼š\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>io.minio</groupId>\r\n    <artifactId>minio</artifactId>\r\n    <version>8.4.3</version>\r\n</dependency>\r\n<dependency>\r\n    <groupId>com.squareup.okhttp3</groupId>\r\n    <artifactId>okhttp</artifactId>\r\n    <version>4.8.1</version>\r\n</dependency>\r\n```\r\n\r\nåœ¨media-serviceå·¥ç¨‹æ·»åŠ æ­¤ä¾èµ–ã€‚\r\n\r\nå‚æ•°è¯´æ˜ï¼š\r\n\r\néœ€è¦ä¸‰ä¸ªå‚æ•°æ‰èƒ½è¿æ¥åˆ°minioæœåŠ¡ã€‚\r\n\r\n| å‚æ•°       | è¯´æ˜                                         |\r\n| ---------- | -------------------------------------------- |\r\n| Endpoint   | å¯¹è±¡å­˜å‚¨æœåŠ¡çš„URL                            |\r\n| Access Key | Access keyå°±åƒç”¨æˆ·IDï¼Œå¯ä»¥å”¯ä¸€æ ‡è¯†ä½ çš„è´¦æˆ·ã€‚ |\r\n| Secret Key | Secret keyæ˜¯ä½ è´¦æˆ·çš„å¯†ç ã€‚                   |\r\n\r\n \r\n\r\nå®˜æ–¹çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\r\n\r\n```java\r\nimport io.minio.BucketExistsArgs;\r\nimport io.minio.MakeBucketArgs;\r\nimport io.minio.MinioClient;\r\nimport io.minio.UploadObjectArgs;\r\nimport io.minio.errors.MinioException;\r\nimport java.io.IOException;\r\nimport java.security.InvalidKeyException;\r\nimport java.security.NoSuchAlgorithmException;\r\npublic class FileUploader {\r\n  public static void main(String[] args)throws IOException, NoSuchAlgorithmException, InvalidKeyException {\r\n    try {\r\n      // Create a minioClient with the MinIO server playground, its access key and secret key.\r\n      MinioClient minioClient =\r\n          MinioClient.builder()\r\n              .endpoint(\"https://play.min.io\")\r\n              .credentials(\"Q3AM3UQ867SPQQA43P2F\", \"zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG\")\r\n              .build();\r\n      // Make 'asiatrip' bucket if not exist.\r\n      boolean found =\r\n          minioClient.bucketExists(BucketExistsArgs.builder().bucket(\"asiatrip\").build());\r\n      if (!found) {\r\n        // Make a new bucket called 'asiatrip'.\r\n        minioClient.makeBucket(MakeBucketArgs.builder().bucket(\"asiatrip\").build());\r\n      } else {\r\n        System.out.println(\"Bucket 'asiatrip' already exists.\");\r\n      }\r\n      // Upload '/home/user/Photos/asiaphotos.zip' as object name 'asiaphotos-2015.zip' to bucket\r\n      // 'asiatrip'.\r\n      minioClient.uploadObject(\r\n          UploadObjectArgs.builder()\r\n              .bucket(\"asiatrip\")\r\n              .object(\"asiaphotos-2015.zip\")\r\n              .filename(\"/home/user/Photos/asiaphotos.zip\")\r\n              .build());\r\n      System.out.println(\r\n          \"'/home/user/Photos/asiaphotos.zip' is successfully uploaded as \"\r\n              + \"object 'asiaphotos-2015.zip' to bucket 'asiatrip'.\");\r\n    } catch (MinioException e) {\r\n      System.out.println(\"Error occurred: \" + e);\r\n      System.out.println(\"HTTP trace: \" + e.httpTrace());\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nå‚è€ƒç¤ºä¾‹åœ¨media-serviceå·¥ç¨‹ä¸­ æµ‹è¯•ä¸Šä¼ æ–‡ä»¶åŠŸèƒ½ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•çš„bucket\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps68.jpg) \r\n\r\nç‚¹å‡»â€œManageâ€ä¿®æ”¹bucketçš„è®¿é—®æƒé™\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps69.jpg) \r\n\r\né€‰æ‹©publicæƒé™\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps70.jpg) \r\n\r\nåœ¨xuecheng-plus-media-serviceå·¥ç¨‹ çš„testä¸‹ç¼–å†™æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\r\n\r\n```java\r\nimport io.minio.BucketExistsArgs;\r\nimport io.minio.MakeBucketArgs;\r\nimport io.minio.MinioClient;\r\nimport io.minio.UploadObjectArgs;\r\nimport io.minio.errors.MinioException;\r\n\r\nimport java.io.IOException;\r\nimport java.security.InvalidKeyException;\r\nimport java.security.NoSuchAlgorithmException;\r\npublic class MinioTest {\r\n    MinioClient minioClient =\r\n            MinioClient.builder()\r\n                    .endpoint(\"http://192.168.2.203:9000\")\r\n                    .credentials(\"minioadmin\", \"minioadmin\")\r\n                    .build();\r\n    @Test\r\n    public void test_upload() throws Exception {\r\n        try {\r\n            UploadObjectArgs testbucket = UploadObjectArgs.builder()\r\n                    .bucket(\"testbucket\")//æ¡¶\r\n                    .filename(\"D:\\\\Learning\\\\upload\\\\1.mp4\") //æŒ‡å®šæœ¬åœ°æ–‡ä»¶è·¯å¾„\r\n    //                .object(\"1.mp4\")//å¯¹è±¡å åœ¨æ¡¶ä¸‹å­˜å‚¨è¯¥æ–‡ä»¶\r\n                    .object(\"test/01/1.mp4\")//å¯¹è±¡å æ”¾åœ¨å­ç›®å½•ä¸‹\r\n                    .contentType(\"video/mp4\")//é»˜è®¤æ ¹æ®æ‰©å±•åç¡®å®šæ–‡ä»¶å†…å®¹ç±»å‹ï¼Œä¹Ÿå¯ä»¥æŒ‡å®š\r\n                    .build();\r\n            minioClient.uploadObject(testbucket);\r\n            System.out.println(\"ä¸Šä¼ æˆåŠŸ\");\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n            System.out.println(\"ä¸Šä¼ å¤±è´¥\");\r\n        }\r\n    }\r\n}\r\n```\r\n\r\næ‰§è¡Œuploadæ–¹æ³•ï¼Œåˆ†åˆ«æµ‹è¯•å‘æ¡¶çš„æ ¹ç›®å½•ä¸Šä¼ æ–‡ä»¶ä»¥åŠå­ç›®å½•ä¸Šä¼ æ–‡ä»¶ã€‚\r\n\r\nä¸Šä¼ æˆåŠŸï¼Œé€šè¿‡webæ§åˆ¶å°æŸ¥çœ‹æ–‡ä»¶ï¼Œå¹¶é¢„è§ˆæ–‡ä»¶ã€‚\r\n\r\nè¯´æ˜ï¼š\r\n\r\nè®¾ç½®contentTypeå¯ä»¥é€šè¿‡com.j256.simplemagic.ContentTypeæšä¸¾ç±»æŸ¥çœ‹å¸¸ç”¨çš„mimeTypeï¼ˆåª’ä½“ç±»å‹ï¼‰\r\n\r\né€šè¿‡æ‰©å±•åå¾—åˆ°mimeTypeï¼Œä»£ç å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\t//æ ¹æ®æ‰©å±•åå–å‡ºmimeType\r\n    ContentInfo extensionMatch = ContentInfoUtil.findExtensionMatch(\".mp4\");\r\n    String mimeType = MediaType.APPLICATION_OCTET_STREAM_VALUE;//é€šç”¨mimeTypeï¼Œå­—èŠ‚æµ\r\n```\r\n\r\nå®Œå–„ä¸Šè¾¹çš„ä»£ç  å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\t@Test\r\n    public void test_upload() throws Exception {\r\n        //é€šè¿‡æ‰©å±•åå¾—åˆ°åª’ä½“èµ„æºç±»å‹ mimeType\r\n        //æ ¹æ®æ‰©å±•åå–å‡ºmimeType\r\n        ContentInfo extensionMatch = ContentInfoUtil.findExtensionMatch(\".mp4\");\r\n        String mimeType = MediaType.APPLICATION_OCTET_STREAM_VALUE;//é€šç”¨mimeTypeï¼Œå­—èŠ‚æµ\r\n        if(extensionMatch!=null){\r\n            mimeType = extensionMatch.getMimeType();\r\n        }\r\n        //ä¸Šä¼ æ–‡ä»¶çš„å‚æ•°ä¿¡æ¯\r\n        UploadObjectArgs uploadObjectArgs = UploadObjectArgs.builder()\r\n                .bucket(\"testbucket\")//æ¡¶\r\n                .filename(\"D:\\\\Learning\\\\upload\\\\1.mp4\") //æŒ‡å®šæœ¬åœ°æ–‡ä»¶è·¯å¾„\r\n//                .object(\"1.mp4\")//å¯¹è±¡å åœ¨æ¡¶ä¸‹å­˜å‚¨è¯¥æ–‡ä»¶\r\n                .object(\"test/01/1.mp4\")//å¯¹è±¡å æ”¾åœ¨å­ç›®å½•ä¸‹\r\n                .contentType(mimeType)//è®¾ç½®åª’ä½“æ–‡ä»¶ç±»å‹\r\n                .build();\r\n        //ä¸Šä¼ æ–‡ä»¶\r\n        minioClient.uploadObject(uploadObjectArgs);\r\n    }\r\n```\r\n\r\n \r\n\r\n##### **1.2.4.2 åˆ é™¤æ–‡ä»¶**\r\n\r\nä¸‹è¾¹æµ‹è¯•åˆ é™¤æ–‡ä»¶\r\n\r\nå‚è€ƒï¼šhttps://docs.min.io/docs/java-client-api-reference#removeObject\r\n\r\n```java\r\n@Test\r\npublic void delete(){\r\n    try {\r\n        minioClient.removeObject(\r\n               RemoveObjectArgs.builder().bucket(\"testbucket\").object(\"001/test001.mp4\").build());\r\n        System.out.println(\"åˆ é™¤æˆåŠŸ\");\r\n    } catch (Exception e) {\r\n       e.printStackTrace();\r\n        System.out.println(\"åˆ é™¤å¤±è´¥\");\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n##### **1.2.4.3 æŸ¥è¯¢æ–‡ä»¶**\r\n\r\né€šè¿‡æŸ¥è¯¢æ–‡ä»¶æŸ¥çœ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨minioä¸­ã€‚\r\n\r\nå‚è€ƒï¼šhttps://docs.min.io/docs/java-client-api-reference#getObject\r\n\r\næ ¡éªŒæ–‡ä»¶çš„å®Œæ•´æ€§ï¼Œå¯¹æ–‡ä»¶è®¡ç®—å‡ºmd5å€¼ï¼Œæ¯”è¾ƒåŸå§‹æ–‡ä»¶çš„md5å’Œç›®æ ‡æ–‡ä»¶çš„md5ï¼Œä¸€è‡´åˆ™è¯´æ˜å®Œæ•´\r\n\r\n```java\r\n//æŸ¥è¯¢æ–‡ä»¶ ä»minioä¸­ä¸‹è½½\r\n@Test\r\npublic void test_getFile() throws Exception {\r\n\r\n    GetObjectArgs getObjectArgs = GetObjectArgs.builder().bucket(\"testbucket\").object(\"test/01/1.mp4\").build();\r\n    //æŸ¥è¯¢è¿œç¨‹æœåŠ¡è·å–åˆ°ä¸€ä¸ªæµå¯¹è±¡\r\n    FilterInputStream inputStream = minioClient.getObject(getObjectArgs);\r\n    //æŒ‡å®šè¾“å‡ºæµ\r\n    FileOutputStream outputStream = new FileOutputStream(new File(\"D:\\\\Learning\\\\upload\\\\1a.mp4\"));\r\n    IOUtils.copy(inputStream,outputStream);\r\n\r\n    //æ ¡éªŒæ–‡ä»¶çš„å®Œæ•´æ€§å¯¹æ–‡ä»¶çš„å†…å®¹è¿›è¡Œmd5\r\n    FileInputStream fileInputStream1 = new FileInputStream(new File(\"D:\\\\Learning\\\\upload\\\\1.mp4\"));\r\n    String source_md5 = DigestUtils.md5Hex(fileInputStream1);\r\n    FileInputStream fileInputStream = new FileInputStream(new File(\"D:\\\\Learning\\\\upload\\\\1a.mp4\"));\r\n    String local_md5 = DigestUtils.md5Hex(fileInputStream);\r\n    if(source_md5.equals(local_md5)){\r\n        System.out.println(\"ä¸‹è½½æˆåŠŸ\");\r\n    }\r\n\r\n\r\n}\r\n```\r\n\r\n\r\n\r\n## **äºŒ ä¸Šä¼ å›¾ç‰‡**\r\n\r\n### **2.1 éœ€æ±‚åˆ†æ**\r\n\r\n#### **2.1.1 ä¸šåŠ¡æµç¨‹**\r\n\r\nè¯¾ç¨‹å›¾ç‰‡æ˜¯å®£ä¼ è¯¾ç¨‹éå¸¸é‡è¦çš„ä¿¡æ¯ï¼Œåœ¨æ–°å¢è¯¾ç¨‹ç•Œé¢ä¸Šä¼ è¯¾ç¨‹å›¾ç‰‡ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹è¯¾ç¨‹å›¾ç‰‡ã€‚\r\n\r\nå¦‚ä¸‹å›¾ï¼š\r\n\r\n![image-20230704224229162](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230704224229162.png)\r\n\r\nä¸Šä¼ è¯¾ç¨‹å›¾ç‰‡æ€»ä½“ä¸ŠåŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š\r\n\r\n1ã€ä¸Šä¼ è¯¾ç¨‹å›¾ç‰‡å‰ç«¯è¯·æ±‚åª’èµ„ç®¡ç†æœåŠ¡å°†æ–‡ä»¶ä¸Šä¼ è‡³åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”åœ¨åª’èµ„ç®¡ç†æ•°æ®åº“ä¿å­˜æ–‡ä»¶ä¿¡æ¯ã€‚\r\n\r\n2ã€ä¸Šä¼ å›¾ç‰‡æˆåŠŸä¿å­˜å›¾ç‰‡åœ°å€åˆ°è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯è¡¨ä¸­ã€‚\r\n\r\nè¯¦ç»†æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps72.jpg) \r\n\r\n1ã€å‰ç«¯è¿›å…¥ä¸Šä¼ å›¾ç‰‡ç•Œé¢\r\n\r\n2ã€ä¸Šä¼ å›¾ç‰‡ï¼Œè¯·æ±‚åª’èµ„ç®¡ç†æœåŠ¡ã€‚\r\n\r\n3ã€åª’èµ„ç®¡ç†æœåŠ¡å°†å›¾ç‰‡æ–‡ä»¶å­˜å‚¨åœ¨MinIOã€‚\r\n\r\n4ã€åª’èµ„ç®¡ç†è®°å½•æ–‡ä»¶ä¿¡æ¯åˆ°æ•°æ®åº“ã€‚\r\n\r\n5ã€å‰ç«¯è¯·æ±‚å†…å®¹ç®¡ç†æœåŠ¡ä¿å­˜è¯¾ç¨‹ä¿¡æ¯ï¼Œåœ¨å†…å®¹ç®¡ç†æ•°æ®åº“ä¿å­˜å›¾ç‰‡åœ°å€ã€‚\r\n\r\n \r\n\r\n#### **2.1.2 æ•°æ®æ¨¡å‹**\r\n\r\næ¶‰åŠåˆ°çš„æ•°æ®è¡¨æœ‰ï¼šè¯¾ç¨‹ä¿¡æ¯è¡¨ä¸­çš„å›¾ç‰‡å­—æ®µã€åª’èµ„æ•°æ®åº“çš„æ–‡ä»¶è¡¨ï¼Œä¸‹è¾¹ä¸»è¦çœ‹åª’èµ„æ•°æ®åº“çš„æ–‡ä»¶è¡¨ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps73.jpg) \r\n\r\nå„å­—æ®µæè¿°å¦‚ä¸‹ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps74.jpg) \r\n\r\n \r\n\r\n### **2.2 å‡†å¤‡ç¯å¢ƒ**\r\n\r\né¦–å…ˆåœ¨minioé…ç½®bucketï¼Œbucketåç§°ä¸ºï¼šmediafilesï¼Œå¹¶è®¾ç½®bucketçš„æƒé™ä¸ºå…¬å¼€ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps75.jpg) \r\n\r\nåœ¨nacosé…ç½®ä¸­minioçš„ç›¸å…³ä¿¡æ¯ï¼Œè¿›å…¥`media-service-dev.yaml`:\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps76.jpg) \r\n\r\né…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š\r\n\r\n```yaml\r\nminio:\r\n  endpoint: http://192.168.2.203:9000\r\n  accessKey: minioadmin\r\n  secretKey: minioadmin\r\n  bucket:\r\n    files: mediafiles\r\n    videofiles: video\r\n\r\n \r\n```\r\n\r\nåœ¨media-serviceå·¥ç¨‹ç¼–å†™minioçš„é…ç½®ç±»ï¼š\r\n\r\n```java\r\n@Configuration\r\npublic class MinioConfig {\r\n\r\n\r\n @Value(\"${minio.endpoint}\")\r\n private String endpoint;\r\n @Value(\"${minio.accessKey}\")\r\n private String accessKey;\r\n @Value(\"${minio.secretKey}\")\r\n private String secretKey;\r\n\r\n @Bean\r\n public MinioClient minioClient() {\r\n\r\n  MinioClient minioClient =\r\n          MinioClient.builder()\r\n                  .endpoint(endpoint)\r\n                  .credentials(accessKey, secretKey)\r\n                  .build();\r\n  return minioClient;\r\n }\r\n}\r\n```\r\n\r\n \r\n\r\n### **2.3 æ¥å£å®šä¹‰**\r\n\r\næ ¹æ®éœ€æ±‚åˆ†æï¼Œä¸‹è¾¹è¿›è¡Œæ¥å£å®šä¹‰ï¼Œæ­¤æ¥å£å®šä¹‰ä¸ºä¸€ä¸ªé€šç”¨çš„ä¸Šä¼ æ–‡ä»¶æ¥å£ï¼Œå¯ä»¥ä¸Šä¼ å›¾ç‰‡æˆ–å…¶å®ƒæ–‡ä»¶ã€‚\r\n\r\né¦–å…ˆåˆ†ææ¥å£ï¼š\r\n\r\n> è¯·æ±‚åœ°å€ï¼š/media/upload/coursefile\r\n>\r\n> è¯·æ±‚å†…å®¹ï¼š**Content-Type:** multipart/form-data;\r\n>\r\n> form-data; name=\"filedata\"; filename=\"å…·ä½“çš„æ–‡ä»¶åç§°\"\r\n\r\n \r\n\r\nå“åº”å‚æ•°ï¼šæ–‡ä»¶ä¿¡æ¯ï¼Œå¦‚ä¸‹\r\n\r\n```json\r\n{\r\n  \"id\": \"a16da7a132559daf9e1193166b3e7f52\",\r\n  \"companyId\": 1232141425,\r\n  \"companyName\": null,\r\n  \"filename\": \"1.jpg\",\r\n  \"fileType\": \"001001\",\r\n  \"tags\": \"\",\r\n  \"bucket\": \"/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg\",\r\n  \"fileId\": \"a16da7a132559daf9e1193166b3e7f52\",\r\n  \"url\": \"/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg\",\r\n  \"timelength\": null,\r\n  \"username\": null,\r\n  \"createDate\": \"2022-09-12T21:57:18\",\r\n  \"changeDate\": null,\r\n  \"status\": \"1\",\r\n  \"remark\": \"\",\r\n  \"auditStatus\": null,\r\n  \"auditMind\": null,\r\n  \"fileSize\": 248329\r\n}\r\n```\r\n\r\nå®šä¹‰ä¸Šä¼ å“åº”æ¨¡å‹ç±»ï¼š\r\n\r\n```java\r\n/**\r\n * @description ä¸Šä¼ æ™®é€šæ–‡ä»¶æˆåŠŸå“åº”ç»“æœ\r\n */\r\n@Data\r\npublic class UploadFileResultDto extends MediaFiles {\r\n}\r\n```\r\n\r\n \r\n\r\nå®šä¹‰æ¥å£å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n@ApiOperation(\"ä¸Šä¼ æ–‡ä»¶\")\r\n@RequestMapping(value = \"/upload/coursefile\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\r\npublic UploadFileResultDto upload(@RequestPart(\"filedata\") MultipartFile upload) throws IOException {\r\n\r\n    return null;\r\n}\r\n```\r\n\r\næ¥å£å®šä¹‰å¥½åå¯ä»¥ç”¨httpclientå·¥å…·æµ‹è¯•ä¸€ä¸‹\r\n\r\nä½¿ç”¨httpclientæµ‹è¯•\r\n\r\n```http\r\n### ä¸Šä¼ æ–‡ä»¶\r\nPOST {{media_host}}/media/upload/coursefile\r\nContent-Type: multipart/form-data; boundary=WebAppBoundary\r\n\r\n--WebAppBoundary\r\nContent-Disposition: form-data; name=\"filedata\"; filename=\"1.jpg\"\r\nContent-Type: application/octet-stream\r\n\r\n< d:/develop/upload/1.jpg\r\n```\r\n\r\n \r\n\r\n### **2.4 æ¥å£å¼€å‘**\r\n\r\n#### **2.4.1 DAOå¼€å‘**\r\n\r\næ ¹æ®éœ€æ±‚åˆ†æDAOå±‚å®ç°å‘`media_files`è¡¨æ’å…¥ä¸€æ¡è®°å½•ï¼Œä½¿ç”¨`media_files`è¡¨ç”Ÿæˆçš„mapperå³å¯ã€‚\r\n\r\n#### **2.4.2 Serviceå¼€å‘**\r\n\r\nServiceæ–¹æ³•éœ€è¦æä¾›ä¸€ä¸ªæ›´åŠ é€šç”¨çš„ä¿å­˜æ–‡ä»¶çš„æ–¹æ³•ã€‚\r\n\r\nå®šä¹‰è¯·æ±‚å‚æ•°ç±»ï¼š\r\n\r\n```java\r\n/**\r\n * @description ä¸Šä¼ æ™®é€šæ–‡ä»¶è¯·æ±‚å‚æ•°\r\n */\r\n @Data\r\npublic class UploadFileParamsDto {\r\n\r\n /**\r\n  * æ–‡ä»¶åç§°\r\n  */\r\n private String filename;\r\n\r\n\r\n /**\r\n  * æ–‡ä»¶ç±»å‹ï¼ˆæ–‡æ¡£ï¼ŒéŸ³é¢‘ï¼Œè§†é¢‘ï¼‰\r\n  */\r\n private String fileType;\r\n /**\r\n  * æ–‡ä»¶å¤§å°\r\n  */\r\n private Long fileSize;\r\n\r\n /**\r\n  * æ ‡ç­¾\r\n  */\r\n private String tags;\r\n\r\n /**\r\n  * ä¸Šä¼ äºº\r\n  */\r\n private String username;\r\n\r\n /**\r\n  * å¤‡æ³¨\r\n  */\r\n private String remark;\r\n\r\n\r\n\r\n}\r\n```\r\n\r\nå®šä¹‰serviceæ–¹æ³•ï¼š\r\n\r\n```java\r\n/**\r\n * ä¸Šä¼ æ–‡ä»¶\r\n * @param companyId æœºæ„id\r\n * @param uploadFileParamsDto ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯\r\n * @param localFilePath æ–‡ä»¶ç£ç›˜è·¯å¾„\r\n * @return æ–‡ä»¶ä¿¡æ¯\r\n */\r\npublic UploadFileResultDto uploadFile(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath);\r\n//ä¿®æ”¹ç‰ˆ\r\npublic UploadFileResultDto uploadFile(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath, String objectName);\r\n```\r\n\r\nå®ç°æ–¹æ³•å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n@Autowired\r\nMinioClient minioClient;\r\n\r\n@Autowired\r\nMediaFilesMapper mediaFilesMapper;\r\n\r\n//æ™®é€šæ–‡ä»¶æ¡¶\r\n@Value(\"${minio.bucket.files}\")\r\nprivate String bucket_Files;\r\n\r\n\r\n//è·å–æ–‡ä»¶é»˜è®¤å­˜å‚¨ç›®å½•è·¯å¾„ å¹´/æœˆ/æ—¥\r\nprivate String getDefaultFolderPath() {\r\n    SimpleDateFormat sdf = new SimpleDateFormat(\"yyyy-MM-dd\");\r\n    String folder = sdf.format(new Date()).replace(\"-\", \"/\")+\"/\";\r\n    return folder;\r\n}\r\n\r\n//è·å–æ–‡ä»¶çš„md5\r\nprivate String getFileMd5(File file) {\r\n    try (FileInputStream fileInputStream = new FileInputStream(file)) {\r\n        String fileMd5 = DigestUtils.md5Hex(fileInputStream);\r\n        return fileMd5;\r\n    } catch (Exception e) {\r\n        e.printStackTrace();\r\n        return null;\r\n    }\r\n}\r\n\r\n\r\nprivate String getMimeType(String extension){\r\n    if(extension==null)\r\n        extension = \"\";\r\n    //æ ¹æ®æ‰©å±•åå–å‡ºmimeType\r\n    ContentInfo extensionMatch = ContentInfoUtil.findExtensionMatch(extension);\r\n    //é€šç”¨mimeTypeï¼Œå­—èŠ‚æµ\r\n    String mimeType = MediaType.APPLICATION_OCTET_STREAM_VALUE;\r\n    if(extensionMatch!=null){\r\n        mimeType = extensionMatch.getMimeType();\r\n    }\r\n    return mimeType;\r\n}\r\n/**\r\n * @description å°†æ–‡ä»¶å†™å…¥minIO\r\n * @param localFilePath  æ–‡ä»¶åœ°å€\r\n * @param bucket  æ¡¶\r\n * @param objectName å¯¹è±¡åç§°\r\n * @return void\r\n */\r\npublic boolean addMediaFilesToMinIO(String localFilePath,String mimeType,String bucket, String objectName) {\r\n    try {\r\n        UploadObjectArgs testbucket = UploadObjectArgs.builder()\r\n                .bucket(bucket)\r\n                .object(objectName)\r\n                .filename(localFilePath)\r\n                .contentType(mimeType)\r\n                .build();\r\n        minioClient.uploadObject(testbucket);\r\n        log.debug(\"ä¸Šä¼ æ–‡ä»¶åˆ°minioæˆåŠŸ,bucket:{},objectName:{}\",bucket,objectName);\r\n        System.out.println(\"ä¸Šä¼ æˆåŠŸ\");\r\n        return true;\r\n    } catch (Exception e) {\r\n        e.printStackTrace();\r\n        log.error(\"ä¸Šä¼ æ–‡ä»¶åˆ°minioå‡ºé”™,bucket:{},objectName:{},é”™è¯¯åŸå› :{}\",bucket,objectName,e.getMessage(),e);\r\n        XueChengPlusException.cast(\"ä¸Šä¼ æ–‡ä»¶åˆ°æ–‡ä»¶ç³»ç»Ÿå¤±è´¥\");\r\n    }\r\n    return false;\r\n}\r\n\r\n/**\r\n * @description å°†æ–‡ä»¶ä¿¡æ¯æ·»åŠ åˆ°æ–‡ä»¶è¡¨\r\n * @param companyId  æœºæ„id\r\n * @param fileMd5  æ–‡ä»¶md5å€¼\r\n * @param uploadFileParamsDto  ä¸Šä¼ æ–‡ä»¶çš„ä¿¡æ¯\r\n * @param bucket  æ¡¶\r\n * @param objectName å¯¹è±¡åç§°\r\n * @return com.xuecheng.media.model.po.MediaFiles\r\n */\r\n@Transactional\r\npublic MediaFiles addMediaFilesToDb(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName){\r\n    //ä»æ•°æ®åº“æŸ¥è¯¢æ–‡ä»¶\r\n    MediaFiles mediaFiles = mediaFilesMapper.selectById(fileMd5);\r\n    if (mediaFiles == null) {\r\n        mediaFiles = new MediaFiles();\r\n        //æ‹·è´åŸºæœ¬ä¿¡æ¯\r\n        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);\r\n        mediaFiles.setId(fileMd5);\r\n        mediaFiles.setFileId(fileMd5);\r\n        mediaFiles.setCompanyId(companyId);\r\n        mediaFiles.setUrl(\"/\" + bucket + \"/\" + objectName);\r\n        mediaFiles.setBucket(bucket);\r\n        mediaFiles.setFilePath(objectName);\r\n        mediaFiles.setCreateDate(LocalDateTime.now());\r\n        mediaFiles.setAuditStatus(\"002003\");\r\n        mediaFiles.setStatus(\"1\");\r\n        //ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°æ–‡ä»¶è¡¨\r\n        int insert = mediaFilesMapper.insert(mediaFiles);\r\n        if (insert < 0) {\r\n            log.error(\"ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°æ•°æ®åº“å¤±è´¥,{}\",mediaFiles.toString());\r\n            XueChengPlusException.cast(\"ä¿å­˜æ–‡ä»¶ä¿¡æ¯å¤±è´¥\");\r\n        }\r\n        log.debug(\"ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°æ•°æ®åº“æˆåŠŸ,{}\",mediaFiles.toString());\r\n\r\n    }\r\n    return mediaFiles;\r\n\r\n}\r\n@Transactional\r\n@Override\r\npublic UploadFileResultDto uploadFile(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath) {\r\n    File file = new File(localFilePath);\r\n    if (!file.exists()) {\r\n        XueChengPlusException.cast(\"æ–‡ä»¶ä¸å­˜åœ¨\");\r\n    }\r\n    //æ–‡ä»¶åç§°\r\n    String filename = uploadFileParamsDto.getFilename();\r\n    //æ–‡ä»¶æ‰©å±•å\r\n    String extension = filename.substring(filename.lastIndexOf(\".\"));\r\n    //æ–‡ä»¶mimeType\r\n    String mimeType = getMimeType(extension);\r\n    //æ–‡ä»¶çš„md5å€¼\r\n    String fileMd5 = getFileMd5(file);\r\n    //æ–‡ä»¶çš„é»˜è®¤ç›®å½•\r\n    String defaultFolderPath = getDefaultFolderPath();\r\n    //å­˜å‚¨åˆ°minioä¸­çš„å¯¹è±¡å(å¸¦ç›®å½•)\r\n    String  objectName = defaultFolderPath + fileMd5 + exension;\r\n    //å°†æ–‡ä»¶ä¸Šä¼ åˆ°minio\r\n    boolean b = addMediaFilesToMinIO(localFilePath, mimeType, bucket_files, objectName);\r\n    //æ–‡ä»¶å¤§å°\r\n    uploadFileParamsDto.setFileSize(file.length());\r\n    //å°†æ–‡ä»¶ä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®åº“\r\n    MediaFiles mediaFiles = addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_files, objectName);\r\n    //å‡†å¤‡è¿”å›æ•°æ®\r\n    UploadFileResultDto uploadFileResultDto = new UploadFileResultDto();\r\n    BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);\r\n    return uploadFileResultDto;\r\n\r\n}\r\n```\r\n\r\n ä¿®æ”¹ç‰ˆ\r\n\r\n```java\r\n//å°†æ–‡ä»¶ä¿¡æ¯æ·»åŠ åˆ°æ–‡ä»¶è¡¨æ·»åŠ åˆ°serviceæ¥å£\r\nMediaFiles addMediaFilesToDb(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName);\r\n/*-----------------------------------------------------------------------------------------------------------------------*/\r\n//æ³¨å…¥è‡ªèº«\r\n@Autowired\r\nMediaFileService currentProxy;\r\n\r\n/**\r\n     * @description å°†æ–‡ä»¶ä¿¡æ¯æ·»åŠ åˆ°æ–‡ä»¶è¡¨\r\n     * @param companyId  æœºæ„id\r\n     * @param fileMd5  æ–‡ä»¶md5å€¼\r\n     * @param uploadFileParamsDto  ä¸Šä¼ æ–‡ä»¶çš„ä¿¡æ¯\r\n     * @param bucket  æ¡¶\r\n     * @param objectName å¯¹è±¡åç§°\r\n     * @return com.xuecheng.media.model.po.MediaFiles\r\n     */\r\n    @Override\r\n    @Transactional\r\n    public MediaFiles addMediaFilesToDb(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName){\r\n        //å°†æ–‡ä»¶ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“\r\n        MediaFiles mediaFiles = mediaFilesMapper.selectById(fileMd5);\r\n        if(mediaFiles == null){\r\n            mediaFiles = new MediaFiles();\r\n            BeanUtils.copyProperties(uploadFileParamsDto,mediaFiles);\r\n            //æ–‡ä»¶id\r\n            mediaFiles.setId(fileMd5);\r\n            //æœºæ„id\r\n            mediaFiles.setCompanyId(companyId);\r\n            //æ¡¶\r\n            mediaFiles.setBucket(bucket);\r\n            //file_path\r\n            mediaFiles.setFilePath(objectName);\r\n            //file_id\r\n            mediaFiles.setFileId(fileMd5);\r\n            //url\r\n            mediaFiles.setUrl(\"/\"+bucket+\"/\"+objectName);\r\n            //ä¸Šä¼ æ—¶é—´\r\n            mediaFiles.setCreateDate(LocalDateTime.now());\r\n            //çŠ¶æ€\r\n            mediaFiles.setStatus(\"1\");\r\n            //å®¡æ ¸çŠ¶æ€\r\n            mediaFiles.setAuditStatus(\"002003\");\r\n            //æ’å…¥æ•°æ®åº“\r\n            int insert = mediaFilesMapper.insert(mediaFiles);\r\n            if(insert<=0){\r\n                log.debug(\"å‘æ•°æ®åº“ä¿å­˜æ–‡ä»¶å¤±è´¥,bucket:{},objectName:{}\",bucket,objectName);\r\n                return null;\r\n            }\r\n            //æ·»åŠ åˆ°å¾…å¤„ç†ä»»åŠ¡è¡¨\r\n            addWaitingTask(mediaFiles);\r\n            log.debug(\"ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°æ•°æ®åº“æˆåŠŸ,{}\", mediaFiles.toString());\r\n\r\n        }\r\n        return mediaFiles;\r\n\r\n    }\r\n\r\n@Override\r\npublic UploadFileResultDto uploadFile(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath, String objectName) {\r\n\r\n    //æ–‡ä»¶å\r\n    String filename = uploadFileParamsDto.getFilename();\r\n    //å…ˆå¾—åˆ°æ‰©å±•å\r\n    String extension = filename.substring(filename.lastIndexOf(\".\"));\r\n\r\n    //å¾—åˆ°mimeType\r\n    String mimeType = getMimeType(extension);\r\n\r\n    //å­ç›®å½•\r\n    String defaultFolderPath = getDefaultFolderPath();\r\n    //æ–‡ä»¶çš„md5å€¼\r\n    String fileMd5 = getFileMd5(new File(localFilePath));\r\n    if (StringUtil.isEmpty(objectName)){\r\n        //                      2023/6/23/  adgfgetgwg24f4gr.jpg\r\n        objectName = defaultFolderPath+fileMd5+extension;\r\n    }\r\n    //ä¸Šä¼ æ–‡ä»¶åˆ°minio\r\n    boolean result = addMediaFilesToMinIO(localFilePath, mimeType, bucket_mediafiles, objectName);\r\n    if(!result){\r\n        XueChengPlusException.cast(\"ä¸Šä¼ æ–‡ä»¶å¤±è´¥\");\r\n    }\r\n    //å…¥åº“æ–‡ä»¶ä¿¡æ¯\r\n    MediaFiles mediaFiles = currentProxy.addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_mediafiles, objectName);\r\n    if(mediaFiles==null){\r\n        XueChengPlusException.cast(\"æ–‡ä»¶ä¸Šä¼ åä¿å­˜ä¿¡æ¯å¤±è´¥\");\r\n    }\r\n    //å‡†å¤‡è¿”å›çš„å¯¹è±¡\r\n    UploadFileResultDto uploadFileResultDto = new UploadFileResultDto();\r\n    BeanUtils.copyProperties(mediaFiles,uploadFileResultDto);\r\n\r\n    return uploadFileResultDto;\r\n}\r\n```\r\n\r\n#### **2.4.3 å®Œå–„æ¥å£å±‚**\r\n\r\nå®Œå–„æ¥å£å±‚ä»£ç  ï¼š\r\n\r\n```java\r\n@ApiOperation(\"ä¸Šä¼ æ–‡ä»¶\")\r\n@RequestMapping(value = \"/upload/coursefile\",consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\r\n@ResponseBody\r\npublic UploadFileResultDto upload(@RequestPart(\"filedata\") MultipartFile upload,@RequestParam(value = \"folder\",required=false) String folder,@RequestParam(value = \"objectName\",required=false) String objectName) throws IOException {\r\n\r\n        Long companyId = 1232141425L;\r\n    UploadFileParamsDto uploadFileParamsDto = new UploadFileParamsDto();\r\n    //æ–‡ä»¶å¤§å°\r\n    uploadFileParamsDto.setFileSize(filedata.getSize());\r\n    //å›¾ç‰‡\r\n    uploadFileParamsDto.setFileType(\"001001\");\r\n    //æ–‡ä»¶åç§°\r\n    uploadFileParamsDto.setFilename(filedata.getOriginalFilename());//æ–‡ä»¶åç§°\r\n    //æ–‡ä»¶å¤§å°\r\n    long fileSize = filedata.getSize();\r\n    uploadFileParamsDto.setFileSize(fileSize);\r\n    //åˆ›å»ºä¸´æ—¶æ–‡ä»¶\r\n    File tempFile = File.createTempFile(\"minio\", \"temp\");\r\n    //ä¸Šä¼ çš„æ–‡ä»¶æ‹·è´åˆ°ä¸´æ—¶æ–‡ä»¶\r\n    filedata.transferTo(tempFile);\r\n    //æ–‡ä»¶è·¯å¾„\r\n    String absolutePath = tempFile.getAbsolutePath();\r\n    //ä¸Šä¼ æ–‡ä»¶\r\n    UploadFileResultDto uploadFileResultDto = mediaFileService.uploadFile(companyId, uploadFileParamsDto, absolutePath);\r\n    \r\n    return uploadFileResultDto;\r\n}\r\n\r\n\t//ä¿®æ”¹ç‰ˆ\r\n \t@ApiOperation(\"ä¸Šä¼ å›¾ç‰‡\")\r\n    @RequestMapping(value = \"/upload/coursefile\",consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\r\n    public UploadFileResultDto upload(@RequestPart(\"filedata\") MultipartFile filedata,\r\n                                      @RequestParam(value= \"objectName\",required=false) String objectName) throws IOException {\r\n\r\n        //å‡†å¤‡ä¸Šä¼ æ–‡ä»¶çš„ä¿¡æ¯\r\n        UploadFileParamsDto uploadFileParamsDto = new UploadFileParamsDto();\r\n        //åŸå§‹æ–‡ä»¶åç§°\r\n        uploadFileParamsDto.setFilename(filedata.getOriginalFilename());\r\n        //æ–‡ä»¶å¤§å°\r\n        uploadFileParamsDto.setFileSize(filedata.getSize());\r\n        //æ–‡ä»¶ç±»å‹\r\n        uploadFileParamsDto.setFileType(\"001001\");\r\n        //åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶\r\n        File tempFile = File.createTempFile(\"minio\", \".temp\");\r\n        //å°†æœ¬åœ°è¦ä¸Šä¼ çš„æ–‡ä»¶æ‹·è´åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œæ‹¿åˆ°æœ¬åœ°è·¯å¾„\r\n        filedata.transferTo(tempFile);\r\n        Long companyId = 1232141425L;\r\n        //æ–‡ä»¶è·¯å¾„\r\n        String localFilePath = tempFile.getAbsolutePath();\r\n\r\n        //è°ƒç”¨serviceä¸Šä¼ å›¾ç‰‡\r\n        UploadFileResultDto uploadFileResultDto = mediaFileService.uploadFile(companyId, uploadFileParamsDto, localFilePath, objectName);\r\n\r\n        return uploadFileResultDto;\r\n    }\r\n```\r\n\r\n \r\n\r\n#### **2.4.4 æ¥å£æµ‹è¯•**\r\n\r\n1ã€é¦–å…ˆä½¿ç”¨httpclientæµ‹è¯•\r\n\r\n```http\r\n### ä¸Šä¼ æ–‡ä»¶\r\nPOST {{media_host}}/media/upload/coursefile\r\nContent-Type: multipart/form-data; boundary=WebAppBoundary\r\n\r\n--WebAppBoundary\r\nContent-Disposition: form-data; name=\"filedata\"; filename=\"1.jpg\"\r\nContent-Type: application/octet-stream\r\n\r\n< d:/develop/upload/1.jpg\r\n```\r\n\r\n2ã€å†è¿›è¡Œå‰åç«¯è”è°ƒæµ‹è¯•\r\n\r\nåœ¨æ–°å¢è¯¾ç¨‹ã€ç¼–è¾‘è¯¾ç¨‹ç•Œé¢ä¸Šä¼ å›¾ï¼Œä¿å­˜è¯¾ç¨‹ä¿¡æ¯åå†æ¬¡è¿›å…¥ç¼–è¾‘è¯¾ç¨‹ç•Œé¢ï¼ŒæŸ¥çœ‹æ˜¯å¦å¯ä»¥æ­£å¸¸ä¿å­˜è¯¾ç¨‹å›¾ç‰‡ä¿¡æ¯ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps77.jpg) \r\n\r\nä¸Šå›¾å›¾ç‰‡å®Œæˆåï¼Œè¿›å…¥åª’èµ„ç®¡ç†ï¼ŒæŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨ä¸­æ˜¯å¦æœ‰åˆšåˆšä¸Šä¼ çš„å›¾ç‰‡ä¿¡æ¯ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps78.jpg) \r\n\r\n \r\n\r\n#### **2.4.5 Serviceäº‹åŠ¡ä¼˜åŒ–**\r\n\r\nä¸Šè¾¹çš„serviceæ–¹æ³•ä¼˜åŒ–åå¹¶æµ‹è¯•é€šè¿‡ï¼Œç°åœ¨æ€è€ƒå…³äºuploadFileæ–¹æ³•çš„æ˜¯å¦åº”è¯¥å¼€å¯äº‹åŠ¡ã€‚\r\n\r\nç›®å‰æ˜¯åœ¨uploadFileæ–¹æ³•ä¸Šæ·»åŠ `@Transactional`ï¼Œå½“è°ƒç”¨uploadFileæ–¹æ³•å‰ä¼šå¼€å¯æ•°æ®åº“äº‹åŠ¡ï¼Œå¦‚æœä¸Šä¼ æ–‡ä»¶è¿‡ç¨‹æ—¶é—´è¾ƒé•¿é‚£ä¹ˆæ•°æ®åº“çš„äº‹åŠ¡æŒç»­æ—¶é—´å°±ä¼šå˜é•¿ï¼Œè¿™æ ·æ•°æ®åº“é“¾æ¥é‡Šæ”¾å°±æ…¢ï¼Œæœ€ç»ˆå¯¼è‡´æ•°æ®åº“é“¾æ¥ä¸å¤Ÿç”¨ã€‚\r\n\r\næˆ‘ä»¬åªå°†addMediaFilesToDbæ–¹æ³•æ·»åŠ äº‹åŠ¡æ§åˆ¶å³å¯,uploadFileæ–¹æ³•ä¸Šçš„`@Transactional`æ³¨è§£å»æ‰ã€‚\r\n\r\nä¼˜åŒ–åå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n/**\r\n * @description å°†æ–‡ä»¶ä¿¡æ¯æ·»åŠ åˆ°æ–‡ä»¶è¡¨\r\n * @param companyId  æœºæ„id\r\n * @param fileMd5  æ–‡ä»¶md5å€¼\r\n * @param uploadFileParamsDto  ä¸Šä¼ æ–‡ä»¶çš„ä¿¡æ¯\r\n * @param bucket  æ¡¶\r\n * @param objectName å¯¹è±¡åç§°\r\n * @return com.xuecheng.media.model.po.MediaFiles\r\n */\r\n@Override\r\n@Transactional\r\npublic MediaFiles addMediaFilesToDb(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName){\r\n    //å°†æ–‡ä»¶ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“\r\n    MediaFiles mediaFiles = mediaFilesMapper.selectById(fileMd5);\r\n    if(mediaFiles == null){\r\n        mediaFiles = new MediaFiles();\r\n        BeanUtils.copyProperties(uploadFileParamsDto,mediaFiles);\r\n        //æ–‡ä»¶id\r\n        mediaFiles.setId(fileMd5);\r\n        //æœºæ„id\r\n        mediaFiles.setCompanyId(companyId);\r\n        //æ¡¶\r\n        mediaFiles.setBucket(bucket);\r\n        //file_path\r\n        mediaFiles.setFilePath(objectName);\r\n        //file_id\r\n        mediaFiles.setFileId(fileMd5);\r\n        //url\r\n        mediaFiles.setUrl(\"/\"+bucket+\"/\"+objectName);\r\n        //ä¸Šä¼ æ—¶é—´\r\n        mediaFiles.setCreateDate(LocalDateTime.now());\r\n        //çŠ¶æ€\r\n        mediaFiles.setStatus(\"1\");\r\n        //å®¡æ ¸çŠ¶æ€\r\n        mediaFiles.setAuditStatus(\"002003\");\r\n        //æ’å…¥æ•°æ®åº“\r\n        int insert = mediaFilesMapper.insert(mediaFiles);\r\n        if(insert<=0){\r\n            log.debug(\"å‘æ•°æ®åº“ä¿å­˜æ–‡ä»¶å¤±è´¥,bucket:{},objectName:{}\",bucket,objectName);\r\n            return null;\r\n        }\r\n        //æ·»åŠ åˆ°å¾…å¤„ç†ä»»åŠ¡è¡¨\r\n        addWaitingTask(mediaFiles);\r\n        log.debug(\"ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°æ•°æ®åº“æˆåŠŸ,{}\", mediaFiles.toString());\r\n\r\n    }\r\n    return mediaFiles;\r\n\r\n}\r\n```\r\n\r\næˆ‘ä»¬äººä¸ºåœ¨`int insert = mediaFilesMapper.insert(mediaFiles);`ä¸‹è¾¹æ·»åŠ ä¸€ä¸ªå¼‚å¸¸ä»£ç `int a=1/0;`\r\n\r\næµ‹è¯•æ˜¯å¦äº‹åŠ¡æ§åˆ¶ã€‚å¾ˆé—æ†¾ï¼Œäº‹åŠ¡æ§åˆ¶å¤±è´¥ã€‚\r\n\r\næ–¹æ³•ä¸Šå·²ç»æ·»åŠ äº†`@Transactional`æ³¨è§£ä¸ºä»€ä¹ˆè¯¥æ–¹æ³•ä¸èƒ½è¢«äº‹åŠ¡æ§åˆ¶å‘¢ï¼Ÿ\r\n\r\nå¦‚æœæ˜¯åœ¨uploadFileæ–¹æ³•ä¸Šæ·»åŠ `@Transactional`æ³¨è§£å°±å¯ä»¥æ§åˆ¶äº‹åŠ¡ï¼Œå»æ‰åˆ™ä¸è¡Œã€‚\r\n\r\nç°åœ¨çš„é—®é¢˜å…¶å®æ˜¯ä¸€ä¸ªéäº‹åŠ¡æ–¹æ³•è°ƒåŒç±»ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•ï¼Œäº‹åŠ¡æ— æ³•æ§åˆ¶ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ\r\n\r\nä¸‹è¾¹åˆ†æåŸå› ï¼š\r\n\r\nå¦‚æœåœ¨uploadFileæ–¹æ³•ä¸Šæ·»åŠ `@Transactional`æ³¨è§£ï¼Œä»£ç†å¯¹è±¡æ‰§è¡Œæ­¤æ–¹æ³•å‰ä¼šå¼€å¯äº‹åŠ¡ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps79.jpg) \r\n\r\nå¦‚æœåœ¨uploadFileæ–¹æ³•ä¸Šæ²¡æœ‰`@Transactional`æ³¨è§£ï¼Œä»£ç†å¯¹è±¡æ‰§è¡Œæ­¤æ–¹æ³•å‰ä¸è¿›è¡Œäº‹åŠ¡æ§åˆ¶ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps80.jpg) \r\n\r\næ‰€ä»¥åˆ¤æ–­è¯¥æ–¹æ³•æ˜¯å¦å¯ä»¥äº‹åŠ¡æ§åˆ¶å¿…é¡»ä¿è¯æ˜¯é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨æ­¤æ–¹æ³•ï¼Œä¸”æ­¤æ–¹æ³•ä¸Šæ·»åŠ äº†`@Transactional`æ³¨è§£ã€‚\r\n\r\nç°åœ¨åœ¨addMediaFilesToDbæ–¹æ³•ä¸Šæ·»åŠ `@Transactional`æ³¨è§£ï¼Œä¹Ÿä¸ä¼šè¿›è¡Œäº‹åŠ¡æ§åˆ¶æ˜¯å› ä¸ºå¹¶ä¸æ˜¯é€šè¿‡ä»£ç†å¯¹è±¡æ‰§è¡Œçš„addMediaFilesToDbæ–¹æ³•ã€‚ä¸ºäº†åˆ¤æ–­åœ¨uploadFileæ–¹æ³•ä¸­å»è°ƒç”¨addMediaFilesToDbæ–¹æ³•æ˜¯å¦æ˜¯é€šè¿‡ä»£ç†å¯¹è±¡å»è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“æ–­ç‚¹è·Ÿè¸ªã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps81.jpg) \r\n\r\næˆ‘ä»¬å‘ç°åœ¨uploadFileæ–¹æ³•ä¸­å»è°ƒç”¨addMediaFilesToDbæ–¹æ³•ä¸æ˜¯é€šè¿‡ä»£ç†å¯¹è±¡å»è°ƒç”¨ã€‚\r\n\r\n \r\n\r\nå¦‚ä½•è§£å†³å‘¢ï¼Ÿé€šè¿‡ä»£ç†å¯¹è±¡å»è°ƒç”¨addMediaFilesToDbæ–¹æ³•å³å¯è§£å†³ã€‚\r\n\r\nåœ¨MediaFileServiceçš„å®ç°ç±»ä¸­æ³¨å…¥MediaFileServiceçš„ä»£ç†å¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n@Autowired\r\nMediaFileService currentProxy;\r\n```\r\n\r\nå°†addMediaFilesToDbæ–¹æ³•ææˆæ¥å£ã€‚\r\n\r\n```java\r\n/**\r\n * @description å°†æ–‡ä»¶ä¿¡æ¯æ·»åŠ åˆ°æ–‡ä»¶è¡¨\r\n * @param companyId  æœºæ„id\r\n * @param fileMd5  æ–‡ä»¶md5å€¼\r\n * @param uploadFileParamsDto  ä¸Šä¼ æ–‡ä»¶çš„ä¿¡æ¯\r\n * @param bucket  æ¡¶\r\n * @param objectName å¯¹è±¡åç§°\r\n * @return com.xuecheng.media.model.po.MediaFiles\r\n */\r\npublic MediaFiles addMediaFilesToDb(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName);\r\n```\r\n\r\n \r\n\r\nè°ƒç”¨addMediaFilesToDbæ–¹æ³•çš„ä»£ç å¤„æ”¹ä¸ºå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n..... \r\n    //å†™å…¥æ–‡ä»¶è¡¨ \r\n    MediaFiles mediaFiles = currentProxy.addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_files, objectName);  \r\n....\r\n```\r\n\r\nå†æ¬¡æµ‹è¯•äº‹åŠ¡æ˜¯å¦å¯ä»¥æ­£å¸¸æ§åˆ¶ã€‚\r\n\r\n\r\n\r\n## **ä¸‰ ä¸Šä¼ è§†é¢‘**\r\n\r\n### **3.1 éœ€æ±‚åˆ†æ**\r\n\r\n1ã€æ•™å­¦æœºæ„äººå‘˜è¿›å…¥åª’èµ„ç®¡ç†åˆ—è¡¨æŸ¥è¯¢è‡ªå·±ä¸Šä¼ çš„åª’èµ„æ–‡ä»¶ã€‚\r\n\r\nç‚¹å‡»â€œåª’èµ„ç®¡ç†â€\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps82.jpg) \r\n\r\nè¿›å…¥åª’èµ„ç®¡ç†åˆ—è¡¨é¡µé¢æŸ¥è¯¢æœ¬æœºæ„ä¸Šä¼ çš„åª’èµ„æ–‡ä»¶ã€‚\r\n\r\n![image-20230704231746909](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230704231746909.png)\r\n\r\n \r\n\r\n2ã€æ•™è‚²æœºæ„ç”¨æˆ·åœ¨\"åª’èµ„ç®¡ç†\"é¡µé¢ä¸­ç‚¹å‡» \"ä¸Šä¼ è§†é¢‘\" æŒ‰é’®ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps84.jpg) \r\n\r\nç‚¹å‡»â€œä¸Šä¼ è§†é¢‘â€æ‰“å¼€ä¸Šä¼ é¡µé¢\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps85.jpg) \r\n\r\n3ã€é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼Œè‡ªåŠ¨æ‰§è¡Œæ–‡ä»¶ä¸Šä¼ ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps86.jpg) \r\n\r\n4ã€è§†é¢‘ä¸Šä¼ æˆåŠŸä¼šè‡ªåŠ¨å¤„ç†ï¼Œå¤„ç†å®Œæˆå¯ä»¥é¢„è§ˆè§†é¢‘ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps87.jpg) \r\n\r\n \r\n\r\n### **3.2 æ–­ç‚¹ç»­ä¼ æŠ€æœ¯**\r\n\r\n#### **3.2.1 ä»€ä¹ˆæ˜¯æ–­ç‚¹ç»­ä¼ **\r\n\r\né€šå¸¸è§†é¢‘æ–‡ä»¶éƒ½æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥å¯¹äºåª’èµ„ç³»ç»Ÿä¸Šä¼ æ–‡ä»¶çš„éœ€æ±‚è¦æ»¡è¶³å¤§æ–‡ä»¶çš„ä¸Šä¼ è¦æ±‚ã€‚httpåè®®æœ¬èº«å¯¹ä¸Šä¼ æ–‡ä»¶å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œä½†æ˜¯å®¢æˆ·çš„ç½‘ç»œç¯å¢ƒè´¨é‡ã€ç”µè„‘ç¡¬ä»¶ç¯å¢ƒç­‰å‚å·®ä¸é½ï¼Œå¦‚æœä¸€ä¸ªå¤§æ–‡ä»¶å¿«ä¸Šä¼ å®Œäº†ç½‘æ–­äº†æ²¡æœ‰ä¸Šä¼ å®Œæˆï¼Œéœ€è¦å®¢æˆ·é‡æ–°ä¸Šä¼ ï¼Œç”¨æˆ·ä½“éªŒéå¸¸å·®ï¼Œæ‰€ä»¥å¯¹äºå¤§æ–‡ä»¶ä¸Šä¼ çš„è¦æ±‚æœ€åŸºæœ¬çš„æ˜¯æ–­ç‚¹ç»­ä¼ ã€‚\r\n\r\nä»€ä¹ˆæ˜¯æ–­ç‚¹ç»­ä¼ ï¼š\r\n\r\nâ€‹    å¼•ç”¨ç™¾åº¦ç™¾ç§‘ï¼šæ–­ç‚¹ç»­ä¼ æŒ‡çš„æ˜¯åœ¨ä¸‹è½½æˆ–ä¸Šä¼ æ—¶ï¼Œå°†ä¸‹è½½æˆ–ä¸Šä¼ ä»»åŠ¡ï¼ˆä¸€ä¸ªæ–‡ä»¶æˆ–ä¸€ä¸ªå‹ç¼©åŒ…ï¼‰äººä¸ºçš„åˆ’åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸€ä¸ªéƒ¨åˆ†é‡‡ç”¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œä¸Šä¼ æˆ–ä¸‹è½½ï¼Œå¦‚æœç¢°åˆ°ç½‘ç»œæ•…éšœï¼Œå¯ä»¥ä»å·²ç»ä¸Šä¼ æˆ–ä¸‹è½½çš„éƒ¨åˆ†å¼€å§‹ç»§ç»­ä¸Šä¼ ä¸‹è½½æœªå®Œæˆçš„éƒ¨åˆ†ï¼Œè€Œæ²¡æœ‰å¿…è¦ä»å¤´å¼€å§‹ä¸Šä¼ ä¸‹è½½ï¼Œæ–­ç‚¹ç»­ä¼ å¯ä»¥æé«˜èŠ‚çœæ“ä½œæ—¶é—´ï¼Œæé«˜ç”¨æˆ·ä½“éªŒæ€§ã€‚\r\n\r\næ–­ç‚¹ç»­ä¼ æµç¨‹å¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps88.jpg) \r\n\r\næµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n1ã€å‰ç«¯ä¸Šä¼ å‰å…ˆæŠŠæ–‡ä»¶åˆ†æˆå—\r\n\r\n2ã€ä¸€å—ä¸€å—çš„ä¸Šä¼ ï¼Œä¸Šä¼ ä¸­æ–­åé‡æ–°ä¸Šä¼ ï¼Œå·²ä¸Šä¼ çš„åˆ†å—åˆ™ä¸ç”¨å†ä¸Šä¼ \r\n\r\n3ã€å„åˆ†å—ä¸Šä¼ å®Œæˆæœ€ååœ¨æœåŠ¡ç«¯åˆå¹¶æ–‡ä»¶\r\n\r\n#### **3.2.2 åˆ†å—ä¸åˆå¹¶æµ‹è¯•**\r\n\r\nä¸ºäº†æ›´å¥½çš„ç†è§£æ–‡ä»¶åˆ†å—ä¸Šä¼ çš„åŸç†ï¼Œä¸‹è¾¹ç”¨javaä»£ç æµ‹è¯•æ–‡ä»¶çš„åˆ†å—ä¸åˆå¹¶ã€‚\r\n\r\næ–‡ä»¶åˆ†å—çš„æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n1ã€è·å–æºæ–‡ä»¶é•¿åº¦\r\n\r\n2ã€æ ¹æ®è®¾å®šçš„åˆ†å—æ–‡ä»¶çš„å¤§å°è®¡ç®—å‡ºå—æ•°\r\n\r\n3ã€ä»æºæ–‡ä»¶è¯»æ•°æ®ä¾æ¬¡å‘æ¯ä¸€ä¸ªå—æ–‡ä»¶å†™æ•°æ®ã€‚\r\n\r\næµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2023/06/23 19:43\r\n * @description æµ‹è¯•å¤§æ–‡ä»¶ä¸Šä¼ æ–¹æ³•\r\n */\r\npublic class BigFileTest {\r\n    //åˆ†å—æµ‹è¯•\r\n    @Test\r\n    public void testChunk() throws IOException {\r\n        //æºæ–‡ä»¶\r\n        File sourceFile = new File(\"D:\\\\Learning\\\\upload\\\\1.mkv\");\r\n        //åˆ†å—æ–‡ä»¶å­˜å‚¨è·¯å¾„\r\n        String chunkFilePath = \"D:\\\\Learning\\\\upload\\\\chunk\\\\\";\r\n        //åˆ†å—æ–‡ä»¶å¤§å°\r\n        //long chunkSize = 1024 * 1024 * 1;\r\n        int chunkSize = 1024 * 1024 * 5;\r\n        //åˆ†å—æ–‡ä»¶ä¸ªæ•°\r\n        int chunkNum = (int) Math.ceil(sourceFile.length() * 1.0 / chunkSize);\r\n        //ä½¿ç”¨æµä»æºæ–‡ä»¶è¯»æ•°æ®ï¼Œå‘åˆ†å—æ–‡ä»¶ä¸­å†™æ•°æ®\r\n        RandomAccessFile raf_r = new RandomAccessFile(sourceFile, \"r\");\r\n        //ç¼“å­˜åŒº\r\n        byte[] bytes = new byte[1024];\r\n        for (int i = 0; i < chunkNum; i++) {\r\n            File chunkFile = new File(chunkFilePath + i);\r\n            //åˆ†å—æ–‡ä»¶å†™å…¥æµ\r\n            RandomAccessFile raf_rw = new RandomAccessFile(chunkFile, \"rw\");\r\n            int len = -1;\r\n            while ((len=raf_r.read(bytes))!=-1){\r\n                raf_rw.write(bytes,0,len);\r\n                if(chunkFile.length()>=chunkSize){\r\n                    break;\r\n                }\r\n            }\r\n            raf_rw.close();\r\n        }\r\n        raf_r.close();\r\n\r\n    }\r\n}\r\n```\r\n\r\næ–‡ä»¶åˆå¹¶æµç¨‹ï¼š\r\n\r\n1ã€æ‰¾åˆ°è¦åˆå¹¶çš„æ–‡ä»¶å¹¶æŒ‰æ–‡ä»¶åˆå¹¶çš„å…ˆåè¿›è¡Œæ’åºã€‚\r\n\r\n2ã€åˆ›å»ºåˆå¹¶æ–‡ä»¶\r\n\r\n3ã€ä¾æ¬¡ä»åˆå¹¶çš„æ–‡ä»¶ä¸­è¯»å–æ•°æ®å‘åˆå¹¶æ–‡ä»¶å†™å…¥æ•°\r\n\r\næ–‡ä»¶åˆå¹¶çš„æµ‹è¯•ä»£ç  ï¼š\r\n\r\n```java\r\n//å°†åˆ†å—è¿›è¡Œåˆå¹¶\r\n@Test\r\npublic void testMerge() throws IOException {\r\n    //å—æ–‡ä»¶ç›®å½•\r\n    File chunkFolder = new File(\"D:\\\\Learning\\\\upload\\\\chunk\");\r\n    //æºæ–‡ä»¶\r\n    File sourceFile = new File(\"D:\\\\Learning\\\\upload\\\\1.mkv\");\r\n    //åˆå¹¶åçš„æ–‡ä»¶\r\n    File mergeFile = new File(\"D:\\\\Learning\\\\upload\\\\1_1.mkv\");\r\n\r\n    //å–å‡ºæ‰€æœ‰åˆ†å—æ–‡ä»¶\r\n    File[] files = chunkFolder.listFiles();\r\n    //å°†æ•°ç»„è½¬æˆlist\r\n    List<File> filesList = Arrays.asList(files);\r\n    //å¯¹åˆ†å—æ–‡ä»¶æ’åº\r\n    Collections.sort(filesList, new Comparator<File>() {\r\n        @Override\r\n        public int compare(File o1, File o2) {\r\n            return Integer.parseInt(o1.getName())-Integer.parseInt(o2.getName());\r\n        }\r\n    });\r\n    //å‘åˆå¹¶æ–‡ä»¶å†™çš„æµ\r\n    RandomAccessFile raf_rw = new RandomAccessFile(mergeFile, \"rw\");\r\n    //ç¼“å­˜åŒº\r\n    byte[] bytes = new byte[1024];\r\n    //éå†åˆ†å—æ–‡ä»¶ï¼Œå‘åˆå¹¶ çš„æ–‡ä»¶å†™\r\n    for (File file : filesList) {\r\n        //è¯»åˆ†å—çš„æµ\r\n        RandomAccessFile raf_r = new RandomAccessFile(file, \"r\");\r\n        int len = -1;\r\n        while ((len=raf_r.read(bytes))!=-1){\r\n            raf_rw.write(bytes,0,len);\r\n        }\r\n        raf_r.close();\r\n\r\n    }\r\n    raf_rw.close();\r\n    //åˆå¹¶æ–‡ä»¶å®Œæˆåå¯¹åˆå¹¶çš„æ–‡ä»¶md5æ ¡éªŒ\r\n    FileInputStream fileInputStream_merge = new FileInputStream(mergeFile);\r\n    FileInputStream fileInputStream_source = new FileInputStream(sourceFile);\r\n    String md5_merge = DigestUtils.md5Hex(fileInputStream_merge);\r\n    String md5_source = DigestUtils.md5Hex(fileInputStream_source);\r\n    if(md5_merge.equals(md5_source)){\r\n        System.out.println(\"æ–‡ä»¶åˆå¹¶æˆåŠŸ\");\r\n    }\r\n\r\n}\r\n```\r\n\r\n#### **3.2.3 è§†é¢‘ä¸Šä¼ æµç¨‹**\r\n\r\nä¸‹å›¾æ˜¯ä¸Šä¼ è§†é¢‘çš„æ•´ä½“æµç¨‹ï¼š\r\n\r\n![image-20230704232249335](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230704232249335.png)\r\n\r\n1ã€å‰ç«¯å¯¹æ–‡ä»¶è¿›è¡Œåˆ†å—ã€‚\r\n\r\n2ã€å‰ç«¯ä¸Šä¼ åˆ†å—æ–‡ä»¶å‰è¯·æ±‚åª’èµ„æœåŠ¡æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™ä¸å†ä¸Šä¼ ã€‚\r\n\r\n3ã€å¦‚æœåˆ†å—æ–‡ä»¶ä¸å­˜åœ¨åˆ™å‰ç«¯å¼€å§‹ä¸Šä¼ \r\n\r\n4ã€å‰ç«¯è¯·æ±‚åª’èµ„æœåŠ¡ä¸Šä¼ åˆ†å—ã€‚\r\n\r\n5ã€åª’èµ„æœåŠ¡å°†åˆ†å—ä¸Šä¼ è‡³MinIOã€‚\r\n\r\n6ã€å‰ç«¯å°†åˆ†å—ä¸Šä¼ å®Œæ¯•è¯·æ±‚åª’èµ„æœåŠ¡åˆå¹¶åˆ†å—ã€‚\r\n\r\n7ã€åª’èµ„æœåŠ¡åˆ¤æ–­åˆ†å—ä¸Šä¼ å®Œæˆåˆ™è¯·æ±‚MinIOåˆå¹¶æ–‡ä»¶ã€‚\r\n\r\n8ã€åˆå¹¶å®Œæˆæ ¡éªŒåˆå¹¶åçš„æ–‡ä»¶æ˜¯å¦å®Œæ•´ï¼Œå¦‚æœå®Œæ•´åˆ™ä¸Šä¼ å®Œæˆï¼Œå¦åˆ™åˆ é™¤æ–‡ä»¶ã€‚\r\n\r\n \r\n\r\n#### **3.2.4 minioåˆå¹¶æ–‡ä»¶æµ‹è¯•**\r\n\r\n1ã€å°†åˆ†å—æ–‡ä»¶ä¸Šä¼ è‡³minio\r\n\r\n```java\r\n//å°†åˆ†å—æ–‡ä»¶ä¸Šä¼ åˆ°minio\r\n@Test\r\npublic void uploadChunk() throws IOException,  InsufficientDataException, ErrorResponseException, NoSuchAlgorithmException,  InvalidResponseException, XmlParserException, InternalException, ServerException, InvalidKeyException {\r\n\r\n    for (int i = 0; i < 3; i++) {\r\n        //ä¸Šä¼ æ–‡ä»¶çš„å‚æ•°ä¿¡æ¯\r\n        UploadObjectArgs uploadObjectArgs = UploadObjectArgs.builder()\r\n                .bucket(\"testbucket\")//æ¡¶\r\n                .filename(\"D:\\\\Learning\\\\upload\\\\chunk\\\\\"+i) //æŒ‡å®šæœ¬åœ°æ–‡ä»¶è·¯å¾„\r\n                .object(\"chunk/\"+i)//å¯¹è±¡å æ”¾åœ¨å­ç›®å½•ä¸‹\r\n                .build();\r\n\r\n        //ä¸Šä¼ æ–‡ä»¶\r\n        minioClient.uploadObject(uploadObjectArgs);\r\n        System.out.println(\"ä¸Šä¼ åˆ†å—\"+i+\"æˆåŠŸ\");\r\n    }\r\n\r\n}\r\n```\r\n\r\n \r\n\r\n2ã€é€šè¿‡minioçš„åˆå¹¶æ–‡ä»¶\r\n\r\n```java\r\n//åˆå¹¶æ–‡ä»¶ï¼Œè¦æ±‚åˆ†å—æ–‡ä»¶æœ€å°5M\r\n    @Test\r\n    public void testMerge() throws Exception {\r\n\r\n//        List<ComposeSource> sources = new ArrayList<>();\r\n//        for (int i = 0; i < 30; i++) {\r\n//            //æŒ‡å®šåˆ†å—æ–‡ä»¶çš„ä¿¡æ¯\r\n//            ComposeSource composeSource = ComposeSource.builder().bucket(\"testbucket\").object(\"chunk/\" + i).build();\r\n//            sources.add(composeSource);\r\n//        }\r\n\r\n        List<ComposeSource> sources = Stream.iterate(0, i -> ++i).limit(3).map(i -> ComposeSource.builder().bucket(\"testbucket\").object(\"chunk/\" + i).build()).collect(Collectors.toList());\r\n\r\n        //æŒ‡å®šåˆå¹¶åçš„objectNameç­‰ä¿¡æ¯\r\n        ComposeObjectArgs composeObjectArgs = ComposeObjectArgs.builder()\r\n                .bucket(\"testbucket\")\r\n                .object(\"merge01.mp4\")\r\n                .sources(sources)//æŒ‡å®šæºæ–‡ä»¶\r\n                .build();\r\n        //åˆå¹¶æ–‡ä»¶,\r\n        //æŠ¥é”™size 1048576 must be greater than 5242880ï¼Œminioé»˜è®¤çš„åˆ†å—æ–‡ä»¶å¤§å°ä¸º5M\r\n        minioClient.composeObject(composeObjectArgs);\r\n\r\n    }\r\n//æ¸…é™¤åˆ†å—æ–‡ä»¶\r\n@Test\r\npublic void test_removeObjects(){\r\n    //åˆå¹¶åˆ†å—å®Œæˆå°†åˆ†å—æ–‡ä»¶æ¸…é™¤\r\n    List<DeleteObject> deleteObjects = Stream.iterate(0, i -> ++i)\r\n            .limit(6)\r\n            .map(i -> new DeleteObject(\"chunk/\".concat(Integer.toString(i))))\r\n            .collect(Collectors.toList());\r\n\r\n    RemoveObjectsArgs removeObjectsArgs = RemoveObjectsArgs.builder().bucket(\"testbucket\").objects(deleteObjects).build();\r\n    Iterable<Result<DeleteError>> results = minioClient.removeObjects(removeObjectsArgs);\r\n    results.forEach(r->{\r\n        DeleteError deleteError = null;\r\n        try {\r\n            deleteError = r.get();\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n        }\r\n    });\r\n}\r\n```\r\n\r\nä½¿ç”¨minioåˆå¹¶æ–‡ä»¶æŠ¥é”™ï¼š`java.lang.IllegalArgumentException: source testbucket/chunk/0: size 1048576 must be greater than 5242880`\r\n\r\nminioåˆå¹¶æ–‡ä»¶é»˜è®¤åˆ†å—æœ€å°5Mï¼Œæˆ‘ä»¬å°†åˆ†å—æ”¹ä¸º5Må†æ¬¡æµ‹è¯•ã€‚\r\n\r\n \r\n\r\n \r\n\r\n### **3.3 æ¥å£å®šä¹‰**\r\n\r\næ ¹æ®ä¸Šä¼ è§†é¢‘æµç¨‹ï¼Œå®šä¹‰æ¥å£ï¼Œä¸å‰ç«¯çš„çº¦å®šæ˜¯æ“ä½œæˆåŠŸè¿”å›`{code:0}`å¦åˆ™è¿”å›`{code:-1}`\r\n\r\nä»è¯¾ç¨‹èµ„æ–™ä¸­æ‹·è´`RestResponse.java`ç±»åˆ°baseå·¥ç¨‹ä¸‹çš„modelåŒ…ä¸‹ã€‚\r\n\r\nå®šä¹‰æ¥å£å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n@Api(value = \"å¤§æ–‡ä»¶ä¸Šä¼ æ¥å£\", tags = \"å¤§æ–‡ä»¶ä¸Šä¼ æ¥å£\")\r\n@RestController\r\npublic class BigFilesController {\r\n\r\n\r\n    @ApiOperation(value = \"æ–‡ä»¶ä¸Šä¼ å‰æ£€æŸ¥æ–‡ä»¶\")\r\n    @PostMapping(\"/upload/checkfile\")\r\n    public RestResponse<Boolean> checkfile(\r\n            @RequestParam(\"fileMd5\") String fileMd5\r\n    ) throws Exception {\r\n        return null;\r\n    }\r\n\r\n\r\n    @ApiOperation(value = \"åˆ†å—æ–‡ä»¶ä¸Šä¼ å‰çš„æ£€æµ‹\")\r\n    @PostMapping(\"/upload/checkchunk\")\r\n    public RestResponse<Boolean> checkchunk(@RequestParam(\"fileMd5\") String fileMd5,\r\n                                            @RequestParam(\"chunk\") int chunk) throws Exception {\r\n       return null;\r\n    }\r\n\r\n    @ApiOperation(value = \"ä¸Šä¼ åˆ†å—æ–‡ä»¶\")\r\n    @PostMapping(\"/upload/uploadchunk\")\r\n    public RestResponse uploadchunk(@RequestParam(\"file\") MultipartFile file,\r\n                                    @RequestParam(\"fileMd5\") String fileMd5,\r\n                                    @RequestParam(\"chunk\") int chunk) throws Exception {\r\n        return null;\r\n    }\r\n\r\n    @ApiOperation(value = \"åˆå¹¶æ–‡ä»¶\")\r\n    @PostMapping(\"/upload/mergechunks\")\r\n    public RestResponse mergechunks(@RequestParam(\"fileMd5\") String fileMd5,\r\n                                    @RequestParam(\"fileName\") String fileName,\r\n                                    @RequestParam(\"chunkTotal\") int chunkTotal) throws Exception {\r\n        return null;\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n### **3.4 ä¸Šä¼ åˆ†å—å¼€å‘**\r\n\r\n#### **3.4.1 DAOå¼€å‘**\r\n\r\nå‘åª’èµ„æ•°æ®åº“çš„æ–‡ä»¶è¡¨æ’å…¥è®°å½•ï¼Œä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„Mapperæ¥å£å³å¯æ»¡è¶³è¦æ±‚ã€‚\r\n\r\n#### **3.4.2 Serviceå¼€å‘**\r\n\r\n##### **3.4.2.1 æ£€æŸ¥æ–‡ä»¶å’Œåˆ†å—**\r\n\r\næ¥å£å®Œæˆè¿›è¡Œæ¥å£å®ç°ï¼Œé¦–å…ˆå®ç°æ£€æŸ¥æ–‡ä»¶æ–¹æ³•å’Œæ£€æŸ¥åˆ†å—æ–¹æ³•ã€‚\r\n\r\nåœ¨MediaFileServiceä¸­å®šä¹‰serviceæ¥å£å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n/**\r\n * @description æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨\r\n * @param fileMd5 æ–‡ä»¶çš„md5\r\n * @return com.xuecheng.base.model.RestResponse<java.lang.Boolean> falseä¸å­˜åœ¨ï¼Œtrueå­˜åœ¨\r\n*/\r\npublic RestResponse<Boolean> checkFile(String fileMd5);\r\n\r\n/**\r\n * @description æ£€æŸ¥åˆ†å—æ˜¯å¦å­˜åœ¨\r\n * @param fileMd5  æ–‡ä»¶çš„md5\r\n * @param chunkIndex  åˆ†å—åºå·\r\n * @return com.xuecheng.base.model.RestResponse<java.lang.Boolean> falseä¸å­˜åœ¨ï¼Œtrueå­˜åœ¨\r\n*/\r\npublic RestResponse<Boolean> checkChunk(String fileMd5, int chunkIndex);\r\n```\r\n\r\n \r\n\r\nserviceæ¥å£å®ç°æ–¹æ³•ï¼š\r\n\r\n```java\r\n@Override\r\npublic RestResponse<Boolean> checkFile(String fileMd5) {\r\n    //æŸ¥è¯¢æ–‡ä»¶ä¿¡æ¯\r\n    MediaFiles mediaFiles = mediaFilesMapper.selectById(fileMd5);\r\n    if (mediaFiles != null) {\r\n        //æ¡¶\r\n        String bucket = mediaFiles.getBucket();\r\n        //å­˜å‚¨ç›®å½•\r\n        String filePath = mediaFiles.getFilePath();\r\n        //æ–‡ä»¶æµ\r\n        InputStream stream = null;\r\n        try {\r\n            stream = minioClient.getObject(\r\n                    GetObjectArgs.builder()\r\n                            .bucket(bucket)\r\n                            .object(filePath)\r\n                            .build());\r\n\r\n            if (stream != null) {\r\n                //æ–‡ä»¶å·²å­˜åœ¨\r\n                return RestResponse.success(true);\r\n            }\r\n        } catch (Exception e) {\r\n           \r\n        }\r\n    }\r\n    //æ–‡ä»¶ä¸å­˜åœ¨\r\n    return RestResponse.success(false);\r\n}\r\n\r\n\r\n\r\n@Override\r\npublic RestResponse<Boolean> checkChunk(String fileMd5, int chunkIndex) {\r\n\r\n    //å¾—åˆ°åˆ†å—æ–‡ä»¶ç›®å½•\r\n    String chunkFileFolderPath = getChunkFileFolderPath(fileMd5);\r\n    //å¾—åˆ°åˆ†å—æ–‡ä»¶çš„è·¯å¾„\r\n    String chunkFilePath = chunkFileFolderPath + chunkIndex;\r\n\r\n    //æ–‡ä»¶æµ\r\n    InputStream fileInputStream = null;\r\n    try {\r\n        fileInputStream = minioClient.getObject(\r\n                GetObjectArgs.builder()\r\n                        .bucket(bucket_videoFiles)\r\n                        .object(chunkFilePath)\r\n                        .build());\r\n\r\n        if (fileInputStream != null) {\r\n            //åˆ†å—å·²å­˜åœ¨\r\n            return RestResponse.success(true);\r\n        }\r\n    } catch (Exception e) {\r\n        \r\n    }\r\n    //åˆ†å—æœªå­˜åœ¨\r\n    return RestResponse.success(false);\r\n}\r\n\r\n//å¾—åˆ°åˆ†å—æ–‡ä»¶çš„ç›®å½•\r\nprivate String getChunkFileFolderPath(String fileMd5) {\r\n    return fileMd5.substring(0, 1) + \"/\" + fileMd5.substring(1, 2) + \"/\" + fileMd5 + \"/\" + \"chunk\" + \"/\";\r\n}\r\n\r\n\r\n```\r\n\r\n \r\n\r\n##### **3.4.2.2 ä¸Šä¼ åˆ†å—**\r\n\r\nå®šä¹‰serviceæ¥å£\r\n\r\n```java\r\n/**\r\n * @description ä¸Šä¼ åˆ†å—\r\n * @param fileMd5  æ–‡ä»¶md5\r\n * @param chunk  åˆ†å—åºå·\r\n * @param localChunkFilePath  åˆ†å—æ–‡ä»¶æœ¬åœ°è·¯å¾„\r\n * @return com.xuecheng.base.model.RestResponse\r\n */\r\npublic RestResponse uploadChunk(String fileMd5,int chunk,String localChunkFilePath);\r\n```\r\n\r\næ¥å£å®ç°ï¼š\r\n\r\n```java\r\n@Override\r\npublic RestResponse uploadChunk(String fileMd5, int chunk, String localChunkFilePath) {\r\n\r\n    //å¾—åˆ°åˆ†å—æ–‡ä»¶çš„ç›®å½•è·¯å¾„\r\n    String chunkFileFolderPath = getChunkFileFolderPath(fileMd5);\r\n    //å¾—åˆ°åˆ†å—æ–‡ä»¶çš„è·¯å¾„\r\n    String chunkFilePath = chunkFileFolderPath + chunk;\r\n    //mimeType\r\n    String mimeType = getMimeType(null);\r\n    //å°†æ–‡ä»¶å­˜å‚¨è‡³minIO\r\n    boolean b = addMediaFilesToMinIO(localChunkFilePath, mimeType, bucket_videoFiles, chunkFilePath);\r\n    if (!b) {\r\n        log.debug(\"ä¸Šä¼ åˆ†å—æ–‡ä»¶å¤±è´¥:{}\", chunkFilePath);\r\n        return RestResponse.validfail(false, \"ä¸Šä¼ åˆ†å—å¤±è´¥\");\r\n    }\r\n    log.debug(\"ä¸Šä¼ åˆ†å—æ–‡ä»¶æˆåŠŸ:{}\",chunkFilePath);\r\n    return RestResponse.success(true);\r\n\r\n}\r\n```\r\n\r\n\r\n\r\n##### **3.4.2.3 ä¸Šä¼ åˆ†å—æµ‹è¯•**\r\n\r\nå®Œå–„æ¥å£å±‚ï¼š\r\n\r\n```java\r\n@ApiOperation(value = \"æ–‡ä»¶ä¸Šä¼ å‰æ£€æŸ¥æ–‡ä»¶\")\r\n@PostMapping(\"/upload/checkfile\")\r\npublic RestResponse<Boolean> checkfile(\r\n        @RequestParam(\"fileMd5\") String fileMd5\r\n) throws Exception {\r\n    return mediaFileService.checkFile(fileMd5);\r\n}\r\n\r\n\r\n@ApiOperation(value = \"åˆ†å—æ–‡ä»¶ä¸Šä¼ å‰çš„æ£€æµ‹\")\r\n@PostMapping(\"/upload/checkchunk\")\r\npublic RestResponse<Boolean> checkchunk(@RequestParam(\"fileMd5\") String fileMd5,\r\n                                        @RequestParam(\"chunk\") int chunk) throws Exception {\r\n    return mediaFileService.checkChunk(fileMd5,chunk);\r\n}\r\n\r\n@ApiOperation(value = \"ä¸Šä¼ åˆ†å—æ–‡ä»¶\")\r\n@PostMapping(\"/upload/uploadchunk\")\r\npublic RestResponse uploadchunk(@RequestParam(\"file\") MultipartFile file,\r\n                                @RequestParam(\"fileMd5\") String fileMd5,\r\n                                @RequestParam(\"chunk\") int chunk) throws Exception {\r\n\r\n    //åˆ›å»ºä¸´æ—¶æ–‡ä»¶\r\n    File tempFile = File.createTempFile(\"minio\", \"temp\");\r\n    //ä¸Šä¼ çš„æ–‡ä»¶æ‹·è´åˆ°ä¸´æ—¶æ–‡ä»¶\r\n    file.transferTo(tempFile);\r\n    //æ–‡ä»¶è·¯å¾„\r\n    String absolutePath = tempFile.getAbsolutePath();\r\n    return mediaFileService.uploadChunk(fileMd5,chunk,absolutePath);\r\n}\r\n\r\n```\r\n\r\nå¯åŠ¨å‰ç«¯å·¥ç¨‹ï¼Œè¿›å…¥ä¸Šä¼ è§†é¢‘ç•Œé¢è¿›è¡Œå‰åç«¯è”è°ƒæµ‹è¯•ã€‚\r\n\r\n \r\n\r\nå‰ç«¯å¯¹æ–‡ä»¶åˆ†å—çš„å¤§å°ä¸º5MBï¼ŒSpringBoot webé»˜è®¤ä¸Šä¼ æ–‡ä»¶çš„å¤§å°é™åˆ¶ä¸º1MBï¼Œè¿™é‡Œéœ€è¦åœ¨media-apiå·¥ç¨‹ä¿®æ”¹é…ç½®å¦‚ä¸‹ï¼š\r\n\r\n```yaml\r\nspring:\r\n  servlet:\r\n    multipart:\r\n      max-file-size: 50MB\r\n      max-request-size: 50MB\r\n\r\n```\r\n\r\n`max-file-size`ï¼šå•ä¸ªæ–‡ä»¶çš„å¤§å°é™åˆ¶\r\n\r\n`Max-request-size`: å•æ¬¡è¯·æ±‚çš„å¤§å°é™åˆ¶\r\n\r\nä¸Šä¼ åˆ†å—æ—¶è¢«é™åˆ¶å¤§å°ï¼Œåœ¨æœ¬åœ°`nginx.conf`é…ç½®ï¼š\r\n\r\n```apl\r\n#gzip  on;\r\n#æ–‡ä»¶æœåŠ¡\r\nclient_max_body_size 50m;\r\n```\r\n\r\n\r\n\r\n### **3.5 åˆå¹¶åˆ†å—å¼€å‘**\r\n\r\n#### **3.5.1 serviceå¼€å‘**\r\n\r\nå®šä¹‰serviceæ¥å£ï¼š\r\n\r\n```java\r\n/**\r\n * @description åˆå¹¶åˆ†å—\r\n * @param companyId  æœºæ„id\r\n * @param fileMd5  æ–‡ä»¶md5\r\n * @param chunkTotal åˆ†å—æ€»å’Œ\r\n * @param uploadFileParamsDto æ–‡ä»¶ä¿¡æ¯\r\n * @return com.xuecheng.base.model.RestResponse\r\n */\r\npublic RestResponse mergechunks(Long companyId,String fileMd5,int chunkTotal,UploadFileParamsDto uploadFileParamsDto);\r\n```\r\n\r\nserviceå®ç°ï¼š\r\n\r\n```java\r\nJava\r\n@Override\r\npublic RestResponse mergechunks(Long companyId, String fileMd5, int chunkTotal, UploadFileParamsDto uploadFileParamsDto) {\r\n    //=====è·å–åˆ†å—æ–‡ä»¶è·¯å¾„=====\r\n    String chunkFileFolderPath = getChunkFileFolderPath(fileMd5);\r\n    //ç»„æˆå°†åˆ†å—æ–‡ä»¶è·¯å¾„ç»„æˆ List<ComposeSource>\r\n    List<ComposeSource> sourceObjectList = Stream.iterate(0, i -> ++i)\r\n            .limit(chunkTotal)\r\n            .map(i -> ComposeSource.builder()\r\n                    .bucket(bucket_videoFiles)\r\n                    .object(chunkFileFolderPath.concat(Integer.toString(i)))\r\n                    .build())\r\n            .collect(Collectors.toList());\r\n    //=====åˆå¹¶=====\r\n    //æ–‡ä»¶åç§°\r\n    String fileName = uploadFileParamsDto.getFilename();\r\n    //æ–‡ä»¶æ‰©å±•å\r\n    String extName = fileName.substring(fileName.lastIndexOf(\".\"));\r\n    //åˆå¹¶æ–‡ä»¶è·¯å¾„\r\n    String mergeFilePath = getFilePathByMd5(fileMd5, extName);\r\n    try {\r\n        //åˆå¹¶æ–‡ä»¶\r\n        ObjectWriteResponse response = minioClient.composeObject(\r\n                ComposeObjectArgs.builder()\r\n                        .bucket(bucket_videoFiles)\r\n                        .object(mergeFilePath)\r\n                        .sources(sourceObjectList)\r\n                        .build());\r\n        log.debug(\"åˆå¹¶æ–‡ä»¶æˆåŠŸ:{}\",mergeFilePath);\r\n    } catch (Exception e) {\r\n        log.debug(\"åˆå¹¶æ–‡ä»¶å¤±è´¥,fileMd5:{},å¼‚å¸¸:{}\",fileMd5,e.getMessage(),e);\r\n        return RestResponse.validfail(false, \"åˆå¹¶æ–‡ä»¶å¤±è´¥ã€‚\");\r\n    }\r\n\r\n    // ====éªŒè¯md5====\r\n    //ä¸‹è½½åˆå¹¶åçš„æ–‡ä»¶\r\n    File minioFile = downloadFileFromMinIO(bucket_videoFiles,mergeFilePath);\r\n    if(minioFile == null){\r\n        log.debug(\"ä¸‹è½½åˆå¹¶åæ–‡ä»¶å¤±è´¥,mergeFilePath:{}\",mergeFilePath);\r\n        return RestResponse.validfail(false, \"ä¸‹è½½åˆå¹¶åæ–‡ä»¶å¤±è´¥ã€‚\");\r\n    }\r\n\r\n    try (InputStream newFileInputStream = new FileInputStream(minioFile)) {\r\n        //minioä¸Šæ–‡ä»¶çš„md5å€¼\r\n        String md5Hex = DigestUtils.md5Hex(newFileInputStream);\r\n        //æ¯”è¾ƒmd5å€¼ï¼Œä¸ä¸€è‡´åˆ™è¯´æ˜æ–‡ä»¶ä¸å®Œæ•´\r\n        if(!fileMd5.equals(md5Hex)){\r\n            return RestResponse.validfail(false, \"æ–‡ä»¶åˆå¹¶æ ¡éªŒå¤±è´¥ï¼Œæœ€ç»ˆä¸Šä¼ å¤±è´¥ã€‚\");\r\n        }\r\n        //æ–‡ä»¶å¤§å°\r\n        uploadFileParamsDto.setFileSize(minioFile.length());\r\n    }catch (Exception e){\r\n        log.debug(\"æ ¡éªŒæ–‡ä»¶å¤±è´¥,fileMd5:{},å¼‚å¸¸:{}\",fileMd5,e.getMessage(),e);\r\n        return RestResponse.validfail(false, \"æ–‡ä»¶åˆå¹¶æ ¡éªŒå¤±è´¥ï¼Œæœ€ç»ˆä¸Šä¼ å¤±è´¥ã€‚\");\r\n    }finally {\r\n       if(minioFile!=null){\r\n           minioFile.delete();\r\n       }\r\n    }\r\n\r\n    //æ–‡ä»¶å…¥åº“\r\n    currentProxy.addMediaFilesToDb(companyId,fileMd5,uploadFileParamsDto,bucket_videoFiles,mergeFilePath);\r\n    //=====æ¸…é™¤åˆ†å—æ–‡ä»¶=====\r\n    clearChunkFiles(chunkFileFolderPath,chunkTotal);\r\n    return RestResponse.success(true);\r\n}\r\n\r\n/**\r\n * ä»minioä¸‹è½½æ–‡ä»¶\r\n * @param bucket æ¡¶\r\n * @param objectName å¯¹è±¡åç§°\r\n * @return ä¸‹è½½åçš„æ–‡ä»¶\r\n */\r\npublic File downloadFileFromMinIO(String bucket,String objectName){\r\n    //ä¸´æ—¶æ–‡ä»¶\r\n    File minioFile = null;\r\n    FileOutputStream outputStream = null;\r\n    try{\r\n        InputStream stream = minioClient.getObject(GetObjectArgs.builder()\r\n                .bucket(bucket)\r\n                .object(objectName)\r\n                .build());\r\n        //åˆ›å»ºä¸´æ—¶æ–‡ä»¶\r\n        minioFile=File.createTempFile(\"minio\", \".merge\");\r\n        outputStream = new FileOutputStream(minioFile);\r\n        IOUtils.copy(stream,outputStream);\r\n        return minioFile;\r\n    } catch (Exception e) {\r\n       e.printStackTrace();\r\n    }finally {\r\n        if(outputStream!=null){\r\n            try {\r\n                outputStream.close();\r\n            } catch (IOException e) {\r\n                e.printStackTrace();\r\n            }\r\n        }\r\n    }\r\n    return null;\r\n}\r\n/**\r\n * å¾—åˆ°åˆå¹¶åçš„æ–‡ä»¶çš„åœ°å€\r\n * @param fileMd5 æ–‡ä»¶idå³md5å€¼\r\n * @param fileExt æ–‡ä»¶æ‰©å±•å\r\n * @return\r\n */\r\nprivate String getFilePathByMd5(String fileMd5,String fileExt){\r\n    return   fileMd5.substring(0,1) + \"/\" + fileMd5.substring(1,2) + \"/\" + fileMd5 + \"/\" +fileMd5 +fileExt;\r\n}\r\n\r\n/**\r\n * æ¸…é™¤åˆ†å—æ–‡ä»¶\r\n * @param chunkFileFolderPath åˆ†å—æ–‡ä»¶è·¯å¾„\r\n * @param chunkTotal åˆ†å—æ–‡ä»¶æ€»æ•°\r\n */\r\nprivate void clearChunkFiles(String chunkFileFolderPath,int chunkTotal){\r\n\r\n    try {\r\n        List<DeleteObject> deleteObjects = Stream.iterate(0, i -> ++i)\r\n                .limit(chunkTotal)\r\n                .map(i -> new DeleteObject(chunkFileFolderPath.concat(Integer.toString(i))))\r\n                .collect(Collectors.toList());\r\n\r\n        RemoveObjectsArgs removeObjectsArgs = RemoveObjectsArgs.builder().bucket(\"video\").objects(deleteObjects).build();\r\n        Iterable<Result<DeleteError>> results = minioClient.removeObjects(removeObjectsArgs);\r\n        results.forEach(r->{\r\n            DeleteError deleteError = null;\r\n            try {\r\n                deleteError = r.get();\r\n            } catch (Exception e) {\r\n                e.printStackTrace();\r\n                log.error(\"æ¸…æ¥šåˆ†å—æ–‡ä»¶å¤±è´¥,objectname:{}\",deleteError.objectName(),e);\r\n            }\r\n        });\r\n    } catch (Exception e) {\r\n        e.printStackTrace();\r\n        log.error(\"æ¸…æ¥šåˆ†å—æ–‡ä»¶å¤±è´¥,chunkFileFolderPath:{}\",chunkFileFolderPath,e);\r\n    }\r\n}\r\n```\r\n\r\n \r\n\r\n \r\n\r\n#### **3.5.2 æ¥å£å±‚å®Œå–„**\r\n\r\nä¸‹è¾¹å®Œå–„æ¥å£å±‚\r\n\r\n```java\r\n@ApiOperation(value = \"åˆå¹¶æ–‡ä»¶\")\r\n@PostMapping(\"/upload/mergechunks\")\r\npublic RestResponse mergechunks(@RequestParam(\"fileMd5\") String fileMd5,\r\n                                @RequestParam(\"fileName\") String fileName,\r\n                                @RequestParam(\"chunkTotal\") int chunkTotal) throws Exception {\r\n    Long companyId = 1232141425L;\r\n\r\n    UploadFileParamsDto uploadFileParamsDto = new UploadFileParamsDto();\r\n    uploadFileParamsDto.setFileType(\"001002\");\r\n    uploadFileParamsDto.setTags(\"è¯¾ç¨‹è§†é¢‘\");\r\n    uploadFileParamsDto.setRemark(\"\");\r\n    uploadFileParamsDto.setFilename(fileName);\r\n\r\n    return mediaFileService.mergechunks(companyId,fileMd5,chunkTotal,uploadFileParamsDto);\r\n\r\n}\r\n```\r\n\r\n \r\n\r\n#### **3.5.3 åˆå¹¶åˆ†å—æµ‹è¯•**\r\n\r\nä¸‹è¾¹è¿›è¡Œå‰åç«¯è”è°ƒï¼š\r\n\r\n1ã€ä¸Šä¼ ä¸€ä¸ªè§†é¢‘æµ‹è¯•åˆå¹¶åˆ†å—çš„æ‰§è¡Œé€»è¾‘\r\n\r\nè¿›å…¥serviceæ–¹æ³•é€è¡Œè·Ÿè¸ªã€‚\r\n\r\n2ã€æ–­ç‚¹ç»­ä¼ æµ‹è¯•\r\n\r\nä¸Šä¼ ä¸€éƒ¨åˆ†åï¼Œåœæ­¢åˆ·æ–°æµè§ˆå™¨å†é‡æ–°ä¸Šä¼ ï¼Œé€šè¿‡æµè§ˆå™¨æ—¥å¿—å‘ç°å·²ç»ä¸Šä¼ è¿‡çš„åˆ†å—ä¸å†é‡æ–°ä¸Šä¼ \r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps90.jpg) \r\n\r\n \r\n\r\n## **å›› ç»‘å®šåª’èµ„**\r\n\r\n### **4.1 éœ€æ±‚åˆ†æ**\r\n\r\n#### **4.1.1 ä¸šåŠ¡æµç¨‹**\r\n\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œåª’èµ„ç®¡ç†å·²å®Œæˆæ–‡ä»¶ä¸Šä¼ ã€è§†é¢‘å¤„ç†ã€æˆ‘çš„åª’èµ„åŠŸèƒ½ç­‰åŸºæœ¬åŠŸèƒ½ï¼Œå…¶å®ƒæ¨¡å—å¯ä»¥ä½¿ç”¨åª’èµ„æ–‡ä»¶ï¼Œæœ¬èŠ‚è¦è®²è§£è¯¾ç¨‹è®¡åˆ’ç»‘å®šåª’èµ„æ–‡ä»¶ã€‚\r\n\r\nå¦‚ä½•å°†è¯¾ç¨‹è®¡åˆ’ç»‘å®šåª’èµ„å‘¢ï¼Ÿ\r\n\r\né¦–å…ˆè¿›å…¥è¯¾ç¨‹è®¡åˆ’ç•Œé¢ï¼Œç„¶åé€‰æ‹©è¦ç»‘å®šçš„è§†é¢‘è¿›è¡Œç»‘å®šå³å¯ã€‚\r\n\r\nå…·ä½“çš„ä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n1.æ•™è‚²æœºæ„ç”¨æˆ·è¿›å…¥è¯¾ç¨‹ç®¡ç†é¡µé¢å¹¶ç¼–è¾‘æŸä¸€ä¸ªè¯¾ç¨‹ï¼Œåœ¨\"è¯¾ç¨‹å¤§çº²\"æ ‡ç­¾é¡µçš„æŸä¸€å°èŠ‚åå¯ç‚¹å‡»â€æ·»åŠ è§†é¢‘â€œã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps139.jpg) \r\n\r\n2.å¼¹å‡ºæ·»åŠ è§†é¢‘å¯¹è¯æ¡†ï¼Œå¯é€šè¿‡è§†é¢‘å…³é”®å­—æœç´¢å·²å®¡æ ¸é€šè¿‡çš„è§†é¢‘åª’èµ„ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps140.jpg) \r\n\r\n \r\n\r\n3.é€‰æ‹©è§†é¢‘åª’èµ„ï¼Œç‚¹å‡»æäº¤æŒ‰é’®ï¼Œå®Œæˆè¯¾ç¨‹è®¡åˆ’ç»‘å®šåª’èµ„æµç¨‹ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps141.jpg) \r\n\r\n \r\n\r\nè¯¾ç¨‹è®¡åˆ’å…³è”è§†é¢‘åå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps142.jpg) \r\n\r\nç‚¹å‡»å·²ç»ç»‘å®šçš„è§†é¢‘åç§°å³å¯è§£é™¤ç»‘å®šã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps143.jpg) \r\n\r\n#### **4.1.2 æ•°æ®æ¨¡å‹** \r\n\r\nè¯¾ç¨‹è®¡åˆ’ç»‘å®šåª’èµ„æ–‡ä»¶åå­˜å‚¨è‡³è¯¾ç¨‹è®¡åˆ’ç»‘å®šåª’èµ„è¡¨\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps144.jpg) \r\n\r\n### **4.2 æ¥å£å®šä¹‰**\r\n\r\næ ¹æ®ä¸šåŠ¡æµç¨‹ï¼Œç”¨æˆ·è¿›å…¥è¯¾ç¨‹è®¡åˆ’åˆ—è¡¨ï¼Œé¦–å…ˆç¡®å®šå‘å“ªä¸ªè¯¾ç¨‹è®¡åˆ’æ·»åŠ è§†é¢‘ï¼Œç‚¹å‡»â€æ·»åŠ è§†é¢‘â€œåç”¨æˆ·é€‰æ‹©è§†é¢‘ï¼Œé€‰æ‹©è§†é¢‘ï¼Œç‚¹å‡»æäº¤ï¼Œå‰ç«¯ä»¥jsonæ ¼å¼è¯·æ±‚ä»¥ä¸‹å‚æ•°ï¼š\r\n\r\næäº¤åª’èµ„æ–‡ä»¶idã€æ–‡ä»¶åç§°ã€æ•™å­¦è®¡åˆ’id\r\n\r\nç¤ºä¾‹å¦‚ä¸‹ï¼š\r\n\r\n```json\r\n{\r\n  \"mediaId\": \"70a98b4a2fffc89e50b101f959cc33ca\",\r\n  \"fileName\": \"22-Hmilyå®ç°TCCäº‹åŠ¡-å¼€å‘bank2çš„confirmæ–¹æ³•.avi\",\r\n  \"teachplanId\": 257\r\n}\r\n```\r\n\r\næ­¤æ¥å£åœ¨å†…å®¹ç®¡ç†æ¨¡å—æä¾›ã€‚\r\n\r\nåœ¨å†…å®¹ç®¡ç†æ¨¡å—å®šä¹‰è¯·æ±‚å‚æ•°æ¨¡å‹ç±»å‹ï¼š\r\n\r\n```java\r\n@Data\r\n@ApiModel(value=\"BindTeachplanMediaDto\", description=\"æ•™å­¦è®¡åˆ’-åª’èµ„ç»‘å®šæäº¤æ•°æ®\")\r\npublic class BindTeachplanMediaDto {\r\n\r\n@ApiModelProperty(value = \"åª’èµ„æ–‡ä»¶id\", required = true)\r\nprivate String mediaId;\r\n\r\n@ApiModelProperty(value = \"åª’èµ„æ–‡ä»¶åç§°\", required = true)\r\nprivate String fileName;\r\n\r\n @ApiModelProperty(value = \"è¯¾ç¨‹è®¡åˆ’æ ‡è¯†\", required = true)\r\n private Long teachplanId;\r\n\r\n\r\n}\r\n```\r\n\r\n \r\n\r\nåœ¨TeachplanControllerç±»ä¸­å®šä¹‰æ¥å£å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n@ApiOperation(value = \"è¯¾ç¨‹è®¡åˆ’å’Œåª’èµ„ä¿¡æ¯ç»‘å®š\")\r\n@PostMapping(\"/teachplan/association/media\")\r\npublic void associationMedia(@RequestBody BindTeachplanMediaDto bindTeachplanMediaDto){\r\n\r\n}\r\n\r\n```\r\n\r\n\r\n\r\n### **4.3 æ¥å£å¼€å‘**\r\n\r\n#### **4.3.1 DAOå¼€å‘**\r\n\r\nå¯¹teachplanMediaè¡¨è‡ªåŠ¨ç”ŸæˆMapperã€‚\r\n\r\n \r\n\r\n#### **4.3.2 Serviceå¼€å‘**\r\n\r\næ ¹æ®éœ€æ±‚å®šä¹‰serviceæ¥å£\r\n\r\n```java\r\n/**\r\n * @description æ•™å­¦è®¡åˆ’ç»‘å®šåª’èµ„\r\n * @param bindTeachplanMediaDto\r\n * @return com.xuecheng.content.model.po.TeachplanMedia\r\n * @author Mr.M\r\n * @date 2022/9/14 22:20\r\n*/\r\npublic TeachplanMedia associationMedia(BindTeachplanMediaDto bindTeachplanMediaDto);\r\n\r\n```\r\n\r\nå®šä¹‰æ¥å£å®ç°\r\n\r\n```java\r\n @Transactional\r\n @Override\r\npublic TeachplanMedia associationMedia(BindTeachplanMediaDto bindTeachplanMediaDto) {\r\n //æ•™å­¦è®¡åˆ’id\r\n Long teachplanId = bindTeachplanMediaDto.getTeachplanId();\r\n Teachplan teachplan = teachplanMapper.selectById(teachplanId);\r\n if(teachplan==null){\r\n  XueChengPlusException.cast(\"æ•™å­¦è®¡åˆ’ä¸å­˜åœ¨\");\r\n }\r\n Integer grade = teachplan.getGrade();\r\n if(grade!=2){\r\n  XueChengPlusException.cast(\"åªå…è®¸ç¬¬äºŒçº§æ•™å­¦è®¡åˆ’ç»‘å®šåª’èµ„æ–‡ä»¶\");\r\n }\r\n //è¯¾ç¨‹id\r\n Long courseId = teachplan.getCourseId();\r\n\r\n //å…ˆåˆ é™¤åŸæ¥è¯¥æ•™å­¦è®¡åˆ’ç»‘å®šçš„åª’èµ„\r\n teachplanMediaMapper.delete(new LambdaQueryWrapper<TeachplanMedia>().eq(TeachplanMedia::getTeachplanId,teachplanId));\r\n\r\n //å†æ·»åŠ æ•™å­¦è®¡åˆ’ä¸åª’èµ„çš„ç»‘å®šå…³ç³»\r\n TeachplanMedia teachplanMedia = new TeachplanMedia();\r\n teachplanMedia.setCourseId(courseId);\r\n teachplanMedia.setTeachplanId(teachplanId);\r\n teachplanMedia.setMediaFilename(bindTeachplanMediaDto.getFileName());\r\n teachplanMedia.setMediaId(bindTeachplanMediaDto.getMediaId());\r\n teachplanMedia.setCreateDate(LocalDateTime.now());\r\n teachplanMediaMapper.insert(teachplanMedia);\r\n return teachplanMedia;\r\n}\r\n\r\n\r\n```\r\n\r\n\r\n\r\n#### **4.3.3 æ¥å£å±‚å®Œå–„**\r\n\r\nå®Œå–„æ¥å£å±‚è°ƒç”¨Serviceå±‚çš„ä»£ç \r\n\r\n```java\r\n@ApiOperation(value = \"è¯¾ç¨‹è®¡åˆ’å’Œåª’èµ„ä¿¡æ¯ç»‘å®š\")\r\n@PostMapping(\"/teachplan/association/media\")\r\nvoid associationMedia(@RequestBody BindTeachplanMediaDto bindTeachplanMediaDto){\r\n    teachplanService.associationMedia(bindTeachplanMediaDto);\r\n}\r\n\r\n\r\n```\r\n\r\n\r\n\r\n#### **4.3.4 æ¥å£æµ‹è¯•**\r\n\r\n1ã€ä½¿ç”¨httpclientæµ‹è¯•\r\n\r\n```http\r\n### è¯¾ç¨‹è®¡åˆ’ç»‘å®šè§†é¢‘\r\nPOST {{media_host}}/media/teachplan/association/media\r\nContent-Type: application/json\r\n\r\n{\r\n  \"mediaId\": \"\",\r\n  \"fileName\": \"\",\r\n  \"teachplanId\": \"\"\r\n}\r\n```\r\n\r\n \r\n\r\n2ã€å‰åç«¯è”è°ƒ\r\n\r\næ­¤åŠŸèƒ½è¾ƒä¸ºç®€å•æ¨èç›´æ¥å‰åç«¯è”è°ƒ\r\n\r\nå‘æŒ‡å®šè¯¾ç¨‹è®¡åˆ’æ·»åŠ è§†é¢‘\r\n\r\n \r\n\r\n### **4.4 å®æˆ˜**\r\n\r\næ ¹æ®æ¥å£å®šä¹‰å®ç°è§£é™¤ç»‘å®šåŠŸèƒ½ã€‚\r\n\r\nç‚¹å‡»å·²ç»ç»‘å®šçš„è§†é¢‘åç§°å³å¯è§£é™¤ç»‘å®šã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps145.jpg) \r\n\r\n \r\n\r\næ¥å£å®šä¹‰å¦‚ä¸‹ï¼š\r\n\r\n`delete /teachplan/association/media/{teachPlanId}/{mediaId}  è¿”å›200çŠ¶æ€ç è¡¨ç¤ºæˆåŠŸã€‚` \r\n\r\nå¼€å‘å®Œæˆä½¿ç”¨httpclientæµ‹è¯•ã€å‰åç«¯è”è°ƒ\r\n\r\n```http\r\n### è¯¾ç¨‹è®¡åˆ’æ¥è§¦è§†é¢‘ç»‘å®š\r\nDELETE {{media_host}}/media/teachplan/association/media/{teachPlanId}/{mediaId}\r\n```\r\n\r\n \r\n"},{"title":"MySQL - ç®€ä»‹ä¸æ¶æ„","tags":["SQL"],"categories":["MySQL","åŸºç¡€ç¯‡"],"author":"imklaus","excerpt":"\r\n## ç®€ä»‹\r\n\r\n### æ•°æ®åº“\r\n\r\næ•°æ®åº“ï¼šDataBaseï¼Œç®€ç§° DBï¼Œå­˜å‚¨å’Œç®¡ç†æ•°æ®çš„ä»“åº“\r\n\r\næ•°æ®åº“çš„ä¼˜åŠ¿ï¼š\r\n\r\n- å¯ä»¥æŒä¹…åŒ–å­˜å‚¨æ•°æ®\r\n- æ–¹ä¾¿å­˜å‚¨å’Œç®¡ç†æ•°æ®\r\n- ä½¿ç”¨äº†ç»Ÿä¸€çš„æ–¹å¼æ“ä½œæ•°æ®åº“ SQL\r\n\r\næ•°æ®åº“ã€æ•°æ®è¡¨ã€æ•°æ®çš„å…³ç³»ä»‹ç»ï¼š\r\n\r\n- æ•°æ®åº“\r\n\r\n  - ç”¨äºå­˜å‚¨å’Œç®¡ç†æ•°æ®çš„ä»“åº“\r\n  - ä¸€ä¸ªåº“ä¸­å¯ä»¥åŒ…å«å¤šä¸ªæ•°æ®è¡¨\r\n\r\n- æ•°æ®è¡¨\r\n\r\n  - æ•°æ®åº“æœ€é‡è¦çš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€\r\n  - ç”±çºµå‘çš„åˆ—å’Œæ¨ªå‘çš„è¡Œç»„æˆï¼ˆç±»ä¼¼ excel è¡¨æ ¼ï¼‰\r\n  - å¯ä»¥æŒ‡å®šåˆ—åã€æ•°æ®ç±»å‹ã€çº¦æŸç­‰\r\n  - ä¸€ä¸ªè¡¨ä¸­å¯ä»¥å­˜å‚¨å¤šæ¡æ•°æ®\r\n\r\n- æ•°æ®ï¼šæƒ³è¦æ°¸ä¹…åŒ–å­˜å‚¨çš„æ•°æ®\r\n\r\n\r\n\r\n\r\nå‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1zJ411M7TB\r\n\r\nå‚è€ƒä¸“æ ï¼šhttps://time.geekbang.org/column/intro/139\r\n\r\nå‚è€ƒä¹¦ç±ï¼šhttps://book.douban.com/subject/35231266/\r\n\r\n","link":"/posts/MySQL_Basic","content":"\r\n## ç®€ä»‹\r\n\r\n### æ•°æ®åº“\r\n\r\næ•°æ®åº“ï¼šDataBaseï¼Œç®€ç§° DBï¼Œå­˜å‚¨å’Œç®¡ç†æ•°æ®çš„ä»“åº“\r\n\r\næ•°æ®åº“çš„ä¼˜åŠ¿ï¼š\r\n\r\n- å¯ä»¥æŒä¹…åŒ–å­˜å‚¨æ•°æ®\r\n- æ–¹ä¾¿å­˜å‚¨å’Œç®¡ç†æ•°æ®\r\n- ä½¿ç”¨äº†ç»Ÿä¸€çš„æ–¹å¼æ“ä½œæ•°æ®åº“ SQL\r\n\r\næ•°æ®åº“ã€æ•°æ®è¡¨ã€æ•°æ®çš„å…³ç³»ä»‹ç»ï¼š\r\n\r\n- æ•°æ®åº“\r\n\r\n  - ç”¨äºå­˜å‚¨å’Œç®¡ç†æ•°æ®çš„ä»“åº“\r\n  - ä¸€ä¸ªåº“ä¸­å¯ä»¥åŒ…å«å¤šä¸ªæ•°æ®è¡¨\r\n\r\n- æ•°æ®è¡¨\r\n\r\n  - æ•°æ®åº“æœ€é‡è¦çš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€\r\n  - ç”±çºµå‘çš„åˆ—å’Œæ¨ªå‘çš„è¡Œç»„æˆï¼ˆç±»ä¼¼ excel è¡¨æ ¼ï¼‰\r\n  - å¯ä»¥æŒ‡å®šåˆ—åã€æ•°æ®ç±»å‹ã€çº¦æŸç­‰\r\n  - ä¸€ä¸ªè¡¨ä¸­å¯ä»¥å­˜å‚¨å¤šæ¡æ•°æ®\r\n\r\n- æ•°æ®ï¼šæƒ³è¦æ°¸ä¹…åŒ–å­˜å‚¨çš„æ•°æ®\r\n\r\n\r\n\r\n\r\nå‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1zJ411M7TB\r\n\r\nå‚è€ƒä¸“æ ï¼šhttps://time.geekbang.org/column/intro/139\r\n\r\nå‚è€ƒä¹¦ç±ï¼šhttps://book.douban.com/subject/35231266/\r\n\r\n<!-- more -->\r\n\r\n***\r\n\r\n\r\n\r\n### MySQL\r\n\r\nMySQL æ•°æ®åº“æ˜¯ä¸€ä¸ªæœ€æµè¡Œçš„å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¹‹ä¸€ï¼Œå…³ç³»å‹æ•°æ®åº“æ˜¯å°†æ•°æ®ä¿å­˜åœ¨ä¸åŒçš„æ•°æ®è¡¨ä¸­ï¼Œè€Œä¸”è¡¨ä¸è¡¨ä¹‹é—´å¯ä»¥æœ‰å…³è”å…³ç³»ï¼Œæé«˜äº†çµæ´»æ€§\r\n\r\nç¼ºç‚¹ï¼šæ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸­ï¼Œå¯¼è‡´è¯»å†™æ€§èƒ½å·®ï¼Œè€Œä¸”æ•°æ®å…³ç³»å¤æ‚ï¼Œæ‰©å±•æ€§å·®\r\n\r\nMySQL æ‰€ä½¿ç”¨çš„ SQL è¯­å¥æ˜¯ç”¨äºè®¿é—®æ•°æ®åº“æœ€å¸¸ç”¨çš„æ ‡å‡†åŒ–è¯­è¨€\r\n\r\nMySQL é…ç½®ï¼š\r\n\r\n* MySQL å®‰è£…ï¼šhttps://www.jianshu.com/p/ba48f1e386f0\r\n\r\n* MySQL é…ç½®ï¼š\r\n\r\n  * ä¿®æ”¹ MySQL é»˜è®¤å­—ç¬¦é›†ï¼šå®‰è£… MySQL ä¹‹åç¬¬ä¸€ä»¶äº‹å°±æ˜¯ä¿®æ”¹å­—ç¬¦é›†ç¼–ç \r\n\r\n    ```sql\r\n    vim /etc/mysql/my.cnf\r\n    \r\n    æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š\r\n    [mysqld]\r\n    character-set-server=utf8\r\n    collation-server=utf8_general_ci\r\n    \r\n    [client]\r\n    default-character-set=utf8\r\n    ```\r\n\r\n  * å¯åŠ¨ MySQL æœåŠ¡ï¼š \r\n\r\n    ```shell\r\n    systemctl start/restart mysql\r\n    ```\r\n\r\n  * ç™»å½• MySQLï¼š\r\n\r\n    ```shell\r\n    mysql -u root -p  æ•²å›è½¦ï¼Œè¾“å…¥å¯†ç \r\n    åˆå§‹å¯†ç æŸ¥çœ‹ï¼šcat /var/log/mysqld.log\r\n    åœ¨root@localhost:   åé¢çš„å°±æ˜¯åˆå§‹å¯†ç \r\n    ```\r\n\r\n  * æŸ¥çœ‹é»˜è®¤å­—ç¬¦é›†å‘½ä»¤ï¼š\r\n\r\n    ```sql\r\n    SHOW VARIABLES LIKE 'char%';\r\n    ```\r\n\r\n  * ä¿®æ”¹MySQLç™»å½•å¯†ç ï¼š\r\n\r\n    ```sql\r\n    set global validate_password_policy=0;\r\n    set global validate_password_length=1;\r\n      \r\n    set password=password('å¯†ç ');\r\n    ```\r\n\r\n  * æˆäºˆè¿œç¨‹è¿æ¥æƒé™ï¼ˆMySQL å†…è¾“å…¥ï¼‰ï¼š\r\n\r\n    ```sql\r\n    -- æˆæƒ\r\n    grant all privileges on *.* to 'root' @'%' identified by 'å¯†ç ';\r\n    -- åˆ·æ–°\r\n    flush privileges;\r\n    ```\r\n\r\n* ä¿®æ”¹ MySQL ç»‘å®š IPï¼š\r\n\r\n  ```shell\r\n  cd /etc/mysql/mysql.conf.d\r\n  sudo chmod 666 mysqld.cnf \r\n  vim mysqld.cnf \r\n  # bind-address = 127.0.0.1æ³¨é‡Šè¯¥è¡Œ\r\n  ```\r\n\r\n* å…³é—­ Linux é˜²ç«å¢™\r\n\r\n  ```shell\r\n  systemctl stop firewalld.service\r\n  # æ”¾è¡Œ3306ç«¯å£\r\n  ```\r\n\r\n  \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n\r\n\r\n## ä½“ç³»æ¶æ„\r\n\r\n### æ•´ä½“æ¶æ„\r\n\r\nä½“ç³»ç»“æ„è¯¦è§£ï¼š\r\n\r\n* ç¬¬ä¸€å±‚ï¼šç½‘ç»œè¿æ¥å±‚\r\n  * ä¸€äº›å®¢æˆ·ç«¯å’Œé“¾æ¥æœåŠ¡ï¼ŒåŒ…å«æœ¬åœ° Socket é€šä¿¡å’Œå¤§å¤šæ•°åŸºäºå®¢æˆ·ç«¯/æœåŠ¡ç«¯å·¥å…·å®ç°çš„ TCP/IP é€šä¿¡ï¼Œä¸»è¦å®Œæˆä¸€äº›ç±»ä¼¼äºè¿æ¥å¤„ç†ã€æˆæƒè®¤è¯ã€åŠç›¸å…³çš„å®‰å…¨æ–¹æ¡ˆ\r\n  * åœ¨è¯¥å±‚ä¸Šå¼•å…¥äº†**è¿æ¥æ± ** Connection Pool çš„æ¦‚å¿µï¼Œç®¡ç†ç¼“å†²ç”¨æˆ·è¿æ¥ï¼Œçº¿ç¨‹å¤„ç†ç­‰éœ€è¦ç¼“å­˜çš„éœ€æ±‚\r\n  * åœ¨è¯¥å±‚ä¸Šå®ç°åŸºäº SSL çš„å®‰å…¨é“¾æ¥ï¼ŒæœåŠ¡å™¨ä¹Ÿä¼šä¸ºå®‰å…¨æ¥å…¥çš„æ¯ä¸ªå®¢æˆ·ç«¯éªŒè¯å®ƒæ‰€å…·æœ‰çš„æ“ä½œæƒé™\r\n\r\n- ç¬¬äºŒå±‚ï¼šæ ¸å¿ƒæœåŠ¡å±‚\r\n  * æŸ¥è¯¢ç¼“å­˜ã€åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨ç­‰ï¼Œæ¶µç›– MySQL çš„å¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡åŠŸèƒ½ï¼Œæ‰€æœ‰çš„å†…ç½®å‡½æ•°ï¼ˆæ—¥æœŸã€æ•°å­¦ã€åŠ å¯†å‡½æ•°ç­‰ï¼‰\r\n    * Management Serveices & Utilitiesï¼šç³»ç»Ÿç®¡ç†å’Œæ§åˆ¶å·¥å…·ï¼Œå¤‡ä»½ã€å®‰å…¨ã€å¤åˆ¶ã€é›†ç¾¤ç­‰\r\n    * SQL Interfaceï¼šæ¥å—ç”¨æˆ·çš„ SQL å‘½ä»¤ï¼Œå¹¶ä¸”è¿”å›ç”¨æˆ·éœ€è¦æŸ¥è¯¢çš„ç»“æœ\r\n    * Parserï¼šSQL è¯­å¥åˆ†æå™¨\r\n    * Optimizerï¼šæŸ¥è¯¢ä¼˜åŒ–å™¨\r\n    * Caches & Buffersï¼šæŸ¥è¯¢ç¼“å­˜ï¼ŒæœåŠ¡å™¨ä¼šæŸ¥è¯¢å†…éƒ¨çš„ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜ç©ºé—´è¶³å¤Ÿå¤§ï¼Œå¯ä»¥åœ¨å¤§é‡è¯»æ“ä½œçš„ç¯å¢ƒä¸­æå‡ç³»ç»Ÿæ€§èƒ½\r\n  * æ‰€æœ‰**è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½**åœ¨è¿™ä¸€å±‚å®ç°ï¼Œå¦‚å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰\r\n  * åœ¨è¯¥å±‚æœåŠ¡å™¨ä¼šè§£ææŸ¥è¯¢å¹¶åˆ›å»ºç›¸åº”çš„å†…éƒ¨è§£ææ ‘ï¼Œå¹¶å¯¹å…¶å®Œæˆç›¸åº”çš„ä¼˜åŒ–å¦‚ç¡®å®šè¡¨çš„æŸ¥è¯¢é¡ºåºï¼Œæ˜¯å¦åˆ©ç”¨ç´¢å¼•ç­‰ï¼Œ æœ€åç”Ÿæˆç›¸åº”çš„æ‰§è¡Œæ“ä½œ\r\n  * MySQL ä¸­æœåŠ¡å™¨å±‚ä¸ç®¡ç†äº‹åŠ¡ï¼Œ**äº‹åŠ¡æ˜¯ç”±å­˜å‚¨å¼•æ“å®ç°çš„**\r\n- ç¬¬ä¸‰å±‚ï¼šå­˜å‚¨å¼•æ“å±‚\r\n  - Pluggable Storage Enginesï¼šå­˜å‚¨å¼•æ“æ¥å£ï¼ŒMySQL åŒºåˆ«äºå…¶ä»–æ•°æ®åº“çš„é‡è¦ç‰¹ç‚¹å°±æ˜¯å…¶å­˜å‚¨å¼•æ“çš„æ¶æ„æ¨¡å¼æ˜¯æ’ä»¶å¼çš„ï¼ˆå­˜å‚¨å¼•æ“æ˜¯åŸºäºè¡¨çš„ï¼Œè€Œä¸æ˜¯æ•°æ®åº“ï¼‰\r\n  - å­˜å‚¨å¼•æ“**çœŸæ­£çš„è´Ÿè´£äº† MySQL ä¸­æ•°æ®çš„å­˜å‚¨å’Œæå–**ï¼ŒæœåŠ¡å™¨é€šè¿‡ API å’Œå­˜å‚¨å¼•æ“è¿›è¡Œé€šä¿¡\r\n  - ä¸åŒçš„å­˜å‚¨å¼•æ“å…·æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œå…±ç”¨ä¸€ä¸ª Server å±‚ï¼Œå¯ä»¥æ ¹æ®å¼€å‘çš„éœ€è¦ï¼Œæ¥é€‰å–åˆé€‚çš„å­˜å‚¨å¼•æ“\r\n- ç¬¬å››å±‚ï¼šç³»ç»Ÿæ–‡ä»¶å±‚\r\n  - æ•°æ®å­˜å‚¨å±‚ï¼Œä¸»è¦æ˜¯å°†æ•°æ®å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼Œå¹¶å®Œæˆä¸å­˜å‚¨å¼•æ“çš„äº¤äº’\r\n  - File Systemï¼šæ–‡ä»¶ç³»ç»Ÿï¼Œä¿å­˜é…ç½®æ–‡ä»¶ã€æ•°æ®æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶ã€é”™è¯¯æ–‡ä»¶ã€äºŒè¿›åˆ¶æ–‡ä»¶ç­‰\r\n\r\n![image-20250319234059758](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319234059758.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å»ºç«‹è¿æ¥\r\n\r\n#### è¿æ¥å™¨\r\n\r\næ± åŒ–æŠ€æœ¯ï¼šå¯¹äºè®¿é—®æ•°æ®åº“æ¥è¯´ï¼Œå»ºç«‹è¿æ¥çš„ä»£ä»·æ˜¯æ¯”è¾ƒæ˜‚è´µçš„ï¼Œå› ä¸ºæ¯ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªç”¨æ¥äº¤äº’çš„çº¿ç¨‹ï¼Œé¢‘ç¹çš„åˆ›å»ºå…³é—­è¿æ¥æ¯”è¾ƒè€—è´¹èµ„æºï¼Œæœ‰å¿…è¦å»ºç«‹æ•°æ®åº“è¿æ¥æ± ï¼Œä»¥æé«˜è®¿é—®çš„æ€§èƒ½\r\n\r\nè¿æ¥å»ºç«‹ TCP ä»¥åéœ€è¦åš**æƒé™éªŒè¯**ï¼ŒéªŒè¯æˆåŠŸåå¯ä»¥è¿›è¡Œæ‰§è¡Œ SQLã€‚å¦‚æœè¿™æ—¶ç®¡ç†å‘˜è´¦å·å¯¹è¿™ä¸ªç”¨æˆ·çš„æƒé™åšäº†ä¿®æ”¹ï¼Œä¹Ÿä¸ä¼šå½±å“å·²ç»å­˜åœ¨è¿æ¥çš„æƒé™ï¼Œåªæœ‰å†æ–°å»ºçš„è¿æ¥æ‰ä¼šä½¿ç”¨æ–°çš„æƒé™è®¾ç½®\r\n\r\nMySQL æœåŠ¡å™¨å¯ä»¥åŒæ—¶å’Œå¤šä¸ªå®¢æˆ·ç«¯è¿›è¡Œäº¤äº’ï¼Œæ‰€ä»¥è¦ä¿è¯æ¯ä¸ªè¿æ¥ä¼šè¯çš„éš”ç¦»æ€§ï¼ˆäº‹åŠ¡æœºåˆ¶éƒ¨åˆ†è¯¦è§£ï¼‰\r\n\r\næ•´ä½“çš„æ‰§è¡Œæµç¨‹ï¼š\r\n\r\n![image-20250319234144374](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319234144374.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æƒé™ä¿¡æ¯\r\n\r\ngrant è¯­å¥ä¼šåŒæ—¶ä¿®æ”¹æ•°æ®è¡¨å’Œå†…å­˜ï¼Œåˆ¤æ–­æƒé™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯å†…å­˜æ•°æ®\r\n\r\nflush privileges è¯­å¥æœ¬èº«ä¼šç”¨æ•°æ®è¡¨ï¼ˆç£ç›˜ï¼‰çš„æ•°æ®é‡å»ºä¸€ä»½å†…å­˜æƒé™æ•°æ®ï¼Œæ‰€ä»¥åœ¨æƒé™æ•°æ®å¯èƒ½å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œè¿™ç§ä¸ä¸€è‡´å¾€å¾€æ˜¯ç”±äºç›´æ¥ç”¨ DML è¯­å¥æ“ä½œç³»ç»Ÿæƒé™è¡¨å¯¼è‡´çš„ï¼Œæ‰€ä»¥å°½é‡ä¸è¦ä½¿ç”¨è¿™ç±»è¯­å¥\r\n\r\n![image-20250319234950483](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319234950483.png)\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### è¿æ¥çŠ¶æ€\r\n\r\nå®¢æˆ·ç«¯å¦‚æœé•¿æ—¶é—´æ²¡æœ‰æ“ä½œï¼Œè¿æ¥å™¨å°±ä¼šè‡ªåŠ¨æ–­å¼€ï¼Œæ—¶é—´æ˜¯ç”±å‚æ•° wait_timeout æ§åˆ¶çš„ï¼Œé»˜è®¤å€¼æ˜¯ 8 å°æ—¶ã€‚å¦‚æœåœ¨è¿æ¥è¢«æ–­å¼€ä¹‹åï¼Œå®¢æˆ·ç«¯**å†æ¬¡å‘é€è¯·æ±‚**çš„è¯ï¼Œå°±ä¼šæ”¶åˆ°ä¸€ä¸ªé”™è¯¯æé†’ï¼š`Lost connection to MySQL server during query`\r\n\r\næ•°æ®åº“é‡Œé¢ï¼Œé•¿è¿æ¥æ˜¯æŒ‡è¿æ¥æˆåŠŸåï¼Œå¦‚æœå®¢æˆ·ç«¯æŒç»­æœ‰è¯·æ±‚ï¼Œåˆ™ä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ï¼›çŸ­è¿æ¥åˆ™æ˜¯æŒ‡æ¯æ¬¡æ‰§è¡Œå®Œå¾ˆå°‘çš„å‡ æ¬¡æŸ¥è¯¢å°±æ–­å¼€è¿æ¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢å†é‡æ–°å»ºç«‹ä¸€ä¸ª\r\n\r\nä¸ºäº†å‡å°‘è¿æ¥çš„åˆ›å»ºï¼Œæ¨èä½¿ç”¨é•¿è¿æ¥ï¼Œä½†æ˜¯**è¿‡å¤šçš„é•¿è¿æ¥ä¼šé€ æˆ OOM**ï¼Œè§£å†³æ–¹æ¡ˆï¼š\r\n\r\n* å®šæœŸæ–­å¼€é•¿è¿æ¥ï¼Œä½¿ç”¨ä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…ç¨‹åºé‡Œé¢åˆ¤æ–­æ‰§è¡Œè¿‡ä¸€ä¸ªå ç”¨å†…å­˜çš„å¤§æŸ¥è¯¢åï¼Œæ–­å¼€è¿æ¥ï¼Œä¹‹åè¦æŸ¥è¯¢å†é‡è¿\r\n\r\n  ```sql\r\n  KILL CONNECTION id\r\n  ```\r\n\r\n* MySQL 5.7 ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ“ä½œåï¼Œé€šè¿‡æ‰§è¡Œ mysql_reset_connection æ¥é‡æ–°åˆå§‹åŒ–è¿æ¥èµ„æºï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦é‡è¿å’Œé‡æ–°åšæƒé™éªŒè¯ï¼Œä½†æ˜¯ä¼šå°†è¿æ¥æ¢å¤åˆ°åˆšåˆšåˆ›å»ºå®Œæ—¶çš„çŠ¶æ€\r\n\r\nSHOW PROCESSLISTï¼šæŸ¥çœ‹å½“å‰ MySQL åœ¨è¿›è¡Œçš„çº¿ç¨‹ï¼Œå¯ä»¥å®æ—¶åœ°æŸ¥çœ‹ SQL çš„æ‰§è¡Œæƒ…å†µï¼Œå…¶ä¸­çš„ Command åˆ—æ˜¾ç¤ºä¸º Sleep çš„è¿™ä¸€è¡Œï¼Œå°±è¡¨ç¤ºç°åœ¨ç³»ç»Ÿé‡Œé¢æœ‰ä¸€ä¸ªç©ºé—²è¿æ¥\r\n\r\n![image-20250319234249865](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319234249865.png)\r\n\r\n| å‚æ•°    | å«ä¹‰                                                         |\r\n| ------- | ------------------------------------------------------------ |\r\n| ID      | ç”¨æˆ·ç™»å½• mysql æ—¶ç³»ç»Ÿåˆ†é…çš„ connection_idï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•° connection_id() æŸ¥çœ‹ |\r\n| User    | æ˜¾ç¤ºå½“å‰ç”¨æˆ·ï¼Œå¦‚æœä¸æ˜¯ rootï¼Œè¿™ä¸ªå‘½ä»¤å°±åªæ˜¾ç¤ºç”¨æˆ·æƒé™èŒƒå›´çš„ sql è¯­å¥ |\r\n| Host    | æ˜¾ç¤ºè¿™ä¸ªè¯­å¥æ˜¯ä»å“ªä¸ª ip çš„å“ªä¸ªç«¯å£ä¸Šå‘çš„ï¼Œå¯ä»¥ç”¨æ¥è·Ÿè¸ªå‡ºç°é—®é¢˜è¯­å¥çš„ç”¨æˆ· |\r\n| db      | æ˜¾ç¤ºè¿™ä¸ªè¿›ç¨‹ç›®å‰è¿æ¥çš„æ˜¯å“ªä¸ªæ•°æ®åº“                           |\r\n| Command | æ˜¾ç¤ºå½“å‰è¿æ¥çš„æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¸€èˆ¬å–å€¼ä¸ºä¼‘çœ  Sleepã€æŸ¥è¯¢ Queryã€è¿æ¥ Connect ç­‰ |\r\n| Time    | æ˜¾ç¤ºè¿™ä¸ªçŠ¶æ€æŒç»­çš„æ—¶é—´ï¼Œå•ä½æ˜¯ç§’                             |\r\n| State   | æ˜¾ç¤ºä½¿ç”¨å½“å‰è¿æ¥çš„ sql è¯­å¥çš„çŠ¶æ€ï¼Œä»¥æŸ¥è¯¢ä¸ºä¾‹ï¼Œéœ€è¦ç»è¿‡ copying to tmp tableã€sorting resultã€sending dataç­‰çŠ¶æ€æ‰å¯ä»¥å®Œæˆ |\r\n| Info    | æ˜¾ç¤ºæ‰§è¡Œçš„ sql è¯­å¥ï¼Œæ˜¯åˆ¤æ–­é—®é¢˜è¯­å¥çš„ä¸€ä¸ªé‡è¦ä¾æ®            |\r\n\r\n**Sending data çŠ¶æ€**è¡¨ç¤º MySQL çº¿ç¨‹å¼€å§‹è®¿é—®æ•°æ®è¡Œå¹¶æŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè€Œä¸ä»…ä»…åªæ˜¯è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ˜¯å¤„äºæ‰§è¡Œå™¨è¿‡ç¨‹ä¸­çš„ä»»æ„é˜¶æ®µã€‚ç”±äºåœ¨ Sending data çŠ¶æ€ä¸‹ï¼ŒMySQL çº¿ç¨‹éœ€è¦åšå¤§é‡ç£ç›˜è¯»å–æ“ä½œï¼Œæ‰€ä»¥æ˜¯æ•´ä¸ªæŸ¥è¯¢ä¸­è€—æ—¶æœ€é•¿çš„çŠ¶æ€\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### æ‰§è¡Œæµç¨‹\r\n\r\n#### æŸ¥è¯¢ç¼“å­˜\r\n\r\n##### å·¥ä½œæµç¨‹\r\n\r\nå½“æ‰§è¡Œå®Œå…¨ç›¸åŒçš„ SQL è¯­å¥çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨å°±ä¼šç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–ç»“æœï¼Œå½“æ•°æ®è¢«ä¿®æ”¹ï¼Œä¹‹å‰çš„ç¼“å­˜ä¼šå¤±æ•ˆï¼Œä¿®æ”¹æ¯”è¾ƒé¢‘ç¹çš„è¡¨ä¸é€‚åˆåšæŸ¥è¯¢ç¼“å­˜\r\n\r\næŸ¥è¯¢è¿‡ç¨‹ï¼š\r\n\r\n1. å®¢æˆ·ç«¯å‘é€ä¸€æ¡æŸ¥è¯¢ç»™æœåŠ¡å™¨\r\n2. æœåŠ¡å™¨å…ˆä¼šæ£€æŸ¥æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­äº†ç¼“å­˜ï¼Œåˆ™ç«‹å³è¿”å›å­˜å‚¨åœ¨ç¼“å­˜ä¸­çš„ç»“æœï¼ˆä¸€èˆ¬æ˜¯ K-V é”®å€¼å¯¹ï¼‰ï¼Œå¦åˆ™è¿›å…¥ä¸‹ä¸€é˜¶æ®µ\r\n3. åˆ†æå™¨è¿›è¡Œ SQL åˆ†æï¼Œå†ç”±ä¼˜åŒ–å™¨ç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’\r\n4. æ‰§è¡Œå™¨æ ¹æ®ä¼˜åŒ–å™¨ç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’ï¼Œè°ƒç”¨å­˜å‚¨å¼•æ“çš„ API æ¥æ‰§è¡ŒæŸ¥è¯¢\r\n5. å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯\r\n\r\nå¤§å¤šæ•°æƒ…å†µä¸‹ä¸å»ºè®®ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ï¼Œå› ä¸ºæŸ¥è¯¢ç¼“å­˜å¾€å¾€å¼Šå¤§äºåˆ©\r\n\r\n* æŸ¥è¯¢ç¼“å­˜çš„**å¤±æ•ˆéå¸¸é¢‘ç¹**ï¼Œåªè¦æœ‰å¯¹ä¸€ä¸ªè¡¨çš„æ›´æ–°ï¼Œè¿™ä¸ªè¡¨ä¸Šæ‰€æœ‰çš„æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šè¢«æ¸…ç©ºã€‚å› æ­¤å¾ˆå¯èƒ½è´¹åŠ›åœ°æŠŠç»“æœå­˜èµ·æ¥ï¼Œè¿˜æ²¡ä½¿ç”¨å°±è¢«ä¸€ä¸ªæ›´æ–°å…¨æ¸…ç©ºäº†ï¼Œå¯¹äºæ›´æ–°å‹åŠ›å¤§çš„æ•°æ®åº“æ¥è¯´ï¼ŒæŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡ä¼šéå¸¸ä½\r\n* é™¤éä¸šåŠ¡å°±æ˜¯æœ‰ä¸€å¼ é™æ€è¡¨ï¼Œå¾ˆé•¿æ—¶é—´æ‰ä¼šæ›´æ–°ä¸€æ¬¡ï¼Œæ¯”å¦‚ä¸€ä¸ªç³»ç»Ÿé…ç½®è¡¨ï¼Œé‚£è¿™å¼ è¡¨ä¸Šçš„æŸ¥è¯¢æ‰é€‚åˆä½¿ç”¨æŸ¥è¯¢ç¼“å­˜\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ç¼“å­˜é…ç½®\r\n\r\n1. æŸ¥çœ‹å½“å‰ MySQL æ•°æ®åº“æ˜¯å¦æ”¯æŒæŸ¥è¯¢ç¼“å­˜ï¼š\r\n\r\n   ```sql\r\n   SHOW VARIABLES LIKE 'have_query_cache';\t-- YES\r\n   ```\r\n\r\n2. æŸ¥çœ‹å½“å‰ MySQL æ˜¯å¦å¼€å¯äº†æŸ¥è¯¢ç¼“å­˜ï¼š\r\n\r\n   ```sql\r\n   SHOW VARIABLES LIKE 'query_cache_type';\t-- OFF\r\n   ```\r\n\r\n   å‚æ•°è¯´æ˜ï¼š\r\n\r\n   * OFF æˆ– 0ï¼šæŸ¥è¯¢ç¼“å­˜åŠŸèƒ½å…³é—­\r\n\r\n   * ON æˆ– 1ï¼šæŸ¥è¯¢ç¼“å­˜åŠŸèƒ½æ‰“å¼€ï¼ŒæŸ¥è¯¢ç»“æœç¬¦åˆç¼“å­˜æ¡ä»¶å³ä¼šç¼“å­˜ï¼Œå¦åˆ™ä¸äºˆç¼“å­˜ï¼›å¯ä»¥æ˜¾å¼æŒ‡å®š SQL_NO_CACHE ä¸äºˆç¼“å­˜\r\n\r\n   * DEMAND æˆ– 2ï¼šæŸ¥è¯¢ç¼“å­˜åŠŸèƒ½æŒ‰éœ€è¿›è¡Œï¼Œæ˜¾å¼æŒ‡å®š SQL_CACHE çš„ SELECT è¯­å¥æ‰ç¼“å­˜ï¼Œå…¶å®ƒä¸äºˆç¼“å­˜\r\n\r\n     ```sql\r\n     SELECT SQL_CACHE id, name FROM customer; -- SQL_CACHE:æŸ¥è¯¢ç»“æœå¯ç¼“å­˜\r\n     SELECT SQL_NO_CACHE id, name FROM customer;-- SQL_NO_CACHE:ä¸ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜\r\n     ```\r\n\r\n3. æŸ¥çœ‹æŸ¥è¯¢ç¼“å­˜çš„å ç”¨å¤§å°ï¼š\r\n\r\n   ```sql\r\n   SHOW VARIABLES LIKE 'query_cache_size';-- å•ä½æ˜¯å­—èŠ‚ 1048576 / 1024 = 1024 = 1KB\r\n   ```\r\n\r\n4. æŸ¥çœ‹æŸ¥è¯¢ç¼“å­˜çš„çŠ¶æ€å˜é‡ï¼š\r\n\r\n   ```sql\r\n   SHOW STATUS LIKE 'Qcache%';\r\n   ```\r\n\r\n   ![image-20250319234326198](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319234326198.png)\r\n\r\n   | å‚æ•°                    | å«ä¹‰                                                         |\r\n   | ----------------------- | ------------------------------------------------------------ |\r\n   | Qcache_free_blocks      | æŸ¥è¯¢ç¼“å­˜ä¸­çš„å¯ç”¨å†…å­˜å—æ•°                                     |\r\n   | Qcache_free_memory      | æŸ¥è¯¢ç¼“å­˜çš„å¯ç”¨å†…å­˜é‡                                         |\r\n   | Qcache_hits             | æŸ¥è¯¢ç¼“å­˜å‘½ä¸­æ•°                                               |\r\n   | Qcache_inserts          | æ·»åŠ åˆ°æŸ¥è¯¢ç¼“å­˜çš„æŸ¥è¯¢æ•°                                       |\r\n   | Qcache_lowmen_prunes    | ç”±äºå†…å­˜ä¸è¶³è€Œä»æŸ¥è¯¢ç¼“å­˜ä¸­åˆ é™¤çš„æŸ¥è¯¢æ•°                       |\r\n   | Qcache_not_cached       | éç¼“å­˜æŸ¥è¯¢çš„æ•°é‡ï¼ˆç”±äº query_cache_type è®¾ç½®è€Œæ— æ³•ç¼“å­˜æˆ–æœªç¼“å­˜ï¼‰ |\r\n   | Qcache_queries_in_cache | æŸ¥è¯¢ç¼“å­˜ä¸­æ³¨å†Œçš„æŸ¥è¯¢æ•°                                       |\r\n   | Qcache_total_blocks     | æŸ¥è¯¢ç¼“å­˜ä¸­çš„å—æ€»æ•°                                           |\r\n\r\n5. é…ç½® my.cnfï¼š\r\n\r\n   ```sh\r\n   sudo chmod 666 /etc/mysql/my.cnf\r\n   vim my.cnf\r\n   # mysqldä¸­é…ç½®ç¼“å­˜\r\n   query_cache_type=1\r\n   ```\r\n\r\n   é‡å¯æœåŠ¡æ—¢å¯ç”Ÿæ•ˆï¼Œæ‰§è¡Œ SQL è¯­å¥è¿›è¡ŒéªŒè¯ ï¼Œæ‰§è¡Œä¸€æ¡æ¯”è¾ƒè€—æ—¶çš„ SQL è¯­å¥ï¼Œç„¶åå†å¤šæ‰§è¡Œå‡ æ¬¡ï¼ŒæŸ¥çœ‹åé¢å‡ æ¬¡çš„æ‰§è¡Œæ—¶é—´ï¼›è·å–é€šè¿‡æŸ¥çœ‹æŸ¥è¯¢ç¼“å­˜çš„ç¼“å­˜å‘½ä¸­æ•°ï¼Œæ¥åˆ¤å®šæ˜¯å¦èµ°æŸ¥è¯¢ç¼“å­˜\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ç¼“å­˜å¤±æ•ˆ\r\n\r\næŸ¥è¯¢ç¼“å­˜å¤±æ•ˆçš„æƒ…å†µï¼š\r\n\r\n* SQL è¯­å¥ä¸ä¸€è‡´ï¼Œè¦æƒ³å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼ŒæŸ¥è¯¢çš„ SQL è¯­å¥å¿…é¡»ä¸€è‡´ï¼Œå› ä¸º**ç¼“å­˜ä¸­ key æ˜¯æŸ¥è¯¢çš„è¯­å¥**ï¼Œvalue æ˜¯æŸ¥è¯¢ç»“æ„\r\n\r\n  ```sql\r\n  select count(*) from tb_item;\r\n  Select count(*) from tb_item;\t-- ä¸èµ°ç¼“å­˜ï¼Œé¦–å­—æ¯ä¸ä¸€è‡´\r\n  ```\r\n\r\n* å½“æŸ¥è¯¢è¯­å¥ä¸­æœ‰ä¸€äº›ä¸ç¡®å®šæŸ¥è¯¢æ—¶ï¼Œåˆ™ä¸ä¼šç¼“å­˜ï¼Œæ¯”å¦‚ï¼šnow()ã€current_date()ã€curdate()ã€curtime()ã€rand()ã€uuid()ã€user()ã€database() \r\n\r\n  ```sql\r\n  SELECT * FROM tb_item WHERE updatetime < NOW() LIMIT 1;\r\n  SELECT USER();\r\n  SELECT DATABASE();\r\n  ```\r\n\r\n* ä¸ä½¿ç”¨ä»»ä½•è¡¨æŸ¥è¯¢è¯­å¥ï¼š\r\n\r\n  ```sql\r\n  SELECT 'A';\r\n  ```\r\n\r\n* æŸ¥è¯¢ mysqlã€information_schemaã€performance_schema ç­‰ç³»ç»Ÿè¡¨æ—¶ï¼Œä¸èµ°æŸ¥è¯¢ç¼“å­˜ï¼š\r\n\r\n  ```sql\r\n  SELECT * FROM information_schema.engines;\r\n  ```\r\n\r\n* åœ¨**è·¨å­˜å‚¨å¼•æ“**çš„å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨æˆ–å­˜å‚¨å‡½æ•°çš„ä¸»ä½“å†…æ‰§è¡Œçš„æŸ¥è¯¢ï¼Œç¼“å­˜å¤±æ•ˆ\r\n\r\n* å¦‚æœè¡¨æ›´æ”¹ï¼Œåˆ™ä½¿ç”¨è¯¥è¡¨çš„**æ‰€æœ‰é«˜é€Ÿç¼“å­˜æŸ¥è¯¢éƒ½å°†å˜ä¸ºæ— æ•ˆ**å¹¶ä»é«˜é€Ÿç¼“å­˜ä¸­åˆ é™¤ï¼ŒåŒ…æ‹¬ä½¿ç”¨ MERGE æ˜ å°„åˆ°å·²æ›´æ”¹è¡¨çš„è¡¨çš„æŸ¥è¯¢ï¼Œæ¯”å¦‚ï¼šINSERTã€UPDATEã€DELETEã€ALTER TABLEã€DROP TABLEã€DROP DATABASE \r\n\r\n  \r\n\r\n***\r\n\r\n\r\n\r\n#### åˆ†æå™¨\r\n\r\næ²¡æœ‰å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œå°±å¼€å§‹äº† SQL çš„çœŸæ­£æ‰§è¡Œï¼Œåˆ†æå™¨ä¼šå¯¹ SQL è¯­å¥åšè§£æ\r\n\r\n```sql\r\nSELECT * FROM t WHERE id = 1;\r\n```\r\n\r\nè§£æå™¨ï¼šå¤„ç†è¯­æ³•å’Œè§£ææŸ¥è¯¢ï¼Œç”Ÿæˆä¸€è¯¾å¯¹åº”çš„è§£ææ ‘\r\n\r\n* å…ˆåš**è¯æ³•åˆ†æ**ï¼Œè¾“å…¥çš„æ˜¯ç”±å¤šä¸ªå­—ç¬¦ä¸²å’Œç©ºæ ¼ç»„æˆçš„ä¸€æ¡ SQL è¯­å¥ï¼ŒMySQL éœ€è¦è¯†åˆ«å‡ºé‡Œé¢çš„å­—ç¬¦ä¸²åˆ†åˆ«æ˜¯ä»€ä¹ˆä»£è¡¨ä»€ä¹ˆã€‚ä»è¾“å…¥çš„ select è¿™ä¸ªå…³é”®å­—è¯†åˆ«å‡ºæ¥è¿™æ˜¯ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ï¼›æŠŠå­—ç¬¦ä¸² t è¯†åˆ«æˆ è¡¨å tï¼ŒæŠŠå­—ç¬¦ä¸² id è¯†åˆ«æˆåˆ— id\r\n* ç„¶ååš**è¯­æ³•åˆ†æ**ï¼Œæ ¹æ®è¯æ³•åˆ†æçš„ç»“æœï¼Œè¯­æ³•åˆ†æå™¨ä¼šæ ¹æ®è¯­æ³•è§„åˆ™ï¼Œåˆ¤æ–­ä½ è¾“å…¥çš„è¿™ä¸ª SQL è¯­å¥æ˜¯å¦æ»¡è¶³ MySQL è¯­æ³•ã€‚å¦‚æœè¯­å¥ä¸å¯¹ï¼Œå°±ä¼šæ”¶åˆ° `You have an error in your SQL syntax` çš„é”™è¯¯æé†’\r\n\r\né¢„å¤„ç†å™¨ï¼šè¿›ä¸€æ­¥æ£€æŸ¥è§£ææ ‘çš„åˆæ³•æ€§ï¼Œæ¯”å¦‚æ•°æ®è¡¨å’Œæ•°æ®åˆ—æ˜¯å¦å­˜åœ¨ã€åˆ«åæ˜¯å¦æœ‰æ­§ä¹‰ç­‰\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä¼˜åŒ–å™¨\r\n\r\n##### æˆæœ¬åˆ†æ\r\n\r\nä¼˜åŒ–å™¨æ˜¯åœ¨è¡¨é‡Œé¢æœ‰å¤šä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œå†³å®šä½¿ç”¨å“ªä¸ªç´¢å¼•ï¼›æˆ–è€…åœ¨ä¸€ä¸ªè¯­å¥æœ‰å¤šè¡¨å…³è”ï¼ˆjoinï¼‰çš„æ—¶å€™ï¼Œå†³å®šå„ä¸ªè¡¨çš„è¿æ¥é¡ºåº\r\n\r\n* æ ¹æ®æœç´¢æ¡ä»¶æ‰¾å‡ºæ‰€æœ‰å¯èƒ½çš„ä½¿ç”¨çš„ç´¢å¼•\r\n* æˆæœ¬åˆ†æï¼Œæ‰§è¡Œæˆæœ¬ç”± I/O æˆæœ¬å’Œ CPU æˆæœ¬ç»„æˆï¼Œè®¡ç®—å…¨è¡¨æ‰«æå’Œä½¿ç”¨ä¸åŒç´¢å¼•æ‰§è¡Œ SQL çš„ä»£ä»·\r\n* æ‰¾åˆ°ä¸€ä¸ªæœ€ä¼˜çš„æ‰§è¡Œæ–¹æ¡ˆï¼Œç”¨æœ€å°çš„ä»£ä»·å»æ‰§è¡Œè¯­å¥\r\n\r\nåœ¨æ•°æ®åº“é‡Œé¢ï¼Œæ‰«æè¡Œæ•°æ˜¯å½±å“æ‰§è¡Œä»£ä»·çš„å› ç´ ä¹‹ä¸€ï¼Œæ‰«æçš„è¡Œæ•°è¶Šå°‘æ„å‘³ç€è®¿é—®ç£ç›˜çš„æ¬¡æ•°è¶Šå°‘ï¼Œæ¶ˆè€—çš„ CPU èµ„æºè¶Šå°‘ï¼Œä¼˜åŒ–å™¨è¿˜ä¼šç»“åˆæ˜¯å¦ä½¿ç”¨ä¸´æ—¶è¡¨ã€æ˜¯å¦æ’åºç­‰å› ç´ è¿›è¡Œç»¼åˆåˆ¤æ–­\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ç»Ÿè®¡æ•°æ®\r\n\r\nMySQL ä¸­ä¿å­˜ç€ä¸¤ç§ç»Ÿè®¡æ•°æ®ï¼š\r\n\r\n* innodb_table_stats å­˜å‚¨äº†è¡¨çš„ç»Ÿè®¡æ•°æ®ï¼Œæ¯ä¸€æ¡è®°å½•å¯¹åº”ç€ä¸€ä¸ªè¡¨çš„ç»Ÿè®¡æ•°æ®\r\n* innodb_index_stats å­˜å‚¨äº†ç´¢å¼•çš„ç»Ÿè®¡æ•°æ®ï¼Œæ¯ä¸€æ¡è®°å½•å¯¹åº”ç€ä¸€ä¸ªç´¢å¼•çš„ä¸€ä¸ªç»Ÿè®¡é¡¹çš„æ•°æ®\r\n\r\nMySQL åœ¨çœŸæ­£æ‰§è¡Œè¯­å¥ä¹‹å‰ï¼Œå¹¶ä¸èƒ½ç²¾ç¡®åœ°çŸ¥é“æ»¡è¶³æ¡ä»¶çš„è®°å½•æœ‰å¤šå°‘æ¡ï¼Œåªèƒ½æ ¹æ®ç»Ÿè®¡ä¿¡æ¯æ¥ä¼°ç®—è®°å½•ï¼Œç»Ÿè®¡ä¿¡æ¯å°±æ˜¯ç´¢å¼•çš„åŒºåˆ†åº¦ï¼Œä¸€ä¸ªç´¢å¼•ä¸Šä¸åŒçš„å€¼çš„ä¸ªæ•°ï¼ˆæ¯”å¦‚æ€§åˆ«åªèƒ½æ˜¯ç”·å¥³ï¼Œå°±æ˜¯ 2 ï¼‰ï¼Œç§°ä¹‹ä¸ºåŸºæ•°ï¼ˆcardinalityï¼‰ï¼Œ**åŸºæ•°è¶Šå¤§è¯´æ˜åŒºåˆ†åº¦è¶Šå¥½**\r\n\r\né€šè¿‡**é‡‡æ ·ç»Ÿè®¡**æ¥è·å–åŸºæ•°ï¼ŒInnoDB é»˜è®¤ä¼šé€‰æ‹© N ä¸ªæ•°æ®é¡µï¼Œç»Ÿè®¡è¿™äº›é¡µé¢ä¸Šçš„ä¸åŒå€¼å¾—åˆ°ä¸€ä¸ªå¹³å‡å€¼ï¼Œç„¶åä¹˜ä»¥è¿™ä¸ªç´¢å¼•çš„é¡µé¢æ•°ï¼Œå°±å¾—åˆ°äº†è¿™ä¸ªç´¢å¼•çš„åŸºæ•°\r\n\r\nåœ¨ MySQL ä¸­ï¼Œæœ‰ä¸¤ç§å­˜å‚¨ç»Ÿè®¡æ•°æ®çš„æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å‚æ•° `innodb_stats_persistent` çš„å€¼æ¥é€‰æ‹©ï¼š\r\n\r\n* ONï¼šè¡¨ç¤ºç»Ÿè®¡ä¿¡æ¯ä¼šæŒä¹…åŒ–å­˜å‚¨ï¼ˆé»˜è®¤ï¼‰ï¼Œé‡‡æ ·é¡µæ•° N é»˜è®¤ä¸º 20ï¼Œå¯ä»¥é€šè¿‡ `innodb_stats_persistent_sample_pages` æŒ‡å®šï¼Œé¡µæ•°è¶Šå¤šç»Ÿè®¡çš„æ•°æ®è¶Šå‡†ç¡®ï¼Œä½†æ¶ˆè€—çš„èµ„æºæ›´å¤§\r\n* OFFï¼šè¡¨ç¤ºç»Ÿè®¡ä¿¡æ¯åªå­˜å‚¨åœ¨å†…å­˜ï¼Œé‡‡æ ·é¡µæ•° N é»˜è®¤ä¸º 8ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç³»ç»Ÿå˜é‡è®¾ç½®ï¼ˆä¸æ¨èï¼Œæ¯æ¬¡é‡æ–°è®¡ç®—æµªè´¹èµ„æºï¼‰\r\n\r\næ•°æ®è¡¨æ˜¯ä¼šæŒç»­æ›´æ–°çš„ï¼Œä¸¤ç§ç»Ÿè®¡ä¿¡æ¯çš„æ›´æ–°æ–¹å¼ï¼š\r\n\r\n* è®¾ç½® `innodb_stats_auto_recalc` ä¸º 1ï¼Œå½“å‘ç”Ÿå˜åŠ¨çš„è®°å½•æ•°é‡è¶…è¿‡è¡¨å¤§å°çš„ 10% æ—¶ï¼Œè‡ªåŠ¨è§¦å‘é‡æ–°è®¡ç®—ï¼Œä¸è¿‡æ˜¯**å¼‚æ­¥è¿›è¡Œ**\r\n* è°ƒç”¨ `ANALYZE TABLE t` æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œåªå¯¹ä¿¡æ¯åš**é‡æ–°ç»Ÿè®¡**ï¼ˆä¸æ˜¯é‡å»ºè¡¨ï¼‰ï¼Œæ²¡æœ‰ä¿®æ”¹æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­åŠ äº† MDL è¯»é”å¹¶ä¸”æ˜¯åŒæ­¥è¿›è¡Œï¼Œæ‰€ä»¥ä¼šæš‚æ—¶é˜»å¡ç³»ç»Ÿ\r\n\r\n**EXPLAIN æ‰§è¡Œè®¡åˆ’åœ¨ä¼˜åŒ–å™¨é˜¶æ®µç”Ÿæˆ**ï¼Œå¦‚æœ explain çš„ç»“æœé¢„ä¼°çš„ rows å€¼è·Ÿå®é™…æƒ…å†µå·®è·æ¯”è¾ƒå¤§ï¼Œå¯ä»¥æ‰§è¡Œ analyze å‘½ä»¤é‡æ–°ä¿®æ­£ä¿¡æ¯\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### é”™é€‰ç´¢å¼•\r\n\r\né‡‡æ ·ç»Ÿè®¡æœ¬èº«æ˜¯ä¼°ç®—æ•°æ®ï¼Œæˆ–è€… SQL è¯­å¥ä¸­çš„å­—æ®µé€‰æ‹©æœ‰é—®é¢˜æ—¶ï¼Œå¯èƒ½å¯¼è‡´ MySQL æ²¡æœ‰é€‰æ‹©æ­£ç¡®çš„æ‰§è¡Œç´¢å¼•\r\n\r\nè§£å†³æ–¹æ³•ï¼š\r\n\r\n* é‡‡ç”¨ force index å¼ºè¡Œé€‰æ‹©ä¸€ä¸ªç´¢å¼•\r\n\r\n  ```sql\r\n  SELECT * FROM user FORCE INDEX(name) WHERE NAME='klaus';\r\n  ```\r\n\r\n* å¯ä»¥è€ƒè™‘ä¿®æ”¹ SQL è¯­å¥ï¼Œå¼•å¯¼ MySQL ä½¿ç”¨æœŸæœ›çš„ç´¢å¼•\r\n\r\n* æ–°å»ºä¸€ä¸ªæ›´åˆé€‚çš„ç´¢å¼•ï¼Œæ¥æä¾›ç»™ä¼˜åŒ–å™¨åšé€‰æ‹©ï¼Œæˆ–åˆ æ‰è¯¯ç”¨çš„ç´¢å¼•\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æ‰§è¡Œå™¨\r\n\r\nå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦å…ˆåˆ¤æ–­ä¸€ä¸‹å½“å‰è¿æ¥å¯¹è¡¨æœ‰æ²¡æœ‰**æ‰§è¡ŒæŸ¥è¯¢çš„æƒé™**ï¼Œå¦‚æœæ²¡æœ‰å°±ä¼šè¿”å›æ²¡æœ‰æƒé™çš„é”™è¯¯ï¼Œåœ¨å·¥ç¨‹å®ç°ä¸Šï¼Œå¦‚æœå‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œä¼šåœ¨æŸ¥è¯¢ç¼“å­˜è¿”å›ç»“æœçš„æ—¶å€™ï¼Œåšæƒé™éªŒè¯ã€‚å¦‚æœæœ‰æƒé™ï¼Œå°±æ‰“å¼€è¡¨ç»§ç»­æ‰§è¡Œï¼Œæ‰§è¡Œå™¨å°±ä¼šæ ¹æ®è¡¨çš„å¼•æ“å®šä¹‰ï¼Œå»ä½¿ç”¨è¿™ä¸ªå¼•æ“æä¾›çš„æ¥å£\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å¼•æ“å±‚\r\n\r\nServer å±‚å’Œå­˜å‚¨å¼•æ“å±‚çš„äº¤äº’æ˜¯**ä»¥è®°å½•ä¸ºå•ä½çš„**ï¼Œå­˜å‚¨å¼•æ“ä¼šå°†å•æ¡è®°å½•è¿”å›ç»™ Server å±‚åšè¿›ä¸€æ­¥å¤„ç†ï¼Œå¹¶ä¸æ˜¯ç›´æ¥è¿”å›æ‰€æœ‰çš„è®°å½•\r\n\r\nå·¥ä½œæµç¨‹ï¼š\r\n\r\n* é¦–å…ˆæ ¹æ®äºŒçº§ç´¢å¼•é€‰æ‹©æ‰«æèŒƒå›´ï¼Œè·å–ç¬¬ä¸€æ¡ç¬¦åˆäºŒçº§ç´¢å¼•æ¡ä»¶çš„è®°å½•ï¼Œè¿›è¡Œå›è¡¨æŸ¥è¯¢ï¼Œå°†èšç°‡ç´¢å¼•çš„è®°å½•è¿”å› Server å±‚ï¼Œç”± Server åˆ¤æ–­è®°å½•æ˜¯å¦ç¬¦åˆè¦æ±‚\r\n* ç„¶ååœ¨äºŒçº§ç´¢å¼•ä¸Šç»§ç»­æ‰«æä¸‹ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„è®°å½•\r\n\r\n\r\n\r\næ¨èé˜…è¯»ï¼šhttps://mp.weixin.qq.com/s/YZ-LckObephrP1f15mzHpA\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ç»ˆæ­¢æµç¨‹\r\n\r\n#### ç»ˆæ­¢è¯­å¥\r\n\r\nç»ˆæ­¢çº¿ç¨‹ä¸­æ­£åœ¨æ‰§è¡Œçš„è¯­å¥ï¼š\r\n\r\n```sql\r\nKILL QUERY thread_id\r\n```\r\n\r\nKILL ä¸æ˜¯é©¬ä¸Šç»ˆæ­¢çš„æ„æ€ï¼Œè€Œæ˜¯å‘Šè¯‰æ‰§è¡Œçº¿ç¨‹è¿™æ¡è¯­å¥å·²ç»ä¸éœ€è¦ç»§ç»­æ‰§è¡Œï¼Œå¯ä»¥å¼€å§‹æ‰§è¡Œåœæ­¢çš„é€»è¾‘ï¼ˆç±»ä¼¼äºæ‰“æ–­ï¼‰ã€‚å› ä¸ºå¯¹è¡¨åšå¢åˆ æ”¹æŸ¥æ“ä½œï¼Œä¼šåœ¨è¡¨ä¸ŠåŠ  MDL è¯»é”ï¼Œå¦‚æœçº¿ç¨‹è¢« KILL æ—¶å°±ç›´æ¥ç»ˆæ­¢ï¼Œé‚£è¿™ä¸ª MDL è¯»é”å°±æ²¡æœºä¼šè¢«é‡Šæ”¾äº†\r\n\r\nå‘½ä»¤ `KILL QUERYthread_id_A` çš„æ‰§è¡Œæµç¨‹ï¼š\r\n\r\n* æŠŠ session A çš„è¿è¡ŒçŠ¶æ€æ”¹æˆ THD::KILL_QUERYï¼ˆå°†å˜é‡ killed èµ‹å€¼ä¸º THD::KILL_QUERYï¼‰\r\n* ç»™ session A çš„æ‰§è¡Œçº¿ç¨‹å‘ä¸€ä¸ªä¿¡å·ï¼Œè®© session A æ¥å¤„ç†è¿™ä¸ª THD::KILL_QUERY çŠ¶æ€\r\n\r\nä¼šè¯å¤„äºç­‰å¾…çŠ¶æ€ï¼ˆé”é˜»å¡ï¼‰ï¼Œå¿…é¡»æ»¡è¶³æ˜¯ä¸€ä¸ªå¯ä»¥è¢«å”¤é†’çš„ç­‰å¾…ï¼Œå¿…é¡»æœ‰æœºä¼šå»**åˆ¤æ–­çº¿ç¨‹çš„çŠ¶æ€**ï¼Œå¦‚æœä¸æ»¡è¶³å°±ä¼šé€ æˆ KILL å¤±è´¥\r\n\r\nå…¸å‹åœºæ™¯ï¼šinnodb_thread_concurrency ä¸º 2ï¼Œä»£è¡¨å¹¶å‘çº¿ç¨‹ä¸Šé™æ•°è®¾ç½®ä¸º 2\r\n\r\n* session A æ‰§è¡Œäº‹åŠ¡ï¼Œsession B æ‰§è¡Œäº‹åŠ¡ï¼Œè¾¾åˆ°çº¿ç¨‹ä¸Šé™ï¼›æ­¤æ—¶ session C æ‰§è¡Œäº‹åŠ¡ä¼šé˜»å¡ç­‰å¾…ï¼Œsession D æ‰§è¡Œ kill query C æ— æ•ˆ\r\n* C çš„é€»è¾‘æ˜¯æ¯ 10 æ¯«ç§’åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›å…¥ InnoDB æ‰§è¡Œï¼Œå¦‚æœä¸è¡Œå°±è°ƒç”¨ nanosleep å‡½æ•°è¿›å…¥ sleep çŠ¶æ€ï¼Œæ²¡æœ‰å»åˆ¤æ–­çº¿ç¨‹çŠ¶æ€\r\n\r\nè¡¥å……ï¼šæ‰§è¡Œ Ctrl+C çš„æ—¶å€™ï¼Œæ˜¯ MySQL å®¢æˆ·ç«¯å¦å¤–å¯åŠ¨ä¸€ä¸ªè¿æ¥ï¼Œç„¶åå‘é€ä¸€ä¸ª KILL QUERY å‘½ä»¤\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ç»ˆæ­¢è¿æ¥\r\n\r\næ–­å¼€çº¿ç¨‹çš„è¿æ¥ï¼š\r\n\r\n```sql\r\nKILL CONNECTION id\r\n```\r\n\r\næ–­å¼€è¿æ¥åæ‰§è¡Œ SHOW PROCESSLIST å‘½ä»¤ï¼Œå¦‚æœè¿™æ¡è¯­å¥çš„ Command åˆ—æ˜¾ç¤º Killedï¼Œä»£è¡¨çº¿ç¨‹çš„çŠ¶æ€æ˜¯ KILL_CONNECTIONï¼Œè¯´æ˜è¿™ä¸ªçº¿ç¨‹æœ‰è¯­å¥æ­£åœ¨æ‰§è¡Œï¼Œå½“å‰çŠ¶æ€æ˜¯åœæ­¢è¯­å¥æ‰§è¡Œä¸­ï¼Œç»ˆæ­¢é€»è¾‘è€—æ—¶è¾ƒé•¿\r\n\r\n* è¶…å¤§äº‹åŠ¡æ‰§è¡ŒæœŸé—´è¢« KILLï¼Œè¿™æ—¶å›æ»šæ“ä½œéœ€è¦å¯¹äº‹åŠ¡æ‰§è¡ŒæœŸé—´ç”Ÿæˆçš„æ‰€æœ‰æ–°æ•°æ®ç‰ˆæœ¬åšå›æ”¶æ“ä½œï¼Œè€—æ—¶å¾ˆé•¿\r\n* å¤§æŸ¥è¯¢å›æ»šï¼Œå¦‚æœæŸ¥è¯¢è¿‡ç¨‹ä¸­ç”Ÿæˆäº†æ¯”è¾ƒå¤§çš„ä¸´æ—¶æ–‡ä»¶ï¼Œåˆ é™¤ä¸´æ—¶æ–‡ä»¶å¯èƒ½éœ€è¦ç­‰å¾… IO èµ„æºï¼Œå¯¼è‡´è€—æ—¶è¾ƒé•¿\r\n* DDL å‘½ä»¤æ‰§è¡Œåˆ°æœ€åé˜¶æ®µè¢« KILLï¼Œéœ€è¦åˆ é™¤ä¸­é—´è¿‡ç¨‹çš„ä¸´æ—¶æ–‡ä»¶ï¼Œä¹Ÿå¯èƒ½å— IO èµ„æºå½±å“è€—æ—¶è¾ƒä¹…\r\n\r\næ€»ç»“ï¼šKILL CONNECTION æœ¬è´¨ä¸Šåªæ˜¯æŠŠå®¢æˆ·ç«¯çš„ SQL è¿æ¥æ–­å¼€ï¼Œåé¢çš„ç»ˆæ­¢æµç¨‹è¿˜æ˜¯è¦èµ° KILL QUERY\r\n\r\nä¸€ä¸ªäº‹åŠ¡è¢« KILL ä¹‹åï¼ŒæŒç»­å¤„äºå›æ»šçŠ¶æ€ï¼Œä¸åº”è¯¥å¼ºè¡Œé‡å¯æ•´ä¸ª MySQL è¿›ç¨‹ï¼Œåº”è¯¥ç­‰å¾…äº‹åŠ¡è‡ªå·±æ‰§è¡Œå®Œæˆï¼Œå› ä¸ºé‡å¯åä¾ç„¶ç»§ç»­åšå›æ»šæ“ä½œçš„é€»è¾‘\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å¸¸ç”¨å·¥å…·\r\n\r\n#### mysql\r\n\r\nmysql ä¸æ˜¯æŒ‡ mysql æœåŠ¡ï¼Œè€Œæ˜¯æŒ‡ mysql çš„å®¢æˆ·ç«¯å·¥å…·\r\n\r\n```sh\r\nmysql [options] [database]\r\n```\r\n\r\n* -u  --user=nameï¼šæŒ‡å®šç”¨æˆ·å\r\n* -p  --password[=name]ï¼šæŒ‡å®šå¯†ç \r\n* -h  --host=nameï¼šæŒ‡å®šæœåŠ¡å™¨IPæˆ–åŸŸå\r\n* -P  --port=#ï¼šæŒ‡å®šè¿æ¥ç«¯å£\r\n* -e  --execute=nameï¼šæ‰§è¡ŒSQLè¯­å¥å¹¶é€€å‡ºï¼Œåœ¨æ§åˆ¶å°æ‰§è¡ŒSQLè¯­å¥ï¼Œè€Œä¸ç”¨è¿æ¥åˆ°æ•°æ®åº“æ‰§è¡Œ\r\n\r\nç¤ºä¾‹ï¼š\r\n\r\n```sh\r\nmysql -h 127.0.0.1 -P 3306 -u root -p\r\nmysql -uroot -p2143 db01 -e \"select * from tb_book\";\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### admin\r\n\r\nmysqladmin æ˜¯ä¸€ä¸ªæ‰§è¡Œç®¡ç†æ“ä½œçš„å®¢æˆ·ç«¯ç¨‹åºï¼Œç”¨æ¥æ£€æŸ¥æœåŠ¡å™¨çš„é…ç½®å’Œå½“å‰çŠ¶æ€ã€åˆ›å»ºå¹¶åˆ é™¤æ•°æ®åº“ç­‰\r\n\r\né€šè¿‡ `mysqladmin --help` æŒ‡ä»¤æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£\r\n\r\n```sh\r\nmysqladmin -uroot -p2143 create 'test01';\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### binlog\r\n\r\næœåŠ¡å™¨ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶ä»¥äºŒè¿›åˆ¶æ ¼å¼ä¿å­˜ï¼Œå¦‚æœéœ€è¦æ£€æŸ¥è¿™äº›æ–‡æœ¬ï¼Œå°±è¦ä½¿ç”¨ mysqlbinlog æ—¥å¿—ç®¡ç†å·¥å…·\r\n\r\n```sh\r\nmysqlbinlog [options]  log-files1 log-files2 ...\r\n```\r\n\r\n* -d  --database=nameï¼šæŒ‡å®šæ•°æ®åº“åç§°ï¼Œåªåˆ—å‡ºæŒ‡å®šçš„æ•°æ®åº“ç›¸å…³æ“ä½œ\r\n\r\n* -o  --offset=#ï¼šå¿½ç•¥æ‰æ—¥å¿—ä¸­çš„å‰ n è¡Œå‘½ä»¤ã€‚\r\n\r\n* -r  --result-file=nameï¼šå°†è¾“å‡ºçš„æ–‡æœ¬æ ¼å¼æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶ã€‚\r\n\r\n* -s  --short-formï¼šæ˜¾ç¤ºç®€å•æ ¼å¼ï¼Œçœç•¥æ‰ä¸€äº›ä¿¡æ¯ã€‚\r\n\r\n* --start-datatime=date1  --stop-datetime=date2ï¼šæŒ‡å®šæ—¥æœŸé—´éš”å†…çš„æ‰€æœ‰æ—¥å¿—\r\n\r\n* --start-position=pos1 --stop-position=pos2ï¼šæŒ‡å®šä½ç½®é—´éš”å†…çš„æ‰€æœ‰æ—¥å¿—\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### dump\r\n\r\n##### å‘½ä»¤ä»‹ç»\r\n\r\nmysqldump å®¢æˆ·ç«¯å·¥å…·ç”¨æ¥å¤‡ä»½æ•°æ®åº“æˆ–åœ¨ä¸åŒæ•°æ®åº“ä¹‹é—´è¿›è¡Œæ•°æ®è¿ç§»ï¼Œå¤‡ä»½å†…å®¹åŒ…å«åˆ›å»ºè¡¨ï¼ŒåŠæ’å…¥è¡¨çš„ SQL è¯­å¥\r\n\r\n```sh\r\nmysqldump [options] db_name [tables]\r\nmysqldump [options] --database/-B db1 [db2 db3...]\r\nmysqldump [options] --all-databases/-A\r\n```\r\n\r\nè¿æ¥é€‰é¡¹ï¼š\r\n\r\n* -u  --user=nameï¼šæŒ‡å®šç”¨æˆ·å\r\n* -p  --password[=name]ï¼šæŒ‡å®šå¯†ç \r\n* -h  --host=nameï¼šæŒ‡å®šæœåŠ¡å™¨ IP æˆ–åŸŸå\r\n* -P  --port=#ï¼šæŒ‡å®šè¿æ¥ç«¯å£\r\n\r\nè¾“å‡ºå†…å®¹é€‰é¡¹ï¼š\r\n\r\n* --add-drop-databaseï¼šåœ¨æ¯ä¸ªæ•°æ®åº“åˆ›å»ºè¯­å¥å‰åŠ ä¸Š Drop database è¯­å¥\r\n* --add-drop-tableï¼šåœ¨æ¯ä¸ªè¡¨åˆ›å»ºè¯­å¥å‰åŠ ä¸Š Drop table è¯­å¥ , é»˜è®¤å¼€å¯ï¼Œä¸å¼€å¯ (--skip-add-drop-table)\r\n* -n  --no-create-dbï¼šä¸åŒ…å«æ•°æ®åº“çš„åˆ›å»ºè¯­å¥\r\n* -t  --no-create-infoï¼šä¸åŒ…å«æ•°æ®è¡¨çš„åˆ›å»ºè¯­å¥\r\n* -d --no-dataï¼šä¸åŒ…å«æ•°æ®\r\n* -T, --tab=nameï¼šè‡ªåŠ¨ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼šä¸€ä¸ª .sql æ–‡ä»¶ï¼Œåˆ›å»ºè¡¨ç»“æ„çš„è¯­å¥ï¼›ä¸€ä¸ª .txt æ–‡ä»¶ï¼Œæ•°æ®æ–‡ä»¶ï¼Œç›¸å½“äº select into outfile  \r\n\r\nç¤ºä¾‹ï¼š\r\n\r\n```sh\r\nmysqldump -uroot -p2143 db01 tb_book --add-drop-database --add-drop-table > a\r\nmysqldump -uroot -p2143 -T /tmp test city\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ•°æ®å¤‡ä»½\r\n\r\nå‘½ä»¤è¡Œæ–¹å¼ï¼š\r\n\r\n* å¤‡ä»½å‘½ä»¤ï¼šmysqldump -u root -p æ•°æ®åº“åç§° > æ–‡ä»¶ä¿å­˜è·¯å¾„\r\n* æ¢å¤\r\n  1. ç™»å½•MySQLæ•°æ®åº“ï¼š`mysql -u root p`\r\n  2. åˆ é™¤å·²ç»å¤‡ä»½çš„æ•°æ®åº“\r\n  3. é‡æ–°åˆ›å»ºä¸å¤‡ä»½æ•°æ®åº“åç§°ç›¸åŒçš„æ•°æ®åº“\r\n  4. ä½¿ç”¨è¯¥æ•°æ®åº“\r\n  5. å¯¼å…¥æ–‡ä»¶æ‰§è¡Œï¼š`source å¤‡ä»½æ–‡ä»¶å…¨è·¯å¾„`\r\n\r\næ›´å¤šæ–¹å¼å‚è€ƒï¼šhttps://time.geekbang.org/column/article/81925\r\n\r\nå›¾å½¢åŒ–ç•Œé¢ï¼š\r\n\r\n* å¤‡ä»½\r\n\r\n  ![image-20250319234400695](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319234400695.png)\r\n\r\n* æ¢å¤\r\n\r\n  ![image-20250319234436591](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319234436591.png)\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### import\r\n\r\nmysqlimport æ˜¯å®¢æˆ·ç«¯æ•°æ®å¯¼å…¥å·¥å…·ï¼Œç”¨æ¥å¯¼å…¥mysqldump åŠ  -T å‚æ•°åå¯¼å‡ºçš„æ–‡æœ¬æ–‡ä»¶\r\n\r\n```sh\r\nmysqlimport [options]  db_name  textfile1  [textfile2...]\r\n```\r\n\r\nç¤ºä¾‹ï¼š\r\n\r\n```sh\r\nmysqlimport -uroot -p2143 test /tmp/city.txt\r\n```\r\n\r\nå¯¼å…¥ sql æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ MySQL ä¸­çš„ source æŒ‡ä»¤ : \r\n\r\n```sql\r\nsource æ–‡ä»¶å…¨è·¯å¾„\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### show\r\n\r\nmysqlshow å®¢æˆ·ç«¯å¯¹è±¡æŸ¥æ‰¾å·¥å…·ï¼Œç”¨æ¥å¾ˆå¿«åœ°æŸ¥æ‰¾å­˜åœ¨å“ªäº›æ•°æ®åº“ã€æ•°æ®åº“ä¸­çš„è¡¨ã€è¡¨ä¸­çš„åˆ—æˆ–è€…ç´¢å¼•\r\n\r\n```sh\r\nmysqlshow [options] [db_name [table_name [col_name]]]\r\n```\r\n\r\n* --countï¼šæ˜¾ç¤ºæ•°æ®åº“åŠè¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ•°æ®åº“ï¼Œè¡¨ å‡å¯ä»¥ä¸æŒ‡å®šï¼‰\r\n\r\n* -iï¼šæ˜¾ç¤ºæŒ‡å®šæ•°æ®åº“æˆ–è€…æŒ‡å®šè¡¨çš„çŠ¶æ€ä¿¡æ¯\r\n\r\nç¤ºä¾‹ï¼š\r\n\r\n```sh\r\n#æŸ¥è¯¢æ¯ä¸ªæ•°æ®åº“çš„è¡¨çš„æ•°é‡åŠè¡¨ä¸­è®°å½•çš„æ•°é‡\r\nmysqlshow -uroot -p1234 --count\r\n#æŸ¥è¯¢teståº“ä¸­æ¯ä¸ªè¡¨ä¸­çš„å­—æ®µä¹¦ï¼ŒåŠè¡Œæ•°\r\nmysqlshow -uroot -p1234 test --count\r\n#æŸ¥è¯¢teståº“ä¸­bookè¡¨çš„è¯¦ç»†æƒ…å†µ\r\nmysqlshow -uroot -p1234 test book --count\r\n```\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n## é«˜çº§ç»“æ„\r\n\r\n### è§†å›¾\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\nè§†å›¾æ¦‚å¿µï¼šè§†å›¾æ˜¯ä¸€ç§è™šæ‹Ÿå­˜åœ¨çš„æ•°æ®è¡¨ï¼Œè¿™ä¸ªè™šæ‹Ÿçš„è¡¨å¹¶ä¸åœ¨æ•°æ®åº“ä¸­å®é™…å­˜åœ¨\r\n\r\næœ¬è´¨ï¼šå°†ä¸€æ¡ SELECT æŸ¥è¯¢è¯­å¥çš„ç»“æœå°è£…åˆ°äº†ä¸€ä¸ªè™šæ‹Ÿè¡¨ä¸­ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºè§†å›¾çš„æ—¶å€™ï¼Œå·¥ä½œé‡å¿ƒè¦æ”¾åœ¨è¿™æ¡ SELECT æŸ¥è¯¢è¯­å¥ä¸Š\r\n\r\nä½œç”¨ï¼šå°†ä¸€äº›æ¯”è¾ƒå¤æ‚çš„æŸ¥è¯¢è¯­å¥çš„ç»“æœï¼Œå°è£…åˆ°ä¸€ä¸ªè™šæ‹Ÿè¡¨ä¸­ï¼Œå†æœ‰ç›¸åŒæŸ¥è¯¢éœ€æ±‚æ—¶ï¼Œç›´æ¥æŸ¥è¯¢è¯¥è™šæ‹Ÿè¡¨\r\n\r\nä¼˜ç‚¹ï¼š\r\n\r\n* ç®€å•ï¼šä½¿ç”¨è§†å›¾çš„ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒè¡¨çš„ç»“æ„ã€å…³è”æ¡ä»¶å’Œç­›é€‰æ¡ä»¶ï¼Œå› ä¸ºè™šæ‹Ÿè¡¨ä¸­å·²ç»æ˜¯è¿‡æ»¤å¥½çš„ç»“æœé›†\r\n* å®‰å…¨ï¼šä½¿ç”¨è§†å›¾çš„ç”¨æˆ·åªèƒ½è®¿é—®æŸ¥è¯¢çš„ç»“æœé›†ï¼Œå¯¹è¡¨çš„æƒé™ç®¡ç†å¹¶ä¸èƒ½é™åˆ¶åˆ°æŸä¸ªè¡ŒæŸä¸ªåˆ—\r\n\r\n* æ•°æ®ç‹¬ç«‹ï¼Œä¸€æ—¦è§†å›¾çš„ç»“æ„ç¡®å®šï¼Œå¯ä»¥å±è”½è¡¨ç»“æ„å˜åŒ–å¯¹ç”¨æˆ·çš„å½±å“ï¼Œæºè¡¨å¢åŠ åˆ—å¯¹è§†å›¾æ²¡æœ‰å½±å“ï¼›æºè¡¨ä¿®æ”¹åˆ—åï¼Œåˆ™å¯ä»¥é€šè¿‡ä¿®æ”¹è§†å›¾æ¥è§£å†³ï¼Œä¸ä¼šé€ æˆå¯¹è®¿é—®è€…çš„å½±å“\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### è§†å›¾åˆ›å»º\r\n\r\n* åˆ›å»ºè§†å›¾\r\n\r\n  ```sql\r\n  CREATE [OR REPLACE] \r\n  VIEW è§†å›¾åç§° [(åˆ—ååˆ—è¡¨)] \r\n  AS æŸ¥è¯¢è¯­å¥\r\n  [WITH [CASCADED | LOCAL] CHECK OPTION];\r\n  ```\r\n\r\n  `WITH [CASCADED | LOCAL] CHECK OPTION` å†³å®šäº†æ˜¯å¦å…è®¸æ›´æ–°æ•°æ®ä½¿è®°å½•ä¸å†æ»¡è¶³è§†å›¾çš„æ¡ä»¶ï¼š\r\n\r\n  * LOCALï¼šåªè¦æ»¡è¶³æœ¬è§†å›¾çš„æ¡ä»¶å°±å¯ä»¥æ›´æ–°\r\n  * CASCADEDï¼šå¿…é¡»æ»¡è¶³æ‰€æœ‰é’ˆå¯¹è¯¥è§†å›¾çš„æ‰€æœ‰è§†å›¾çš„æ¡ä»¶æ‰å¯ä»¥æ›´æ–°ï¼Œ é»˜è®¤å€¼\r\n\r\n* ä¾‹å¦‚\r\n\r\n  ```sql\r\n  -- æ•°æ®å‡†å¤‡ city\r\n  id\tNAME\tcid\r\n  1\tæ·±åœ³\t \t1\r\n  2\tä¸Šæµ·\t\t1\r\n  3\tçº½çº¦\t\t2\r\n  4\tè«æ–¯ç§‘\t    3\r\n  \r\n  -- æ•°æ®å‡†å¤‡ country\r\n  id\tNAME\r\n  1\tä¸­å›½\r\n  2\tç¾å›½\r\n  3\tä¿„ç½—æ–¯\r\n  \r\n  -- åˆ›å»ºcity_countryè§†å›¾ï¼Œä¿å­˜åŸå¸‚å’Œå›½å®¶çš„ä¿¡æ¯(ä½¿ç”¨æŒ‡å®šåˆ—å)\r\n  CREATE \r\n  VIEW \r\n  \tcity_country (city_id,city_name,country_name)\r\n  AS\r\n      SELECT\r\n          c1.id,\r\n          c1.name,\r\n          c2.name\r\n      FROM\r\n          city c1,\r\n          country c2\r\n      WHERE\r\n          c1.cid=c2.id;\r\n  ```\r\n\r\n  \r\n\r\n***\r\n\r\n\r\n\r\n#### è§†å›¾æŸ¥è¯¢\r\n\r\n* æŸ¥è¯¢æ‰€æœ‰æ•°æ®è¡¨ï¼Œè§†å›¾ä¹Ÿä¼šæŸ¥è¯¢å‡ºæ¥\r\n\r\n  ```sql\r\n  SHOW TABLES;\r\n  SHOW TABLE STATUS [\\G];\r\n  ```\r\n\r\n* æŸ¥è¯¢è§†å›¾\r\n\r\n  ```sql\r\n  SELECT * FROM è§†å›¾åç§°;\r\n  ```\r\n\r\n* æŸ¥è¯¢æŸä¸ªè§†å›¾åˆ›å»º\r\n\r\n  ```sql\r\n  SHOW CREATE VIEW è§†å›¾åç§°;\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### è§†å›¾ä¿®æ”¹\r\n\r\nè§†å›¾è¡¨æ•°æ®ä¿®æ”¹ï¼Œä¼š**è‡ªåŠ¨ä¿®æ”¹æºè¡¨ä¸­çš„æ•°æ®**ï¼Œå› ä¸ºæ›´æ–°çš„æ˜¯è§†å›¾ä¸­çš„åŸºè¡¨ä¸­çš„æ•°æ®\r\n\r\n* ä¿®æ”¹è§†å›¾è¡¨ä¸­çš„æ•°æ®\r\n\r\n  ```sql\r\n  UPDATE è§†å›¾åç§° SET åˆ—å = å€¼ WHERE æ¡ä»¶;\r\n  ```\r\n\r\n* ä¿®æ”¹è§†å›¾çš„ç»“æ„\r\n\r\n  ```sql\r\n  ALTER [ALGORITHM = {UNDEFINED | MERGE | TEMPTABLE}]\r\n  VIEW è§†å›¾åç§° [(åˆ—ååˆ—è¡¨)] \r\n  AS æŸ¥è¯¢è¯­å¥\r\n  [WITH [CASCADED | LOCAL] CHECK OPTION]\r\n  \r\n  -- å°†è§†å›¾ä¸­çš„country_nameä¿®æ”¹ä¸ºname\r\n  ALTER \r\n  VIEW \r\n  \tcity_country (city_id,city_name,name) \r\n  AS\r\n      SELECT\r\n          c1.id,\r\n          c1.name,\r\n          c2.name\r\n      FROM\r\n          city c1,\r\n          country c2\r\n      WHERE\r\n          c1.cid=c2.id;\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### è§†å›¾åˆ é™¤\r\n\r\n* åˆ é™¤è§†å›¾\r\n\r\n  ```sql\r\n  DROP VIEW è§†å›¾åç§°;\r\n  ```\r\n\r\n* å¦‚æœå­˜åœ¨åˆ™åˆ é™¤\r\n\r\n  ```sql\r\n  DROP VIEW IF EXISTS è§†å›¾åç§°;\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å­˜å‚¨è¿‡ç¨‹\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\nå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ï¼šå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°æ˜¯äº‹å…ˆç»è¿‡ç¼–è¯‘å¹¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„ä¸€æ®µ SQL è¯­å¥çš„é›†åˆ\r\n\r\nå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„å¥½å¤„ï¼š\r\n\r\n* æé«˜ä»£ç çš„å¤ç”¨æ€§\r\n* å‡å°‘æ•°æ®åœ¨æ•°æ®åº“å’Œåº”ç”¨æœåŠ¡å™¨ä¹‹é—´çš„ä¼ è¾“ï¼Œæé«˜ä¼ è¾“æ•ˆç‡\r\n* å‡å°‘ä»£ç å±‚é¢çš„ä¸šåŠ¡å¤„ç†\r\n* **ä¸€æ¬¡ç¼–è¯‘æ°¸ä¹…æœ‰æ•ˆ**\r\n\r\nå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„åŒºåˆ«ï¼š\r\n\r\n* å­˜å‚¨å‡½æ•°å¿…é¡»æœ‰è¿”å›å€¼\r\n* å­˜å‚¨è¿‡ç¨‹å¯ä»¥æ²¡æœ‰è¿”å›å€¼\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åŸºæœ¬æ“ä½œ\r\n\r\nDELIMITERï¼š\r\n\r\n* DELIMITER å…³é”®å­—ç”¨æ¥å£°æ˜ sql è¯­å¥çš„åˆ†éš”ç¬¦ï¼Œå‘Šè¯‰ MySQL è¯¥æ®µå‘½ä»¤å·²ç»ç»“æŸ\r\n\r\n* MySQL è¯­å¥é»˜è®¤çš„åˆ†éš”ç¬¦æ˜¯åˆ†å·ï¼Œä½†æ˜¯æœ‰æ—¶éœ€è¦ä¸€æ¡åŠŸèƒ½ sql è¯­å¥ä¸­åŒ…å«åˆ†å·ï¼Œä½†æ˜¯å¹¶ä¸ä½œä¸ºç»“æŸæ ‡è¯†ï¼Œè¿™æ—¶ä½¿ç”¨ DELIMITER æ¥æŒ‡å®šåˆ†éš”ç¬¦ï¼š\r\n\r\n  ```sql\r\n  DELIMITER åˆ†éš”ç¬¦\r\n  ```\r\n\r\nå­˜å‚¨è¿‡ç¨‹çš„åˆ›å»ºè°ƒç”¨æŸ¥çœ‹å’Œåˆ é™¤ï¼š\r\n\r\n* åˆ›å»ºå­˜å‚¨è¿‡ç¨‹\r\n\r\n  ```sql\r\n  -- ä¿®æ”¹åˆ†éš”ç¬¦ä¸º$\r\n  DELIMITER $\r\n  \r\n  -- æ ‡å‡†è¯­æ³•\r\n  CREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹åç§°(å‚æ•°...)\r\n  BEGIN\r\n  \tsqlè¯­å¥;\r\n  END$\r\n  \r\n  -- ä¿®æ”¹åˆ†éš”ç¬¦ä¸ºåˆ†å·\r\n  DELIMITER ;\r\n  ```\r\n\r\n* è°ƒç”¨å­˜å‚¨è¿‡ç¨‹\r\n\r\n  ```sql\r\n  CALL å­˜å‚¨è¿‡ç¨‹åç§°(å®é™…å‚æ•°);\r\n  ```\r\n\r\n* æŸ¥çœ‹å­˜å‚¨è¿‡ç¨‹\r\n\r\n  ```sql\r\n  SELECT * FROM mysql.proc WHERE db='æ•°æ®åº“åç§°';\r\n  ```\r\n\r\n* åˆ é™¤å­˜å‚¨è¿‡ç¨‹\r\n\r\n  ```sql\r\n  DROP PROCEDURE [IF EXISTS] å­˜å‚¨è¿‡ç¨‹åç§°;\r\n  ```\r\n\r\nç»ƒä¹ ï¼š\r\n\r\n* æ•°æ®å‡†å¤‡\r\n\r\n  ```sql\r\n  id\tNAME\tage\t\tgender\tscore\r\n  1\tå¼ ä¸‰\t\t23\t\tç”·\t\t95\r\n  2\tæå››\t\t24\t\tç”·\t\t98\r\n  3\tç‹äº”\t\t25\t\tå¥³\t\t100\r\n  4\tèµµå…­\t\t26\t\tå¥³\t\t90\r\n  ```\r\n\r\n* åˆ›å»º stu_group() å­˜å‚¨è¿‡ç¨‹ï¼Œå°è£…åˆ†ç»„æŸ¥è¯¢æ€»æˆç»©ï¼Œå¹¶æŒ‰ç…§æ€»æˆç»©å‡åºæ’åºçš„åŠŸèƒ½\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  \r\n  CREATE PROCEDURE stu_group()\r\n  BEGIN\r\n  \tSELECT gender,SUM(score) getSum FROM student GROUP BY gender ORDER BY getSum ASC; \r\n  END$\r\n  \r\n  DELIMITER ;\r\n  \r\n  -- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹\r\n  CALL stu_group();\r\n  -- åˆ é™¤å­˜å‚¨è¿‡ç¨‹\r\n  DROP PROCEDURE IF EXISTS stu_group;\r\n  ```\r\n\r\n  \r\n\r\n***\r\n\r\n\r\n\r\n#### å­˜å‚¨è¯­æ³•\r\n\r\n##### å˜é‡ä½¿ç”¨\r\n\r\nå­˜å‚¨è¿‡ç¨‹æ˜¯å¯ä»¥è¿›è¡Œç¼–ç¨‹çš„ï¼Œæ„å‘³ç€å¯ä»¥ä½¿ç”¨å˜é‡ã€è¡¨è¾¾å¼ã€æ¡ä»¶æ§åˆ¶è¯­å¥ç­‰ï¼Œæ¥å®Œæˆæ¯”è¾ƒå¤æ‚çš„åŠŸèƒ½\r\n\r\n* å®šä¹‰å˜é‡ï¼šDECLARE å®šä¹‰çš„æ˜¯å±€éƒ¨å˜é‡ï¼Œåªèƒ½ç”¨åœ¨ BEGIN END èŒƒå›´ä¹‹å†…\r\n\r\n  ```sql\r\n  DECLARE å˜é‡å æ•°æ®ç±»å‹ [DEFAULT é»˜è®¤å€¼];\r\n  ```\r\n\r\n* å˜é‡çš„èµ‹å€¼\r\n\r\n  ```sql\r\n  SET å˜é‡å = å˜é‡å€¼;\r\n  SELECT åˆ—å INTO å˜é‡å FROM è¡¨å [WHERE æ¡ä»¶];\r\n  ```\r\n\r\n* æ•°æ®å‡†å¤‡ï¼šè¡¨ student\r\n\r\n  ```sql\r\n  id\tNAME\tage\t\tgender\tscore\r\n  1\tå¼ ä¸‰\t\t23\t\tç”·\t\t95\r\n  2\tæå››\t\t24\t\tç”·\t\t98\r\n  3\tç‹äº”\t\t25\t\tå¥³\t\t100\r\n  4\tèµµå…­\t\t26\t\tå¥³\t\t90\r\n  ```\r\n\r\n* å®šä¹‰ä¸¤ä¸ª int å˜é‡ï¼Œç”¨äºå­˜å‚¨ç”·å¥³åŒå­¦çš„æ€»åˆ†æ•°\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  CREATE PROCEDURE pro_test3()\r\n  BEGIN\r\n  \t-- å®šä¹‰ä¸¤ä¸ªå˜é‡\r\n  \tDECLARE men,women INT;\r\n  \t-- æŸ¥è¯¢ç”·åŒå­¦çš„æ€»åˆ†æ•°ï¼Œä¸ºmenèµ‹å€¼\r\n  \tSELECT SUM(score) INTO men FROM student WHERE gender='ç”·';\r\n  \t-- æŸ¥è¯¢å¥³åŒå­¦çš„æ€»åˆ†æ•°ï¼Œä¸ºwomenèµ‹å€¼\r\n  \tSELECT SUM(score) INTO women FROM student WHERE gender='å¥³';\r\n  \t-- ä½¿ç”¨å˜é‡\r\n  \tSELECT men,women;\r\n  END$\r\n  DELIMITER ;\r\n  -- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹\r\n  CALL pro_test3();\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### IFè¯­å¥\r\n\r\n* if è¯­å¥æ ‡å‡†è¯­æ³•\r\n\r\n  ```sql\r\n  IF åˆ¤æ–­æ¡ä»¶1 THEN æ‰§è¡Œçš„sqlè¯­å¥1;\r\n  [ELSEIF åˆ¤æ–­æ¡ä»¶2 THEN æ‰§è¡Œçš„sqlè¯­å¥2;]\r\n  ...\r\n  [ELSE æ‰§è¡Œçš„sqlè¯­å¥n;]\r\n  END IF;\r\n  ```\r\n\r\n* æ•°æ®å‡†å¤‡ï¼šè¡¨ student\r\n\r\n  ```sql\r\n  id\tNAME\tage\t\tgender\tscore\r\n  1\tå¼ ä¸‰\t\t23\t\tç”·\t\t95\r\n  2\tæå››\t\t24\t\tç”·\t\t98\r\n  3\tç‹äº”\t\t25\t\tå¥³\t\t100\r\n  4\tèµµå…­\t\t26\t\tå¥³\t\t90\r\n  ```\r\n\r\n* æ ¹æ®æ€»æˆç»©åˆ¤æ–­ï¼šå…¨ç­ 380 åˆ†åŠä»¥ä¸Šå­¦ä¹ ä¼˜ç§€ã€320 ~ 380 å­¦ä¹ è‰¯å¥½ã€320 ä»¥ä¸‹å­¦ä¹ ä¸€èˆ¬\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  CREATE PROCEDURE pro_test4()\r\n  BEGIN\r\n  \tDECLARE total INT;\t\t\t\t\t\t\t-- å®šä¹‰æ€»åˆ†æ•°å˜é‡\r\n  \tDECLARE description VARCHAR(10);\t\t\t-- å®šä¹‰åˆ†æ•°æè¿°å˜é‡\r\n  \tSELECT SUM(score) INTO total FROM student; \t-- ä¸ºæ€»åˆ†æ•°å˜é‡èµ‹å€¼\r\n  \t-- åˆ¤æ–­æ€»åˆ†æ•°\r\n  \tIF total >= 380 THEN\r\n  \t\tSET description = 'å­¦ä¹ ä¼˜ç§€';\r\n  \tELSEIF total >=320 AND total < 380 THEN\r\n  \t\tSET description = 'å­¦ä¹ è‰¯å¥½';\r\n  \tELSE\r\n  \t\tSET description = 'å­¦ä¹ ä¸€èˆ¬';\r\n  \tEND IF;\r\n  END$\r\n  DELIMITER ;\r\n  -- è°ƒç”¨pro_test4å­˜å‚¨è¿‡ç¨‹\r\n  CALL pro_test4();\r\n  ```\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å‚æ•°ä¼ é€’\r\n\r\n* å‚æ•°ä¼ é€’çš„è¯­æ³•\r\n\r\n  INï¼šä»£è¡¨è¾“å…¥å‚æ•°ï¼Œéœ€è¦ç”±è°ƒç”¨è€…ä¼ é€’å®é™…æ•°æ®ï¼Œé»˜è®¤çš„\r\n  OUTï¼šä»£è¡¨è¾“å‡ºå‚æ•°ï¼Œè¯¥å‚æ•°å¯ä»¥ä½œä¸ºè¿”å›å€¼\r\n  INOUTï¼šä»£è¡¨æ—¢å¯ä»¥ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºè¾“å‡ºå‚æ•°\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  \r\n  -- æ ‡å‡†è¯­æ³•\r\n  CREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹åç§°([IN|OUT|INOUT] å‚æ•°å æ•°æ®ç±»å‹)\r\n  BEGIN\r\n  \tæ‰§è¡Œçš„sqlè¯­å¥;\r\n  END$\r\n  \r\n  DELIMITER ;\r\n  ```\r\n\r\n* è¾“å…¥æ€»æˆç»©å˜é‡ï¼Œä»£è¡¨å­¦ç”Ÿæ€»æˆç»©ï¼Œè¾“å‡ºåˆ†æ•°æè¿°å˜é‡ï¼Œä»£è¡¨å­¦ç”Ÿæ€»æˆç»©çš„æè¿°\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  \r\n  CREATE PROCEDURE pro_test6(IN total INT, OUT description VARCHAR(10))\r\n  BEGIN\r\n  \t-- åˆ¤æ–­æ€»åˆ†æ•°\r\n  \tIF total >= 380 THEN \r\n  \t\tSET description = 'å­¦ä¹ ä¼˜ç§€';\r\n  \tELSEIF total >= 320 AND total < 380 THEN \r\n  \t\tSET description = 'å­¦ä¹ ä¸é”™';\r\n  \tELSE \r\n  \t\tSET description = 'å­¦ä¹ ä¸€èˆ¬';\r\n  \tEND IF;\r\n  END$\r\n  \r\n  DELIMITER ;\r\n  -- è°ƒç”¨pro_test6å­˜å‚¨è¿‡ç¨‹\r\n  CALL pro_test6(310,@description);\r\n  CALL pro_test6((SELECT SUM(score) FROM student), @description);\r\n  -- æŸ¥è¯¢æ€»æˆç»©æè¿°\r\n  SELECT @description;\r\n  ```\r\n\r\n* æŸ¥çœ‹å‚æ•°æ–¹æ³•\r\n\r\n  * @å˜é‡å : **ç”¨æˆ·ä¼šè¯å˜é‡**ï¼Œä»£è¡¨æ•´ä¸ªä¼šè¯è¿‡ç¨‹ä»–éƒ½æ˜¯æœ‰ä½œç”¨çš„ï¼Œç±»ä¼¼äºå…¨å±€å˜é‡\r\n  * @@å˜é‡å : **ç³»ç»Ÿå˜é‡** \r\n\r\n \r\n\r\n***\r\n\r\n\r\n\r\n##### CASE\r\n\r\n* æ ‡å‡†è¯­æ³• 1\r\n\r\n  ```sql\r\n  CASE è¡¨è¾¾å¼\r\n      WHEN å€¼1 THEN æ‰§è¡Œsqlè¯­å¥1;\r\n      [WHEN å€¼2 THEN æ‰§è¡Œsqlè¯­å¥2;]\r\n      ...\r\n      [ELSE æ‰§è¡Œsqlè¯­å¥n;]\r\n  END CASE;\r\n  ```\r\n\r\n* æ ‡å‡†è¯­æ³• 2\r\n\r\n  ```sql\r\n  sCASE\r\n      WHEN åˆ¤æ–­æ¡ä»¶1 THEN æ‰§è¡Œsqlè¯­å¥1;\r\n      [WHEN åˆ¤æ–­æ¡ä»¶2 THEN æ‰§è¡Œsqlè¯­å¥2;]\r\n      ...\r\n      [ELSE æ‰§è¡Œsqlè¯­å¥n;]\r\n  END CASE;\r\n  ```\r\n\r\n* æ¼”ç¤º\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  CREATE PROCEDURE pro_test7(IN total INT)\r\n  BEGIN\r\n  \t-- å®šä¹‰å˜é‡\r\n  \tDECLARE description VARCHAR(10);\r\n  \t-- ä½¿ç”¨caseåˆ¤æ–­\r\n  \tCASE\r\n  \tWHEN total >= 380 THEN\r\n  \t\tSET description = 'å­¦ä¹ ä¼˜ç§€';\r\n  \tWHEN total >= 320 AND total < 380 THEN\r\n  \t\tSET description = 'å­¦ä¹ ä¸é”™';\r\n  \tELSE \r\n  \t\tSET description = 'å­¦ä¹ ä¸€èˆ¬';\r\n  \tEND CASE;\r\n  \t\r\n  \t-- æŸ¥è¯¢åˆ†æ•°æè¿°ä¿¡æ¯\r\n  \tSELECT description;\r\n  END$\r\n  DELIMITER ;\r\n  -- è°ƒç”¨pro_test7å­˜å‚¨è¿‡ç¨‹\r\n  CALL pro_test7(390);\r\n  CALL pro_test7((SELECT SUM(score) FROM student));\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### WHILE\r\n\r\n* while å¾ªç¯è¯­æ³•\r\n\r\n  ```sql\r\n  WHILE æ¡ä»¶åˆ¤æ–­è¯­å¥ DO\r\n  \tå¾ªç¯ä½“è¯­å¥;\r\n  \tæ¡ä»¶æ§åˆ¶è¯­å¥;\r\n  END WHILE;\r\n  ```\r\n\r\n* è®¡ç®— 1~100 ä¹‹é—´çš„å¶æ•°å’Œ\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  CREATE PROCEDURE pro_test6()\r\n  BEGIN\r\n  \t-- å®šä¹‰æ±‚å’Œå˜é‡\r\n  \tDECLARE result INT DEFAULT 0;\r\n  \t-- å®šä¹‰åˆå§‹åŒ–å˜é‡\r\n  \tDECLARE num INT DEFAULT 1;\r\n  \t-- whileå¾ªç¯\r\n  \tWHILE num <= 100 DO\r\n  \t\tIF num % 2 = 0 THEN\r\n  \t\t\tSET result = result + num;\r\n  \t\tEND IF;\r\n  \t\tSET num = num + 1;\r\n  \tEND WHILE;\r\n  \t-- æŸ¥è¯¢æ±‚å’Œç»“æœ\r\n  \tSELECT result;\r\n  END$\r\n  DELIMITER ;\r\n  \r\n  -- è°ƒç”¨pro_test6å­˜å‚¨è¿‡ç¨‹\r\n  CALL pro_test6();\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### REPEAT\r\n\r\n* repeat å¾ªç¯æ ‡å‡†è¯­æ³•\r\n\r\n  ```sql\r\n  åˆå§‹åŒ–è¯­å¥;\r\n  REPEAT\r\n  \tå¾ªç¯ä½“è¯­å¥;\r\n  \tæ¡ä»¶æ§åˆ¶è¯­å¥;\r\n  \tUNTIL æ¡ä»¶åˆ¤æ–­è¯­å¥\r\n  END REPEAT;\r\n  ```\r\n\r\n* è®¡ç®— 1~10 ä¹‹é—´çš„å’Œ\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  CREATE PROCEDURE pro_test9()\r\n  BEGIN\r\n  \t-- å®šä¹‰æ±‚å’Œå˜é‡\r\n  \tDECLARE result INT DEFAULT 0;\r\n  \t-- å®šä¹‰åˆå§‹åŒ–å˜é‡\r\n  \tDECLARE num INT DEFAULT 1;\r\n  \t-- repeatå¾ªç¯\r\n  \tREPEAT\r\n  \t\t-- ç´¯åŠ \r\n  \t\tSET result = result + num;\r\n  \t\t-- è®©num+1\r\n  \t\tSET num = num + 1;\r\n  \t\t-- åœæ­¢å¾ªç¯\r\n  \t\tUNTIL num > 10\r\n  \tEND REPEAT;\r\n  \t-- æŸ¥è¯¢æ±‚å’Œç»“æœ\r\n  \tSELECT result;\r\n  END$\r\n  \r\n  DELIMITER ;\r\n  -- è°ƒç”¨pro_test9å­˜å‚¨è¿‡ç¨‹\r\n  CALL pro_test9();\r\n  ```\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### LOOP\r\n\r\nLOOP å®ç°ç®€å•çš„å¾ªç¯ï¼Œé€€å‡ºå¾ªç¯çš„æ¡ä»¶éœ€è¦ä½¿ç”¨å…¶ä»–çš„è¯­å¥å®šä¹‰ï¼Œé€šå¸¸å¯ä»¥ä½¿ç”¨ LEAVE è¯­å¥å®ç°ï¼Œå¦‚æœä¸åŠ é€€å‡ºå¾ªç¯çš„è¯­å¥ï¼Œé‚£ä¹ˆå°±å˜æˆäº†æ­»å¾ªç¯\r\n\r\n* loop å¾ªç¯æ ‡å‡†è¯­æ³•\r\n\r\n  ```sql\r\n  [å¾ªç¯åç§°:] LOOP\r\n  \tæ¡ä»¶åˆ¤æ–­è¯­å¥\r\n  \t\t[LEAVE å¾ªç¯åç§°;]\r\n  \tå¾ªç¯ä½“è¯­å¥;\r\n  \tæ¡ä»¶æ§åˆ¶è¯­å¥;\r\n  END LOOP å¾ªç¯åç§°;\r\n  ```\r\n\r\n* è®¡ç®— 1~10 ä¹‹é—´çš„å’Œ\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  CREATE PROCEDURE pro_test10()\r\n  BEGIN\r\n  \t-- å®šä¹‰æ±‚å’Œå˜é‡\r\n  \tDECLARE result INT DEFAULT 0;\r\n  \t-- å®šä¹‰åˆå§‹åŒ–å˜é‡\r\n  \tDECLARE num INT DEFAULT 1;\r\n  \t-- loopå¾ªç¯\r\n  \tl:LOOP\r\n  \t\t-- æ¡ä»¶æˆç«‹ï¼Œåœæ­¢å¾ªç¯\r\n  \t\tIF num > 10 THEN\r\n  \t\t\tLEAVE l;\r\n  \t\tEND IF;\r\n  \t\t-- ç´¯åŠ \r\n  \t\tSET result = result + num;\r\n  \t\t-- è®©num+1\r\n  \t\tSET num = num + 1;\r\n  \tEND LOOP l;\r\n  \t-- æŸ¥è¯¢æ±‚å’Œç»“æœ\r\n  \tSELECT result;\r\n  END$\r\n  DELIMITER ;\r\n  -- è°ƒç”¨pro_test10å­˜å‚¨è¿‡ç¨‹\r\n  CALL pro_test10();\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ¸¸æ ‡\r\n\r\næ¸¸æ ‡æ˜¯ç”¨æ¥å­˜å‚¨æŸ¥è¯¢ç»“æœé›†çš„æ•°æ®ç±»å‹ï¼Œåœ¨å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨å…‰æ ‡å¯¹ç»“æœé›†è¿›è¡Œå¾ªç¯çš„å¤„ç†\r\n\r\n* æ¸¸æ ‡å¯ä»¥éå†è¿”å›çš„å¤šè¡Œç»“æœï¼Œæ¯æ¬¡æ‹¿åˆ°ä¸€æ•´è¡Œæ•°æ®\r\n* ç®€å•æ¥è¯´æ¸¸æ ‡å°±ç±»ä¼¼äºé›†åˆçš„è¿­ä»£å™¨éå†\r\n* MySQL ä¸­çš„æ¸¸æ ‡åªèƒ½ç”¨åœ¨å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ä¸­\r\n\r\næ¸¸æ ‡çš„è¯­æ³•\r\n\r\n* åˆ›å»ºæ¸¸æ ‡\r\n\r\n  ```sql\r\n  DECLARE æ¸¸æ ‡åç§° CURSOR FOR æŸ¥è¯¢sqlè¯­å¥;\r\n  ```\r\n\r\n* æ‰“å¼€æ¸¸æ ‡\r\n\r\n  ```sql\r\n  OPEN æ¸¸æ ‡åç§°;\r\n  ```\r\n\r\n* ä½¿ç”¨æ¸¸æ ‡è·å–æ•°æ®\r\n\r\n  ```sql\r\n  FETCH æ¸¸æ ‡åç§° INTO å˜é‡å1,å˜é‡å2,...;\r\n  ```\r\n\r\n* å…³é—­æ¸¸æ ‡\r\n\r\n  ```sql\r\n  CLOSE æ¸¸æ ‡åç§°;\r\n  ```\r\n\r\n* Mysql é€šè¿‡ä¸€ä¸ª Error handler å£°æ˜æ¥åˆ¤æ–­æŒ‡é’ˆæ˜¯å¦åˆ°å°¾éƒ¨ï¼Œå¹¶ä¸”å¿…é¡»å’Œåˆ›å»ºæ¸¸æ ‡çš„ SQL è¯­å¥å£°æ˜åœ¨ä¸€èµ·ï¼š\r\n\r\n  ```sql\r\n  DECLARE EXIT HANDLER FOR NOT FOUND (do some actionï¼Œä¸€èˆ¬æ˜¯è®¾ç½®æ ‡å¿—å˜é‡)\r\n  ```\r\n\r\n  \r\n\r\næ¸¸æ ‡çš„åŸºæœ¬ä½¿ç”¨\r\n\r\n* æ•°æ®å‡†å¤‡ï¼šè¡¨ student\r\n\r\n  ```sql\r\n  id\tNAME\tage\t\tgender\tscore\r\n  1\tå¼ ä¸‰\t\t23\t\tç”·\t\t95\r\n  2\tæå››\t\t24\t\tç”·\t\t98\r\n  3\tç‹äº”\t\t25\t\tå¥³\t\t100\r\n  4\tèµµå…­\t\t26\t\tå¥³\t\t90\r\n  ```\r\n\r\n* åˆ›å»º stu_score è¡¨\r\n\r\n  ```sql\r\n  CREATE TABLE stu_score(\r\n  \tid INT PRIMARY KEY AUTO_INCREMENT,\r\n  \tscore INT\r\n  );\r\n  ```\r\n\r\n* å°†studentè¡¨ä¸­æ‰€æœ‰çš„æˆç»©ä¿å­˜åˆ°stu_scoreè¡¨ä¸­\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  \r\n  CREATE PROCEDURE pro_test12()\r\n  BEGIN\r\n  \t-- å®šä¹‰æˆç»©å˜é‡\r\n  \tDECLARE s_score INT;\r\n  \t-- å®šä¹‰æ ‡è®°å˜é‡\r\n  \tDECLARE flag INT DEFAULT 0;\r\n  \t\r\n  \t-- åˆ›å»ºæ¸¸æ ‡ï¼ŒæŸ¥è¯¢æ‰€æœ‰å­¦ç”Ÿæˆç»©æ•°æ®\r\n  \tDECLARE stu_result CURSOR FOR SELECT score FROM student;\r\n  \t-- æ¸¸æ ‡ç»“æŸåï¼Œå°†æ ‡è®°å˜é‡æ”¹ä¸º1  è¿™ä¸¤ä¸ªå¿…é¡»å£°æ˜åœ¨ä¸€èµ·\r\n  \tDECLARE EXIT HANDLER FOR NOT FOUND SET flag = 1;\r\n  \t\r\n  \t-- å¼€å¯æ¸¸æ ‡\r\n  \tOPEN stu_result;\r\n  \t-- å¾ªç¯ä½¿ç”¨æ¸¸æ ‡\r\n  \tREPEAT\r\n  \t\t-- ä½¿ç”¨æ¸¸æ ‡ï¼Œéå†ç»“æœ,æ‹¿åˆ°æ•°æ®\r\n  \t\tFETCH stu_result INTO s_score;\r\n  \t\t-- å°†æ•°æ®ä¿å­˜åˆ°stu_scoreè¡¨ä¸­\r\n  \t\tINSERT INTO stu_score VALUES (NULL,s_score);\r\n  \tUNTIL flag=1\r\n  \tEND REPEAT;\r\n  \t-- å…³é—­æ¸¸æ ‡\r\n  \tCLOSE stu_result;\r\n  END$\r\n  \r\n  DELIMITER ;\r\n  \r\n  -- è°ƒç”¨pro_test12å­˜å‚¨è¿‡ç¨‹\r\n  CALL pro_test12();\r\n  -- æŸ¥è¯¢stu_scoreè¡¨\r\n  SELECT * FROM stu_score;\r\n  ```\r\n\r\n  \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å­˜å‚¨å‡½æ•°\r\n\r\nå­˜å‚¨å‡½æ•°å’Œå­˜å‚¨è¿‡ç¨‹æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼Œå­˜å‚¨å‡½æ•°å¯ä»¥åšçš„äº‹æƒ…ï¼Œå­˜å‚¨è¿‡ç¨‹ä¹Ÿå¯ä»¥åšåˆ°\r\n\r\nå­˜å‚¨å‡½æ•°æœ‰è¿”å›å€¼ï¼Œå­˜å‚¨è¿‡ç¨‹æ²¡æœ‰è¿”å›å€¼ï¼ˆå‚æ•°çš„ out å…¶å®ä¹Ÿç›¸å½“äºæ˜¯è¿”å›æ•°æ®äº†ï¼‰\r\n\r\n* åˆ›å»ºå­˜å‚¨å‡½æ•°\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  -- æ ‡å‡†è¯­æ³•\r\n  CREATE FUNCTION å‡½æ•°åç§°(å‚æ•° æ•°æ®ç±»å‹)\r\n  RETURNS è¿”å›å€¼ç±»å‹\r\n  BEGIN\r\n  \tæ‰§è¡Œçš„sqlè¯­å¥;\r\n  \tRETURN ç»“æœ;\r\n  END$\r\n  \r\n  DELIMITER ;\r\n  ```\r\n\r\n* è°ƒç”¨å­˜å‚¨å‡½æ•°ï¼Œå› ä¸ºæœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥ä½¿ç”¨ SELECT è°ƒç”¨\r\n\r\n  ```sql\r\n  SELECT å‡½æ•°åç§°(å®é™…å‚æ•°);\r\n  ```\r\n\r\n* åˆ é™¤å­˜å‚¨å‡½æ•°\r\n\r\n  ```sql\r\n  DROP FUNCTION å‡½æ•°åç§°;\r\n  ```\r\n\r\n* å®šä¹‰å­˜å‚¨å‡½æ•°ï¼Œè·å–å­¦ç”Ÿè¡¨ä¸­æˆç»©å¤§äº95åˆ†çš„å­¦ç”Ÿæ•°é‡\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  CREATE FUNCTION fun_test()\r\n  RETURN INT\r\n  BEGIN\r\n  \t-- å®šä¹‰ç»Ÿè®¡å˜é‡\r\n  \tDECLARE result INT;\r\n  \t-- æŸ¥è¯¢æˆç»©å¤§äº95åˆ†çš„å­¦ç”Ÿæ•°é‡ï¼Œç»™ç»Ÿè®¡å˜é‡èµ‹å€¼\r\n  \tSELECT COUNT(score) INTO result FROM student WHERE score > 95;\r\n  \t-- è¿”å›ç»Ÿè®¡ç»“æœ\r\n  \tSELECT result;\r\n  END\r\n  DELIMITER ;\r\n  -- è°ƒç”¨fun_testå­˜å‚¨å‡½æ•°\r\n  SELECT fun_test();\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### è§¦å‘å™¨\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\nè§¦å‘å™¨æ˜¯ä¸è¡¨æœ‰å…³çš„æ•°æ®åº“å¯¹è±¡ï¼Œåœ¨ insert/update/delete ä¹‹å‰æˆ–ä¹‹åè§¦å‘å¹¶æ‰§è¡Œè§¦å‘å™¨ä¸­å®šä¹‰çš„ SQL è¯­å¥\r\n\r\n* è§¦å‘å™¨çš„è¿™ç§ç‰¹æ€§å¯ä»¥ååŠ©åº”ç”¨åœ¨æ•°æ®åº“ç«¯ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ ã€æ—¥å¿—è®°å½• ã€æ•°æ®æ ¡éªŒç­‰æ“ä½œ\r\n\r\n- ä½¿ç”¨åˆ«å NEW å’Œ OLD æ¥å¼•ç”¨è§¦å‘å™¨ä¸­å‘ç”Ÿå˜åŒ–çš„è®°å½•å†…å®¹ï¼Œè¿™ä¸å…¶ä»–çš„æ•°æ®åº“æ˜¯ç›¸ä¼¼çš„\r\n- ç°åœ¨è§¦å‘å™¨è¿˜åªæ”¯æŒè¡Œçº§è§¦å‘ï¼Œä¸æ”¯æŒè¯­å¥çº§è§¦å‘\r\n\r\n| è§¦å‘å™¨ç±»å‹      | OLDçš„å«ä¹‰                      | NEWçš„å«ä¹‰                      |\r\n| --------------- | ------------------------------ | ------------------------------ |\r\n| INSERT å‹è§¦å‘å™¨ | æ—  (å› ä¸ºæ’å…¥å‰çŠ¶æ€æ— æ•°æ®)      | NEW è¡¨ç¤ºå°†è¦æˆ–è€…å·²ç»æ–°å¢çš„æ•°æ® |\r\n| UPDATE å‹è§¦å‘å™¨ | OLD è¡¨ç¤ºä¿®æ”¹ä¹‹å‰çš„æ•°æ®         | NEW è¡¨ç¤ºå°†è¦æˆ–å·²ç»ä¿®æ”¹åçš„æ•°æ® |\r\n| DELETE å‹è§¦å‘å™¨ | OLD è¡¨ç¤ºå°†è¦æˆ–è€…å·²ç»åˆ é™¤çš„æ•°æ® | æ—  (å› ä¸ºåˆ é™¤åçŠ¶æ€æ— æ•°æ®)      |\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åŸºæœ¬æ“ä½œ\r\n\r\n* åˆ›å»ºè§¦å‘å™¨\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  \r\n  CREATE TRIGGER è§¦å‘å™¨åç§°\r\n  BEFORE|AFTER  INSERT|UPDATE|DELETE\r\n  ON è¡¨å\r\n  [FOR EACH ROW]  -- è¡Œçº§è§¦å‘å™¨\r\n  BEGIN\r\n  \tè§¦å‘å™¨è¦æ‰§è¡Œçš„åŠŸèƒ½;\r\n  END$\r\n  \r\n  DELIMITER ;\r\n  ```\r\n\r\n* æŸ¥çœ‹è§¦å‘å™¨çš„çŠ¶æ€ã€è¯­æ³•ç­‰ä¿¡æ¯\r\n\r\n  ```sql\r\n  SHOW TRIGGERS;\r\n  ```\r\n\r\n* åˆ é™¤è§¦å‘å™¨ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š schema_nameï¼Œé»˜è®¤ä¸ºå½“å‰æ•°æ®åº“\r\n\r\n  ```sql\r\n  DROP TRIGGER [schema_name.]trigger_name;\r\n  ```\r\n\r\n  \r\n\r\n***\r\n\r\n\r\n\r\n#### è§¦å‘æ¼”ç¤º\r\n\r\né€šè¿‡è§¦å‘å™¨è®°å½•è´¦æˆ·è¡¨çš„æ•°æ®å˜æ›´æ—¥å¿—ã€‚åŒ…å«ï¼šå¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤\r\n\r\n* æ•°æ®å‡†å¤‡\r\n\r\n  ```sql\r\n  -- åˆ›å»ºdb9æ•°æ®åº“\r\n  CREATE DATABASE db9;\r\n  -- ä½¿ç”¨db9æ•°æ®åº“\r\n  USE db9;\r\n  ```\r\n\r\n  ```sql\r\n  -- åˆ›å»ºè´¦æˆ·è¡¨account\r\n  CREATE TABLE account(\r\n  \tid INT PRIMARY KEY AUTO_INCREMENT,\t-- è´¦æˆ·id\r\n  \tNAME VARCHAR(20),\t\t\t\t\t-- å§“å\r\n  \tmoney DOUBLE\t\t\t\t\t\t-- ä½™é¢\r\n  );\r\n  -- æ·»åŠ æ•°æ®\r\n  INSERT INTO account VALUES (NULL,'å¼ ä¸‰',1000),(NULL,'æå››',2000);\r\n  ```\r\n\r\n  ```sql\r\n  -- åˆ›å»ºæ—¥å¿—è¡¨account_log\r\n  CREATE TABLE account_log(\r\n  \tid INT PRIMARY KEY AUTO_INCREMENT,\t-- æ—¥å¿—id\r\n  \toperation VARCHAR(20),\t\t\t\t-- æ“ä½œç±»å‹ (insert update delete)\r\n  \toperation_time DATETIME,\t\t\t-- æ“ä½œæ—¶é—´\r\n  \toperation_id INT,\t\t\t\t\t-- æ“ä½œè¡¨çš„id\r\n  \toperation_params VARCHAR(200)       -- æ“ä½œå‚æ•°\r\n  );\r\n  ```\r\n\r\n* åˆ›å»º INSERT å‹è§¦å‘å™¨\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  \r\n  CREATE TRIGGER account_insert\r\n  AFTER INSERT\r\n  ON account\r\n  FOR EACH ROW\r\n  BEGIN\r\n  \tINSERT INTO account_log VALUES (NULL,'INSERT',NOW(),new.id,CONCAT('æ’å…¥å{id=',new.id,',name=',new.name,',money=',new.money,'}'));\r\n  END$\r\n  \r\n  DELIMITER ;\r\n  ```\r\n\r\n  ```sql\r\n  -- å‘accountè¡¨æ·»åŠ è®°å½•\r\n  INSERT INTO account VALUES (NULL,'ç‹äº”',3000);\r\n  \r\n  -- æŸ¥è¯¢æ—¥å¿—è¡¨\r\n  SELECT * FROM account_log;\r\n  /*\r\n  id\toperation\toperation_time\t\toperation_id\toperation_params\r\n  1\tINSERT\t   \t2021-01-26 19:51:11\t\t3\t     æ’å…¥å{id=3,name=ç‹äº”money=2000}\r\n  */\r\n  ```\r\n\r\n  \r\n\r\n* åˆ›å»º UPDATE å‹è§¦å‘å™¨\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  \r\n  CREATE TRIGGER account_update\r\n  AFTER UPDATE\r\n  ON account\r\n  FOR EACH ROW\r\n  BEGIN\r\n  \tINSERT INTO account_log VALUES (NULL,'UPDATE',NOW(),new.id,CONCAT('ä¿®æ”¹å‰{id=',old.id,',name=',old.name,',money=',old.money,'}','ä¿®æ”¹å{id=',new.id,',name=',new.name,',money=',new.money,'}'));\r\n  END$\r\n  \r\n  DELIMITER ;\r\n  ```\r\n\r\n  ```sql\r\n  -- ä¿®æ”¹accountè¡¨\r\n  UPDATE account SET money=3500 WHERE id=3;\r\n  \r\n  -- æŸ¥è¯¢æ—¥å¿—è¡¨\r\n  SELECT * FROM account_log;\r\n  /*\r\n  id\toperation\toperation_time\t\toperation_id\t  operation_params\r\n  2\tUPDATE\t   \t2021-01-26 19:58:54\t\t2\t\t æ›´æ–°å‰{id=2,name=æå››money=1000}\r\n  \t\t\t\t\t\t\t\t\t\t\t\t æ›´æ–°å{id=2,name=æå››money=200}\r\n  */\r\n  ```\r\n\r\n  \r\n\r\n* åˆ›å»º DELETE å‹è§¦å‘å™¨\r\n\r\n  ```sql\r\n  DELIMITER $\r\n  \r\n  CREATE TRIGGER account_delete\r\n  AFTER DELETE\r\n  ON account\r\n  FOR EACH ROW\r\n  BEGIN\r\n  \tINSERT INTO account_log VALUES (NULL,'DELETE',NOW(),old.id,CONCAT('åˆ é™¤å‰{id=',old.id,',name=',old.name,',money=',old.money,'}'));\r\n  END$\r\n  \r\n  DELIMITER ;\r\n  ```\r\n\r\n  ```sql\r\n  -- åˆ é™¤accountè¡¨æ•°æ®\r\n  DELETE FROM account WHERE id=3;\r\n  \r\n  -- æŸ¥è¯¢æ—¥å¿—è¡¨\r\n  SELECT * FROM account_log;\r\n  /*\r\n  id\toperation\toperation_time\t\toperation_id\toperation_params\r\n  3\tDELETE\t\t2021-01-26 20:02:48\t\t3\t    åˆ é™¤å‰{id=3,name=ç‹äº”money=2000}\r\n  */\r\n  ```\r\n\r\n\r\n\r\n****\r\n\r\n## èŒƒå¼\r\n\r\n### ç¬¬ä¸€èŒƒå¼\r\n\r\nå»ºç«‹ç§‘å­¦çš„ï¼Œ**è§„èŒƒçš„æ•°æ®è¡¨**å°±éœ€è¦æ»¡è¶³ä¸€äº›è§„åˆ™æ¥ä¼˜åŒ–æ•°æ®çš„è®¾è®¡å’Œå­˜å‚¨ï¼Œè¿™äº›è§„åˆ™å°±ç§°ä¸ºèŒƒå¼\r\n\r\n**1NFï¼š**æ•°æ®åº“è¡¨çš„æ¯ä¸€åˆ—éƒ½æ˜¯ä¸å¯åˆ†å‰²çš„åŸå­æ•°æ®é¡¹ï¼Œä¸èƒ½æ˜¯é›†åˆã€æ•°ç»„ç­‰éåŸå­æ•°æ®é¡¹ã€‚å³è¡¨ä¸­çš„æŸä¸ªåˆ—æœ‰å¤šä¸ªå€¼æ—¶ï¼Œå¿…é¡»æ‹†åˆ†ä¸ºä¸åŒçš„åˆ—ã€‚ç®€è€Œè¨€ä¹‹ï¼Œ**ç¬¬ä¸€èŒƒå¼æ¯ä¸€åˆ—ä¸å¯å†æ‹†åˆ†ï¼Œç§°ä¸ºåŸå­æ€§**\r\n\r\nåŸºæœ¬è¡¨ï¼š\r\n\r\n![image-20250319234724584](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319234724584.png)\r\n\t\t\t\t\t\r\n\r\nç¬¬ä¸€èŒƒå¼è¡¨ï¼š\r\n\r\n![image-20250319234816785](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319234816785.png)\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### ç¬¬äºŒèŒƒå¼\r\n\r\n**2NFï¼š**åœ¨æ»¡è¶³ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œéä¸»å±æ€§å®Œå…¨ä¾èµ–äºä¸»ç ï¼ˆä¸»å…³é”®å­—ã€ä¸»é”®ï¼‰ï¼Œæ¶ˆé™¤éä¸»å±æ€§å¯¹ä¸»ç çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ã€‚ç®€è€Œè¨€ä¹‹ï¼Œ**è¡¨ä¸­çš„æ¯ä¸€ä¸ªå­—æ®µ ï¼ˆæ‰€æœ‰åˆ—ï¼‰éƒ½å®Œå…¨ä¾èµ–äºä¸»é”®ï¼Œè®°å½•çš„å”¯ä¸€æ€§**\r\n\r\nä½œç”¨ï¼šéµå®ˆç¬¬äºŒèŒƒå¼å‡å°‘æ•°æ®å†—ä½™ï¼Œé€šè¿‡ä¸»é”®åŒºåˆ†ç›¸åŒæ•°æ®ã€‚\r\n\r\n1. å‡½æ•°ä¾èµ–ï¼šA â†’ Bï¼Œå¦‚æœé€šè¿‡ A å±æ€§(å±æ€§ç»„)çš„å€¼ï¼Œå¯ä»¥ç¡®å®šå”¯ä¸€ B å±æ€§çš„å€¼ï¼Œåˆ™ç§° B ä¾èµ–äº A\r\n   * å­¦å· â†’ å§“åï¼›(å­¦å·ï¼Œè¯¾ç¨‹åç§°) â†’ åˆ†æ•°\r\n2. å®Œå…¨å‡½æ•°ä¾èµ–ï¼šA â†’ Bï¼Œå¦‚æœAæ˜¯ä¸€ä¸ªå±æ€§ç»„ï¼Œåˆ™ B å±æ€§å€¼çš„ç¡®å®šéœ€è¦ä¾èµ–äº A å±æ€§ç»„çš„æ‰€æœ‰å±æ€§å€¼\r\n   * (å­¦å·ï¼Œè¯¾ç¨‹åç§°) â†’ åˆ†æ•°\r\n3. éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼šA â†’ Bï¼Œå¦‚æœ A æ˜¯ä¸€ä¸ªå±æ€§ç»„ï¼Œåˆ™ B å±æ€§å€¼çš„ç¡®å®šåªéœ€è¦ä¾èµ–äº A å±æ€§ç»„çš„æŸäº›å±æ€§å€¼\r\n   * (å­¦å·ï¼Œè¯¾ç¨‹åç§°) â†’ å§“å\r\n4. ä¼ é€’å‡½æ•°ä¾èµ–ï¼šA â†’ Bï¼ŒB â†’ Cï¼Œå¦‚æœé€šè¿‡Aå±æ€§(å±æ€§ç»„)çš„å€¼ï¼Œå¯ä»¥ç¡®å®šå”¯ä¸€ B å±æ€§çš„å€¼ï¼Œåœ¨é€šè¿‡ B å±æ€§(å±æ€§ç»„)çš„å€¼ï¼Œå¯ä»¥ç¡®å®šå”¯ä¸€ C å±æ€§çš„å€¼ï¼Œåˆ™ç§° C ä¼ é€’å‡½æ•°ä¾èµ–äº A\r\n   * å­¦å· â†’ ç³»åï¼Œç³»å â†’ ç³»ä¸»ä»»\r\n5. ç ï¼šå¦‚æœåœ¨ä¸€å¼ è¡¨ä¸­ï¼Œä¸€ä¸ªå±æ€§æˆ–å±æ€§ç»„ï¼Œè¢«å…¶ä»–æ‰€æœ‰å±æ€§æ‰€å®Œå…¨ä¾èµ–ï¼Œåˆ™ç§°è¿™ä¸ªå±æ€§(å±æ€§ç»„)ä¸ºè¯¥è¡¨çš„ç \r\n   * è¯¥è¡¨ä¸­çš„ç ï¼š(å­¦å·ï¼Œè¯¾ç¨‹åç§°)\r\n   * ä¸»å±æ€§ï¼šç å±æ€§ç»„ä¸­çš„æ‰€æœ‰å±æ€§\r\n   * éä¸»å±æ€§ï¼šé™¤ç å±æ€§ç»„ä»¥å¤–çš„å±æ€§\r\n\r\n![image-20250319234838513](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319234838513.png)\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### ç¬¬ä¸‰èŒƒå¼\r\n\r\n**3NFï¼š**åœ¨æ»¡è¶³ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œè¡¨ä¸­çš„ä»»ä½•å±æ€§ä¸ä¾èµ–äºå…¶å®ƒéä¸»å±æ€§ï¼Œæ¶ˆé™¤ä¼ é€’ä¾èµ–ã€‚ç®€è€Œè¨€ä¹‹ï¼Œ**éä¸»é”®éƒ½ç›´æ¥ä¾èµ–äºä¸»é”®ï¼Œè€Œä¸æ˜¯é€šè¿‡å…¶å®ƒçš„é”®æ¥é—´æ¥ä¾èµ–äºä¸»é”®**ã€‚\r\n\r\nä½œç”¨ï¼šå¯ä»¥é€šè¿‡ä¸»é”® id åŒºåˆ†ç›¸åŒæ•°æ®ï¼Œä¿®æ”¹æ•°æ®çš„æ—¶å€™åªéœ€è¦ä¿®æ”¹ä¸€å¼ è¡¨ï¼ˆæ–¹ä¾¿ä¿®æ”¹ï¼‰ï¼Œåä¹‹éœ€è¦ä¿®æ”¹å¤šè¡¨ã€‚\r\n\r\n![image-20250319234912807](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319234912807.png)\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### æ€»ç»“\r\n\r\n![image-20250319235102890](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235102890.png)\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"MySQL - å­˜å‚¨å¼•æ“ä¸ç´¢å¼•","tags":["SQL"],"categories":["MySQL","ç´¢å¼•ç¯‡"],"author":"imklaus","excerpt":"\r\n## å­˜å‚¨å¼•æ“\r\n\r\n### åŸºæœ¬ä»‹ç»\r\n\r\nå¯¹æ¯”å…¶ä»–æ•°æ®åº“ï¼ŒMySQL çš„æ¶æ„å¯ä»¥åœ¨ä¸åŒåœºæ™¯åº”ç”¨å¹¶å‘æŒ¥è‰¯å¥½ä½œç”¨ï¼Œä¸»è¦ä½“ç°åœ¨å­˜å‚¨å¼•æ“ï¼Œæ’ä»¶å¼çš„å­˜å‚¨å¼•æ“æ¶æ„å°†æŸ¥è¯¢å¤„ç†å’Œå…¶ä»–çš„ç³»ç»Ÿä»»åŠ¡ä»¥åŠæ•°æ®çš„å­˜å‚¨æå–åˆ†ç¦»ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„å­˜å‚¨éœ€æ±‚å¯ä»¥é€‰æ‹©æœ€ä¼˜çš„å­˜å‚¨å¼•æ“\r\n\r\nå­˜å‚¨å¼•æ“çš„ä»‹ç»ï¼š\r\n\r\n- MySQL æ•°æ®åº“ä½¿ç”¨ä¸åŒçš„æœºåˆ¶å­˜å–è¡¨æ–‡ä»¶ , æœºåˆ¶çš„å·®åˆ«åœ¨äºä¸åŒçš„å­˜å‚¨æ–¹å¼ã€ç´¢å¼•æŠ€å·§ã€é”å®šæ°´å¹³ç­‰ä¸åŒçš„åŠŸèƒ½å’Œèƒ½åŠ›ï¼Œåœ¨ MySQL ä¸­ï¼Œå°†è¿™äº›ä¸åŒçš„æŠ€æœ¯åŠé…å¥—çš„åŠŸèƒ½ç§°ä¸ºå­˜å‚¨å¼•æ“\r\n- Oracleã€SqlServer ç­‰æ•°æ®åº“åªæœ‰ä¸€ç§å­˜å‚¨å¼•æ“ï¼ŒMySQL **æä¾›äº†æ’ä»¶å¼çš„å­˜å‚¨å¼•æ“æ¶æ„**ï¼Œæ‰€ä»¥ MySQL å­˜åœ¨å¤šç§å­˜å‚¨å¼•æ“ , å°±ä¼šè®©æ•°æ®åº“é‡‡å–äº†ä¸åŒçš„å¤„ç†æ•°æ®çš„æ–¹å¼å’Œæ‰©å±•åŠŸèƒ½\r\n- åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­æ•°æ®çš„å­˜å‚¨æ˜¯ä»¥è¡¨çš„å½¢å¼å­˜è¿›è¡Œï¼Œæ‰€ä»¥å­˜å‚¨å¼•æ“ä¹Ÿç§°ä¸ºè¡¨ç±»å‹ï¼ˆå­˜å‚¨å’Œæ“ä½œæ­¤è¡¨çš„ç±»å‹ï¼‰\r\n- é€šè¿‡é€‰æ‹©ä¸åŒçš„å¼•æ“ï¼Œèƒ½å¤Ÿè·å–æœ€ä½³çš„æ–¹æ¡ˆ,  ä¹Ÿèƒ½å¤Ÿè·å¾—é¢å¤–çš„é€Ÿåº¦æˆ–è€…åŠŸèƒ½ï¼Œæé«˜ç¨‹åºçš„æ•´ä½“æ•ˆæœã€‚\r\n\r\nMySQL æ”¯æŒçš„å­˜å‚¨å¼•æ“ï¼š\r\n\r\n- MySQL æ”¯æŒçš„å¼•æ“åŒ…æ‹¬ï¼šInnoDBã€MyISAMã€MEMORYã€Archiveã€Federateã€CSVã€BLACKHOLE ç­‰\r\n- MySQL5.5 ä¹‹å‰çš„é»˜è®¤å­˜å‚¨å¼•æ“æ˜¯ MyISAMï¼Œ5.5 ä¹‹åå°±æ”¹ä¸ºäº† InnoDB\r\n\r\n","link":"/posts/MySQL_Index","content":"\r\n## å­˜å‚¨å¼•æ“\r\n\r\n### åŸºæœ¬ä»‹ç»\r\n\r\nå¯¹æ¯”å…¶ä»–æ•°æ®åº“ï¼ŒMySQL çš„æ¶æ„å¯ä»¥åœ¨ä¸åŒåœºæ™¯åº”ç”¨å¹¶å‘æŒ¥è‰¯å¥½ä½œç”¨ï¼Œä¸»è¦ä½“ç°åœ¨å­˜å‚¨å¼•æ“ï¼Œæ’ä»¶å¼çš„å­˜å‚¨å¼•æ“æ¶æ„å°†æŸ¥è¯¢å¤„ç†å’Œå…¶ä»–çš„ç³»ç»Ÿä»»åŠ¡ä»¥åŠæ•°æ®çš„å­˜å‚¨æå–åˆ†ç¦»ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„å­˜å‚¨éœ€æ±‚å¯ä»¥é€‰æ‹©æœ€ä¼˜çš„å­˜å‚¨å¼•æ“\r\n\r\nå­˜å‚¨å¼•æ“çš„ä»‹ç»ï¼š\r\n\r\n- MySQL æ•°æ®åº“ä½¿ç”¨ä¸åŒçš„æœºåˆ¶å­˜å–è¡¨æ–‡ä»¶ , æœºåˆ¶çš„å·®åˆ«åœ¨äºä¸åŒçš„å­˜å‚¨æ–¹å¼ã€ç´¢å¼•æŠ€å·§ã€é”å®šæ°´å¹³ç­‰ä¸åŒçš„åŠŸèƒ½å’Œèƒ½åŠ›ï¼Œåœ¨ MySQL ä¸­ï¼Œå°†è¿™äº›ä¸åŒçš„æŠ€æœ¯åŠé…å¥—çš„åŠŸèƒ½ç§°ä¸ºå­˜å‚¨å¼•æ“\r\n- Oracleã€SqlServer ç­‰æ•°æ®åº“åªæœ‰ä¸€ç§å­˜å‚¨å¼•æ“ï¼ŒMySQL **æä¾›äº†æ’ä»¶å¼çš„å­˜å‚¨å¼•æ“æ¶æ„**ï¼Œæ‰€ä»¥ MySQL å­˜åœ¨å¤šç§å­˜å‚¨å¼•æ“ , å°±ä¼šè®©æ•°æ®åº“é‡‡å–äº†ä¸åŒçš„å¤„ç†æ•°æ®çš„æ–¹å¼å’Œæ‰©å±•åŠŸèƒ½\r\n- åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­æ•°æ®çš„å­˜å‚¨æ˜¯ä»¥è¡¨çš„å½¢å¼å­˜è¿›è¡Œï¼Œæ‰€ä»¥å­˜å‚¨å¼•æ“ä¹Ÿç§°ä¸ºè¡¨ç±»å‹ï¼ˆå­˜å‚¨å’Œæ“ä½œæ­¤è¡¨çš„ç±»å‹ï¼‰\r\n- é€šè¿‡é€‰æ‹©ä¸åŒçš„å¼•æ“ï¼Œèƒ½å¤Ÿè·å–æœ€ä½³çš„æ–¹æ¡ˆ,  ä¹Ÿèƒ½å¤Ÿè·å¾—é¢å¤–çš„é€Ÿåº¦æˆ–è€…åŠŸèƒ½ï¼Œæé«˜ç¨‹åºçš„æ•´ä½“æ•ˆæœã€‚\r\n\r\nMySQL æ”¯æŒçš„å­˜å‚¨å¼•æ“ï¼š\r\n\r\n- MySQL æ”¯æŒçš„å¼•æ“åŒ…æ‹¬ï¼šInnoDBã€MyISAMã€MEMORYã€Archiveã€Federateã€CSVã€BLACKHOLE ç­‰\r\n- MySQL5.5 ä¹‹å‰çš„é»˜è®¤å­˜å‚¨å¼•æ“æ˜¯ MyISAMï¼Œ5.5 ä¹‹åå°±æ”¹ä¸ºäº† InnoDB\r\n\r\n<!-- more -->\r\n\r\n****\r\n\r\n\r\n\r\n### å¼•æ“å¯¹æ¯”\r\n\r\nMyISAM å­˜å‚¨å¼•æ“ï¼š\r\n\r\n* ç‰¹ç‚¹ï¼šä¸æ”¯æŒäº‹åŠ¡å’Œå¤–é”®ï¼Œè¯»å–é€Ÿåº¦å¿«ï¼ŒèŠ‚çº¦èµ„æº\r\n* åº”ç”¨åœºæ™¯ï¼š**é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯**ï¼Œå¯¹äº‹åŠ¡çš„å®Œæ•´æ€§è¦æ±‚ä¸é«˜ï¼Œæ¯”å¦‚ä¸€äº›æ•°ä»“ã€ç¦»çº¿æ•°æ®ã€æ”¯ä»˜å®çš„å¹´åº¦æ€»ç»“ä¹‹ç±»çš„åœºæ™¯ï¼Œä¸šåŠ¡è¿›è¡Œåªè¯»æ“ä½œï¼ŒæŸ¥è¯¢èµ·æ¥ä¼šæ›´å¿«\r\n* å­˜å‚¨æ–¹å¼ï¼š\r\n  * æ¯ä¸ª MyISAM åœ¨ç£ç›˜ä¸Šå­˜å‚¨æˆ 3 ä¸ªæ–‡ä»¶ï¼Œå…¶æ–‡ä»¶åéƒ½å’Œè¡¨åç›¸åŒï¼Œæ‹“å±•åä¸åŒ\r\n  * è¡¨çš„å®šä¹‰ä¿å­˜åœ¨ .frm æ–‡ä»¶ï¼Œè¡¨æ•°æ®ä¿å­˜åœ¨ .MYD (MYData) æ–‡ä»¶ä¸­ï¼Œç´¢å¼•ä¿å­˜åœ¨ .MYI (MYIndex) æ–‡ä»¶ä¸­\r\n\r\nInnoDB å­˜å‚¨å¼•æ“ï¼š(MySQL5.5 ç‰ˆæœ¬åé»˜è®¤çš„å­˜å‚¨å¼•æ“)\r\n\r\n- ç‰¹ç‚¹ï¼š**æ”¯æŒäº‹åŠ¡**å’Œå¤–é”®æ“ä½œï¼Œæ”¯æŒå¹¶å‘æ§åˆ¶ã€‚å¯¹æ¯” MyISAM çš„å­˜å‚¨å¼•æ“ï¼ŒInnoDB å†™çš„å¤„ç†æ•ˆç‡å·®ä¸€äº›ï¼Œå¹¶ä¸”ä¼šå ç”¨æ›´å¤šçš„ç£ç›˜ç©ºé—´ä»¥ä¿ç•™æ•°æ®å’Œç´¢å¼•\r\n- åº”ç”¨åœºæ™¯ï¼šå¯¹äº‹åŠ¡çš„å®Œæ•´æ€§æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼Œåœ¨å¹¶å‘æ¡ä»¶ä¸‹è¦æ±‚æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¯»å†™é¢‘ç¹çš„æ“ä½œ\r\n- å­˜å‚¨æ–¹å¼ï¼š\r\n  - ä½¿ç”¨å…±äº«è¡¨ç©ºé—´å­˜å‚¨ï¼Œ è¿™ç§æ–¹å¼åˆ›å»ºçš„è¡¨çš„è¡¨ç»“æ„ä¿å­˜åœ¨ .frm æ–‡ä»¶ä¸­ï¼Œ æ•°æ®å’Œç´¢å¼•ä¿å­˜åœ¨ innodb_data_home_dir å’Œ innodb_data_file_path å®šä¹‰çš„è¡¨ç©ºé—´ä¸­ï¼Œå¯ä»¥æ˜¯å¤šä¸ªæ–‡ä»¶\r\n  - ä½¿ç”¨å¤šè¡¨ç©ºé—´å­˜å‚¨ï¼Œåˆ›å»ºçš„è¡¨çš„è¡¨ç»“æ„å­˜åœ¨ .frm æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªè¡¨çš„æ•°æ®å’Œç´¢å¼•å•ç‹¬ä¿å­˜åœ¨ .ibd ä¸­\r\n\r\nMEMORY å­˜å‚¨å¼•æ“ï¼š\r\n\r\n- ç‰¹ç‚¹ï¼šæ¯ä¸ª MEMORY è¡¨å®é™…å¯¹åº”ä¸€ä¸ªç£ç›˜æ–‡ä»¶ ï¼Œè¯¥æ–‡ä»¶ä¸­åªå­˜å‚¨è¡¨çš„ç»“æ„ï¼Œè¡¨æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸”é»˜è®¤**ä½¿ç”¨ HASH ç´¢å¼•**ï¼Œæ‰€ä»¥æ•°æ®é»˜è®¤å°±æ˜¯æ— åºçš„ï¼Œä½†æ˜¯åœ¨éœ€è¦å¿«é€Ÿå®šä½è®°å½•å¯ä»¥æä¾›æ›´å¿«çš„è®¿é—®ï¼Œ**æœåŠ¡ä¸€æ—¦å…³é—­ï¼Œè¡¨ä¸­çš„æ•°æ®å°±ä¼šä¸¢å¤±**ï¼Œå­˜å‚¨ä¸å®‰å…¨\r\n- åº”ç”¨åœºæ™¯ï¼š**ç¼“å­˜å‹å­˜å‚¨å¼•æ“**ï¼Œé€šå¸¸ç”¨äºæ›´æ–°ä¸å¤ªé¢‘ç¹çš„å°è¡¨ï¼Œç”¨ä»¥å¿«é€Ÿå¾—åˆ°è®¿é—®ç»“æœ\r\n- å­˜å‚¨æ–¹å¼ï¼šè¡¨ç»“æ„ä¿å­˜åœ¨ .frm ä¸­\r\n\r\nMERGE å­˜å‚¨å¼•æ“ï¼š\r\n\r\n* ç‰¹ç‚¹ï¼š\r\n\r\n  * æ˜¯ä¸€ç»„ MyISAM è¡¨çš„ç»„åˆï¼Œè¿™äº› MyISAM è¡¨å¿…é¡»ç»“æ„å®Œå…¨ç›¸åŒï¼Œé€šè¿‡å°†ä¸åŒçš„è¡¨åˆ†å¸ƒåœ¨å¤šä¸ªç£ç›˜ä¸Š\r\n  * MERGE è¡¨æœ¬èº«å¹¶æ²¡æœ‰å­˜å‚¨æ•°æ®ï¼Œå¯¹ MERGE ç±»å‹çš„è¡¨å¯ä»¥è¿›è¡ŒæŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤æ“ä½œï¼Œè¿™äº›æ“ä½œå®é™…ä¸Šæ˜¯å¯¹å†…éƒ¨çš„ MyISAM è¡¨è¿›è¡Œçš„\r\n\r\n* åº”ç”¨åœºæ™¯ï¼šå°†ä¸€ç³»åˆ—ç­‰åŒçš„ MyISAM è¡¨ä»¥é€»è¾‘æ–¹å¼ç»„åˆåœ¨ä¸€èµ·ï¼Œå¹¶ä½œä¸ºä¸€ä¸ªå¯¹è±¡å¼•ç”¨ä»–ä»¬ï¼Œé€‚åˆåšæ•°æ®ä»“åº“\r\n\r\n* æ“ä½œæ–¹å¼ï¼š\r\n\r\n  * æ’å…¥æ“ä½œæ˜¯é€šè¿‡ INSERT_METHOD å­å¥å®šä¹‰æ’å…¥çš„è¡¨ï¼Œä½¿ç”¨ FIRST æˆ– LAST å€¼ä½¿å¾—æ’å…¥æ“ä½œè¢«ç›¸åº”åœ°ä½œç”¨åœ¨ç¬¬ä¸€æˆ–è€…æœ€åä¸€ä¸ªè¡¨ä¸Šï¼›ä¸å®šä¹‰è¿™ä¸ªå­å¥æˆ–è€…å®šä¹‰ä¸º NOï¼Œè¡¨ç¤ºä¸èƒ½å¯¹ MERGE è¡¨æ‰§è¡Œæ’å…¥æ“ä½œ\r\n  * å¯¹ MERGE è¡¨è¿›è¡Œ DROP æ“ä½œï¼Œä½†æ˜¯è¿™ä¸ªæ“ä½œåªæ˜¯åˆ é™¤ MERGE è¡¨çš„å®šä¹‰ï¼Œå¯¹å†…éƒ¨çš„è¡¨æ˜¯æ²¡æœ‰ä»»ä½•å½±å“çš„\r\n\r\n  ```sql\r\n  CREATE TABLE order_1(\r\n  )ENGINE = MyISAM DEFAULT CHARSET=utf8;\r\n  \r\n  CREATE TABLE order_2(\r\n  )ENGINE = MyISAM DEFAULT CHARSET=utf8;\r\n  \r\n  CREATE TABLE order_all(\r\n  \t-- ç»“æ„ä¸MyISAMè¡¨ç›¸åŒ\r\n  )ENGINE = MERGE UNION = (order_1,order_2) INSERT_METHOD=LAST DEFAULT CHARSET=utf8;\r\n  ```\r\n\r\n  ![](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/MySQL-MERGE.png)\r\n\r\n| ç‰¹æ€§         | MyISAM                         | InnoDB        | MEMORY               |\r\n| ------------ | ------------------------------ | ------------- | -------------------- |\r\n| å­˜å‚¨é™åˆ¶     | æœ‰ï¼ˆå¹³å°å¯¹æ–‡ä»¶ç³»ç»Ÿå¤§å°çš„é™åˆ¶ï¼‰ | 64TB          | æœ‰ï¼ˆå¹³å°çš„å†…å­˜é™åˆ¶ï¼‰ |\r\n| **äº‹åŠ¡å®‰å…¨** | **ä¸æ”¯æŒ**                     | **æ”¯æŒ**      | **ä¸æ”¯æŒ**           |\r\n| **é”æœºåˆ¶**   | **è¡¨é”**                       | **è¡¨é”/è¡Œé”** | **è¡¨é”**             |\r\n| B+Tree ç´¢å¼•  | æ”¯æŒ                           | æ”¯æŒ          | æ”¯æŒ                 |\r\n| å“ˆå¸Œç´¢å¼•     | ä¸æ”¯æŒ                         | ä¸æ”¯æŒ        | æ”¯æŒ                 |\r\n| å…¨æ–‡ç´¢å¼•     | æ”¯æŒ                           | æ”¯æŒ          | ä¸æ”¯æŒ               |\r\n| é›†ç¾¤ç´¢å¼•     | ä¸æ”¯æŒ                         | æ”¯æŒ          | ä¸æ”¯æŒ               |\r\n| æ•°æ®ç´¢å¼•     | ä¸æ”¯æŒ                         | æ”¯æŒ          | æ”¯æŒ                 |\r\n| æ•°æ®ç¼“å­˜     | ä¸æ”¯æŒ                         | æ”¯æŒ          | N/A                  |\r\n| ç´¢å¼•ç¼“å­˜     | æ”¯æŒ                           | æ”¯æŒ          | N/A                  |\r\n| æ•°æ®å¯å‹ç¼©   | æ”¯æŒ                           | ä¸æ”¯æŒ        | ä¸æ”¯æŒ               |\r\n| ç©ºé—´ä½¿ç”¨     | ä½                             | é«˜            | N/A                  |\r\n| å†…å­˜ä½¿ç”¨     | ä½                             | é«˜            | ä¸­ç­‰                 |\r\n| æ‰¹é‡æ’å…¥é€Ÿåº¦ | é«˜                             | ä½            | é«˜                   |\r\n| **å¤–é”®**     | **ä¸æ”¯æŒ**                     | **æ”¯æŒ**      | **ä¸æ”¯æŒ**           |\r\n\r\nåªè¯»åœºæ™¯ MyISAM æ¯” InnoDB æ›´å¿«ï¼š\r\n\r\n* åº•å±‚å­˜å‚¨ç»“æ„æœ‰å·®åˆ«ï¼ŒMyISAM æ˜¯éèšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹ä¿å­˜çš„æ˜¯æ•°æ®çš„å…·ä½“åœ°å€ï¼Œä¸ç”¨å›è¡¨æŸ¥è¯¢\r\n* InnoDB æ¯æ¬¡æŸ¥è¯¢éœ€è¦ç»´æŠ¤ MVCC ç‰ˆæœ¬çŠ¶æ€ï¼Œä¿è¯å¹¶å‘çŠ¶æ€ä¸‹çš„è¯»å†™å†²çªé—®é¢˜\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å¼•æ“æ“ä½œ\r\n\r\n* æŸ¥è¯¢æ•°æ®åº“æ”¯æŒçš„å­˜å‚¨å¼•æ“\r\n\r\n  ```sql\r\n  SHOW ENGINES;\r\n  SHOW VARIABLES LIKE '%storage_engine%'; -- æŸ¥çœ‹Mysqlæ•°æ®åº“é»˜è®¤çš„å­˜å‚¨å¼•æ“ \r\n  ```\r\n\r\n* æŸ¥è¯¢æŸä¸ªæ•°æ®åº“ä¸­æ‰€æœ‰æ•°æ®è¡¨çš„å­˜å‚¨å¼•æ“\r\n\r\n  ```sql\r\n  SHOW TABLE STATUS FROM æ•°æ®åº“åç§°;\r\n  ```\r\n\r\n* æŸ¥è¯¢æŸä¸ªæ•°æ®åº“ä¸­æŸä¸ªæ•°æ®è¡¨çš„å­˜å‚¨å¼•æ“\r\n\r\n  ```sql\r\n  SHOW TABLE STATUS FROM æ•°æ®åº“åç§° WHERE NAME = 'æ•°æ®è¡¨åç§°';\r\n  ```\r\n\r\n* åˆ›å»ºæ•°æ®è¡¨ï¼ŒæŒ‡å®šå­˜å‚¨å¼•æ“\r\n\r\n  ```sql\r\n  CREATE TABLE è¡¨å(\r\n  \tåˆ—å,æ•°æ®ç±»å‹,\r\n      ...\r\n  )ENGINE = å¼•æ“åç§°;\r\n  ```\r\n\r\n* ä¿®æ”¹æ•°æ®è¡¨çš„å­˜å‚¨å¼•æ“\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å ENGINE = å¼•æ“åç§°;\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n\r\n\r\n## ç´¢å¼•æœºåˆ¶\r\n\r\n### ç´¢å¼•ä»‹ç»\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\nMySQL å®˜æ–¹å¯¹ç´¢å¼•çš„å®šä¹‰ä¸ºï¼šç´¢å¼•ï¼ˆindexï¼‰æ˜¯å¸®åŠ© MySQL é«˜æ•ˆè·å–æ•°æ®çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œ**æœ¬è´¨æ˜¯æ’å¥½åºçš„å¿«é€ŸæŸ¥æ‰¾æ•°æ®ç»“æ„ã€‚**åœ¨è¡¨æ•°æ®ä¹‹å¤–ï¼Œæ•°æ®åº“ç³»ç»Ÿè¿˜ç»´æŠ¤ç€æ»¡è¶³ç‰¹å®šæŸ¥æ‰¾ç®—æ³•çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„ä»¥æŸç§æ–¹å¼æŒ‡å‘æ•°æ®ï¼Œ è¿™æ ·å°±å¯ä»¥åœ¨è¿™äº›æ•°æ®ç»“æ„ä¸Šå®ç°é«˜çº§æŸ¥æ‰¾ç®—æ³•ï¼Œè¿™ç§æ•°æ®ç»“æ„å°±æ˜¯ç´¢å¼•\r\n\r\n**ç´¢å¼•æ˜¯åœ¨å­˜å‚¨å¼•æ“å±‚å®ç°çš„**ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ç»Ÿä¸€çš„ç´¢å¼•æ ‡å‡†ï¼Œå³ä¸åŒå­˜å‚¨å¼•æ“çš„ç´¢å¼•çš„å·¥ä½œæ–¹å¼å¹¶ä¸ä¸€æ ·\r\n\r\nç´¢å¼•ä½¿ç”¨ï¼šä¸€å¼ æ•°æ®è¡¨ï¼Œç”¨äºä¿å­˜æ•°æ®ï¼›ä¸€ä¸ªç´¢å¼•é…ç½®æ–‡ä»¶ï¼Œç”¨äºä¿å­˜ç´¢å¼•ï¼›æ¯ä¸ªç´¢å¼•éƒ½æŒ‡å‘äº†æŸä¸€ä¸ªæ•°æ®\r\n![image-20250319235408735](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235408735.png)\r\n\r\nå·¦è¾¹æ˜¯æ•°æ®è¡¨ï¼Œä¸€å…±æœ‰ä¸¤åˆ—ä¸ƒæ¡è®°å½•ï¼Œæœ€å·¦è¾¹çš„æ˜¯æ•°æ®è®°å½•çš„ç‰©ç†åœ°å€ï¼ˆæ³¨æ„é€»è¾‘ä¸Šç›¸é‚»çš„è®°å½•åœ¨ç£ç›˜ä¸Šä¹Ÿå¹¶ä¸æ˜¯ä¸€å®šç‰©ç†ç›¸é‚»çš„ï¼‰ã€‚ä¸ºäº†åŠ å¿« Col2 çš„æŸ¥æ‰¾ï¼Œå¯ä»¥ç»´æŠ¤ä¸€ä¸ªå³è¾¹æ‰€ç¤ºçš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆ†åˆ«åŒ…å«ç´¢å¼•é”®å€¼å’Œä¸€ä¸ªæŒ‡å‘å¯¹åº”æ•°æ®çš„ç‰©ç†åœ°å€çš„æŒ‡é’ˆï¼Œè¿™æ ·å°±å¯ä»¥è¿ç”¨äºŒå‰æŸ¥æ‰¾å¿«é€Ÿè·å–åˆ°ç›¸åº”æ•°æ®\r\n\r\nç´¢å¼•çš„ä¼˜ç‚¹ï¼š\r\n\r\n* ç±»ä¼¼äºä¹¦ç±çš„ç›®å½•ç´¢å¼•ï¼Œæé«˜æ•°æ®æ£€ç´¢çš„æ•ˆç‡ï¼Œé™ä½æ•°æ®åº“çš„ IO æˆæœ¬\r\n* é€šè¿‡ç´¢å¼•åˆ—å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œé™ä½æ•°æ®æ’åºçš„æˆæœ¬ï¼Œé™ä½ CPU çš„æ¶ˆè€—\r\n\r\nç´¢å¼•çš„ç¼ºç‚¹ï¼š\r\n\r\n* ä¸€èˆ¬æ¥è¯´ç´¢å¼•æœ¬èº«ä¹Ÿå¾ˆå¤§ï¼Œä¸å¯èƒ½å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼**å­˜å‚¨åœ¨ç£ç›˜**ä¸Š\r\n* è™½ç„¶ç´¢å¼•å¤§å¤§æé«˜äº†æŸ¥è¯¢æ•ˆç‡ï¼ŒåŒæ—¶å´ä¹Ÿé™ä½æ›´æ–°è¡¨çš„é€Ÿåº¦ã€‚å¯¹è¡¨è¿›è¡Œ INSERTã€UPDATEã€DELETE æ“ä½œï¼ŒMySQL ä¸ä»…è¦ä¿å­˜æ•°æ®ï¼Œè¿˜è¦ä¿å­˜ä¸€ä¸‹ç´¢å¼•æ–‡ä»¶æ¯æ¬¡æ›´æ–°æ·»åŠ äº†ç´¢å¼•åˆ—çš„å­—æ®µï¼Œè¿˜ä¼šè°ƒæ•´å› ä¸ºæ›´æ–°æ‰€å¸¦æ¥çš„é”®å€¼å˜åŒ–åçš„ç´¢å¼•ä¿¡æ¯ï¼Œ**ä½†æ˜¯æ›´æ–°æ•°æ®ä¹Ÿéœ€è¦å…ˆä»æ•°æ®åº“ä¸­è·å–**ï¼Œç´¢å¼•åŠ å¿«äº†è·å–é€Ÿåº¦ï¼Œæ‰€ä»¥å¯ä»¥ç›¸äº’æŠµæ¶ˆä¸€ä¸‹ã€‚\r\n* ç´¢å¼•ä¼šå½±å“åˆ° WHERE çš„æŸ¥è¯¢æ¡ä»¶å’Œæ’åº ORDER BY ä¸¤å¤§åŠŸèƒ½\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ç´¢å¼•åˆ†ç±»\r\n\r\nç´¢å¼•ä¸€èˆ¬çš„åˆ†ç±»å¦‚ä¸‹ï¼š\r\n\r\n- åŠŸèƒ½åˆ†ç±» \r\n\r\n  - ä¸»é”®ç´¢å¼•ï¼šä¸€ç§ç‰¹æ®Šçš„å”¯ä¸€ç´¢å¼•ï¼Œä¸å…è®¸æœ‰ç©ºå€¼ï¼Œä¸€èˆ¬åœ¨å»ºè¡¨æ—¶åŒæ—¶åˆ›å»ºä¸»é”®ç´¢å¼•\r\n  - å•åˆ—ç´¢å¼•ï¼šä¸€ä¸ªç´¢å¼•åªåŒ…å«å•ä¸ªåˆ—ï¼Œä¸€ä¸ªè¡¨å¯ä»¥æœ‰å¤šä¸ªå•åˆ—ç´¢å¼•ï¼ˆæ™®é€šç´¢å¼•ï¼‰\r\n  - è”åˆç´¢å¼•ï¼šé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°†å•åˆ—ç´¢å¼•è¿›è¡Œç»„åˆ\r\n  - å”¯ä¸€ç´¢å¼•ï¼šç´¢å¼•åˆ—çš„å€¼å¿…é¡»å”¯ä¸€ï¼Œ**å…è®¸æœ‰ç©ºå€¼**ï¼Œå¦‚æœæ˜¯è”åˆç´¢å¼•ï¼Œåˆ™åˆ—å€¼ç»„åˆå¿…é¡»å”¯ä¸€\r\n    * NULL å€¼å¯ä»¥å‡ºç°å¤šæ¬¡ï¼Œå› ä¸ºä¸¤ä¸ª NULL æ¯”è¾ƒçš„ç»“æœæ—¢ä¸ç›¸ç­‰ï¼Œä¹Ÿä¸ä¸ç­‰ï¼Œç»“æœä»ç„¶æ˜¯æœªçŸ¥\r\n    * å¯ä»¥å£°æ˜ä¸å…è®¸å­˜å‚¨ NULL å€¼çš„éç©ºå”¯ä¸€ç´¢å¼•\r\n  - å¤–é”®ç´¢å¼•ï¼šåªæœ‰ InnoDB å¼•æ“æ”¯æŒå¤–é”®ç´¢å¼•ï¼Œç”¨æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€å®Œæ•´æ€§å’Œå®ç°çº§è”æ“ä½œ\r\n\r\n- ç»“æ„åˆ†ç±»\r\n\r\n  - BTree ç´¢å¼•ï¼šMySQL ä½¿ç”¨æœ€é¢‘ç¹çš„ä¸€ä¸ªç´¢å¼•æ•°æ®ç»“æ„ï¼Œæ˜¯ InnoDB å’Œ MyISAM å­˜å‚¨å¼•æ“é»˜è®¤çš„ç´¢å¼•ç±»å‹ï¼Œåº•å±‚åŸºäº B+Tree\r\n  - Hash ç´¢å¼•ï¼šMySQLä¸­ Memory å­˜å‚¨å¼•æ“é»˜è®¤æ”¯æŒçš„ç´¢å¼•ç±»å‹\r\n  - R-tree ç´¢å¼•ï¼ˆç©ºé—´ç´¢å¼•ï¼‰ï¼šç©ºé—´ç´¢å¼•æ˜¯ MyISAM å¼•æ“çš„ä¸€ä¸ªç‰¹æ®Šç´¢å¼•ç±»å‹ï¼Œä¸»è¦ç”¨äºåœ°ç†ç©ºé—´æ•°æ®ç±»å‹\r\n  - Full-text ç´¢å¼•ï¼ˆå…¨æ–‡ç´¢å¼•ï¼‰ï¼šå¿«é€ŸåŒ¹é…å…¨éƒ¨æ–‡æ¡£çš„æ–¹å¼ã€‚MyISAM æ”¯æŒï¼Œ InnoDB ä¸æ”¯æŒ FULLTEXT ç±»å‹çš„ç´¢å¼•ï¼Œä½†æ˜¯ InnoDB å¯ä»¥ä½¿ç”¨ sphinx æ’ä»¶æ”¯æŒå…¨æ–‡ç´¢å¼•ï¼ŒMEMORY å¼•æ“ä¸æ”¯æŒ\r\n\r\n  | ç´¢å¼•      | InnoDB           | MyISAM | Memory |\r\n  | --------- | ---------------- | ------ | ------ |\r\n  | BTREE     | æ”¯æŒ             | æ”¯æŒ   | æ”¯æŒ   |\r\n  | HASH      | ä¸æ”¯æŒ           | ä¸æ”¯æŒ | æ”¯æŒ   |\r\n  | R-tree    | ä¸æ”¯æŒ           | æ”¯æŒ   | ä¸æ”¯æŒ |\r\n  | Full-text | 5.6 ç‰ˆæœ¬ä¹‹åæ”¯æŒ | æ”¯æŒ   | ä¸æ”¯æŒ |\r\n\r\nè”åˆç´¢å¼•å›¾ç¤ºï¼šæ ¹æ®èº«é«˜å¹´é¾„å»ºç«‹çš„ç»„åˆç´¢å¼•ï¼ˆheightã€ageï¼‰\r\n\r\n![image-20250319235448631](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235448631.png)\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ç´¢å¼•æ“ä½œ\r\n\r\nç´¢å¼•åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™å¯ä»¥åŒæ—¶åˆ›å»ºï¼Œ ä¹Ÿå¯ä»¥éšæ—¶å¢åŠ æ–°çš„ç´¢å¼•\r\n\r\n* åˆ›å»ºç´¢å¼•ï¼šå¦‚æœä¸€ä¸ªè¡¨ä¸­æœ‰ä¸€åˆ—æ˜¯ä¸»é”®ï¼Œé‚£ä¹ˆä¼š**é»˜è®¤ä¸ºå…¶åˆ›å»ºä¸»é”®ç´¢å¼•**ï¼ˆä¸»é”®åˆ—ä¸éœ€è¦å•ç‹¬åˆ›å»ºç´¢å¼•ï¼‰\r\n\r\n  ```sql\r\n  CREATE [UNIQUE|FULLTEXT] INDEX ç´¢å¼•åç§° [USING ç´¢å¼•ç±»å‹] ON è¡¨å(åˆ—å...);\r\n  -- ç´¢å¼•ç±»å‹é»˜è®¤æ˜¯ B+TREE\r\n  ```\r\n\r\n* æŸ¥çœ‹ç´¢å¼•\r\n\r\n  ```sql\r\n  SHOW INDEX FROM è¡¨å;\r\n  ```\r\n\r\n* æ·»åŠ ç´¢å¼•\r\n\r\n  ```sql\r\n  -- å•åˆ—ç´¢å¼•\r\n  ALTER TABLE è¡¨å ADD INDEX ç´¢å¼•åç§°(åˆ—å);\r\n  \r\n  -- ç»„åˆç´¢å¼•\r\n  ALTER TABLE è¡¨å ADD INDEX ç´¢å¼•åç§°(åˆ—å1,åˆ—å2,...);\r\n  \r\n  -- ä¸»é”®ç´¢å¼•\r\n  ALTER TABLE è¡¨å ADD PRIMARY KEY(ä¸»é”®åˆ—å); \r\n  \r\n  -- å¤–é”®ç´¢å¼•(æ·»åŠ å¤–é”®çº¦æŸï¼Œå°±æ˜¯å¤–é”®ç´¢å¼•)\r\n  ALTER TABLE è¡¨å ADD CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»é”®åˆ—å);\r\n  \r\n  -- å”¯ä¸€ç´¢å¼•\r\n  ALTER TABLE è¡¨å ADD UNIQUE ç´¢å¼•åç§°(åˆ—å);\r\n  \r\n  -- å…¨æ–‡ç´¢å¼•(mysqlåªæ”¯æŒæ–‡æœ¬ç±»å‹)\r\n  ALTER TABLE è¡¨å ADD FULLTEXT ç´¢å¼•åç§°(åˆ—å);\r\n  ```\r\n\r\n* åˆ é™¤ç´¢å¼•\r\n\r\n  ```sql\r\n  DROP INDEX ç´¢å¼•åç§° ON è¡¨å;\r\n  ```\r\n\r\n* æ¡ˆä¾‹ç»ƒä¹ \r\n\r\n  æ•°æ®å‡†å¤‡ï¼šstudent\r\n\r\n  ```sql\r\n  id\tNAME\t age\tscore\r\n  1\tå¼ ä¸‰\t\t23\t\t99\r\n  2\tæå››\t\t24\t\t95\r\n  3\tç‹äº”\t\t25\t\t98\r\n  4\tèµµå…­\t\t26\t\t97\r\n  ```\r\n\r\n  ç´¢å¼•æ“ä½œï¼š\r\n\r\n  ```sql\r\n  -- ä¸ºstudentè¡¨ä¸­å§“ååˆ—åˆ›å»ºä¸€ä¸ªæ™®é€šç´¢å¼•\r\n  CREATE INDEX idx_name ON student(NAME);\r\n  \r\n  -- ä¸ºstudentè¡¨ä¸­å¹´é¾„åˆ—åˆ›å»ºä¸€ä¸ªå”¯ä¸€ç´¢å¼•\r\n  CREATE UNIQUE INDEX idx_age ON student(age);\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### èšç°‡ç´¢å¼•\r\n\r\n#### ç´¢å¼•å¯¹æ¯”\r\n\r\nèšç°‡ç´¢å¼•æ˜¯ä¸€ç§æ•°æ®å­˜å‚¨æ–¹å¼ï¼Œå¹¶ä¸æ˜¯ä¸€ç§å•ç‹¬çš„ç´¢å¼•ç±»å‹\r\n\r\n* èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼å’Œæ•°æ®è¡Œï¼Œæ”¯æŒè¦†ç›–ç´¢å¼•\r\n\r\n* éèšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼æˆ–æŒ‡å‘æ•°æ®è¡Œçš„æŒ‡é’ˆï¼ˆç”±å­˜å‚¨å¼•æ“å†³å®šï¼‰\r\n\r\nåœ¨ Innodb ä¸‹ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œåœ¨ MyISAM ä¸‹ä¸»é”®ç´¢å¼•æ˜¯éèšç°‡ç´¢å¼•\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### Innodb\r\n\r\n##### èšç°‡ç´¢å¼•\r\n\r\nåœ¨ Innodb å­˜å‚¨å¼•æ“ï¼ŒB+ æ ‘ç´¢å¼•å¯ä»¥åˆ†ä¸ºèšç°‡ç´¢å¼•ï¼ˆä¹Ÿç§°èšé›†ç´¢å¼•ã€clustered indexï¼‰å’Œè¾…åŠ©ç´¢å¼•ï¼ˆä¹Ÿç§°éèšç°‡ç´¢å¼•æˆ–äºŒçº§ç´¢å¼•ã€secondary indexã€non-clustered indexï¼‰\r\n\r\nInnoDB ä¸­ï¼Œèšç°‡ç´¢å¼•æ˜¯æŒ‰ç…§æ¯å¼ è¡¨çš„ä¸»é”®æ„é€ ä¸€é¢— B+ æ ‘ï¼Œå¶å­èŠ‚ç‚¹ä¸­å­˜æ”¾çš„å°±æ˜¯æ•´å¼ è¡¨çš„æ•°æ®ï¼Œå°†èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ç§°ä¸ºæ•°æ®é¡µ\r\n\r\n* è¿™ä¸ªç‰¹æ€§å†³å®šäº†**æ•°æ®ä¹Ÿæ˜¯ç´¢å¼•çš„ä¸€éƒ¨åˆ†**ï¼Œæ‰€ä»¥ä¸€å¼ è¡¨åªèƒ½æœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•\r\n* è¾…åŠ©ç´¢å¼•çš„å­˜åœ¨ä¸å½±å“èšç°‡ç´¢å¼•ä¸­æ•°æ®çš„ç»„ç»‡ï¼Œæ‰€ä»¥ä¸€å¼ è¡¨å¯ä»¥æœ‰å¤šä¸ªè¾…åŠ©ç´¢å¼•\r\n\r\nèšç°‡ç´¢å¼•çš„ä¼˜ç‚¹ï¼š\r\n\r\n* æ•°æ®è®¿é—®æ›´å¿«ï¼Œèšç°‡ç´¢å¼•å°†ç´¢å¼•å’Œæ•°æ®ä¿å­˜åœ¨åŒä¸€ä¸ª B+ æ ‘ä¸­ï¼Œå› æ­¤ä»èšç°‡ç´¢å¼•ä¸­è·å–æ•°æ®æ¯”éèšç°‡ç´¢å¼•æ›´å¿«\r\n* èšç°‡ç´¢å¼•å¯¹äºä¸»é”®çš„æ’åºæŸ¥æ‰¾å’ŒèŒƒå›´æŸ¥æ‰¾é€Ÿåº¦éå¸¸å¿«\r\n\r\nèšç°‡ç´¢å¼•çš„ç¼ºç‚¹ï¼š\r\n\r\n* æ’å…¥é€Ÿåº¦ä¸¥é‡ä¾èµ–äºæ’å…¥é¡ºåºï¼ŒæŒ‰ç…§ä¸»é”®çš„é¡ºåºï¼ˆé€’å¢ï¼‰æ’å…¥æ˜¯æœ€å¿«çš„æ–¹å¼ï¼Œå¦åˆ™å°†ä¼šå‡ºç°é¡µåˆ†è£‚ï¼Œä¸¥é‡å½±å“æ€§èƒ½ï¼Œæ‰€ä»¥å¯¹äº InnoDB è¡¨ï¼Œä¸€èˆ¬éƒ½ä¼šå®šä¹‰ä¸€ä¸ªè‡ªå¢çš„ ID åˆ—ä¸ºä¸»é”®\r\n\r\n* æ›´æ–°ä¸»é”®çš„ä»£ä»·å¾ˆé«˜ï¼Œå°†ä¼šå¯¼è‡´è¢«æ›´æ–°çš„è¡Œç§»åŠ¨ï¼Œæ‰€ä»¥å¯¹äº InnoDB è¡¨ï¼Œä¸€èˆ¬å®šä¹‰ä¸»é”®ä¸ºä¸å¯æ›´æ–°\r\n\r\n* äºŒçº§ç´¢å¼•è®¿é—®éœ€è¦ä¸¤æ¬¡ç´¢å¼•æŸ¥æ‰¾ï¼Œç¬¬ä¸€æ¬¡æ‰¾åˆ°ä¸»é”®å€¼ï¼Œç¬¬äºŒæ¬¡æ ¹æ®ä¸»é”®å€¼æ‰¾åˆ°è¡Œæ•°æ®\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### è¾…åŠ©ç´¢å¼•\r\n\r\nåœ¨èšç°‡ç´¢å¼•ä¹‹ä¸Šåˆ›å»ºçš„ç´¢å¼•ç§°ä¹‹ä¸ºè¾…åŠ©ç´¢å¼•ï¼Œéèšç°‡ç´¢å¼•éƒ½æ˜¯è¾…åŠ©ç´¢å¼•ï¼Œåƒå¤åˆç´¢å¼•ã€å‰ç¼€ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ç­‰\r\n\r\nè¾…åŠ©ç´¢å¼•å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®å€¼ï¼Œè€Œä¸æ˜¯æ•°æ®çš„ç‰©ç†åœ°å€ï¼Œæ‰€ä»¥è®¿é—®æ•°æ®éœ€è¦äºŒæ¬¡æŸ¥æ‰¾ï¼Œæ¨èä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå¯ä»¥å‡å°‘å›è¡¨æŸ¥è¯¢\r\n\r\n**æ£€ç´¢è¿‡ç¨‹**ï¼šè¾…åŠ©ç´¢å¼•æ‰¾åˆ°ä¸»é”®å€¼ï¼Œå†é€šè¿‡èšç°‡ç´¢å¼•ï¼ˆäºŒåˆ†ï¼‰æ‰¾åˆ°æ•°æ®é¡µï¼Œæœ€åé€šè¿‡æ•°æ®é¡µä¸­çš„ Page Directoryï¼ˆäºŒåˆ†ï¼‰æ‰¾åˆ°å¯¹åº”çš„æ•°æ®åˆ†ç»„ï¼Œéå†ç»„å†…æ‰€æ‰€æœ‰çš„æ•°æ®æ‰¾åˆ°æ•°æ®è¡Œ\r\n\r\nè¡¥å……ï¼šæ— ç´¢å¼•èµ°å…¨è¡¨æŸ¥è¯¢ï¼ŒæŸ¥åˆ°æ•°æ®é¡µåå’Œä¸Šè¿°æ­¥éª¤ä¸€è‡´\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ç´¢å¼•å®ç°\r\n\r\nInnoDB ä½¿ç”¨ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œå¹¶ä¸” InnoDB ä¸€å®šæœ‰ç´¢å¼•\r\n\r\nä¸»é”®ç´¢å¼•ï¼š\r\n\r\n* åœ¨ InnoDB ä¸­ï¼Œè¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰ B+Tree ç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼Œè¿™ä¸ªç´¢å¼•çš„ key æ˜¯æ•°æ®è¡¨çš„ä¸»é”®ï¼Œå¶å­èŠ‚ç‚¹ data åŸŸä¿å­˜äº†å®Œæ•´çš„æ•°æ®è®°å½•\r\n\r\n* InnoDB çš„è¡¨æ•°æ®æ–‡ä»¶**é€šè¿‡ä¸»é”®èšé›†æ•°æ®**ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰ä¸»é”®ï¼Œä¼šé€‰æ‹©éç©ºå”¯ä¸€ç´¢å¼•ä»£æ›¿ï¼Œå¦‚æœä¹Ÿæ²¡æœ‰è¿™æ ·çš„åˆ—ï¼ŒMySQL ä¼šè‡ªåŠ¨ä¸º InnoDB è¡¨ç”Ÿæˆä¸€ä¸ª**éšå«å­—æ®µ row_id** ä½œä¸ºä¸»é”®ï¼Œè¿™ä¸ªå­—æ®µé•¿åº¦ä¸º 6 ä¸ªå­—èŠ‚ï¼Œç±»å‹ä¸ºé•¿æ•´å½¢\r\n\r\nè¾…åŠ©ç´¢å¼•ï¼š\r\n\r\n* InnoDB çš„æ‰€æœ‰è¾…åŠ©ç´¢å¼•ï¼ˆäºŒçº§ç´¢å¼•ï¼‰éƒ½å¼•ç”¨ä¸»é”®ä½œä¸º data åŸŸ\r\n\r\n* InnoDB è¡¨æ˜¯åŸºäºèšç°‡ç´¢å¼•å»ºç«‹çš„ï¼Œå› æ­¤ InnoDB çš„ç´¢å¼•èƒ½æä¾›ä¸€ç§éå¸¸å¿«é€Ÿçš„ä¸»é”®æŸ¥æ‰¾æ€§èƒ½ã€‚ä¸è¿‡è¾…åŠ©ç´¢å¼•ä¹Ÿä¼šåŒ…å«ä¸»é”®åˆ—ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨è¿‡é•¿çš„å­—æ®µä½œä¸ºä¸»é”®ï¼Œ**è¿‡é•¿çš„ä¸»ç´¢å¼•ä¼šä»¤è¾…åŠ©ç´¢å¼•å˜å¾—è¿‡å¤§**\r\n\r\n![image-20250319235510755](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235510755.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### MyISAM\r\n\r\n##### éèšç°‡\r\n\r\nMyISAM çš„ä¸»é”®ç´¢å¼•ä½¿ç”¨çš„æ˜¯éèšç°‡ç´¢å¼•ï¼Œç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œ**ç´¢å¼•æ–‡ä»¶ä»…ä¿å­˜æ•°æ®çš„åœ°å€**\r\n\r\n* ä¸»é”®ç´¢å¼• B+ æ ‘çš„èŠ‚ç‚¹å­˜å‚¨äº†ä¸»é”®ï¼Œè¾…åŠ©é”®ç´¢å¼• B+ æ ‘å­˜å‚¨äº†è¾…åŠ©é”®ï¼Œè¡¨æ•°æ®å­˜å‚¨åœ¨ç‹¬ç«‹çš„åœ°æ–¹ï¼Œè¿™ä¸¤é¢— B+ æ ‘çš„å¶å­èŠ‚ç‚¹éƒ½ä½¿ç”¨ä¸€ä¸ªåœ°å€æŒ‡å‘çœŸæ­£çš„è¡¨æ•°æ®ï¼Œå¯¹äºè¡¨æ•°æ®æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªé”®æ²¡æœ‰ä»»ä½•å·®åˆ«\r\n* ç”±äºç´¢å¼•æ ‘æ˜¯ç‹¬ç«‹çš„ï¼Œé€šè¿‡è¾…åŠ©ç´¢å¼•æ£€ç´¢**æ— éœ€å›è¡¨æŸ¥è¯¢**è®¿é—®ä¸»é”®çš„ç´¢å¼•æ ‘\r\n\r\n![image-20250319235552649](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235552649.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ç´¢å¼•å®ç°\r\n\r\nMyISAM çš„ç´¢å¼•æ–¹å¼ä¹Ÿå«åšéèšé›†çš„ï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆç§°å‘¼æ˜¯ä¸ºäº†ä¸ InnoDB çš„èšé›†ç´¢å¼•åŒºåˆ†\r\n\r\nä¸»é”®ç´¢å¼•ï¼šMyISAM å¼•æ“ä½¿ç”¨ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œå¶èŠ‚ç‚¹çš„ data åŸŸå­˜æ”¾çš„æ˜¯æ•°æ®è®°å½•çš„åœ°å€\r\n\r\nè¾…åŠ©ç´¢å¼•ï¼šMyISAM ä¸­ä¸»ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•ï¼ˆSecondary keyï¼‰åœ¨ç»“æ„ä¸Šæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œåªæ˜¯ä¸»ç´¢å¼•è¦æ±‚ key æ˜¯å”¯ä¸€çš„ï¼Œè€Œè¾…åŠ©ç´¢å¼•çš„ key å¯ä»¥é‡å¤\r\n\r\n![image-20250319235621481](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235621481.png)\r\n\r\n\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/lm1060891265/article/details/81482136\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ç´¢å¼•ç»“æ„\r\n\r\n#### æ•°æ®é¡µ\r\n\r\næ–‡ä»¶ç³»ç»Ÿçš„æœ€å°å•å…ƒæ˜¯å—ï¼ˆblockï¼‰ï¼Œä¸€ä¸ªå—çš„å¤§å°æ˜¯ 4Kï¼Œç³»ç»Ÿä»ç£ç›˜è¯»å–æ•°æ®åˆ°å†…å­˜æ—¶æ˜¯ä»¥ç£ç›˜å—ä¸ºåŸºæœ¬å•ä½çš„ï¼Œä½äºåŒä¸€ä¸ªç£ç›˜å—ä¸­çš„æ•°æ®ä¼šè¢«ä¸€æ¬¡æ€§è¯»å–å‡ºæ¥ï¼Œè€Œä¸æ˜¯éœ€è¦ä»€ä¹ˆå–ä»€ä¹ˆ\r\n\r\nInnoDB å­˜å‚¨å¼•æ“ä¸­æœ‰é¡µï¼ˆPageï¼‰çš„æ¦‚å¿µï¼Œé¡µæ˜¯ MySQL ç£ç›˜ç®¡ç†çš„æœ€å°å•ä½\r\n\r\n* **InnoDB å­˜å‚¨å¼•æ“ä¸­é»˜è®¤æ¯ä¸ªé¡µçš„å¤§å°ä¸º 16KBï¼Œç´¢å¼•ä¸­ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªæ•°æ®é¡µ**ï¼Œæ‰€ä»¥ä¼šä¸€æ¬¡æ€§è¯»å– 16KB çš„æ•°æ®åˆ°å†…å­˜\r\n* InnoDB å¼•æ“å°†è‹¥å¹²ä¸ªåœ°å€è¿æ¥ç£ç›˜å—ï¼Œä»¥æ­¤æ¥è¾¾åˆ°é¡µçš„å¤§å° 16KB\r\n* åœ¨æŸ¥è¯¢æ•°æ®æ—¶å¦‚æœä¸€ä¸ªé¡µä¸­çš„æ¯æ¡æ•°æ®éƒ½èƒ½æœ‰åŠ©äºå®šä½æ•°æ®è®°å½•çš„ä½ç½®ï¼Œè¿™å°†ä¼šå‡å°‘ç£ç›˜ I/O æ¬¡æ•°ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡\r\n\r\nè¶…è¿‡ 16KB çš„ä¸€æ¡è®°å½•ï¼Œä¸»é”®ç´¢å¼•é¡µåªä¼šå­˜å‚¨éƒ¨åˆ†æ•°æ®å’ŒæŒ‡å‘**æº¢å‡ºé¡µ**çš„æŒ‡é’ˆï¼Œå‰©ä½™æ•°æ®éƒ½ä¼šåˆ†æ•£å­˜å‚¨åœ¨æº¢å‡ºé¡µä¸­\r\n\r\næ•°æ®é¡µç‰©ç†ç»“æ„ï¼Œä»ä¸Šåˆ°ä¸‹ï¼š\r\n\r\n* File Headerï¼šä¸Šä¸€é¡µå’Œä¸‹ä¸€é¡µçš„æŒ‡é’ˆã€è¯¥é¡µçš„ç±»å‹ï¼ˆç´¢å¼•é¡µã€æ•°æ®é¡µã€æ—¥å¿—é¡µç­‰ï¼‰ã€**æ ¡éªŒå’Œ**ã€LSNï¼ˆæœ€è¿‘ä¸€æ¬¡ä¿®æ”¹å½“å‰é¡µé¢æ—¶çš„ç³»ç»Ÿ lsn å€¼ï¼Œäº‹åŠ¡æŒä¹…æ€§éƒ¨åˆ†è¯¦è§£ï¼‰ç­‰ä¿¡æ¯\r\n* Page Headerï¼šè®°å½•çŠ¶æ€ä¿¡æ¯\r\n* Infimum + Supremumï¼šå½“å‰é¡µçš„æœ€å°è®°å½•å’Œæœ€å¤§è®°å½•ï¼ˆå¤´å°¾æŒ‡é’ˆï¼‰ï¼ŒInfimum æ‰€åœ¨åˆ†ç»„åªæœ‰ä¸€æ¡è®°å½•ï¼ŒSupremum æ‰€åœ¨åˆ†ç»„å¯ä»¥æœ‰ 1 ~ 8 æ¡è®°å½•ï¼Œå‰©ä½™çš„åˆ†ç»„å¯ä»¥æœ‰ 4 ~ 8 æ¡è®°å½•\r\n* User Recordsï¼šå­˜å‚¨æ•°æ®çš„è®°å½•\r\n* Free Spaceï¼šå°šæœªä½¿ç”¨çš„å­˜å‚¨ç©ºé—´\r\n* Page Directoryï¼šåˆ†ç»„çš„ç›®å½•ï¼Œå¯ä»¥é€šè¿‡ç›®å½•å¿«é€Ÿå®šä½ï¼ˆäºŒåˆ†æ³•ï¼‰æ•°æ®çš„åˆ†ç»„\r\n* File Trailerï¼šæ£€éªŒå’Œå­—æ®µï¼Œåœ¨åˆ·è„è¿‡ç¨‹ä¸­ï¼Œé¡µé¦–å’Œé¡µå°¾çš„æ ¡éªŒå’Œä¸€è‡´æ‰èƒ½è¯´æ˜é¡µé¢åˆ·æ–°æˆåŠŸï¼ŒäºŒè€…ä¸åŒè¯´æ˜åˆ·æ–°æœŸé—´å‘ç”Ÿäº†é”™è¯¯ï¼›LSN å­—æ®µï¼Œä¹Ÿæ˜¯ç”¨æ¥æ ¡éªŒé¡µé¢çš„å®Œæ•´æ€§\r\n\r\næ•°æ®é¡µä¸­åŒ…å«æ•°æ®è¡Œï¼Œæ•°æ®çš„å­˜å‚¨æ˜¯åŸºäºæ•°æ®è¡Œçš„ï¼Œæ•°æ®è¡Œæœ‰ next_record å±æ€§æŒ‡å‘ä¸‹ä¸€ä¸ªè¡Œæ•°æ®ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥éå†çš„ï¼Œä½†æ˜¯ä¸€ç»„æ•°æ®è‡³å¤š 8 ä¸ªè¡Œï¼Œé€šè¿‡ Page Directory å…ˆå®šä½åˆ°ç»„ï¼Œç„¶åéå†è·å–æ‰€éœ€çš„æ•°æ®è¡Œå³å¯\r\n\r\næ•°æ®è¡Œä¸­æœ‰ä¸‰ä¸ªéšè—å­—æ®µï¼štrx_idã€roll_pointerã€row_idï¼ˆåœ¨äº‹åŠ¡ç« èŠ‚ä¼šè¯¦ç»†ä»‹ç»å®ƒä»¬çš„ä½œç”¨ï¼‰\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### BTree\r\n\r\nBTree çš„ç´¢å¼•ç±»å‹æ˜¯åŸºäº B+Tree æ ‘å‹æ•°æ®ç»“æ„çš„ï¼ŒB+Tree åˆæ˜¯ BTree æ•°æ®ç»“æ„çš„å˜ç§ï¼Œç”¨åœ¨æ•°æ®åº“å’Œæ“ä½œç³»ç»Ÿä¸­çš„æ–‡ä»¶ç³»ç»Ÿï¼Œç‰¹ç‚¹æ˜¯èƒ½å¤Ÿä¿æŒæ•°æ®ç¨³å®šæœ‰åº\r\n\r\nBTree åˆå«å¤šè·¯å¹³è¡¡æœç´¢æ ‘ï¼Œä¸€é¢— m å‰çš„ BTree ç‰¹æ€§å¦‚ä¸‹ï¼š\r\n\r\n- æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šåŒ…å« m ä¸ªå­©å­\r\n- é™¤æ ¹èŠ‚ç‚¹ä¸å¶å­èŠ‚ç‚¹å¤–ï¼Œæ¯ä¸ªèŠ‚ç‚¹è‡³å°‘æœ‰ [ceil(m/2)] ä¸ªå­©å­\r\n- è‹¥æ ¹èŠ‚ç‚¹ä¸æ˜¯å¶å­èŠ‚ç‚¹ï¼Œåˆ™è‡³å°‘æœ‰ä¸¤ä¸ªå­©å­\r\n- æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹éƒ½åœ¨åŒä¸€å±‚\r\n- æ¯ä¸ªéå¶å­èŠ‚ç‚¹ç”± n ä¸ª key ä¸ n+1 ä¸ªæŒ‡é’ˆç»„æˆï¼Œå…¶ä¸­ [ceil(m/2)-1] <= n <= m-1 \r\n\r\n5 å‰ï¼Œkey çš„æ•°é‡ [ceil(m/2)-1] <= n <= m-1 ä¸º 2 <= n <=4 ï¼Œå½“ n>4 æ—¶ä¸­é—´èŠ‚ç‚¹åˆ†è£‚åˆ°çˆ¶èŠ‚ç‚¹ï¼Œä¸¤è¾¹èŠ‚ç‚¹åˆ†è£‚\r\n\r\næ’å…¥ C N G A H E K Q M F W L T Z D P R X Y S æ•°æ®çš„å·¥ä½œæµç¨‹ï¼š\r\n\r\n* æ’å…¥å‰ 4 ä¸ªå­—æ¯ C N G A \r\n\r\n  ![image-20250319235644264](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235644264.png)\r\n\r\n* æ’å…¥ Hï¼Œn>4ï¼Œä¸­é—´å…ƒç´  G å­—æ¯å‘ä¸Šåˆ†è£‚åˆ°æ–°çš„èŠ‚ç‚¹\r\n\r\n  ![image-20250319235655244](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235655244.png)\r\n\r\n* æ’å…¥ Eã€Kã€Q ä¸éœ€è¦åˆ†è£‚\r\n\r\n  ![image-20250319235706367](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235706367.png)\r\n\r\n* æ’å…¥ Mï¼Œä¸­é—´å…ƒç´  M å­—æ¯å‘ä¸Šåˆ†è£‚åˆ°çˆ¶èŠ‚ç‚¹ G\r\n\r\n  ![image-20250319235720993](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235720993.png)\r\n\r\n* æ’å…¥ Fï¼ŒWï¼ŒLï¼ŒT ä¸éœ€è¦åˆ†è£‚\r\n\r\n  ![image-20250319235733907](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235733907.png)\r\n\r\n* æ’å…¥ Zï¼Œä¸­é—´å…ƒç´  T å‘ä¸Šåˆ†è£‚åˆ°çˆ¶èŠ‚ç‚¹ä¸­\r\n\r\n  ![image-20250319235755652](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235755652.png)\r\n\r\n* æ’å…¥ Dï¼Œä¸­é—´å…ƒç´  D å‘ä¸Šåˆ†è£‚åˆ°çˆ¶èŠ‚ç‚¹ä¸­ï¼Œç„¶åæ’å…¥ Pï¼ŒRï¼ŒXï¼ŒY ä¸éœ€è¦åˆ†è£‚\r\n\r\n  ![image-20250319235823260](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235823260.png)\r\n\r\n* æœ€åæ’å…¥ Sï¼ŒNPQR èŠ‚ç‚¹ n>5ï¼Œä¸­é—´èŠ‚ç‚¹ Q å‘ä¸Šåˆ†è£‚ï¼Œä½†åˆ†è£‚åçˆ¶èŠ‚ç‚¹ DGMT çš„ n>5ï¼Œä¸­é—´èŠ‚ç‚¹ M å‘ä¸Šåˆ†è£‚\r\n\r\n  ![image-20250319235841987](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235841987.png)\r\n\r\nBTree æ ‘å°±å·²ç»æ„å»ºå®Œæˆäº†ï¼ŒBTree æ ‘å’ŒäºŒå‰æ ‘ç›¸æ¯”ï¼Œ æŸ¥è¯¢æ•°æ®çš„æ•ˆç‡æ›´é«˜ï¼Œ å› ä¸ºå¯¹äºç›¸åŒçš„æ•°æ®é‡æ¥è¯´ï¼Œ**BTree çš„å±‚çº§ç»“æ„æ¯”äºŒå‰æ ‘å°‘**ï¼Œæ‰€ä»¥æœç´¢é€Ÿåº¦å¿«\r\n\r\nBTree ç»“æ„çš„æ•°æ®å¯ä»¥è®©ç³»ç»Ÿé«˜æ•ˆçš„æ‰¾åˆ°æ•°æ®æ‰€åœ¨çš„ç£ç›˜å—ï¼Œå®šä¹‰ä¸€æ¡è®°å½•ä¸ºä¸€ä¸ªäºŒå…ƒç»„ [key, data] ï¼Œkey ä¸ºè®°å½•çš„é”®å€¼ï¼Œå¯¹åº”è¡¨ä¸­çš„ä¸»é”®å€¼ï¼Œdata ä¸ºä¸€è¡Œè®°å½•ä¸­é™¤ä¸»é”®å¤–çš„æ•°æ®ã€‚å¯¹äºä¸åŒçš„è®°å½•ï¼Œkey å€¼äº’ä¸ç›¸åŒï¼ŒBTree ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ ¹æ®å®é™…æƒ…å†µå¯ä»¥åŒ…å«å¤§é‡çš„å…³é”®å­—ä¿¡æ¯å’Œåˆ†æ”¯\r\n![image-20250319235910313](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235910313.png)\r\n\r\nç¼ºç‚¹ï¼šå½“è¿›è¡ŒèŒƒå›´æŸ¥æ‰¾æ—¶ä¼šå‡ºç°å›æ—‹æŸ¥æ‰¾\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### B+Tree\r\n\r\n##### æ•°æ®ç»“æ„\r\n\r\nBTree æ•°æ®ç»“æ„ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¸­ä¸ä»…åŒ…å«æ•°æ®çš„ key å€¼ï¼Œè¿˜æœ‰ data å€¼ã€‚ç£ç›˜ä¸­æ¯ä¸€é¡µçš„å­˜å‚¨ç©ºé—´æ˜¯æœ‰é™çš„ï¼Œå¦‚æœ data æ•°æ®è¾ƒå¤§æ—¶å°†ä¼šå¯¼è‡´æ¯ä¸ªèŠ‚ç‚¹ï¼ˆå³ä¸€ä¸ªé¡µï¼‰èƒ½å­˜å‚¨çš„ key çš„æ•°é‡å¾ˆå°ï¼Œå½“å­˜å‚¨çš„æ•°æ®é‡å¾ˆå¤§æ—¶åŒæ ·ä¼šå¯¼è‡´ B-Tree çš„æ·±åº¦è¾ƒå¤§ï¼Œå¢å¤§æŸ¥è¯¢æ—¶çš„ç£ç›˜ I/O æ¬¡æ•°ï¼Œè¿›è€Œå½±å“æŸ¥è¯¢æ•ˆç‡ï¼Œæ‰€ä»¥å¼•å…¥ B+Tree\r\n\r\nB+Tree ä¸º BTree çš„å˜ç§ï¼ŒB+Tree ä¸ BTree çš„åŒºåˆ«ä¸ºï¼š\r\n\r\n* n å‰ B+Tree æœ€å¤šå«æœ‰ n ä¸ª keyï¼ˆå“ˆå¸Œå€¼ï¼‰ï¼Œè€Œ BTree æœ€å¤šå«æœ‰ n-1 ä¸ª key\r\n\r\n- æ‰€æœ‰**éå¶å­èŠ‚ç‚¹åªå­˜å‚¨é”®å€¼ key** ä¿¡æ¯ï¼Œåªè¿›è¡Œæ•°æ®ç´¢å¼•ï¼Œä½¿æ¯ä¸ªéå¶å­èŠ‚ç‚¹æ‰€èƒ½ä¿å­˜çš„å…³é”®å­—å¤§å¤§å¢åŠ \r\n- æ‰€æœ‰**æ•°æ®éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹**ï¼Œæ‰€ä»¥æ¯æ¬¡æ•°æ®æŸ¥è¯¢çš„æ¬¡æ•°éƒ½ä¸€æ ·\r\n- **å¶å­èŠ‚ç‚¹æŒ‰ç…§ key å¤§å°é¡ºåºæ’åˆ—ï¼Œå·¦è¾¹ç»“å°¾æ•°æ®éƒ½ä¼šä¿å­˜å³è¾¹èŠ‚ç‚¹å¼€å§‹æ•°æ®çš„æŒ‡é’ˆï¼Œå½¢æˆä¸€ä¸ªé“¾è¡¨**\r\n- æ‰€æœ‰èŠ‚ç‚¹ä¸­çš„ key åœ¨å¶å­èŠ‚ç‚¹ä¸­ä¹Ÿå­˜åœ¨ï¼ˆæ¯”å¦‚ 5)ï¼Œ**key å…è®¸é‡å¤**ï¼ŒB æ ‘ä¸åŒèŠ‚ç‚¹ä¸å­˜åœ¨é‡å¤çš„ key\r\n\r\n![image-20250319235924557](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250319235924557.png)\r\n\r\nB* æ ‘ï¼šæ˜¯ B+ æ ‘çš„å˜ä½“ï¼Œåœ¨ B+ æ ‘çš„éæ ¹å’Œéå¶å­ç»“ç‚¹å†å¢åŠ æŒ‡å‘å…„å¼Ÿçš„æŒ‡é’ˆ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ä¼˜åŒ–ç»“æ„\r\n\r\nMySQL ç´¢å¼•æ•°æ®ç»“æ„å¯¹ç»å…¸çš„ B+Tree è¿›è¡Œäº†ä¼˜åŒ–ï¼Œåœ¨åŸ B+Tree çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ªæŒ‡å‘ç›¸é‚»å¶å­èŠ‚ç‚¹çš„é“¾è¡¨æŒ‡é’ˆï¼Œå°±å½¢æˆäº†å¸¦æœ‰é¡ºåºæŒ‡é’ˆçš„ B+Treeï¼Œ**æé«˜åŒºé—´è®¿é—®çš„æ€§èƒ½ï¼Œé˜²æ­¢å›æ—‹æŸ¥æ‰¾**\r\n\r\nåŒºé—´è®¿é—®çš„æ„æ€æ˜¯è®¿é—®ç´¢å¼•ä¸º 5 - 15 çš„æ•°æ®ï¼Œå¯ä»¥ç›´æ¥æ ¹æ®ç›¸é‚»èŠ‚ç‚¹çš„æŒ‡é’ˆéå†\r\n\r\nB+ æ ‘çš„**å¶å­èŠ‚ç‚¹æ˜¯æ•°æ®é¡µ**ï¼ˆpageï¼‰ï¼Œä¸€ä¸ªé¡µé‡Œé¢å¯ä»¥å­˜å¤šä¸ªæ•°æ®è¡Œ\r\n\r\n![image-20250320000006683](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320000006683.png)\r\n\r\né€šå¸¸åœ¨ B+Tree ä¸Šæœ‰ä¸¤ä¸ªå¤´æŒ‡é’ˆï¼Œ**ä¸€ä¸ªæŒ‡å‘æ ¹èŠ‚ç‚¹ï¼Œå¦ä¸€ä¸ªæŒ‡å‘å…³é”®å­—æœ€å°çš„å¶å­èŠ‚ç‚¹**ï¼Œè€Œä¸”æ‰€æœ‰å¶å­èŠ‚ç‚¹ï¼ˆå³æ•°æ®èŠ‚ç‚¹ï¼‰ä¹‹é—´æ˜¯ä¸€ç§é“¾å¼ç¯ç»“æ„ã€‚å¯ä»¥å¯¹ B+Tree è¿›è¡Œä¸¤ç§æŸ¥æ‰¾è¿ç®—ï¼š\r\n\r\n- æœ‰èŒƒå›´ï¼šå¯¹äºä¸»é”®çš„èŒƒå›´æŸ¥æ‰¾å’Œåˆ†é¡µæŸ¥æ‰¾\r\n- æœ‰é¡ºåºï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œè¿›è¡ŒéšæœºæŸ¥æ‰¾ï¼Œé¡ºåºæŸ¥æ‰¾\r\n\r\nInnoDB ä¸­æ¯ä¸ªæ•°æ®é¡µçš„å¤§å°é»˜è®¤æ˜¯ 16KB\r\n\r\n* ç´¢å¼•è¡Œï¼šä¸€èˆ¬è¡¨çš„ä¸»é”®ç±»å‹ä¸º INTï¼ˆ4 å­—èŠ‚ï¼‰æˆ– BIGINTï¼ˆ8 å­—èŠ‚ï¼‰ï¼ŒæŒ‡é’ˆå¤§å°åœ¨ InnoDB ä¸­è®¾ç½®ä¸º 6 å­—èŠ‚èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªé¡µå¤§æ¦‚å­˜å‚¨ 16KB/(8B+6B)=1K ä¸ªé”®å€¼ï¼ˆä¼°å€¼ï¼‰ã€‚åˆ™ä¸€ä¸ªæ·±åº¦ä¸º 3 çš„ B+Tree ç´¢å¼•å¯ä»¥ç»´æŠ¤ `10^3 * 10^3 * 10^3 = 10äº¿` æ¡è®°å½•\r\n* æ•°æ®è¡Œï¼šä¸€è¡Œæ•°æ®çš„å¤§å°å¯èƒ½æ˜¯ 1kï¼Œä¸€ä¸ªæ•°æ®é¡µå¯ä»¥å­˜å‚¨ 16 è¡Œ\r\n\r\nå®é™…æƒ…å†µä¸­æ¯ä¸ªèŠ‚ç‚¹å¯èƒ½ä¸èƒ½å¡«å……æ»¡ï¼Œå› æ­¤åœ¨æ•°æ®åº“ä¸­ï¼ŒB+Tree çš„é«˜åº¦ä¸€èˆ¬éƒ½åœ¨ 2-4 å±‚ã€‚MySQL çš„ InnoDB å­˜å‚¨å¼•æ“åœ¨è®¾è®¡æ—¶æ˜¯**å°†æ ¹èŠ‚ç‚¹å¸¸é©»å†…å­˜çš„**ï¼Œä¹Ÿå°±æ˜¯è¯´æŸ¥æ‰¾æŸä¸€é”®å€¼çš„è¡Œè®°å½•æ—¶æœ€å¤šåªéœ€è¦ 1~3 æ¬¡ç£ç›˜ I/O æ“ä½œ\r\n\r\nB+Tree ä¼˜ç‚¹ï¼šæé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œå‡å°‘ç£ç›˜çš„ IO æ¬¡æ•°ï¼Œæ ‘å½¢ç»“æ„è¾ƒå°\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ç´¢å¼•ç»´æŠ¤\r\n\r\nB+ æ ‘ä¸ºäº†ä¿æŒç´¢å¼•çš„æœ‰åºæ€§ï¼Œåœ¨æ’å…¥æ–°å€¼çš„æ—¶å€™éœ€è¦åšç›¸åº”çš„ç»´æŠ¤\r\n\r\næ¯ä¸ªç´¢å¼•ä¸­æ¯ä¸ªå—å­˜å‚¨åœ¨ç£ç›˜é¡µä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š\r\n\r\n* å¦‚æœæ‰€åœ¨çš„æ•°æ®é¡µå·²ç»æ»¡äº†ï¼Œè¿™æ—¶å€™éœ€è¦ç”³è¯·ä¸€ä¸ªæ–°çš„æ•°æ®é¡µï¼Œç„¶åæŒªåŠ¨éƒ¨åˆ†æ•°æ®è¿‡å»ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º**é¡µåˆ†è£‚**ï¼ŒåŸæœ¬æ”¾åœ¨ä¸€ä¸ªé¡µçš„æ•°æ®ç°åœ¨åˆ†åˆ°ä¸¤ä¸ªé¡µä¸­ï¼Œé™ä½äº†ç©ºé—´åˆ©ç”¨ç‡\r\n* å½“ç›¸é‚»ä¸¤ä¸ªé¡µç”±äºåˆ é™¤äº†æ•°æ®ï¼Œåˆ©ç”¨ç‡å¾ˆä½ä¹‹åï¼Œä¼šå°†æ•°æ®é¡µåš**é¡µåˆå¹¶**ï¼Œåˆå¹¶çš„è¿‡ç¨‹å¯ä»¥è®¤ä¸ºæ˜¯åˆ†è£‚è¿‡ç¨‹çš„é€†è¿‡ç¨‹\r\n* è¿™ä¸¤ä¸ªæƒ…å†µéƒ½æ˜¯ç”± B+ æ ‘çš„ç»“æ„å†³å®šçš„\r\n\r\nä¸€èˆ¬é€‰ç”¨æ•°æ®å°çš„å­—æ®µåšç´¢å¼•ï¼Œå­—æ®µé•¿åº¦è¶Šå°ï¼Œæ™®é€šç´¢å¼•çš„å¶å­èŠ‚ç‚¹å°±è¶Šå°ï¼Œæ™®é€šç´¢å¼•å ç”¨çš„ç©ºé—´ä¹Ÿå°±è¶Šå°\r\n\r\nè‡ªå¢ä¸»é”®çš„æ’å…¥æ•°æ®æ¨¡å¼ï¼Œå¯ä»¥è®©ä¸»é”®ç´¢å¼•å°½é‡åœ°ä¿æŒé€’å¢é¡ºåºæ’å…¥ï¼Œä¸æ¶‰åŠåˆ°æŒªåŠ¨å…¶ä»–è®°å½•ï¼Œ**é¿å…äº†é¡µåˆ†è£‚**ï¼Œé¡µåˆ†è£‚çš„ç›®çš„å°±æ˜¯ä¿è¯åä¸€ä¸ªæ•°æ®é¡µä¸­çš„æ‰€æœ‰è¡Œä¸»é”®å€¼æ¯”å‰ä¸€ä¸ªæ•°æ®é¡µä¸­ä¸»é”®å€¼å¤§\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://developer.aliyun.com/article/919861\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### è®¾è®¡åŸåˆ™\r\n\r\nç´¢å¼•çš„è®¾è®¡å¯ä»¥éµå¾ªä¸€äº›å·²æœ‰çš„åŸåˆ™ï¼Œåˆ›å»ºç´¢å¼•çš„æ—¶å€™è¯·å°½é‡è€ƒè™‘ç¬¦åˆè¿™äº›åŸåˆ™ï¼Œä¾¿äºæå‡ç´¢å¼•çš„ä½¿ç”¨æ•ˆç‡\r\n\r\nåˆ›å»ºç´¢å¼•æ—¶çš„åŸåˆ™ï¼š\r\n\r\n- å¯¹æŸ¥è¯¢é¢‘æ¬¡è¾ƒé«˜ï¼Œä¸”æ•°æ®é‡æ¯”è¾ƒå¤§çš„è¡¨å»ºç«‹ç´¢å¼•\r\n- ä½¿ç”¨å”¯ä¸€ç´¢å¼•ï¼ŒåŒºåˆ†åº¦è¶Šé«˜ï¼Œä½¿ç”¨ç´¢å¼•çš„æ•ˆç‡è¶Šé«˜\r\n- ç´¢å¼•å­—æ®µçš„é€‰æ‹©ï¼Œæœ€ä½³å€™é€‰åˆ—åº”å½“ä» where å­å¥çš„æ¡ä»¶ä¸­æå–ï¼Œä½¿ç”¨è¦†ç›–ç´¢å¼•\r\n- ä½¿ç”¨çŸ­ç´¢å¼•ï¼Œç´¢å¼•åˆ›å»ºä¹‹åä¹Ÿæ˜¯ä½¿ç”¨ç¡¬ç›˜æ¥å­˜å‚¨çš„ï¼Œå› æ­¤æå‡ç´¢å¼•è®¿é—®çš„ I/O æ•ˆç‡ï¼Œä¹Ÿå¯ä»¥æå‡æ€»ä½“çš„è®¿é—®æ•ˆç‡ã€‚å‡å¦‚æ„æˆç´¢å¼•çš„å­—æ®µæ€»é•¿åº¦æ¯”è¾ƒçŸ­ï¼Œé‚£ä¹ˆåœ¨ç»™å®šå¤§å°çš„å­˜å‚¨å—å†…å¯ä»¥å­˜å‚¨æ›´å¤šçš„ç´¢å¼•å€¼ï¼Œç›¸åº”çš„å¯ä»¥æœ‰æ•ˆçš„æå‡ MySQL è®¿é—®ç´¢å¼•çš„ I/O æ•ˆç‡\r\n- ç´¢å¼•å¯ä»¥æœ‰æ•ˆçš„æå‡æŸ¥è¯¢æ•°æ®çš„æ•ˆç‡ï¼Œä½†ç´¢å¼•æ•°é‡ä¸æ˜¯å¤šå¤šç›Šå–„ï¼Œç´¢å¼•è¶Šå¤šï¼Œç»´æŠ¤ç´¢å¼•çš„ä»£ä»·è¶Šé«˜ã€‚å¯¹äºæ’å…¥ã€æ›´æ–°ã€åˆ é™¤ç­‰ DML æ“ä½œæ¯”è¾ƒé¢‘ç¹çš„è¡¨æ¥è¯´ï¼Œç´¢å¼•è¿‡å¤šï¼Œä¼šå¼•å…¥ç›¸å½“é«˜çš„ç»´æŠ¤ä»£ä»·ï¼Œé™ä½ DML æ“ä½œçš„æ•ˆç‡ï¼Œå¢åŠ ç›¸åº”æ“ä½œçš„æ—¶é—´æ¶ˆè€—ï¼›å¦å¤–ç´¢å¼•è¿‡å¤šçš„è¯ï¼ŒMySQL ä¹Ÿä¼šçŠ¯é€‰æ‹©å›°éš¾ç—…ï¼Œè™½ç„¶æœ€ç»ˆä»ç„¶ä¼šæ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ç´¢å¼•ï¼Œä½†æé«˜äº†é€‰æ‹©çš„ä»£ä»·\r\n\r\n* MySQL å»ºç«‹è”åˆç´¢å¼•æ—¶ä¼šéµå®ˆ**æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™**ï¼Œå³æœ€å·¦ä¼˜å…ˆï¼Œåœ¨æ£€ç´¢æ•°æ®æ—¶ä»è”åˆç´¢å¼•çš„æœ€å·¦è¾¹å¼€å§‹åŒ¹é…\r\n\r\n  N ä¸ªåˆ—ç»„åˆè€Œæˆçš„ç»„åˆç´¢å¼•ï¼Œç›¸å½“äºåˆ›å»ºäº† N ä¸ªç´¢å¼•ï¼Œå¦‚æœæŸ¥è¯¢æ—¶ where å¥ä¸­ä½¿ç”¨äº†ç»„æˆè¯¥ç´¢å¼•çš„**å‰**å‡ ä¸ªå­—æ®µï¼Œé‚£ä¹ˆè¿™æ¡æŸ¥è¯¢ SQL å¯ä»¥åˆ©ç”¨ç»„åˆç´¢å¼•æ¥æå‡æŸ¥è¯¢æ•ˆç‡\r\n\r\n  ```sql\r\n  -- å¯¹nameã€addressã€phoneåˆ—å»ºä¸€ä¸ªè”åˆç´¢å¼•\r\n  ALTER TABLE user ADD INDEX index_three(name,address,phone);\r\n  -- æŸ¥è¯¢è¯­å¥æ‰§è¡Œæ—¶ä¼šä¾ç…§æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™ï¼Œæ£€ç´¢æ—¶åˆ†åˆ«ä¼šä½¿ç”¨ç´¢å¼•è¿›è¡Œæ•°æ®åŒ¹é…ã€‚\r\n  (name,address,phone)\r\n  (name,address)\r\n  (name,phone)\t-- åªæœ‰nameå­—æ®µèµ°äº†ç´¢å¼•\r\n  (name)\r\n  \r\n  -- ç´¢å¼•çš„å­—æ®µå¯ä»¥æ˜¯ä»»æ„é¡ºåºçš„ï¼Œä¼˜åŒ–å™¨ä¼šå¸®åŠ©æˆ‘ä»¬è°ƒæ•´é¡ºåºï¼Œä¸‹é¢çš„SQLè¯­å¥å¯ä»¥å‘½ä¸­ç´¢å¼•\r\n  SELECT * FROM user WHERE address = 'åŒ—äº¬' AND phone = '12345' AND name = 'å¼ ä¸‰';\r\n  ```\r\n\r\n  ```sql\r\n  -- å¦‚æœè”åˆç´¢å¼•ä¸­æœ€å·¦è¾¹çš„åˆ—ä¸åŒ…å«åœ¨æ¡ä»¶æŸ¥è¯¢ä¸­ï¼ŒSQLè¯­å¥å°±ä¸ä¼šå‘½ä¸­ç´¢å¼•ï¼Œæ¯”å¦‚ï¼š\r\n  SELECT * FROM user WHERE address = 'åŒ—äº¬' AND phone = '12345'; \r\n  ```\r\n\r\nå“ªäº›æƒ…å†µä¸è¦å»ºç«‹ç´¢å¼•ï¼š\r\n\r\n* è®°å½•å¤ªå°‘çš„è¡¨\r\n* ç»å¸¸å¢åˆ æ”¹çš„è¡¨\r\n* é¢‘ç¹æ›´æ–°çš„å­—æ®µä¸é€‚åˆåˆ›å»ºç´¢å¼•\r\n* where æ¡ä»¶é‡Œç”¨ä¸åˆ°çš„å­—æ®µä¸åˆ›å»ºç´¢å¼•\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ç´¢å¼•ä¼˜åŒ–\r\n\r\n#### è¦†ç›–ç´¢å¼•\r\n\r\nè¦†ç›–ç´¢å¼•ï¼šåŒ…å«æ‰€æœ‰æ»¡è¶³æŸ¥è¯¢éœ€è¦çš„æ•°æ®çš„ç´¢å¼•ï¼ˆSELECT åé¢çš„å­—æ®µåˆšå¥½æ˜¯ç´¢å¼•å­—æ®µï¼‰ï¼Œå¯ä»¥åˆ©ç”¨è¯¥ç´¢å¼•è¿”å› SELECT åˆ—è¡¨çš„å­—æ®µï¼Œè€Œä¸å¿…æ ¹æ®ç´¢å¼•å»èšç°‡ç´¢å¼•ä¸Šè¯»å–æ•°æ®æ–‡ä»¶\r\n\r\nå›è¡¨æŸ¥è¯¢ï¼šè¦æŸ¥æ‰¾çš„å­—æ®µä¸åœ¨éä¸»é”®ç´¢å¼•æ ‘ä¸Šæ—¶ï¼Œéœ€è¦é€šè¿‡å¶å­èŠ‚ç‚¹çš„ä¸»é”®å€¼å»ä¸»é”®ç´¢å¼•ä¸Šè·å–å¯¹åº”çš„è¡Œæ•°æ®\r\n\r\nä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œé˜²æ­¢å›è¡¨æŸ¥è¯¢ï¼š\r\n\r\n* è¡¨ user ä¸»é”®ä¸º idï¼Œæ™®é€šç´¢å¼•ä¸º ageï¼ŒæŸ¥è¯¢è¯­å¥ï¼š\r\n\r\n  ```sql\r\n  SELECT * FROM user WHERE age = 30;\r\n  ```\r\n\r\n  æŸ¥è¯¢è¿‡ç¨‹ï¼šå…ˆé€šè¿‡æ™®é€šç´¢å¼• age=30 å®šä½åˆ°ä¸»é”®å€¼ id=1ï¼Œå†é€šè¿‡èšé›†ç´¢å¼• id=1 å®šä½åˆ°è¡Œè®°å½•æ•°æ®ï¼Œéœ€è¦ä¸¤æ¬¡æ‰«æ B+ æ ‘\r\n\r\n* ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼š\r\n\r\n  ```sql\r\n  DROP INDEX idx_age ON user;\r\n  CREATE INDEX idx_age_name ON user(age,name);\r\n  SELECT id,age FROM user WHERE age = 30;\r\n  ```\r\n\r\n  åœ¨ä¸€æ£µç´¢å¼•æ ‘ä¸Šå°±èƒ½è·å–æŸ¥è¯¢æ‰€éœ€çš„æ•°æ®ï¼Œæ— éœ€å›è¡¨é€Ÿåº¦æ›´å¿«\r\n\r\nä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œè¦æ³¨æ„ SELECT åˆ—è¡¨ä¸­åªå–å‡ºéœ€è¦çš„åˆ—ï¼Œä¸å¯ç”¨ SELECT *ï¼Œæ‰€æœ‰å­—æ®µä¸€èµ·åšç´¢å¼•ä¼šå¯¼è‡´ç´¢å¼•æ–‡ä»¶è¿‡å¤§ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¸‹é™\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ç´¢å¼•ä¸‹æ¨\r\n\r\nç´¢å¼•æ¡ä»¶ä¸‹æ¨ä¼˜åŒ–ï¼ˆIndex Condition Pushdownï¼ŒICPï¼‰æ˜¯ MySQL5.6 æ·»åŠ ï¼Œå¯ä»¥åœ¨ç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°\r\n\r\nç´¢å¼•ä¸‹æ¨å……åˆ†åˆ©ç”¨äº†ç´¢å¼•ä¸­çš„æ•°æ®ï¼Œåœ¨æŸ¥è¯¢å‡ºæ•´è¡Œæ•°æ®ä¹‹å‰è¿‡æ»¤æ‰æ— æ•ˆçš„æ•°æ®ï¼Œå†å»ä¸»é”®ç´¢å¼•æ ‘ä¸ŠæŸ¥æ‰¾\r\n\r\n* ä¸ä½¿ç”¨ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–æ—¶å­˜å‚¨å¼•æ“é€šè¿‡ç´¢å¼•æ£€ç´¢åˆ°æ•°æ®ï¼Œç„¶åå›è¡¨æŸ¥è¯¢è®°å½•è¿”å›ç»™ Server å±‚ï¼Œ**æœåŠ¡å™¨åˆ¤æ–­æ•°æ®æ˜¯å¦ç¬¦åˆæ¡ä»¶**\r\n\r\n  ![image-20250320000053752](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320000053752.png)\r\n\r\n* ä½¿ç”¨ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–æ—¶ï¼Œå¦‚æœ**å­˜åœ¨æŸäº›è¢«ç´¢å¼•çš„åˆ—çš„åˆ¤æ–­æ¡ä»¶**æ—¶ï¼Œç”±å­˜å‚¨å¼•æ“åœ¨ç´¢å¼•éå†çš„è¿‡ç¨‹ä¸­åˆ¤æ–­æ•°æ®æ˜¯å¦ç¬¦åˆä¼ é€’çš„æ¡ä»¶ï¼Œå°†ç¬¦åˆæ¡ä»¶çš„æ•°æ®è¿›è¡Œå›è¡¨ï¼Œæ£€ç´¢å‡ºæ¥è¿”å›ç»™æœåŠ¡å™¨ï¼Œç”±æ­¤å‡å°‘ IO æ¬¡æ•°\r\n\r\n  ![image-20250320000124468](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320000124468.png)\r\n\r\n**é€‚ç”¨æ¡ä»¶**ï¼š\r\n\r\n* éœ€è¦å­˜å‚¨å¼•æ“å°†ç´¢å¼•ä¸­çš„æ•°æ®ä¸æ¡ä»¶è¿›è¡Œåˆ¤æ–­ï¼ˆæ‰€ä»¥**æ¡ä»¶åˆ—å¿…é¡»éƒ½åœ¨åŒä¸€ä¸ªç´¢å¼•ä¸­**ï¼‰ï¼Œæ‰€ä»¥ä¼˜åŒ–æ˜¯åŸºäºå­˜å‚¨å¼•æ“çš„ï¼Œåªæœ‰ç‰¹å®šå¼•æ“å¯ä»¥ä½¿ç”¨ï¼Œé€‚ç”¨äº InnoDB å’Œ MyISAM\r\n* å­˜å‚¨å¼•æ“æ²¡æœ‰è°ƒç”¨è·¨å­˜å‚¨å¼•æ“çš„èƒ½åŠ›ï¼Œè·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½æœ‰å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ï¼Œæ‰€ä»¥è°ƒç”¨è¿™äº›åŠŸèƒ½çš„ä¸å¯ä»¥è¿›è¡Œç´¢å¼•ä¸‹æ¨ä¼˜åŒ–\r\n* å¯¹äº InnoDB å¼•æ“åªé€‚ç”¨äºäºŒçº§ç´¢å¼•ï¼ŒInnoDB çš„èšç°‡ç´¢å¼•ä¼šå°†æ•´è¡Œæ•°æ®è¯»åˆ°ç¼“å†²åŒºï¼Œä¸å†éœ€è¦å»å›è¡¨æŸ¥è¯¢äº†\r\n\r\nå·¥ä½œè¿‡ç¨‹ï¼šç”¨æˆ·è¡¨ userï¼Œ(name, age) æ˜¯è”åˆç´¢å¼•\r\n\r\n```sql\r\nSELECT * FROM user WHERE name LIKE 'å¼ %' ANDã€€age = 10;\t-- å¤´éƒ¨æ¨¡ç³ŠåŒ¹é…ä¼šé€ æˆç´¢å¼•å¤±æ•ˆ\r\n```\r\n\r\n* ä¼˜åŒ–å‰ï¼šåœ¨éä¸»é”®ç´¢å¼•æ ‘ä¸Šæ‰¾åˆ°æ»¡è¶³ç¬¬ä¸€ä¸ªæ¡ä»¶çš„è¡Œï¼Œç„¶åé€šè¿‡å¶å­èŠ‚ç‚¹è®°å½•çš„ä¸»é”®å€¼å†å›åˆ°ä¸»é”®ç´¢å¼•æ ‘ä¸ŠæŸ¥æ‰¾åˆ°å¯¹åº”çš„è¡Œæ•°æ®ï¼Œå†å¯¹æ¯” AND åçš„æ¡ä»¶æ˜¯å¦ç¬¦åˆï¼Œç¬¦åˆè¿”å›æ•°æ®ï¼Œéœ€è¦ 4 æ¬¡å›è¡¨\r\n\r\n  ![image-20250320000152904](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320000152904.png)\r\n\r\n* ä¼˜åŒ–åï¼šæ£€æŸ¥ç´¢å¼•ä¸­å­˜å‚¨çš„åˆ—ä¿¡æ¯æ˜¯å¦ç¬¦åˆç´¢å¼•æ¡ä»¶ï¼Œç„¶åäº¤ç”±å­˜å‚¨å¼•æ“ç”¨å‰©ä½™çš„åˆ¤æ–­æ¡ä»¶åˆ¤æ–­æ­¤è¡Œæ•°æ®æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œ**ä¸æ»¡è¶³æ¡ä»¶çš„ä¸å»è¯»å–è¡¨ä¸­çš„æ•°æ®**ï¼Œæ»¡è¶³ä¸‹æ¨æ¡ä»¶çš„å°±æ ¹æ®ä¸»é”®å€¼è¿›è¡Œå›è¡¨æŸ¥è¯¢ï¼Œ2 æ¬¡å›è¡¨\r\n  ![image-20250320000204151](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320000204151.png)\r\n\r\nå½“ä½¿ç”¨ EXPLAIN è¿›è¡Œåˆ†ææ—¶ï¼Œå¦‚æœä½¿ç”¨äº†ç´¢å¼•æ¡ä»¶ä¸‹æ¨ï¼ŒExtra ä¼šæ˜¾ç¤º Using index condition\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/sinat_29774479/article/details/103470244\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/69636\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å‰ç¼€ç´¢å¼•\r\n\r\nå½“è¦ç´¢å¼•çš„åˆ—å­—ç¬¦å¾ˆå¤šæ—¶ï¼Œç´¢å¼•ä¼šå˜å¤§å˜æ…¢ï¼Œå¯ä»¥åªç´¢å¼•åˆ—å¼€å§‹çš„éƒ¨åˆ†å­—ç¬¦ä¸²ï¼ŒèŠ‚çº¦ç´¢å¼•ç©ºé—´ï¼Œæé«˜ç´¢å¼•æ•ˆç‡\r\n\r\næ³¨æ„ï¼šä½¿ç”¨å‰ç¼€ç´¢å¼•å°±ç³»ç»Ÿå°±å¿½ç•¥è¦†ç›–ç´¢å¼•å¯¹æŸ¥è¯¢æ€§èƒ½çš„ä¼˜åŒ–äº†\r\n\r\nä¼˜åŒ–åŸåˆ™ï¼š**é™ä½é‡å¤çš„ç´¢å¼•å€¼**\r\n\r\næ¯”å¦‚åœ°åŒºè¡¨ï¼š\r\n\r\n```sql\r\narea\t\t\tgdp\t\tcode\r\nchinaShanghai\t100\t\taaa\r\nchinaDalian\t\t200\t\tbbb\r\nusaNewYork\t\t300\t\tccc\r\nchinaFuxin\t\t400\t\tddd\r\nchinaBeijing\t500\t\teee\r\n```\r\n\r\nå‘ç° area å­—æ®µå¾ˆå¤šéƒ½æ˜¯ä»¥ china å¼€å¤´çš„ï¼Œé‚£ä¹ˆå¦‚æœä»¥å‰ 1-5 ä½å­—ç¬¦åšå‰ç¼€ç´¢å¼•å°±ä¼šå‡ºç°å¤§é‡ç´¢å¼•å€¼é‡å¤çš„æƒ…å†µï¼Œç´¢å¼•å€¼é‡å¤æ€§è¶Šä½ï¼ŒæŸ¥è¯¢æ•ˆç‡ä¹Ÿå°±è¶Šé«˜ï¼Œæ‰€ä»¥éœ€è¦å»ºç«‹å‰ 6 ä½å­—ç¬¦çš„ç´¢å¼•ï¼š\r\n\r\n```sql\r\nCREATE INDEX idx_area ON table_name(area(7));\r\n```\r\n\r\nåœºæ™¯ï¼šå­˜å‚¨èº«ä»½è¯\r\n\r\n* ç›´æ¥åˆ›å»ºå®Œæ•´ç´¢å¼•ï¼Œè¿™æ ·å¯èƒ½æ¯”è¾ƒå ç”¨ç©ºé—´\r\n* åˆ›å»ºå‰ç¼€ç´¢å¼•ï¼ŒèŠ‚çœç©ºé—´ï¼Œä½†ä¼šå¢åŠ æŸ¥è¯¢æ‰«ææ¬¡æ•°ï¼Œå¹¶ä¸”ä¸èƒ½ä½¿ç”¨è¦†ç›–ç´¢å¼•\r\n* å€’åºå­˜å‚¨ï¼Œå†åˆ›å»ºå‰ç¼€ç´¢å¼•ï¼Œç”¨äºç»•è¿‡å­—ç¬¦ä¸²æœ¬èº«å‰ç¼€çš„åŒºåˆ†åº¦ä¸å¤Ÿçš„é—®é¢˜ï¼ˆå‰ 6 ä½ç›¸åŒçš„å¾ˆå¤šï¼‰\r\n* åˆ›å»º hash å­—æ®µç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½ç¨³å®šï¼Œæœ‰é¢å¤–çš„å­˜å‚¨å’Œè®¡ç®—æ¶ˆè€—ï¼Œè·Ÿç¬¬ä¸‰ç§æ–¹å¼ä¸€æ ·ï¼Œéƒ½ä¸æ”¯æŒèŒƒå›´æ‰«æ\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### ç´¢å¼•åˆå¹¶\r\n\r\nä½¿ç”¨å¤šä¸ªç´¢å¼•æ¥å®Œæˆä¸€æ¬¡æŸ¥è¯¢çš„æ‰§è¡Œæ–¹æ³•å«åšç´¢å¼•åˆå¹¶ index merge\r\n\r\n* Intersection ç´¢å¼•åˆå¹¶ï¼š\r\n\r\n  ```sql\r\n  SELECT * FROM table_test WHERE key1 = 'a' AND key3 = 'b'; # key1 å’Œ key3 åˆ—éƒ½æ˜¯å•åˆ—ç´¢å¼•ã€äºŒçº§ç´¢å¼•\r\n  ```\r\n\r\n  ä»ä¸åŒç´¢å¼•ä¸­æ‰«æåˆ°çš„è®°å½•çš„ id å€¼å–**äº¤é›†**ï¼ˆç›¸åŒ idï¼‰ï¼Œç„¶åæ‰§è¡Œå›è¡¨æ“ä½œï¼Œè¦æ±‚ä»æ¯ä¸ªäºŒçº§ç´¢å¼•è·å–åˆ°çš„è®°å½•éƒ½æ˜¯æŒ‰ç…§ä¸»é”®å€¼æ’åº\r\n\r\n* Union ç´¢å¼•åˆå¹¶ï¼š\r\n\r\n  ```sql\r\n  SELECT * FROM table_test WHERE key1 = 'a' OR key3 = 'b';\r\n  ```\r\n\r\n  ä»ä¸åŒç´¢å¼•ä¸­æ‰«æåˆ°çš„è®°å½•çš„ id å€¼å–**å¹¶é›†**ï¼Œç„¶åæ‰§è¡Œå›è¡¨æ“ä½œï¼Œè¦æ±‚ä»æ¯ä¸ªäºŒçº§ç´¢å¼•è·å–åˆ°çš„è®°å½•éƒ½æ˜¯æŒ‰ç…§ä¸»é”®å€¼æ’åº\r\n\r\n* Sort-Union ç´¢å¼•åˆå¹¶\r\n\r\n  ```sql\r\n  SELECT * FROM table_test WHERE key1 < 'a' OR key3 > 'b';\r\n  ```\r\n\r\n  å…ˆå°†ä»ä¸åŒç´¢å¼•ä¸­æ‰«æåˆ°çš„è®°å½•çš„ä¸»é”®å€¼è¿›è¡Œæ’åºï¼Œå†æŒ‰ç…§ Union ç´¢å¼•åˆå¹¶çš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢\r\n\r\nç´¢å¼•åˆå¹¶ç®—æ³•çš„æ•ˆç‡å¹¶ä¸å¥½ï¼Œé€šè¿‡å°†å…¶ä¸­çš„ä¸€ä¸ªç´¢å¼•æ”¹æˆè”åˆç´¢å¼•ä¼šä¼˜åŒ–æ•ˆç‡\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"MySQL - é”","tags":["SQL"],"categories":["MySQL","é”ç¯‡"],"author":"imklaus","excerpt":"\r\n### åŸºæœ¬ä»‹ç»\r\n\r\né”æœºåˆ¶ï¼šæ•°æ®åº“ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨å…±äº«çš„èµ„æºè¢«å¹¶å‘è®¿é—®æ—¶å˜å¾—å®‰å…¨æœ‰åºæ‰€è®¾è®¡çš„ä¸€ç§è§„åˆ™\r\n\r\nåˆ©ç”¨ MVCC æ€§è´¨è¿›è¡Œè¯»å–çš„æ“ä½œå«**ä¸€è‡´æ€§è¯»**ï¼Œè¯»å–æ•°æ®å‰åŠ é”çš„æ“ä½œå«**é”å®šè¯»**\r\n","link":"/posts/MySQL_Lock","content":"\r\n### åŸºæœ¬ä»‹ç»\r\n\r\né”æœºåˆ¶ï¼šæ•°æ®åº“ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨å…±äº«çš„èµ„æºè¢«å¹¶å‘è®¿é—®æ—¶å˜å¾—å®‰å…¨æœ‰åºæ‰€è®¾è®¡çš„ä¸€ç§è§„åˆ™\r\n\r\nåˆ©ç”¨ MVCC æ€§è´¨è¿›è¡Œè¯»å–çš„æ“ä½œå«**ä¸€è‡´æ€§è¯»**ï¼Œè¯»å–æ•°æ®å‰åŠ é”çš„æ“ä½œå«**é”å®šè¯»**\r\n<!-- more -->\r\né”çš„åˆ†ç±»ï¼š\r\n\r\n- æŒ‰æ“ä½œåˆ†ç±»ï¼š\r\n  - å…±äº«é”ï¼šä¹Ÿå«è¯»é”ã€‚å¯¹åŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ªäº‹åŠ¡è¯»æ“ä½œå¯ä»¥åŒæ—¶åŠ é”è€Œä¸äº’ç›¸å½±å“ ï¼Œä½†ä¸èƒ½ä¿®æ”¹æ•°æ®\r\n  - æ’ä»–é”ï¼šä¹Ÿå«å†™é”ã€‚å½“å‰çš„æ“ä½œæ²¡æœ‰å®Œæˆå‰ï¼Œä¼šé˜»æ–­å…¶ä»–æ“ä½œçš„è¯»å–å’Œå†™å…¥\r\n- æŒ‰ç²’åº¦åˆ†ç±»ï¼š\r\n  - è¡¨çº§é”ï¼šä¼šé”å®šæ•´ä¸ªè¡¨ï¼Œå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šåŠ›åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªæ¦‚ç‡é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ï¼Œåå‘ MyISAM\r\n  - è¡Œçº§é”ï¼šä¼šé”å®šå½“å‰æ“ä½œè¡Œï¼Œå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šåŠ›åº¦å°ï¼Œå‘ç”Ÿé”å†²çªæ¦‚ç‡ä½ï¼Œå¹¶å‘åº¦é«˜ï¼Œåå‘ InnoDB\r\n  - é¡µçº§é”ï¼šé”çš„åŠ›åº¦ã€å‘ç”Ÿå†²çªçš„æ¦‚ç‡å’ŒåŠ é”å¼€é”€ä»‹äºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œä¼šå‡ºç°æ­»é”ï¼Œå¹¶å‘æ€§èƒ½ä¸€èˆ¬\r\n- æŒ‰ä½¿ç”¨æ–¹å¼åˆ†ç±»ï¼š\r\n  - æ‚²è§‚é”ï¼šæ¯æ¬¡æŸ¥è¯¢æ•°æ®æ—¶éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œå¾ˆæ‚²è§‚ï¼Œæ‰€ä»¥æŸ¥è¯¢æ—¶åŠ é”\r\n  - ä¹è§‚é”ï¼šæ¯æ¬¡æŸ¥è¯¢æ•°æ®æ—¶éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œå¾ˆä¹è§‚ï¼Œä½†æ˜¯æ›´æ–°æ—¶ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ®\r\n\r\n* ä¸åŒå­˜å‚¨å¼•æ“æ”¯æŒçš„é”\r\n\r\n  | å­˜å‚¨å¼•æ“ | è¡¨çº§é”   | è¡Œçº§é”   | é¡µçº§é” |\r\n  | -------- | -------- | -------- | ------ |\r\n  | MyISAM   | æ”¯æŒ     | ä¸æ”¯æŒ   | ä¸æ”¯æŒ |\r\n  | InnoDB   | **æ”¯æŒ** | **æ”¯æŒ** | ä¸æ”¯æŒ |\r\n  | MEMORY   | æ”¯æŒ     | ä¸æ”¯æŒ   | ä¸æ”¯æŒ |\r\n  | BDB      | æ”¯æŒ     | ä¸æ”¯æŒ   | æ”¯æŒ   |\r\n\r\nä»é”çš„è§’åº¦æ¥è¯´ï¼šè¡¨çº§é”æ›´é€‚åˆäºä»¥æŸ¥è¯¢ä¸ºä¸»ï¼Œåªæœ‰å°‘é‡æŒ‰ç´¢å¼•æ¡ä»¶æ›´æ–°æ•°æ®çš„åº”ç”¨ï¼Œå¦‚ Web åº”ç”¨ï¼›è€Œè¡Œçº§é”åˆ™æ›´é€‚åˆäºæœ‰å¤§é‡æŒ‰ç´¢å¼•æ¡ä»¶å¹¶å‘æ›´æ–°å°‘é‡ä¸åŒæ•°æ®ï¼ŒåŒæ—¶åˆæœ‰å¹¶æŸ¥è¯¢çš„åº”ç”¨ï¼Œå¦‚ä¸€äº›åœ¨çº¿äº‹åŠ¡å¤„ç†ç³»ç»Ÿ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å†…å­˜ç»“æ„\r\n\r\nå¯¹ä¸€æ¡è®°å½•åŠ é”çš„æœ¬è´¨å°±æ˜¯**åœ¨å†…å­˜ä¸­**åˆ›å»ºä¸€ä¸ªé”ç»“æ„ä¸ä¹‹å…³è”ï¼Œç»“æ„åŒ…æ‹¬\r\n\r\n* äº‹åŠ¡ä¿¡æ¯ï¼šé”å¯¹åº”çš„äº‹åŠ¡ä¿¡æ¯ï¼Œä¸€ä¸ªé”å±äºä¸€ä¸ªäº‹åŠ¡\r\n* ç´¢å¼•ä¿¡æ¯ï¼šå¯¹äºè¡Œçº§é”ï¼Œéœ€è¦è®°å½•åŠ é”çš„è®°å½•å±äºå“ªä¸ªç´¢å¼•\r\n* è¡¨é”å’Œè¡Œé”ä¿¡æ¯ï¼šè¡¨é”è®°å½•ç€é”å®šçš„è¡¨ï¼Œè¡Œé”è®°å½•äº† Space ID æ‰€åœ¨è¡¨ç©ºé—´ã€Page Number æ‰€åœ¨çš„é¡µå·ã€n_bits ä½¿ç”¨äº†å¤šå°‘æ¯”ç‰¹\r\n* type_modeï¼šä¸€ä¸ª 32 æ¯”ç‰¹çš„æ•°ï¼Œè¢«åˆ†æˆ lock_modeã€lock_typeã€rec_lock_type ä¸‰ä¸ªéƒ¨åˆ†\r\n  * lock_modeï¼šé”æ¨¡å¼ï¼Œè®°å½•æ˜¯å…±äº«é”ã€æ’ä»–é”ã€æ„å‘é”ä¹‹ç±»\r\n  * lock_typeï¼šä»£è¡¨è¡¨çº§é”è¿˜æ˜¯è¡Œçº§é”\r\n  * rec_lock_typeï¼šä»£è¡¨è¡Œé”çš„å…·ä½“ç±»å‹å’Œ is_waiting å±æ€§ï¼Œis_waiting = true æ—¶è¡¨ç¤ºå½“å‰äº‹åŠ¡å°šæœªè·å–åˆ°é”ï¼Œå¤„äºç­‰å¾…çŠ¶æ€ã€‚äº‹åŠ¡è·å–é”åçš„é”ç»“æ„æ˜¯ is_waiting ä¸º falseï¼Œé‡Šæ”¾é”æ—¶ä¼šæ£€æŸ¥æ˜¯å¦ä¸å½“å‰è®°å½•å…³è”çš„é”ç»“æ„ï¼Œå¦‚æœæœ‰å°±å”¤é†’å¯¹åº”äº‹åŠ¡çš„çº¿ç¨‹\r\n\r\nä¸€ä¸ªäº‹åŠ¡å¯èƒ½æ“ä½œå¤šæ¡è®°å½•ï¼Œä¸ºäº†èŠ‚çœå†…å­˜ï¼Œæ»¡è¶³ä¸‹é¢æ¡ä»¶çš„é”ä½¿ç”¨åŒä¸€ä¸ªé”ç»“æ„ï¼š\r\n\r\n* åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­çš„åŠ é”æ“ä½œ\r\n* è¢«åŠ é”çš„è®°å½•åœ¨åŒä¸€ä¸ªé¡µé¢ä¸­\r\n* åŠ é”çš„ç±»å‹æ˜¯ä¸€æ ·çš„\r\n* åŠ é”çš„çŠ¶æ€æ˜¯ä¸€æ ·çš„\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### Server\r\n\r\nMySQL é‡Œé¢è¡¨çº§åˆ«çš„é”æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯è¡¨é”ï¼Œä¸€ç§æ˜¯å…ƒæ•°æ®é”ï¼ˆmeta data lockï¼ŒMDL)\r\n\r\nMDL å«å…ƒæ•°æ®é”ï¼Œä¸»è¦ç”¨æ¥ä¿æŠ¤ MySQL å†…éƒ¨å¯¹è±¡çš„å…ƒæ•°æ®ï¼Œä¿è¯æ•°æ®è¯»å†™çš„æ­£ç¡®æ€§ï¼Œ**å½“å¯¹ä¸€ä¸ªè¡¨åšå¢åˆ æ”¹æŸ¥çš„æ—¶å€™ï¼ŒåŠ  MDL è¯»é”ï¼›å½“è¦å¯¹è¡¨åšç»“æ„å˜æ›´æ“ä½œ DDL çš„æ—¶å€™ï¼ŒåŠ  MDL å†™é”**ï¼Œä¸¤ç§é”ä¸ç›¸äº’å…¼å®¹ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯ DDLã€DMLã€DQL æ“ä½œçš„å®‰å…¨\r\n\r\nè¯´æ˜ï¼šDDL æ“ä½œæ‰§è¡Œå‰ä¼šéšå¼æäº¤å½“å‰ä¼šè¯çš„äº‹åŠ¡ï¼Œå› ä¸º DDL ä¸€èˆ¬ä¼šåœ¨è‹¥å¹²ä¸ªç‰¹æ®Šäº‹åŠ¡ä¸­å®Œæˆï¼Œå¼€å¯ç‰¹æ®Šäº‹åŠ¡å‰éœ€è¦æäº¤åˆ°å…¶ä»–äº‹åŠ¡\r\n\r\nMDL é”çš„ç‰¹æ€§ï¼š\r\n\r\n* MDL é”ä¸éœ€è¦æ˜¾å¼ä½¿ç”¨ï¼Œåœ¨è®¿é—®ä¸€ä¸ªè¡¨çš„æ—¶å€™ä¼šè¢«è‡ªåŠ¨åŠ ä¸Šï¼Œåœ¨äº‹åŠ¡å¼€å§‹æ—¶ç”³è¯·ï¼Œæ•´ä¸ªäº‹åŠ¡æäº¤åé‡Šæ”¾ï¼ˆæ‰§è¡Œå®Œå•æ¡è¯­å¥ä¸é‡Šæ”¾ï¼‰\r\n\r\n* MDL é”æ˜¯åœ¨ Server ä¸­å®ç°ï¼Œä¸æ˜¯ InnoDB å­˜å‚¨å¼•æ“å±‚èƒ½ç›´æ¥å®ç°çš„é”\r\n\r\n* MDL é”è¿˜èƒ½å®ç°å…¶ä»–ç²’åº¦çº§åˆ«çš„é”ï¼Œæ¯”å¦‚å…¨å±€é”ã€åº“çº§åˆ«çš„é”ã€è¡¨ç©ºé—´çº§åˆ«çš„é”\r\n\r\nFLUSH TABLES WITH READ LOCK ç®€ç§°ï¼ˆFTWRLï¼‰ï¼Œå…¨å±€è¯»é”ï¼Œè®©æ•´ä¸ªåº“å¤„äºåªè¯»çŠ¶æ€ï¼ŒDDL DML éƒ½è¢«é˜»å¡ï¼Œå·¥ä½œæµç¨‹ï¼š\r\n\r\n1. ä¸Šå…¨å±€è¯»é”ï¼ˆlock_global_read_lockï¼‰\r\n2. æ¸…ç†è¡¨ç¼“å­˜ï¼ˆclose_cached_tablesï¼‰\r\n3. ä¸Šå…¨å±€ COMMIT é”ï¼ˆmake_global_read_lock_block_commitï¼‰\r\n\r\nè¯¥å‘½ä»¤ä¸»è¦ç”¨äºå¤‡ä»½å·¥å…·åš**ä¸€è‡´æ€§å¤‡ä»½**ï¼Œç”±äº FTWRL éœ€è¦æŒæœ‰ä¸¤æŠŠå…¨å±€çš„ MDL é”ï¼Œå¹¶ä¸”è¿˜è¦å…³é—­æ‰€æœ‰è¡¨å¯¹è±¡ï¼Œå› æ­¤æ€ä¼¤æ€§å¾ˆå¤§\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### MyISAM\r\n\r\n#### è¡¨çº§é”\r\n\r\nMyISAM å­˜å‚¨å¼•æ“åªæ”¯æŒè¡¨é”ï¼Œè¿™ä¹Ÿæ˜¯ MySQL å¼€å§‹å‡ ä¸ªç‰ˆæœ¬ä¸­å”¯ä¸€æ”¯æŒçš„é”ç±»å‹\r\n\r\nMyISAM å¼•æ“åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¹‹å‰ï¼Œä¼š**è‡ªåŠ¨**ç»™æ¶‰åŠåˆ°çš„æ‰€æœ‰è¡¨åŠ è¯»é”ï¼Œåœ¨æ‰§è¡Œå¢åˆ æ”¹ä¹‹å‰ï¼Œä¼š**è‡ªåŠ¨**ç»™æ¶‰åŠçš„è¡¨åŠ å†™é”ï¼Œè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸éœ€è¦ç”¨æˆ·å¹²é¢„ï¼Œæ‰€ä»¥ç”¨æˆ·ä¸€èˆ¬ä¸éœ€è¦ç›´æ¥ç”¨ LOCK TABLE å‘½ä»¤ç»™ MyISAM è¡¨æ˜¾å¼åŠ é”\r\n\r\n* åŠ é”å‘½ä»¤ï¼šï¼ˆå¯¹ InnoDB å­˜å‚¨å¼•æ“ä¹Ÿé€‚ç”¨ï¼‰\r\n\r\n  è¯»é”ï¼šæ‰€æœ‰è¿æ¥åªèƒ½è¯»å–æ•°æ®ï¼Œä¸èƒ½ä¿®æ”¹\r\n\r\n  å†™é”ï¼šå…¶ä»–è¿æ¥ä¸èƒ½æŸ¥è¯¢å’Œä¿®æ”¹æ•°æ®\r\n\r\n  ```sql\r\n  -- è¯»é”\r\n  LOCK TABLE table_name READ;\r\n  \r\n  -- å†™é”\r\n  LOCK TABLE table_name WRITE;\r\n  ```\r\n\r\n* è§£é”å‘½ä»¤ï¼š\r\n\r\n  ```sql\r\n  -- å°†å½“å‰ä¼šè¯æ‰€æœ‰çš„è¡¨è¿›è¡Œè§£é”\r\n  UNLOCK TABLES;\r\n  ```\r\n\r\né”çš„å…¼å®¹æ€§ï¼š\r\n\r\n* å¯¹ MyISAM è¡¨çš„è¯»æ“ä½œï¼Œä¸ä¼šé˜»å¡å…¶ä»–ç”¨æˆ·å¯¹åŒä¸€è¡¨çš„è¯»è¯·æ±‚ï¼Œä½†ä¼šé˜»å¡å¯¹åŒä¸€è¡¨çš„å†™è¯·æ±‚\r\n* å¯¹ MyISAM è¡¨çš„å†™æ“ä½œï¼Œåˆ™ä¼šé˜»å¡å…¶ä»–ç”¨æˆ·å¯¹åŒä¸€è¡¨çš„è¯»å’Œå†™æ“ä½œ\r\n\r\n![image-20250320011957733](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011957733.png)\r\n\r\né”è°ƒåº¦ï¼š**MyISAM çš„è¯»å†™é”è°ƒåº¦æ˜¯å†™ä¼˜å…ˆ**ï¼Œå› ä¸ºå†™é”åå…¶ä»–çº¿ç¨‹ä¸èƒ½åšä»»ä½•æ“ä½œï¼Œå¤§é‡çš„æ›´æ–°ä¼šä½¿æŸ¥è¯¢å¾ˆéš¾å¾—åˆ°é”ï¼Œä»è€Œé€ æˆæ°¸è¿œé˜»å¡ï¼Œæ‰€ä»¥ MyISAM ä¸é€‚åˆåšå†™ä¸ºä¸»çš„è¡¨çš„å­˜å‚¨å¼•æ“\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### é”æ“ä½œ\r\n\r\n##### è¯»é”\r\n\r\nä¸¤ä¸ªå®¢æˆ·ç«¯æ“ä½œ Client 1å’Œ Client 2ï¼Œç®€åŒ–ä¸º C1ã€C2\r\n\r\n* æ•°æ®å‡†å¤‡ï¼š\r\n\r\n  ```sql\r\n  CREATE TABLE `tb_book` (\r\n    `id` INT(11) AUTO_INCREMENT,\r\n    `name` VARCHAR(50) DEFAULT NULL,\r\n    `publish_time` DATE DEFAULT NULL,\r\n    `status` CHAR(1) DEFAULT NULL,\r\n    PRIMARY KEY (`id`)\r\n  ) ENGINE=MYISAM DEFAULT CHARSET=utf8 ;\r\n  \r\n  INSERT INTO tb_book (id, NAME, publish_time, STATUS) VALUES(NULL,'javaç¼–ç¨‹æ€æƒ³','2088-08-01','1');\r\n  INSERT INTO tb_book (id, NAME, publish_time, STATUS) VALUES(NULL,'mysqlç¼–ç¨‹æ€æƒ³','2088-08-08','0');\r\n  ```\r\n\r\n* C1ã€C2 åŠ è¯»é”ï¼ŒåŒæ—¶æŸ¥è¯¢å¯ä»¥æ­£å¸¸æŸ¥è¯¢å‡ºæ•°æ®\r\n\r\n  ```sql\r\n  LOCK TABLE tb_book READ;\t-- C1ã€C2\r\n  SELECT * FROM tb_book;\t\t-- C1ã€C2\r\n  ```\r\n\r\n  ![image-20250320012120176](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012120176.png)\r\n\r\n* C1 åŠ è¯»é”ï¼ŒC1ã€C2 æŸ¥è¯¢æœªé”å®šçš„è¡¨ï¼ŒC1 æŠ¥é”™ï¼ŒC2 æ­£å¸¸æŸ¥è¯¢\r\n\r\n  ```sql\r\n  LOCK TABLE tb_book READ;\t-- C1\r\n  SELECT * FROM tb_user;\t\t-- C1ã€C2\r\n  ```\r\n\r\n  ![image-20250320012150524](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012150524.png)\r\n\r\n  C1ã€C2 æ‰§è¡Œæ’å…¥æ“ä½œï¼ŒC1 æŠ¥é”™ï¼ŒC2 ç­‰å¾…è·å–\r\n\r\n  ```sql\r\n  INSERT INTO tb_book VALUES(NULL,'Springé«˜çº§','2088-01-01','1');\t-- C1ã€C2\r\n  ```\r\n\r\n  ![image-20250320012210171](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012210171.png)\r\n\r\n  å½“åœ¨ C1 ä¸­é‡Šæ”¾é”æŒ‡ä»¤ UNLOCK TABLESï¼ŒC2 ä¸­çš„ INSERT è¯­å¥ç«‹å³æ‰§è¡Œ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å†™é”\r\n\r\nä¸¤ä¸ªå®¢æˆ·ç«¯æ“ä½œ Client 1å’Œ Client 2ï¼Œç®€åŒ–ä¸º C1ã€C2\r\n\r\n* C1 åŠ å†™é”ï¼ŒC1ã€C2æŸ¥è¯¢è¡¨ï¼ŒC1 æ­£å¸¸æŸ¥è¯¢ï¼ŒC2 éœ€è¦ç­‰å¾…\r\n\r\n  ```sql\r\n  LOCK TABLE tb_book WRITE;\t-- C1\r\n  SELECT * FROM tb_book;\t\t-- C1ã€C2\r\n  ```\r\n\r\n  ![image-20250320012225386](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012225386.png)\r\n\r\n  å½“åœ¨ C1 ä¸­é‡Šæ”¾é”æŒ‡ä»¤ UNLOCK TABLESï¼ŒC2 ä¸­çš„ SELECT è¯­å¥ç«‹å³æ‰§è¡Œ\r\n\r\n* C1ã€C2 åŒæ—¶åŠ å†™é”\r\n\r\n  ```sql\r\n  LOCK TABLE tb_book WRITE;\r\n  ```\r\n\r\n  ![image-20250320012244418](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012244418.png)\r\n\r\n* C1 åŠ å†™é”ï¼ŒC1ã€C2æŸ¥è¯¢æœªé”å®šçš„è¡¨ï¼ŒC1 æŠ¥é”™ï¼ŒC2 æ­£å¸¸æŸ¥è¯¢\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### é”çŠ¶æ€\r\n\r\n* æŸ¥çœ‹é”ç«äº‰ï¼š\r\n\r\n  ```sql\r\n  SHOW OPEN TABLES;\r\n  ```\r\n\r\n  ![image-20250320012302380](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012302380.png)\r\n\r\n  In_userï¼šè¡¨å½“å‰è¢«æŸ¥è¯¢ä½¿ç”¨çš„æ¬¡æ•°ï¼Œå¦‚æœè¯¥æ•°ä¸ºé›¶ï¼Œåˆ™è¡¨æ˜¯æ‰“å¼€çš„ï¼Œä½†æ˜¯å½“å‰æ²¡æœ‰è¢«ä½¿ç”¨\r\n\r\n  Name_lockedï¼šè¡¨åç§°æ˜¯å¦è¢«é”å®šï¼Œåç§°é”å®šç”¨äºå–æ¶ˆè¡¨æˆ–å¯¹è¡¨è¿›è¡Œé‡å‘½åç­‰æ“ä½œ\r\n\r\n  ```sql\r\n  LOCK TABLE tb_book READ;\t-- æ‰§è¡Œå‘½ä»¤\r\n  ```\r\n\r\n  ![image-20250320012311528](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012311528.png)\r\n\r\n* æŸ¥çœ‹é”çŠ¶æ€ï¼š\r\n\r\n  ```sql\r\n  SHOW STATUS LIKE 'Table_locks%';\r\n  ```\r\n\r\n  ![image-20250320012325225](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012325225.png)\r\n\r\n  Table_locks_immediateï¼šæŒ‡çš„æ˜¯èƒ½ç«‹å³è·å¾—è¡¨çº§é”çš„æ¬¡æ•°ï¼Œæ¯ç«‹å³è·å–é”ï¼Œå€¼åŠ  1\r\n\r\n  Table_locks_waitedï¼šæŒ‡çš„æ˜¯ä¸èƒ½ç«‹å³è·å–è¡¨çº§é”è€Œéœ€è¦ç­‰å¾…çš„æ¬¡æ•°ï¼Œæ¯ç­‰å¾…ä¸€æ¬¡ï¼Œè¯¥å€¼åŠ  1ï¼Œæ­¤å€¼é«˜è¯´æ˜å­˜åœ¨ç€è¾ƒä¸ºä¸¥é‡çš„è¡¨çº§é”äº‰ç”¨æƒ…å†µ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### InnoDB\r\n\r\n#### è¡Œçº§é”\r\n\r\n##### è®°å½•é”\r\n\r\nInnoDB ä¸ MyISAM çš„æœ€å¤§ä¸åŒæœ‰ä¸¤ç‚¹ï¼šä¸€æ˜¯æ”¯æŒäº‹åŠ¡ï¼›äºŒæ˜¯é‡‡ç”¨äº†è¡Œçº§é”ï¼Œ**InnoDB åŒæ—¶æ”¯æŒè¡¨é”å’Œè¡Œé”**\r\n\r\nè¡Œçº§é”ï¼Œä¹Ÿç§°ä¸ºè®°å½•é”ï¼ˆRecord Lockï¼‰ï¼ŒInnoDB  å®ç°äº†ä»¥ä¸‹ä¸¤ç§ç±»å‹çš„è¡Œé”ï¼š\r\n\r\n- å…±äº«é” (S)ï¼šåˆç§°ä¸ºè¯»é”ï¼Œç®€ç§° S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯¹äºåŒä¸€æ•°æ®å¯ä»¥å…±äº«ä¸€æŠŠé”ï¼Œéƒ½èƒ½è®¿é—®åˆ°æ•°æ®ï¼Œä½†æ˜¯åªèƒ½è¯»ä¸èƒ½ä¿®æ”¹\r\n- æ’ä»–é” (X)ï¼šåˆç§°ä¸ºå†™é”ï¼Œç®€ç§° X é”ï¼Œä¸èƒ½ä¸å…¶ä»–é”å¹¶å­˜ï¼Œè·å–æ’ä»–é”çš„äº‹åŠ¡æ˜¯å¯ä»¥å¯¹æ•°æ®è¯»å–å’Œä¿®æ”¹\r\n\r\nRR éš”ç¦»ç•Œåˆ«ä¸‹ï¼Œå¯¹äº UPDATEã€DELETE å’Œ INSERT è¯­å¥ï¼ŒInnoDB ä¼š**è‡ªåŠ¨ç»™æ¶‰åŠæ•°æ®é›†åŠ æ’ä»–é”**ï¼ˆè¡Œé”ï¼‰ï¼Œåœ¨ commit æ—¶è‡ªåŠ¨é‡Šæ”¾ï¼›å¯¹äºæ™®é€š SELECT è¯­å¥ï¼Œä¸ä¼šåŠ ä»»ä½•é”ï¼ˆåªæ˜¯é’ˆå¯¹ InnoDB å±‚æ¥è¯´çš„ï¼Œå› ä¸ºåœ¨ Server å±‚ä¼š**åŠ  MDL è¯»é”**ï¼‰ï¼Œé€šè¿‡ MVCC é˜²æ­¢å¹¶å‘å†²çª\r\n\r\nåœ¨äº‹åŠ¡ä¸­åŠ çš„é”ï¼Œå¹¶ä¸æ˜¯ä¸éœ€è¦äº†å°±é‡Šæ”¾ï¼Œè€Œæ˜¯åœ¨äº‹åŠ¡ä¸­æ­¢æˆ–æäº¤æ—¶è‡ªåŠ¨é‡Šæ”¾ï¼Œè¿™ä¸ªå°±æ˜¯**ä¸¤é˜¶æ®µé”åè®®**ã€‚æ‰€ä»¥ä¸€èˆ¬å°†æ›´æ–°å…±äº«èµ„æºï¼ˆå¹¶å‘é«˜ï¼‰çš„ SQL æ”¾åˆ°äº‹åŠ¡çš„æœ€åæ‰§è¡Œï¼Œå¯ä»¥è®©å…¶ä»–çº¿ç¨‹å°½é‡çš„å‡å°‘ç­‰å¾…æ—¶é—´\r\n\r\né”çš„å…¼å®¹æ€§ï¼š\r\n\r\n- å…±äº«é”å’Œå…±äº«é”     å…¼å®¹\r\n- å…±äº«é”å’Œæ’ä»–é”     å†²çª\r\n- æ’ä»–é”å’Œæ’ä»–é”     å†²çª\r\n- æ’ä»–é”å’Œå…±äº«é”     å†²çª\r\n\r\næ˜¾å¼ç»™æ•°æ®é›†åŠ å…±äº«é”æˆ–æ’ä»–é”ï¼š**åŠ é”è¯»å°±æ˜¯å½“å‰è¯»ï¼Œè¯»å–çš„æ˜¯æœ€æ–°æ•°æ®**\r\n\r\n```sql\r\nSELECT * FROM table_name WHERE ... LOCK IN SHARE MODE\t-- å…±äº«é”\r\nSELECT * FROM table_name WHERE ... FOR UPDATE\t\t\t-- æ’ä»–é”\r\n```\r\n\r\næ³¨æ„ï¼š**é”é»˜è®¤ä¼šé”èšç°‡ç´¢å¼•ï¼ˆé”å°±æ˜¯åŠ åœ¨ç´¢å¼•ä¸Šï¼‰**ï¼Œä½†æ˜¯å½“ä½¿ç”¨è¦†ç›–ç´¢å¼•æ—¶ï¼ŒåŠ å…±äº«é”åªé”äºŒçº§ç´¢å¼•ï¼Œä¸é”èšç°‡ç´¢å¼•\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### é”æ“ä½œ\r\n\r\nä¸¤ä¸ªå®¢æˆ·ç«¯æ“ä½œ Client 1å’Œ Client 2ï¼Œç®€åŒ–ä¸º C1ã€C2\r\n\r\n* ç¯å¢ƒå‡†å¤‡\r\n\r\n  ```sql\r\n  CREATE TABLE test_innodb_lock(\r\n  \tid INT(11),\r\n  \tname VARCHAR(16),\r\n  \tsex VARCHAR(1)\r\n  )ENGINE = INNODB DEFAULT CHARSET=utf8;\r\n  \r\n  INSERT INTO test_innodb_lock VALUES(1,'100','1');\r\n  -- ..........\r\n  \r\n  CREATE INDEX idx_test_innodb_lock_id ON test_innodb_lock(id);\r\n  CREATE INDEX idx_test_innodb_lock_name ON test_innodb_lock(name);\r\n  ```\r\n\r\n* å…³é—­è‡ªåŠ¨æäº¤åŠŸèƒ½ï¼š\r\n\r\n  ```sql\r\n  SET AUTOCOMMIT=0;\t-- C1ã€C2\r\n  ```\r\n\r\n  æ­£å¸¸æŸ¥è¯¢æ•°æ®ï¼š\r\n\r\n  ```sql\r\n  SELECT * FROM test_innodb_lock;\t-- C1ã€C2\r\n  ```\r\n\r\n* æŸ¥è¯¢ id ä¸º 3 çš„æ•°æ®ï¼Œæ­£å¸¸æŸ¥è¯¢ï¼š\r\n\r\n  ```sql\r\n  SELECT * FROM test_innodb_lock WHERE id=3;\t-- C1ã€C2\r\n  ```\r\n\r\n  ![image-20250320012357505](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012357505.png)\r\n\r\n* C1 æ›´æ–° id ä¸º 3 çš„æ•°æ®ï¼Œä½†ä¸æäº¤ï¼š\r\n\r\n  ```sql\r\n  UPDATE test_innodb_lock SET name='300' WHERE id=3;\t-- C1\r\n  ```\r\n\r\n  ![image-20250320012418342](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012418342.png)\r\n\r\n  C2 æŸ¥è¯¢ä¸åˆ° C1 ä¿®æ”¹çš„æ•°æ®ï¼Œå› ä¸ºéš”ç¦»ç•Œåˆ«ä¸º REPEATABLE READï¼ŒC1 æäº¤äº‹åŠ¡ï¼ŒC2 æŸ¥è¯¢ï¼š\r\n\r\n  ```sql\r\n  COMMIT;\t-- C1\r\n  ```\r\n\r\n  ![image-20250320012433081](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012433081.png)\r\n\r\n  æäº¤åä»ç„¶æŸ¥è¯¢ä¸åˆ° C1 ä¿®æ”¹çš„æ•°æ®ï¼Œå› ä¸ºéš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ï¼Œæ‰€ä»¥ C2 éœ€è¦æäº¤æ‰å¯ä»¥æŸ¥è¯¢åˆ°å…¶ä»–äº‹åŠ¡å¯¹æ•°æ®çš„ä¿®æ”¹ï¼š\r\n\r\n  ```sql\r\n  COMMIT;\t-- C2\r\n  SELECT * FROM test_innodb_lock WHERE id=3;\t-- C2\r\n  ```\r\n\r\n  ![image-20250320012447025](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012447025.png)\r\n\r\n* C1 æ›´æ–° id ä¸º 3 çš„æ•°æ®ï¼Œä½†ä¸æäº¤ï¼ŒC2 ä¹Ÿæ›´æ–° id ä¸º 3 çš„æ•°æ®ï¼š\r\n\r\n  ```sql\r\n  UPDATE test_innodb_lock SET name='3' WHERE id=3;\t-- C1\r\n  UPDATE test_innodb_lock SET name='30' WHERE id=3;\t-- C2\r\n  ```\r\n\r\n  ![image-20250320012503376](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012503376.png)\r\n\r\n  å½“ C1 æäº¤ï¼ŒC2 ç›´æ¥è§£é™¤é˜»å¡ï¼Œç›´æ¥æ›´æ–°\r\n\r\n* æ“ä½œä¸åŒè¡Œçš„æ•°æ®ï¼š\r\n\r\n  ```sql\r\n  UPDATE test_innodb_lock SET name='10' WHERE id=1;\t-- C1\r\n  UPDATE test_innodb_lock SET name='30' WHERE id=3;\t-- C2\r\n  ```\r\n\r\n  ![image-20250320012519822](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012519822.png)\r\n\r\n  ç”±äº C1ã€C2 æ“ä½œçš„ä¸åŒè¡Œï¼Œè·å–ä¸åŒçš„è¡Œé”ï¼Œæ‰€ä»¥éƒ½å¯ä»¥æ­£å¸¸è·å–è¡Œé”\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### é”åˆ†ç±»\r\n\r\n##### é—´éš™é”\r\n\r\nInnoDB ä¼šå¯¹é—´éš™ï¼ˆGAPï¼‰è¿›è¡ŒåŠ é”ï¼Œå°±æ˜¯é—´éš™é” ï¼ˆRR éš”ç¦»çº§åˆ«ä¸‹æ‰æœ‰è¯¥é”ï¼‰ã€‚é—´éš™é”ä¹‹é—´ä¸å­˜åœ¨å†²çªå…³ç³»ï¼Œ**å¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶å¯¹ä¸€ä¸ªé—´éš™åŠ é”**ï¼Œä½†æ˜¯é—´éš™é”ä¼šé˜»æ­¢å¾€è¿™ä¸ªé—´éš™ä¸­æ’å…¥ä¸€ä¸ªè®°å½•çš„æ“ä½œ\r\n\r\nInnoDB åŠ é”çš„åŸºæœ¬å•ä½æ˜¯ next-key lockï¼Œè¯¥é”æ˜¯è¡Œé”å’Œ gap lock çš„ç»„åˆï¼ˆX or S é”ï¼‰ï¼Œä½†æ˜¯åŠ é”è¿‡ç¨‹æ˜¯åˆ†ä¸ºé—´éš™é”å’Œè¡Œé”ä¸¤æ®µæ‰§è¡Œ\r\n\r\n* å¯ä»¥**ä¿æŠ¤å½“å‰è®°å½•å’Œå‰é¢çš„é—´éš™**ï¼Œéµå¾ªå·¦å¼€å³é—­åŸåˆ™ï¼Œå•çº¯çš„é—´éš™é”æ˜¯å·¦å¼€å³å¼€\r\n* å‡è®¾æœ‰ 10ã€11ã€13ï¼Œé‚£ä¹ˆå¯èƒ½çš„é—´éš™é”åŒ…æ‹¬ï¼š(è´Ÿæ— ç©·,10]ã€(10,11]ã€(11,13]ã€(13,æ­£æ— ç©·)\r\n\r\nå‡ ç§ç´¢å¼•çš„åŠ é”æƒ…å†µï¼š\r\n\r\n* å”¯ä¸€ç´¢å¼•åŠ é”åœ¨å€¼å­˜åœ¨æ—¶æ˜¯è¡Œé”ï¼Œnext-key lock ä¼šé€€åŒ–ä¸ºè¡Œé”ï¼Œå€¼ä¸å­˜åœ¨ä¼šå˜æˆé—´éš™é”\r\n* æ™®é€šç´¢å¼•åŠ é”ä¼šç»§ç»­å‘å³éå†åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„å€¼ä¸ºæ­¢ï¼Œnext-key lock é€€åŒ–ä¸ºé—´éš™é”\r\n* èŒƒå›´æŸ¥è¯¢æ— è®ºæ˜¯å¦æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œéƒ½éœ€è¦è®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢\r\n* å¯¹äºè”åˆç´¢å¼•ä¸”æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œå¦‚æœ where æ¡ä»¶åªåŒ…æ‹¬è”åˆç´¢å¼•çš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆä¼šåŠ é—´éš™é”\r\n\r\né—´éš™é”ä¼˜ç‚¹ï¼šRR çº§åˆ«ä¸‹é—´éš™é”å¯ä»¥**è§£å†³äº‹åŠ¡çš„ä¸€éƒ¨åˆ†çš„å¹»è¯»é—®é¢˜**ï¼Œé€šè¿‡å¯¹é—´éš™åŠ é”ï¼Œå¯ä»¥é˜²æ­¢è¯»å–è¿‡ç¨‹ä¸­æ•°æ®æ¡ç›®å‘ç”Ÿå˜åŒ–ã€‚ä¸€éƒ¨åˆ†çš„æ„æ€æ˜¯ä¸ä¼šå¯¹å…¨éƒ¨é—´éš™åŠ é”ï¼Œåªèƒ½åŠ é”ä¸€éƒ¨åˆ†çš„é—´éš™\r\n\r\né—´éš™é”å±å®³ï¼š\r\n\r\n* å½“é”å®šä¸€ä¸ªèŒƒå›´çš„é”®å€¼åï¼Œå³ä½¿æŸäº›ä¸å­˜åœ¨çš„é”®å€¼ä¹Ÿä¼šè¢«æ— è¾œçš„é”å®šï¼Œé€ æˆåœ¨é”å®šçš„æ—¶å€™æ— æ³•æ’å…¥é”å®šé”®å€¼èŒƒå›´å†…çš„ä»»ä½•æ•°æ®ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹è¿™å¯èƒ½ä¼šå¯¹æ€§èƒ½é€ æˆå¾ˆå¤§çš„å±å®³ï¼Œå½±å“å¹¶å‘åº¦\r\n* äº‹åŠ¡ A B åŒæ—¶é”ä½ä¸€ä¸ªé—´éš™åï¼ŒA å¾€å½“å‰é—´éš™æ’å…¥æ•°æ®æ—¶ä¼šè¢« B çš„é—´éš™é”é˜»å¡ï¼ŒB ä¹Ÿæ‰§è¡Œæ’å…¥é—´éš™æ•°æ®çš„æ“ä½œæ—¶å°±ä¼š**äº§ç”Ÿæ­»é”**\r\n\r\nç°åœºæ¼”ç¤ºï¼š\r\n\r\n* å…³é—­è‡ªåŠ¨æäº¤åŠŸèƒ½ï¼š\r\n\r\n  ```sql\r\n  SET AUTOCOMMIT=0;\t-- C1ã€C2\r\n  ```\r\n\r\n* æŸ¥è¯¢æ•°æ®è¡¨ï¼š\r\n\r\n  ```sql\r\n  SELECT * FROM test_innodb_lock;\r\n  ```\r\n\r\n  ![image-20250320012534405](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012534405.png)\r\n\r\n* C1 æ ¹æ® id èŒƒå›´æ›´æ–°æ•°æ®ï¼ŒC2 æ’å…¥æ•°æ®ï¼š\r\n\r\n  ```sql\r\n  UPDATE test_innodb_lock SET name='8888' WHERE id < 4;\t-- C1\r\n  INSERT INTO test_innodb_lock VALUES(2,'200','2');\t\t-- C2\r\n  ```\r\n\r\n  ![image-20250320012549974](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012549974.png)\r\n\r\n  å‡ºç°é—´éš™é”ï¼ŒC2 è¢«é˜»å¡ï¼Œç­‰å¾… C1 æäº¤äº‹åŠ¡åæ‰èƒ½æ›´æ–°\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n##### æ„å‘é”\r\n\r\nInnoDB ä¸ºäº†æ”¯æŒå¤šç²’åº¦çš„åŠ é”ï¼Œå…è®¸è¡Œé”å’Œè¡¨é”åŒæ—¶å­˜åœ¨ï¼Œæ”¯æŒåœ¨ä¸åŒç²’åº¦ä¸Šçš„åŠ é”æ“ä½œï¼ŒInnoDB å¢åŠ äº†æ„å‘é”ï¼ˆIntention Lockï¼‰\r\n\r\næ„å‘é”æ˜¯å°†é”å®šçš„å¯¹è±¡åˆ†ä¸ºå¤šä¸ªå±‚æ¬¡ï¼Œæ„å‘é”æ„å‘³ç€äº‹åŠ¡å¸Œæœ›åœ¨æ›´ç»†ç²’åº¦ä¸Šè¿›è¡ŒåŠ é”ï¼Œæ„å‘é”åˆ†ä¸ºä¸¤ç§ï¼š\r\n\r\n* æ„å‘å…±äº«é”ï¼ˆISï¼‰ï¼šäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨åŠ å…±äº«é”\r\n* æ„å‘æ’ä»–é”ï¼ˆIXï¼‰ï¼šäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨åŠ æ’ä»–é”\r\n\r\n**IXï¼ŒIS æ˜¯è¡¨çº§é”**ï¼Œä¸ä¼šå’Œè¡Œçº§çš„ Xï¼ŒS é”å‘ç”Ÿå†²çªï¼Œæ„å‘é”æ˜¯åœ¨åŠ è¡¨çº§é”ä¹‹å‰æ·»åŠ ï¼Œä¸ºäº†åœ¨åŠ è¡¨çº§é”æ—¶å¯ä»¥å¿«é€Ÿåˆ¤æ–­è¡¨ä¸­æ˜¯å¦æœ‰è®°å½•è¢«ä¸Šé”ï¼Œæ¯”å¦‚å‘ä¸€ä¸ªè¡¨æ·»åŠ è¡¨çº§ X é”çš„æ—¶ï¼š\r\n\r\n- æ²¡æœ‰æ„å‘é”ï¼Œåˆ™éœ€è¦éå†æ•´ä¸ªè¡¨åˆ¤æ–­æ˜¯å¦æœ‰é”å®šçš„è®°å½•\r\n- æœ‰äº†æ„å‘é”ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨æ„å‘é”ï¼Œç„¶ååˆ¤æ–­è¯¥æ„å‘é”ä¸å³å°†æ·»åŠ çš„è¡¨çº§é”æ˜¯å¦å…¼å®¹å³å¯ï¼Œå› ä¸ºæ„å‘é”çš„å­˜åœ¨ä»£è¡¨æœ‰è¡¨çº§é”çš„å­˜åœ¨æˆ–è€…å³å°†æœ‰è¡¨çº§é”çš„å­˜åœ¨\r\n\r\nå…¼å®¹æ€§å¦‚ä¸‹æ‰€ç¤ºï¼š\r\n\r\n![image-20250320012619005](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012619005.png)\r\n\r\n**æ’å…¥æ„å‘é”** Insert Intention Lock æ˜¯åœ¨æ’å…¥ä¸€è¡Œè®°å½•æ“ä½œä¹‹å‰è®¾ç½®çš„ä¸€ç§é—´éš™é”ï¼Œæ˜¯è¡Œçº§é”\r\n\r\næ’å…¥æ„å‘é”é‡Šæ”¾äº†ä¸€ç§æ’å…¥ä¿¡å·ï¼Œå³å¤šä¸ªäº‹åŠ¡åœ¨ç›¸åŒçš„ç´¢å¼•é—´éš™æ’å…¥æ—¶å¦‚æœä¸æ˜¯æ’å…¥ç›¸åŒçš„é—´éš™ä½ç½®å°±ä¸éœ€è¦äº’ç›¸ç­‰å¾…ã€‚å‡è®¾æŸåˆ—æœ‰ç´¢å¼•ï¼Œåªè¦ä¸¤ä¸ªäº‹åŠ¡æ’å…¥ä½ç½®ä¸åŒï¼Œå¦‚äº‹åŠ¡ A æ’å…¥ 3ï¼Œäº‹åŠ¡ B æ’å…¥ 4ï¼Œé‚£ä¹ˆå°±å¯ä»¥åŒæ—¶æ’å…¥\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### è‡ªå¢é”\r\n\r\nç³»ç»Ÿä¼šè‡ªåŠ¨ç»™ AUTO_INCREMENT ä¿®é¥°çš„åˆ—è¿›è¡Œé€’å¢èµ‹å€¼ï¼Œå®ç°æ–¹å¼ï¼š\r\n\r\n* AUTO_INC é”ï¼šè¡¨çº§é”ï¼Œæ‰§è¡Œæ’å…¥è¯­å¥æ—¶ä¼šè‡ªåŠ¨æ·»åŠ ï¼Œåœ¨è¯¥è¯­å¥æ‰§è¡Œå®Œæˆåé‡Šæ”¾ï¼Œå¹¶ä¸æ˜¯äº‹åŠ¡ç»“æŸ\r\n* è½»é‡çº§é”ï¼šä¸ºæ’å…¥è¯­å¥ç”Ÿæˆ AUTO_INCREMENT ä¿®é¥°çš„åˆ—æ—¶è·å–è¯¥é”ï¼Œç”Ÿæˆä»¥åé‡Šæ”¾æ‰ï¼Œä¸éœ€è¦ç­‰åˆ°æ’å…¥è¯­å¥æ‰§è¡Œå®Œåé‡Šæ”¾\r\n\r\nç³»ç»Ÿå˜é‡ `innodb_autoinc_lock_mode` æ§åˆ¶é‡‡å–å“ªç§æ–¹å¼ï¼š\r\n\r\n* 0ï¼šå…¨éƒ¨é‡‡ç”¨ AUTO_INC é”\r\n* 1ï¼šå…¨éƒ¨é‡‡ç”¨è½»é‡çº§é”\r\n* 2ï¼šæ··åˆä½¿ç”¨ï¼Œåœ¨æ’å…¥è®°å½•çš„æ•°é‡ç¡®å®šæ—¶é‡‡ç”¨è½»é‡çº§é”ï¼Œä¸ç¡®å®šæ—¶é‡‡ç”¨ AUTO_INC é”\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n##### éšå¼é”\r\n\r\nä¸€èˆ¬æƒ…å†µä¸‹ INSERT è¯­å¥æ˜¯ä¸éœ€è¦åœ¨å†…å­˜ä¸­ç”Ÿæˆé”ç»“æ„çš„ï¼Œä¼šè¿›è¡Œéšå¼çš„åŠ é”ï¼Œä¿æŠ¤çš„æ˜¯æ’å…¥åçš„å®‰å…¨\r\n\r\næ³¨æ„ï¼šå¦‚æœæ’å…¥çš„é—´éš™è¢«å…¶ä»–äº‹åŠ¡åŠ äº†é—´éš™é”ï¼Œæ­¤æ¬¡æ’å…¥ä¼šè¢«é˜»å¡ï¼Œå¹¶åœ¨è¯¥é—´éš™æ’å…¥ä¸€ä¸ªæ’å…¥æ„å‘é”\r\n\r\n* èšç°‡ç´¢å¼•ï¼šç´¢å¼•è®°å½•æœ‰ trx_id éšè—åˆ—ï¼Œè¡¨ç¤ºæœ€åæ”¹åŠ¨è¯¥è®°å½•çš„äº‹åŠ¡ idï¼Œæ’å…¥æ•°æ®åäº‹åŠ¡ id å°±æ˜¯å½“å‰äº‹åŠ¡ã€‚å…¶ä»–äº‹åŠ¡æƒ³è·å–è¯¥è®°å½•çš„é”æ—¶ä¼šåˆ¤æ–­å½“å‰è®°å½•çš„äº‹åŠ¡ id æ˜¯å¦æ˜¯æ´»è·ƒçš„ï¼Œå¦‚æœä¸æ˜¯å°±å¯ä»¥æ­£å¸¸åŠ é”ï¼›å¦‚æœæ˜¯å°±åˆ›å»ºä¸€ä¸ª X çš„é”ç»“æ„ï¼Œè¯¥é”çš„ is_waiting æ˜¯ falseï¼Œä¸ºè‡ªå·±çš„äº‹åŠ¡åˆ›å»ºä¸€ä¸ªé”ç»“æ„ï¼Œis_waiting æ˜¯ trueï¼ˆç±»ä¼¼ Java ä¸­çš„é”å‡çº§ï¼‰\r\n* äºŒçº§ç´¢å¼•ï¼šè·å–æ•°æ®é¡µ Page Header ä¸­çš„ PAGE_MAX_TRX_ID å±æ€§ï¼Œä»£è¡¨ä¿®æ”¹å½“å‰é¡µé¢çš„æœ€å¤§çš„äº‹åŠ¡ IDï¼Œå¦‚æœå°äºå½“å‰æ´»è·ƒçš„æœ€å°äº‹åŠ¡ idï¼Œå°±è¯æ˜æ’å…¥è¯¥æ•°æ®çš„äº‹åŠ¡å·²ç»æäº¤ï¼Œå¦åˆ™å°±éœ€è¦è·å–åˆ°ä¸»é”®å€¼è¿›è¡Œå›è¡¨æ“ä½œ\r\n\r\néšå¼é”èµ·åˆ°äº†å»¶è¿Ÿç”Ÿæˆé”çš„æ•ˆæœï¼Œå¦‚æœå…¶ä»–äº‹åŠ¡ä¸éšå¼é”æ²¡æœ‰å†²çªï¼Œå°±å¯ä»¥é¿å…é”ç»“æ„çš„ç”Ÿæˆï¼ŒèŠ‚çœäº†å†…å­˜èµ„æº\r\n\r\nINSERT åœ¨ä¸¤ç§æƒ…å†µä¸‹ä¼šç”Ÿæˆé”ç»“æ„ï¼š\r\n\r\n* é‡å¤é”®ï¼šåœ¨æ’å…¥ä¸»é”®æˆ–å”¯ä¸€äºŒçº§ç´¢å¼•æ—¶é‡åˆ°é‡å¤çš„é”®å€¼ä¼šæŠ¥é”™ï¼Œåœ¨æŠ¥é”™å‰éœ€è¦å¯¹å¯¹åº”çš„èšç°‡ç´¢å¼•è¿›è¡ŒåŠ é”\r\n  * éš”ç¦»çº§åˆ« <= Read Uncommittedï¼ŒåŠ  S å‹ Record Lock\r\n  * éš”ç¦»çº§åˆ« >= Repeatable Readï¼ŒåŠ  S å‹ next_key é”\r\n\r\n* å¤–é”®æ£€æŸ¥ï¼šå¦‚æœå¾…æ’å…¥çš„è®°å½•åœ¨çˆ¶è¡¨ä¸­å¯ä»¥æ‰¾åˆ°ï¼Œä¼šå¯¹çˆ¶è¡¨çš„è®°å½•åŠ  S å‹ Record Lockã€‚å¦‚æœå¾…æ’å…¥çš„è®°å½•åœ¨çˆ¶è¡¨ä¸­æ‰¾ä¸åˆ°\r\n  * éš”ç¦»çº§åˆ« <= Read Committedï¼Œä¸åŠ é”\r\n  * éš”ç¦»çº§åˆ« >= Repeatable Readï¼ŒåŠ é—´éš™é”\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### é”ä¼˜åŒ–\r\n\r\n##### ä¼˜åŒ–é”\r\n\r\nInnoDB å­˜å‚¨å¼•æ“å®ç°äº†è¡Œçº§é”å®šï¼Œè™½ç„¶åœ¨é”å®šæœºåˆ¶çš„å®ç°æ–¹é¢å¸¦æ¥äº†æ€§èƒ½æŸè€—å¯èƒ½æ¯”è¡¨é”ä¼šæ›´é«˜ï¼Œä½†æ˜¯åœ¨æ•´ä½“å¹¶å‘å¤„ç†èƒ½åŠ›æ–¹é¢è¦è¿œè¿œä¼˜äº MyISAM çš„è¡¨é”ï¼Œå½“ç³»ç»Ÿå¹¶å‘é‡è¾ƒé«˜çš„æ—¶å€™ï¼ŒInnoDB çš„æ•´ä½“æ€§èƒ½è¿œè¿œå¥½äº MyISAM\r\n\r\nä½†æ˜¯ä½¿ç”¨ä¸å½“å¯èƒ½ä¼šè®© InnoDB çš„æ•´ä½“æ€§èƒ½è¡¨ç°ä¸ä»…ä¸èƒ½æ¯” MyISAM é«˜ï¼Œç”šè‡³å¯èƒ½ä¼šæ›´å·®\r\n\r\nä¼˜åŒ–å»ºè®®ï¼š\r\n\r\n- å°½å¯èƒ½è®©æ‰€æœ‰æ•°æ®æ£€ç´¢éƒ½èƒ½é€šè¿‡ç´¢å¼•æ¥å®Œæˆï¼Œé¿å…æ— ç´¢å¼•è¡Œé”å‡çº§ä¸ºè¡¨é”\r\n- åˆç†è®¾è®¡ç´¢å¼•ï¼Œå°½é‡ç¼©å°é”çš„èŒƒå›´\r\n- å°½å¯èƒ½å‡å°‘ç´¢å¼•æ¡ä»¶åŠç´¢å¼•èŒƒå›´ï¼Œé¿å…é—´éš™é”\r\n- å°½é‡æ§åˆ¶äº‹åŠ¡å¤§å°ï¼Œå‡å°‘é”å®šèµ„æºé‡å’Œæ—¶é—´é•¿åº¦\r\n- å°½å¯ä½¿ç”¨ä½çº§åˆ«äº‹åŠ¡éš”ç¦»ï¼ˆéœ€è¦ä¸šåŠ¡å±‚é¢æ»¡è¶³éœ€æ±‚ï¼‰\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n##### é”å‡çº§\r\n\r\nç´¢å¼•å¤±æ•ˆé€ æˆ**è¡Œé”å‡çº§ä¸ºè¡¨é”**ï¼Œä¸é€šè¿‡ç´¢å¼•æ£€ç´¢æ•°æ®ï¼Œå…¨å±€æ‰«æçš„è¿‡ç¨‹ä¸­ InnoDB ä¼šå°†å¯¹è¡¨ä¸­çš„æ‰€æœ‰è®°å½•åŠ é”ï¼Œå®é™…æ•ˆæœå’Œ**è¡¨é”**ä¸€æ ·ï¼Œå®é™…å¼€å‘è¿‡ç¨‹åº”é¿å…å‡ºç°ç´¢å¼•å¤±æ•ˆçš„çŠ¶å†µ\r\n\r\n* æŸ¥çœ‹å½“å‰è¡¨çš„ç´¢å¼•ï¼š\r\n\r\n  ```sql\r\n  SHOW INDEX FROM test_innodb_lock;\r\n  ```\r\n\r\n* å…³é—­è‡ªåŠ¨æäº¤åŠŸèƒ½ï¼š\r\n\r\n  ```sql\r\n  SET AUTOCOMMIT=0;\t-- C1ã€C2\r\n  ```\r\n\r\n* æ‰§è¡Œæ›´æ–°è¯­å¥ï¼š\r\n\r\n  ```sql\r\n  UPDATE test_innodb_lock SET sex='2' WHERE name=10;\t-- C1\r\n  UPDATE test_innodb_lock SET sex='2' WHERE id=3;\t\t-- C2\r\n  ```\r\n\r\n  ![image-20250320012637282](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012637282.png)\r\n\r\n  ç´¢å¼•å¤±æ•ˆï¼šæ‰§è¡Œæ›´æ–°æ—¶ name å­—æ®µä¸º varchar ç±»å‹ï¼Œé€ æˆç´¢å¼•å¤±æ•ˆï¼Œæœ€ç»ˆè¡Œé”å˜ä¸ºè¡¨é” \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ­»é”\r\n\r\nä¸åŒäº‹åŠ¡ç”±äºäº’ç›¸æŒæœ‰å¯¹æ–¹éœ€è¦çš„é”è€Œå¯¼è‡´äº‹åŠ¡éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œçš„æƒ…å†µç§°ä¸ºæ­»é”\r\n\r\næ­»é”æƒ…å†µï¼šçº¿ç¨‹ A ä¿®æ”¹äº† id = 1 çš„æ•°æ®ï¼Œè¯·æ±‚ä¿®æ”¹ id = 2 çš„æ•°æ®ï¼Œçº¿ç¨‹ B ä¿®æ”¹äº† id = 2 çš„æ•°æ®ï¼Œè¯·æ±‚ä¿®æ”¹ id = 1 çš„æ•°æ®ï¼Œäº§ç”Ÿæ­»é”\r\n\r\nè§£å†³ç­–ç•¥ï¼š\r\n\r\n* ç›´æ¥è¿›å…¥ç­‰å¾…ç›´åˆ°è¶…æ—¶ï¼Œè¶…æ—¶æ—¶é—´å¯ä»¥é€šè¿‡å‚æ•° innodb_lock_wait_timeout æ¥è®¾ç½®ï¼Œé»˜è®¤ 50 ç§’ï¼Œä½†æ˜¯æ—¶é—´çš„è®¾ç½®ä¸å¥½æ§åˆ¶ï¼Œè¶…æ—¶å¯èƒ½ä¸æ˜¯å› ä¸ºæ­»é”ï¼Œè€Œæ˜¯å› ä¸ºäº‹åŠ¡å¤„ç†æ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸é‡‡å–è¯¥æ–¹å¼\r\n\r\n* ä¸»åŠ¨æ­»é”æ£€æµ‹ï¼Œå‘ç°æ­»é”å**ä¸»åŠ¨å›æ»šæ­»é”é“¾æ¡ä¸­è¾ƒå°çš„ä¸€ä¸ªäº‹åŠ¡**ï¼Œè®©å…¶ä»–äº‹åŠ¡å¾—ä»¥ç»§ç»­æ‰§è¡Œï¼Œå°†å‚æ•° `innodb_deadlock_detect` è®¾ç½®ä¸º onï¼Œè¡¨ç¤ºå¼€å¯è¯¥åŠŸèƒ½ï¼ˆäº‹åŠ¡è¾ƒå°çš„æ„æ€å°±æ˜¯äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ’å…¥ã€åˆ é™¤ã€æ›´æ–°çš„è®°å½•æ¡æ•°ï¼‰\r\n\r\n  æ­»é”æ£€æµ‹å¹¶ä¸æ˜¯æ¯ä¸ªè¯­å¥éƒ½è¦æ£€æµ‹ï¼Œåªæœ‰åœ¨åŠ é”è®¿é—®çš„è¡Œä¸Šå·²ç»æœ‰é”æ—¶ï¼Œå½“å‰äº‹åŠ¡è¢«é˜»å¡äº†æ‰ä¼šæ£€æµ‹ï¼Œä¹Ÿæ˜¯ä»å½“å‰äº‹åŠ¡å¼€å§‹è¿›è¡Œæ£€æµ‹\r\n\r\né€šè¿‡æ‰§è¡Œ `SHOW ENGINE INNODB STATUS` å¯ä»¥æŸ¥çœ‹æœ€è¿‘å‘ç”Ÿçš„ä¸€æ¬¡æ­»å¾ªç¯ï¼Œå…¨å±€ç³»ç»Ÿå˜é‡ `innodb_print_all_deadlocks` è®¾ç½®ä¸º onï¼Œå°±å¯ä»¥å°†æ¯ä¸ªæ­»é”ä¿¡æ¯éƒ½è®°å½•åœ¨ MySQL é”™è¯¯æ—¥å¿—ä¸­\r\n\r\næ­»é”ä¸€èˆ¬æ˜¯è¡Œçº§é”ï¼Œå½“è¡¨é”å‘ç”Ÿæ­»é”æ—¶ï¼Œä¼šåœ¨äº‹åŠ¡ä¸­è®¿é—®å…¶ä»–è¡¨æ—¶**ç›´æ¥æŠ¥é”™**ï¼Œç ´åäº†æŒæœ‰å¹¶ç­‰å¾…çš„æ­»é”æ¡ä»¶\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### é”çŠ¶æ€\r\n\r\næŸ¥çœ‹é”ä¿¡æ¯\r\n\r\n```sql\r\nSHOW STATUS LIKE 'innodb_row_lock%';\r\n```\r\n\r\n![image-20250320012702739](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012702739.png)\r\n\r\nå‚æ•°è¯´æ˜ï¼š\r\n\r\n* Innodb_row_lock_current_waitsï¼šå½“å‰æ­£åœ¨ç­‰å¾…é”å®šçš„æ•°é‡\r\n\r\n* Innodb_row_lock_timeï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨é”å®šæ€»æ—¶é—´é•¿åº¦\r\n\r\n* Innodb_row_lock_time_avgï¼šæ¯æ¬¡ç­‰å¾…æ‰€èŠ±å¹³å‡æ—¶é•¿\r\n\r\n* Innodb_row_lock_time_maxï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨ç­‰å¾…æœ€é•¿çš„ä¸€æ¬¡æ‰€èŠ±çš„æ—¶é—´\r\n\r\n* Innodb_row_lock_waitsï¼šç³»ç»Ÿå¯åŠ¨ååˆ°ç°åœ¨æ€»å…±ç­‰å¾…çš„æ¬¡æ•°\r\n\r\nå½“ç­‰å¾…çš„æ¬¡æ•°å¾ˆé«˜ï¼Œè€Œä¸”æ¯æ¬¡ç­‰å¾…çš„æ—¶é•¿ä¹Ÿä¸çŸ­çš„æ—¶å€™ï¼Œå°±éœ€è¦åˆ†æç³»ç»Ÿä¸­ä¸ºä»€ä¹ˆä¼šæœ‰å¦‚æ­¤å¤šçš„ç­‰å¾…ï¼Œç„¶åæ ¹æ®åˆ†æç»“æœåˆ¶å®šä¼˜åŒ–è®¡åˆ’\r\n\r\næŸ¥çœ‹é”çŠ¶æ€ï¼š\r\n\r\n```sql\r\nSELECT * FROM information_schema.innodb_locks;\t#é”çš„æ¦‚å†µ\r\nSHOW ENGINE INNODB STATUS\\G; #InnoDBæ•´ä½“çŠ¶æ€ï¼Œå…¶ä¸­åŒ…æ‹¬é”çš„æƒ…å†µ\r\n```\r\n\r\n![image-20250320012717199](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012717199.png)\r\n\r\nlock_id æ˜¯é” idï¼›lock_trx_id ä¸ºäº‹åŠ¡ idï¼›lock_mode ä¸º X ä»£è¡¨æ’å®ƒé”ï¼ˆå†™é”ï¼‰ï¼›lock_type ä¸º RECORD ä»£è¡¨é”ä¸ºè¡Œé”ï¼ˆè®°å½•é”ï¼‰\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ä¹è§‚é”\r\n\r\næ‚²è§‚é”ï¼šåœ¨æ•´ä¸ªæ•°æ®å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå°†æ•°æ®å¤„äºé”å®šçŠ¶æ€ï¼Œä¸ºäº†ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œå°±éœ€è¦ä¸€è‡´æ€§é”å®šè¯»ã€‚è¯»å–æ•°æ®æ—¶ç»™åŠ é”ï¼Œå…¶å®ƒäº‹åŠ¡æ— æ³•ä¿®æ”¹è¿™äº›æ•°æ®ï¼Œä¿®æ”¹åˆ é™¤æ•°æ®æ—¶ä¹ŸåŠ é”ï¼Œå…¶å®ƒäº‹åŠ¡åŒæ ·æ— æ³•è¯»å–è¿™äº›æ•°æ®\r\n\r\næ‚²è§‚é”å’Œä¹è§‚é”ä½¿ç”¨å‰æï¼š\r\n\r\n- å¯¹äºè¯»çš„æ“ä½œè¿œå¤šäºå†™çš„æ“ä½œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ›´æ–°æ“ä½œåŠ é”ä¼šé˜»å¡æ‰€æœ‰çš„è¯»å–æ“ä½œï¼Œé™ä½äº†ååé‡ï¼Œæœ€åéœ€è¦é‡Šæ”¾é”ï¼Œé”æ˜¯éœ€è¦ä¸€äº›å¼€é”€çš„ï¼Œè¿™æ—¶å€™å¯ä»¥é€‰æ‹©ä¹è§‚é”\r\n- å¦‚æœæ˜¯è¯»å†™æ¯”ä¾‹å·®è·ä¸æ˜¯éå¸¸å¤§æˆ–è€…ç³»ç»Ÿæ²¡æœ‰å“åº”ä¸åŠæ—¶ï¼Œååé‡ç“¶é¢ˆçš„é—®é¢˜ï¼Œé‚£å°±ä¸è¦å»ä½¿ç”¨ä¹è§‚é”ï¼Œå®ƒå¢åŠ äº†å¤æ‚åº¦ï¼Œä¹Ÿå¸¦æ¥äº†ä¸šåŠ¡é¢å¤–çš„é£é™©ï¼Œè¿™æ—¶å€™å¯ä»¥é€‰æ‹©æ‚²è§‚é”\r\n\r\nä¹è§‚é”çš„å®ç°æ–¹å¼ï¼šå°±æ˜¯ CASï¼Œæ¯”è¾ƒå¹¶äº¤æ¢\r\n\r\n* ç‰ˆæœ¬å·\r\n\r\n  1. ç»™æ•°æ®è¡¨ä¸­æ·»åŠ ä¸€ä¸ª version åˆ—ï¼Œæ¯æ¬¡æ›´æ–°åéƒ½å°†è¿™ä¸ªåˆ—çš„å€¼åŠ  1\r\n\r\n  2. è¯»å–æ•°æ®æ—¶ï¼Œå°†ç‰ˆæœ¬å·è¯»å–å‡ºæ¥ï¼Œåœ¨æ‰§è¡Œæ›´æ–°çš„æ—¶å€™ï¼Œæ¯”è¾ƒç‰ˆæœ¬å·\r\n\r\n  3. å¦‚æœç›¸åŒåˆ™æ‰§è¡Œæ›´æ–°ï¼Œå¦‚æœä¸ç›¸åŒï¼Œè¯´æ˜æ­¤æ¡æ•°æ®å·²ç»å‘ç”Ÿäº†å˜åŒ–\r\n\r\n  4. ç”¨æˆ·è‡ªè¡Œæ ¹æ®è¿™ä¸ªé€šçŸ¥æ¥å†³å®šæ€ä¹ˆå¤„ç†ï¼Œæ¯”å¦‚é‡æ–°å¼€å§‹ä¸€éï¼Œæˆ–è€…æ”¾å¼ƒæœ¬æ¬¡æ›´æ–°\r\n\r\n     ```sql\r\n     -- åˆ›å»ºcityè¡¨\r\n     CREATE TABLE city(\r\n     \tid INT PRIMARY KEY AUTO_INCREMENT,  -- åŸå¸‚id\r\n     \tNAME VARCHAR(20),                   -- åŸå¸‚åç§°\r\n     \tVERSION INT                         -- ç‰ˆæœ¬å·\r\n     );\r\n     \r\n     -- æ·»åŠ æ•°æ®\r\n     INSERT INTO city VALUES (NULL,'åŒ—äº¬',1),(NULL,'ä¸Šæµ·',1),(NULL,'å¹¿å·',1),(NULL,'æ·±åœ³',1);\r\n     \r\n     -- ä¿®æ”¹åŒ—äº¬ä¸ºåŒ—äº¬å¸‚\r\n     -- 1.æŸ¥è¯¢åŒ—äº¬çš„version\r\n     SELECT VERSION FROM city WHERE NAME='åŒ—äº¬';\r\n     -- 2.ä¿®æ”¹åŒ—äº¬ä¸ºåŒ—äº¬å¸‚ï¼Œç‰ˆæœ¬å·+1ã€‚å¹¶å¯¹æ¯”ç‰ˆæœ¬å·\r\n     UPDATE city SET NAME='åŒ—äº¬å¸‚',VERSION=VERSION+1 WHERE NAME='åŒ—äº¬' AND VERSION=1;\r\n     ```\r\n\r\n* æ—¶é—´æˆ³\r\n\r\n  - å’Œç‰ˆæœ¬å·æ–¹å¼åŸºæœ¬ä¸€æ ·ï¼Œç»™æ•°æ®è¡¨ä¸­æ·»åŠ ä¸€ä¸ªåˆ—ï¼Œåç§°æ— æ‰€è°“ï¼Œæ•°æ®ç±»å‹éœ€è¦æ˜¯ **timestamp**\r\n  - æ¯æ¬¡æ›´æ–°åéƒ½å°†æœ€æ–°æ—¶é—´æ’å…¥åˆ°æ­¤åˆ—\r\n  - è¯»å–æ•°æ®æ—¶ï¼Œå°†æ—¶é—´è¯»å–å‡ºæ¥ï¼Œåœ¨æ‰§è¡Œæ›´æ–°çš„æ—¶å€™ï¼Œæ¯”è¾ƒæ—¶é—´\r\n  - å¦‚æœç›¸åŒåˆ™æ‰§è¡Œæ›´æ–°ï¼Œå¦‚æœä¸ç›¸åŒï¼Œè¯´æ˜æ­¤æ¡æ•°æ®å·²ç»å‘ç”Ÿäº†å˜åŒ–\r\n\r\nä¹è§‚é”çš„å¼‚å¸¸æƒ…å†µï¼šå¦‚æœ version è¢«å…¶ä»–äº‹åŠ¡æŠ¢å…ˆæ›´æ–°ï¼Œåˆ™åœ¨å½“å‰äº‹åŠ¡ä¸­æ›´æ–°å¤±è´¥ï¼Œtrx_id æ²¡æœ‰å˜æˆå½“å‰äº‹åŠ¡çš„ IDï¼Œå½“å‰äº‹åŠ¡å†æ¬¡æŸ¥è¯¢è¿˜æ˜¯æ—§å€¼ï¼Œå°±ä¼šå‡ºç°**å€¼æ²¡å˜ä½†æ˜¯æ›´æ–°ä¸äº†**çš„ç°è±¡ï¼ˆanomalyï¼‰\r\n\r\nè§£å†³æ–¹æ¡ˆï¼šæ¯æ¬¡ CAS æ›´æ–°ä¸ç®¡æˆåŠŸå¤±è´¥ï¼Œå°±ç»“æŸå½“å‰äº‹åŠ¡ï¼›å¦‚æœå¤±è´¥åˆ™é‡æ–°èµ·ä¸€ä¸ªäº‹åŠ¡è¿›è¡ŒæŸ¥è¯¢æ›´æ–°\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"MySQL - æ—¥å¿—","tags":["SQL"],"categories":["MySQL","æ—¥å¿—ç¯‡"],"author":"imklaus","excerpt":"\r\n### æ—¥å¿—åˆ†ç±»\r\n\r\nåœ¨ä»»ä½•ä¸€ç§æ•°æ®åº“ä¸­ï¼Œéƒ½ä¼šæœ‰å„ç§å„æ ·çš„æ—¥å¿—ï¼Œè®°å½•ç€æ•°æ®åº“å·¥ä½œçš„è¿‡ç¨‹ï¼Œå¯ä»¥å¸®åŠ©æ•°æ®åº“ç®¡ç†å‘˜è¿½è¸ªæ•°æ®åº“æ›¾ç»å‘ç”Ÿè¿‡çš„å„ç§äº‹ä»¶\r\n\r\nMySQLæ—¥å¿—ä¸»è¦åŒ…æ‹¬å…­ç§ï¼š\r\n\r\n1. é‡åšæ—¥å¿—ï¼ˆredo logï¼‰\r\n2. å›æ»šæ—¥å¿—ï¼ˆundo logï¼‰\r\n3. å½’æ¡£æ—¥å¿—ï¼ˆbinlogï¼‰ï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰\r\n4. é”™è¯¯æ—¥å¿—ï¼ˆerrorlogï¼‰\r\n5. æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆslow query logï¼‰\r\n6. ä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—ï¼ˆgeneral logï¼‰\r\n7. ä¸­ç»§æ—¥å¿—ï¼ˆrelay logï¼‰\r\n\r\n","link":"/posts/MySQL_Log","content":"\r\n### æ—¥å¿—åˆ†ç±»\r\n\r\nåœ¨ä»»ä½•ä¸€ç§æ•°æ®åº“ä¸­ï¼Œéƒ½ä¼šæœ‰å„ç§å„æ ·çš„æ—¥å¿—ï¼Œè®°å½•ç€æ•°æ®åº“å·¥ä½œçš„è¿‡ç¨‹ï¼Œå¯ä»¥å¸®åŠ©æ•°æ®åº“ç®¡ç†å‘˜è¿½è¸ªæ•°æ®åº“æ›¾ç»å‘ç”Ÿè¿‡çš„å„ç§äº‹ä»¶\r\n\r\nMySQLæ—¥å¿—ä¸»è¦åŒ…æ‹¬å…­ç§ï¼š\r\n\r\n1. é‡åšæ—¥å¿—ï¼ˆredo logï¼‰\r\n2. å›æ»šæ—¥å¿—ï¼ˆundo logï¼‰\r\n3. å½’æ¡£æ—¥å¿—ï¼ˆbinlogï¼‰ï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰\r\n4. é”™è¯¯æ—¥å¿—ï¼ˆerrorlogï¼‰\r\n5. æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆslow query logï¼‰\r\n6. ä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—ï¼ˆgeneral logï¼‰\r\n7. ä¸­ç»§æ—¥å¿—ï¼ˆrelay logï¼‰\r\n\r\n<!-- more -->\r\n\r\n***\r\n\r\n\r\n\r\n### é”™è¯¯æ—¥å¿—\r\n\r\né”™è¯¯æ—¥å¿—æ˜¯ MySQL ä¸­æœ€é‡è¦çš„æ—¥å¿—ä¹‹ä¸€ï¼Œè®°å½•äº†å½“ mysqld å¯åŠ¨å’Œåœæ­¢æ—¶ï¼Œä»¥åŠæœåŠ¡å™¨åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿä»»ä½•ä¸¥é‡é”™è¯¯æ—¶çš„ç›¸å…³ä¿¡æ¯ã€‚å½“æ•°æ®åº“å‡ºç°ä»»ä½•æ•…éšœå¯¼è‡´æ— æ³•æ­£å¸¸ä½¿ç”¨æ—¶ï¼Œå¯ä»¥é¦–å…ˆæŸ¥çœ‹æ­¤æ—¥å¿—\r\n\r\nè¯¥æ—¥å¿—æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œé»˜è®¤ä½ç½®æ˜¯ï¼š`/var/log/mysql/error.log`\r\n\r\næŸ¥çœ‹æŒ‡ä»¤ï¼š\r\n\r\n```sql\r\nSHOW VARIABLES LIKE 'log_error%';\r\n```\r\n\r\næŸ¥çœ‹æ—¥å¿—å†…å®¹ï¼š\r\n\r\n```sh\r\ntail -f /var/log/mysql/error.log\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å½’æ¡£æ—¥å¿—\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\nå½’æ¡£æ—¥å¿—ï¼ˆBINLOGï¼‰ä¹Ÿå«äºŒè¿›åˆ¶æ—¥å¿—ï¼Œæ˜¯å› ä¸ºé‡‡ç”¨äºŒè¿›åˆ¶è¿›è¡Œå­˜å‚¨ï¼Œè®°å½•äº†æ‰€æœ‰çš„ DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰è¯­å¥å’Œ DMLï¼ˆæ•°æ®æ“ä½œè¯­è¨€ï¼‰è¯­å¥ï¼Œä½†**ä¸åŒ…æ‹¬æ•°æ®æŸ¥è¯¢è¯­å¥ï¼Œåœ¨äº‹åŠ¡æäº¤å‰çš„æœ€åé˜¶æ®µå†™å…¥**\r\n\r\nä½œç”¨ï¼š**ç¾éš¾æ—¶çš„æ•°æ®æ¢å¤å’Œ MySQL çš„ä¸»ä»å¤åˆ¶**\r\n\r\nå½’æ¡£æ—¥å¿—é»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡æœ‰å¼€å¯çš„ï¼Œéœ€è¦åœ¨ MySQL é…ç½®æ–‡ä»¶ä¸­å¼€å¯ï¼Œå¹¶é…ç½® MySQL æ—¥å¿—çš„æ ¼å¼ï¼š\r\n\r\n```sh\r\ncd /etc/mysql\r\nvim my.cnf\r\n\r\n# é…ç½®å¼€å¯binlogæ—¥å¿—ï¼Œ æ—¥å¿—çš„æ–‡ä»¶å‰ç¼€ä¸º mysqlbin -----> ç”Ÿæˆçš„æ–‡ä»¶åå¦‚: mysqlbin.000001\r\nlog_bin=mysqlbin\r\n# é…ç½®äºŒè¿›åˆ¶æ—¥å¿—çš„æ ¼å¼\r\nbinlog_format=STATEMENT\r\n```\r\n\r\næ—¥å¿—å­˜æ”¾ä½ç½®ï¼šé…ç½®æ—¶ç»™å®šäº†æ–‡ä»¶åä½†æ˜¯æ²¡æœ‰æŒ‡å®šè·¯å¾„ï¼Œæ—¥å¿—é»˜è®¤å†™å…¥MySQL çš„æ•°æ®ç›®å½•\r\n\r\næ—¥å¿—æ ¼å¼ï¼š\r\n\r\n* STATEMENTï¼šè¯¥æ—¥å¿—æ ¼å¼åœ¨æ—¥å¿—æ–‡ä»¶ä¸­è®°å½•çš„éƒ½æ˜¯ **SQL è¯­å¥**ï¼Œæ¯ä¸€æ¡å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„ SQL éƒ½ä¼šè®°å½•åœ¨æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ mysqlbinlog å·¥å…·ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°æ¯æ¡è¯­å¥çš„æ–‡æœ¬ã€‚ä¸»ä»å¤åˆ¶æ—¶ï¼Œä»åº“ä¼šå°†æ—¥å¿—è§£æä¸ºåŸè¯­å¥ï¼Œå¹¶åœ¨ä»åº“é‡æ–°æ‰§è¡Œä¸€é\r\n\r\n  ç¼ºç‚¹ï¼šå¯èƒ½ä¼šå¯¼è‡´ä¸»å¤‡ä¸ä¸€è‡´ï¼Œå› ä¸ºè®°å½•çš„ SQL åœ¨ä¸åŒçš„ç¯å¢ƒä¸­å¯èƒ½é€‰æ‹©çš„ç´¢å¼•ä¸åŒï¼Œå¯¼è‡´ç»“æœä¸åŒ\r\n\r\n* ROWï¼šè¯¥æ—¥å¿—æ ¼å¼åœ¨æ—¥å¿—æ–‡ä»¶ä¸­è®°å½•çš„æ˜¯æ¯ä¸€è¡Œçš„**æ•°æ®å˜æ›´**ï¼Œè€Œä¸æ˜¯è®°å½• SQL è¯­å¥ã€‚æ¯”å¦‚æ‰§è¡Œ SQL è¯­å¥ `update tb_book set status='1'`ï¼Œå¦‚æœæ˜¯ STATEMENTï¼Œåœ¨æ—¥å¿—ä¸­ä¼šè®°å½•ä¸€è¡Œ SQL è¯­å¥ï¼› å¦‚æœæ˜¯ ROWï¼Œç”±äºæ˜¯å¯¹å…¨è¡¨è¿›è¡Œæ›´æ–°ï¼Œå°±æ˜¯æ¯ä¸€è¡Œè®°å½•éƒ½ä¼šå‘ç”Ÿå˜æ›´ï¼ŒROW æ ¼å¼çš„æ—¥å¿—ä¸­ä¼šè®°å½•æ¯ä¸€è¡Œçš„æ•°æ®å˜æ›´\r\n\r\n  ç¼ºç‚¹ï¼šè®°å½•çš„æ•°æ®æ¯”è¾ƒå¤šï¼Œå ç”¨å¾ˆå¤šçš„å­˜å‚¨ç©ºé—´\r\n\r\n* MIXEDï¼šè¿™æ˜¯ MySQL é»˜è®¤çš„æ—¥å¿—æ ¼å¼ï¼Œæ··åˆäº†STATEMENT å’Œ ROW ä¸¤ç§æ ¼å¼ï¼ŒMIXED æ ¼å¼èƒ½å°½é‡åˆ©ç”¨ä¸¤ç§æ¨¡å¼çš„ä¼˜ç‚¹ï¼Œè€Œé¿å¼€å®ƒä»¬çš„ç¼ºç‚¹\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æ—¥å¿—åˆ·ç›˜\r\n\r\näº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…ˆå°†æ—¥å¿—å†™ï¼ˆwriteï¼‰åˆ° binlog cacheï¼Œäº‹åŠ¡æäº¤æ—¶å†æŠŠ binlog cache å†™ï¼ˆfsyncï¼‰åˆ° binlog æ–‡ä»¶ä¸­ï¼Œä¸€ä¸ªäº‹åŠ¡çš„ binlog æ˜¯ä¸èƒ½è¢«æ‹†å¼€çš„ï¼Œæ‰€ä»¥ä¸è®ºè¿™ä¸ªäº‹åŠ¡å¤šå¤§ä¹Ÿè¦ç¡®ä¿ä¸€æ¬¡æ€§å†™å…¥\r\n\r\näº‹åŠ¡æäº¤æ—¶æ‰§è¡Œå™¨æŠŠ binlog cache é‡Œçš„å®Œæ•´äº‹åŠ¡å†™å…¥åˆ° binlog ä¸­ï¼Œå¹¶æ¸…ç©º binlog cache\r\n\r\nwrite å’Œ fsync çš„æ—¶æœºç”±å‚æ•° sync_binlog æ§åˆ¶çš„ï¼š\r\n\r\n* sync_binlog=0ï¼šè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½åª writeï¼Œä¸ fsync\r\n* sync_binlog=1ï¼šè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¼šæ‰§è¡Œ fsync\r\n* sync_binlog=N(N>1)ï¼šè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ writeï¼Œä½†ç´¯ç§¯ N ä¸ªäº‹åŠ¡åæ‰ fsyncï¼Œä½†æ˜¯å¦‚æœä¸»æœºå‘ç”Ÿå¼‚å¸¸é‡å¯ï¼Œä¼šä¸¢å¤±æœ€è¿‘ N ä¸ªäº‹åŠ¡çš„ binlog æ—¥å¿—\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æ—¥å¿—è¯»å–\r\n\r\næ—¥å¿—æ–‡ä»¶å­˜å‚¨ä½ç½®ï¼š/var/lib/mysql\r\n\r\nç”±äºæ—¥å¿—ä»¥äºŒè¿›åˆ¶æ–¹å¼å­˜å‚¨ï¼Œä¸èƒ½ç›´æ¥è¯»å–ï¼Œéœ€è¦ç”¨ mysqlbinlog å·¥å…·æ¥æŸ¥çœ‹ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š\r\n\r\n```sh\r\nmysqlbinlog log-file;\r\n```\r\n\r\næŸ¥çœ‹ STATEMENT æ ¼å¼æ—¥å¿—ï¼š\r\n\r\n* æ‰§è¡Œæ’å…¥è¯­å¥ï¼š\r\n\r\n  ```sql\r\n  INSERT INTO tb_book VALUES(NULL,'Lucene','2088-05-01','0');\r\n  ```\r\n\r\n* `cd /var/lib/mysql`ï¼š\r\n\r\n  ```sh\r\n  -rw-r-----  1 mysql mysql      177 5æœˆ  23 21:08 mysqlbin.000001\r\n  -rw-r-----  1 mysql mysql       18 5æœˆ  23 21:04 mysqlbin.index\r\n  ```\r\n\r\n  mysqlbin.indexï¼šè¯¥æ–‡ä»¶æ˜¯æ—¥å¿—ç´¢å¼•æ–‡ä»¶ ï¼Œ è®°å½•æ—¥å¿—çš„æ–‡ä»¶åï¼›\r\n\r\n  mysqlbing.000001ï¼šæ—¥å¿—æ–‡ä»¶\r\n\r\n* æŸ¥çœ‹æ—¥å¿—å†…å®¹ï¼š\r\n\r\n  ```sh\r\n  mysqlbinlog mysqlbing.000001;\r\n  ```\r\n\r\n  ![image-20250320013217813](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013217813.png)\r\n\r\n  æ—¥å¿—ç»“å°¾æœ‰ COMMIT\r\n\r\næŸ¥çœ‹ ROW æ ¼å¼æ—¥å¿—ï¼š\r\n\r\n* ä¿®æ”¹é…ç½®ï¼š\r\n\r\n  ```sh\r\n  # é…ç½®äºŒè¿›åˆ¶æ—¥å¿—çš„æ ¼å¼\r\n  binlog_format=ROW\r\n  ```\r\n\r\n* æ’å…¥æ•°æ®ï¼š\r\n\r\n  ```sql\r\n  INSERT INTO tb_book VALUES(NULL,'SpringCloudå®æˆ˜','2088-05-05','0');\r\n  ```\r\n\r\n* æŸ¥çœ‹æ—¥å¿—å†…å®¹ï¼šæ—¥å¿—æ ¼å¼ ROWï¼Œç›´æ¥æŸ¥çœ‹æ•°æ®æ˜¯ä¹±ç ï¼Œå¯ä»¥åœ¨ mysqlbinlog åé¢åŠ ä¸Šå‚æ•° -vv \r\n\r\n  ```sql\r\n  mysqlbinlog -vv mysqlbin.000002\r\n  ```\r\n\r\n  ![image-20250320013258023](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013258023.png)\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æ—¥å¿—åˆ é™¤\r\n\r\nå¯¹äºæ¯”è¾ƒç¹å¿™çš„ç³»ç»Ÿï¼Œç”Ÿæˆæ—¥å¿—é‡å¤§ï¼Œè¿™äº›æ—¥å¿—å¦‚æœé•¿æ—¶é—´ä¸æ¸…é™¤ï¼Œå°†ä¼šå ç”¨å¤§é‡çš„ç£ç›˜ç©ºé—´ï¼Œéœ€è¦åˆ é™¤æ—¥å¿—\r\n\r\n* Reset Master æŒ‡ä»¤åˆ é™¤å…¨éƒ¨ binlog æ—¥å¿—ï¼Œåˆ é™¤ä¹‹åï¼Œæ—¥å¿—ç¼–å·å°†ä» xxxx.000001é‡æ–°å¼€å§‹\r\n\r\n  ```sql\r\n  Reset Master\t-- MySQLæŒ‡ä»¤\r\n  ```\r\n\r\n* æ‰§è¡ŒæŒ‡ä»¤ `PURGE MASTER LOGS TO 'mysqlbin.***`ï¼Œè¯¥å‘½ä»¤å°†åˆ é™¤ ` ***` ç¼–å·ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—\r\n\r\n* æ‰§è¡ŒæŒ‡ä»¤ `PURGE MASTER LOGS BEFORE 'yyyy-mm-dd hh:mm:ss'` ï¼Œè¯¥å‘½ä»¤å°†åˆ é™¤æ—¥å¿—ä¸º `yyyy-mm-dd hh:mm:ss` ä¹‹å‰äº§ç”Ÿçš„æ—¥å¿—\r\n\r\n* è®¾ç½®å‚æ•° `--expire_logs_days=#`ï¼Œæ­¤å‚æ•°çš„å«ä¹‰æ˜¯è®¾ç½®æ—¥å¿—çš„è¿‡æœŸå¤©æ•°ï¼Œè¿‡äº†æŒ‡å®šçš„å¤©æ•°åæ—¥å¿—å°†ä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼Œè¿™æ ·åšæœ‰åˆ©äºå‡å°‘ç®¡ç†æ—¥å¿—çš„å·¥ä½œé‡ï¼Œé…ç½® my.cnf æ–‡ä»¶ï¼š\r\n\r\n  ```sh\r\n  log_bin=mysqlbin\r\n  binlog_format=ROW\r\n  --expire_logs_days=3\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### æ•°æ®æ¢å¤\r\n\r\nè¯¯åˆ åº“æˆ–è€…è¡¨æ—¶ï¼Œéœ€è¦æ ¹æ® binlog è¿›è¡Œæ•°æ®æ¢å¤\r\n\r\nä¸€èˆ¬æƒ…å†µä¸‹æ•°æ®åº“æœ‰å®šæ—¶çš„å…¨é‡å¤‡ä»½ï¼Œå‡å¦‚æ¯å¤© 0 ç‚¹å®šæ—¶å¤‡ä»½ï¼Œ12 ç‚¹è¯¯åˆ äº†åº“ï¼Œæ¢å¤æµç¨‹ï¼š\r\n\r\n* å–æœ€è¿‘ä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼Œç”¨å¤‡ä»½æ¢å¤å‡ºä¸€ä¸ªä¸´æ—¶åº“\r\n* ä»æ—¥å¿—æ–‡ä»¶ä¸­å–å‡ºå‡Œæ™¨ 0 ç‚¹ä¹‹åçš„æ—¥å¿—\r\n* æŠŠé™¤äº†è¯¯åˆ é™¤æ•°æ®çš„è¯­å¥å¤–æ—¥å¿—ï¼Œå…¨éƒ¨åº”ç”¨åˆ°ä¸´æ—¶åº“\r\n\r\nè·³è¿‡è¯¯åˆ é™¤è¯­å¥æ—¥å¿—çš„æ–¹æ³•ï¼š\r\n\r\n* å¦‚æœåŸå®ä¾‹æ²¡æœ‰ä½¿ç”¨ GTID æ¨¡å¼ï¼Œåªèƒ½åœ¨åº”ç”¨åˆ°åŒ…å« 12 ç‚¹çš„ binlog æ–‡ä»¶çš„æ—¶å€™ï¼Œå…ˆç”¨ â€“stop-position å‚æ•°æ‰§è¡Œåˆ°è¯¯æ“ä½œä¹‹å‰çš„æ—¥å¿—ï¼Œç„¶åå†ç”¨ â€“start-position ä»è¯¯æ“ä½œä¹‹åçš„æ—¥å¿—ç»§ç»­æ‰§è¡Œ\r\n* å¦‚æœå®ä¾‹ä½¿ç”¨äº† GTID æ¨¡å¼ï¼Œå‡è®¾è¯¯æ“ä½œå‘½ä»¤çš„ GTID æ˜¯ gtid1ï¼Œé‚£ä¹ˆåªéœ€è¦æäº¤ä¸€ä¸ªç©ºäº‹åŠ¡å…ˆå°†è¿™ä¸ª GTID åŠ åˆ°ä¸´æ—¶å®ä¾‹çš„ GTID é›†åˆï¼Œä¹‹åæŒ‰é¡ºåºæ‰§è¡Œ binlog çš„æ—¶å°±ä¼šè‡ªåŠ¨è·³è¿‡è¯¯æ“ä½œçš„è¯­å¥\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### æŸ¥è¯¢æ—¥å¿—\r\n\r\næŸ¥è¯¢æ—¥å¿—ä¸­è®°å½•äº†å®¢æˆ·ç«¯çš„æ‰€æœ‰æ“ä½œè¯­å¥ï¼Œè€ŒäºŒè¿›åˆ¶æ—¥å¿—ä¸åŒ…å«æŸ¥è¯¢æ•°æ®çš„ SQL è¯­å¥\r\n\r\né»˜è®¤æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢æ—¥å¿—æ˜¯æœªå¼€å¯çš„ã€‚å¦‚æœéœ€è¦å¼€å¯æŸ¥è¯¢æ—¥å¿—ï¼Œé…ç½® my.cnfï¼š\r\n\r\n```sh\r\n# è¯¥é€‰é¡¹ç”¨æ¥å¼€å¯æŸ¥è¯¢æ—¥å¿—ï¼Œå¯é€‰å€¼0æˆ–è€…1ï¼Œ0ä»£è¡¨å…³é—­ï¼Œ1ä»£è¡¨å¼€å¯ \r\ngeneral_log=1\r\n# è®¾ç½®æ—¥å¿—çš„æ–‡ä»¶åï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤çš„æ–‡ä»¶åä¸ºhost_name.logï¼Œå­˜æ”¾åœ¨/var/lib/mysql\r\ngeneral_log_file=mysql_query.log\r\n```\r\n\r\né…ç½®å®Œæ¯•ä¹‹åï¼Œåœ¨æ•°æ®åº“æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\r\n\r\n```sql\r\nSELECT * FROM tb_book;\r\nSELECT * FROM tb_book WHERE id = 1;\r\nUPDATE tb_book SET name = 'luceneå…¥é—¨æŒ‡å—' WHERE id = 5;\r\nSELECT * FROM tb_book WHERE id < 8\r\n```\r\n\r\næ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ å†æ¬¡æ¥æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶ï¼š\r\n\r\n![image-20250320013318003](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013318003.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### æ…¢æ—¥å¿—\r\n\r\næ…¢æŸ¥è¯¢æ—¥å¿—è®°å½•æ‰€æœ‰æ‰§è¡Œæ—¶é—´è¶…è¿‡ long_query_time å¹¶ä¸”æ‰«æè®°å½•æ•°ä¸å°äº min_examined_row_limit çš„æ‰€æœ‰çš„ SQL è¯­å¥çš„æ—¥å¿—long_query_time é»˜è®¤ä¸º 10 ç§’ï¼Œæœ€å°ä¸º 0ï¼Œ ç²¾åº¦åˆ°å¾®ç§’\r\n\r\næ…¢æŸ¥è¯¢æ—¥å¿—é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ä»¥é€šè¿‡ä¸¤ä¸ªå‚æ•°æ¥æ§åˆ¶æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œé…ç½®æ–‡ä»¶ `/etc/mysql/my.cnf`ï¼š\r\n\r\n```sh\r\n# è¯¥å‚æ•°ç”¨æ¥æ§åˆ¶æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯å¦å¼€å¯ï¼Œå¯é€‰å€¼0æˆ–è€…1ï¼Œ0ä»£è¡¨å…³é—­ï¼Œ1ä»£è¡¨å¼€å¯ \r\nslow_query_log=1 \r\n\r\n# è¯¥å‚æ•°ç”¨æ¥æŒ‡å®šæ…¢æŸ¥è¯¢æ—¥å¿—çš„æ–‡ä»¶åï¼Œå­˜æ”¾åœ¨ /var/lib/mysql\r\nslow_query_log_file=slow_query.log\r\n\r\n# è¯¥é€‰é¡¹ç”¨æ¥é…ç½®æŸ¥è¯¢çš„æ—¶é—´é™åˆ¶ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å°†è®¤ä¸ºå€¼æ…¢æŸ¥è¯¢ï¼Œå°†éœ€è¦è¿›è¡Œæ—¥å¿—è®°å½•ï¼Œé»˜è®¤10s\r\nlong_query_time=10\r\n```\r\n\r\næ—¥å¿—è¯»å–ï¼š\r\n\r\n* ç›´æ¥é€šè¿‡ cat æŒ‡ä»¤æŸ¥è¯¢è¯¥æ—¥å¿—æ–‡ä»¶ï¼š\r\n\r\n  ```sh\r\n  cat slow_query.log\r\n  ```\r\n\r\n  ![image-20250320013338559](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013338559.png)\r\n\r\n* å¦‚æœæ…¢æŸ¥è¯¢æ—¥å¿—å†…å®¹å¾ˆå¤šï¼Œç›´æ¥æŸ¥çœ‹æ–‡ä»¶æ¯”è¾ƒç¹çï¼Œå¯ä»¥å€ŸåŠ© mysql è‡ªå¸¦çš„ mysqldumpslow å·¥å…·å¯¹æ…¢æŸ¥è¯¢æ—¥å¿—è¿›è¡Œåˆ†ç±»æ±‡æ€»ï¼š\r\n\r\n  ```sh\r\n  mysqldumpslow slow_query.log\r\n  ```\r\n\r\n  ![image-20250320013349361](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013349361.png)\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"MySQL - ä¸»ä»","tags":["SQL"],"categories":["MySQL","ä¸»ä»ç¯‡"],"author":"imklaus","excerpt":"\r\n### åŸºæœ¬ä»‹ç»\r\n\r\nä¸»ä»å¤åˆ¶æ˜¯æŒ‡å°†ä¸»æ•°æ®åº“çš„ DDL å’Œ DML æ“ä½œé€šè¿‡äºŒè¿›åˆ¶æ—¥å¿—ä¼ åˆ°ä»åº“æœåŠ¡å™¨ä¸­ï¼Œç„¶ååœ¨ä»åº“ä¸Šå¯¹è¿™äº›æ—¥å¿—é‡æ–°æ‰§è¡Œï¼ˆä¹Ÿå«é‡åšï¼‰ï¼Œä»è€Œä½¿å¾—ä»åº“å’Œä¸»åº“çš„æ•°æ®ä¿æŒåŒæ­¥\r\n\r\nMySQL æ”¯æŒä¸€å°ä¸»åº“åŒæ—¶å‘å¤šå°ä»åº“è¿›è¡Œå¤åˆ¶ï¼Œä»åº“åŒæ—¶ä¹Ÿå¯ä»¥ä½œä¸ºå…¶ä»–ä»æœåŠ¡å™¨çš„ä¸»åº“ï¼Œå®ç°é“¾çŠ¶å¤åˆ¶\r\n\r\nMySQL å¤åˆ¶çš„ä¼˜ç‚¹ä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š\r\n\r\n- ä¸»åº“å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿåˆ‡æ¢åˆ°ä»åº“æä¾›æœåŠ¡\r\n\r\n- å¯ä»¥åœ¨ä»åº“ä¸Šæ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼Œä»ä¸»åº“ä¸­æ›´æ–°ï¼Œå®ç°è¯»å†™åˆ†ç¦»\r\n\r\n- å¯ä»¥åœ¨ä»åº“ä¸­æ‰§è¡Œå¤‡ä»½ï¼Œä»¥é¿å…å¤‡ä»½æœŸé—´å½±å“ä¸»åº“çš„æœåŠ¡ï¼ˆå¤‡ä»½æ—¶ä¼šåŠ å…¨å±€è¯»é”ï¼‰\r\n\r\n","link":"/posts/MySQL_Master_Slave","content":"\r\n### åŸºæœ¬ä»‹ç»\r\n\r\nä¸»ä»å¤åˆ¶æ˜¯æŒ‡å°†ä¸»æ•°æ®åº“çš„ DDL å’Œ DML æ“ä½œé€šè¿‡äºŒè¿›åˆ¶æ—¥å¿—ä¼ åˆ°ä»åº“æœåŠ¡å™¨ä¸­ï¼Œç„¶ååœ¨ä»åº“ä¸Šå¯¹è¿™äº›æ—¥å¿—é‡æ–°æ‰§è¡Œï¼ˆä¹Ÿå«é‡åšï¼‰ï¼Œä»è€Œä½¿å¾—ä»åº“å’Œä¸»åº“çš„æ•°æ®ä¿æŒåŒæ­¥\r\n\r\nMySQL æ”¯æŒä¸€å°ä¸»åº“åŒæ—¶å‘å¤šå°ä»åº“è¿›è¡Œå¤åˆ¶ï¼Œä»åº“åŒæ—¶ä¹Ÿå¯ä»¥ä½œä¸ºå…¶ä»–ä»æœåŠ¡å™¨çš„ä¸»åº“ï¼Œå®ç°é“¾çŠ¶å¤åˆ¶\r\n\r\nMySQL å¤åˆ¶çš„ä¼˜ç‚¹ä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š\r\n\r\n- ä¸»åº“å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿåˆ‡æ¢åˆ°ä»åº“æä¾›æœåŠ¡\r\n\r\n- å¯ä»¥åœ¨ä»åº“ä¸Šæ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼Œä»ä¸»åº“ä¸­æ›´æ–°ï¼Œå®ç°è¯»å†™åˆ†ç¦»\r\n\r\n- å¯ä»¥åœ¨ä»åº“ä¸­æ‰§è¡Œå¤‡ä»½ï¼Œä»¥é¿å…å¤‡ä»½æœŸé—´å½±å“ä¸»åº“çš„æœåŠ¡ï¼ˆå¤‡ä»½æ—¶ä¼šåŠ å…¨å±€è¯»é”ï¼‰\r\n\r\n<!-- more -->\r\n\r\n***\r\n\r\n\r\n\r\n### ä¸»ä»å¤åˆ¶\r\n\r\n#### ä¸»ä»ç»“æ„\r\n\r\nMySQL çš„ä¸»ä»ä¹‹é—´ç»´æŒäº†ä¸€ä¸ª**é•¿è¿æ¥**ã€‚ä¸»åº“å†…éƒ¨æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸“é—¨ç”¨äºæœåŠ¡ä»åº“çš„é•¿è¿æ¥ï¼Œè¿æ¥è¿‡ç¨‹ï¼š\r\n\r\n* ä»åº“æ‰§è¡Œ change master å‘½ä»¤ï¼Œè®¾ç½®ä¸»åº“çš„ IPã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ä»¥åŠè¦ä»å“ªä¸ªä½ç½®å¼€å§‹è¯·æ±‚ binlogï¼Œè¿™ä¸ªä½ç½®åŒ…å«æ–‡ä»¶åå’Œæ—¥å¿—åç§»é‡\r\n* ä»åº“æ‰§è¡Œ start slave å‘½ä»¤ï¼Œè¿™æ—¶ä»åº“ä¼šå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œå°±æ˜¯å›¾ä¸­çš„ io_thread å’Œ sql_threadï¼Œå…¶ä¸­ io_thread è´Ÿè´£ä¸ä¸»åº“å»ºç«‹è¿æ¥\r\n* ä¸»åº“æ ¡éªŒå®Œç”¨æˆ·åã€å¯†ç åï¼Œå¼€å§‹æŒ‰ç…§ä»ä¼ è¿‡æ¥çš„ä½ç½®ï¼Œä»æœ¬åœ°è¯»å– binlog å‘ç»™ä»åº“ï¼Œå¼€å§‹ä¸»ä»å¤åˆ¶\r\n\r\nä¸»ä»å¤åˆ¶åŸç†å›¾ï¼š\r\n\r\n![image-20250320012805574](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012805574.png)\r\n\r\nä¸»ä»å¤åˆ¶ä¸»è¦ä¾èµ–çš„æ˜¯ binlogï¼ŒMySQL é»˜è®¤æ˜¯å¼‚æ­¥å¤åˆ¶ï¼Œéœ€è¦ä¸‰ä¸ªçº¿ç¨‹ï¼š\r\n\r\n- binlog threadï¼šåœ¨ä¸»åº“äº‹åŠ¡æäº¤æ—¶ï¼ŒæŠŠæ•°æ®å˜æ›´è®°å½•åœ¨æ—¥å¿—æ–‡ä»¶ binlog ä¸­ï¼Œå¹¶é€šçŸ¥ slave æœ‰æ•°æ®æ›´æ–°\r\n- I/O threadï¼šè´Ÿè´£ä»ä¸»æœåŠ¡å™¨ä¸Š**æ‹‰å–äºŒè¿›åˆ¶æ—¥å¿—**ï¼Œå¹¶å°† binlog æ—¥å¿—å†…å®¹ä¾æ¬¡å†™åˆ° relay log ä¸­è½¬æ—¥å¿—çš„æœ€æœ«ç«¯ï¼Œå¹¶å°†æ–°çš„ binlog æ–‡ä»¶åå’Œ offset è®°å½•åˆ° master-info æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡è¯»å–æ—¥å¿—æ—¶ä»æŒ‡å®š binlog æ—¥å¿—æ–‡ä»¶åŠä½ç½®å¼€å§‹è¯»å–æ–°çš„ binlog æ—¥å¿—å†…å®¹\r\n- SQL threadï¼šç›‘æµ‹æœ¬åœ° relay log ä¸­æ–°å¢äº†æ—¥å¿—å†…å®¹ï¼Œè¯»å–ä¸­ç»§æ—¥å¿—å¹¶é‡åšå…¶ä¸­çš„ SQL è¯­å¥ï¼Œä»åº“åœ¨ relay-log.info ä¸­è®°å½•å½“å‰åº”ç”¨ä¸­ç»§æ—¥å¿—çš„æ–‡ä»¶åå’Œä½ç‚¹ä»¥ä¾¿ä¸‹ä¸€æ¬¡æ‰§è¡Œ\r\n\r\nåŒæ­¥ä¸å¼‚æ­¥ï¼š\r\n\r\n* å¼‚æ­¥å¤åˆ¶æœ‰æ•°æ®ä¸¢å¤±é£é™©ï¼Œä¾‹å¦‚æ•°æ®è¿˜æœªåŒæ­¥åˆ°ä»åº“ï¼Œä¸»åº“å°±ç»™å®¢æˆ·ç«¯å“åº”ï¼Œç„¶åä¸»åº“æŒ‚äº†ï¼Œæ­¤æ—¶ä»åº“æ™‹å‡ä¸ºä¸»åº“çš„è¯æ•°æ®æ˜¯ç¼ºå¤±çš„\r\n* åŒæ­¥å¤åˆ¶ï¼Œä¸»åº“éœ€è¦å°† binlog å¤åˆ¶åˆ°æ‰€æœ‰ä»åº“ï¼Œç­‰æ‰€æœ‰ä»åº“å“åº”äº†ä¹‹åä¸»åº“æ‰è¿›è¡Œå…¶ä»–é€»è¾‘ï¼Œè¿™æ ·çš„è¯æ€§èƒ½å¾ˆå·®ï¼Œä¸€èˆ¬ä¸ä¼šé€‰æ‹©\r\n* MySQL 5.7 ä¹‹åå‡ºç°äº†åŠåŒæ­¥å¤åˆ¶ï¼Œæœ‰å‚æ•°å¯ä»¥é€‰æ‹©æˆåŠŸåŒæ­¥å‡ ä¸ªä»åº“å°±è¿”å›å“åº”\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### ä¸»ä¸»ç»“æ„\r\n\r\nä¸»ä¸»ç»“æ„å°±æ˜¯ä¸¤ä¸ªæ•°æ®åº“ä¹‹é—´æ€»æ˜¯äº’ä¸ºä¸»ä»å…³ç³»ï¼Œè¿™æ ·åœ¨åˆ‡æ¢çš„æ—¶å€™å°±ä¸ç”¨å†ä¿®æ”¹ä¸»ä»å…³ç³»\r\n\r\nå¾ªç¯å¤åˆ¶ï¼šåœ¨åº“ A ä¸Šæ›´æ–°äº†ä¸€æ¡è¯­å¥ï¼Œç„¶åæŠŠç”Ÿæˆçš„ binlog å‘ç»™åº“ Bï¼Œåº“ B æ‰§è¡Œå®Œè¿™æ¡æ›´æ–°è¯­å¥åä¹Ÿä¼šç”Ÿæˆ binlogï¼Œä¼šå†å‘ç»™ A\r\n\r\nè§£å†³æ–¹æ³•ï¼š\r\n\r\n* ä¸¤ä¸ªåº“çš„ server id å¿…é¡»ä¸åŒï¼Œå¦‚æœç›¸åŒåˆ™å®ƒä»¬ä¹‹é—´ä¸èƒ½è®¾å®šä¸ºä¸»ä¸»å…³ç³»\r\n* ä¸€ä¸ªåº“æ¥åˆ° binlog å¹¶åœ¨é‡æ”¾çš„è¿‡ç¨‹ä¸­ï¼Œç”Ÿæˆä¸åŸ binlog çš„ server id ç›¸åŒçš„æ–°çš„ binlog\r\n* æ¯ä¸ªåº“åœ¨æ”¶åˆ°ä»ä¸»åº“å‘è¿‡æ¥çš„æ—¥å¿—åï¼Œå…ˆåˆ¤æ–­ server idï¼Œå¦‚æœè·Ÿè‡ªå·±çš„ç›¸åŒï¼Œè¡¨ç¤ºè¿™ä¸ªæ—¥å¿—æ˜¯è‡ªå·±ç”Ÿæˆçš„ï¼Œå°±ç›´æ¥ä¸¢å¼ƒè¿™ä¸ªæ—¥å¿—\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ä¸»ä»å»¶è¿Ÿ\r\n\r\n#### å»¶è¿ŸåŸå› \r\n\r\næ­£å¸¸æƒ…å†µä¸»åº“æ‰§è¡Œæ›´æ–°ç”Ÿæˆçš„æ‰€æœ‰ binlogï¼Œéƒ½å¯ä»¥ä¼ åˆ°ä»åº“å¹¶è¢«æ­£ç¡®åœ°æ‰§è¡Œï¼Œä»åº“å°±èƒ½è¾¾åˆ°è·Ÿä¸»åº“ä¸€è‡´çš„çŠ¶æ€ï¼Œè¿™å°±æ˜¯æœ€ç»ˆä¸€è‡´æ€§\r\n\r\nä¸»ä»å»¶è¿Ÿæ˜¯ä¸»ä»ä¹‹é—´æ˜¯å­˜åœ¨ä¸€å®šæ—¶é—´çš„æ•°æ®ä¸ä¸€è‡´ï¼Œå°±æ˜¯åŒä¸€ä¸ªäº‹åŠ¡åœ¨ä»åº“æ‰§è¡Œå®Œæˆçš„æ—¶é—´å’Œä¸»åº“æ‰§è¡Œå®Œæˆçš„æ—¶é—´çš„å·®å€¼ï¼Œå³ T2-T1\r\n\r\n- ä¸»åº“ A æ‰§è¡Œå®Œæˆä¸€ä¸ªäº‹åŠ¡ï¼Œå†™å…¥ binlogï¼Œè¯¥æ—¶åˆ»è®°ä¸º T1\r\n- æ—¥å¿—ä¼ ç»™ä»åº“ Bï¼Œä»åº“ B æ‰§è¡Œå®Œè¿™ä¸ªäº‹åŠ¡ï¼Œè¯¥æ—¶åˆ»è®°ä¸º T2\r\n\r\né€šè¿‡åœ¨ä»åº“æ‰§è¡Œ `show slave status` å‘½ä»¤ï¼Œè¿”å›ç»“æœä¼šæ˜¾ç¤º seconds_behind_master è¡¨ç¤ºå½“å‰ä»åº“å»¶è¿Ÿäº†å¤šå°‘ç§’\r\n\r\n- æ¯ä¸€ä¸ªäº‹åŠ¡çš„ binlog éƒ½æœ‰ä¸€ä¸ªæ—¶é—´å­—æ®µï¼Œç”¨äºè®°å½•ä¸»åº“ä¸Šå†™å…¥çš„æ—¶é—´\r\n- ä»åº“å–å‡ºå½“å‰æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡çš„æ—¶é—´å­—æ®µï¼Œè·Ÿç³»ç»Ÿçš„æ—¶é—´è¿›è¡Œç›¸å‡ï¼Œå¾—åˆ°çš„å°±æ˜¯ seconds_behind_master\r\n\r\nä¸»ä»å»¶è¿Ÿçš„åŸå› ï¼š\r\n\r\n* ä»åº“çš„æœºå™¨æ€§èƒ½æ¯”ä¸»åº“çš„å·®ï¼Œå¯¼è‡´ä»åº“çš„å¤åˆ¶èƒ½åŠ›å¼±\r\n* ä»åº“çš„æŸ¥è¯¢å‹åŠ›å¤§ï¼Œå»ºç«‹ä¸€ä¸»å¤šä»çš„ç»“æ„\r\n* å¤§äº‹åŠ¡çš„æ‰§è¡Œï¼Œä¸»åº“å¿…é¡»è¦ç­‰åˆ°äº‹åŠ¡å®Œæˆä¹‹åæ‰ä¼šå†™å…¥ binlogï¼Œå¯¼è‡´ä»èŠ‚ç‚¹å‡ºç°åº”ç”¨ binlog å»¶è¿Ÿ\r\n* ä¸»åº“çš„ DDLï¼Œä»åº“ä¸ä¸»åº“çš„ DDL åŒæ­¥æ˜¯ä¸²è¡Œè¿›è¡Œï¼ŒDDL åœ¨ä¸»åº“æ‰§è¡Œæ—¶é—´å¾ˆé•¿ï¼Œé‚£ä¹ˆä»åº“ä¹Ÿä¼šæ¶ˆè€—åŒæ ·çš„æ—¶é—´\r\n* é”å†²çªé—®é¢˜ä¹Ÿå¯èƒ½å¯¼è‡´ä»èŠ‚ç‚¹çš„ SQL çº¿ç¨‹æ‰§è¡Œæ…¢\r\n\r\nä¸»ä»åŒæ­¥é—®é¢˜æ°¸è¿œéƒ½æ˜¯**ä¸€è‡´æ€§å’Œæ€§èƒ½çš„æƒè¡¡**ï¼Œéœ€è¦æ ¹æ®å®é™…çš„åº”ç”¨åœºæ™¯ï¼Œå¯ä»¥é‡‡å–ä¸‹é¢çš„åŠæ³•ï¼š\r\n\r\n* ä¼˜åŒ– SQLï¼Œé¿å…æ…¢ SQLï¼Œå‡å°‘æ‰¹é‡æ“ä½œ\r\n* é™ä½å¤šçº¿ç¨‹å¤§äº‹åŠ¡å¹¶å‘çš„æ¦‚ç‡ï¼Œä¼˜åŒ–ä¸šåŠ¡é€»è¾‘\r\n* ä¸šåŠ¡ä¸­å¤§å¤šæ•°æƒ…å†µæŸ¥è¯¢æ“ä½œè¦æ¯”æ›´æ–°æ“ä½œæ›´å¤šï¼Œæ­å»º**ä¸€ä¸»å¤šä»**ç»“æ„ï¼Œè®©è¿™äº›ä»åº“æ¥åˆ†æ‹…è¯»çš„å‹åŠ›\r\n\r\n* å°½é‡é‡‡ç”¨çŸ­çš„é“¾è·¯ï¼Œä¸»åº“å’Œä»åº“æœåŠ¡å™¨çš„è·ç¦»å°½é‡è¦çŸ­ï¼Œæå‡ç«¯å£å¸¦å®½ï¼Œå‡å°‘ binlog ä¼ è¾“çš„ç½‘ç»œå»¶æ—¶\r\n* å®æ—¶æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡è¯»å¼ºåˆ¶èµ°ä¸»åº“ï¼Œä»åº“åªåšå¤‡ä»½\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å¹¶è¡Œå¤åˆ¶\r\n\r\n##### MySQL5.6\r\n\r\né«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œä¸»åº“çš„ä¼šäº§ç”Ÿå¤§é‡çš„ binlogï¼Œåœ¨ä»åº“ä¸­æœ‰ä¸¤ä¸ªçº¿ç¨‹ IO Thread å’Œ SQL Thread å•çº¿ç¨‹æ‰§è¡Œï¼Œä¼šå¯¼è‡´ä¸»åº“å»¶è¿Ÿå˜å¤§ã€‚ä¸ºäº†æ”¹å–„å¤åˆ¶å»¶è¿Ÿé—®é¢˜ï¼ŒMySQL 5.6 ç‰ˆæœ¬å¢åŠ äº†å¹¶è¡Œå¤åˆ¶åŠŸèƒ½ï¼Œä»¥é‡‡ç”¨å¤šçº¿ç¨‹æœºåˆ¶æ¥ä¿ƒè¿›æ‰§è¡Œ\r\n\r\ncoordinator å°±æ˜¯åŸæ¥çš„ SQL Threadï¼Œå¹¶è¡Œå¤åˆ¶ä¸­å®ƒä¸å†ç›´æ¥æ›´æ–°æ•°æ®ï¼Œ**åªè´Ÿè´£è¯»å–ä¸­è½¬æ—¥å¿—å’Œåˆ†å‘äº‹åŠ¡**ï¼š\r\n\r\n* çº¿ç¨‹åˆ†é…å®Œæˆå¹¶ä¸æ˜¯ç«‹å³æ‰§è¡Œï¼Œä¸ºäº†é˜²æ­¢é€ æˆæ›´æ–°è¦†ç›–ï¼Œæ›´æ–°åŒä¸€ DB çš„ä¸¤ä¸ªäº‹åŠ¡å¿…é¡»è¢«åˆ†å‘åˆ°åŒä¸€ä¸ªå·¥ä½œçº¿ç¨‹\r\n* åŒä¸€ä¸ªäº‹åŠ¡ä¸èƒ½è¢«æ‹†å¼€ï¼Œå¿…é¡»æ”¾åˆ°åŒä¸€ä¸ªå·¥ä½œçº¿ç¨‹\r\n\r\nMySQL 5.6 ç‰ˆæœ¬çš„ç­–ç•¥ï¼šæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ª hash è¡¨ï¼Œç”¨äºä¿å­˜å½“å‰è¿™ä¸ªçº¿ç¨‹çš„æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„äº‹åŠ¡æ‰€æ¶‰åŠçš„è¡¨ï¼Œhash è¡¨çš„ key æ˜¯æ•°æ®åº“åï¼Œvalue æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œè¡¨ç¤ºé˜Ÿåˆ—ä¸­æœ‰å¤šå°‘ä¸ªäº‹åŠ¡ä¿®æ”¹è¿™ä¸ªåº“ï¼Œé€‚ç”¨äºä¸»åº“ä¸Šæœ‰å¤šä¸ª DB çš„æƒ…å†µ\r\n\r\næ¯ä¸ªäº‹åŠ¡åœ¨åˆ†å‘çš„æ—¶å€™ï¼Œè·Ÿçº¿ç¨‹çš„**å†²çª**ï¼ˆäº‹åŠ¡æ“ä½œçš„æ˜¯åŒä¸€ä¸ªåº“ï¼‰å…³ç³»åŒ…æ‹¬ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š\r\n\r\n* å¦‚æœè·Ÿæ‰€æœ‰çº¿ç¨‹éƒ½ä¸å†²çªï¼Œcoordinator çº¿ç¨‹å°±ä¼šæŠŠè¿™ä¸ªäº‹åŠ¡åˆ†é…ç»™æœ€ç©ºé—²çš„çº¿ç¨‹\r\n* å¦‚æœåªè·Ÿä¸€ä¸ªçº¿ç¨‹å†²çªï¼Œcoordinator çº¿ç¨‹å°±ä¼šæŠŠè¿™ä¸ªäº‹åŠ¡åˆ†é…ç»™è¿™ä¸ªå­˜åœ¨å†²çªå…³ç³»çš„çº¿ç¨‹\r\n* å¦‚æœè·Ÿå¤šäºä¸€ä¸ªçº¿ç¨‹å†²çªï¼Œcoordinator çº¿ç¨‹å°±è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°å’Œè¿™ä¸ªäº‹åŠ¡å­˜åœ¨å†²çªå…³ç³»çš„çº¿ç¨‹åªå‰©ä¸‹ 1 ä¸ª\r\n\r\nä¼˜ç¼ºç‚¹ï¼š\r\n\r\n* æ„é€  hash å€¼çš„æ—¶å€™å¾ˆå¿«ï¼Œåªéœ€è¦åº“åï¼Œè€Œä¸”ä¸€ä¸ªå®ä¾‹ä¸Š DB æ•°ä¹Ÿä¸ä¼šå¾ˆå¤šï¼Œä¸ä¼šå‡ºç°éœ€è¦æ„é€ å¾ˆå¤šé¡¹çš„æƒ…å†µ\r\n* ä¸è¦æ±‚ binlog çš„æ ¼å¼ï¼Œstatement æ ¼å¼çš„ binlog ä¹Ÿå¯ä»¥å¾ˆå®¹æ˜“æ‹¿åˆ°åº“åï¼ˆæ—¥å¿—ç« èŠ‚è¯¦è§£äº† binlogï¼‰\r\n* ä¸»åº“ä¸Šçš„è¡¨éƒ½æ”¾åœ¨åŒä¸€ä¸ª DB é‡Œé¢ï¼Œè¿™ä¸ªç­–ç•¥å°±æ²¡æœ‰æ•ˆæœäº†ï¼›æˆ–è€…ä¸åŒ DB çš„çƒ­ç‚¹ä¸åŒï¼Œæ¯”å¦‚ä¸€ä¸ªæ˜¯ä¸šåŠ¡é€»è¾‘åº“ï¼Œä¸€ä¸ªæ˜¯ç³»ç»Ÿé…ç½®åº“ï¼Œé‚£ä¹Ÿèµ·ä¸åˆ°å¹¶è¡Œçš„æ•ˆæœï¼Œéœ€è¦**æŠŠç›¸åŒçƒ­åº¦çš„è¡¨å‡åŒ€åˆ†åˆ°è¿™äº›ä¸åŒçš„ DB ä¸­**ï¼Œæ‰å¯ä»¥ä½¿ç”¨è¿™ä¸ªç­–ç•¥\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### MySQL5.7\r\n\r\nMySQL 5.7 ç”±å‚æ•° slave-parallel-type æ¥æ§åˆ¶å¹¶è¡Œå¤åˆ¶ç­–ç•¥ï¼š\r\n\r\n* é…ç½®ä¸º DATABASEï¼Œè¡¨ç¤ºä½¿ç”¨ MySQL 5.6 ç‰ˆæœ¬çš„**æŒ‰åº“ï¼ˆDBï¼‰å¹¶è¡Œç­–ç•¥**\r\n* é…ç½®ä¸º LOGICAL_CLOCKï¼Œè¡¨ç¤ºçš„**æŒ‰æäº¤çŠ¶æ€å¹¶è¡Œ**æ‰§è¡Œ\r\n\r\næŒ‰æäº¤çŠ¶æ€å¹¶è¡Œå¤åˆ¶ç­–ç•¥çš„æ€æƒ³æ˜¯ï¼š\r\n\r\n* æ‰€æœ‰å¤„äº commit çŠ¶æ€çš„äº‹åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼›åŒæ—¶å¤„äº prepare çŠ¶æ€çš„äº‹åŠ¡ï¼Œåœ¨ä»åº“æ‰§è¡Œæ—¶æ˜¯å¯ä»¥å¹¶è¡Œçš„\r\n* å¤„äº prepare çŠ¶æ€çš„äº‹åŠ¡ï¼Œä¸å¤„äº commit çŠ¶æ€çš„äº‹åŠ¡ä¹‹é—´ï¼Œåœ¨ä»åº“æ‰§è¡Œæ—¶ä¹Ÿæ˜¯å¯ä»¥å¹¶è¡Œçš„\r\n\r\nMySQL 5.7.22 ç‰ˆæœ¬é‡Œï¼ŒMySQL å¢åŠ äº†ä¸€ä¸ªæ–°çš„å¹¶è¡Œå¤åˆ¶ç­–ç•¥ï¼ŒåŸºäº WRITESET çš„å¹¶è¡Œå¤åˆ¶ï¼Œæ–°å¢äº†ä¸€ä¸ªå‚æ•° binlog-transaction-dependency-trackingï¼Œç”¨æ¥æ§åˆ¶æ˜¯å¦å¯ç”¨è¿™ä¸ªæ–°ç­–ç•¥ï¼š\r\n\r\n* COMMIT_ORDERï¼šè¡¨ç¤ºæ ¹æ®åŒæ—¶è¿›å…¥ prepare å’Œ commit æ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥å¹¶è¡Œçš„ç­–ç•¥\r\n\r\n* WRITESETï¼šè¡¨ç¤ºçš„æ˜¯å¯¹äºæ¯ä¸ªäº‹åŠ¡æ¶‰åŠæ›´æ–°çš„æ¯ä¸€è¡Œï¼Œè®¡ç®—å‡ºè¿™ä¸€è¡Œçš„ hash å€¼ï¼Œç»„æˆè¯¥äº‹åŠ¡çš„ writeset é›†åˆï¼Œå¦‚æœä¸¤ä¸ªäº‹åŠ¡æ²¡æœ‰æ“ä½œç›¸åŒçš„è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬çš„ writeset æ²¡æœ‰äº¤é›†ï¼Œå°±å¯ä»¥å¹¶è¡Œï¼ˆ**æŒ‰è¡Œå¹¶è¡Œ**ï¼‰\r\n\r\n  ä¸ºäº†å”¯ä¸€æ ‡è¯†ï¼Œè¿™ä¸ª hash è¡¨çš„å€¼æ˜¯é€šè¿‡ `åº“å + è¡¨å + ç´¢å¼•å + å€¼`ï¼ˆè¡¨ç¤ºçš„æ˜¯æŸä¸€è¡Œï¼‰è®¡ç®—å‡ºæ¥çš„\r\n\r\n* WRITESET_SESSIONï¼šæ˜¯åœ¨ WRITESET çš„åŸºç¡€ä¸Šå¤šäº†ä¸€ä¸ªçº¦æŸï¼Œå³åœ¨ä¸»åº“ä¸ŠåŒä¸€ä¸ªçº¿ç¨‹å…ˆåæ‰§è¡Œçš„ä¸¤ä¸ªäº‹åŠ¡ï¼Œåœ¨å¤‡åº“æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦ä¿è¯ç›¸åŒçš„å…ˆåé¡ºåº\r\n\r\n\r\nMySQL 5.7.22 æŒ‰è¡Œå¹¶å‘çš„ä¼˜åŠ¿ï¼š\r\n\r\n* writeset æ˜¯åœ¨ä¸»åº“ç”Ÿæˆåç›´æ¥å†™å…¥åˆ° binlog é‡Œé¢çš„ï¼Œè¿™æ ·åœ¨å¤‡åº“æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸éœ€è¦è§£æ binlog å†…å®¹ï¼ŒèŠ‚çœäº†è®¡ç®—é‡\r\n* ä¸éœ€è¦æŠŠæ•´ä¸ªäº‹åŠ¡çš„ binlog éƒ½æ‰«ä¸€éæ‰èƒ½å†³å®šåˆ†å‘åˆ°å“ªä¸ªçº¿ç¨‹ï¼Œæ›´çœå†…å­˜\r\n* ä»åº“çš„åˆ†å‘ç­–ç•¥ä¸ä¾èµ–äº binlog å†…å®¹ï¼Œæ‰€ä»¥ binlog æ˜¯ statement æ ¼å¼ä¹Ÿå¯ä»¥ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼ˆå› ä¸º row æ‰è®°å½•æ›´æ”¹çš„è¡Œï¼‰\r\n\r\nMySQL 5.7.22 çš„å¹¶è¡Œå¤åˆ¶ç­–ç•¥åœ¨é€šç”¨æ€§ä¸Šæ˜¯æœ‰ä¿è¯çš„ï¼Œä½†æ˜¯å¯¹äºè¡¨ä¸Šæ²¡ä¸»é”®ã€å”¯ä¸€å’Œå¤–é”®çº¦æŸçš„åœºæ™¯ï¼ŒWRITESET ç­–ç•¥ä¹Ÿæ˜¯æ²¡æ³•å¹¶è¡Œçš„ï¼Œä¹Ÿä¼šæš‚æ—¶é€€åŒ–ä¸ºå•çº¿ç¨‹æ¨¡å‹\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/77083\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### è¯»å†™åˆ†ç¦»\r\n\r\n#### è¯»å†™å»¶è¿Ÿ\r\n\r\nè¯»å†™åˆ†ç¦»ï¼šå¯ä»¥é™ä½ä¸»åº“çš„è®¿é—®å‹åŠ›ï¼Œæé«˜ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›\r\n\r\n* ä¸»åº“ä¸å»ºæŸ¥è¯¢çš„ç´¢å¼•ï¼Œä»åº“å»ºæŸ¥è¯¢çš„ç´¢å¼•ã€‚å› ä¸ºç´¢å¼•éœ€è¦ç»´æŠ¤çš„ï¼Œæ¯”å¦‚æ’å…¥ä¸€æ¡æ•°æ®ï¼Œä¸ä»…è¦åœ¨èšç°‡ç´¢å¼•ä¸Šé¢æ’å…¥ï¼Œå¯¹åº”çš„äºŒçº§ç´¢å¼•ä¹Ÿå¾—æ’å…¥\r\n* å°†è¯»æ“ä½œåˆ†åˆ°ä»åº“äº†ä¹‹åï¼Œå¯ä»¥åœ¨ä¸»åº“æŠŠæŸ¥è¯¢è¦ç”¨çš„ç´¢å¼•åˆ äº†ï¼Œå‡å°‘å†™æ“ä½œå¯¹ä¸»åº“çš„å½±å“\r\n\r\nè¯»å†™åˆ†ç¦»äº§ç”Ÿäº†è¯»å†™å»¶è¿Ÿï¼Œé€ æˆæ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚å‡å¦‚å®¢æˆ·ç«¯æ‰§è¡Œå®Œä¸€ä¸ªæ›´æ–°äº‹åŠ¡åé©¬ä¸Šå‘èµ·æŸ¥è¯¢ï¼Œå¦‚æœæŸ¥è¯¢é€‰æ‹©çš„æ˜¯ä»åº“çš„è¯ï¼Œå¯èƒ½è¯»åˆ°çš„è¿˜æ˜¯ä»¥å‰çš„æ•°æ®ï¼Œå«è¿‡æœŸè¯»\r\n\r\nè§£å†³æ–¹æ¡ˆï¼š\r\n\r\n* å¼ºåˆ¶å°†å†™ä¹‹å**ç«‹åˆ»è¯»çš„æ“ä½œè½¬ç§»åˆ°ä¸»åº“**ï¼Œæ¯”å¦‚åˆšæ³¨å†Œçš„ç”¨æˆ·ï¼Œç›´æ¥ç™»å½•ä»åº“æŸ¥è¯¢å¯èƒ½æŸ¥è¯¢ä¸åˆ°ï¼Œå…ˆèµ°ä¸»åº“ç™»å½•\r\n* **äºŒæ¬¡æŸ¥è¯¢**ï¼Œå¦‚æœä»åº“æŸ¥ä¸åˆ°æ•°æ®ï¼Œåˆ™å†å»ä¸»åº“æŸ¥ä¸€éï¼Œç”± API å°è£…ï¼Œæ¯”è¾ƒç®€å•ï¼Œä½†å¯¼è‡´ä¸»åº“å‹åŠ›å¤§\r\n* æ›´æ–°ä¸»åº“åï¼Œè¯»ä»åº“ä¹‹å‰å…ˆ sleep ä¸€ä¸‹ï¼Œç±»ä¼¼äºæ‰§è¡Œä¸€æ¡ `select sleep(1)` å‘½ä»¤ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ä¸»å¤‡å»¶è¿Ÿåœ¨ 1 ç§’ä¹‹å†…\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ç¡®ä¿æœºåˆ¶\r\n\r\n##### æ— å»¶è¿Ÿ\r\n\r\nç¡®ä¿ä¸»å¤‡æ— å»¶è¿Ÿçš„æ–¹æ³•ï¼š\r\n\r\n* æ¯æ¬¡ä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯·æ±‚å‰ï¼Œå…ˆåˆ¤æ–­ seconds_behind_master æ˜¯å¦å·²ç»ç­‰äº 0ï¼Œå¦‚æœä¸ç­‰äºé‚£å°±ç­‰åˆ°å‚æ•°å˜ä¸º 0 æ‰§è¡ŒæŸ¥è¯¢è¯·æ±‚\r\n* å¯¹æ¯”ä½ç‚¹ï¼ŒMaster_Log_File å’Œ Read_Master_Log_Pos è¡¨ç¤ºçš„æ˜¯è¯»åˆ°çš„ä¸»åº“çš„æœ€æ–°ä½ç‚¹ï¼ŒRelay_Master_Log_File å’Œ Exec_Master_Log_Pos è¡¨ç¤ºçš„æ˜¯å¤‡åº“æ‰§è¡Œçš„æœ€æ–°ä½ç‚¹ï¼Œè¿™ä¸¤ç»„å€¼å®Œå…¨ç›¸åŒå°±è¯´æ˜æ¥æ”¶åˆ°çš„æ—¥å¿—å·²ç»åŒæ­¥å®Œæˆ\r\n* å¯¹æ¯” GTID é›†åˆï¼ŒRetrieved_Gtid_Set æ˜¯å¤‡åº“æ”¶åˆ°çš„æ‰€æœ‰æ—¥å¿—çš„ GTID é›†åˆï¼ŒExecuted_Gtid_Set æ˜¯å¤‡åº“æ‰€æœ‰å·²ç»æ‰§è¡Œå®Œæˆçš„ GTID é›†åˆï¼Œå¦‚æœè¿™ä¸¤ä¸ªé›†åˆç›¸åŒä¹Ÿè¡¨ç¤ºå¤‡åº“æ¥æ”¶åˆ°çš„æ—¥å¿—éƒ½å·²ç»åŒæ­¥å®Œæˆ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### åŠåŒæ­¥\r\n\r\nåŠåŒæ­¥å¤åˆ¶å°±æ˜¯ semi-sync replicationï¼Œé€‚ç”¨äºä¸€ä¸»ä¸€å¤‡çš„åœºæ™¯ï¼Œå·¥ä½œæµç¨‹ï¼š\r\n\r\n* äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œä¸»åº“æŠŠ binlog å‘ç»™ä»åº“\r\n* ä»åº“æ”¶åˆ° binlog ä»¥åï¼Œå‘å›ç»™ä¸»åº“ä¸€ä¸ª ackï¼Œè¡¨ç¤ºæ”¶åˆ°äº†\r\n* ä¸»åº“æ”¶åˆ°è¿™ä¸ª ack ä»¥åï¼Œæ‰èƒ½ç»™å®¢æˆ·ç«¯è¿”å›äº‹åŠ¡å®Œæˆçš„ç¡®è®¤\r\n\r\nåœ¨ä¸€ä¸»å¤šä»åœºæ™¯ä¸­ï¼Œä¸»åº“åªè¦ç­‰åˆ°ä¸€ä¸ªä»åº“çš„ ackï¼Œå°±å¼€å§‹ç»™å®¢æˆ·ç«¯è¿”å›ç¡®è®¤ï¼Œè¿™æ—¶åœ¨ä»åº“ä¸Šæ‰§è¡ŒæŸ¥è¯¢è¯·æ±‚ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š\r\n\r\n* å¦‚æœæŸ¥è¯¢æ˜¯è½åœ¨è¿™ä¸ªå“åº”äº† ack çš„ä»åº“ä¸Šï¼Œæ˜¯èƒ½å¤Ÿç¡®ä¿è¯»åˆ°æœ€æ–°æ•°æ®\r\n* å¦‚æœæŸ¥è¯¢è½åˆ°å…¶ä»–ä»åº“ä¸Šï¼Œå®ƒä»¬å¯èƒ½è¿˜æ²¡æœ‰æ”¶åˆ°æœ€æ–°çš„æ—¥å¿—ï¼Œå°±ä¼šäº§ç”Ÿè¿‡æœŸè¯»çš„é—®é¢˜\r\n\r\nåœ¨ä¸šåŠ¡æ›´æ–°çš„é«˜å³°æœŸï¼Œä¸»åº“çš„ä½ç‚¹æˆ–è€… GTID é›†åˆæ›´æ–°å¾ˆå¿«ï¼Œå¯¼è‡´ä»åº“æ¥ä¸åŠå¤„ç†ï¼Œé‚£ä¹ˆä¸¤ä¸ªä½ç‚¹ç­‰å€¼åˆ¤æ–­å°±ä¼šä¸€ç›´ä¸æˆç«‹ï¼Œå¾ˆå¯èƒ½å‡ºç°ä»åº“ä¸Šè¿Ÿè¿Ÿæ— æ³•å“åº”æŸ¥è¯¢è¯·æ±‚çš„æƒ…å†µ\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n##### ç­‰ä½ç‚¹\r\n\r\nåœ¨**ä»åº“æ‰§è¡Œåˆ¤æ–­ä½ç‚¹**çš„å‘½ä»¤ï¼Œå‚æ•° file å’Œ pos æŒ‡çš„æ˜¯ä¸»åº“ä¸Šçš„æ–‡ä»¶åå’Œä½ç½®ï¼Œtimeout å¯é€‰ï¼Œè®¾ç½®ä¸ºæ­£æ•´æ•° N è¡¨ç¤ºæœ€å¤šç­‰å¾… N ç§’\r\n\r\n```sql\r\nSELECT master_pos_wait(file, pos[, timeout]);\r\n```\r\n\r\nå‘½ä»¤æ­£å¸¸è¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªæ­£æ•´æ•° Mï¼Œè¡¨ç¤ºä»å‘½ä»¤å¼€å§‹æ‰§è¡Œï¼Œåˆ°åº”ç”¨å®Œ file å’Œ pos è¡¨ç¤ºçš„ binlog ä½ç½®ï¼Œæ‰§è¡Œäº†å¤šå°‘äº‹åŠ¡\r\n\r\n* å¦‚æœæ‰§è¡ŒæœŸé—´ï¼Œå¤‡åº“åŒæ­¥çº¿ç¨‹å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™è¿”å› NULL\r\n* å¦‚æœç­‰å¾…è¶…è¿‡ N ç§’ï¼Œå°±è¿”å› -1\r\n* å¦‚æœåˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±å‘ç°å·²ç»æ‰§è¡Œè¿‡è¿™ä¸ªä½ç½®äº†ï¼Œåˆ™è¿”å› 0\r\n\r\nå·¥ä½œæµç¨‹ï¼šå…ˆæ‰§è¡Œ trx1ï¼Œå†æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚çš„é€»è¾‘ï¼Œè¦**ä¿è¯èƒ½å¤ŸæŸ¥åˆ°æ­£ç¡®çš„æ•°æ®**\r\n\r\n* trx1 äº‹åŠ¡æ›´æ–°å®Œæˆåï¼Œé©¬ä¸Šæ‰§è¡Œ `show master status` å¾—åˆ°å½“å‰ä¸»åº“æ‰§è¡Œåˆ°çš„ File å’Œ Position\r\n* é€‰å®šä¸€ä¸ªä»åº“æ‰§è¡Œåˆ¤æ–­ä½ç‚¹è¯­å¥ï¼Œå¦‚æœè¿”å›å€¼æ˜¯ >=0 çš„æ­£æ•´æ•°ï¼Œè¯´æ˜ä»åº“å·²ç»åŒæ­¥å®Œäº‹åŠ¡ï¼Œå¯ä»¥åœ¨è¿™ä¸ªä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥\r\n* å¦‚æœå‡ºç°å…¶ä»–æƒ…å†µï¼Œéœ€è¦åˆ°ä¸»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥\r\n\r\næ³¨æ„ï¼šå¦‚æœæ‰€æœ‰çš„ä»åº“éƒ½å»¶è¿Ÿè¶…è¿‡ timeout ç§’ï¼ŒæŸ¥è¯¢å‹åŠ›å°±éƒ½è·‘åˆ°ä¸»åº“ä¸Šï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œæƒè¡¡\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ç­‰GTID\r\n\r\næ•°æ®åº“å¼€å¯äº† GTID æ¨¡å¼ï¼ŒMySQL æä¾›äº†åˆ¤æ–­ GTID çš„å‘½ä»¤\r\n\r\n```sql\r\nSELECT wait_for_executed_gtid_set(gtid_set [, timeout])\r\n```\r\n\r\n* ç­‰å¾…ç›´åˆ°è¿™ä¸ªåº“æ‰§è¡Œçš„äº‹åŠ¡ä¸­åŒ…å«ä¼ å…¥çš„ gtid_setï¼Œè¿”å› 0\r\n* è¶…æ—¶è¿”å› 1\r\n\r\nå·¥ä½œæµç¨‹ï¼šå…ˆæ‰§è¡Œ trx1ï¼Œå†æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚çš„é€»è¾‘ï¼Œè¦ä¿è¯èƒ½å¤ŸæŸ¥åˆ°æ­£ç¡®çš„æ•°æ®\r\n\r\n* trx1 äº‹åŠ¡æ›´æ–°å®Œæˆåï¼Œä»è¿”å›åŒ…ç›´æ¥è·å–è¿™ä¸ªäº‹åŠ¡çš„ GTIDï¼Œè®°ä¸º gtid\r\n* é€‰å®šä¸€ä¸ªä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼Œå¦‚æœè¿”å›å€¼æ˜¯ 0ï¼Œåˆ™åœ¨è¿™ä¸ªä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼Œå¦åˆ™åˆ°ä¸»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥\r\n\r\nå¯¹æ¯”ç­‰å¾…ä½ç‚¹æ–¹æ³•ï¼Œå‡å°‘äº†ä¸€æ¬¡ `show master status` çš„æ–¹æ³•ï¼Œå°†å‚æ•° session_track_gtids è®¾ç½®ä¸º OWN_GTIDï¼Œç„¶åé€šè¿‡ API æ¥å£ mysql_session_track_get_first ä»è¿”å›åŒ…è§£æå‡º GTID çš„å€¼å³å¯\r\n\r\næ€»ç»“ï¼šæ‰€æœ‰çš„ç­‰å¾…æ— å»¶è¿Ÿçš„æ–¹æ³•ï¼Œéƒ½éœ€è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯å»åˆ¤æ–­å®æ–½\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/77636\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### è´Ÿè½½å‡è¡¡\r\n\r\nè´Ÿè½½å‡è¡¡æ˜¯åº”ç”¨ä¸­ä½¿ç”¨éå¸¸æ™®éçš„ä¸€ç§ä¼˜åŒ–æ–¹æ³•ï¼Œæœºåˆ¶å°±æ˜¯åˆ©ç”¨æŸç§å‡è¡¡ç®—æ³•ï¼Œå°†å›ºå®šçš„è´Ÿè½½é‡åˆ†å¸ƒåˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä»¥æ­¤æ¥é™ä½å•å°æœåŠ¡å™¨çš„è´Ÿè½½ï¼Œè¾¾åˆ°ä¼˜åŒ–çš„æ•ˆæœ\r\n\r\n* åˆ†æµæŸ¥è¯¢ï¼šé€šè¿‡ MySQL çš„ä¸»ä»å¤åˆ¶ï¼Œå®ç°è¯»å†™åˆ†ç¦»ï¼Œä½¿å¢åˆ æ”¹æ“ä½œèµ°ä¸»èŠ‚ç‚¹ï¼ŒæŸ¥è¯¢æ“ä½œèµ°ä»èŠ‚ç‚¹ï¼Œä»è€Œå¯ä»¥é™ä½å•å°æœåŠ¡å™¨çš„è¯»å†™å‹åŠ›\r\n\r\n  ![image-20250320012913617](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012913617.png)\r\n\r\n* åˆ†å¸ƒå¼æ•°æ®åº“æ¶æ„ï¼šé€‚åˆå¤§æ•°æ®é‡ã€è´Ÿè½½é«˜çš„æƒ…å†µï¼Œå…·æœ‰è‰¯å¥½çš„æ‹“å±•æ€§å’Œé«˜å¯ç”¨æ€§ã€‚é€šè¿‡åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´åˆ†å¸ƒæ•°æ®ï¼Œå¯ä»¥å®ç°åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´çš„è´Ÿè½½å‡è¡¡ï¼Œæé«˜è®¿é—®æ•ˆç‡\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### ä¸»ä»æ­å»º\r\n\r\n#### master\r\n\r\n1. åœ¨master çš„é…ç½®æ–‡ä»¶ï¼ˆ/etc/mysql/my.cnfï¼‰ä¸­ï¼Œé…ç½®å¦‚ä¸‹å†…å®¹ï¼š\r\n\r\n   ```sh\r\n   #mysql æœåŠ¡ID,ä¿è¯æ•´ä¸ªé›†ç¾¤ç¯å¢ƒä¸­å”¯ä¸€\r\n   server-id=1\r\n   \r\n   #mysql binlog æ—¥å¿—çš„å­˜å‚¨è·¯å¾„å’Œæ–‡ä»¶å\r\n   log-bin=/var/lib/mysql/mysqlbin\r\n   \r\n   #é”™è¯¯æ—¥å¿—,é»˜è®¤å·²ç»å¼€å¯\r\n   #log-err\r\n   \r\n   #mysqlçš„å®‰è£…ç›®å½•\r\n   #basedir\r\n   \r\n   #mysqlçš„ä¸´æ—¶ç›®å½•\r\n   #tmpdir\r\n   \r\n   #mysqlçš„æ•°æ®å­˜æ”¾ç›®å½•\r\n   #datadir\r\n   \r\n   #æ˜¯å¦åªè¯»,1 ä»£è¡¨åªè¯», 0 ä»£è¡¨è¯»å†™\r\n   read-only=0\r\n   \r\n   #å¿½ç•¥çš„æ•°æ®, æŒ‡ä¸éœ€è¦åŒæ­¥çš„æ•°æ®åº“\r\n   binlog-ignore-db=mysql\r\n   \r\n   #æŒ‡å®šåŒæ­¥çš„æ•°æ®åº“\r\n   #binlog-do-db=db01\r\n   ```\r\n\r\n2. æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œéœ€è¦é‡å¯ MySQL\r\n\r\n3. åˆ›å»ºåŒæ­¥æ•°æ®çš„è´¦æˆ·ï¼Œå¹¶ä¸”è¿›è¡Œæˆæƒæ“ä½œï¼š\r\n\r\n   ```sql\r\n   GRANT REPLICATION SLAVE ON *.* TO 'klaus'@'192.168.0.137' IDENTIFIED BY '123456';\r\n   FLUSH PRIVILEGES;\r\n   ```\r\n\r\n4. æŸ¥çœ‹ master çŠ¶æ€ï¼š\r\n\r\n   ```sql\r\n   SHOW MASTER STATUS;\r\n   ```\r\n\r\n   ![image-20250320012950363](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012950363.png)\r\n\r\n   * Fileï¼šä»å“ªä¸ªæ—¥å¿—æ–‡ä»¶å¼€å§‹æ¨é€æ—¥å¿—æ–‡ä»¶ \r\n   * Positionï¼šä»å“ªä¸ªä½ç½®å¼€å§‹æ¨é€æ—¥å¿—\r\n   * Binlog_Ignore_DBï¼šæŒ‡å®šä¸éœ€è¦åŒæ­¥çš„æ•°æ®åº“\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### slave\r\n\r\n1. åœ¨ slave ç«¯é…ç½®æ–‡ä»¶ä¸­ï¼Œé…ç½®å¦‚ä¸‹å†…å®¹ï¼š\r\n\r\n   ```sh\r\n   #mysqlæœåŠ¡ç«¯ID,å”¯ä¸€\r\n   server-id=2\r\n   \r\n   #æŒ‡å®šbinlogæ—¥å¿—\r\n   log-bin=/var/lib/mysql/mysqlbin\r\n   ```\r\n\r\n2. æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œéœ€è¦é‡å¯ MySQL\r\n\r\n3. æŒ‡å®šå½“å‰ä»åº“å¯¹åº”çš„ä¸»åº“çš„IPåœ°å€ã€ç”¨æˆ·åã€å¯†ç ï¼Œä»å“ªä¸ªæ—¥å¿—æ–‡ä»¶å¼€å§‹çš„é‚£ä¸ªä½ç½®å¼€å§‹åŒæ­¥æ¨é€æ—¥å¿—\r\n\r\n   ```sql\r\n   CHANGE MASTER TO MASTER_HOST= '192.168.0.138', MASTER_USER='klaus', MASTER_PASSWORD='klaus', MASTER_LOG_FILE='mysqlbin.000001', MASTER_LOG_POS=413;\r\n   ```\r\n\r\n4. å¼€å¯åŒæ­¥æ“ä½œï¼š\r\n\r\n   ```sql\r\n   START SLAVE;\r\n   SHOW SLAVE STATUS;\r\n   ```\r\n\r\n5. åœæ­¢åŒæ­¥æ“ä½œï¼š\r\n\r\n   ```sql\r\n   STOP SLAVE;\r\n   ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### éªŒè¯\r\n\r\n1. åœ¨ä¸»åº“ä¸­åˆ›å»ºæ•°æ®åº“ï¼Œåˆ›å»ºè¡¨å¹¶æ’å…¥æ•°æ®ï¼š\r\n\r\n   ```sql\r\n   CREATE DATABASE db01;\r\n   USE db01;\r\n   CREATE TABLE user(\r\n   \tid INT(11) NOT NULL AUTO_INCREMENT,\r\n   \tname VARCHAR(50) NOT NULL,\r\n   \tsex VARCHAR(1),\r\n   \tPRIMARY KEY (id)\r\n   )ENGINE=INNODB DEFAULT CHARSET=utf8;\r\n   \r\n   INSERT INTO user(id,NAME,sex) VALUES(NULL,'Tom','1');\r\n   INSERT INTO user(id,NAME,sex) VALUES(NULL,'Trigger','0');\r\n   INSERT INTO user(id,NAME,sex) VALUES(NULL,'Dawn','1');\r\n   ```\r\n\r\n2. åœ¨ä»åº“ä¸­æŸ¥è¯¢æ•°æ®ï¼Œè¿›è¡ŒéªŒè¯ï¼š\r\n\r\n   åœ¨ä»åº“ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°åˆšæ‰åˆ›å»ºçš„æ•°æ®åº“ï¼š\r\n\r\n   ![image-20250320013022810](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013022810.png)\r\n\r\n   åœ¨è¯¥æ•°æ®åº“ä¸­ï¼ŒæŸ¥è¯¢è¡¨ä¸­çš„æ•°æ®ï¼š\r\n\r\n   ![image-20250320013033136](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013033136.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ä¸»ä»åˆ‡æ¢\r\n\r\n#### æ­£å¸¸åˆ‡æ¢\r\n\r\næ­£å¸¸åˆ‡æ¢æ­¥éª¤ï¼š\r\n\r\n* åœ¨å¼€å§‹åˆ‡æ¢ä¹‹å‰å…ˆå¯¹ä¸»åº“è¿›è¡Œé”è¡¨ `flush tables with read lock`ï¼Œç„¶åç­‰å¾…æ‰€æœ‰è¯­å¥æ‰§è¡Œå®Œæˆï¼Œåˆ‡æ¢å®Œæˆåå¯ä»¥é‡Šæ”¾é”\r\n\r\n* æ£€æŸ¥ slave åŒæ­¥çŠ¶æ€ï¼Œåœ¨ slave æ‰§è¡Œ `show processlist`\r\n\r\n* åœæ­¢ slave io çº¿ç¨‹ï¼Œæ‰§è¡Œå‘½ä»¤ `STOP SLAVE IO_THREAD`\r\n\r\n* æå‡ slave ä¸º master\r\n\r\n  ```sql\r\n  Stop slave;\r\n  Reset master;\r\n  Reset slave all;\r\n  set global read_only=off;\t-- è®¾ç½®ä¸ºå¯æ›´æ–°çŠ¶æ€\r\n  ```\r\n\r\n* å°†åŸæ¥ master å˜ä¸º slaveï¼ˆå‚è€ƒæ­å»ºæµç¨‹ä¸­çš„ slave æ–¹æ³•ï¼‰\r\n\r\n**å¯é æ€§ä¼˜å…ˆç­–ç•¥**ï¼š\r\n\r\n* åˆ¤æ–­å¤‡åº“ B ç°åœ¨çš„ seconds_behind_masterï¼Œå¦‚æœå°äºæŸä¸ªå€¼ï¼ˆæ¯”å¦‚ 5 ç§’ï¼‰ç»§ç»­ä¸‹ä¸€æ­¥ï¼Œå¦åˆ™æŒç»­é‡è¯•è¿™ä¸€æ­¥\r\n* æŠŠä¸»åº“ A æ”¹æˆåªè¯»çŠ¶æ€ï¼Œå³æŠŠ readonly è®¾ç½®ä¸º true\r\n* åˆ¤æ–­å¤‡åº“ B çš„ seconds_behind_master çš„å€¼ï¼Œç›´åˆ°è¿™ä¸ªå€¼å˜æˆ 0 ä¸ºæ­¢ï¼ˆè¯¥æ­¥éª¤æ¯”è¾ƒè€—æ—¶ï¼Œæ‰€ä»¥æ­¥éª¤ 1 ä¸­è¦å°½é‡ç­‰å¾…è¯¥å€¼å˜å°ï¼‰\r\n* æŠŠå¤‡åº“ B æ”¹æˆå¯è¯»å†™çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æŠŠ readonly è®¾ç½®ä¸º false\r\n* æŠŠä¸šåŠ¡è¯·æ±‚åˆ‡åˆ°å¤‡åº“ B\r\n\r\nå¯ç”¨æ€§ä¼˜å…ˆç­–ç•¥ï¼šå…ˆåšæœ€åä¸¤æ­¥ï¼Œä¼šé€ æˆä¸»å¤‡æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/76795\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å¥åº·æ£€æµ‹\r\n\r\nä¸»åº“å‘ç”Ÿæ•…éšœåä»åº“ä¼šä¸Šä½ï¼Œ**å…¶ä»–ä»åº“æŒ‡å‘æ–°çš„ä¸»åº“**ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå¥åº·æ£€æµ‹çš„æœºåˆ¶æ¥åˆ¤æ–­ä¸»åº“æ˜¯å¦å®•æœº\r\n\r\n* select 1 åˆ¤æ–­ï¼Œä½†æ˜¯é«˜å¹¶å‘ä¸‹æ£€æµ‹ä¸å‡ºçº¿ç¨‹çš„é”ç­‰å¾…çš„é˜»å¡é—®é¢˜\r\n\r\n* æŸ¥è¡¨åˆ¤æ–­ï¼Œåœ¨ç³»ç»Ÿåº“ï¼ˆmysql åº“ï¼‰é‡Œåˆ›å»ºä¸€ä¸ªè¡¨ï¼Œæ¯”å¦‚å‘½åä¸º health_checkï¼Œé‡Œé¢åªæ”¾ä¸€è¡Œæ•°æ®ï¼Œç„¶åå®šæœŸæ‰§è¡Œã€‚ä½†æ˜¯å½“ binlog æ‰€åœ¨ç£ç›˜çš„ç©ºé—´å ç”¨ç‡è¾¾åˆ° 100%ï¼Œæ‰€æœ‰çš„æ›´æ–°å’Œäº‹åŠ¡æäº¤è¯­å¥éƒ½è¢«é˜»å¡ï¼ŒæŸ¥è¯¢è¯­å¥å¯ä»¥ç»§ç»­è¿è¡Œ\r\n\r\n* æ›´æ–°åˆ¤æ–­ï¼Œåœ¨å¥åº·æ£€æµ‹è¡¨ä¸­æ”¾ä¸€ä¸ª timestamp å­—æ®µï¼Œç”¨æ¥è¡¨ç¤ºæœ€åä¸€æ¬¡æ‰§è¡Œæ£€æµ‹çš„æ—¶é—´\r\n\r\n  ```sql\r\n  UPDATE mysql.health_check SET t_modified=now();\r\n  ```\r\n\r\n  èŠ‚ç‚¹å¯ç”¨æ€§çš„æ£€æµ‹éƒ½åº”è¯¥åŒ…å«ä¸»åº“å’Œå¤‡åº“ï¼Œä¸ºäº†è®©ä¸»å¤‡ä¹‹é—´çš„æ›´æ–°ä¸äº§ç”Ÿå†²çªï¼Œå¯ä»¥åœ¨ mysql.health_check è¡¨ä¸Šå­˜å…¥å¤šè¡Œæ•°æ®ï¼Œå¹¶ç”¨ä¸»å¤‡çš„ server_id åšä¸»é”®ï¼Œä¿è¯ä¸»ã€å¤‡åº“å„è‡ªçš„æ£€æµ‹å‘½ä»¤ä¸ä¼šå‘ç”Ÿå†²çª\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n\r\n\r\n#### åŸºäºä½ç‚¹\r\n\r\nä¸»åº“ä¸Šä½åï¼Œä»åº“ B æ‰§è¡Œ CHANGE MASTER TO å‘½ä»¤ï¼ŒæŒ‡å®š MASTER_LOG_FILEã€MASTER_LOG_POS è¡¨ç¤ºä»æ–°ä¸»åº“ A çš„å“ªä¸ªæ–‡ä»¶çš„å“ªä¸ªä½ç‚¹å¼€å§‹åŒæ­¥ï¼Œè¿™ä¸ªä½ç½®å°±æ˜¯**åŒæ­¥ä½ç‚¹**ï¼Œå¯¹åº”ä¸»åº“çš„æ–‡ä»¶åå’Œæ—¥å¿—åç§»é‡\r\n\r\nå¯»æ‰¾ä½ç‚¹éœ€è¦æ‰¾ä¸€ä¸ªç¨å¾®å¾€å‰çš„ï¼Œç„¶åå†é€šè¿‡åˆ¤æ–­è·³è¿‡é‚£äº›åœ¨ä»åº“ B ä¸Šå·²ç»æ‰§è¡Œè¿‡çš„äº‹åŠ¡ï¼Œè·å–ä½ç‚¹æ–¹æ³•ï¼š\r\n\r\n* ç­‰å¾…æ–°ä¸»åº“ A æŠŠä¸­è½¬æ—¥å¿—ï¼ˆrelay logï¼‰å…¨éƒ¨åŒæ­¥å®Œæˆ\r\n* åœ¨ A ä¸Šæ‰§è¡Œ show master status å‘½ä»¤ï¼Œå¾—åˆ°å½“å‰ A ä¸Šæœ€æ–°çš„ File å’Œ Position\r\n* å–åŸä¸»åº“æ•…éšœçš„æ—¶åˆ» Tï¼Œç”¨ mysqlbinlog å·¥å…·è§£ææ–°ä¸»åº“ A çš„ Fileï¼Œå¾—åˆ° T æ—¶åˆ»çš„ä½ç‚¹\r\n\r\né€šå¸¸æƒ…å†µä¸‹è¯¥å€¼å¹¶ä¸å‡†ç¡®ï¼Œåœ¨åˆ‡æ¢çš„è¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿé”™è¯¯ï¼Œæ‰€ä»¥è¦å…ˆä¸»åŠ¨è·³è¿‡è¿™äº›é”™è¯¯ï¼š\r\n\r\n* åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šé‡å¤æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰€ä»¥éœ€è¦ä¸»åŠ¨è·³è¿‡æ‰€æœ‰é‡å¤çš„äº‹åŠ¡\r\n\r\n  ```sql\r\n  SET GLOBAL sql_slave_skip_counter=1;\r\n  START SLAVE;\r\n  ```\r\n\r\n* è®¾ç½® slave_skip_errors å‚æ•°ï¼Œç›´æ¥è®¾ç½®è·³è¿‡æŒ‡å®šçš„é”™è¯¯ï¼Œä¿è¯ä¸»ä»åˆ‡æ¢çš„æ­£å¸¸è¿›è¡Œ\r\n\r\n  * 1062 é”™è¯¯æ˜¯æ’å…¥æ•°æ®æ—¶å”¯ä¸€é”®å†²çª\r\n  * 1032 é”™è¯¯æ˜¯åˆ é™¤æ•°æ®æ—¶æ‰¾ä¸åˆ°è¡Œ\r\n\r\n  è¯¥æ–¹æ³•é’ˆå¯¹çš„æ˜¯ä¸»å¤‡åˆ‡æ¢æ—¶ï¼Œç”±äºæ‰¾ä¸åˆ°ç²¾ç¡®çš„åŒæ­¥ä½ç‚¹ï¼Œåªèƒ½é‡‡ç”¨è¿™ç§æ–¹æ³•æ¥åˆ›å»ºä»åº“å’Œæ–°ä¸»åº“çš„ä¸»å¤‡å…³ç³»ã€‚ç­‰åˆ°ä¸»å¤‡é—´çš„åŒæ­¥å…³ç³»å»ºç«‹å®Œæˆå¹¶ç¨³å®šæ‰§è¡Œä¸€æ®µæ—¶é—´åï¼Œè¿˜éœ€è¦æŠŠè¿™ä¸ªå‚æ•°è®¾ç½®ä¸ºç©ºï¼Œä»¥å…çœŸçš„å‡ºç°äº†ä¸»ä»æ•°æ®ä¸ä¸€è‡´ä¹Ÿè·³è¿‡äº†\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### åŸºäºGTID\r\n\r\n##### GTID\r\n\r\nGTID çš„å…¨ç§°æ˜¯ Global Transaction Identifierï¼Œå…¨å±€äº‹åŠ¡ IDï¼Œæ˜¯ä¸€ä¸ªäº‹åŠ¡**åœ¨æäº¤æ—¶ç”Ÿæˆ**çš„ï¼Œæ˜¯è¿™ä¸ªäº‹åŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œç»„æˆï¼š\r\n\r\n```sql\r\nGTID=source_id:transaction_id\r\n```\r\n\r\n* source_idï¼šæ˜¯ä¸€ä¸ªå®ä¾‹ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å€¼\r\n* transaction_idï¼šåˆå§‹å€¼æ˜¯ 1ï¼Œæ¯æ¬¡æäº¤äº‹åŠ¡çš„æ—¶å€™åˆ†é…ç»™è¿™ä¸ªäº‹åŠ¡ï¼Œå¹¶åŠ  1ï¼Œæ˜¯è¿ç»­çš„ï¼ˆåŒºåˆ†äº‹åŠ¡ IDï¼Œäº‹åŠ¡ ID æ˜¯åœ¨æ‰§è¡Œæ—¶ç”Ÿæˆï¼‰\r\n\r\nå¯åŠ¨ MySQL å®ä¾‹æ—¶ï¼ŒåŠ ä¸Šå‚æ•° `gtid_mode=on` å’Œ `enforce_gtid_consistency=on` å°±å¯ä»¥å¯åŠ¨ GTID æ¨¡å¼ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½ä¼šå’Œä¸€ä¸ª GTID ä¸€ä¸€å¯¹åº”ï¼Œæ¯ä¸ª MySQL å®ä¾‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ª GTID é›†åˆï¼Œç”¨æ¥å­˜å‚¨å½“å‰å®ä¾‹**æ‰§è¡Œè¿‡çš„æ‰€æœ‰äº‹åŠ¡**\r\n\r\nGTID æœ‰ä¸¤ç§ç”Ÿæˆæ–¹å¼ï¼Œä½¿ç”¨å“ªç§æ–¹å¼å–å†³äº session å˜é‡ gtid_nextï¼š\r\n\r\n* `gtid_next=automatic`ï¼šä½¿ç”¨é»˜è®¤å€¼ï¼ŒæŠŠ source_id:transaction_id ï¼ˆé€’å¢ï¼‰åˆ†é…ç»™è¿™ä¸ªäº‹åŠ¡ï¼Œç„¶ååŠ å…¥æœ¬å®ä¾‹çš„ GTID é›†åˆ\r\n\r\n  ```sql\r\n  @@SESSION.GTID_NEXT = 'source_id:transaction_id';\r\n  ```\r\n\r\n* `gtid_next=GTID`ï¼šæŒ‡å®šçš„ GTID çš„å€¼ï¼Œå¦‚æœè¯¥å€¼å·²ç»å­˜åœ¨äºå®ä¾‹çš„ GTID é›†åˆä¸­ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œçš„äº‹åŠ¡ä¼šç›´æ¥è¢«ç³»ç»Ÿå¿½ç•¥ï¼›åä¹‹å°±å°†è¯¥å€¼åˆ†é…ç»™æ¥ä¸‹æ¥è¦æ‰§è¡Œçš„äº‹åŠ¡ï¼Œç³»ç»Ÿä¸éœ€è¦ç»™è¿™ä¸ªäº‹åŠ¡ç”Ÿæˆæ–°çš„ GTIDï¼Œä¹Ÿä¸ç”¨åŠ  1\r\n\r\n  æ³¨æ„ï¼šä¸€ä¸ª GTID åªèƒ½ç»™ä¸€ä¸ªäº‹åŠ¡ä½¿ç”¨ï¼Œæ‰€ä»¥æ‰§è¡Œä¸‹ä¸€ä¸ªäº‹åŠ¡ï¼Œè¦æŠŠ gtid_next è®¾ç½®æˆå¦å¤–ä¸€ä¸ª GTID æˆ–è€… automatic\r\n\r\nä¸šåŠ¡åœºæ™¯ï¼š\r\n\r\n* ä¸»åº“ X å’Œä»åº“ Y æ‰§è¡Œä¸€æ¡ç›¸åŒçš„æŒ‡ä»¤åè¿›è¡Œäº‹åŠ¡åŒæ­¥\r\n\r\n  ```sql\r\n  INSERT INTO t VALUES(1,1);\r\n  ```\r\n\r\n* å½“ Y åŒæ­¥ X æ—¶ï¼Œä¼šå‡ºç°ä¸»é”®å†²çªï¼Œå¯¼è‡´å®ä¾‹ X çš„åŒæ­¥çº¿ç¨‹åœæ­¢ï¼Œè§£å†³æ–¹æ³•ï¼š\r\n\r\n  ```sql\r\n  SET gtid_next='(è¿™é‡Œæ˜¯ä¸»åº“ X çš„ GTID å€¼)';\r\n  BEGIN;\r\n  COMMIT;\r\n  SET gtid_next=automatic;\r\n  START SLAVE;\r\n  ```\r\n\r\n  å‰ä¸‰æ¡è¯­å¥é€šè¿‡**æäº¤ä¸€ä¸ªç©ºäº‹åŠ¡**ï¼ŒæŠŠ X çš„ GTID åŠ åˆ°å®ä¾‹ Y çš„ GTID é›†åˆä¸­ï¼Œå®ä¾‹ Y å°±ä¼šç›´æ¥è·³è¿‡è¿™ä¸ªäº‹åŠ¡\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n##### åˆ‡æ¢\r\n\r\nåœ¨ GTID æ¨¡å¼ä¸‹ï¼ŒCHANGE MASTER TO ä¸éœ€è¦æŒ‡å®šæ—¥å¿—åå’Œæ—¥å¿—åç§»é‡ï¼ŒæŒ‡å®š `master_auto_position=1` ä»£è¡¨ä½¿ç”¨ GTID æ¨¡å¼\r\n\r\næ–°ä¸»åº“å®ä¾‹ A çš„ GTID é›†åˆè®°ä¸º set_aï¼Œä»åº“å®ä¾‹ B çš„ GTID é›†åˆè®°ä¸º set_bï¼Œä¸»å¤‡åˆ‡æ¢é€»è¾‘ï¼š\r\n\r\n* å®ä¾‹ B æŒ‡å®šä¸»åº“ Aï¼ŒåŸºäºä¸»å¤‡åè®®å»ºç«‹è¿æ¥ï¼Œå®ä¾‹ B å¹¶æŠŠ set_b å‘ç»™ä¸»åº“ A\r\n* å®ä¾‹ A ç®—å‡º set_a ä¸ set_b çš„å·®é›†ï¼Œå°±æ˜¯æ‰€æœ‰å­˜åœ¨äº set_a ä½†ä¸å­˜åœ¨äº set_b çš„ GTID çš„é›†åˆï¼Œåˆ¤æ–­ A æœ¬åœ°æ˜¯å¦åŒ…å«äº†è¿™ä¸ª**å·®é›†**éœ€è¦çš„æ‰€æœ‰ binlog äº‹åŠ¡\r\n  * å¦‚æœä¸åŒ…å«ï¼Œè¡¨ç¤º A å·²ç»æŠŠå®ä¾‹ B éœ€è¦çš„ binlog ç»™åˆ æ‰äº†ï¼Œç›´æ¥è¿”å›é”™è¯¯\r\n  * å¦‚æœç¡®è®¤å…¨éƒ¨åŒ…å«ï¼ŒA ä»è‡ªå·±çš„ binlog æ–‡ä»¶é‡Œé¢ï¼Œæ‰¾å‡ºç¬¬ä¸€ä¸ªä¸åœ¨ set_b çš„äº‹åŠ¡ï¼Œå‘ç»™ B\r\n* å®ä¾‹ A ä¹‹åå°±ä»è¿™ä¸ªäº‹åŠ¡å¼€å§‹ï¼Œå¾€åè¯»æ–‡ä»¶ï¼ŒæŒ‰é¡ºåºå– binlog å‘ç»™ B å»æ‰§è¡Œ\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/77427\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"MySQL - ä¼˜åŒ–","tags":["SQL"],"categories":["MySQL","ä¼˜åŒ–ç¯‡"],"author":"imklaus","excerpt":"\r\nç›®å½•æŒ‡å¼•ï¼š\r\n\r\n[[toc]]\r\n\r\n## è¡¨ä¼˜åŒ–\r\n\r\n### åˆ†åŒºè¡¨\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\nåˆ†åŒºè¡¨æ˜¯å°†å¤§è¡¨çš„æ•°æ®æŒ‰åˆ†åŒºå­—æ®µåˆ†æˆè®¸å¤šå°çš„å­é›†ï¼Œå»ºç«‹ä¸€ä¸ªä»¥ ftime å¹´ä»½ä¸ºåˆ†åŒºçš„è¡¨ï¼š","link":"/posts/MySQL_Optimization","content":"\r\nç›®å½•æŒ‡å¼•ï¼š\r\n\r\n[[toc]]\r\n\r\n## è¡¨ä¼˜åŒ–\r\n\r\n### åˆ†åŒºè¡¨\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\nåˆ†åŒºè¡¨æ˜¯å°†å¤§è¡¨çš„æ•°æ®æŒ‰åˆ†åŒºå­—æ®µåˆ†æˆè®¸å¤šå°çš„å­é›†ï¼Œå»ºç«‹ä¸€ä¸ªä»¥ ftime å¹´ä»½ä¸ºåˆ†åŒºçš„è¡¨ï¼š\r\n\r\n```sql\r\nCREATE TABLE `t` (\r\n    `ftime` datetime NOT NULL,\r\n    `c` int(11) DEFAULT NULL,\r\n    KEY (`ftime`)\r\n) ENGINE=InnoDB DEFAULT CHARSET=latin1\r\nPARTITION BY RANGE (YEAR(ftime))\r\n(PARTITION p_2017 VALUES LESS THAN (2017) ENGINE = InnoDB,\r\n PARTITION p_2018 VALUES LESS THAN (2018) ENGINE = InnoDB,\r\n PARTITION p_2019 VALUES LESS THAN (2019) ENGINE = InnoDB,\r\n PARTITION p_others VALUES LESS THAN MAXVALUE ENGINE = InnoDB);\r\nINSERT INTO t VALUES('2017-4-1',1),('2018-4-1',1);-- è¿™ä¸¤è¡Œè®°å½•åˆ†åˆ«è½åœ¨ p_2018 å’Œ p_2019 è¿™ä¸¤ä¸ªåˆ†åŒºä¸Š\r\n```\r\n\r\nè¿™ä¸ªè¡¨åŒ…å«äº†ä¸€ä¸ª.frm æ–‡ä»¶å’Œ 4 ä¸ª.ibd æ–‡ä»¶ï¼Œæ¯ä¸ªåˆ†åŒºå¯¹åº”ä¸€ä¸ª.ibd æ–‡ä»¶\r\n\r\n* å¯¹äºå¼•æ“å±‚æ¥è¯´ï¼Œè¿™æ˜¯ 4 ä¸ªè¡¨ï¼Œé’ˆå¯¹æ¯ä¸ªåˆ†åŒºè¡¨çš„æ“ä½œä¸ä¼šç›¸äº’å½±å“\r\n* å¯¹äº Server å±‚æ¥è¯´ï¼Œè¿™æ˜¯ 1 ä¸ªè¡¨\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åˆ†åŒºç­–ç•¥\r\n\r\næ‰“å¼€è¡¨è¡Œä¸ºï¼šç¬¬ä¸€æ¬¡è®¿é—®ä¸€ä¸ªåˆ†åŒºè¡¨æ—¶ï¼ŒMySQL éœ€è¦**æŠŠæ‰€æœ‰çš„åˆ†åŒºéƒ½è®¿é—®ä¸€é**ï¼Œå¦‚æœåˆ†åŒºè¡¨çš„æ•°é‡å¾ˆå¤šï¼Œè¶…è¿‡äº† open_files_limit å‚æ•°ï¼ˆé»˜è®¤å€¼ 1024ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨è®¿é—®è¿™ä¸ªè¡¨æ—¶æ‰“å¼€æ‰€æœ‰çš„æ–‡ä»¶ï¼Œå¯¼è‡´æ‰“å¼€è¡¨æ–‡ä»¶çš„ä¸ªæ•°è¶…è¿‡äº†ä¸Šé™è€ŒæŠ¥é”™\r\n\r\né€šç”¨åˆ†åŒºç­–ç•¥ï¼šMyISAM åˆ†åŒºè¡¨ä½¿ç”¨çš„åˆ†åŒºç­–ç•¥ï¼Œæ¯æ¬¡è®¿é—®åˆ†åŒºéƒ½ç”± Server å±‚æ§åˆ¶ï¼Œåœ¨æ–‡ä»¶ç®¡ç†ã€è¡¨ç®¡ç†çš„å®ç°ä¸Šå¾ˆç²—ç³™ï¼Œå› æ­¤æœ‰æ¯”è¾ƒä¸¥é‡çš„æ€§èƒ½é—®é¢˜\r\n\r\næœ¬åœ°åˆ†åŒºç­–ç•¥ï¼šä» MySQL 5.7.9 å¼€å§‹ï¼ŒInnoDB å¼•æ“å†…éƒ¨è‡ªå·±ç®¡ç†æ‰“å¼€åˆ†åŒºçš„è¡Œä¸ºï¼ŒInnoDB å¼•æ“æ‰“å¼€æ–‡ä»¶è¶…è¿‡ innodb_open_files æ—¶å°±ä¼š**å…³æ‰ä¸€äº›ä¹‹å‰æ‰“å¼€çš„æ–‡ä»¶**ï¼Œæ‰€ä»¥å³ä½¿åˆ†åŒºä¸ªæ•°å¤§äº open_files_limitï¼Œä¹Ÿä¸ä¼šæŠ¥é”™\r\n\r\nä» MySQL 8.0 ç‰ˆæœ¬å¼€å§‹ï¼Œå°±ä¸å…è®¸åˆ›å»º MyISAM åˆ†åŒºè¡¨ï¼Œåªå…è®¸åˆ›å»ºå·²ç»å®ç°äº†æœ¬åœ°åˆ†åŒºç­–ç•¥çš„å¼•æ“ï¼Œç›®å‰åªæœ‰ InnoDB å’Œ NDB è¿™ä¸¤ä¸ªå¼•æ“æ”¯æŒäº†æœ¬åœ°åˆ†åŒºç­–ç•¥\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### Server å±‚\r\n\r\nä» Server å±‚çœ‹ä¸€ä¸ªåˆ†åŒºè¡¨å°±åªæ˜¯ä¸€ä¸ªè¡¨\r\n\r\n* Session Aï¼š\r\n\r\n  ```sql\r\n  SELECT * FROM t WHERE ftime = '2018-4-1';\r\n  ```\r\n\r\n* Session Bï¼š\r\n\r\n  ```sql\r\n  ALTER TABLE t TRUNCATE PARTITION p_2017; -- blocked\r\n  ```\r\n\r\nç°è±¡ï¼šSession B åªæ“ä½œ p_2017 åˆ†åŒºï¼Œä½†æ˜¯ç”±äº Session A æŒæœ‰æ•´ä¸ªè¡¨ t çš„ MDL è¯»é”ï¼Œå°±å¯¼è‡´ B çš„ ALTER è¯­å¥è·å– MDL å†™é”é˜»å¡\r\n\r\nåˆ†åŒºè¡¨çš„ç‰¹ç‚¹ï¼š\r\n\r\n* ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™éœ€è¦è®¿é—®æ‰€æœ‰åˆ†åŒº\r\n* åœ¨ Server å±‚è®¤ä¸ºè¿™æ˜¯åŒä¸€å¼ è¡¨ï¼Œå› æ­¤**æ‰€æœ‰åˆ†åŒºå…±ç”¨åŒä¸€ä¸ª MDL é”**\r\n* åœ¨å¼•æ“å±‚è®¤ä¸ºè¿™æ˜¯ä¸åŒçš„è¡¨ï¼Œå› æ­¤ MDL é”ä¹‹åçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä¼šæ ¹æ®åˆ†åŒºè¡¨è§„åˆ™ï¼Œåªè®¿é—®éœ€è¦çš„åˆ†åŒº\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åº”ç”¨åœºæ™¯\r\n\r\nåˆ†åŒºè¡¨çš„ä¼˜ç‚¹ï¼š\r\n\r\n* å¯¹ä¸šåŠ¡é€æ˜ï¼Œç›¸å¯¹äºç”¨æˆ·åˆ†è¡¨æ¥è¯´ï¼Œä½¿ç”¨åˆ†åŒºè¡¨çš„ä¸šåŠ¡ä»£ç æ›´ç®€æ´\r\n\r\n* åˆ†åŒºè¡¨å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ¸…ç†å†å²æ•°æ®ã€‚æŒ‰ç…§æ—¶é—´åˆ†åŒºçš„åˆ†åŒºè¡¨ï¼Œå°±å¯ä»¥ç›´æ¥é€šè¿‡ `alter table t drop partition` è¿™ä¸ªè¯­æ³•ç›´æ¥åˆ é™¤åˆ†åŒºæ–‡ä»¶ï¼Œä»è€Œåˆ æ‰è¿‡æœŸçš„å†å²æ•°æ®ï¼Œä¸ä½¿ç”¨ drop è¯­å¥åˆ é™¤æ•°æ®ç›¸æ¯”ï¼Œä¼˜åŠ¿æ˜¯é€Ÿåº¦å¿«ã€å¯¹ç³»ç»Ÿå½±å“å°\r\n\r\nä½¿ç”¨åˆ†åŒºè¡¨ï¼Œä¸å»ºè®®åˆ›å»ºå¤ªå¤šçš„åˆ†åŒºï¼Œæ³¨æ„äº‹é¡¹ï¼š\r\n\r\n* åˆ†åŒºå¹¶ä¸æ˜¯è¶Šç»†è¶Šå¥½ï¼Œå•è¡¨æˆ–è€…å•åˆ†åŒºçš„æ•°æ®ä¸€åƒä¸‡è¡Œï¼Œåªè¦æ²¡æœ‰ç‰¹åˆ«å¤§çš„ç´¢å¼•ï¼Œå¯¹äºç°åœ¨çš„ç¡¬ä»¶èƒ½åŠ›æ¥è¯´éƒ½å·²ç»æ˜¯å°è¡¨\r\n* åˆ†åŒºä¸è¦æå‰é¢„ç•™å¤ªå¤šï¼Œåœ¨ä½¿ç”¨ä¹‹å‰é¢„å…ˆåˆ›å»ºå³å¯ã€‚æ¯”å¦‚æ˜¯æŒ‰æœˆåˆ†åŒºï¼Œæ¯å¹´å¹´åº•æ—¶å†æŠŠä¸‹ä¸€å¹´åº¦çš„ 12 ä¸ªæ–°åˆ†åŒºåˆ›å»ºä¸Šå³å¯ï¼Œå¹¶ä¸”å¯¹äºæ²¡æœ‰æ•°æ®çš„å†å²åˆ†åŒºï¼Œè¦åŠæ—¶çš„ drop æ‰\r\n\r\n\r\n\r\nå‚è€ƒæ–‡æ¡£ï¼šhttps://time.geekbang.org/column/article/82560\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ä¸´æ—¶è¡¨\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\nä¸´æ—¶è¡¨åˆ†ä¸ºå†…éƒ¨ä¸´æ—¶è¡¨å’Œç”¨æˆ·ä¸´æ—¶è¡¨\r\n\r\n* å†…éƒ¨ä¸´æ—¶è¡¨ï¼šç³»ç»Ÿæ‰§è¡Œ SQL è¯­å¥ä¼˜åŒ–æ—¶äº§ç”Ÿçš„è¡¨ï¼Œä¾‹å¦‚ Join è¿æ¥æŸ¥è¯¢ã€å»é‡æŸ¥è¯¢ç­‰\r\n\r\n* ç”¨æˆ·ä¸´æ—¶è¡¨ï¼šç”¨æˆ·ä¸»åŠ¨åˆ›å»ºçš„ä¸´æ—¶è¡¨\r\n\r\n  ```sql\r\n  CREATE TEMPORARY TABLE temp_t like table_1;\r\n  ```\r\n\r\nä¸´æ—¶è¡¨å¯ä»¥æ˜¯å†…å­˜è¡¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ç£ç›˜è¡¨ï¼ˆå¤šè¡¨æ“ä½œ â†’ åµŒå¥—æŸ¥è¯¢ç« èŠ‚æåŠï¼‰\r\n\r\n* å†…å­˜è¡¨æŒ‡çš„æ˜¯ä½¿ç”¨ Memory å¼•æ“çš„è¡¨ï¼Œå»ºç«‹å“ˆå¸Œç´¢å¼•ï¼Œå»ºè¡¨è¯­æ³•æ˜¯ `create table â€¦ engine=memory`ï¼Œè¿™ç§è¡¨çš„æ•°æ®éƒ½ä¿å­˜åœ¨å†…å­˜é‡Œï¼Œç³»ç»Ÿé‡å¯æ—¶ä¼šè¢«æ¸…ç©ºï¼Œä½†æ˜¯è¡¨ç»“æ„è¿˜åœ¨\r\n* ç£ç›˜è¡¨æ˜¯ä½¿ç”¨ InnoDB å¼•æ“æˆ–è€… MyISAM å¼•æ“çš„ä¸´æ—¶è¡¨ï¼Œå»ºç«‹ B+ æ ‘ç´¢å¼•ï¼Œå†™æ•°æ®çš„æ—¶å€™æ˜¯å†™åˆ°ç£ç›˜ä¸Šçš„\r\n\r\nä¸´æ—¶è¡¨çš„ç‰¹ç‚¹ï¼š\r\n\r\n* ä¸€ä¸ªä¸´æ—¶è¡¨åªèƒ½è¢«åˆ›å»ºå®ƒçš„ session è®¿é—®ï¼Œå¯¹å…¶ä»–çº¿ç¨‹ä¸å¯è§ï¼Œæ‰€ä»¥ä¸åŒ session çš„ä¸´æ—¶è¡¨æ˜¯**å¯ä»¥é‡å**çš„\r\n* ä¸´æ—¶è¡¨å¯ä»¥ä¸æ™®é€šè¡¨åŒåï¼Œä¼šè¯å†…æœ‰åŒåçš„ä¸´æ—¶è¡¨å’Œæ™®é€šè¡¨æ—¶ï¼Œæ‰§è¡Œ show create è¯­å¥ä»¥åŠå¢åˆ æ”¹æŸ¥è¯­å¥è®¿é—®çš„éƒ½æ˜¯ä¸´æ—¶è¡¨\r\n* show tables å‘½ä»¤ä¸æ˜¾ç¤ºä¸´æ—¶è¡¨\r\n* æ•°æ®åº“å‘ç”Ÿå¼‚å¸¸é‡å¯ä¸éœ€è¦æ‹…å¿ƒæ•°æ®åˆ é™¤é—®é¢˜ï¼Œä¸´æ—¶è¡¨ä¼š**è‡ªåŠ¨å›æ”¶**\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### é‡ååŸç†\r\n\r\næ‰§è¡Œåˆ›å»ºä¸´æ—¶è¡¨çš„ SQLï¼š\r\n\r\n```sql\r\ncreate temporary table temp_t(id int primary key)engine=innodb;\r\n```\r\n\r\nMySQL ç»™ InnoDB è¡¨åˆ›å»ºä¸€ä¸ª frm æ–‡ä»¶ä¿å­˜è¡¨ç»“æ„å®šä¹‰ï¼Œåœ¨ ibd ä¿å­˜è¡¨æ•°æ®ã€‚frm æ–‡ä»¶æ”¾åœ¨ä¸´æ—¶æ–‡ä»¶ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åçš„åç¼€æ˜¯ .frmï¼Œ**å‰ç¼€æ˜¯** `#sql{è¿›ç¨‹ id}_{çº¿ç¨‹ id}_ åºåˆ—å·`ï¼Œä½¿ç”¨ `select @@tmpdir` å‘½ä»¤ï¼Œæ¥æ˜¾ç¤ºå®ä¾‹çš„ä¸´æ—¶æ–‡ä»¶ç›®å½•\r\n\r\nMySQL ç»´æŠ¤æ•°æ®è¡¨ï¼Œé™¤äº†ç‰©ç†ç£ç›˜ä¸Šçš„æ–‡ä»¶å¤–ï¼Œå†…å­˜é‡Œä¹Ÿæœ‰ä¸€å¥—æœºåˆ¶åŒºåˆ«ä¸åŒçš„è¡¨ï¼Œæ¯ä¸ªè¡¨éƒ½å¯¹åº”ä¸€ä¸ª table_def_key\r\n\r\n* ä¸€ä¸ªæ™®é€šè¡¨çš„ table_def_key çš„å€¼æ˜¯ç”± `åº“å + è¡¨å` å¾—åˆ°çš„ï¼Œæ‰€ä»¥å¦‚æœåœ¨åŒä¸€ä¸ªåº“ä¸‹åˆ›å»ºä¸¤ä¸ªåŒåçš„æ™®é€šè¡¨ï¼Œåˆ›å»ºç¬¬äºŒä¸ªè¡¨çš„è¿‡ç¨‹ä¸­å°±ä¼šå‘ç° table_def_key å·²ç»å­˜åœ¨äº†\r\n* å¯¹äºä¸´æ—¶è¡¨ï¼Œtable_def_key åœ¨ `åº“å + è¡¨å` åŸºç¡€ä¸Šï¼ŒåˆåŠ å…¥äº† `server_id + thread_id`ï¼Œæ‰€ä»¥ä¸åŒçº¿ç¨‹ä¹‹é—´ï¼Œä¸´æ—¶è¡¨å¯ä»¥é‡å\r\n\r\nå®ç°åŸç†ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤äº†è‡ªå·±çš„ä¸´æ—¶è¡¨é“¾è¡¨ï¼Œæ¯æ¬¡ session å†…æ“ä½œè¡¨æ—¶ï¼Œå…ˆéå†é“¾è¡¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¿™ä¸ªåå­—çš„ä¸´æ—¶è¡¨ï¼Œå¦‚æœæœ‰å°±**ä¼˜å…ˆæ“ä½œä¸´æ—¶è¡¨**ï¼Œå¦‚æœæ²¡æœ‰å†æ“ä½œæ™®é€šè¡¨ï¼›åœ¨ session ç»“æŸæ—¶å¯¹é“¾è¡¨é‡Œçš„æ¯ä¸ªä¸´æ—¶è¡¨ï¼Œæ‰§è¡Œ `DROP TEMPORARY TABLE + è¡¨å` æ“ä½œ\r\n\r\næ‰§è¡Œ rename table è¯­å¥æ— æ³•ä¿®æ”¹ä¸´æ—¶è¡¨ï¼Œå› ä¸ºä¼šæŒ‰ç…§ `åº“å / è¡¨å.frm` çš„è§„åˆ™å»ç£ç›˜æ‰¾æ–‡ä»¶ï¼Œä½†æ˜¯ä¸´æ—¶è¡¨æ–‡ä»¶åçš„è§„åˆ™æ˜¯ `#sql{è¿›ç¨‹ id}_{çº¿ç¨‹ id}_ åºåˆ—å·.frm`ï¼Œå› æ­¤ä¼šæŠ¥æ‰¾ä¸åˆ°æ–‡ä»¶åçš„é”™è¯¯\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### ä¸»å¤‡å¤åˆ¶\r\n\r\nåˆ›å»ºä¸´æ—¶è¡¨çš„è¯­å¥ä¼šä¼ åˆ°å¤‡åº“æ‰§è¡Œï¼Œå› æ­¤å¤‡åº“çš„åŒæ­¥çº¿ç¨‹å°±ä¼šåˆ›å»ºè¿™ä¸ªä¸´æ—¶è¡¨ã€‚ä¸»åº“åœ¨çº¿ç¨‹é€€å‡ºæ—¶ä¼šè‡ªåŠ¨åˆ é™¤ä¸´æ—¶è¡¨ï¼Œä½†å¤‡åº“åŒæ­¥çº¿ç¨‹æ˜¯æŒç»­åœ¨è¿è¡Œçš„å¹¶ä¸ä¼šé€€å‡ºï¼Œæ‰€ä»¥è¿™æ—¶å°±éœ€è¦åœ¨ä¸»åº“ä¸Šå†å†™ä¸€ä¸ª DROP TEMPORARY TABLE ä¼ ç»™å¤‡åº“æ‰§è¡Œ\r\n\r\nbinlog æ—¥å¿—å†™å…¥è§„åˆ™ï¼š\r\n\r\n* binlog_format=rowï¼Œè·Ÿä¸´æ—¶è¡¨æœ‰å…³çš„è¯­å¥å°±ä¸ä¼šè®°å½•åˆ° binlog\r\n* binlog_format=statment/mixedï¼Œbinlog ä¸­æ‰ä¼šè®°å½•ä¸´æ—¶è¡¨çš„æ“ä½œï¼Œä¹Ÿå°±ä¼šè®°å½• `DROP TEMPORARY TABLE` è¿™æ¡å‘½ä»¤\r\n\r\nä¸»åº“ä¸Šä¸åŒçš„çº¿ç¨‹åˆ›å»ºåŒåçš„ä¸´æ—¶è¡¨æ˜¯ä¸å†²çªçš„ï¼Œä½†æ˜¯å¤‡åº“åªæœ‰ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼Œæ‰€ä»¥ MySQL åœ¨è®°å½• binlog æ—¶ä¼šæŠŠä¸»åº“æ‰§è¡Œè¿™ä¸ªè¯­å¥çš„çº¿ç¨‹ id å†™åˆ° binlog ä¸­ï¼Œåœ¨å¤‡åº“çš„åº”ç”¨çº¿ç¨‹å°±å¯ä»¥è·å–æ‰§è¡Œæ¯ä¸ªè¯­å¥çš„ä¸»åº“çº¿ç¨‹ idï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªçº¿ç¨‹ id æ¥æ„é€ ä¸´æ—¶è¡¨çš„ table_def_key\r\n\r\n* session A çš„ä¸´æ—¶è¡¨ t1ï¼Œåœ¨å¤‡åº“çš„ table_def_key å°±æ˜¯ï¼š`åº“å + t1 +â€œM çš„ serverid\" + \"session A çš„ thread_idâ€`\r\n* session B çš„ä¸´æ—¶è¡¨ t1ï¼Œåœ¨å¤‡åº“çš„ table_def_key å°±æ˜¯ ï¼š`åº“å + t1 +\"M çš„ serverid\" + \"session B çš„ thread_id\"`\r\n\r\nMySQL åœ¨è®°å½• binlog çš„æ—¶ä¸è®ºæ˜¯ create table è¿˜æ˜¯ alter table è¯­å¥éƒ½æ˜¯åŸæ ·è®°å½•ï¼Œä½†æ˜¯å¦‚æœæ‰§è¡Œ drop tableï¼Œç³»ç»Ÿè®°å½• binlog å°±ä¼šè¢«æœåŠ¡ç«¯æ”¹å†™\r\n\r\n```sql\r\nDROP TABLE `t_normal` /* generated by server */\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### è·¨åº“æŸ¥è¯¢\r\n\r\nåˆ†åº“åˆ†è¡¨ç³»ç»Ÿçš„è·¨åº“æŸ¥è¯¢ä½¿ç”¨ä¸´æ—¶è¡¨ä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¹‹é—´çš„é‡åå†²çªï¼Œåˆ†åº“åˆ†è¡¨å°±æ˜¯è¦æŠŠä¸€ä¸ªé€»è¾‘ä¸Šçš„å¤§è¡¨åˆ†æ•£åˆ°ä¸åŒçš„æ•°æ®åº“å®ä¾‹ä¸Š\r\n\r\næ¯”å¦‚å°†ä¸€ä¸ªå¤§è¡¨ htï¼ŒæŒ‰ç…§å­—æ®µ fï¼Œæ‹†åˆ†æˆ 1024 ä¸ªåˆ†è¡¨ï¼Œåˆ†å¸ƒåˆ° 32 ä¸ªæ•°æ®åº“å®ä¾‹ä¸Šï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½æœ‰ä¸€ä¸ªä¸­é—´å±‚ proxy è§£æ SQL è¯­å¥ï¼Œé€šè¿‡åˆ†åº“è§„åˆ™é€šè¿‡åˆ†è¡¨è§„åˆ™ï¼ˆæ¯”å¦‚ N%1024ï¼‰ç¡®å®šå°†è¿™æ¡è¯­å¥è·¯ç”±åˆ°å“ªä¸ªåˆ†è¡¨åšæŸ¥è¯¢\r\n\r\n```sql\r\nselect v from ht where f=N;\r\n```\r\n\r\nå¦‚æœè¿™ä¸ªè¡¨ä¸Šè¿˜æœ‰å¦å¤–ä¸€ä¸ªç´¢å¼• kï¼Œå¹¶ä¸”æŸ¥è¯¢è¯­å¥ï¼š\r\n\r\n```sql\r\nselect v from ht where k >= M order by t_modified desc limit 100;\r\n```\r\n\r\næŸ¥è¯¢æ¡ä»¶é‡Œé¢æ²¡æœ‰ç”¨åˆ°åˆ†åŒºå­—æ®µ fï¼Œåªèƒ½**åˆ°æ‰€æœ‰çš„åˆ†åŒº**ä¸­å»æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰è¡Œï¼Œç„¶åç»Ÿä¸€åš order by æ“ä½œï¼Œä¸¤ç§æ–¹å¼ï¼š\r\n\r\n* åœ¨ proxy å±‚çš„è¿›ç¨‹ä»£ç ä¸­å®ç°æ’åºï¼Œæ‹¿åˆ°åˆ†åº“çš„æ•°æ®ä»¥åï¼Œç›´æ¥åœ¨å†…å­˜ä¸­å‚ä¸è®¡ç®—ï¼Œä½†æ˜¯å¯¹ proxy ç«¯çš„å‹åŠ›æ¯”è¾ƒå¤§ï¼Œå¾ˆå®¹æ˜“å‡ºç°å†…å­˜ä¸å¤Ÿç”¨å’Œ CPU ç“¶é¢ˆé—®é¢˜\r\n* æŠŠå„ä¸ªåˆ†åº“æ‹¿åˆ°çš„æ•°æ®ï¼Œæ±‡æ€»åˆ°ä¸€ä¸ª MySQL å®ä¾‹çš„ä¸€ä¸ªè¡¨ä¸­ï¼Œç„¶ååœ¨è¿™ä¸ªæ±‡æ€»å®ä¾‹ä¸Šåšé€»è¾‘æ“ä½œï¼Œæ‰§è¡Œæµç¨‹ï¼š\r\n  * åœ¨æ±‡æ€»åº“ä¸Šåˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ temp_htï¼Œè¡¨é‡ŒåŒ…å«ä¸‰ä¸ªå­—æ®µ vã€kã€t_modified\r\n  * åœ¨å„ä¸ªåˆ†åº“æ‰§è¡Œï¼š`select v,k,t_modified from ht_x where k >= M order by t_modified desc limit 100`\r\n  * æŠŠåˆ†åº“æ‰§è¡Œçš„ç»“æœæ’å…¥åˆ° temp_ht è¡¨ä¸­\r\n  * åœ¨ä¸´æ—¶è¡¨ä¸Šæ‰§è¡Œï¼š`select v from temp_ht order by t_modified desc limit 100`\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n## ä¼˜åŒ–æ­¥éª¤\r\n\r\n### æ‰§è¡Œé¢‘ç‡\r\n\r\nMySQL å®¢æˆ·ç«¯è¿æ¥æˆåŠŸåï¼ŒæŸ¥è¯¢æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯ï¼š\r\n\r\n```sql\r\nSHOW [SESSION|GLOBAL] STATUS LIKE '';\r\n-- SESSION: æ˜¾ç¤ºå½“å‰ä¼šè¯è¿æ¥çš„ç»Ÿè®¡ç»“æœï¼Œé»˜è®¤å‚æ•°\r\n-- GLOBAL: æ˜¾ç¤ºè‡ªæ•°æ®åº“ä¸Šæ¬¡å¯åŠ¨è‡³ä»Šçš„ç»Ÿè®¡ç»“æœ\r\n```\r\n\r\n* æŸ¥çœ‹ SQL æ‰§è¡Œé¢‘ç‡ï¼š\r\n\r\n  ```sql\r\n  SHOW STATUS LIKE 'Com_____';\r\n  ```\r\n\r\n  Com_xxx è¡¨ç¤ºæ¯ç§è¯­å¥æ‰§è¡Œçš„æ¬¡æ•°\r\n\r\n  ![image-20250320000337300](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320000337300.png)\r\n\r\n  \r\n\r\n* æŸ¥è¯¢ SQL è¯­å¥å½±å“çš„è¡Œæ•°ï¼š\r\n\r\n  ```sql\r\n  SHOW STATUS LIKE 'Innodb_rows_%';\r\n  ```\r\n\r\n  ![image-20250320004820682](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320004820682.png)\r\n\r\nCom_xxxxï¼šè¿™äº›å‚æ•°å¯¹äºæ‰€æœ‰å­˜å‚¨å¼•æ“çš„è¡¨æ“ä½œéƒ½ä¼šè¿›è¡Œç´¯è®¡\r\n\r\nInnodb_xxxxï¼šè¿™å‡ ä¸ªå‚æ•°åªæ˜¯é’ˆå¯¹ InnoDB å­˜å‚¨å¼•æ“çš„ï¼Œç´¯åŠ çš„ç®—æ³•ä¹Ÿç•¥æœ‰ä¸åŒ\r\n\r\n| å‚æ•°                 | å«ä¹‰                                                         |\r\n| :------------------- | ------------------------------------------------------------ |\r\n| Com_select           | æ‰§è¡Œ SELECT æ“ä½œçš„æ¬¡æ•°ï¼Œä¸€æ¬¡æŸ¥è¯¢åªç´¯åŠ  1                     |\r\n| Com_insert           | æ‰§è¡Œ INSERT æ“ä½œçš„æ¬¡æ•°ï¼Œå¯¹äºæ‰¹é‡æ’å…¥çš„ INSERT æ“ä½œï¼Œåªç´¯åŠ ä¸€æ¬¡ |\r\n| Com_update           | æ‰§è¡Œ UPDATE æ“ä½œçš„æ¬¡æ•°                                       |\r\n| Com_delete           | æ‰§è¡Œ DELETE æ“ä½œçš„æ¬¡æ•°                                       |\r\n| Innodb_rows_read     | æ‰§è¡Œ SELECT æŸ¥è¯¢è¿”å›çš„è¡Œæ•°                                   |\r\n| Innodb_rows_inserted | æ‰§è¡Œ INSERT æ“ä½œæ’å…¥çš„è¡Œæ•°                                   |\r\n| Innodb_rows_updated  | æ‰§è¡Œ UPDATE æ“ä½œæ›´æ–°çš„è¡Œæ•°                                   |\r\n| Innodb_rows_deleted  | æ‰§è¡Œ DELETE æ“ä½œåˆ é™¤çš„è¡Œæ•°                                   |\r\n| Connections          | è¯•å›¾è¿æ¥ MySQL æœåŠ¡å™¨çš„æ¬¡æ•°                                  |\r\n| Uptime               | æœåŠ¡å™¨å·¥ä½œæ—¶é—´                                               |\r\n| Slow_queries         | æ…¢æŸ¥è¯¢çš„æ¬¡æ•°                                                 |\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### å®šä½ä½æ•ˆ\r\n\r\nSQL æ‰§è¡Œæ…¢æœ‰ä¸¤ç§æƒ…å†µï¼š\r\n\r\n* å¶å°”æ…¢ï¼šDB åœ¨åˆ·æ–°è„é¡µï¼ˆå­¦å®Œäº‹åŠ¡å°±æ‡‚äº†ï¼‰\r\n  * redo log å†™æ»¡äº†\r\n  * å†…å­˜ä¸å¤Ÿç”¨ï¼Œè¦ä» LRU é“¾è¡¨ä¸­æ·˜æ±°\r\n  * MySQL è®¤ä¸ºç³»ç»Ÿç©ºé—²çš„æ—¶å€™\r\n  * MySQL å…³é—­æ—¶\r\n* ä¸€ç›´æ…¢çš„åŸå› ï¼šç´¢å¼•æ²¡æœ‰è®¾è®¡å¥½ã€SQL è¯­å¥æ²¡å†™å¥½ã€MySQL é€‰é”™äº†ç´¢å¼•\r\n\r\né€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å®šä½æ‰§è¡Œæ•ˆç‡è¾ƒä½çš„ SQL è¯­å¥\r\n\r\n* æ…¢æ—¥å¿—æŸ¥è¯¢ï¼š æ…¢æŸ¥è¯¢æ—¥å¿—åœ¨æŸ¥è¯¢ç»“æŸä»¥åæ‰è®°å½•ï¼Œæ‰§è¡Œæ•ˆç‡å‡ºç°é—®é¢˜æ—¶æŸ¥è¯¢æ—¥å¿—å¹¶ä¸èƒ½å®šä½é—®é¢˜\r\n\r\n  é…ç½®æ–‡ä»¶ä¿®æ”¹ï¼šä¿®æ”¹ .cnf æ–‡ä»¶ `vim /etc/mysql/my.cnf`ï¼Œé‡å¯ MySQL æœåŠ¡å™¨\r\n\r\n  ```sh\r\n  slow_query_log=ON\r\n  slow_query_log_file=/usr/local/mysql/var/localhost-slow.log\r\n  long_query_time=1\t#è®°å½•è¶…è¿‡long_query_timeç§’çš„SQLè¯­å¥çš„æ—¥å¿—\r\n  log-queries-not-using-indexes = 1\r\n  ```\r\n\r\n  ä½¿ç”¨å‘½ä»¤é…ç½®ï¼š\r\n\r\n  ```sql\r\n  mysql> SET slow_query_log=ON;\r\n  mysql> SET GLOBAL slow_query_log=ON;\r\n  ```\r\n\r\n  æŸ¥çœ‹æ˜¯å¦é…ç½®æˆåŠŸï¼š\r\n\r\n  ```sql\r\n  SHOW VARIABLES LIKE '%query%'\r\n  ```\r\n\r\n* SHOW PROCESSLISTï¼š**å®æ—¶æŸ¥çœ‹**å½“å‰ MySQL åœ¨è¿›è¡Œçš„è¿æ¥çº¿ç¨‹ï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„çŠ¶æ€ã€æ˜¯å¦é”è¡¨ã€SQL çš„æ‰§è¡Œæƒ…å†µï¼ŒåŒæ—¶å¯¹ä¸€äº›é”è¡¨æ“ä½œè¿›è¡Œä¼˜åŒ–\r\n\r\n  ![image-20250320004906769](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320004906769.png)\r\n\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### EXPLAIN\r\n\r\n#### æ‰§è¡Œè®¡åˆ’\r\n\r\né€šè¿‡ EXPLAIN å‘½ä»¤è·å–æ‰§è¡Œ SQL è¯­å¥çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬åœ¨ SELECT è¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚ä½•è¿æ¥å’Œè¿æ¥çš„é¡ºåºï¼Œæ‰§è¡Œè®¡åˆ’åœ¨ä¼˜åŒ–å™¨ä¼˜åŒ–å®Œæˆåã€æ‰§è¡Œå™¨ä¹‹å‰ç”Ÿæˆï¼Œç„¶åæ‰§è¡Œå™¨ä¼šè°ƒç”¨å­˜å‚¨å¼•æ“æ£€ç´¢æ•°æ®\r\n\r\næŸ¥è¯¢ SQL è¯­å¥çš„æ‰§è¡Œè®¡åˆ’ï¼š\r\n\r\n```sql\r\nEXPLAIN SELECT * FROM table_1 WHERE id = 1;\r\n```\r\n\r\n![image-20250320004929861](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320004929861.png)\r\n\r\n| å­—æ®µ          | å«ä¹‰                                                         |\r\n| ------------- | ------------------------------------------------------------ |\r\n| id            | SELECT çš„åºåˆ—å·                                              |\r\n| select_type   | è¡¨ç¤º SELECT çš„ç±»å‹                                           |\r\n| table         | è®¿é—®æ•°æ®åº“ä¸­è¡¨åç§°ï¼Œæœ‰æ—¶å¯èƒ½æ˜¯ç®€ç§°æˆ–è€…ä¸´æ—¶è¡¨åç§°ï¼ˆ<table_name>ï¼‰ |\r\n| type          | è¡¨ç¤ºè¡¨çš„è¿æ¥ç±»å‹                                             |\r\n| possible_keys | è¡¨ç¤ºæŸ¥è¯¢æ—¶ï¼Œå¯èƒ½ä½¿ç”¨çš„ç´¢å¼•                                   |\r\n| key           | è¡¨ç¤ºå®é™…ä½¿ç”¨çš„ç´¢å¼•                                           |\r\n| key_len       | ç´¢å¼•å­—æ®µçš„é•¿åº¦                                               |\r\n| ref           | è¡¨ç¤ºä¸ç´¢å¼•åˆ—è¿›è¡Œç­‰å€¼åŒ¹é…çš„å¯¹è±¡ï¼Œå¸¸æ•°ã€æŸä¸ªåˆ—ã€å‡½æ•°ç­‰ï¼Œtype å¿…é¡»åœ¨ï¼ˆrange, const] ä¹‹é—´ï¼Œå·¦é—­å³å¼€ |\r\n| rows          | æ‰«æå‡ºçš„è¡Œæ•°ï¼Œè¡¨ç¤º MySQL æ ¹æ®è¡¨ç»Ÿè®¡ä¿¡æ¯åŠç´¢å¼•é€‰ç”¨æƒ…å†µï¼Œ**ä¼°ç®—**çš„æ‰¾åˆ°æ‰€éœ€çš„è®°å½•æ‰«æçš„è¡Œæ•° |\r\n| filtered      | æ¡ä»¶è¿‡æ»¤çš„è¡Œç™¾åˆ†æ¯”ï¼Œå•è¡¨æŸ¥è¯¢æ²¡æ„ä¹‰ï¼Œç”¨äºè¿æ¥æŸ¥è¯¢ä¸­å¯¹é©±åŠ¨è¡¨çš„æ‰‡å‡ºè¿›è¡Œè¿‡æ»¤ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨é¢„æµ‹æ‰€æœ‰æ‰‡å‡ºå€¼æ»¡è¶³å‰©ä½™æŸ¥è¯¢æ¡ä»¶çš„ç™¾åˆ†æ¯”ï¼Œç›¸ä¹˜ä»¥åè¡¨ç¤ºå¤šè¡¨æŸ¥è¯¢ä¸­è¿˜è¦å¯¹è¢«é©±åŠ¨æ‰§è¡ŒæŸ¥è¯¢çš„æ¬¡æ•° |\r\n| extra         | æ‰§è¡Œæƒ…å†µçš„è¯´æ˜å’Œæè¿°                                         |\r\n\r\nMySQL **æ‰§è¡Œè®¡åˆ’çš„å±€é™**ï¼š\r\n\r\n* åªæ˜¯è®¡åˆ’ï¼Œä¸æ˜¯æ‰§è¡Œ SQL è¯­å¥ï¼Œå¯ä»¥éšç€åº•å±‚ä¼˜åŒ–å™¨è¾“å…¥çš„æ›´æ”¹è€Œæ›´æ”¹\r\n* EXPLAIN ä¸ä¼šå‘Šè¯‰æ˜¾ç¤ºå…³äºè§¦å‘å™¨ã€å­˜å‚¨è¿‡ç¨‹çš„ä¿¡æ¯å¯¹æŸ¥è¯¢çš„å½±å“æƒ…å†µï¼Œ ä¸è€ƒè™‘å„ç§ Cache\r\n* EXPLAIN ä¸èƒ½æ˜¾ç¤º MySQL åœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶çš„åŠ¨æ€ï¼Œå› ä¸ºæ‰§è¡Œè®¡åˆ’åœ¨æ‰§è¡Œ**æŸ¥è¯¢ä¹‹å‰ç”Ÿæˆ**\r\n* EXPALIN åªèƒ½è§£é‡Š SELECT æ“ä½œï¼Œå…¶ä»–æ“ä½œè¦é‡å†™ä¸º SELECT åæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’\r\n* EXPLAIN PLAN æ˜¾ç¤ºçš„æ˜¯åœ¨è§£é‡Šè¯­å¥æ—¶æ•°æ®åº“å°†å¦‚ä½•è¿è¡Œ SQL è¯­å¥ï¼Œç”±äºæ‰§è¡Œç¯å¢ƒå’Œ EXPLAIN PLAN ç¯å¢ƒçš„ä¸åŒï¼Œæ­¤è®¡åˆ’å¯èƒ½ä¸ SQL è¯­å¥**å®é™…çš„æ‰§è¡Œè®¡åˆ’ä¸åŒ**ï¼Œéƒ¨åˆ†ç»Ÿè®¡ä¿¡æ¯æ˜¯ä¼°ç®—çš„ï¼Œå¹¶éç²¾ç¡®å€¼\r\n\r\nSHOW WARINGSï¼šåœ¨ä½¿ç”¨ EXPALIN å‘½ä»¤åæ‰§è¡Œè¯¥è¯­å¥ï¼Œå¯ä»¥æŸ¥è¯¢ä¸æ‰§è¡Œè®¡åˆ’ç›¸å…³çš„æ‹“å±•ä¿¡æ¯ï¼Œå±•ç¤ºå‡º Levelã€Codeã€Message ä¸‰ä¸ªå­—æ®µï¼Œå½“ Code ä¸º 1003 æ—¶ï¼ŒMessage å­—æ®µå±•ç¤ºçš„ä¿¡æ¯ç±»ä¼¼äºå°†æŸ¥è¯¢è¯­å¥é‡å†™åçš„ä¿¡æ¯ï¼Œä½†æ˜¯ä¸æ˜¯ç­‰ä»·ï¼Œä¸èƒ½æ‰§è¡Œå¤åˆ¶è¿‡æ¥è¿è¡Œ\r\n\r\nç¯å¢ƒå‡†å¤‡ï¼š\r\n\r\n![image-20250320004958531](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320004958531.png)\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### id\r\n\r\nid ä»£è¡¨ SQL æ‰§è¡Œçš„é¡ºåºçš„æ ‡è¯†ï¼Œæ¯ä¸ª SELECT å…³é”®å­—å¯¹åº”ä¸€ä¸ªå”¯ä¸€ idï¼Œæ‰€ä»¥åœ¨åŒä¸€ä¸ª SELECT å…³é”®å­—ä¸­çš„è¡¨çš„ id éƒ½æ˜¯ç›¸åŒçš„ã€‚SELECT åçš„ FROM å¯ä»¥è·Ÿéšå¤šä¸ªè¡¨ï¼Œæ¯ä¸ªè¡¨éƒ½ä¼šå¯¹åº”ä¸€æ¡è®°å½•ï¼Œè¿™äº›è®°å½•çš„ id éƒ½æ˜¯ç›¸åŒçš„ï¼Œ\r\n\r\n* id ç›¸åŒæ—¶ï¼Œæ‰§è¡Œé¡ºåºç”±ä¸Šè‡³ä¸‹ã€‚è¿æ¥æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ï¼Œè®°å½•çš„ id å€¼éƒ½æ˜¯ç›¸åŒçš„ï¼Œå‡ºç°åœ¨å‰é¢çš„è¡¨ä¸ºé©±åŠ¨è¡¨ï¼Œåé¢ä¸ºè¢«é©±åŠ¨è¡¨\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM t_role r, t_user u, user_role ur WHERE r.id = ur.role_id AND u.id = ur.user_id ;\r\n  ```\r\n\r\n  ![image-20250320005020698](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005020698.png)\r\n\r\n* id ä¸åŒæ—¶ï¼Œid å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆè¢«æ‰§è¡Œ\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM t_role WHERE id = (SELECT role_id FROM user_role WHERE user_id = (SELECT id FROM t_user WHERE username = 'stu1'))\r\n  ```\r\n\r\n  ![image-20250320005039682](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005039682.png)\r\n\r\n* id æœ‰ç›¸åŒä¹Ÿæœ‰ä¸åŒæ—¶ï¼Œid ç›¸åŒçš„å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç»„ï¼Œä»ä¸Šå¾€ä¸‹é¡ºåºæ‰§è¡Œï¼›åœ¨æ‰€æœ‰çš„ç»„ä¸­ï¼Œid çš„å€¼è¶Šå¤§çš„ç»„ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆæ‰§è¡Œ\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM t_role r , (SELECT * FROM user_role ur WHERE ur.`user_id` = '2') a WHERE r.id = a.role_id ; \r\n  ```\r\n\r\n  ![image-20250320005057427](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005057427.png)\r\n\r\n* id ä¸º NULL æ—¶ä»£è¡¨çš„æ˜¯ä¸´æ—¶è¡¨\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### select\r\n\r\nè¡¨ç¤ºæŸ¥è¯¢ä¸­æ¯ä¸ª select å­å¥çš„ç±»å‹ï¼ˆç®€å• OR å¤æ‚ï¼‰\r\n\r\n| select_type        | å«ä¹‰                                                         |\r\n| ------------------ | ------------------------------------------------------------ |\r\n| SIMPLE             | ç®€å•çš„ SELECT æŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸­ä¸åŒ…å«å­æŸ¥è¯¢æˆ–è€… UNION             |\r\n| PRIMARY            | æŸ¥è¯¢ä¸­è‹¥åŒ…å«ä»»ä½•å¤æ‚çš„å­æŸ¥è¯¢ï¼Œæœ€å¤–å±‚ï¼ˆä¹Ÿå°±æ˜¯æœ€å·¦ä¾§ï¼‰æŸ¥è¯¢æ ‡è®°ä¸ºè¯¥æ ‡è¯† |\r\n| UNION              | å¯¹äº UNION æˆ–è€… UNION ALL çš„å¤æ‚æŸ¥è¯¢ï¼Œé™¤äº†æœ€å·¦ä¾§çš„æŸ¥è¯¢ï¼Œå…¶ä½™çš„å°æŸ¥è¯¢éƒ½æ˜¯ UNION |\r\n| UNION RESULT       | UNION éœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨è¿›è¡Œå»é‡ï¼Œä¸´æ—¶è¡¨çš„æ˜¯ UNION RESULT        |\r\n| DEPENDENT UNION    | å¯¹äº UNION æˆ–è€… UNION ALL çš„å¤æ‚æŸ¥è¯¢ï¼Œå¦‚æœå„ä¸ªå°æŸ¥è¯¢éƒ½ä¾èµ–å¤–å±‚æŸ¥è¯¢ï¼Œæ˜¯ç›¸å…³å­æŸ¥è¯¢ï¼Œé™¤äº†æœ€å·¦ä¾§çš„å°æŸ¥è¯¢ä¸º DEPENDENT SUBQUERYï¼Œå…¶ä½™éƒ½æ˜¯ DEPENDENT UNION |\r\n| SUBQUERY           | å­æŸ¥è¯¢ä¸æ˜¯ç›¸å…³å­æŸ¥è¯¢ï¼Œè¯¥å­æŸ¥è¯¢ç¬¬ä¸€ä¸ª SELECT ä»£è¡¨çš„æŸ¥è¯¢å°±æ˜¯è¿™ç§ç±»å‹ï¼Œä¼šè¿›è¡Œç‰©åŒ–ï¼ˆè¯¥å­æŸ¥è¯¢åªéœ€è¦æ‰§è¡Œä¸€æ¬¡ï¼‰ |\r\n| DEPENDENT SUBQUERY | å­æŸ¥è¯¢æ˜¯ç›¸å…³å­æŸ¥è¯¢ï¼Œè¯¥å­æŸ¥è¯¢ç¬¬ä¸€ä¸ª SELECT ä»£è¡¨çš„æŸ¥è¯¢å°±æ˜¯è¿™ç§ç±»å‹ï¼Œä¸ä¼šç‰©åŒ–ï¼ˆè¯¥å­æŸ¥è¯¢éœ€è¦æ‰§è¡Œå¤šæ¬¡ï¼‰ |\r\n| DERIVED            | åœ¨ FROM åˆ—è¡¨ä¸­åŒ…å«çš„å­æŸ¥è¯¢ï¼Œè¢«æ ‡è®°ä¸º DERIVEDï¼ˆè¡ç”Ÿï¼‰ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆç‰©åŒ–æ´¾ç”Ÿè¡¨çš„è¿™ä¸ªå­æŸ¥è¯¢ |\r\n| MATERIALIZED       | å°†å­æŸ¥è¯¢ç‰©åŒ–åä¸ä¸å¤–å±‚è¿›è¡Œè¿æ¥æŸ¥è¯¢ï¼Œç”Ÿæˆç‰©åŒ–è¡¨çš„å­æŸ¥è¯¢       |\r\n\r\nå­æŸ¥è¯¢ä¸º DERIVEDï¼š`SELECT * FROM (SELECT key1 FROM t1) AS derived_1 WHERE key1 > 10`\r\n\r\nå­æŸ¥è¯¢ä¸º MATERIALIZEDï¼š`SELECT * FROM t1 WHERE key1 IN (SELECT key1 FROM t2)`\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### type\r\n\r\nå¯¹è¡¨çš„è®¿é—®æ–¹å¼ï¼Œè¡¨ç¤º MySQL åœ¨è¡¨ä¸­æ‰¾åˆ°æ‰€éœ€è¡Œçš„æ–¹å¼ï¼Œåˆç§°è®¿é—®ç±»å‹\r\n\r\n| type            | å«ä¹‰                                                         |\r\n| --------------- | ------------------------------------------------------------ |\r\n| ALL             | å…¨è¡¨æ‰«æï¼Œå¦‚æœæ˜¯ InnoDB å¼•æ“æ˜¯æ‰«æèšç°‡ç´¢å¼•                   |\r\n| index           | å¯ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œä½†éœ€è¦æ‰«æå…¨éƒ¨ç´¢å¼•                         |\r\n| range           | ç´¢å¼•èŒƒå›´æ‰«æï¼Œå¸¸è§äº betweenã€<ã€> ç­‰çš„æŸ¥è¯¢                  |\r\n| index_subquery  | å­æŸ¥è¯¢å¯ä»¥æ™®é€šç´¢å¼•ï¼Œåˆ™å­æŸ¥è¯¢çš„ type ä¸º index_subquery        |\r\n| unique_subquery | å­æŸ¥è¯¢å¯ä»¥ä½¿ç”¨ä¸»é”®æˆ–å”¯ä¸€äºŒçº§ç´¢å¼•ï¼Œåˆ™å­æŸ¥è¯¢çš„ type ä¸º index_subquery |\r\n| index_merge     | ç´¢å¼•åˆå¹¶                                                     |\r\n| ref_or_null     | éå”¯ä¸€æ€§ç´¢å¼•ï¼ˆæ™®é€šäºŒçº§ç´¢å¼•ï¼‰å¹¶ä¸”å¯ä»¥å­˜å‚¨ NULLï¼Œè¿›è¡Œç­‰å€¼åŒ¹é…  |\r\n| ref             | éå”¯ä¸€æ€§ç´¢å¼•ä¸å¸¸é‡ç­‰å€¼åŒ¹é…                                   |\r\n| eq_ref          | å”¯ä¸€æ€§ç´¢å¼•ï¼ˆä¸»é”®æˆ–ä¸å­˜å‚¨ NULL çš„å”¯ä¸€äºŒçº§ç´¢å¼•ï¼‰è¿›è¡Œç­‰å€¼åŒ¹é…ï¼Œå¦‚æœäºŒçº§ç´¢å¼•æ˜¯è”åˆç´¢å¼•ï¼Œé‚£ä¹ˆæ‰€æœ‰è”åˆçš„åˆ—éƒ½è¦è¿›è¡Œç­‰å€¼åŒ¹é… |\r\n| const           | é€šè¿‡ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•ä¸å¸¸é‡è¿›è¡Œç­‰å€¼åŒ¹é…                   |\r\n| system          | system æ˜¯ const ç±»å‹çš„ç‰¹ä¾‹ï¼Œå½“æŸ¥è¯¢çš„è¡¨åªæœ‰ä¸€æ¡è®°å½•çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ system |\r\n| NULL            | MySQL åœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­åˆ†è§£è¯­å¥ï¼Œæ‰§è¡Œæ—¶ç”šè‡³ä¸ç”¨è®¿é—®è¡¨æˆ–ç´¢å¼•       |\r\n\r\nä»ä¸Šåˆ°ä¸‹ï¼Œæ€§èƒ½ä»å·®åˆ°å¥½ï¼Œä¸€èˆ¬æ¥è¯´éœ€è¦ä¿è¯æŸ¥è¯¢è‡³å°‘è¾¾åˆ° range çº§åˆ«ï¼Œ æœ€å¥½è¾¾åˆ° ref \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### key\r\n\r\npossible_keysï¼š\r\n\r\n* æŒ‡å‡º MySQL èƒ½ä½¿ç”¨å“ªä¸ªç´¢å¼•åœ¨è¡¨ä¸­æ‰¾åˆ°è®°å½•ï¼ŒæŸ¥è¯¢æ¶‰åŠåˆ°çš„å­—æ®µä¸Šè‹¥å­˜åœ¨ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•å°†è¢«åˆ—å‡ºï¼Œä½†ä¸ä¸€å®šè¢«æŸ¥è¯¢ä½¿ç”¨\r\n* å¦‚æœè¯¥åˆ—æ˜¯ NULLï¼Œåˆ™æ²¡æœ‰ç›¸å…³çš„ç´¢å¼•\r\n\r\nkeyï¼š\r\n\r\n* æ˜¾ç¤º MySQL åœ¨æŸ¥è¯¢ä¸­å®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼Œè‹¥æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œæ˜¾ç¤ºä¸º NULL\r\n* æŸ¥è¯¢ä¸­è‹¥ä½¿ç”¨äº†**è¦†ç›–ç´¢å¼•**ï¼Œåˆ™è¯¥ç´¢å¼•å¯èƒ½å‡ºç°åœ¨ key åˆ—è¡¨ï¼Œä¸å‡ºç°åœ¨ possible_keys\r\n\r\nkey_lenï¼š\r\n\r\n* è¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œå¯é€šè¿‡è¯¥åˆ—è®¡ç®—æŸ¥è¯¢ä¸­ä½¿ç”¨çš„ç´¢å¼•çš„é•¿åº¦\r\n* key_len æ˜¾ç¤ºçš„å€¼ä¸ºç´¢å¼•å­—æ®µçš„æœ€å¤§å¯èƒ½é•¿åº¦ï¼Œå¹¶éå®é™…ä½¿ç”¨é•¿åº¦ï¼Œå³ key_len æ˜¯æ ¹æ®è¡¨å®šä¹‰è®¡ç®—è€Œå¾—ï¼Œä¸æ˜¯é€šè¿‡è¡¨å†…æ£€ç´¢å‡ºçš„\r\n* åœ¨ä¸æŸå¤±ç²¾ç¡®æ€§çš„å‰æä¸‹ï¼Œé•¿åº¦è¶ŠçŸ­è¶Šå¥½ \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### Extra\r\n\r\nå…¶ä»–çš„é¢å¤–çš„æ‰§è¡Œè®¡åˆ’ä¿¡æ¯ï¼Œåœ¨è¯¥åˆ—å±•ç¤ºï¼š\r\n\r\n* No tables usedï¼šæŸ¥è¯¢è¯­å¥ä¸­ä½¿ç”¨ FROM dual æˆ–è€…æ²¡æœ‰ FROM è¯­å¥\r\n* Impossible WHEREï¼šæŸ¥è¯¢è¯­å¥ä¸­çš„ WHERE å­å¥æ¡ä»¶æ°¸è¿œä¸º FALSEï¼Œä¼šå¯¼è‡´æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è¡Œ\r\n* Using indexï¼šè¯¥å€¼è¡¨ç¤ºç›¸åº”çš„ SELECT æ“ä½œä¸­ä½¿ç”¨äº†**è¦†ç›–ç´¢å¼•**ï¼ˆCovering Indexï¼‰\r\n* Using index conditionï¼šç¬¬ä¸€ç§æƒ…å†µæ˜¯æœç´¢æ¡ä»¶ä¸­è™½ç„¶å‡ºç°äº†ç´¢å¼•åˆ—ï¼Œä½†æ˜¯éƒ¨åˆ†æ¡ä»¶æ— æ³•å½¢æˆæ‰«æåŒºé—´ï¼ˆ**ç´¢å¼•å¤±æ•ˆ**ï¼‰ï¼Œä¼šæ ¹æ®å¯ç”¨ç´¢å¼•çš„æ¡ä»¶å…ˆæœç´¢ä¸€éå†åŒ¹é…æ— æ³•ä½¿ç”¨ç´¢å¼•çš„æ¡ä»¶ï¼Œå›è¡¨æŸ¥è¯¢æ•°æ®ï¼›ç¬¬äºŒç§æ˜¯ä½¿ç”¨äº†**ç´¢å¼•æ¡ä»¶ä¸‹æ¨**ä¼˜åŒ–\r\n* Using whereï¼šæœç´¢çš„æ•°æ®éœ€è¦åœ¨ Server å±‚åˆ¤æ–­ï¼Œæ— æ³•ä½¿ç”¨ç´¢å¼•ä¸‹æ¨\r\n* Using join bufferï¼šè¿æ¥æŸ¥è¯¢è¢«é©±åŠ¨è¡¨æ— æ³•åˆ©ç”¨ç´¢å¼•ï¼Œéœ€è¦è¿æ¥ç¼“å†²åŒºæ¥å­˜å‚¨ä¸­é—´ç»“æœ\r\n* Using filesortï¼šæ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆæ’åºï¼ˆä¼˜åŒ–æ–¹å‘ï¼‰ï¼Œéœ€è¦å¯¹æ•°æ®ä½¿ç”¨å¤–éƒ¨æ’åºç®—æ³•ï¼Œå°†å–å¾—çš„æ•°æ®åœ¨å†…å­˜æˆ–ç£ç›˜ä¸­è¿›è¡Œæ’åº\r\n* Using temporaryï¼šè¡¨ç¤º MySQL éœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨æ¥å­˜å‚¨ç»“æœé›†ï¼Œå¸¸è§äº**æ’åºã€å»é‡ï¼ˆUNIONï¼‰ã€åˆ†ç»„**ç­‰åœºæ™¯\r\n* Select tables optimized awayï¼šè¯´æ˜ä»…é€šè¿‡ä½¿ç”¨ç´¢å¼•ï¼Œä¼˜åŒ–å™¨å¯èƒ½ä»…ä»èšåˆå‡½æ•°ç»“æœä¸­è¿”å›ä¸€è¡Œ\r\n* No tables usedï¼šQuery è¯­å¥ä¸­ä½¿ç”¨ from dual æˆ–ä¸å«ä»»ä½• from å­å¥\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/ggjucheng/archive/2012/11/11/2765237.html\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### PROFILES\r\n\r\nSHOW PROFILES èƒ½å¤Ÿåœ¨åš SQL ä¼˜åŒ–æ—¶åˆ†æå½“å‰ä¼šè¯ä¸­è¯­å¥æ‰§è¡Œçš„**èµ„æºæ¶ˆè€—**æƒ…å†µ\r\n\r\n* é€šè¿‡ have_profiling å‚æ•°ï¼Œèƒ½å¤Ÿçœ‹åˆ°å½“å‰ MySQL æ˜¯å¦æ”¯æŒ profileï¼š\r\n  ![image-20250320005117798](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005117798.png)\r\n\r\n* é»˜è®¤ profiling æ˜¯å…³é—­çš„ï¼Œå¯ä»¥é€šè¿‡ set è¯­å¥åœ¨ Session çº§åˆ«å¼€å¯ profilingï¼š\r\n\r\n  ![image-20250320005143789](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005143789.png)\r\n\r\n  ```sql\r\n  SET profiling=1; #å¼€å¯profiling å¼€å…³ï¼›\r\n  ```\r\n\r\n* æ‰§è¡Œ SHOW PROFILES æŒ‡ä»¤ï¼Œ æ¥æŸ¥çœ‹ SQL è¯­å¥æ‰§è¡Œçš„è€—æ—¶:\r\n\r\n  ```sql\r\n  SHOW PROFILES;\r\n  ```\r\n\r\n  ![image-20250320005201687](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005201687.png)\r\n\r\n* æŸ¥çœ‹åˆ°è¯¥ SQL æ‰§è¡Œè¿‡ç¨‹ä¸­æ¯ä¸ªçº¿ç¨‹çš„çŠ¶æ€å’Œæ¶ˆè€—çš„æ—¶é—´ï¼š\r\n\r\n  ```sql\r\n  SHOW PROFILE FOR QUERY query_id;\r\n  ```\r\n\r\n  ![image-20250320005215913](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005215913.png)\r\n\r\n* åœ¨è·å–åˆ°æœ€æ¶ˆè€—æ—¶é—´çš„çº¿ç¨‹çŠ¶æ€åï¼ŒMySQL æ”¯æŒé€‰æ‹© allã€cpuã€block io ã€context switchã€page faults ç­‰ç±»å‹æŸ¥çœ‹ MySQL åœ¨ä½¿ç”¨ä»€ä¹ˆèµ„æºä¸Šè€—è´¹äº†è¿‡é«˜çš„æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œé€‰æ‹©æŸ¥çœ‹ CPU çš„è€—è´¹æ—¶é—´ï¼š\r\n\r\n  ![image-20250320005233044](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005233044.png)\r\n\r\n  * Statusï¼šSQL è¯­å¥æ‰§è¡Œçš„çŠ¶æ€\r\n  * Durationsqlï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­æ¯ä¸€ä¸ªæ­¥éª¤çš„è€—æ—¶\r\n  * CPU_userï¼šå½“å‰ç”¨æˆ·å æœ‰çš„ CPU\r\n  * CPU_systemï¼šç³»ç»Ÿå æœ‰çš„ CPU\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### TRACE\r\n\r\nMySQL æä¾›äº†å¯¹ SQL çš„è·Ÿè¸ªï¼Œ é€šè¿‡ trace æ–‡ä»¶å¯ä»¥æŸ¥çœ‹ä¼˜åŒ–å™¨**ç”Ÿæˆæ‰§è¡Œè®¡åˆ’çš„è¿‡ç¨‹**\r\n\r\n* æ‰“å¼€ trace åŠŸèƒ½ï¼Œè®¾ç½®æ ¼å¼ä¸º JSONï¼Œå¹¶è®¾ç½® trace çš„æœ€å¤§ä½¿ç”¨å†…å­˜ï¼Œé¿å…è§£æè¿‡ç¨‹ä¸­å› é»˜è®¤å†…å­˜è¿‡å°è€Œä¸èƒ½å¤Ÿå®Œæ•´å±•ç¤º\r\n\r\n  ```sql\r\n  SET optimizer_trace=\"enabled=on\",end_markers_in_json=ON;\t-- ä¼šè¯å†…æœ‰æ•ˆ\r\n  SET optimizer_trace_max_mem_size=1000000;\r\n  ```\r\n\r\n* æ‰§è¡Œ SQL è¯­å¥ï¼š\r\n\r\n  ```sql\r\n  SELECT * FROM tb_item WHERE id < 4;\r\n  ```\r\n\r\n* æ£€æŸ¥ information_schema.optimizer_traceï¼š\r\n\r\n  ```sql\r\n  SELECT * FROM information_schema.optimizer_trace \\G; -- \\Gä»£è¡¨ç«–åˆ—å±•ç¤º\r\n  ```\r\n\r\n  æ‰§è¡Œä¿¡æ¯ä¸»è¦æœ‰ä¸‰ä¸ªé˜¶æ®µï¼šprepare é˜¶æ®µã€optimize é˜¶æ®µï¼ˆæˆæœ¬åˆ†æï¼‰ã€execute é˜¶æ®µï¼ˆæ‰§è¡Œï¼‰\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n## ç´¢å¼•ä¼˜åŒ–\r\n\r\n### åˆ›å»ºç´¢å¼•\r\n\r\nç´¢å¼•æ˜¯æ•°æ®åº“ä¼˜åŒ–æœ€é‡è¦çš„æ‰‹æ®µä¹‹ä¸€ï¼Œé€šè¿‡ç´¢å¼•é€šå¸¸å¯ä»¥å¸®åŠ©ç”¨æˆ·è§£å†³å¤§å¤šæ•°çš„ MySQL çš„æ€§èƒ½ä¼˜åŒ–é—®é¢˜\r\n\r\n```sql\r\nCREATE TABLE `tb_seller` (\r\n\t`sellerid` varchar (100),\r\n\t`name` varchar (100),\r\n\t`nickname` varchar (50),\r\n\t`password` varchar (60),\r\n\t`status` varchar (1),\r\n\t`address` varchar (100),\r\n\t`createtime` datetime,\r\n    PRIMARY KEY(`sellerid`)\r\n)ENGINE=INNODB DEFAULT CHARSET=utf8mb4;\r\nINSERT INTO `tb_seller` (`sellerid`, `name`, `nickname`, `password`, `status`, `address`, `createtime`) values('xiaomi','å°ç±³ç§‘æŠ€','å°ç±³å®˜æ–¹æ——èˆ°åº—','e10adc3949ba59abbe56e057f20f883e','1','è¥¿å®‰å¸‚','2088-01-01 12:00:00');\r\nCREATE INDEX idx_seller_name_sta_addr ON tb_seller(name, status, address); # è”åˆç´¢å¼•\r\n```\r\n\r\n![image-20250320005254944](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005254944.png)\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### é¿å…å¤±æ•ˆ\r\n\r\n#### è¯­å¥é”™è¯¯\r\n\r\n* å…¨å€¼åŒ¹é…ï¼šå¯¹ç´¢å¼•ä¸­æ‰€æœ‰åˆ—éƒ½æŒ‡å®šå…·ä½“å€¼ï¼Œè¿™ç§æƒ…å†µç´¢å¼•ç”Ÿæ•ˆï¼Œæ‰§è¡Œæ•ˆç‡é«˜\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name='å°ç±³ç§‘æŠ€' AND status='1' AND address='è¥¿å®‰å¸‚';\r\n  ```\r\n\r\n  ![image-20250320005322275](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005322275.png)\r\n\r\n* **æœ€å·¦å‰ç¼€æ³•åˆ™**ï¼šè”åˆç´¢å¼•éµå®ˆæœ€å·¦å‰ç¼€æ³•åˆ™\r\n\r\n  åŒ¹é…æœ€å·¦å‰ç¼€æ³•åˆ™ï¼Œèµ°ç´¢å¼•ï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name='å°ç±³ç§‘æŠ€';\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name='å°ç±³ç§‘æŠ€' AND status='1';\r\n  ```\r\n\r\n  ![image-20250320005339410](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005339410.png)\r\n\r\n  è¿æ³•æœ€å·¦å‰ç¼€æ³•åˆ™ ï¼Œ ç´¢å¼•å¤±æ•ˆï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE status='1';\r\n  EXPLAIN SELECT * FROM tb_seller WHERE status='1' AND address='è¥¿å®‰å¸‚';\r\n  ```\r\n\r\n  ![image-20250320005359201](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005359201.png)\r\n\r\n  å¦‚æœç¬¦åˆæœ€å·¦æ³•åˆ™ï¼Œä½†æ˜¯å‡ºç°è·³è·ƒæŸä¸€åˆ—ï¼Œåªæœ‰æœ€å·¦åˆ—ç´¢å¼•ç”Ÿæ•ˆï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name='å°ç±³ç§‘æŠ€' AND address='è¥¿å®‰å¸‚';\r\n  ```\r\n\r\n  ![image-20250320005413395](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005413395.png)\r\n\r\n  è™½ç„¶ç´¢å¼•åˆ—å¤±æ•ˆï¼Œä½†æ˜¯ç³»ç»Ÿä¼š**ä½¿ç”¨äº†ç´¢å¼•ä¸‹æ¨è¿›è¡Œäº†ä¼˜åŒ–**\r\n\r\n* **èŒƒå›´æŸ¥è¯¢**å³è¾¹çš„åˆ—ï¼Œä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name='å°ç±³ç§‘æŠ€' AND status>'1' AND address='è¥¿å®‰å¸‚';\r\n  ```\r\n\r\n  æ ¹æ®å‰é¢çš„ä¸¤ä¸ªå­—æ®µ name ï¼Œ status æŸ¥è¯¢æ˜¯èµ°ç´¢å¼•çš„ï¼Œ ä½†æ˜¯æœ€åä¸€ä¸ªæ¡ä»¶ address æ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼Œä½¿ç”¨äº†ç´¢å¼•ä¸‹æ¨\r\n\r\n  ![image-20250320005428460](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005428460.png)\r\n\r\n* åœ¨ç´¢å¼•åˆ—ä¸Š**å‡½æ•°æˆ–è€…è¿ç®—ï¼ˆ+ - æ•°å€¼ï¼‰æ“ä½œ**ï¼Œ ç´¢å¼•å°†å¤±æ•ˆï¼šä¼šç ´åç´¢å¼•å€¼çš„æœ‰åºæ€§\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE SUBSTRING(name,3,2) = 'ç§‘æŠ€';\r\n  ```\r\n\r\n  ![image-20250320005505822](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005505822.png)\r\n\r\n* **å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·**ï¼Œé€ æˆç´¢å¼•å¤±æ•ˆï¼šéšå¼ç±»å‹è½¬æ¢ï¼Œå½“å­—ç¬¦ä¸²å’Œæ•°å­—æ¯”è¾ƒæ—¶ä¼š**æŠŠå­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ•°å­—**\r\n\r\n  æ²¡æœ‰å¯¹å­—ç¬¦ä¸²åŠ å•å¼•å·ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šè°ƒç”¨ CAST å‡½æ•°å°† status è½¬æ¢ä¸º int è¿›è¡Œæ¯”è¾ƒï¼Œé€ æˆç´¢å¼•å¤±æ•ˆ\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name='å°ç±³ç§‘æŠ€' AND status = 1;\r\n  ```\r\n\r\n  ![image-20250320005522191](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005522191.png)\r\n\r\n  å¦‚æœ status æ˜¯ int ç±»å‹ï¼ŒSQL ä¸º `SELECT * FROM tb_seller WHERE status = '1' ` å¹¶ä¸ä¼šé€ æˆç´¢å¼•å¤±æ•ˆï¼Œå› ä¸ºä¼šå°† `'1'` è½¬æ¢ä¸º `1`ï¼Œå¹¶**ä¸ä¼šå¯¹ç´¢å¼•åˆ—äº§ç”Ÿæ“ä½œ**\r\n\r\n* å¤šè¡¨è¿æ¥æŸ¥è¯¢æ—¶ï¼Œå¦‚æœä¸¤å¼ è¡¨çš„**å­—ç¬¦é›†ä¸åŒ**ï¼Œä¼šé€ æˆç´¢å¼•å¤±æ•ˆï¼Œå› ä¸ºä¼šè¿›è¡Œç±»å‹è½¬æ¢\r\n\r\n  è§£å†³æ–¹æ³•ï¼šCONVERT å‡½æ•°æ˜¯åŠ åœ¨è¾“å…¥å‚æ•°ä¸Šã€ä¿®æ”¹è¡¨çš„å­—ç¬¦é›†\r\n\r\n* **ç”¨ OR åˆ†å‰²æ¡ä»¶ï¼Œç´¢å¼•å¤±æ•ˆ**ï¼Œå¯¼è‡´å…¨è¡¨æŸ¥è¯¢ï¼š\r\n\r\n  OR å‰çš„æ¡ä»¶ä¸­çš„åˆ—æœ‰ç´¢å¼•è€Œåé¢çš„åˆ—ä¸­æ²¡æœ‰ç´¢å¼•æˆ– OR å‰åä¸¤ä¸ªåˆ—æ˜¯åŒä¸€ä¸ªå¤åˆç´¢å¼•ï¼Œéƒ½é€ æˆç´¢å¼•å¤±æ•ˆ\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name='é˜¿é‡Œå·´å·´' OR createtime = '2088-01-01 12:00:00';\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name='å°ç±³ç§‘æŠ€' OR status='1';\r\n  ```\r\n\r\n  ![image-20250320005541388](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005541388.png)\r\n\r\n  **AND åˆ†å‰²çš„æ¡ä»¶ä¸å½±å“**ï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name='é˜¿é‡Œå·´å·´' AND createtime = '2088-01-01 12:00:00';\r\n  ```\r\n\r\n  ![image-20250320005600331](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005600331.png)\r\n\r\n* **ä»¥ % å¼€å¤´çš„ LIKE æ¨¡ç³ŠæŸ¥è¯¢**ï¼Œç´¢å¼•å¤±æ•ˆï¼š\r\n\r\n  å¦‚æœæ˜¯å°¾éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•ä¸ä¼šå¤±æ•ˆï¼›å¦‚æœæ˜¯å¤´éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•å¤±æ•ˆ\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name like '%ç§‘æŠ€%';\r\n  ```\r\n\r\n  ![image-20250320005627032](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005627032.png)\r\n\r\n  è§£å†³æ–¹æ¡ˆï¼šé€šè¿‡è¦†ç›–ç´¢å¼•æ¥è§£å†³ \r\n\r\n  ```sql\r\n  EXPLAIN SELECT sellerid,name,status FROM tb_seller WHERE name like '%ç§‘æŠ€%';\r\n  ```\r\n\r\n  ![image-20250320005641628](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005641628.png)\r\n\r\n  åŸå› ï¼šåœ¨è¦†ç›–ç´¢å¼•çš„è¿™æ£µ B+ æ•°ä¸Šåªéœ€è¦è¿›è¡Œ like çš„åŒ¹é…ï¼Œæˆ–è€…æ˜¯åŸºäºè¦†ç›–ç´¢å¼•æŸ¥è¯¢å†è¿›è¡Œ WHERE çš„åˆ¤æ–­å°±å¯ä»¥è·å¾—ç»“æœ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ç³»ç»Ÿä¼˜åŒ–\r\n\r\nç³»ç»Ÿä¼˜åŒ–ä¸ºå…¨è¡¨æ‰«æï¼š\r\n\r\n* å¦‚æœ MySQL è¯„ä¼°ä½¿ç”¨ç´¢å¼•æ¯”å…¨è¡¨æ›´æ…¢ï¼Œåˆ™ä¸ä½¿ç”¨ç´¢å¼•ï¼Œç´¢å¼•å¤±æ•ˆï¼š\r\n\r\n  ```sql\r\n  CREATE INDEX idx_address ON tb_seller(address);\r\n  EXPLAIN SELECT * FROM tb_seller WHERE address='è¥¿å®‰å¸‚';\r\n  EXPLAIN SELECT * FROM tb_seller WHERE address='åŒ—äº¬å¸‚';\r\n  ```\r\n\r\n  åŒ—äº¬å¸‚çš„é”®å€¼å  9/10ï¼ˆåŒºåˆ†åº¦ä½ï¼‰ï¼Œæ‰€ä»¥ä¼˜åŒ–ä¸ºå…¨è¡¨æ‰«æï¼Œtype = ALL\r\n\r\n  ![image-20250320005656396](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005656396.png)\r\n\r\n* IS  NULLã€IS NOT NULL  **æœ‰æ—¶**ç´¢å¼•å¤±æ•ˆï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name IS NULL;\r\n  EXPLAIN SELECT * FROM tb_seller WHERE name IS NOT NULL;\r\n  ```\r\n\r\n  NOT NULL å¤±æ•ˆçš„åŸå› æ˜¯ name åˆ—å…¨éƒ¨ä¸æ˜¯ nullï¼Œä¼˜åŒ–ä¸ºå…¨è¡¨æ‰«æï¼Œå½“ NULL è¿‡å¤šæ—¶ï¼ŒIS NULL å¤±æ•ˆ\r\n\r\n  ![image-20250320005712759](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005712759.png)\r\n\r\n* IN è‚¯å®šä¼šèµ°ç´¢å¼•ï¼Œä½†æ˜¯å½“ IN çš„å–å€¼èŒƒå›´è¾ƒå¤§æ—¶ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œèµ°å…¨è¡¨æ‰«æï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller WHERE sellerId IN ('alibaba','huawei');-- éƒ½èµ°ç´¢å¼•\r\n  EXPLAIN SELECT * FROM tb_seller WHERE sellerId NOT IN ('alibaba','huawei');\r\n  ```\r\n\r\n* [MySQL å®æˆ˜ 45 è®²](https://time.geekbang.org/column/article/74687)è¯¥ç« èŠ‚æœ€åæå‡ºäº†ä¸€ç§æ…¢æŸ¥è¯¢åœºæ™¯ï¼Œè·å–åˆ°æ•°æ®ä»¥å Server å±‚è¿˜ä¼šåšåˆ¤æ–­\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### åº•å±‚åŸç†\r\n\r\nç´¢å¼•å¤±æ•ˆä¸€èˆ¬æ˜¯é’ˆå¯¹è”åˆç´¢å¼•ï¼Œè”åˆç´¢å¼•ä¸€èˆ¬ç”±å‡ ä¸ªå­—æ®µç»„æˆï¼Œæ’åºæ–¹å¼æ˜¯å…ˆæŒ‰ç…§ç¬¬ä¸€ä¸ªå­—æ®µè¿›è¡Œæ’åºï¼Œç„¶åæ’åºç¬¬äºŒä¸ªï¼Œä¾æ­¤ç±»æ¨ï¼Œå›¾ç¤ºï¼ˆa, bï¼‰ç´¢å¼•ï¼Œ**a ç›¸ç­‰çš„æƒ…å†µä¸‹ b æ˜¯æœ‰åºçš„**\r\n\r\n![image-20250320005742061](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005742061.png)\r\n\r\n* æœ€å·¦å‰ç¼€æ³•åˆ™ï¼šå½“ä¸åŒ¹é…å‰é¢çš„å­—æ®µçš„æ—¶å€™ï¼Œåé¢çš„å­—æ®µéƒ½æ˜¯æ— åºçš„ã€‚è¿™ç§æ— åºä¸ä»…ä½“ç°åœ¨å¶å­èŠ‚ç‚¹ï¼Œä¹Ÿä¼š**å¯¼è‡´æŸ¥è¯¢æ—¶æ‰«æçš„éå¶å­èŠ‚ç‚¹ä¹Ÿæ˜¯æ— åºçš„**ï¼Œå› ä¸ºç´¢å¼•æ ‘ç›¸å½“äºå¿½ç•¥çš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œå°±æ— æ³•ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾\r\n\r\n* èŒƒå›´æŸ¥è¯¢å³è¾¹çš„åˆ—ï¼Œä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œæ¯”å¦‚è¯­å¥ï¼š `WHERE a > 1 AND b = 1 `ï¼Œåœ¨ a å¤§äº 1 çš„æ—¶å€™ï¼Œb æ˜¯æ— åºçš„ï¼Œa > 1 æ˜¯æ‰«ææ—¶æœ‰åºçš„ï¼Œä½†æ˜¯æ‰¾åˆ°ä»¥åè¿›è¡Œå¯»æ‰¾ b æ—¶ï¼Œç´¢å¼•æ ‘å°±ä¸æ˜¯æœ‰åºçš„äº†\r\n\r\n  ![image-20250320005804788](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005804788.png)\r\n\r\n* ä»¥ % å¼€å¤´çš„ LIKE æ¨¡ç³ŠæŸ¥è¯¢ï¼Œç´¢å¼•å¤±æ•ˆï¼Œæ¯”å¦‚è¯­å¥ï¼š`WHERE a LIKE '%d'`ï¼Œå‰é¢çš„ä¸ç¡®å®šï¼Œå¯¼è‡´ä¸ç¬¦åˆæœ€å·¦åŒ¹é…ï¼Œç›´æ¥å»ç´¢å¼•ä¸­æœç´¢ä»¥ d ç»“å°¾çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ²¡æœ‰é¡ºåº\r\n      ![image-20250320005815689](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005815689.png)\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://mp.weixin.qq.com/s/B_M09dzLe9w7cT46rdGIeQ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### æŸ¥çœ‹ç´¢å¼•\r\n\r\n```sql\r\nSHOW STATUS LIKE 'Handler_read%';\t\r\nSHOW GLOBAL STATUS LIKE 'Handler_read%';\r\n```\r\n\r\n![image-20250320005841861](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005841861.png)\r\n\r\n* Handler_read_firstï¼šç´¢å¼•ä¸­ç¬¬ä¸€æ¡è¢«è¯»çš„æ¬¡æ•°ï¼Œå¦‚æœè¾ƒé«˜ï¼Œè¡¨ç¤ºæœåŠ¡å™¨æ­£æ‰§è¡Œå¤§é‡å…¨ç´¢å¼•æ‰«æï¼ˆè¿™ä¸ªå€¼è¶Šä½è¶Šå¥½ï¼‰\r\n\r\n* Handler_read_keyï¼šå¦‚æœç´¢å¼•æ­£åœ¨å·¥ä½œï¼Œè¿™ä¸ªå€¼ä»£è¡¨ä¸€ä¸ªè¡Œè¢«ç´¢å¼•å€¼è¯»çš„æ¬¡æ•°ï¼Œå€¼è¶Šä½è¡¨ç¤ºç´¢å¼•ä¸ç»å¸¸ä½¿ç”¨ï¼ˆè¿™ä¸ªå€¼è¶Šé«˜è¶Šå¥½ï¼‰\r\n\r\n* Handler_read_nextï¼šæŒ‰ç…§é”®é¡ºåºè¯»ä¸‹ä¸€è¡Œçš„è¯·æ±‚æ•°ï¼Œå¦‚æœèŒƒå›´çº¦æŸæˆ–æ‰§è¡Œç´¢å¼•æ‰«ææ¥æŸ¥è¯¢ç´¢å¼•åˆ—ï¼Œå€¼å¢åŠ \r\n\r\n* Handler_read_prevï¼šæŒ‰ç…§é”®é¡ºåºè¯»å‰ä¸€è¡Œçš„è¯·æ±‚æ•°ï¼Œè¯¥è¯»æ–¹æ³•ä¸»è¦ç”¨äºä¼˜åŒ– ORDER BY ... DESC\r\n\r\n* Handler_read_rndï¼šæ ¹æ®å›ºå®šä½ç½®è¯»ä¸€è¡Œçš„è¯·æ±‚æ•°ï¼Œå¦‚æœæ‰§è¡Œå¤§é‡æŸ¥è¯¢å¹¶å¯¹ç»“æœè¿›è¡Œæ’åºåˆ™è¯¥å€¼è¾ƒé«˜ï¼Œå¯èƒ½æ˜¯ä½¿ç”¨äº†å¤§é‡éœ€è¦ MySQL æ‰«ææ•´ä¸ªè¡¨çš„æŸ¥è¯¢æˆ–è¿æ¥ï¼Œè¿™ä¸ªå€¼è¾ƒé«˜æ„å‘³ç€è¿è¡Œæ•ˆç‡ä½ï¼Œåº”è¯¥å»ºç«‹ç´¢å¼•æ¥è§£å†³\r\n\r\n* Handler_read_rnd_nextï¼šåœ¨æ•°æ®æ–‡ä»¶ä¸­è¯»ä¸‹ä¸€è¡Œçš„è¯·æ±‚æ•°ï¼Œå¦‚æœæ­£è¿›è¡Œå¤§é‡çš„è¡¨æ‰«æï¼Œè¯¥å€¼è¾ƒé«˜ï¼Œè¯´æ˜è¡¨ç´¢å¼•ä¸æ­£ç¡®æˆ–å†™å…¥çš„æŸ¥è¯¢æ²¡æœ‰åˆ©ç”¨ç´¢å¼•\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n## SQL ä¼˜åŒ–\r\n\r\n### è‡ªå¢ä¸»é”®\r\n\r\n#### è‡ªå¢æœºåˆ¶\r\n\r\nè‡ªå¢ä¸»é”®å¯ä»¥è®©ä¸»é”®ç´¢å¼•å°½é‡åœ°ä¿æŒåœ¨æ•°æ®é¡µä¸­é€’å¢é¡ºåºæ’å…¥ï¼Œä¸è‡ªå¢éœ€è¦å¯»æ‰¾å…¶ä»–é¡µæ’å…¥ï¼Œå¯¼è‡´éšæœº IO å’Œé¡µåˆ†è£‚çš„æƒ…å†µ\r\n\r\nè¡¨çš„ç»“æ„å®šä¹‰å­˜æ”¾åœ¨åç¼€åä¸º.frm çš„æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯å¹¶ä¸ä¼šä¿å­˜è‡ªå¢å€¼ï¼Œä¸åŒçš„å¼•æ“å¯¹äºè‡ªå¢å€¼çš„ä¿å­˜ç­–ç•¥ä¸åŒï¼š\r\n\r\n* MyISAM å¼•æ“çš„è‡ªå¢å€¼ä¿å­˜åœ¨æ•°æ®æ–‡ä»¶ä¸­\r\n* InnoDB å¼•æ“çš„è‡ªå¢å€¼ä¿å­˜åœ¨äº†å†…å­˜é‡Œï¼Œæ¯æ¬¡æ‰“å¼€è¡¨éƒ½ä¼šå»æ‰¾è‡ªå¢å€¼çš„æœ€å¤§å€¼ max(id)ï¼Œç„¶åå°† max(id)+1 ä½œä¸ºå½“å‰çš„è‡ªå¢å€¼ï¼›8.0 ç‰ˆæœ¬åï¼Œæ‰æœ‰äº†è‡ªå¢å€¼æŒä¹…åŒ–çš„èƒ½åŠ›ï¼Œå°†è‡ªå¢å€¼çš„å˜æ›´è®°å½•åœ¨äº† redo log ä¸­ï¼Œé‡å¯çš„æ—¶å€™ä¾é  redo log æ¢å¤é‡å¯ä¹‹å‰çš„å€¼\r\n\r\nåœ¨æ’å…¥ä¸€è¡Œæ•°æ®çš„æ—¶å€™ï¼Œè‡ªå¢å€¼çš„è¡Œä¸ºå¦‚ä¸‹ï¼š\r\n\r\n* å¦‚æœæ’å…¥æ•°æ®æ—¶ id å­—æ®µæŒ‡å®šä¸º 0ã€null æˆ–æœªæŒ‡å®šå€¼ï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸ªè¡¨å½“å‰çš„ AUTO_INCREMENT å€¼å¡«åˆ°è‡ªå¢å­—æ®µ\r\n* å¦‚æœæ’å…¥æ•°æ®æ—¶ id å­—æ®µæŒ‡å®šäº†å…·ä½“çš„å€¼ï¼Œæ¯”å¦‚æŸæ¬¡è¦æ’å…¥çš„å€¼æ˜¯ Xï¼Œå½“å‰çš„è‡ªå¢å€¼æ˜¯ Y\r\n  * å¦‚æœ X<Yï¼Œé‚£ä¹ˆè¿™ä¸ªè¡¨çš„è‡ªå¢å€¼ä¸å˜\r\n  * å¦‚æœ Xâ‰¥Yï¼Œå°±éœ€è¦æŠŠå½“å‰è‡ªå¢å€¼ä¿®æ”¹ä¸ºæ–°çš„è‡ªå¢å€¼\r\n\r\nå‚æ•°è¯´æ˜ï¼šauto_increment_offset å’Œ auto_increment_increment åˆ†åˆ«è¡¨ç¤ºè‡ªå¢çš„åˆå§‹å€¼å’Œæ­¥é•¿ï¼Œé»˜è®¤å€¼éƒ½æ˜¯ 1\r\n\r\nè¯­å¥æ‰§è¡Œå¤±è´¥ä¹Ÿä¸å›é€€è‡ªå¢ idï¼Œæ‰€ä»¥ä¿è¯äº†è‡ªå¢ id æ˜¯é€’å¢çš„ï¼Œä½†ä¸ä¿è¯æ˜¯è¿ç»­çš„ï¼ˆä¸èƒ½å›é€€ï¼Œæ‰€ä»¥æœ‰äº›å›æ»šäº‹åŠ¡çš„è‡ªå¢ id å°±ä¸ä¼šé‡æ–°ä½¿ç”¨ï¼Œå¯¼è‡´å‡ºç°ä¸è¿ç»­ï¼‰\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### è‡ªå¢ ID\r\n\r\nMySQL ä¸åŒçš„è‡ªå¢ id åœ¨è¾¾åˆ°ä¸Šé™åçš„è¡¨ç°ä¸åŒï¼š\r\n\r\n* è¡¨çš„è‡ªå¢ id å¦‚æœæ˜¯ int ç±»å‹ï¼Œè¾¾åˆ°ä¸Šé™ 2^32-1 åï¼Œå†ç”³è¯·æ—¶å€¼å°±ä¸ä¼šæ”¹å˜ï¼Œè¿›è€Œå¯¼è‡´ç»§ç»­æ’å…¥æ•°æ®æ—¶æŠ¥ä¸»é”®å†²çªçš„é”™è¯¯\r\n\r\n* row_id é•¿åº¦ä¸º 6 ä¸ªå­—èŠ‚ï¼Œè¾¾åˆ°ä¸Šé™ååˆ™ä¼šå½’ 0 å†é‡æ–°é€’å¢ï¼Œå¦‚æœå‡ºç°ç›¸åŒçš„ row_idï¼Œåå†™çš„æ•°æ®ä¼šè¦†ç›–ä¹‹å‰çš„æ•°æ®ï¼Œé€ æˆæ—§æ•°æ®ä¸¢å¤±ï¼Œå½±å“çš„æ˜¯æ•°æ®å¯é æ€§ï¼Œæ‰€ä»¥åº”è¯¥åœ¨ InnoDB è¡¨ä¸­ä¸»åŠ¨åˆ›å»ºè‡ªå¢ä¸»é”®æŠ¥ä¸»é”®å†²çªï¼Œæ’å…¥å¤±è´¥å½±å“çš„æ˜¯å¯ç”¨æ€§ï¼Œè€Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ**å¯é æ€§ä¼˜å…ˆäºå¯ç”¨æ€§**\r\n\r\n* Xid é•¿åº¦ 8 å­—èŠ‚ï¼Œç”± Server å±‚ç»´æŠ¤ï¼Œåªéœ€è¦ä¸åœ¨åŒä¸€ä¸ª binlog æ–‡ä»¶ä¸­å‡ºç°é‡å¤å€¼å³å¯ï¼Œè™½ç„¶ç†è®ºä¸Šä¼šå‡ºç°é‡å¤å€¼ï¼Œä½†æ˜¯æ¦‚ç‡æå°\r\n\r\n* InnoDB çš„ max_trx_id é€’å¢å€¼æ¯æ¬¡ MySQL é‡å¯éƒ½ä¼šè¢«ä¿å­˜èµ·æ¥ï¼Œé‡å¯ä¹Ÿä¸ä¼šé‡ç½®ä¸º 0ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ä¸€ç›´å¢åŠ åˆ°è¾¾ä¸Šé™ï¼Œç„¶åä» 0 å¼€å§‹ï¼Œè¿™æ—¶åŸäº‹åŠ¡ 0 ä¿®æ”¹çš„æ•°æ®å¯¹å½“å‰äº‹åŠ¡å°±æ˜¯å¯è§çš„ï¼Œäº§ç”Ÿè„è¯»çš„ç°è±¡\r\n\r\n  åªè¯»äº‹åŠ¡ä¸åˆ†é… trx_idï¼Œæ‰€ä»¥ trx_id çš„å¢åŠ é€Ÿåº¦å˜æ…¢äº†\r\n\r\n* thread_id é•¿åº¦ 4 ä¸ªå­—èŠ‚ï¼Œåˆ°è¾¾ä¸Šé™åå°±ä¼šé‡ç½®ä¸º 0ï¼ŒMySQL è®¾è®¡äº†ä¸€ä¸ªå”¯ä¸€æ•°ç»„çš„é€»è¾‘ï¼Œç»™æ–°çº¿ç¨‹åˆ†é… thread_id æ—¶åšåˆ¤æ–­ï¼Œä¿è¯ä¸ä¼šå‡ºç°ä¸¤ä¸ªç›¸åŒçš„ thread_idï¼š\r\n\r\n  ```c++\r\n  do {\r\n  \tnew_id = thread_id_counter++;\r\n  } while (!thread_ids.insert_unique(new_id).second);\r\n  ```\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/83183\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### è¦†ç›–ç´¢å¼•\r\n\r\nå¤åˆç´¢å¼•å¶å­èŠ‚ç‚¹ä¸ä»…ä¿å­˜äº†å¤åˆç´¢å¼•çš„å€¼ï¼Œè¿˜æœ‰ä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„æ—¶å€™ï¼ŒåŠ ä¸Šä¸»é”®ä¹Ÿä¼šç”¨åˆ°ç´¢å¼•\r\n\r\nå°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œé¿å… SELECT *ï¼š\r\n\r\n```sql\r\nEXPLAIN SELECT name,status,address FROM tb_seller WHERE name='å°ç±³ç§‘æŠ€' AND status='1' AND address='è¥¿å®‰å¸‚';\r\n```\r\n\r\n![image-20250320005911035](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005911035.png)\r\n\r\nå¦‚æœæŸ¥è¯¢åˆ—ï¼Œè¶…å‡ºç´¢å¼•åˆ—ï¼Œä¹Ÿä¼šé™ä½æ€§èƒ½ï¼š\r\n\r\n```sql\r\nEXPLAIN SELECT name,status,address,password FROM tb_seller WHERE name='å°ç±³ç§‘æŠ€' AND status='1' AND address='è¥¿å®‰å¸‚';\r\n```\r\n\r\n![image-20250320005923175](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005923175.png)\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### å‡å°‘è®¿é—®\r\n\r\né¿å…å¯¹æ•°æ®è¿›è¡Œé‡å¤æ£€ç´¢ï¼šèƒ½å¤Ÿä¸€æ¬¡è¿æ¥å°±è·å–åˆ°ç»“æœçš„ï¼Œå°±ä¸ç”¨ä¸¤æ¬¡è¿æ¥ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘å¯¹æ•°æ®åº“æ— ç”¨çš„é‡å¤è¯·æ±‚\r\n\r\n* æŸ¥è¯¢æ•°æ®ï¼š\r\n\r\n  ```sql\r\n  SELECT id,name FROM tb_book;\r\n  SELECT id,status FROM tb_book; -- å‘æ•°æ®åº“æäº¤ä¸¤æ¬¡è¯·æ±‚ï¼Œæ•°æ®åº“å°±è¦åšä¸¤æ¬¡æŸ¥è¯¢æ“ä½œ\r\n  -- > ä¼˜åŒ–ä¸º:\r\n  SELECT id,name,statu FROM tb_book;\r\n  ```\r\n\r\n* æ’å…¥æ•°æ®ï¼š\r\n\r\n  ```sql\r\n  INSERT INTO tb_test VALUES(1,'Tom');\r\n  INSERT INTO tb_test VALUES(2,'Cat');\r\n  INSERT INTO tb_test VALUES(3,'Jerry');\t-- è¿æ¥ä¸‰æ¬¡æ•°æ®åº“\r\n  -- >ä¼˜åŒ–ä¸º\r\n  INSERT INTO tb_test VALUES(1,'Tom'),(2,'Cat')ï¼Œ(3,'Jerry');\t-- è¿æ¥ä¸€æ¬¡\r\n  ```\r\n\r\n* åœ¨äº‹åŠ¡ä¸­è¿›è¡Œæ•°æ®æ’å…¥ï¼š\r\n\r\n  ```sql\r\n  start transaction;\r\n  INSERT INTO tb_test VALUES(1,'Tom');\r\n  INSERT INTO tb_test VALUES(2,'Cat');\r\n  INSERT INTO tb_test VALUES(3,'Jerry');\r\n  commit;\t-- æ‰‹åŠ¨æäº¤ï¼Œåˆ†æ®µæäº¤\r\n  ```\r\n\r\n* æ•°æ®æœ‰åºæ’å…¥ï¼š\r\n\r\n  ```sql\r\n  INSERT INTO tb_test VALUES(1,'Tom');\r\n  INSERT INTO tb_test VALUES(2,'Cat');\r\n  INSERT INTO tb_test VALUES(3,'Jerry');\r\n  ```\r\n\r\nå¢åŠ  cache å±‚ï¼šåœ¨åº”ç”¨ä¸­å¢åŠ ç¼“å­˜å±‚æ¥è¾¾åˆ°å‡è½»æ•°æ®åº“è´Ÿæ‹…çš„ç›®çš„ã€‚å¯ä»¥éƒ¨åˆ†æ•°æ®ä»æ•°æ®åº“ä¸­æŠ½å–å‡ºæ¥æ”¾åˆ°åº”ç”¨ç«¯ä»¥æ–‡æœ¬æ–¹å¼å­˜å‚¨ï¼Œæˆ–è€…ä½¿ç”¨æ¡†æ¶ï¼ˆMybatisï¼‰æä¾›çš„ä¸€çº§ç¼“å­˜ / äºŒçº§ç¼“å­˜ï¼Œæˆ–è€…ä½¿ç”¨ Redis æ•°æ®åº“æ¥ç¼“å­˜æ•°æ® \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### æ•°æ®æ’å…¥\r\n\r\nå½“ä½¿ç”¨ load å‘½ä»¤å¯¼å…¥æ•°æ®çš„æ—¶å€™ï¼Œé€‚å½“çš„è®¾ç½®å¯ä»¥æé«˜å¯¼å…¥çš„æ•ˆç‡ï¼š\r\n\r\n![image-20250320005951328](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320005951328.png)\r\n\r\n```sql\r\nLOAD DATA LOCAL INFILE = '/home/klaus/sql1.log' INTO TABLE `tb_user_1` FIELD TERMINATED BY ',' LINES TERMINATED BY '\\n'; -- æ–‡ä»¶æ ¼å¼å¦‚ä¸Šå›¾\r\n```\r\n\r\nå¯¹äº InnoDB ç±»å‹çš„è¡¨ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼å¯ä»¥æé«˜å¯¼å…¥çš„æ•ˆç‡ï¼š\r\n\r\n1. **ä¸»é”®é¡ºåºæ’å…¥**ï¼šå› ä¸º InnoDB ç±»å‹çš„è¡¨æ˜¯æŒ‰ç…§ä¸»é”®çš„é¡ºåºä¿å­˜çš„ï¼Œæ‰€ä»¥å°†å¯¼å…¥çš„æ•°æ®æŒ‰ç…§ä¸»é”®çš„é¡ºåºæ’åˆ—ï¼Œå¯ä»¥æœ‰æ•ˆçš„æé«˜å¯¼å…¥æ•°æ®çš„æ•ˆç‡ï¼Œå¦‚æœ InnoDB è¡¨æ²¡æœ‰ä¸»é”®ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šè‡ªåŠ¨é»˜è®¤åˆ›å»ºä¸€ä¸ªå†…éƒ¨åˆ—ä½œä¸ºä¸»é”®\r\n\r\n   ä¸»é”®æ˜¯å¦è¿ç»­å¯¹æ€§èƒ½å½±å“ä¸å¤§ï¼Œåªè¦æ˜¯é€’å¢çš„å°±å¯ä»¥ï¼Œæ¯”å¦‚é›ªèŠ±ç®—æ³•äº§ç”Ÿçš„ ID ä¸æ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯æ˜¯é€’å¢çš„ï¼Œå› ä¸ºé€’å¢å¯ä»¥è®©ä¸»é”®ç´¢å¼•å°½é‡åœ°ä¿æŒé¡ºåºæ’å…¥ï¼Œ**é¿å…äº†é¡µåˆ†è£‚**ï¼Œå› æ­¤ç´¢å¼•æ›´ç´§å‡‘\r\n\r\n   * æ’å…¥ ID é¡ºåºæ’åˆ—æ•°æ®ï¼š\r\n\r\n   ![image-20250320010010521](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010010521.png)\r\n\r\n   * æ’å…¥ ID æ— åºæ’åˆ—æ•°æ®ï¼š\r\n\r\n   ![image-20250320010026345](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010026345.png)\r\n\r\n2. **å…³é—­å”¯ä¸€æ€§æ ¡éªŒ**ï¼šåœ¨å¯¼å…¥æ•°æ®å‰æ‰§è¡Œ `SET UNIQUE_CHECKS=0`ï¼Œå…³é—­å”¯ä¸€æ€§æ ¡éªŒï¼›å¯¼å…¥ç»“æŸåæ‰§è¡Œ `SET UNIQUE_CHECKS=1`ï¼Œæ¢å¤å”¯ä¸€æ€§æ ¡éªŒï¼Œå¯ä»¥æé«˜å¯¼å…¥çš„æ•ˆç‡ã€‚\r\n\r\n   ![image-20250320010102015](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010102015.png)\r\n\r\n3. **æ‰‹åŠ¨æäº¤äº‹åŠ¡**ï¼šå¦‚æœåº”ç”¨ä½¿ç”¨è‡ªåŠ¨æäº¤çš„æ–¹å¼ï¼Œå»ºè®®åœ¨å¯¼å…¥å‰æ‰§è¡Œ`SET AUTOCOMMIT=0`ï¼Œå…³é—­è‡ªåŠ¨æäº¤ï¼›å¯¼å…¥ç»“æŸåå†æ‰“å¼€è‡ªåŠ¨æäº¤ï¼Œå¯ä»¥æé«˜å¯¼å…¥çš„æ•ˆç‡ã€‚\r\n\r\n   äº‹åŠ¡éœ€è¦æ§åˆ¶å¤§å°ï¼Œäº‹åŠ¡å¤ªå¤§å¯èƒ½ä¼šå½±å“æ‰§è¡Œçš„æ•ˆç‡ã€‚MySQL æœ‰ innodb_log_buffer_size é…ç½®é¡¹ï¼Œè¶…è¿‡è¿™ä¸ªå€¼çš„æ—¥å¿—ä¼šå†™å…¥ç£ç›˜æ•°æ®ï¼Œæ•ˆç‡ä¼šä¸‹é™ï¼Œæ‰€ä»¥åœ¨äº‹åŠ¡å¤§å°è¾¾åˆ°é…ç½®é¡¹æ•°æ®çº§å‰è¿›è¡Œäº‹åŠ¡æäº¤å¯ä»¥æé«˜æ•ˆç‡\r\n\r\n   ![image-20250320010116411](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010116411.png)\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### åˆ†ç»„æ’åº\r\n\r\n#### ORDER\r\n\r\næ•°æ®å‡†å¤‡ï¼š\r\n\r\n```sql\r\nCREATE TABLE `emp` (\r\n  `id` INT(11) NOT NULL AUTO_INCREMENT,\r\n  `name` VARCHAR(100) NOT NULL,\r\n  `age` INT(3) NOT NULL,\r\n  `salary` INT(11) DEFAULT NULL,\r\n  PRIMARY KEY (`id`)\r\n) ENGINE=INNODB DEFAULT CHARSET=utf8mb4;\r\nINSERT INTO `emp` (`id`, `name`, `age`, `salary`) VALUES('1','Tom','25','2300');-- ...\r\nCREATE INDEX idx_emp_age_salary ON emp(age, salary);\r\n```\r\n\r\n* ç¬¬ä¸€ç§æ˜¯é€šè¿‡å¯¹è¿”å›æ•°æ®è¿›è¡Œæ’åºï¼Œæ‰€æœ‰ä¸é€šè¿‡ç´¢å¼•ç›´æ¥è¿”å›ç»“æœçš„æ’åºéƒ½å« FileSort æ’åºï¼Œä¼šåœ¨å†…å­˜ä¸­é‡æ–°æ’åº\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM emp ORDER BY age DESC;\t-- å¹´é¾„é™åº\r\n  ```\r\n\r\n  ![image-20250320010133855](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010133855.png)\r\n\r\n* ç¬¬äºŒç§é€šè¿‡æœ‰åºç´¢å¼•é¡ºåºæ‰«æç›´æ¥è¿”å›**æœ‰åºæ•°æ®**ï¼Œè¿™ç§æƒ…å†µä¸º Using indexï¼Œä¸éœ€è¦é¢å¤–æ’åºï¼Œæ“ä½œæ•ˆç‡é«˜\r\n\r\n  ```sql\r\n  EXPLAIN SELECT id, age, salary FROM emp ORDER BY age DESC;\r\n  ```\r\n\r\n  ![image-20250320010145655](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010145655.png)\r\n\r\n* å¤šå­—æ®µæ’åºï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT id,age,salary FROM emp ORDER BY age DESC, salary DESC;\r\n  EXPLAIN SELECT id,age,salary FROM emp ORDER BY salary DESC, age DESC;\r\n  EXPLAIN SELECT id,age,salary FROM emp ORDER BY age DESC, salary ASC;\r\n  ```\r\n\r\n  ![image-20250320010212699](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010212699.png)\r\n\r\n  å°½é‡å‡å°‘é¢å¤–çš„æ’åºï¼Œé€šè¿‡ç´¢å¼•ç›´æ¥è¿”å›æœ‰åºæ•°æ®ã€‚**éœ€è¦æ»¡è¶³ Order by ä½¿ç”¨ç›¸åŒçš„ç´¢å¼•ã€Order By çš„é¡ºåºå’Œç´¢å¼•é¡ºåºç›¸åŒã€Order  by çš„å­—æ®µéƒ½æ˜¯å‡åºæˆ–éƒ½æ˜¯é™åº**ï¼Œå¦åˆ™éœ€è¦é¢å¤–çš„æ“ä½œï¼Œå°±ä¼šå‡ºç° FileSort\r\n\r\n* ORDER BY RAND() å‘½ä»¤ç”¨æ¥è¿›è¡Œéšæœºæ’åºï¼Œä¼šä½¿ç”¨äº†ä¸´æ—¶å†…å­˜è¡¨ï¼Œä¸´æ—¶å†…å­˜è¡¨æ’åºçš„æ—¶ä½¿ç”¨ rowid æ’åºæ–¹æ³•\r\n\r\nä¼˜åŒ–æ–¹å¼ï¼šåˆ›å»ºåˆé€‚çš„ç´¢å¼•èƒ½å¤Ÿå‡å°‘ Filesort çš„å‡ºç°ï¼Œä½†æ˜¯æŸäº›æƒ…å†µä¸‹æ¡ä»¶é™åˆ¶ä¸èƒ½è®© Filesort æ¶ˆå¤±ï¼Œå°±è¦åŠ å¿« Filesort çš„æ’åºæ“ä½œ\r\n\r\nå†…å­˜ä¸´æ—¶è¡¨ï¼ŒMySQL æœ‰ä¸¤ç§ Filesort æ’åºç®—æ³•ï¼š\r\n\r\n* rowid æ’åºï¼šé¦–å…ˆæ ¹æ®æ¡ä»¶å–å‡ºæ’åºå­—æ®µå’Œä¿¡æ¯ï¼Œç„¶ååœ¨**æ’åºåŒº sort bufferï¼ˆServer å±‚ï¼‰**ä¸­æ’åºï¼Œå¦‚æœ sort buffer ä¸å¤Ÿï¼Œåˆ™åœ¨ä¸´æ—¶è¡¨ temporary table ä¸­å­˜å‚¨æ’åºç»“æœã€‚å®Œæˆæ’åºåå†æ ¹æ®è¡ŒæŒ‡é’ˆ**å›è¡¨è¯»å–è®°å½•**ï¼Œè¯¥æ“ä½œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡éšæœº I/O æ“ä½œ\r\n\r\n  è¯´æ˜ï¼šå¯¹äºä¸´æ—¶å†…å­˜è¡¨ï¼Œå›è¡¨è¿‡ç¨‹åªæ˜¯ç®€å•åœ°æ ¹æ®æ•°æ®è¡Œçš„ä½ç½®ï¼Œç›´æ¥è®¿é—®å†…å­˜å¾—åˆ°æ•°æ®ï¼Œä¸ä¼šå¯¼è‡´å¤šè®¿é—®ç£ç›˜ï¼Œä¼˜å…ˆé€‰æ‹©è¯¥æ–¹å¼\r\n\r\n* å…¨å­—æ®µæ’åºï¼šä¸€æ¬¡æ€§å–å‡ºæ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰æ•°æ®ï¼Œéœ€è¦å›è¡¨ï¼Œç„¶ååœ¨æ’åºåŒº sort  buffer ä¸­æ’åºåç›´æ¥è¾“å‡ºç»“æœé›†ã€‚æ’åºæ—¶å†…å­˜å¼€é”€è¾ƒå¤§ï¼Œä½†æ˜¯æ’åºæ•ˆç‡æ¯”ä¸¤æ¬¡æ‰«æç®—æ³•é«˜\r\n\r\nå…·ä½“çš„é€‰æ‹©æ–¹å¼ï¼š\r\n\r\n* MySQL é€šè¿‡æ¯”è¾ƒç³»ç»Ÿå˜é‡ max_length_for_sort_data çš„å¤§å°å’Œ Query è¯­å¥å–å‡ºçš„å­—æ®µçš„å¤§å°ï¼Œæ¥åˆ¤å®šä½¿ç”¨å“ªç§æ’åºç®—æ³•ã€‚å¦‚æœå‰è€…å¤§ï¼Œåˆ™è¯´æ˜ sort  buffer ç©ºé—´è¶³å¤Ÿï¼Œä½¿ç”¨ç¬¬äºŒç§ä¼˜åŒ–ä¹‹åçš„ç®—æ³•ï¼Œå¦åˆ™ä½¿ç”¨ç¬¬ä¸€ç§ã€‚\r\n\r\n* å¯ä»¥é€‚å½“æé«˜ sort_buffer_size  å’Œ max_length_for_sort_data ç³»ç»Ÿå˜é‡ï¼Œæ¥å¢å¤§æ’åºåŒºçš„å¤§å°ï¼Œæé«˜æ’åºçš„æ•ˆç‡\r\n\r\n  ```sql\r\n  SET @@max_length_for_sort_data = 10000; \t\t-- è®¾ç½®å…¨å±€å˜é‡\r\n  SET max_length_for_sort_data = 10240; \t\t\t-- è®¾ç½®ä¼šè¯å˜é‡\r\n  SHOW VARIABLES LIKE 'max_length_for_sort_data';\t-- é»˜è®¤1024\r\n  SHOW VARIABLES LIKE 'sort_buffer_size';\t\t\t-- é»˜è®¤262114\r\n  ```\r\n\r\nç£ç›˜ä¸´æ—¶è¡¨ï¼šæ’åºä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆå †ï¼‰çš„æ–¹å¼\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### GROUP\r\n\r\nGROUP BY ä¹Ÿä¼šè¿›è¡Œæ’åºæ“ä½œï¼Œä¸ ORDER BY ç›¸æ¯”ï¼ŒGROUP BY ä¸»è¦åªæ˜¯å¤šäº†æ’åºä¹‹åçš„åˆ†ç»„æ“ä½œï¼Œæ‰€ä»¥åœ¨ GROUP BY çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œä¸ ORDER BY ä¸€æ ·ä¹Ÿå¯ä»¥åˆ©ç”¨åˆ°ç´¢å¼•\r\n\r\n* åˆ†ç»„æŸ¥è¯¢ï¼š\r\n\r\n  ```sql\r\n  DROP INDEX idx_emp_age_salary ON emp;\r\n  EXPLAIN SELECT age,COUNT(*) FROM emp GROUP BY age;\r\n  ```\r\n\r\n  ![image-20250320010253430](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010253430.png)\r\n\r\n  Using temporaryï¼šè¡¨ç¤º MySQL éœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨ï¼ˆä¸æ˜¯ sort bufferï¼‰æ¥å­˜å‚¨ç»“æœé›†ï¼Œå¸¸è§äºæ’åºå’Œåˆ†ç»„æŸ¥è¯¢\r\n\r\n* æŸ¥è¯¢åŒ…å« GROUP BY ä½†æ˜¯ç”¨æˆ·æƒ³è¦é¿å…æ’åºç»“æœçš„æ¶ˆè€—ï¼Œ åˆ™å¯ä»¥æ‰§è¡Œ ORDER BY NULL ç¦æ­¢æ’åºï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT age,COUNT(*) FROM emp GROUP BY age ORDER BY NULL;\r\n  ```\r\n\r\n  ![image-20250320010330441](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010330441.png)\r\n\r\n* åˆ›å»ºç´¢å¼•ï¼šç´¢å¼•æœ¬èº«æœ‰åºï¼Œä¸éœ€è¦ä¸´æ—¶è¡¨ï¼Œä¹Ÿä¸éœ€è¦å†é¢å¤–æ’åº\r\n\r\n  ```sql\r\n  CREATE INDEX idx_emp_age_salary ON emp(age, salary);\r\n  ```\r\n\r\n  ![](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010353642.png)\r\n\r\n* æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œä½¿ç”¨ SQL_BIG_RESULT æç¤ºä¼˜åŒ–å™¨ç›´æ¥ä½¿ç”¨ç›´æ¥ç”¨ç£ç›˜ä¸´æ—¶è¡¨\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### è”åˆæŸ¥è¯¢\r\n\r\nå¯¹äºåŒ…å« OR çš„æŸ¥è¯¢å­å¥ï¼Œå¦‚æœè¦åˆ©ç”¨ç´¢å¼•ï¼Œåˆ™ OR ä¹‹é—´çš„**æ¯ä¸ªæ¡ä»¶åˆ—éƒ½å¿…é¡»ç”¨åˆ°ç´¢å¼•ï¼Œè€Œä¸”ä¸èƒ½ä½¿ç”¨åˆ°æ¡ä»¶ä¹‹é—´çš„å¤åˆç´¢å¼•**ï¼Œå¦‚æœæ²¡æœ‰ç´¢å¼•ï¼Œåˆ™åº”è¯¥è€ƒè™‘å¢åŠ ç´¢å¼•\r\n\r\n* æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM emp WHERE id = 1 OR age = 30;\t-- ä¸¤ä¸ªç´¢å¼•ï¼Œå¹¶ä¸”ä¸æ˜¯å¤åˆç´¢å¼•\r\n  ```\r\n\r\n  ![image-20250320010443299](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010443299.png)\r\n\r\n  ```sh\r\n  Extra: Using sort_union(idx_emp_age_salary,PRIMARY); Using where\r\n  ```\r\n\r\n* ä½¿ç”¨ UNION æ›¿æ¢ ORï¼Œæ±‚å¹¶é›†ï¼š\r\n\r\n  æ³¨æ„ï¼šè¯¥ä¼˜åŒ–åªé’ˆå¯¹å¤šä¸ªç´¢å¼•åˆ—æœ‰æ•ˆï¼Œå¦‚æœæœ‰åˆ—æ²¡æœ‰è¢«ç´¢å¼•ï¼ŒæŸ¥è¯¢æ•ˆç‡å¯èƒ½ä¼šå› ä¸ºæ²¡æœ‰é€‰æ‹© OR è€Œé™ä½\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM emp WHERE id = 1 UNION SELECT * FROM emp WHERE age = 30;\r\n  ```\r\n\r\n  ![image-20250320010458558](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010458558.png)\r\n\r\n* UNION è¦ä¼˜äº OR çš„åŸå› ï¼š\r\n\r\n  * UNION è¯­å¥çš„ type å€¼ä¸º refï¼ŒOR è¯­å¥çš„ type å€¼ä¸º range\r\n  * UNION è¯­å¥çš„ ref å€¼ä¸º constï¼ŒOR è¯­å¥çš„ ref å€¼ä¸º nullï¼Œconst è¡¨ç¤ºæ˜¯å¸¸é‡å€¼å¼•ç”¨ï¼Œéå¸¸å¿«\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### åµŒå¥—æŸ¥è¯¢\r\n\r\nMySQL 4.1 ç‰ˆæœ¬ä¹‹åï¼Œå¼€å§‹æ”¯æŒ SQL çš„å­æŸ¥è¯¢\r\n\r\n* å¯ä»¥ä½¿ç”¨ SELECT è¯­å¥æ¥åˆ›å»ºä¸€ä¸ªå•åˆ—çš„æŸ¥è¯¢ç»“æœï¼Œç„¶åæŠŠç»“æœä½œä¸ºè¿‡æ»¤æ¡ä»¶ç”¨åœ¨å¦ä¸€ä¸ªæŸ¥è¯¢ä¸­\r\n* ä½¿ç”¨å­æŸ¥è¯¢å¯ä»¥ä¸€æ¬¡æ€§çš„å®Œæˆé€»è¾‘ä¸Šéœ€è¦å¤šä¸ªæ­¥éª¤æ‰èƒ½å®Œæˆçš„ SQL æ“ä½œï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é¿å…äº‹åŠ¡æˆ–è€…è¡¨é”æ­»\r\n* åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œ**å­æŸ¥è¯¢æ˜¯å¯ä»¥è¢«æ›´é«˜æ•ˆçš„è¿æ¥ï¼ˆJOINï¼‰æ›¿ä»£**\r\n\r\nä¾‹å¦‚æŸ¥æ‰¾æœ‰è§’è‰²çš„æ‰€æœ‰çš„ç”¨æˆ·ä¿¡æ¯ï¼š\r\n\r\n* æ‰§è¡Œè®¡åˆ’ï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM t_user WHERE id IN (SELECT user_id FROM user_role);\r\n  ```\r\n\r\n  ![image-20250320010514932](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010514932.png)\r\n\r\n* ä¼˜åŒ–åï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM t_user u , user_role ur WHERE u.id = ur.user_id;\r\n  ```\r\n\r\n  ![image-20250320010528940](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010528940.png)\r\n\r\n  è¿æ¥æŸ¥è¯¢ä¹‹æ‰€ä»¥æ•ˆç‡æ›´é«˜ ï¼Œæ˜¯å› ä¸º**ä¸éœ€è¦åœ¨å†…å­˜ä¸­åˆ›å»ºä¸´æ—¶è¡¨**æ¥å®Œæˆé€»è¾‘ä¸Šéœ€è¦ä¸¤ä¸ªæ­¥éª¤çš„æŸ¥è¯¢å·¥ä½œ\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### åˆ†é¡µæŸ¥è¯¢\r\n\r\nä¸€èˆ¬åˆ†é¡µæŸ¥è¯¢æ—¶ï¼Œé€šè¿‡åˆ›å»ºè¦†ç›–ç´¢å¼•èƒ½å¤Ÿæ¯”è¾ƒå¥½åœ°æé«˜æ€§èƒ½\r\n\r\nä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯ `LIMIT 200000,10`ï¼Œæ­¤æ—¶éœ€è¦ MySQL æ‰«æå‰ 200010 è®°å½•ï¼Œä»…ä»…è¿”å› 200000 - 200010 ä¹‹é—´çš„è®°å½•ï¼Œå…¶ä»–è®°å½•ä¸¢å¼ƒï¼ŒæŸ¥è¯¢æ’åºçš„ä»£ä»·éå¸¸å¤§\r\n\r\n* åˆ†é¡µæŸ¥è¯¢ï¼š\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_user_1 LIMIT 200000,10;\r\n  ```\r\n\r\n  ![image-20250320010546706](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010546706.png)\r\n\r\n* ä¼˜åŒ–æ–¹å¼ä¸€ï¼šå†…è¿æ¥æŸ¥è¯¢ï¼Œåœ¨ç´¢å¼•åˆ— id ä¸Šå®Œæˆæ’åºåˆ†é¡µæ“ä½œï¼Œæœ€åæ ¹æ®ä¸»é”®å…³è”å›åŸè¡¨æŸ¥è¯¢æ‰€éœ€è¦çš„å…¶ä»–åˆ—å†…å®¹\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_user_1 t,(SELECT id FROM tb_user_1 ORDER BY id LIMIT 200000,10) a WHERE t.id = a.id;\r\n  ```\r\n\r\n  ![image-20250320010600495](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010600495.png)\r\n\r\n* ä¼˜åŒ–æ–¹å¼äºŒï¼šæ–¹æ¡ˆé€‚ç”¨äºä¸»é”®è‡ªå¢çš„è¡¨ï¼Œå¯ä»¥æŠŠ LIMIT æŸ¥è¯¢è½¬æ¢æˆæŸä¸ªä½ç½®çš„æŸ¥è¯¢\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_user_1 WHERE id > 200000 LIMIT 10;\t\t\t-- å†™æ³• 1\r\n  EXPLAIN SELECT * FROM tb_user_1 WHERE id BETWEEN 200000 and 200010;\t-- å†™æ³• 2\r\n  ```\r\n\r\n  ![image-20250320010614388](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010614388.png)\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### ä½¿ç”¨æç¤º\r\n\r\nSQL æç¤ºï¼Œæ˜¯ä¼˜åŒ–æ•°æ®åº“çš„ä¸€ä¸ªé‡è¦æ‰‹æ®µï¼Œå°±æ˜¯åœ¨ SQL è¯­å¥ä¸­åŠ å…¥ä¸€äº›æç¤ºæ¥è¾¾åˆ°ä¼˜åŒ–æ“ä½œçš„ç›®çš„\r\n\r\n* USE INDEXï¼šåœ¨æŸ¥è¯¢è¯­å¥ä¸­è¡¨åçš„åé¢æ·»åŠ  USE INDEX æ¥æä¾› MySQL å»å‚è€ƒçš„ç´¢å¼•åˆ—è¡¨ï¼Œå¯ä»¥è®© MySQL ä¸å†è€ƒè™‘å…¶ä»–å¯ç”¨çš„ç´¢å¼•\r\n\r\n  ```sql\r\n  CREATE INDEX idx_seller_name ON tb_seller(name);\r\n  EXPLAIN SELECT * FROM tb_seller USE INDEX(idx_seller_name) WHERE name='å°ç±³ç§‘æŠ€';\r\n  ```\r\n\r\n  ![image-20250320010640115](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010640115.png)\r\n\r\n* IGNORE INDEXï¼šè®© MySQL å¿½ç•¥ä¸€ä¸ªæˆ–è€…å¤šä¸ªç´¢å¼•ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ IGNORE INDEX ä½œä¸ºæç¤º\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller IGNORE INDEX(idx_seller_name) WHERE name = 'å°ç±³ç§‘æŠ€';\r\n  ```\r\n\r\n  ![image-20250320010653006](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010653006.png)\r\n\r\n* FORCE INDEXï¼šå¼ºåˆ¶ MySQL ä½¿ç”¨ä¸€ä¸ªç‰¹å®šçš„ç´¢å¼•\r\n\r\n  ```sql\r\n  EXPLAIN SELECT * FROM tb_seller FORCE INDEX(idx_seller_name_sta_addr) WHERE NAME='å°ç±³ç§‘æŠ€';\r\n  ```\r\n\r\n  ![image-20250320010722329](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010722329.png)\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ç»Ÿè®¡è®¡æ•°\r\n\r\nåœ¨ä¸åŒçš„ MySQL å¼•æ“ä¸­ï¼Œcount(*) æœ‰ä¸åŒçš„å®ç°æ–¹å¼ï¼š\r\n\r\n* MyISAM å¼•æ“æŠŠä¸€ä¸ªè¡¨çš„æ€»è¡Œæ•°å­˜åœ¨äº†ç£ç›˜ä¸Šï¼Œå› æ­¤æ‰§è¡Œ count(*) çš„æ—¶å€™ä¼šç›´æ¥è¿”å›è¿™ä¸ªæ•°ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œä½†ä¸æ”¯æŒäº‹åŠ¡\r\n* show table status å‘½ä»¤é€šè¿‡é‡‡æ ·ä¼°ç®—å¯ä»¥å¿«é€Ÿè·å–ï¼Œä½†æ˜¯ä¸å‡†ç¡®\r\n* InnoDB è¡¨æ‰§è¡Œ count(*) ä¼šéå†å…¨è¡¨ï¼Œè™½ç„¶ç»“æœå‡†ç¡®ï¼Œä½†ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜\r\n\r\nè§£å†³æ–¹æ¡ˆï¼š\r\n\r\n* è®¡æ•°ä¿å­˜åœ¨ Redis ä¸­ï¼Œä½†æ˜¯æ›´æ–° MySQL å’Œ Redis çš„æ“ä½œä¸æ˜¯åŸå­çš„ï¼Œä¼šå­˜åœ¨æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜\r\n\r\n* è®¡æ•°ç›´æ¥æ”¾åˆ°æ•°æ®åº“é‡Œå•ç‹¬çš„ä¸€å¼ è®¡æ•°è¡¨ä¸­ï¼Œåˆ©ç”¨äº‹åŠ¡è§£å†³è®¡æ•°ç²¾ç¡®é—®é¢˜ï¼š\r\n\r\n  ![image-20250320010755840](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010755840.png)\r\n\r\n  ä¼šè¯ B çš„è¯»æ“ä½œåœ¨ T3 æ‰§è¡Œçš„ï¼Œè¿™æ—¶æ›´æ–°äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œæ‰€ä»¥è®¡æ•°å€¼åŠ  1 è¿™ä¸ªæ“ä½œå¯¹ä¼šè¯ B è¿˜ä¸å¯è§ï¼Œå› æ­¤ä¼šè¯ B æŸ¥è¯¢çš„è®¡æ•°å€¼å’Œæœ€è¿‘ 100 æ¡è®°å½•ï¼Œè¿”å›çš„ç»“æœé€»è¾‘ä¸Šå°±æ˜¯ä¸€è‡´çš„\r\n\r\n  å¹¶å‘ç³»ç»Ÿæ€§èƒ½çš„è§’åº¦è€ƒè™‘ï¼Œåº”è¯¥å…ˆæ’å…¥æ“ä½œè®°å½•å†æ›´æ–°è®¡æ•°è¡¨ï¼Œå› ä¸ºæ›´æ–°è®¡æ•°è¡¨æ¶‰åŠåˆ°è¡Œé”çš„ç«äº‰ï¼Œ**å…ˆæ’å…¥å†æ›´æ–°èƒ½æœ€å¤§ç¨‹åº¦åœ°å‡å°‘äº‹åŠ¡ä¹‹é—´çš„é”ç­‰å¾…ï¼Œæå‡å¹¶å‘åº¦**\r\n\r\ncount å‡½æ•°çš„æŒ‰ç…§æ•ˆç‡æ’åºï¼š`count(å­—æ®µ) < count(ä¸»é”®id) < count(1) â‰ˆ count(*)`ï¼Œæ‰€ä»¥å»ºè®®å°½é‡ä½¿ç”¨ count(*)\r\n\r\n* count(ä¸»é”® id)ï¼šInnoDB å¼•æ“ä¼šéå†æ•´å¼ è¡¨ï¼ŒæŠŠæ¯ä¸€è¡Œçš„ id å€¼éƒ½å–å‡ºæ¥è¿”å›ç»™ Server å±‚ï¼ŒServer åˆ¤æ–­ id ä¸ä¸ºç©ºå°±æŒ‰è¡Œç´¯åŠ \r\n* count(1)ï¼šInnoDB å¼•æ“éå†æ•´å¼ è¡¨ä½†ä¸å–å€¼ï¼ŒServer å±‚å¯¹äºè¿”å›çš„æ¯ä¸€è¡Œï¼Œæ”¾ä¸€ä¸ªæ•°å­— 1 è¿›å»ï¼Œåˆ¤æ–­ä¸ä¸ºç©ºå°±æŒ‰è¡Œç´¯åŠ \r\n* count(å­—æ®µ)ï¼šå¦‚æœè¿™ä¸ªå­—æ®µæ˜¯å®šä¹‰ä¸º not null çš„è¯ï¼Œä¸€è¡Œè¡Œåœ°ä»è®°å½•é‡Œé¢è¯»å‡ºè¿™ä¸ªå­—æ®µï¼Œåˆ¤æ–­ä¸èƒ½ä¸º nullï¼ŒæŒ‰è¡Œç´¯åŠ ï¼›å¦‚æœè¿™ä¸ªå­—æ®µå®šä¹‰å…è®¸ä¸º nullï¼Œé‚£ä¹ˆæ‰§è¡Œçš„æ—¶å€™ï¼Œåˆ¤æ–­åˆ°æœ‰å¯èƒ½æ˜¯ nullï¼Œè¿˜è¦æŠŠå€¼å–å‡ºæ¥å†åˆ¤æ–­ä¸€ä¸‹ï¼Œä¸æ˜¯ null æ‰ç´¯åŠ \r\n* count(*)ï¼šä¸å–å€¼ï¼ŒæŒ‰è¡Œç´¯åŠ \r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/72775\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n## ç¼“å†²ä¼˜åŒ–\r\n\r\n### ä¼˜åŒ–åŸåˆ™\r\n\r\nä¸‰ä¸ªåŸåˆ™ï¼š\r\n\r\n* å°†å°½é‡å¤šçš„å†…å­˜åˆ†é…ç»™ MySQL åšç¼“å­˜ï¼Œä½†ä¹Ÿè¦ç»™æ“ä½œç³»ç»Ÿå’Œå…¶ä»–ç¨‹åºé¢„ç•™è¶³å¤Ÿå†…å­˜\r\n* MyISAM å­˜å‚¨å¼•æ“çš„æ•°æ®æ–‡ä»¶è¯»å–ä¾èµ–äºæ“ä½œç³»ç»Ÿè‡ªèº«çš„ IO ç¼“å­˜ï¼Œå¦‚æœæœ‰ MyISAM è¡¨ï¼Œå°±è¦é¢„ç•™æ›´å¤šçš„å†…å­˜ç»™æ“ä½œç³»ç»Ÿåš IO ç¼“å­˜\r\n* æ’åºåŒºã€è¿æ¥åŒºç­‰ç¼“å­˜æ˜¯åˆ†é…ç»™æ¯ä¸ªæ•°æ®åº“ä¼šè¯ï¼ˆSessionï¼‰ä¸“ç”¨çš„ï¼Œå€¼çš„è®¾ç½®è¦æ ¹æ®æœ€å¤§è¿æ¥æ•°åˆç†åˆ†é…ï¼Œå¦‚æœè®¾ç½®å¤ªå¤§ï¼Œä¸ä½†æµªè´¹èµ„æºï¼Œè€Œä¸”åœ¨å¹¶å‘æ•°è¾ƒé«˜æ—¶ä¼šå¯¼è‡´ç‰©ç†å†…å­˜è€—å°½\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### ç¼“å†²å†…å­˜\r\n\r\nBuffer Pool æœ¬è´¨ä¸Šæ˜¯ InnoDB å‘æ“ä½œç³»ç»Ÿç”³è¯·çš„ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ã€‚InnoDB çš„æ•°æ®æ˜¯æŒ‰æ•°æ®é¡µä¸ºå•ä½æ¥è¯»å†™ï¼Œæ¯ä¸ªæ•°æ®é¡µçš„å¤§å°é»˜è®¤æ˜¯ 16KBã€‚æ•°æ®æ˜¯å­˜æ”¾åœ¨ç£ç›˜ä¸­ï¼Œæ¯æ¬¡è¯»å†™æ•°æ®éƒ½éœ€è¦è¿›è¡Œç£ç›˜ IO å°†æ•°æ®è¯»å…¥å†…å­˜è¿›è¡Œæ“ä½œï¼Œæ•ˆç‡ä¼šå¾ˆä½ï¼Œæ‰€ä»¥æä¾›äº† Buffer Pool æ¥æš‚å­˜è¿™äº›æ•°æ®é¡µï¼Œç¼“å­˜ä¸­çš„è¿™äº›é¡µåˆå«ç¼“å†²é¡µ\r\n\r\nå·¥ä½œåŸç†ï¼š\r\n\r\n* ä»æ•°æ®åº“è¯»å–æ•°æ®æ—¶ï¼Œä¼šé¦–å…ˆä»ç¼“å­˜ä¸­è¯»å–ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™ä»ç£ç›˜è¯»å–åæ”¾å…¥ Buffer Pool\r\n* å‘æ•°æ®åº“å†™å…¥æ•°æ®æ—¶ï¼Œä¼šå†™å…¥ç¼“å­˜ï¼Œç¼“å­˜ä¸­ä¿®æ”¹çš„æ•°æ®ä¼š**å®šæœŸåˆ·æ–°**åˆ°ç£ç›˜ï¼Œè¿™ä¸€è¿‡ç¨‹ç§°ä¸ºåˆ·è„\r\n\r\nBuffer Pool ä¸­æ¯ä¸ªç¼“å†²é¡µéƒ½æœ‰å¯¹åº”çš„æ§åˆ¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨ç©ºé—´ç¼–å·ã€é¡µå·ã€åç§»é‡ã€é“¾è¡¨ä¿¡æ¯ç­‰ï¼Œæ§åˆ¶ä¿¡æ¯å­˜æ”¾åœ¨å ç”¨çš„å†…å­˜ç§°ä¸ºæ§åˆ¶å—ï¼Œæ§åˆ¶å—ä¸ç¼“å†²é¡µæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œä½†å¹¶ä¸æ˜¯ç‰©ç†ä¸Šç›¸è¿çš„ï¼Œéƒ½åœ¨ç¼“å†²æ± ä¸­\r\n\r\nMySQL æä¾›äº†ç¼“å†²é¡µçš„å¿«é€ŸæŸ¥æ‰¾æ–¹å¼ï¼š**å“ˆå¸Œè¡¨**ï¼Œä½¿ç”¨è¡¨ç©ºé—´å·å’Œé¡µå·ä½œä¸º Keyï¼Œç¼“å†²é¡µæ§åˆ¶å—çš„åœ°å€ä½œä¸º Value åˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œè·å–æ•°æ®é¡µæ—¶æ ¹æ® Key è¿›è¡Œå“ˆå¸Œå¯»å€ï¼š\r\n\r\n* å¦‚æœä¸å­˜åœ¨å¯¹åº”çš„ç¼“å­˜é¡µï¼Œå°±ä» free é“¾è¡¨ä¸­é€‰ä¸€ä¸ªç©ºé—²ç¼“å†²é¡µï¼ŒæŠŠç£ç›˜ä¸­çš„å¯¹åº”é¡µåŠ è½½åˆ°è¯¥ä½ç½®\r\n* å¦‚æœå­˜åœ¨å¯¹åº”çš„ç¼“å­˜é¡µï¼Œç›´æ¥è·å–ä½¿ç”¨ï¼Œæé«˜æŸ¥è¯¢æ•°æ®çš„æ•ˆç‡\r\n\r\nå½“å†…å­˜æ•°æ®é¡µè·Ÿç£ç›˜æ•°æ®é¡µå†…å®¹ä¸ä¸€è‡´æ—¶ï¼Œç§°è¿™ä¸ªå†…å­˜é¡µä¸ºè„é¡µï¼›å†…å­˜æ•°æ®å†™å…¥ç£ç›˜åï¼Œå†…å­˜å’Œç£ç›˜ä¸Šçš„æ•°æ®é¡µä¸€è‡´ï¼Œç§°ä¸ºå¹²å‡€é¡µ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å†…å­˜ç®¡ç†\r\n\r\n#### Free é“¾è¡¨\r\n\r\nMySQL å¯åŠ¨æ—¶å®Œæˆå¯¹ Buffer Pool çš„åˆå§‹åŒ–ï¼Œå…ˆå‘æ“ä½œç³»ç»Ÿç”³è¯·è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œç„¶åå°†å†…å­˜åˆ’åˆ†ä¸ºè‹¥å¹²å¯¹æ§åˆ¶å—å’Œç¼“å†²é¡µã€‚ä¸ºäº†åŒºåˆ†ç©ºé—²å’Œå·²å ç”¨çš„æ•°æ®é¡µï¼Œå°†æ‰€æœ‰ç©ºé—²ç¼“å†²é¡µå¯¹åº”çš„**æ§åˆ¶å—ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹**æ”¾å…¥ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œå°±æ˜¯ Free é“¾è¡¨ï¼ˆ**ç©ºé—²é“¾è¡¨**ï¼‰\r\n\r\n![image-20250320010821319](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010821319.png)\r\n\r\nåŸºèŠ‚ç‚¹ï¼šæ˜¯ä¸€å—å•ç‹¬ç”³è¯·çš„å†…å­˜ç©ºé—´ï¼ˆå  40 å­—èŠ‚ï¼‰ï¼Œå¹¶ä¸åœ¨ Buffer Pool çš„é‚£ä¸€å¤§ç‰‡è¿ç»­å†…å­˜ç©ºé—´é‡Œ\r\n\r\nç£ç›˜åŠ è½½é¡µçš„æµç¨‹ï¼š\r\n\r\n* ä» Free é“¾è¡¨ä¸­å–å‡ºä¸€ä¸ªç©ºé—²çš„ç¼“å†²é¡µ\r\n* æŠŠç¼“å†²é¡µå¯¹åº”çš„æ§åˆ¶å—çš„ä¿¡æ¯å¡«ä¸Šï¼ˆé¡µæ‰€åœ¨çš„è¡¨ç©ºé—´ã€é¡µå·ä¹‹ç±»çš„ä¿¡æ¯ï¼‰\r\n* æŠŠç¼“å†²é¡µå¯¹åº”çš„ Free é“¾è¡¨èŠ‚ç‚¹ï¼ˆæ§åˆ¶å—ï¼‰ä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œè¡¨ç¤ºè¯¥ç¼“å†²é¡µå·²ç»è¢«ä½¿ç”¨\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/li1325169021/article/details/121124440\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### Flush é“¾è¡¨\r\n\r\nFlush é“¾è¡¨æ˜¯ä¸€ä¸ªç”¨æ¥**å­˜å‚¨è„é¡µ**çš„é“¾è¡¨ï¼Œå¯¹äºå·²ç»ä¿®æ”¹è¿‡çš„ç¼“å†²è„é¡µï¼Œç¬¬ä¸€æ¬¡ä¿®æ”¹ååŠ å…¥åˆ°**é“¾è¡¨å¤´éƒ¨**ï¼Œä»¥åæ¯æ¬¡ä¿®æ”¹éƒ½ä¸ä¼šé‡æ–°åŠ å…¥ï¼Œåªä¿®æ”¹éƒ¨åˆ†æ§åˆ¶ä¿¡æ¯ï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘å¹¶ä¸æ˜¯ç›´æ¥æ›´æ–°åˆ°ç£ç›˜ï¼Œè€Œæ˜¯åœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´è¿›è¡Œåˆ·è„\r\n\r\n![image-20250320010834310](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320010834310.png)\r\n\r\n**åå°æœ‰ä¸“é—¨çš„çº¿ç¨‹æ¯éš”ä¸€æ®µæ—¶é—´æŠŠè„é¡µåˆ·æ–°åˆ°ç£ç›˜**ï¼š\r\n\r\n* ä» Flush é“¾è¡¨ä¸­åˆ·æ–°ä¸€éƒ¨åˆ†é¡µé¢åˆ°ç£ç›˜ï¼š\r\n  * **åå°çº¿ç¨‹å®šæ—¶**ä» Flush é“¾è¡¨åˆ·è„ï¼Œæ ¹æ®ç³»ç»Ÿçš„ç¹å¿™ç¨‹åº¦æ¥å†³å®šåˆ·æ–°é€Ÿç‡ï¼Œè¿™ç§æ–¹å¼ç§°ä¸º BUF_FLUSH_LIST\r\n  * çº¿ç¨‹åˆ·è„çš„æ¯”è¾ƒæ…¢ï¼Œå¯¼è‡´ç”¨æˆ·çº¿ç¨‹åŠ è½½ä¸€ä¸ªæ–°çš„æ•°æ®é¡µæ—¶å‘ç°æ²¡æœ‰ç©ºé—²ç¼“å†²é¡µï¼Œæ­¤æ—¶ä¼šå°è¯•ä» LRU é“¾è¡¨å°¾éƒ¨å¯»æ‰¾ç¼“å†²é¡µç›´æ¥é‡Šæ”¾ï¼Œå¦‚æœè¯¥é¡µé¢æ˜¯å·²ç»ä¿®æ”¹è¿‡çš„è„é¡µå°±**åŒæ­¥åˆ·æ–°**åˆ°ç£ç›˜ï¼Œé€Ÿåº¦è¾ƒæ…¢ï¼Œè¿™ç§æ–¹å¼ç§°ä¸º BUF_FLUSH_SINGLE_PAGE\r\n* ä» LRU é“¾è¡¨çš„å†·æ•°æ®ä¸­åˆ·æ–°ä¸€éƒ¨åˆ†é¡µé¢åˆ°ç£ç›˜ï¼Œå³ï¼šBUF_FLUSH_LRU\r\n  * åå°çº¿ç¨‹ä¼šå®šæ—¶ä» LRU é“¾è¡¨çš„å°¾éƒ¨å¼€å§‹æ‰«æä¸€äº›é¡µé¢ï¼Œæ‰«æçš„é¡µé¢æ•°é‡å¯ä»¥é€šè¿‡ç³»ç»Ÿå˜é‡ `innodb_lru_scan_depth` æŒ‡å®šï¼Œå¦‚æœåœ¨ LRU é“¾è¡¨ä¸­å‘ç°è„é¡µï¼Œåˆ™æŠŠå®ƒä»¬åˆ·æ–°åˆ°ç£ç›˜ï¼Œè¿™ç§æ–¹å¼ç§°ä¸º BUF_FLUSH_LRU\r\n  * æ§åˆ¶å—é‡Œä¼šå­˜å‚¨è¯¥ç¼“å†²é¡µæ˜¯å¦è¢«ä¿®æ”¹çš„ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆå®¹æ˜“çš„è·å–åˆ°æŸä¸ªç¼“å†²é¡µæ˜¯å¦æ˜¯è„é¡µ\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/li1325169021/article/details/121125765\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### LRU é“¾è¡¨\r\n\r\nBuffer Pool éœ€è¦ä¿è¯ç¼“å­˜çš„å‘½ä¸­ç‡ï¼Œæ‰€ä»¥ MySQL åˆ›å»ºäº†ä¸€ä¸ª LRU é“¾è¡¨ï¼Œå½“è®¿é—®æŸä¸ªé¡µæ—¶ï¼š\r\n\r\n* å¦‚æœè¯¥é¡µä¸åœ¨ Buffer Pool ä¸­ï¼ŒæŠŠè¯¥é¡µä»ç£ç›˜åŠ è½½è¿›æ¥åä¼šå°†è¯¥ç¼“å†²é¡µå¯¹åº”çš„æ§åˆ¶å—ä½œä¸ºèŠ‚ç‚¹æ”¾å…¥ **LRU é“¾è¡¨çš„å¤´éƒ¨**ï¼Œä¿è¯çƒ­ç‚¹æ•°æ®åœ¨é“¾è¡¨å¤´\r\n* å¦‚æœè¯¥é¡µåœ¨ Buffer Pool ä¸­ï¼Œåˆ™ç›´æ¥æŠŠè¯¥é¡µå¯¹åº”çš„æ§åˆ¶å—ç§»åŠ¨åˆ° LRU é“¾è¡¨çš„å¤´éƒ¨ï¼Œæ‰€ä»¥ LRU é“¾è¡¨å°¾éƒ¨å°±æ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å†²é¡µ\r\n\r\nMySQL åŸºäºå±€éƒ¨æ€§åŸç†æä¾›äº†é¢„è¯»åŠŸèƒ½ï¼š\r\n\r\n* çº¿æ€§é¢„è¯»ï¼šç³»ç»Ÿå˜é‡ `innodb_read_ahead_threshold`ï¼Œå¦‚æœé¡ºåºè®¿é—®æŸä¸ªåŒºï¼ˆextentï¼š16 KB çš„é¡µï¼Œè¿ç»­ 64 ä¸ªå½¢æˆä¸€ä¸ªåŒºï¼Œä¸€ä¸ªåŒºé»˜è®¤ 1MB å¤§å°ï¼‰çš„é¡µé¢æ•°è¶…è¿‡äº†è¯¥ç³»ç»Ÿå˜é‡å€¼ï¼Œå°±ä¼šè§¦å‘ä¸€æ¬¡**å¼‚æ­¥è¯»å–**ä¸‹ä¸€ä¸ªåŒºä¸­å…¨éƒ¨çš„é¡µé¢åˆ° Buffer Pool ä¸­\r\n* éšæœºé¢„è¯»ï¼šå¦‚æœæŸä¸ªåŒº 13 ä¸ªè¿ç»­çš„é¡µé¢éƒ½è¢«åŠ è½½åˆ° Buffer Poolï¼Œæ— è®ºè¿™äº›é¡µé¢æ˜¯å¦æ˜¯é¡ºåºè¯»å–ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡**å¼‚æ­¥è¯»å–**æœ¬åŒºæ‰€æœ‰çš„å…¶ä»–é¡µé¢åˆ° Buffer Pool ä¸­\r\n\r\né¢„è¯»ä¼šé€ æˆåŠ è½½å¤ªå¤šç”¨ä¸åˆ°çš„æ•°æ®é¡µï¼Œé€ æˆé‚£äº›ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„æ•°æ®é¡µè¢«æŒ¤åˆ° LRU é“¾è¡¨å°¾éƒ¨ï¼Œæ‰€ä»¥ InnoDB å°† LRU é“¾è¡¨åˆ†æˆä¸¤æ®µï¼Œ**å†·çƒ­æ•°æ®éš”ç¦»**ï¼š\r\n\r\n* ä¸€éƒ¨åˆ†å­˜å‚¨ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„æ•°æ®é¡µï¼Œè¿™éƒ¨åˆ†é“¾è¡¨ä¹Ÿå«çƒ­æ•°æ®ï¼Œyoung åŒºï¼Œé è¿‘é“¾è¡¨å¤´éƒ¨çš„åŒºåŸŸ\r\n* ä¸€éƒ¨åˆ†å­˜å‚¨ä½¿ç”¨é¢‘ç‡ä¸é«˜çš„å†·æ•°æ®ï¼Œold åŒºï¼Œé è¿‘é“¾è¡¨å°¾éƒ¨ï¼Œé»˜è®¤å  37%ï¼Œå¯ä»¥é€šè¿‡ç³»ç»Ÿå˜é‡ `innodb_old_blocks_pct` æŒ‡å®š\r\n\r\nå½“ç£ç›˜ä¸Šçš„æŸæ•°æ®é¡µè¢«åˆæ¬¡åŠ è½½åˆ° Buffer Pool ä¸­ä¼šè¢«æ”¾å…¥ old åŒºï¼Œæ·˜æ±°æ—¶ä¼˜å…ˆæ·˜æ±° old åŒº\r\n\r\n* å½“å¯¹ old åŒºçš„æ•°æ®è¿›è¡Œè®¿é—®æ—¶ï¼Œä¼šåœ¨æ§åˆ¶å—è®°å½•ä¸‹è®¿é—®æ—¶é—´ï¼Œç­‰å¾…åç»­çš„è®¿é—®æ—¶é—´ä¸ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶é—´æ˜¯å¦åœ¨æŸä¸ªæ—¶é—´é—´éš”å†…ï¼Œé€šè¿‡ç³»ç»Ÿå˜é‡ `innodb_old_blocks_time` æŒ‡å®šæ—¶é—´é—´éš”ï¼Œé»˜è®¤ 1000msï¼Œæˆç«‹å°±**ç§»åŠ¨åˆ° young åŒºçš„é“¾è¡¨å¤´éƒ¨**\r\n* `innodb_old_blocks_time` ä¸º 0 æ—¶ï¼Œæ¯æ¬¡è®¿é—®ä¸€ä¸ªé¡µé¢éƒ½ä¼šæ”¾å…¥ young åŒºçš„å¤´éƒ¨\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å‚æ•°ä¼˜åŒ–\r\n\r\nInnoDB ç”¨ä¸€å—å†…å­˜åŒºåš IO ç¼“å­˜æ± ï¼Œè¯¥ç¼“å­˜æ± ä¸ä»…ç”¨æ¥ç¼“å­˜ InnoDB çš„ç´¢å¼•å—ï¼Œä¹Ÿç”¨æ¥ç¼“å­˜ InnoDB çš„æ•°æ®å—ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æŒ‡ä»¤æŸ¥çœ‹ Buffer Pool çš„çŠ¶æ€ä¿¡æ¯ï¼š\r\n\r\n```sql\r\nSHOW ENGINE INNODB STATUS\\G\r\n```\r\n\r\n`Buffer pool hit rate` å­—æ®µä»£è¡¨**å†…å­˜å‘½ä¸­ç‡**ï¼Œè¡¨ç¤º Buffer Pool å¯¹æŸ¥è¯¢çš„åŠ é€Ÿæ•ˆæœ\r\n\r\næ ¸å¿ƒå‚æ•°ï¼š\r\n\r\n* `innodb_buffer_pool_size`ï¼šè¯¥å˜é‡å†³å®šäº† Innodb å­˜å‚¨å¼•æ“è¡¨æ•°æ®å’Œç´¢å¼•æ•°æ®çš„æœ€å¤§ç¼“å­˜åŒºå¤§å°ï¼Œé»˜è®¤ 128M\r\n\r\n  ```sql\r\n  SHOW VARIABLES LIKE 'innodb_buffer_pool_size';\r\n  ```\r\n\r\n  åœ¨ä¿è¯æ“ä½œç³»ç»ŸåŠå…¶ä»–ç¨‹åºæœ‰è¶³å¤Ÿå†…å­˜å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œ`innodb_buffer_pool_size` çš„å€¼è¶Šå¤§ï¼Œç¼“å­˜å‘½ä¸­ç‡è¶Šé«˜ï¼Œå»ºè®®è®¾ç½®æˆå¯ç”¨ç‰©ç†å†…å­˜çš„ 60%~80%\r\n\r\n  ```sh\r\n  innodb_buffer_pool_size=512M\r\n  ```\r\n\r\n* `innodb_log_buffer_size`ï¼šè¯¥å€¼å†³å®šäº† Innodb æ—¥å¿—ç¼“å†²åŒºçš„å¤§å°ï¼Œä¿å­˜è¦å†™å…¥ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶æ•°æ®\r\n\r\n  å¯¹äºå¯èƒ½äº§ç”Ÿå¤§é‡æ›´æ–°è®°å½•çš„å¤§äº‹åŠ¡ï¼Œå¢åŠ è¯¥å€¼çš„å¤§å°ï¼Œå¯ä»¥é¿å… Innodb åœ¨äº‹åŠ¡æäº¤å‰å°±æ‰§è¡Œä¸å¿…è¦çš„æ—¥å¿—å†™å…¥ç£ç›˜æ“ä½œï¼Œå½±å“æ‰§è¡Œæ•ˆç‡ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹ï¼š\r\n\r\n  ```sh\r\n  innodb_log_buffer_size=10M\r\n  ```\r\n\r\nåœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œè®¿é—® Buffer Pool ä¸­çš„å„ç§é“¾è¡¨éƒ½éœ€è¦åŠ é”ï¼Œæ‰€ä»¥å°† Buffer Pool æ‹†æˆè‹¥å¹²ä¸ªå°å®ä¾‹ï¼Œ**æ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªå®ä¾‹**ï¼Œç‹¬ç«‹ç®¡ç†å†…å­˜ç©ºé—´å’Œå„ç§é“¾è¡¨ï¼ˆç±»ä¼¼ ThreadLocalï¼‰ï¼Œå¤šçº¿ç¨‹è®¿é—®å„è‡ªå®ä¾‹äº’ä¸å½±å“ï¼Œæé«˜äº†å¹¶å‘èƒ½åŠ›\r\n\r\nMySQL 5.7.5 ä¹‹å‰ `innodb_buffer_pool_size` åªæ”¯æŒåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ä¿®æ”¹ï¼Œç°åœ¨å·²ç»æ”¯æŒè¿è¡Œæ—¶ä¿®æ”¹ Buffer Pool çš„å¤§å°ï¼Œä½†æ˜¯æ¯æ¬¡è°ƒæ•´å‚æ•°éƒ½ä¼šé‡æ–°å‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œ**å°†æ—§çš„ç¼“å†²æ± çš„å†…å®¹æ‹·è´åˆ°æ–°ç©ºé—´**éå¸¸è€—æ—¶ï¼Œæ‰€ä»¥ MySQL å¼€å§‹ä»¥ä¸€ä¸ª chunk ä¸ºå•ä½å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œæ‰€ä»¥ä¸€ä¸ª Buffer Pool å®ä¾‹å¯ä»¥ç”±å¤šä¸ª chunk ç»„æˆ\r\n\r\n* åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è®¾ç½®ç³»ç»Ÿå˜é‡ `innodb_buffer_pool_instance` å¯ä»¥æŒ‡å®š Buffer Pool å®ä¾‹çš„ä¸ªæ•°ï¼Œä½†æ˜¯å½“ Buffer Pool å°äº 1GB æ—¶ï¼Œè®¾ç½®å¤šä¸ªå®ä¾‹æ—¶æ— æ•ˆçš„\r\n* æŒ‡å®šç³»ç»Ÿå˜é‡ `innodb_buffer_pool_chunk_size` æ¥æ”¹å˜ chunk çš„å¤§å°ï¼Œåªèƒ½åœ¨å¯åŠ¨æ—¶ä¿®æ”¹ï¼Œè¿è¡Œä¸­ä¸èƒ½ä¿®æ”¹ï¼Œè€Œä¸”è¯¥å˜é‡å¹¶ä¸åŒ…å«ç¼“å†²é¡µçš„æ§åˆ¶å—çš„å†…å­˜å¤§å°\r\n* `innodb_buffer_pool_size` å¿…é¡»æ˜¯ `innodb_buffer_pool_chunk_size Ã— innodb_buffer_pool_instance` çš„å€æ•°ï¼Œé»˜è®¤å€¼æ˜¯ `128M Ã— 16 = 2G`ï¼ŒBuffer Pool å¿…é¡»æ˜¯ 2G çš„æ•´æ•°å€ï¼Œå¦‚æœæŒ‡å®š 5Gï¼Œä¼šè‡ªåŠ¨è°ƒæ•´æˆ 6G\r\n* å¦‚æœå¯åŠ¨æ—¶ `chunk Ã— instances` > `pool_size`ï¼Œé‚£ä¹ˆ chunk çš„å€¼ä¼šè‡ªåŠ¨è®¾ç½®ä¸º `pool_size Ã· instances`\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n## å†…å­˜ä¼˜åŒ–\r\n\r\n### Change\r\n\r\nInnoDB ç®¡ç†çš„ Buffer Pool ä¸­æœ‰ä¸€å—å†…å­˜å« Change Buffer ç”¨æ¥å¯¹**å¢åˆ æ”¹æ“ä½œ**æä¾›ç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡å‚æ•°æ¥åŠ¨æ€è®¾ç½®ï¼Œè®¾ç½®ä¸º 50 æ—¶è¡¨ç¤º Change Buffer çš„å¤§å°æœ€å¤šå ç”¨ Buffer Pool çš„ 50%\r\n\r\n* å”¯ä¸€ç´¢å¼•çš„æ›´æ–°ä¸èƒ½ä½¿ç”¨ Change Bufferï¼Œéœ€è¦å°†æ•°æ®é¡µè¯»å…¥å†…å­˜ï¼Œåˆ¤æ–­æ²¡æœ‰å†²çªåœ¨å†™å…¥\r\n* æ™®é€šç´¢å¼•å¯ä»¥ä½¿ç”¨ Change Bufferï¼Œ**ç›´æ¥å†™å…¥ Buffer å°±ç»“æŸ**ï¼Œä¸ç”¨æ ¡éªŒå”¯ä¸€æ€§\r\n\r\nChange Buffer å¹¶ä¸æ˜¯æ•°æ®é¡µï¼Œåªæ˜¯å¯¹æ“ä½œçš„ç¼“å­˜ï¼Œæ‰€ä»¥éœ€è¦å°† Change Buffer ä¸­çš„æ“ä½œåº”ç”¨åˆ°æ—§æ•°æ®é¡µï¼Œå¾—åˆ°æ–°çš„æ•°æ®é¡µï¼ˆè„é¡µï¼‰çš„è¿‡ç¨‹ç§°ä¸º Merge\r\n\r\n* è§¦å‘æ—¶æœºï¼šè®¿é—®æ•°æ®é¡µæ—¶ä¼šè§¦å‘ Mergeã€åå°æœ‰å®šæ—¶çº¿ç¨‹è¿›è¡Œ Mergeã€åœ¨æ•°æ®åº“æ­£å¸¸å…³é—­ï¼ˆshutdownï¼‰çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šè§¦å‘\r\n* å·¥ä½œæµç¨‹ï¼šé¦–å…ˆä»ç£ç›˜è¯»å…¥æ•°æ®é¡µåˆ°å†…å­˜ï¼ˆå› ä¸º Buffer Pool ä¸­ä¸ä¸€å®šå­˜åœ¨å¯¹åº”çš„æ•°æ®é¡µï¼‰ï¼Œä» Change Buffer ä¸­æ‰¾åˆ°å¯¹åº”çš„æ“ä½œåº”ç”¨åˆ°æ•°æ®é¡µï¼Œå¾—åˆ°æ–°çš„æ•°æ®é¡µå³ä¸ºè„é¡µï¼Œç„¶åå†™å…¥ redo logï¼Œç­‰å¾…åˆ·è„å³å¯\r\n\r\nè¯´æ˜ï¼šChange Buffer ä¸­çš„è®°å½•ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶ä¹Ÿä¼šå†™å…¥ redo logï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ä¿è¯ä¸ä¸¢å¤±çš„\r\n\r\nä¸šåŠ¡åœºæ™¯ï¼š\r\n\r\n* å¯¹äº**å†™å¤šè¯»å°‘**çš„ä¸šåŠ¡æ¥è¯´ï¼Œé¡µé¢åœ¨å†™å®Œä»¥åé©¬ä¸Šè¢«è®¿é—®åˆ°çš„æ¦‚ç‡æ¯”è¾ƒå°ï¼Œæ­¤æ—¶ Change Buffer çš„ä½¿ç”¨æ•ˆæœæœ€å¥½ï¼Œå¸¸è§çš„å°±æ˜¯è´¦å•ç±»ã€æ—¥å¿—ç±»çš„ç³»ç»Ÿ\r\n\r\n* ä¸€ä¸ªä¸šåŠ¡çš„æ›´æ–°æ¨¡å¼æ˜¯å†™å…¥åé©¬ä¸ŠåšæŸ¥è¯¢ï¼Œé‚£ä¹ˆå³ä½¿æ»¡è¶³äº†æ¡ä»¶ï¼Œå°†æ›´æ–°å…ˆè®°å½•åœ¨ Change Bufferï¼Œä½†ä¹‹åç”±äºé©¬ä¸Šè¦è®¿é—®è¿™ä¸ªæ•°æ®é¡µï¼Œä¼šç«‹å³è§¦å‘ Merge è¿‡ç¨‹ï¼Œè¿™æ ·éšæœºè®¿é—® IO çš„æ¬¡æ•°ä¸ä¼šå‡å°‘ï¼Œå¹¶ä¸”å¢åŠ äº† Change Buffer çš„ç»´æŠ¤ä»£ä»·\r\n\r\nè¡¥å……ï¼šChange Buffer çš„å‰èº«æ˜¯ Insert Bufferï¼Œåªèƒ½å¯¹ Insert æ“ä½œä¼˜åŒ–ï¼Œåæ¥å¢åŠ äº† Update/Delete çš„æ”¯æŒï¼Œæ”¹ä¸º Change Buffer\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### Net\r\n\r\nServer å±‚é’ˆå¯¹ä¼˜åŒ–**æŸ¥è¯¢**çš„å†…å­˜ä¸º Net Bufferï¼Œå†…å­˜çš„å¤§å°æ˜¯ç”±å‚æ•° `net_buffer_length`å®šä¹‰ï¼Œé»˜è®¤ 16kï¼Œå®ç°æµç¨‹ï¼š\r\n\r\n* è·å–ä¸€è¡Œæ•°æ®å†™å…¥ Net Bufferï¼Œé‡å¤è·å–ç›´åˆ° Net Buffer å†™æ»¡ï¼Œè°ƒç”¨ç½‘ç»œæ¥å£å‘å‡ºå»\r\n* è‹¥å‘é€æˆåŠŸå°±æ¸…ç©º Net Bufferï¼Œç„¶åç»§ç»­å–ä¸‹ä¸€è¡Œï¼›è‹¥å‘é€å‡½æ•°è¿”å› EAGAIN æˆ– WSAEWOULDBLOCKï¼Œè¡¨ç¤ºæœ¬åœ°ç½‘ç»œæ ˆ `socket send buffer` å†™æ»¡äº†ï¼Œ**è¿›å…¥ç­‰å¾…**ï¼Œç›´åˆ°ç½‘ç»œæ ˆé‡æ–°å¯å†™å†ç»§ç»­å‘é€\r\n\r\nMySQL é‡‡ç”¨çš„æ˜¯è¾¹è¯»è¾¹å‘çš„é€»è¾‘ï¼Œå› æ­¤å¯¹äºæ•°æ®é‡å¾ˆå¤§çš„æŸ¥è¯¢æ¥è¯´ï¼Œä¸ä¼šåœ¨ Server ç«¯ä¿å­˜å®Œæ•´çš„ç»“æœé›†ï¼Œå¦‚æœå®¢æˆ·ç«¯è¯»ç»“æœä¸åŠæ—¶ï¼Œä¼šå µä½ MySQL çš„æŸ¥è¯¢è¿‡ç¨‹ï¼Œä½†æ˜¯**ä¸ä¼šæŠŠå†…å­˜æ‰“çˆ†å¯¼è‡´ OOM**\r\n\r\n![image-20250320011014398](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011014398.png)\r\n\r\nSHOW PROCESSLIST è·å–çº¿ç¨‹ä¿¡æ¯åï¼Œå¤„äº Sending to client çŠ¶æ€ä»£è¡¨æœåŠ¡å™¨ç«¯çš„ç½‘ç»œæ ˆå†™æ»¡ï¼Œç­‰å¾…å®¢æˆ·ç«¯æ¥æ”¶æ•°æ®\r\n\r\nå‡è®¾æœ‰ä¸€ä¸ªä¸šåŠ¡çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæ¯è¯»ä¸€è¡Œæ•°æ®ä»¥åè¦å¤„ç†å¾ˆä¹…çš„é€»è¾‘ï¼Œå°±ä¼šå¯¼è‡´å®¢æˆ·ç«¯è¦è¿‡å¾ˆä¹…æ‰ä¼šå»å–ä¸‹ä¸€è¡Œæ•°æ®ï¼Œå¯¼è‡´ MySQL çš„é˜»å¡ï¼Œä¸€ç›´å¤„äº Sending to client çš„çŠ¶æ€\r\n\r\nè§£å†³æ–¹æ³•ï¼šå¦‚æœä¸€ä¸ªæŸ¥è¯¢çš„è¿”å›ç»“æœå¾ˆæ˜¯å¾ˆå¤šï¼Œå»ºè®®ä½¿ç”¨ mysql_store_result è¿™ä¸ªæ¥å£ï¼Œç›´æ¥æŠŠæŸ¥è¯¢ç»“æœä¿å­˜åˆ°æœ¬åœ°å†…å­˜\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/qq_33589510/article/details/117673449\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### Read\r\n\r\nread_rnd_buffer æ˜¯ MySQL çš„éšæœºè¯»ç¼“å†²åŒºï¼Œå½“æŒ‰ä»»æ„é¡ºåºè¯»å–è®°å½•è¡Œæ—¶å°†åˆ†é…ä¸€ä¸ªéšæœºè¯»å–ç¼“å†²åŒºï¼Œè¿›è¡Œæ’åºæŸ¥è¯¢æ—¶ï¼ŒMySQL ä¼šé¦–å…ˆæ‰«æä¸€éè¯¥ç¼“å†²ï¼Œä»¥é¿å…ç£ç›˜æœç´¢ï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œå¤§å°æ˜¯ç”± read_rnd_buffer_size å‚æ•°æ§åˆ¶çš„\r\n\r\nMulti-Range Read ä¼˜åŒ–ï¼Œ**å°†éšæœº IO è½¬åŒ–ä¸ºé¡ºåº IO** ä»¥é™ä½æŸ¥è¯¢è¿‡ç¨‹ä¸­ IO å¼€é”€ï¼Œå› ä¸ºå¤§å¤šæ•°çš„æ•°æ®éƒ½æ˜¯æŒ‰ç…§ä¸»é”®é€’å¢é¡ºåºæ’å…¥å¾—åˆ°ï¼Œæ‰€ä»¥æŒ‰ç…§ä¸»é”®çš„é€’å¢é¡ºåºæŸ¥è¯¢çš„è¯ï¼Œå¯¹ç£ç›˜çš„è¯»æ¯”è¾ƒæ¥è¿‘é¡ºåºè¯»ï¼Œèƒ½å¤Ÿæå‡è¯»æ€§èƒ½\r\n\r\näºŒçº§ç´¢å¼•ä¸º aï¼Œèšç°‡ç´¢å¼•ä¸º idï¼Œä¼˜åŒ–å›è¡¨æµç¨‹ï¼š\r\n\r\n* æ ¹æ®ç´¢å¼• aï¼Œå®šä½åˆ°æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå°† id å€¼æ”¾å…¥ read_rnd_buffer ä¸­\r\n* å°† read_rnd_buffer ä¸­çš„ id è¿›è¡Œ**é€’å¢æ’åº**\r\n* æ’åºåçš„ id æ•°ç»„ï¼Œä¾æ¬¡å›è¡¨åˆ°ä¸»é”® id ç´¢å¼•ä¸­æŸ¥è®°å½•ï¼Œå¹¶ä½œä¸ºç»“æœè¿”å›\r\n\r\nè¯´æ˜ï¼šå¦‚æœæ­¥éª¤ 1 ä¸­ read_rnd_buffer æ”¾æ»¡äº†ï¼Œå°±ä¼šå…ˆæ‰§è¡Œæ­¥éª¤ 2 å’Œ 3ï¼Œç„¶åæ¸…ç©º read_rnd_bufferï¼Œä¹‹åç»§ç»­æ‰¾ç´¢å¼• a çš„ä¸‹ä¸ªè®°å½•\r\n\r\nä½¿ç”¨ MRR ä¼˜åŒ–éœ€è¦è®¾è¿›è¡Œè®¾ç½®ï¼š\r\n\r\n```sql\r\nSET optimizer_switch='mrr_cost_based=off'\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### Key\r\n\r\nMyISAM å­˜å‚¨å¼•æ“ä½¿ç”¨ key_buffer ç¼“å­˜ç´¢å¼•å—ï¼ŒåŠ é€Ÿ MyISAM ç´¢å¼•çš„è¯»å†™é€Ÿåº¦ã€‚å¯¹äº MyISAM è¡¨çš„æ•°æ®å—æ²¡æœ‰ç‰¹åˆ«çš„ç¼“å­˜æœºåˆ¶ï¼Œå®Œå…¨ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ IO ç¼“å­˜\r\n\r\n* key_buffer_sizeï¼šè¯¥å˜é‡å†³å®š MyISAM ç´¢å¼•å—ç¼“å­˜åŒºçš„å¤§å°ï¼Œç›´æ¥å½±å“åˆ° MyISAM è¡¨çš„å­˜å–æ•ˆç‡\r\n\r\n  ```sql\r\n  SHOW VARIABLES LIKE 'key_buffer_size';\t-- å•ä½æ˜¯å­—èŠ‚\r\n  ```\r\n\r\n  åœ¨ MySQL é…ç½®æ–‡ä»¶ä¸­è®¾ç½®è¯¥å€¼ï¼Œå»ºè®®è‡³å°‘å°†1/4å¯ç”¨å†…å­˜åˆ†é…ç»™ key_buffer_sizeï¼š\r\n\r\n  ```sh\r\n  vim /etc/mysql/my.cnf\r\n  key_buffer_size=1024M\r\n  ```\r\n\r\n* read_buffer_sizeï¼šå¦‚æœéœ€è¦ç»å¸¸é¡ºåºæ‰«æ MyISAM è¡¨ï¼Œå¯ä»¥é€šè¿‡å¢å¤§ read_buffer_size çš„å€¼æ¥æ”¹å–„æ€§èƒ½ã€‚ä½† read_buffer_size æ˜¯æ¯ä¸ª Session ç‹¬å çš„ï¼Œå¦‚æœé»˜è®¤å€¼è®¾ç½®å¤ªå¤§ï¼Œå¹¶å‘ç¯å¢ƒå°±ä¼šé€ æˆå†…å­˜æµªè´¹\r\n\r\n* read_rnd_buffer_sizeï¼šå¯¹äºéœ€è¦åšæ’åºçš„ MyISAM è¡¨çš„æŸ¥è¯¢ï¼Œå¦‚å¸¦æœ‰ ORDER BY å­å¥çš„è¯­å¥ï¼Œé€‚å½“å¢åŠ è¯¥çš„å€¼ï¼Œå¯ä»¥æ”¹å–„æ­¤ç±»çš„ SQL çš„æ€§èƒ½ï¼Œä½†æ˜¯ read_rnd_buffer_size æ˜¯æ¯ä¸ª Session ç‹¬å çš„ï¼Œå¦‚æœé»˜è®¤å€¼è®¾ç½®å¤ªå¤§ï¼Œå°±ä¼šé€ æˆå†…å­˜æµªè´¹\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n\r\n\r\n## å­˜å‚¨ä¼˜åŒ–\r\n\r\n### æ•°æ®å­˜å‚¨\r\n\r\nç³»ç»Ÿè¡¨ç©ºé—´æ˜¯ç”¨æ¥æ”¾ç³»ç»Ÿä¿¡æ¯çš„ï¼Œæ¯”å¦‚æ•°æ®å­—å…¸ä»€ä¹ˆçš„ï¼Œå¯¹åº”çš„ç£ç›˜æ–‡ä»¶æ˜¯ ibdataï¼Œæ•°æ®è¡¨ç©ºé—´æ˜¯ä¸€ä¸ªä¸ªçš„è¡¨æ•°æ®æ–‡ä»¶ï¼Œå¯¹åº”çš„ç£ç›˜æ–‡ä»¶å°±æ˜¯è¡¨å.ibd\r\n\r\nè¡¨æ•°æ®æ—¢å¯ä»¥å­˜åœ¨å…±äº«è¡¨ç©ºé—´é‡Œï¼Œä¹Ÿå¯ä»¥æ˜¯å•ç‹¬çš„æ–‡ä»¶ï¼Œè¿™ä¸ªè¡Œä¸ºæ˜¯ç”±å‚æ•° innodb_file_per_table æ§åˆ¶çš„ï¼š\r\n\r\n* OFFï¼šè¡¨ç¤ºè¡¨çš„æ•°æ®æ”¾åœ¨ç³»ç»Ÿå…±äº«è¡¨ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è·Ÿæ•°æ®å­—å…¸æ”¾åœ¨ä¸€èµ·\r\n* ON ï¼šè¡¨ç¤ºæ¯ä¸ª InnoDB è¡¨æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªä»¥ .ibd ä¸ºåç¼€çš„æ–‡ä»¶ä¸­ï¼ˆé»˜è®¤ï¼‰\r\n\r\nä¸€ä¸ªè¡¨å•ç‹¬å­˜å‚¨ä¸ºä¸€ä¸ªæ–‡ä»¶æ›´å®¹æ˜“ç®¡ç†ï¼Œåœ¨ä¸éœ€è¦è¿™ä¸ªè¡¨æ—¶é€šè¿‡ drop table å‘½ä»¤ï¼Œç³»ç»Ÿå°±ä¼šç›´æ¥åˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼›å¦‚æœæ˜¯æ”¾åœ¨å…±äº«è¡¨ç©ºé—´ä¸­ï¼Œå³ä½¿è¡¨åˆ æ‰äº†ï¼Œç©ºé—´ä¹Ÿæ˜¯ä¸ä¼šå›æ”¶çš„\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### æ•°æ®åˆ é™¤\r\n\r\nMySQL çš„æ•°æ®åˆ é™¤å°±æ˜¯ç§»é™¤æ‰æŸä¸ªè®°å½•åï¼Œè¯¥ä½ç½®å°±è¢«æ ‡è®°ä¸º**å¯å¤ç”¨**ï¼Œå¦‚æœæœ‰ç¬¦åˆèŒƒå›´æ¡ä»¶çš„æ•°æ®å¯ä»¥æ’å…¥åˆ°è¿™é‡Œã€‚ç¬¦åˆèŒƒå›´æ¡ä»¶çš„æ„æ€æ˜¯å‡è®¾åˆ é™¤è®°å½• R4ï¼Œä¹‹åè¦å†æ’å…¥ä¸€ä¸ª ID åœ¨ 300 å’Œ 600 ä¹‹é—´çš„è®°å½•æ—¶ï¼Œå°±ä¼šå¤ç”¨è¿™ä¸ªä½ç½®\r\n\r\n![image-20250320011040214](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011040214.png)\r\n\r\nInnoDB çš„æ•°æ®æ˜¯æŒ‰é¡µå­˜å‚¨çš„å¦‚æœåˆ æ‰äº†ä¸€ä¸ªæ•°æ®é¡µä¸Šçš„æ‰€æœ‰è®°å½•ï¼Œæ•´ä¸ªæ•°æ®é¡µå°±å¯ä»¥è¢«å¤ç”¨äº†ï¼Œå¦‚æœç›¸é‚»çš„ä¸¤ä¸ªæ•°æ®é¡µåˆ©ç”¨ç‡éƒ½å¾ˆå°ï¼Œç³»ç»Ÿå°±ä¼šæŠŠè¿™ä¸¤ä¸ªé¡µä¸Šçš„æ•°æ®åˆåˆ°å…¶ä¸­ä¸€ä¸ªé¡µä¸Šï¼Œå¦å¤–ä¸€ä¸ªæ•°æ®é¡µå°±è¢«æ ‡è®°ä¸ºå¯å¤ç”¨\r\n\r\nåˆ é™¤å‘½ä»¤å…¶å®åªæ˜¯æŠŠè®°å½•çš„ä½ç½®ï¼Œæˆ–è€…**æ•°æ®é¡µæ ‡è®°ä¸ºäº†å¯å¤ç”¨ï¼Œä½†ç£ç›˜æ–‡ä»¶çš„å¤§å°æ˜¯ä¸ä¼šå˜çš„**ï¼Œè¿™äº›å¯ä»¥å¤ç”¨è¿˜æ²¡æœ‰è¢«ä½¿ç”¨çš„ç©ºé—´ï¼Œçœ‹èµ·æ¥å°±åƒæ˜¯ç©ºæ´ï¼Œé€ æˆæ•°æ®åº“çš„ç¨€ç–ï¼Œå› æ­¤éœ€è¦è¿›è¡Œç´§å‡‘å¤„ç†\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### é‡å»ºæ•°æ®\r\n\r\né‡å»ºè¡¨å°±æ˜¯æŒ‰ç…§ä¸»é”® ID é€’å¢çš„é¡ºåºï¼ŒæŠŠæ•°æ®ä¸€è¡Œä¸€è¡Œåœ°ä»æ—§è¡¨ä¸­è¯»å‡ºæ¥å†æ’å…¥åˆ°æ–°è¡¨ä¸­ï¼Œè®©æ•°æ®æ›´åŠ ç´§å‡‘ã€‚é‡å»ºè¡¨æ—¶ MySQL ä¼šè‡ªåŠ¨å®Œæˆè½¬å­˜æ•°æ®ã€äº¤æ¢è¡¨åã€åˆ é™¤æ—§è¡¨çš„æ“ä½œï¼Œçº¿ä¸Šæ“ä½œä¼šé˜»å¡å¤§é‡çš„çº¿ç¨‹å¢åˆ æ”¹æŸ¥çš„æ“ä½œ\r\n\r\né‡å»ºå‘½ä»¤ï¼š\r\n\r\n```sql\r\nALTER TABLE A ENGINE=InnoDB\r\n```\r\n\r\nå·¥ä½œæµç¨‹ï¼šæ–°å»ºä¸´æ—¶è¡¨ tmp_table Bï¼ˆåœ¨ Server å±‚åˆ›å»ºçš„ï¼‰ï¼ŒæŠŠè¡¨ A ä¸­çš„æ•°æ®å¯¼å…¥åˆ°è¡¨ B ä¸­ï¼Œæ“ä½œå®Œæˆåç”¨è¡¨ B æ›¿æ¢è¡¨ Aï¼Œå®Œæˆé‡å»º\r\n\r\né‡å»ºè¡¨çš„æ­¥éª¤éœ€è¦ DDL ä¸æ˜¯ Online çš„ï¼Œå› ä¸ºåœ¨å¯¼å…¥æ•°æ®çš„è¿‡ç¨‹æœ‰æ–°çš„æ•°æ®è¦å†™å…¥åˆ°è¡¨ A çš„è¯ï¼Œå°±ä¼šé€ æˆæ•°æ®ä¸¢å¤±\r\n\r\nMySQL 5.6 ç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„ **Online DDL**ï¼Œé‡å»ºè¡¨çš„å‘½ä»¤é»˜è®¤æ‰§è¡Œæ­¤æ­¥éª¤ï¼š\r\n\r\n* å»ºç«‹ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ tmp_fileï¼ˆInnoDB åˆ›å»ºï¼‰ï¼Œæ‰«æè¡¨ A ä¸»é”®çš„æ‰€æœ‰æ•°æ®é¡µ\r\n* ç”¨æ•°æ®é¡µä¸­è¡¨ A çš„è®°å½•ç”Ÿæˆ B+ æ ‘ï¼Œå­˜å‚¨åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­\r\n* ç”Ÿæˆä¸´æ—¶æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œå°†æ‰€æœ‰å¯¹ A çš„æ“ä½œè®°å½•åœ¨ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼ˆrow logï¼‰ä¸­ï¼Œå¯¹åº”çš„æ˜¯å›¾ä¸­ state2 çš„çŠ¶æ€\r\n* ä¸´æ—¶æ–‡ä»¶ç”Ÿæˆåï¼Œå°†æ—¥å¿—æ–‡ä»¶ä¸­çš„æ“ä½œåº”ç”¨åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œå¾—åˆ°ä¸€ä¸ªé€»è¾‘æ•°æ®ä¸Šä¸è¡¨ A ç›¸åŒçš„æ•°æ®æ–‡ä»¶ï¼Œå¯¹åº”çš„å°±æ˜¯å›¾ä¸­ state3\r\n* ç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢è¡¨ A çš„æ•°æ®æ–‡ä»¶\r\n\r\n![image-20250320011052781](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011052781.png)\r\n\r\nOnline DDL æ“ä½œä¼šå…ˆè·å– MDL å†™é”ï¼Œå†é€€åŒ–æˆ MDL è¯»é”ã€‚ä½† MDL å†™é”æŒæœ‰æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œæ‰€ä»¥å¯ä»¥ç§°ä¸º Onlineï¼› è€Œ MDL è¯»é”ï¼Œä¸é˜»æ­¢æ•°æ®å¢åˆ æŸ¥æ”¹ï¼Œä½†ä¼šé˜»æ­¢å…¶å®ƒçº¿ç¨‹ä¿®æ”¹è¡¨ç»“æ„ï¼ˆå¯ä»¥å¯¹æ¯” `ANALYZE TABLE t`  å‘½ä»¤ï¼‰\r\n\r\né—®é¢˜ï¼šé‡å»ºè¡¨å¯ä»¥æ”¶ç¼©è¡¨ç©ºé—´ï¼Œä½†æ˜¯æ‰§è¡ŒæŒ‡ä»¤åæ•´ä½“å ç”¨ç©ºé—´å¢å¤§\r\n\r\nåŸå› ï¼šåœ¨é‡å»ºè¡¨å InnoDB ä¸ä¼šæŠŠæ•´å¼ è¡¨å æ»¡ï¼Œæ¯ä¸ªé¡µç•™äº† 1/16 ç»™åç»­çš„æ›´æ–°ä½¿ç”¨ã€‚è¡¨åœ¨æœªæ•´ç†ä¹‹å‰é¡µå·²ç»å ç”¨ 15/16 ä»¥ä¸Šï¼Œæ”¶ç¼©ä¹‹åéœ€è¦ä¿æŒæ•°æ®å ç”¨ç©ºé—´åœ¨ 15/16ï¼Œæ‰€ä»¥æ–‡ä»¶å ç”¨ç©ºé—´æ›´å¤§æ‰èƒ½ä¿æŒ\r\n\r\næ³¨æ„ï¼šä¸´æ—¶æ–‡ä»¶ä¹Ÿè¦å ç”¨ç©ºé—´ï¼Œå¦‚æœç©ºé—´ä¸è¶³ä¼šé‡å»ºå¤±è´¥\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### åŸåœ°ç½®æ¢\r\n\r\nDDL ä¸­çš„ä¸´æ—¶è¡¨ tmp_table æ˜¯åœ¨ Server å±‚åˆ›å»ºçš„ï¼ŒOnline DDL ä¸­çš„ä¸´æ—¶æ–‡ä»¶ tmp_file æ˜¯ InnoDB åœ¨å†…éƒ¨åˆ›å»ºå‡ºæ¥çš„ï¼Œæ•´ä¸ª DDL è¿‡ç¨‹éƒ½åœ¨ InnoDB å†…éƒ¨å®Œæˆï¼Œå¯¹äº Server å±‚æ¥è¯´ï¼Œæ²¡æœ‰æŠŠæ•°æ®æŒªåŠ¨åˆ°ä¸´æ—¶è¡¨ï¼Œæ˜¯ä¸€ä¸ªåŸåœ°æ“ä½œï¼Œè¿™å°±æ˜¯ inplace\r\n\r\nä¸¤è€…çš„å…³ç³»ï¼š\r\n\r\n* DDL è¿‡ç¨‹å¦‚æœæ˜¯ Online çš„ï¼Œå°±ä¸€å®šæ˜¯ inplace çš„\r\n* inplace çš„ DDLï¼Œæœ‰å¯èƒ½ä¸æ˜¯ Online çš„ï¼Œæˆªæ­¢åˆ° MySQL 8.0ï¼Œå…¨æ–‡ç´¢å¼•ï¼ˆFULLTEXTï¼‰å’Œç©ºé—´ç´¢å¼•ï¼ˆSPATIALï¼‰å±äºè¿™ç§æƒ…å†µ\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n## å¹¶å‘ä¼˜åŒ–\r\n\r\nMySQL Server æ˜¯å¤šçº¿ç¨‹ç»“æ„ï¼ŒåŒ…æ‹¬åå°çº¿ç¨‹å’Œå®¢æˆ·æœåŠ¡çº¿ç¨‹ã€‚å¤šçº¿ç¨‹å¯ä»¥æœ‰æ•ˆåˆ©ç”¨æœåŠ¡å™¨èµ„æºï¼Œæé«˜æ•°æ®åº“çš„å¹¶å‘æ€§èƒ½ã€‚åœ¨ MySQL ä¸­ï¼Œæ§åˆ¶å¹¶å‘è¿æ¥å’Œçº¿ç¨‹çš„ä¸»è¦å‚æ•°ï¼š\r\n\r\n* max_connectionsï¼šæ§åˆ¶å…è®¸è¿æ¥åˆ° MySQL æ•°æ®åº“çš„æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤å€¼æ˜¯ 151\r\n\r\n  å¦‚æœçŠ¶æ€å˜é‡ connection_errors_max_connections ä¸ä¸ºé›¶ï¼Œå¹¶ä¸”ä¸€ç›´å¢é•¿ï¼Œåˆ™è¯´æ˜ä¸æ–­æœ‰è¿æ¥è¯·æ±‚å› æ•°æ®åº“è¿æ¥æ•°å·²è¾¾åˆ°å…è®¸æœ€å¤§å€¼è€Œå¤±è´¥ï¼Œè¿™æ—¶å¯ä»¥è€ƒè™‘å¢å¤§ max_connections çš„å€¼\r\n\r\n  MySQL æœ€å¤§å¯æ”¯æŒçš„è¿æ¥æ•°å–å†³äºå¾ˆå¤šå› ç´ ï¼ŒåŒ…æ‹¬æ“ä½œç³»ç»Ÿå¹³å°çš„çº¿ç¨‹åº“çš„è´¨é‡ã€å†…å­˜å¤§å°ã€æ¯ä¸ªè¿æ¥çš„è´Ÿè·ã€CPUçš„å¤„ç†é€Ÿåº¦ã€æœŸæœ›çš„å“åº”æ—¶é—´ç­‰ã€‚åœ¨ Linux å¹³å°ä¸‹ï¼Œæ€§èƒ½å¥½çš„æœåŠ¡å™¨ï¼Œå¯ä»¥æ”¯æŒ 500-1000 ä¸ªè¿æ¥ï¼Œéœ€è¦æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è¿›è¡Œè¯„ä¼°è®¾å®š\r\n\r\n* innodb_thread_concurrencyï¼šå¹¶å‘çº¿ç¨‹æ•°ï¼Œä»£è¡¨ç³»ç»Ÿå†…åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ï¼ˆå·²ç»è¢«ç§»é™¤ï¼‰\r\n\r\n* back_logï¼šæ§åˆ¶ MySQL ç›‘å¬ TCP ç«¯å£æ—¶çš„ç§¯å‹è¯·æ±‚æ ˆçš„å¤§å°\r\n\r\n  å¦‚æœ Mysql çš„è¿æ¥æ•°è¾¾åˆ° max_connections æ—¶ï¼Œæ–°æ¥çš„è¯·æ±‚å°†ä¼šè¢«å­˜åœ¨å †æ ˆä¸­ï¼Œä»¥ç­‰å¾…æŸä¸€è¿æ¥é‡Šæ”¾èµ„æºï¼Œè¯¥å †æ ˆçš„æ•°é‡å³ back_logã€‚å¦‚æœç­‰å¾…è¿æ¥çš„æ•°é‡è¶…è¿‡ back_logï¼Œå°†ä¸è¢«æˆäºˆè¿æ¥èµ„æºç›´æ¥æŠ¥é”™\r\n\r\n  5.6.6 ç‰ˆæœ¬ä¹‹å‰é»˜è®¤å€¼ä¸º 50ï¼Œä¹‹åçš„ç‰ˆæœ¬é»˜è®¤ä¸º `50 + (max_connections/5)`ï¼Œä½†æœ€å¤§ä¸è¶…è¿‡900ï¼Œå¦‚æœéœ€è¦æ•°æ®åº“åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…å¤„ç†å¤§é‡è¿æ¥è¯·æ±‚ï¼Œ å¯ä»¥è€ƒè™‘é€‚å½“å¢å¤§ back_log çš„å€¼\r\n\r\n* table_open_cacheï¼šæ§åˆ¶æ‰€æœ‰ SQL è¯­å¥æ‰§è¡Œçº¿ç¨‹å¯æ‰“å¼€è¡¨ç¼“å­˜çš„æ•°é‡\r\n\r\n  åœ¨æ‰§è¡Œ SQL è¯­å¥æ—¶ï¼Œæ¯ä¸ªæ‰§è¡Œçº¿ç¨‹è‡³å°‘è¦æ‰“å¼€1ä¸ªè¡¨ç¼“å­˜ï¼Œè¯¥å‚æ•°çš„å€¼åº”è¯¥æ ¹æ®è®¾ç½®çš„æœ€å¤§è¿æ¥æ•°ä»¥åŠæ¯ä¸ªè¿æ¥æ‰§è¡Œå…³è”æŸ¥è¯¢ä¸­æ¶‰åŠçš„è¡¨çš„æœ€å¤§æ•°é‡æ¥è®¾å®šï¼š`max_connections * N`\r\n\r\n* thread_cache_sizeï¼šå¯æ§åˆ¶ MySQL ç¼“å­˜å®¢æˆ·æœåŠ¡çº¿ç¨‹çš„æ•°é‡\r\n\r\n  ä¸ºäº†åŠ å¿«è¿æ¥æ•°æ®åº“çš„é€Ÿåº¦ï¼ŒMySQL ä¼šç¼“å­˜ä¸€å®šæ•°é‡çš„å®¢æˆ·æœåŠ¡çº¿ç¨‹ä»¥å¤‡é‡ç”¨ï¼Œæ± åŒ–æ€æƒ³\r\n\r\n* innodb_lock_wait_timeoutï¼šè®¾ç½® InnoDB äº‹åŠ¡ç­‰å¾…è¡Œé”çš„æ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯ 50ms\r\n\r\n  å¯¹äºéœ€è¦å¿«é€Ÿåé¦ˆçš„ä¸šåŠ¡ç³»ç»Ÿï¼Œå¯ä»¥å°†è¡Œé”çš„ç­‰å¾…æ—¶é—´è°ƒå°ï¼Œä»¥é¿å…äº‹åŠ¡è¢«é•¿æ—¶é—´æŒ‚èµ·ï¼› å¯¹äºåå°è¿è¡Œçš„æ‰¹é‡å¤„ç†ç¨‹åºæ¥è¯´ï¼Œå¯ä»¥å°†è¡Œé”çš„ç­‰å¾…æ—¶é—´è°ƒå¤§ï¼Œä»¥é¿å…å‘ç”Ÿå¤§çš„å›æ»šæ“ä½œ\r\n\r\n\r\n\r\n"},{"title":"MySQL - è¡¨","tags":["SQL"],"categories":["MySQL","åŸºç¡€ç¯‡"],"author":"imklaus","excerpt":"\r\n\r\n\r\n## å•è¡¨æ“ä½œ\r\n\r\n### SQL\r\n\r\n- SQL\r\n\r\n  - Structured Query Languageï¼šç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€\r\n  - å®šä¹‰äº†æ“ä½œæ‰€æœ‰å…³ç³»å‹æ•°æ®åº“çš„è§„åˆ™ï¼Œæ¯ç§æ•°æ®åº“æ“ä½œçš„æ–¹å¼å¯èƒ½ä¼šå­˜åœ¨ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œç§°ä¸ºâ€œæ–¹è¨€â€\r\n\r\n- SQL é€šç”¨è¯­æ³•\r\n\r\n  - SQL è¯­å¥å¯ä»¥å•è¡Œæˆ–å¤šè¡Œä¹¦å†™ï¼Œä»¥**åˆ†å·ç»“å°¾**ã€‚\r\n  - å¯ä½¿ç”¨ç©ºæ ¼å’Œç¼©è¿›æ¥å¢å¼ºè¯­å¥çš„å¯è¯»æ€§ã€‚\r\n  - MySQL æ•°æ®åº“çš„ SQL è¯­å¥ä¸åŒºåˆ†å¤§å°å†™ï¼Œ**å…³é”®å­—å»ºè®®ä½¿ç”¨å¤§å†™**ã€‚\r\n  - æ•°æ®åº“çš„æ³¨é‡Šï¼š\r\n    - å•è¡Œæ³¨é‡Šï¼š-- æ³¨é‡Šå†…å®¹       #æ³¨é‡Šå†…å®¹ï¼ˆMySQL ç‰¹æœ‰ï¼‰\r\n    - å¤šè¡Œæ³¨é‡Šï¼š/* æ³¨é‡Šå†…å®¹ */\r\n\r\n- SQL åˆ†ç±»\r\n\r\n  - DDLï¼ˆData Definition Languageï¼‰æ•°æ®å®šä¹‰è¯­è¨€\r\n\r\n    - ç”¨æ¥å®šä¹‰æ•°æ®åº“å¯¹è±¡ï¼šæ•°æ®åº“ï¼Œè¡¨ï¼Œåˆ—ç­‰ã€‚å…³é”®å­—ï¼šcreateã€drop,ã€alter ç­‰\r\n\r\n  - DMLï¼ˆData Manipulation Languageï¼‰æ•°æ®æ“ä½œè¯­è¨€\r\n\r\n    - ç”¨æ¥å¯¹æ•°æ®åº“ä¸­è¡¨çš„æ•°æ®è¿›è¡Œå¢åˆ æ”¹ã€‚å…³é”®å­—ï¼šinsertã€deleteã€update ç­‰\r\n\r\n  - DQLï¼ˆData Query Languageï¼‰æ•°æ®æŸ¥è¯¢è¯­è¨€\r\n\r\n    - ç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­è¡¨çš„è®°å½•(æ•°æ®)ã€‚å…³é”®å­—ï¼šselectã€where ç­‰\r\n\r\n  - DCLï¼ˆData Control Languageï¼‰æ•°æ®æ§åˆ¶è¯­è¨€\r\n\r\n    - ç”¨æ¥å®šä¹‰æ•°æ®åº“çš„è®¿é—®æƒé™å’Œå®‰å…¨çº§åˆ«ï¼ŒåŠåˆ›å»ºç”¨æˆ·ã€‚å…³é”®å­—ï¼šgrantï¼Œ revokeç­‰\r\n\r\n    ![image-20250320013733663](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013733663.png)\r\n\r\n","link":"/posts/MySQL_Table","content":"\r\n\r\n\r\n## å•è¡¨æ“ä½œ\r\n\r\n### SQL\r\n\r\n- SQL\r\n\r\n  - Structured Query Languageï¼šç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€\r\n  - å®šä¹‰äº†æ“ä½œæ‰€æœ‰å…³ç³»å‹æ•°æ®åº“çš„è§„åˆ™ï¼Œæ¯ç§æ•°æ®åº“æ“ä½œçš„æ–¹å¼å¯èƒ½ä¼šå­˜åœ¨ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œç§°ä¸ºâ€œæ–¹è¨€â€\r\n\r\n- SQL é€šç”¨è¯­æ³•\r\n\r\n  - SQL è¯­å¥å¯ä»¥å•è¡Œæˆ–å¤šè¡Œä¹¦å†™ï¼Œä»¥**åˆ†å·ç»“å°¾**ã€‚\r\n  - å¯ä½¿ç”¨ç©ºæ ¼å’Œç¼©è¿›æ¥å¢å¼ºè¯­å¥çš„å¯è¯»æ€§ã€‚\r\n  - MySQL æ•°æ®åº“çš„ SQL è¯­å¥ä¸åŒºåˆ†å¤§å°å†™ï¼Œ**å…³é”®å­—å»ºè®®ä½¿ç”¨å¤§å†™**ã€‚\r\n  - æ•°æ®åº“çš„æ³¨é‡Šï¼š\r\n    - å•è¡Œæ³¨é‡Šï¼š-- æ³¨é‡Šå†…å®¹       #æ³¨é‡Šå†…å®¹ï¼ˆMySQL ç‰¹æœ‰ï¼‰\r\n    - å¤šè¡Œæ³¨é‡Šï¼š/* æ³¨é‡Šå†…å®¹ */\r\n\r\n- SQL åˆ†ç±»\r\n\r\n  - DDLï¼ˆData Definition Languageï¼‰æ•°æ®å®šä¹‰è¯­è¨€\r\n\r\n    - ç”¨æ¥å®šä¹‰æ•°æ®åº“å¯¹è±¡ï¼šæ•°æ®åº“ï¼Œè¡¨ï¼Œåˆ—ç­‰ã€‚å…³é”®å­—ï¼šcreateã€drop,ã€alter ç­‰\r\n\r\n  - DMLï¼ˆData Manipulation Languageï¼‰æ•°æ®æ“ä½œè¯­è¨€\r\n\r\n    - ç”¨æ¥å¯¹æ•°æ®åº“ä¸­è¡¨çš„æ•°æ®è¿›è¡Œå¢åˆ æ”¹ã€‚å…³é”®å­—ï¼šinsertã€deleteã€update ç­‰\r\n\r\n  - DQLï¼ˆData Query Languageï¼‰æ•°æ®æŸ¥è¯¢è¯­è¨€\r\n\r\n    - ç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­è¡¨çš„è®°å½•(æ•°æ®)ã€‚å…³é”®å­—ï¼šselectã€where ç­‰\r\n\r\n  - DCLï¼ˆData Control Languageï¼‰æ•°æ®æ§åˆ¶è¯­è¨€\r\n\r\n    - ç”¨æ¥å®šä¹‰æ•°æ®åº“çš„è®¿é—®æƒé™å’Œå®‰å…¨çº§åˆ«ï¼ŒåŠåˆ›å»ºç”¨æˆ·ã€‚å…³é”®å­—ï¼šgrantï¼Œ revokeç­‰\r\n\r\n    ![image-20250320013733663](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013733663.png)\r\n\r\n<!-- more -->\r\n\r\n***\r\n\r\n\r\n\r\n### DDL\r\n\r\n#### æ•°æ®åº“\r\n\r\n* R(Retrieve)ï¼šæŸ¥è¯¢\r\n\r\n  * æŸ¥è¯¢æ‰€æœ‰æ•°æ®åº“ï¼š\r\n\r\n    ```sql\r\n    SHOW DATABASES;\r\n    ```\r\n\r\n  * æŸ¥è¯¢æŸä¸ªæ•°æ®åº“çš„åˆ›å»ºè¯­å¥\r\n\r\n    ```sql\r\n    SHOW CREATE DATABASE æ•°æ®åº“åç§°;  -- æ ‡å‡†è¯­æ³•\r\n    \r\n    SHOW CREATE DATABASE mysql;     -- æŸ¥çœ‹mysqlæ•°æ®åº“çš„åˆ›å»ºæ ¼å¼\r\n    ```\r\n\r\n    \r\n\r\n* C(Create)ï¼šåˆ›å»º\r\n\r\n  * åˆ›å»ºæ•°æ®åº“\r\n\r\n    ```sql\r\n    CREATE DATABASE æ•°æ®åº“åç§°;-- æ ‡å‡†è¯­æ³•\r\n    \r\n    CREATE DATABASE db1;     -- åˆ›å»ºdb1æ•°æ®åº“\r\n    ```\r\n\r\n  * åˆ›å»ºæ•°æ®åº“ï¼ˆåˆ¤æ–­ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰\r\n\r\n    ```sql\r\n    CREATE DATABASE IF NOT EXISTS æ•°æ®åº“åç§°;\r\n    ```\r\n\r\n  * åˆ›å»ºæ•°æ®åº“ï¼Œå¹¶æŒ‡å®šå­—ç¬¦é›†\r\n\r\n    ```sql\r\n    CREATE DATABASE æ•°æ®åº“åç§° CHARACTER SET å­—ç¬¦é›†åç§°;\r\n    ```\r\n\r\n  * ä¾‹å¦‚ï¼šåˆ›å»ºdb4æ•°æ®åº“ã€å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼ŒæŒ‡å®šå­—ç¬¦é›†ä¸ºgbk\r\n\r\n    ```sql\r\n    -- åˆ›å»ºdb4æ•°æ®åº“ã€å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼ŒæŒ‡å®šå­—ç¬¦é›†ä¸ºgbk\r\n    CREATE DATABASE IF NOT EXISTS db4 CHARACTER SET gbk;\r\n    \r\n    -- æŸ¥çœ‹db4æ•°æ®åº“çš„å­—ç¬¦é›†\r\n    SHOW CREATE DATABASE db4;\r\n    ```\r\n\r\n    \r\n\r\n* U(Update)ï¼šä¿®æ”¹\r\n\r\n  * ä¿®æ”¹æ•°æ®åº“çš„å­—ç¬¦é›†\r\n\r\n    ```sql\r\n    ALTER DATABASE æ•°æ®åº“åç§° CHARACTER SET å­—ç¬¦é›†åç§°;\r\n    ```\r\n\r\n  * å¸¸ç”¨å­—ç¬¦é›†ï¼š\r\n\r\n    ```sql\r\n    --æŸ¥è¯¢æ‰€æœ‰æ”¯æŒçš„å­—ç¬¦é›†\r\n    SHOW CHARSET;\r\n    --æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„æ ¡å¯¹è§„åˆ™\r\n    SHOW COLLATION;\r\n    \r\n    -- å­—ç¬¦é›†: utf8,latinI,GBK,,GBKæ˜¯utf8çš„å­é›†\r\n    -- æ ¡å¯¹è§„åˆ™: ci å¤§å°å®šä¸æ•æ„Ÿï¼Œcsæˆ–binå¤§å°å†™æ•æ„Ÿ\r\n    ```\r\n\r\n    \r\n\r\n* D(Delete)ï¼šåˆ é™¤\r\n\r\n  * åˆ é™¤æ•°æ®åº“ï¼š\r\n\r\n    ```sql\r\n    DROP DATABASE æ•°æ®åº“åç§°;\r\n    ```\r\n\r\n  * åˆ é™¤æ•°æ®åº“(åˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨åˆ™åˆ é™¤)ï¼š\r\n\r\n    ```sql\r\n    DROP DATABASE IF EXISTS æ•°æ®åº“åç§°;\r\n    ```\r\n    \r\n    \r\n\r\n* ä½¿ç”¨æ•°æ®åº“ï¼š\r\n\r\n  * æŸ¥è¯¢å½“å‰æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“åç§°\r\n\r\n    ```sql\r\n    SELECT DATABASE();\r\n    ```\r\n\r\n  * ä½¿ç”¨æ•°æ®åº“\r\n\r\n    ```sql\r\n    USE æ•°æ®åº“åç§°ï¼› -- æ ‡å‡†è¯­æ³•\r\n    USE db4;\t   -- ä½¿ç”¨db4æ•°æ®åº“\r\n    ```\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æ•°æ®è¡¨\r\n\r\n- R(Retrieve)ï¼šæŸ¥è¯¢\r\n\r\n  - æŸ¥è¯¢æ•°æ®åº“ä¸­æ‰€æœ‰çš„æ•°æ®è¡¨\r\n\r\n    ```sql\r\n    USE mysql;-- ä½¿ç”¨mysqlæ•°æ®åº“\r\n    \r\n    SHOW TABLES;-- æŸ¥è¯¢åº“ä¸­æ‰€æœ‰çš„è¡¨\r\n    ```\r\n  \r\n  - æŸ¥è¯¢è¡¨ç»“æ„\r\n\r\n    ```sql\r\n  DESC è¡¨å;\r\n    ```\r\n  \r\n  - æŸ¥è¯¢è¡¨å­—ç¬¦é›†\r\n  \r\n    ```sql\r\n    SHOW TABLE STATUS FROM åº“å LIKE 'è¡¨å';\r\n    ```\r\n\r\n    \r\n\r\n- C(Create)ï¼šåˆ›å»º\r\n\r\n  - åˆ›å»ºæ•°æ®è¡¨\r\n\r\n    ```sql\r\n    CREATE TABLE è¡¨å(\r\n        åˆ—å1 æ•°æ®ç±»å‹1,\r\n        åˆ—å2 æ•°æ®ç±»å‹2,\r\n        ....\r\n        åˆ—ån æ•°æ®ç±»å‹n\r\n    );\r\n    -- æ³¨æ„ï¼šæœ€åä¸€åˆ—ï¼Œä¸éœ€è¦åŠ é€—å·\r\n    ```\r\n\r\n  - å¤åˆ¶è¡¨\r\n\r\n    ```sql\r\n    CREATE TABLE è¡¨å LIKE è¢«å¤åˆ¶çš„è¡¨å;  -- æ ‡å‡†è¯­æ³•\r\n    \r\n    CREATE TABLE product2 LIKE product; -- å¤åˆ¶productè¡¨åˆ°product2è¡¨\r\n    ```\r\n\r\n  - æ•°æ®ç±»å‹\r\n\r\n    | æ•°æ®ç±»å‹  | è¯´æ˜                                                         |\r\n    | --------- | ------------------------------------------------------------ |\r\n    | INT       | æ•´æ•°ç±»å‹                                                     |\r\n    | DOUBLE    | å°æ•°ç±»å‹                                                     |\r\n    | DATE      | æ—¥æœŸï¼ŒåªåŒ…å«å¹´æœˆæ—¥ï¼šyyyy-MM-dd                               |\r\n    | DATETIME  | æ—¥æœŸï¼ŒåŒ…å«å¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼šyyyy-MM-dd HH:mm:ss                  |\r\n    | TIMESTAMP | æ—¶é—´æˆ³ç±»å‹ï¼ŒåŒ…å«å¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼šyyyy-MM-dd HH:mm:ss<br />å¦‚æœä¸ç»™è¿™ä¸ªå­—æ®µèµ‹å€¼æˆ–èµ‹å€¼ä¸º NULLï¼Œåˆ™é»˜è®¤ä½¿ç”¨å½“å‰çš„ç³»ç»Ÿæ—¶é—´ |\r\n    | CHAR      | å­—ç¬¦ä¸²ï¼Œå®šé•¿ç±»å‹                                             |\r\n    | VARCHAR   | å­—ç¬¦ä¸²ï¼Œ**å˜é•¿ç±»å‹**<br />name varchar(20) ä»£è¡¨å§“åæœ€å¤§ 20 ä¸ªå­—ç¬¦ï¼šzhangsan 8 ä¸ªå­—ç¬¦ï¼Œå¼ ä¸‰ 2 ä¸ªå­—ç¬¦ |\r\n  \r\n    `INT(n)`ï¼šn ä»£è¡¨ä½æ•°\r\n  \r\n    * 3ï¼šintï¼ˆ9ï¼‰æ˜¾ç¤ºç»“æœä¸º 000000010\r\n    * 3ï¼šintï¼ˆ3ï¼‰æ˜¾ç¤ºç»“æœä¸º 010\r\n  \r\n    `varchar(n)`ï¼šn è¡¨ç¤ºçš„æ˜¯å­—ç¬¦æ•°\r\n  \r\n  - ä¾‹å¦‚ï¼š\r\n  \r\n    ```sql\r\n    -- ä½¿ç”¨db3æ•°æ®åº“\r\n    USE db3;\r\n    \r\n    -- åˆ›å»ºä¸€ä¸ªproductå•†å“è¡¨\r\n    CREATE TABLE product(\r\n    \tid INT,\t\t\t\t-- å•†å“ç¼–å·\r\n    \tNAME VARCHAR(30),\t-- å•†å“åç§°\r\n    \tprice DOUBLE,\t\t-- å•†å“ä»·æ ¼\r\n    \tstock INT,\t\t\t-- å•†å“åº“å­˜\r\n    \tinsert_time DATE    -- ä¸Šæ¶æ—¶é—´\r\n    );\r\n    ```\r\n\r\n    \r\n\r\n- U(Update)ï¼šä¿®æ”¹\r\n\r\n  - ä¿®æ”¹è¡¨å\r\n\r\n    ```sql\r\n    ALTER TABLE è¡¨å RENAME TO æ–°çš„è¡¨å;\r\n    ```\r\n  \r\n  - ä¿®æ”¹è¡¨çš„å­—ç¬¦é›†\r\n  \r\n    ```sql\r\n  ALTER TABLE è¡¨å CHARACTER SET å­—ç¬¦é›†åç§°;\r\n    ```\r\n\r\n  - æ·»åŠ ä¸€åˆ—\r\n  \r\n    ```sql\r\n    ALTER TABLE è¡¨å ADD åˆ—å æ•°æ®ç±»å‹;\r\n    ```\r\n  \r\n  - ä¿®æ”¹åˆ—æ•°æ®ç±»å‹\r\n  \r\n    ```sql\r\n    ALTER TABLE è¡¨å MODIFY åˆ—å æ–°æ•°æ®ç±»å‹;\r\n    ```\r\n\r\n  - ä¿®æ”¹åˆ—åç§°å’Œæ•°æ®ç±»å‹\r\n\r\n    ```sql\r\n    ALTER TABLE è¡¨å CHANGE åˆ—å æ–°åˆ—å æ–°æ•°æ®ç±»å‹;\r\n    ```\r\n  \r\n  - åˆ é™¤åˆ—\r\n  \r\n    ```sql\r\n    ALTER TABLE è¡¨å DROP åˆ—å;\r\n    ```\r\n\r\n    \r\n  \r\n- D(Delete)ï¼šåˆ é™¤\r\n\r\n  - åˆ é™¤æ•°æ®è¡¨\r\n\r\n    ```sql\r\n    DROP TABLE è¡¨å;\r\n    ```\r\n  \r\n  - åˆ é™¤æ•°æ®è¡¨(åˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨åˆ™åˆ é™¤)\r\n  \r\n    ```sql\r\n    DROP TABLE IF EXISTS è¡¨å;\r\n    ```\r\n  \r\n    \r\n\r\n***\r\n\r\n\r\n\r\n### DML\r\n\r\n#### INSERT\r\n\r\n* æ–°å¢è¡¨æ•°æ®\r\n\r\n  * æ–°å¢æ ¼å¼ 1ï¼šç»™æŒ‡å®šåˆ—æ·»åŠ æ•°æ®\r\n\r\n    ```sql\r\n    INSERT INTO è¡¨å(åˆ—å1,åˆ—å2...) VALUES (å€¼1,å€¼2...);\r\n    ```\r\n\r\n  * æ–°å¢æ ¼å¼ 2ï¼šé»˜è®¤ç»™å…¨éƒ¨åˆ—æ·»åŠ æ•°æ®\r\n\r\n    ```sql\r\n    INSERT INTO è¡¨å VALUES (å€¼1,å€¼2,å€¼3,...);\r\n    ```\r\n\r\n  * æ–°å¢æ ¼å¼ 3ï¼šæ‰¹é‡æ·»åŠ æ•°æ®\r\n\r\n    ```sql\r\n    -- ç»™æŒ‡å®šåˆ—æ‰¹é‡æ·»åŠ æ•°æ®\r\n    INSERT INTO è¡¨å(åˆ—å1,åˆ—å2,...) VALUES (å€¼1,å€¼2,...),(å€¼1,å€¼2,...)...;\r\n    \r\n    -- é»˜è®¤ç»™æ‰€æœ‰åˆ—æ‰¹é‡æ·»åŠ æ•°æ® \r\n    INSERT INTO è¡¨å VALUES (å€¼1,å€¼2,å€¼3,...),(å€¼1,å€¼2,å€¼3,...)...;\r\n    ```\r\n\r\n* å­—ç¬¦ä¸²æ‹¼æ¥\r\n\r\n  ```sql\r\n  CONCAT(string1,string2,'',...)\r\n  ```\r\n  \r\n  \r\n  \r\n* æ³¨æ„äº‹é¡¹\r\n\r\n  - åˆ—åå’Œå€¼çš„æ•°é‡ä»¥åŠæ•°æ®ç±»å‹è¦å¯¹åº”\r\n  - é™¤äº†æ•°å­—ç±»å‹ï¼Œå…¶ä»–æ•°æ®ç±»å‹çš„æ•°æ®éƒ½éœ€è¦åŠ å¼•å·(å•å¼•åŒå¼•éƒ½å¯ä»¥ï¼Œæ¨èå•å¼•)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### UPDATE\r\n\r\n* ä¿®æ”¹è¡¨æ•°æ®è¯­æ³•\r\n\r\n  * æ ‡å‡†è¯­æ³•\r\n\r\n    ```sql\r\n    UPDATE è¡¨å SET åˆ—å1 = å€¼1,åˆ—å2 = å€¼2,... [where æ¡ä»¶];\r\n    ```\r\n\r\n  * ä¿®æ”¹ç”µè§†çš„ä»·æ ¼ä¸º1800ã€åº“å­˜ä¸º36\r\n\r\n    ```sql\r\n    UPDATE product SET price=1800,stock=36 WHERE NAME='ç”µè§†';\r\n    SELECT * FROM product;-- æŸ¥çœ‹æ‰€æœ‰å•†å“ä¿¡æ¯\r\n    ```\r\n\r\n* æ³¨æ„äº‹é¡¹\r\n\r\n  - ä¿®æ”¹è¯­å¥ä¸­å¿…é¡»åŠ æ¡ä»¶\r\n  - å¦‚æœä¸åŠ æ¡ä»¶ï¼Œåˆ™å°†æ‰€æœ‰æ•°æ®éƒ½ä¿®æ”¹\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### DELETE\r\n\r\n* åˆ é™¤è¡¨æ•°æ®è¯­æ³•\r\n\r\n  ```sql\r\n  DELETE FROM è¡¨å [WHERE æ¡ä»¶];\r\n  ```\r\n\r\n* æ³¨æ„äº‹é¡¹\r\n  * åˆ é™¤è¯­å¥ä¸­å¿…é¡»åŠ æ¡ä»¶\r\n  * å¦‚æœä¸åŠ æ¡ä»¶ï¼Œåˆ™å°†æ‰€æœ‰æ•°æ®åˆ é™¤\r\n\r\n\r\n\r\nâ€‹    \r\n\r\n***\r\n\r\n\r\n\r\n### DQL\r\n\r\n#### æŸ¥è¯¢è¯­æ³•\r\n\r\næ•°æ®åº“æŸ¥è¯¢éµå¾ªæ¡ä»¶åœ¨å‰çš„åŸåˆ™\r\n\r\n```sql\r\nSELECT DISTINCT\r\n\t<select list>\r\nFROM\r\n\t<left_table> <join_type>\r\nJOIN\r\n\t<right_table> ON <join_condition>\t-- è¿æ¥æŸ¥è¯¢åœ¨å¤šè¡¨æŸ¥è¯¢éƒ¨åˆ†è¯¦è§£\r\nWHERE\r\n\t<where_condition>\r\nGROUP BY\r\n\t<group_by_list>\r\nHAVING\r\n\t<having_condition>\r\nORDER BY\r\n\t<order_by_condition>\r\nLIMIT\r\n\t<limit_params>\r\n```\r\n\r\næ‰§è¡Œé¡ºåºï¼š\r\n\r\n```sql\r\nFROM\t<left_table>\r\n\r\nON \t\t<join_condition>\r\n\r\n<join_type>\t\tJOIN\t<right_table>\r\n\r\nWHERE\t\t<where_condition>\r\n\r\nGROUP BY \t<group_by_list>\r\n\r\nHAVING\t\t<having_condition>\r\n\r\nSELECT DISTINCT\t\t<select list>\r\n\r\nORDER BY\t<order_by_condition>\r\n\r\nLIMIT\t\t<limit_params>\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æŸ¥è¯¢å…¨éƒ¨\r\n\r\n* æŸ¥è¯¢å…¨éƒ¨çš„è¡¨æ•°æ®\r\n\r\n  ```sql\r\n  -- æ ‡å‡†è¯­æ³•\r\n  SELECT * FROM è¡¨å;\r\n  \r\n  -- æŸ¥è¯¢productè¡¨æ‰€æœ‰æ•°æ®(å¸¸ç”¨)\r\n  SELECT * FROM product;\r\n  ```\r\n\r\n* æŸ¥è¯¢æŒ‡å®šå­—æ®µçš„è¡¨æ•°æ®\r\n\r\n  ```sql\r\n  SELECT åˆ—å1,åˆ—å2,... FROM è¡¨å;\r\n  ```\r\n\r\n* **å»é™¤é‡å¤æŸ¥è¯¢**ï¼šåªæœ‰å€¼å…¨éƒ¨é‡å¤çš„æ‰å¯ä»¥å»é™¤ï¼Œéœ€è¦åˆ›å»ºä¸´æ—¶è¡¨è¾…åŠ©æŸ¥è¯¢\r\n  \r\n  ```sql\r\n  SELECT DISTINCT åˆ—å1,åˆ—å2,... FROM è¡¨å;\r\n  ```\r\n  \r\n* è®¡ç®—åˆ—çš„å€¼ï¼ˆå››åˆ™è¿ç®—ï¼‰\r\n\r\n  ```sql\r\n  SELECT åˆ—å1 è¿ç®—ç¬¦(+ - * /) åˆ—å2 FROM è¡¨å;\r\n  \r\n  /*å¦‚æœæŸä¸€åˆ—å€¼ä¸ºnullï¼Œå¯ä»¥è¿›è¡Œæ›¿æ¢\r\n  \tifnull(è¡¨è¾¾å¼1,è¡¨è¾¾å¼2)\r\n  \tè¡¨è¾¾å¼1ï¼šæƒ³æ›¿æ¢çš„åˆ—\r\n  \tè¡¨è¾¾å¼2ï¼šæƒ³æ›¿æ¢çš„å€¼*/\r\n  ```\r\n\r\n  ä¾‹å¦‚ï¼š\r\n\r\n  ```sql\r\n  -- æŸ¥è¯¢å•†å“åç§°å’Œåº“å­˜ï¼Œåº“å­˜æ•°é‡åœ¨åŸæœ‰åŸºç¡€ä¸ŠåŠ 10\r\n  SELECT NAME,stock+10 FROM product;\r\n  \r\n  -- æŸ¥è¯¢å•†å“åç§°å’Œåº“å­˜ï¼Œåº“å­˜æ•°é‡åœ¨åŸæœ‰åŸºç¡€ä¸ŠåŠ 10ã€‚è¿›è¡Œnullå€¼åˆ¤æ–­\r\n  SELECT NAME,IFNULL(stock,0)+10 FROM product;\r\n  ```\r\n\r\n* **èµ·åˆ«å**\r\n\r\n  ```sql\r\n  SELECT åˆ—å1,åˆ—å2,... AS åˆ«å FROM è¡¨å;\r\n  ```\r\n\r\n  ä¾‹å¦‚ï¼š\r\n\r\n  ```sql\r\n  -- æŸ¥è¯¢å•†å“åç§°å’Œåº“å­˜ï¼Œåº“å­˜æ•°é‡åœ¨åŸæœ‰åŸºç¡€ä¸ŠåŠ 10ã€‚è¿›è¡Œnullå€¼åˆ¤æ–­ï¼Œèµ·åˆ«åä¸ºgetSum,ASå¯ä»¥çœç•¥ã€‚\r\n  SELECT NAME,IFNULL(stock,0)+10 AS getsum FROM product;\r\n  SELECT NAME,IFNULL(stock,0)+10 getsum FROM product;\r\n  ```\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æ¡ä»¶æŸ¥è¯¢\r\n\r\n* æ¡ä»¶æŸ¥è¯¢è¯­æ³•\r\n\r\n  ```sql\r\n  SELECT åˆ—å FROM è¡¨å WHERE æ¡ä»¶;\r\n  ```\r\n\r\n* æ¡ä»¶åˆ†ç±»\r\n\r\n  | ç¬¦å·                | åŠŸèƒ½                                                         |\r\n  | ------------------- | ------------------------------------------------------------ |\r\n  | >                   | å¤§äº                                                         |\r\n  | <                   | å°äº                                                         |\r\n  | >=                  | å¤§äºç­‰äº                                                     |\r\n  | <=                  | å°äºç­‰äº                                                     |\r\n  | =                   | ç­‰äº                                                         |\r\n  | <> æˆ– !=            | ä¸ç­‰äº                                                       |\r\n  | BETWEEN ... AND ... | åœ¨æŸä¸ªèŒƒå›´ä¹‹å†…(éƒ½åŒ…å«)                                       |\r\n  | IN(...)             | å¤šé€‰ä¸€                                                       |\r\n  | LIKE                | **æ¨¡ç³ŠæŸ¥è¯¢**ï¼š_å•ä¸ªä»»æ„å­—ç¬¦ã€%ä»»æ„ä¸ªå­—ç¬¦ã€[] åŒ¹é…é›†åˆå†…çš„å­—ç¬¦<br/>`LIKE '[^AB]%' `ï¼šä¸ä»¥ A å’Œ B å¼€å¤´çš„ä»»æ„æ–‡æœ¬ |\r\n  | IS NULL             | æ˜¯NULL                                                       |\r\n  | IS NOT NULL         | ä¸æ˜¯NULL                                                     |\r\n  | AND æˆ– &&           | å¹¶ä¸”                                                         |\r\n  | OR æˆ– \\|\\|          | æˆ–è€…                                                         |\r\n  | NOT æˆ– !            | éï¼Œä¸æ˜¯                                                     |\r\n  | UNION               | å¯¹ä¸¤ä¸ªç»“æœé›†è¿›è¡Œ**å¹¶é›†æ“ä½œå¹¶è¿›è¡Œå»é‡ï¼ŒåŒæ—¶è¿›è¡Œé»˜è®¤è§„åˆ™çš„æ’åº** |\r\n  | UNION ALL           | å¯¹ä¸¤ä¸ªç»“æœé›†è¿›è¡Œå¹¶é›†æ“ä½œä¸è¿›è¡Œå»é‡ï¼Œä¸è¿›è¡Œæ’åº               |\r\n\r\n* ä¾‹å¦‚ï¼š\r\n\r\n  ```sql\r\n  -- æŸ¥è¯¢åº“å­˜å¤§äº20çš„å•†å“ä¿¡æ¯\r\n  SELECT * FROM product WHERE stock > 20;\r\n  \r\n  -- æŸ¥è¯¢å“ç‰Œä¸ºåä¸ºçš„å•†å“ä¿¡æ¯\r\n  SELECT * FROM product WHERE brand='åä¸º';\r\n  \r\n  -- æŸ¥è¯¢é‡‘é¢åœ¨4000 ~ 6000ä¹‹é—´çš„å•†å“ä¿¡æ¯\r\n  SELECT * FROM product WHERE price >= 4000 AND price <= 6000;\r\n  SELECT * FROM product WHERE price BETWEEN 4000 AND 6000;\r\n  \r\n  -- æŸ¥è¯¢åº“å­˜ä¸º14ã€30ã€23çš„å•†å“ä¿¡æ¯\r\n  SELECT * FROM product WHERE stock=14 OR stock=30 OR stock=23;\r\n  SELECT * FROM product WHERE stock IN(14,30,23);\r\n  \r\n  -- æŸ¥è¯¢åº“å­˜ä¸ºnullçš„å•†å“ä¿¡æ¯\r\n  SELECT * FROM product WHERE stock IS NULL;\r\n  -- æŸ¥è¯¢åº“å­˜ä¸ä¸ºnullçš„å•†å“ä¿¡æ¯\r\n  SELECT * FROM product WHERE stock IS NOT NULL;\r\n  \r\n  -- æŸ¥è¯¢åç§°ä»¥'å°ç±³'ä¸ºå¼€å¤´çš„å•†å“ä¿¡æ¯\r\n  SELECT * FROM product WHERE NAME LIKE 'å°ç±³%';\r\n  \r\n  -- æŸ¥è¯¢åç§°ç¬¬äºŒä¸ªå­—æ˜¯'ä¸º'çš„å•†å“ä¿¡æ¯\r\n  SELECT * FROM product WHERE NAME LIKE '_ä¸º%';\r\n  \r\n  -- æŸ¥è¯¢åç§°ä¸ºå››ä¸ªå­—ç¬¦çš„å•†å“ä¿¡æ¯ 4ä¸ªä¸‹åˆ’çº¿\r\n  SELECT * FROM product WHERE NAME LIKE '____';\r\n  \r\n  -- æŸ¥è¯¢åç§°ä¸­åŒ…å«ç”µè„‘çš„å•†å“ä¿¡æ¯\r\n  SELECT * FROM product WHERE NAME LIKE '%ç”µè„‘%';\r\n  ```\r\n\r\n  ![image-20250320013806768](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013806768.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å‡½æ•°æŸ¥è¯¢\r\n\r\n##### èšåˆå‡½æ•°\r\n\r\nèšåˆå‡½æ•°ï¼šå°†ä¸€åˆ—æ•°æ®ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¿›è¡Œçºµå‘çš„è®¡ç®—\r\n\r\n* èšåˆå‡½æ•°è¯­æ³•\r\n\r\n  ```sql\r\n  SELECT å‡½æ•°å(åˆ—å) FROM è¡¨å [WHERE æ¡ä»¶]\r\n  ```\r\n\r\n* èšåˆå‡½æ•°åˆ†ç±»\r\n\r\n  | å‡½æ•°å      | åŠŸèƒ½                               |\r\n  | ----------- | ---------------------------------- |\r\n  | COUNT(åˆ—å) | ç»Ÿè®¡æ•°é‡ï¼ˆä¸€èˆ¬é€‰ç”¨ä¸ä¸º null çš„åˆ—ï¼‰ |\r\n  | MAX(åˆ—å)   | æœ€å¤§å€¼                             |\r\n  | MIN(åˆ—å)   | æœ€å°å€¼                             |\r\n  | SUM(åˆ—å)   | æ±‚å’Œ                               |\r\n  | AVG(åˆ—å)   | å¹³å‡å€¼ï¼ˆä¼šå¿½ç•¥ null è¡Œï¼‰           |\r\n\r\n* ä¾‹å¦‚\r\n\r\n  ```sql\r\n  -- è®¡ç®—productè¡¨ä¸­æ€»è®°å½•æ¡æ•° 7\r\n  SELECT COUNT(*) FROM product;\r\n  \r\n  -- è·å–æœ€é«˜ä»·æ ¼\r\n  SELECT MAX(price) FROM product;\r\n  -- è·å–æœ€é«˜ä»·æ ¼çš„å•†å“åç§°\r\n  SELECT NAME,price FROM product WHERE price = (SELECT MAX(price) FROM product);\r\n  \r\n  -- è·å–æœ€ä½åº“å­˜\r\n  SELECT MIN(stock) FROM product;\r\n  -- è·å–æœ€ä½åº“å­˜çš„å•†å“åç§°\r\n  SELECT NAME,stock FROM product WHERE stock = (SELECT MIN(stock) FROM product);\r\n  \r\n  -- è·å–æ€»åº“å­˜æ•°é‡\r\n  SELECT SUM(stock) FROM product;\r\n  -- è·å–å“ç‰Œä¸ºå°ç±³çš„å¹³å‡å•†å“ä»·æ ¼\r\n  SELECT AVG(price) FROM product WHERE brand='å°ç±³';\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ–‡æœ¬å‡½æ•°\r\n\r\nCONCAT()ï¼šç”¨äºè¿æ¥ä¸¤ä¸ªå­—æ®µ\r\n\r\n```sql\r\nSELECT CONCAT(TRIM(col1), '(', TRIM(col2), ')') AS concat_col FROM mytable\r\n-- è®¸å¤šæ•°æ®åº“ä¼šä½¿ç”¨ç©ºæ ¼æŠŠä¸€ä¸ªå€¼å¡«å……ä¸ºåˆ—å®½ï¼Œè¿æ¥çš„ç»“æœå‡ºç°ä¸€äº›ä¸å¿…è¦çš„ç©ºæ ¼ï¼Œä½¿ç”¨TRIM()å¯ä»¥å»é™¤é¦–å°¾ç©ºæ ¼\r\n```\r\n\r\n| å‡½æ•°åç§°  | ä½œ ç”¨                                                        |\r\n| --------- | ------------------------------------------------------------ |\r\n| LENGTH    | è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦å‡½æ•°ï¼Œè¿”å›å­—ç¬¦ä¸²çš„å­—èŠ‚é•¿åº¦                     |\r\n| CONCAT    | åˆå¹¶å­—ç¬¦ä¸²å‡½æ•°ï¼Œè¿”å›ç»“æœä¸ºè¿æ¥å‚æ•°äº§ç”Ÿçš„å­—ç¬¦ä¸²ï¼Œå‚æ•°å¯ä»¥ä½¿ä¸€ä¸ªæˆ–å¤šä¸ª |\r\n| INSERT    | æ›¿æ¢å­—ç¬¦ä¸²å‡½æ•°                                               |\r\n| LOWER     | å°†å­—ç¬¦ä¸²ä¸­çš„å­—æ¯è½¬æ¢ä¸ºå°å†™                                   |\r\n| UPPER     | å°†å­—ç¬¦ä¸²ä¸­çš„å­—æ¯è½¬æ¢ä¸ºå¤§å†™                                   |\r\n| LEFT      | ä»å·¦ä¾§å­—æˆªå–ç¬¦ä¸²ï¼Œè¿”å›å­—ç¬¦ä¸²å·¦è¾¹çš„è‹¥å¹²ä¸ªå­—ç¬¦                 |\r\n| RIGHT     | ä»å³ä¾§å­—æˆªå–ç¬¦ä¸²ï¼Œè¿”å›å­—ç¬¦ä¸²å³è¾¹çš„è‹¥å¹²ä¸ªå­—ç¬¦                 |\r\n| TRIM      | åˆ é™¤å­—ç¬¦ä¸²å·¦å³ä¸¤ä¾§çš„ç©ºæ ¼                                     |\r\n| REPLACE   | å­—ç¬¦ä¸²æ›¿æ¢å‡½æ•°ï¼Œè¿”å›æ›¿æ¢åçš„æ–°å­—ç¬¦ä¸²                         |\r\n| SUBSTRING | æˆªå–å­—ç¬¦ä¸²ï¼Œè¿”å›ä»æŒ‡å®šä½ç½®å¼€å§‹çš„æŒ‡å®šé•¿åº¦çš„å­—ç¬¦æ¢             |\r\n| REVERSE   | å­—ç¬¦ä¸²åè½¬ï¼ˆé€†åºï¼‰å‡½æ•°ï¼Œè¿”å›ä¸åŸå§‹å­—ç¬¦ä¸²é¡ºåºç›¸åçš„å­—ç¬¦ä¸²     |\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ•°å­—å‡½æ•°\r\n\r\n| å‡½æ•°åç§°        | ä½œ ç”¨                                                      |\r\n| --------------- | ---------------------------------------------------------- |\r\n| ABS             | æ±‚ç»å¯¹å€¼                                                   |\r\n| SQRT            | æ±‚äºŒæ¬¡æ–¹æ ¹                                                 |\r\n| MOD             | æ±‚ä½™æ•°                                                     |\r\n| CEIL å’Œ CEILING | ä¸¤ä¸ªå‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œéƒ½æ˜¯è¿”å›ä¸å°äºå‚æ•°çš„æœ€å°æ•´æ•°ï¼Œå³å‘ä¸Šå–æ•´ |\r\n| FLOOR           | å‘ä¸‹å–æ•´ï¼Œè¿”å›å€¼è½¬åŒ–ä¸ºä¸€ä¸ªBIGINT                           |\r\n| RAND            | ç”Ÿæˆä¸€ä¸ª0~1ä¹‹é—´çš„éšæœºæ•°ï¼Œä¼ å…¥æ•´æ•°å‚æ•°æ˜¯ï¼Œç”¨æ¥äº§ç”Ÿé‡å¤åºåˆ—  |\r\n| ROUND           | å¯¹æ‰€ä¼ å‚æ•°è¿›è¡Œå››èˆäº”å…¥                                     |\r\n| SIGN            | è¿”å›å‚æ•°çš„ç¬¦å·                                             |\r\n| POW å’Œ POWER    | ä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½ç›¸åŒï¼Œéƒ½æ˜¯æ‰€ä¼ å‚æ•°çš„æ¬¡æ–¹çš„ç»“æœå€¼             |\r\n| SIN             | æ±‚æ­£å¼¦å€¼                                                   |\r\n| ASIN            | æ±‚åæ­£å¼¦å€¼ï¼Œä¸å‡½æ•° SIN äº’ä¸ºåå‡½æ•°                          |\r\n| COS             | æ±‚ä½™å¼¦å€¼                                                   |\r\n| ACOS            | æ±‚åä½™å¼¦å€¼ï¼Œä¸å‡½æ•° COS äº’ä¸ºåå‡½æ•°                          |\r\n| TAN             | æ±‚æ­£åˆ‡å€¼                                                   |\r\n| ATAN            | æ±‚åæ­£åˆ‡å€¼ï¼Œä¸å‡½æ•° TAN äº’ä¸ºåå‡½æ•°                          |\r\n| COT             | æ±‚ä½™åˆ‡å€¼                                                   |\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ—¥æœŸå‡½æ•°\r\n\r\n| å‡½æ•°åç§°                | ä½œ ç”¨                                                        |\r\n| ----------------------- | ------------------------------------------------------------ |\r\n| CURDATE å’Œ CURRENT_DATE | ä¸¤ä¸ªå‡½æ•°ä½œç”¨ç›¸åŒï¼Œè¿”å›å½“å‰ç³»ç»Ÿçš„æ—¥æœŸå€¼                       |\r\n| CURTIME å’Œ CURRENT_TIME | ä¸¤ä¸ªå‡½æ•°ä½œç”¨ç›¸åŒï¼Œè¿”å›å½“å‰ç³»ç»Ÿçš„æ—¶é—´å€¼                       |\r\n| NOW å’Œ  SYSDATE         | ä¸¤ä¸ªå‡½æ•°ä½œç”¨ç›¸åŒï¼Œè¿”å›å½“å‰ç³»ç»Ÿçš„æ—¥æœŸå’Œæ—¶é—´å€¼                 |\r\n| MONTH                   | è·å–æŒ‡å®šæ—¥æœŸä¸­çš„æœˆä»½                                         |\r\n| MONTHNAME               | è·å–æŒ‡å®šæ—¥æœŸä¸­çš„æœˆä»½è‹±æ–‡åç§°                                 |\r\n| DAYNAME                 | è·å–æŒ‡å®šæ›°æœŸå¯¹åº”çš„æ˜ŸæœŸå‡ çš„è‹±æ–‡åç§°                           |\r\n| DAYOFWEEK               | è·å–æŒ‡å®šæ—¥æœŸå¯¹åº”çš„ä¸€å‘¨çš„ç´¢å¼•ä½ç½®å€¼                           |\r\n| WEEK                    | è·å–æŒ‡å®šæ—¥æœŸæ˜¯ä¸€å¹´ä¸­çš„ç¬¬å‡ å‘¨ï¼Œè¿”å›å€¼çš„èŒƒå›´æ˜¯å¦ä¸º 0ã€œ52 æˆ– 1ã€œ53 |\r\n| DAYOFYEAR               | è·å–æŒ‡å®šæ›°æœŸæ˜¯ä¸€å¹´ä¸­çš„ç¬¬å‡ å¤©ï¼Œè¿”å›å€¼èŒƒå›´æ˜¯1~366              |\r\n| DAYOFMONTH              | è·å–æŒ‡å®šæ—¥æœŸæ˜¯ä¸€ä¸ªæœˆä¸­æ˜¯ç¬¬å‡ å¤©ï¼Œè¿”å›å€¼èŒƒå›´æ˜¯1~31             |\r\n| YEAR                    | è·å–å¹´ä»½ï¼Œè¿”å›å€¼èŒƒå›´æ˜¯ 1970ã€œ2069                            |\r\n| TIME_TO_SEC             | å°†æ—¶é—´å‚æ•°è½¬æ¢ä¸ºç§’æ•°                                         |\r\n| SEC_TO_TIME             | å°†ç§’æ•°è½¬æ¢ä¸ºæ—¶é—´ï¼Œä¸TIME_TO_SEC äº’ä¸ºåå‡½æ•°                   |\r\n| DATE_ADD å’Œ ADDDATE     | ä¸¤ä¸ªå‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œéƒ½æ˜¯å‘æ—¥æœŸæ·»åŠ æŒ‡å®šçš„æ—¶é—´é—´éš”               |\r\n| DATE_SUB å’Œ SUBDATE     | ä¸¤ä¸ªå‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œéƒ½æ˜¯å‘æ—¥æœŸå‡å»æŒ‡å®šçš„æ—¶é—´é—´éš”               |\r\n| ADDTIME                 | æ—¶é—´åŠ æ³•è¿ç®—ï¼Œåœ¨åŸå§‹æ—¶é—´ä¸Šæ·»åŠ æŒ‡å®šçš„æ—¶é—´                     |\r\n| SUBTIME                 | æ—¶é—´å‡æ³•è¿ç®—ï¼Œåœ¨åŸå§‹æ—¶é—´ä¸Šå‡å»æŒ‡å®šçš„æ—¶é—´                     |\r\n| DATEDIFF                | è·å–ä¸¤ä¸ªæ—¥æœŸä¹‹é—´é—´éš”ï¼Œè¿”å›å‚æ•° 1 å‡å»å‚æ•° 2 çš„å€¼             |\r\n| DATE_FORMAT             | æ ¼å¼åŒ–æŒ‡å®šçš„æ—¥æœŸï¼Œæ ¹æ®å‚æ•°è¿”å›æŒ‡å®šæ ¼å¼çš„å€¼                   |\r\n| WEEKDAY                 | è·å–æŒ‡å®šæ—¥æœŸåœ¨ä¸€å‘¨å†…çš„å¯¹åº”çš„å·¥ä½œæ—¥ç´¢å¼•                       |\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### æ­£åˆ™æŸ¥è¯¢\r\n\r\næ­£åˆ™è¡¨è¾¾å¼ï¼ˆRegular Expressionï¼‰æ˜¯æŒ‡ä¸€ä¸ªç”¨æ¥æè¿°æˆ–è€…åŒ¹é…ä¸€ç³»åˆ—ç¬¦åˆæŸä¸ªå¥æ³•è§„åˆ™çš„å­—ç¬¦ä¸²çš„å•ä¸ªå­—ç¬¦ä¸²\r\n\r\n```sql\r\nSELECT * FROM emp WHERE name REGEXP '^T';\t-- åŒ¹é…ä»¥Tå¼€å¤´çš„nameå€¼\r\nSELECT * FROM emp WHERE name REGEXP '2$';\t-- åŒ¹é…ä»¥2ç»“å°¾çš„nameå€¼\r\nSELECT * FROM emp WHERE name REGEXP '[uvw]';-- åŒ¹é…åŒ…å« uvw çš„nameå€¼\r\n```\r\n\r\n| ç¬¦å·   | å«ä¹‰                          |\r\n| ------ | ----------------------------- |\r\n| ^      | åœ¨å­—ç¬¦ä¸²å¼€å§‹å¤„è¿›è¡ŒåŒ¹é…        |\r\n| $      | åœ¨å­—ç¬¦ä¸²æœ«å°¾å¤„è¿›è¡ŒåŒ¹é…        |\r\n| .      | åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦, åŒ…æ‹¬æ¢è¡Œç¬¦  |\r\n| [...]  | åŒ¹é…å‡ºæ‹¬å·å†…çš„ä»»æ„å­—ç¬¦        |\r\n| [^...] | åŒ¹é…ä¸å‡ºæ‹¬å·å†…çš„ä»»æ„å­—ç¬¦      |\r\n| a*     | åŒ¹é…é›¶ä¸ªæˆ–è€…å¤šä¸ªa(åŒ…æ‹¬ç©ºä¸²)   |\r\n| a+     | åŒ¹é…ä¸€ä¸ªæˆ–è€…å¤šä¸ªa(ä¸åŒ…æ‹¬ç©ºä¸²) |\r\n| a?     | åŒ¹é…é›¶ä¸ªæˆ–è€…ä¸€ä¸ªa             |\r\n| a1\\|a2 | åŒ¹é…a1æˆ–a2                    |\r\n| a(m)   | åŒ¹é…mä¸ªa                      |\r\n| a(m,)  | è‡³å°‘åŒ¹é…mä¸ªa                  |\r\n| a(m,n) | åŒ¹é…mä¸ªa åˆ° nä¸ªa              |\r\n| a(,n)  | åŒ¹é…0åˆ°nä¸ªa                   |\r\n| (...)  | å°†æ¨¡å¼å…ƒç´ ç»„æˆå•ä¸€å…ƒç´         |\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æ’åºæŸ¥è¯¢\r\n\r\n* æ’åºæŸ¥è¯¢è¯­æ³•\r\n\r\n  ```sql\r\n  SELECT åˆ—å FROM è¡¨å [WHERE æ¡ä»¶] ORDER BY åˆ—å1 æ’åºæ–¹å¼1,åˆ—å2 æ’åºæ–¹å¼2;\r\n  ```\r\n\r\n* æ’åºæ–¹å¼\r\n\r\n  ```sql\r\n  ASC:å‡åº\r\n  DESC:é™åº\r\n  ```\r\n\r\n  æ³¨æ„ï¼šå¤šä¸ªæ’åºæ¡ä»¶ï¼Œå½“å‰è¾¹çš„æ¡ä»¶å€¼ä¸€æ ·æ—¶ï¼Œæ‰ä¼šåˆ¤æ–­ç¬¬äºŒæ¡ä»¶\r\n\r\n* ä¾‹å¦‚\r\n\r\n  ```sql\r\n  -- æŒ‰ç…§åº“å­˜å‡åºæ’åº\r\n  SELECT * FROM product ORDER BY stock ASC;\r\n  \r\n  -- æŸ¥è¯¢åç§°ä¸­åŒ…å«æ‰‹æœºçš„å•†å“ä¿¡æ¯ã€‚æŒ‰ç…§é‡‘é¢é™åºæ’åº\r\n  SELECT * FROM product WHERE NAME LIKE '%æ‰‹æœº%' ORDER BY price DESC;\r\n  \r\n  -- æŒ‰ç…§é‡‘é¢å‡åºæ’åºï¼Œå¦‚æœé‡‘é¢ç›¸åŒï¼ŒæŒ‰ç…§åº“å­˜é™åºæ’åˆ—\r\n  SELECT * FROM product ORDER BY price ASC,stock DESC;\r\n  ```\r\n\r\n  \r\n\r\n***\r\n\r\n\r\n\r\n#### åˆ†ç»„æŸ¥è¯¢\r\n\r\nåˆ†ç»„æŸ¥è¯¢ä¼šè¿›è¡Œå»é‡\r\n\r\n* åˆ†ç»„æŸ¥è¯¢è¯­æ³•\r\n\r\n  ````sql\r\n  SELECT åˆ—å FROM è¡¨å [WHERE æ¡ä»¶] GROUP BY åˆ†ç»„åˆ—å [HAVING åˆ†ç»„åæ¡ä»¶è¿‡æ»¤] [ORDER BY æ’åºåˆ—å æ’åºæ–¹å¼];\r\n  ````\r\n\r\n  WHERE è¿‡æ»¤è¡Œï¼ŒHAVING è¿‡æ»¤åˆ†ç»„ï¼Œè¡Œè¿‡æ»¤åº”å½“å…ˆäºåˆ†ç»„è¿‡æ»¤\r\n\r\n  åˆ†ç»„è§„å®šï¼š\r\n\r\n  * GROUP BY å­å¥å‡ºç°åœ¨ WHERE å­å¥ä¹‹åï¼ŒORDER BY å­å¥ä¹‹å‰\r\n  * NULL çš„è¡Œä¼šå•ç‹¬åˆ†ä¸ºä¸€ç»„\r\n  * å¤§å¤šæ•° SQL å®ç°ä¸æ”¯æŒ GROUP BY åˆ—å…·æœ‰å¯å˜é•¿åº¦çš„æ•°æ®ç±»å‹\r\n\r\n* ä¾‹å¦‚\r\n\r\n  ```sql\r\n  -- æŒ‰ç…§å“ç‰Œåˆ†ç»„ï¼Œè·å–æ¯ç»„å•†å“çš„æ€»é‡‘é¢\r\n  SELECT brand,SUM(price) FROM product GROUP BY brand;\r\n  \r\n  -- å¯¹é‡‘é¢å¤§äº4000å…ƒçš„å•†å“ï¼ŒæŒ‰ç…§å“ç‰Œåˆ†ç»„,è·å–æ¯ç»„å•†å“çš„æ€»é‡‘é¢\r\n  SELECT brand,SUM(price) FROM product WHERE price > 4000 GROUP BY brand;\r\n  \r\n  -- å¯¹é‡‘é¢å¤§äº4000å…ƒçš„å•†å“ï¼ŒæŒ‰ç…§å“ç‰Œåˆ†ç»„ï¼Œè·å–æ¯ç»„å•†å“çš„æ€»é‡‘é¢ï¼Œåªæ˜¾ç¤ºæ€»é‡‘é¢å¤§äº7000å…ƒçš„\r\n  SELECT brand,SUM(price) AS getSum FROM product WHERE price > 4000 GROUP BY brand HAVING getSum > 7000;\r\n  \r\n  -- å¯¹é‡‘é¢å¤§äº4000å…ƒçš„å•†å“ï¼ŒæŒ‰ç…§å“ç‰Œåˆ†ç»„ï¼Œè·å–æ¯ç»„å•†å“çš„æ€»é‡‘é¢ï¼Œåªæ˜¾ç¤ºæ€»é‡‘é¢å¤§äº7000å…ƒçš„ã€å¹¶æŒ‰ç…§æ€»é‡‘é¢çš„é™åºæ’åˆ—\r\n  SELECT brand,SUM(price) AS getSum FROM product WHERE price > 4000 GROUP BY brand HAVING getSum > 7000 ORDER BY getSum DESC;\r\n  ```\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åˆ†é¡µæŸ¥è¯¢\r\n\r\n* åˆ†é¡µæŸ¥è¯¢è¯­æ³•\r\n\r\n  ```sql\r\n  SELECT åˆ—å FROM è¡¨å [WHERE æ¡ä»¶] GROUP BY åˆ†ç»„åˆ—å [HAVING åˆ†ç»„åæ¡ä»¶è¿‡æ»¤] [ORDER BY æ’åºåˆ—å æ’åºæ–¹å¼] LIMIT å¼€å§‹ç´¢å¼•,æŸ¥è¯¢æ¡æ•°;\r\n  ```\r\n\r\n* å…¬å¼ï¼šå¼€å§‹ç´¢å¼• = (å½“å‰é¡µç -1) * æ¯é¡µæ˜¾ç¤ºçš„æ¡æ•°\r\n\r\n* ä¾‹å¦‚\r\n\r\n  ```sql\r\n  SELECT * FROM product LIMIT 0,2;  -- ç¬¬ä¸€é¡µ å¼€å§‹ç´¢å¼•=(1-1) * 2\r\n  SELECT * FROM product LIMIT 2,2;  -- ç¬¬äºŒé¡µ å¼€å§‹ç´¢å¼•=(2-1) * 2\r\n  SELECT * FROM product LIMIT 4,2;  -- ç¬¬ä¸‰é¡µ å¼€å§‹ç´¢å¼•=(3-1) * 2\r\n  SELECT * FROM product LIMIT 6,2;  -- ç¬¬å››é¡µ å¼€å§‹ç´¢å¼•=(4-1) * 2\r\n  ```\r\n\r\n  ![image-20250320013830640](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013830640.png)\r\n\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n\r\n\r\n## å¤šè¡¨æ“ä½œ\r\n\r\n### çº¦æŸåˆ†ç±»\r\n\r\n#### çº¦æŸä»‹ç»\r\n\r\nçº¦æŸï¼šå¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œé™å®šï¼Œä¿è¯æ•°æ®çš„æ­£ç¡®æ€§ã€æœ‰æ•ˆæ€§ã€å®Œæ•´æ€§\r\n\r\nçº¦æŸçš„åˆ†ç±»ï¼š\r\n\r\n| çº¦æŸ                          | è¯´æ˜           |\r\n| ----------------------------- | -------------- |\r\n| PRIMARY KEY                   | ä¸»é”®çº¦æŸ       |\r\n| PRIMARY KEY AUTO_INCREMENT    | ä¸»é”®ã€è‡ªåŠ¨å¢é•¿ |\r\n| UNIQUE                        | å”¯ä¸€çº¦æŸ       |\r\n| NOT NULL                      | éç©ºçº¦æŸ       |\r\n| FOREIGN KEY                   | å¤–é”®çº¦æŸ       |\r\n| FOREIGN KEY ON UPDATE CASCADE | å¤–é”®çº§è”æ›´æ–°   |\r\n| FOREIGN KEY ON DELETE CASCADE | å¤–é”®çº§è”åˆ é™¤   |\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä¸»é”®çº¦æŸ\r\n\r\n* ä¸»é”®çº¦æŸç‰¹ç‚¹ï¼š\r\n\r\n  * ä¸»é”®çº¦æŸé»˜è®¤åŒ…å«**éç©ºå’Œå”¯ä¸€**ä¸¤ä¸ªåŠŸèƒ½\r\n  * ä¸€å¼ è¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®\r\n  * ä¸»é”®ä¸€èˆ¬ç”¨äºè¡¨ä¸­æ•°æ®çš„å”¯ä¸€æ ‡è¯†\r\n\r\n* å»ºè¡¨æ—¶æ·»åŠ ä¸»é”®çº¦æŸ\r\n\r\n  ```sql\r\n  CREATE TABLE è¡¨å(\r\n  \tåˆ—å æ•°æ®ç±»å‹ PRIMARY KEY,\r\n      åˆ—å æ•°æ®ç±»å‹,\r\n      ...\r\n  );\r\n  ```\r\n\r\n* åˆ é™¤ä¸»é”®çº¦æŸ\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å DROP PRIMARY KEY;\r\n  ```\r\n\r\n* å»ºè¡¨åå•ç‹¬æ·»åŠ ä¸»é”®çº¦æŸ\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹ PRIMARY KEY;\r\n  ```\r\n\r\n* ä¾‹å¦‚\r\n\r\n  ```sql\r\n  -- åˆ›å»ºstudentè¡¨\r\n  CREATE TABLE student(\r\n  \tid INT PRIMARY KEY  -- ç»™idæ·»åŠ ä¸»é”®çº¦æŸ\r\n  );\r\n  \r\n  -- æ·»åŠ æ•°æ®\r\n  INSERT INTO student VALUES (1),(2);\r\n  -- ä¸»é”®é»˜è®¤å”¯ä¸€ï¼Œæ·»åŠ é‡å¤æ•°æ®ï¼Œä¼šæŠ¥é”™\r\n  INSERT INTO student VALUES (2);\r\n  -- ä¸»é”®é»˜è®¤éç©ºï¼Œä¸èƒ½æ·»åŠ nullçš„æ•°æ®\r\n  INSERT INTO student VALUES (NULL);\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä¸»é”®è‡ªå¢\r\n\r\nä¸»é”®è‡ªå¢çº¦æŸå¯ä»¥ä¸ºç©ºï¼Œå¹¶è‡ªåŠ¨å¢é•¿ã€‚åˆ é™¤æŸæ¡æ•°æ®ä¸å½±å“è‡ªå¢çš„ä¸‹ä¸€ä¸ªæ•°å€¼ï¼Œä¾ç„¶æŒ‰ç…§å‰ä¸€ä¸ªå€¼è‡ªå¢\r\n\r\n* å»ºè¡¨æ—¶æ·»åŠ ä¸»é”®è‡ªå¢çº¦æŸ\r\n\r\n  ```sql\r\n  CREATE TABLE è¡¨å(\r\n  \tåˆ—å æ•°æ®ç±»å‹ PRIMARY KEY AUTO_INCREMENT,\r\n      åˆ—å æ•°æ®ç±»å‹,\r\n      ...\r\n  );\r\n  ```\r\n\r\n* åˆ é™¤ä¸»é”®è‡ªå¢çº¦æŸ\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹;\r\n  ```\r\n\r\n* å»ºè¡¨åå•ç‹¬æ·»åŠ ä¸»é”®è‡ªå¢çº¦æŸ\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹ AUTO_INCREMENT;\r\n  ```\r\n\r\n* ä¾‹å¦‚\r\n\r\n  ```sql\r\n  -- åˆ›å»ºstudent2è¡¨\r\n  CREATE TABLE student2(\r\n  \tid INT PRIMARY KEY AUTO_INCREMENT    -- ç»™idæ·»åŠ ä¸»é”®è‡ªå¢çº¦æŸ\r\n  );\r\n  \r\n  -- æ·»åŠ æ•°æ®\r\n  INSERT INTO student2 VALUES (1),(2);\r\n  -- æ·»åŠ nullå€¼ï¼Œä¼šè‡ªåŠ¨å¢é•¿\r\n  INSERT INTO student2 VALUES (NULL),(NULL);-- 3ï¼Œ4\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å”¯ä¸€çº¦æŸ\r\n\r\nå”¯ä¸€çº¦æŸï¼šçº¦æŸä¸èƒ½æœ‰é‡å¤çš„æ•°æ®\r\n\r\n* å»ºè¡¨æ—¶æ·»åŠ å”¯ä¸€çº¦æŸ\r\n\r\n  ```sql\r\n  CREATE TABLE è¡¨å(\r\n  \tåˆ—å æ•°æ®ç±»å‹ UNIQUE,\r\n      åˆ—å æ•°æ®ç±»å‹,\r\n      ...\r\n  );\r\n  ```\r\n\r\n* åˆ é™¤å”¯ä¸€çº¦æŸ\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å DROP INDEX åˆ—å;\r\n  ```\r\n\r\n* å»ºè¡¨åå•ç‹¬æ·»åŠ å”¯ä¸€çº¦æŸ\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹ UNIQUE;\r\n  ```\r\n\r\n  \r\n\r\n***\r\n\r\n\r\n\r\n#### éç©ºçº¦æŸ\r\n\r\n* å»ºè¡¨æ—¶æ·»åŠ éç©ºçº¦æŸ\r\n\r\n  ```sql\r\n  CREATE TABLE è¡¨å(\r\n  \tåˆ—å æ•°æ®ç±»å‹ NOT NULL,\r\n      åˆ—å æ•°æ®ç±»å‹,\r\n      ...\r\n  );\r\n  ```\r\n\r\n* åˆ é™¤éç©ºçº¦æŸ\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹;\r\n  ```\r\n\r\n* å»ºè¡¨åå•ç‹¬æ·»åŠ éç©ºçº¦æŸ\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹ NOT NULL;\r\n  ```\r\n\r\n \r\n\r\n***\r\n\r\n\r\n\r\n#### å¤–é”®çº¦æŸ\r\n\r\n  å¤–é”®çº¦æŸï¼šè®©è¡¨å’Œè¡¨ä¹‹é—´äº§ç”Ÿå…³ç³»ï¼Œä»è€Œä¿è¯æ•°æ®çš„å‡†ç¡®æ€§\r\n\r\n* å»ºè¡¨æ—¶æ·»åŠ å¤–é”®çº¦æŸ\r\n\r\n  ```sql\r\n  CREATE TABLE è¡¨å(\r\n  \tåˆ—å æ•°æ®ç±»å‹ çº¦æŸ,\r\n      ...\r\n      CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»è¡¨ä¸»é”®åˆ—å)\r\n  );\r\n  ```\r\n\r\n* åˆ é™¤å¤–é”®çº¦æŸ\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å DROP FOREIGN KEY å¤–é”®å;\r\n  ```\r\n\r\n* å»ºè¡¨åå•ç‹¬æ·»åŠ å¤–é”®çº¦æŸ\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å ADD CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»è¡¨ä¸»é”®åˆ—å);\r\n  ```\r\n\r\n* ä¾‹å¦‚\r\n\r\n  ```sql\r\n  -- åˆ›å»ºuserç”¨æˆ·è¡¨\r\n  CREATE TABLE USER(\r\n  \tid INT PRIMARY KEY AUTO_INCREMENT,    -- id\r\n  \tname VARCHAR(20) NOT NULL             -- å§“å\r\n  );\r\n  -- æ·»åŠ ç”¨æˆ·æ•°æ®\r\n  INSERT INTO USER VALUES (NULL,'å¼ ä¸‰'),(NULL,'æå››'),(NULL,'ç‹äº”');\r\n  \r\n  -- åˆ›å»ºorderlistè®¢å•è¡¨\r\n  CREATE TABLE orderlist(\r\n  \tid INT PRIMARY KEY AUTO_INCREMENT,    -- id\r\n  \tnumber VARCHAR(20) NOT NULL,          -- è®¢å•ç¼–å·\r\n  \tuid INT,                              -- è®¢å•æ‰€å±ç”¨æˆ·\r\n  \tCONSTRAINT ou_fk1 FOREIGN KEY (uid) REFERENCES USER(id)   -- æ·»åŠ å¤–é”®çº¦æŸ\r\n  );\r\n  -- æ·»åŠ è®¢å•æ•°æ®\r\n  INSERT INTO orderlist VALUES (NULL,'hm001',1),(NULL,'hm002',1),\r\n  (NULL,'hm003',2),(NULL,'hm004',2),\r\n  (NULL,'hm005',3),(NULL,'hm006',3);\r\n  \r\n  -- æ·»åŠ ä¸€ä¸ªè®¢å•ï¼Œä½†æ˜¯æ²¡æœ‰æ‰€å±ç”¨æˆ·ã€‚æ— æ³•æ·»åŠ \r\n  INSERT INTO orderlist VALUES (NULL,'hm007',8);\r\n  -- åˆ é™¤ç‹äº”è¿™ä¸ªç”¨æˆ·ï¼Œä½†æ˜¯è®¢å•è¡¨ä¸­ç‹äº”è¿˜æœ‰å¾ˆå¤šä¸ªè®¢å•å‘¢ã€‚æ— æ³•åˆ é™¤\r\n  DELETE FROM USER WHERE NAME='ç‹äº”';\r\n  ```\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å¤–é”®çº§è”\r\n\r\nçº§è”æ“ä½œï¼šå½“æŠŠä¸»è¡¨ä¸­çš„æ•°æ®è¿›è¡Œåˆ é™¤æˆ–æ›´æ–°æ—¶ï¼Œä»è¡¨ä¸­æœ‰å…³è”çš„æ•°æ®çš„ç›¸åº”æ“ä½œï¼ŒåŒ…æ‹¬ RESTRICTã€CASCADEã€SET NULL å’Œ NO ACTION\r\n\r\n* RESTRICT å’Œ NO ACTIONç›¸åŒï¼Œ æ˜¯æŒ‡é™åˆ¶åœ¨å­è¡¨æœ‰å…³è”è®°å½•çš„æƒ…å†µä¸‹ï¼Œ çˆ¶è¡¨ä¸èƒ½æ›´æ–°\r\n\r\n* CASCADE è¡¨ç¤ºçˆ¶è¡¨åœ¨æ›´æ–°æˆ–è€…åˆ é™¤æ—¶ï¼Œæ›´æ–°æˆ–è€…åˆ é™¤å­è¡¨å¯¹åº”çš„è®°å½•\r\n\r\n* SET NULL åˆ™è¡¨ç¤ºçˆ¶è¡¨åœ¨æ›´æ–°æˆ–è€…åˆ é™¤çš„æ—¶å€™ï¼Œå­è¡¨çš„å¯¹åº”å­—æ®µè¢«SET NULL\r\n\r\nçº§è”æ“ä½œï¼š\r\n\r\n* æ·»åŠ çº§è”æ›´æ–°\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å ADD CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»è¡¨ä¸»é”®åˆ—å) ON UPDATE [CASCADE | RESTRICT | SET NULL];\r\n  ```\r\n\r\n* æ·»åŠ çº§è”åˆ é™¤\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å ADD CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»è¡¨ä¸»é”®åˆ—å) ON DELETE CASCADE;\r\n  ```\r\n\r\n* åŒæ—¶æ·»åŠ çº§è”æ›´æ–°å’Œçº§è”åˆ é™¤\r\n\r\n  ```sql\r\n  ALTER TABLE è¡¨å ADD CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»è¡¨ä¸»é”®åˆ—å) ON UPDATE CASCADE ON DELETE CASCADE;\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n\r\n\r\n### å¤šè¡¨è®¾è®¡\r\n\r\n#### ä¸€å¯¹ä¸€\r\n\r\nå¤šè¡¨ï¼šæœ‰å¤šå¼ æ•°æ®è¡¨ï¼Œè€Œè¡¨ä¸è¡¨ä¹‹é—´æœ‰ä¸€å®šçš„å…³è”å…³ç³»ï¼Œé€šè¿‡å¤–é”®çº¦æŸå®ç°ï¼Œåˆ†ä¸ºä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šä¸‰ç±»\r\n\r\nä¸¾ä¾‹ï¼šäººå’Œèº«ä»½è¯\r\n\r\nå®ç°åŸåˆ™ï¼šåœ¨ä»»æ„ä¸€ä¸ªè¡¨å»ºç«‹å¤–é”®ï¼Œå»å…³è”å¦å¤–ä¸€ä¸ªè¡¨çš„ä¸»é”®\r\n\r\n```sql\r\n-- åˆ›å»ºpersonè¡¨\r\nCREATE TABLE person(\r\n\tid INT PRIMARY KEY AUTO_INCREMENT,\t-- ä¸»é”®id\r\n\tNAME VARCHAR(20)                        -- å§“å\r\n);\r\n-- æ·»åŠ æ•°æ®\r\nINSERT INTO person VALUES (NULL,'å¼ ä¸‰'),(NULL,'æå››');\r\n\r\n-- åˆ›å»ºcardè¡¨\r\nCREATE TABLE card(\r\n\tid INT PRIMARY KEY AUTO_INCREMENT,\t-- ä¸»é”®id\r\n\tnumber VARCHAR(20) UNIQUE NOT NULL,\t-- èº«ä»½è¯å·\r\n\tpid INT UNIQUE,                         -- å¤–é”®åˆ—\r\n\tCONSTRAINT cp_fk1 FOREIGN KEY (pid) REFERENCES person(id)\r\n);\r\n-- æ·»åŠ æ•°æ®\r\nINSERT INTO card VALUES (NULL,'12345',1),(NULL,'56789',2);\r\n```\r\n\r\n![image-20250320013856202](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013856202.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä¸€å¯¹å¤š\r\n\r\nä¸¾ä¾‹ï¼šç”¨æˆ·å’Œè®¢å•ã€å•†å“åˆ†ç±»å’Œå•†å“\r\n\r\nå®ç°åŸåˆ™ï¼šåœ¨å¤šçš„ä¸€æ–¹ï¼Œå»ºç«‹å¤–é”®çº¦æŸï¼Œæ¥å…³è”ä¸€çš„ä¸€æ–¹ä¸»é”®\r\n\r\n```sql\r\n-- åˆ›å»ºuserè¡¨\r\nCREATE TABLE USER(\r\n\tid INT PRIMARY KEY AUTO_INCREMENT,\t-- ä¸»é”®id\r\n\tNAME VARCHAR(20)                        -- å§“å\r\n);\r\n-- æ·»åŠ æ•°æ®\r\nINSERT INTO USER VALUES (NULL,'å¼ ä¸‰'),(NULL,'æå››');\r\n\r\n-- åˆ›å»ºorderlistè¡¨\r\nCREATE TABLE orderlist(\r\n\tid INT PRIMARY KEY AUTO_INCREMENT,\t-- ä¸»é”®id\r\n\tnumber VARCHAR(20),                     -- è®¢å•ç¼–å·\r\n\tuid INT,\t\t\t\t-- å¤–é”®åˆ—\r\n\tCONSTRAINT ou_fk1 FOREIGN KEY (uid) REFERENCES USER(id)\r\n);\r\n-- æ·»åŠ æ•°æ®\r\nINSERT INTO orderlist VALUES (NULL,'hm001',1),(NULL,'hm002',1),(NULL,'hm003',2),(NULL,'hm004',2);\r\n```\r\n\r\n![image-20250320013919866](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013919866.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å¤šå¯¹å¤š\r\n\r\nä¸¾ä¾‹ï¼šå­¦ç”Ÿå’Œè¯¾ç¨‹ã€‚ä¸€ä¸ªå­¦ç”Ÿå¯ä»¥é€‰æ‹©å¤šä¸ªè¯¾ç¨‹ï¼Œä¸€ä¸ªè¯¾ç¨‹ä¹Ÿå¯ä»¥è¢«å¤šä¸ªå­¦ç”Ÿé€‰æ‹©\r\n\r\nå®ç°åŸåˆ™ï¼šå€ŸåŠ©ç¬¬ä¸‰å¼ è¡¨ä¸­é—´è¡¨ï¼Œä¸­é—´è¡¨è‡³å°‘åŒ…å«ä¸¤ä¸ªåˆ—ï¼Œè¿™ä¸¤ä¸ªåˆ—ä½œä¸ºä¸­é—´è¡¨çš„å¤–é”®ï¼Œåˆ†åˆ«å…³è”ä¸¤å¼ è¡¨çš„ä¸»é”®\r\n\r\n```sql\r\n-- åˆ›å»ºstudentè¡¨\r\nCREATE TABLE student(\r\n\tid INT PRIMARY KEY AUTO_INCREMENT,\t-- ä¸»é”®id\r\n\tNAME VARCHAR(20)\t\t\t-- å­¦ç”Ÿå§“å\r\n);\r\n-- æ·»åŠ æ•°æ®\r\nINSERT INTO student VALUES (NULL,'å¼ ä¸‰'),(NULL,'æå››');\r\n\r\n-- åˆ›å»ºcourseè¡¨\r\nCREATE TABLE course(\r\n\tid INT PRIMARY KEY AUTO_INCREMENT,\t-- ä¸»é”®id\r\n\tNAME VARCHAR(10)\t\t\t-- è¯¾ç¨‹åç§°\r\n);\r\n-- æ·»åŠ æ•°æ®\r\nINSERT INTO course VALUES (NULL,'è¯­æ–‡'),(NULL,'æ•°å­¦');\r\n\r\n-- åˆ›å»ºä¸­é—´è¡¨\r\nCREATE TABLE stu_course(\r\n\tid INT PRIMARY KEY AUTO_INCREMENT,\t-- ä¸»é”®id\r\n\tsid INT,  -- ç”¨äºå’Œstudentè¡¨ä¸­çš„idè¿›è¡Œå¤–é”®å…³è”\r\n\tcid INT,  -- ç”¨äºå’Œcourseè¡¨ä¸­çš„idè¿›è¡Œå¤–é”®å…³è”\r\n\tCONSTRAINT sc_fk1 FOREIGN KEY (sid) REFERENCES student(id), -- æ·»åŠ å¤–é”®çº¦æŸ\r\n\tCONSTRAINT sc_fk2 FOREIGN KEY (cid) REFERENCES course(id)   -- æ·»åŠ å¤–é”®çº¦æŸ\r\n);\r\n-- æ·»åŠ æ•°æ®\r\nINSERT INTO stu_course VALUES (NULL,1,1),(NULL,1,2),(NULL,2,1),(NULL,2,2);\r\n```\r\n\r\n![image-20250320013934976](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013934976.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### è¿æ¥æŸ¥è¯¢\r\n\r\n#### å†…å¤–è¿æ¥\r\n\r\n##### å†…è¿æ¥\r\n\r\nè¿æ¥æŸ¥è¯¢çš„æ˜¯ä¸¤å¼ è¡¨æœ‰äº¤é›†çš„éƒ¨åˆ†æ•°æ®ï¼Œä¸¤å¼ è¡¨åˆ†ä¸º**é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨**ï¼Œå¦‚æœç»“æœé›†ä¸­çš„æ¯æ¡è®°å½•éƒ½æ˜¯ä¸¤ä¸ªè¡¨ç›¸äº’åŒ¹é…çš„ç»„åˆï¼Œåˆ™ç§°è¿™æ ·çš„ç»“æœé›†ä¸ºç¬›å¡å°”ç§¯\r\n\r\nå†…è¿æ¥æŸ¥è¯¢ï¼Œè‹¥é©±åŠ¨è¡¨ä¸­çš„è®°å½•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾ä¸åˆ°åŒ¹é…çš„è®°å½•æ—¶ï¼Œåˆ™è¯¥è®°å½•ä¸ä¼šåŠ åˆ°æœ€åçš„ç»“æœé›†\r\n\r\n* æ˜¾å¼å†…è¿æ¥ï¼š\r\n\r\n  ```sql\r\n  SELECT åˆ—å FROM è¡¨å1 [INNER] JOIN è¡¨å2 ON æ¡ä»¶;\r\n  ```\r\n\r\n* éšå¼å†…è¿æ¥ï¼šå†…è¿æ¥ä¸­ WHERE å­å¥å’Œ ON å­å¥æ˜¯ç­‰ä»·çš„\r\n\r\n  ```sql\r\n  SELECT åˆ—å FROM è¡¨å1,è¡¨å2 WHERE æ¡ä»¶;\r\n  ```\r\n\r\nSTRAIGHT_JOINä¸ JOIN ç±»ä¼¼ï¼Œåªä¸è¿‡å·¦è¡¨å§‹ç»ˆåœ¨å³è¡¨ä¹‹å‰è¯»å–ï¼Œåªé€‚ç”¨äºå†…è¿æ¥\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å¤–è¿æ¥\r\n\r\nå¤–è¿æ¥æŸ¥è¯¢ï¼Œè‹¥é©±åŠ¨è¡¨ä¸­çš„è®°å½•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾ä¸åˆ°åŒ¹é…çš„è®°å½•æ—¶ï¼Œåˆ™è¯¥è®°å½•ä¹Ÿä¼šåŠ åˆ°æœ€åçš„ç»“æœé›†ï¼Œåªæ˜¯å¯¹äºè¢«é©±åŠ¨è¡¨ä¸­**ä¸åŒ¹é…è¿‡æ»¤æ¡ä»¶**çš„è®°å½•ï¼Œå„ä¸ªå­—æ®µä½¿ç”¨ NULL å¡«å……\r\n\r\nåº”ç”¨å®ä¾‹ï¼šæŸ¥å­¦ç”Ÿæˆç»©ï¼Œä¹Ÿæƒ³å±•ç¤ºå‡ºç¼ºè€ƒçš„äººçš„æˆç»©\r\n\r\n* å·¦å¤–è¿æ¥ï¼šé€‰æ‹©å·¦ä¾§çš„è¡¨ä¸ºé©±åŠ¨è¡¨ï¼ŒæŸ¥è¯¢å·¦è¡¨çš„å…¨éƒ¨æ•°æ®ï¼Œå’Œå·¦å³ä¸¤å¼ è¡¨æœ‰äº¤é›†éƒ¨åˆ†çš„æ•°æ®\r\n\r\n  ```sql\r\n  SELECT åˆ—å FROM è¡¨å1 LEFT [OUTER] JOIN è¡¨å2 ON æ¡ä»¶;\r\n  ```\r\n\r\n* å³å¤–è¿æ¥ï¼šé€‰æ‹©å³ä¾§çš„è¡¨ä¸ºé©±åŠ¨è¡¨ï¼ŒæŸ¥è¯¢å³è¡¨çš„å…¨éƒ¨æ•°æ®ï¼Œå’Œå·¦å³ä¸¤å¼ è¡¨æœ‰äº¤é›†éƒ¨åˆ†çš„æ•°æ®\r\n\r\n  ```sql\r\n  SELECT åˆ—å FROM è¡¨å1 RIGHT [OUTER] JOIN è¡¨å2 ON æ¡ä»¶;\r\n  ```\r\n\r\n![image-20250320014019945](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320014019945.png)\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n\r\n\r\n#### å…³è”æŸ¥è¯¢\r\n\r\nè‡ªå…³è”æŸ¥è¯¢ï¼šåŒä¸€å¼ è¡¨ä¸­æœ‰æ•°æ®å…³è”ï¼Œå¯ä»¥å¤šæ¬¡æŸ¥è¯¢è¿™åŒä¸€ä¸ªè¡¨\r\n\r\n* æ•°æ®å‡†å¤‡\r\n\r\n  ```sql\r\n  -- åˆ›å»ºå‘˜å·¥è¡¨\r\n  CREATE TABLE employee(\r\n  \tid INT PRIMARY KEY AUTO_INCREMENT,\t-- å‘˜å·¥ç¼–å·\r\n  \tNAME VARCHAR(20),\t\t\t\t\t-- å‘˜å·¥å§“å\r\n  \tmgr INT,\t\t\t\t\t\t\t-- ä¸Šçº§ç¼–å·\r\n  \tsalary DOUBLE\t\t\t\t\t\t-- å‘˜å·¥å·¥èµ„\r\n  );\r\n  -- æ·»åŠ æ•°æ®\r\n  INSERT INTO employee VALUES (1001,'å­™æ‚Ÿç©º',1005,9000.00),..,(1009,'å®‹æ±Ÿ',NULL,16000.00);\r\n  ```\r\n  \r\n  ![image-20250320014040398](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320014040398.png)\r\n  \r\n* æ•°æ®æŸ¥è¯¢\r\n\r\n  ```sql\r\n  -- æŸ¥è¯¢æ‰€æœ‰å‘˜å·¥çš„å§“ååŠå…¶ç›´æ¥ä¸Šçº§çš„å§“åï¼Œæ²¡æœ‰ä¸Šçº§çš„å‘˜å·¥ä¹Ÿéœ€è¦æŸ¥è¯¢\r\n  /*\r\n  åˆ†æ\r\n  \tå‘˜å·¥ä¿¡æ¯ employeeè¡¨\r\n  \tæ¡ä»¶ï¼šemployee.mgr = employee.id\r\n  \tæŸ¥è¯¢å·¦è¡¨çš„å…¨éƒ¨æ•°æ®ï¼Œå’Œå·¦å³ä¸¤å¼ è¡¨æœ‰äº¤é›†éƒ¨åˆ†æ•°æ®ï¼Œå·¦å¤–è¿æ¥\r\n  */\r\n  SELECT\r\n  \te1.id,\r\n  \te1.name,\r\n  \te1.mgr,\r\n  \te2.id,\r\n  \te2.name\r\n  FROM\r\n  \temployee e1\r\n  LEFT OUTER JOIN\r\n  \temployee e2\r\n  ON\r\n  \te1.mgr = e2.id;\t\r\n  ```\r\n\r\n* æŸ¥è¯¢ç»“æœ\r\n\r\n  ```\r\n  id\t\tname\tmgr\t   id\t  name\r\n  1001\tå­™æ‚Ÿç©º\t  1005\t1005\tå”åƒ§\r\n  1002\tçŒªå…«æˆ’\t  1005\t1005\tå”åƒ§\r\n  1003\tæ²™å’Œå°š\t  1005\t1005\tå”åƒ§\r\n  1004\tå°ç™½é¾™\t  1005\t1005\tå”åƒ§\r\n  1005\tå”åƒ§\t   NULL\t NULL\t NULL\r\n  1006\tæ­¦æ¾\t   1009\t 1009\t å®‹æ±Ÿ\r\n  1007\tæé€µ\t   1009\t 1009\t å®‹æ±Ÿ\r\n  1008\tæ—å†²\t   1009\t 1009\t å®‹æ±Ÿ\r\n  1009\tå®‹æ±Ÿ\t   NULL\t NULL\t NULL\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### è¿æ¥åŸç†\r\n\r\nIndex Nested-Loop Join ç®—æ³•ï¼šæŸ¥è¯¢é©±åŠ¨è¡¨å¾—åˆ°**æ•°æ®é›†**ï¼Œç„¶åæ ¹æ®æ•°æ®é›†ä¸­çš„æ¯ä¸€æ¡è®°å½•çš„**å…³è”å­—æ®µå†åˆ†åˆ«**åˆ°è¢«é©±åŠ¨è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…ï¼ˆ**èµ°ç´¢å¼•**ï¼‰ï¼Œæ‰€ä»¥é©±åŠ¨è¡¨åªéœ€è¦è®¿é—®ä¸€æ¬¡ï¼Œè¢«é©±åŠ¨è¡¨è¦è®¿é—®å¤šæ¬¡\r\n\r\nMySQL å°†æŸ¥è¯¢é©±åŠ¨è¡¨åå¾—åˆ°çš„è®°å½•æˆä¸ºé©±åŠ¨è¡¨çš„æ‰‡å‡ºï¼Œè¿æ¥æŸ¥è¯¢çš„æˆæœ¬ï¼šå•æ¬¡è®¿é—®é©±åŠ¨è¡¨çš„æˆæœ¬ + æ‰‡å‡ºå€¼ * å•æ¬¡è®¿é—®è¢«é©±åŠ¨è¡¨çš„æˆæœ¬ï¼Œä¼˜åŒ–å™¨ä¼šé€‰æ‹©æˆæœ¬æœ€å°çš„è¡¨è¿æ¥é¡ºåºï¼ˆç¡®å®šè°æ˜¯é©±åŠ¨è¡¨ï¼Œè°æ˜¯è¢«é©±åŠ¨è¡¨ï¼‰ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œè¿›è¡Œè¿æ¥æŸ¥è¯¢ï¼Œä¼˜åŒ–æ–¹å¼ï¼š\r\n\r\n* å‡å°‘é©±åŠ¨è¡¨çš„æ‰‡å‡ºï¼ˆè®©æ•°æ®é‡å°çš„è¡¨æ¥åšé©±åŠ¨è¡¨ï¼‰\r\n* é™ä½è®¿é—®è¢«é©±åŠ¨è¡¨çš„æˆæœ¬\r\n\r\nè¯´æ˜ï¼šSTRAIGHT_JOIN æ˜¯æŸ¥ä¸€æ¡é©±åŠ¨è¡¨ï¼Œç„¶åæ ¹æ®å…³è”å­—æ®µå»æŸ¥è¢«é©±åŠ¨è¡¨ï¼Œè¦è®¿é—®å¤šæ¬¡é©±åŠ¨è¡¨ï¼Œæ‰€ä»¥éœ€è¦ä¼˜åŒ–ä¸º INL ç®—æ³•\r\n\r\nBlock Nested-Loop Join ç®—æ³•ï¼šä¸€ç§**ç©ºé—´æ¢æ—¶é—´**çš„ä¼˜åŒ–æ–¹å¼ï¼ŒåŸºäºå—çš„å¾ªç¯è¿æ¥ï¼Œæ‰§è¡Œè¿æ¥æŸ¥è¯¢å‰ç”³è¯·ä¸€å—å›ºå®šå¤§å°çš„å†…å­˜ä½œä¸ºè¿æ¥ç¼“å†²åŒº Join Bufferï¼Œå…ˆæŠŠè‹¥å¹²æ¡é©±åŠ¨è¡¨ä¸­çš„æ‰‡å‡ºæš‚å­˜åœ¨ç¼“å†²åŒºï¼Œæ¯ä¸€æ¡è¢«é©±åŠ¨è¡¨ä¸­çš„è®°å½•ä¸€æ¬¡æ€§çš„ä¸ Buffer ä¸­å¤šæ¡è®°å½•è¿›è¡ŒåŒ¹é…ï¼ˆæ‰«æå…¨éƒ¨æ•°æ®ï¼Œä¸€æ¡ä¸€æ¡çš„åŒ¹é…ï¼‰ï¼Œå› ä¸ºæ˜¯åœ¨å†…å­˜ä¸­å®Œæˆï¼Œæ‰€ä»¥é€Ÿåº¦å¿«ï¼Œå¹¶ä¸”é™ä½äº† I/O æˆæœ¬\r\n\r\nJoin Buffer å¯ä»¥é€šè¿‡å‚æ•° `join_buffer_size` è¿›è¡Œé…ç½®ï¼Œé»˜è®¤å¤§å°æ˜¯ 256 KB\r\n\r\nåœ¨æˆæœ¬åˆ†ææ—¶ï¼Œå¯¹äºå¾ˆå¤šå¼ è¡¨çš„è¿æ¥æŸ¥è¯¢ï¼Œè¿æ¥é¡ºåºæœ‰éå¸¸å¤šï¼ŒMySQL å¦‚æœæŒ¨ç€è¿›è¡Œéå†è®¡ç®—æˆæœ¬ï¼Œä¼šæ¶ˆè€—å¾ˆå¤šèµ„æº\r\n\r\n* æå‰ç»“æŸæŸç§è¿æ¥é¡ºåºçš„æˆæœ¬è¯„ä¼°ï¼šç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡è®°å½•å½“å‰æˆæœ¬æœ€å°çš„è¿æ¥æ–¹å¼ï¼Œå¦‚æœä¸€ç§é¡ºåºåªè®¡ç®—äº†ä¸€éƒ¨åˆ†å°±å·²ç»è¶…è¿‡äº†æœ€å°æˆæœ¬ï¼Œå¯ä»¥æå‰ç»“æŸè®¡ç®—\r\n* ç³»ç»Ÿå˜é‡ optimizer_search_depthï¼šå¦‚æœè¿æ¥è¡¨çš„ä¸ªæ•°å°äºè¯¥å˜é‡ï¼Œå°±ç»§ç»­ç©·ä¸¾åˆ†ææ¯ä¸€ç§è¿æ¥æ•°é‡ï¼Œåä¹‹åªå¯¹æ•°é‡ä¸ depth å€¼ç›¸åŒçš„è¡¨è¿›è¡Œåˆ†æï¼Œè¯¥å€¼è¶Šå¤§æˆæœ¬åˆ†æçš„è¶Šç²¾ç¡®\r\n\r\n* ç³»ç»Ÿå˜é‡ optimizer_prune_levelï¼šæ§åˆ¶å¯å‘å¼è§„åˆ™çš„å¯ç”¨ï¼Œè¿™äº›è§„åˆ™å°±æ˜¯æ ¹æ®ä»¥å¾€ç»éªŒæŒ‡å®šçš„ï¼Œä¸æ»¡è¶³è§„åˆ™çš„è¿æ¥é¡ºåºä¸åˆ†ææˆæœ¬\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### è¿æ¥ä¼˜åŒ–\r\n\r\n##### BKA\r\n\r\nBatched Key Access ç®—æ³•æ˜¯å¯¹ NLJ ç®—æ³•çš„ä¼˜åŒ–ï¼Œåœ¨è¯»å–è¢«é©±åŠ¨è¡¨çš„è®°å½•æ—¶ä½¿ç”¨é¡ºåº IOï¼ŒExtra ä¿¡æ¯ä¸­ä¼šæœ‰ Batched Key Access ä¿¡æ¯\r\n\r\nä½¿ç”¨ BKA çš„è¡¨çš„ JOIN è¿‡ç¨‹å¦‚ä¸‹ï¼š\r\n\r\n* è¿æ¥é©±åŠ¨è¡¨å°†æ»¡è¶³æ¡ä»¶çš„è®°å½•æ”¾å…¥ Join Bufferï¼Œå¹¶å°†ä¸¤è¡¨è¿æ¥çš„å­—æ®µæ”¾å…¥ä¸€ä¸ª DYNAMIC_ARRAY ranges ä¸­\r\n* åœ¨è¿›è¡Œè¡¨çš„è¿‡æ¥è¿‡ç¨‹ä¸­ï¼Œä¼šå°† ranges ç›¸å…³çš„ä¿¡æ¯ä¼ å…¥ Buffer ä¸­ï¼Œè¿›è¡Œè¢«é©±åŠ¨è¡¨ä¸»å»ºçš„æŸ¥æ‰¾åŠæ’åºæ“ä½œ\r\n* è°ƒç”¨æ­¥éª¤ 2 ä¸­äº§ç”Ÿçš„æœ‰åºä¸»å»ºï¼Œ**é¡ºåºè¯»å–è¢«é©±åŠ¨è¡¨çš„æ•°æ®**\r\n* å½“ç¼“å†²åŒºçš„æ•°æ®è¢«è¯»å®Œåï¼Œä¼šé‡å¤è¿›è¡Œæ­¥éª¤ 2ã€3ï¼Œç›´åˆ°è®°å½•è¢«è¯»å–å®Œ\r\n\r\nä½¿ç”¨ BKA ä¼˜åŒ–éœ€è¦è®¾è¿›è¡Œè®¾ç½®ï¼š\r\n\r\n```sql\r\nSET optimizer_switch='mrr=on,mrr_cost_based=off,batched_key_access=on';\r\n```\r\n\r\nè¯´æ˜ï¼šå‰ä¸¤ä¸ªå‚æ•°çš„ä½œç”¨æ˜¯å¯ç”¨ MRRï¼Œå› ä¸º BKA ç®—æ³•çš„ä¼˜åŒ–è¦ä¾èµ–äº MRRï¼ˆç³»ç»Ÿä¼˜åŒ– â†’ å†…å­˜ä¼˜åŒ– â†’ Read è¯¦è§£ï¼‰\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### BNL\r\n\r\n###### é—®é¢˜\r\n\r\nBNL å³ Block Nested-Loop Join ç®—æ³•ï¼Œç”±äºè¦è®¿é—®å¤šæ¬¡è¢«é©±åŠ¨è¡¨ï¼Œä¼šäº§ç”Ÿä¸¤ä¸ªé—®é¢˜ï¼š\r\n\r\n* Join è¯­å¥å¤šæ¬¡æ‰«æä¸€ä¸ªå†·è¡¨ï¼Œå¹¶ä¸”è¯­å¥æ‰§è¡Œæ—¶é—´å°äº 1 ç§’ï¼Œå°±ä¼šåœ¨å†æ¬¡æ‰«æå†·è¡¨æ—¶ï¼ŒæŠŠå†·è¡¨çš„æ•°æ®é¡µç§»åˆ° LRU é“¾è¡¨å¤´éƒ¨ï¼Œå¯¼è‡´çƒ­æ•°æ®è¢«æ·˜æ±°ï¼Œå½±å“ä¸šåŠ¡çš„æ­£å¸¸è¿è¡Œ\r\n\r\n  è¿™ç§æƒ…å†µå†·è¡¨çš„æ•°æ®é‡è¦å°äºæ•´ä¸ª Buffer Pool çš„ old åŒºåŸŸï¼Œèƒ½å¤Ÿå®Œå…¨æ”¾å…¥ old åŒºï¼Œæ‰ä¼šå†æ¬¡è¢«è¯»æ—¶åŠ åˆ° youngï¼Œå¦åˆ™è¯»å–ä¸‹ä¸€æ®µæ—¶å°±å·²ç»æŠŠä¸Šä¸€æ®µæ·˜æ±°\r\n\r\n* Join è¯­å¥åœ¨å¾ªç¯è¯»ç£ç›˜å’Œæ·˜æ±°å†…å­˜é¡µï¼Œè¿›å…¥ old åŒºåŸŸçš„æ•°æ®é¡µå¾ˆå¯èƒ½åœ¨ 1 ç§’ä¹‹å†…å°±è¢«æ·˜æ±°ï¼Œå°±ä¼šå¯¼è‡´ MySQL å®ä¾‹çš„ Buffer Pool åœ¨è¿™æ®µæ—¶é—´å†… young åŒºåŸŸçš„æ•°æ®é¡µæ²¡æœ‰è¢«åˆç†åœ°æ·˜æ±°\r\n\r\nå¤§è¡¨ Join æ“ä½œè™½ç„¶å¯¹ IO æœ‰å½±å“ï¼Œä½†æ˜¯åœ¨è¯­å¥æ‰§è¡Œç»“æŸåå¯¹ IO çš„å½±å“éšä¹‹ç»“æŸã€‚ä½†æ˜¯å¯¹ Buffer Pool çš„å½±å“å°±æ˜¯æŒç»­æ€§çš„ï¼Œéœ€è¦ä¾é åç»­çš„æŸ¥è¯¢è¯·æ±‚æ…¢æ…¢æ¢å¤å†…å­˜å‘½ä¸­ç‡\r\n\r\n\r\n\r\n###### ä¼˜åŒ–\r\n\r\nå°† BNL ç®—æ³•è½¬æˆ BKA ç®—æ³•ï¼Œä¼˜åŒ–æ–¹å‘ï¼š\r\n\r\n* åœ¨è¢«é©±åŠ¨è¡¨ä¸Šå»ºç´¢å¼•ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®ç´¢å¼•è¿›è¡Œé¡ºåº IO\r\n* ä½¿ç”¨ä¸´æ—¶è¡¨ï¼Œ**åœ¨ä¸´æ—¶è¡¨ä¸Šå»ºç«‹ç´¢å¼•**ï¼Œå°†è¢«é©±åŠ¨è¡¨å’Œä¸´æ—¶è¡¨è¿›è¡Œè¿æ¥æŸ¥è¯¢\r\n\r\né©±åŠ¨è¡¨ t1ï¼Œè¢«é©±åŠ¨è¡¨ t2ï¼Œä½¿ç”¨ä¸´æ—¶è¡¨çš„å·¥ä½œæµç¨‹ï¼š\r\n\r\n* æŠŠè¡¨ t1 ä¸­æ»¡è¶³æ¡ä»¶çš„æ•°æ®æ”¾åœ¨ä¸´æ—¶è¡¨ tmp_t ä¸­\r\n* ç»™ä¸´æ—¶è¡¨ tmp_t çš„å…³è”å­—æ®µåŠ ä¸Šç´¢å¼•ï¼Œä½¿ç”¨ BKA ç®—æ³•\r\n* è®©è¡¨ t2 å’Œ tmp_t åš Join æ“ä½œï¼ˆä¸´æ—¶è¡¨æ˜¯è¢«é©±åŠ¨è¡¨ï¼‰\r\n\r\nè¡¥å……ï¼šMySQL 8.0 æ”¯æŒ hash joinï¼Œjoin_buffer ç»´æŠ¤çš„ä¸å†æ˜¯ä¸€ä¸ªæ— åºæ•°ç»„ï¼Œè€Œæ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼ŒæŸ¥è¯¢æ•ˆç‡æ›´é«˜ï¼Œæ‰§è¡Œæ•ˆç‡æ¯”ä¸´æ—¶è¡¨æ›´é«˜\r\n\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### åµŒå¥—æŸ¥è¯¢\r\n\r\n#### æŸ¥è¯¢åˆ†ç±»\r\n\r\næŸ¥è¯¢è¯­å¥ä¸­åµŒå¥—äº†æŸ¥è¯¢è¯­å¥ï¼Œ**å°†åµŒå¥—æŸ¥è¯¢ç§°ä¸ºå­æŸ¥è¯¢**ï¼ŒFROM å­å¥åé¢çš„å­æŸ¥è¯¢çš„ç»“æœé›†ç§°ä¸ºæ´¾ç”Ÿè¡¨\r\n\r\næ ¹æ®ç»“æœåˆ†ç±»ï¼š\r\n\r\n* ç»“æœæ˜¯å•è¡Œå•åˆ—ï¼šå¯ä»¥å°†æŸ¥è¯¢çš„ç»“æœä½œä¸ºå¦ä¸€æ¡è¯­å¥çš„æŸ¥è¯¢æ¡ä»¶ï¼Œä½¿ç”¨è¿ç®—ç¬¦åˆ¤æ–­\r\n\r\n  ```sql\r\n  SELECT åˆ—å FROM è¡¨å WHERE åˆ—å=(SELECT åˆ—å/èšåˆå‡½æ•°(åˆ—å) FROM è¡¨å [WHERE æ¡ä»¶]);\r\n  ```\r\n\r\n* ç»“æœæ˜¯å¤šè¡Œå•åˆ—ï¼šå¯ä»¥ä½œä¸ºæ¡ä»¶ï¼Œä½¿ç”¨è¿ç®—ç¬¦ IN æˆ– NOT IN è¿›è¡Œåˆ¤æ–­\r\n\r\n  ```sql\r\n  SELECT åˆ—å FROM è¡¨å WHERE åˆ—å [NOT] IN (SELECT åˆ—å FROM è¡¨å [WHERE æ¡ä»¶]); \r\n  ```\r\n\r\n* ç»“æœæ˜¯å¤šè¡Œå¤šåˆ—ï¼šæŸ¥è¯¢çš„ç»“æœå¯ä»¥ä½œä¸ºä¸€å¼ è™šæ‹Ÿè¡¨å‚ä¸æŸ¥è¯¢\r\n\r\n  ```sql\r\n  SELECT åˆ—å FROM è¡¨å [åˆ«å],(SELECT åˆ—å FROM è¡¨å [WHERE æ¡ä»¶]) [åˆ«å] [WHERE æ¡ä»¶];\r\n  \r\n  -- æŸ¥è¯¢è®¢å•è¡¨orderlistä¸­idå¤§äº4çš„è®¢å•ä¿¡æ¯å’Œæ‰€å±ç”¨æˆ·USERä¿¡æ¯\r\n  SELECT \r\n  \t* \r\n  FROM \r\n  \tUSER u,\r\n  \t(SELECT * FROM orderlist WHERE id>4) o \r\n  WHERE \r\n  \tu.id=o.uid;\r\n  ```\r\n\r\nç›¸å…³æ€§åˆ†ç±»ï¼š\r\n\r\n* ä¸ç›¸å…³å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢ä¸ä¾èµ–å¤–å±‚æŸ¥è¯¢çš„å€¼ï¼Œå¯ä»¥å•ç‹¬è¿è¡Œå‡ºç»“æœ\r\n* ç›¸å…³å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢çš„æ‰§è¡Œéœ€è¦ä¾èµ–å¤–å±‚æŸ¥è¯¢çš„å€¼\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### æŸ¥è¯¢ä¼˜åŒ–\r\n\r\nä¸ç›¸å…³å­æŸ¥è¯¢çš„ç»“æœé›†ä¼šè¢«å†™å…¥ä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œå¹¶ä¸”åœ¨å†™å…¥æ—¶**å»é‡**ï¼Œè¯¥è¿‡ç¨‹ç§°ä¸º**ç‰©åŒ–**ï¼Œå­˜å‚¨ç»“æœé›†çš„ä¸´æ—¶è¡¨ç§°ä¸ºç‰©åŒ–è¡¨\r\n\r\nç³»ç»Ÿå˜é‡ tmp_table_size æˆ–è€… max_heap_table_size ä¸ºè¡¨çš„æœ€å€¼\r\n\r\n* å°äºç³»ç»Ÿå˜é‡æ—¶ï¼Œå†…å­˜ä¸­å¯ä»¥ä¿å­˜ï¼Œä¼šä¸ºå»ºç«‹**åŸºäºå†…å­˜**çš„ MEMORY å­˜å‚¨å¼•æ“çš„ä¸´æ—¶è¡¨ï¼Œå¹¶å»ºç«‹å“ˆå¸Œç´¢å¼•\r\n* å¤§äºä»»æ„ä¸€ä¸ªç³»ç»Ÿå˜é‡æ—¶ï¼Œç‰©åŒ–è¡¨ä¼šä½¿ç”¨**åŸºäºç£ç›˜**çš„ InnoDB å­˜å‚¨å¼•æ“æ¥ä¿å­˜ç»“æœé›†ä¸­çš„è®°å½•ï¼Œç´¢å¼•ç±»å‹ä¸º B+ æ ‘\r\n\r\nç‰©åŒ–åï¼ŒåµŒå¥—æŸ¥è¯¢å°±ç›¸å½“äºå¤–å±‚æŸ¥è¯¢çš„è¡¨å’Œç‰©åŒ–è¡¨è¿›è¡Œå†…è¿æ¥æŸ¥è¯¢ï¼Œç„¶åç»è¿‡ä¼˜åŒ–å™¨é€‰æ‹©æˆæœ¬æœ€å°çš„è¡¨è¿æ¥é¡ºåºæ‰§è¡ŒæŸ¥è¯¢\r\n\r\nå­æŸ¥è¯¢ç‰©åŒ–ä¼šäº§ç”Ÿå»ºç«‹ä¸´æ—¶è¡¨çš„æˆæœ¬ï¼Œä½†æ˜¯å°†å­æŸ¥è¯¢è½¬åŒ–ä¸ºè¿æ¥æŸ¥è¯¢å¯ä»¥å……åˆ†å‘æŒ¥ä¼˜åŒ–å™¨çš„ä½œç”¨ï¼Œæ‰€ä»¥å¼•å…¥ï¼šåŠè¿æ¥\r\n\r\n* t1 å’Œ t2 è¡¨è¿›è¡ŒåŠè¿æ¥ï¼Œå¯¹äº t1 è¡¨ä¸­çš„æŸæ¡è®°å½•ï¼Œåªéœ€è¦å…³å¿ƒåœ¨ t2 è¡¨ä¸­æ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸éœ€è¦å…³å¿ƒæœ‰å¤šå°‘æ¡è®°å½•ä¸ä¹‹åŒ¹é…ï¼Œæœ€ç»ˆç»“æœé›†åªä¿ç•™ t1 çš„è®°å½•\r\n* åŠè¿æ¥åªæ˜¯æ‰§è¡Œå­æŸ¥è¯¢çš„ä¸€ç§æ–¹å¼ï¼ŒMySQL å¹¶æ²¡æœ‰æä¾›é¢å‘ç”¨æˆ·çš„åŠè¿æ¥è¯­æ³•\r\n\r\n\r\n\r\nå‚è€ƒä¹¦ç±ï¼šhttps://book.douban.com/subject/35231266/\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### è”åˆæŸ¥è¯¢\r\n\r\nUNION æ˜¯å–è¿™ä¸¤ä¸ªå­æŸ¥è¯¢ç»“æœçš„å¹¶é›†ï¼Œå¹¶è¿›è¡Œå»é‡ï¼ŒåŒæ—¶è¿›è¡Œé»˜è®¤è§„åˆ™çš„æ’åºï¼ˆunion æ˜¯è¡ŒåŠ èµ·æ¥ï¼Œjoin æ˜¯åˆ—åŠ èµ·æ¥ï¼‰\r\n\r\nUNION ALL æ˜¯å¯¹ä¸¤ä¸ªç»“æœé›†è¿›è¡Œå¹¶é›†æ“ä½œä¸è¿›è¡Œå»é‡ï¼Œä¸è¿›è¡Œæ’åº\r\n\r\n```sql\r\n(select 1000 as f) union (select id from t1 order by id desc limit 2); #t1è¡¨ä¸­åŒ…å«id ä¸º 1-1000 çš„æ•°æ®\r\n```\r\n\r\nè¯­å¥çš„æ‰§è¡Œæµç¨‹ï¼š\r\n\r\n* åˆ›å»ºä¸€ä¸ªå†…å­˜ä¸´æ—¶è¡¨ï¼Œè¿™ä¸ªä¸´æ—¶è¡¨åªæœ‰ä¸€ä¸ªæ•´å‹å­—æ®µ fï¼Œå¹¶ä¸” f æ˜¯ä¸»é”®å­—æ®µ\r\n* æ‰§è¡Œç¬¬ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œå¾—åˆ° 1000 è¿™ä¸ªå€¼ï¼Œå¹¶å­˜å…¥ä¸´æ—¶è¡¨ä¸­\r\n* æ‰§è¡Œç¬¬äºŒä¸ªå­æŸ¥è¯¢ï¼Œæ‹¿åˆ°ç¬¬ä¸€è¡Œ id=1000ï¼Œè¯•å›¾æ’å…¥ä¸´æ—¶è¡¨ä¸­ï¼Œä½†ç”±äº 1000 è¿™ä¸ªå€¼å·²ç»å­˜åœ¨äºä¸´æ—¶è¡¨äº†ï¼Œè¿åäº†å”¯ä¸€æ€§çº¦æŸï¼Œæ‰€ä»¥æ’å…¥å¤±è´¥ï¼Œç„¶åç»§ç»­æ‰§è¡Œ\r\n* å–åˆ°ç¬¬äºŒè¡Œ id=999ï¼Œæ’å…¥ä¸´æ—¶è¡¨æˆåŠŸ\r\n* ä»ä¸´æ—¶è¡¨ä¸­æŒ‰è¡Œå–å‡ºæ•°æ®ï¼Œè¿”å›ç»“æœå¹¶åˆ é™¤ä¸´æ—¶è¡¨ï¼Œç»“æœä¸­åŒ…å«ä¸¤è¡Œæ•°æ®åˆ†åˆ«æ˜¯ 1000 å’Œ 999\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### æŸ¥è¯¢ç»ƒä¹ \r\n\r\næ•°æ®å‡†å¤‡ï¼š\r\n\r\n```sql\r\n-- åˆ›å»ºdb4æ•°æ®åº“\r\nCREATE DATABASE db4;\r\n-- ä½¿ç”¨db4æ•°æ®åº“\r\nUSE db4;\r\n\r\n-- åˆ›å»ºuserè¡¨\r\nCREATE TABLE USER(\r\n\tid INT PRIMARY KEY AUTO_INCREMENT,\t-- ç”¨æˆ·id\r\n\tNAME VARCHAR(20),\t\t\t\t\t-- ç”¨æˆ·å§“å\r\n\tage INT                             -- ç”¨æˆ·å¹´é¾„\r\n);\r\n\r\n-- è®¢å•è¡¨\r\nCREATE TABLE orderlist(\r\n\tid INT PRIMARY KEY AUTO_INCREMENT,\t-- è®¢å•id\r\n\tnumber VARCHAR(30),\t\t\t\t\t-- è®¢å•ç¼–å·\r\n\tuid INT,   \t\t\t\t\t\t\t-- å¤–é”®å­—æ®µ\r\n\tCONSTRAINT ou_fk1 FOREIGN KEY (uid) REFERENCES USER(id)\r\n);\r\n\r\n-- å•†å“åˆ†ç±»è¡¨\r\nCREATE TABLE category(\r\n\tid INT PRIMARY KEY AUTO_INCREMENT,  -- å•†å“åˆ†ç±»id\r\n\tNAME VARCHAR(10)                    -- å•†å“åˆ†ç±»åç§°\r\n);\r\n\r\n-- å•†å“è¡¨\r\nCREATE TABLE product(\r\n\tid INT PRIMARY KEY AUTO_INCREMENT,   -- å•†å“id\r\n\tNAME VARCHAR(30),                    -- å•†å“åç§°\r\n\tcid INT, -- å¤–é”®å­—æ®µ\r\n\tCONSTRAINT cp_fk1 FOREIGN KEY (cid) REFERENCES category(id)\r\n);\r\n\r\n-- ä¸­é—´è¡¨\r\nCREATE TABLE us_pro(\r\n\tupid INT PRIMARY KEY AUTO_INCREMENT,  -- ä¸­é—´è¡¨id\r\n\tuid INT, \t\t\t\t\t\t\t  -- å¤–é”®å­—æ®µã€‚éœ€è¦å’Œç”¨æˆ·è¡¨çš„ä¸»é”®äº§ç”Ÿå…³è”\r\n\tpid INT,\t\t\t\t\t\t\t  -- å¤–é”®å­—æ®µã€‚éœ€è¦å’Œå•†å“è¡¨çš„ä¸»é”®äº§ç”Ÿå…³è”\r\n\tCONSTRAINT up_fk1 FOREIGN KEY (uid) REFERENCES USER(id),\r\n\tCONSTRAINT up_fk2 FOREIGN KEY (pid) REFERENCES product(id)\r\n);\r\n```\r\n\r\n![image-20250320014105104](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320014105104.png)\r\n\r\n\r\n\r\n**æ•°æ®æŸ¥è¯¢ï¼š**\r\n\r\n1. æŸ¥è¯¢ç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€è®¢å•ç¼–å·\r\n   \r\n   æ•°æ®ï¼šç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„åœ¨ user è¡¨ï¼Œè®¢å•ç¼–å·åœ¨ orderlist è¡¨\r\n   \r\n   æ¡ä»¶ï¼šuser.id = orderlist.uid\r\n   \r\n   ```sql\r\n   SELECT\r\n   \tu.*,\r\n   \to.number\r\n   FROM\r\n   \tUSER u,\r\n   \torderlist o\r\n   WHERE\r\n   \tu.id = o.uid;\r\n   ```\r\n   \r\n2. æŸ¥è¯¢æ‰€æœ‰çš„ç”¨æˆ·ï¼Œæ˜¾ç¤ºç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€è®¢å•ç¼–å·ã€‚\r\n\r\n   ```sql\r\n   SELECT\r\n   \tu.*,\r\n   \to.number\r\n   FROM\r\n   \tUSER u\r\n   LEFT OUTER JOIN\r\n   \torderlist o\r\n   ON\r\n   \tu.id = o.uid;\r\n   ```\r\n\r\n3. æŸ¥è¯¢ç”¨æˆ·å¹´é¾„å¤§äº 23 å²çš„ä¿¡æ¯ï¼Œæ˜¾ç¤ºç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€è®¢å•ç¼–å·\r\n\r\n   ```sql\r\n   SELECT\r\n   \tu.*,\r\n   \to.number\r\n   FROM\r\n   \tUSER u,\r\n   \torderlist o\r\n   WHERE\r\n   \tu.id = o.uid\r\n   \tAND\r\n   \tu.age > 23;\r\n   ```\r\n\r\n   ```sql\r\n   SELECT\r\n   \tu.*,\r\n   \to.number\r\n   FROM\r\n   \t(SELECT * FROM USER WHERE age > 23) u,-- åµŒå¥—æŸ¥è¯¢\r\n   \torderlist o\r\n   WHERE\r\n   \tu.id = o.uid;\r\n   ```\r\n\r\n4. æŸ¥è¯¢å¼ ä¸‰å’Œæå››ç”¨æˆ·çš„ä¿¡æ¯ï¼Œæ˜¾ç¤ºç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€è®¢å•ç¼–å·ã€‚\r\n\r\n   ````sql\r\n   SELECT\r\n   \tu.*,\r\n   \to.number\r\n   FROM\r\n   \tUSER u,\r\n   \torderlist o\r\n   WHERE\r\n   \tu.id=o.uid\r\n   \tAND\r\n   \tu.name IN ('å¼ ä¸‰','æå››');\r\n   ````\r\n\r\n5. æŸ¥è¯¢æ‰€æœ‰çš„ç”¨æˆ·å’Œè¯¥ç”¨æˆ·èƒ½æŸ¥çœ‹çš„æ‰€æœ‰çš„å•†å“ï¼Œæ˜¾ç¤ºç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€å•†å“åç§°\r\n   \r\n   æ•°æ®ï¼šç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„åœ¨ user è¡¨ï¼Œå•†å“åç§°åœ¨ product è¡¨ï¼Œä¸­é—´è¡¨ us_pro\r\n   \r\n   æ¡ä»¶ï¼šus_pro.uid = user.id AND us_pro.pid = product.id\r\n   \r\n   ```sql\r\n   SELECT\r\n   \tu.id,\r\n   \tu.name,\r\n   \tu.age,\r\n   \tp.name\r\n   FROM\r\n   \tUSER u,\r\n   \tproduct p,\r\n   \tus_pro up\r\n   WHERE\r\n   \tup.uid = u.id\r\n   \tAND\r\n   \tup.pid=p.id;\r\n   ```\r\n   \r\n6. æŸ¥è¯¢å¼ ä¸‰å’Œæå››è¿™ä¸¤ä¸ªç”¨æˆ·å¯ä»¥çœ‹åˆ°çš„å•†å“ï¼Œæ˜¾ç¤ºç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€å•†å“åç§°ã€‚\r\n\r\n   ```sql\r\n   SELECT\r\n   \tu.id,\r\n   \tu.name,\r\n   \tu.age,\r\n   \tp.name\r\n   FROM\r\n   \tUSER u,\r\n   \tproduct p,\r\n   \tus_pro up\r\n   WHERE\r\n   \tup.uid=u.id\r\n   \tAND\r\n   \tup.pid=p.id\r\n   \tAND\r\n   \tu.name IN ('å¼ ä¸‰','æå››');\r\n   ```\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"MySQL - äº‹åŠ¡","tags":["SQL"],"categories":["MySQL","äº‹åŠ¡ç¯‡"],"author":"imklaus","excerpt":"\r\n### åŸºæœ¬ä»‹ç»\r\n\r\näº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯è®¿é—®å’Œæ›´æ–°æ•°æ®åº“çš„ç¨‹åºæ‰§è¡Œå•å…ƒï¼›äº‹åŠ¡ä¸­å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª SQL è¯­å¥ï¼Œè¿™äº›è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œä½œä¸ºä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ï¼ŒMySQL æ”¯æŒäº‹åŠ¡ã€‚\r\n\r\nå•å…ƒä¸­çš„æ¯æ¡ SQL è¯­å¥éƒ½ç›¸äº’ä¾èµ–ï¼Œå½¢æˆä¸€ä¸ªæ•´ä½“\r\n\r\n* å¦‚æœæŸæ¡ SQL è¯­å¥æ‰§è¡Œå¤±è´¥æˆ–è€…å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆæ•´ä¸ªå•å…ƒå°±ä¼šå›æ»šï¼Œæ’¤å›åˆ°äº‹åŠ¡æœ€åˆçš„çŠ¶æ€\r\n\r\n* å¦‚æœå•å…ƒä¸­æ‰€æœ‰çš„ SQL è¯­å¥éƒ½æ‰§è¡ŒæˆåŠŸï¼Œåˆ™äº‹åŠ¡å°±é¡ºåˆ©æ‰§è¡Œ\r\n\r\näº‹åŠ¡çš„å››å¤§ç‰¹å¾ï¼šACID\r\n\r\n- åŸå­æ€§ (atomicity)\r\n- ä¸€è‡´æ€§ (consistency)\r\n- éš”ç¦»æ€§ (isolaction)\r\n- æŒä¹…æ€§ (durability)\r\n\r\näº‹åŠ¡çš„å‡ ç§çŠ¶æ€ï¼š\r\n\r\n* æ´»åŠ¨çš„ï¼ˆactiveï¼‰ï¼šäº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“æ“ä½œæ­£åœ¨æ‰§è¡Œä¸­\r\n* éƒ¨åˆ†æäº¤çš„ï¼ˆpartially committedï¼‰ï¼šäº‹åŠ¡çš„æœ€åä¸€ä¸ªæ“ä½œæ‰§è¡Œå®Œï¼Œä½†æ˜¯å†…å­˜è¿˜æ²¡åˆ·æ–°è‡³ç£ç›˜\r\n* å¤±è´¥çš„ï¼ˆfailedï¼‰ï¼šå½“äº‹åŠ¡å¤„äºæ´»åŠ¨çŠ¶æ€æˆ–éƒ¨åˆ†æäº¤çŠ¶æ€æ—¶ï¼Œå¦‚æœæ•°æ®åº“é‡åˆ°äº†é”™è¯¯æˆ–åˆ·è„å¤±è´¥ï¼Œæˆ–è€…ç”¨æˆ·ä¸»åŠ¨åœæ­¢å½“å‰çš„äº‹åŠ¡\r\n* ä¸­æ­¢çš„ï¼ˆabortedï¼‰ï¼šå¤±è´¥çŠ¶æ€çš„äº‹åŠ¡å›æ»šå®Œæˆåçš„çŠ¶æ€\r\n* æäº¤çš„ï¼ˆcommittedï¼‰ï¼šå½“å¤„äºéƒ¨åˆ†æäº¤çŠ¶æ€çš„äº‹åŠ¡åˆ·è„æˆåŠŸï¼Œå°±å¤„äºæäº¤çŠ¶æ€\r\n\r\n","link":"/posts/MySQL_Transaction","content":"\r\n### åŸºæœ¬ä»‹ç»\r\n\r\näº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯è®¿é—®å’Œæ›´æ–°æ•°æ®åº“çš„ç¨‹åºæ‰§è¡Œå•å…ƒï¼›äº‹åŠ¡ä¸­å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª SQL è¯­å¥ï¼Œè¿™äº›è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œä½œä¸ºä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ï¼ŒMySQL æ”¯æŒäº‹åŠ¡ã€‚\r\n\r\nå•å…ƒä¸­çš„æ¯æ¡ SQL è¯­å¥éƒ½ç›¸äº’ä¾èµ–ï¼Œå½¢æˆä¸€ä¸ªæ•´ä½“\r\n\r\n* å¦‚æœæŸæ¡ SQL è¯­å¥æ‰§è¡Œå¤±è´¥æˆ–è€…å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆæ•´ä¸ªå•å…ƒå°±ä¼šå›æ»šï¼Œæ’¤å›åˆ°äº‹åŠ¡æœ€åˆçš„çŠ¶æ€\r\n\r\n* å¦‚æœå•å…ƒä¸­æ‰€æœ‰çš„ SQL è¯­å¥éƒ½æ‰§è¡ŒæˆåŠŸï¼Œåˆ™äº‹åŠ¡å°±é¡ºåˆ©æ‰§è¡Œ\r\n\r\näº‹åŠ¡çš„å››å¤§ç‰¹å¾ï¼šACID\r\n\r\n- åŸå­æ€§ (atomicity)\r\n- ä¸€è‡´æ€§ (consistency)\r\n- éš”ç¦»æ€§ (isolaction)\r\n- æŒä¹…æ€§ (durability)\r\n\r\näº‹åŠ¡çš„å‡ ç§çŠ¶æ€ï¼š\r\n\r\n* æ´»åŠ¨çš„ï¼ˆactiveï¼‰ï¼šäº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“æ“ä½œæ­£åœ¨æ‰§è¡Œä¸­\r\n* éƒ¨åˆ†æäº¤çš„ï¼ˆpartially committedï¼‰ï¼šäº‹åŠ¡çš„æœ€åä¸€ä¸ªæ“ä½œæ‰§è¡Œå®Œï¼Œä½†æ˜¯å†…å­˜è¿˜æ²¡åˆ·æ–°è‡³ç£ç›˜\r\n* å¤±è´¥çš„ï¼ˆfailedï¼‰ï¼šå½“äº‹åŠ¡å¤„äºæ´»åŠ¨çŠ¶æ€æˆ–éƒ¨åˆ†æäº¤çŠ¶æ€æ—¶ï¼Œå¦‚æœæ•°æ®åº“é‡åˆ°äº†é”™è¯¯æˆ–åˆ·è„å¤±è´¥ï¼Œæˆ–è€…ç”¨æˆ·ä¸»åŠ¨åœæ­¢å½“å‰çš„äº‹åŠ¡\r\n* ä¸­æ­¢çš„ï¼ˆabortedï¼‰ï¼šå¤±è´¥çŠ¶æ€çš„äº‹åŠ¡å›æ»šå®Œæˆåçš„çŠ¶æ€\r\n* æäº¤çš„ï¼ˆcommittedï¼‰ï¼šå½“å¤„äºéƒ¨åˆ†æäº¤çŠ¶æ€çš„äº‹åŠ¡åˆ·è„æˆåŠŸï¼Œå°±å¤„äºæäº¤çŠ¶æ€\r\n\r\n<!-- more -->\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### äº‹åŠ¡ç®¡ç†\r\n\r\n#### åŸºæœ¬æ“ä½œ\r\n\r\näº‹åŠ¡ç®¡ç†çš„ä¸‰ä¸ªæ­¥éª¤\r\n\r\n1. å¼€å¯äº‹åŠ¡ï¼šè®°å½•å›æ»šç‚¹ï¼Œå¹¶é€šçŸ¥æœåŠ¡å™¨ï¼Œå°†è¦æ‰§è¡Œä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸã€è¦ä¹ˆåŒæ—¶å¤±è´¥\r\n\r\n2. æ‰§è¡Œ SQL è¯­å¥ï¼šæ‰§è¡Œå…·ä½“çš„ä¸€æ¡æˆ–å¤šæ¡ SQL è¯­å¥\r\n\r\n3. ç»“æŸäº‹åŠ¡ï¼ˆæäº¤|å›æ»šï¼‰\r\n\r\n   - æäº¤ï¼šæ²¡å‡ºç°é—®é¢˜ï¼Œæ•°æ®è¿›è¡Œæ›´æ–°\r\n   - å›æ»šï¼šå‡ºç°é—®é¢˜ï¼Œæ•°æ®æ¢å¤åˆ°å¼€å¯äº‹åŠ¡æ—¶çš„çŠ¶æ€\r\n\r\n\r\näº‹åŠ¡æ“ä½œï¼š\r\n\r\n* æ˜¾å¼å¼€å¯äº‹åŠ¡\r\n\r\n  ```sql\r\n  START TRANSACTION [READ ONLY|READ WRITE|WITH CONSISTENT SNAPSHOT]; #å¯ä»¥è·Ÿä¸€ä¸ªæˆ–å¤šä¸ªçŠ¶æ€ï¼Œæœ€åçš„æ˜¯ä¸€è‡´æ€§è¯»\r\n  BEGIN [WORK];\r\n  ```\r\n\r\n  è¯´æ˜ï¼šä¸å¡«çŠ¶æ€é»˜è®¤æ˜¯è¯»å†™äº‹åŠ¡\r\n\r\n* å›æ»šäº‹åŠ¡ï¼Œç”¨æ¥æ‰‹åŠ¨ä¸­æ­¢äº‹åŠ¡\r\n\r\n  ```sql\r\n  ROLLBACK;\r\n  ```\r\n\r\n* æäº¤äº‹åŠ¡ï¼Œæ˜¾ç¤ºæ‰§è¡Œæ˜¯æ‰‹åŠ¨æäº¤ï¼ŒMySQL é»˜è®¤ä¸ºè‡ªåŠ¨æäº¤\r\n\r\n  ```sql\r\n  COMMIT;\r\n  ```\r\n\r\n* ä¿å­˜ç‚¹ï¼šåœ¨äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ä¸­è®¾ç½®çš„è¿˜åŸç‚¹ï¼Œè°ƒç”¨ ROLLBACK æ—¶å¯ä»¥æŒ‡å®šå›æ»šåˆ°å“ªä¸ªç‚¹\r\n\r\n  ```sql\r\n  SAVEPOINT point_name;\t\t\t\t\t\t#è®¾ç½®ä¿å­˜ç‚¹\r\n  RELEASE point_name\t\t\t\t\t\t\t#åˆ é™¤ä¿å­˜ç‚¹\r\n  ROLLBACK [WORK] TO [SAVEPOINT] point_name\t#å›æ»šè‡³æŸä¸ªä¿å­˜ç‚¹ï¼Œä¸å¡«é»˜è®¤å›æ»šåˆ°äº‹åŠ¡æ‰§è¡Œä¹‹å‰çš„çŠ¶æ€\r\n  ```\r\n\r\n* æ“ä½œæ¼”ç¤º\r\n\r\n  ```sql\r\n  -- å¼€å¯äº‹åŠ¡\r\n  START TRANSACTION;\r\n  \r\n  -- å¼ ä¸‰ç»™æå››è½¬è´¦500å…ƒ\r\n  -- 1.å¼ ä¸‰è´¦æˆ·-500\r\n  UPDATE account SET money=money-500 WHERE NAME='å¼ ä¸‰';\r\n  -- 2.æå››è´¦æˆ·+500\r\n  UPDATE account SET money=money+500 WHERE NAME='æå››';\r\n  \r\n  -- å›æ»šäº‹åŠ¡(å‡ºç°é—®é¢˜)\r\n  ROLLBACK;\r\n  \r\n  -- æäº¤äº‹åŠ¡(æ²¡å‡ºç°é—®é¢˜)\r\n  COMMIT;\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### æäº¤æ–¹å¼\r\n\r\næäº¤æ–¹å¼çš„ç›¸å…³è¯­æ³•ï¼š\r\n\r\n- æŸ¥çœ‹äº‹åŠ¡æäº¤æ–¹å¼\r\n\r\n  ```sql\r\n  SELECT @@AUTOCOMMIT;  \t\t-- ä¼šè¯ï¼Œ1 ä»£è¡¨è‡ªåŠ¨æäº¤    0 ä»£è¡¨æ‰‹åŠ¨æäº¤\r\n  SELECT @@GLOBAL.AUTOCOMMIT;\t-- ç³»ç»Ÿ\r\n  ```\r\n\r\n- ä¿®æ”¹äº‹åŠ¡æäº¤æ–¹å¼\r\n\r\n  ```sql\r\n  SET @@AUTOCOMMIT=æ•°å­—;\t-- ç³»ç»Ÿ\r\n  SET AUTOCOMMIT=æ•°å­—;\t\t-- ä¼šè¯\r\n  ```\r\n\r\n- **ç³»ç»Ÿå˜é‡çš„æ“ä½œ**ï¼š\r\n\r\n  ```sql\r\n  SET [GLOBAL|SESSION] å˜é‡å = å€¼;\t\t\t\t\t-- é»˜è®¤æ˜¯ä¼šè¯\r\n  SET @@[(GLOBAL|SESSION).]å˜é‡å = å€¼;\t\t\t\t-- é»˜è®¤æ˜¯ç³»ç»Ÿ\r\n  ```\r\n\r\n  ```sql\r\n  SHOW [GLOBAL|SESSION] VARIABLES [LIKE 'å˜é‡%'];\t  -- é»˜è®¤æŸ¥çœ‹ä¼šè¯å†…ç³»ç»Ÿå˜é‡å€¼\r\n  ```\r\n\r\nå·¥ä½œåŸç†ï¼š\r\n\r\n* è‡ªåŠ¨æäº¤ï¼šå¦‚æœæ²¡æœ‰ START TRANSACTION æ˜¾å¼åœ°å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆ**æ¯æ¡ SQL è¯­å¥éƒ½ä¼šè¢«å½“åšä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œæäº¤æ“ä½œ**ï¼›æ˜¾å¼å¼€å¯äº‹åŠ¡åï¼Œä¼šåœ¨æœ¬æ¬¡äº‹åŠ¡ç»“æŸï¼ˆæäº¤æˆ–å›æ»šï¼‰å‰æš‚æ—¶å…³é—­è‡ªåŠ¨æäº¤\r\n* æ‰‹åŠ¨æäº¤ï¼šä¸éœ€è¦æ˜¾å¼çš„å¼€å¯äº‹åŠ¡ï¼Œæ‰€æœ‰çš„ SQL è¯­å¥éƒ½åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œç›´åˆ°æ‰§è¡Œäº†æäº¤æˆ–å›æ»šï¼Œç„¶åè¿›å…¥ä¸‹ä¸€ä¸ªäº‹åŠ¡\r\n* éšå¼æäº¤ï¼šå­˜åœ¨ä¸€äº›ç‰¹æ®Šçš„å‘½ä»¤ï¼Œåœ¨äº‹åŠ¡ä¸­æ‰§è¡Œäº†è¿™äº›å‘½ä»¤ä¼šé©¬ä¸Š**å¼ºåˆ¶æ‰§è¡Œ COMMIT æäº¤äº‹åŠ¡**\r\n  * **DDL è¯­å¥** (CREATE/DROP/ALTER)ã€LOCK TABLES è¯­å¥ã€LOAD DATA å¯¼å…¥æ•°æ®è¯­å¥ã€ä¸»ä»å¤åˆ¶è¯­å¥ç­‰\r\n  * å½“ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æˆ–å›æ»šï¼Œæ˜¾å¼çš„å¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¼šéšå¼çš„æäº¤ä¸Šä¸€ä¸ªäº‹åŠ¡\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### äº‹åŠ¡ ID\r\n\r\näº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹æŸä¸ªè¡¨æ‰§è¡Œäº†**å¢åˆ æ”¹æ“ä½œæˆ–è€…åˆ›å»ºè¡¨**ï¼Œå°±ä¼šä¸ºå½“å‰äº‹åŠ¡åˆ†é…ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„äº‹åŠ¡ IDï¼ˆå¯¹ä¸´æ—¶è¡¨å¹¶ä¸ä¼šåˆ†é… IDï¼‰ï¼Œå¦‚æœå½“å‰äº‹åŠ¡æ²¡æœ‰è¢«åˆ†é… IDï¼Œé»˜è®¤æ˜¯ 0\r\n\r\nè¯´æ˜ï¼šåªè¯»äº‹åŠ¡ä¸èƒ½å¯¹æ™®é€šçš„è¡¨è¿›è¡Œå¢åˆ æ”¹æ“ä½œï¼Œä½†æ˜¯å¯ä»¥å¯¹ä¸´æ—¶è¡¨å¢åˆ æ”¹ï¼Œè¯»å†™äº‹åŠ¡å¯ä»¥å¯¹æ•°æ®è¡¨æ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œ\r\n\r\näº‹åŠ¡ ID æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒæœåŠ¡å™¨åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡ï¼š\r\n\r\n* æ¯å½“éœ€è¦ä¸ºæŸä¸ªäº‹åŠ¡åˆ†é… IDï¼Œå°±ä¼šæŠŠå…¨å±€å˜é‡çš„å€¼èµ‹å€¼ç»™äº‹åŠ¡ IDï¼Œç„¶åå˜é‡è‡ªå¢ 1\r\n* æ¯å½“å˜é‡å€¼ä¸º 256 çš„å€æ•°æ—¶ï¼Œå°±å°†è¯¥å˜é‡çš„å€¼åˆ·æ–°åˆ°ç³»ç»Ÿè¡¨ç©ºé—´çš„ Max Trx ID å±æ€§ä¸­ï¼Œè¯¥å±æ€§å  8 å­—èŠ‚\r\n* ç³»ç»Ÿå†æ¬¡å¯åŠ¨åï¼Œä¼šè¯»å–è¡¨ç©ºé—´çš„ Max Trx ID å±æ€§åˆ°å†…å­˜ï¼ŒåŠ ä¸Š 256 åèµ‹å€¼ç»™å…¨å±€å˜é‡ï¼Œå› ä¸ºå…³æœºæ—¶çš„äº‹åŠ¡ ID å¯èƒ½å¹¶ä¸æ˜¯ 256 çš„å€æ•°ï¼Œä¼šæ¯” Max Trx ID å¤§ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Š 256 ä¿æŒäº‹åŠ¡ ID æ˜¯ä¸€ä¸ª**é€’å¢çš„æ•°å­—**\r\n\r\n**èšç°‡ç´¢å¼•**çš„è¡Œè®°å½•é™¤äº†å®Œæ•´çš„æ•°æ®ï¼Œè¿˜ä¼šè‡ªåŠ¨æ·»åŠ  trx_idã€roll_pointer éšè—åˆ—ï¼Œå¦‚æœè¡¨ä¸­æ²¡æœ‰ä¸»é”®å¹¶ä¸”æ²¡æœ‰éç©ºå”¯ä¸€ç´¢å¼•ï¼Œä¹Ÿä¼šæ·»åŠ ä¸€ä¸ª row_id çš„éšè—åˆ—ä½œä¸ºèšç°‡ç´¢å¼•\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### éš”ç¦»çº§åˆ«\r\n\r\n#### å››ç§çº§åˆ«\r\n\r\näº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼šå¤šä¸ªå®¢æˆ·ç«¯æ“ä½œæ—¶ï¼Œå„ä¸ªå®¢æˆ·ç«¯çš„äº‹åŠ¡ä¹‹é—´åº”è¯¥æ˜¯éš”ç¦»çš„ï¼Œ**ä¸åŒçš„äº‹åŠ¡ä¹‹é—´ä¸è¯¥äº’ç›¸å½±å“**ï¼Œè€Œå¦‚æœå¤šä¸ªäº‹åŠ¡æ“ä½œåŒä¸€æ‰¹æ•°æ®æ—¶ï¼Œåˆ™éœ€è¦è®¾ç½®ä¸åŒçš„éš”ç¦»çº§åˆ«ï¼Œå¦åˆ™å°±ä¼šäº§ç”Ÿé—®é¢˜ã€‚\r\n\r\néš”ç¦»çº§åˆ«åˆ†ç±»ï¼š\r\n\r\n| éš”ç¦»çº§åˆ«         | åç§°     | ä¼šå¼•å‘çš„é—®é¢˜           | æ•°æ®åº“é»˜è®¤éš”ç¦»çº§åˆ«  |\r\n| ---------------- | -------- | ---------------------- | ------------------- |\r\n| Read Uncommitted | è¯»æœªæäº¤ | è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯» |                     |\r\n| Read Committed   | è¯»å·²æäº¤ | ä¸å¯é‡å¤è¯»ã€å¹»è¯»       | Oracle / SQL Server |\r\n| Repeatable Read  | å¯é‡å¤è¯» | å¹»è¯»                   | MySQL               |\r\n| Serializable     | å¯ä¸²è¡ŒåŒ– | æ—                      |                     |\r\n\r\nä¸€èˆ¬æ¥è¯´ï¼Œéš”ç¦»çº§åˆ«è¶Šä½ï¼Œç³»ç»Ÿå¼€é”€è¶Šä½ï¼Œå¯æ”¯æŒçš„å¹¶å‘è¶Šé«˜ï¼Œä½†éš”ç¦»æ€§ä¹Ÿè¶Šå·®\r\n\r\n* è„å†™ (Dirty Write)ï¼šå½“ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡é€‰æ‹©åŒä¸€è¡Œï¼Œæœ€åˆçš„äº‹åŠ¡ä¿®æ”¹çš„å€¼è¢«åé¢äº‹åŠ¡ä¿®æ”¹çš„å€¼è¦†ç›–ï¼Œæ‰€æœ‰çš„éš”ç¦»çº§åˆ«éƒ½å¯ä»¥é¿å…è„å†™ï¼ˆåˆå«ä¸¢å¤±æ›´æ–°ï¼‰ï¼Œå› ä¸ºæœ‰è¡Œé”\r\n\r\n* è„è¯» (Dirty Reads)ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­è¯»å–äº†å¦ä¸€ä¸ª**æœªæäº¤**çš„äº‹åŠ¡ä¸­ä¿®æ”¹è¿‡çš„æ•°æ®\r\n\r\n* ä¸å¯é‡å¤è¯» (Non-Repeatable Reads)ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­è¯»å–äº†å¦ä¸€ä¸ªäº‹åŠ¡ä¸­ä¿®æ”¹å¹¶**å·²æäº¤**çš„æ•°æ®\r\n\r\n  > å¯é‡å¤è¯»çš„æ„æ€æ˜¯ä¸ç®¡è¯»å‡ æ¬¡ï¼Œç»“æœéƒ½ä¸€æ ·ï¼Œå¯ä»¥é‡å¤çš„è¯»ï¼Œå¯ä»¥ç†è§£ä¸ºå¿«ç…§è¯»ï¼Œè¦è¯»çš„æ•°æ®é›†ä¸ä¼šå‘ç”Ÿå˜åŒ–\r\n\r\n* å¹»è¯» (Phantom Reads)ï¼šåœ¨äº‹åŠ¡ä¸­æŒ‰æŸä¸ªæ¡ä»¶å…ˆåä¸¤æ¬¡æŸ¥è¯¢æ•°æ®åº“ï¼Œåä¸€æ¬¡æŸ¥è¯¢æŸ¥åˆ°äº†å‰ä¸€æ¬¡æŸ¥è¯¢æ²¡æœ‰æŸ¥åˆ°çš„è¡Œï¼Œ**æ•°æ®æ¡ç›®**å‘ç”Ÿäº†å˜åŒ–ã€‚æ¯”å¦‚æŸ¥è¯¢æŸæ•°æ®ä¸å­˜åœ¨ï¼Œå‡†å¤‡æ’å…¥æ­¤è®°å½•ï¼Œä½†æ‰§è¡Œæ’å…¥æ—¶å‘ç°æ­¤è®°å½•å·²å­˜åœ¨ï¼Œæ— æ³•æ’å…¥\r\n\r\néš”ç¦»çº§åˆ«æ“ä½œè¯­æ³•ï¼š\r\n\r\n* æŸ¥è¯¢æ•°æ®åº“éš”ç¦»çº§åˆ«\r\n\r\n  ```sql\r\n  SELECT @@TX_ISOLATION;\t\t\t-- ä¼šè¯\r\n  SELECT @@GLOBAL.TX_ISOLATION;\t-- ç³»ç»Ÿ\r\n  ```\r\n\r\n* ä¿®æ”¹æ•°æ®åº“éš”ç¦»çº§åˆ«\r\n\r\n  ```sql\r\n  SET GLOBAL TRANSACTION ISOLATION LEVEL çº§åˆ«å­—ç¬¦ä¸²;\r\n  ```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åŠ é”åˆ†æ\r\n\r\nInnoDB å­˜å‚¨å¼•æ“æ”¯æŒäº‹åŠ¡ï¼Œæ‰€ä»¥åŠ é”åˆ†ææ˜¯åŸºäºè¯¥å­˜å‚¨å¼•æ“\r\n\r\n* Read Uncommitted çº§åˆ«ï¼Œä»»ä½•æ“ä½œéƒ½ä¸ä¼šåŠ é”\r\n\r\n* Read Committed çº§åˆ«ï¼Œå¢åˆ æ”¹æ“ä½œä¼šåŠ å†™é”ï¼ˆè¡Œé”ï¼‰ï¼Œè¯»æ“ä½œä¸åŠ é”\r\n\r\n  åœ¨ Server å±‚è¿‡æ»¤æ¡ä»¶æ—¶å‘ç°ä¸æ»¡è¶³çš„è®°å½•ä¼šè°ƒç”¨ unlock_row æ–¹æ³•é‡Šæ”¾è¯¥è®°å½•çš„è¡Œé”ï¼Œä¿è¯æœ€ååªæœ‰æ»¡è¶³æ¡ä»¶çš„è®°å½•åŠ é”ï¼Œä½†æ˜¯æ‰«è¡¨è¿‡ç¨‹ä¸­æ¯æ¡è®°å½•çš„**åŠ é”æ“ä½œä¸èƒ½çœç•¥**ã€‚æ‰€ä»¥å¯¹æ•°æ®é‡å¾ˆå¤§çš„è¡¨åšæ‰¹é‡ä¿®æ”¹æ—¶ï¼Œå¦‚æœæ— æ³•ä½¿ç”¨ç›¸åº”çš„ç´¢å¼•ï¼ˆå…¨è¡¨æ‰«æï¼‰ï¼Œåœ¨ Server è¿‡æ»¤æ•°æ®æ—¶å°±ä¼šç‰¹åˆ«æ…¢ï¼Œå‡ºç°è™½ç„¶æ²¡æœ‰ä¿®æ”¹æŸäº›è¡Œçš„æ•°æ®ï¼Œä½†æ˜¯è¿˜æ˜¯è¢«é”ä½äº†çš„ç°è±¡ï¼ˆé”è¡¨ï¼‰ï¼Œè¿™ç§æƒ…å†µåŒæ ·é€‚ç”¨äº  RR\r\n\r\n* Repeatable Read çº§åˆ«ï¼Œå¢åˆ æ”¹æ“ä½œä¼šåŠ å†™é”ï¼Œè¯»æ“ä½œä¸åŠ é”ã€‚å› ä¸ºè¯»å†™é”ä¸å…¼å®¹ï¼Œ**åŠ äº†è¯»é”åå…¶ä»–äº‹åŠ¡å°±æ— æ³•ä¿®æ”¹æ•°æ®**ï¼Œå½±å“äº†å¹¶å‘æ€§èƒ½ï¼Œä¸ºäº†ä¿è¯éš”ç¦»æ€§å’Œå¹¶å‘æ€§ï¼ŒMySQL é€šè¿‡ MVCC è§£å†³äº†è¯»å†™å†²çªã€‚RR çº§åˆ«ä¸‹çš„é”æœ‰å¾ˆå¤šç§ï¼Œé”æœºåˆ¶ç« èŠ‚è¯¦è§£\r\n\r\n* Serializable çº§åˆ«ï¼Œè¯»åŠ å…±äº«é”ï¼Œå†™åŠ æ’ä»–é”ï¼Œè¯»å†™äº’æ–¥ï¼Œä½¿ç”¨çš„æ‚²è§‚é”çš„ç†è®ºï¼Œå®ç°ç®€å•ï¼Œæ•°æ®æ›´åŠ å®‰å…¨ï¼Œä½†æ˜¯å¹¶å‘èƒ½åŠ›éå¸¸å·®\r\n\r\n  * ä¸²è¡ŒåŒ–ï¼šè®©æ‰€æœ‰äº‹åŠ¡æŒ‰é¡ºåºå•ç‹¬æ‰§è¡Œï¼Œå†™æ“ä½œä¼šåŠ å†™é”ï¼Œè¯»æ“ä½œä¼šåŠ è¯»é”\r\n  * å¯ä¸²è¡ŒåŒ–ï¼šè®©æ‰€æœ‰æ“ä½œç›¸åŒæ•°æ®çš„äº‹åŠ¡é¡ºåºæ‰§è¡Œï¼Œé€šè¿‡åŠ é”å®ç°\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://tech.meituan.com/2014/08/20/innodb-lock.html\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### åŸå­ç‰¹æ€§\r\n\r\n#### å®ç°æ–¹å¼\r\n\r\nåŸå­æ€§æ˜¯æŒ‡äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡çš„æ“ä½œå¦‚æœæˆåŠŸå°±å¿…é¡»è¦å®Œå…¨åº”ç”¨åˆ°æ•°æ®åº“ï¼Œå¤±è´¥åˆ™ä¸èƒ½å¯¹æ•°æ®åº“æœ‰ä»»ä½•å½±å“ã€‚æ¯”å¦‚äº‹åŠ¡ä¸­ä¸€ä¸ª SQL è¯­å¥æ‰§è¡Œå¤±è´¥ï¼Œåˆ™å·²æ‰§è¡Œçš„è¯­å¥ä¹Ÿå¿…é¡»å›æ»šï¼Œæ•°æ®åº“é€€å›åˆ°äº‹åŠ¡å‰çš„çŠ¶æ€\r\n\r\nInnoDB å­˜å‚¨å¼•æ“æä¾›äº†ä¸¤ç§äº‹åŠ¡æ—¥å¿—ï¼šredo logï¼ˆé‡åšæ—¥å¿—ï¼‰å’Œ undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰\r\n\r\n* redo log ç”¨äºä¿è¯äº‹åŠ¡æŒä¹…æ€§\r\n* undo log ç”¨äºä¿è¯äº‹åŠ¡åŸå­æ€§å’Œéš”ç¦»æ€§\r\n\r\nundo log å±äº**é€»è¾‘æ—¥å¿—**ï¼Œæ ¹æ®æ¯è¡Œæ“ä½œè¿›è¡Œè®°å½•ï¼Œè®°å½•äº† SQL æ‰§è¡Œç›¸å…³çš„ä¿¡æ¯ï¼Œç”¨æ¥å›æ»šè¡Œè®°å½•åˆ°æŸä¸ªç‰ˆæœ¬\r\n\r\nå½“äº‹åŠ¡å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹æ—¶ï¼ŒInnoDB ä¼šå…ˆè®°å½•å¯¹åº”çš„ undo logï¼Œå¦‚æœäº‹åŠ¡æ‰§è¡Œå¤±è´¥æˆ–è°ƒç”¨äº† rollback å¯¼è‡´äº‹åŠ¡å›æ»šï¼ŒInnoDB ä¼šæ ¹æ® undo log çš„å†…å®¹**åšä¸ä¹‹å‰ç›¸åçš„æ“ä½œ**ï¼š\r\n\r\n* å¯¹äºæ¯ä¸ª insertï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œ delete\r\n\r\n* å¯¹äºæ¯ä¸ª deleteï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œ insert\r\n\r\n* å¯¹äºæ¯ä¸ª updateï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œä¸€ä¸ªç›¸åçš„ updateï¼ŒæŠŠæ•°æ®ä¿®æ”¹å›å»\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/kismetv/p/10331633.html\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### DML è§£æ\r\n\r\n##### INSERT\r\n\r\nä¹è§‚æ’å…¥ï¼šå½“å‰æ•°æ®é¡µçš„å‰©ä½™ç©ºé—´å……è¶³ï¼Œç›´æ¥å°†æ•°æ®è¿›è¡Œæ’å…¥\r\n\r\næ‚²è§‚æ’å…¥ï¼šå½“å‰æ•°æ®é¡µçš„å‰©ä½™ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è¿›è¡Œé¡µåˆ†è£‚ï¼Œç”³è¯·ä¸€ä¸ªæ–°çš„é¡µé¢æ¥æ’å…¥æ•°æ®ï¼Œä¼šé€ æˆæ›´å¤šçš„ redo logï¼Œundo log å½±å“ä¸å¤§\r\n\r\nå½“å‘æŸä¸ªè¡¨æ’å…¥ä¸€æ¡è®°å½•ï¼Œå®é™…ä¸Šéœ€è¦å‘èšç°‡ç´¢å¼•å’Œæ‰€æœ‰äºŒçº§ç´¢å¼•éƒ½æ’å…¥ä¸€æ¡è®°å½•ï¼Œä½†æ˜¯ undo log **åªé’ˆå¯¹èšç°‡ç´¢å¼•è®°å½•**ï¼Œåœ¨å›æ»šæ—¶ä¼šæ ¹æ®èšç°‡ç´¢å¼•å»æ‰€æœ‰çš„äºŒçº§ç´¢å¼•è¿›è¡Œå›æ»šæ“ä½œ\r\n\r\nroll_pointer æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œ**æŒ‡å‘è®°å½•å¯¹åº”çš„ undo log æ—¥å¿—**ï¼Œä¸€æ¡è®°å½•å°±æ˜¯ä¸€ä¸ªæ•°æ®è¡Œï¼Œè¡Œæ ¼å¼ä¸­çš„ roll_pointer å°±æŒ‡å‘ undo log\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### DELETE\r\n\r\næ’å…¥åˆ°é¡µé¢ä¸­çš„è®°å½•ä¼šæ ¹æ® next_record å±æ€§ç»„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨ç§°ä¸ºæ­£å¸¸é“¾è¡¨ï¼Œè¢«åˆ é™¤çš„è®°å½•ä¹Ÿä¼šé€šè¿‡ next_record ç»„æˆä¸€ä¸ªåƒåœ¾é“¾è¡¨ï¼Œè¯¥é“¾è¡¨ä¸­æ‰€å ç”¨çš„å­˜å‚¨ç©ºé—´å¯ä»¥è¢«é‡æ–°åˆ©ç”¨ï¼Œå¹¶ä¸ä¼šç›´æ¥æ¸…é™¤æ•°æ®\r\n\r\nåœ¨é¡µé¢ Page Header ä¸­ï¼ŒPAGE_FREE å±æ€§æŒ‡å‘åƒåœ¾é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œåˆ é™¤çš„å·¥ä½œè¿‡ç¨‹ï¼š\r\n\r\n* å°†è¦åˆ é™¤çš„è®°å½•çš„ delete_flag ä½ç½®ä¸º 1ï¼Œå…¶ä»–ä¸åšä¿®æ”¹ï¼Œè¿™ä¸ªè¿‡ç¨‹å« **delete mark**\r\n\r\n* åœ¨äº‹åŠ¡æäº¤å‰ï¼Œdelete_flag = 1 çš„è®°å½•ä¸€ç›´éƒ½ä¼šå¤„äºä¸­é—´çŠ¶æ€\r\n\r\n* äº‹åŠ¡æäº¤åï¼Œæœ‰ä¸“é—¨çš„çº¿ç¨‹å°† delete_flag = 1 çš„è®°å½•ä»æ­£å¸¸é“¾è¡¨ç§»é™¤å¹¶åŠ å…¥åƒåœ¾é“¾è¡¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å« **purge**\r\n\r\n  purge çº¿ç¨‹åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ä¼šåˆ›å»ºä¸€ä¸ª ReadViewï¼Œæ ¹æ®äº‹åŠ¡çš„å¯è§æ€§ç§»é™¤æ•°æ®ï¼ˆéš”ç¦»ç‰¹æ€§éƒ¨åˆ†è¯¦è§£ï¼‰\r\n\r\nå½“æœ‰æ–°æ’å…¥çš„è®°å½•æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­ PAGE_FREE æŒ‡å‘çš„å¤´èŠ‚ç‚¹æ˜¯å¦è¶³å¤Ÿå®¹çº³æ–°çºªå½•ï¼š\r\n\r\n* å¦‚æœå¯ä»¥å®¹çº³æ–°çºªå½•ï¼Œå°±ä¼šç›´æ¥é‡ç”¨å·²åˆ é™¤çš„è®°å½•çš„å­˜å‚¨ç©ºé—´ï¼Œç„¶åè®© PAGE_FREE æŒ‡å‘åƒåœ¾é“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\r\n* å¦‚æœä¸èƒ½å®¹çº³æ–°çºªå½•ï¼Œå°±ç›´æ¥å‘é¡µé¢ç”³è¯·æ–°çš„ç©ºé—´å­˜å‚¨ï¼Œå¹¶ä¸ä¼šéå†åƒåœ¾é“¾è¡¨\r\n\r\né‡ç”¨å·²åˆ é™¤çš„è®°å½•ç©ºé—´ï¼Œå¯èƒ½ä¼šé€ æˆç©ºé—´ç¢ç‰‡ï¼Œå½“æ•°æ®é¡µå®¹çº³ä¸äº†ä¸€æ¡è®°å½•æ—¶ï¼Œä¼šåˆ¤æ–­å°†ç¢ç‰‡ç©ºé—´åŠ èµ·æ¥æ˜¯å¦å¯ä»¥å®¹çº³ï¼Œåˆ¤æ–­ä¸ºçœŸå°±ä¼šé‡æ–°ç»„ç»‡é¡µå†…çš„è®°å½•ï¼š\r\n\r\n* å¼€è¾Ÿä¸€ä¸ªä¸´æ—¶é¡µé¢ï¼Œå°†é¡µå†…è®°å½•ä¸€æ¬¡æ’å…¥åˆ°ä¸´æ—¶é¡µé¢ï¼Œæ­¤æ—¶ä¸´æ—¶é¡µé¢æ—¶æ²¡æœ‰ç¢ç‰‡çš„\r\n* æŠŠä¸´æ—¶é¡µé¢çš„å†…å®¹å¤åˆ¶åˆ°æœ¬é¡µï¼Œè¿™æ ·å°±è§£æ”¾å‡ºäº†å†…å­˜ç¢ç‰‡ï¼Œä½†æ˜¯ä¼šè€—è´¹å¾ˆå¤§çš„æ€§èƒ½èµ„æº\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n##### UPDATE\r\n\r\næ‰§è¡Œ UPDATE è¯­å¥ï¼Œå¯¹äºæ›´æ–°ä¸»é”®å’Œä¸æ›´æ–°ä¸»é”®æœ‰ä¸¤ç§ä¸åŒçš„å¤„ç†æ–¹å¼\r\n\r\nä¸æ›´æ–°ä¸»é”®çš„æƒ…å†µï¼š\r\n\r\n* å°±åœ°æ›´æ–°ï¼ˆin-place updateï¼‰ï¼Œå¦‚æœæ›´æ–°åçš„åˆ—å’Œæ›´æ–°å‰çš„åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´ä¸€æ ·å¤§ï¼Œå°±å¯ä»¥ç›´æ¥åœ¨åŸè®°å½•ä¸Šä¿®æ”¹\r\n\r\n* å…ˆåˆ é™¤æ—§çºªå½•ï¼Œå†æ’å…¥æ–°çºªå½•ï¼Œè¿™é‡Œçš„åˆ é™¤ä¸æ˜¯ delete markï¼Œè€Œæ˜¯ç›´æ¥å°†è®°å½•åŠ å…¥åƒåœ¾é“¾è¡¨ï¼Œå¹¶ä¸”ä¿®æ”¹é¡µé¢çš„ç›¸åº”çš„æ§åˆ¶ä¿¡æ¯ï¼Œæ‰§è¡Œåˆ é™¤çš„çº¿ç¨‹ä¸æ˜¯ purgeï¼Œæ˜¯æ‰§è¡Œæ›´æ–°çš„ç”¨æˆ·çº¿ç¨‹ï¼Œæ’å…¥æ–°è®°å½•æ—¶å¯èƒ½é€ æˆé¡µç©ºé—´ä¸è¶³ï¼Œä»è€Œå¯¼è‡´é¡µåˆ†è£‚\r\n\r\n\r\næ›´æ–°ä¸»é”®çš„æƒ…å†µï¼š\r\n\r\n* å°†æ—§çºªå½•è¿›è¡Œ delete markï¼Œåœ¨æ›´æ–°è¯­å¥æäº¤åç”± purge çº¿ç¨‹ç§»å…¥åƒåœ¾é“¾è¡¨\r\n* æ ¹æ®æ›´æ–°çš„å„åˆ—çš„å€¼åˆ›å»ºä¸€æ¡æ–°çºªå½•ï¼Œæ’å…¥åˆ°èšç°‡ç´¢å¼•ä¸­\r\n\r\nåœ¨å¯¹ä¸€æ¡è®°å½•ä¿®æ”¹å‰ä¼š**å°†è®°å½•çš„éšè—åˆ— trx_id å’Œ roll_pointer çš„æ—§å€¼è®°å½•åˆ°å½“å‰ undo log å¯¹åº”çš„å±æ€§ä¸­**ï¼Œè¿™æ ·å½“å‰è®°å½•çš„ roll_pointer æŒ‡å‘å½“å‰ undo log è®°å½•ï¼Œå½“å‰ undo log è®°å½•çš„ roll_pointer æŒ‡å‘æ—§çš„ undo log è®°å½•ï¼Œ**å½¢æˆä¸€ä¸ªç‰ˆæœ¬é“¾**\r\n\r\nUPDATEã€DELETE æ“ä½œäº§ç”Ÿçš„ undo æ—¥å¿—ä¼šç”¨äºå…¶ä»–äº‹åŠ¡çš„ MVCC æ“ä½œï¼Œæ‰€ä»¥ä¸èƒ½ç«‹å³åˆ é™¤ï¼ŒINSERT å¯ä»¥åˆ é™¤çš„åŸå› æ˜¯ MVCC æ˜¯å¯¹ç°æœ‰æ•°æ®çš„å¿«ç…§\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å›æ»šæ—¥å¿—\r\n\r\nundo log æ˜¯é‡‡ç”¨æ®µçš„æ–¹å¼æ¥è®°å½•ï¼ŒRollback Segement ç§°ä¸ºå›æ»šæ®µï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªç±»å‹æ˜¯ Rollback Segement Header çš„é¡µé¢\r\n\r\næ¯ä¸ªå›æ»šæ®µä¸­æœ‰ 1024 ä¸ª undo slotï¼Œæ¯ä¸ª slot å­˜æ”¾ undo é“¾è¡¨é¡µé¢çš„å¤´èŠ‚ç‚¹é¡µå·ï¼Œæ¯ä¸ªé“¾è¡¨å¯¹åº”ä¸€ä¸ªå« undo log segment çš„æ®µ\r\n\r\n* åœ¨ä»¥å‰è€ç‰ˆæœ¬ï¼Œåªæ”¯æŒ 1 ä¸ª Rollback Segementï¼Œåªèƒ½è®°å½• 1024 ä¸ª undo log segment\r\n* MySQL5.5 å¼€å§‹æ”¯æŒ 128 ä¸ª Rollback Segementï¼Œæ”¯æŒ 128*1024 ä¸ª undo æ“ä½œ\r\n\r\nå·¥ä½œæµç¨‹ï¼š\r\n\r\n* äº‹åŠ¡æ‰§è¡Œå‰éœ€è¦åˆ°ç³»ç»Ÿè¡¨ç©ºé—´ç¬¬ 5 å·é¡µé¢ä¸­åˆ†é…ä¸€ä¸ªå›æ»šæ®µï¼ˆé¡µï¼‰ï¼Œè·å–ä¸€ä¸ª Rollback Segement Header é¡µé¢çš„åœ°å€\r\n\r\n* å›æ»šæ®µé¡µé¢æœ‰ 1024 ä¸ª undo slotï¼Œé¦–å…ˆå»å›æ»šæ®µçš„ä¸¤ä¸ª cached é“¾è¡¨è·å–ç¼“å­˜çš„ slotï¼Œç¼“å­˜ä¸­æ²¡æœ‰å°±åœ¨å›æ»šæ®µé¡µé¢ä¸­æ‰¾ä¸€ä¸ªå¯ç”¨çš„ undo slot åˆ†é…ç»™å½“å‰äº‹åŠ¡\r\n\r\n* å¦‚æœæ˜¯ç¼“å­˜ä¸­è·å–çš„ slotï¼Œåˆ™è¯¥ slot å¯¹åº”çš„ undo log segment å·²ç»åˆ†é…äº†ï¼Œéœ€è¦é‡æ–°åˆ†é…ï¼Œç„¶åä» undo log segment ä¸­ç”³è¯·ä¸€ä¸ªé¡µé¢ä½œä¸ºæ—¥å¿—é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œå¹¶å¡«å…¥å¯¹åº”çš„ slot ä¸­\r\n\r\n* æ¯ä¸ªäº‹åŠ¡ undo æ—¥å¿—åœ¨è®°å½•çš„æ—¶å€™**å ç”¨ä¸¤ä¸ª undo é¡µé¢çš„ç»„æˆé“¾è¡¨**ï¼Œåˆ†åˆ«ä¸º insert undo é“¾è¡¨å’Œ update undo é“¾è¡¨ï¼Œé“¾è¡¨çš„å¤´èŠ‚ç‚¹é¡µé¢ä¸º first undo page ä¼šåŒ…å«ä¸€äº›ç®¡ç†ä¿¡æ¯ï¼Œå…¶ä»–é¡µé¢ä¸º normal undo page\r\n\r\n  è¯´æ˜ï¼šäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹çš„ä¸´æ—¶è¡¨ä¹Ÿéœ€è¦ä¸¤ä¸ª undo é“¾è¡¨ï¼Œä¸å’Œæ™®é€šè¡¨å…±ç”¨ï¼Œè¿™äº›é“¾è¡¨å¹¶ä¸æ˜¯äº‹åŠ¡å¼€å§‹å°±åˆ†é…ï¼Œè€Œæ˜¯æŒ‰éœ€åˆ†é…\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### éš”ç¦»ç‰¹æ€§\r\n\r\n#### å®ç°æ–¹å¼\r\n\r\néš”ç¦»æ€§æ˜¯æŒ‡ï¼Œäº‹åŠ¡å†…éƒ¨çš„æ“ä½œä¸å…¶ä»–äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¤šä¸ªå¹¶å‘äº‹åŠ¡ä¹‹é—´è¦ç›¸äº’éš”ç¦»ï¼Œä¸èƒ½äº’ç›¸å¹²æ‰°\r\n\r\n* ä¸¥æ ¼çš„éš”ç¦»æ€§ï¼Œå¯¹åº”äº†äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸­çš„ serializableï¼Œå®é™…åº”ç”¨ä¸­å¯¹æ€§èƒ½è€ƒè™‘å¾ˆå°‘ä½¿ç”¨å¯ä¸²è¡ŒåŒ–\r\n\r\n* ä¸åŸå­æ€§ã€æŒä¹…æ€§ä¾§é‡äºç ”ç©¶äº‹åŠ¡æœ¬èº«ä¸åŒï¼Œéš”ç¦»æ€§ç ”ç©¶çš„æ˜¯**ä¸åŒäº‹åŠ¡**ä¹‹é—´çš„ç›¸äº’å½±å“\r\n\r\néš”ç¦»æ€§è®©å¹¶å‘æƒ…å½¢ä¸‹çš„äº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°ï¼š\r\n\r\n- ä¸€ä¸ªäº‹åŠ¡çš„å†™æ“ä½œå¯¹å¦ä¸€ä¸ªäº‹åŠ¡çš„å†™æ“ä½œï¼ˆå†™å†™ï¼‰ï¼šé”æœºåˆ¶ä¿è¯éš”ç¦»æ€§\r\n- ä¸€ä¸ªäº‹åŠ¡çš„å†™æ“ä½œå¯¹å¦ä¸€ä¸ªäº‹åŠ¡çš„è¯»æ“ä½œï¼ˆè¯»å†™ï¼‰ï¼šMVCC ä¿è¯éš”ç¦»æ€§\r\n\r\né”æœºåˆ¶ï¼šäº‹åŠ¡åœ¨ä¿®æ”¹æ•°æ®ä¹‹å‰ï¼Œéœ€è¦å…ˆè·å¾—ç›¸åº”çš„é”ï¼Œè·å¾—é”ä¹‹åï¼Œäº‹åŠ¡ä¾¿å¯ä»¥ä¿®æ”¹æ•°æ®ï¼›è¯¥äº‹åŠ¡æ“ä½œæœŸé—´ï¼Œè¿™éƒ¨åˆ†æ•°æ®æ˜¯é”å®šçš„ï¼Œå…¶ä»–äº‹åŠ¡å¦‚æœéœ€è¦ä¿®æ”¹æ•°æ®ï¼Œéœ€è¦ç­‰å¾…å½“å‰äº‹åŠ¡æäº¤æˆ–å›æ»šåé‡Šæ”¾é”ï¼ˆè¯¦è§£è§é”æœºåˆ¶ï¼‰\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å¹¶å‘æ§åˆ¶\r\n\r\nMVCC å…¨ç§° Multi-Version Concurrency Controlï¼Œå³å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œç”¨æ¥**è§£å†³è¯»å†™å†²çªçš„æ— é”å¹¶å‘æ§åˆ¶**ï¼Œå¯ä»¥åœ¨å‘ç”Ÿè¯»å†™è¯·æ±‚å†²çªæ—¶ä¸ç”¨åŠ é”è§£å†³ï¼Œè¿™ä¸ªè¯»æ˜¯æŒ‡çš„å¿«ç…§è¯»ï¼ˆä¹Ÿå«ä¸€è‡´æ€§è¯»æˆ–ä¸€è‡´æ€§æ— é”è¯»ï¼‰ï¼Œè€Œä¸æ˜¯å½“å‰è¯»ï¼š\r\n\r\n* å¿«ç…§è¯»ï¼šå®ç°åŸºäº MVCCï¼Œå› ä¸ºæ˜¯å¤šç‰ˆæœ¬å¹¶å‘ï¼Œæ‰€ä»¥å¿«ç…§è¯»è¯»åˆ°çš„æ•°æ®ä¸ä¸€å®šæ˜¯å½“å‰æœ€æ–°çš„æ•°æ®ï¼Œæœ‰å¯èƒ½æ˜¯å†å²ç‰ˆæœ¬çš„æ•°æ®\r\n* å½“å‰è¯»ï¼šåˆå«åŠ é”è¯»ï¼Œè¯»å–æ•°æ®åº“è®°å½•æ˜¯å½“å‰**æœ€æ–°çš„ç‰ˆæœ¬**ï¼ˆäº§ç”Ÿå¹»è¯»ã€ä¸å¯é‡å¤è¯»ï¼‰ï¼Œå¯ä»¥å¯¹è¯»å–çš„æ•°æ®è¿›è¡ŒåŠ é”ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡ä¿®æ”¹æ•°æ®ï¼Œæ˜¯æ‚²è§‚é”çš„ä¸€ç§æ“ä½œï¼Œè¯»å†™æ“ä½œåŠ å…±äº«é”æˆ–è€…æ’ä»–é”å’Œä¸²è¡ŒåŒ–äº‹åŠ¡çš„éš”ç¦»çº§åˆ«éƒ½æ˜¯å½“å‰è¯»\r\n\r\næ•°æ®åº“å¹¶å‘åœºæ™¯ï¼š\r\n\r\n* è¯»-è¯»ï¼šä¸å­˜åœ¨ä»»ä½•é—®é¢˜ï¼Œä¹Ÿä¸éœ€è¦å¹¶å‘æ§åˆ¶\r\n\r\n* è¯»-å†™ï¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯èƒ½ä¼šé€ æˆäº‹åŠ¡éš”ç¦»æ€§é—®é¢˜ï¼Œå¯èƒ½é‡åˆ°è„è¯»ï¼Œå¹»è¯»ï¼Œä¸å¯é‡å¤è¯»\r\n\r\n* å†™-å†™ï¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯èƒ½ä¼šå­˜åœ¨è„å†™ï¼ˆä¸¢å¤±æ›´æ–°ï¼‰é—®é¢˜\r\n\r\nMVCC çš„ä¼˜ç‚¹ï¼š\r\n\r\n* åœ¨å¹¶å‘è¯»å†™æ•°æ®åº“æ—¶ï¼Œåšåˆ°åœ¨è¯»æ“ä½œæ—¶ä¸ç”¨é˜»å¡å†™æ“ä½œï¼Œå†™æ“ä½œä¹Ÿä¸ç”¨é˜»å¡è¯»æ“ä½œï¼Œæé«˜äº†å¹¶å‘è¯»å†™çš„æ€§èƒ½\r\n* å¯ä»¥è§£å†³è„è¯»ï¼Œä¸å¯é‡å¤è¯»ç­‰äº‹åŠ¡éš”ç¦»é—®é¢˜ï¼ˆåŠ é”ä¹Ÿèƒ½è§£å†³ï¼‰ï¼Œä½†ä¸èƒ½è§£å†³æ›´æ–°ä¸¢å¤±é—®é¢˜ï¼ˆå†™é”ä¼šè§£å†³ï¼‰\r\n\r\næé«˜è¯»å†™å’Œå†™å†™çš„å¹¶å‘æ€§èƒ½ï¼š\r\n\r\n* MVCC + æ‚²è§‚é”ï¼šMVCC è§£å†³è¯»å†™å†²çªï¼Œæ‚²è§‚é”è§£å†³å†™å†™å†²çª\r\n* MVCC + ä¹è§‚é”ï¼šMVCC è§£å†³è¯»å†™å†²çªï¼Œä¹è§‚é”è§£å†³å†™å†™å†²çª\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://www.jianshu.com/p/8845ddca3b23\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å®ç°åŸç†\r\n\r\n##### éšè—å­—æ®µ\r\n\r\nå®ç°åŸç†ä¸»è¦æ˜¯éšè—å­—æ®µï¼Œundoæ—¥å¿—ï¼ŒRead View æ¥å®ç°çš„\r\n\r\nInnoDB å­˜å‚¨å¼•æ“ï¼Œæ•°æ®åº“ä¸­çš„**èšç°‡ç´¢å¼•**æ¯è¡Œæ•°æ®ï¼Œé™¤äº†è‡ªå®šä¹‰çš„å­—æ®µï¼Œè¿˜æœ‰æ•°æ®åº“éšå¼å®šä¹‰çš„å­—æ®µï¼š\r\n\r\n* DB_TRX_IDï¼šæœ€è¿‘ä¿®æ”¹äº‹åŠ¡ IDï¼Œè®°å½•åˆ›å»ºè¯¥æ•°æ®æˆ–æœ€åä¸€æ¬¡ä¿®æ”¹è¯¥æ•°æ®çš„äº‹åŠ¡ ID\r\n* DB_ROLL_PTRï¼šå›æ»šæŒ‡é’ˆï¼Œ**æŒ‡å‘è®°å½•å¯¹åº”çš„ undo log æ—¥å¿—**ï¼Œundo log ä¸­åˆæŒ‡å‘ä¸Šä¸€ä¸ªæ—§ç‰ˆæœ¬çš„ undo log\r\n* DB_ROW_IDï¼šéšå«çš„è‡ªå¢ IDï¼ˆ**éšè—ä¸»é”®**ï¼‰ï¼Œå¦‚æœæ•°æ®è¡¨æ²¡æœ‰ä¸»é”®ï¼ŒInnoDB ä¼šè‡ªåŠ¨ä»¥ DB_ROW_ID ä½œä¸ºèšç°‡ç´¢å¼•\r\n\r\n![image-20250320011302852](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011302852.png)\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ç‰ˆæœ¬é“¾\r\n\r\nundo log æ˜¯é€»è¾‘æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯æ¯ä¸ªäº‹åŠ¡å¯¹æ•°æ®æ‰§è¡Œçš„æ“ä½œï¼Œè€Œä¸æ˜¯è®°å½•çš„å…¨éƒ¨æ•°æ®ï¼Œè¦**æ ¹æ® undo log é€†æ¨å‡ºä»¥å¾€äº‹åŠ¡çš„æ•°æ®**\r\n\r\nundo log çš„ä½œç”¨ï¼š\r\n\r\n* ä¿è¯äº‹åŠ¡è¿›è¡Œ rollback æ—¶çš„åŸå­æ€§å’Œä¸€è‡´æ€§ï¼Œå½“äº‹åŠ¡è¿›è¡Œå›æ»šçš„æ—¶å€™å¯ä»¥ç”¨ undo log çš„æ•°æ®è¿›è¡Œæ¢å¤\r\n* ç”¨äº MVCC å¿«ç…§è¯»ï¼Œé€šè¿‡è¯»å– undo log çš„å†å²ç‰ˆæœ¬æ•°æ®å¯ä»¥å®ç°ä¸åŒäº‹åŠ¡ç‰ˆæœ¬å·éƒ½æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å¿«ç…§æ•°æ®\r\n\r\nundo log ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼š\r\n\r\n* insert undo logï¼šäº‹åŠ¡åœ¨ insert æ–°è®°å½•æ—¶äº§ç”Ÿçš„ undo logï¼Œåªåœ¨äº‹åŠ¡å›æ»šæ—¶éœ€è¦ï¼Œå¹¶ä¸”åœ¨äº‹åŠ¡æäº¤åå¯ä»¥è¢«ç«‹å³ä¸¢å¼ƒ\r\n\r\n* update undo logï¼šäº‹åŠ¡åœ¨è¿›è¡Œ update æˆ– delete æ—¶äº§ç”Ÿçš„ undo logï¼Œåœ¨äº‹åŠ¡å›æ»šæ—¶éœ€è¦ï¼Œåœ¨å¿«ç…§è¯»æ—¶ä¹Ÿéœ€è¦ã€‚ä¸èƒ½éšæ„åˆ é™¤ï¼Œåªæœ‰åœ¨å½“å‰è¯»æˆ–äº‹åŠ¡å›æ»šä¸æ¶‰åŠè¯¥æ—¥å¿—æ—¶ï¼Œå¯¹åº”çš„æ—¥å¿—æ‰ä¼šè¢« purge çº¿ç¨‹ç»Ÿä¸€æ¸…é™¤\r\n\r\næ¯æ¬¡å¯¹æ•°æ®åº“è®°å½•è¿›è¡Œæ”¹åŠ¨ï¼Œéƒ½ä¼šäº§ç”Ÿçš„æ–°ç‰ˆæœ¬çš„ undo logï¼Œéšç€æ›´æ–°æ¬¡æ•°çš„å¢å¤šï¼Œæ‰€æœ‰çš„ç‰ˆæœ¬éƒ½ä¼šè¢« roll_pointer å±æ€§è¿æ¥æˆä¸€ä¸ªé“¾è¡¨ï¼ŒæŠŠè¿™ä¸ªé“¾è¡¨ç§°ä¹‹ä¸º**ç‰ˆæœ¬é“¾**ï¼Œç‰ˆæœ¬é“¾çš„å¤´èŠ‚ç‚¹å°±æ˜¯å½“å‰çš„æœ€æ–°çš„ undo logï¼Œé“¾å°¾å°±æ˜¯æœ€æ—©çš„æ—§ undo log\r\n\r\nè¯´æ˜ï¼šå› ä¸º DELETE åˆ é™¤è®°å½•ï¼Œéƒ½æ˜¯ç§»åŠ¨åˆ°åƒåœ¾é“¾è¡¨ä¸­ï¼Œä¸æ˜¯çœŸæ­£çš„åˆ é™¤ï¼Œæ‰€ä»¥æ‰å¯ä»¥é€šè¿‡ç‰ˆæœ¬é“¾è®¿é—®åŸå§‹æ•°æ®\r\n\r\n![image-20250320011625759](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011625759.png)\r\n\r\næ³¨æ„ï¼šundo æ˜¯é€»è¾‘æ—¥å¿—ï¼Œè¿™é‡Œåªæ˜¯ç›´è§‚çš„å±•ç¤ºå‡ºæ¥\r\n\r\nå·¥ä½œæµç¨‹ï¼š\r\n\r\n* æœ‰ä¸ªäº‹åŠ¡æ’å…¥ persion è¡¨ä¸€æ¡æ–°è®°å½•ï¼Œname ä¸º Jerryï¼Œage ä¸º 24\r\n* äº‹åŠ¡ 1 ä¿®æ”¹è¯¥è¡Œæ•°æ®æ—¶ï¼Œæ•°æ®åº“ä¼šå…ˆå¯¹è¯¥è¡ŒåŠ æ’ä»–é”ï¼Œç„¶åå…ˆè®°å½• undo logï¼Œç„¶åä¿®æ”¹è¯¥è¡Œ name ä¸º Tomï¼Œå¹¶ä¸”ä¿®æ”¹éšè—å­—æ®µçš„äº‹åŠ¡ ID ä¸ºå½“å‰äº‹åŠ¡ 1 çš„ IDï¼ˆé»˜è®¤ä¸º 1 ä¹‹åé€’å¢ï¼‰ï¼Œå›æ»šæŒ‡é’ˆæŒ‡å‘æ‹·è´åˆ° undo log çš„å‰¯æœ¬è®°å½•ï¼Œäº‹åŠ¡æäº¤åï¼Œé‡Šæ”¾é”\r\n* ä»¥æ­¤ç±»æ¨\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### è¯»è§†å›¾\r\n\r\nRead View æ˜¯äº‹åŠ¡è¿›è¡Œè¯»æ•°æ®æ“ä½œæ—¶äº§ç”Ÿçš„è¯»è§†å›¾ï¼Œè¯¥äº‹åŠ¡æ‰§è¡Œå¿«ç…§è¯»çš„é‚£ä¸€åˆ»ä¼šç”Ÿæˆæ•°æ®åº“ç³»ç»Ÿå½“å‰çš„ä¸€ä¸ªå¿«ç…§ï¼Œè®°å½•å¹¶ç»´æŠ¤ç³»ç»Ÿå½“å‰æ´»è·ƒäº‹åŠ¡çš„ IDï¼Œç”¨æ¥åšå¯è§æ€§åˆ¤æ–­ï¼Œæ ¹æ®è§†å›¾åˆ¤æ–­å½“å‰äº‹åŠ¡èƒ½å¤Ÿçœ‹åˆ°å“ªä¸ªç‰ˆæœ¬çš„æ•°æ®\r\n\r\næ³¨æ„ï¼šè¿™é‡Œçš„å¿«ç…§å¹¶ä¸æ˜¯æŠŠæ‰€æœ‰çš„æ•°æ®æ‹·è´ä¸€ä»½å‰¯æœ¬ï¼Œè€Œæ˜¯ç”± undo log è®°å½•çš„é€»è¾‘æ—¥å¿—ï¼Œæ ¹æ®åº“ä¸­çš„æ•°æ®è¿›è¡Œè®¡ç®—å‡ºå†å²æ•°æ®\r\n\r\nå·¥ä½œæµç¨‹ï¼šå°†ç‰ˆæœ¬é“¾çš„å¤´èŠ‚ç‚¹çš„äº‹åŠ¡ IDï¼ˆæœ€æ–°æ•°æ®äº‹åŠ¡ IDï¼Œå¤§æ¦‚ç‡ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼‰DB_TRX_ID å–å‡ºæ¥ï¼Œä¸ç³»ç»Ÿå½“å‰æ´»è·ƒäº‹åŠ¡çš„ ID å¯¹æ¯”è¿›è¡Œå¯è§æ€§åˆ†æï¼Œä¸å¯è§å°±é€šè¿‡ DB_ROLL_PTR å›æ»šæŒ‡é’ˆå»å–å‡º undo log ä¸­çš„ä¸‹ä¸€ä¸ª DB_TRX_ID æ¯”è¾ƒï¼Œç›´åˆ°æ‰¾åˆ°æœ€è¿‘çš„æ»¡è¶³å¯è§æ€§çš„ DB_TRX_IDï¼Œè¯¥äº‹åŠ¡ ID æ‰€åœ¨çš„æ—§è®°å½•å°±æ˜¯å½“å‰äº‹åŠ¡èƒ½çœ‹è§çš„æœ€æ–°çš„è®°å½•\r\n\r\nRead View å‡ ä¸ªå±æ€§ï¼š\r\n\r\n- m_idsï¼šç”Ÿæˆ Read View æ—¶å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„äº‹åŠ¡ id åˆ—è¡¨ï¼ˆæœªæäº¤çš„äº‹åŠ¡é›†åˆï¼Œå½“å‰äº‹åŠ¡ä¹Ÿåœ¨å…¶ä¸­ï¼‰\r\n- min_trx_idï¼šç”Ÿæˆ Read View æ—¶å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„æœ€å°çš„äº‹åŠ¡ idï¼Œä¹Ÿå°±æ˜¯ m_ids ä¸­çš„æœ€å°å€¼ï¼ˆå·²æäº¤çš„äº‹åŠ¡é›†åˆï¼‰\r\n- max_trx_idï¼šç”Ÿæˆ Read View æ—¶å½“å‰ç³»ç»Ÿåº”è¯¥åˆ†é…ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„ id å€¼ï¼Œm_ids ä¸­çš„æœ€å¤§å€¼åŠ  1ï¼ˆæœªå¼€å§‹äº‹åŠ¡ï¼‰\r\n- creator_trx_idï¼šç”Ÿæˆè¯¥ Read View çš„äº‹åŠ¡çš„äº‹åŠ¡ idï¼Œå°±æ˜¯åˆ¤æ–­è¯¥ id çš„äº‹åŠ¡èƒ½è¯»åˆ°ä»€ä¹ˆæ•°æ®\r\n\r\ncreator åˆ›å»ºä¸€ä¸ª Read Viewï¼Œè¿›è¡Œå¯è§æ€§ç®—æ³•åˆ†æï¼šï¼ˆè§£å†³äº†è¯»æœªæäº¤ï¼‰\r\n\r\n*  db_trx_id == creator_trx_idï¼šè¡¨ç¤ºè¿™ä¸ªæ•°æ®å°±æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ç”Ÿæˆçš„ï¼Œè‡ªå·±ç”Ÿæˆçš„æ•°æ®è‡ªå·±è‚¯å®šèƒ½çœ‹è§ï¼Œæ‰€ä»¥æ­¤æ•°æ®å¯¹ creator æ˜¯å¯è§çš„\r\n*  db_trx_id <  min_trx_idï¼šè¯¥ç‰ˆæœ¬å¯¹åº”çš„äº‹åŠ¡ ID å°äº Read view ä¸­çš„æœ€å°æ´»è·ƒäº‹åŠ¡ IDï¼Œåˆ™è¿™ä¸ªäº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡ä¹‹å‰å°±å·²ç»è¢«æäº¤äº†ï¼Œå¯¹ creator å¯è§ï¼ˆå› ä¸ºæ¯”å·²æäº¤çš„æœ€å¤§äº‹åŠ¡ ID å°çš„å¹¶ä¸ä¸€å®šå·²ç»æäº¤ï¼Œæ‰€ä»¥åº”è¯¥åˆ¤æ–­æ˜¯å¦åœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼‰\r\n\r\n*  db_trx_id >= max_trx_idï¼šè¯¥ç‰ˆæœ¬å¯¹åº”çš„äº‹åŠ¡ ID å¤§äº Read view ä¸­å½“å‰ç³»ç»Ÿçš„æœ€å¤§äº‹åŠ¡ IDï¼Œåˆ™è¯´æ˜è¯¥æ•°æ®æ˜¯åœ¨å½“å‰ Read view åˆ›å»ºä¹‹åæ‰äº§ç”Ÿçš„ï¼Œå¯¹ creator ä¸å¯è§\r\n*  min_trx_id<= db_trx_id < max_trx_idï¼šåˆ¤æ–­ db_trx_id æ˜¯å¦åœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ m_ids ä¸­\r\n   * åœ¨åˆ—è¡¨ä¸­ï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬å¯¹åº”çš„äº‹åŠ¡æ­£åœ¨è¿è¡Œï¼Œæ•°æ®ä¸èƒ½æ˜¾ç¤ºï¼ˆ**ä¸èƒ½è¯»åˆ°æœªæäº¤çš„æ•°æ®**ï¼‰\r\n   * ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬å¯¹åº”çš„äº‹åŠ¡å·²ç»è¢«æäº¤ï¼Œæ•°æ®å¯ä»¥æ˜¾ç¤ºï¼ˆ**å¯ä»¥è¯»åˆ°å·²ç»æäº¤çš„æ•°æ®**ï¼‰\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### å·¥ä½œæµç¨‹\r\n\r\nè¡¨ user æ•°æ®\r\n\r\n```sh\r\nid\t\tname\t\tage\r\n1\t\tå¼ ä¸‰\t\t   18\t\r\n```\r\n\r\nTransaction 20ï¼š\r\n\r\n```sql\r\nSTART TRANSACTION;\t-- å¼€å¯äº‹åŠ¡\r\nUPDATE user SET name = 'æå››' WHERE id = 1;\r\nUPDATE user SET name = 'ç‹äº”' WHERE id = 1;\r\n```\r\n\r\nTransaction 60ï¼š\r\n\r\n```sql\r\nSTART TRANSACTION;\t-- å¼€å¯äº‹åŠ¡\r\n-- æ“ä½œè¡¨çš„å…¶ä»–æ•°æ®\r\n```\r\n\r\n![image-20250320011657453](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011657453.png)\r\n\r\nID ä¸º 0 çš„äº‹åŠ¡åˆ›å»º Read Viewï¼š\r\n\r\n* m_idsï¼š20ã€60\r\n* min_trx_idï¼š20\r\n* max_trx_idï¼š61\r\n* creator_trx_idï¼š0\r\n\r\n![image-20250320011726021](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011726021.png)\r\n\r\nåªæœ‰çº¢æ¡†éƒ¨åˆ†æ‰å¤åˆæ¡ä»¶ï¼Œæ‰€ä»¥åªæœ‰å¼ ä¸‰å¯¹åº”çš„ç‰ˆæœ¬çš„æ•°æ®å¯ä»¥è¢«çœ‹åˆ°\r\n\r\n\r\n\r\nå‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1t5411u7Fg\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### äºŒçº§ç´¢å¼•\r\n\r\nåªæœ‰åœ¨èšç°‡ç´¢å¼•ä¸­æ‰æœ‰ trx_id å’Œ roll_pointer çš„éšè—åˆ—ï¼Œå¯¹äºäºŒçº§ç´¢å¼•åˆ¤æ–­å¯è§æ€§çš„æ–¹å¼ï¼š\r\n\r\n* äºŒçº§ç´¢å¼•é¡µé¢çš„ Page Header ä¸­æœ‰ä¸€ä¸ª PAGE_MAX_TRX_ID å±æ€§ï¼Œä»£è¡¨ä¿®æ”¹å½“å‰é¡µé¢çš„æœ€å¤§çš„äº‹åŠ¡ IDï¼ŒSELECT è¯­å¥è®¿é—®æŸä¸ªäºŒçº§ç´¢å¼•æ—¶ä¼šåˆ¤æ–­ ReadView çš„ min_trx_id æ˜¯å¦å¤§äºè¯¥å±æ€§ï¼Œå¤§äºè¯´æ˜è¯¥é¡µé¢çš„æ‰€æœ‰å±æ€§å¯¹ ReadView å¯è§\r\n* å¦‚æœå±æ€§åˆ¤æ–­ä¸å¯è§ï¼Œå°±éœ€è¦åˆ©ç”¨äºŒçº§ç´¢å¼•è·å–ä¸»é”®å€¼è¿›è¡Œ**å›è¡¨æ“ä½œ**ï¼Œå¾—åˆ°èšç°‡ç´¢å¼•åæŒ‰ç…§èšç°‡ç´¢å¼•çš„å¯è§æ€§åˆ¤æ–­çš„æ–¹æ³•æ“ä½œ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### RC RR\r\n\r\nRead View ç”¨äºæ”¯æŒ RCï¼ˆRead Committedï¼Œè¯»å·²æäº¤ï¼‰å’Œ RRï¼ˆRepeatable Readï¼Œå¯é‡å¤è¯»ï¼‰éš”ç¦»çº§åˆ«çš„å®ç°ï¼Œæ‰€ä»¥ **SELECT åœ¨ RC å’Œ RR éš”ç¦»çº§åˆ«ä½¿ç”¨ MVCC è¯»å–è®°å½•**\r\n\r\nRRã€RC ç”Ÿæˆæ—¶æœºï¼š\r\n\r\n- RC éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ¯æ¬¡è¯»å–æ•°æ®å‰éƒ½ä¼šç”Ÿæˆæœ€æ–°çš„ Read Viewï¼ˆå½“å‰è¯»ï¼‰\r\n- RR éš”ç¦»çº§åˆ«ä¸‹ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ•°æ®è¯»å–æ—¶æ‰ä¼šåˆ›å»º Read Viewï¼ˆå¿«ç…§è¯»ï¼‰\r\n\r\nRCã€RR çº§åˆ«ä¸‹çš„ InnoDB å¿«ç…§è¯»åŒºåˆ«\r\n\r\n- RC çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡ä¸­æ¯æ¬¡å¿«ç…§è¯»éƒ½ä¼šæ–°ç”Ÿæˆä¸€ä¸ª Read Viewï¼Œè¿™å°±æ˜¯åœ¨ RC çº§åˆ«ä¸‹çš„äº‹åŠ¡ä¸­å¯ä»¥çœ‹åˆ°åˆ«çš„äº‹åŠ¡æäº¤çš„æ›´æ–°çš„åŸå› \r\n\r\n- RR çº§åˆ«ä¸‹ï¼ŒæŸä¸ªäº‹åŠ¡çš„å¯¹æŸæ¡è®°å½•çš„**ç¬¬ä¸€æ¬¡å¿«ç…§è¯»**ä¼šåˆ›å»ºä¸€ä¸ª Read Viewï¼Œ å°†å½“å‰ç³»ç»Ÿæ´»è·ƒçš„å…¶ä»–äº‹åŠ¡è®°å½•èµ·æ¥ï¼Œæ­¤ååœ¨è°ƒç”¨å¿«ç…§è¯»çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª Read Viewï¼Œæ‰€ä»¥ä¸€ä¸ªäº‹åŠ¡çš„æŸ¥è¯¢ç»“æœæ¯æ¬¡éƒ½æ˜¯ç›¸åŒçš„\r\n\r\n  RR çº§åˆ«ä¸‹ï¼Œé€šè¿‡ `START TRANSACTION WITH CONSISTENT SNAPSHOT` å¼€å¯äº‹åŠ¡ï¼Œä¼šåœ¨æ‰§è¡Œè¯¥è¯­å¥åç«‹åˆ»ç”Ÿæˆä¸€ä¸ª Read Viewï¼Œä¸æ˜¯åœ¨æ‰§è¡Œç¬¬ä¸€æ¡ SELECT è¯­å¥æ—¶ç”Ÿæˆï¼ˆæ‰€ä»¥è¯´ `START TRANSACTION` å¹¶ä¸æ˜¯äº‹åŠ¡çš„èµ·ç‚¹ï¼Œæ‰§è¡Œç¬¬ä¸€æ¡è¯­å¥æ‰ç®—èµ·ç‚¹ï¼‰\r\n\r\nè§£å†³å¹»è¯»é—®é¢˜ï¼š\r\n\r\n- å¿«ç…§è¯»ï¼šé€šè¿‡ MVCC æ¥è¿›è¡Œæ§åˆ¶çš„ï¼Œåœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ™®é€šæŸ¥è¯¢æ˜¯å¿«ç…§è¯»ï¼Œæ˜¯ä¸ä¼šçœ‹åˆ°åˆ«çš„äº‹åŠ¡æ’å…¥çš„æ•°æ®çš„ï¼Œä½†æ˜¯**å¹¶ä¸èƒ½å®Œå…¨é¿å…å¹»è¯»**\r\n\r\n  åœºæ™¯ï¼šRR çº§åˆ«ï¼ŒT1 äº‹åŠ¡å¼€å¯ï¼Œåˆ›å»º Read Viewï¼Œæ­¤æ—¶ T2 å» INSERT æ–°çš„ä¸€è¡Œç„¶åæäº¤ï¼Œç„¶å T1 å» UPDATE è¯¥è¡Œä¼šå‘ç°æ›´æ–°æˆåŠŸï¼Œå¹¶ä¸”æŠŠè¿™æ¡æ–°è®°å½•çš„ trx_id å˜ä¸ºå½“å‰çš„äº‹åŠ¡ idï¼Œæ‰€ä»¥å¯¹å½“å‰äº‹åŠ¡å°±æ˜¯å¯è§çš„ã€‚å› ä¸º **Read View å¹¶ä¸èƒ½é˜»æ­¢äº‹åŠ¡å»æ›´æ–°æ•°æ®ï¼Œæ›´æ–°æ•°æ®éƒ½æ˜¯å…ˆè¯»åå†™å¹¶ä¸”æ˜¯å½“å‰è¯»**ï¼Œè¯»å–åˆ°çš„æ˜¯æœ€æ–°ç‰ˆæœ¬çš„æ•°æ®\r\n\r\n- å½“å‰è¯»ï¼šé€šè¿‡ next-key é”ï¼ˆè¡Œé” + é—´éš™é”ï¼‰æ¥è§£å†³é—®é¢˜\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### æŒä¹…ç‰¹æ€§\r\n\r\n#### å®ç°æ–¹å¼\r\n\r\næŒä¹…æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤äº†ï¼Œé‚£ä¹ˆå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œæ¥ä¸‹æ¥çš„å…¶ä»–æ“ä½œæˆ–æ•…éšœä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚\r\n\r\nBuffer Pool çš„ä½¿ç”¨æé«˜äº†è¯»å†™æ•°æ®çš„æ•ˆç‡ï¼Œä½†æ˜¯å¦‚æœ MySQL å®•æœºï¼Œæ­¤æ—¶ Buffer Pool ä¸­ä¿®æ”¹çš„æ•°æ®è¿˜æ²¡æœ‰åˆ·æ–°åˆ°ç£ç›˜ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®çš„ä¸¢å¤±ï¼Œäº‹åŠ¡çš„æŒä¹…æ€§æ— æ³•ä¿è¯ï¼Œæ‰€ä»¥å¼•å…¥äº† redo log æ—¥å¿—ï¼š\r\n\r\n* redo log **è®°å½•æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹**ï¼Œè€Œä¸æ˜¯æŸä¸€è¡Œæˆ–æŸå‡ è¡Œçš„ä¿®æ”¹ï¼Œç”¨æ¥æ¢å¤æäº¤åçš„æ•°æ®é¡µï¼Œåªèƒ½**æ¢å¤åˆ°æœ€åä¸€æ¬¡æäº¤**çš„ä½ç½®\r\n* redo log é‡‡ç”¨çš„æ˜¯ WALï¼ˆWrite-ahead loggingï¼Œ**é¢„å†™å¼æ—¥å¿—**ï¼‰ï¼Œæ‰€æœ‰ä¿®æ”¹è¦å…ˆå†™å…¥æ—¥å¿—ï¼Œå†æ›´æ–°åˆ°ç£ç›˜ï¼Œä¿è¯äº†æ•°æ®ä¸ä¼šå›  MySQL å®•æœºè€Œä¸¢å¤±ï¼Œä»è€Œæ»¡è¶³äº†æŒä¹…æ€§è¦æ±‚\r\n* ç®€å•çš„ redo log æ˜¯çº¯ç²¹çš„ç‰©ç†æ—¥å¿—ï¼Œå¤æ‚çš„ redo log ä¼šå­˜åœ¨ç‰©ç†æ—¥å¿—å’Œé€»è¾‘æ—¥å¿—\r\n\r\nå·¥ä½œè¿‡ç¨‹ï¼šMySQL å‘ç”Ÿäº†å®•æœºï¼ŒInnoDB ä¼šåˆ¤æ–­ä¸€ä¸ªæ•°æ®é¡µåœ¨å´©æºƒæ¢å¤æ—¶ä¸¢å¤±äº†æ›´æ–°ï¼Œå°±ä¼šå°†å®ƒè¯»åˆ°å†…å­˜ï¼Œç„¶åæ ¹æ® redo log å†…å®¹æ›´æ–°å†…å­˜ï¼Œæ›´æ–°å®Œæˆåï¼Œå†…å­˜é¡µå˜æˆè„é¡µï¼Œç„¶åè¿›è¡Œåˆ·è„\r\n\r\nç¼“å†²æ± çš„**åˆ·è„ç­–ç•¥**ï¼š\r\n\r\n* redo log æ–‡ä»¶æ˜¯å›ºå®šå¤§å°çš„ï¼Œå¦‚æœå†™æ»¡äº†å°±è¦æ“¦é™¤ä»¥å‰çš„è®°å½•ï¼Œåœ¨æ“¦é™¤ä¹‹å‰éœ€è¦æŠŠå¯¹åº”çš„æ›´æ–°æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­\r\n* Buffer Pool å†…å­˜ä¸è¶³ï¼Œéœ€è¦æ·˜æ±°éƒ¨åˆ†æ•°æ®é¡µï¼ˆLRU é“¾è¡¨å°¾éƒ¨ï¼‰ï¼Œå¦‚æœæ·˜æ±°çš„æ˜¯è„é¡µï¼Œå°±è¦å…ˆå°†è„é¡µå†™åˆ°ç£ç›˜ï¼ˆè¦é¿å…å¤§äº‹åŠ¡ï¼‰\r\n* ç³»ç»Ÿç©ºé—²æ—¶ï¼Œåå°çº¿ç¨‹ä¼šè‡ªåŠ¨è¿›è¡Œåˆ·è„ï¼ˆFlush é“¾è¡¨éƒ¨åˆ†å·²ç»è¯¦è§£ï¼‰\r\n* MySQL æ­£å¸¸å…³é—­æ—¶ï¼Œä¼šæŠŠå†…å­˜çš„è„é¡µéƒ½åˆ·æ–°åˆ°ç£ç›˜ä¸Š\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### é‡åšæ—¥å¿—\r\n\r\n##### æ—¥å¿—ç¼“å†²\r\n\r\næœåŠ¡å™¨å¯åŠ¨æ—¶ä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸€ç‰‡è¿ç»­å†…å­˜ç©ºé—´ä½œä¸º redo log bufferï¼ˆé‡åšæ—¥å¿—ç¼“å†²åŒºï¼‰ï¼Œå¯ä»¥é€šè¿‡ `innodb_log_buffer_size` ç³»ç»Ÿå˜é‡æŒ‡å®š redo log buffer çš„å¤§å°ï¼Œé»˜è®¤æ˜¯ 16MB\r\n\r\nlog buffer è¢«åˆ’åˆ†ä¸ºè‹¥å¹² redo log blockï¼ˆå—ï¼Œç±»ä¼¼æ•°æ®é¡µçš„æ¦‚å¿µï¼‰ï¼Œæ¯ä¸ªé»˜è®¤å¤§å° 512 å­—èŠ‚ï¼Œæ¯ä¸ª block ç”± 12 å­—èŠ‚çš„ log block headã€496 å­—èŠ‚çš„ log block bodyã€4 å­—èŠ‚çš„ log block trailer ç»„æˆ\r\n\r\n* å½“æ•°æ®ä¿®æ”¹æ—¶ï¼Œå…ˆä¿®æ”¹ Change Buffer ä¸­çš„æ•°æ®ï¼Œç„¶ååœ¨ redo log buffer è®°å½•è¿™æ¬¡æ“ä½œï¼Œå†™å…¥ log buffer çš„è¿‡ç¨‹æ˜¯**é¡ºåºå†™å…¥**çš„ï¼ˆå…ˆå†™å…¥å‰é¢çš„ blockï¼Œå†™æ»¡åç»§ç»­å†™ä¸‹ä¸€ä¸ªï¼‰\r\n* log buffer ä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆ buf_freeï¼Œæ¥æ ‡è¯†è¯¥ä½ç½®ä¹‹å‰éƒ½æ˜¯å¡«æ»¡çš„ blockï¼Œè¯¥ä½ç½®ä¹‹åéƒ½æ˜¯ç©ºé—²åŒºåŸŸ\r\n\r\nMySQL è§„å®šå¯¹åº•å±‚é¡µé¢çš„ä¸€æ¬¡åŸå­è®¿é—®ç§°ä¸ºä¸€ä¸ª Mini-Transactionï¼ˆMTRï¼‰ï¼Œæ¯”å¦‚åœ¨ B+ æ ‘ä¸Šæ’å…¥ä¸€æ¡æ•°æ®å°±ç®—ä¸€ä¸ª MTR\r\n\r\n* ä¸€ä¸ªäº‹åŠ¡åŒ…å«è‹¥å¹²ä¸ª MTRï¼Œä¸€ä¸ª MTR å¯¹åº”ä¸€ç»„è‹¥å¹²æ¡ redo logï¼Œä¸€ç»„ redo log æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œåœ¨è¿›è¡Œæ•°æ®æ¢å¤æ—¶ä¹ŸæŠŠä¸€ç»„ redo log å½“ä½œä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“å¤„ç†\r\n\r\n* ä¸æ˜¯æ¯ç”Ÿæˆä¸€æ¡ redo æ—¥å¿—å°±å°†å…¶æ’å…¥åˆ° log buffer ä¸­ï¼Œè€Œæ˜¯ä¸€ä¸ª MTR ç»“æŸå**å°†ä¸€ç»„ redo æ—¥å¿—å†™å…¥**\r\n\r\nInnoDB çš„ redo log æ˜¯**å›ºå®šå¤§å°**çš„ï¼Œredo æ—¥å¿—åœ¨ç£ç›˜ä¸­ä»¥æ–‡ä»¶ç»„çš„å½¢å¼å­˜å‚¨ï¼ŒåŒä¸€ç»„ä¸­çš„æ¯ä¸ªæ–‡ä»¶å¤§å°ä¸€æ ·æ ¼å¼ä¸€æ ·\r\n\r\n* `innodb_log_group_home_dir` ä»£è¡¨ç£ç›˜å­˜å‚¨ redo log çš„æ–‡ä»¶ç›®å½•ï¼Œé»˜è®¤æ˜¯å½“å‰æ•°æ®ç›®å½•\r\n* `innodb_log_file_size` ä»£è¡¨æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤ 48Mï¼Œ`innodb_log_files_in_group` ä»£è¡¨æ–‡ä»¶ä¸ªæ•°ï¼Œé»˜è®¤ 2 æœ€å¤§ 100ï¼Œæ‰€ä»¥æ—¥å¿—çš„æ–‡ä»¶å¤§å°ä¸º `innodb_log_file_size * innodb_log_files_in_group`\r\n\r\nredo æ—¥å¿—æ–‡ä»¶ä¹Ÿæ˜¯ç”±è‹¥å¹²ä¸ª 512 å­—èŠ‚çš„ block ç»„æˆï¼Œæ—¥å¿—æ–‡ä»¶çš„å‰ 2048 ä¸ªå­—èŠ‚ï¼ˆå‰ 4 ä¸ª blockï¼‰ç”¨æ¥å­˜å‚¨ä¸€äº›ç®¡ç†ä¿¡æ¯ï¼Œä»¥åçš„ç”¨æ¥å­˜å‚¨ log buffer ä¸­çš„ block é•œåƒ\r\n\r\næ³¨æ„ï¼šblock å¹¶ä¸ä»£è¡¨ä¸€ç»„ redo logï¼Œä¸€ç»„æ—¥å¿—å¯èƒ½å ç”¨ä¸åˆ°ä¸€ä¸ª block æˆ–è€…å‡ ä¸ª blockï¼Œä¾èµ–äº MTR çš„å¤§å°\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ—¥å¿—åˆ·ç›˜\r\n\r\nredo log éœ€è¦åœ¨äº‹åŠ¡æäº¤æ—¶å°†æ—¥å¿—å†™å…¥ç£ç›˜ï¼Œä½†æ˜¯æ¯” Buffer Pool ä¿®æ”¹çš„æ•°æ®å†™å…¥ç£ç›˜çš„é€Ÿåº¦å¿«ï¼ŒåŸå› ï¼š\r\n\r\n* åˆ·è„æ˜¯éšæœº IOï¼Œå› ä¸ºæ¯æ¬¡ä¿®æ”¹çš„æ•°æ®ä½ç½®éšæœºï¼›redo log å’Œ binlog éƒ½æ˜¯**é¡ºåºå†™**ï¼Œç£ç›˜çš„é¡ºåº IO æ¯”éšæœº IO é€Ÿåº¦è¦å¿«\r\n* åˆ·è„æ˜¯ä»¥æ•°æ®é¡µï¼ˆPageï¼‰ä¸ºå•ä½çš„ï¼Œä¸€ä¸ªé¡µä¸Šçš„ä¸€ä¸ªå°ä¿®æ”¹éƒ½è¦æ•´é¡µå†™å…¥ï¼›redo log ä¸­åªåŒ…å«çœŸæ­£éœ€è¦å†™å…¥çš„éƒ¨åˆ†ï¼Œå¥½å‡ é¡µçš„æ•°æ®ä¿®æ”¹å¯èƒ½åªè®°å½•åœ¨ä¸€ä¸ª redo log é¡µä¸­ï¼Œå‡å°‘æ— æ•ˆ IO\r\n* **ç»„æäº¤æœºåˆ¶**ï¼Œå¯ä»¥å¤§å¹…åº¦é™ä½ç£ç›˜çš„ IO æ¶ˆè€—\r\n\r\nInnoDB å¼•æ“ä¼šåœ¨é€‚å½“çš„æ—¶å€™ï¼ŒæŠŠå†…å­˜ä¸­ redo log buffer æŒä¹…åŒ–ï¼ˆfsyncï¼‰åˆ°ç£ç›˜ï¼Œå…·ä½“çš„**åˆ·ç›˜ç­–ç•¥**ï¼š\r\n\r\n* åœ¨äº‹åŠ¡æäº¤æ—¶éœ€è¦è¿›è¡Œåˆ·ç›˜ï¼Œé€šè¿‡ä¿®æ”¹å‚æ•° `innodb_flush_log_at_trx_commit` è®¾ç½®ï¼š\r\n  * 0ï¼šè¡¨ç¤ºå½“æäº¤äº‹åŠ¡æ—¶ï¼Œå¹¶ä¸å°†ç¼“å†²åŒºçš„ redo æ—¥å¿—å†™å…¥ç£ç›˜ï¼Œè€Œæ˜¯ç­‰å¾…**åå°çº¿ç¨‹æ¯ç§’åˆ·æ–°ä¸€æ¬¡**\r\n  * 1ï¼šåœ¨äº‹åŠ¡æäº¤æ—¶å°†ç¼“å†²åŒºçš„ redo æ—¥å¿—**åŒæ­¥å†™å…¥**åˆ°ç£ç›˜ï¼Œä¿è¯ä¸€å®šä¼šå†™å…¥æˆåŠŸï¼ˆé»˜è®¤å€¼ï¼‰\r\n  * 2ï¼šåœ¨äº‹åŠ¡æäº¤æ—¶å°†ç¼“å†²åŒºçš„ redo æ—¥å¿—å¼‚æ­¥å†™å…¥åˆ°ç£ç›˜ï¼Œä¸èƒ½ä¿è¯æäº¤æ—¶è‚¯å®šä¼šå†™å…¥ï¼Œåªæ˜¯æœ‰è¿™ä¸ªåŠ¨ä½œã€‚æ—¥å¿—å·²ç»åœ¨æ“ä½œç³»ç»Ÿçš„ç¼“å­˜ï¼Œå¦‚æœæ“ä½œç³»ç»Ÿæ²¡æœ‰å®•æœºè€Œ MySQL å®•æœºï¼Œä¹Ÿæ˜¯å¯ä»¥æ¢å¤æ•°æ®çš„\r\n* å†™å…¥ redo log buffer çš„æ—¥å¿—è¶…è¿‡äº†æ€»å®¹é‡çš„ä¸€åŠï¼Œå°±ä¼šå°†æ—¥å¿—åˆ·å…¥åˆ°ç£ç›˜æ–‡ä»¶ï¼Œè¿™ä¼šå½±å“æ‰§è¡Œæ•ˆç‡ï¼Œæ‰€ä»¥å¼€å‘ä¸­åº”**é¿å…å¤§äº‹åŠ¡**\r\n* æœåŠ¡å™¨å…³é—­æ—¶\r\n* å¹¶è¡Œçš„äº‹åŠ¡æäº¤ï¼ˆç»„æäº¤ï¼‰æ—¶ï¼Œä¼šå°†å°†å…¶ä»–äº‹åŠ¡çš„ redo log æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚å‡è®¾äº‹åŠ¡ A å·²ç»å†™å…¥ redo log  buffer ä¸­ï¼Œè¿™æ—¶å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„äº‹åŠ¡ B æäº¤ï¼Œå¦‚æœ innodb_flush_log_at_trx_commit è®¾ç½®çš„æ˜¯ 1ï¼Œé‚£ä¹ˆäº‹åŠ¡ B è¦æŠŠ redo log buffer é‡Œçš„æ—¥å¿—å…¨éƒ¨æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œ**å› ä¸ºå¤šä¸ªäº‹åŠ¡å…±ç”¨ä¸€ä¸ª redo log buffer**ï¼Œæ‰€ä»¥ä¸€æ¬¡ fsync å¯ä»¥åˆ·ç›˜å¤šä¸ªäº‹åŠ¡çš„ redo logï¼Œæå‡äº†å¹¶å‘é‡\r\n\r\næœåŠ¡å™¨å¯åŠ¨å redo ç£ç›˜ç©ºé—´ä¸å˜ï¼Œæ‰€ä»¥ redo ç£ç›˜ä¸­çš„æ—¥å¿—æ–‡ä»¶æ˜¯è¢«**å¾ªç¯ä½¿ç”¨**çš„ï¼Œé‡‡ç”¨å¾ªç¯å†™æ•°æ®çš„æ–¹å¼ï¼Œå†™å®Œå°¾éƒ¨é‡æ–°å†™å¤´éƒ¨ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¤´éƒ¨ log å¯¹åº”çš„ä¿®æ”¹å·²ç»æŒä¹…åŒ–åˆ°ç£ç›˜\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ—¥å¿—åºå·\r\n\r\nlsn (log sequence number) ä»£è¡¨å·²ç»å†™å…¥çš„ redo æ—¥å¿—é‡ã€flushed_to_disk_lsn æŒ‡åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„ redo æ—¥å¿—é‡ï¼Œä¸¤è€…éƒ½æ˜¯**å…¨å±€å˜é‡**ï¼Œå¦‚æœä¸¤è€…çš„å€¼ç›¸åŒï¼Œè¯´æ˜ log buffer ä¸­æ‰€æœ‰çš„ redo æ—¥å¿—éƒ½å·²ç»æŒä¹…åŒ–åˆ°ç£ç›˜\r\n\r\nå·¥ä½œè¿‡ç¨‹ï¼šå†™å…¥ log buffer æ•°æ®æ—¶ï¼Œbuf_free ä¼šè¿›è¡Œåç§»ï¼Œåç§»é‡å°±ä¼šåŠ åˆ° lsn ä¸Š\r\n\r\nMTR çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹è¿‡çš„é¡µå¯¹åº”çš„æ§åˆ¶å—ä¼šåŠ åˆ° Buffer Pool çš„ flush é“¾è¡¨ä¸­ï¼Œé“¾è¡¨ä¸­è„é¡µæ˜¯æŒ‰ç…§ç¬¬ä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´è¿›è¡Œæ’åºçš„ï¼ˆå¤´æ’ï¼‰ï¼Œæ§åˆ¶å—ä¸­æœ‰ä¸¤ä¸ªæŒ‡é’ˆç”¨æ¥è®°å½•è„é¡µè¢«ä¿®æ”¹çš„æ—¶é—´ï¼š\r\n\r\n* oldest_modificationï¼šç¬¬ä¸€æ¬¡ä¿®æ”¹ Buffer Pool ä¸­æŸä¸ªç¼“å†²é¡µæ—¶ï¼Œå°†ä¿®æ”¹è¯¥é¡µçš„ MTR **å¼€å§‹æ—¶**å¯¹åº”çš„ lsn å€¼å†™å…¥è¿™ä¸ªå±æ€§\r\n* newest_modificationï¼šæ¯æ¬¡ä¿®æ”¹é¡µé¢ï¼Œéƒ½å°† MTR ç»“æŸæ—¶å…¨å±€çš„ lsn å€¼å†™å…¥è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥è¯¥å€¼æ˜¯è¯¥é¡µé¢æœ€åä¸€æ¬¡ä¿®æ”¹åçš„ lsn å€¼\r\n\r\nå…¨å±€å˜é‡ checkpoint_lsn è¡¨ç¤º**å½“å‰ç³»ç»Ÿå¯ä»¥è¢«è¦†ç›–çš„ redo æ—¥å¿—æ€»é‡**ï¼Œå½“ redo æ—¥å¿—å¯¹åº”çš„è„é¡µå·²ç»è¢«åˆ·æ–°åˆ°ç£ç›˜åï¼Œè¯¥æ–‡ä»¶ç©ºé—´å°±å¯ä»¥è¢«è¦†ç›–é‡ç”¨ï¼Œæ­¤æ—¶æ‰§è¡Œä¸€æ¬¡ checkpoint æ¥æ›´æ–° checkpoint_lsn çš„å€¼å­˜å…¥ç®¡ç†ä¿¡æ¯ï¼ˆåˆ·è„å’Œæ‰§è¡Œä¸€æ¬¡ checkpoint å¹¶ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼Œè¯¥å€¼çš„å¢é‡å°±ä»£è¡¨ç£ç›˜æ–‡ä»¶ä¸­å½“å‰ä½ç½®å‘åå¯ä»¥è¢«è¦†ç›–çš„æ–‡ä»¶çš„é‡ï¼Œæ‰€ä»¥è¯¥å€¼æ˜¯ä¸€ç›´å¢å¤§çš„\r\n\r\n**checkpoint**ï¼šä» flush é“¾è¡¨å°¾éƒ¨ä¸­æ‰¾å‡ºè¿˜æœªåˆ·è„çš„é¡µé¢ï¼Œè¯¥é¡µé¢æ˜¯å½“å‰ç³»ç»Ÿä¸­æœ€æ—©è¢«ä¿®æ”¹çš„è„é¡µï¼Œè¯¥é¡µé¢ä¹‹å‰äº§ç”Ÿçš„è„é¡µéƒ½å·²ç»åˆ·è„ï¼Œç„¶åå°†è¯¥é¡µ oldest_modification å€¼èµ‹å€¼ç»™ checkpoint_lsnï¼Œå› ä¸º lsn å°äºè¯¥å€¼æ—¶äº§ç”Ÿçš„ redo æ—¥å¿—éƒ½å¯ä»¥è¢«è¦†ç›–äº†\r\n\r\nä½†æ˜¯åœ¨ç³»ç»Ÿå¿™ç¢Œæ—¶ï¼Œåå°çº¿ç¨‹çš„åˆ·è„æ“ä½œä¸èƒ½å°†è„é¡µå¿«é€Ÿåˆ·å‡ºï¼Œå¯¼è‡´ç³»ç»Ÿæ— æ³•åŠæ—¶æ‰§è¡Œ checkpoint ï¼Œè¿™æ—¶éœ€è¦ç”¨æˆ·çº¿ç¨‹ä» flush é“¾è¡¨ä¸­æŠŠæœ€æ—©ä¿®æ”¹çš„è„é¡µåˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œç„¶åæ‰§è¡Œ checkpoint\r\n\r\n```java\r\nwrite pos ------- checkpoint_lsn // ä¸¤å€¼ä¹‹é—´çš„éƒ¨åˆ†è¡¨ç¤ºå¯ä»¥å†™å…¥çš„æ—¥å¿—é‡ï¼Œå½“ pos è¿½èµ¶ä¸Š lsn æ—¶å¿…é¡»æ‰§è¡Œ checkpoint\r\n```\r\n\r\nä½¿ç”¨å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰ InnoDB å­˜å‚¨å¼•æ“å„ç§ lsn çš„å€¼ï¼š\r\n\r\n```sql\r\nSHOW ENGINE INNODB STATUS\\G\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n##### å´©æºƒæ¢å¤\r\n\r\næ¢å¤çš„èµ·ç‚¹ï¼šåœ¨ä» redo æ—¥å¿—æ–‡ä»¶ç»„çš„ç®¡ç†ä¿¡æ¯ä¸­è·å–æœ€è¿‘å‘ç”Ÿ checkpoint çš„ä¿¡æ¯ï¼Œ**ä» checkpoint_lsn å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶å¼€å§‹æ¢å¤**\r\n\r\næ¢å¤çš„ç»ˆç‚¹ï¼šæ‰«ææ—¥å¿—æ–‡ä»¶çš„ blockï¼Œblock çš„å¤´éƒ¨è®°å½•ç€å½“å‰ block ä½¿ç”¨äº†å¤šå°‘å­—èŠ‚ï¼Œå¡«æ»¡çš„ block æ€»æ˜¯ 512 å­—èŠ‚ï¼Œ å¦‚æœæŸä¸ª block ä¸æ˜¯ 512 å­—èŠ‚ï¼Œè¯´æ˜è¯¥ block å°±æ˜¯éœ€è¦æ¢å¤çš„æœ€åä¸€ä¸ª block\r\n\r\næ¢å¤çš„è¿‡ç¨‹ï¼šæŒ‰ç…§ redo log ä¾æ¬¡æ‰§è¡Œæ¢å¤æ•°æ®ï¼Œä¼˜åŒ–æ–¹å¼\r\n\r\n* ä½¿ç”¨å“ˆå¸Œè¡¨ï¼šæ ¹æ® redo log çš„ space id å’Œ page number å±æ€§è®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œå°†å¯¹åŒä¸€é¡µé¢çš„ä¿®æ”¹æ”¾å…¥åŒä¸€ä¸ªæ§½é‡Œï¼Œå¯ä»¥ä¸€æ¬¡æ€§å®Œæˆå¯¹æŸé¡µçš„æ¢å¤ï¼Œ**é¿å…äº†éšæœº IO**\r\n* è·³è¿‡å·²ç»åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„é¡µé¢ï¼šæ•°æ®é¡µçš„ File Header ä¸­çš„ FILE_PAGE_LSN å±æ€§ï¼ˆç±»ä¼¼ newest_modificationï¼‰è¡¨ç¤ºæœ€è¿‘ä¸€æ¬¡ä¿®æ”¹é¡µé¢æ—¶çš„ lsn å€¼ï¼Œæ•°æ®é¡µè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œé‚£ä¹ˆè¯¥é¡µ lsn å±æ€§è‚¯å®šå¤§äº checkpoint_lsn \r\n\r\n\r\n\r\nå‚è€ƒä¹¦ç±ï¼šhttps://book.douban.com/subject/35231266/\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å·¥ä½œæµç¨‹\r\n\r\n##### æ—¥å¿—å¯¹æ¯”\r\n\r\nMySQL ä¸­è¿˜å­˜åœ¨ binlogï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰ä¹Ÿå¯ä»¥è®°å½•å†™æ“ä½œå¹¶ç”¨äºæ•°æ®çš„æ¢å¤ï¼Œ**ä¿è¯æ•°æ®ä¸ä¸¢å¤±**ï¼ŒäºŒè€…çš„åŒºåˆ«æ˜¯ï¼š\r\n\r\n* ä½œç”¨ä¸åŒï¼šredo log æ˜¯ç”¨äº crash recovery ï¼ˆæ•…éšœæ¢å¤ï¼‰ï¼Œä¿è¯ MySQL å®•æœºä¹Ÿä¸ä¼šå½±å“æŒä¹…æ€§ï¼›binlog æ˜¯ç”¨äº point-in-time recovery çš„ï¼Œä¿è¯æœåŠ¡å™¨å¯ä»¥åŸºäºæ—¶é—´ç‚¹æ¢å¤æ•°æ®ï¼Œæ­¤å¤– binlog è¿˜ç”¨äºä¸»ä»å¤åˆ¶\r\n* å±‚æ¬¡ä¸åŒï¼šredo log æ˜¯ InnoDB å­˜å‚¨å¼•æ“å®ç°çš„ï¼Œè€Œ binlog æ˜¯MySQLçš„ Server å±‚å®ç°çš„ï¼ŒåŒæ—¶æ”¯æŒ InnoDB å’Œå…¶ä»–å­˜å‚¨å¼•æ“\r\n* å†…å®¹ä¸åŒï¼šredo log æ˜¯ç‰©ç†æ—¥å¿—ï¼Œå†…å®¹åŸºäºç£ç›˜çš„ Pageï¼›binlog çš„å†…å®¹æ˜¯äºŒè¿›åˆ¶çš„ï¼Œæ ¹æ® binlog_format å‚æ•°çš„ä¸åŒï¼Œå¯èƒ½åŸºäºSQL è¯­å¥ã€åŸºäºæ•°æ®æœ¬èº«æˆ–è€…äºŒè€…çš„æ··åˆï¼ˆæ—¥å¿—éƒ¨åˆ†è¯¦è§£ï¼‰\r\n* å†™å…¥æ—¶æœºä¸åŒï¼šbinlog åœ¨äº‹åŠ¡æäº¤æ—¶ä¸€æ¬¡å†™å…¥ï¼›redo log çš„å†™å…¥æ—¶æœºç›¸å¯¹å¤šå…ƒ\r\n\r\nbinlog ä¸ºä»€ä¹ˆä¸æ”¯æŒå´©æºƒæ¢å¤ï¼Ÿ\r\n\r\n* binlog è®°å½•çš„æ˜¯è¯­å¥ï¼Œå¹¶ä¸è®°å½•æ•°æ®é¡µçº§çš„æ•°æ®ï¼ˆå“ªä¸ªé¡µæ”¹äº†å“ªäº›åœ°æ–¹ï¼‰ï¼Œæ‰€ä»¥æ²¡æœ‰èƒ½åŠ›æ¢å¤æ•°æ®é¡µ\r\n* binlog æ˜¯è¿½åŠ å†™ï¼Œä¿å­˜å…¨é‡çš„æ—¥å¿—ï¼Œæ²¡æœ‰æ ‡å¿—ç¡®å®šä»å“ªä¸ªç‚¹å¼€å§‹çš„æ•°æ®æ˜¯å·²ç»åˆ·ç›˜äº†ï¼Œè€Œ redo log åªè¦åœ¨ checkpoint_lsn åé¢çš„å°±æ˜¯æ²¡æœ‰åˆ·ç›˜çš„\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ›´æ–°è®°å½•\r\n\r\næ›´æ–°ä¸€æ¡è®°å½•çš„è¿‡ç¨‹ï¼šå†™ä¹‹å‰ä¸€å®šå…ˆè¯»\r\n\r\n* åœ¨ B+ æ ‘ä¸­å®šä½åˆ°è¯¥è®°å½•ï¼Œå¦‚æœè¯¥è®°å½•æ‰€åœ¨çš„é¡µé¢ä¸åœ¨ Buffer Pool é‡Œï¼Œå…ˆå°†å…¶åŠ è½½è¿›å†…å­˜\r\n\r\n* é¦–å…ˆæ›´æ–°è¯¥è®°å½•å¯¹åº”çš„èšç°‡ç´¢å¼•ï¼Œæ›´æ–°èšç°‡ç´¢å¼•è®°å½•æ—¶ï¼š\r\n\r\n  * æ›´æ–°è®°å½•å‰å‘ undo é¡µé¢å†™ undo æ—¥å¿—ï¼Œç”±äºè¿™æ˜¯æ›´æ”¹é¡µé¢ï¼Œæ‰€ä»¥éœ€è¦è®°å½•ä¸€ä¸‹ç›¸åº”çš„ redo æ—¥å¿—\r\n\r\n    æ³¨æ„ï¼šä¿®æ”¹ undo é¡µé¢ä¹Ÿæ˜¯åœ¨**ä¿®æ”¹é¡µé¢**ï¼Œäº‹åŠ¡åªè¦ä¿®æ”¹é¡µé¢å°±éœ€è¦å…ˆè®°å½•ç›¸åº”çš„ redo æ—¥å¿—\r\n\r\n  * ç„¶å**è®°å½•å¯¹åº”çš„ redo æ—¥å¿—**ï¼ˆç­‰å¾… MTR æäº¤åå†™å…¥ redo log bufferï¼‰ï¼Œ**æœ€åè¿›è¡ŒçœŸæ­£çš„æ›´æ–°è®°å½•**\r\n\r\n* æ›´æ–°å…¶ä»–çš„äºŒçº§ç´¢å¼•è®°å½•ï¼Œä¸ä¼šå†è®°å½• undo logï¼Œåªè®°å½• redo log åˆ° buffer ä¸­\r\n\r\n* åœ¨ä¸€æ¡æ›´æ–°è¯­å¥æ‰§è¡Œå®Œæˆåï¼ˆä¹Ÿå°±æ˜¯å°†æ‰€æœ‰å¾…æ›´æ–°è®°å½•éƒ½æ›´æ–°å®Œäº†ï¼‰ï¼Œå°±ä¼šå¼€å§‹è®°å½•è¯¥è¯­å¥å¯¹åº”çš„ binlog æ—¥å¿—ï¼Œæ­¤æ—¶è®°å½•çš„ binlog å¹¶æ²¡æœ‰åˆ·æ–°åˆ°ç¡¬ç›˜ä¸Šï¼Œè¿˜åœ¨å†…å­˜ä¸­ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶æ‰ä¼šç»Ÿä¸€å°†è¯¥äº‹åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ binlog æ—¥å¿—åˆ·æ–°åˆ°ç¡¬ç›˜\r\n\r\nå‡è®¾è¡¨ä¸­æœ‰å­—æ®µ id å’Œ aï¼Œå­˜åœ¨ä¸€æ¡ `id = 1, a = 2` çš„è®°å½•ï¼Œæ­¤æ—¶æ‰§è¡Œæ›´æ–°è¯­å¥ï¼š\r\n\r\n```sql\r\nupdate table set a=2 where id=1;\r\n```\r\n\r\nInnoDB ä¼šçœŸæ­£çš„å»æ‰§è¡ŒæŠŠå€¼ä¿®æ”¹æˆ (1,2) è¿™ä¸ªæ“ä½œï¼Œå…ˆåŠ è¡Œé”ï¼Œåœ¨å»æ›´æ–°ï¼Œå¹¶ä¸ä¼šæå‰åˆ¤æ–­ç›¸åŒå°±ä¸ä¿®æ”¹äº†\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://mp.weixin.qq.com/s/wcJ2KisSaMnfP4nH5NYaQA\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ä¸¤æ®µæäº¤\r\n\r\nå½“å®¢æˆ·ç«¯æ‰§è¡Œ COMMIT è¯­å¥æˆ–è€…åœ¨è‡ªåŠ¨æäº¤çš„æƒ…å†µä¸‹ï¼ŒMySQL å†…éƒ¨å¼€å¯ä¸€ä¸ª XA äº‹åŠ¡ï¼Œåˆ†ä¸¤é˜¶æ®µæ¥å®Œæˆ XA äº‹åŠ¡çš„æäº¤ï¼š\r\n\r\n```sql\r\nupdate T set c=c+1 where ID=2;\r\n```\r\n\r\n![image-20250320011843399](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011843399.png)\r\n\r\næµç¨‹è¯´æ˜ï¼šæ‰§è¡Œå¼•æ“å°†è¿™è¡Œæ–°æ•°æ®è¯»å…¥åˆ°å†…å­˜ä¸­ï¼ˆBuffer Poolï¼‰åï¼Œå…ˆå°†æ­¤æ¬¡æ›´æ–°æ“ä½œè®°å½•åˆ° redo log buffer é‡Œï¼Œç„¶åæ›´æ–°è®°å½•ã€‚æœ€åå°† redo log åˆ·ç›˜åäº‹åŠ¡å¤„äº prepare çŠ¶æ€ï¼Œæ‰§è¡Œå™¨ä¼šç”Ÿæˆè¿™ä¸ªæ“ä½œçš„ binlogï¼Œå¹¶**æŠŠ binlog å†™å…¥ç£ç›˜**ï¼Œå®Œæˆæäº¤\r\n\r\nä¸¤é˜¶æ®µï¼š\r\n\r\n* Prepare é˜¶æ®µï¼šå­˜å‚¨å¼•æ“å°†è¯¥äº‹åŠ¡çš„ **redo æ—¥å¿—åˆ·ç›˜**ï¼Œå¹¶ä¸”å°†æœ¬äº‹åŠ¡çš„çŠ¶æ€è®¾ç½®ä¸º PREPAREï¼Œä»£è¡¨æ‰§è¡Œå®Œæˆéšæ—¶å¯ä»¥æäº¤äº‹åŠ¡\r\n* Commit é˜¶æ®µï¼šå…ˆå°†äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ binlog åˆ·æ–°åˆ°ç¡¬ç›˜ï¼Œå†æ‰§è¡Œå­˜å‚¨å¼•æ“çš„æäº¤å·¥ä½œï¼Œå¼•æ“æŠŠ redo log æ”¹æˆæäº¤çŠ¶æ€\r\n\r\nå­˜å‚¨å¼•æ“å±‚çš„ redo log å’Œ server å±‚çš„ binlog å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œ éƒ½å¯ä»¥ç”¨äºè¡¨ç¤ºäº‹åŠ¡çš„æäº¤çŠ¶æ€ï¼Œè€Œ**ä¸¤é˜¶æ®µæäº¤å°±æ˜¯è®©è¿™ä¸¤ä¸ªçŠ¶æ€ä¿æŒé€»è¾‘ä¸Šçš„ä¸€è‡´**ï¼Œä¹Ÿæœ‰åˆ©äºä¸»ä»å¤åˆ¶ï¼Œæ›´å¥½çš„ä¿æŒä¸»ä»æ•°æ®çš„ä¸€è‡´æ€§\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### æ•°æ®æ¢å¤\r\n\r\nç³»ç»Ÿå´©æºƒå‰æ²¡æœ‰æäº¤çš„äº‹åŠ¡çš„ redo log å¯èƒ½å·²ç»åˆ·ç›˜ï¼ˆå®šæ—¶çº¿ç¨‹æˆ–è€… checkpointï¼‰ï¼Œæ€ä¹ˆå¤„ç†å´©æºƒæ¢å¤ï¼Ÿ\r\n\r\nå·¥ä½œæµç¨‹ï¼šè·å– undo é“¾è¡¨é¦–èŠ‚ç‚¹é¡µé¢çš„ undo segement header ä¸­çš„ TRX_UNDO_STATE å±æ€§ï¼Œè¡¨ç¤ºå½“å‰é“¾è¡¨çš„äº‹åŠ¡å±æ€§ï¼Œ**äº‹åŠ¡çŠ¶æ€æ˜¯æ´»è·ƒï¼ˆæœªæäº¤ï¼‰çš„å°±å…¨éƒ¨å›æ»š**ï¼Œå¦‚æœæ˜¯ PREPARE çŠ¶æ€ï¼Œå°±éœ€è¦æ ¹æ® binlog çš„çŠ¶æ€è¿›è¡Œåˆ¤æ–­ï¼š\r\n\r\n* å¦‚æœåœ¨æ—¶åˆ» A å‘ç”Ÿäº†å´©æºƒï¼ˆcrashï¼‰ï¼Œç”±äºæ­¤æ—¶ binlog è¿˜æ²¡å®Œæˆï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œå›æ»š\r\n* å¦‚æœåœ¨æ—¶åˆ» B å‘ç”Ÿäº†å´©æºƒï¼Œredo log å’Œ binlog æœ‰ä¸€ä¸ªå…±**åŒçš„æ•°æ®å­—æ®µå« XID**ï¼Œå´©æºƒæ¢å¤çš„æ—¶å€™ï¼Œä¼šæŒ‰é¡ºåºæ‰«æ redo logï¼š\r\n  * å¦‚æœ redo log é‡Œé¢çš„äº‹åŠ¡æ˜¯å®Œæ•´çš„ï¼Œä¹Ÿå°±æ˜¯å·²ç»æœ‰äº† commit æ ‡è¯†ï¼Œè¯´æ˜ binlog ä¹Ÿå·²ç»è®°å½•å®Œæ•´ï¼Œç›´æ¥ä» redo log æ¢å¤æ•°æ®\r\n  * å¦‚æœ redo log é‡Œé¢çš„äº‹åŠ¡åªæœ‰ prepareï¼Œå°±æ ¹æ® XID å» binlog ä¸­åˆ¤æ–­å¯¹åº”çš„äº‹åŠ¡æ˜¯å¦å­˜åœ¨å¹¶å®Œæ•´ï¼Œå¦‚æœå®Œæ•´å¯ä»¥æ¢å¤æ•°æ®\r\n\r\n\r\nåˆ¤æ–­ä¸€ä¸ªäº‹åŠ¡çš„ binlog æ˜¯å¦å®Œæ•´çš„æ–¹æ³•ï¼š\r\n\r\n* statement æ ¼å¼çš„ binlogï¼Œæœ€åä¼šæœ‰ COMMIT\r\n* row æ ¼å¼çš„ binlogï¼Œæœ€åä¼šæœ‰ä¸€ä¸ª XID event\r\n* MySQL 5.6.2 ç‰ˆæœ¬ä»¥åï¼Œå¼•å…¥äº† binlog-checksum å‚æ•°ç”¨æ¥éªŒè¯ binlog å†…å®¹çš„æ­£ç¡®æ€§ï¼ˆå¯èƒ½æ—¥å¿—ä¸­é—´å‡ºé”™ï¼‰\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/73161\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### åˆ·è„ä¼˜åŒ–\r\n\r\nç³»ç»Ÿåœ¨è¿›è¡Œåˆ·è„æ—¶ä¼šå ç”¨ä¸€éƒ¨åˆ†ç³»ç»Ÿèµ„æºï¼Œä¼šå½±å“ç³»ç»Ÿçš„æ€§èƒ½ï¼Œ**äº§ç”Ÿç³»ç»ŸæŠ–åŠ¨**\r\n\r\n* ä¸€ä¸ªæŸ¥è¯¢è¦æ·˜æ±°çš„è„é¡µä¸ªæ•°å¤ªå¤šï¼Œä¼šå¯¼è‡´æŸ¥è¯¢çš„å“åº”æ—¶é—´æ˜æ˜¾å˜é•¿\r\n* æ—¥å¿—å†™æ»¡ï¼Œæ›´æ–°å…¨éƒ¨å µä½ï¼Œå†™æ€§èƒ½è·Œä¸º 0ï¼Œè¿™ç§æƒ…å†µå¯¹æ•æ„Ÿä¸šåŠ¡æ¥è¯´ï¼Œæ˜¯ä¸èƒ½æ¥å—çš„\r\n\r\nInnoDB åˆ·è„é¡µçš„æ§åˆ¶ç­–ç•¥ï¼š\r\n\r\n* `innodb_io_capacity` å‚æ•°ä»£è¡¨ç£ç›˜çš„è¯»å†™èƒ½åŠ›ï¼Œå»ºè®®è®¾ç½®æˆç£ç›˜çš„ IOPSï¼ˆæ¯ç§’çš„ IO æ¬¡æ•°ï¼‰\r\n* åˆ·è„é€Ÿåº¦å‚è€ƒä¸¤ä¸ªå› ç´ ï¼šè„é¡µæ¯”ä¾‹å’Œ redo log å†™ç›˜é€Ÿåº¦\r\n  * å‚æ•° `innodb_max_dirty_pages_pct` æ˜¯è„é¡µæ¯”ä¾‹ä¸Šé™ï¼Œé»˜è®¤å€¼æ˜¯ 75%ï¼ŒInnoDB ä¼šæ ¹æ®å½“å‰çš„è„é¡µæ¯”ä¾‹ï¼Œç®—å‡ºä¸€ä¸ªèŒƒå›´åœ¨ 0 åˆ° 100 ä¹‹é—´çš„æ•°å­—\r\n  * InnoDB æ¯æ¬¡å†™å…¥çš„æ—¥å¿—éƒ½æœ‰ä¸€ä¸ªåºå·ï¼Œå½“å‰å†™å…¥çš„åºå·è·Ÿ checkpoint å¯¹åº”çš„åºå·ä¹‹é—´çš„å·®å€¼ï¼ŒInnoDB æ ¹æ®å·®å€¼ç®—å‡ºä¸€ä¸ªèŒƒå›´åœ¨ 0 åˆ° 100 ä¹‹é—´çš„æ•°å­—\r\n  * ä¸¤è€…è¾ƒå¤§çš„å€¼è®°ä¸º Rï¼Œæ‰§è¡Œå¼•æ“æŒ‰ç…§ innodb_io_capacity å®šä¹‰çš„èƒ½åŠ›ä¹˜ä»¥ R% æ¥æ§åˆ¶åˆ·è„é¡µçš„é€Ÿåº¦\r\n* `innodb_flush_neighbors` å‚æ•°ç½®ä¸º 1 ä»£è¡¨æ§åˆ¶åˆ·è„æ—¶æ£€æŸ¥ç›¸é‚»çš„æ•°æ®é¡µï¼Œå¦‚æœä¹Ÿæ˜¯è„é¡µå°±ä¸€èµ·åˆ·è„ï¼Œå¹¶æ£€æŸ¥é‚»å±…çš„é‚»å±…ï¼Œè¿™ä¸ªè¡Œä¸ºä¼šä¸€ç›´è”“å»¶ç›´åˆ°ä¸æ˜¯è„é¡µï¼Œåœ¨ MySQL 8.0 ä¸­è¯¥å€¼çš„é»˜è®¤å€¼æ˜¯ 0ï¼Œä¸å»ºè®®å¼€å¯æ­¤åŠŸèƒ½\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### ä¸€è‡´ç‰¹æ€§\r\n\r\nä¸€è‡´æ€§æ˜¯æŒ‡äº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åï¼Œäº‹åŠ¡æ‰§è¡Œçš„å‰åéƒ½æ˜¯åˆæ³•çš„æ•°æ®çŠ¶æ€ã€‚\r\n\r\næ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸåŒ…æ‹¬ä½†ä¸é™äºï¼šå®ä½“å®Œæ•´æ€§ï¼ˆå¦‚è¡Œçš„ä¸»é”®å­˜åœ¨ä¸”å”¯ä¸€ï¼‰ã€åˆ—å®Œæ•´æ€§ï¼ˆå¦‚å­—æ®µçš„ç±»å‹ã€å¤§å°ã€é•¿åº¦è¦ç¬¦åˆè¦æ±‚ï¼‰ã€å¤–é”®çº¦æŸã€ç”¨æˆ·è‡ªå®šä¹‰å®Œæ•´æ€§ï¼ˆå¦‚è½¬è´¦å‰åï¼Œä¸¤ä¸ªè´¦æˆ·ä½™é¢çš„å’Œåº”è¯¥ä¸å˜ï¼‰\r\n\r\nå®ç°ä¸€è‡´æ€§çš„æªæ–½ï¼š\r\n\r\n- ä¿è¯åŸå­æ€§ã€æŒä¹…æ€§å’Œéš”ç¦»æ€§ï¼Œå¦‚æœè¿™äº›ç‰¹æ€§æ— æ³•ä¿è¯ï¼Œäº‹åŠ¡çš„ä¸€è‡´æ€§ä¹Ÿæ— æ³•ä¿è¯\r\n- æ•°æ®åº“æœ¬èº«æä¾›ä¿éšœï¼Œä¾‹å¦‚ä¸å…è®¸å‘æ•´å½¢åˆ—æ’å…¥å­—ç¬¦ä¸²å€¼ã€å­—ç¬¦ä¸²é•¿åº¦ä¸èƒ½è¶…è¿‡åˆ—çš„é™åˆ¶ç­‰\r\n- åº”ç”¨å±‚é¢è¿›è¡Œä¿éšœï¼Œä¾‹å¦‚å¦‚æœè½¬è´¦æ“ä½œåªæ‰£é™¤è½¬è´¦è€…çš„ä½™é¢ï¼Œè€Œæ²¡æœ‰å¢åŠ æ¥æ”¶è€…çš„ä½™é¢ï¼Œæ— è®ºæ•°æ®åº“å®ç°çš„å¤šä¹ˆå®Œç¾ï¼Œä¹Ÿæ— æ³•ä¿è¯çŠ¶æ€çš„ä¸€è‡´\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},{"title":"Netty","tags":["Netty"],"categories":["Java","æœªåˆ†ç±»"],"author":"imklaus","excerpt":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥Nettyæ·±å…¥æµ…å‡ºJavaç½‘ç»œç¼–ç¨‹æ•™ç¨‹](https://www.bilibili.com/video/BV1py4y1E7oA)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n","link":"/posts/Netty","content":"\r\nå‚è€ƒè§†é¢‘ï¼š[æ»¡ç¥Nettyæ·±å…¥æµ…å‡ºJavaç½‘ç»œç¼–ç¨‹æ•™ç¨‹](https://www.bilibili.com/video/BV1py4y1E7oA)\r\n\r\nç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†\r\n\r\n<!-- more -->\r\n\r\nç›®å½•æŒ‡å¼•ï¼š\r\n\r\n[[toc]]\r\n\r\n\r\n\r\n## åŸºæœ¬ä»‹ç»\r\n\r\nNetty æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯\r\n\r\nNetty å®˜ç½‘ï¼šhttps://netty.io/\r\n\r\nNetty çš„å¯¹ JDK è‡ªå¸¦çš„ NIO çš„ API è¿›è¡Œå°è£…ï¼Œè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸»è¦ç‰¹ç‚¹æœ‰ï¼š\r\n\r\n- è®¾è®¡ä¼˜é›…ï¼Œé€‚ç”¨äºå„ç§ä¼ è¾“ç±»å‹çš„ç»Ÿä¸€ APIï¼Œ é˜»å¡å’Œéé˜»å¡ Socket åŸºäºçµæ´»ä¸”å¯æ‰©å±•çš„äº‹ä»¶æ¨¡å‹\r\n- ä½¿ç”¨æ–¹ä¾¿ï¼Œè¯¦ç»†è®°å½•çš„ Javadocã€ç”¨æˆ·æŒ‡å—å’Œç¤ºä¾‹ï¼Œæ²¡æœ‰å…¶ä»–ä¾èµ–é¡¹\r\n- é«˜æ€§èƒ½ï¼Œååé‡æ›´é«˜ï¼Œå»¶è¿Ÿæ›´ä½ï¼Œå‡å°‘èµ„æºæ¶ˆè€—ï¼Œæœ€å°åŒ–ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶\r\n- å®‰å…¨ï¼Œå®Œæ•´çš„ SSL/TLS å’Œ StartTLS æ”¯æŒ\r\n\r\n\r\n\r\nNetty çš„åŠŸèƒ½ç‰¹æ€§ï¼š\r\n\r\n* ä¼ è¾“æœåŠ¡ï¼šæ”¯æŒ BIO å’Œ NIO\r\n* å®¹å™¨é›†æˆï¼šæ”¯æŒ OSGIã€JBossMCã€Springã€Guice å®¹å™¨\r\n* åè®®æ”¯æŒï¼šHTTPã€Protobufã€äºŒè¿›åˆ¶ã€æ–‡æœ¬ã€WebSocket ç­‰ä¸€ç³»åˆ—åè®®éƒ½æ”¯æŒï¼Œä¹Ÿæ”¯æŒé€šè¿‡å®è¡Œç¼–ç è§£ç é€»è¾‘æ¥å®ç°è‡ªå®šä¹‰åè®®\r\n* Core æ ¸å¿ƒï¼šå¯æ‰©å±•äº‹ä»¶æ¨¡å‹ã€é€šç”¨é€šä¿¡ APIã€æ”¯æŒé›¶æ‹·è´çš„ ByteBuf ç¼“å†²å¯¹è±¡\r\n\r\n![image-20241006231240655](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231240655.png)\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n\r\n\r\n## çº¿ç¨‹æ¨¡å‹\r\n\r\n### é˜»å¡æ¨¡å‹\r\n\r\nä¼ ç»Ÿé˜»å¡å‹ I/O æ¨¡å¼ï¼Œæ¯ä¸ªè¿æ¥éƒ½éœ€è¦ç‹¬ç«‹çš„çº¿ç¨‹å®Œæˆæ•°æ®çš„è¾“å…¥ï¼Œä¸šåŠ¡å¤„ç†ï¼Œæ•°æ®è¿”å›\r\n\r\n![image-20241006231321181](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231321181.png)\r\n\r\næ¨¡å‹ç¼ºç‚¹ï¼š\r\n\r\n- å½“å¹¶å‘æ•°è¾ƒå¤§æ—¶ï¼Œéœ€è¦åˆ›å»ºå¤§é‡çº¿ç¨‹æ¥å¤„ç†è¿æ¥ï¼Œç³»ç»Ÿèµ„æºå ç”¨è¾ƒå¤§\r\n- è¿æ¥å»ºç«‹åï¼Œå¦‚æœå½“å‰çº¿ç¨‹æš‚æ—¶æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™çº¿ç¨‹å°±é˜»å¡åœ¨ read æ“ä½œä¸Šï¼Œé€ æˆçº¿ç¨‹èµ„æºæµªè´¹\r\n\r\n\r\n\r\nå‚è€ƒæ–‡ç« ï¼šhttps://www.jianshu.com/p/2965fca6bb8f\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### Reactor\r\n\r\n#### è®¾è®¡æ€æƒ³\r\n\r\nReactor æ¨¡å¼ï¼Œé€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥åŒæ—¶ä¼ é€’ç»™æœåŠ¡å¤„ç†å™¨çš„**äº‹ä»¶é©±åŠ¨å¤„ç†æ¨¡å¼**ã€‚ æœåŠ¡ç«¯ç¨‹åºå¤„ç†ä¼ å…¥çš„å¤šè·¯è¯·æ±‚ï¼Œå¹¶å°†å®ƒä»¬åŒæ­¥åˆ†æ´¾ç»™å¯¹åº”çš„å¤„ç†çº¿ç¨‹ï¼ŒReactor æ¨¡å¼ä¹Ÿå« Dispatcher æ¨¡å¼ï¼Œå³ I/O å¤šè·¯å¤ç”¨ç»Ÿä¸€ç›‘å¬äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶ååˆ†å‘ï¼ˆDispatch ç»™æŸçº¿ç¨‹ï¼‰\r\n\r\n**I/O å¤ç”¨ç»“åˆçº¿ç¨‹æ± **ï¼Œå°±æ˜¯ Reactor æ¨¡å¼åŸºæœ¬è®¾è®¡æ€æƒ³ï¼š\r\n\r\n![image-20241006231348776](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231348776.png)\r\n\r\nReactor æ¨¡å¼å…³é”®ç»„æˆï¼š\r\n\r\n- Reactorï¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œè´Ÿè´£**ç›‘å¬å’Œåˆ†å‘äº‹ä»¶**ï¼Œåˆ†å‘ç»™é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å¯¹ I/O äº‹ä»¶åšå‡ºååº”\r\n- Handlerï¼šå¤„ç†ç¨‹åºæ‰§è¡Œ I/O è¦å®Œæˆçš„å®é™…äº‹ä»¶ï¼ŒReactor é€šè¿‡è°ƒåº¦é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å“åº” I/O äº‹ä»¶ï¼Œå¤„ç†ç¨‹åºæ‰§è¡Œ**éé˜»å¡æ“ä½œ**\r\n\r\nReactor æ¨¡å¼å…·æœ‰å¦‚ä¸‹çš„ä¼˜ç‚¹ï¼š\r\n\r\n- å“åº”å¿«ï¼Œä¸å¿…ä¸ºå•ä¸ªåŒæ­¥æ—¶é—´æ‰€é˜»å¡ï¼Œè™½ç„¶ Reactor æœ¬èº«ä¾ç„¶æ˜¯åŒæ­¥çš„\r\n- ç¼–ç¨‹ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¤æ‚çš„å¤šçº¿ç¨‹åŠåŒæ­¥é—®é¢˜ï¼Œå¹¶ä¸”é¿å…äº†å¤šçº¿ç¨‹/è¿›ç¨‹çš„åˆ‡æ¢å¼€é”€\r\n- å¯æ‰©å±•æ€§ï¼Œå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡å¢åŠ  Reactor å®ä¾‹ä¸ªæ•°æ¥å……åˆ†åˆ©ç”¨ CPU èµ„æº\r\n- å¯å¤ç”¨æ€§ï¼ŒReactor æ¨¡å‹æœ¬èº«ä¸å…·ä½“äº‹ä»¶å¤„ç†é€»è¾‘æ— å…³ï¼Œå…·æœ‰å¾ˆé«˜çš„å¤ç”¨æ€§\r\n\r\næ ¹æ® Reactor çš„æ•°é‡å’Œå¤„ç†èµ„æºæ± çº¿ç¨‹çš„æ•°é‡ä¸åŒï¼Œæœ‰ä¸‰ç§å…¸å‹çš„å®ç°ï¼š\r\n\r\n- å• Reactor å•çº¿ç¨‹\r\n- å• Reactor å¤šçº¿ç¨‹\r\n- ä¸»ä» Reactor å¤šçº¿ç¨‹\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å•Rå•çº¿ç¨‹\r\n\r\nReactor å¯¹è±¡é€šè¿‡ select ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ dispatch è¿›è¡Œåˆ†å‘ï¼š\r\n\r\n* å¦‚æœæ˜¯å»ºç«‹è¿æ¥è¯·æ±‚äº‹ä»¶ï¼Œåˆ™ç”± Acceptor é€šè¿‡ accept å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡å¤„ç†è¿æ¥å®Œæˆåçš„åç»­ä¸šåŠ¡å¤„ç†\r\n\r\n* å¦‚æœä¸æ˜¯å»ºç«‹è¿æ¥äº‹ä»¶ï¼Œåˆ™ Reactor ä¼šåˆ†å‘ç»™è¿æ¥å¯¹åº”çš„ Handler æ¥å“åº”ï¼ŒHandler ä¼šå®Œæˆ readã€ä¸šåŠ¡å¤„ç†ã€send çš„å®Œæ•´æµç¨‹\r\n\r\n  è¯´æ˜ï¼š**Handler å’Œ Acceptor å±äºåŒä¸€ä¸ªçº¿ç¨‹**\r\n\r\n![image-20241006231415161](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231415161.png)\r\n\r\næ¨¡å‹ä¼˜ç‚¹ï¼šæ¨¡å‹ç®€å•ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ã€è¿›ç¨‹é€šä¿¡ã€ç«äº‰çš„é—®é¢˜ï¼Œå…¨éƒ¨éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆ\r\n\r\næ¨¡å‹ç¼ºç‚¹ï¼š\r\n\r\n* æ€§èƒ½é—®é¢˜ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ— æ³•å‘æŒ¥å¤šæ ¸ CPU çš„æ€§èƒ½ï¼ŒHandler åœ¨å¤„ç†æŸä¸ªè¿æ¥ä¸Šçš„ä¸šåŠ¡æ—¶ï¼Œæ•´ä¸ªè¿›ç¨‹æ— æ³•å¤„ç†å…¶ä»–è¿æ¥äº‹ä»¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ\r\n* å¯é æ€§é—®é¢˜ï¼šçº¿ç¨‹æ„å¤–è·‘é£ï¼Œæˆ–è€…è¿›å…¥æ­»å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€šä¿¡æ¨¡å—ä¸å¯ç”¨ï¼Œä¸èƒ½æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨æ¶ˆæ¯ï¼Œé€ æˆèŠ‚ç‚¹æ•…éšœ\r\n\r\nä½¿ç”¨åœºæ™¯ï¼šå®¢æˆ·ç«¯çš„æ•°é‡æœ‰é™ï¼Œä¸šåŠ¡å¤„ç†éå¸¸å¿«é€Ÿï¼Œæ¯”å¦‚ Redisï¼Œä¸šåŠ¡å¤„ç†çš„æ—¶é—´å¤æ‚åº¦ O(1)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å•Rå¤šçº¿ç¨‹\r\n\r\næ‰§è¡Œæµç¨‹é€šåŒå• Reactor å•çº¿ç¨‹ï¼Œä¸åŒçš„æ˜¯ï¼š\r\n\r\n* Handler åªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“ä¸šåŠ¡å¤„ç†ï¼Œé€šè¿‡ read è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™åé¢çš„ Worker çº¿ç¨‹æ± è¿›è¡Œä¸šåŠ¡å¤„ç†\r\n\r\n* Worker çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡å¤„ç†ï¼Œå°†å“åº”ç»“æœå‘ç»™ Handler è¿›è¡Œå¤„ç†ï¼Œæœ€åç”± Handler æ”¶åˆ°å“åº”ç»“æœåé€šè¿‡ send å°†å“åº”ç»“æœè¿”å›ç»™ Client\r\n\r\n![image-20241006231433735](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231433735.png)\r\n\r\næ¨¡å‹ä¼˜ç‚¹ï¼šå¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„å¤„ç†èƒ½åŠ›\r\n\r\næ¨¡å‹ç¼ºç‚¹ï¼š\r\n\r\n* å¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚\r\n* Reactor æ‰¿æ‹…æ‰€æœ‰äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œåœ¨å•çº¿ç¨‹ä¸­è¿è¡Œï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹å®¹æ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä¸»ä»æ¨¡å‹\r\n\r\né‡‡ç”¨å¤šä¸ª Reactor ï¼Œæ‰§è¡Œæµç¨‹ï¼š\r\n\r\n* Reactor ä¸»çº¿ç¨‹ MainReactor é€šè¿‡ select **ç›‘æ§å»ºç«‹è¿æ¥äº‹ä»¶**ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ Acceptor æ¥æ”¶ï¼Œå¤„ç†å»ºç«‹è¿æ¥äº‹ä»¶ï¼Œå¤„ç†å®Œæˆå MainReactor ä¼šå°†è¿æ¥åˆ†é…ç»™ Reactor å­çº¿ç¨‹çš„ SubReactorï¼ˆæœ‰å¤šä¸ªï¼‰å¤„ç†\r\n\r\n* SubReactor å°†è¿æ¥åŠ å…¥è¿æ¥é˜Ÿåˆ—è¿›è¡Œç›‘å¬å…¶ä»–äº‹ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª Handler ç”¨äºå¤„ç†è¯¥è¿æ¥çš„äº‹ä»¶ï¼Œå½“æœ‰æ–°çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒSubReactor ä¼šè°ƒç”¨è¿æ¥å¯¹åº”çš„ Handler è¿›è¡Œå“åº”\r\n\r\n* Handler é€šè¿‡ read è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™ Worker çº¿ç¨‹æ± è¿›è¡Œä¸šåŠ¡å¤„ç†\r\n\r\n* Worker çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡å¤„ç†ï¼Œå°†å“åº”ç»“æœå‘ç»™ Handler è¿›è¡Œå¤„ç†ï¼Œæœ€åç”± Handler æ”¶åˆ°å“åº”ç»“æœåé€šè¿‡ send å°†å“åº”ç»“æœè¿”å›ç»™ Client\r\n\r\n![image-20241006231457281](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231457281.png)\r\n\r\næ¨¡å‹ä¼˜ç‚¹\r\n\r\n- **çˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹**çš„æ•°æ®äº¤äº’ç®€å•èŒè´£æ˜ç¡®ï¼Œçˆ¶çº¿ç¨‹åªéœ€è¦æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†\r\n- çˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•ï¼ŒReactor ä¸»çº¿ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹æ— éœ€è¿”å›æ•°æ®\r\n\r\nä½¿ç”¨åœºæ™¯ï¼šNginx ä¸»ä» Reactor å¤šè¿›ç¨‹æ¨¡å‹ï¼ŒMemcached ä¸»ä»å¤šçº¿ç¨‹ï¼ŒNetty ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹çš„æ”¯æŒ\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### Proactor\r\n\r\nReactor æ¨¡å¼ä¸­ï¼ŒReactor ç­‰å¾…æŸä¸ªäº‹ä»¶çš„æ“ä½œçŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆæ–‡ä»¶æè¿°ç¬¦å¯è¯»å†™ï¼Œsocket å¯è¯»å†™ï¼‰ï¼Œç„¶åæŠŠäº‹ä»¶ä¼ é€’ç»™äº‹å…ˆæ³¨å†Œçš„ Handler æ¥åšå®é™…çš„è¯»å†™æ“ä½œï¼Œå…¶ä¸­çš„è¯»å†™æ“ä½œéƒ½éœ€è¦åº”ç”¨ç¨‹åºåŒæ­¥æ“ä½œï¼Œæ‰€ä»¥ **Reactor æ˜¯éé˜»å¡åŒæ­¥ç½‘ç»œæ¨¡å‹ï¼ˆNIOï¼‰**\r\n\r\næŠŠ I/O æ“ä½œæ”¹ä¸ºå¼‚æ­¥ï¼Œäº¤ç»™æ“ä½œç³»ç»Ÿæ¥å®Œæˆå°±èƒ½è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼Œè¿™å°±æ˜¯å¼‚æ­¥ç½‘ç»œæ¨¡å‹ Proactorï¼ˆAIOï¼‰ï¼š\r\n\r\n![image-20241006231558168](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231558168.png)\r\n\r\nå·¥ä½œæµç¨‹ï¼š\r\n\r\n* ProactorInitiator åˆ›å»º Proactor å’Œ Handler å¯¹è±¡ï¼Œå¹¶å°† Proactor å’Œ Handler é€šè¿‡ Asynchronous Operation Processorï¼ˆAsyOptProcessorï¼‰æ³¨å†Œåˆ°å†…æ ¸\r\n* AsyOptProcessor å¤„ç†æ³¨å†Œè¯·æ±‚ï¼Œå¹¶å¤„ç† I/O æ“ä½œï¼Œå®ŒæˆI/Oåé€šçŸ¥ Proactor\r\n* Proactor æ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹å›è°ƒä¸åŒçš„ Handler è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œæœ€åç”± Handler å®Œæˆä¸šåŠ¡å¤„ç†\r\n\r\nå¯¹æ¯”ï¼šReactor åœ¨äº‹ä»¶å‘ç”Ÿæ—¶å°±é€šçŸ¥äº‹å…ˆæ³¨å†Œçš„å¤„ç†å™¨ï¼ˆè¯»å†™åœ¨åº”ç”¨ç¨‹åºçº¿ç¨‹ä¸­å¤„ç†å®Œæˆï¼‰ï¼›Proactor æ˜¯åœ¨äº‹ä»¶å‘ç”Ÿæ—¶åŸºäºå¼‚æ­¥ I/O å®Œæˆè¯»å†™æ“ä½œï¼ˆå†…æ ¸å®Œæˆï¼‰ï¼ŒI/O å®Œæˆåæ‰å›è°ƒåº”ç”¨ç¨‹åºçš„å¤„ç†å™¨è¿›è¡Œä¸šåŠ¡å¤„ç†\r\n\r\næ¨¡å¼ä¼˜ç‚¹ï¼šå¼‚æ­¥ I/O æ›´åŠ å……åˆ†å‘æŒ¥ DMAï¼ˆDirect Memory Access ç›´æ¥å†…å­˜å­˜å–ï¼‰çš„ä¼˜åŠ¿\r\n\r\næ¨¡å¼ç¼ºç‚¹ï¼š\r\n\r\n* ç¼–ç¨‹å¤æ‚æ€§ï¼Œç”±äºå¼‚æ­¥æ“ä½œæµç¨‹çš„äº‹ä»¶çš„åˆå§‹åŒ–å’Œäº‹ä»¶å®Œæˆåœ¨æ—¶é—´å’Œç©ºé—´ä¸Šéƒ½æ˜¯ç›¸äº’åˆ†ç¦»çš„ï¼Œå› æ­¤å¼€å‘å¼‚æ­¥åº”ç”¨ç¨‹åºæ›´åŠ å¤æ‚ï¼Œåº”ç”¨ç¨‹åºè¿˜å¯èƒ½å› ä¸ºåå‘çš„æµæ§è€Œå˜å¾—æ›´åŠ éš¾ä»¥è°ƒè¯•\r\n* å†…å­˜ä½¿ç”¨ï¼Œç¼“å†²åŒºåœ¨è¯»æˆ–å†™æ“ä½œçš„æ—¶é—´æ®µå†…å¿…é¡»ä¿æŒä½ï¼Œå¯èƒ½é€ æˆæŒç»­çš„ä¸ç¡®å®šæ€§ï¼Œå¹¶ä¸”æ¯ä¸ªå¹¶å‘æ“ä½œéƒ½è¦æ±‚æœ‰ç‹¬ç«‹çš„ç¼“å­˜ï¼ŒReactor æ¨¡å¼åœ¨ socket å‡†å¤‡å¥½è¯»æˆ–å†™ä¹‹å‰æ˜¯ä¸è¦æ±‚å¼€è¾Ÿç¼“å­˜çš„\r\n* æ“ä½œç³»ç»Ÿæ”¯æŒï¼ŒWindows ä¸‹é€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ I/Oï¼Œè€Œåœ¨ Linux ç³»ç»Ÿä¸‹ï¼ŒLinux2.6 æ‰å¼•å…¥å¼‚æ­¥ I/Oï¼Œç›®å‰è¿˜ä¸å®Œå–„ï¼Œæ‰€ä»¥åœ¨ Linux ä¸‹å®ç°é«˜å¹¶å‘ç½‘ç»œç¼–ç¨‹éƒ½æ˜¯ä»¥ Reactor æ¨¡å‹ä¸ºä¸»\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### Netty\r\n\r\nNetty ä¸»è¦åŸºäºä¸»ä» Reactors å¤šçº¿ç¨‹æ¨¡å‹åšäº†ä¸€å®šçš„æ”¹è¿›ï¼ŒNetty çš„å·¥ä½œæ¶æ„å›¾ï¼š\r\n\r\n![image-20241006231638664](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231638664.png)\r\n\r\nå·¥ä½œæµç¨‹ï¼š\r\n\r\n1. Netty æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ±  BossGroup ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼ŒWorkerGroup ä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™\r\n\r\n2. BossGroup å’Œ WorkerGroup ç±»å‹éƒ½æ˜¯ NioEventLoopGroupï¼Œè¯¥ Group ç›¸å½“äºä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„ï¼Œå«æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯æ˜¯ NioEventLoopï¼Œæ‰€ä»¥å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹\r\n\r\n3. NioEventLoop è¡¨ç¤ºä¸€ä¸ª**å¾ªç¯å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹**ï¼Œæ¯ä¸ª NioEventLoop éƒ½æœ‰ä¸€ä¸ª Selectorï¼Œç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„ Socket çš„é€šè®¯\r\n\r\n4. æ¯ä¸ª Boss NioEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ï¼š\r\n\r\n   - è½®è¯¢ accept äº‹ä»¶\r\n   - å¤„ç† accept äº‹ä»¶ï¼Œä¸ client å»ºç«‹è¿æ¥ï¼Œç”Ÿæˆ NioScocketChannelï¼Œå¹¶å°†å…¶**æ³¨å†Œåˆ°æŸä¸ª Worker ä¸­**çš„æŸä¸ª NioEventLoop ä¸Šçš„ Selectorï¼Œè¿æ¥å°±ä¸ NioEventLoop ç»‘å®š\r\n   - å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ runAllTasks\r\n\r\n5. æ¯ä¸ª Worker NioEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ï¼š\r\n\r\n   - è½®è¯¢ readã€write äº‹ä»¶\r\n   - å¤„ç† I/O äº‹ä»¶ï¼Œå³ readï¼Œwrite äº‹ä»¶ï¼Œåœ¨å¯¹åº” NioSocketChannel å¤„ç†\r\n   - å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ runAllTasks\r\n\r\n6. æ¯ä¸ª Worker NioEventLoop å¤„ç†ä¸šåŠ¡æ—¶ï¼Œä¼šä½¿ç”¨ Pipelineï¼ˆç®¡é“ï¼‰ï¼ŒPipeline ä¸­åŒ…å«äº† Channelï¼Œå³é€šè¿‡ Pipeline å¯ä»¥è·å–åˆ°å¯¹åº”é€šé“ï¼Œç®¡é“ä¸­ç»´æŠ¤äº†å¾ˆå¤šçš„å¤„ç†å™¨ Handler\r\n\r\n   ![image-20241006231702313](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231702313.png)\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n\r\n\r\n## åŸºæœ¬å®ç°\r\n\r\nå¼€å‘ç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ï¼ŒåŸºæœ¬ä»‹ç»ï¼š\r\n\r\n* Channel ç†è§£ä¸ºæ•°æ®çš„é€šé“ï¼ŒæŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ Pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf\r\n* Handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åºï¼ŒPipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ä¼ æ’­ç»™æ¯ä¸ª Handlerï¼ŒHandler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰ï¼Œåˆ† Inbound å’Œ Outbound ä¸¤ç±»\r\n* EventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„æ‰§è¡Œè€…ï¼Œæ—¢å¯ä»¥æ‰§è¡Œ IO æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ã€‚æ¯ä¸ªæ‰§è¡Œè€…æœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª Channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡ã€‚æŒ‰ç…§ Pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ Handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®\r\n\r\nä»£ç å®ç°ï¼š\r\n\r\n* pom.xml\r\n\r\n  ```xml\r\n  <dependency>\r\n      <groupId>io.netty</groupId>\r\n      <artifactId>netty-all</artifactId>\r\n      <version>4.1.20.Final</version>\r\n  </dependency>\r\n  ```\r\n\r\n\r\n* Server.java\r\n\r\n  ```java\r\n  public class HelloServer {\r\n      public static void main(String[] args) {\r\n          EventLoopGroup boss = new NioEventLoopGroup();\r\n          EventLoopGroup worker = new NioEventLoopGroup(2);\r\n          // 1. å¯åŠ¨å™¨ï¼Œè´Ÿè´£ç»„è£… netty ç»„ä»¶ï¼Œå¯åŠ¨æœåŠ¡å™¨\r\n          new ServerBootstrap()\r\n                  // 2. çº¿ç¨‹ç»„ï¼Œboss åªè´Ÿè´£ã€å¤„ç† accept äº‹ä»¶ã€‘ï¼Œ worker åªã€è´Ÿè´£ channel ä¸Šçš„è¯»å†™ã€‘\r\n                  .group(boss, worker)\r\n             \t \t//.option() \t\t// ç»™ ServerSocketChannel é…ç½®å‚æ•°\r\n              \t//.childOption()   \t// ç»™ SocketChannel é…ç½®å‚æ•°\r\n                  // 3. é€‰æ‹©æœåŠ¡å™¨çš„ ServerSocketChannel å®ç°\r\n                  .channel(NioServerSocketChannel.class)\r\n                  // 4. boss è´Ÿè´£å¤„ç†è¿æ¥ï¼Œworker(child) è´Ÿè´£å¤„ç†è¯»å†™ï¼Œå†³å®šäº†èƒ½æ‰§è¡Œå“ªäº›æ“ä½œ(handler)\r\n                  .childHandler(new ChannelInitializer<NioSocketChannel>() {\r\n                      // 5. channel ä»£è¡¨å’Œå®¢æˆ·ç«¯è¿›è¡Œæ•°æ®è¯»å†™çš„é€šé“ Initializer åˆå§‹åŒ–ï¼Œè´Ÿè´£æ·»åŠ åˆ«çš„ handler\r\n                      // 7. è¿æ¥å»ºç«‹åï¼Œæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•\r\n                      @Override\r\n                      protected void initChannel(NioSocketChannel ch) throws Exception {\r\n                          // æ·»åŠ å…·ä½“çš„ handler\r\n                          ch.pipeline().addLast(new StringDecoder());// å°† ByteBuf è½¬æˆå­—ç¬¦ä¸²\r\n                          ch.pipeline().addLast(new ChannelInboundHandlerAdapter() { // è‡ªå®šä¹‰ handler\r\n                              // è¯»äº‹ä»¶\r\n                              @Override\r\n                              public void channelRead(ChannelHandlerContext ctx, Object msg) {\r\n                                  // æ‰“å°è½¬æ¢å¥½çš„å­—ç¬¦ä¸²\r\n                                  System.out.println(msg);\r\n                              }\r\n                          });\r\n                      }\r\n                  })\r\n                  // 6. ç»‘å®šç›‘å¬ç«¯å£\r\n                  .bind(8080);\r\n      }\r\n  }\r\n  ```\r\n\r\n* Client.java\r\n\r\n  ```java\r\n  public class HelloClient {\r\n      public static void main(String[] args) throws InterruptedException {\r\n          // 1. åˆ›å»ºå¯åŠ¨å™¨ç±»\r\n          new Bootstrap()\r\n                  // 2. æ·»åŠ  EventLoop\r\n                  .group(new NioEventLoopGroup())\r\n              \t//.option()ï¼Œç»™ SocketChannel é…ç½®å‚æ•°\r\n                  // 3. é€‰æ‹©å®¢æˆ·ç«¯ channel å®ç°\r\n                  .channel(NioSocketChannel.class)\r\n                  // 4. æ·»åŠ å¤„ç†å™¨\r\n                  .handler(new ChannelInitializer<NioSocketChannel>() {\r\n                      // 4.1 è¿æ¥å»ºç«‹åè¢«è°ƒç”¨\r\n                      @Override\r\n                      protected void initChannel(NioSocketChannel ch) throws Exception {\r\n                          // å°† Hello World è½¬ä¸º ByteBuf\r\n                          ch.pipeline().addLast(new StringEncoder());\r\n                      }\r\n                  })\r\n                  // 5. è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œç„¶åè°ƒç”¨ 4.1\r\n                  .connect(new InetSocketAddress(\"127.0.0.1\",8080))\r\n                  // 6. é˜»å¡æ–¹æ³•ï¼Œç›´åˆ°è¿æ¥å»ºç«‹\r\n                  .sync()\r\n                  // 7. ä»£è¡¨è¿æ¥å¯¹è±¡\r\n                  .channel()\r\n                  // 8. å‘æœåŠ¡å™¨å‘é€æ•°æ®\r\n                  .writeAndFlush(\"Hello World\");\r\n      }\r\n  }\r\n  ```\r\n\r\n\r\n\r\nå‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1py4y1E7oA\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n\r\n\r\n## ç»„ä»¶ä»‹ç»\r\n\r\n### EventLoop\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\näº‹ä»¶å¾ªç¯å¯¹è±¡ EventLoopï¼Œ**æœ¬è´¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨åŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª Selector**ï¼Œæœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ IO äº‹ä»¶\r\n\r\näº‹ä»¶å¾ªç¯ç»„ EventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼ŒChannel ä¼šè°ƒç”¨ Boss EventLoopGroup çš„ register æ–¹æ³•æ¥ç»‘å®šå…¶ä¸­ä¸€ä¸ª Worker çš„ EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ IO äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼Œä¿è¯äº†äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨\r\n\r\nEventLoopGroup ç±» APIï¼š\r\n\r\n* `EventLoop next()`ï¼šè·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoopï¼ŒEventLoopGroup å®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ›\r\n* `Future<?> shutdownGracefully()`ï¼šä¼˜é›…å…³é—­çš„æ–¹æ³•ï¼Œä¼šé¦–å…ˆåˆ‡æ¢ EventLoopGroup åˆ°å…³é—­çŠ¶æ€ä»è€Œæ‹’ç»æ–°çš„ä»»åŠ¡çš„åŠ å…¥ï¼Œç„¶ååœ¨ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å¤„ç†å®Œæˆåï¼Œåœæ­¢çº¿ç¨‹çš„è¿è¡Œï¼Œä»è€Œç¡®ä¿æ•´ä½“åº”ç”¨æ˜¯åœ¨æ­£å¸¸æœ‰åºçš„çŠ¶æ€ä¸‹é€€å‡ºçš„\r\n\r\n* `<T> Future<T> submit(Callable<T> task)`ï¼šæäº¤ä»»åŠ¡\r\n* `ScheduledFuture<?> scheduleWithFixedDelay`ï¼šæäº¤å®šæ—¶ä»»åŠ¡\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ä»»åŠ¡ä¼ é€’\r\n\r\næŠŠè¦è°ƒç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç”±ä¸‹ä¸€ä¸ª handler çš„çº¿ç¨‹æ¥è°ƒç”¨\r\n\r\n```java\r\npublic class EventLoopServer {\r\n    public static void main(String[] args) {\r\n        EventLoopGroup group = new DefaultEventLoopGroup();\r\n        new ServerBootstrap()\r\n                .group(new NioEventLoopGroup(), new NioEventLoopGroup(2))\r\n                .channel(NioServerSocketChannel.class)\r\n                .childHandler(new ChannelInitializer<NioSocketChannel>() {\r\n                    @Override\r\n                    protected void initChannel(NioSocketChannel ch) {\r\n                        ch.pipeline().addLast(\"handler1\", new ChannelInboundHandlerAdapter() {\r\n                            @Override\r\n                            public void channelRead(ChannelHandlerContext ctx, Object msg) {\r\n                                ByteBuf buf = (ByteBuf) msg;\r\n                                log.debug(buf.toString(Charset.defaultCharset()));\r\n                                ctx.fireChannelRead(msg);   // è®©æ¶ˆæ¯ã€ä¼ é€’ã€‘ç»™ä¸‹ä¸€ä¸ª handler\r\n                            }\r\n                        }).addLast(group, \"handler2\", new ChannelInboundHandlerAdapter() {\r\n                            @Override\r\n                            public void channelRead(ChannelHandlerContext ctx, Object msg) {\r\n                                ByteBuf buf = (ByteBuf) msg;\r\n                                log.debug(buf.toString(Charset.defaultCharset()));\r\n                            }\r\n                        });\r\n                    }\r\n                })\r\n                .bind(8080);\r\n    }\r\n}\r\n```\r\n\r\næºç åˆ†æï¼š\r\n\r\n```java\r\npublic ChannelHandlerContext fireChannelRead(final Object msg) {\r\n    invokeChannelRead(findContextInbound(MASK_CHANNEL_READ), msg);\r\n    return this;\r\n}\r\nstatic void invokeChannelRead(final AbstractChannelHandlerContext next, Object msg) {\r\n    final Object m = next.pipeline.touch(ObjectUtil.checkNotNull(msg, \"msg\"), next);\r\n    EventExecutor executor = next.executor();\r\n    // ä¸‹ä¸€ä¸ª handler çš„äº‹ä»¶å¾ªç¯æ˜¯å¦ä¸å½“å‰çš„äº‹ä»¶å¾ªç¯æ˜¯åŒä¸€ä¸ªçº¿ç¨‹\r\n    if (executor.inEventLoop()) {\r\n        // æ˜¯ï¼Œç›´æ¥è°ƒç”¨\r\n        next.invokeChannelRead(m);\r\n    } else {\r\n        // ä¸æ˜¯ï¼Œå°†è¦æ‰§è¡Œçš„ä»£ç ä½œä¸ºä»»åŠ¡æäº¤ç»™ä¸‹ä¸€ä¸ª handler å¤„ç†\r\n        executor.execute(new Runnable() {\r\n            @Override\r\n            public void run() {\r\n                next.invokeChannelRead(m);\r\n            }\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### Channel\r\n\r\n#### è¿æ¥æ“ä½œ\r\n\r\nChannel ç±» APIï¼š\r\n\r\n* `ChannelFuture close()`ï¼šå…³é—­é€šé“\r\n* `ChannelPipeline pipeline()`ï¼šæ·»åŠ å¤„ç†å™¨\r\n* `ChannelFuture write(Object msg)`ï¼šæ•°æ®å†™å…¥ç¼“å†²åŒº\r\n* `ChannelFuture writeAndFlush(Object msg)`ï¼šæ•°æ®å†™å…¥ç¼“å†²åŒºå¹¶ä¸”åˆ·å‡º\r\n\r\nChannelFuture ç±» APIï¼š\r\n\r\n* `ChannelFuture sync()`ï¼šåŒæ­¥é˜»å¡ç­‰å¾…è¿æ¥æˆåŠŸ\r\n* `ChannelFuture addListener(GenericFutureListener listener)`ï¼šå¼‚æ­¥ç­‰å¾…\r\n\r\nä»£ç å®ç°ï¼š\r\n\r\n* connect æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œä¸ç­‰è¿æ¥å»ºç«‹å®Œæˆå°±è¿”å›ï¼Œå› æ­¤ channelFuture å¯¹è±¡ä¸­ä¸èƒ½ç«‹åˆ»è·å¾—åˆ°æ­£ç¡®çš„ Channel å¯¹è±¡ï¼Œéœ€è¦ç­‰å¾…\r\n* è¿æ¥æœªå»ºç«‹ channel æ‰“å°ä¸º `[id: 0x2e1884dd]`ï¼›å»ºç«‹æˆåŠŸæ‰“å°ä¸º `[id: 0x2e1884dd, L:/127.0.0.1:57191 - R:/127.0.0.1:8080]`\r\n\r\n```java\r\npublic class ChannelClient {\r\n    public static void main(String[] args) throws InterruptedException {\r\n        ChannelFuture channelFuture = new Bootstrap()\r\n                .group(new NioEventLoopGroup())\r\n                .channel(NioSocketChannel.class)\r\n                .handler(new ChannelInitializer<NioSocketChannel>() {\r\n                    @Override\r\n                    protected void initChannel(NioSocketChannel ch) throws Exception {\r\n                        ch.pipeline().addLast(new StringEncoder());\r\n                    }\r\n                })\r\n                // 1. è¿æ¥æœåŠ¡å™¨ï¼Œã€å¼‚æ­¥éé˜»å¡ã€‘ï¼Œmain è°ƒç”¨ connect æ–¹æ³•ï¼ŒçœŸæ­£æ‰§è¡Œè¿æ¥çš„æ˜¯ nio çº¿ç¨‹\r\n                .connect(new InetSocketAddress(\"127.0.0.1\", 8080));\r\n        // 2.1 ä½¿ç”¨ sync æ–¹æ³•ã€åŒæ­¥ã€‘å¤„ç†ç»“æœï¼Œé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ° nio çº¿ç¨‹è¿æ¥å»ºç«‹å®Œæ¯•\r\n        channelFuture.sync();\r\n        Channel channel = channelFuture.channel();\r\n        System.out.println(channel); // ã€æ‰“å°ã€‘\r\n        // å‘æœåŠ¡å™¨å‘é€æ•°æ®\r\n        channel.writeAndFlush(\"hello world\");\r\n        \r\n**************************************************************************************äºŒé€‰ä¸€\r\n        // 2.2 ä½¿ç”¨ addListener æ–¹æ³•ã€å¼‚æ­¥ã€‘å¤„ç†ç»“æœ\r\n        channelFuture.addListener(new ChannelFutureListener() {\r\n            @Override\r\n            // nio çº¿ç¨‹è¿æ¥å»ºç«‹å¥½ä»¥åï¼Œå›è°ƒè¯¥æ–¹æ³•\r\n            public void operationComplete(ChannelFuture future) throws Exception {\r\n                if (future.isSuccess()) {\r\n                    Channel channel = future.channel();\r\n                \tchannel.writeAndFlush(\"hello, world\");\r\n                } else {\r\n                    // å»ºç«‹å¤±è´¥ï¼Œéœ€è¦å…³é—­\r\n                    future.channel().close();\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å…³é—­æ“ä½œ\r\n\r\nå…³é—­ EventLoopGroup çš„è¿è¡Œï¼Œåˆ†ä¸ºåŒæ­¥å…³é—­å’Œå¼‚æ­¥å…³é—­\r\n\r\n```java\r\npublic class CloseFutureClient {\r\n    public static void main(String[] args) throws InterruptedException {\r\n        NioEventLoopGroup group = new NioEventLoopGroup();\r\n        ChannelFuture channelFuture = new Bootstrap()\r\n                // ....\r\n                .connect(new InetSocketAddress(\"127.0.0.1\", 8080));\r\n        Channel channel = channelFuture.sync().channel();\r\n        // å‘é€æ•°æ®\r\n        new Thread(() -> {\r\n            Scanner sc = new Scanner(System.in);\r\n            while (true) {\r\n                String line = sc.nextLine();\r\n                if (line.equals(\"q\")) {\r\n                    channel.close();\r\n                    break;\r\n                }\r\n                channel.writeAndFlush(line);\r\n            }\r\n        }, \"input\").start();\r\n        // è·å– CloseFuture å¯¹è±¡\r\n        ChannelFuture closeFuture = channel.closeFuture();\r\n        \r\n        // 1. åŒæ­¥å¤„ç†å…³é—­\r\n        System.out.println(\"waiting close...\");\r\n        closeFuture.sync();\r\n        System.out.println(\"å¤„ç†å…³é—­åçš„æ“ä½œ\");\r\n****************************************************\r\n        // 2. å¼‚æ­¥å¤„ç†å…³é—­\r\n        closeFuture.addListener(new ChannelFutureListener() {\r\n            @Override\r\n            public void operationComplete(ChannelFuture future) throws Exception {\r\n                System.out.println(\"å¤„ç†å…³é—­åçš„æ“ä½œ\");\r\n                group.shutdownGracefully();\r\n            }\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### Future\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\nNetty ä¸­çš„ Future ä¸ JDK ä¸­çš„ Future åŒåï¼Œä½†æ˜¯åŠŸèƒ½çš„å®ç°ä¸åŒ\r\n\r\n```java\r\npackage io.netty.util.concurrent;\r\npublic interface Future<V> extends java.util.concurrent.Future<V>\r\n```\r\n\r\nFuture ç±» APIï¼š\r\n\r\n* `V get()`ï¼šé˜»å¡ç­‰å¾…è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ\r\n* `V getNow()`ï¼šéé˜»å¡è·å–ä»»åŠ¡ç»“æœï¼Œè¿˜æœªäº§ç”Ÿç»“æœæ—¶è¿”å› null\r\n* `Throwable cause()`ï¼šéé˜»å¡è·å–å¤±è´¥ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥ï¼Œè¿”å› null\r\n* `Future<V> sync()`ï¼šç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸\r\n* `boolean cancel(boolean mayInterruptIfRunning)`ï¼šå–æ¶ˆä»»åŠ¡\r\n* `Future<V> addListener(GenericFutureListener listener)`ï¼šæ·»åŠ å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ\r\n* `boolean isSuccess()`ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸ\r\n* `boolean isCancellable()`ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å–æ¶ˆ\r\n\r\n```java\r\npublic class NettyFutureDemo {\r\n    public static void main(String[] args) throws Exception {\r\n        NioEventLoopGroup group = new NioEventLoopGroup();\r\n        EventLoop eventLoop = group.next();\r\n        Future<Integer> future = eventLoop.submit(new Callable<Integer>() {\r\n            @Override\r\n            public Integer call() throws Exception {\r\n                System.out.println(\"æ‰§è¡Œè®¡ç®—\");\r\n                Thread.sleep(1000);\r\n                return 70;\r\n            }\r\n        });\r\n        future.getNow();\r\n        System.out.println(new Date() + \"ç­‰å¾…ç»“æœ\");\r\n        System.out.println(new Date() + \"\" + future.get());\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### æ‰©å±•å­ç±»\r\n\r\nPromise ç±»æ˜¯ Future çš„å­ç±»ï¼Œå¯ä»¥è„±ç¦»ä»»åŠ¡ç‹¬ç«‹å­˜åœ¨ï¼Œä½œä¸ºä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’ç»“æœçš„å®¹å™¨\r\n\r\n```java\r\npublic interface Promise<V> extends Future<V>\r\n```\r\n\r\nPromise ç±» APIï¼š\r\n\r\n* `Promise<V> setSuccess(V result)`ï¼šè®¾ç½®æˆåŠŸç»“æœ\r\n* `Promise<V> setFailure(Throwable cause)`ï¼šè®¾ç½®å¤±è´¥ç»“æœ\r\n\r\n```java\r\npublic class NettyPromiseDemo {\r\n    public static void main(String[] args) throws Exception {\r\n        // 1. å‡†å¤‡ EventLoop å¯¹è±¡\r\n        EventLoop eventLoop = new NioEventLoopGroup().next();\r\n        // 2. ä¸»åŠ¨åˆ›å»º promise\r\n        DefaultPromise<Integer> promise = new DefaultPromise<>(eventLoop);\r\n        // 3. ä»»æ„ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè®¡ç®—ï¼Œè®¡ç®—å®Œæ¯•åå‘ promise å¡«å……ç»“æœ\r\n        new Thread(() -> {\r\n            try {\r\n                Thread.sleep(1000);\r\n            } catch (InterruptedException e) {\r\n                e.printStackTrace();\r\n            }\r\n            promise.setSuccess(200);\r\n        }).start();\r\n\r\n        // 4. æ¥å—ç»“æœçš„çº¿ç¨‹\r\n        System.out.println(new Date() + \"ç­‰å¾…ç»“æœ\");\r\n        System.out.println(new Date() + \"\" + promise.get());\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### Pipeline\r\n\r\nChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸ºå…¥ç«™å‡ºç«™ä¸¤ç§ï¼Œæ‰€æœ‰ ChannelHandler è¿æ¥æˆåŒå‘é“¾è¡¨å°±æ˜¯ Pipeline\r\n\r\n* å…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ\r\n* å‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥ï¼ˆå…¥ç«™å’Œå‡ºç«™æ˜¯å¯¹äºæœåŠ¡ç«¯æ¥è¯´çš„ï¼‰\r\n\r\n```java\r\npublic static void main(String[] args) {\r\n    new ServerBootstrap()\r\n        .group(new NioEventLoopGroup())\r\n        .channel(NioServerSocketChannel.class)\r\n        .childHandler(new ChannelInitializer<NioSocketChannel>() {\r\n            @Override\r\n            protected void initChannel(NioSocketChannel ch) throws Exception {\r\n                // 1. é€šè¿‡ channel æ‹¿åˆ° pipeline\r\n                ChannelPipeline pipeline = ch.pipeline();\r\n                // 2. æ·»åŠ å¤„ç†å™¨ head -> h1 -> h2 -> h3 -> h4 -> tail\r\n                pipeline.addLast(\"h1\", new ChannelInboundHandlerAdapter() {\r\n                    @Override\r\n                    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\r\n                        log.debug(\"1\");\r\n                        ByteBuf buf = (ByteBuf) msg;\r\n                        String s = buf.toString(Charset.defaultCharset());\r\n                        // å°†æ•°æ®ä¼ é€’ç»™ä¸‹ä¸€ä¸ªã€å…¥ç«™ã€‘handlerï¼Œå¦‚æœä¸è°ƒç”¨è¯¥æ–¹æ³•åˆ™é“¾ä¼šæ–­å¼€\r\n                        super.channelRead(ctx, s);\r\n                    }\r\n                });\r\n                pipeline.addLast(\"h2\", new ChannelInboundHandlerAdapter() {\r\n                    @Override\r\n                    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\r\n                        log.debug(\"2\");\r\n                        // ä»ã€å°¾éƒ¨å¼€å§‹å‘å‰è§¦å‘ã€‘å‡ºç«™å¤„ç†å™¨\r\n                        ch.writeAndFlush(ctx.alloc().buffer().writeBytes(\"server\".getBytes()));\r\n                        // è¯¥æ–¹æ³•ä¼šè®©ç®¡é“ä»ã€å½“å‰ handler å‘å‰ã€‘å¯»æ‰¾å‡ºç«™å¤„ç†å™¨\r\n                        // ctx.writeAndFlush();\r\n                    }\r\n                });\r\n                pipeline.addLast(\"h3\", new ChannelOutboundHandlerAdapter() {\r\n                    @Override\r\n                    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {\r\n                        log.debug(\"3\");\r\n                        super.write(ctx, msg, promise);\r\n                    }\r\n                });\r\n                pipeline.addLast(\"h4\", new ChannelOutboundHandlerAdapter() {\r\n                    @Override\r\n                    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {\r\n                        log.debug(\"4\");\r\n                        super.write(ctx, msg, promise);\r\n                    }\r\n                });\r\n            }\r\n        })\r\n        .bind(8080);\r\n}\r\n```\r\n\r\næœåŠ¡å™¨ç«¯ä¾æ¬¡æ‰“å°ï¼š1 2 4 3 ï¼Œæ‰€ä»¥**å…¥ç«™æ˜¯æŒ‰ç…§ addLast çš„é¡ºåºæ‰§è¡Œçš„ï¼Œå‡ºç«™æ˜¯æŒ‰ç…§ addLast çš„é€†åºæ‰§è¡Œ**\r\n\r\nä¸€ä¸ª Channel åŒ…å«äº†ä¸€ä¸ª ChannelPipelineï¼Œè€Œ ChannelPipeline ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”± ChannelHandlerContext ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”æ¯ä¸ª ChannelHandlerContext ä¸­å…³è”ç€ä¸€ä¸ª ChannelHandler\r\n\r\nå…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œä¸¤ç§ç±»å‹çš„ handler äº’ä¸å¹²æ‰°ï¼š\r\n\r\n* å…¥ç«™äº‹ä»¶ä¼šä»é“¾è¡¨ head å¾€åä¼ é€’åˆ°æœ€åä¸€ä¸ªå…¥ç«™çš„ handler\r\n* å‡ºç«™äº‹ä»¶ä¼šä»é“¾è¡¨ tail å¾€å‰ä¼ é€’åˆ°æœ€å‰ä¸€ä¸ªå‡ºç«™çš„ handler\r\n\r\n![](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/Netty-ChannelPipeline.png)\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### ByteBuf\r\n\r\n#### åŸºæœ¬ä»‹ç»\r\n\r\nByteBuf æ˜¯å¯¹å­—èŠ‚æ•°æ®çš„å°è£…ï¼Œä¼˜ç‚¹ï¼š\r\n\r\n* æ± åŒ–ï¼Œå¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½\r\n* è¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼\r\n* å¯ä»¥è‡ªåŠ¨æ‰©å®¹\r\n* æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨æ›´æµç•…\r\n* é›¶æ‹·è´æ€æƒ³ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### åˆ›å»ºæ–¹æ³•\r\n\r\nåˆ›å»ºæ–¹å¼\r\n\r\n* `ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(10)`ï¼šåˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ ByteBufï¼Œåˆå§‹å®¹é‡æ˜¯ 10\r\n\r\n  ```java\r\n  public ByteBuf buffer() {\r\n      if (directByDefault) {\r\n          return directBuffer();\r\n      }\r\n      return heapBuffer();\r\n  }\r\n  ```\r\n\r\n* `ByteBuf buffer = ByteBufAllocator.DEFAULT.heapBuffer(10)`ï¼šåˆ›å»ºæ± åŒ–åŸºäºå †çš„ ByteBuf\r\n\r\n* `ByteBuf buffer = ByteBufAllocator.DEFAULT.directBuffer(10)`ï¼šåˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBuf\r\n\r\n* **æ¨è**çš„åˆ›å»ºæ–¹å¼ï¼šåœ¨æ·»åŠ å¤„ç†å™¨çš„æ–¹æ³•ä¸­\r\n\r\n  ```java\r\n  pipeline.addLast(new ChannelInboundHandlerAdapter() {\r\n      @Override\r\n      public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\r\n          ByteBuf buffer = ctx.alloc().buffer();\r\n      }\r\n  });\r\n  ```\r\n\r\nç›´æ¥å†…å­˜å¯¹æ¯”å †å†…å­˜ï¼š\r\n\r\n* ç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œé€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨\r\n* ç›´æ¥å†…å­˜å¯¹ GC å‹åŠ›å°ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦æ³¨æ„åŠæ—¶ä¸»åŠ¨é‡Šæ”¾\r\n\r\næ± åŒ–çš„æ„ä¹‰åœ¨äºå¯ä»¥**é‡ç”¨ ByteBuf**ï¼Œé«˜å¹¶å‘æ—¶æ± åŒ–åŠŸèƒ½æ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½ï¼Œä¸éæ± åŒ–å¯¹æ¯”ï¼š\r\n\r\n* éæ± åŒ–ï¼Œæ¯æ¬¡éƒ½è¦åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ï¼Œè¿™ä¸ªæ“ä½œå¯¹ç›´æ¥å†…å­˜ä»£ä»·æ˜‚è´µï¼Œå †å†…å­˜ä¼šå¢åŠ  GC å‹åŠ›\r\n* æ± åŒ–ï¼Œå¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡\r\n\r\næ± åŒ–åŠŸèƒ½çš„å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®ï¼š\r\n\r\n```sh\r\n-Dio.netty.allocator.type={unpooled|pooled}\t # VM å‚æ•°\r\n```\r\n\r\n* 4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼ŒAndroid å¹³å°å¯ç”¨éæ± åŒ–å®ç°\r\n* 4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç°\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### è¯»å†™æ“ä½œ\r\n\r\nByteBuf ç”±å››éƒ¨åˆ†ç»„æˆï¼Œæœ€å¼€å§‹è¯»å†™æŒ‡é’ˆï¼ˆ**åŒæŒ‡é’ˆ**ï¼‰éƒ½åœ¨ 0 ä½ç½®\r\n\r\n![image-20241006231846130](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231846130.png)\r\n\r\nå†™å…¥æ–¹æ³•ï¼š\r\n\r\n| æ–¹æ³•å                                           | è¯´æ˜                   | å¤‡æ³¨                                        |\r\n| ------------------------------------------------ | ---------------------- | ------------------------------------------- |\r\n| writeBoolean(boolean value)                      | å†™å…¥ boolean å€¼        | ç”¨ä¸€å­—èŠ‚ 01\\|00 ä»£è¡¨ true\\|false            |\r\n| writeByte(int value)                             | å†™å…¥ byte å€¼           |                                             |\r\n| writeInt(int value)                              | å†™å…¥ int å€¼            | Big Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50    |\r\n| writeIntLE(int value)                            | å†™å…¥ int å€¼            | Little Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00 |\r\n| writeBytes(ByteBuf src)                          | å†™å…¥ ByteBuf           |                                             |\r\n| writeBytes(byte[] src)                           | å†™å…¥ byte[]            |                                             |\r\n| writeBytes(ByteBuffer src)                       | å†™å…¥ NIO çš„ ByteBuffer |                                             |\r\n| int writeCharSequence(CharSequence s, Charset c) | å†™å…¥å­—ç¬¦ä¸²             |                                             |\r\n\r\n* è¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨\r\n* å†™å…¥å‡ ä½å†™æŒ‡é’ˆåç§»å‡ ä½ï¼ŒæŒ‡å‘å¯ä»¥å†™å…¥çš„ä½ç½®\r\n* ç½‘ç»œä¼ è¾“ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endian\r\n\r\næ‰©å®¹ï¼šå†™å…¥æ•°æ®æ—¶ï¼Œå®¹é‡ä¸å¤Ÿäº†ï¼ˆåˆå§‹å®¹é‡æ˜¯ 10ï¼‰ï¼Œè¿™æ—¶ä¼šå¼•å‘**æ‰©å®¹**\r\n\r\n* å¦‚æœå†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16\r\n* å¦‚æœå†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2^nï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 2^10 = 1024ï¼ˆ2^9=512 ä¸å¤Ÿï¼‰\r\n* æ‰©å®¹ä¸èƒ½è¶…è¿‡ max capacity ä¼šæŠ¥é”™\r\n\r\nè¯»å–æ–¹æ³•ï¼š\r\n\r\n* `byte readByte()`ï¼šè¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè¯»æŒ‡é’ˆåç§»\r\n* `byte getByte(int index)`ï¼šè¯»å–æŒ‡å®šç´¢å¼•ä½ç½®çš„å­—èŠ‚ï¼Œè¯»æŒ‡é’ˆä¸åŠ¨\r\n* `ByteBuf markReaderIndex()`ï¼šæ ‡è®°è¯»æ•°æ®çš„ä½ç½®\r\n* `ByteBuf resetReaderIndex()`ï¼šé‡ç½®åˆ°æ ‡è®°ä½ç½®ï¼Œå¯ä»¥é‡å¤è¯»å–æ ‡è®°ä½ç½®å‘åçš„æ•°æ®\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### å†…å­˜é‡Šæ”¾\r\n\r\nNetty ä¸­ä¸‰ç§å†…å­˜çš„å›æ”¶ï¼š\r\n\r\n* UnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€ç­‰ GC å›æ”¶å†…å­˜\r\n* UnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶å†…å­˜\r\n* PooledByteBuf å’Œå­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶å†…å­˜\r\n\r\nNetty é‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•æ¥æ§åˆ¶å›æ”¶å†…å­˜ï¼Œæ¯ä¸ª ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£ï¼Œå›æ”¶çš„è§„åˆ™ï¼š\r\n\r\n* æ¯ä¸ª ByteBuf å¯¹è±¡çš„åˆå§‹è®¡æ•°ä¸º 1\r\n* è°ƒç”¨ release æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶\r\n* è°ƒç”¨ retain æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶\r\n* å½“è®¡æ•°ä¸º 0 æ—¶ï¼Œåº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªæ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨\r\n\r\n```java\r\nByteBuf buf = .ByteBufAllocator.DEFAULT.buffer(10)\r\ntry {\r\n    // é€»è¾‘å¤„ç†\r\n} finally {\r\n    buf.release();\r\n}\r\n```\r\n\r\nPipeline çš„å­˜åœ¨ï¼Œéœ€è¦å°† ByteBuf ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¦‚æœåœ¨ finally ä¸­ release äº†ï¼Œå°±å¤±å»äº†ä¼ é€’æ€§ï¼Œå¤„ç†è§„åˆ™ï¼š\r\n\r\n* åˆ›å»º ByteBuf æ”¾å…¥ Pipeline\r\n\r\n* å…¥ç«™ ByteBuf å¤„ç†åŸåˆ™\r\n\r\n  * å¯¹åŸå§‹ ByteBuf ä¸åšå¤„ç†ï¼Œè°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» releaseï¼Œåä¹‹ä¸ä¼ é€’éœ€è¦\r\n\r\n  * å°†åŸå§‹ ByteBuf è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œæ­¤æ—¶å¿…é¡» release\r\n\r\n  * å¦‚æœå‡ºç°å¼‚å¸¸ï¼ŒByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release\r\n\r\n  * å‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯ï¼ˆåŸå§‹çš„ ByteBufï¼‰\r\n\r\n    ```java\r\n    // io.netty.channel.DefaultChannelPipeline#onUnhandledInboundMessage(java.lang.Object)\r\n    protected void onUnhandledInboundMessage(Object msg) {\r\n        try {\r\n            logger.debug();\r\n        } finally {\r\n            ReferenceCountUtil.release(msg);\r\n        }\r\n    }\r\n    // io.netty.util.ReferenceCountUtil#release(java.lang.Object)\r\n    public static boolean release(Object msg) {\r\n        if (msg instanceof ReferenceCounted) {\r\n            return ((ReferenceCounted) msg).release();\r\n        }\r\n        return false;\r\n    }\r\n    ```\r\n\r\n* å‡ºç«™ ByteBuf å¤„ç†åŸåˆ™\r\n\r\n  * å‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰ä¼ ï¼Œç”± HeadContext flush å release\r\n\r\n* ä¸ç¡®å®š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥å¾ªç¯è°ƒç”¨ release ç›´åˆ°è¿”å› true\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### æ‹·è´æ“ä½œ\r\n\r\né›¶æ‹·è´æ–¹æ³•ï¼š\r\n\r\n* `ByteBuf slice(int index, int length)`ï¼šå¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œåˆ‡ç‰‡åçš„ ByteBuf å¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œ**å…±ç”¨åŸå§‹ ByteBuf çš„å†…å­˜**ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readï¼Œwrite æŒ‡é’ˆ\r\n\r\n  ```java\r\n  public static void main(String[] args) {\r\n      ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(10);\r\n      buf.writeBytes(new byte[]{'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j'});\r\n      // åœ¨åˆ‡ç‰‡è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰å‘ç”Ÿæ•°æ®å¤åˆ¶\r\n      ByteBuf f1 = buf.slice(0, 5);\r\n      f1.retain();\r\n      ByteBuf f2 = buf.slice(5, 5);\r\n      f2.retain();\r\n      // å¯¹ f1 è¿›è¡Œç›¸å…³çš„æ“ä½œä¹Ÿä¼šä½“ç°åœ¨ buf ä¸Š\r\n  }\r\n  ```\r\n\r\n* `ByteBuf duplicate()`ï¼šæˆªå–åŸå§‹ ByteBuf æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯è¯»å†™æŒ‡é’ˆæ˜¯ç‹¬ç«‹çš„\r\n\r\n* `CompositeByteBuf addComponents(boolean increaseWriterIndex, ByteBuf... buffers)`ï¼šåˆå¹¶å¤šä¸ª ByteBuf\r\n\r\n  ```java\r\n  public static void main(String[] args) {\r\n      ByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer();\r\n      buf1.writeBytes(new byte[]{1, 2, 3, 4, 5});\r\n  \r\n      ByteBuf buf2 = ByteBufAllocator.DEFAULT.buffer();\r\n      buf1.writeBytes(new byte[]{6, 7, 8, 9, 10});\r\n  \r\n      CompositeByteBuf buf = ByteBufAllocator.DEFAULT.compositeBuffer();\r\n      // true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0\r\n      buf.addComponents(true, buf1, buf2);\r\n  }\r\n  ```\r\n\r\n  CompositeByteBuf æ˜¯ä¸€ä¸ªç»„åˆçš„ ByteBufï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component æ•°ç»„ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“åç§»é‡ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ®\r\n\r\n  * ä¼˜ç‚¹ï¼šå¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶\r\n  * ç¼ºç‚¹ï¼šå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—\r\n\r\næ·±æ‹·è´ï¼š\r\n\r\n* `ByteBuf copy()`ï¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œæ·±æ‹·è´ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf æ— å…³\r\n\r\næ± åŒ–ç›¸å…³ï¼š\r\n\r\n* Unpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œæä¾›äº†éæ± åŒ–çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ\r\n\r\n  ```java\r\n  ByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer(5);\r\n  buf1.writeBytes(new byte[]{1, 2, 3, 4, 5});\r\n  ByteBuf buf2 = ByteBufAllocator.DEFAULT.buffer(5);\r\n  buf2.writeBytes(new byte[]{6, 7, 8, 9, 10});\r\n  \r\n  // å½“åŒ…è£… ByteBuf ä¸ªæ•°è¶…è¿‡ä¸€ä¸ªæ—¶, åº•å±‚ä½¿ç”¨äº† CompositeByteBufï¼Œé›¶æ‹·è´æ€æƒ³\r\n  ByteBuf buf = Unpooled.wrappedBuffer(buf1, buf2);\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n\r\n\r\n## ç²˜åŒ…åŠåŒ…\r\n\r\n### ç°è±¡æ¼”ç¤º\r\n\r\nåœ¨ TCP ä¼ è¾“ä¸­ï¼Œå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ—¶ï¼Œå®é™…ä¸Šæ˜¯å°†æ•°æ®å†™å…¥ TCP çš„ç¼“å­˜ï¼Œæ­¤æ—¶æ•°æ®çš„å¤§å°å’Œç¼“å­˜çš„å¤§å°å°±ä¼šé€ æˆç²˜åŒ…å’ŒåŠåŒ…\r\n\r\n* å½“æ•°æ®è¶…è¿‡ TCP ç¼“å­˜å®¹é‡æ—¶ï¼Œå°±ä¼šè¢«æ‹†åˆ†æˆå¤šä¸ªåŒ…ï¼Œé€šè¿‡ Socket å¤šæ¬¡å‘é€åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ¯æ¬¡ä»ç¼“å­˜ä¸­å–æ•°æ®ï¼Œäº§ç”ŸåŠåŒ…é—®é¢˜\r\n\r\n* å½“æ•°æ®å°äº TCP ç¼“å­˜å®¹é‡æ—¶ï¼Œç¼“å­˜ä¸­å¯ä»¥å­˜æ”¾å¤šä¸ªåŒ…ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸€æ¬¡é€šä¿¡å°±å¯èƒ½ä¼ é€’å¤šä¸ªåŒ…ï¼Œè¿™æ—¶å€™æœåŠ¡ç«¯å°±å¯èƒ½ä¸€æ¬¡è¯»å–å¤šä¸ªåŒ…ï¼Œäº§ç”Ÿç²˜åŒ…çš„é—®é¢˜\r\n\r\nä»£ç æ¼”ç¤ºï¼š\r\n\r\n* å®¢æˆ·ç«¯ä»£ç ï¼š\r\n\r\n  ```java\r\n  public class HelloWorldClient {\r\n      public static void main(String[] args) {\r\n          send();\r\n      }\r\n  \r\n      private static void send() {\r\n          NioEventLoopGroup worker = new NioEventLoopGroup();\r\n          try {\r\n              Bootstrap bootstrap = new Bootstrap();\r\n              bootstrap.channel(NioSocketChannel.class);\r\n              bootstrap.group(worker);\r\n              bootstrap.handler(new ChannelInitializer<SocketChannel>() {\r\n                  @Override\r\n                  protected void initChannel(SocketChannel ch) throws Exception {\r\n                      ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {\r\n                          // ã€åœ¨è¿æ¥ channel å»ºç«‹æˆåŠŸåï¼Œä¼šè§¦å‘ active æ–¹æ³•ã€‘\r\n                          @Override\r\n                          public void channelActive(ChannelHandlerContext ctx) throws Exception {\r\n                              // å‘é€å†…å®¹éšæœºçš„æ•°æ®åŒ…\r\n                              Random r = new Random();\r\n                              char c = '0';\r\n                              ByteBuf buf = ctx.alloc().buffer();\r\n                              for (int i = 0; i < 10; i++) {\r\n                                  byte[] bytes = new byte[10];\r\n                                  for (int j = 0; j < r.nextInt(9) + 1; j++) {\r\n                                      bytes[j] = (byte) c;\r\n                                  }\r\n                                  c++;\r\n                                  buf.writeBytes(bytes);\r\n                              }\r\n                              ctx.writeAndFlush(buf);\r\n                          }\r\n                      });\r\n                  }\r\n              });\r\n              ChannelFuture channelFuture = bootstrap.connect(\"127.0.0.1\", 8080).sync();\r\n              channelFuture.channel().closeFuture().sync();\r\n  \r\n          } catch (InterruptedException e) {\r\n              log.error(\"client error\", e);\r\n          } finally {\r\n              worker.shutdownGracefully();\r\n          }\r\n      }\r\n  }\r\n  ```\r\n\r\n* æœåŠ¡å™¨ä»£ç ï¼š\r\n\r\n  ```java\r\n  public class HelloWorldServer {\r\n      public static void main(String[] args) {\r\n          NioEventLoopGroup boss = new NioEventLoopGroup(1);\r\n          NioEventLoopGroup worker = new NioEventLoopGroup();\r\n          try {\r\n              ServerBootstrap serverBootstrap = new ServerBootstrap();\r\n              serverBootstrap.channel(NioServerSocketChannel.class);\r\n              // è°ƒæ•´ç³»ç»Ÿçš„æ¥å—ç¼“å†²åŒºã€æ»‘åŠ¨çª—å£ã€‘\r\n              //serverBootstrap.option(ChannelOption.SO_RCVBUF, 10);\r\n              // è°ƒæ•´ netty çš„æ¥å—ç¼“å†²åŒºï¼ˆByteBufï¼‰\r\n              //serverBootstrap.childOption(ChannelOption.RCVBUF_ALLOCATOR, \r\n              //                            new AdaptiveRecvByteBufAllocator(16, 16, 16));\r\n              serverBootstrap.group(boss, worker);\r\n              serverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\r\n                  @Override\r\n                  protected void initChannel(SocketChannel ch) throws Exception {\r\n                      // ã€è¿™é‡Œå¯ä»¥æ·»åŠ è§£ç å™¨ã€‘\r\n                      // LoggingHandler ç”¨æ¥æ‰“å°æ¶ˆæ¯\r\n                      ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\r\n                  }\r\n              });\r\n              ChannelFuture channelFuture = serverBootstrap.bind(8080);\r\n              channelFuture.sync();\r\n              channelFuture.channel().closeFuture().sync();\r\n          } catch (InterruptedException e) {\r\n              log.error(\"server error\", e);\r\n          } finally {\r\n              boss.shutdownGracefully();\r\n              worker.shutdownGracefully();\r\n              log.debug(\"stop\");\r\n          }\r\n      }\r\n  }\r\n  ```\r\n\r\n* ç²˜åŒ…æ•ˆæœå±•ç¤ºï¼š\r\n\r\n  ```java\r\n  09:57:27.140 [nioEventLoopGroup-3-1] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0xddbaaef6, L:/127.0.0.1:8080 - R:/127.0.0.1:8701] READ: 100B\t// è¯»äº† 100 å­—èŠ‚ï¼Œå‘ç”Ÿç²˜åŒ…\r\n           +-------------------------------------------------+\r\n           |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n  +--------+-------------------------------------------------+----------------+\r\n  |00000000| 30 30 30 30 30 00 00 00 00 00 31 00 00 00 00 00 |00000.....1.....|\r\n  |00000010| 00 00 00 00 32 32 32 32 00 00 00 00 00 00 33 00 |....2222......3.|\r\n  |00000020| 00 00 00 00 00 00 00 00 34 34 00 00 00 00 00 00 |........44......|\r\n  |00000030| 00 00 35 35 35 35 00 00 00 00 00 00 36 36 36 00 |..5555......666.|\r\n  |00000040| 00 00 00 00 00 00 37 37 37 37 00 00 00 00 00 00 |......7777......|\r\n  |00000050| 38 38 38 38 38 00 00 00 00 00 39 39 00 00 00 00 |88888.....99....|\r\n  |00000060| 00 00 00 00                                     |....            |\r\n  +--------+-------------------------------------------------+----------------+\r\n  ```\r\n\r\nè§£å†³æ–¹æ³•ï¼šé€šè¿‡è°ƒæ•´ç³»ç»Ÿçš„æ¥å—ç¼“å†²åŒºçš„æ»‘åŠ¨çª—å£å’Œ Netty çš„æ¥å—ç¼“å†²åŒºä¿è¯æ¯æ¡åŒ…åªå«æœ‰ä¸€æ¡æ•°æ®ï¼Œæ»‘åŠ¨çª—å£çš„å¤§å°ä»…å†³å®šäº† Netty è¯»å–çš„**æœ€å°å•ä½**ï¼Œå®é™…æ¯æ¬¡è¯»å–çš„ä¸€èˆ¬æ˜¯å®ƒçš„æ•´æ•°å€\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### è§£å†³æ–¹æ¡ˆ\r\n\r\n#### çŸ­è¿æ¥\r\n\r\nå‘ä¸€ä¸ªåŒ…å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œè¿™æ ·è¿æ¥å»ºç«‹åˆ°è¿æ¥æ–­å¼€ä¹‹é—´å°±æ˜¯æ¶ˆæ¯çš„è¾¹ç•Œï¼Œç¼ºç‚¹å°±æ˜¯æ•ˆç‡å¾ˆä½\r\n\r\nå®¢æˆ·ç«¯ä»£ç æ”¹é€ ï¼š\r\n\r\n```java\r\npublic class HelloWorldClient {\r\n    public static void main(String[] args) {\r\n        // åˆ† 10 æ¬¡å‘é€\r\n        for (int i = 0; i < 10; i++) {\r\n            send();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### å›ºå®šé•¿åº¦\r\n\r\næœåŠ¡å™¨ç«¯åŠ å…¥å®šé•¿è§£ç å™¨ï¼Œæ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨å›ºå®šé•¿åº¦ã€‚å¦‚æœæ˜¯åŠåŒ…æ¶ˆæ¯ï¼Œä¼šç¼“å­˜åŠåŒ…æ¶ˆæ¯å¹¶ç­‰å¾…ä¸‹ä¸ªåŒ…åˆ°è¾¾ä¹‹åè¿›è¡Œæ‹¼åŒ…åˆå¹¶ï¼Œç›´åˆ°è¯»å–ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯åŒ…ï¼›å¦‚æœæ˜¯ç²˜åŒ…æ¶ˆæ¯ï¼Œç©ºä½™çš„ä½ç½®ä¼šè¿›è¡Œè¡¥ 0ï¼Œä¼šæµªè´¹ç©ºé—´\r\n\r\n```java\r\nserverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\r\n    @Override\r\n    protected void initChannel(SocketChannel ch) throws Exception {\r\n        ch.pipeline().addLast(new FixedLengthFrameDecoder(10));\r\n        // LoggingHandler ç”¨æ¥æ‰“å°æ¶ˆæ¯\r\n        ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\r\n    }\r\n});\r\n```\r\n\r\n```java\r\n10:29:06.522 [nioEventLoopGroup-3-1] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0x38a70fbf, L:/127.0.0.1:8080 - R:/127.0.0.1:10144] READ: 10B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 31 31 00 00 00 00 00 00 00 00                   |11........      |\r\n+--------+-------------------------------------------------+----------------+\r\n10:29:06.522 [nioEventLoopGroup-3-1] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0x38a70fbf, L:/127.0.0.1:8080 - R:/127.0.0.1:10144] READ: 10B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 32 32 32 32 32 32 00 00 00 00                   |222222....      |\r\n+--------+-------------------------------------------------+----------------+\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### åˆ†éš”ç¬¦\r\n\r\næœåŠ¡ç«¯åŠ å…¥è¡Œè§£ç å™¨ï¼Œé»˜è®¤ä»¥ `\\n` æˆ– `\\r\\n` ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå¦‚æœè¶…å‡ºæŒ‡å®šé•¿åº¦ä»æœªå‡ºç°åˆ†éš”ç¬¦ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼š\r\n\r\n```java\r\nserverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\r\n    @Override\r\n    protected void initChannel(SocketChannel ch) throws Exception {\r\n        ch.pipeline().addLast(new FixedLengthFrameDecoder(8));\r\n        ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\r\n    }\r\n});\r\n```\r\n\r\nå®¢æˆ·ç«¯åœ¨æ¯æ¡æ¶ˆæ¯ä¹‹åï¼ŒåŠ å…¥ `\\n` åˆ†éš”ç¬¦ï¼š\r\n\r\n```java\r\npublic void channelActive(ChannelHandlerContext ctx) throws Exception {\r\n    Random r = new Random();\r\n    char c = 'a';\r\n    ByteBuf buffer = ctx.alloc().buffer();\r\n    for (int i = 0; i < 10; i++) {\r\n        for (int j = 1; j <= r.nextInt(16)+1; j++) {\r\n            buffer.writeByte((byte) c);\r\n        }\r\n        // 10 ä»£è¡¨ '\\n'\r\n        buffer.writeByte(10);\r\n        c++;\r\n    }\r\n    ctx.writeAndFlush(buffer);\r\n}\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### é¢„è®¾é•¿åº¦\r\n\r\nLengthFieldBasedFrameDecoder è§£ç å™¨è‡ªå®šä¹‰é•¿åº¦è§£å†³ TCP ç²˜åŒ…é»åŒ…é—®é¢˜\r\n\r\n```java\r\nint maxFrameLength\t\t// æ•°æ®æœ€å¤§é•¿åº¦\r\nint lengthFieldOffset \t// é•¿åº¦å­—æ®µåç§»é‡ï¼Œä»ç¬¬å‡ ä¸ªå­—èŠ‚å¼€å§‹æ˜¯å†…å®¹çš„é•¿åº¦å­—æ®µ\r\nint lengthFieldLength\t// é•¿åº¦å­—æ®µæœ¬èº«çš„é•¿åº¦\r\nint lengthAdjustment \t// é•¿åº¦å­—æ®µä¸ºåŸºå‡†ï¼Œå‡ ä¸ªå­—èŠ‚åæ‰æ˜¯å†…å®¹\r\nint initialBytesToStrip\t// ä»å¤´å¼€å§‹å‰¥ç¦»å‡ ä¸ªå­—èŠ‚è§£ç åæ˜¾ç¤º\r\n```\r\n\r\n```java\r\nlengthFieldOffset   = 1 (= the length of HDR1)\r\nlengthFieldLength   = 2\r\nlengthAdjustment    = 1 (= the length of HDR2)\r\ninitialBytesToStrip = 3 (= the length of HDR1 + LEN)\r\n\r\nBEFORE DECODE (16 bytes)                       AFTER DECODE (13 bytes)//è§£ç \r\n+------+--------+------+----------------+      +------+----------------+\r\n| HDR1 | Length | HDR2 | Actual Content |----->| HDR2 | Actual Content |\r\n| 0xCA | 0x000C | 0xFE | \"HELLO, WORLD\" |      | 0xFE | \"HELLO, WORLD\" |\r\n+------+--------+------+----------------+      +------+----------------+\r\n```\r\n\r\nä»£ç å®ç°ï¼š\r\n\r\n```java\r\npublic class LengthFieldDecoderDemo {\r\n    public static void main(String[] args) {\r\n        EmbeddedChannel channel = new EmbeddedChannel(\r\n                // int å  4 å­—èŠ‚ï¼Œç‰ˆæœ¬å·ä¸€ä¸ªå­—èŠ‚\r\n                new LengthFieldBasedFrameDecoder(1024, 0, 4, 1,5),\r\n                new LoggingHandler(LogLevel.DEBUG)\r\n        );\r\n\r\n        // 4 ä¸ªå­—èŠ‚çš„å†…å®¹é•¿åº¦ï¼Œ å®é™…å†…å®¹\r\n        ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer();\r\n        send(buffer, \"Hello, world\");\r\n        send(buffer, \"Hi!\");\r\n        // å†™å‡ºç¼“å­˜\r\n        channel.writeInbound(buffer);\r\n    }\r\n    // å†™å…¥ç¼“å­˜\r\n    private static void send(ByteBuf buffer, String content) {\r\n        byte[] bytes = content.getBytes();  // å®é™…å†…å®¹\r\n        int length = bytes.length;          // å®é™…å†…å®¹é•¿åº¦\r\n        buffer.writeInt(length);\r\n        buffer.writeByte(1);                // è¡¨ç¤ºç‰ˆæœ¬å·\r\n        buffer.writeBytes(bytes);\r\n    }\r\n}\r\n```\r\n\r\n```java\r\n10:49:59.344 [main] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0xembedded, L:embedded - R:embedded] READ: 12B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 48 65 6c 6c 6f 2c 20 77 6f 72 6c 64             |Hello, world    |\r\n+--------+-------------------------------------------------+----------------+\r\n10:49:59.344 [main] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0xembedded, L:embedded - R:embedded] READ: 3B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 48 69 21                                        |Hi!             |\r\n+--------+-------------------------------------------------+----------------+\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### åè®®è®¾è®¡\r\n\r\n#### HTTP\r\n\r\nè®¿é—® URLï¼š`http://localhost:8080/`\r\n\r\n```java\r\npublic class HttpDemo {\r\n    public static void main(String[] args) {\r\n        NioEventLoopGroup boss = new NioEventLoopGroup();\r\n        NioEventLoopGroup worker = new NioEventLoopGroup();\r\n        try {\r\n            ServerBootstrap serverBootstrap = new ServerBootstrap();\r\n            serverBootstrap.channel(NioServerSocketChannel.class);\r\n            serverBootstrap.group(boss, worker);\r\n            serverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\r\n                @Override\r\n                protected void initChannel(SocketChannel ch) throws Exception {\r\n                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\r\n                    ch.pipeline().addLast(new HttpServerCodec());\r\n                    // åªé’ˆå¯¹æŸä¸€ç§ç±»å‹çš„è¯·æ±‚å¤„ç†ï¼Œæ­¤å¤„é’ˆå¯¹ HttpRequest\r\n                    ch.pipeline().addLast(new SimpleChannelInboundHandler<HttpRequest>() {\r\n                        @Override\r\n                        protected void channelRead0(ChannelHandlerContext ctx, HttpRequest msg) {\r\n                            // è·å–è¯·æ±‚\r\n                            log.debug(msg.uri());\r\n\r\n                            // è¿”å›å“åº”\r\n                            DefaultFullHttpResponse response = new DefaultFullHttpResponse(\r\n                                msg.protocolVersion(), HttpResponseStatus.OK);\r\n\r\n                            byte[] bytes = \"<h1>Hello, world!</h1>\".getBytes();\r\n\r\n                            response.headers().setInt(CONTENT_LENGTH, bytes.length);\r\n                            response.content().writeBytes(bytes);\r\n\r\n                            // å†™å›å“åº”\r\n                            ctx.writeAndFlush(response);\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n            ChannelFuture channelFuture = serverBootstrap.bind(8080).sync();\r\n            channelFuture.channel().closeFuture().sync();\r\n        } catch (InterruptedException e) {\r\n            log.error(\"n3.server error\", e);\r\n        } finally {\r\n            boss.shutdownGracefully();\r\n            worker.shutdownGracefully();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### è‡ªå®šä¹‰\r\n\r\nå¤„ç†å™¨ä»£ç ï¼š\r\n\r\n```java\r\n@Slf4j\r\npublic class MessageCodec extends ByteToMessageCodec<Message> {\r\n    // ç¼–ç \r\n    @Override\r\n    public void encode(ChannelHandlerContext ctx, Message msg, ByteBuf out) throws Exception {\r\n        // 4 å­—èŠ‚çš„é­”æ•°\r\n        out.writeBytes(new byte[]{1, 2, 3, 4});\r\n        // 1 å­—èŠ‚çš„ç‰ˆæœ¬,\r\n        out.writeByte(1);\r\n        // 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1\r\n        out.writeByte(0);\r\n        // 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹\r\n        out.writeByte(msg.getMessageType());\r\n        // 4 ä¸ªå­—èŠ‚\r\n        out.writeInt(msg.getSequenceId());\r\n        // æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……, 1 å­—èŠ‚\r\n        out.writeByte(0xff);\r\n        // è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„ï¼Œmsg å¯¹è±¡åºåˆ—åŒ–\r\n        ByteArrayOutputStream bos = new ByteArrayOutputStream();\r\n        ObjectOutputStream oos = new ObjectOutputStream(bos);\r\n        oos.writeObject(msg);\r\n        byte[] bytes = bos.toByteArray();\r\n        // é•¿åº¦\r\n        out.writeInt(bytes.length);\r\n        // å†™å…¥å†…å®¹\r\n        out.writeBytes(bytes);\r\n    }\r\n\r\n    // è§£ç \r\n    @Override\r\n    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {\r\n        int magicNum = in.readInt();\r\n        byte version = in.readByte();\r\n        byte serializerType = in.readByte();\r\n        byte messageType = in.readByte();\r\n        int sequenceId = in.readInt();\r\n        in.readByte();\r\n        int length = in.readInt();\r\n        byte[] bytes = new byte[length];\r\n        in.readBytes(bytes, 0, length);\r\n        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(bytes));\r\n        Message message = (Message) ois.readObject();\r\n        log.debug(\"{}, {}, {}, {}, {}, {}\", magicNum, version, serializerType, messageType, sequenceId, length);\r\n        log.debug(\"{}\", message);\r\n        out.add(message);\r\n    }\r\n}\r\n```\r\n\r\næµ‹è¯•ä»£ç ï¼š\r\n\r\n```java\r\npublic static void main(String[] args) throws Exception {\r\n    EmbeddedChannel channel = new EmbeddedChannel(new LoggingHandler(), new MessageCodec());\r\n    // encode\r\n    LoginRequestMessage message = new LoginRequestMessage(\"zhangsan\", \"123\");\r\n    channel.writeOutbound(message);\r\n\r\n    // decode\r\n    ByteBuf buf = ByteBufAllocator.DEFAULT.buffer();\r\n    new MessageCodec().encode(null, message, buf);\r\n    // å…¥ç«™\r\n    channel.writeInbound(buf);\r\n}\r\npublic class LoginRequestMessage extends Message {\r\n    private String username;\r\n    private String password;\r\n    // set + get \r\n}\r\n```\r\n\r\n![image-20241006231929202](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231929202.png)\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### Sharable\r\n\r\n@Sharable æ³¨è§£çš„æ·»åŠ æ—¶æœºï¼š\r\n\r\n* å½“ handler ä¸ä¿å­˜çŠ¶æ€æ—¶ï¼Œå°±å¯ä»¥å®‰å…¨åœ°åœ¨å¤šçº¿ç¨‹ä¸‹è¢«å…±äº«\r\n\r\n* å¯¹äºç¼–è§£ç å™¨ç±»ä¸èƒ½ç»§æ‰¿ ByteToMessageCodec æˆ– CombinedChannelDuplexHandlerï¼Œå®ƒä»¬çš„æ„é€ æ–¹æ³•å¯¹ @Sharable æœ‰é™åˆ¶\r\n\r\n  ```java\r\n  protected ByteToMessageCodec(boolean preferDirect) {\r\n      ensureNotSharable();\r\n      outboundMsgMatcher = TypeParameterMatcher.find(this, ByteToMessageCodec.class, \"I\");\r\n      encoder = new Encoder(preferDirect);\r\n  }\r\n  ```\r\n\r\n  ```java\r\n  protected void ensureNotSharable() {\r\n      // å¦‚æœç±»ä¸Šæœ‰è¯¥æ³¨è§£\r\n      if (isSharable()) {\r\n          throw new IllegalStateException();\r\n      }\r\n  }\r\n  ```\r\n\r\n* å¦‚æœèƒ½ç¡®ä¿ç¼–è§£ç å™¨ä¸ä¼šä¿å­˜çŠ¶æ€ï¼Œå¯ä»¥ç»§æ‰¿ MessageToMessageCodec çˆ¶ç±»\r\n\r\n  ````java\r\n  @Slf4j\r\n  @ChannelHandler.Sharable\r\n  // å¿…é¡»å’Œ LengthFieldBasedFrameDecoder ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿æ¥åˆ°çš„ ByteBuf æ¶ˆæ¯æ˜¯å®Œæ•´çš„\r\n  public class MessageCodecSharable extends MessageToMessageCodec<ByteBuf, Message> {\r\n      @Override\r\n      protected void encode(ChannelHandlerContext ctx, Message msg, List<Object> outList) throws Exception {\r\n          ByteBuf out = ctx.alloc().buffer();\r\n          // 4 å­—èŠ‚çš„é­”æ•°\r\n          out.writeBytes(new byte[]{1, 2, 3, 4});\r\n  \t\t// ....\r\n          outList.add(out);\r\n      }\r\n  \r\n      @Override\r\n      protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {\r\n          //....\r\n      }\r\n  }\r\n  ````\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n\r\n\r\n## åœºæ™¯ä¼˜åŒ–\r\n\r\n### ç©ºé—²æ£€æµ‹\r\n\r\n#### è¿æ¥å‡æ­»\r\n\r\nè¿æ¥å‡æ­»å°±æ˜¯å®¢æˆ·ç«¯æ•°æ®å‘ä¸å‡ºå»ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸€ç›´æ”¶ä¸åˆ°æ•°æ®ï¼Œä¿æŒè¿™ç§çŠ¶æ€ï¼Œå‡æ­»çš„è¿æ¥å ç”¨çš„èµ„æºä¸èƒ½è‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä¸”å‘å‡æ­»è¿æ¥å‘é€æ•°æ®ï¼Œå¾—åˆ°çš„åé¦ˆæ˜¯å‘é€è¶…æ—¶\r\n\r\nè§£å†³æ–¹æ¡ˆï¼šæ¯éš”ä¸€æ®µæ—¶é—´å°±æ£€æŸ¥è¿™æ®µæ—¶é—´å†…æ˜¯å¦æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼Œæ²¡æœ‰å°±å¯ä»¥åˆ¤å®šä¸ºè¿æ¥å‡æ­»\r\n\r\nIdleStateHandler æ˜¯ Netty æä¾›çš„å¤„ç†ç©ºé—²çŠ¶æ€çš„å¤„ç†å™¨ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯è¯»ç©ºé—²æ—¶é—´æˆ–å†™ç©ºé—²æ—¶é—´è¿‡é•¿\r\n\r\n* å‚æ•°ä¸€ long readerIdleTimeï¼šè¯»ç©ºé—²ï¼Œè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯»\r\n* å‚æ•°äºŒ long writerIdleTimeï¼šå†™ç©ºé—²ï¼Œè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰å†™\r\n* å‚æ•°ä¸‰ long allIdleTimeï¼šè¯»å†™ç©ºé—²ï¼Œè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯»å†™\r\n\r\n```java\r\nserverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\r\n\t@Override\r\n\tprotected void initChannel(SocketChannel ch) throws Exception {\r\n        ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 12, 4, 0, 0));\r\n        ch.pipeline().addLast(new MessageCodec());\r\n        // 5s å†…å¦‚æœæ²¡æœ‰æ”¶åˆ° channel çš„æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#READER_IDLE äº‹ä»¶ï¼Œ\r\n        ch.pipeline().addLast(new IdleStateHandler(5, 0, 0));\r\n        // ChannelDuplexHandler ã€å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™ã€‘å¤„ç†å™¨\r\n        ch.pipeline().addLast(new ChannelDuplexHandler() {\r\n            // ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶\r\n            @Override\r\n            public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception{\r\n                IdleStateEvent event = (IdleStateEvent) evt;\r\n                // è§¦å‘äº†è¯»ç©ºé—²äº‹ä»¶\r\n                if (event.state() == IdleState.READER_IDLE) {\r\n                    log.debug(\"å·²ç» 5s æ²¡æœ‰è¯»åˆ°æ•°æ®äº†\");\r\n                    ctx.channel().close();\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### å¿ƒè·³æœºåˆ¶\r\n\r\nå®¢æˆ·ç«¯å®šæ—¶å‘æœåŠ¡å™¨ç«¯å‘é€æ•°æ®ï¼Œ**æ—¶é—´é—´éš”è¦å°äºæœåŠ¡å™¨å®šä¹‰çš„ç©ºé—²æ£€æµ‹çš„æ—¶é—´é—´éš”**ï¼Œå°±èƒ½é˜²æ­¢è¯¯åˆ¤è¿æ¥å‡æ­»ï¼Œè¿™å°±æ˜¯å¿ƒè·³æœºåˆ¶\r\n\r\n```java\r\nbootstrap.handler(new ChannelInitializer<SocketChannel>() {\r\n    @Override\r\n    protected void initChannel(SocketChannel ch) throws Exception {\r\n        ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 12, 4, 0, 0));\r\n        ch.pipeline().addLast(new MessageCodec());\r\n        // 3s å†…å¦‚æœæ²¡æœ‰å‘æœåŠ¡å™¨å†™æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#WRITER_IDLE äº‹ä»¶\r\n        ch.pipeline().addLast(new IdleStateHandler(0, 3, 0));\r\n        // ChannelDuplexHandler å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨\r\n        ch.pipeline().addLast(new ChannelDuplexHandler() {\r\n            // ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶\r\n            @Override\r\n            public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\r\n                IdleStateEvent event = (IdleStateEvent) evt;\r\n                // è§¦å‘äº†å†™ç©ºé—²äº‹ä»¶\r\n                if (event.state() == IdleState.WRITER_IDLE) {\r\n                    // 3s æ²¡æœ‰å†™æ•°æ®äº†ï¼Œã€å‘é€ä¸€ä¸ªå¿ƒè·³åŒ…ã€‘\r\n                    ctx.writeAndFlush(new PingMessage());\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n### åºåˆ—åŒ–\r\n\r\n#### æ™®é€šæ–¹å¼\r\n\r\nåºåˆ—åŒ–ï¼Œååºåˆ—åŒ–ä¸»è¦ç”¨åœ¨æ¶ˆæ¯æ­£æ–‡çš„è½¬æ¢ä¸Š\r\n\r\n* åºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°† Java å¯¹è±¡å˜ä¸ºè¦ä¼ è¾“çš„æ•°æ®ï¼ˆå¯ä»¥æ˜¯ byte[]ï¼Œæˆ– json ç­‰ï¼Œæœ€ç»ˆéƒ½éœ€è¦å˜æˆ byte[]ï¼‰\r\n* ååºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°†ä¼ å…¥çš„æ­£æ–‡æ•°æ®è¿˜åŸæˆ Java å¯¹è±¡ï¼Œä¾¿äºå¤„ç†\r\n\r\nä»£ç å®ç°ï¼š\r\n\r\n* æŠ½è±¡ä¸€ä¸ª Serializer æ¥å£\r\n\r\n  ```java\r\n  public interface Serializer {\r\n      // ååºåˆ—åŒ–æ–¹æ³•\r\n      <T> T deserialize(Class<T> clazz, byte[] bytes);\r\n      // åºåˆ—åŒ–æ–¹æ³•\r\n      <T> byte[] serialize(T object);\r\n  }\r\n  ```\r\n\r\n* æä¾›ä¸¤ä¸ªå®ç°\r\n\r\n  ```java\r\n  enum SerializerAlgorithm implements Serializer {\r\n  \t// Java å®ç°\r\n      Java {\r\n          @Override\r\n          public <T> T deserialize(Class<T> clazz, byte[] bytes) {\r\n              try {\r\n                  ObjectInputStream in = \r\n                      new ObjectInputStream(new ByteArrayInputStream(bytes));\r\n                  Object object = in.readObject();\r\n                  return (T) object;\r\n              } catch (IOException | ClassNotFoundException e) {\r\n                  throw new RuntimeException(\"SerializerAlgorithm.Java ååºåˆ—åŒ–é”™è¯¯\", e);\r\n              }\r\n          }\r\n  \r\n          @Override\r\n          public <T> byte[] serialize(T object) {\r\n              try {\r\n                  ByteArrayOutputStream out = new ByteArrayOutputStream();\r\n                  new ObjectOutputStream(out).writeObject(object);\r\n                  return out.toByteArray();\r\n              } catch (IOException e) {\r\n                  throw new RuntimeException(\"SerializerAlgorithm.Java åºåˆ—åŒ–é”™è¯¯\", e);\r\n              }\r\n          }\r\n      }, \r\n      // Json å®ç°(å¼•å…¥äº† Gson ä¾èµ–)\r\n      Json {\r\n          @Override\r\n          public <T> T deserialize(Class<T> clazz, byte[] bytes) {\r\n              return new Gson().fromJson(new String(bytes, StandardCharsets.UTF_8), clazz);\r\n          }\r\n  \r\n          @Override\r\n          public <T> byte[] serialize(T object) {\r\n              return new Gson().toJson(object).getBytes(StandardCharsets.UTF_8);\r\n          }\r\n      };\r\n  \r\n      // éœ€è¦ä»åè®®çš„å­—èŠ‚ä¸­å¾—åˆ°æ˜¯å“ªç§åºåˆ—åŒ–ç®—æ³•\r\n      public static SerializerAlgorithm getByInt(int type) {\r\n          SerializerAlgorithm[] array = SerializerAlgorithm.values();\r\n          if (type < 0 || type > array.length - 1) {\r\n              throw new IllegalArgumentException(\"è¶…è¿‡ SerializerAlgorithm èŒƒå›´\");\r\n          }\r\n          return array[type];\r\n      }\r\n  }\r\n  ```\r\n\r\n  \r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n#### ProtoBuf\r\n\r\n##### åŸºæœ¬ä»‹ç»\r\n\r\nCodecï¼ˆç¼–è§£ç å™¨ï¼‰çš„ç»„æˆéƒ¨åˆ†æœ‰ä¸¤ä¸ªï¼šDecoderï¼ˆè§£ç å™¨ï¼‰å’Œ Encoderï¼ˆç¼–ç å™¨ï¼‰ã€‚Encoder è´Ÿè´£æŠŠä¸šåŠ¡æ•°æ®è½¬æ¢æˆå­—èŠ‚ç æ•°æ®ï¼ŒDecoder è´Ÿè´£æŠŠå­—èŠ‚ç æ•°æ®è½¬æ¢æˆä¸šåŠ¡æ•°æ®\r\n\r\n![image-20241006231953135](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006231953135.png)\r\n\r\n\r\n\r\nProtobuf æ˜¯ Google å‘å¸ƒçš„å¼€æºé¡¹ç›®ï¼Œå…¨ç§°  Google Protocol Buffers ï¼Œæ˜¯ä¸€ç§è½»ä¾¿é«˜æ•ˆçš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥ç”¨äºç»“æ„åŒ–æ•°æ®ä¸²è¡ŒåŒ–ï¼Œæˆ–è€…è¯´åºåˆ—åŒ–ã€‚å¾ˆé€‚åˆåšæ•°æ®å­˜å‚¨æˆ– RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ remote procedure callï¼‰æ•°æ®äº¤æ¢æ ¼å¼ã€‚ç›®å‰å¾ˆå¤šå…¬å¸ä» HTTP + Json è½¬å‘ TCP + Protobuf ï¼Œæ•ˆç‡ä¼šæ›´é«˜\r\n\r\nProtobuf æ˜¯ä»¥ message çš„æ–¹å¼æ¥ç®¡ç†æ•°æ®ï¼Œæ”¯æŒè·¨å¹³å°ã€è·¨è¯­è¨€ï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å¯ä»¥æ˜¯ä¸åŒçš„è¯­è¨€ç¼–å†™çš„ï¼‰ï¼Œé«˜æ€§èƒ½ã€é«˜å¯é æ€§\r\n\r\nå·¥ä½œè¿‡ç¨‹ï¼šä½¿ç”¨ Protobuf ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼ŒProtobuf æ˜¯å°†ç±»çš„å®šä¹‰ä½¿ç”¨ .proto æ–‡ä»¶è¿›è¡Œæè¿°ï¼Œç„¶åé€šè¿‡ protoc.exe ç¼–è¯‘å™¨æ ¹æ®  .proto è‡ªåŠ¨ç”Ÿæˆ .java æ–‡ä»¶\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n##### ä»£ç å®ç°\r\n\r\n* å•ä¸ª messageï¼š\r\n\r\n  ```less\r\n  syntax = \"proto3\"; \t\t\t\t\t\t\t\t// ç‰ˆæœ¬\r\n  option java_outer_classname = \"StudentPOJO\";\t// ç”Ÿæˆçš„å¤–éƒ¨ç±»åï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ–‡ä»¶å\r\n  \r\n  message Student { \t// åœ¨ StudentPOJO å¤–éƒ¨ç±»ç§ç”Ÿæˆä¸€ä¸ªå†…éƒ¨ç±» Studentï¼Œæ˜¯çœŸæ­£å‘é€çš„ POJO å¯¹è±¡\r\n      int32 id = 1; \t// Student ç±»ä¸­æœ‰ä¸€ä¸ªå±æ€§ï¼šåå­—ä¸º id ç±»å‹ä¸º int32(protobufç±»å‹) ï¼Œ1è¡¨ç¤ºå±æ€§åºå·ï¼Œä¸æ˜¯å€¼\r\n      string name = 2;\r\n  }\r\n  ```\r\n\r\n  ![image-20241006232123918](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006232123918.png)\r\n\r\n  ç¼–è¯‘ `protoc.exe --java_out=.Student.proto`ï¼ˆcmd çª—å£è¾“å…¥ï¼‰ å°†ç”Ÿæˆçš„ StudentPOJO æ”¾å…¥åˆ°é¡¹ç›®ä½¿ç”¨\r\n\r\n  Server ç«¯ï¼š\r\n\r\n  ```java\r\n  new ServerBootstrap() //...\r\n      .childHandler(new ChannelInitializer<SocketChannel>() {\t// åˆ›å»ºä¸€ä¸ªé€šé“åˆå§‹åŒ–å¯¹è±¡\r\n          // ç»™pipeline è®¾ç½®å¤„ç†å™¨\r\n          @Override\r\n          protected void initChannel(SocketChannel ch) throws Exception {\r\n              // åœ¨pipelineåŠ å…¥ProtoBufDecoderï¼ŒæŒ‡å®šå¯¹å“ªç§å¯¹è±¡è¿›è¡Œè§£ç \r\n              ch.pipeline().addLast(\"decoder\", new ProtobufDecoder(\r\n                  \t\t\t\t\t\t\tStudentPOJO.Student.getDefaultInstance()));\r\n              ch.pipeline().addLast(new NettyServerHandler());\r\n          }\r\n      }); \r\n  }\r\n  ```\r\n\r\n  Client ç«¯ï¼š\r\n\r\n  ```java\r\n  new Bootstrap().group(group) \t\t\t// è®¾ç½®çº¿ç¨‹ç»„\r\n      .channel(NioSocketChannel.class) \t// è®¾ç½®å®¢æˆ·ç«¯é€šé“çš„å®ç°ç±»(åå°„)\r\n      .handler(new ChannelInitializer<SocketChannel>() {\r\n          @Override\r\n          protected void initChannel(SocketChannel ch) throws Exception {\r\n              // åœ¨pipelineä¸­åŠ å…¥ ProtoBufEncoder\r\n              ch.pipeline().addLast(\"encoder\", new ProtobufEncoder());\r\n              ch.pipeline().addLast(new NettyClientHandler()); // åŠ å…¥è‡ªå®šä¹‰çš„ä¸šåŠ¡å¤„ç†å™¨\r\n          }\r\n      });\r\n  ```\r\n\r\n* å¤šä¸ª messageï¼šProtobuf å¯ä»¥ä½¿ç”¨ message ç®¡ç†å…¶ä»–çš„ messageã€‚å‡è®¾æŸä¸ªé¡¹ç›®éœ€è¦ä¼ è¾“ 20 ä¸ªå¯¹è±¡ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œå®šä¹‰ 20 ä¸ª messageï¼Œæœ€åå†ç”¨ä¸€ä¸ªæ€»çš„ message æ¥å†³å®šåœ¨å®é™…ä¼ è¾“æ—¶çœŸæ­£éœ€è¦ä¼ è¾“å“ªä¸€ä¸ªå¯¹è±¡\r\n\r\n  ```less\r\n  syntax = \"proto3\";\r\n  option optimize_for = SPEED; \t\t\t\t\t// åŠ å¿«è§£æ\r\n  option java_package=\"com.atguigu.netty.codec2\";\t// æŒ‡å®šç”Ÿæˆåˆ°å“ªä¸ªåŒ…ä¸‹\r\n  option java_outer_classname=\"MyDataInfo\"; \t\t// å¤–éƒ¨ç±»å, æ–‡ä»¶å\r\n  \r\n  message MyMessage {\r\n      // å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»å‹ï¼ŒDataType å¦‚æœæ˜¯ 0 åˆ™è¡¨ç¤ºä¸€ä¸ª Student å¯¹è±¡å®ä¾‹ï¼ŒDataType è¿™ä¸ªåç§°è‡ªå®šä¹‰\r\n      enum DataType {\r\n          StudentType = 0; //åœ¨ proto3 è¦æ±‚ enum çš„ç¼–å·ä» 0 å¼€å§‹\r\n          WorkerType = 1;\r\n      }\r\n  \r\n      // ç”¨ data_type æ¥æ ‡è¯†ä¼ çš„æ˜¯å“ªä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œè¿™é‡Œæ‰çœŸæ­£å¼€å§‹å®šä¹‰ Message çš„æ•°æ®ç±»å‹\r\n      DataType data_type = 1;  // æ‰€æœ‰åé¢çš„æ•°å­—éƒ½åªæ˜¯ç¼–å·è€Œå·²\r\n  \r\n      // oneof å…³é”®å­—ï¼Œè¡¨ç¤ºæ¯æ¬¡æšä¸¾ç±»å‹è¿›è¡Œä¼ è¾“æ—¶ï¼Œé™åˆ¶æœ€å¤šåªèƒ½ä¼ è¾“ä¸€ä¸ªå¯¹è±¡ã€‚\r\n      // dataBodyåç§°ä¹Ÿæ˜¯è‡ªå®šä¹‰çš„\r\n      // MyMessage é‡Œå‡ºç°çš„ç±»å‹åªæœ‰ä¸¤ä¸ª DataType ç±»å‹ï¼ŒStudent æˆ–è€… Worker ç±»å‹ï¼Œåœ¨çœŸæ­£ä¼ è¾“çš„æ—¶å€™åªä¼šæœ‰ä¸€ä¸ªå‡ºç°\r\n      oneof dataBody {\r\n          Student student = 2;  //æ³¨æ„è¿™åé¢çš„æ•°å­—ä¹Ÿéƒ½åªæ˜¯ç¼–å·è€Œå·²ï¼Œä¸Šé¢DataType data_type = 1  å äº†ç¬¬ä¸€ä¸ªåºå·äº†\r\n          Worker worker = 3;\r\n      }\r\n  \r\n  \r\n  }\r\n  \r\n  message Student {\r\n      int32 id = 1;\t\t// Studentç±»çš„å±æ€§\r\n      string name = 2; \t//\r\n  }\r\n  message Worker {\r\n      string name=1;\r\n      int32 age=2;\r\n  }\r\n  ```\r\n\r\n  ç¼–è¯‘ï¼š\r\n\r\n  Server ç«¯ï¼š\r\n\r\n  ```java\r\n  ch.pipeline().addLast(\"decoder\", new ProtobufDecoder(MyDataInfo.MyMessage.getDefaultInstance()));\r\n  ```\r\n\r\n  Client ç«¯ï¼š\r\n\r\n  ```java\r\n  pipeline.addLast(\"encoder\", new ProtobufEncoder());\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### é•¿è¿æ¥\r\n\r\nHTTP åè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨é—´çš„è¯·æ±‚å“åº”ä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡ä¼šé‡æ–°åˆ›å»ºè¿æ¥ã€‚å®ç°åŸºäº WebSocket çš„é•¿è¿æ¥çš„å…¨åŒå·¥çš„äº¤äº’ï¼Œæ”¹å˜ HTTP åè®®å¤šæ¬¡è¯·æ±‚çš„çº¦æŸ\r\n\r\nå¼€å‘éœ€æ±‚ï¼š\r\n\r\n* å®ç°é•¿è¿æ¥ï¼ŒæœåŠ¡å™¨ä¸æµè§ˆå™¨ç›¸äº’é€šä¿¡å®¢æˆ·ç«¯\r\n* æµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯ä¼šç›¸äº’æ„ŸçŸ¥ï¼Œæ¯”å¦‚æœåŠ¡å™¨å…³é—­äº†ï¼Œæµè§ˆå™¨ä¼šæ„ŸçŸ¥ï¼ŒåŒæ ·æµè§ˆå™¨å…³é—­äº†ï¼ŒæœåŠ¡å™¨ä¼šæ„ŸçŸ¥\r\n\r\nä»£ç å®ç°ï¼š\r\n\r\n* WebSocketï¼š\r\n\r\n  * WebSocket çš„æ•°æ®æ˜¯**ä»¥å¸§ï¼ˆframeï¼‰å½¢å¼ä¼ é€’**ï¼ŒWebSocketFrame ä¸‹é¢æœ‰å…­ä¸ªå­ç±»ï¼Œä»£è¡¨ä¸åŒçš„å¸§æ ¼å¼\r\n\r\n  * æµè§ˆå™¨è¯·æ±‚ URLï¼šws://localhost:8080/xxx\r\n\r\n  ```java\r\n  public class MyWebSocket {\r\n      public static void main(String[] args) throws Exception {\r\n          // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„\r\n          EventLoopGroup bossGroup = new NioEventLoopGroup(1);\r\n          EventLoopGroup workerGroup = new NioEventLoopGroup();\r\n          try {\r\n  \r\n              ServerBootstrap serverBootstrap = new ServerBootstrap();\r\n              serverBootstrap.group(bossGroup, workerGroup);\r\n              serverBootstrap.channel(NioServerSocketChannel.class);\r\n              serverBootstrap.handler(new LoggingHandler(LogLevel.INFO));\r\n              serverBootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\r\n                  @Override\r\n                  protected void initChannel(SocketChannel ch) throws Exception {\r\n                      ChannelPipeline pipeline = ch.pipeline();\r\n  \r\n                      // åŸºäº http åè®®ï¼Œä½¿ç”¨ http çš„ç¼–ç å’Œè§£ç å™¨\r\n                      pipeline.addLast(new HttpServerCodec());\r\n                      // æ˜¯ä»¥å—æ–¹å¼å†™ï¼Œæ·»åŠ  ChunkedWriteHandler å¤„ç†å™¨\r\n                      pipeline.addLast(new ChunkedWriteHandler());\r\n  \r\n                      // http æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯åˆ†æ®µ, HttpObjectAggregator å°±æ˜¯å¯ä»¥å°†å¤šä¸ªæ®µèšåˆ\r\n                      //  è¿™å°±å°±æ˜¯ä¸ºä»€ä¹ˆï¼Œå½“æµè§ˆå™¨å‘é€å¤§é‡æ•°æ®æ—¶ï¼Œå°±ä¼šå‘å‡ºå¤šæ¬¡ http è¯·æ±‚\r\n                      pipeline.addLast(new HttpObjectAggregator(8192));\r\n          \r\n                      // WebSocketServerProtocolHandler æ ¸å¿ƒåŠŸèƒ½æ˜¯ã€å°† http åè®®å‡çº§ä¸º ws åè®®ã€‘ï¼Œä¿æŒé•¿è¿æ¥\r\n                      pipeline.addLast(new WebSocketServerProtocolHandler(\"/hello\"));\r\n  \r\n                      // è‡ªå®šä¹‰çš„handler ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘\r\n                      pipeline.addLast(new MyTextWebSocketFrameHandler());\r\n                  }\r\n              });\r\n  \r\n              // å¯åŠ¨æœåŠ¡å™¨\r\n              ChannelFuture channelFuture = serverBootstrap.bind(8080).sync();\r\n              channelFuture.channel().closeFuture().sync();\r\n  \r\n          } finally {\r\n              bossGroup.shutdownGracefully();\r\n              workerGroup.shutdownGracefully();\r\n          }\r\n      }\r\n  }\r\n  ```\r\n\r\n* å¤„ç†å™¨ï¼š\r\n\r\n  ```java\r\n  public class MyTextWebSocketFrameHandler extends SimpleChannelInboundHandler<TextWebSocketFrame> {\r\n      // TextWebSocketFrame ç±»å‹ï¼Œè¡¨ç¤ºä¸€ä¸ªæ–‡æœ¬å¸§(frame)\r\n      @Override\r\n      protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) throws Exception {\r\n          System.out.println(\"æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯ \" + msg.text());\r\n          // å›å¤æ¶ˆæ¯\r\n          ctx.writeAndFlush(new TextWebSocketFrame(\"æœåŠ¡å™¨æ—¶é—´\" + LocalDateTime.now() + \" \" + msg.text()));\r\n      }\r\n  \r\n      // å½“webå®¢æˆ·ç«¯è¿æ¥åï¼Œ è§¦å‘æ–¹æ³•\r\n      @Override\r\n      public void handlerAdded(ChannelHandlerContext ctx) throws Exception {\r\n          // id è¡¨ç¤ºå”¯ä¸€çš„å€¼ï¼ŒLongText æ˜¯å”¯ä¸€çš„ ShortText ä¸æ˜¯å”¯ä¸€\r\n          System.out.println(\"handlerAdded è¢«è°ƒç”¨\" + ctx.channel().id().asLongText());\r\n          System.out.println(\"handlerAdded è¢«è°ƒç”¨\" + ctx.channel().id().asShortText());\r\n      }\r\n  \r\n      @Override\r\n      public void handlerRemoved(ChannelHandlerContext ctx) throws Exception {\r\n          System.out.println(\"handlerRemoved è¢«è°ƒç”¨\" + ctx.channel().id().asLongText());\r\n      }\r\n  \r\n      @Override\r\n      public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {\r\n          System.out.println(\"å¼‚å¸¸å‘ç”Ÿ \" + cause.getMessage());\r\n          ctx.close(); // å…³é—­è¿æ¥\r\n      }\r\n  }\r\n  ```\r\n\r\n* HTMLï¼š\r\n\r\n  ```html\r\n  <!DOCTYPE html>\r\n  <html lang=\"en\">\r\n  <head>\r\n      <meta charset=\"UTF-8\">\r\n      <title>Title</title>\r\n  </head>\r\n  <body>\r\n  <script>\r\n      var socket;\r\n      // åˆ¤æ–­å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒwebsocket\r\n      if(window.WebSocket) {\r\n          //go on\r\n          socket = new WebSocket(\"ws://localhost:8080/hello\");\r\n          //ç›¸å½“äºchannelReado, ev æ”¶åˆ°æœåŠ¡å™¨ç«¯å›é€çš„æ¶ˆæ¯\r\n          socket.onmessage = function (ev) {\r\n              var rt = document.getElementById(\"responseText\");\r\n              rt.value = rt.value + \"\\n\" + ev.data;\r\n          }\r\n  \r\n          //ç›¸å½“äºè¿æ¥å¼€å¯(æ„ŸçŸ¥åˆ°è¿æ¥å¼€å¯)\r\n          socket.onopen = function (ev) {\r\n              var rt = document.getElementById(\"responseText\");\r\n              rt.value = \"è¿æ¥å¼€å¯äº†..\"\r\n          }\r\n  \r\n          //ç›¸å½“äºè¿æ¥å…³é—­(æ„ŸçŸ¥åˆ°è¿æ¥å…³é—­)\r\n          socket.onclose = function (ev) {\r\n  \r\n              var rt = document.getElementById(\"responseText\");\r\n              rt.value = rt.value + \"\\n\" + \"è¿æ¥å…³é—­äº†..\"\r\n          }\r\n      } else {\r\n          alert(\"å½“å‰æµè§ˆå™¨ä¸æ”¯æŒwebsocket\")\r\n      }\r\n  \r\n      // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨\r\n      function send(message) {\r\n          // å…ˆåˆ¤æ–­socketæ˜¯å¦åˆ›å»ºå¥½\r\n          if(!window.socket) {\r\n              return;\r\n          }\r\n          if(socket.readyState == WebSocket.OPEN) {\r\n              // é€šè¿‡socket å‘é€æ¶ˆæ¯\r\n              socket.send(message)\r\n          } else {\r\n              alert(\"è¿æ¥æ²¡æœ‰å¼€å¯\");\r\n          }\r\n      }\r\n  </script>\r\n      <form onsubmit=\"return false\">\r\n          <textarea name=\"message\" style=\"height: 300px; width: 300px\"></textarea>\r\n          <input type=\"button\" value=\"å‘ç”Ÿæ¶ˆæ¯\" onclick=\"send(this.form.message.value)\">\r\n          <textarea id=\"responseText\" style=\"height: 300px; width: 300px\"></textarea>\r\n          <input type=\"button\" value=\"æ¸…ç©ºå†…å®¹\" onclick=\"document.getElementById('responseText').value=''\">\r\n      </form>\r\n  </body>\r\n  </html>\r\n  ```\r\n\r\n\r\n\r\n\r\n\r\n***\r\n\r\n\r\n\r\n### å‚æ•°è°ƒä¼˜\r\n\r\n#### CONNECT\r\n\r\nå‚æ•°é…ç½®æ–¹å¼ï¼š\r\n\r\n* å®¢æˆ·ç«¯é€šè¿‡ .option() æ–¹æ³•é…ç½®å‚æ•°ï¼Œç»™ SocketChannel é…ç½®å‚æ•°\r\n* æœåŠ¡å™¨ç«¯ï¼š\r\n  * new ServerBootstrap().option()ï¼š ç»™ ServerSocketChannel é…ç½®å‚æ•°\r\n  * new ServerBootstrap().childOption()ï¼šç»™ SocketChannel é…ç½®å‚æ•°\r\n\r\nCONNECT_TIMEOUT_MILLIS å‚æ•°ï¼š\r\n\r\n* å±äº SocketChannal å‚æ•°\r\n* åœ¨å®¢æˆ·ç«¯å»ºç«‹è¿æ¥æ—¶ï¼Œå¦‚æœåœ¨æŒ‡å®šæ¯«ç§’å†…æ— æ³•è¿æ¥ï¼Œä¼šæŠ›å‡º timeout å¼‚å¸¸\r\n\r\n* SO_TIMEOUT ä¸»è¦ç”¨åœ¨é˜»å¡ IOï¼Œé˜»å¡ IO ä¸­ acceptï¼Œread ç­‰éƒ½æ˜¯æ— é™ç­‰å¾…çš„ï¼Œå¦‚æœä¸å¸Œæœ›æ°¸è¿œé˜»å¡ï¼Œå¯ä»¥è°ƒæ•´è¶…æ—¶æ—¶é—´\r\n\r\n```java\r\npublic class ConnectionTimeoutTest {\r\n    public static void main(String[] args) {\r\n        NioEventLoopGroup group = new NioEventLoopGroup();\r\n        try {\r\n            Bootstrap bootstrap = new Bootstrap()\r\n                    .group(group)\r\n                    .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000)\r\n                    .channel(NioSocketChannel.class)\r\n                    .handler(new LoggingHandler());\r\n            ChannelFuture future = bootstrap.connect(\"127.0.0.1\", 8080);\r\n            future.sync().channel().closeFuture().sync();\r\n        } catch (Exception e) {\r\n            e.printStackTrace();\r\n            log.debug(\"timeout\");\r\n        } finally {\r\n            group.shutdownGracefully();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### SO_BACKLOG\r\n\r\nå±äº ServerSocketChannal å‚æ•°ï¼Œé€šè¿‡ `option(ChannelOption.SO_BACKLOG, value)` æ¥è®¾ç½®å¤§å°\r\n\r\nåœ¨ Linux 2.2 ä¹‹å‰ï¼Œbacklog å¤§å°åŒ…æ‹¬äº†ä¸¤ä¸ªé˜Ÿåˆ—çš„å¤§å°ï¼Œåœ¨ 2.2 ä¹‹åï¼Œåˆ†åˆ«ç”¨ä¸‹é¢ä¸¤ä¸ªå‚æ•°æ¥æ§åˆ¶\r\n\r\n* sync queueï¼šåŠè¿æ¥é˜Ÿåˆ—ï¼Œå¤§å°é€šè¿‡ `/proc/sys/net/ipv4/tcp_max_syn_backlog` æŒ‡å®šï¼Œåœ¨ `syncookies` å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œé€»è¾‘ä¸Šæ²¡æœ‰æœ€å¤§å€¼é™åˆ¶\r\n* accept queueï¼šå…¨è¿æ¥é˜Ÿåˆ—ï¼Œå¤§å°é€šè¿‡ `/proc/sys/net/core/somaxconn` æŒ‡å®šï¼Œåœ¨ä½¿ç”¨ listen å‡½æ•°æ—¶ï¼Œå†…æ ¸ä¼šæ ¹æ®ä¼ å…¥çš„ backlog å‚æ•°ä¸ç³»ç»Ÿå‚æ•°ï¼Œå–äºŒè€…çš„è¾ƒå°å€¼ã€‚å¦‚æœ accpet queue é˜Ÿåˆ—æ»¡äº†ï¼Œserver å°†**å‘é€ä¸€ä¸ªæ‹’ç»è¿æ¥çš„é”™è¯¯ä¿¡æ¯**åˆ° client\r\n\r\n![image-20241006232236836](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20241006232236836.png)\r\n\r\n\r\n\r\n****\r\n\r\n\r\n\r\n#### å…¶ä»–å‚æ•°\r\n\r\nALLOCATORï¼šå±äº SocketChannal å‚æ•°ï¼Œç”¨æ¥åˆ†é… ByteBufï¼Œ ctx.alloc()\r\n\r\nRCVBUF_ALLOCATORï¼šå±äº SocketChannal å‚æ•°\r\n\r\n* æ§åˆ¶ Netty æ¥æ”¶ç¼“å†²åŒºå¤§å°\r\n* è´Ÿè´£å…¥ç«™æ•°æ®çš„åˆ†é…ï¼Œå†³å®šå…¥ç«™ç¼“å†²åŒºçš„å¤§å°ï¼ˆå¹¶å¯åŠ¨æ€è°ƒæ•´ï¼‰ï¼Œç»Ÿä¸€é‡‡ç”¨ direct ç›´æ¥å†…å­˜ï¼Œå…·ä½“æ± åŒ–è¿˜æ˜¯éæ± åŒ–ç”± allocator å†³å®š\r\n"},{"title":"ç¬¬äº”ç« . åç«¯ä¹‹äºå‰ç«¯ - React","tags":["React"],"categories":["å‰ç«¯"],"author":"imklaus","excerpt":"\r\n\r\n\r\n\r\n## 1. React åŸºç¡€\r\n\r\nreact æ˜¯å‰ç«¯ä¸‰å¤§æ¡†æ¶ä¹‹ä¸€\r\n\r\n* æ²¡æœ‰ vue çš„åŸºç¡€æ›´å¥½ï¼Œå› ä¸ºä¸¤è€…æ€æƒ³ä¸å¤ªä¸€æ ·ï¼Œä¸èƒ½ç”¨ vue çš„ä¹ æƒ¯å­¦ä¹  react\r\n* éœ€è¦æœ‰ js","link":"/posts/React","content":"\r\n\r\n\r\n\r\n## 1. React åŸºç¡€\r\n\r\nreact æ˜¯å‰ç«¯ä¸‰å¤§æ¡†æ¶ä¹‹ä¸€\r\n\r\n* æ²¡æœ‰ vue çš„åŸºç¡€æ›´å¥½ï¼Œå› ä¸ºä¸¤è€…æ€æƒ³ä¸å¤ªä¸€æ ·ï¼Œä¸èƒ½ç”¨ vue çš„ä¹ æƒ¯å­¦ä¹  react\r\n* éœ€è¦æœ‰ js åŸºç¡€ï¼Œ[è§†é¢‘](https://www.bilibili.com/video/BV1Tt4y1772f) 19-58\r\n* éœ€è¦æœ‰ ts åŸºç¡€ï¼Œ[è§†é¢‘](https://www.bilibili.com/video/BV1Tt4y1772f) 110-116\r\n* æœ¬æ•™ç¨‹é‡‡ç”¨æ›´æµè¡Œçš„ã€å‡½æ•°å¼ç»„ä»¶ + hooksã€‘æ–¹å¼è¿›è¡Œè®²è§£\r\n\r\n\r\n\r\n### 1) ç¯å¢ƒå‡†å¤‡\r\n\r\n#### åˆ›å»ºé¡¹ç›®\r\n\r\né¦–å…ˆï¼Œé€šè¿‡ react è„šæ‰‹æ¶åˆ›å»ºé¡¹ç›®\r\n\r\n```cmd\r\nnpx create-react-app client --template typescript\r\n```\r\n\r\n* client æ˜¯é¡¹ç›®å\r\n* ç›®å‰ react ç‰ˆæœ¬æ˜¯ 18.x\r\n\r\nè¿è¡Œé¡¹ç›®\r\n\r\n```cmd\r\ncd client\r\nnpm start\r\n```\r\n\r\n* ä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œé»˜è®¤ç›‘å¬ 3000 ç«¯å£\r\n\r\n![image-20221001110328233](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221001110328233.png)\r\n\r\n\r\n\r\n#### ä¿®æ”¹ç«¯å£\r\n\r\nåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ .env.developmentï¼Œå®ƒå¯ä»¥å®šä¹‰å¼€å‘ç¯å¢ƒä¸‹çš„ç¯å¢ƒå˜é‡\r\n\r\n```properties\r\nPORT=7070\r\n```\r\n\r\né‡å¯é¡¹ç›®ï¼Œç«¯å£å°±å˜æˆäº† 7070\r\n\r\n* å‚è€ƒæ–‡æ¡£ï¼š[Advanced Configuration | Create React App (create-react-app.dev)](https://create-react-app.dev/docs/advanced-configuration/)\r\n\r\n\r\n\r\n#### æµè§ˆå™¨æ’ä»¶\r\n\r\næ’ä»¶åœ°å€ [New React Developer Tools â€“ React Blog (reactjs.org)](https://reactjs.org/blog/2015/09/02/new-react-developer-tools.html#installation)\r\n\r\n![image-20221004105110150](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221004105110150.png)\r\n\r\n#### VSCode\r\n\r\næ¨èå®‰è£… Prettier ä»£ç æ ¼å¼åŒ–æ’ä»¶\r\n\r\n![image-20221004090816142](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221004090816142.png)\r\n\r\n\r\n\r\n### 2) å…¥é—¨æ¡ˆä¾‹\r\n\r\n#### Hello\r\n\r\nç¼–å†™ä¸€ä¸ª src/pages/Hello.tsx ç»„ä»¶\r\n\r\n```tsx\r\nexport default function Hello()  {\r\n  return <h3>Hello, World!</h3>\r\n}\r\n```\r\n\r\n* ç»„ä»¶ä¸­ä½¿ç”¨äº† jsx è¯­æ³•ï¼Œå³åœ¨ js ä¸­ç›´æ¥ä½¿ç”¨ html æ ‡ç­¾æˆ–ç»„ä»¶æ ‡ç­¾\r\n* å‡½æ•°å¼ç»„ä»¶å¿…é¡»è¿”å›æ ‡ç­¾ç‰‡æ®µ\r\n\r\nåœ¨ index.js å¼•å…¥ç»„ä»¶\r\n\r\n```jsx\r\nimport React from 'react'\r\nimport ReactDOM from 'react-dom/client'\r\nimport './index.css'\r\nimport reportWebVitals from './reportWebVitals'\r\n// 1. å¼•å…¥ç»„ä»¶\r\nimport Hello from './pages/Hello'\r\n\r\nconst root = ReactDOM.createRoot(document.getElementById('root') as HTMLElement)\r\nroot.render(\r\n  <React.StrictMode>\r\n    {/* 2. å°†åŸæ¥çš„ <App/> æ”¹ä¸º <Hello></Hello> */}\r\n    <Hello></Hello>\r\n  </React.StrictMode>\r\n)\r\n\r\n// If you want to start measuring performance in your app, pass a function\r\n// to log results (for example: reportWebVitals(console.log))\r\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\r\nreportWebVitals()\r\n```\r\n\r\n\r\n\r\nå°†æ¬¢è¿è¯ä½œä¸ºå±æ€§ä¼ é€’ç»™ç»„ä»¶\r\n\r\n```jsx\r\n<Hello msg='ä½ å¥½'></Hello>\r\n```\r\n\r\n* å­—ç¬¦ä¸²å€¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨åŒå¼•å·èµ‹å€¼\r\n* å…¶å®ƒç±»å‹çš„å€¼ï¼Œç”¨ `{å€¼}`\r\n\r\nè€Œç»„ä»¶ä¿®æ”¹ä¸º\r\n\r\n```tsx\r\nexport default function Hello(props: { msg: string }) {\r\n  return <h3>{props.msg}</h3>\r\n}\r\n```\r\n\r\n\r\n\r\n#### jsx åŸç†\r\n\r\n```tsx\r\nexport default function Hello(props: { msg: string }) {\r\n  return <h3>{props.msg}</h3>\r\n}\r\n```\r\n\r\nåœ¨ v17 ä¹‹å‰ï¼Œå…¶å®ç›¸å½“äº\r\n\r\n```tsx\r\nimport { createElement } from \"react\";\r\nexport default function Hello(props: {msg: string}) {\r\n  return createElement('h3', null, `${props.msg}`)\r\n}\r\n```\r\n\r\n\r\n\r\n### 3) äººç‰©å¡ç‰‡æ¡ˆä¾‹\r\n\r\næ ·å¼å·²ç»å‡†å¤‡å¥½ /src/css/P1.css\r\n\r\n```css\r\n#root {\r\n  display: flex;\r\n  width: 100vw;\r\n  height: 100vh;\r\n  justify-content: center;\r\n  align-items: center;\r\n}\r\n\r\ndiv.student {\r\n  flex-shrink: 0;\r\n  flex-grow: 0;\r\n  position: relative;\r\n  width: 128px;\r\n  height: 330px;\r\n  /* font-family: 'åæ–‡è¡Œæ¥·'; */\r\n  font-size: 14px;\r\n  text-align: center;\r\n  margin: 20px;\r\n  display: flex;\r\n  justify-content: flex-start;\r\n  background-color: #7591AD;\r\n  align-items: center;\r\n  flex-direction: column;\r\n  border-radius: 5px;\r\n  box-shadow: 0 0 8px #2c2c2c;\r\n  color: #e8f6fd;\r\n}\r\n\r\n.photo {\r\n  position: absolute;\r\n  width: 100%;\r\n  height: 100%;\r\n  top: 0;\r\n  border-radius: 0%;\r\n  overflow: hidden;\r\n  transition: 0.3s;\r\n  border-radius: 5px;\r\n}\r\n\r\n.photo img {\r\n  width: 100%;\r\n  height: 100%;\r\n  /* object-fit: scale-down; */\r\n  object-fit: cover;\r\n}\r\n\r\n.photo::before {\r\n  position: absolute;\r\n  content: '';\r\n  width: 100%;\r\n  height: 100%;\r\n  background-image: linear-gradient(to top, #333, transparent);\r\n}\r\n\r\ndiv.student h2 {\r\n  position: absolute;\r\n  font-size: 20px;\r\n  width: 100%;\r\n  height: 68px;\r\n  font-weight: normal;\r\n  text-align: center;\r\n  margin: 0;\r\n  line-height: 68px;\r\n  visibility: hidden;\r\n}\r\n\r\nh2::before {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  content: '';\r\n  width: 100%;\r\n  height: 68px;\r\n  background-color: rgba(0, 0, 0, 0.3);\r\n  border-top-left-radius: 5px;\r\n  border-top-right-radius: 5px;  \r\n}\r\n\r\ndiv.student h1 {\r\n  position: absolute;\r\n  top: 250px;\r\n  font-size: 22px;\r\n  margin: 0;\r\n  transition: 0.3s;\r\n  font-weight: normal;\r\n}\r\n\r\ndiv.student p {\r\n  margin-top: 300px;\r\n  width: 80%;\r\n  font-weight: normal;\r\n  text-align: center;\r\n  padding-bottom: 5px;\r\n  border-bottom: 1px solid #8ea2b8;\r\n}\r\n\r\n.student:hover .photo::before {\r\n  display: none;\r\n}\r\n\r\n.student:hover .photo {\r\n  width: 90px;\r\n  height: 90px;\r\n  top: 90px;\r\n  border-radius: 50%;\r\n  box-shadow: 0 0 15px #111;\r\n}\r\n\r\n.student:hover img {\r\n  object-position: 50% 0%;\r\n}\r\n\r\n.student:hover h1 {\r\n  position: absolute;\r\n  top: 190px;\r\n  width: 40px;\r\n}\r\n\r\ndiv.student:hover h2 {\r\n  visibility: visible;\r\n}\r\n```\r\n\r\nç±»å‹ /src/model/Student.ts\r\n\r\n```typescript\r\nexport interface Student {\r\n  id: number,\r\n  name: string,\r\n  sex: string,\r\n  age: number,\r\n  photo: string\r\n}\r\n```\r\n\r\nç»„ä»¶ /src/pages/P1.tsx\r\n\r\n```tsx\r\nimport { Student } from '../model/Student'\r\nimport '../css/P1.css'\r\nexport default function P1(props: { student: Student }) {\r\n  return (\r\n    <div className='student'>\r\n      <div className='photo'>\r\n        <img src={props.student.photo}/>\r\n      </div>\r\n      <h1>{props.student.name}</h1>\r\n      <h2>{props.student.id}</h2>      \r\n      <p>æ€§åˆ« {props.student.sex} å¹´é¾„ {props.student.age}</p>\r\n    </div>\r\n  )\r\n}\r\n```\r\n\r\nä½¿ç”¨ç»„ä»¶\r\n\r\n```tsx\r\nconst stu1 = { id: 1, name: 'é£æ¸…æ‰¬', sex: 'ç”·', age: 99, photo: '/imgs/1.png' }\r\nconst stu2 = { id: 2, name: 'ç®å“¥', sex: 'ç”·', age: 20, photo: '/imgs/2.png' }\r\nconst stu3 = { id: 3, name: 'é•¿å®', sex: 'ç”·', age: 30, photo: '/imgs/3.png'}\r\n\r\n<P1 student={stu1}></P1>\r\n<P1 student={stu2}></P1>\r\n<P1 student={stu3}></P1>\r\n```\r\n\r\n\r\n\r\n#### è·¯å¾„\r\n\r\n* src ä¸‹çš„èµ„æºï¼Œè¦ç”¨ç›¸å¯¹è·¯å¾„å¼•å…¥\r\n* public ä¸‹çš„èµ„æºï¼Œè®°å¾— / ä»£è¡¨è·¯å¾„çš„èµ·ç‚¹\r\n\r\n\r\n\r\n#### æ ‡ç­¾å‘½å\r\n\r\n* ç»„ä»¶æ ‡ç­¾å¿…é¡»ç”¨å¤§é©¼å³°å‘½å\r\n* æ™®é€š html æ ‡ç­¾å¿…é¡»ç”¨å°å†™å‘½å\r\n\r\n\r\n\r\n#### äº‹ä»¶å¤„ç†\r\n\r\n```tsx\r\nimport { Student } from '../model/Student'\r\nimport '../css/P1.css'\r\nexport default function P1(props: { student: Student }) {\r\n    \r\n  function handleClick(e : React.MouseEvent){\r\n    console.log(student)\r\n    console.log(e)\r\n  }\r\n  \r\n  return (\r\n    <div className='student'>\r\n      <div className='photo' onClick={handleClick}>\r\n        <img src={props.student.photo}/>\r\n      </div>\r\n      <h1>{props.student.name}</h1>\r\n      <h2>{props.student.id}</h2>\r\n      <p>æ€§åˆ« {props.student.sex} å¹´é¾„ {props.student.age}</p>\r\n    </div>\r\n  )\r\n}\r\n```\r\n\r\n* äº‹ä»¶ä»¥å°é©¼å³°å‘½å\r\n* äº‹ä»¶å¤„ç†å‡½æ•°å¯ä»¥æœ‰ä¸€ä¸ªäº‹ä»¶å¯¹è±¡å‚æ•°ï¼Œå¯ä»¥è·å–äº‹ä»¶ç›¸å…³ä¿¡æ¯\r\n\r\n\r\n\r\n#### åˆ—è¡¨ & Key\r\n\r\n```tsx\r\nimport { Student } from '../model/Student'\r\nimport P1 from './P1'\r\n\r\nexport default function P2(props: { students: Student[] }) {\r\n  return (\r\n    <>\r\n      {props.students.map((s) => ( <P1 student={s} key={s.id}></P1> ))}\r\n    </>\r\n  )\r\n}\r\n```\r\n\r\n* key åœ¨å¾ªç¯æ—¶æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™ä¼šæœ‰ warning\r\n\r\nä¹Ÿå¯ä»¥è¿™ä¹ˆåš\r\n\r\n```tsx\r\nimport { Student } from '../model/Student'\r\nimport P1 from './P1'\r\n\r\nexport default function P2(props: { students: Student[] }) {\r\n  const list = props.students.map((s) => <P1 student={s} key={s.id}></P1>)\r\n  return <>{list}</>\r\n}\r\n```\r\n\r\n\r\n\r\nä½¿ç”¨ç»„ä»¶\r\n\r\n```tsx\r\nconst stu1 = { id: 1, name: 'é£æ¸…æ‰¬', sex: 'ç”·', age: 99, photo: '/1.png' }\r\nconst stu2 = { id: 2, name: 'ç®å“¥', sex: 'ç”·', age: 45, photo: '/2.png' }\r\nconst stu3 = { id: 3, name: 'é•¿å®', sex: 'ç”·', age: 45, photo: '/3.png'}\r\n\r\n<P2 students={[stu1,stu2,stu3]}></P2>\r\n```\r\n\r\n\r\n\r\n#### æ¡ä»¶æ¸²æŸ“\r\n\r\nP1 ä¿®æ”¹ä¸º\r\n\r\n```tsx\r\nimport { Student } from '../model/Student'\r\nimport '../css/P1.css'\r\nexport default function P1(props: { student: Student; hideAge?: boolean }) {\r\n  function handleClick() {\r\n    console.log(props.student)\r\n  }\r\n\r\n  const ageFragment = !props.hideAge && <span>å¹´é¾„ {props.student.age}</span>\r\n\r\n  return (\r\n    <div className='student'>\r\n      <div className='photo' onClick={handleClick}>\r\n        <img src={props.student.photo} />\r\n      </div>\r\n      <h1>{props.student.name}</h1>\r\n      <h2>{props.student.id}</h2>\r\n      <p>\r\n        æ€§åˆ« {props.student.sex} {ageFragment}\r\n      </p>\r\n    </div>\r\n  )\r\n}\r\n```\r\n\r\n* å­å…ƒç´ å¦‚æœæ˜¯å¸ƒå°”å€¼ï¼Œnullishï¼Œä¸ä¼šæ¸²æŸ“\r\n\r\n\r\n\r\nP2 ä¿®æ”¹ä¸º\r\n\r\n```tsx\r\nimport { Student } from '../model/Student'\r\nimport P1 from './P1'\r\n\r\nexport default function P2(props: { students: Student[]; hideAge?: boolean }) {\r\n  const list = props.students.map((s) => (\r\n    <P1 student={s} hideAge={props.hideAge} key={s.id}></P1>\r\n  ))\r\n  return <>{list}</>\r\n}\r\n```\r\n\r\n\r\n\r\nä½¿ç”¨ç»„ä»¶\r\n\r\n```tsx\r\nconst stu1 = { id: 1, name: 'é£æ¸…æ‰¬', sex: 'ç”·', age: 99, photo: '/1.png' }\r\nconst stu2 = { id: 2, name: 'ç®å“¥', sex: 'ç”·', age: 45, photo: '/2.png' }\r\nconst stu3 = { id: 3, name: 'é•¿å®', sex: 'ç”·', age: 45, photo: '/3.png'}\r\n\r\n<P2 students={[stu1,stu2,stu3]} hideAge={true}></P2>\r\n```\r\n\r\n\r\n\r\n#### å‚æ•°è§£æ„\r\n\r\nä»¥ P1 ç»„ä»¶ä¸ºä¾‹\r\n\r\n```tsx\r\nimport { Student } from '../model/Student'\r\nimport '../css/P1.css'\r\nexport default function P1\r\n({ student, hideAge = false }: { student: Student, hideAge?: boolean }) {\r\n  \r\n  function handleClick() {\r\n    console.log(student)\r\n  }\r\n\r\n  const ageFragment = !hideAge && <span>å¹´é¾„ {student.age}</span>\r\n\r\n  return (\r\n    <div className='student'>\r\n      <div className='photo' onClick={handleClick}>\r\n        <img src={student.photo} />\r\n      </div>\r\n      <h1>{student.name}</h1>\r\n      <h2>{student.id}</h2>\r\n      <p>\r\n        æ€§åˆ« {student.sex} {ageFragment}\r\n      </p>\r\n    </div>\r\n  )\r\n}\r\n```\r\n\r\n* å¯ä»¥åˆ©ç”¨è§£æ„èµ‹å€¼è¯­å¥ï¼Œè®© props çš„ä½¿ç”¨æ›´ä¸ºç®€å•\r\n* å¯¹è±¡è§£æ„èµ‹å€¼è¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„å¥½å¤„ï¼Œç»™å±æ€§èµ‹é»˜è®¤å€¼\r\n\r\n\r\n\r\nä½¿ç”¨ç»„ä»¶\r\n\r\n```tsx\r\nconst stu1 = { id: 1, name: 'é£æ¸…æ‰¬', sex: 'ç”·', age: 99, photo: '/1.png' }\r\n\r\n<P1 student={stu1}></P1>\r\n```\r\n\r\n\r\n\r\n### 4) å¤„ç†å˜åŒ–çš„æ•°æ®\r\n\r\nå…¥é—¨æ¡ˆä¾‹ä¾§é‡çš„æ˜¯æ•°æ®å±•ç¤ºï¼Œå¹¶æœªæ¶‰åŠåˆ°æ•°æ®çš„å˜åŠ¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹å­¦ä¹  react å¦‚ä½•å¤„ç†æ•°æ®å˜åŒ–\r\n\r\n\r\n\r\n#### axios\r\n\r\né¦–å…ˆæ¥å­¦ä¹  axiosï¼Œä½œç”¨æ˜¯å‘é€è¯·æ±‚ã€æ¥æ”¶å“åº”ï¼Œä»æœåŠ¡å™¨è·å–çœŸå®æ•°æ®\r\n\r\nå®‰è£…\r\n\r\n```cmd\r\nnpm install axios\r\n```\r\n\r\nå®šä¹‰ç»„ä»¶\r\n\r\n```tsx\r\nimport axios from 'axios'\r\nexport default function P4({ id }: { id: number }) {\r\n  async function updateStudent() {\r\n    const resp = await axios.get(`http://localhost:8080/api/students/${id}`)\r\n    console.log(resp.data.data)\r\n  }\r\n\r\n  updateStudent()\r\n\r\n  return <></>\r\n}\r\n```\r\n\r\n* å…¶ä¸­ /api/students/${id} æ˜¯æå‰å‡†å¤‡å¥½çš„åç«¯æœåŠ¡ apiï¼Œä¼šå»¶è¿Ÿ 2s è¿”å›ç»“æœ\r\n\r\nä½¿ç”¨ç»„ä»¶\r\n\r\n```tsx\r\n<P4 id={1}></P4>\r\n```\r\n\r\nåœ¨æ§åˆ¶å°ä¸Šæ‰“å°\r\n\r\n```\r\n{\r\n    \"id\": 1,\r\n    \"name\": \"å®‹è¿œæ¡¥\",\r\n    \"sex\": \"ç”·\",\r\n    \"age\": 40\r\n}\r\n```\r\n\r\nå½“å±æ€§å˜åŒ–æ—¶ï¼Œä¼šé‡æ–°è§¦å‘ P4 ç»„ä»¶æ‰§è¡Œï¼Œä¾‹å¦‚å°† id ä» 1 ä¿®æ”¹ä¸º 2\r\n\r\n![image-20221005160308705](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221005160308705.png)\r\n\r\næ‰§è¡Œæµç¨‹\r\n\r\n* é¦–æ¬¡è°ƒç”¨å‡½æ•°ç»„ä»¶ï¼Œè¿”å›çš„ jsx ä»£ç ä¼šè¢«æ¸²æŸ“æˆã€è™šæ‹Ÿ dom èŠ‚ç‚¹ã€‘ï¼ˆä¹Ÿç§° Fiber èŠ‚ç‚¹ï¼‰\r\n  * æ ¹æ®ã€è™šæ‹Ÿ dom èŠ‚ç‚¹ã€‘ä¼šç”Ÿæˆã€çœŸå® dom èŠ‚ç‚¹ã€‘ï¼Œç”±æµè§ˆå™¨æ˜¾ç¤ºå‡ºæ¥\r\n* å½“å‡½æ•°ç»„ä»¶çš„ props æˆ– state å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼š**é‡æ–°**è°ƒç”¨å‡½æ•°ç»„ä»¶ï¼Œè¿”å› jsx\r\n  * jsx ä¸ä¸Šæ¬¡çš„ã€è™šæ‹Ÿ dom èŠ‚ç‚¹ã€‘å¯¹æ¯”\r\n    * å¦‚æœæ²¡å˜åŒ–ï¼Œå¤ç”¨ä¸Šæ¬¡çš„èŠ‚ç‚¹\r\n    * æœ‰å˜åŒ–ï¼Œåˆ›å»ºæ–°çš„ã€è™šæ‹Ÿ dom èŠ‚ç‚¹ã€‘æ›¿æ¢æ‰ä¸Šæ¬¡çš„èŠ‚ç‚¹\r\n* ç”±äºä¸¥æ ¼æ¨¡å¼ä¼šè§¦å‘ä¸¤æ¬¡æ¸²æŸ“ï¼Œä¸ºäº†é¿å…å¹²æ‰°ï¼Œè¯·å…ˆæ³¨é‡Šæ‰ index.tsx ä¸­çš„ `<React.StrictMode>`\r\n\r\n\r\n\r\n#### çŠ¶æ€\r\n\r\nå…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œèƒ½å¦æŠŠæœåŠ¡å™¨è¿”å›çš„æ•°æ®æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š\r\n\r\n```tsx\r\nimport axios from 'axios'\r\nlet count = 0\r\nexport default function P5(props: { id: number }) {\r\n  \r\n  function getTime() {\r\n    const d = new Date()\r\n    return d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds()\r\n  }\r\n  \r\n  async function updateStudent() {\r\n    const resp = await axios.get(\r\n      `http://localhost:8080/api/students/${props.id}`\r\n    )\r\n    Object.assign(student, resp.data.data)\r\n    console.log(current, student, getTime())\r\n  }\r\n\r\n  const current = count++\r\n  let student = { name: 'xx' }\r\n  console.log(current, student, getTime())\r\n  updateStudent()\r\n  \r\n  return <h3>å§“åæ˜¯ï¼š{student.name}</h3>\r\n}\r\n```\r\n\r\n* count æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œè®°å½• P5 å‡½æ•°ç¬¬å‡ æ¬¡è¢«è°ƒç”¨\r\n\r\næ‰§è¡Œæ•ˆæœï¼Œæ§åˆ¶å°ä¸Š\r\n\r\n```\r\n0 {name: 'xx'} '16:22:16'\r\n0 {id: 1, name: 'å®‹è¿œæ¡¥', sex: 'ç”·', age: 40} '16:22:18'\r\n```\r\n\r\næ­¤æ—¶é¡µé¢ä»æ˜¾ç¤º `å§“åæ˜¯ï¼šxx`\r\n\r\n\r\n\r\né‚£ä¹ˆä¿®æ”¹ä¸€ä¸‹ props çš„ id å‘¢ï¼Ÿè¿›å…¥å¼€å‘å·¥å…·æŠŠ id ä» 1 ä¿®æ”¹ä¸º 2ï¼Œæ§åˆ¶å°ä¸Š\r\n\r\n```tsx\r\n1 {name: 'xx'} '16:24:0'\r\n1 {id: 2, name: 'ä¿è²èˆŸ', sex: 'ç”·', age: 38} '16:24:2'\r\n```\r\n\r\næ­¤æ—¶é¡µé¢ä»æ˜¾ç¤º `å§“åæ˜¯ï¼šxx`\r\n\r\n\r\n\r\nä¸ºä»€ä¹ˆé¡µé¢æ²¡æœ‰æ˜¾ç¤ºä¸¤ç§’åæ›´æ–°çš„å€¼ï¼Ÿ\r\n\r\n* ç¬¬ä¸€æ¬¡ï¼Œé¡µé¢æ˜¾ç¤ºçš„æ˜¯ P5 å‡½æ•°çš„è¿”å›ç»“æœï¼Œè¿™æ—¶ student.name è¿˜æœªè¢«æ›´æ–°æˆå®‹è¿œæ¡¥ï¼Œé¡µé¢æ˜¾ç¤º xx\r\n  * è™½ç„¶ 2s åæ•°æ®æ›´æ–°äº†ï¼Œä½†æ­¤æ—¶å¹¶æœªè§¦å‘å‡½æ•°æ‰§è¡Œï¼Œé¡µé¢ä¸å˜\r\n* ç¬¬äºŒæ¬¡ï¼Œè™½ç„¶ props ä¿®æ”¹è§¦å‘äº†å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œä½†æ—¢ç„¶å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œå‡½æ•°å†…çš„ student åˆè¢«èµ‹å€¼ä¸º `{ name: 'xx' }`ï¼Œé¡µé¢è¿˜æ˜¯æ˜¾ç¤º xx\r\n  * 2s åæ•°æ®æ›´æ–°ï¼Œè·Ÿç¬¬ä¸€æ¬¡ä¸€æ ·ï¼Œå¹¶æœªé‡æ–°è§¦å‘å‡½æ•°æ‰§è¡Œï¼Œé¡µé¢ä¸å˜\r\n\r\n\r\n\r\nç»“è®ºï¼š\r\n\r\n* å‡½æ•°æ˜¯æ— çŠ¶æ€çš„ï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œå®ƒå†…éƒ¨ç”¨çš„æ•°æ®éƒ½ä¸ä¼šä¿å­˜ä¸‹æ¥\r\n* è¦æƒ³è®©å‡½æ•°æœ‰çŠ¶æ€ï¼Œå°±éœ€è¦ä½¿ç”¨ useState æŠŠæ•°æ®ä¿å­˜åœ¨å‡½æ•°ä¹‹å¤–çš„åœ°æ–¹ï¼Œè¿™äº›æ•°æ®ï¼Œç§°ä¹‹ä¸ºçŠ¶æ€\r\n\r\n\r\n\r\n#### useState\r\n\r\n```tsx\r\nimport axios from 'axios'\r\nimport { useReducer, useState } from 'react'\r\nimport { Student } from '../model/Student'\r\nlet count = 0\r\nexport default function P5(props: { id: number }) {\r\n\r\n  // ...\r\n\r\n  async function updateStudent() {\r\n    const resp = await axios.get(\r\n      `http://localhost:8080/api/students/${props.id}`\r\n    )\r\n    Object.assign(student, resp.data.data)\r\n    console.log(current, student, getTime())\r\n  }\r\n\r\n  const current = count++\r\n  let [student] = useState<Student>({ name: 'xx' })\r\n  console.log(current, student, getTime())\r\n  updateStudent()\r\n\r\n  return <h3>å§“åæ˜¯ï¼š{student.name}</h3>\r\n}\r\n```\r\n\r\næ¥ä¸‹æ¥ä½¿ç”¨ setXXX æ–¹æ³•æ›´æ–° State\r\n\r\n```tsx\r\nimport axios from 'axios'\r\nimport { useState } from 'react'\r\nimport { Student } from '../model/Student'\r\nexport default \r\n\r\nfunction P5(props: { id: number }) {\r\n  async function updateStudent() {\r\n    const resp = await axios.get(`/api/students/${props.id}`)\r\n    setStudent(resp.data.data)\r\n  }\r\n\r\n  let [student, setStudent] = useState<Student>({ name: 'xx' })\r\n  updateStudent()\r\n\r\n  return <h3>å§“åæ˜¯ï¼š{student.name}</h3>\r\n}\r\n```\r\n\r\nå·¥ä½œæµç¨‹å¦‚ä¸‹\r\n\r\né¦–æ¬¡ä½¿ç”¨ useStateï¼Œç”¨å®ƒçš„å‚æ•°åˆå§‹åŒ– State\r\n\r\n![image-20221005173958351](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221005173958351.png)\r\n\r\n2s åæ•°æ®æ›´æ–°ï¼ŒsetStudent å‡½æ•°ä¼šæ›´æ–° State æ•°æ®ï¼Œå¹¶ä¼šè§¦å‘ä¸‹ä¸€æ¬¡æ¸²æŸ“ï¼ˆP5 çš„è°ƒç”¨ï¼‰\r\n\r\n![image-20221005174347981](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221005174347981.png)\r\n\r\nå†æ¬¡è°ƒç”¨ useStateï¼Œè¿™æ—¶è¿”å›æ›´æ–°åçš„æ•°æ®\r\n\r\n![image-20221005174739593](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221005174739593.png)\r\n\r\nè¿™æ—¶å†è¿”å› jsxï¼Œå†…å®¹å°±æ˜¯ `å§“åæ˜¯ï¼šå®‹è¿œæ¡¥` äº†\r\n\r\n> **P.S.**\r\n>\r\n> ä½¿ç”¨äº† useState ä¹‹åï¼Œä¼šæ‰§è¡Œä¸¤æ¬¡ xhr è¯·æ±‚ï¼Œåä¸€æ¬¡è¯·æ±‚æ˜¯ react å¼€å‘å·¥å…·å‘é€çš„ï¼Œä¸ç”¨ç†ä¼š\r\n\r\n\r\n\r\né—®é¢˜è¿˜æœªç»“æŸï¼Œç¬¬äºŒæ¬¡ P5 è°ƒç”¨æ—¶ï¼ŒupdateStudent è¿˜ä¼šæ‰§è¡Œï¼Œç»“æœä¼šå¯¼è‡´ 2s åå“åº”è¿”å›ç»§ç»­è°ƒç”¨ setStudentï¼Œè¿™ä¼šå¯¼è‡´æ¯éš” 2s è°ƒç”¨ä¸€æ¬¡ P5 å‡½æ•°ï¼ˆæ¸²æŸ“ä¸€æ¬¡ï¼‰\r\n\r\n![image-20221005175440228](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221005175440228.png)\r\n\r\nå¦‚ä½•è®© updateStudent åªæ‰§è¡Œä¸€æ¬¡å‘¢ï¼Ÿä¸€ç§åœŸåŠæ³•æ˜¯å†è®¾ç½®ä¸€ä¸ªå¸ƒå°” State \r\n\r\n![image-20221005181042078](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221005181042078.png)\r\n\r\næ¥ä¸‹æ¥æ•°æ®æ›´æ–°\r\n\r\n![image-20221005181428984](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221005181428984.png)\r\n\r\nç¬¬äºŒæ¬¡è¿›å…¥ P5 å‡½æ•°æ—¶ï¼Œç”±äº fetch æ¡ä»¶ä¸æˆç«‹ï¼Œå› æ­¤ä¸ä¼šå†æ‰§è¡Œä¸¤ä¸ª setXXX æ–¹æ³•\r\n\r\n![image-20221005182505908](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221005182505908.png)\r\n\r\n\r\n\r\nå‡½æ•°å¼ç»„ä»¶çš„å·¥ä½œæµç¨‹\r\n\r\n* é¦–æ¬¡è°ƒç”¨å‡½æ•°ç»„ä»¶ï¼Œè¿”å›çš„ jsx ä»£ç ä¼šè¢«æ¸²æŸ“æˆã€è™šæ‹Ÿ dom èŠ‚ç‚¹ã€‘ï¼ˆä¹Ÿç§° Fiber èŠ‚ç‚¹ï¼‰\r\n  * æ­¤æ—¶ä½¿ç”¨ useState ä¼šå°†ç»„ä»¶å·¥ä½œè¿‡ç¨‹ä¸­éœ€è¦æ•°æ®ç»‘å®šåˆ°ã€è™šæ‹Ÿ dom èŠ‚ç‚¹ã€‘ä¸Š\r\n  * æ ¹æ®ã€è™šæ‹Ÿ dom èŠ‚ç‚¹ã€‘ä¼šç”Ÿæˆã€çœŸå® dom èŠ‚ç‚¹ã€‘ï¼Œç”±æµè§ˆå™¨æ˜¾ç¤ºå‡ºæ¥\r\n* å½“å‡½æ•°ç»„ä»¶çš„ props æˆ– state å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡æ–°è°ƒç”¨å‡½æ•°ç»„ä»¶ï¼Œè¿”å› jsx\r\n  * props å˜åŒ–ç”±çˆ¶ç»„ä»¶å†³å®šï¼Œstate å˜åŒ–ç”±ç»„ä»¶è‡ªèº«å†³å®š\r\n  * jsx ä¸ä¸Šæ¬¡çš„ã€è™šæ‹Ÿ dom èŠ‚ç‚¹ã€‘å¯¹æ¯”\r\n    * å¦‚æœæ²¡å˜åŒ–ï¼Œå¤ç”¨ä¸Šæ¬¡çš„èŠ‚ç‚¹\r\n    * æœ‰å˜åŒ–ï¼Œåˆ›å»ºæ–°çš„ã€è™šæ‹Ÿ dom èŠ‚ç‚¹ã€‘æ›¿æ¢æ‰ä¸Šæ¬¡çš„èŠ‚ç‚¹\r\n\r\n\r\n\r\n#### useEffect\r\n\r\nEffect ç§°ä¹‹ä¸ºå‰¯ä½œç”¨ï¼ˆæ²¡æœ‰è´¬ä¹‰ï¼‰ï¼Œå‡½æ•°ç»„ä»¶çš„ä¸»è¦ç›®çš„ï¼Œæ˜¯ä¸ºäº†æ¸²æŸ“ç”Ÿæˆ html å…ƒç´ ï¼Œé™¤äº†è¿™ä¸ªä¸»è¦åŠŸèƒ½ä»¥å¤–ï¼Œç®¡ç†çŠ¶æ€ï¼Œfetch æ•°æ® ... ç­‰ç­‰ä¹‹å¤–çš„åŠŸèƒ½ï¼Œéƒ½å¯ä»¥ç§°ä¹‹ä¸ºå‰¯ä½œç”¨ã€‚\r\n\r\nuseXXX æ‰“å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œéƒ½æ˜¯ä¸ºå‰¯ä½œç”¨è€Œç”Ÿçš„ï¼Œåœ¨ react ä¸­æŠŠå®ƒä»¬ç§°ä¸º Hooks\r\n\r\nuseEffect ä¸‰ç§ç”¨æ³•\r\n\r\n```tsx\r\nimport axios from \"axios\"\r\nimport { useEffect, useState } from \"react\"\r\n\r\n/*\r\nuseEffect\r\n  å‚æ•°1ï¼šç®­å¤´å‡½æ•°, åœ¨çœŸæ­£æ¸²æŸ“ html ä¹‹å‰ä¼šæ‰§è¡Œå®ƒ\r\n  å‚æ•°2ï¼š\r\n    æƒ…å†µ1ï¼šæ²¡æœ‰, ä»£è¡¨æ¯æ¬¡æ‰§è¡Œç»„ä»¶å‡½æ•°æ—¶, éƒ½ä¼šæ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°\r\n    æƒ…å†µ2ï¼š[], ä»£è¡¨å‰¯ä½œç”¨å‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡\r\n    æƒ…å†µ3ï¼š[ä¾èµ–é¡¹], ä¾èµ–é¡¹å˜åŒ–æ—¶ï¼Œå‰¯ä½œç”¨å‡½æ•°ä¼šæ‰§è¡Œ\r\n*/\r\nexport default function P6({ id, age }: { id: number, age: number }) {\r\n\r\n  console.log('1.ä¸»è¦åŠŸèƒ½')\r\n    \r\n  // useEffect(() => console.log('3.å‰¯ä½œç”¨åŠŸèƒ½')) \r\n  // useEffect(() => console.log('3.å‰¯ä½œç”¨åŠŸèƒ½'), []) \r\n  useEffect(() => console.log('3.å‰¯ä½œç”¨åŠŸèƒ½'), [id]) \r\n\r\n  console.log('2.ä¸»è¦åŠŸèƒ½')\r\n\r\n  return <h3>{id}</h3>\r\n}\r\n```\r\n\r\nç”¨å®ƒæ”¹å†™ P5 æ¡ˆä¾‹\r\n\r\n```tsx\r\nimport axios from \"axios\"\r\nimport { useEffect, useState } from \"react\"\r\n\r\nexport default function P6({ id, age }: { id: number, age: number }) {\r\n\r\n  const [student, setStudent] = useState({name:'xx'})\r\n\r\n  useEffect(()=>{\r\n    async function updateStudent() {\r\n      const resp = await axios.get(`http://localhost:8080/api/students/${id}`)    \r\n      setStudent(resp.data.data)\r\n    }\r\n    updateStudent()\r\n  }, [id])\r\n\r\n  return <h3>{student.name}</h3>\r\n}\r\n```\r\n\r\n\r\n\r\n#### useContext\r\n\r\n```tsx\r\nimport axios from 'axios'\r\nimport { createContext, useContext, useEffect, useState } from 'react'\r\nimport { R, Student } from '../model/Student'\r\n\r\n/*\r\n  createContext         åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡\r\n  useContext            è¯»å–ä¸Šä¸‹æ–‡å¯¹è±¡çš„å€¼\r\n  <ä¸Šä¸‹æ–‡å¯¹è±¡.Provider>  ä¿®æ”¹ä¸Šä¸‹æ–‡å¯¹è±¡çš„å€¼\r\n*/\r\nconst HiddenContext = createContext(false)\r\n\r\n// ç»™ä»¥ä¸‹ç»„ä»¶æä¾›æ•°æ®ï¼Œæ§åˆ¶å¹´é¾„éšè—ã€æ˜¾ç¤º\r\nexport default function P7() {\r\n  const [students, setStudents] = useState<Student[]>([])\r\n  const [hidden, setHidden] = useState(false)\r\n  useEffect(()=>{\r\n    async function updateStudents() {\r\n      const resp = await axios.get<R<Student[]>>(\"http://localhost:8080/api/students\")\r\n      setStudents(resp.data.data)\r\n    }\r\n    updateStudents()\r\n  }, [])\r\n\r\n  function hideOrShow() {\r\n    // å‚æ•°ï¼šä¸Šä¸€æ¬¡çŠ¶æ€å€¼ï¼Œæ—§å€¼\r\n    // è¿”å›å€¼ï¼šè¦æ›´æ–°çš„æ–°å€¼\r\n    setHidden((old)=>{\r\n      return !old\r\n    })\r\n  }\r\n  return <HiddenContext.Provider value={hidden}>\r\n    <input type=\"button\" value={hidden?'æ˜¾ç¤º':'éšè—'} onClick={hideOrShow}/>\r\n    <P71 students={students}></P71>\r\n  </HiddenContext.Provider>  \r\n}\r\n\r\n// è´Ÿè´£å¤„ç†å­¦ç”Ÿé›†åˆ\r\nfunction P71({ students }: { students: Student[] }) {\r\n  const list = students.map(s=><P72 student={s} key={s.id}></P72>)\r\n  return <>{list}</>\r\n}\r\n\r\n// è´Ÿè´£æ˜¾ç¤ºå•ä¸ªå­¦ç”Ÿ\r\nfunction P72({ student }: { student: Student }) {\r\n  const hidden = useContext(HiddenContext)\r\n  const jsx = !hidden && <span>{student.age}</span>\r\n  return <div>{student.name} {jsx}</div>\r\n}\r\n```\r\n\r\n* å¦‚æœç»„ä»¶åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ä¸­ï¼ŒHiddenContext åº”è¯¥ export å¯¼å‡ºï¼Œç”¨åˆ°å®ƒçš„ç»„ä»¶ import å¯¼å…¥\r\n* React ä¸­å› ä¿®æ”¹è§¦å‘çš„ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œéƒ½åº”å½“æ˜¯è‡ªä¸Šè€Œä¸‹çš„\r\n* setHidden æ–¹æ³•å¦‚æœæ›´æ–°çš„æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆè¦è¿”å›ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè€Œä¸æ˜¯åœ¨æ—§å¯¹è±¡ä¸Šåšä¿®æ”¹\r\n\r\n\r\n\r\n#### è¡¨å•\r\n\r\n```tsx\r\nimport axios from 'axios'\r\nimport React, { useState } from 'react'\r\nimport '../css/P8.css'\r\n\r\nexport default function P8() {\r\n\r\n  const [student, setStudent] = useState({name:'', sex:'ç”·', age:18})\r\n  const [message, setMessage] = useState('')\r\n\r\n  const options = ['ç”·', 'å¥³']\r\n  const jsx = options.map(e => <option key={e}>{e}</option>)\r\n\r\n  // e äº‹ä»¶å¯¹è±¡, e.target äº‹ä»¶æº\r\n  function onChange(e : React.ChangeEvent<HTMLInputElement|HTMLSelectElement>) {\r\n    setStudent((old)=>{\r\n      // è¿”å›çš„æ–°å€¼ï¼Œä¸èƒ½ä¸æ—§å€¼æ˜¯åŒä¸€ä¸ªå¯¹è±¡\r\n      return {...old, [e.target.name]:e.target.value}\r\n    })\r\n  }\r\n\r\n  async function onClick() {\r\n    const resp = await axios.post('http://localhost:8080/api/students', student)\r\n    setMessage(resp.data.data)\r\n  }\r\n  \r\n  const messageJsx = message && <div className='success'>{message}</div>\r\n\r\n  return (\r\n    <form>\r\n      <div>\r\n        <label>å§“å</label>\r\n        <input type=\"text\" value={student.name} onChange={onChange} name='name'/>\r\n      </div>\r\n      <div>\r\n        <label>æ€§åˆ«</label>\r\n        <select value={student.sex} onChange={onChange} name='sex'>\r\n          {jsx}\r\n        </select>\r\n      </div>\r\n      <div>\r\n        <label>å¹´é¾„</label>\r\n        <input type=\"text\" value={student.age} onChange={onChange} name='age' />\r\n      </div>\r\n      <div>\r\n        <input type='button' value='æ–°å¢' onClick={onClick}/>\r\n      </div>\r\n      {messageJsx}\r\n    </form>\r\n  )\r\n}\r\n```\r\n\r\n\r\n\r\n## 2. React è¿›é˜¶\r\n\r\n### 1) Ant Design\r\n\r\nreact ç»„ä»¶åº“\r\n\r\n* å®˜ç½‘åœ°å€ï¼šhttps://ant.design/\r\n\r\n* é•œåƒåœ°å€1ï¼šhttps://ant-design.gitee.io/\r\n\r\n* é•œåƒåœ°å€2ï¼šhttps://ant-design.antgroup.com/\r\n\r\n#### å…¥é—¨\r\n\r\nå®‰è£…\r\n\r\n```cmd\r\nnpm install antd\r\n```\r\n\r\n* ç›®å‰ç‰ˆæœ¬æ˜¯ 4.x\r\n\r\nå¼•å…¥æ ·å¼ï¼Œåœ¨ css æ–‡ä»¶ä¸­åŠ å…¥\r\n\r\n```tsx\r\n@import '~antd/dist/antd.css';\r\n```\r\n\r\nå¼•å…¥ antd ç»„ä»¶\r\n\r\n```tsx\r\nimport { Button } from \"antd\";\r\n\r\nexport default function A1() {\r\n  return <Button type='primary'>æŒ‰é’®</Button>\r\n}\r\n```\r\n\r\n\r\n\r\n#### å›½é™…åŒ–\r\n\r\nè¯•è¯•å…¶å®ƒç»„ä»¶\r\n\r\n```tsx\r\nimport { Button, Modal } from \"antd\";\r\n\r\nexport default function A1() {\r\n  return <Modal open={true} title='å¯¹è¯æ¡†'>å†…å®¹</Modal>\r\n}\r\n```\r\n\r\nå‘ç°ç¡®å®šå’Œå–æ¶ˆæŒ‰é’®æ˜¯è‹±æ–‡çš„ï¼Œè¿™æ˜¯å› ä¸º antd æ”¯æŒå¤šç§è¯­è¨€ï¼Œè€Œé»˜è®¤è¯­è¨€æ˜¯è‹±æ–‡\r\n\r\n\r\n\r\nè¦æƒ³æ”¹ä¸ºä¸­æ–‡ï¼Œå»ºè®®ä¿®æ”¹æœ€å¤–å±‚çš„ç»„ä»¶ index.tsx\r\n\r\n```tsx\r\n// ...\r\nimport { ConfigProvider } from 'antd'\r\nimport zhCN from 'antd/es/locale/zh_CN'\r\n\r\nroot.render(\r\n  <ConfigProvider locale={zhCN}>\r\n    <A1></A1>\r\n  </ConfigProvider>\r\n)\r\n```\r\n\r\n\r\n\r\n#### è¡¨æ ¼\r\n\r\n```tsx\r\nimport { Table } from 'antd'\r\nimport { ColumnsType } from 'antd/lib/table'\r\nimport axios from 'axios'\r\nimport { useEffect, useState } from 'react'\r\nimport { R, Student } from '../model/Student'\r\n\r\nexport default function A3() {\r\n  const [students, setStudents] = useState<Student[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n\r\n  useEffect(() => {\r\n    async function getStudents() {\r\n      const resp = await axios.get<R<Student[]>>(\r\n        'http://localhost:8080/api/students'\r\n      )\r\n      setStudents(resp.data.data)\r\n      setLoading(false)\r\n    }\r\n\r\n    getStudents()\r\n  }, [])\r\n\r\n  // title: åˆ—æ ‡é¢˜  dataIndex: è¦å…³è”çš„å±æ€§å\r\n  const columns: ColumnsType<Student> = [\r\n    {\r\n      title: 'ç¼–å·',\r\n      dataIndex: 'id',\r\n    },\r\n    {\r\n      title: 'å§“å',\r\n      dataIndex: 'name',\r\n    },\r\n    {\r\n      title: 'æ€§åˆ«',\r\n      dataIndex: 'sex',\r\n    },\r\n    {\r\n      title: 'å¹´é¾„',\r\n      dataIndex: 'age',\r\n    },\r\n  ]\r\n\r\n  // columns: åˆ—å®šä¹‰\r\n  // dataSource: æ•°æ®æºï¼Œä¸€èˆ¬æ˜¯æ•°ç»„åŒ…å¯¹è±¡\r\n  // rowKey: ä½œä¸ºå”¯ä¸€æ ‡è¯†çš„å±æ€§å\r\n  // loading: æ˜¾ç¤ºåŠ è½½å›¾ç‰‡\r\n  return (\r\n    <Table\r\n      columns={columns}\r\n      dataSource={students}\r\n      rowKey='id'\r\n      loading={loading}></Table>\r\n  )\r\n}\r\n```\r\n\r\n\r\n\r\n#### å®¢æˆ·ç«¯åˆ†é¡µ\r\n\r\n```tsx\r\nimport { Table } from 'antd'\r\nimport { ColumnsType, TablePaginationConfig } from 'antd/lib/table'\r\nimport axios from 'axios'\r\nimport { useEffect, useState } from 'react'\r\nimport { R, Student } from '../model/Student'\r\n\r\nexport default function A3() {\r\n  const [students, setStudents] = useState<Student[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [pagination, setPagination] = useState<TablePaginationConfig>(\r\n    {current:1, pageSize:5}\r\n  )\r\n\r\n  // å‚æ•°: æ–°çš„åˆ†é¡µæ•°æ®\r\n  function onTableChange(newPagination: TablePaginationConfig) {\r\n    setPagination(newPagination)\r\n  }\r\n\r\n  useEffect(() => {\r\n    async function getStudents() {\r\n      const resp = await axios.get<R<Student[]>>(\r\n        'http://localhost:8080/api/students'\r\n      )\r\n      setStudents(resp.data.data)\r\n      setLoading(false)\r\n    }\r\n\r\n    getStudents()\r\n  }, [])\r\n\r\n  // ... çœç•¥\r\n\r\n  // pagination: åˆ†é¡µæ•°æ®\r\n  // onChange: å½“é¡µå·ï¼Œé¡µå¤§å°æ”¹å˜æ—¶è§¦å‘\r\n  return (\r\n    <Table\r\n      columns={columns}\r\n      dataSource={students}\r\n      rowKey='id'\r\n      loading={loading}\r\n      pagination={pagination}\r\n      onChange={onTableChange}></Table>\r\n  )\r\n}\r\n```\r\n\r\n* æœ¬ä¾‹è¿˜æ˜¯æŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼Œåˆ†é¡µæ˜¯å®¢æˆ·ç«¯ Table ç»„ä»¶è‡ªå·±å®ç°çš„\r\n\r\n\r\n\r\n#### æœåŠ¡ç«¯åˆ†é¡µ\r\n\r\n```tsx\r\nimport { Table } from 'antd'\r\nimport { ColumnsType, TablePaginationConfig } from 'antd/lib/table'\r\nimport axios from 'axios'\r\nimport { useEffect, useState } from 'react'\r\nimport { PageResp, R, Student } from '../model/Student'\r\n\r\nexport default function A4() {\r\n  const [students, setStudents] = useState<Student[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [pagination, setPagination] = useState<TablePaginationConfig>({\r\n    current: 1,\r\n    pageSize: 5,\r\n  })\r\n\r\n  function onTableChange(newPagination: TablePaginationConfig) {\r\n    setPagination(newPagination)\r\n  }\r\n\r\n  useEffect(() => {\r\n    async function getStudents() {\r\n      // params ç”¨æ¥ç»™è¯·æ±‚æ·»åŠ  url åçš„ ? å‚æ•°\r\n      const resp = await axios.get<R<PageResp<Student>>>(\r\n        'http://localhost:8080/api/students/q',\r\n        {\r\n          params: {\r\n            page: pagination.current,\r\n            size: pagination.pageSize,\r\n          },\r\n        }\r\n      )\r\n      // è¿”å›ç»“æœä¸­ï¼šlist ä»£è¡¨å½“å‰é¡µé›†åˆ, total ä»£è¡¨æ€»è®°å½•æ•°\r\n      setStudents(resp.data.data.list)\r\n      setPagination((old) => {\r\n        return { ...old, total: resp.data.data.total }\r\n      })\r\n      setLoading(false)\r\n    }\r\n\r\n    getStudents()\r\n  }, [pagination.current, pagination.pageSize])\r\n  // useEffect éœ€è¦åœ¨ä¾èµ–é¡¹( current å’Œ pageSize ) æ”¹å˜æ—¶é‡æ–°æ‰§è¡Œ\r\n\r\n  const columns: ColumnsType<Student> = [\r\n    {\r\n      title: 'ç¼–å·',\r\n      dataIndex: 'id',\r\n    },\r\n    {\r\n      title: 'å§“å',\r\n      dataIndex: 'name',\r\n    },\r\n    {\r\n      title: 'æ€§åˆ«',\r\n      dataIndex: 'sex',\r\n    },\r\n    {\r\n      title: 'å¹´é¾„',\r\n      dataIndex: 'age',\r\n    },\r\n  ]\r\n\r\n  return (\r\n    <Table\r\n      columns={columns}\r\n      dataSource={students}\r\n      rowKey='id'\r\n      loading={loading}\r\n      pagination={pagination}\r\n      onChange={onTableChange}></Table>\r\n  )\r\n}\r\n```\r\n\r\n* æœ¬ä¾‹éœ€è¦æœåŠ¡ç«¯é…åˆæ¥å®ç°åˆ†é¡µï¼Œå‚è§ä»£ç ä¸­æ–°åŠ çš„æ³¨é‡Š\r\n\r\nå…¶ä¸­ PageResp ç±»å‹å®šä¹‰ä¸º\r\n\r\n```tsx\r\nexport interface PageResp<T> {\r\n  list: T[],\r\n  total: number\r\n}\r\n```\r\n\r\n\r\n\r\n#### æ¡ä»¶æŸ¥è¯¢\r\n\r\n```tsx\r\nimport { Input, Select, Table } from 'antd'\r\nimport { ColumnsType, TablePaginationConfig } from 'antd/lib/table'\r\nimport axios from 'axios'\r\nimport React, { useEffect, useState } from 'react'\r\nimport { PageResp, R, Student, StudentQueryForm } from '../model/Student'\r\n\r\nconst { Option } = Select\r\n\r\nexport default function A5() {\r\n  const [students, setStudents] = useState<Student[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [pagination, setPagination] = useState<TablePaginationConfig>({\r\n    current: 1,\r\n    pageSize: 5,\r\n  })\r\n  // ä»£è¡¨æŸ¥è¯¢æ¡ä»¶çš„çŠ¶æ€æ•°æ®\r\n  const [form, setForm] = useState<StudentQueryForm>({})\r\n\r\n  function onTableChange(newPagination: TablePaginationConfig) {\r\n    setPagination(newPagination)\r\n  }\r\n\r\n  useEffect(() => {\r\n    async function getStudents() {\r\n      const resp = await axios.get<R<PageResp<Student>>>(\r\n        'http://localhost:8080/api/students/q',\r\n        {\r\n          params: {\r\n            page: pagination.current,\r\n            size: pagination.pageSize,\r\n            ...form // è¡¥å……æŸ¥è¯¢å‚æ•°\r\n          },\r\n        }\r\n      )\r\n      setStudents(resp.data.data.list)\r\n      setPagination((old) => {\r\n        return { ...old, total: resp.data.data.total }\r\n      })\r\n      setLoading(false)\r\n    }\r\n\r\n    getStudents()\r\n  }, [pagination.current, pagination.pageSize, form.name, form.sex, form.age])\r\n  // ä¾èµ–é¡¹é™¤äº†åˆ†é¡µæ¡ä»¶å¤–ï¼Œæ–°åŠ äº†æŸ¥è¯¢æ¡ä»¶ä¾èµ–\r\n    \r\n  const columns: ColumnsType<Student> = [\r\n    {\r\n      title: 'ç¼–å·',\r\n      dataIndex: 'id',\r\n    },\r\n    {\r\n      title: 'å§“å',\r\n      dataIndex: 'name',\r\n    },\r\n    {\r\n      title: 'æ€§åˆ«',\r\n      dataIndex: 'sex',\r\n    },\r\n    {\r\n      title: 'å¹´é¾„',\r\n      dataIndex: 'age',\r\n    },\r\n  ]\r\n\r\n  // name æ¡ä»¶æ”¹å˜æ—¶å¤„ç†å‡½æ•°\r\n  function onNameChange(e: React.ChangeEvent<HTMLInputElement>) {\r\n    setForm((old)=>{\r\n      return {...old, name: e.target.value}\r\n    })\r\n  }\r\n\r\n  // sex æ¡ä»¶æ”¹å˜æ—¶å¤„ç†å‡½æ•°\r\n  function onSexChange(value: string) {\r\n    setForm((old)=>{\r\n      return {...old, sex: value}\r\n    })\r\n  }\r\n\r\n  // age æ¡ä»¶æ”¹å˜æ—¶å¤„ç†å‡½æ•°\r\n  function onAgeChange(value: string) {\r\n    setForm((old)=>{\r\n      return {...old, age: value}\r\n    })\r\n  }\r\n\r\n  return (\r\n    <div>\r\n      <div>\r\n        <Input\r\n          style={{ width: 120 }}\r\n          placeholder='è¯·è¾“å…¥å§“å'\r\n          value={form.name}\r\n          onChange={onNameChange}></Input>\r\n        <Select\r\n          style={{ width: 120 }}\r\n          placeholder='è¯·é€‰æ‹©æ€§åˆ«'\r\n          allowClear={true}\r\n          value={form.sex}\r\n          onChange={onSexChange}>\r\n          <Option value='ç”·'>ç”·</Option>\r\n          <Option value='å¥³'>å¥³</Option>\r\n        </Select>\r\n        <Select\r\n          style={{ width: 120 }}\r\n          placeholder='è¯·é€‰æ‹©å¹´é¾„'\r\n          allowClear={true}\r\n          value={form.age}\r\n          onChange={onAgeChange}>\r\n          <Option value='1,19'>20ä»¥ä¸‹</Option>\r\n          <Option value='20,29'>20å·¦å³</Option>\r\n          <Option value='30,39'>30å·¦å³</Option>\r\n          <Option value='40,120'>40ä»¥ä¸Š</Option>\r\n        </Select>\r\n      </div>\r\n      <Table\r\n        columns={columns}\r\n        dataSource={students}\r\n        rowKey='id'\r\n        loading={loading}\r\n        pagination={pagination}\r\n        onChange={onTableChange}></Table>\r\n    </div>\r\n  )\r\n}\r\n```\r\n\r\n* å»ºè®® axios å‘è¯·æ±‚æ˜¯ç”¨ params è€Œä¸è¦è‡ªå·±æ‹¼å­—ç¬¦ä¸²ï¼Œå› ä¸ºè‡ªå·±æ‹¼ä¸²éœ€è¦å»æ‰å€¼ä¸º undefined çš„å±æ€§\r\n\r\nå…¶ä¸­ StudentQueryForm ä¸º\r\n\r\n```tsx\r\nexport interface StudentQueryForm {\r\n  name?: string,\r\n  sex?: string,\r\n  age?: string,\r\n  [key: string]: any\r\n}\r\n```\r\n\r\n\r\n\r\n#### åˆ é™¤\r\n\r\n```tsx\r\nimport { Button, message, Popconfirm } from 'antd'\r\nimport axios from 'axios'\r\nimport { R } from '../model/Student'\r\n\r\nexport default function A6Delete({ id, onSuccess }: { id: number, onSuccess:()=>void }) {\r\n  async function onConfirm() {\r\n    const resp = await axios.delete<R<string>>(\r\n      `http://localhost:8080/api/students/${id}`\r\n    )\r\n    message.success(resp.data.data)\r\n    // æ”¹å˜ form ä¾èµ–é¡¹\r\n    onSuccess()\r\n  }\r\n  return (\r\n    <Popconfirm title='ç¡®å®šè¦åˆ é™¤å­¦ç”Ÿå—?' onConfirm={onConfirm}>\r\n      <Button danger size='small'>\r\n        åˆ é™¤\r\n      </Button>\r\n    </Popconfirm>\r\n  )\r\n}\r\n```\r\n\r\nä½¿ç”¨åˆ é™¤ç»„ä»¶\r\n\r\n```tsx\r\nimport { Button, Input, Select, Space, Table } from 'antd'\r\nimport { ColumnsType, TablePaginationConfig } from 'antd/lib/table'\r\nimport axios from 'axios'\r\nimport React, { useEffect, useState } from 'react'\r\nimport { PageResp, R, Student, StudentQueryForm } from '../model/Student'\r\nimport A6Delete from './A6Delete'\r\n\r\nconst { Option } = Select\r\n\r\nexport default function A6() {\r\n  // ... çœç•¥\r\n\r\n  function onDeleteSuccess() {\r\n    setForm((old)=>{\r\n      return {...old}\r\n    })\r\n  }\r\n    \r\n  const columns: ColumnsType<Student> = [\r\n    // ... çœç•¥\r\n    {\r\n      title: 'æ“ä½œ',\r\n      dataIndex: 'operation',\r\n      // value: å±æ€§å€¼, student\r\n      render: (_, student)=>{\r\n        return <>\r\n          <Space>\r\n            <A6Delete id={student.id} onSuccess={onDeleteSuccess}></A6Delete>\r\n            <Button type='default' size='small'>ä¿®æ”¹</Button>\r\n          </Space>\r\n        </>\r\n      }\r\n    }\r\n  ]\r\n\r\n  // ... çœç•¥\r\n}\r\n```\r\n\r\n\r\n\r\n#### ä¿®æ”¹\r\n\r\n```tsx\r\nimport { Form, Input, InputNumber, message, Modal, Radio } from 'antd'\r\nimport { Rule } from 'antd/lib/form'\r\nimport axios from 'axios'\r\nimport { useEffect } from 'react'\r\nimport { R, Student } from '../model/Student'\r\n\r\nexport default function A6Update({\r\n  open,\r\n  student,\r\n  onSuccess,\r\n  onCancel,\r\n}: {\r\n  open: boolean\r\n  student: Student\r\n  onSuccess?: () => void\r\n  onCancel?: () => void\r\n}) {\r\n  const { Item } = Form\r\n  const { Group } = Radio\r\n  const options = [\r\n    { label: 'ç”·', value: 'ç”·' },\r\n    { label: 'å¥³', value: 'å¥³' },\r\n  ]\r\n\r\n  const [form] = Form.useForm() // ä»£è¡¨äº†è¡¨å•å¯¹è±¡\r\n\r\n  const nameRules: Rule[] = [\r\n    { required: true, message: 'å§“åå¿…é¡»' },\r\n    { min: 2, type: 'string', message: 'è‡³å°‘ä¸¤ä¸ªå­—ç¬¦' },\r\n  ]\r\n\r\n  const ageRules: Rule[] = [\r\n    { required: true, message: 'å¹´é¾„å¿…é¡»' },\r\n    { min: 1, type: 'number', message: 'æœ€å°1å²' },\r\n    { max: 120, type: 'number', message: 'æœ€å¤§120å²' },\r\n  ]\r\n\r\n  async function onOk() {\r\n    // éªŒè¯å¹¶è·å–è¡¨å•æ•°æ®\r\n    try {\r\n      const values = await form.validateFields()\r\n      console.log(values)\r\n      const resp = await axios.put<R<string>>(\r\n        `http://localhost:8080/api/students/${values.id}`,\r\n        values\r\n      )\r\n      message.success(resp.data.data)\r\n      onSuccess && onSuccess()\r\n    } catch (e) {\r\n      console.error(e)\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    // ä¿®æ”¹è¡¨å•æ•°æ®\r\n    form.setFieldsValue(student) // id, name, sex, age\r\n  }, [student])\r\n\r\n  return (\r\n    <Modal\r\n      open={open}\r\n      title='ä¿®æ”¹å­¦ç”Ÿ'\r\n      onOk={onOk}\r\n      onCancel={onCancel}\r\n      forceRender={true}>\r\n      <Form form={form}>\r\n        <Item label='ç¼–å·' name='id'>\r\n          <Input readOnly></Input>\r\n        </Item>\r\n        <Item label='å§“å' name='name' rules={nameRules}>\r\n          <Input></Input>\r\n        </Item>\r\n        <Item label='æ€§åˆ«' name='sex'>\r\n          <Group\r\n            options={options}\r\n            optionType='button'\r\n            buttonStyle='solid'></Group>\r\n        </Item>\r\n        <Item label='å¹´é¾„' name='age' rules={ageRules}>\r\n          <InputNumber></InputNumber>\r\n        </Item>\r\n      </Form>\r\n    </Modal>\r\n  )\r\n}\r\n```\r\n\r\n* forceRender æ˜¯é¿å…å› ä¸ºä½¿ç”¨ useForm åï¼Œè¡¨å•å¥—åœ¨ Modal ä¸­ä¼šå‡ºç°çš„è­¦å‘Šé”™è¯¯\r\n\r\nä½¿ç”¨ç»„ä»¶\r\n\r\n```tsx\r\nimport { Button, Input, Select, Space, Table } from 'antd'\r\nimport { ColumnsType, TablePaginationConfig } from 'antd/lib/table'\r\nimport axios from 'axios'\r\nimport React, { useEffect, useState } from 'react'\r\nimport { PageResp, R, Student, StudentQueryForm } from '../model/Student'\r\nimport A6Delete from './A6Delete'\r\nimport A6Update from './A6Update'\r\n\r\nconst { Option } = Select\r\n\r\nexport default function A6() {\r\n  // ... çœç•¥\r\n  const columns: ColumnsType<Student> = [\r\n    // ... çœç•¥\r\n    {\r\n      title: 'æ“ä½œ',\r\n      dataIndex: 'operation',\r\n      // value: å±æ€§å€¼, student\r\n      render: (_, student) => {\r\n        return (\r\n          <>\r\n            <Space>\r\n              <A6Delete id={student.id} onSuccess={onDeleteSuccess}></A6Delete>\r\n              <Button\r\n                type='default'\r\n                size='small'\r\n                onClick={() => {\r\n                  onUpdateClick(student)\r\n                }}>\r\n                ä¿®æ”¹\r\n              </Button>\r\n            </Space>\r\n          </>\r\n        )\r\n      },\r\n    },\r\n  ]\r\n\r\n  // -------------- ä¿®æ”¹åŠŸèƒ½å¼€å§‹ -------------\r\n  function onUpdateClick(student: Student) {\r\n    setUpdateOpen(true)\r\n    setUpdateForm(student)\r\n  }\r\n\r\n  function onUpdateCancel() {\r\n    setUpdateOpen(false)\r\n  }\r\n\r\n  function onUpdateSuccess() {\r\n    setUpdateOpen(false)\r\n    setForm((old) => {\r\n      return { ...old }\r\n    })\r\n  }\r\n\r\n  const [updateOpen, setUpdateOpen] = useState(false)\r\n  const [updateForm, setUpdateForm] = useState<Student>({\r\n    id: 0,\r\n    name: '',\r\n    sex: 'ç”·',\r\n    age: 18,\r\n  })\r\n  // -------------- ä¿®æ”¹åŠŸèƒ½ç»“æŸ -------------\r\n\r\n  return (\r\n    <div>\r\n      <A6Update\r\n        open={updateOpen}\r\n        student={updateForm}\r\n        onSuccess={onUpdateSuccess}\r\n        onCancel={onUpdateCancel}></A6Update>\r\n      <!-- ... çœç•¥ -->\r\n    </div>\r\n  )\r\n}\r\n```\r\n\r\n\r\n\r\n#### æ–°å¢\r\n\r\n```tsx\r\nimport { Form, Input, InputNumber, message, Modal, Radio } from 'antd'\r\nimport { Rule } from 'antd/lib/form'\r\nimport axios from 'axios'\r\nimport { useEffect } from 'react'\r\nimport { R, Student } from '../model/Student'\r\n\r\nexport default function A6Insert({\r\n  open,\r\n  student,\r\n  onSuccess,\r\n  onCancel,\r\n}: {\r\n  open: boolean\r\n  student: Student\r\n  onSuccess?: () => void\r\n  onCancel?: () => void\r\n}) {\r\n  const { Item } = Form\r\n  const { Group } = Radio\r\n  const options = [\r\n    { label: 'ç”·', value: 'ç”·' },\r\n    { label: 'å¥³', value: 'å¥³' },\r\n  ]\r\n\r\n  const [form] = Form.useForm() // ä»£è¡¨äº†è¡¨å•å¯¹è±¡\r\n\r\n  const nameRules: Rule[] = [\r\n    { required: true, message: 'å§“åå¿…é¡»' },\r\n    { min: 2, type: 'string', message: 'è‡³å°‘ä¸¤ä¸ªå­—ç¬¦' },\r\n  ]\r\n\r\n  const ageRules: Rule[] = [\r\n    { required: true, message: 'å¹´é¾„å¿…é¡»' },\r\n    { min: 1, type: 'number', message: 'æœ€å°1å²' },\r\n    { max: 120, type: 'number', message: 'æœ€å¤§120å²' },\r\n  ]\r\n\r\n  async function onOk() {\r\n    // éªŒè¯å¹¶è·å–è¡¨å•æ•°æ®\r\n    try {\r\n      const values = await form.validateFields()\r\n      console.log(values)\r\n      const resp = await axios.post<R<string>>(\r\n        `http://localhost:8080/api/students`,\r\n        values\r\n      )\r\n      message.success(resp.data.data)\r\n      onSuccess && onSuccess()\r\n      form.resetFields() // é‡ç½®è¡¨å•\r\n    } catch (e) {\r\n      console.error(e)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Modal\r\n      open={open}\r\n      title='æ–°å¢å­¦ç”Ÿ'\r\n      onOk={onOk}\r\n      onCancel={onCancel}\r\n      forceRender={true}>\r\n      <Form form={form} initialValues={student}>\r\n        <Item label='å§“å' name='name' rules={nameRules}>\r\n          <Input></Input>\r\n        </Item>\r\n        <Item label='æ€§åˆ«' name='sex'>\r\n          <Group\r\n            options={options}\r\n            optionType='button'\r\n            buttonStyle='solid'></Group>\r\n        </Item>\r\n        <Item label='å¹´é¾„' name='age' rules={ageRules}>\r\n          <InputNumber></InputNumber>\r\n        </Item>\r\n      </Form>\r\n    </Modal>\r\n  )\r\n}\r\n\r\n```\r\n\r\n* initialValues åªä¼šè§¦å‘ä¸€æ¬¡è¡¨å•èµ‹åˆå€¼\r\n* form.resetFields() ä¼šå°†è¡¨å•é‡ç½®ä¸º initialValues æ—¶çš„çŠ¶æ€\r\n\r\nä½¿ç”¨ç»„ä»¶\r\n\r\n```tsx\r\nimport { Button, Input, Select, Space, Table } from 'antd'\r\nimport { ColumnsType, TablePaginationConfig } from 'antd/lib/table'\r\nimport axios from 'axios'\r\nimport React, { useEffect, useState } from 'react'\r\nimport { PageResp, R, Student, StudentQueryForm } from '../model/Student'\r\nimport A6Delete from './A6Delete'\r\nimport A6Insert from './A6Insert'\r\nimport A6SelectedDelete from './A6SelectedDelete'\r\nimport A6Update from './A6Update'\r\n\r\nconst { Option } = Select\r\n\r\nexport default function A6() {\r\n  // ... çœç•¥\r\n\r\n  // -------------- æ–°å¢åŠŸèƒ½å¼€å§‹ -------------\r\n  function onInsertClick() {\r\n    setInsertOpen(true)\r\n  }\r\n\r\n  function onInsertCancel() {\r\n    setInsertOpen(false)\r\n  }\r\n\r\n  function onInsertSuccess() {\r\n    setInsertOpen(false)\r\n    setForm((old) => {\r\n      return { ...old }\r\n    })\r\n  }\r\n\r\n  const [insertOpen, setInsertOpen] = useState(false)\r\n  const [insertForm, setInsertForm] = useState<Student>({\r\n    id: 0,\r\n    name: '',\r\n    sex: 'ç”·',\r\n    age: 18,\r\n  })\r\n  // -------------- æ–°å¢åŠŸèƒ½ç»“æŸ -------------\r\n\r\n  \r\n  return (\r\n    <div>\r\n      <A6Insert\r\n        open={insertOpen}\r\n        student={insertForm}\r\n        onSuccess={onInsertSuccess}\r\n        onCancel={onInsertCancel}></A6Insert>\r\n      <A6Update\r\n        open={updateOpen}\r\n        student={updateForm}\r\n        onSuccess={onUpdateSuccess}\r\n        onCancel={onUpdateCancel}></A6Update>\r\n      <div>\r\n        <Space>\r\n          <Input\r\n            style={{ width: 120 }}\r\n            placeholder='è¯·è¾“å…¥å§“å'\r\n            value={form.name}\r\n            onChange={onNameChange}></Input>\r\n          <Select\r\n            style={{ width: 120 }}\r\n            placeholder='è¯·é€‰æ‹©æ€§åˆ«'\r\n            allowClear={true}\r\n            value={form.sex}\r\n            onChange={onSexChange}>\r\n            <Option value='ç”·'>ç”·</Option>\r\n            <Option value='å¥³'>å¥³</Option>\r\n          </Select>\r\n          <Select\r\n            style={{ width: 120 }}\r\n            placeholder='è¯·é€‰æ‹©å¹´é¾„'\r\n            allowClear={true}\r\n            value={form.age}\r\n            onChange={onAgeChange}>\r\n            <Option value='1,19'>20ä»¥ä¸‹</Option>\r\n            <Option value='20,29'>20å·¦å³</Option>\r\n            <Option value='30,39'>30å·¦å³</Option>\r\n            <Option value='40,120'>40ä»¥ä¸Š</Option>\r\n          </Select>\r\n\r\n          <Button type='primary' onClick={onInsertClick}>æ–°å¢</Button>\r\n        </Space>\r\n      </div>\r\n      <Table\r\n        columns={columns}\r\n        dataSource={students}\r\n        rowKey='id'\r\n        loading={loading}\r\n        pagination={pagination}\r\n        onChange={onTableChange}></Table>\r\n    </div>\r\n  )\r\n}\r\n\r\n```\r\n\r\n\r\n\r\n#### åˆ é™¤é€‰ä¸­\r\n\r\n```tsx\r\nimport { Button, message, Popconfirm } from \"antd\";\r\nimport axios from \"axios\";\r\nimport React from \"react\";\r\nimport { R } from \"../model/Student\";\r\n\r\nexport default function A6DeleteSelected(\r\n  {ids, onSuccess}: {ids:React.Key[], onSuccess?:()=>void} // Key[] æ˜¯ number æˆ– string çš„æ•°ç»„\r\n){\r\n  const disabled = ids.length === 0\r\n  async function onConfirm() {\r\n    const resp = await axios.delete<R<string>>('http://localhost:8080/api/students', {\r\n      data: ids\r\n    })\r\n    message.success(resp.data.data)\r\n    onSuccess && onSuccess()\r\n  }\r\n  return (\r\n    <Popconfirm title='çœŸçš„è¦åˆ é™¤é€‰ä¸­çš„å­¦ç”Ÿå—?' onConfirm={onConfirm} disabled={disabled}>\r\n      <Button danger type='primary' disabled={disabled}>\r\n        åˆ é™¤é€‰ä¸­\r\n      </Button>\r\n    </Popconfirm>\r\n  )\r\n}\r\n```\r\n\r\nä¸ A6 ç»“åˆ\r\n\r\n```tsx\r\nimport { Button, Input, Select, Space, Table } from 'antd'\r\nimport { ColumnsType, TablePaginationConfig } from 'antd/lib/table'\r\nimport axios from 'axios'\r\nimport React, { useEffect, useState } from 'react'\r\nimport { PageResp, R, Student, StudentQueryForm } from '../model/Student'\r\nimport A6Delete from './A6Delete'\r\nimport A6Insert from './A6Insert'\r\nimport A6SelectedDelete from './A6SelectedDelete'\r\nimport A6Update from './A6Update'\r\n\r\nconst { Option } = Select\r\n\r\nexport default function A6() {\r\n  // ... çœç•¥\r\n\r\n  // -------------- åˆ é™¤é€‰ä¸­åŠŸèƒ½å¼€å§‹ -------------\r\n  const [ids, setIds] = useState<React.Key[]>([])\r\n  function onIdsChange(ids:React.Key[]) {\r\n    // console.log(ids)\r\n    setIds(ids)\r\n  }\r\n  function onDeleteSelectedSuccess() {\r\n    setForm((old)=>{\r\n      return {...old}\r\n    })\r\n    setIds([])\r\n  }\r\n  // -------------- åˆ é™¤é€‰ä¸­åŠŸèƒ½ç»“æŸ -------------\r\n  return (\r\n    <div>\r\n      <A6Insert\r\n        open={insertOpen}\r\n        student={insertForm}\r\n        onSuccess={onInsertSuccess}\r\n        onCancel={onInsertCancel}></A6Insert>\r\n      <A6Update\r\n        open={updateOpen}\r\n        student={updateForm}\r\n        onSuccess={onUpdateSuccess}\r\n        onCancel={onUpdateCancel}></A6Update>\r\n      <div>\r\n        <Space>\r\n          <!-- ... çœç•¥ -->\r\n          <A6SelectedDelete ids={ids} onSuccess={onDeleteSelectedSuccess}></A6SelectedDelete>\r\n        </Space>\r\n      </div>\r\n      <Table\r\n        rowSelection={{\r\n          selectedRowKeys: selectedKeys,\r\n          onChange: onSelectChange,\r\n        }}\r\n        columns={columns}\r\n        dataSource={students}\r\n        rowKey='id'\r\n        loading={loading}\r\n        pagination={pagination}\r\n        onChange={onTableChange}></Table>\r\n    </div>\r\n  )\r\n}\r\n```\r\n\r\n\r\n\r\n#### useRequest\r\n\r\nå®‰è£…\r\n\r\n```cmd\r\nnpm install ahooks\r\n```\r\n\r\nä½¿ç”¨\r\n\r\n```tsx\r\nimport { useRequest } from 'ahooks'\r\nimport { Table } from 'antd'\r\nimport { ColumnsType } from 'antd/lib/table'\r\nimport axios from 'axios'\r\nimport { Student, R } from '../model/Student'\r\n\r\nexport default function A3() {\r\n  function getStudents() {\r\n    return axios.get<R<Student[]>>('http://localhost:8080/api/students')\r\n  }\r\n\r\n  const { loading, data } = useRequest(getStudents)  \r\n\r\n  const columns: ColumnsType<Student> = [\r\n    {\r\n      title: 'ç¼–å·',\r\n      dataIndex: 'id',\r\n    },\r\n    {\r\n      title: 'å§“å',\r\n      dataIndex: 'name',\r\n    },\r\n    {\r\n      title: 'æ€§åˆ«',\r\n      dataIndex: 'sex',\r\n    },\r\n    {\r\n      title: 'å¹´é¾„',\r\n      dataIndex: 'age',\r\n    },\r\n  ]\r\n\r\n  return (\r\n    <Table\r\n      dataSource={data?.data.data}\r\n      columns={columns}\r\n      rowKey='id'\r\n      loading={loading}\r\n      pagination={{ hideOnSinglePage: true }}></Table>\r\n  )\r\n}\r\n```\r\n\r\n\r\n\r\n#### useAndtTable\r\n\r\n```tsx\r\nimport { useAntdTable } from 'ahooks'\r\nimport { Table } from 'antd'\r\nimport { ColumnsType } from 'antd/lib/table'\r\nimport axios from 'axios'\r\nimport { Student, R } from '../model/Student'\r\n\r\ninterface PageResp<T> {\r\n  total: number\r\n  list: T[]\r\n}\r\n\r\ninterface PageReq {\r\n  current: number\r\n  pageSize: number\r\n  sorter?: any\r\n  filter?: any\r\n}\r\n\r\nexport default function A3() {\r\n  async function getStudents({ current, pageSize }: PageReq) {\r\n    const resp = await axios.get<R<PageResp<Student>>>(\r\n      `http://localhost:8080/api/students/q?page=${current}&size=${pageSize}`\r\n    )\r\n    return resp.data.data\r\n  }\r\n\r\n  const { tableProps } = useAntdTable(getStudents, {\r\n    defaultParams: [{ current: 1, pageSize: 5 }],\r\n  })\r\n  console.log(tableProps)\r\n\r\n  const columns: ColumnsType<Student> = [\r\n    {\r\n      title: 'ç¼–å·',\r\n      dataIndex: 'id',\r\n    },\r\n    {\r\n      title: 'å§“å',\r\n      dataIndex: 'name',\r\n    },\r\n    {\r\n      title: 'æ€§åˆ«',\r\n      dataIndex: 'sex',\r\n    },\r\n    {\r\n      title: 'å¹´é¾„',\r\n      dataIndex: 'age',\r\n    },\r\n  ]\r\n\r\n  return <Table {...tableProps} columns={columns} rowKey='id'></Table>\r\n}\r\n```\r\n\r\n\r\n\r\n### 2) MobX\r\n\r\n#### ä»‹ç»\r\n\r\néœ€æ±‚ï¼Œç»„ä»¶0 æ”¹å˜äº†æ•°æ®ï¼Œå…¶å®ƒç»„ä»¶ä¹Ÿæƒ³è·å¾—æ”¹å˜åçš„æ•°æ®ï¼Œå¦‚å›¾æ‰€ç¤º\r\n\r\n![image-20221025104453534](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221025104453534.png)\r\n\r\nè¿™ç§å¤šä¸ªç»„ä»¶ä¹‹é—´è¦å…±äº«çŠ¶æ€æ•°æ®ï¼ŒuseState å°±ä¸å¤Ÿç”¨äº†ï¼ŒuseContext ä¹Ÿä¸å¥½ç”¨äº†\r\n\r\n\r\n\r\nèƒ½å¤Ÿå’Œ react é…åˆä½¿ç”¨çš„çŠ¶æ€ç®¡ç†åº“æœ‰\r\n\r\n* MobX\r\n* Redux\r\n\r\nå…¶ä¸­ Redux API **éå¸¸**éš¾ä»¥ä½¿ç”¨ï¼Œè¿™é‡Œé€‰æ‹©äº†æ›´åŠ ç¬¦åˆ**äººç±»ä¹ æƒ¯**çš„ MobXï¼Œå®ƒè™½ç„¶é‡‡ç”¨äº†é¢å‘å¯¹è±¡çš„è¯­æ³•ï¼Œä½†ä¹Ÿèƒ½å’Œå‡½æ•°å¼çš„ä»£ç å¾ˆå¥½åœ°ç»“åˆ\r\n\r\n\r\n\r\n\r\n\r\n#### æ–‡æ¡£\r\n\r\n* [MobX ä¸­æ–‡æ–‡æ¡£](https://cn.mobx.js.org/)\r\n* [MobX å®˜æ–¹æ–‡æ¡£](https://mobx.js.org/README.html)\r\n\r\n\r\n\r\n#### å®‰è£…\r\n\r\n```\r\nnpm install mobx mobx-react-lite\r\n```\r\n\r\n* mobx ç›®å‰ç‰ˆæœ¬æ˜¯ 6.x\r\n* mobx-react-lite ç›®å‰ç‰ˆæœ¬æ˜¯ 3.x\r\n\r\n\r\n\r\n#### åè¯\r\n\r\n![Action, State, View](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/action-state-view.png)\r\n\r\n* Actions ç”¨æ¥ä¿®æ”¹çŠ¶æ€æ•°æ®çš„æ–¹æ³•\r\n* Observable state çŠ¶æ€æ•°æ®ï¼Œå¯è§‚å¯Ÿ\r\n* Derived values æ´¾ç”Ÿå€¼ï¼Œä¹Ÿå« Computed values è®¡ç®—å€¼ï¼Œä¼šæ ¹æ®çŠ¶æ€æ•°æ®çš„æ”¹å˜è€Œæ”¹å˜ï¼Œå…·æœ‰ç¼“å­˜åŠŸèƒ½\r\n* Reactions çŠ¶æ€æ•°æ®å‘ç”Ÿå˜åŒ–åè¦æ‰§è¡Œçš„æ“ä½œï¼Œå¦‚ react å‡½æ•°ç»„ä»¶è¢«é‡æ–°æ¸²æŸ“\r\n\r\n\r\n\r\n#### ä½¿ç”¨\r\n\r\né¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªåœ¨å‡½æ•°ä¹‹å¤–å­˜å‚¨çŠ¶æ€æ•°æ®çš„ storeï¼Œå®ƒä¸ useState ä¸åŒï¼š\r\n\r\n* useState é‡Œçš„çŠ¶æ€æ•°æ®æ˜¯å­˜å‚¨åœ¨æ¯ä¸ªç»„ä»¶èŠ‚ç‚¹ä¸Šï¼Œä¸åŒç»„ä»¶ä¹‹é—´æ²¡æ³•å…±äº«\r\n* è€Œ MobX çš„ store å°±æ˜¯ä¸€ä¸ªæ™®é€š js å¯¹è±¡ï¼Œåªè¦ä¿è¯å¤šä¸ªç»„ä»¶éƒ½è®¿é—®æ­¤å¯¹è±¡å³å¯\r\n\r\n```tsx\r\nimport axios from 'axios'\r\nimport { makeAutoObservable } from 'mobx'\r\nimport { R, Student } from '../model/Student'\r\n\r\nclass StudentStore {\r\n  student: Student = { name: '' }\r\n\r\n  constructor() {\r\n    makeAutoObservable(this)\r\n  }\r\n\r\n  async fetch(id: number) {\r\n    const resp = await axios.get<R<Student>>(\r\n      `http://localhost:8080/api/students/${id}`\r\n    )\r\n    runInAction(() => {\r\n      this.student = resp.data.data\r\n    })\r\n  }\r\n    \r\n  get print() {\r\n    const first = this.student.name.charAt(0)\r\n    if (this.student.sex === 'ç”·') {\r\n      return first.concat('å¤§ä¾ ')\r\n    } else if (this.student.sex === 'å¥³') {\r\n      return first.concat('å¥³ä¾ ')\r\n    } else {\r\n      return ''\r\n    }\r\n  } \r\n}\r\n\r\nexport default new StudentStore()\r\n```\r\n\r\nå…¶ä¸­ makeAutoObservable ä¼š\r\n\r\n* å°†å¯¹è±¡çš„å±æ€§ student å˜æˆ Observable stateï¼Œå³çŠ¶æ€æ•°æ®\r\n* å°†å¯¹è±¡çš„æ–¹æ³• fetch å˜æˆ Actionï¼Œå³ä¿®æ”¹æ•°æ®çš„æ–¹æ³•\r\n* å°† get æ–¹æ³•å˜æˆ Computed values\r\n\r\nåœ¨å¼‚æ­¥æ“ä½œé‡Œä¸ºçŠ¶æ€å±æ€§èµ‹å€¼ï¼Œéœ€è¦æ”¾åœ¨ runInAction é‡Œï¼Œå¦åˆ™ä¼šæœ‰è­¦å‘Šé”™è¯¯\r\n\r\n\r\n\r\nä½¿ç”¨ storeï¼Œæ‰€æœ‰ä½¿ç”¨ store çš„ç»„ä»¶ï¼Œä¸ºäº†æ„ŸçŸ¥çŠ¶æ€æ•°æ®çš„å˜åŒ–ï¼Œéœ€è¦ç”¨ observer åŒ…è£…ï¼Œå¯¹åº”ç€å›¾ä¸­ reactions\r\n\r\n```tsx\r\nimport Search from 'antd/lib/input/Search'\r\nimport { observer } from 'mobx-react-lite'\r\nimport studentStore from '../store/StudentStore'\r\nimport A71 from './A71'\r\nimport Test2 from './Test2'\r\n\r\nconst A7 = () => {\r\n  return (\r\n    <div>\r\n      <Search\r\n        placeholder='input search text'\r\n        onSearch={(v) => studentStore.fetch(Number(v))}\r\n        style={{ width: 100 }}\r\n      />\r\n      <h3>ç»„ä»¶0 {studentStore.student.name}</h3>\r\n      <A71></A71>\r\n      <A72></A72>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default observer(A7)\r\n```\r\n\r\nå…¶å®ƒç»„ä»¶\r\n\r\n```tsx\r\nimport { observer } from 'mobx-react-lite'\r\nimport studentStore from '../store/StudentStore'\r\n\r\nconst A71 = () =>{\r\n  return <h3 style={{color:'red'}}>ç»„ä»¶1 {studentStore.student.name}</h3>\r\n}\r\n\r\nexport default observer(A71)\r\n```\r\n\r\n\r\n\r\n```tsx\r\nimport { observer } from 'mobx-react-lite'\r\nimport studentStore from '../store/StudentStore'\r\n\r\nconst A72 = () =>{\r\n  return <h3 style={{color:'red'}}>ç»„ä»¶1 {studentStore.student.name}</h3>\r\n}\r\n\r\nexport default observer(A72)\r\n```\r\n\r\n\r\n\r\n#### æ³¨è§£æ–¹å¼\r\n\r\n```java\r\nimport { R, Student } from \"../model/Student\";\r\nimport { action, computed, makeAutoObservable, makeObservable, observable, runInAction } from 'mobx'\r\nimport axios from \"axios\";\r\n\r\nclass StudentStore {\r\n  // å±æ€§ - å¯¹åº”çŠ¶æ€æ•°æ® observable state\r\n  @observable student: Student = { id: 0, name: '' }\r\n  // æ–¹æ³• - å¯¹åº” action æ–¹æ³•\r\n  @action setName(name: string) {\r\n    this.student.name = name\r\n  }\r\n  @action async fetch(id: number) {\r\n    const resp = await axios.get<R<Student>>(`http://localhost:8080/api/students/${id}`)\r\n    runInAction(() => {\r\n      this.student = resp.data.data\r\n    })\r\n  }\r\n  // get æ–¹æ³• - å¯¹åº” derived value\r\n  @computed get displayName() {\r\n    const first = this.student.name.charAt(0)\r\n    if (this.student.sex === 'ç”·') {\r\n      return first + 'å¤§ä¾ '\r\n    } else if (this.student.sex === 'å¥³') {\r\n      return first + 'å¥³ä¾ '\r\n    } else {\r\n      return ''\r\n    }\r\n  }\r\n  // æ„é€ å™¨\r\n  constructor() {\r\n    makeObservable(this)\r\n  }\r\n}\r\n\r\nexport default new StudentStore()\r\n```\r\n\r\néœ€è¦åœ¨ tsconifg.json ä¸­åŠ å…¥é…ç½®\r\n\r\n```json\r\n{\r\n  \"compilerOptions\": {\r\n    // ...\r\n    \"experimentalDecorators\": true\r\n  }\r\n}\r\n```\r\n\r\n\r\n\r\n### 3) React Router\r\n\r\n#### å®‰è£…\r\n\r\n```cmd\r\nnpm install react-router-dom\r\n```\r\n\r\n* ç›®å‰ç‰ˆæœ¬æ˜¯ 6.x\r\n\r\n\r\n\r\n#### ä½¿ç”¨\r\n\r\næ–°å»ºæ–‡ä»¶ src/router/router.tsx\r\n\r\n```tsx\r\nimport { lazy } from 'react'\r\nimport { Navigate, RouteObject, useRoutes } from 'react-router-dom'\r\n\r\nexport function load(name: string) {\r\n  const Page = lazy(() => import(`../pages/${name}`))\r\n  return <Page></Page>\r\n}\r\n\r\nconst staticRoutes: RouteObject[] = [\r\n  { path: '/login', element: load('A8Login') },\r\n  {\r\n    path: '/',\r\n    element: load('A8Main'),\r\n    children: [\r\n      { path: 'student', element: load('A8MainStudent') },\r\n      { path: 'teacher', element: load('A8MainTeacher') },\r\n      { path: 'user', element: load('A8MainUser') }\r\n    ],\r\n  },\r\n  { path: '/404', element: load('A8Notfound') },\r\n  { path: '/*', element: <Navigate to={'/404'}></Navigate> },\r\n]\r\n\r\nexport default function Router() {\r\n  return useRoutes(staticRoutes)\r\n}\r\n```\r\n\r\nindex.tsx ä¿®æ”¹ä¸º\r\n\r\n```tsx\r\nimport ReactDOM from 'react-dom/client';\r\nimport './index.css';\r\nimport { ConfigProvider } from 'antd';\r\nimport zhCN from 'antd/es/locale/zh_CN'\r\n\r\nimport { BrowserRouter } from 'react-router-dom';\r\nimport Router from './router/router';\r\n\r\nconst root = ReactDOM.createRoot(\r\n  document.getElementById('root') as HTMLElement\r\n);\r\n\r\nroot.render(\r\n  <ConfigProvider locale={zhCN}>\r\n    <BrowserRouter>\r\n      <Router></Router>\r\n    </BrowserRouter>\r\n  </ConfigProvider>  \r\n)\r\n```\r\n\r\nA8Main çš„ä»£ç \r\n\r\n```tsx\r\nimport { Layout } from \"antd\";\r\nimport { Link, Outlet } from \"react-router-dom\";\r\n\r\nexport default function A8Main () {  \r\n  return <Layout>\r\n    <Layout.Header>å¤´éƒ¨å¯¼èˆª</Layout.Header>\r\n    <Layout>\r\n      <Layout.Sider>ä¾§è¾¹å¯¼èˆª\r\n        <Link to='/student'>å­¦ç”Ÿç®¡ç†</Link>\r\n        <Link to='/teacher'>æ•™å¸ˆç®¡ç†</Link>\r\n        <Link to='/user'>ç”¨æˆ·ç®¡ç†</Link>\r\n      </Layout.Sider>\r\n      <Layout.Content>\r\n        <Outlet></Outlet>\r\n      </Layout.Content>\r\n    </Layout>\r\n  </Layout>\r\n}\r\n```\r\n\r\n1. Navigate çš„ä½œç”¨æ˜¯é‡å®šå‘\r\n2. load æ–¹æ³•çš„ä½œç”¨æ˜¯æ‡’åŠ è½½ç»„ä»¶ï¼Œæ›´é‡è¦çš„æ˜¯æ ¹æ®å­—ç¬¦ä¸²æ‰¾åˆ°çœŸæ­£çš„ç»„ä»¶ï¼Œè¿™æ˜¯åŠ¨æ€è·¯ç”±æ‰€éœ€è¦çš„\r\n3. children æ¥è¿›è¡ŒåµŒå¥—è·¯ç”±æ˜ å°„ï¼ŒåµŒå¥—è·¯ç”±åœ¨è·³è½¬åï¼Œå¹¶ä¸æ˜¯æ›¿æ¢æ•´ä¸ªé¡µé¢ï¼Œè€Œæ˜¯ç”¨æ–°é¡µé¢æ›¿æ¢çˆ¶é¡µé¢çš„ Outlet éƒ¨åˆ†\r\n\r\n\r\n\r\n#### åŠ¨æ€è·¯ç”±\r\n\r\nè·¯ç”±åˆ†æˆä¸¤éƒ¨åˆ†ï¼š\r\n\r\n* é™æ€è·¯ç”±ï¼Œå›ºå®šçš„éƒ¨åˆ†ï¼Œå¦‚ä¸»é¡µã€404ã€login è¿™å‡ ä¸ªé¡µé¢\r\n* åŠ¨æ€è·¯ç”±ï¼Œå˜åŒ–çš„éƒ¨åˆ†ï¼Œç»å¸¸æ˜¯ä¸»é¡µå†…çš„åµŒå¥—è·¯ç”±ï¼Œæ¯”å¦‚ Studentã€Teacher è¿™äº›\r\n\r\nåŠ¨æ€è·¯ç”±åº”è¯¥æ˜¯æ ¹æ®ç”¨æˆ·ç™»å½•åï¼Œæ ¹æ®è§’è‰²çš„ä¸åŒï¼Œä»åç«¯æœåŠ¡è·å–ï¼Œå› ä¸ºè¿™äº›æ•°æ®æ˜¯å˜åŒ–çš„ï¼Œæ‰€ä»¥ç”¨ mobx æ¥ç®¡ç†\r\n\r\n```tsx\r\nimport axios from 'axios'\r\nimport { makeAutoObservable, runInAction } from 'mobx'\r\nimport { Navigate, RouteObject } from 'react-router-dom'\r\nimport { MenuAndRoute, R, Route } from '../model/Student'\r\nimport { load } from '../router/MyRouter'\r\n\r\nclass RoutesStore {\r\n  dynamicRoutes: Route[]\r\n\r\n  async fetch(username: string) {\r\n    const resp = await axios.get<R<MenuAndRoute>>(\r\n      `http://localhost:8080/api/menu/${username}`\r\n    )\r\n    runInAction(() => {\r\n      this.dynamicRoutes = resp.data.data.routeList\r\n      localStorage.setItem('dynamicRoutes', JSON.stringify(this.dynamicRoutes))\r\n    })\r\n  }\r\n\r\n  constructor() {\r\n    makeAutoObservable(this)\r\n    const r = localStorage.getItem('dynamicRoutes')\r\n    this.dynamicRoutes = r ? JSON.parse(r) : []\r\n  }\r\n\r\n  reset() {\r\n    this.dynamicRoutes = []\r\n    localStorage.removeItem('dynamicRoutes')\r\n  }\r\n\r\n  get routes() {\r\n    const staticRoutes: RouteObject[] = [\r\n      { path: '/login', element: load('A8Login') },\r\n      { path: '/', element: load('A8Main') },\r\n      { path: '/404', element: load('A8Notfound') },\r\n      { path: '/*', element: <Navigate to={'/404'}></Navigate> },\r\n    ]\r\n    const main = staticRoutes[1]\r\n\r\n    main.children = this.dynamicRoutes.map((r) => {\r\n      console.log(r.path, r.element)\r\n      return {\r\n        path: r.path,\r\n        element: load(r.element),\r\n      }\r\n    })\r\n    return staticRoutes\r\n  }\r\n}\r\n\r\nexport default new RoutesStore()\r\n```\r\n\r\n* å…¶ä¸­ç”¨ localStorage è¿›è¡Œäº†æ•°æ®çš„æŒä¹…åŒ–ï¼Œé¿å…åˆ·æ–°åä¸¢å¤±æ•°æ®\r\n\r\nMyRouter æ–‡ä»¶ä¿®æ”¹ä¸º\r\n\r\n```tsx\r\nimport { observer } from 'mobx-react-lite'\r\nimport { lazy } from 'react'\r\nimport { Navigate, RouteObject, useRoutes } from 'react-router-dom'\r\nimport RoutesStore from '../store/RoutesStore'\r\n\r\n// æŠŠå­—ç¬¦ä¸²ç»„ä»¶ => ç»„ä»¶æ ‡ç­¾\r\nexport function load(name: string) {\r\n  // A8Login\r\n  const Page = lazy(() => import(`../pages/${name}`))\r\n  return <Page></Page>\r\n}\r\n\r\n// è·¯ç”±å¯¹è±¡\r\nfunction MyRouter() {  \r\n  const router = useRoutes(RoutesStore.routes)\r\n  return router\r\n}\r\n\r\nexport default observer(MyRouter)\r\n```\r\n\r\næ³¨æ„å¯¼å…¥ router å¯¹è±¡æ—¶ï¼Œç”¨ observer åšäº†åŒ…è£…ï¼Œè¿™æ ·èƒ½å¤Ÿåœ¨ store å‘ç”Ÿå˜åŒ–æ—¶é‡å»º router å¯¹è±¡\r\n\r\n\r\n\r\n#### åŠ¨æ€èœå•\r\n\r\nå›¾æ ‡è¦ç‹¬ç«‹å®‰è£…ä¾èµ–\r\n\r\n```\r\nnpm install @ant-design/icons\r\n```\r\n\r\nå›¾æ ‡ç»„ä»¶ï¼Œç”¨æ¥å°†**å­—ç¬¦ä¸²å›¾æ ‡**è½¬æ¢ä¸º**æ ‡ç­¾å›¾æ ‡**\r\n\r\n```tsx\r\nimport * as icons from '@ant-design/icons'\r\n\r\ninterface Module {\r\n  [p: string]: any\r\n}\r\n\r\nconst all: Module = icons\r\n\r\nexport default function Icon({ name }: { name: string }) {\r\n  const Icon = all[name]\r\n  return <Icon></Icon>\r\n}\r\n```\r\n\r\nä¿®æ”¹ RoutesStore.tsx\r\n\r\n```tsx\r\nimport axios from 'axios'\r\nimport { makeAutoObservable, runInAction } from 'mobx'\r\nimport { Link, Navigate, RouteObject } from 'react-router-dom'\r\nimport { Menu, MenuAndRoute, R, Route } from '../model/Student'\r\nimport { load } from '../router/MyRouter'\r\nimport Icon from './Icon'\r\n\r\nfunction convertMenu(m: Menu): any {\r\n  const Label = m.routePath ? <Link to={m.routePath}>{m.label}</Link> : m.label\r\n  return {\r\n    label: Label,\r\n    key: m.key,\r\n    icon: <Icon name={m.icon}></Icon>,\r\n    children: m.children && m.children.map(convertMenu)\r\n  }\r\n}\r\n\r\nclass RoutesStore {\r\n  // åŠ¨æ€éƒ¨åˆ†\r\n  dynamicRoutes: Route[] = []\r\n  dynamicMenus: Menu[] = []\r\n\r\n  async fetch(username: string) {\r\n    const resp = await axios.get<R<MenuAndRoute>>(\r\n      `http://localhost:8080/api/menu/${username}`\r\n    )\r\n    runInAction(() => {\r\n      this.dynamicRoutes = resp.data.data.routeList\r\n      localStorage.setItem('dynamicRoutes', JSON.stringify(this.dynamicRoutes))\r\n\r\n      this.dynamicMenus = resp.data.data.menuTree\r\n      localStorage.setItem('dynamicMenus', JSON.stringify(this.dynamicMenus))\r\n    })\r\n  }\r\n\r\n  get menus() {\r\n    return this.dynamicMenus.map(convertMenu)\r\n  }\r\n\r\n  get routes() {\r\n    const staticRoutes: RouteObject[] = [\r\n      { path: '/login', element: load('A8Login') },\r\n      { path: '/', element: load('A8Main'), children: [] },\r\n      { path: '/404', element: load('A8Notfound') },\r\n      { path: '/*', element: <Navigate to={'/404'}></Navigate> },\r\n    ]\r\n    staticRoutes[1].children = this.dynamicRoutes.map((r) => {\r\n      return {\r\n        path: r.path,\r\n        element: load(r.element),\r\n      }\r\n    })\r\n    return staticRoutes\r\n  }\r\n\r\n  constructor() {\r\n    makeAutoObservable(this)\r\n    const json = localStorage.getItem('dynamicRoutes')\r\n    this.dynamicRoutes = json ? JSON.parse(json) : []\r\n\r\n    const json2 = localStorage.getItem('dynamicMenus')\r\n    this.dynamicMenus = json2 ? JSON.parse(json2) : []\r\n  }\r\n\r\n  reset() {\r\n    localStorage.removeItem('dynamicRoutes')\r\n    this.dynamicRoutes = []\r\n    localStorage.removeItem('dynamicMenus')\r\n    this.dynamicMenus = []\r\n  }\r\n}\r\n\r\nexport default new RoutesStore()\r\n\r\n```\r\n\r\nå…¶ä¸­ convertMenu ä¸ºæ ¸å¿ƒæ–¹æ³•ï¼Œè´Ÿè´£å°†æœåŠ¡å™¨è¿”å›çš„ Menu è½¬æ¢æˆ antd Menu ç»„ä»¶éœ€è¦çš„ Menu\r\n\r\nä½¿ç”¨\r\n\r\n```tsx\r\n<Menu items={RoutesStore.menus} mode='inline' theme=\"dark\"></Menu>\r\n```\r\n\r\nè·³è½¬è‹¥å‘ç”Ÿé”™è¯¯ï¼Œå¯èƒ½æ˜¯å› ä¸ºç»„ä»¶æ‡’åŠ è½½å¼•èµ·çš„ï¼Œéœ€è¦ç”¨ Suspense è§£å†³\r\n\r\n```tsx\r\nroot.render(\r\n  <ConfigProvider locale={zhCN}>\r\n    <BrowserRouter>\r\n      <Suspense fallback={<h3>åŠ è½½ä¸­...</h3>}>\r\n        <MyRouter></MyRouter>\r\n      </Suspense>\r\n    </BrowserRouter>\r\n  </ConfigProvider>\r\n)\r\n```\r\n\r\n\r\n\r\n\r\n\r\n#### ç™»å½•\r\n\r\n```tsx\r\nimport { ItemType } from 'antd/lib/menu/hooks/useItems'\r\nimport axios from 'axios'\r\nimport { makeAutoObservable, runInAction } from 'mobx'\r\nimport { Link, Navigate, RouteObject } from 'react-router-dom'\r\nimport { LoginReq, LoginResp, Menu, MenuAndRoute, R, Route } from '../model/Student'\r\nimport { load } from '../router/MyRouter'\r\nimport Icon from './Icon'\r\n\r\nfunction convertMenu(m: Menu): ItemType {\r\n  const Label = m.routePath? <Link to={m.routePath}>{m.label}</Link> : m.label\r\n  return {\r\n    key: m.key,\r\n    label: Label,\r\n    icon: <Icon name={m.icon}></Icon>, \r\n    children: m.children && m.children.map(convertMenu)\r\n  }\r\n}\r\n\r\nclass RoutesStore {\r\n  // åŠ¨æ€éƒ¨åˆ†\r\n  dynamicRoutes: Route[] = []\r\n  dynamicMenus: Menu[] = []\r\n\r\n  token: string = ''\r\n  state: string = 'pending' // å–å€¼ pending done error\r\n  message: string = '' // å–å€¼: 1. ç©ºä¸² æ­£å¸¸  2. éç©ºä¸² é”™è¯¯æ¶ˆæ¯\r\n\r\n  async login(loginReq: LoginReq) {\r\n    this.state = 'pending'\r\n    this.message = ''\r\n    const resp1 = await axios.post<R<LoginResp>>(\r\n      'http://localhost:8080/api/loginJwt',\r\n      loginReq\r\n    )\r\n    if(resp1.data.code === 999) {\r\n      const resp2 = await axios.get<R<MenuAndRoute>>(\r\n        `http://localhost:8080/api/menu/${loginReq.username}`\r\n      )\r\n      runInAction(()=>{\r\n        this.token = resp1.data.data.token\r\n        localStorage.setItem('token', this.token)\r\n\r\n        this.dynamicRoutes = resp2.data.data.routeList\r\n        localStorage.setItem('dynamicRoutes', JSON.stringify(this.dynamicRoutes))\r\n\r\n        this.dynamicMenus = resp2.data.data.menuTree\r\n        localStorage.setItem('dynamicMenus', JSON.stringify(this.dynamicMenus))\r\n\r\n        this.state = 'done'\r\n      })\r\n    } else {\r\n      runInAction(()=>{\r\n        this.message = resp1.data.message || 'æœªçŸ¥é”™è¯¯'\r\n        this.state = 'error'\r\n      })\r\n    }\r\n  }\r\n\r\n  async fetch(username: string) {\r\n    const resp = await axios.get<R<MenuAndRoute>>(\r\n      `http://localhost:8080/api/menu/${username}`\r\n    )\r\n    runInAction(() => {\r\n      this.dynamicRoutes = resp.data.data.routeList\r\n      localStorage.setItem('dynamicRoutes', JSON.stringify(this.dynamicRoutes))\r\n\r\n      this.dynamicMenus = resp.data.data.menuTree\r\n      localStorage.setItem('dynamicMenus', JSON.stringify(this.dynamicMenus))\r\n    })\r\n  }\r\n    \r\n  get routes() {\r\n    const staticRoutes: RouteObject[] = [\r\n      { path: '/login', element: load('A8Login') },\r\n      { path: '/', element: load('A8Main'), children: [] },\r\n      { path: '/404', element: load('A8Notfound') },\r\n      { path: '/*', element: <Navigate to={'/404'}></Navigate> },\r\n    ]\r\n    staticRoutes[1].children = this.dynamicRoutes.map((r) => {\r\n      return {\r\n        path: r.path,\r\n        element: load(r.element),\r\n      }\r\n    })\r\n    return staticRoutes\r\n  }\r\n\r\n  get menus() {\r\n    return this.dynamicMenus.map(convertMenu)\r\n  }\r\n\r\n  constructor() {\r\n    makeAutoObservable(this)\r\n    const json = localStorage.getItem('dynamicRoutes')\r\n    this.dynamicRoutes = json ? JSON.parse(json) : []\r\n\r\n    const json1 = localStorage.getItem('dynamicMenus')\r\n    this.dynamicMenus = json1 ? JSON.parse(json1) : []\r\n\r\n    const token = localStorage.getItem('token')\r\n    this.token = token ?? ''\r\n      \r\n    this.message = ''\r\n    this.state = 'pending'  \r\n  }\r\n\r\n  reset() {\r\n    localStorage.removeItem('dynamicRoutes')\r\n    this.dynamicRoutes = []\r\n\r\n    localStorage.removeItem('dynamicMenus')\r\n    this.dynamicMenus = []\r\n\r\n    localStorage.removeItem('token')\r\n    this.token = ''\r\n      \r\n    this.message = ''\r\n    this.state = 'pending'    \r\n  }\r\n}\r\n\r\nexport default new RoutesStore()\r\n```\r\n\r\nç™»å½•é¡µé¢\r\n\r\n```tsx\r\nfunction A8Login() {\r\n  function onFinish(values: { username: string; password: string }) {\r\n    RoutesStore.login(values)\r\n  }\r\n\r\n  const nav = useNavigate()\r\n  useEffect(() => {\r\n    if (RoutesStore.state === 'done') {\r\n      nav('/')\r\n    } else if (RoutesStore.state === 'error') {\r\n      message.error(RoutesStore.message)\r\n    }\r\n  }, [RoutesStore.state])\r\n\r\n  // ...\r\n}\r\n\r\nexport default observer(A8Login)\r\n```\r\n\r\n* ç”¨ useNavigate() è¿”å›çš„å‡½æ•°è·³è½¬çš„ä»£ç ä¸èƒ½åŒ…å«åœ¨å‡½æ•°å¼ç»„ä»¶çš„ä¸»é€»è¾‘ä¸­ï¼Œåªèƒ½æ”¾åœ¨\r\n  * å…¶å®ƒäº‹ä»¶å¤„ç†å‡½æ•°ä¸­\r\n  * å†™åœ¨å‰¯ä½œç”¨å‡½æ•° useEffect ä¹‹ä¸­\r\n\r\n\r\n\r\n#### æ³¨é”€ã€æ¬¢è¿è¯ã€ç™»å½•æ£€æŸ¥\r\n\r\nStore ä¸­å¢åŠ  get username æ–¹æ³•\r\n\r\n```tsx\r\nclass RoutesStore {\r\n  // ...\r\n\r\n  // eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiJ9.-l-MjMPGJVOf3zoIJgoqpV3LWoqvCCgcaI1ga86ismU\r\n  get username() {\r\n    if(this.token.length === 0) {\r\n      return ''\r\n    }\r\n    const json = atob(this.token.split('.')[1])\r\n    return JSON.parse(json).sub\r\n  }\r\n    \r\n  // ...\r\n}\r\n```\r\n\r\n* token çš„å‰ä¸¤éƒ¨åˆ†éƒ½å¯ä»¥è§£ç å‡ºæ¥ï¼Œå…¶ä¸­ [1] å°±æ˜¯ token çš„å†…å®¹éƒ¨åˆ†\r\n\r\nä¸»é¡µç»„ä»¶æ”¹ä¸º\r\n\r\n```tsx\r\nimport { Button, Layout, Menu } from 'antd'\r\nimport { observer } from 'mobx-react-lite'\r\nimport { useEffect } from 'react'\r\nimport { Navigate, Outlet, useNavigate } from 'react-router-dom'\r\nimport RoutesStore from '../store/RoutesStore'\r\n\r\nfunction A8Main() {\r\n  const nav = useNavigate()\r\n\r\n  function onClick() {\r\n    RoutesStore.reset()\r\n    nav('/login')\r\n  }\r\n\r\n  /* useEffect(()=>{\r\n    if(RoutesStore.username === '') {\r\n      nav('/login')\r\n    }\r\n  }, []) */\r\n\r\n  if(RoutesStore.username === '') {\r\n    return <Navigate to='/login'></Navigate>\r\n  }\r\n\r\n  return (\r\n    <Layout>\r\n      <Layout.Header>\r\n        <span>æ¬¢è¿æ‚¨ã€{RoutesStore.username}ã€‘</span>\r\n        <Button size='small' onClick={onClick}>æ³¨é”€</Button>\r\n      </Layout.Header>\r\n      <Layout>\r\n        <Layout.Sider>\r\n          <Menu items={RoutesStore.menus} theme='dark' mode='inline'></Menu>\r\n        </Layout.Sider>\r\n        <Layout.Content>\r\n          <Outlet></Outlet>\r\n        </Layout.Content>\r\n      </Layout>\r\n    </Layout>\r\n  )\r\n}\r\n\r\nexport default observer(A8Main)\r\n```\r\n\r\n* è¿™ä¸ªä¾‹å­ä¸­æ¨èç”¨ Navigate æ¥å®Œæˆè·³è½¬\r\n* /studentï¼Œ/teacher ç­‰è·¯ç”±ä¸éœ€è¦æ£€æŸ¥ï¼Œå› ä¸ºç™»å½•æˆåŠŸåæ‰æœ‰\r\n\r\n\r\n\r\n## é™„å½•\r\n\r\n### ä»£ç ç‰‡æ®µ\r\n\r\nctrl+shift+p è¾“å…¥å…³é”®è¯**ä»£ç **\r\n\r\n![image-20221026102533928](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20221026102533928.png)\r\n\r\nå®šä¹‰ fun.code-snippets\r\n\r\n```json\r\n{\r\n\t\"å‡½æ•°ç»„ä»¶\": {\r\n\t\t\"scope\": \"javascript,typescript,typescriptreact\",\r\n\t\t\"prefix\": \"fun\",\r\n\t\t\"body\": [\r\n\t\t\t\"export default function ${1:å‡½æ•°å} () {\",\r\n      \"  $0\",      \r\n      \"  return <></>\",\r\n\t\t\t\"}\"\r\n\t\t],\r\n\t\t\"description\": \"å¿«é€Ÿç”Ÿæˆreactå‡½æ•°å¼ç»„ä»¶\"\r\n\t}\r\n}\r\n```\r\n\r\nå®šä¹‰ ofun.code-snippets\r\n\r\n```json\r\n{\r\n\t\"mobxå‡½æ•°ç»„ä»¶\": {\r\n\t\t\"scope\": \"javascript,typescript,typescriptreact\",\r\n\t\t\"prefix\": \"ofun\",\r\n\t\t\"body\": [\r\n      \"import { observer } from \\\"mobx-react-lite\\\"\",\r\n      \"\",\r\n\t\t\t\"function ${1:å‡½æ•°å} () {\",\r\n      \"  $0\",      \r\n      \"  return <></>\",\r\n\t\t\t\"}\",\r\n      \"export default observer($1)\",\r\n\t\t],\r\n\t\t\"description\": \"å¿«é€Ÿç”Ÿæˆmobx reactå‡½æ•°å¼ç»„ä»¶\"\r\n\t}\r\n}\r\n```\r\n\r\nè¿™æ ·å¯ä»¥åœ¨ tsx ä¸­ç”¨å¿«æ·é”® `fun` ä»¥åŠ `ofun` åˆ›å»ºç›¸åº”çš„ä»£ç ç‰‡æ®µ\r\n"},{"title":"è®¤è¯æˆæƒ-Spring Security","tags":["Spring Cloud","Spring Boot","Spring Security","JWT","OAuth2","Redis"],"categories":["Java","å¾®ç³»ç»Ÿä¸ç¬¬ä¸‰æ–¹æ¡†æ¶"],"author":"imklaus","excerpt":"\r\n\r\nå‚è€ƒè§†é¢‘ï¼š[é»‘é©¬å­¦æˆåœ¨çº¿é¡¹ç›®](https://www.bilibili.com/video/BV1j8411N7Bm/)\r\n\r\n","link":"/posts/Spring-Security","content":"\r\n\r\nå‚è€ƒè§†é¢‘ï¼š[é»‘é©¬å­¦æˆåœ¨çº¿é¡¹ç›®](https://www.bilibili.com/video/BV1j8411N7Bm/)\r\n\r\n<!-- more -->\r\n\r\n\r\n## **1 æ¨¡å—éœ€æ±‚åˆ†æ**\r\n\r\n### **1.1 ä»€ä¹ˆæ˜¯è®¤è¯æˆæƒ**\r\n\r\næˆªè‡³ç›®å‰ï¼Œé¡¹ç›®å·²ç»å®Œæˆäº†è¯¾ç¨‹å‘å¸ƒåŠŸèƒ½ï¼Œè¯¾ç¨‹å‘å¸ƒåç”¨æˆ·é€šè¿‡åœ¨çº¿å­¦ä¹ é¡µé¢ç‚¹æ’­è§†é¢‘è¿›è¡Œå­¦ä¹ ã€‚å¦‚ä½•å»è®°å½•å­¦ç”Ÿçš„å­¦ä¹ è¿‡ç¨‹å‘¢ï¼Ÿè¦æƒ³æŒæ¡å­¦ç”Ÿçš„å­¦ä¹ æƒ…å†µå°±éœ€è¦çŸ¥é“ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œè®°å½•å“ªä¸ªç”¨æˆ·åœ¨ä»€ä¹ˆæ—¶é—´å­¦ä¹ ä»€ä¹ˆè¯¾ç¨‹ï¼Œå¦‚æœç”¨æˆ·è¦è´­ä¹°è¯¾ç¨‹ä¹Ÿéœ€è¦çŸ¥é“ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œå»ç®¡ç†å­¦ç”Ÿçš„å­¦ä¹ è¿‡ç¨‹æœ€åŸºæœ¬çš„è¦å®ç°ç”¨æˆ·çš„èº«ä»½è®¤è¯ã€‚\r\n\r\nè®¤è¯æˆæƒæ¨¡å—å®ç°å¹³å°æ‰€æœ‰ç”¨æˆ·çš„èº«ä»½è®¤è¯ä¸ç”¨æˆ·æˆæƒåŠŸèƒ½ã€‚\r\n\r\nä»€ä¹ˆæ˜¯ç”¨æˆ·èº«ä»½è®¤è¯ï¼Ÿ\r\n\r\nâ€‹    ç”¨æˆ·èº«ä»½è®¤è¯å³ç”¨æˆ·å»è®¿é—®ç³»ç»Ÿèµ„æºæ—¶ç³»ç»Ÿè¦æ±‚éªŒè¯ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œèº«ä»½åˆæ³•æ–¹å¯ç»§ç»­è®¿é—®ã€‚å¸¸è§çš„ç”¨æˆ·èº«ä»½è®¤è¯çš„è¡¨ç°å½¢å¼æœ‰ï¼šç”¨æˆ·åå¯†ç ç™»å½•ï¼Œå¾®ä¿¡æ‰«ç ç­‰æ–¹å¼ã€‚\r\n\r\né¡¹ç›®åŒ…æ‹¬å­¦ç”Ÿã€å­¦ä¹ æœºæ„çš„è€å¸ˆã€å¹³å°è¿è¥äººå‘˜ä¸‰ç±»ç”¨æˆ·ï¼Œä¸ç®¡å“ªä¸€ç±»ç”¨æˆ·åœ¨è®¿é—®é¡¹ç›®å—ä¿æŠ¤èµ„æºæ—¶éƒ½éœ€è¦è¿›è¡Œèº«ä»½è®¤è¯ã€‚æ¯”å¦‚ï¼šå‘å¸ƒè¯¾ç¨‹æ“ä½œï¼Œéœ€è¦å­¦ä¹ æœºæ„çš„è€å¸ˆé¦–å…ˆç™»å½•ç³»ç»ŸæˆåŠŸï¼Œç„¶åå†æ‰§è¡Œå‘å¸ƒè¯¾ç¨‹æ“ä½œã€‚åˆ›å»ºè®¢å•ï¼Œéœ€è¦å­¦ç”Ÿç”¨æˆ·é¦–å…ˆç™»å½•ç³»ç»Ÿï¼Œæ‰å¯ä»¥åˆ›å»ºè®¢å•ã€‚å¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps35.jpg) \r\n\r\nä»€ä¹ˆæ˜¯ç”¨æˆ·æˆæƒï¼Ÿ\r\n\r\nâ€‹    ç”¨æˆ·è®¤è¯é€šè¿‡åå»è®¿é—®ç³»ç»Ÿçš„èµ„æºï¼Œç³»ç»Ÿä¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è®¿é—®èµ„æºçš„æƒé™ï¼Œåªå…è®¸è®¿é—®æœ‰æƒé™çš„ç³»ç»Ÿèµ„æºï¼Œæ²¡æœ‰æƒé™çš„èµ„æºå°†æ— æ³•è®¿é—®ï¼Œè¿™ä¸ªè¿‡ç¨‹å«ç”¨æˆ·æˆæƒã€‚æ¯”å¦‚ï¼šç”¨æˆ·å»å‘å¸ƒè¯¾ç¨‹ï¼Œç³»ç»Ÿé¦–å…ˆè¿›è¡Œç”¨æˆ·èº«ä»½è®¤è¯ï¼Œè®¤è¯é€šè¿‡åç»§ç»­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰å‘å¸ƒè¯¾ç¨‹çš„æƒé™ï¼Œå¦‚æœæ²¡æœ‰æƒé™åˆ™æ‹’ç»ç»§ç»­è®¿é—®ç³»ç»Ÿï¼Œå¦‚æœæœ‰æƒé™åˆ™ç»§ç»­å‘å¸ƒè¯¾ç¨‹ã€‚å¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps36.jpg) \r\n\r\n \r\n\r\n### **1.2 ä¸šåŠ¡æµç¨‹**\r\n\r\n#### **1.2.1 ç»Ÿä¸€è®¤è¯**\r\n\r\né¡¹ç›®åŒ…æ‹¬å­¦ç”Ÿã€å­¦ä¹ æœºæ„çš„è€å¸ˆã€å¹³å°è¿è¥äººå‘˜ä¸‰ç±»ç”¨æˆ·ï¼Œä¸‰ç±»ç”¨æˆ·å°†ä½¿ç”¨ç»Ÿä¸€çš„è®¤è¯å…¥å£ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps37.jpg) \r\n\r\nç”¨æˆ·è¾“å…¥è´¦å·å’Œå¯†ç æäº¤è®¤è¯ï¼Œè®¤è¯é€šè¿‡åˆ™ç»§ç»­æ“ä½œã€‚\r\n\r\né¡¹ç›®ç”±ç»Ÿä¸€è®¤è¯æœåŠ¡å—ç†ç”¨æˆ·çš„è®¤è¯è¯·æ±‚ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps38.jpg) \r\n\r\nè®¤è¯é€šè¿‡ç”±è®¤è¯æœåŠ¡å‘ç»™ç”¨æˆ·é¢å‘ä»¤ç‰Œï¼Œç›¸å½“äºè®¿é—®ç³»ç»Ÿçš„é€šè¡Œè¯ï¼Œç”¨æˆ·æ‹¿ç€ä»¤ç‰Œå»è®¿é—®ç³»ç»Ÿçš„èµ„æºã€‚\r\n\r\n#### **1.2.2 å•ç‚¹ç™»å½•**\r\n\r\næœ¬é¡¹ç›®åŸºäºå¾®æœåŠ¡æ¶æ„æ„å»ºï¼Œå¾®æœåŠ¡åŒ…æ‹¬ï¼šå†…å®¹ç®¡ç†æœåŠ¡ã€åª’èµ„ç®¡ç†æœåŠ¡ã€å­¦ä¹ ä¸­å¿ƒæœåŠ¡ã€ç³»ç»Ÿç®¡ç†æœåŠ¡ç­‰ï¼Œä¸ºäº†æé«˜ç”¨æˆ·ä½“éªŒæ€§ï¼Œç”¨æˆ·åªéœ€è¦è®¤è¯ä¸€æ¬¡ä¾¿å¯ä»¥åœ¨å¤šä¸ªæ‹¥æœ‰è®¿é—®æƒé™çš„ç³»ç»Ÿä¸­è®¿é—®ï¼Œè¿™ä¸ªåŠŸèƒ½å«åšå•ç‚¹ç™»å½•ã€‚\r\n\r\nå¼•ç”¨ç™¾åº¦ç™¾ç§‘ï¼šå•ç‚¹ç™»å½•ï¼ˆSingle Sign Onï¼‰ï¼Œç®€ç§°ä¸º SSOï¼Œæ˜¯ç›®å‰æ¯”è¾ƒæµè¡Œçš„ä¼ä¸šä¸šåŠ¡æ•´åˆçš„è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚SSOçš„å®šä¹‰æ˜¯åœ¨å¤šä¸ªåº”ç”¨ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·åªéœ€è¦ç™»å½•ä¸€æ¬¡å°±å¯ä»¥è®¿é—®æ‰€æœ‰ç›¸äº’ä¿¡ä»»çš„åº”ç”¨ç³»ç»Ÿã€‚\r\n\r\nå¦‚ä¸‹å›¾ï¼Œç”¨æˆ·åªéœ€è¦è®¤è¯ä¸€æ¬¡ï¼Œä¾¿å¯ä»¥åœ¨å¤šä¸ªæ‹¥æœ‰è®¿é—®æƒé™çš„ç³»ç»Ÿä¸­è®¿é—®ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps39.jpg) \r\n\r\n \r\n\r\n#### **1.2.3 ç¬¬ä¸‰æ–¹è®¤è¯**\r\n\r\nä¸ºäº†æé«˜ç”¨æˆ·ä½“éªŒï¼Œå¾ˆå¤šç½‘ç«™æœ‰æ‰«ç ç™»å½•çš„åŠŸèƒ½ï¼Œå¦‚ï¼šå¾®ä¿¡æ‰«ç ç™»å½•ã€QQæ‰«ç ç™»å½•ç­‰ã€‚æ‰«ç ç™»å½•çš„å¥½å¤„æ˜¯ç”¨æˆ·ä¸ç”¨è¾“å…¥è´¦å·å’Œå¯†ç ï¼Œæ“ä½œç®€ä¾¿ï¼Œå¦å¤–ä¸€ä¸ªå¥½å¤„å°±æ˜¯æœ‰åˆ©äºç”¨æˆ·ä¿¡æ¯çš„å…±äº«ï¼Œäº’è”ç½‘çš„ä¼˜åŠ¿å°±æ˜¯èµ„æºå…±äº«ï¼Œç”¨æˆ·ä¹Ÿæ˜¯ä¸€ç§èµ„æºï¼Œå¯¹äºä¸€ä¸ªæ–°ç½‘ç«™å¦‚æœè®©ç”¨æˆ·å»æ³¨å†Œæ˜¯å¾ˆå›°éš¾çš„ï¼Œå¦‚æœæä¾›äº†å¾®ä¿¡æ‰«ç ç™»å½•å°†çœå»ç”¨æˆ·æ³¨å†Œçš„æˆæœ¬ï¼Œæ˜¯ä¸€ç§éå¸¸æœ‰æ•ˆçš„æ¨å¹¿æ‰‹æ®µã€‚\r\n\r\nå¾®ä¿¡æ‰«ç ç™»å½•å…¶ä¸­çš„åŸç†æ­£æ˜¯ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹è®¤è¯ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps40.jpg) \r\n\r\n## **2 Spring Security è®¤è¯ç ”ç©¶**\r\n\r\n### **2.1 Spring Securityä»‹ç»**\r\n\r\nè®¤è¯åŠŸèƒ½å‡ ä¹æ˜¯æ¯ä¸ªé¡¹ç›®éƒ½è¦å…·å¤‡çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å®ƒä¸ä¸šåŠ¡æ— å…³ï¼Œå¸‚é¢ä¸Šæœ‰å¾ˆå¤šè®¤è¯æ¡†æ¶ï¼Œå¦‚ï¼šApache Shiroã€CASã€Spring Securityç­‰ã€‚ç”±äºæœ¬é¡¹ç›®åŸºäºSpring CloudæŠ€æœ¯æ„å»ºï¼ŒSpring Securityæ˜¯springå®¶æ—çš„ä¸€ä»½å­ä¸”å’ŒSpring Cloudé›†æˆçš„å¾ˆå¥½ï¼Œæ‰€ä»¥æœ¬é¡¹ç›®é€‰ç”¨Spring Securityä½œä¸ºè®¤è¯æœåŠ¡çš„æŠ€æœ¯æ¡†æ¶ã€‚\r\n\r\nSpring Security æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä¸”é«˜åº¦å¯å®šåˆ¶çš„èº«ä»½éªŒè¯å’Œè®¿é—®æ§åˆ¶æ¡†æ¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸“æ³¨äºä¸º Java åº”ç”¨ç¨‹åºæä¾›èº«ä»½éªŒè¯å’Œæˆæƒçš„æ¡†æ¶ã€‚\r\n\r\né¡¹ç›®ä¸»é¡µï¼šhttps://spring.io/projects/spring-security\r\n\r\nSpring cloud Securityï¼š https://spring.io/projects/spring-cloud-security\r\n\r\n### **2.2 è®¤è¯æˆæƒå…¥é—¨**\r\n\r\n#### **2.2.1 åˆ›å»ºè®¤è¯æœåŠ¡å·¥ç¨‹**\r\n\r\nä¸‹è¾¹æˆ‘ä»¬ä½¿ç”¨Spring Securityæ¡†æ¶å¿«é€Ÿæ„å»ºè®¤è¯æˆæƒåŠŸèƒ½ä½“ç³»ã€‚\r\n\r\n1ã€éƒ¨ç½²è®¤è¯æœåŠ¡å·¥ç¨‹\r\n\r\nä»è¯¾ç¨‹èµ„æ–™ä¸­æ‹·è´xuecheng-plus-authå·¥ç¨‹åˆ°è‡ªå·±çš„å·¥ç¨‹ç›®å½•ä¸‹ã€‚\r\n\r\næ­¤å·¥ç¨‹æ˜¯ä¸€ä¸ªæ™®é€šçš„spring bootå·¥ç¨‹ï¼Œå¯ä»¥è¿æ¥æ•°æ®åº“ã€‚\r\n\r\næ­¤å·¥ç¨‹ä¸å…·å¤‡è®¤è¯æˆæƒçš„åŠŸèƒ½ã€‚\r\n\r\n2ã€åˆ›å»ºæ•°æ®åº“\r\n\r\nåˆ›å»ºxc_usersæ•°æ®åº“\r\n\r\nå¯¼å…¥è¯¾ç¨‹èµ„æ–™ä¸­çš„xcplus_users.sqlè„šæœ¬ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps41.jpg) \r\n\r\n \r\n\r\nåœ¨nacosä¸­æ–°å¢`auth-service-dev.yaml`ï¼š\r\n\r\n```yaml\r\n\r\nserver:\r\n  servlet:\r\n    context-path: /auth\r\n  port: 63070\r\nspring:\r\n  datasource:\r\n    driver-class-name: com.mysql.cj.jdbc.Driver\r\n    url: jdbc:mysql://192.168.2.203:3306/xc_users?serverTimezone=UTC&userUnicode=true&useSSL=false&\r\n    username: root\r\n    password: 1234\r\n```\r\n\r\nåˆå§‹å·¥ç¨‹è‡ªå¸¦äº†ä¸€ä¸ªControllerç±»ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n@Slf4j\r\n@RestController\r\npublic class LoginController {\r\n\r\n  @Autowired\r\n  XcUserMapper userMapper;\r\n\r\n  @RequestMapping(\"/login-success\")\r\n  public String loginSuccess(){\r\n\r\n      return \"ç™»å½•æˆåŠŸ\";\r\n  }\r\n\r\n\r\n  @RequestMapping(\"/user/{id}\")\r\n  public XcUser getuser(@PathVariable(\"id\") String id){\r\n    XcUser xcUser = userMapper.selectById(id);\r\n    return xcUser;\r\n  }\r\n\r\n  @RequestMapping(\"/r/r1\")\r\n  public String r1(){\r\n    return \"è®¿é—®r1èµ„æº\";\r\n  }\r\n\r\n  @RequestMapping(\"/r/r2\")\r\n  public String r2(){\r\n    return \"è®¿é—®r2èµ„æº\";\r\n  }\r\n\r\n}\r\n```\r\n\r\nå¯åŠ¨å·¥ç¨‹ï¼Œå°è¯•è®¿é—®`http://localhost:63070/auth/r/r1` :\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps42.jpg) \r\n\r\nè®¿é—®ç”¨æˆ·ä¿¡æ¯ï¼š`http://localhost:63070/auth/user/52` \r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps43.jpg) \r\n\r\nä»¥ä¸Šæµ‹è¯•ä¸€åˆ‡æ­£å¸¸è¯´æ˜æ­¤å·¥ç¨‹éƒ¨ç½²æˆåŠŸã€‚\r\n\r\n \r\n\r\n#### **2.2.2 è®¤è¯æµ‹è¯•**\r\n\r\nä¸‹è¾¹å‘authè®¤è¯å·¥ç¨‹é›†æˆSpring securityï¼Œå‘pom.xmlåŠ å…¥Spring Securityæ‰€éœ€è¦çš„ä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>org.springframework.cloud</groupId>\r\n    <artifactId>spring-cloud-starter-security</artifactId>\r\n</dependency>\r\n<dependency>\r\n    <groupId>org.springframework.cloud</groupId>\r\n    <artifactId>spring-cloud-starter-oauth2</artifactId>\r\n</dependency>\r\n```\r\n\r\né‡å¯å·¥ç¨‹ï¼Œè®¿é—®`http://localhost:63070/auth/r/r1`\r\n\r\nè‡ªåŠ¨è¿›å…¥`/login`ç™»å½•é¡µé¢ï¼Œ`/login`æ˜¯spring securityæä¾›çš„,æ­¤é¡µé¢æœ‰å‡ ä¸ªcssæ ·å¼åŠ è½½ä¼šç¨å¾®æ…¢ç‚¹ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps44.jpg) \r\n\r\n \r\n\r\nè´¦å·å’Œå¯†ç æ˜¯å¤šå°‘å‘¢ï¼Ÿä¸‹ä¸€æ­¥éœ€è¦è¿›è¡Œå®‰å…¨é…ç½®ã€‚\r\n\r\næ‹·è´è¯¾ç¨‹èµ„æ–™ä¸‹çš„`WebSecurityConfig.java`åˆ°configä¸‹éœ€è¦ä¸‰éƒ¨åˆ†å†…å®¹ï¼š\r\n\r\n1ã€ç”¨æˆ·ä¿¡æ¯\r\n\r\nåœ¨å†…å­˜é…ç½®ä¸¤ä¸ªç”¨æˆ·ï¼š`zhangsanã€lisi`\r\n\r\nzhangsanç”¨æˆ·æ‹¥æœ‰çš„æƒé™ä¸ºp1\r\n\r\nlisiç”¨æˆ·æ‹¥æœ‰çš„æƒé™ä¸ºp2\r\n\r\n2ã€å¯†ç æ–¹å¼\r\n\r\næš‚æ—¶é‡‡ç”¨æ˜æ–‡æ–¹å¼\r\n\r\n3ã€å®‰å…¨æ‹¦æˆªæœºåˆ¶\r\n\r\n`/r/**`å¼€å¤´çš„è¯·æ±‚éœ€è¦è®¤è¯\r\n\r\nç™»å½•æˆåŠŸåˆ°æˆåŠŸé¡µé¢\r\n\r\nä»£ç å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n//é…ç½®ç”¨æˆ·ä¿¡æ¯æœåŠ¡\r\n@Bean\r\npublic UserDetailsService userDetailsService() {\r\n    //è¿™é‡Œé…ç½®ç”¨æˆ·ä¿¡æ¯,è¿™é‡Œæš‚æ—¶ä½¿ç”¨è¿™ç§æ–¹å¼å°†ç”¨æˆ·å­˜å‚¨åœ¨å†…å­˜ä¸­\r\n    InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();\r\n            manager.createUser(User.withUsername(\"zhangsan\").password(\"123\").authorities(\"p1\").build());\r\n    manager.createUser(User.withUsername(\"lisi\").password(\"456\").authorities(\"p2\").build());\r\n    return manager;\r\n}\r\n\r\n    @Bean\r\n    public PasswordEncoder passwordEncoder() {\r\n        //å¯†ç ä¸ºæ˜æ–‡æ–¹å¼\r\n        return NoOpPasswordEncoder.getInstance();\r\n    }\r\n\r\n    //é…ç½®å®‰å…¨æ‹¦æˆªæœºåˆ¶\r\n    @Override\r\n    protected void configure(HttpSecurity http) throws Exception {\r\n        http\r\n                .authorizeRequests()\r\n                .antMatchers(\"/r/**\").authenticated()//è®¿é—®/rå¼€å§‹çš„è¯·æ±‚éœ€è¦è®¤è¯é€šè¿‡\r\n                .anyRequest().permitAll()//å…¶å®ƒè¯·æ±‚å…¨éƒ¨æ”¾è¡Œ\r\n                .and()\r\n                .formLogin().successForwardUrl(\"/login-success\");//ç™»å½•æˆåŠŸè·³è½¬åˆ°/login-success\r\n                http.logout().logoutUrl(\"/logout\");//é€€å‡ºåœ°å€\r\n    }\r\n```\r\n\r\né‡å¯å·¥ç¨‹\r\n\r\n1ã€è®¿é—®`http://localhost:63070/auth/user/52`  å¯ä»¥æ­£å¸¸è®¿é—®\r\n\r\n2ã€è®¿é—®`http://localhost:63070/auth/r/r1` æ˜¾ç¤ºç™»å½•é¡µé¢\r\n\r\nè´¦å·zhangsanï¼Œå¯†ç ä¸º123ï¼Œå¦‚æœè¾“å…¥çš„å¯†ç ä¸æ­£ç¡®ä¼šè®¤è¯å¤±è´¥ï¼Œè¾“å…¥æ­£ç¡®æ˜¾ç¤ºç™»å½•æˆåŠŸã€‚\r\n\r\nä¸ºä»€ä¹ˆ`http://localhost:63070/auth/user/52`  å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œè®¿é—®`http://localhost:63070/auth/r/r1` æ˜¾ç¤ºç™»å½•é¡µé¢ï¼Ÿ\r\n\r\n \r\n\r\n`http.logout().logoutUrl(\"/logout\");`é…ç½®äº†é€€å‡ºé¡µé¢ï¼Œè®¤è¯æˆåŠŸåè®¿é—®`/logout`å¯é€€å‡ºç™»å½•ã€‚\r\n\r\n \r\n\r\n#### **2.2.3 æˆæƒæµ‹è¯•**\r\n\r\nç”¨æˆ·è®¤è¯é€šè¿‡å»è®¿é—®ç³»ç»Ÿèµ„æºæ—¶spring securityè¿›è¡Œæˆæƒæ§åˆ¶ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰è¯¥èµ„æºçš„è®¿é—®æƒé™ï¼Œå¦‚æœæœ‰åˆ™ç»§ç»­è®¿é—®ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ‹’ç»è®¿é—®ã€‚\r\n\r\nä¸‹è¾¹æµ‹è¯•æˆæƒåŠŸèƒ½ï¼š\r\n\r\n1ã€é…ç½®ç”¨æˆ·æ‹¥æœ‰å“ªäº›æƒé™ã€‚\r\n\r\nåœ¨WebSecurityConfigç±»é…ç½®zhangsanæ‹¥æœ‰p1æƒé™ï¼Œlisiæ‹¥æœ‰p2æƒé™ã€‚\r\n\r\n```java\r\n\r\n    @Bean\r\n    public UserDetailsService userDetailsService() {\r\n        //è¿™é‡Œé…ç½®ç”¨æˆ·ä¿¡æ¯,è¿™é‡Œæš‚æ—¶ä½¿ç”¨è¿™ç§æ–¹å¼å°†ç”¨æˆ·å­˜å‚¨åœ¨å†…å­˜ä¸­\r\n        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();\r\n        manager.createUser(User.withUsername(\"zhangsan\").password(\"123\").authorities(\"p1\").build());\r\n        manager.createUser(User.withUsername(\"lisi\").password(\"456\").authorities(\"p2\").build());\r\n        return manager;\r\n    }\r\n```\r\n\r\n2ã€æŒ‡å®šèµ„æºä¸æƒé™çš„å…³ç³»ã€‚\r\n\r\nä»€ä¹ˆæ˜¯ç³»ç»Ÿçš„èµ„æºï¼Ÿ\r\n\r\næ¯”å¦‚ï¼šæŸ¥è¯¢ä¸€ä¸ªç”¨æˆ·çš„ä¿¡æ¯ï¼Œç”¨æˆ·ä¿¡æ¯å°±æ˜¯ç³»ç»Ÿçš„èµ„æºï¼Œè¦è®¿é—®èµ„æºéœ€è¦é€šè¿‡URLï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨controllerä¸­å®šä¹‰çš„æ¯ä¸ªhttpçš„æ¥å£å°±æ˜¯è®¿é—®èµ„æºçš„æ¥å£ã€‚\r\n\r\nä¸‹è¾¹åœ¨controllerä¸­é…ç½®`/r/r1`éœ€è¦p1æƒé™ï¼Œ`/r/r2`éœ€è¦p2æƒé™ã€‚\r\n\r\n`hasAuthority('p1')`è¡¨ç¤ºæ‹¥æœ‰p1æƒé™æ–¹å¯è®¿é—®ã€‚\r\n\r\nä»£ç å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n@RestController\r\npublic class LoginController {\r\n    ....\r\n    @RequestMapping(\"/r/r1\")\r\n    @PreAuthorize(\"hasAuthority('p1')\")//æ‹¥æœ‰p1æƒé™æ–¹å¯è®¿é—®\r\n    public String r1(){\r\n      return \"è®¿é—®r1èµ„æº\";\r\n    }\r\n    \r\n    @RequestMapping(\"/r/r2\")\r\n    @PreAuthorize(\"hasAuthority('p2')\")//æ‹¥æœ‰p2æƒé™æ–¹å¯è®¿é—®\r\n    public String r2(){\r\n      return \"è®¿é—®r2èµ„æº\";\r\n    }\r\n    ...\r\n```\r\n\r\nç°åœ¨é‡å¯å·¥ç¨‹ã€‚\r\n\r\nå½“è®¿é—®ä»¥/r/å¼€å¤´çš„urlæ—¶ä¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦è®¤è¯ï¼Œå¦‚æœæ²¡æœ‰è®¤è¯åˆ™è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œå¦‚æœå·²ç»è®¤è¯åˆ™åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å…·æœ‰è¯¥URLçš„è®¿é—®æƒé™ï¼Œå¦‚æœå…·æœ‰è¯¥URLçš„è®¿é—®æƒé™åˆ™ç»§ç»­ï¼Œå¦åˆ™æ‹’ç»è®¿é—®ã€‚\r\n\r\nä¾‹å¦‚ï¼š\r\n\r\nè®¿é—®`/r/r1`ï¼Œä½¿ç”¨zhangsanç™»å½•å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œå› ä¸ºåœ¨`/r/r1`çš„æ–¹æ³•ä¸ŠæŒ‡å®šäº†æƒé™p1ï¼Œzhangsanç”¨æˆ·æ‹¥æœ‰æƒé™p1,æ‰€ä»¥å¯ä»¥æ­£å¸¸è®¿é—®ã€‚\r\n\r\nè®¿é—®`/r/r1`ï¼Œä½¿ç”¨lisiç™»å½•åˆ™æ‹’ç»è®¿é—®ï¼Œç”±äºlisiç”¨æˆ·ä¸å…·æœ‰æƒé™p1éœ€è¦æ‹’ç»è®¿é—®\r\n\r\næ³¨æ„ï¼šå¦‚æœè®¿é—®ä¸Šä¸åŠ `@PreAuthorize`ï¼Œæ­¤æ–¹æ³•æ²¡æœ‰æˆæƒæ§åˆ¶ã€‚\r\n\r\n \r\n\r\næ•´ç†æˆæƒçš„è¿‡ç¨‹è§ä¸‹å›¾æ‰€ç¤ºï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps45.jpg) \r\n\r\n \r\n\r\n#### **2.2.4 å·¥ä½œåŸç†**\r\n\r\né€šè¿‡æµ‹è¯•è®¤è¯å’Œæˆæƒä¸¤ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬äº†è§£äº†Spring Securityçš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œä¸‹è¾¹äº†è§£å®ƒçš„å·¥ä½œæµç¨‹ã€‚\r\n\r\nSpring Securityæ‰€è§£å†³çš„é—®é¢˜å°±æ˜¯**å®‰å…¨è®¿é—®æ§åˆ¶**ï¼Œè€Œå®‰å…¨è®¿é—®æ§åˆ¶åŠŸèƒ½å…¶å®å°±æ˜¯å¯¹æ‰€æœ‰è¿›å…¥ç³»ç»Ÿçš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œæ ¡éªŒæ¯ä¸ªè¯·æ±‚æ˜¯å¦èƒ½å¤Ÿè®¿é—®å®ƒæ‰€æœŸæœ›çš„èµ„æºã€‚æ ¹æ®å‰è¾¹çŸ¥è¯†çš„å­¦ä¹ ï¼Œå¯ä»¥é€šè¿‡Filteræˆ–AOPç­‰æŠ€æœ¯æ¥å®ç°ï¼ŒSpring Securityå¯¹Webèµ„æºçš„ä¿æŠ¤æ˜¯é Filterå®ç°çš„ï¼Œæ‰€ä»¥ä»è¿™ä¸ªFilteræ¥å…¥æ‰‹ï¼Œé€æ­¥æ·±å…¥Spring SecurityåŸç†ã€‚\r\n\r\nâ€‹    å½“åˆå§‹åŒ–Spring Securityæ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸ºSpringSecurityFilterChainçš„Servletè¿‡æ»¤å™¨ï¼Œç±»å‹ä¸º `org.springframework.security.web.FilterChainProxy`ï¼Œå®ƒå®ç°äº†`javax.servlet.Filter`ï¼Œå› æ­¤å¤–éƒ¨çš„è¯·æ±‚ä¼šç»è¿‡æ­¤ç±»ï¼Œä¸‹å›¾æ˜¯Spring Securityè¿‡è™‘å™¨é“¾ç»“æ„å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps46.jpg) \r\n\r\nFilterChainProxyæ˜¯ä¸€ä¸ªä»£ç†ï¼ŒçœŸæ­£èµ·ä½œç”¨çš„æ˜¯FilterChainProxyä¸­SecurityFilterChainæ‰€åŒ…å«çš„å„ä¸ªFilterï¼ŒåŒæ—¶è¿™äº›Filterä½œä¸ºBeanè¢«Springç®¡ç†ï¼Œå®ƒä»¬æ˜¯Spring Securityæ ¸å¿ƒï¼Œå„æœ‰å„çš„èŒè´£ï¼Œä½†ä»–ä»¬å¹¶ä¸ç›´æ¥å¤„ç†ç”¨æˆ·çš„**è®¤è¯**ï¼Œä¹Ÿä¸ç›´æ¥å¤„ç†ç”¨æˆ·çš„**æˆæƒ**ï¼Œè€Œæ˜¯æŠŠå®ƒä»¬äº¤ç»™äº†è®¤è¯ç®¡ç†å™¨ï¼ˆAuthenticationManagerï¼‰å’Œå†³ç­–ç®¡ç†å™¨ï¼ˆAccessDecisionManagerï¼‰è¿›è¡Œå¤„ç†ã€‚\r\n\r\nspring SecurityåŠŸèƒ½çš„å®ç°ä¸»è¦æ˜¯ç”±ä¸€ç³»åˆ—è¿‡æ»¤å™¨é“¾ç›¸äº’é…åˆå®Œæˆã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps47.jpg) \r\n\r\nä¸‹é¢ä»‹ç»è¿‡æ»¤å™¨é“¾ä¸­ä¸»è¦çš„å‡ ä¸ªè¿‡æ»¤å™¨åŠå…¶ä½œç”¨ï¼š\r\n\r\n**SecurityContextPersistenceFilter** è¿™ä¸ªFilteræ˜¯æ•´ä¸ªæ‹¦æˆªè¿‡ç¨‹çš„å…¥å£å’Œå‡ºå£ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ‹¦æˆªå™¨ï¼‰ï¼Œä¼šåœ¨è¯·æ±‚å¼€å§‹æ—¶ä»é…ç½®å¥½çš„ SecurityContextRepository ä¸­è·å– SecurityContextï¼Œç„¶åæŠŠå®ƒè®¾ç½®ç»™ SecurityContextHolderã€‚åœ¨è¯·æ±‚å®Œæˆåå°† SecurityContextHolder æŒæœ‰çš„ SecurityContext å†ä¿å­˜åˆ°é…ç½®å¥½çš„ SecurityContextRepositoryï¼ŒåŒæ—¶æ¸…é™¤ securityContextHolder æ‰€æŒæœ‰çš„ SecurityContextï¼›\r\n\r\n**UsernamePasswordAuthenticationFilter** ç”¨äºå¤„ç†æ¥è‡ªè¡¨å•æäº¤çš„è®¤è¯ã€‚è¯¥è¡¨å•å¿…é¡»æä¾›å¯¹åº”çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå…¶å†…éƒ¨è¿˜æœ‰ç™»å½•æˆåŠŸæˆ–å¤±è´¥åè¿›è¡Œå¤„ç†çš„ AuthenticationSuccessHandler å’Œ AuthenticationFailureHandlerï¼Œè¿™äº›éƒ½å¯ä»¥æ ¹æ®éœ€æ±‚åšç›¸å…³æ”¹å˜ï¼›\r\n\r\n**FilterSecurityInterceptor** æ˜¯ç”¨äºä¿æŠ¤webèµ„æºçš„ï¼Œä½¿ç”¨AccessDecisionManagerå¯¹å½“å‰ç”¨æˆ·è¿›è¡Œæˆæƒè®¿é—®ï¼Œå‰é¢å·²ç»è¯¦ç»†ä»‹ç»è¿‡äº†ï¼›\r\n\r\n**ExceptionTranslationFilter** èƒ½å¤Ÿæ•è·æ¥è‡ª FilterChain æ‰€æœ‰çš„å¼‚å¸¸ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚ä½†æ˜¯å®ƒåªä¼šå¤„ç†ä¸¤ç±»å¼‚å¸¸ï¼šAuthenticationException å’Œ AccessDeniedExceptionï¼Œå…¶å®ƒçš„å¼‚å¸¸å®ƒä¼šç»§ç»­æŠ›å‡ºã€‚\r\n\r\n \r\n\r\nSpring Securityçš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps48.jpg) \r\n\r\n1. ç”¨æˆ·æäº¤ç”¨æˆ·åã€å¯†ç è¢«SecurityFilterChainä¸­çš„UsernamePasswordAuthenticationFilterè¿‡æ»¤å™¨è·å–åˆ°ï¼Œå°è£…ä¸ºè¯·æ±‚Authenticationï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯UsernamePasswordAuthenticationTokenè¿™ä¸ªå®ç°ç±»ã€‚\r\n\r\n2. ç„¶åè¿‡æ»¤å™¨å°†Authenticationæäº¤è‡³è®¤è¯ç®¡ç†å™¨ï¼ˆAuthenticationManagerï¼‰è¿›è¡Œè®¤è¯\r\n\r\n3. è®¤è¯æˆåŠŸåï¼ŒAuthenticationManagerèº«ä»½ç®¡ç†å™¨è¿”å›ä¸€ä¸ªè¢«å¡«å……æ»¡äº†ä¿¡æ¯çš„ï¼ˆåŒ…æ‹¬ä¸Šé¢æåˆ°çš„æƒé™ä¿¡æ¯ï¼Œèº«ä»½ä¿¡æ¯ï¼Œç»†èŠ‚ä¿¡æ¯ï¼Œä½†å¯†ç é€šå¸¸ä¼šè¢«ç§»é™¤ï¼‰Authenticationå®ä¾‹ã€‚\r\n\r\n4. SecurityContextHolderå®‰å…¨ä¸Šä¸‹æ–‡å®¹å™¨å°†ç¬¬3æ­¥å¡«å……äº†ä¿¡æ¯çš„Authenticationï¼Œé€šè¿‡`SecurityContextHolder.getContext().setAuthentication(â€¦)`æ–¹æ³•ï¼Œè®¾ç½®åˆ°å…¶ä¸­ã€‚\r\n\r\n5. å¯ä»¥çœ‹å‡ºAuthenticationManageræ¥å£ï¼ˆè®¤è¯ç®¡ç†å™¨ï¼‰æ˜¯è®¤è¯ç›¸å…³çš„æ ¸å¿ƒæ¥å£ï¼Œä¹Ÿæ˜¯å‘èµ·è®¤è¯çš„å‡ºå‘ç‚¹ï¼Œå®ƒçš„å®ç°ç±»ä¸ºProviderManagerã€‚è€ŒSpring Securityæ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼Œå› æ­¤ProviderManagerç»´æŠ¤ç€ä¸€ä¸ª`List<AuthenticationProvider>`åˆ—è¡¨ï¼Œå­˜æ”¾å¤šç§è®¤è¯æ–¹å¼ï¼Œæœ€ç»ˆå®é™…çš„è®¤è¯å·¥ä½œæ˜¯ç”±AuthenticationProviderå®Œæˆçš„ã€‚å’±ä»¬çŸ¥é“webè¡¨å•çš„å¯¹åº”çš„AuthenticationProviderå®ç°ç±»ä¸ºDaoAuthenticationProviderï¼Œå®ƒçš„å†…éƒ¨åˆç»´æŠ¤ç€ä¸€ä¸ªUserDetailsServiceè´Ÿè´£UserDetailsçš„è·å–ã€‚æœ€ç»ˆAuthenticationProviderå°†UserDetailså¡«å……è‡³Authenticationã€‚\r\n\r\n \r\n\r\n \r\n\r\n### **2.3 ä»€ä¹ˆæ˜¯OAuth2**\r\n\r\n#### **2.3.1 OAuth2è®¤è¯æµç¨‹**\r\n\r\nåœ¨å‰è¾¹æˆ‘ä»¬æåˆ°å¾®ä¿¡æ‰«ç è®¤è¯ï¼Œè¿™æ˜¯ä¸€ç§ç¬¬ä¸‰æ–¹è®¤è¯çš„æ–¹å¼ï¼Œè¿™ç§è®¤è¯æ–¹å¼æ˜¯åŸºäºOAuth2åè®®å®ç°ï¼Œ\r\n\r\nOAUTHåè®®ä¸ºç”¨æˆ·èµ„æºçš„æˆæƒæä¾›äº†ä¸€ä¸ªå®‰å…¨çš„ã€å¼€æ”¾è€Œåˆç®€æ˜“çš„æ ‡å‡†ã€‚åŒæ—¶ï¼Œä»»ä½•ç¬¬ä¸‰æ–¹éƒ½å¯ä»¥ä½¿ç”¨OAUTHè®¤è¯æœåŠ¡ï¼Œä»»ä½•æœåŠ¡æä¾›å•†éƒ½å¯ä»¥å®ç°è‡ªèº«çš„OAUTHè®¤è¯æœåŠ¡ï¼Œå› è€ŒOAUTHæ˜¯å¼€æ”¾çš„ã€‚ä¸šç•Œæä¾›äº†OAUTHçš„å¤šç§å®ç°å¦‚`PHPã€JavaScriptï¼ŒJavaï¼ŒRuby`ç­‰å„ç§è¯­è¨€å¼€å‘åŒ…ï¼Œå¤§å¤§èŠ‚çº¦äº†ç¨‹åºå‘˜çš„æ—¶é—´ï¼Œå› è€ŒOAUTHæ˜¯ç®€æ˜“çš„ã€‚äº’è”ç½‘å¾ˆå¤šæœåŠ¡å¦‚Open APIï¼Œå¾ˆå¤šå¤§å…¬å¸å¦‚`Googleï¼ŒYahooï¼ŒMicrosoft`ç­‰éƒ½æä¾›äº†OAUTHè®¤è¯æœåŠ¡ï¼Œè¿™äº›éƒ½è¶³ä»¥è¯´æ˜OAUTHæ ‡å‡†é€æ¸æˆä¸ºå¼€æ”¾èµ„æºæˆæƒçš„æ ‡å‡†ã€‚\r\n\r\nâ€‹    Oauthåè®®ç›®å‰å‘å±•åˆ°2.0ç‰ˆæœ¬ï¼Œ1.0ç‰ˆæœ¬è¿‡äºå¤æ‚ï¼Œ2.0ç‰ˆæœ¬å·²å¾—åˆ°å¹¿æ³›åº”ç”¨ã€‚\r\n\r\nå‚è€ƒï¼šhttps://baike.baidu.com/item/oAuth/7153134?fr=aladdin\r\n\r\nOauthåè®®ï¼šhttps://tools.ietf.org/html/rfc6749\r\n\r\nä¸‹è¾¹åˆ†æä¸€ä¸ªOauth2è®¤è¯çš„ä¾‹å­ï¼Œé»‘é©¬ç¨‹åºå‘˜ç½‘ç«™ä½¿ç”¨å¾®ä¿¡è®¤è¯æ‰«ç ç™»å½•çš„è¿‡ç¨‹ï¼š\r\n\r\n![image-20230705222917841](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705222917841.png) \r\n\r\nå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n1ã€ç”¨æˆ·ç‚¹å‡»å¾®ä¿¡æ‰«ç \r\n\r\nç”¨æˆ·è¿›å…¥é»‘é©¬ç¨‹åºçš„ç™»å½•é¡µé¢ï¼Œç‚¹å‡»å¾®ä¿¡çš„å›¾æ ‡å¼€æ‰“å¾®ä¿¡æ‰«ç ç•Œé¢ã€‚\r\n\r\n \r\n\r\n![image-20230705223020201](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223020201.png) \r\n\r\n![image-20230705223055747](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223055747.png) \r\n\r\n \r\n\r\nå¾®ä¿¡æ‰«ç çš„ç›®çš„æ˜¯é€šè¿‡å¾®ä¿¡è®¤è¯ç™»å½•é»‘é©¬ç¨‹åºå‘˜å®˜ç½‘ï¼Œé»‘é©¬ç¨‹åºå‘˜ç½‘ç«™éœ€è¦ä»å¾®ä¿¡è·å–å½“å‰ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯æ‰ä¼šè®©å½“å‰ç”¨æˆ·åœ¨é»‘é©¬ç½‘ç«™ç™»å½•æˆåŠŸã€‚\r\n\r\nç°åœ¨ææ¸…æ¥šå‡ ä¸ªæ¦‚å¿µï¼š\r\n\r\nèµ„æºï¼šç”¨æˆ·ä¿¡æ¯ï¼Œåœ¨å¾®ä¿¡ä¸­å­˜å‚¨ã€‚\r\n\r\nèµ„æºæ‹¥æœ‰è€…ï¼šç”¨æˆ·æ˜¯ç”¨æˆ·ä¿¡æ¯èµ„æºçš„æ‹¥æœ‰è€…ã€‚\r\n\r\nè®¤è¯æœåŠ¡ï¼šå¾®ä¿¡è´Ÿè´£è®¤è¯å½“å‰ç”¨æˆ·çš„èº«ä»½ï¼Œè´Ÿè´£ä¸ºå®¢æˆ·ç«¯é¢å‘ä»¤ç‰Œã€‚\r\n\r\nå®¢æˆ·ç«¯ï¼šå®¢æˆ·ç«¯ä¼šæºå¸¦ä»¤ç‰Œè¯·æ±‚å¾®ä¿¡è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œé»‘é©¬ç¨‹åºå‘˜ç½‘ç«™å³å®¢æˆ·ç«¯ï¼Œé»‘é©¬ç½‘ç«™éœ€è¦åœ¨æµè§ˆå™¨æ‰“å¼€ã€‚\r\n\r\n2ã€ç”¨æˆ·æˆæƒé»‘é©¬ç½‘ç«™è®¿é—®ç”¨æˆ·ä¿¡æ¯\r\n\r\nèµ„æºæ‹¥æœ‰è€…æ‰«æäºŒç»´ç è¡¨ç¤ºèµ„æºæ‹¥æœ‰è€…è¯·æ±‚å¾®ä¿¡è¿›è¡Œè®¤è¯ï¼Œå¾®ä¿¡è®¤è¯é€šè¿‡å‘ç”¨æˆ·æ‰‹æœºè¿”å›æˆæƒé¡µé¢ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![image-20230705223223906](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223223906.png) \r\n\r\nè¯¢é—®ç”¨æˆ·æ˜¯å¦æˆæƒé»‘é©¬ç¨‹åºå‘˜è®¿é—®è‡ªå·±åœ¨å¾®ä¿¡çš„ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·ç‚¹å‡»â€œç¡®è®¤ç™»å½•â€è¡¨ç¤ºåŒæ„æˆæƒï¼Œå¾®ä¿¡è®¤è¯æœåŠ¡å™¨ä¼šé¢å‘ä¸€ä¸ªæˆæƒç ç»™é»‘é©¬ç¨‹åºå‘˜çš„ç½‘ç«™ã€‚\r\n\r\nåªæœ‰èµ„æºæ‹¥æœ‰è€…åŒæ„å¾®ä¿¡æ‰å…è®¸é»‘é©¬ç½‘ç«™è®¿é—®èµ„æºã€‚\r\n\r\n3ã€é»‘é©¬ç¨‹åºå‘˜çš„ç½‘ç«™è·å–åˆ°æˆæƒç \r\n\r\n4ã€æºå¸¦æˆæƒç è¯·æ±‚å¾®ä¿¡è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œ\r\n\r\næ­¤äº¤äº’è¿‡ç¨‹ç”¨æˆ·çœ‹ä¸åˆ°ã€‚\r\n\r\n5ã€å¾®ä¿¡è®¤è¯æœåŠ¡å™¨å‘é»‘é©¬ç¨‹åºå‘˜çš„ç½‘ç«™å“åº”ä»¤ç‰Œ\r\n\r\næ­¤äº¤äº’è¿‡ç¨‹ç”¨æˆ·çœ‹ä¸åˆ°ã€‚\r\n\r\n6ã€é»‘é©¬ç¨‹åºå‘˜ç½‘ç«™è¯·æ±‚å¾®ä¿¡èµ„æºæœåŠ¡å™¨è·å–èµ„æºå³ç”¨æˆ·ä¿¡æ¯ã€‚\r\n\r\né»‘é©¬ç¨‹åºå‘˜ç½‘ç«™æºå¸¦ä»¤ç‰Œè¯·æ±‚è®¿é—®å¾®ä¿¡æœåŠ¡å™¨è·å–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ã€‚\r\n\r\n7ã€èµ„æºæœåŠ¡å™¨è¿”å›å—ä¿æŠ¤èµ„æºå³ç”¨æˆ·ä¿¡æ¯\r\n\r\n8ã€é»‘é©¬ç½‘ç«™æ¥æ”¶åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œæ­¤æ—¶ç”¨æˆ·åœ¨é»‘é©¬ç½‘ç«™ç™»å½•æˆåŠŸã€‚\r\n\r\nç†è§£äº†å¾®ä¿¡æ‰«ç ç™»å½•é»‘é©¬ç½‘ç«™çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥è®¤è¯†Oauth2.0çš„è®¤è¯æµç¨‹ï¼Œå¦‚ä¸‹ï¼š\r\n\r\nå¼•è‡ªOauth2.0åè®®rfc6749 https://tools.ietf.org/html/rfc6749\r\n\r\n![image-20230705223310223](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223310223.png) \r\n\r\nOauth2åŒ…æ‹¬ä»¥ä¸‹è§’è‰²ï¼š\r\n\r\n1ã€å®¢æˆ·ç«¯\r\n\r\næœ¬èº«ä¸å­˜å‚¨èµ„æºï¼Œéœ€è¦é€šè¿‡èµ„æºæ‹¥æœ‰è€…çš„æˆæƒå»è¯·æ±‚èµ„æºæœåŠ¡å™¨çš„èµ„æºï¼Œæ¯”å¦‚ï¼šæ‰‹æœºå®¢æˆ·ç«¯ã€æµè§ˆå™¨ç­‰ã€‚\r\n\r\nä¸Šè¾¹ç¤ºä¾‹ä¸­é»‘é©¬ç½‘ç«™å³ä¸ºå®¢æˆ·ç«¯ï¼Œå®ƒéœ€è¦é€šè¿‡æµè§ˆå™¨æ‰“å¼€ã€‚\r\n\r\n2ã€èµ„æºæ‹¥æœ‰è€…\r\n\r\né€šå¸¸ä¸ºç”¨æˆ·ï¼Œä¹Ÿå¯ä»¥æ˜¯åº”ç”¨ç¨‹åºï¼Œå³è¯¥èµ„æºçš„æ‹¥æœ‰è€…ã€‚\r\n\r\nAè¡¨ç¤º å®¢æˆ·ç«¯è¯·æ±‚èµ„æºæ‹¥æœ‰è€…æˆæƒã€‚\r\n\r\nBè¡¨ç¤º èµ„æºæ‹¥æœ‰è€…æˆæƒå®¢æˆ·ç«¯å³é»‘é©¬ç½‘ç«™è®¿é—®è‡ªå·±çš„ç”¨æˆ·ä¿¡æ¯ã€‚\r\n\r\n3ã€æˆæƒæœåŠ¡å™¨ï¼ˆä¹Ÿç§°è®¤è¯æœåŠ¡å™¨ï¼‰\r\n\r\nè®¤è¯æœåŠ¡å™¨å¯¹èµ„æºæ‹¥æœ‰è€…è¿›è¡Œè®¤è¯ï¼Œè¿˜ä¼šå¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯å¹¶é¢å‘ä»¤ç‰Œã€‚\r\n\r\nC å®¢æˆ·ç«¯å³é»‘é©¬ç½‘ç«™æºå¸¦æˆæƒç è¯·æ±‚è®¤è¯ã€‚\r\n\r\nDè®¤è¯é€šè¿‡é¢å‘ä»¤ç‰Œã€‚\r\n\r\n4ã€èµ„æºæœåŠ¡å™¨\r\n\r\nå­˜å‚¨èµ„æºçš„æœåŠ¡å™¨ã€‚\r\n\r\nEè¡¨ç¤ºå®¢æˆ·ç«¯å³é»‘é©¬ç½‘ç«™æºå¸¦ä»¤ç‰Œè¯·æ±‚èµ„æºæœåŠ¡å™¨è·å–èµ„æºã€‚\r\n\r\nFè¡¨ç¤ºèµ„æºæœåŠ¡å™¨æ ¡éªŒä»¤ç‰Œé€šè¿‡åæä¾›å—ä¿æŠ¤èµ„æºã€‚\r\n\r\n \r\n\r\n#### **2.3.2 OAuth2åœ¨æœ¬é¡¹ç›®çš„åº”ç”¨**\r\n\r\nOauth2æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å¼€æ”¾çš„æˆæƒåè®®ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®è‡ªå·±çš„è¦æ±‚å»ä½¿ç”¨Oauth2ï¼Œæœ¬é¡¹ç›®ä½¿ç”¨Oauth2å®ç°å¦‚ä¸‹ç›®æ ‡ï¼š\r\n\r\n1ã€å­¦æˆåœ¨çº¿è®¿é—®ç¬¬ä¸‰æ–¹ç³»ç»Ÿçš„èµ„æºã€‚\r\n\r\næœ¬é¡¹ç›®è¦æ¥å…¥å¾®ä¿¡æ‰«ç ç™»å½•æ‰€ä»¥æœ¬é¡¹ç›®è¦ä½¿ç”¨OAuth2åè®®è®¿é—®å¾®ä¿¡ä¸­çš„ç”¨æˆ·ä¿¡æ¯ã€‚\r\n\r\n2ã€å¤–éƒ¨ç³»ç»Ÿè®¿é—®å­¦æˆåœ¨çº¿çš„èµ„æº  ã€‚\r\n\r\nåŒæ ·å½“ç¬¬ä¸‰æ–¹ç³»ç»Ÿæƒ³è¦è®¿é—®å­¦æˆåœ¨çº¿ç½‘ç«™çš„èµ„æºä¹Ÿå¯ä»¥åŸºäºOAuth2åè®®ã€‚\r\n\r\n3ã€å­¦æˆåœ¨çº¿å‰ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰ è®¿é—®å­¦æˆåœ¨çº¿å¾®æœåŠ¡çš„èµ„æºã€‚\r\n\r\næœ¬é¡¹ç›®æ˜¯å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œå‰ç«¯è®¿é—®å¾®æœåŠ¡èµ„æºä¹Ÿå¯ä»¥åŸºäºOAuth2åè®®è¿›è¡Œè®¤è¯ã€‚\r\n\r\n \r\n\r\n#### **2.3.3 OAuth2çš„æˆæƒæ¨¡å¼**\r\n\r\nSpring Securityæ”¯æŒOAuth2è®¤è¯ï¼ŒOAuth2æä¾›æˆæƒç æ¨¡å¼ã€å¯†ç æ¨¡å¼ã€ç®€åŒ–æ¨¡å¼ã€å®¢æˆ·ç«¯æ¨¡å¼ç­‰å››ç§æˆæƒæ¨¡å¼ï¼Œå‰è¾¹ä¸¾çš„å¾®ä¿¡æ‰«ç ç™»å½•çš„ä¾‹å­å°±æ˜¯åŸºäºæˆæƒç æ¨¡å¼ï¼Œè¿™å››ç§æ¨¡å¼ä¸­æˆæƒç æ¨¡å¼å’Œå¯†ç æ¨¡å¼åº”ç”¨è¾ƒå¤šï¼Œæœ¬èŠ‚ä½¿ç”¨Spring Securityæ¼”ç¤ºæˆæƒç æ¨¡å¼ã€å¯†ç æ¨¡å¼ï¼Œå…¶ä½™ä¸¤ç§è¯·è‡ªè¡ŒæŸ¥é˜…ç›¸å…³èµ„æ–™ã€‚\r\n\r\n##### **2.3.3.1 æˆæƒç æ¨¡å¼**\r\n\r\nOAuth2çš„å‡ ä¸ªæˆæƒæ¨¡å¼æ˜¯æ ¹æ®ä¸åŒçš„åº”ç”¨åœºæ™¯ä»¥ä¸åŒçš„æ–¹å¼å»è·å–ä»¤ç‰Œï¼Œæœ€ç»ˆç›®çš„æ˜¯è¦è·å–è®¤è¯æœåŠ¡é¢å‘çš„ä»¤ç‰Œï¼Œæœ€ç»ˆé€šè¿‡ä»¤ç‰Œå»è·å–èµ„æºã€‚\r\n\r\næˆæƒç æ¨¡å¼ç®€å•ç†è§£æ˜¯ä½¿ç”¨æˆæƒç å»è·å–ä»¤ç‰Œï¼Œè¦æƒ³è·å–ä»¤ç‰Œå…ˆè¦è·å–æˆæƒç ï¼Œæˆæƒç çš„è·å–éœ€è¦èµ„æºæ‹¥æœ‰è€…äº²è‡ªæˆæƒåŒæ„æ‰å¯ä»¥è·å–ã€‚\r\n\r\nä¸‹å›¾æ˜¯æˆæƒç æ¨¡å¼çš„äº¤äº’å›¾ï¼š\r\n\r\n![image-20230705223355846](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223355846.png) \r\n\r\nè¿˜ä»¥é»‘é©¬ç½‘ç«™å¾®ä¿¡æ‰«ç ç™»å½•ä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼š\r\n\r\n1ã€ç”¨æˆ·æ‰“å¼€æµè§ˆå™¨ã€‚\r\n\r\n2ã€é€šè¿‡æµè§ˆå™¨è®¿é—®å®¢æˆ·ç«¯å³é»‘é©¬ç½‘ç«™ã€‚\r\n\r\n3ã€ç”¨æˆ·é€šè¿‡æµè§ˆå™¨å‘è®¤è¯æœåŠ¡è¯·æ±‚æˆæƒï¼Œè¯·æ±‚æˆæƒæ—¶ä¼šæºå¸¦å®¢æˆ·ç«¯çš„URLï¼Œæ­¤URLä¸ºä¸‹å‘æˆæƒç çš„é‡å®šå‘åœ°å€ã€‚\r\n\r\n4ã€è®¤è¯æœåŠ¡å‘èµ„æºæ‹¥æœ‰è€…è¿”å›æˆæƒé¡µé¢ã€‚\r\n\r\n5ã€èµ„æºæ‹¥æœ‰è€…äº²è‡ªæˆæƒåŒæ„ã€‚\r\n\r\n6ã€é€šè¿‡æµè§ˆå™¨å‘è®¤è¯æœåŠ¡å‘é€æˆæƒåŒæ„ã€‚\r\n\r\n7ã€è®¤è¯æœåŠ¡å‘å®¢æˆ·ç«¯åœ°å€é‡å®šå‘å¹¶æºå¸¦æˆæƒç ã€‚\r\n\r\n8ã€å®¢æˆ·ç«¯å³é»‘é©¬ç½‘ç«™æ”¶åˆ°æˆæƒç ã€‚\r\n\r\n9ã€å®¢æˆ·ç«¯æºå¸¦æˆæƒç å‘è®¤è¯æœåŠ¡ç”³è¯·ä»¤ç‰Œã€‚\r\n\r\n10ã€è®¤è¯æœåŠ¡å‘å®¢æˆ·ç«¯é¢å‘ä»¤ç‰Œã€‚\r\n\r\n \r\n\r\n##### **2.3.3.2æˆæƒç æ¨¡å¼æµ‹è¯•**\r\n\r\nè¦æƒ³æµ‹è¯•æˆæƒæ¨¡å¼é¦–å…ˆè¦é…ç½®æˆæƒæœåŠ¡å™¨å³ä¸Šå›¾ä¸­çš„è®¤è¯æœåŠ¡å™¨ï¼Œéœ€è¦é…ç½®æˆæƒæœåŠ¡åŠä»¤ç‰Œç­–ç•¥ã€‚\r\n\r\n1ã€ä»è¯¾ç¨‹èµ„æ–™ä¸­æ‹·è´ `AuthorizationServer.javaã€TokenConfig.java`åˆ°è®¤è¯æœåŠ¡çš„configåŒ…ä¸‹ã€‚\r\n\r\n> è¯´æ˜ï¼šAuthorizationServerç”¨ `@EnableAuthorizationServer` æ³¨è§£æ ‡è¯†å¹¶ç»§æ‰¿AuthorizationServerConfigurerAdapteræ¥é…ç½®OAuth2.0 æˆæƒæœåŠ¡å™¨ã€‚\r\n\r\n```java\r\n\r\n @Configuration\r\n @EnableAuthorizationServer\r\n public class AuthorizationServer extends AuthorizationServerConfigurerAdapter {\r\n ...\r\n \r\n```\r\n\r\nAuthorizationServerConfigurerAdapterè¦æ±‚é…ç½®ä»¥ä¸‹å‡ ä¸ªç±»ï¼š\r\n\r\n```java\r\n\r\npublic class AuthorizationServerConfigurerAdapter implements AuthorizationServerConfigurer {\r\n    public AuthorizationServerConfigurerAdapter() {}\r\n    public void configure(AuthorizationServerSecurityConfigurer security) throws Exception {}\r\n    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {}\r\n    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {}\r\n}\r\n```\r\n\r\n**1ï¼‰ClientDetailsServiceConfigurer**ï¼šç”¨æ¥é…ç½®å®¢æˆ·ç«¯è¯¦æƒ…æœåŠ¡ï¼ˆClientDetailsServiceï¼‰ï¼Œ\r\n\r\néšä¾¿ä¸€ä¸ªå®¢æˆ·ç«¯éƒ½å¯ä»¥éšä¾¿æ¥å…¥åˆ°å®ƒçš„è®¤è¯æœåŠ¡å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼ŒæœåŠ¡æä¾›å•†ä¼šç»™æ‰¹å‡†æ¥å…¥çš„å®¢æˆ·ç«¯ä¸€ä¸ªèº«ä»½ï¼Œç”¨äºæ¥å…¥æ—¶çš„å‡­æ®ï¼Œæœ‰å®¢æˆ·ç«¯æ ‡è¯†å’Œå®¢æˆ·ç«¯ç§˜é’¥ï¼Œåœ¨è¿™é‡Œé…ç½®æ‰¹å‡†æ¥å…¥çš„å®¢æˆ·ç«¯çš„è¯¦ç»†ä¿¡æ¯ã€‚\r\n\r\n**2ï¼‰AuthorizationServerEndpointsConfigurer**ï¼šç”¨æ¥é…ç½®ä»¤ç‰Œï¼ˆtokenï¼‰çš„è®¿é—®ç«¯ç‚¹å’Œä»¤ç‰ŒæœåŠ¡(token services)ã€‚\r\n\r\n**3ï¼‰AuthorizationServerSecurityConfigurer**ï¼šç”¨æ¥é…ç½®ä»¤ç‰Œç«¯ç‚¹çš„å®‰å…¨çº¦æŸ.\r\n\r\n**2ã€TokenConfigä¸ºä»¤ç‰Œç­–ç•¥é…ç½®ç±»**\r\n\r\næš‚æ—¶å…ˆä½¿ç”¨InMemoryTokenStoreåœ¨å†…å­˜å­˜å‚¨ä»¤ç‰Œï¼Œä»¤ç‰Œçš„æœ‰æ•ˆæœŸç­‰ä¿¡æ¯é…ç½®å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n    //ä»¤ç‰Œç®¡ç†æœåŠ¡\r\n    @Bean(name=\"authorizationServerTokenServicesCustom\")\r\n    public AuthorizationServerTokenServices tokenService() {\r\n        DefaultTokenServices service=new DefaultTokenServices();\r\n        service.setSupportRefreshToken(true);//æ”¯æŒåˆ·æ–°ä»¤ç‰Œ\r\n        service.setTokenStore(tokenStore);//ä»¤ç‰Œå­˜å‚¨ç­–ç•¥\r\n        service.setAccessTokenValiditySeconds(7200); // ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ2å°æ—¶\r\n        service.setRefreshTokenValiditySeconds(259200); // åˆ·æ–°ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ3å¤©\r\n        return service;\r\n    }\r\n```\r\n\r\n3ã€é…ç½®è®¤è¯ç®¡ç†bean\r\n\r\n```java\r\n\r\n@EnableWebSecurity\r\n@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)\r\npublic class WebSecurityConfig extends WebSecurityConfigurerAdapter {\r\n\r\n    @Bean\r\n    public AuthenticationManager authenticationManagerBean() throws Exception {\r\n        return super.authenticationManagerBean();\r\n    }\r\n    ....\r\n```\r\n\r\né‡å¯è®¤è¯æœåŠ¡\r\n\r\n1ã€getè¯·æ±‚è·å–æˆæƒç \r\n\r\nåœ°å€: `http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&response_type=code&scope=all&redirect_uri=http://www.51xuecheng.cn`\r\n\r\nå‚æ•°åˆ—è¡¨å¦‚ä¸‹ï¼š\r\n\r\nâ€¢ `client_id`ï¼šå®¢æˆ·ç«¯å‡†å…¥æ ‡è¯†ã€‚\r\n\r\nâ€¢ `response_type`ï¼šæˆæƒç æ¨¡å¼å›ºå®šä¸ºcodeã€‚\r\n\r\nâ€¢ `scope`ï¼šå®¢æˆ·ç«¯æƒé™ã€‚\r\n\r\nâ€¢ `redirect_uri`ï¼šè·³è½¬uriï¼Œå½“æˆæƒç ç”³è¯·æˆåŠŸåä¼šè·³è½¬åˆ°æ­¤åœ°å€ï¼Œå¹¶åœ¨åè¾¹å¸¦ä¸Šcodeå‚æ•°ï¼ˆæˆæƒç ï¼‰ã€‚\r\n\r\nè¾“å…¥è´¦å·zhangsanã€å¯†ç 123ç™»å½•æˆåŠŸï¼Œè¾“å…¥`/oauth/authorize?client_id=XcWebApp&response_type=code&scope=all&redirect_uri=http://www.51xuecheng.cn`\r\n\r\næ˜¾ç¤ºæˆæƒé¡µé¢\r\n\r\n![image-20230705223440333](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223440333.png) \r\n\r\næˆæƒâ€œXcWebAppâ€è®¿é—®è‡ªå·±çš„å—ä¿æŠ¤èµ„æº?\r\n\r\né€‰æ‹©åŒæ„ã€‚\r\n\r\n2ã€è¯·æ±‚æˆåŠŸï¼Œé‡å®šå‘è‡³`http://www.51xuecheng.cn/?code=æˆæƒç `ï¼Œæ¯”å¦‚ï¼š`http://www.51xuecheng.cn/?code=Wqjb5H`\r\n\r\n3ã€ä½¿ç”¨httpclientå·¥å…·postç”³è¯·ä»¤ç‰Œ\r\n\r\n`/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=authorization_code&code=æˆæƒç &redirect_uri=http://www.51xuecheng.cn/`\r\n\r\nå‚æ•°åˆ—è¡¨å¦‚ä¸‹\r\n\r\nâ€¢ `client_id`ï¼šå®¢æˆ·ç«¯å‡†å…¥æ ‡è¯†ã€‚\r\n\r\nâ€¢ `client_secret`ï¼šå®¢æˆ·ç«¯ç§˜é’¥ã€‚\r\n\r\nâ€¢ `grant_type`ï¼šæˆæƒç±»å‹ï¼Œå¡«å†™authorization_codeï¼Œè¡¨ç¤ºæˆæƒç æ¨¡å¼\r\n\r\nâ€¢ `code`ï¼šæˆæƒç ï¼Œå°±æ˜¯åˆšåˆšè·å–çš„æˆæƒç ï¼Œæ³¨æ„ï¼šæˆæƒç åªä½¿ç”¨ä¸€æ¬¡å°±æ— æ•ˆäº†ï¼Œéœ€è¦é‡æ–°ç”³è¯·ã€‚\r\n\r\nâ€¢ `redirect_uri`ï¼šç”³è¯·æˆæƒç æ—¶çš„è·³è½¬urlï¼Œä¸€å®šå’Œç”³è¯·æˆæƒç æ—¶ç”¨çš„redirect_uriä¸€è‡´ã€‚\r\n\r\nhttpclientè„šæœ¬å¦‚ä¸‹ï¼š\r\n\r\n```http\r\n### æˆæƒç æ¨¡å¼\r\n### ç¬¬ä¸€æ­¥ç”³è¯·æˆæƒç (æµè§ˆå™¨è¯·æ±‚)/oauth/authorize?client_id=c1&response_type=code&scope=all&redirect_uri=http://www.51xuecheng.cn\r\n### ç¬¬äºŒæ­¥ç”³è¯·ä»¤ç‰Œ\r\nPOST {{auth_host}}/auth/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=authorization_code&code=CTvCrB&redirect_uri=http://www.51xuecheng.cn\r\n```\r\n\r\nç”³è¯·ä»¤ç‰ŒæˆåŠŸå¦‚ä¸‹æ‰€ç¤ºï¼š\r\n\r\n```json\r\n\r\n{\r\n  \"access_token\": \"368b1ee7-a9ee-4e9a-aae6-0fcab243aad2\",\r\n  \"token_type\": \"bearer\",\r\n  \"refresh_token\": \"3d56e139-0ee6-4ace-8cbe-1311dfaa991f\",\r\n  \"expires_in\": 7199,\r\n  \"scope\": \"all\"\r\n}\r\n```\r\n\r\nè¯´æ˜ï¼š\r\n\r\n1ã€`access_token`ï¼Œè®¿é—®ä»¤ç‰Œï¼Œç”¨äºè®¿é—®èµ„æºä½¿ç”¨ã€‚\r\n\r\n2ã€`token_type`ï¼Œbeareræ˜¯åœ¨RFC6750ä¸­å®šä¹‰çš„ä¸€ç§tokenç±»å‹ï¼Œåœ¨æºå¸¦ä»¤ç‰Œè®¿é—®èµ„æºæ—¶éœ€è¦åœ¨headä¸­åŠ å…¥bearer ç©ºæ ¼ ä»¤ç‰Œå†…å®¹\r\n\r\n3ã€`refresh_token`ï¼Œå½“ä»¤ç‰Œå¿«è¿‡æœŸæ—¶ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œå¯ä»¥å†æ¬¡ç”Ÿæˆä»¤ç‰Œã€‚\r\n\r\n4ã€`expires_in`ï¼šè¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰\r\n\r\n5ã€`scope`ï¼šä»¤ç‰Œçš„æƒé™èŒƒå›´ï¼ŒæœåŠ¡ç«¯å¯ä»¥æ ¹æ®ä»¤ç‰Œçš„æƒé™èŒƒå›´å»å¯¹ä»¤ç‰Œæˆæƒã€‚\r\n\r\n \r\n\r\n##### **2.3.3.3 å¯†ç æ¨¡å¼**\r\n\r\nå¯†ç æ¨¡å¼ç›¸å¯¹æˆæƒç æ¨¡å¼ç®€å•ï¼Œæˆæƒç æ¨¡å¼éœ€è¦å€ŸåŠ©æµè§ˆå™¨ä¾›ç”¨æˆ·äº²è‡ªæˆæƒï¼Œå¯†ç æ¨¡å¼ä¸ç”¨å€ŸåŠ©æµè§ˆå™¨ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![image-20230705223503678](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223503678.png) \r\n\r\n1ã€èµ„æºæ‹¥æœ‰è€…æä¾›è´¦å·å’Œå¯†ç \r\n\r\n2ã€å®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡ç”³è¯·ä»¤ç‰Œï¼Œè¯·æ±‚ä¸­æºå¸¦è´¦å·å’Œå¯†ç \r\n\r\n3ã€è®¤è¯æœåŠ¡æ ¡éªŒè´¦å·å’Œå¯†ç æ­£ç¡®é¢å‘ä»¤ç‰Œã€‚\r\n\r\nå¼€å§‹æµ‹è¯•ï¼š\r\n\r\n1ã€POSTè¯·æ±‚è·å–ä»¤ç‰Œ\r\n\r\n`/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=password&username=shangsan&password=123`\r\n\r\nå‚æ•°åˆ—è¡¨å¦‚ä¸‹ï¼š\r\n\r\n- `client_id`ï¼šå®¢æˆ·ç«¯å‡†å…¥æ ‡è¯†ã€‚\r\n- `client_secret`ï¼šå®¢æˆ·ç«¯ç§˜é’¥ã€‚\r\n- `grant_type`ï¼šæˆæƒç±»å‹ï¼Œå¡«å†™passwordè¡¨ç¤ºå¯†ç æ¨¡å¼\r\n- `username`ï¼šèµ„æºæ‹¥æœ‰è€…ç”¨æˆ·åã€‚\r\n- `password`ï¼šèµ„æºæ‹¥æœ‰è€…å¯†ç ã€‚\r\n\r\n2ã€æˆæƒæœåŠ¡å™¨å°†ä»¤ç‰Œï¼ˆ`access_token`ï¼‰å‘é€ç»™client\r\n\r\nä½¿ç”¨httpclientè¿›è¡Œæµ‹è¯•\r\n\r\n```http\r\n### å¯†ç æ¨¡å¼\r\nPOST {{auth_host}}/auth/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=password&username=zhangsan&password=123\r\n```\r\n\r\nè¿”å›ç¤ºä¾‹ï¼š\r\n\r\n```json\r\n\r\n{\r\n  \"access_token\": \"368b1ee7-a9ee-4e9a-aae6-0fcab243aad2\",\r\n  \"token_type\": \"bearer\",\r\n  \"refresh_token\": \"3d56e139-0ee6-4ace-8cbe-1311dfaa991f\",\r\n  \"expires_in\": 6806,\r\n  \"scope\": \"all\"\r\n}\r\n```\r\n\r\nâ€‹    è¿™ç§æ¨¡å¼ååˆ†ç®€å•ï¼Œä½†æ˜¯å´æ„å‘³ç€ç›´æ¥å°†ç”¨æˆ·æ•æ„Ÿä¿¡æ¯æ³„æ¼ç»™äº†clientï¼Œå› æ­¤è¿™å°±è¯´æ˜è¿™ç§æ¨¡å¼åªèƒ½ç”¨äºclientæ˜¯æˆ‘ä»¬è‡ªå·±å¼€å‘çš„æƒ…å†µä¸‹ã€‚\r\n\r\n##### **2.3.3.4 æœ¬é¡¹ç›®çš„åº”ç”¨æ–¹å¼**\r\n\r\né€šè¿‡æ¼”ç¤ºæˆæƒç æ¨¡å¼å’Œå¯†ç æ¨¡å¼ï¼Œæˆæƒç æ¨¡å¼é€‚åˆå®¢æˆ·ç«¯å’Œè®¤è¯æœåŠ¡éåŒä¸€ä¸ªç³»ç»Ÿçš„æƒ…å†µï¼Œæ‰€ä»¥æœ¬é¡¹ç›®ä½¿ç”¨æˆæƒç æ¨¡å¼å®Œæˆå¾®ä¿¡æ‰«ç è®¤è¯ã€‚æœ¬é¡¹ç›®é‡‡ç”¨å¯†ç æ¨¡å¼ä½œä¸ºå‰ç«¯è¯·æ±‚å¾®æœåŠ¡çš„è®¤è¯æ–¹å¼ã€‚\r\n\r\n \r\n\r\n### **2.4 JWT**\r\n\r\n#### **2.4.1 æ™®é€šä»¤ç‰Œçš„é—®é¢˜**\r\n\r\nå®¢æˆ·ç«¯ç”³è¯·åˆ°ä»¤ç‰Œï¼Œæ¥ä¸‹æ¥å®¢æˆ·ç«¯æºå¸¦ä»¤ç‰Œå»è®¿é—®èµ„æºï¼Œåˆ°èµ„æºæœåŠ¡å™¨å°†ä¼šæ ¡éªŒä»¤ç‰Œçš„åˆæ³•æ€§ã€‚\r\n\r\nèµ„æºæœåŠ¡å™¨å¦‚ä½•æ ¡éªŒä»¤ç‰Œçš„åˆæ³•æ€§ï¼Ÿ\r\n\r\næˆ‘ä»¬ä»¥OAuth2çš„å¯†ç æ¨¡å¼ä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼š\r\n\r\n![image-20230705223542073](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223542073.png) \r\n\r\nä»ç¬¬4æ­¥å¼€å§‹è¯´æ˜ï¼š\r\n\r\n1ã€å®¢æˆ·ç«¯æºå¸¦ä»¤ç‰Œè®¿é—®èµ„æºæœåŠ¡è·å–èµ„æºã€‚\r\n\r\n2ã€èµ„æºæœåŠ¡è¿œç¨‹è¯·æ±‚è®¤è¯æœåŠ¡æ ¡éªŒä»¤ç‰Œçš„åˆæ³•æ€§\r\n\r\n3ã€å¦‚æœä»¤ç‰Œåˆæ³•èµ„æºæœåŠ¡å‘å®¢æˆ·ç«¯è¿”å›èµ„æºã€‚\r\n\r\nè¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼š\r\n\r\nå°±æ˜¯æ ¡éªŒä»¤ç‰Œéœ€è¦è¿œç¨‹è¯·æ±‚è®¤è¯æœåŠ¡ï¼Œå®¢æˆ·ç«¯çš„æ¯æ¬¡è®¿é—®éƒ½ä¼šè¿œç¨‹æ ¡éªŒï¼Œæ‰§è¡Œæ€§èƒ½ä½ã€‚\r\n\r\nå¦‚æœèƒ½å¤Ÿè®©èµ„æºæœåŠ¡è‡ªå·±æ ¡éªŒä»¤ç‰Œçš„åˆæ³•æ€§å°†çœå»è¿œç¨‹è¯·æ±‚è®¤è¯æœåŠ¡çš„æˆæœ¬ï¼Œæé«˜äº†æ€§èƒ½ã€‚å¦‚ä¸‹å›¾ï¼š\r\n\r\n![image-20230705223607439](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223607439.png) \r\n\r\nå¦‚ä½•è§£å†³ä¸Šè¾¹çš„é—®é¢˜ï¼Œå®ç°èµ„æºæœåŠ¡è‡ªè¡Œæ ¡éªŒä»¤ç‰Œã€‚\r\n\r\nä»¤ç‰Œé‡‡ç”¨JWTæ ¼å¼å³å¯è§£å†³ä¸Šè¾¹çš„é—®é¢˜ï¼Œç”¨æˆ·è®¤è¯é€šè¿‡åä¼šå¾—åˆ°ä¸€ä¸ªJWTä»¤ç‰Œï¼ŒJWTä»¤ç‰Œä¸­å·²ç»åŒ…æ‹¬äº†ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯åªéœ€è¦æºå¸¦JWTè®¿é—®èµ„æºæœåŠ¡ï¼Œèµ„æºæœåŠ¡æ ¹æ®äº‹å…ˆçº¦å®šçš„ç®—æ³•è‡ªè¡Œå®Œæˆä»¤ç‰Œæ ¡éªŒï¼Œæ— éœ€æ¯æ¬¡éƒ½è¯·æ±‚è®¤è¯æœåŠ¡å®Œæˆæˆæƒã€‚\r\n\r\n \r\n\r\n#### **2.4.2 ä»€ä¹ˆæ˜¯JWT**\r\n\r\nä»€ä¹ˆæ˜¯JWTï¼Ÿ\r\n\r\nJSON Web Tokenï¼ˆJWTï¼‰æ˜¯ä¸€ç§ä½¿ç”¨JSONæ ¼å¼ä¼ é€’æ•°æ®çš„ç½‘ç»œä»¤ç‰ŒæŠ€æœ¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼€æ”¾çš„è¡Œä¸šæ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç®€æ´çš„ã€è‡ªåŒ…å«çš„åè®®æ ¼å¼ï¼Œç”¨äºåœ¨é€šä¿¡åŒæ–¹ä¼ é€’jsonå¯¹è±¡ï¼Œä¼ é€’çš„ä¿¡æ¯ç»è¿‡æ•°å­—ç­¾åå¯ä»¥è¢«éªŒè¯å’Œä¿¡ä»»ï¼Œå®ƒå¯ä»¥ä½¿ç”¨HMACç®—æ³•æˆ–ä½¿ç”¨RSAçš„å…¬é’¥/ç§é’¥å¯¹æ¥ç­¾åï¼Œé˜²æ­¢å†…å®¹ç¯¡æ”¹ã€‚å®˜ç½‘ï¼šhttps://jwt.io/\r\n\r\nä½¿ç”¨JWTå¯ä»¥å®ç°æ— çŠ¶æ€è®¤è¯ï¼Œä»€ä¹ˆæ˜¯æ— çŠ¶æ€è®¤è¯ï¼Ÿ\r\n\r\nä¼ ç»Ÿçš„åŸºäºsessionçš„æ–¹å¼æ˜¯æœ‰çŠ¶æ€è®¤è¯ï¼Œç”¨æˆ·ç™»å½•æˆåŠŸå°†ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯å­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼Œè¿™æ ·åŠ å¤§äº†æœåŠ¡ç«¯çš„å­˜å‚¨å‹åŠ›ï¼Œå¹¶ä¸”è¿™ç§æ–¹å¼ä¸é€‚åˆåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­åº”ç”¨ã€‚\r\n\r\nå¦‚ä¸‹å›¾ï¼Œå½“ç”¨æˆ·è®¿é—®åº”ç”¨æœåŠ¡ï¼Œæ¯ä¸ªåº”ç”¨æœåŠ¡éƒ½ä¼šå»æœåŠ¡å™¨æŸ¥çœ‹sessionä¿¡æ¯ï¼Œå¦‚æœsessionä¸­æ²¡æœ‰è¯¥ç”¨æˆ·åˆ™è¯´æ˜ç”¨æˆ·æ²¡æœ‰ç™»å½•ï¼Œæ­¤æ—¶å°±ä¼šé‡æ–°è®¤è¯ï¼Œè€Œè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯Sessionå¤åˆ¶ã€Sessioné»è´´ã€‚\r\n\r\n![image-20230705223645686](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223645686.png) \r\n\r\nå¦‚æœæ˜¯åŸºäºä»¤ç‰ŒæŠ€æœ¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°è®¤è¯åˆ™æœåŠ¡ç«¯ä¸ç”¨å­˜å‚¨sessionï¼Œå¯ä»¥å°†ç”¨æˆ·èº«ä»½ä¿¡æ¯å­˜å‚¨åœ¨ä»¤ç‰Œä¸­ï¼Œç”¨æˆ·è®¤è¯é€šè¿‡åè®¤è¯æœåŠ¡é¢å‘ä»¤ç‰Œç»™ç”¨æˆ·ï¼Œç”¨æˆ·å°†ä»¤ç‰Œå­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œå»è®¿é—®åº”ç”¨æœåŠ¡æ—¶æºå¸¦ä»¤ç‰Œå»è®¿é—®ï¼ŒæœåŠ¡ç«¯ä»jwtè§£æå‡ºç”¨æˆ·ä¿¡æ¯ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ— çŠ¶æ€è®¤è¯ã€‚\r\n\r\n![image-20230705223829078](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223829078.png)\r\n\r\n \r\n\r\n \r\n\r\nJWTä»¤ç‰Œçš„ä¼˜ç‚¹ï¼š\r\n\r\n1ã€jwtåŸºäºjsonï¼Œéå¸¸æ–¹ä¾¿è§£æã€‚\r\n\r\n2ã€å¯ä»¥åœ¨ä»¤ç‰Œä¸­è‡ªå®šä¹‰ä¸°å¯Œçš„å†…å®¹ï¼Œæ˜“æ‰©å±•ã€‚\r\n\r\n3ã€é€šè¿‡éå¯¹ç§°åŠ å¯†ç®—æ³•åŠæ•°å­—ç­¾åæŠ€æœ¯ï¼ŒJWTé˜²æ­¢ç¯¡æ”¹ï¼Œå®‰å…¨æ€§é«˜ã€‚\r\n\r\n4ã€èµ„æºæœåŠ¡ä½¿ç”¨JWTå¯ä¸ä¾èµ–è®¤è¯æœåŠ¡å³å¯å®Œæˆæˆæƒã€‚\r\n\r\nç¼ºç‚¹ï¼š\r\n\r\nï¼‘ã€JWTä»¤ç‰Œè¾ƒé•¿ï¼Œå å­˜å‚¨ç©ºé—´æ¯”è¾ƒå¤§ã€‚\r\n\r\nä¸‹è¾¹æ˜¯ä¸€ä¸ªJWTä»¤ç‰Œçš„ç¤ºä¾‹ï¼š\r\n\r\n```apl\r\neyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQyNTQ2NzIsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6Ijg4OTEyYjJkLTVkMDUtNGMxNC1iYmMzLWZkZTk5NzdmZWJjNiIsImNsaWVudF9pZCI6ImMxIn0.wkDBL7roLrvdBG2oGnXeoXq-zZRgE9IVV2nxd-ez_oA\r\n```\r\n\r\nJWTä»¤ç‰Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œæ¯éƒ¨åˆ†ä¸­é—´ä½¿ç”¨ç‚¹ï¼ˆ.ï¼‰åˆ†éš”ï¼Œæ¯”å¦‚ï¼š`xxxxx.yyyyy.zzzzz`\r\n\r\n1. Header     \r\n\r\n å¤´éƒ¨åŒ…æ‹¬ä»¤ç‰Œçš„ç±»å‹ï¼ˆå³JWTï¼‰åŠä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ï¼ˆå¦‚HMAC SHA256æˆ–RSAï¼‰\r\n\r\n ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š\r\n\r\n ä¸‹è¾¹æ˜¯Headeréƒ¨åˆ†çš„å†…å®¹\r\n\r\n```json\r\n   {\r\n    \"alg\": \"HS256\",\r\n    \"typ\": \"JWT\"\r\n  }\r\n```\r\n\r\nå°†ä¸Šè¾¹çš„å†…å®¹ä½¿ç”¨Base64Urlç¼–ç ï¼Œå¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²å°±æ˜¯JWTä»¤ç‰Œçš„ç¬¬ä¸€éƒ¨åˆ†ã€‚\r\n\r\n2. Payload\r\n\r\n ç¬¬äºŒéƒ¨åˆ†æ˜¯è´Ÿè½½ï¼Œå†…å®¹ä¹Ÿæ˜¯ä¸€ä¸ªjsonå¯¹è±¡ï¼Œå®ƒæ˜¯å­˜æ”¾æœ‰æ•ˆä¿¡æ¯çš„åœ°æ–¹ï¼Œå®ƒå¯ä»¥å­˜æ”¾jwtæä¾›çš„ä¿¡æ¯å­—æ®µï¼Œæ¯”å¦‚ï¼šissï¼ˆç­¾å‘è€…ï¼‰,expï¼ˆè¿‡æœŸæ—¶é—´æˆ³ï¼‰, subï¼ˆé¢å‘çš„ç”¨æˆ·ï¼‰ç­‰ï¼Œä¹Ÿå¯è‡ªå®šä¹‰å­—æ®µã€‚\r\n\r\n æ­¤éƒ¨åˆ†ä¸å»ºè®®å­˜æ”¾æ•æ„Ÿä¿¡æ¯ï¼Œå› ä¸ºæ­¤éƒ¨åˆ†å¯ä»¥è§£ç è¿˜åŸåŸå§‹å†…å®¹ã€‚\r\n\r\n æœ€åå°†ç¬¬äºŒéƒ¨åˆ†è´Ÿè½½ä½¿ç”¨Base64Urlç¼–ç ï¼Œå¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²å°±æ˜¯JWTä»¤ç‰Œçš„ç¬¬äºŒéƒ¨åˆ†ã€‚\r\n\r\n ä¸€ä¸ªä¾‹å­ï¼š\r\n\r\n```json\r\n\r\n  {\r\n    \"sub\": \"1234567890\",\r\n    \"name\": \"456\",\r\n    \"admin\": true\r\n  }\r\n```\r\n\r\n\r\n\r\n3. Signature\r\n\r\n ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ç­¾åï¼Œæ­¤éƒ¨åˆ†ç”¨äºé˜²æ­¢jwtå†…å®¹è¢«ç¯¡æ”¹ã€‚\r\n\r\n è¿™ä¸ªéƒ¨åˆ†ä½¿ç”¨base64urlå°†å‰ä¸¤éƒ¨åˆ†è¿›è¡Œç¼–ç ï¼Œç¼–ç åä½¿ç”¨ç‚¹ï¼ˆ.ï¼‰è¿æ¥ç»„æˆå­—ç¬¦ä¸²ï¼Œæœ€åä½¿ç”¨headerä¸­å£°æ˜çš„ç­¾åç®—æ³•è¿›è¡Œç­¾åã€‚\r\n\r\n ä¸€ä¸ªä¾‹å­ï¼š\r\n\r\n```json\r\n\r\n  HMACSHA256(\r\n    base64UrlEncode(header) + \".\" +\r\n    base64UrlEncode(payload),\r\n    secret)\r\n```\r\n\r\n\r\n\r\nbase64UrlEncode(header)ï¼šjwtä»¤ç‰Œçš„ç¬¬ä¸€éƒ¨åˆ†ã€‚\r\n\r\nbase64UrlEncode(payload)ï¼šjwtä»¤ç‰Œçš„ç¬¬äºŒéƒ¨åˆ†ã€‚\r\n\r\nsecretï¼šç­¾åæ‰€ä½¿ç”¨çš„å¯†é’¥ã€‚\r\n\r\nä¸ºä»€ä¹ˆJWTå¯ä»¥é˜²æ­¢ç¯¡æ”¹ï¼Ÿ\r\n\r\nç¬¬ä¸‰éƒ¨åˆ†ä½¿ç”¨ç­¾åç®—æ³•å¯¹ç¬¬ä¸€éƒ¨åˆ†å’Œç¬¬äºŒéƒ¨åˆ†çš„å†…å®¹è¿›è¡Œç­¾åï¼Œå¸¸ç”¨çš„ç­¾åç®—æ³•æ˜¯ HS256ï¼Œå¸¸è§çš„è¿˜æœ‰md5,sha ç­‰ï¼Œç­¾åç®—æ³•éœ€è¦ä½¿ç”¨å¯†é’¥è¿›è¡Œç­¾åï¼Œå¯†é’¥ä¸å¯¹å¤–å…¬å¼€ï¼Œå¹¶ä¸”ç­¾åæ˜¯ä¸å¯é€†çš„ï¼Œå¦‚æœç¬¬ä¸‰æ–¹æ›´æ”¹äº†å†…å®¹é‚£ä¹ˆæœåŠ¡å™¨éªŒè¯ç­¾åå°±ä¼šå¤±è´¥ï¼Œè¦æƒ³ä¿è¯éªŒè¯ç­¾åæ­£ç¡®å¿…é¡»ä¿è¯å†…å®¹ã€å¯†é’¥ä¸ç­¾åå‰ä¸€è‡´ã€‚\r\n\r\n \r\n\r\n![image-20230705223925811](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223925811.png) \r\n\r\nä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºè®¤è¯æœåŠ¡å’Œèµ„æºæœåŠ¡ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ï¼Œè¿™å«å¯¹ç§°åŠ å¯†ï¼Œå¯¹ç§°åŠ å¯†æ•ˆç‡é«˜ï¼Œå¦‚æœä¸€æ—¦å¯†é’¥æ³„éœ²å¯ä»¥ä¼ªé€ jwtä»¤ç‰Œã€‚\r\n\r\nJWTè¿˜å¯ä»¥ä½¿ç”¨éå¯¹ç§°åŠ å¯†ï¼Œè®¤è¯æœåŠ¡è‡ªå·±ä¿ç•™ç§é’¥ï¼Œå°†å…¬é’¥ä¸‹å‘ç»™å—ä¿¡ä»»çš„å®¢æˆ·ç«¯ã€èµ„æºæœåŠ¡ï¼Œå…¬é’¥å’Œç§é’¥æ˜¯é…å¯¹çš„ï¼Œæˆå¯¹çš„å…¬é’¥å’Œç§é’¥æ‰å¯ä»¥æ­£å¸¸åŠ å¯†å’Œè§£å¯†ï¼Œéå¯¹ç§°åŠ å¯†æ•ˆç‡ä½ä½†ç›¸æ¯”å¯¹ç§°åŠ å¯†éå¯¹ç§°åŠ å¯†æ›´å®‰å…¨ä¸€äº›ã€‚\r\n\r\n \r\n\r\n#### **2.4.3 æµ‹è¯•ç”ŸæˆJWTä»¤ç‰Œ**\r\n\r\nåœ¨è®¤è¯æœåŠ¡ä¸­é…ç½®jwtä»¤ç‰ŒæœåŠ¡ï¼Œå³å¯å®ç°ç”Ÿæˆjwtæ ¼å¼çš„ä»¤ç‰Œ,  \r\n\r\n```java\r\n\r\n@Configuration\r\npublic class TokenConfig {\r\n\r\n    private String SIGNING_KEY = \"mq123\";\r\n\r\n    @Autowired\r\n    TokenStore tokenStore;\r\n\r\n//    @Bean\r\n//    public TokenStore tokenStore() {\r\n//        //ä½¿ç”¨å†…å­˜å­˜å‚¨ä»¤ç‰Œï¼ˆæ™®é€šä»¤ç‰Œï¼‰\r\n//        return new InMemoryTokenStore();\r\n//    }\r\n\r\n    @Autowired\r\n    private JwtAccessTokenConverter accessTokenConverter;\r\n\r\n    @Bean\r\n    public TokenStore tokenStore() {\r\n        return new JwtTokenStore(accessTokenConverter());\r\n    }\r\n\r\n    @Bean\r\n    public JwtAccessTokenConverter accessTokenConverter() {\r\n        JwtAccessTokenConverter converter = new JwtAccessTokenConverter();\r\n        converter.setSigningKey(SIGNING_KEY);\r\n        return converter;\r\n    }\r\n\r\n    //ä»¤ç‰Œç®¡ç†æœåŠ¡\r\n    @Bean(name=\"authorizationServerTokenServicesCustom\")\r\n    public AuthorizationServerTokenServices tokenService() {\r\n        DefaultTokenServices service=new DefaultTokenServices();\r\n        service.setSupportRefreshToken(true);//æ”¯æŒåˆ·æ–°ä»¤ç‰Œ\r\n        service.setTokenStore(tokenStore);//ä»¤ç‰Œå­˜å‚¨ç­–ç•¥\r\n\r\n        TokenEnhancerChain tokenEnhancerChain = new TokenEnhancerChain();\r\n        tokenEnhancerChain.setTokenEnhancers(Arrays.asList(accessTokenConverter));\r\n        service.setTokenEnhancer(tokenEnhancerChain);\r\n\r\n        service.setAccessTokenValiditySeconds(7200); // ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ2å°æ—¶\r\n        service.setRefreshTokenValiditySeconds(259200); // åˆ·æ–°ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ3å¤©\r\n        return service;\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\né‡å¯è®¤è¯æœåŠ¡ã€‚\r\n\r\nä½¿ç”¨httpclienté€šè¿‡å¯†ç æ¨¡å¼ç”³è¯·ä»¤ç‰Œ\r\n\r\n```http\r\n### å¯†ç æ¨¡å¼\r\nPOST {{auth_host}}/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=password&username=zhangsan&password=123\r\n```\r\n\r\nç”Ÿæˆjwtçš„ç¤ºä¾‹å¦‚ä¸‹ï¼š\r\n\r\n```json\r\n{\r\n  \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzMzE2OTUsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImU5ZDNkMGZkLTI0Y2ItNDRjOC04YzEwLTI1NmIzNGY4ZGZjYyIsImNsaWVudF9pZCI6ImMxIn0.-9SKI-qUqKhKcs8Gb80Rascx-JxqsNZxxXoPo82d8SM\",\r\n  \"token_type\": \"bearer\",\r\n  \"refresh_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJhdGkiOiJlOWQzZDBmZC0yNGNiLTQ0YzgtOGMxMC0yNTZiMzRmOGRmY2MiLCJleHAiOjE2NjQ1ODM2OTUsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImRjNTRjNTRkLTA0YTMtNDIzNS04MmY3LTFkOWZkMmFjM2VmNSIsImNsaWVudF9pZCI6ImMxIn0.Wsw1Jc-Kd_GFqEugzdfoSsMY6inC8OQsraA21WjWtT8\",\r\n  \"expires_in\": 7199,\r\n  \"scope\": \"all\",\r\n  \"jti\": \"e9d3d0fd-24cb-44c8-8c10-256b34f8dfcc\"\r\n}\r\n```\r\n\r\n1ã€`access_token`ï¼Œç”Ÿæˆçš„jwtä»¤ç‰Œï¼Œç”¨äºè®¿é—®èµ„æºä½¿ç”¨ã€‚\r\n\r\n2ã€`token_type`ï¼Œbeareræ˜¯åœ¨RFC6750ä¸­å®šä¹‰çš„ä¸€ç§tokenç±»å‹ï¼Œåœ¨æºå¸¦jwtè®¿é—®èµ„æºæ—¶éœ€è¦åœ¨headä¸­åŠ å…¥bearer jwtä»¤ç‰Œå†…å®¹\r\n\r\n3ã€`refresh_token`ï¼Œå½“jwtä»¤ç‰Œå¿«è¿‡æœŸæ—¶ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œå¯ä»¥å†æ¬¡ç”Ÿæˆjwtä»¤ç‰Œã€‚\r\n\r\n4ã€`expires_in`ï¼šè¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰\r\n\r\n5ã€`scope`ï¼Œä»¤ç‰Œçš„æƒé™èŒƒå›´ï¼ŒæœåŠ¡ç«¯å¯ä»¥æ ¹æ®ä»¤ç‰Œçš„æƒé™èŒƒå›´å»å¯¹ä»¤ç‰Œæˆæƒã€‚\r\n\r\n6ã€`jti`ï¼šä»¤ç‰Œçš„å”¯ä¸€æ ‡è¯†ã€‚\r\n\r\n \r\n\r\næˆ‘ä»¬å¯ä»¥é€šè¿‡check_tokenæ¥å£æ ¡éªŒjwtä»¤ç‰Œ\r\n\r\n```http\r\n###æ ¡éªŒjwtä»¤ç‰Œ\r\nPOST {{auth_host}}/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJzdHUxIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY2NDM3MTc4MCwiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiZjBhM2NkZWItMzk5ZC00OGYwLTg4MDQtZWNhNjM4YWQ4ODU3IiwiY2xpZW50X2lkIjoiYzEifQ.qy46CSCJsH3eXWTHgdcntZhzcSzfRQlBU0dxAjZcsUw\r\n```\r\n\r\nå“åº”ç¤ºä¾‹å¦‚ä¸‹ï¼š\r\n\r\n```json\r\n{\r\n  \"aud\": [\r\n    \"res1\"\r\n  ],\r\n  \"user_name\": \"zhangsan\",\r\n  \"scope\": [\r\n    \"all\"\r\n  ],\r\n  \"active\": true,\r\n  \"exp\": 1664371780,\r\n  \"authorities\": [\r\n    \"p1\"\r\n  ],\r\n  \"jti\": \"f0a3cdeb-399d-48f0-8804-eca638ad8857\",\r\n  \"client_id\": \"c1\"\r\n}\r\n```\r\n\r\n#### **2.4.4 æµ‹è¯•èµ„æºæœåŠ¡æ ¡éªŒä»¤ç‰Œ**\r\n\r\næ‹¿åˆ°äº†jwtä»¤ç‰Œä¸‹ä¸€æ­¥å°±è¦æºå¸¦ä»¤ç‰Œå»è®¿é—®èµ„æºæœåŠ¡ä¸­çš„èµ„æºï¼Œæœ¬é¡¹ç›®å„ä¸ªå¾®æœåŠ¡å°±æ˜¯èµ„æºæœåŠ¡ï¼Œæ¯”å¦‚ï¼šå†…å®¹ç®¡ç†æœåŠ¡ï¼Œå®¢æˆ·ç«¯ç”³è¯·åˆ°jwtä»¤ç‰Œï¼Œæºå¸¦jwtå»å†…å®¹ç®¡ç†æœåŠ¡æŸ¥è¯¢è¯¾ç¨‹ä¿¡æ¯ï¼Œæ­¤æ—¶å†…å®¹ç®¡ç†æœåŠ¡è¦å¯¹jwtè¿›è¡Œæ ¡éªŒï¼Œåªæœ‰jwtåˆæ³•æ‰å¯ä»¥ç»§ç»­è®¿é—®ã€‚å¦‚ä¸‹å›¾ï¼š\r\n\r\n![image-20230705223951357](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223951357.png) \r\n\r\n1ã€åœ¨å†…å®¹ç®¡ç†æœåŠ¡çš„content-apiå·¥ç¨‹ä¸­æ·»åŠ ä¾èµ–\r\n\r\n```xml\r\n<!--è®¤è¯ç›¸å…³-->\r\n<dependency>\r\n    <groupId>org.springframework.cloud</groupId>\r\n    <artifactId>spring-cloud-starter-security</artifactId>\r\n</dependency>\r\n<dependency>\r\n    <groupId>org.springframework.cloud</groupId>\r\n    <artifactId>spring-cloud-starter-oauth2</artifactId>\r\n</dependency>\r\n```\r\n\r\n2ã€åœ¨å†…å®¹ç®¡ç†æœåŠ¡çš„content-apiå·¥ç¨‹ä¸­æ·»åŠ TokenConfig\r\n\r\n```java\r\n\r\n@Configuration\r\npublic class TokenConfig {\r\n\r\n    //jwtç­¾åå¯†é’¥,ä¸è®¤è¯æœåŠ¡ä¿æŒä¸€è‡´\r\n    private String SIGNING_KEY = \"mq123\";\r\n\r\n    @Bean\r\n    public TokenStore tokenStore() {\r\n        //JWTä»¤ç‰Œå­˜å‚¨æ–¹æ¡ˆ\r\n        return new JwtTokenStore(accessTokenConverter());\r\n    }\r\n\r\n    @Bean\r\n    public JwtAccessTokenConverter accessTokenConverter() {\r\n        JwtAccessTokenConverter converter = new JwtAccessTokenConverter();\r\n        converter.setSigningKey(SIGNING_KEY);\r\n        return converter;\r\n    }\r\n\r\n   /* @Bean\r\n    public TokenStore tokenStore() {\r\n        //ä½¿ç”¨å†…å­˜å­˜å‚¨ä»¤ç‰Œï¼ˆæ™®é€šä»¤ç‰Œï¼‰\r\n        return new InMemoryTokenStore();\r\n    }*/\r\n}\r\n```\r\n\r\n3ã€æ·»åŠ èµ„æºæœåŠ¡é…ç½®\r\n\r\n```java\r\n\r\n@Configuration\r\n@EnableResourceServer\r\n@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)\r\npublic class ResouceServerConfig extends ResourceServerConfigurerAdapter {\r\n\r\n\r\n    //èµ„æºæœåŠ¡æ ‡è¯†\r\n    public static final String RESOURCE_ID = \"xuecheng-plus\";\r\n\r\n    @Autowired\r\n    TokenStore tokenStore;\r\n\r\n    @Override\r\n    public void configure(ResourceServerSecurityConfigurer resources) {\r\n        resources.resourceId(RESOURCE_ID)//èµ„æº id\r\n                .tokenStore(tokenStore)\r\n                .stateless(true);\r\n    }\r\n\r\n    @Override\r\n    public void configure(HttpSecurity http) throws Exception {\r\n        http.csrf().disable()\r\n                .authorizeRequests()\r\n                .antMatchers(\"/r/**\",\"/course/**\").authenticated()//æ‰€æœ‰/r/**çš„è¯·æ±‚å¿…é¡»è®¤è¯é€šè¿‡\r\n                .anyRequest().permitAll()\r\n        ;\r\n    }\r\n\r\n}\r\n```\r\n\r\næ ¹æ®é…ç½®å¯çŸ¥/course/**å¼€å¤´çš„æ¥å£éœ€è¦è®¤è¯é€šè¿‡ã€‚\r\n\r\né‡å¯å†…å®¹ç®¡ç†æœåŠ¡\r\n\r\nä½¿ç”¨httpclientæµ‹è¯•ï¼š\r\n\r\n1ã€è®¿é—®æ ¹æ®è¯¾ç¨‹idæŸ¥è¯¢è¯¾ç¨‹æ¥å£\r\n\r\n```http\r\nGET http://localhost:63040/content/course/2\r\n```\r\n\r\nè¿”å›ï¼š\r\n\r\n```json\r\n\r\n{\r\n  \"error\": \"unauthorized\",\r\n  \"error_description\": \"Full authentication is required to access this resource\"\r\n}\r\n```\r\n\r\nä»è¿”å›ä¿¡æ¯å¯çŸ¥å½“å‰æ²¡æœ‰è®¤è¯ã€‚\r\n\r\nä¸‹è¾¹æºå¸¦JWTä»¤ç‰Œè®¿é—®æ¥å£ï¼š\r\n\r\n1ã€ç”³è¯·jwtä»¤ç‰Œ\r\n\r\né‡‡ç”¨å¯†ç æ¨¡å¼ç”³è¯·ä»¤ç‰Œã€‚\r\n\r\n2ã€æºå¸¦jwtä»¤ç‰Œè®¿é—®èµ„æºæœåŠ¡åœ°å€\r\n\r\n```http\r\n### æºå¸¦tokenè®¿é—®èµ„æºæœåŠ¡\r\nGET http://localhost:63040/content/course/2\r\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzMzM0OTgsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6IjhhM2M2OTk1LWU1ZGEtNDQ1Yy05ZDAyLTEwNDFlYzk3NTkwOSIsImNsaWVudF9pZCI6ImMxIn0.73eNDxTX5ifttGCjwc7xrd-Sbp_mCfcIerI3lGetZto\r\n```\r\n\r\nå¦‚æœæºå¸¦jwtä»¤ç‰Œä¸”jwtæ­£ç¡®åˆ™æ­£å¸¸è®¿é—®èµ„æºæœåŠ¡çš„å†…å®¹ã€‚\r\n\r\nå¦‚æœä¸æ­£ç¡®åˆ™æŠ¥ä»¤ç‰Œæ— æ•ˆçš„é”™è¯¯ï¼š\r\n\r\n```json\r\n{\r\n  \"error\": \"invalid_token\",\r\n  \"error_description\": \"Cannot convert access token to JSON\"\r\n}\r\n```\r\n\r\n#### **2.4.5 æµ‹è¯•è·å–ç”¨æˆ·èº«ä»½**\r\n\r\njwtä»¤ç‰Œä¸­è®°å½•äº†ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œå½“å®¢æˆ·ç«¯æºå¸¦jwtè®¿é—®èµ„æºæœåŠ¡ï¼Œèµ„æºæœåŠ¡éªŒç­¾é€šè¿‡åå°†å‰ä¸¤éƒ¨åˆ†çš„å†…å®¹è¿˜åŸå³å¯å–å‡ºç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œå¹¶å°†ç”¨æˆ·èº«ä»½ä¿¡æ¯æ”¾åœ¨äº†SecurityContextHolderä¸Šä¸‹æ–‡ï¼ŒSecurityContextä¸å½“å‰çº¿ç¨‹è¿›è¡Œç»‘å®šï¼Œæ–¹ä¾¿è·å–ç”¨æˆ·èº«ä»½ã€‚\r\n\r\nè¿˜ä»¥æŸ¥è¯¢è¯¾ç¨‹æ¥å£ä¸ºä¾‹ï¼Œè¿›å…¥æŸ¥è¯¢è¯¾ç¨‹æ¥å£çš„ä»£ç ä¸­ï¼Œæ·»åŠ è·å–ç”¨æˆ·èº«ä»½çš„ä»£ç \r\n\r\n```java\r\n\r\n@ApiOperation(\"æ ¹æ®è¯¾ç¨‹idæŸ¥è¯¢è¯¾ç¨‹åŸºç¡€ä¿¡æ¯\")\r\n@GetMapping(\"/course/{courseId}\")\r\npublic CourseBaseInfoDto getCourseBaseById(@PathVariable(\"courseId\") Long courseId){\r\n    //å–å‡ºå½“å‰ç”¨æˆ·èº«ä»½\r\n    Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();\r\n    System.out.println(principal);\r\n\r\n    return courseBaseInfoService.getCourseBaseInfo(courseId);\r\n}\r\n```\r\n\r\næµ‹è¯•æ—¶éœ€è¦æ³¨æ„ï¼š\r\n\r\n1ã€é¦–å…ˆåœ¨èµ„æºæœåŠ¡é…ç½®ä¸­æŒ‡å®šå®‰å…¨æ‹¦æˆªæœºåˆ¶ `/course/`å¼€å¤´çš„è¯·æ±‚éœ€è¦è®¤è¯ï¼Œå³è¯·æ±‚`/course/{courseId}`æ¥å£éœ€è¦æºå¸¦jwtä»¤ç‰Œä¸”ç­¾è¯é€šè¿‡ã€‚\r\n\r\n2ã€è®¤è¯æœåŠ¡ç”Ÿæˆjwtä»¤ç‰Œå°†ç”¨æˆ·èº«ä»½ä¿¡æ¯å†™å…¥ä»¤ç‰Œï¼Œè®¤è¯æœåŠ¡å“ªé‡Œè·å–ç”¨æˆ·èº«ä»½ã€‚\r\n\r\nç›®å‰è¿˜æ˜¯å°†ç”¨æˆ·ä¿¡æ¯ç¡¬ç¼–ç å¹¶æš‚æ”¾åœ¨å†…å­˜ä¸­ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n@Bean\r\npublic UserDetailsService userDetailsService() {\r\n    //è¿™é‡Œé…ç½®ç”¨æˆ·ä¿¡æ¯,è¿™é‡Œæš‚æ—¶ä½¿ç”¨è¿™ç§æ–¹å¼å°†ç”¨æˆ·å­˜å‚¨åœ¨å†…å­˜ä¸­\r\n    InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();\r\n    manager.createUser(User.withUsername(\"zhangsan\").password(\"123\").authorities(\"p1\").build());\r\n    manager.createUser(User.withUsername(\"lisi\").password(\"456\").authorities(\"p2\").build());\r\n    return manager;\r\n}\r\n```\r\n\r\n3ã€æˆ‘ä»¬åœ¨ä½¿ç”¨å¯†ç æ¨¡å¼ç”Ÿæˆjwtä»¤ç‰Œæ—¶ç”¨çš„æ˜¯zhangsançš„ä¿¡æ¯ï¼Œæ‰€ä»¥jwtä»¤ç‰Œä¸­å­˜å‚¨äº†zhangsançš„ä¿¡æ¯ï¼Œé‚£ä¹ˆåœ¨èµ„æºæœåŠ¡ä¸­åº”è¯¥å–å‡ºzhangsançš„ä¿¡æ¯æ‰å¯¹ã€‚\r\n\r\næ¸…æ¥šäº†ä»¥ä¸Šå†…å®¹ï¼Œä¸‹è¾¹é‡å¯å†…å®¹ç®¡ç†æœåŠ¡ï¼Œè·Ÿè¸ªå–åˆ°çš„ç”¨æˆ·èº«ä»½æ˜¯å¦æ­£ç¡®ã€‚\r\n\r\n \r\n\r\n### **2.5 ç½‘å…³è®¤è¯**\r\n\r\n#### **2.5.1 æŠ€æœ¯æ–¹æ¡ˆ**\r\n\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæµ‹è¯•é€šè¿‡äº†è®¤è¯æœåŠ¡é¢å‘jwtä»¤ç‰Œï¼Œå®¢æˆ·ç«¯æºå¸¦jwtè®¿é—®èµ„æºæœåŠ¡ï¼Œèµ„æºæœåŠ¡å¯¹jwtçš„åˆæ³•æ€§è¿›è¡ŒéªŒè¯ã€‚å¦‚ä¸‹å›¾ï¼š\r\n\r\n![](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705223951357.png) \r\n\r\nä»”ç»†è§‚å¯Ÿæ­¤å›¾ï¼Œé—æ¼äº†æœ¬é¡¹ç›®æ¶æ„ä¸­éå¸¸é‡è¦çš„ç»„ä»¶ï¼šç½‘å…³ï¼ŒåŠ ä¸Šç½‘å…³å¹¶å®Œå–„åå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\r\n\r\n![image-20230705224031161](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224031161.png) \r\n\r\n> æ‰€æœ‰è®¿é—®å¾®æœåŠ¡çš„è¯·æ±‚éƒ½è¦ç»è¿‡ç½‘å…³ï¼Œåœ¨ç½‘å…³è¿›è¡Œç”¨æˆ·èº«ä»½çš„è®¤è¯å¯ä»¥å°†å¾ˆå¤šéæ³•çš„è¯·æ±‚æ‹¦æˆªåˆ°å¾®æœåŠ¡ä»¥å¤–ï¼Œè¿™å«åšç½‘å…³è®¤è¯ã€‚\r\n\r\nä¸‹è¾¹éœ€è¦æ˜ç¡®ç½‘å…³çš„èŒè´£ï¼š\r\n\r\n1ã€ç½‘ç«™ç™½åå•ç»´æŠ¤\r\n\r\né’ˆå¯¹ä¸ç”¨è®¤è¯çš„URLå…¨éƒ¨æ”¾è¡Œã€‚\r\n\r\n2ã€æ ¡éªŒjwtçš„åˆæ³•æ€§ã€‚\r\n\r\né™¤äº†ç™½åå•å‰©ä¸‹çš„å°±æ˜¯éœ€è¦è®¤è¯çš„è¯·æ±‚ï¼Œç½‘å…³éœ€è¦éªŒè¯jwtçš„åˆæ³•æ€§ï¼Œjwtåˆæ³•åˆ™è¯´æ˜ç”¨æˆ·èº«ä»½åˆæ³•ï¼Œå¦åˆ™è¯´æ˜èº«ä»½ä¸åˆæ³•åˆ™æ‹’ç»ç»§ç»­è®¿é—®ã€‚\r\n\r\n \r\n\r\nç½‘å…³è´Ÿè´£æˆæƒå—ï¼Ÿ\r\n\r\nç½‘å…³ä¸è´Ÿè´£æˆæƒï¼Œå¯¹è¯·æ±‚çš„æˆæƒæ“ä½œåœ¨å„ä¸ªå¾®æœåŠ¡è¿›è¡Œï¼Œå› ä¸ºå¾®æœåŠ¡æœ€æ¸…æ¥šç”¨æˆ·æœ‰å“ªäº›æƒé™è®¿é—®å“ªäº›æ¥å£ã€‚\r\n\r\n \r\n\r\n#### **2.5.2 å®ç°ç½‘å…³è®¤è¯**\r\n\r\nä¸‹è¾¹å®ç°ç½‘å…³è®¤è¯ï¼Œå®ç°ä»¥ä¸‹èŒè´£ï¼š\r\n\r\n1ã€ç½‘ç«™ç™½åå•ç»´æŠ¤\r\n\r\né’ˆå¯¹ä¸ç”¨è®¤è¯çš„URLå…¨éƒ¨æ”¾è¡Œã€‚\r\n\r\n2ã€æ ¡éªŒjwtçš„åˆæ³•æ€§ã€‚\r\n\r\né™¤äº†ç™½åå•å‰©ä¸‹çš„å°±æ˜¯éœ€è¦è®¤è¯çš„è¯·æ±‚ï¼Œç½‘å…³éœ€è¦éªŒè¯jwtçš„åˆæ³•æ€§ï¼Œjwtåˆæ³•åˆ™è¯´æ˜ç”¨æˆ·èº«ä»½åˆæ³•ï¼Œå¦åˆ™è¯´æ˜èº«ä»½ä¸åˆæ³•åˆ™æ‹’ç»ç»§ç»­è®¿é—®ã€‚\r\n\r\n \r\n\r\n1ã€åœ¨ç½‘å…³å·¥ç¨‹æ·»åŠ ä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>org.springframework.cloud</groupId>\r\n    <artifactId>spring-cloud-starter-security</artifactId>\r\n</dependency>\r\n<dependency>\r\n    <groupId>org.springframework.cloud</groupId>\r\n    <artifactId>spring-cloud-starter-oauth2</artifactId>\r\n</dependency>\r\n<dependency>\r\n    <groupId>org.projectlombok</groupId>\r\n    <artifactId>lombok</artifactId>\r\n</dependency>\r\n<dependency>\r\n    <groupId>com.alibaba</groupId>\r\n    <artifactId>fastjson</artifactId>\r\n</dependency>\r\n```\r\n\r\n2ã€æ‹·è´è¯¾ç¨‹èµ„æ–™ä¸‹ç½‘å…³è®¤è¯é…ç½®ç±»åˆ°ç½‘å…³å·¥ç¨‹çš„configåŒ…ä¸‹ã€‚\r\n\r\n3ã€é…ç½®ç™½åå•æ–‡ä»¶`security-whitelist.properties`\r\n\r\nå†…å®¹å¦‚ä¸‹ï¼ˆæŒç»­è¡¥å……ï¼‰\r\n\r\n```properties\r\n/**=ä¸´æ—¶å…¨éƒ¨æ”¾è¡Œ\r\n/auth/**=è®¤è¯åœ°å€\r\n/content/open/**=å†…å®¹ç®¡ç†å…¬å¼€è®¿é—®æ¥å£\r\n/media/open/**=åª’èµ„ç®¡ç†å…¬å¼€è®¿é—®æ¥å£\r\n```\r\n\r\né‡å¯ç½‘å…³å·¥ç¨‹ï¼Œè¿›è¡Œæµ‹è¯•\r\n\r\n1ã€ç”³è¯·ä»¤ç‰Œ\r\n\r\n2ã€é€šè¿‡ç½‘å…³è®¿é—®èµ„æºæœåŠ¡\r\n\r\nè¿™é‡Œè®¿é—®å†…å®¹ç®¡ç†æœåŠ¡\r\n\r\n```http\r\n### é€šè¿‡ç½‘å…³è®¿é—®èµ„æºæœåŠ¡\r\nGET http://localhost:63010/content/course/2\r\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzNjIzMTAsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6Ijc2OTkwMGNiLWM1ZjItNGRiNC1hZWJmLWY1MzgxZDQxZWMyZCIsImNsaWVudF9pZCI6ImMxIn0.lOITjUgYg2HCh5mDPK9EvJJqz-tIupKVfmP8yWJQIKs\r\n```\r\n\r\nå½“tokenæ­£ç¡®æ—¶å¯ä»¥æ­£å¸¸è®¿é—®èµ„æºæœåŠ¡ï¼ŒtokenéªŒè¯å¤±è´¥è¿”å›tokenæ— æ•ˆï¼š\r\n\r\n```json\r\n{\r\n  \"errMessage\": \"è®¤è¯ä»¤ç‰Œæ— æ•ˆ\"\r\n}\r\n```\r\n\r\næ³¨æ„ï¼šç½‘å…³é‰´æƒåŠŸèƒ½è°ƒè¯•é€šè¿‡åï¼Œç”±äºç›®å‰è¿˜æ²¡æœ‰å¼€å‘è®¤è¯åŠŸèƒ½ï¼Œå‰ç«¯è¯·æ±‚ç½‘å…³çš„URLä¸åœ¨ç™½åå•ä¸­é—´æ—¶ä¼šâ€œæ²¡æœ‰è®¤è¯â€çš„é”™è¯¯ï¼Œæš‚æ—¶åœ¨ç™½åå•ä¸­æ·»åŠ  å…¨éƒ¨æ”¾è¡Œé…ç½®ï¼Œå¾…è®¤è¯åŠŸèƒ½å¼€å‘å®Œæˆå†å±è”½å…¨éƒ¨æ”¾è¡Œé…ç½®ï¼Œ\r\n\r\n![image-20230705224115205](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224115205.png) \r\n\r\n \r\n\r\n \r\n\r\n## **3 ç”¨æˆ·è®¤è¯**\r\n\r\n### **3.1 éœ€æ±‚åˆ†æ**\r\n\r\nè‡³æ­¤æˆ‘ä»¬äº†è§£äº†ä½¿ç”¨Spring Securityè¿›è¡Œè®¤è¯æˆæƒçš„è¿‡ç¨‹ï¼Œæœ¬èŠ‚å®ç°ç”¨æˆ·è®¤è¯åŠŸèƒ½ã€‚\r\n\r\nç›®å‰å„å¤§ç½‘ç«™çš„è®¤è¯æ–¹å¼éå¸¸ä¸°å¯Œï¼šè´¦å·å¯†ç è®¤è¯ã€æ‰‹æœºéªŒè¯ç è®¤è¯ã€æ‰«ç ç™»å½•ç­‰ã€‚\r\n\r\næœ¬é¡¹ç›®ä¹Ÿè¦æ”¯æŒå¤šç§è®¤è¯è¯•ã€‚\r\n\r\n \r\n\r\n### **3.2 è¿æ¥ç”¨æˆ·ä¸­å¿ƒæ•°æ®åº“**\r\n\r\n#### **3.2.1 è¿æ¥æ•°æ®åº“è®¤è¯**\r\n\r\nåŸºäºçš„è®¤è¯æµç¨‹åœ¨ç ”ç©¶Spring Securityè¿‡ç¨‹ä¸­å·²ç»æµ‹è¯•é€šè¿‡ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ç”¨æˆ·è®¤è¯æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![image-20230705224147514](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224147514.png) \r\n\r\nè®¤è¯æ‰€éœ€è¦çš„ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨ç”¨æˆ·ä¸­å¿ƒæ•°æ®åº“ï¼Œç°åœ¨éœ€è¦å°†è®¤è¯æœåŠ¡è¿æ¥æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ã€‚\r\n\r\nåœ¨ç ”ç©¶Spring Securityçš„è¿‡ç¨‹ä¸­æ˜¯å°†ç”¨æˆ·ä¿¡æ¯ç¡¬ç¼–ç ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n@Bean\r\npublic UserDetailsService userDetailsService() {\r\n    //è¿™é‡Œé…ç½®ç”¨æˆ·ä¿¡æ¯,è¿™é‡Œæš‚æ—¶ä½¿ç”¨è¿™ç§æ–¹å¼å°†ç”¨æˆ·å­˜å‚¨åœ¨å†…å­˜ä¸­\r\n    InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();\r\n    manager.createUser(User.withUsername(\"zhangsan\").password(\"123\").authorities(\"p1\").build());\r\n    manager.createUser(User.withUsername(\"lisi\").password(\"456\").authorities(\"p2\").build());\r\n    return manager;\r\n}\r\n```\r\n\r\næˆ‘ä»¬è¦è®¤è¯æœåŠ¡ä¸­è¿æ¥ç”¨æˆ·ä¸­å¿ƒæ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ã€‚\r\n\r\nå¦‚ä½•ä½¿ç”¨Spring Securityè¿æ¥æ•°æ®åº“è®¤è¯å—ï¼Ÿ\r\n\r\nå‰è¾¹å­¦ä¹ Spring Securityå·¥ä½œåŸç†æ—¶æœ‰ä¸€å¼ æ‰§è¡Œæµç¨‹å›¾ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![image-20230705224242929](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224242929.png)\r\n\r\nç”¨æˆ·æäº¤è´¦å·å’Œå¯†ç ç”±DaoAuthenticationProviderè°ƒç”¨UserDetailsServiceçš„`loadUserByUsername()`æ–¹æ³•è·å–UserDetailsç”¨æˆ·ä¿¡æ¯ã€‚\r\n\r\næŸ¥è¯¢DaoAuthenticationProviderçš„æºä»£ç å¦‚ä¸‹ï¼š\r\n\r\n![image-20230705224313517](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224313517.png) \r\n\r\nUserDetailsServiceæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\npackage org.springframework.security.core.userdetails;\r\n\r\npublic interface UserDetailsService {\r\n    UserDetails loadUserByUsername(String var1) throws UsernameNotFoundException;\r\n}\r\n```\r\n\r\nUserDetailsæ˜¯ç”¨æˆ·ä¿¡æ¯æ¥å£\r\n\r\n```java\r\n\r\npublic interface UserDetails extends Serializable {\r\n    Collection<? extends GrantedAuthority> getAuthorities();\r\n\r\n    String getPassword();\r\n\r\n    String getUsername();\r\n\r\n    boolean isAccountNonExpired();\r\n\r\n    boolean isAccountNonLocked();\r\n\r\n    boolean isCredentialsNonExpired();\r\n\r\n    boolean isEnabled();\r\n}\r\n```\r\n\r\næˆ‘ä»¬åªè¦å®ç°UserDetailsService æ¥å£æŸ¥è¯¢æ•°æ®åº“å¾—åˆ°ç”¨æˆ·ä¿¡æ¯è¿”å›UserDetails ç±»å‹çš„ç”¨æˆ·ä¿¡æ¯å³å¯,æ¡†æ¶è°ƒç”¨`loadUserByUsername()`æ–¹æ³•æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ä¹‹åæ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Œè§ä¸‹å›¾ï¼š\r\n\r\n![image-20230705224342435](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224342435.png) \r\n\r\né¦–å…ˆå±è”½åŸæ¥å®šä¹‰çš„UserDetailsServiceã€‚\r\n\r\n```java\r\n\r\n    //é…ç½®ç”¨æˆ·ä¿¡æ¯æœåŠ¡\r\n//    @Bean\r\n//    public UserDetailsService userDetailsService() {\r\n//        //è¿™é‡Œé…ç½®ç”¨æˆ·ä¿¡æ¯,è¿™é‡Œæš‚æ—¶ä½¿ç”¨è¿™ç§æ–¹å¼å°†ç”¨æˆ·å­˜å‚¨åœ¨å†…å­˜ä¸­\r\n//        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();\r\n//        manager.createUser(User.withUsername(\"zhangsan\").password(\"123\").authorities(\"p1\").build());\r\n//        manager.createUser(User.withUsername(\"lisi\").password(\"456\").authorities(\"p2\").build());\r\n//        return manager;\r\n//    }\r\n```\r\n\r\nä¸‹è¾¹è‡ªå®šä¹‰UserDetailsService\r\n\r\n```java\r\n\r\n@Service\r\npublic class UserServiceImpl implements UserDetailsService {\r\n\r\n    @Autowired\r\n    XcUserMapper xcUserMapper;\r\n\r\n    /**\r\n     * @description æ ¹æ®è´¦å·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\r\n     * @param s  è´¦å·\r\n     * @return org.springframework.security.core.userdetails.UserDetails\r\n     * @author Mr.M\r\n     * @date 2022/9/28 18:30\r\n    */\r\n    @Override\r\n    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {\r\n\r\n        XcUser user = xcUserMapper.selectOne(new LambdaQueryWrapper<XcUser>().eq(XcUser::getUsername, s));\r\n        if(user==null){\r\n            //è¿”å›ç©ºè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨\r\n            return null;\r\n        }\r\n        //å–å‡ºæ•°æ®åº“å­˜å‚¨çš„æ­£ç¡®å¯†ç \r\n        String password  =user.getPassword();\r\n        //ç”¨æˆ·æƒé™,å¦‚æœä¸åŠ æŠ¥Cannot pass a null GrantedAuthority collection\r\n        String[] authorities= {\"test\"};\r\n        //åˆ›å»ºUserDetailså¯¹è±¡,æƒé™ä¿¡æ¯å¾…å®ç°æˆæƒåŠŸèƒ½æ—¶å†å‘UserDetailä¸­åŠ å…¥\r\n        UserDetails userDetails = User.withUsername(user.getUsername()).password(password).authorities(authorities).build();\r\n\r\n        return userDetails;\r\n    }\r\n\r\n\r\n}\r\n```\r\n\r\næ•°æ®åº“ä¸­çš„å¯†ç åŠ è¿‡å¯†çš„ï¼Œç”¨æˆ·è¾“å…¥çš„å¯†ç æ˜¯æ˜æ–‡ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹å¯†ç æ ¼å¼å™¨PasswordEncoderï¼ŒåŸæ¥ä½¿ç”¨çš„æ˜¯NoOpPasswordEncoderï¼Œå®ƒæ˜¯é€šè¿‡æ˜æ–‡æ–¹å¼æ¯”è¾ƒå¯†ç ï¼Œç°åœ¨æˆ‘ä»¬ä¿®æ”¹ä¸ºBCryptPasswordEncoderï¼Œå®ƒæ˜¯å°†ç”¨æˆ·è¾“å…¥çš„å¯†ç ç¼–ç ä¸ºBCryptæ ¼å¼ä¸æ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œæ¯”å¯¹ã€‚\r\n\r\nå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n    @Bean\r\n    public PasswordEncoder passwordEncoder() {\r\n//        //å¯†ç ä¸ºæ˜æ–‡æ–¹å¼\r\n//        return NoOpPasswordEncoder.getInstance();\r\n        return new BCryptPasswordEncoder();\r\n    }\r\n```\r\n\r\næˆ‘ä»¬é€šè¿‡æµ‹è¯•ä»£ç æµ‹è¯•BCryptPasswordEncoderï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\npublic static void main(String[] args) {\r\n    String password = \"111111\";\r\n    PasswordEncoder passwordEncoder = new BCryptPasswordEncoder();\r\n    for(int i=0;i<10;i++) {\r\n        //æ¯ä¸ªè®¡ç®—å‡ºçš„Hashå€¼éƒ½ä¸ä¸€æ ·\r\n        String hashPass = passwordEncoder.encode(password);\r\n        System.out.println(hashPass);\r\n        //è™½ç„¶æ¯æ¬¡è®¡ç®—çš„å¯†ç Hashå€¼ä¸ä¸€æ ·ä½†æ˜¯æ ¡éªŒæ˜¯é€šè¿‡çš„\r\n        boolean f = passwordEncoder.matches(password, hashPass);\r\n        System.out.println(f);\r\n    }\r\n}\r\n```\r\n\r\nä¿®æ”¹æ•°æ®åº“ä¸­çš„å¯†ç ä¸ºBcryptæ ¼å¼ï¼Œå¹¶ä¸”è®°å½•æ˜æ–‡å¯†ç ï¼Œç¨åç”³è¯·ä»¤ç‰Œæ—¶éœ€è¦ã€‚\r\n\r\nç”±äºä¿®æ”¹å¯†ç ç¼–ç æ–¹å¼è¿˜éœ€è¦å°†å®¢æˆ·ç«¯çš„å¯†é’¥æ›´æ”¹ä¸ºBcryptæ ¼å¼.\r\n\r\n```java\r\n\r\n @Override\r\n  public void configure(ClientDetailsServiceConfigurer clients)\r\n          throws Exception {\r\n        clients.inMemory()// ä½¿ç”¨in-memoryå­˜å‚¨\r\n                .withClient(\"XcWebApp\")// client_id\r\n//                .secret(\"secret\")//å®¢æˆ·ç«¯å¯†é’¥\r\n                .secret(new BCryptPasswordEncoder().encode(\"XcWebApp\"))//å®¢æˆ·ç«¯å¯†é’¥\r\n                .resourceIds(\"xuecheng-plus\")//èµ„æºåˆ—è¡¨\r\n                .authorizedGrantTypes(\"authorization_code\", \"password\",\"client_credentials\",\"implicit\",\"refresh_token\")// è¯¥clientå…è®¸çš„æˆæƒç±»å‹authorization_code,password,refresh_token,implicit,client_credentials\r\n                .scopes(\"all\")// å…è®¸çš„æˆæƒèŒƒå›´\r\n                .autoApprove(false)//falseè·³è½¬åˆ°æˆæƒé¡µé¢\r\n                //å®¢æˆ·ç«¯æ¥æ”¶æˆæƒç çš„é‡å®šå‘åœ°å€\r\n                .redirectUris(\"http://www.51xuecheng.cn\")\r\n   ;\r\n  }\r\n```\r\n\r\nç°åœ¨é‡å¯è®¤è¯æœåŠ¡ã€‚\r\n\r\nä¸‹è¾¹ä½¿ç”¨httpclientè¿›è¡Œæµ‹è¯•ï¼š\r\n\r\n```http\r\n### å¯†ç æ¨¡å¼\r\nPOST {{auth_host}}/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=password&username=stu1&password=111111\r\n```\r\n\r\nè¾“å…¥æ­£ç¡®çš„è´¦å·å’Œå¯†ç ï¼Œç”³è¯·ä»¤ç‰ŒæˆåŠŸã€‚\r\n\r\nè¾“å…¥é”™è¯¯çš„å¯†ç ï¼ŒæŠ¥é”™ï¼š\r\n\r\n```json\r\n{\r\n  \"error\": \"invalid_grant\",\r\n  \"error_description\": \"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯\"\r\n}\r\n```\r\n\r\nè¾“å…¥é”™è¯¯çš„è´¦å·ï¼ŒæŠ¥é”™ï¼š\r\n\r\n```json\r\n{\r\n  \"error\": \"unauthorized\",\r\n  \"error_description\": \"UserDetailsService returned null, which is an interface contract violation\"\r\n}\r\n```\r\n\r\n#### **3.2.2 æ‰©å±•ç”¨æˆ·èº«ä»½ä¿¡æ¯**\r\n\r\nç”¨æˆ·è¡¨ä¸­å­˜å‚¨äº†ç”¨æˆ·çš„è´¦å·ã€æ‰‹æœºå·ã€emailï¼Œæ˜µç§°ã€qqç­‰ä¿¡æ¯ï¼ŒUserDetailsæ¥å£åªè¿”å›äº†usernameã€å¯†ç ç­‰ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\npublic interface UserDetails extends Serializable {\r\n    Collection<? extends GrantedAuthority> getAuthorities();\r\n\r\n    String getPassword();\r\n\r\n    String getUsername();\r\n\r\n    boolean isAccountNonExpired();\r\n\r\n    boolean isAccountNonLocked();\r\n\r\n    boolean isCredentialsNonExpired();\r\n\r\n    boolean isEnabled();\r\n}\r\n```\r\n\r\næˆ‘ä»¬éœ€è¦æ‰©å±•ç”¨æˆ·èº«ä»½çš„ä¿¡æ¯ï¼Œåœ¨jwtä»¤ç‰Œä¸­å­˜å‚¨ç”¨æˆ·çš„æ˜µç§°ã€å¤´åƒã€qqç­‰ä¿¡æ¯ã€‚\r\n\r\nå¦‚ä½•æ‰©å±•Spring Securityçš„ç”¨æˆ·èº«ä»½ä¿¡æ¯å‘¢ï¼Ÿ\r\n\r\nåœ¨è®¤è¯é˜¶æ®µDaoAuthenticationProviderä¼šè°ƒç”¨UserDetailServiceæŸ¥è¯¢ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè¿™é‡Œæ˜¯å¯ä»¥è·å–åˆ°é½å…¨çš„ç”¨æˆ·ä¿¡æ¯çš„ã€‚ç”±äºJWTä»¤ç‰Œä¸­ç”¨æˆ·èº«ä»½ä¿¡æ¯æ¥æºäºUserDetailsï¼ŒUserDetailsä¸­ä»…å®šä¹‰äº†usernameä¸ºç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªæ€è·¯ï¼šç¬¬ä¸€æ˜¯å¯ä»¥æ‰©å±•UserDetailsï¼Œä½¿ä¹‹åŒ…æ‹¬æ›´å¤šçš„è‡ªå®šä¹‰å±æ€§ï¼Œç¬¬äºŒä¹Ÿå¯ä»¥æ‰©å±•usernameçš„å†…å®¹ ï¼Œæ¯”å¦‚å­˜å…¥jsonæ•°æ®å†…å®¹ä½œä¸ºusernameçš„å†…å®¹ã€‚ç›¸æ¯”è¾ƒè€Œè¨€ï¼Œæ–¹æ¡ˆäºŒæ¯”è¾ƒç®€å•è¿˜ä¸ç”¨ç ´åUserDetailsçš„ç»“æ„ï¼Œæˆ‘ä»¬é‡‡ç”¨æ–¹æ¡ˆäºŒã€‚\r\n\r\nä¿®æ”¹UserServiceImplå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n@Service\r\npublic class UserServiceImpl implements UserDetailsService {\r\n\r\n    @Autowired\r\n    XcUserMapper xcUserMapper;\r\n\r\n    /**\r\n     * @description æ ¹æ®è´¦å·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\r\n     * @param s  è´¦å·\r\n     * @return org.springframework.security.core.userdetails.UserDetails\r\n     * @author Mr.M\r\n     * @date 2022/9/28 18:30\r\n    */\r\n    @Override\r\n    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {\r\n\r\n        XcUser user = xcUserMapper.selectOne(new LambdaQueryWrapper<XcUser>().eq(XcUser::getUsername, s));\r\n        if(user==null){\r\n            //è¿”å›ç©ºè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨\r\n            return null;\r\n        }\r\n\r\n        //å–å‡ºæ•°æ®åº“å­˜å‚¨çš„æ­£ç¡®å¯†ç \r\n        String password  =user.getPassword();\r\n        //ç”¨æˆ·æƒé™,å¦‚æœä¸åŠ æŠ¥Cannot pass a null GrantedAuthority collection\r\n        String[] authorities = {\"p1\"};\r\n       //ä¸ºäº†å®‰å…¨åœ¨ä»¤ç‰Œä¸­ä¸æ”¾å¯†ç \r\n        user.setPassword(null);\r\n        //å°†userå¯¹è±¡è½¬json\r\n        String userString = JSON.toJSONString(user);\r\n        //åˆ›å»ºUserDetailså¯¹è±¡\r\n        UserDetails userDetails = User.withUsername(userString).password(password).authorities(authorities).build();\r\n\r\n        return userDetails;\r\n    }\r\n\r\n\r\n}\r\n```\r\n\r\né‡å¯è®¤è¯æœåŠ¡ï¼Œé‡æ–°ç”Ÿæˆä»¤ç‰Œï¼Œç”ŸæˆæˆåŠŸã€‚\r\n\r\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨`check_token`æŸ¥è¯¢jwtçš„å†…å®¹\r\n\r\n```http\r\n###æ ¡éªŒjwtä»¤ç‰Œ\r\nPOST {{auth_host}}/oauth/check_token?token=\r\n```\r\n\r\nå“åº”ç¤ºä¾‹å¦‚ä¸‹ï¼Œ\r\n\r\n```json\r\n\r\n{\r\n  \"aud\": [\r\n    \"res1\"\r\n  ],\r\n  \"user_name\": \"{\\\"birthday\\\":\\\"2022-09-28T19:28:46\\\",\\\"createTime\\\":\\\"2022-09-28T08:32:03\\\",\\\"id\\\":\\\"50\\\",\\\"name\\\":\\\"å­¦ç”Ÿ1\\\",\\\"nickname\\\":\\\"å¤§æ°´ç‰›\\\",\\\"password\\\":\\\"$2a$10$0pt7WlfTbnPDTcWtp/.2Mu5CTXvohnNQhR628qq4RoKSc0dGAdEgm\\\",\\\"sex\\\":\\\"1\\\",\\\"status\\\":\\\"1\\\",\\\"username\\\":\\\"stu1\\\",\\\"userpic\\\":\\\"http://file.51xuecheng.cn/dddf\\\",\\\"utype\\\":\\\"101001\\\"}\",\r\n  \"scope\": [\r\n    \"all\"\r\n  ],\r\n  \"active\": true,\r\n  \"exp\": 1664372184,\r\n  \"authorities\": [\r\n    \"p1\"\r\n  ],\r\n  \"jti\": \"73da9f7b-bd8c-45ac-9add-46b711d11fb8\",\r\n  \"client_id\": \"c1\"\r\n}\r\n```\r\n\r\n`user_name`å­˜å‚¨äº†ç”¨æˆ·ä¿¡æ¯çš„jsonæ ¼å¼ï¼Œåœ¨èµ„æºæœåŠ¡ä¸­å°±å¯ä»¥å–å‡ºè¯¥jsonæ ¼å¼çš„å†…å®¹è½¬ä¸ºç”¨æˆ·å¯¹è±¡å»ä½¿ç”¨ã€‚\r\n\r\n#### **3.2.3 èµ„æºæœåŠ¡è·å–ç”¨æˆ·èº«ä»½**\r\n\r\nä¸‹è¾¹ç¼–å†™ä¸€ä¸ªå·¥å…·ç±»åœ¨å„ä¸ªå¾®æœåŠ¡ä¸­å»ä½¿ç”¨ï¼Œè·å–å½“å‰ç™»å½•ç”¨æˆ·çš„å¯¹è±¡ã€‚\r\n\r\nåœ¨`content-api`ä¸­å®šä¹‰æ­¤ç±»ï¼š\r\n\r\n```java\r\n/**\r\n * @description è·å–å½“å‰ç”¨æˆ·èº«ä»½å·¥å…·ç±»\r\n */\r\n@Slf4j\r\npublic class SecurityUtil {\r\n\r\n    public static XcUser getUser() {\r\n        try {\r\n            Object principalObj = SecurityContextHolder.getContext().getAuthentication().getPrincipal();\r\n            if (principalObj instanceof String) {\r\n                //å–å‡ºç”¨æˆ·èº«ä»½ä¿¡æ¯\r\n                String principal = principalObj.toString();\r\n                //å°†jsonè½¬æˆå¯¹è±¡\r\n                XcUser user = JSON.parseObject(principal, XcUser.class);\r\n                return user;\r\n            }\r\n        } catch (Exception e) {\r\n            log.error(\"è·å–å½“å‰ç™»å½•ç”¨æˆ·èº«ä»½å‡ºé”™:{}\", e.getMessage());\r\n            e.printStackTrace();\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n\r\n    @Data\r\n    public static class XcUser implements Serializable {\r\n\r\n        private static final long serialVersionUID = 1L;\r\n\r\n        private String id;\r\n\r\n        private String username;\r\n\r\n        private String password;\r\n\r\n        private String salt;\r\n\r\n        private String name;\r\n        private String nickname;\r\n        private String wxUnionid;\r\n        private String companyId;\r\n        /**\r\n         * å¤´åƒ\r\n         */\r\n        private String userpic;\r\n\r\n        private String utype;\r\n\r\n        private LocalDateTime birthday;\r\n\r\n        private String sex;\r\n\r\n        private String email;\r\n\r\n        private String cellphone;\r\n\r\n        private String qq;\r\n\r\n        /**\r\n         * ç”¨æˆ·çŠ¶æ€\r\n         */\r\n        private String status;\r\n\r\n        private LocalDateTime createTime;\r\n\r\n        private LocalDateTime updateTime;\r\n\r\n\r\n    }\r\n\r\n\r\n}\r\n```\r\n\r\nä¸‹è¾¹åœ¨å†…å®¹ç®¡ç†æœåŠ¡ä¸­æµ‹è¯•æ­¤å·¥å…·ç±»ï¼Œä»¥æŸ¥è¯¢è¯¾ç¨‹ä¿¡æ¯æ¥å£ä¸ºä¾‹ï¼š\r\n\r\n```java\r\n@ApiOperation(\"æ ¹æ®è¯¾ç¨‹idæŸ¥è¯¢è¯¾ç¨‹åŸºç¡€ä¿¡æ¯\")\r\n@GetMapping(\"/course/{courseId}\")\r\npublic CourseBaseInfoDto getCourseBaseById(@PathVariable(\"courseId\") Long courseId){\r\n    //å–å‡ºå½“å‰ç”¨æˆ·èº«ä»½\r\n//    Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();\r\n   SecurityUtil.XcUser user = SecurityUtil.getUser();\r\n    System.out.println(user);\r\n\r\n    return courseBaseInfoService.getCourseBaseInfo(courseId);\r\n}\r\n```\r\n\r\né‡å¯å†…å®¹ç®¡ç†æœåŠ¡ï¼š\r\n\r\n1ã€å¯åŠ¨è®¤è¯æœåŠ¡ã€ç½‘å…³ã€å†…å®¹ç®¡ç†æœåŠ¡\r\n\r\n2ã€ç”Ÿæˆæ–°çš„ä»¤ç‰Œ\r\n\r\n3ã€æºå¸¦ä»¤ç‰Œè®¿é—®å†…å®¹ç®¡ç†æœåŠ¡çš„æŸ¥è¯¢è¯¾ç¨‹æ¥å£\r\n\r\n![image-20230705224419107](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224419107.png) \r\n\r\n \r\n\r\n### **3.3 æ”¯æŒè®¤è¯æ–¹å¼å¤šæ ·**\r\n\r\n#### **3.3.1 ç»Ÿä¸€è®¤è¯å…¥å£**\r\n\r\n \r\n\r\nç›®å‰å„å¤§ç½‘ç«™çš„è®¤è¯æ–¹å¼éå¸¸ä¸°å¯Œï¼šè´¦å·å¯†ç è®¤è¯ã€æ‰‹æœºéªŒè¯ç è®¤è¯ã€æ‰«ç ç™»å½•ç­‰ã€‚åŸºäºå½“å‰ç ”ç©¶çš„Spring Securityè®¤è¯æµç¨‹å¦‚ä½•æ”¯æŒå¤šæ ·åŒ–çš„è®¤è¯æ–¹å¼å‘¢ï¼Ÿ\r\n\r\n1ã€æ”¯æŒè´¦å·å’Œå¯†ç è®¤è¯\r\n\r\né‡‡ç”¨OAuth2åè®®çš„å¯†ç æ¨¡å¼å³å¯å®ç°ã€‚\r\n\r\n2ã€æ”¯æŒæ‰‹æœºå·åŠ éªŒè¯ç è®¤è¯\r\n\r\nç”¨æˆ·è®¤è¯æäº¤çš„æ˜¯æ‰‹æœºå·å’ŒéªŒè¯ç ï¼Œå¹¶ä¸æ˜¯è´¦å·å’Œå¯†ç ã€‚\r\n\r\n3ã€å¾®ä¿¡æ‰«ç è®¤è¯\r\n\r\nåŸºäºOAuth2åè®®ä¸å¾®ä¿¡äº¤äº’ï¼Œå­¦æˆåœ¨çº¿ç½‘ç«™å‘å¾®ä¿¡æœåŠ¡å™¨ç”³è¯·åˆ°ä¸€ä¸ªä»¤ç‰Œï¼Œç„¶åæºå¸¦ä»¤ç‰Œå»å¾®ä¿¡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒæŸ¥è¯¢æˆåŠŸåˆ™ç”¨æˆ·åœ¨å­¦æˆåœ¨çº¿é¡¹ç›®è®¤è¯é€šè¿‡ã€‚\r\n\r\n \r\n\r\nç›®å‰æˆ‘ä»¬æµ‹è¯•é€šè¿‡OAuth2çš„å¯†ç æ¨¡å¼ï¼Œç”¨æˆ·è®¤è¯ä¼šæäº¤è´¦å·å’Œå¯†ç ï¼Œç”±DaoAuthenticationProviderè°ƒç”¨UserDetailsServiceçš„`loadUserByUsername()`æ–¹æ³•è·å–UserDetailsç”¨æˆ·ä¿¡æ¯ã€‚\r\n\r\nåœ¨å‰è¾¹æˆ‘ä»¬è‡ªå®šä¹‰äº†UserDetailsServiceæ¥å£å®ç°ç±»ï¼Œé€šè¿‡`loadUserByUsername()`æ–¹æ³•æ ¹æ®è´¦å·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ã€‚\r\n\r\nè€Œä¸åŒçš„è®¤è¯æ–¹å¼æäº¤çš„æ•°æ®ä¸ä¸€æ ·ï¼Œæ¯”å¦‚ï¼šæ‰‹æœºåŠ éªŒè¯ç æ–¹å¼ä¼šæäº¤æ‰‹æœºå·å’ŒéªŒè¯ç ï¼Œè´¦å·å¯†ç æ–¹å¼ä¼šæäº¤è´¦å·ã€å¯†ç ã€éªŒè¯ç ã€‚\r\n\r\næˆ‘ä»¬å¯ä»¥åœ¨`loadUserByUsername()`æ–¹æ³•ä¸Šä½œæ–‡ç« ï¼Œå°†ç”¨æˆ·åŸæ¥æäº¤çš„è´¦å·æ•°æ®æ”¹ä¸ºæäº¤jsonæ•°æ®ï¼Œjsonæ•°æ®å¯ä»¥æ‰©å±•ä¸åŒè®¤è¯æ–¹å¼æ‰€æäº¤çš„å„ç§å‚æ•°ã€‚\r\n\r\né¦–å…ˆåˆ›å»ºä¸€ä¸ªDTOç±»è¡¨ç¤ºè®¤è¯çš„å‚æ•°ï¼š\r\n\r\n```java\r\n\r\n\r\n/**\r\n * @description è®¤è¯ç”¨æˆ·è¯·æ±‚å‚æ•°\r\n */\r\n@Data\r\npublic class AuthParamsDto {\r\n\r\n    private String username; //ç”¨æˆ·å\r\n    private String password; //åŸŸ  ç”¨äºæ‰©å±•\r\n    private String cellphone;//æ‰‹æœºå·\r\n    private String checkcode;//éªŒè¯ç \r\n    private String checkcodekey;//éªŒè¯ç key\r\n    private String authType; // è®¤è¯çš„ç±»å‹   password:ç”¨æˆ·åå¯†ç æ¨¡å¼ç±»å‹    sms:çŸ­ä¿¡æ¨¡å¼ç±»å‹\r\n    private Map<String, Object> payload = new HashMap<>();//é™„åŠ æ•°æ®ï¼Œä½œä¸ºæ‰©å±•ï¼Œä¸åŒè®¤è¯ç±»å‹å¯æ‹¥æœ‰ä¸åŒçš„é™„åŠ æ•°æ®ã€‚å¦‚è®¤è¯ç±»å‹ä¸ºçŸ­ä¿¡æ—¶åŒ…å«smsKey : sms:3d21042d054548b08477142bbca95cfa; æ‰€æœ‰æƒ…å†µä¸‹éƒ½åŒ…å«clientId\r\n\r\n\r\n}\r\n```\r\n\r\næ­¤æ—¶`loadUserByUsername()`æ–¹æ³•å¯ä»¥ä¿®æ”¹å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n\r\n/**\r\n * @description è‡ªå®šä¹‰UserDetailsServiceç”¨æ¥å¯¹æ¥Spring Security\r\n */\r\n@Slf4j\r\n@Service\r\npublic class UserServiceImpl implements UserDetailsService {\r\n\r\n    @Autowired\r\n    XcUserMapper xcUserMapper;\r\n\r\n    /**\r\n     * @description æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ç»„æˆç”¨æˆ·èº«ä»½ä¿¡æ¯\r\n     * @param s  AuthParamsDtoç±»å‹çš„jsonæ•°æ®\r\n     * @return org.springframework.security.core.userdetails.UserDetails\r\n     * @author Mr.M\r\n     * @date 2022/9/28 18:30\r\n    */\r\n    @Override\r\n    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {\r\n\r\n        AuthParamsDto authParamsDto = null;\r\n        try {\r\n            //å°†è®¤è¯å‚æ•°è½¬ä¸ºAuthParamsDtoç±»å‹\r\n            authParamsDto = JSON.parseObject(s, AuthParamsDto.class);\r\n        } catch (Exception e) {\r\n            log.info(\"è®¤è¯è¯·æ±‚ä¸ç¬¦åˆé¡¹ç›®è¦æ±‚:{}\",s);\r\n            throw new RuntimeException(\"è®¤è¯è¯·æ±‚æ•°æ®æ ¼å¼ä¸å¯¹\");\r\n        }\r\n        //è´¦å·\r\n        String username = authParamsDto.getUsername();\r\n        XcUser user = xcUserMapper.selectOne(new LambdaQueryWrapper<XcUser>().eq(XcUser::getUsername, username));\r\n        if(user==null){\r\n            //è¿”å›ç©ºè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨\r\n            return null;\r\n        }\r\n        //å–å‡ºæ•°æ®åº“å­˜å‚¨çš„æ­£ç¡®å¯†ç \r\n        String password  =user.getPassword();\r\n        //ç”¨æˆ·æƒé™,å¦‚æœä¸åŠ æŠ¥Cannot pass a null GrantedAuthority collection\r\n        String[] authorities = {\"p1\"};\r\n        //å°†userå¯¹è±¡è½¬json\r\n        String userString = JSON.toJSONString(user);\r\n        //åˆ›å»ºUserDetailså¯¹è±¡\r\n        UserDetails userDetails = User.withUsername(userString).password(password).authorities(authorities).build();\r\n\r\n        return userDetails;\r\n    }\r\n\r\n}\r\n```\r\n\r\nåŸæ¥çš„DaoAuthenticationProvider ä¼šè¿›è¡Œå¯†ç æ ¡éªŒï¼Œç°åœ¨é‡æ–°å®šä¹‰DaoAuthenticationProviderCustomç±»ï¼Œé‡å†™ç±»çš„additionalAuthenticationChecksæ–¹æ³•ã€‚\r\n\r\n```java\r\n\r\npackage com.xuecheng.auth.config;\r\n\r\nimport lombok.extern.slf4j.Slf4j;\r\nimport org.springframework.beans.factory.annotation.Autowired;\r\nimport org.springframework.security.authentication.BadCredentialsException;\r\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\r\nimport org.springframework.security.authentication.dao.DaoAuthenticationProvider;\r\nimport org.springframework.security.core.AuthenticationException;\r\nimport org.springframework.security.core.userdetails.UserDetails;\r\nimport org.springframework.security.core.userdetails.UserDetailsService;\r\nimport org.springframework.stereotype.Component;\r\n\r\n/**\r\n * @description è‡ªå®šä¹‰DaoAuthenticationProvider\r\n */\r\n@Slf4j\r\n@Component\r\npublic class DaoAuthenticationProviderCustom extends DaoAuthenticationProvider {\r\n\r\n\r\n @Autowired\r\n public void setUserDetailsService(UserDetailsService userDetailsService) {\r\n  super.setUserDetailsService(userDetailsService);\r\n }\r\n\r\n\r\n //å±è”½å¯†ç å¯¹æ¯”\r\n protected void additionalAuthenticationChecks(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication) throws AuthenticationException {\r\n\r\n\r\n }\r\n\r\n}\r\n```\r\n\r\nä¿®æ”¹WebSecurityConfigç±»æŒ‡å®šdaoAuthenticationProviderCustom\r\n\r\n```java\r\n\r\n@Autowired\r\nDaoAuthenticationProviderCustom daoAuthenticationProviderCustom;\r\n\r\n\r\n@Override\r\nprotected void configure(AuthenticationManagerBuilder auth) throws Exception {\r\n    auth.authenticationProvider(daoAuthenticationProviderCustom);\r\n}\r\n```\r\n\r\næ­¤æ—¶å¯ä»¥é‡å¯è®¤è¯æœåŠ¡ï¼Œæµ‹è¯•ç”³è¯·ä»¤ç‰Œæ¥å£ï¼Œä¼ å…¥çš„è´¦å·ä¿¡æ¯æ”¹ä¸ºjsonæ•°æ®ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```http\r\n################æ‰©å±•è®¤è¯è¯·æ±‚å‚æ•°å######################\r\n###å¯†ç æ¨¡å¼\r\nPOST {{auth_host}}/auth/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=password&username={\"username\":\"stu1\",\"authType\":\"password\",\"password\":\"111111\"}\r\n```\r\n\r\nç»è¿‡æµ‹è¯•å‘ç°`loadUserByUsername()`æ–¹æ³•å¯ä»¥æ­£å¸¸æ¥æ”¶åˆ°è®¤è¯è¯·æ±‚ä¸­çš„jsonæ•°æ®ã€‚\r\n\r\næœ‰äº†è¿™äº›è®¤è¯å‚æ•°æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªè®¤è¯Serviceæ¥å£å»è¿›è¡Œå„ç§æ–¹å¼çš„è®¤è¯ã€‚\r\n\r\nå®šä¹‰ç”¨æˆ·ä¿¡æ¯ï¼Œä¸ºäº†æ‰©å±•æ€§è®©å®ƒç»§æ‰¿XcUser\r\n\r\n```java\r\n@Data\r\npublic class XcUserExt extends XcUser {\r\n}\r\n```\r\n\r\nå®šä¹‰è®¤è¯Service æ¥å£\r\n\r\n```java\r\n\r\n/**\r\n * @description è®¤è¯service\r\n */\r\npublic interface AuthService {\r\n\r\n   /**\r\n    * @description è®¤è¯æ–¹æ³•\r\n    * @param authParamsDto è®¤è¯å‚æ•°\r\n    * @return com.xuecheng.ucenter.model.po.XcUser ç”¨æˆ·ä¿¡æ¯\r\n   */\r\n   XcUserExt execute(AuthParamsDto authParamsDto);\r\n\r\n}\r\n```\r\n\r\nloadUserByUsername()ä¿®æ”¹å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n@Slf4j\r\n@Service\r\npublic class UserServiceImpl implements UserDetailsService {\r\n\r\n    @Autowired\r\n    XcUserMapper xcUserMapper;\r\n\r\n    @Autowired\r\n    ApplicationContext applicationContext;\r\n\r\n\r\n    /**\r\n     * @description æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ç»„æˆç”¨æˆ·èº«ä»½ä¿¡æ¯\r\n     * @param s  AuthParamsDtoç±»å‹çš„jsonæ•°æ®\r\n     * @return org.springframework.security.core.userdetails.UserDetails\r\n    */\r\n    @Override\r\n    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {\r\n\r\n        AuthParamsDto authParamsDto = null;\r\n        try {\r\n            //å°†è®¤è¯å‚æ•°è½¬ä¸ºAuthParamsDtoç±»å‹\r\n            authParamsDto = JSON.parseObject(s, AuthParamsDto.class);\r\n        } catch (Exception e) {\r\n            log.info(\"è®¤è¯è¯·æ±‚ä¸ç¬¦åˆé¡¹ç›®è¦æ±‚:{}\",s);\r\n            throw new RuntimeException(\"è®¤è¯è¯·æ±‚æ•°æ®æ ¼å¼ä¸å¯¹\");\r\n        }\r\n        //å¼€å§‹è®¤è¯\r\n        authService.execute(authParamsDto);\r\n        .....\r\n```\r\n\r\nåˆ°æ­¤æˆ‘ä»¬åŸºäºSpring Securityè®¤è¯æµç¨‹ä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼š\r\n\r\n![image-20230705224445890](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224445890.png) \r\n\r\n \r\n\r\n#### **3.3.2 å®ç°è´¦å·å¯†ç è®¤è¯**\r\n\r\nä¸ŠèŠ‚å®šä¹‰äº†AuthServiceè®¤è¯æ¥å£ï¼Œä¸‹è¾¹å®ç°è¯¥æ¥å£å®ç°è´¦å·å¯†ç è®¤è¯\r\n\r\n```java\r\n\r\n\r\n/**\r\n * @description è´¦å·å¯†ç è®¤è¯\r\n */\r\n @Service(\"password_authservice\")\r\npublic class PasswordAuthServiceImpl implements AuthService {\r\n\r\n @Autowired\r\n XcUserMapper xcUserMapper;\r\n\r\n @Autowired\r\n PasswordEncoder passwordEncoder;\r\n\r\n\r\n @Override\r\n public XcUserExt execute(AuthParamsDto authParamsDto) {\r\n\r\n  //è´¦å·\r\n  String username = authParamsDto.getUsername();\r\n  XcUser user = xcUserMapper.selectOne(new LambdaQueryWrapper<XcUser>().eq(XcUser::getUsername, username));\r\n  if(user==null){\r\n   //è¿”å›ç©ºè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨\r\n   throw new RuntimeException(\"è´¦å·ä¸å­˜åœ¨\");\r\n  }\r\n  XcUserExt xcUserExt = new XcUserExt();\r\n  BeanUtils.copyProperties(user,xcUserExt);\r\n  //æ ¡éªŒå¯†ç \r\n  //å–å‡ºæ•°æ®åº“å­˜å‚¨çš„æ­£ç¡®å¯†ç \r\n  String passwordDb  =user.getPassword();\r\n  String passwordForm = authParamsDto.getPassword();\r\n  boolean matches = passwordEncoder.matches(passwordForm, passwordDb);\r\n  if(!matches){\r\n   throw new RuntimeException(\"è´¦å·æˆ–å¯†ç é”™è¯¯\");\r\n  }\r\n  return xcUserExt;\r\n }\r\n}\r\n```\r\n\r\nä¿®æ”¹UserServiceImplç±»ï¼Œæ ¹æ®è®¤è¯æ–¹å¼ä½¿ç”¨ä¸åŒçš„è®¤è¯bean\r\n\r\n```java\r\n/**\r\n * @description è‡ªå®šä¹‰UserDetailsServiceç”¨æ¥å¯¹æ¥Spring Security\r\n */\r\n@Slf4j\r\n@Service\r\npublic class UserServiceImpl implements UserDetailsService {\r\n\r\n    @Autowired\r\n    XcUserMapper xcUserMapper;\r\n\r\n    @Autowired\r\n    ApplicationContext applicationContext;\r\n\r\n//    @Autowired\r\n//    AuthService authService;\r\n\r\n    /**\r\n     * @description æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ç»„æˆç”¨æˆ·èº«ä»½ä¿¡æ¯\r\n     * @param s  AuthParamsDtoç±»å‹çš„jsonæ•°æ®\r\n     * @return org.springframework.security.core.userdetails.UserDetails\r\n    */\r\n    @Override\r\n    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {\r\n\r\n        AuthParamsDto authParamsDto = null;\r\n        try {\r\n            //å°†è®¤è¯å‚æ•°è½¬ä¸ºAuthParamsDtoç±»å‹\r\n            authParamsDto = JSON.parseObject(s, AuthParamsDto.class);\r\n        } catch (Exception e) {\r\n            log.info(\"è®¤è¯è¯·æ±‚ä¸ç¬¦åˆé¡¹ç›®è¦æ±‚:{}\",s);\r\n            throw new RuntimeException(\"è®¤è¯è¯·æ±‚æ•°æ®æ ¼å¼ä¸å¯¹\");\r\n        }\r\n\r\n        //è®¤è¯æ–¹æ³•\r\n        String authType = authParamsDto.getAuthType();\r\n        AuthService authService =  applicationContext.getBean(authType + \"_authservice\",AuthService.class);\r\n        XcUserExt user = authService.execute(authParamsDto);\r\n\r\n        return getUserPrincipal(user);\r\n    }\r\n\r\n\r\n    /**\r\n     * @description æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\r\n     * @param user  ç”¨æˆ·idï¼Œä¸»é”®\r\n     * @return com.xuecheng.ucenter.model.po.XcUser ç”¨æˆ·ä¿¡æ¯\r\n    */\r\n    public UserDetails getUserPrincipal(XcUserExt user){\r\n        //ç”¨æˆ·æƒé™,å¦‚æœä¸åŠ æŠ¥Cannot pass a null GrantedAuthority collection\r\n        String[] authorities = {\"p1\"};\r\n        String password = user.getPassword();\r\n        //ä¸ºäº†å®‰å…¨åœ¨ä»¤ç‰Œä¸­ä¸æ”¾å¯†ç \r\n        user.setPassword(null);\r\n        //å°†userå¯¹è±¡è½¬json\r\n        String userString = JSON.toJSONString(user);\r\n        //åˆ›å»ºUserDetailså¯¹è±¡\r\n        UserDetails userDetails = User.withUsername(userString).password(password ).authorities(authorities).build();\r\n        return userDetails;\r\n    }\r\n\r\n}\r\n```\r\n\r\né‡å¯è®¤è¯æœåŠ¡ï¼Œæµ‹è¯•ç”³è¯·ä»¤ç‰Œæ¥å£ã€‚\r\n\r\n1ã€æµ‹è¯•è´¦å·å’Œå¯†ç éƒ½æ­£ç¡®çš„æƒ…å†µæ˜¯å¦å¯ä»¥ç”³è¯·ä»¤ç‰ŒæˆåŠŸã€‚\r\n\r\n2ã€æµ‹è¯•å¯†ç é”™è¯¯çš„æƒ…å†µã€‚\r\n\r\n3ã€æµ‹è¯•è´¦å·ä¸å­˜åœ¨æƒ…å†µã€‚\r\n\r\n \r\n\r\n### **3.4 éªŒè¯ç æœåŠ¡**\r\n\r\n#### **3.4.1 åˆ›å»ºéªŒè¯ç æœåŠ¡å·¥ç¨‹**\r\n\r\nåœ¨è®¤è¯æ—¶ä¸€èˆ¬éƒ½éœ€è¦è¾“å…¥éªŒè¯ç ï¼ŒéªŒè¯ç æœ‰ä»€ä¹ˆç”¨ï¼Ÿ\r\n\r\néªŒè¯ç å¯ä»¥é˜²æ­¢æ¶æ€§æ”»å‡»ï¼Œæ¯”å¦‚ï¼šXSSè·¨ç«™è„šæœ¬æ”»å‡»ã€CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»ï¼Œä¸€äº›æ¯”è¾ƒå¤æ‚çš„å›¾å½¢éªŒè¯ç å¯ä»¥æœ‰æ•ˆçš„é˜²æ­¢æ¶æ€§æ”»å‡»ã€‚\r\n\r\nä¸ºäº†ä¿æŠ¤ç³»ç»Ÿçš„å®‰å…¨åœ¨ä¸€äº›æ¯”è¾ƒé‡è¦çš„æ“ä½œéƒ½éœ€è¦éªŒè¯ç ã€‚\r\n\r\n![image-20230705224522221](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224522221.png) \r\n\r\néªŒè¯ç çš„ç±»å‹ä¹Ÿæœ‰å¾ˆå¤šï¼šå›¾ç‰‡ã€è¯­éŸ³ã€æ‰‹æœºçŸ­ä¿¡éªŒè¯ç ç­‰ã€‚\r\n\r\næœ¬é¡¹ç›®åˆ›å»ºå•ç‹¬çš„éªŒè¯ç æœåŠ¡ä¸ºå„ä¸šåŠ¡æä¾›éªŒè¯ç çš„ç”Ÿæˆã€æ ¡éªŒç­‰æœåŠ¡ã€‚\r\n\r\næ‹·è´è¯¾ç¨‹èµ„æ–™ç›®å½•xuecheng-plus-checkcodeéªŒè¯ç æœåŠ¡å·¥ç¨‹åˆ°è‡ªå·±çš„å·¥ç¨‹ç›®å½•ã€‚\r\n\r\n![image-20230705224535229](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224535229.png) \r\n\r\nå®šä¹‰nacosé…ç½®æ–‡ä»¶\r\n\r\n```yaml\r\nserver:\r\n  servlet:\r\n    context-path: /checkcode\r\n  port: 63075\r\n```\r\n\r\næ³¨æ„ä¿®æ”¹bootstrap.ymlä¸­çš„å‘½åç©ºé—´ä¸ºè‡ªå·±å®šä¹‰çš„å‘½åç©ºé—´ã€‚\r\n\r\né…ç½®redis-dev.yamlï¼Œ\r\n\r\n![image-20230705224558927](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224558927.png) \r\n\r\nå†…å®¹å¦‚ä¸‹ï¼š\r\n\r\n```yaml\r\nspring: \r\n  redis:\r\n    host: 192.168.101.65\r\n    port: 6379\r\n    password: redis\r\n    database: 0\r\n    lettuce:\r\n      pool:\r\n        max-active: 20\r\n        max-idle: 10\r\n        min-idle: 0\r\n    timeout: 10000\r\n    #redisson:\r\n      #é…ç½®æ–‡ä»¶ç›®å½•\r\n      #config: classpath:singleServerConfig.yaml\r\n```\r\n\r\n#### **3.4.2 éªŒè¯ç æ¥å£æµ‹è¯•**\r\n\r\néªŒè¯ç æœåŠ¡å¯¹å¤–æä¾›çš„æ¥å£æœ‰ï¼š\r\n\r\n1ã€ç”ŸæˆéªŒè¯ç \r\n\r\n2ã€æ ¡éªŒéªŒè¯ç ã€‚\r\n\r\nå¦‚ä¸‹ï¼š\r\n\r\n![image-20230705224626767](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224626767.png) \r\n\r\néªŒè¯ç æœåŠ¡å¦‚ä½•ç”Ÿæˆå¹¶æ ¡éªŒéªŒè¯ç ï¼Ÿ\r\n\r\næ‹¿å›¾ç‰‡éªŒè¯ç ä¸¾ä¾‹ï¼š\r\n\r\n1ã€å…ˆç”Ÿæˆä¸€ä¸ªæŒ‡å®šä½æ•°çš„éªŒè¯ç ï¼Œæ ¹æ®éœ€è¦å¯èƒ½æ˜¯æ•°å­—ã€æ•°å­—å­—æ¯ç»„åˆæˆ–æ–‡å­—ã€‚\r\n\r\n2ã€æ ¹æ®ç”Ÿæˆçš„éªŒè¯ç ç”Ÿæˆä¸€ä¸ªå›¾ç‰‡å¹¶è¿”å›ç»™é¡µé¢\r\n\r\n3ã€ç»™ç”Ÿæˆçš„éªŒè¯ç åˆ†é…ä¸€ä¸ªkeyï¼Œå°†keyå’ŒéªŒè¯ç ä¸€åŒå­˜å…¥ç¼“å­˜ã€‚è¿™ä¸ªkeyå’Œå›¾ç‰‡ä¸€åŒè¿”å›ç»™é¡µé¢ã€‚\r\n\r\n4ã€ç”¨æˆ·è¾“å…¥éªŒè¯ç ï¼Œè¿åŒkeyä¸€åŒæäº¤è‡³è®¤è¯æœåŠ¡ã€‚\r\n\r\n5ã€è®¤è¯æœåŠ¡æ‹¿keyå’Œè¾“å…¥çš„éªŒè¯ç è¯·æ±‚éªŒè¯ç æœåŠ¡å»æ ¡éªŒ\r\n\r\n6ã€éªŒè¯ç æœåŠ¡æ ¹æ®keyä»ç¼“å­˜å–å‡ºæ­£ç¡®çš„éªŒè¯ç å’Œç”¨æˆ·è¾“å…¥çš„éªŒè¯ç è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœç›¸åŒåˆ™æ ¡éªŒé€šè¿‡ï¼Œå¦åˆ™ä¸é€šè¿‡ã€‚\r\n\r\n![image-20230705224639354](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224639354.png) \r\n\r\næ ¹æ®æ¥å£åˆ†æï¼ŒéªŒè¯ç æœåŠ¡æ¥å£å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n@Api(value = \"éªŒè¯ç æœåŠ¡æ¥å£\")\r\n@RestController\r\npublic class CheckCodeController {\r\n\r\n\r\n    @ApiOperation(value=\"ç”ŸæˆéªŒè¯ä¿¡æ¯\", notes=\"ç”ŸæˆéªŒè¯ä¿¡æ¯\")\r\n    @PostMapping(value = \"/pic\")\r\n    public CheckCodeResultDto generatePicCheckCode(CheckCodeParamsDto checkCodeParamsDto){\r\n        \r\n    }\r\n\r\n    @ApiOperation(value=\"æ ¡éªŒ\", notes=\"æ ¡éªŒ\")\r\n    @ApiImplicitParams({\r\n            @ApiImplicitParam(name = \"name\", value = \"ä¸šåŠ¡åç§°\", required = true, dataType = \"String\", paramType=\"query\"),\r\n            @ApiImplicitParam(name = \"key\", value = \"éªŒè¯key\", required = true, dataType = \"String\", paramType=\"query\"),\r\n            @ApiImplicitParam(name = \"code\", value = \"éªŒè¯ç \", required = true, dataType = \"String\", paramType=\"query\")\r\n    })\r\n    @PostMapping(value = \"/verify\")\r\n    public Boolean verify(String key, String code){\r\n        \r\n    }\r\n}\r\n```\r\n\r\n1ã€ç”ŸæˆéªŒè¯ç æ¥å£\r\n\r\n```http\r\n### ç”³è¯·éªŒè¯ç \r\nPOST {{checkcode_host}}/checkcode/pic\r\n```\r\n\r\n\r\n\r\n2ã€æ ¡éªŒéªŒè¯ç æ¥å£\r\n\r\næ ¹æ®ç”ŸæˆéªŒè¯ç è¿”å›çš„keyä»¥åŠæ—¥å¿—ä¸­è¾“å‡ºæ­£ç¡®çš„éªŒè¯ç å»æµ‹è¯•ã€‚\r\n\r\n```http\r\n### æ ¡éªŒéªŒè¯ç \r\nPOST {{checkcode_host}}/checkcode/verify?key=checkcode4506b95bddbe46cdb0d56810b747db1b&code=70dl\r\n```\r\n\r\n### **3.5 è´¦å·å¯†ç è®¤è¯**\r\n\r\n#### **3.5.1 éœ€æ±‚åˆ†æ**\r\n\r\nåˆ°ç›®å‰ä¸ºæ­¢è´¦å·å’Œå¯†ç è®¤è¯æ‰€éœ€è¦çš„æŠ€æœ¯ã€ç»„ä»¶éƒ½å·²å¼€å‘å®Œæ¯•ï¼Œä¸‹è¾¹å®ç°è´¦å·å¯†ç è®¤è¯ï¼Œè¾“å‡ºå¦‚ä¸‹å›¾ï¼š\r\n\r\n![image-20230705224656789](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224656789.png) \r\n\r\næ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![image-20230705224709647](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224709647.png) \r\n\r\n#### **3.5.2 è´¦å·å¯†ç è®¤è¯å¼€å‘**\r\n\r\n1ã€åœ¨è®¤è¯æœåŠ¡å®šä¹‰è¿œç¨‹è°ƒç”¨éªŒè¯ç æœåŠ¡çš„æ¥å£\r\n\r\n```java\r\n\r\n/**\r\n * @description æœç´¢æœåŠ¡è¿œç¨‹æ¥å£\r\n */\r\n @FeignClient(value = \"checkcode\",fallbackFactory = CheckCodeClientFactory.class)\r\n @RequestMapping(\"/checkcode\")\r\npublic interface CheckCodeClient {\r\n\r\n @PostMapping(value = \"/verify\")\r\n public Boolean verify(@RequestParam(\"key\") String key,@RequestParam(\"code\") String code);\r\n\r\n}\r\n```\r\n\r\nCheckCodeClientFactory:\r\n\r\n```java\r\n@Slf4j\r\n@Component\r\npublic class CheckCodeClientFactory implements FallbackFactory<CheckCodeClient> {\r\n    @Override\r\n    public CheckCodeClient create(Throwable throwable) {\r\n        return new CheckCodeClient() {\r\n\r\n            @Override\r\n            public Boolean verify(String key, String code) {\r\n                log.debug(\"è°ƒç”¨éªŒè¯ç æœåŠ¡ç†”æ–­å¼‚å¸¸:{}\", throwable.getMessage());\r\n                return null;\r\n            }\r\n        };\r\n    }\r\n}\r\n```\r\n\r\nå¯åŠ¨ç±»æ·»åŠ ï¼š\r\n\r\n`@EnableFeignClients(basePackages={\"com.xuecheng.*.feignclient\"})`\r\n\r\né…ç½®æ–‡ä»¶å¼•å…¥feign-dev.yaml\r\n\r\n```yaml\r\n- data-id: feign-${spring.profiles.active}.yaml\r\n  group: xuecheng-plus-common\r\n  refresh: true\r\n```\r\n\r\n2ã€å®Œå–„PasswordAuthServiceImpl\r\n\r\n```java\r\n\r\n\r\n/**\r\n * @description è´¦å·å¯†ç è®¤è¯\r\n */\r\n @Service(\"password_authservice\")\r\npublic class PasswordAuthServiceImpl implements AuthService {\r\n\r\n @Autowired\r\n XcUserMapper xcUserMapper;\r\n\r\n @Autowired\r\n PasswordEncoder passwordEncoder;\r\n @Autowired\r\n CheckCodeClient checkCodeClient;\r\n\r\n @Override\r\n public XcUser execute(AuthParamsDto authParamsDto) {\r\n\r\n  //æ ¡éªŒéªŒè¯ç \r\n  String checkcode = authParamsDto.getCheckcode();\r\n  String checkcodekey = authParamsDto.getCheckcodekey();\r\n\r\n  if(StringUtils.isBlank(checkcodekey) || StringUtils.isBlank(checkcode)){\r\n   throw new RuntimeException(\"éªŒè¯ç ä¸ºç©º\");\r\n\r\n  }\r\n  Boolean verify = checkCodeClient.verify(checkcodekey, checkcode);\r\n  if(!verify){\r\n   throw new RuntimeException(\"éªŒè¯ç è¾“å…¥é”™è¯¯\");\r\n  }\r\n  //è´¦å·\r\n  String username = authParamsDto.getUsername();\r\n  XcUser user = xcUserMapper.selectOne(new LambdaQueryWrapper<XcUser>().eq(XcUser::getUsername, username));\r\n  if(user==null){\r\n   //è¿”å›ç©ºè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨\r\n   throw new RuntimeException(\"è´¦å·ä¸å­˜åœ¨\");\r\n  }\r\n  //æ ¡éªŒå¯†ç \r\n  //å–å‡ºæ•°æ®åº“å­˜å‚¨çš„æ­£ç¡®å¯†ç \r\n  String passwordDb  =user.getPassword();\r\n  String passwordForm = authParamsDto.getPassword();\r\n  boolean matches = passwordEncoder.matches(passwordForm, passwordDb);\r\n  if(!matches){\r\n   throw new RuntimeException(\"è´¦å·æˆ–å¯†ç é”™è¯¯\");\r\n  }\r\n  return user;\r\n }\r\n}\r\n```\r\n\r\nå°æŠ€å·§ï¼šç›®å‰è´¦å·å¯†ç æ–¹å¼æ·»åŠ äº†éªŒè¯ç æ ¡éªŒï¼Œä¸ºäº†åæœŸè·å–ä»¤ç‰Œæ–¹ä¾¿å¯ä»¥é‡æ–°å®šä¹‰ä¸€ä¸ªä¸éœ€è¦éªŒè¯ç æ ¡éªŒçš„è®¤è¯ç±»AuthService ï¼ŒAuthService ä¸­å»æ‰éªŒè¯ç çš„æ ¡éªŒï¼Œæ–¹ä¾¿ç”Ÿæˆä»¤ç‰Œã€‚\r\n\r\n \r\n\r\n#### **3.5.3 è´¦å·å¯†ç è®¤è¯æµ‹è¯•**\r\n\r\n1ã€ä½¿ç”¨æµè§ˆå™¨è®¿é—® `http://www.51xuecheng.cn/sign.html`\r\n\r\n![image-20230705224731189](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224731189.png) \r\n\r\n2ã€é¦–å…ˆæµ‹è¯•éªŒè¯ç ï¼Œåˆ†åˆ«è¾“å…¥æ­£ç¡®çš„éªŒè¯ç å’Œé”™è¯¯çš„éªŒè¯ç è¿›è¡Œæµ‹è¯•\r\n\r\n3ã€è¾“å…¥æ­£ç¡®çš„è´¦å·å¯†ç å’Œé”™è¯¯çš„è´¦å·å¯†ç è¿›è¡Œæµ‹è¯•\r\n\r\nç™»å½•æˆåŠŸå°†jwtä»¤ç‰Œå­˜å‚¨cookie.\r\n\r\n4ã€æµ‹è¯•è‡ªåŠ¨ç™»å½•\r\n\r\nå‹¾é€‰è‡ªåŠ¨ç™»å½•cookieç”Ÿæˆæ—¶é—´ä¸º30å¤©ï¼Œä¸å‹¾é€‰è‡ªåŠ¨ç™»å½•å…³é—­æµè§ˆå™¨çª—å£åè‡ªåŠ¨åˆ é™¤cookieã€‚\r\n\r\n \r\n\r\n \r\n\r\n## **4 å¾®ä¿¡æ‰«ç ç™»å½•**\r\n\r\n### **4.1 æ¥å…¥è§„èŒƒ**\r\n\r\n#### **4.1.1 æ¥å…¥æµç¨‹**\r\n\r\nå¾®ä¿¡æ‰«ç ç™»å½•åŸºäºOAuth2åè®®çš„æˆæƒç æ¨¡å¼ï¼Œ\r\n\r\næ¥å£æ–‡æ¡£ï¼š\r\n\r\nhttps://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html\r\n\r\næµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![image-20230705224756059](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224756059.png) \r\n\r\nç¬¬ä¸‰æ–¹åº”ç”¨è·å–access_tokenä»¤ç‰Œåå³å¯è¯·æ±‚å¾®ä¿¡è·å–ç”¨æˆ·çš„ä¿¡æ¯ï¼ŒæˆåŠŸè·å–åˆ°ç”¨æˆ·çš„ä¿¡æ¯è¡¨ç¤ºç”¨æˆ·åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨è®¤è¯æˆåŠŸã€‚\r\n\r\n#### **4.1.2 è¯·æ±‚è·å–æˆæƒç **\r\n\r\nç¬¬ä¸‰æ–¹ä½¿ç”¨ç½‘ç«™åº”ç”¨æˆæƒç™»å½•å‰è¯·æ³¨æ„å·²è·å–ç›¸åº”ç½‘é¡µæˆæƒä½œç”¨åŸŸï¼ˆ`scope=snsapi_login`ï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡åœ¨ PC ç«¯æ‰“å¼€ä»¥ä¸‹é“¾æ¥ï¼š https://open.weixin.qq.com/connect/qrconnect?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect è‹¥æç¤ºâ€œè¯¥é“¾æ¥æ— æ³•è®¿é—®â€ï¼Œè¯·æ£€æŸ¥å‚æ•°æ˜¯å¦å¡«å†™é”™è¯¯ï¼Œå¦‚`redirect_uri`çš„åŸŸåä¸å®¡æ ¸æ—¶å¡«å†™çš„æˆæƒåŸŸåä¸ä¸€è‡´æˆ– scope ä¸ä¸º`snsapi_login`ã€‚\r\n\r\n**å‚æ•°è¯´æ˜**\r\n\r\n![image-20230705224807325](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705224807325.png) \r\n\r\n**è¿”å›è¯´æ˜**\r\n\r\nç”¨æˆ·å…è®¸æˆæƒåï¼Œå°†ä¼šé‡å®šå‘åˆ°`redirect_uri`çš„ç½‘å€ä¸Šï¼Œå¹¶ä¸”å¸¦ä¸Š code å’Œstateå‚æ•°\r\n\r\n```http\r\nredirect_uri?code=CODE&state=STATE\r\n```\r\n\r\nè‹¥ç”¨æˆ·ç¦æ­¢æˆæƒï¼Œåˆ™ä¸ä¼šå‘ç”Ÿé‡å®šå‘ã€‚\r\n\r\nç™»å½•ä¸€å·åº—ç½‘ç«™åº”ç”¨ https://test.yhd.com/wechat/login.do æ‰“å¼€åï¼Œä¸€å·åº—ä¼šç”Ÿæˆ state å‚æ•°ï¼Œè·³è½¬åˆ° https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&redirect_uri=https%3A%2F%2Fpassport.yhd.com%2Fwechat%2Fcallback.do&response_type=code&scope=snsapi_login&state=3d6be0a4035d839573b04816624a415e#wechat_redirect å¾®ä¿¡ç”¨æˆ·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç å¹¶ä¸”ç¡®è®¤ç™»å½•åï¼ŒPCç«¯ä¼šè·³è½¬åˆ° https://test.yhd.com/wechat/callback.do?code=CODE&state=3d6be0a40sssssxxxxx6624a415e ä¸ºäº†æ»¡è¶³ç½‘ç«™æ›´å®šåˆ¶åŒ–çš„éœ€æ±‚ï¼Œæˆ‘ä»¬è¿˜æä¾›äº†ç¬¬äºŒç§è·å– code çš„æ–¹å¼ï¼Œæ”¯æŒç½‘ç«™å°†å¾®ä¿¡ç™»å½•äºŒç»´ç å†…åµŒåˆ°è‡ªå·±é¡µé¢ä¸­ï¼Œç”¨æˆ·ä½¿ç”¨å¾®ä¿¡æ‰«ç æˆæƒåé€šè¿‡ JS å°†codeè¿”å›ç»™ç½‘ç«™ã€‚ JSå¾®ä¿¡ç™»å½•ä¸»è¦ç”¨é€”ï¼šç½‘ç«™å¸Œæœ›ç”¨æˆ·åœ¨ç½‘ç«™å†…å°±èƒ½å®Œæˆç™»å½•ï¼Œæ— éœ€è·³è½¬åˆ°å¾®ä¿¡åŸŸä¸‹ç™»å½•åå†è¿”å›ï¼Œæå‡å¾®ä¿¡ç™»å½•çš„æµç•…æ€§ä¸æˆåŠŸç‡ã€‚ ç½‘ç«™å†…åµŒäºŒç»´ç å¾®ä¿¡ç™»å½• JS å®ç°åŠæ³•ï¼š\r\n\r\næ­¥éª¤1ï¼šåœ¨é¡µé¢ä¸­å…ˆå¼•å…¥å¦‚ä¸‹ JS æ–‡ä»¶ï¼ˆæ”¯æŒhttpsï¼‰ï¼š\r\n\r\n```http\r\nhttp://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js\r\n```\r\n\r\næ­¥éª¤2ï¼šåœ¨éœ€è¦ä½¿ç”¨å¾®ä¿¡ç™»å½•çš„åœ°æ–¹å®ä¾‹ä»¥ä¸‹ JS å¯¹è±¡ï¼š\r\n\r\n```js\r\n var obj = new WxLogin({\r\n self_redirect:true,\r\n id:\"login_container\", \r\n appid: \"\", \r\n scope: \"\", \r\n redirect_uri: \"\",\r\n  state: \"\",\r\n style: \"\",\r\n href: \"\"\r\n });\r\n```\r\n\r\n![image-20230705225019477](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225019477.png)\r\n\r\n \r\n\r\n#### **4.1.3 é€šè¿‡ code è·å–access_token**\r\n\r\né€šè¿‡ code è·å–`access_token`\r\n\r\n```http\r\nhttps://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&secret=SECRET&code=CODE&grant_type=authorization_code\r\n```\r\n\r\n![image-20230705225158430](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225158430.png)\r\n\r\n**è¿”å›è¯´æ˜**\r\n\r\næ­£ç¡®çš„è¿”å›ï¼š\r\n\r\n```json\r\n{ \r\n\"access_token\":\"ACCESS_TOKEN\", \r\n\"expires_in\":7200, \r\n\"refresh_token\":\"REFRESH_TOKEN\",\r\n\"openid\":\"OPENID\", \r\n\"scope\":\"SCOPE\",\r\n\"unionid\": \"o6_bmasdasdsad6_2sgVt7hMZOPfL\"\r\n}\r\n```\r\n\r\n**å‚æ•°è¯´æ˜**\r\n\r\n![image-20230705225227368](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225227368.png) \r\n\r\né”™è¯¯è¿”å›æ ·ä¾‹ï¼š\r\n\r\n```json\r\n{\"errcode\":40029,\"errmsg\":\"invalid code\"}\r\n```\r\n\r\n#### **4.1.4 é€šè¿‡access_tokenè°ƒç”¨æ¥å£**\r\n\r\nè·å–access_tokenåï¼Œè¿›è¡Œæ¥å£è°ƒç”¨ï¼Œæœ‰ä»¥ä¸‹å‰æï¼š\r\n\r\n```json\r\naccess_tokenæœ‰æ•ˆä¸”æœªè¶…æ—¶ï¼›\r\nå¾®ä¿¡ç”¨æˆ·å·²æˆæƒç»™ç¬¬ä¸‰æ–¹åº”ç”¨å¸å·ç›¸åº”æ¥å£ä½œç”¨åŸŸï¼ˆscopeï¼‰ã€‚\r\n```\r\n\r\nå¯¹äºæ¥å£ä½œç”¨åŸŸï¼ˆscopeï¼‰ï¼Œèƒ½è°ƒç”¨çš„æ¥å£æœ‰ä»¥ä¸‹ï¼š\r\n\r\n![image-20230705225242753](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225242753.png) \r\n\r\n \r\n\r\n å…¶ä¸­`snsapi_base`å±äºåŸºç¡€æ¥å£ï¼Œè‹¥åº”ç”¨å·²æ‹¥æœ‰å…¶å®ƒ scope æƒé™ï¼Œåˆ™é»˜è®¤æ‹¥æœ‰`snsapi_base`çš„æƒé™ã€‚ä½¿ç”¨`snsapi_base`å¯ä»¥è®©ç§»åŠ¨ç«¯ç½‘é¡µæˆæƒç»•è¿‡è·³è½¬æˆæƒç™»å½•é¡µè¯·æ±‚ç”¨æˆ·æˆæƒçš„åŠ¨ä½œï¼Œç›´æ¥è·³è½¬ç¬¬ä¸‰æ–¹ç½‘é¡µå¸¦ä¸Šæˆæƒä¸´æ—¶ç¥¨æ®ï¼ˆcodeï¼‰ï¼Œä½†ä¼šä½¿å¾—ç”¨æˆ·å·²æˆæƒä½œç”¨åŸŸï¼ˆscopeï¼‰ä»…ä¸º`snsapi_base`ï¼Œä»è€Œå¯¼è‡´æ— æ³•è·å–åˆ°éœ€è¦ç”¨æˆ·æˆæƒæ‰å…è®¸è·å¾—çš„æ•°æ®å’ŒåŸºç¡€åŠŸèƒ½ã€‚ æ¥å£è°ƒç”¨æ–¹æ³•å¯æŸ¥é˜…[ã€Šå¾®ä¿¡æˆæƒå…³ç³»æ¥å£è°ƒç”¨æŒ‡å—ã€‹](https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html)\r\n\r\nè·å–ç”¨æˆ·ä¿¡æ¯æ¥å£æ–‡æ¡£ï¼šhttps://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html\r\n\r\næ¥å£åœ°å€\r\n\r\n```http\r\nhttpè¯·æ±‚æ–¹å¼: GET\r\nhttps://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&openid=OPENID\r\n```\r\n\r\nå¦‚ä¸‹ï¼š\r\n\r\n![image-20230705225302910](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225302910.png) \r\n\r\nå“åº”ï¼š\r\n\r\n![image-20230705225337018](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225337018.png) \r\n\r\nè¯´æ˜å¦‚ä¸‹ï¼š\r\n\r\n> å‚æ•°       è¯´æ˜\r\n> openid     æ™®é€šç”¨æˆ·çš„æ ‡è¯†ï¼Œå¯¹å½“å‰å¼€å‘è€…å¸å·å”¯ä¸€\r\n> nickname     æ™®é€šç”¨æˆ·æ˜µç§°\r\n> sex       æ™®é€šç”¨æˆ·æ€§åˆ«ï¼Œ1ä¸ºç”·æ€§ï¼Œ2ä¸ºå¥³æ€§\r\n> province     æ™®é€šç”¨æˆ·ä¸ªäººèµ„æ–™å¡«å†™çš„çœä»½\r\n> city       æ™®é€šç”¨æˆ·ä¸ªäººèµ„æ–™å¡«å†™çš„åŸå¸‚\r\n> country     å›½å®¶ï¼Œå¦‚ä¸­å›½ä¸ºCN\r\n> headimgurl     ç”¨æˆ·å¤´åƒï¼Œæœ€åä¸€ä¸ªæ•°å€¼ä»£è¡¨æ­£æ–¹å½¢å¤´åƒå¤§å°ï¼ˆæœ‰0ã€46ã€64ã€96ã€132æ•°å€¼å¯é€‰ï¼Œ0ä»£è¡¨640*640æ­£æ–¹å½¢å¤´åƒï¼‰ï¼Œç”¨æˆ·æ²¡æœ‰å¤´åƒæ—¶è¯¥é¡¹ä¸ºç©º\r\n> privilege     ç”¨æˆ·ç‰¹æƒä¿¡æ¯ï¼Œjsonæ•°ç»„ï¼Œå¦‚å¾®ä¿¡æ²ƒå¡ç”¨æˆ·ä¸ºï¼ˆchinaunicomï¼‰\r\n> unionid      ç”¨æˆ·ç»Ÿä¸€æ ‡è¯†ã€‚é’ˆå¯¹ä¸€ä¸ªå¾®ä¿¡å¼€æ”¾å¹³å°å¸å·ä¸‹çš„åº”ç”¨ï¼ŒåŒä¸€ç”¨æˆ·çš„ unionid æ˜¯å”¯ä¸€çš„ã€‚\r\n\r\n### **4.2 å‡†å¤‡å¼€å‘ç¯å¢ƒ**\r\n\r\n#### **4.2.1 æ·»åŠ åº”ç”¨**\r\n\r\n1ã€æ³¨å†Œå¾®ä¿¡å¼€æ”¾å¹³å°\r\n\r\nhttps://open.weixin.qq.com/\r\n\r\n2ã€æ·»åŠ åº”ç”¨\r\n\r\nè¿›å…¥ç½‘ç«™åº”ç”¨ï¼Œæ·»åŠ åº”ç”¨\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225407356.png) \r\n\r\n3ã€æ·»åŠ åº”ç”¨éœ€è¦æŒ‡å®šä¸€ä¸ªå¤–ç½‘åŸŸåä½œä¸ºå¾®ä¿¡å›è°ƒåŸŸå\r\n\r\nå®¡æ ¸é€šè¿‡åï¼Œç”Ÿæˆappå¯†é’¥ã€‚\r\n\r\næœ€ç»ˆè·å–appIDå’ŒAppSecret\r\n\r\n\r\n\r\n\r\n\r\n#### **4.2.2 å†…ç½‘ç©¿é€**\r\n\r\næˆ‘ä»¬çš„å¼€å‘ç¯å¢ƒåœ¨å±€åŸŸç½‘ï¼Œå¾®ä¿¡å›è°ƒæŒ‡å‘ä¸€ä¸ªå…¬ç½‘åŸŸåã€‚\r\n\r\nå¦‚ä½•è®©å¾®ä¿¡å›è°ƒè¯·æ±‚è‡³æˆ‘ä»¬çš„å¼€å‘è®¡ç®—æœºä¸Šå‘¢ï¼Ÿ\r\n\r\nå¯ä»¥ä½¿ç”¨å†…ç½‘ç©¿é€æŠ€æœ¯ï¼Œä»€ä¹ˆæ˜¯å†…ç½‘ç©¿é€ï¼Ÿ\r\n\r\nå†…ç½‘ç©¿é€ç®€å•æ¥è¯´å°±æ˜¯å°†å†…ç½‘å¤–ç½‘é€šè¿‡éš§é“æ‰“é€š,è®©å†…ç½‘çš„æ•°æ®è®©å¤–ç½‘å¯ä»¥è·å–ã€‚æ¯”å¦‚å¸¸ç”¨çš„åŠå…¬å®¤è½¯ä»¶ç­‰ï¼Œä¸€èˆ¬åœ¨åŠå…¬å®¤æˆ–å®¶é‡Œï¼Œé€šè¿‡æ‹¨å·ä¸Šç½‘ï¼Œè¿™æ ·åŠå…¬è½¯ä»¶åªæœ‰åœ¨æœ¬åœ°çš„å±€åŸŸç½‘ä¹‹å†…æ‰èƒ½è®¿é—®ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœæ˜¯æ‰‹æœºä¸Šï¼Œæˆ–è€…å…¬å¸å¤–åœ°çš„åŠå…¬äººå‘˜ï¼Œå¦‚ä½•è®¿é—®åˆ°åŠå…¬è½¯ä»¶å‘¢ï¼Ÿè¿™å°±éœ€è¦å†…ç½‘ç©¿é€å·¥å…·äº†ã€‚å¼€å¯éš§é“ä¹‹åï¼Œç½‘ç©¿é€å·¥å…·ä¼šåˆ†é…ä¸€ä¸ªä¸“å±åŸŸå/ç«¯å£,åŠå…¬è½¯ä»¶å°±å·²ç»åœ¨å…¬ç½‘ä¸Šäº†,åœ¨å¤–åœ°çš„åŠå…¬äººå‘˜å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹æ„‰å¿«çš„è®¿é—®åŠå…¬è½¯ä»¶äº†~~\r\n\r\n![image-20230705225437784](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225437784.png) \r\n\r\n1ã€åœ¨å†…ç½‘ç©¿é€æœåŠ¡å™¨ä¸Šå¼€é€šéš§é“ï¼Œé…ç½®å¤–ç½‘åŸŸåï¼Œé…ç½®ç©¿é€å†…ç½‘çš„ç«¯å£å³æœ¬åœ°ç”µè„‘ä¸Šçš„ç«¯å£ã€‚\r\n\r\n![image-20230705225502880](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225502880.png) \r\n\r\nè¿™é‡Œæˆ‘ä»¬é…ç½®è®¤è¯æœåŠ¡ç«¯å£ï¼Œæœ€ç»ˆå®ç°é€šè¿‡å¤–ç½‘åŸŸåè®¿é—®æœ¬åœ°è®¤è¯æœåŠ¡ã€‚\r\n\r\n2ã€åœ¨æœ¬åœ°ç”µè„‘ä¸Šå®‰è£…å†…ç½‘ç©¿é€çš„å·¥å…·ï¼Œå·¥å…·ä¸Šé…ç½®å†…ç½‘ç©¿é€æœåŠ¡å™¨éš§é“tokenã€‚\r\n\r\nå¸‚é¢ä¸Šåšå†…ç½‘ç©¿é€çš„å•†å®¶å¾ˆå¤šï¼Œéœ€è¦æ—¶å¯ä»¥æŸ¥é˜…èµ„æ–™äº†è§£ä¸‹ã€‚\r\n\r\n \r\n\r\n#### 4.2.3 æ— éœ€ä½¿ç”¨å†…ç½‘ç©¿é€ï¼ˆå›ºå®šç«¯å£ï¼‰\r\n\r\nè®¤è¯æˆæƒæœåŠ¡ä½¿ç”¨è°·ç²’çš„å›ºå®šç«¯å£8160\r\n\r\nåœ¨`nacos`é…ç½®ä¸­å¿ƒé…ç½®\r\n\r\n```properties\r\n#å¾®ä¿¡ç›¸å…³é…ç½®\r\n# å¾®ä¿¡å¼€æ”¾å¹³å° appid\r\nwx.open.app_id=wxed9954c01bb89b47\r\n# å¾®ä¿¡å¼€æ”¾å¹³å° appsecret\r\nwx.open.app_secret=a7482517235173ddb4083788de60b90e\r\n# å¾®ä¿¡å¼€æ”¾å¹³å° é‡å®šå‘url\r\nwx.open.redirect_url=http://localhost:8160/auth/wxLogin\r\n```\r\n\r\nä¿®æ”¹`wxsign.html`ä¸­çš„`appid`å’Œ`redirect_uri`\r\n\r\n```js\r\n//è¯·ç”¨å¾®ä¿¡ç”ŸæˆäºŒç»´ç \r\n  function generateWxQrcode(token) {\r\n    var wxObj = new WxLogin({\r\n        self_redirect:true,\r\n        id:\"login_container\", \r\n        appid: \"wxed9954c01bb89b47\", \r\n        scope: \"snsapi_login\", \r\n        // redirect_uri: \"http://rcar79.natappfree.cc/xuecheng/auth/wxLogin\",\r\n        // redirect_uri: \"http://tjxt-user-t.itheima.net/api/auth/wxLogin\",\r\n        redirect_uri: \"http://localhost:8160/auth/wxLogin\",\r\n        state: token,\r\n        style: \"\",\r\n        href: \"\"\r\n      });\r\n    }\r\n```\r\n\r\n> åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œè¦ä¹ˆå¯åŠ¨éªŒè¯ç æœåŠ¡ï¼Œè¦ä¹ˆå±è”½éªŒè¯ç æ£€éªŒä»£ç ï¼Œå¦åˆ™ç™»å½•äºŒç»´ç æ— æ³•ç”Ÿæˆ\r\n\r\n\r\n\r\n\r\n\r\n### **4.3 æ¥å…¥å¾®ä¿¡ç™»å½•**\r\n\r\n#### **4.3.1 æ¥å…¥åˆ†æ**\r\n\r\næ ¹æ®OAuth2åè®®æˆæƒç æµç¨‹ï¼Œç»“åˆæœ¬é¡¹ç›®è‡ªèº«ç‰¹ç‚¹ï¼Œåˆ†ææ¥å…¥å¾®ä¿¡æ‰«ç ç™»å½•çš„æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![image-20230705225519898](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225519898.png) \r\n\r\næœ¬é¡¹ç›®è®¤è¯æœåŠ¡éœ€è¦åšå“ªäº›äº‹ï¼Ÿ\r\n\r\n1ã€éœ€è¦å®šä¹‰æ¥å£æ¥æ”¶å¾®ä¿¡ä¸‹å‘çš„æˆæƒç ã€‚\r\n\r\n2ã€æ”¶åˆ°æˆæƒç è°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·ä»¤ç‰Œã€‚\r\n\r\n3ã€ç”³è¯·åˆ°ä»¤ç‰Œè°ƒç”¨å¾®ä¿¡è·å–ç”¨æˆ·ä¿¡æ¯\r\n\r\n4ã€è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸå°†å…¶å†™å…¥æœ¬é¡¹ç›®ç”¨æˆ·ä¸­å¿ƒæ•°æ®åº“ã€‚\r\n\r\n5ã€æœ€åé‡å®šå‘åˆ°æµè§ˆå™¨è‡ªåŠ¨ç™»å½•ã€‚\r\n\r\n#### **4.3.2 å®šä¹‰æ¥å£**\r\n\r\nå‚è€ƒæ¥å£è§„èŒƒä¸­â€œè¯·æ±‚è·å–æˆæƒç â€ å®šä¹‰æ¥æ”¶å¾®ä¿¡ä¸‹å‘çš„æˆæƒç æ¥å£ï¼Œ\r\n\r\nå®šä¹‰WxLoginControllerç±»ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n@Slf4j\r\n@Controller\r\npublic class WxLoginController {\r\n\r\n    @RequestMapping(\"/wxLogin\")\r\n    public String wxLogin(String code, String state) throws IOException {\r\n        log.debug(\"å¾®ä¿¡æ‰«ç å›è°ƒ,code:{},state:{}\",code,state);\r\n        //è¯·æ±‚å¾®ä¿¡ç”³è¯·ä»¤ç‰Œï¼Œæ‹¿åˆ°ä»¤ç‰ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å†™å…¥æœ¬é¡¹ç›®æ•°æ®åº“\r\n        XcUser xcUser = new XcUser();\r\n        //æš‚æ—¶ç¡¬ç¼–å†™ï¼Œç›®çš„æ˜¯è°ƒè¯•ç¯å¢ƒ\r\n        xcUser.setUsername(\"t1\");\r\n        if(xcUser==null){\r\n            return \"redirect:http://www.51xuecheng.cn/error.html\";\r\n        }\r\n        String username = xcUser.getUsername();\r\n        return \"redirect:http://www.51xuecheng.cn/sign.html?username=\"+username+\"&authType=wx\";\r\n    }\r\n}\r\n```\r\n\r\nå®šä¹‰å¾®ä¿¡è®¤è¯çš„service\r\n\r\n```java\r\n\r\n\r\n/**\r\n * @description å¾®ä¿¡æ‰«ç è®¤è¯\r\n */\r\n@Slf4j\r\n@Service(\"wx_authservice\")\r\npublic class WxAuthServiceImpl implements AuthService {\r\n\r\n    @Autowired\r\n    XcUserMapper xcUserMapper;\r\n\r\n    @Override\r\n    public XcUserExt execute(AuthParamsDto authParamsDto) {\r\n\r\n        //è´¦å·\r\n        String username = authParamsDto.getUsername();\r\n        XcUser user = xcUserMapper.selectOne(new LambdaQueryWrapper<XcUser>().eq(XcUser::getUsername, username));\r\n        if(user==null){\r\n            //è¿”å›ç©ºè¡¨ç¤ºç”¨æˆ·ä¸å­˜åœ¨\r\n            throw new RuntimeException(\"è´¦å·ä¸å­˜åœ¨\");\r\n        }\r\n        XcUserExt xcUserExt = new XcUserExt();\r\n        BeanUtils.copyProperties(user,xcUserExt);\r\n        return xcUserExt;\r\n    }\r\n}\r\n```\r\n\r\n#### **4.3.3 æ¥å£ç¯å¢ƒæµ‹è¯•**\r\n\r\næ¥å£å®šä¹‰å¥½ä¸‹è¾¹è¿›è¡Œæµ‹è¯•ä¸‹ï¼Œä¸»è¦ç›®çš„æ˜¯æµ‹è¯•æ¥å£è°ƒåº¦çš„ç¯å¢ƒã€‚\r\n\r\n1ã€å¯åŠ¨å†…ç½‘ç©¿é€å·¥å…·\r\n\r\n2ã€åœ¨/wxLoginæ¥å£ä¸­æ‰“æ–­ç‚¹\r\n\r\n3ã€æ‰“å¼€å‰ç«¯å¾®ä¿¡æ‰«ç é¡µé¢\r\n\r\n![image-20230705225557340](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225557340.png) \r\n\r\nç‚¹å‡»å¾®ä¿¡å›¾æ ‡æ‰“å¼€äºŒç»´ç \r\n\r\n![image-20230705225604434](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225604434.png) \r\n\r\nç”¨æˆ·æ‰«ç ï¼Œç¡®è®¤æˆæƒ\r\n\r\næ­¤æ—¶æ­£å¸¸è¿›å…¥ `/wxLogin`  æ–¹æ³•ï¼Œæœ€åè·³è½¬åˆ°`http://www.51xuecheng.cn/sign.html?username=t1&authType=wx`\r\n\r\n \r\n\r\n#### **4.3.4 ç”³è¯·ä»¤ç‰Œ**\r\n\r\næ¥ä¸‹æ¥è¯·æ±‚å¾®ä¿¡ç”³è¯·ä»¤ç‰Œã€‚\r\n\r\n1ã€ä½¿ç”¨restTemplateè¯·æ±‚å¾®ä¿¡ï¼Œé…ç½®RestTemplate bean\r\n\r\nåœ¨å¯åŠ¨ç±»é…ç½®restTemplate\r\n\r\n```java\r\n\r\n    @Bean\r\n    RestTemplate restTemplate(){\r\n        RestTemplate restTemplate = new RestTemplate(new OkHttp3ClientHttpRequestFactory());\r\n        return  restTemplate;\r\n    }\r\n```\r\n\r\nå®šä¹‰ä¸å¾®ä¿¡è®¤è¯çš„serviceæ¥å£ï¼š\r\n\r\n```java\r\n\r\n/**\r\n * @description å¾®ä¿¡è®¤è¯æ¥å£\r\n */\r\npublic interface WxAuthService {\r\n\r\n    public XcUser wxAuth(String code);\r\n\r\n}\r\n```\r\n\r\nç»§ç»­åœ¨WxAuthServiceImplç±»å†™WxAuthService æ¥å£çš„å®ç°ï¼Œåœ¨å…¶ä¸­å®šä¹‰ç”³è¯·ä»¤ç‰Œçš„ç§æœ‰æ–¹æ³•å¹¶ç”±wxAuthæ–¹æ³•å»è°ƒç”¨ï¼š\r\n\r\n```java\r\n\r\n@Slf4j\r\n@Service(\"wx_authservice\")\r\npublic class WxAuthServiceImpl implements AuthService, WxAuthService {\r\n@Autowired\r\nXcUserMapper xcUserMapper;\r\n@Autowired\r\nRestTemplate restTemplate;\r\n\r\n@Value(\"${weixin.appid}\")\r\nString appid;\r\n@Value(\"${weixin.secret}\")\r\nString secret;\r\n\r\npublic XcUser wxAuth(String code){\r\n\r\n    //æ”¶åˆ°codeè°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token\r\n    Map<String, String> access_token_map = getAccess_token(code);\r\n    if(access_token_map==null){\r\n        return null;\r\n    }\r\n    //è·å–ç”¨æˆ·ä¿¡æ¯\r\n   \r\n    //æ·»åŠ ç”¨æˆ·åˆ°æ•°æ®åº“\r\n    XcUser xcUser = null;\r\n   \r\n    return xcUser;\r\n}\r\n\r\n\r\n/**\r\n * ç”³è¯·è®¿é—®ä»¤ç‰Œ,å“åº”ç¤ºä¾‹\r\n {\r\n \"access_token\":\"ACCESS_TOKEN\",\r\n \"expires_in\":7200,\r\n \"refresh_token\":\"REFRESH_TOKEN\",\r\n \"openid\":\"OPENID\",\r\n \"scope\":\"SCOPE\",\r\n \"unionid\": \"o6_bmasdasdsad6_2sgVt7hMZOPfL\"\r\n }\r\n*/\r\nprivate Map<String,String> getAccess_token(String code) {\r\n\r\n    String wxUrl_template = \"https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&secret=%s&code=%s&grant_type=authorization_code\";\r\n    //è¯·æ±‚å¾®ä¿¡åœ°å€\r\n    String wxUrl = String.format(wxUrl_template, appid, secret, code);\r\n\r\n    log.info(\"è°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token, url:{}\", wxUrl);\r\n\r\n    ResponseEntity<String> exchange = restTemplate.exchange(wxUrl, HttpMethod.POST, null, String.class);\r\n\r\n    String result = exchange.getBody();\r\n    log.info(\"è°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token: è¿”å›å€¼:{}\", result);\r\n    Map<String,String> resultMap = JSON.parseObject(result, Map.class);\r\n\r\n    return resultMap;\r\n}\r\n....\r\n```\r\n\r\nä¸‹è¾¹åœ¨controllerä¸­è°ƒç”¨wxAuthæ¥å£ï¼š\r\n\r\n```java\r\n\r\n@Slf4j\r\n@Controller\r\npublic class WxLoginController {\r\n\r\n    @Autowired\r\n    WxAuthService wxAuthService;\r\n\r\n    @RequestMapping(\"/wxLogin\")\r\n    public String wxLogin(String code, String state) throws IOException {\r\n        log.debug(\"å¾®ä¿¡æ‰«ç å›è°ƒ,code:{},state:{}\",code,state);\r\n        //è¯·æ±‚å¾®ä¿¡ç”³è¯·ä»¤ç‰Œï¼Œæ‹¿åˆ°ä»¤ç‰ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å†™å…¥æœ¬é¡¹ç›®æ•°æ®åº“\r\n        XcUser xcUser = wxAuthService.wxAuth(code);\r\n        if(xcUser==null){\r\n            return \"redirect:http://www.51xuecheng.cn/error.html\";\r\n        }\r\n        String username = xcUser.getUsername();\r\n        return \"redirect:http://www.51xuecheng.cn/sign.html?username=\"+username+\"&authType=wx\";\r\n    }\r\n}\r\n```\r\n\r\næµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯\r\n\r\n1ã€åœ¨wxAuthServiceä¸­è·å–ç”¨æˆ·ä¿¡æ¯å¤„æ‰“æ–­ç‚¹\r\n\r\n2ã€è¿›å…¥`http://www.51xuecheng.cn/wxsign.html`\r\n\r\n3ã€æ‰‹æœºæ‰«ç å¹¶æˆæƒï¼Œè§‚å¯Ÿæ˜¯å¦æˆåŠŸç”³è¯·åˆ°ä»¤ç‰Œ\r\n\r\n \r\n\r\n#### **4.3.5 è·å–ç”¨æˆ·ä¿¡æ¯**\r\n\r\nåœ¨WxAuthServiceImplç±»ä¸­å®šä¹‰è·å–ç”¨æˆ·ä¿¡æ¯æ–¹æ³•ï¼š\r\n\r\n```java\r\n\r\n/**è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š\r\n {\r\n \"openid\":\"OPENID\",\r\n \"nickname\":\"NICKNAME\",\r\n \"sex\":1,\r\n \"province\":\"PROVINCE\",\r\n \"city\":\"CITY\",\r\n \"country\":\"COUNTRY\",\r\n \"headimgurl\": \"https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0\",\r\n \"privilege\":[\r\n \"PRIVILEGE1\",\r\n \"PRIVILEGE2\"\r\n ],\r\n \"unionid\": \" o6_bmasdasdsad6_2sgVt7hMZOPfL\"\r\n }\r\n*/\r\nprivate Map<String,String> getUserinfo(String access_token,String openid) {\r\n\r\n    String wxUrl_template = \"https://api.weixin.qq.com/sns/userinfo?access_token=%s&openid=%s\";\r\n    //è¯·æ±‚å¾®ä¿¡åœ°å€\r\n    String wxUrl = String.format(wxUrl_template, access_token,openid);\r\n\r\n    log.info(\"è°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token, url:{}\", wxUrl);\r\n\r\n    ResponseEntity<String> exchange = restTemplate.exchange(wxUrl, HttpMethod.POST, null, String.class);\r\n\r\n    //é˜²æ­¢ä¹±ç è¿›è¡Œè½¬ç \r\n    String result = new     String(exchange.getBody().getBytes(StandardCharsets.ISO_8859_1),StandardCharsets.UTF_8);\r\n    log.info(\"è°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token: è¿”å›å€¼:{}\", result);\r\n    Map<String,String> resultMap = JSON.parseObject(result, Map.class);\r\n\r\n    return resultMap;\r\n}\r\n```\r\n\r\nè°ƒç”¨è·å–ç”¨æˆ·ä¿¡æ¯ã€‚\r\n\r\n```java\r\n\r\npublic XcUser wxAuth(String code){\r\n\r\n    //æ”¶åˆ°codeè°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token\r\n    Map<String, String> access_token_map = getAccess_token(code);\r\n    if(access_token_map==null){\r\n        return null;\r\n    }\r\n    System.out.println(access_token_map);\r\n    String openid = access_token_map.get(\"openid\");\r\n    String access_token = access_token_map.get(\"access_token\");\r\n    //æ‹¿access_tokenæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\r\n    Map<String, String> userinfo = getUserinfo(access_token, openid);\r\n    if(userinfo==null){\r\n        return null;\r\n    }\r\n    //æ·»åŠ ç”¨æˆ·åˆ°æ•°æ®åº“\r\n    XcUser xcUser = null;\r\n    \r\n    return xcUser;\r\n}\r\n```\r\n\r\næµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯\r\n\r\n1ã€åœ¨è·å–ç”¨æˆ·ä¿¡æ¯å¤„æ‰“æ–­ç‚¹\r\n\r\n2ã€è¿›å…¥`http://www.51xuecheng.cn/wxsign.html`\r\n\r\n3ã€æ‰‹æœºæ‰«ç æˆæƒ\r\n\r\n \r\n\r\n#### **4.3.6 ä¿å­˜ç”¨æˆ·ä¿¡æ¯**\r\n\r\nå‘æ•°æ®åº“ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœç”¨æˆ·ä¸å­˜åœ¨å°†å…¶ä¿å­˜åœ¨æ•°æ®åº“ã€‚\r\n\r\n```java\r\n\r\n@Autowired\r\nXcUserRoleMapper xcUserRoleMapper;\r\n\r\n@Transactional\r\npublic XcUser addWxUser(Map userInfo_map){\r\n    String unionid = userInfo_map.get(\"unionid\").toString();\r\n    //æ ¹æ®unionidæŸ¥è¯¢æ•°æ®åº“\r\n    XcUser xcUser = xcUserMapper.selectOne(new LambdaQueryWrapper<XcUser>().eq(XcUser::getWxUnionid, unionid));\r\n    if(xcUser!=null){\r\n        return xcUser;\r\n    }\r\n    String userId = UUID.randomUUID().toString();\r\n    xcUser = new XcUser();\r\n    xcUser.setId(userId);\r\n    xcUser.setWxUnionid(unionid);\r\n    //è®°å½•ä»å¾®ä¿¡å¾—åˆ°çš„æ˜µç§°\r\n    xcUser.setNickname(userInfo_map.get(\"nickname\").toString());\r\n    xcUser.setUserpic(userInfo_map.get(\"headimgurl\").toString());\r\n    xcUser.setName(userInfo_map.get(\"nickname\").toString());\r\n    xcUser.setUsername(unionid);\r\n    xcUser.setPassword(unionid);\r\n    xcUser.setUtype(\"101001\");//å­¦ç”Ÿç±»å‹\r\n    xcUser.setStatus(\"1\");//ç”¨æˆ·çŠ¶æ€\r\n    xcUser.setCreateTime(LocalDateTime.now());\r\n    xcUserMapper.insert(xcUser);\r\n    XcUserRole xcUserRole = new XcUserRole();\r\n    xcUserRole.setId(UUID.randomUUID().toString());\r\n    xcUserRole.setUserId(userId);\r\n    xcUserRole.setRoleId(\"17\");//å­¦ç”Ÿè§’è‰²\r\n    xcUserRoleMapper.insert(xcUserRole);\r\n    return xcUser;\r\n}\r\n```\r\n\r\nè°ƒç”¨ä¿å­˜ç”¨æˆ·ä¿¡æ¯\r\n\r\n```java\r\n\r\n@Autowired\r\nWxAuthServiceImpl currentProxy;\r\n\r\npublic XcUser wxAuth(String code){\r\n\r\n    //æ”¶åˆ°codeè°ƒç”¨å¾®ä¿¡æ¥å£ç”³è¯·access_token\r\n    Map<String, String> access_token_map = getAccess_token(code);\r\n    if(access_token_map==null){\r\n        return null;\r\n    }\r\n    System.out.println(access_token_map);\r\n    String openid = access_token_map.get(\"openid\");\r\n    String access_token = access_token_map.get(\"access_token\");\r\n    //æ‹¿access_tokenæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\r\n    Map<String, String> userinfo = getUserinfo(access_token, openid);\r\n    if(userinfo==null){\r\n        return null;\r\n    }\r\n    //å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“\r\n    XcUser xcUser = currentProxy.addWxUser(userinfo);\r\n    return xcUser;\r\n}\r\n```\r\n\r\næµ‹è¯•ä¿å­˜ç”¨æˆ·ä¿¡æ¯\r\n\r\n1ã€åœ¨ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤„æ‰“æ–­ç‚¹\r\n\r\n2ã€è¿›å…¥`http://www.51xuecheng.cn/wxsign.html`\r\n\r\n3ã€æ‰‹æœºæ‰«ç æˆæƒ\r\n\r\n4ã€è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œæäº¤è®¤è¯æˆåŠŸã€‚\r\n\r\n \r\n\r\n## **5 ç”¨æˆ·æˆæƒ**\r\n\r\n### **5.1 RBAC**\r\n\r\nå¦‚ä½•å®ç°æˆæƒï¼Ÿä¸šç•Œé€šå¸¸åŸºäºRBACå®ç°æˆæƒã€‚\r\n\r\nRBACåˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼š\r\n\r\nåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRole-Based Access Controlï¼‰\r\n\r\nåŸºäºèµ„æºçš„è®¿é—®æ§åˆ¶ï¼ˆResource-Based Access Controlï¼‰\r\n\r\nè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRole-Based Access Controlï¼‰æ˜¯æŒ‰è§’è‰²è¿›è¡Œæˆæƒï¼Œæ¯”å¦‚ï¼šä¸»ä½“çš„è§’è‰²ä¸ºæ€»ç»ç†å¯ä»¥æŸ¥è¯¢ä¼ä¸šè¿è¥æŠ¥è¡¨ï¼ŒæŸ¥è¯¢å‘˜å·¥å·¥èµ„ä¿¡æ¯ç­‰ï¼Œè®¿é—®æ§åˆ¶æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![image-20230705225635823](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225635823.png) \r\n\r\næ ¹æ®ä¸Šå›¾ä¸­çš„åˆ¤æ–­é€»è¾‘ï¼Œæˆæƒä»£ç å¯è¡¨ç¤ºå¦‚ä¸‹ï¼š\r\n\r\n```java\r\nif(ä¸»ä½“.hasRole(\"æ€»ç»ç†è§’è‰²id\")){\r\næŸ¥è¯¢å·¥èµ„\r\n}\r\n```\r\n\r\nå¦‚æœä¸Šå›¾ä¸­æŸ¥è¯¢å·¥èµ„æ‰€éœ€è¦çš„è§’è‰²å˜åŒ–ä¸ºæ€»ç»ç†å’Œéƒ¨é—¨ç»ç†ï¼Œæ­¤æ—¶å°±éœ€è¦ä¿®æ”¹åˆ¤æ–­é€»è¾‘ä¸ºâ€œåˆ¤æ–­ç”¨æˆ·çš„è§’è‰²æ˜¯å¦æ˜¯æ€»ç»ç†æˆ–éƒ¨é—¨ç»ç†â€ï¼Œä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š\r\n\r\n```java\r\nif(ä¸»ä½“.hasRole(\"æ€»ç»ç†è§’è‰²id\") ||  ä¸»ä½“.hasRole(\"éƒ¨é—¨ç»ç†è§’è‰²id\")){\r\n    æŸ¥è¯¢å·¥èµ„\r\n}\r\n```\r\n\r\næ ¹æ®ä¸Šè¾¹çš„ä¾‹å­å‘ç°ï¼Œå½“éœ€è¦ä¿®æ”¹è§’è‰²çš„æƒé™æ—¶å°±éœ€è¦ä¿®æ”¹æˆæƒçš„ç›¸å…³ä»£ç ï¼Œç³»ç»Ÿå¯æ‰©å±•æ€§å·®ã€‚\r\n\r\n \r\n\r\nåŸºäºèµ„æºçš„è®¿é—®æ§åˆ¶ï¼ˆResource-Based Access\r\n\r\nControlï¼‰æ˜¯æŒ‰èµ„æºï¼ˆæˆ–æƒé™ï¼‰è¿›è¡Œæˆæƒï¼Œæ¯”å¦‚ï¼šç”¨æˆ·å¿…é¡»å…·æœ‰æŸ¥è¯¢å·¥èµ„æƒé™æ‰å¯ä»¥æŸ¥è¯¢å‘˜å·¥å·¥èµ„ä¿¡æ¯ç­‰ï¼Œè®¿é—®æ§åˆ¶æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![image-20230705225645727](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225645727.png) \r\n\r\næ ¹æ®ä¸Šå›¾ä¸­çš„åˆ¤æ–­ï¼Œæˆæƒä»£ç å¯ä»¥è¡¨ç¤ºä¸ºï¼š\r\n\r\n```java\r\nif(ä¸»ä½“.hasPermission(\"æŸ¥è¯¢å·¥èµ„æƒé™æ ‡è¯†\")){\r\n    æŸ¥è¯¢å·¥èµ„\r\n}\r\n```\r\n\r\nä¼˜ç‚¹ï¼šç³»ç»Ÿè®¾è®¡æ—¶å®šä¹‰å¥½æŸ¥è¯¢å·¥èµ„çš„æƒé™æ ‡è¯†ï¼Œå³ä½¿æŸ¥è¯¢å·¥èµ„æ‰€éœ€è¦çš„è§’è‰²å˜åŒ–ä¸ºæ€»ç»ç†å’Œéƒ¨é—¨ç»ç†ä¹Ÿä¸éœ€è¦ä¿®æ”¹æˆæƒä»£ç ï¼Œç³»ç»Ÿå¯æ‰©å±•æ€§å¼ºã€‚\r\n\r\n \r\n\r\n### **5.2 èµ„æºæœåŠ¡æˆæƒæµç¨‹**\r\n\r\næœ¬é¡¹ç›®åœ¨èµ„æºæœåŠ¡å†…éƒ¨è¿›è¡Œæˆæƒï¼ŒåŸºäºèµ„æºçš„æˆæƒæ¨¡å¼ï¼Œå› ä¸ºæ¥å£åœ¨èµ„æºæœåŠ¡ï¼Œé€šè¿‡åœ¨æ¥å£å¤„æ·»åŠ æˆæƒæ³¨è§£å®ç°æˆæƒã€‚\r\n\r\n1ã€é¦–å…ˆé…ç½®nginxä»£ç†\r\n\r\n```apl\r\n\r\n   http {\r\n    server_names_hash_bucket_size 64;\r\n    ...\r\n   \r\n   #å‰ç«¯å¼€å‘æœåŠ¡\r\n  upstream uidevserver{\r\n    server 127.0.0.1:8601 weight=10;\r\n  } \r\n   server {\r\n        listen       80;\r\n        server_name  teacher.51xuecheng.cn;\r\n        #charset koi8-r;\r\n        ssi on;\r\n        ssi_silent_errors on;\r\n        #access_log  logs/host.access.log  main;\r\n        #location / {\r\n         #   alias   D:/itcast2022/xc_edu3.0/code_1/dist/;\r\n         #   index  index.html index.htm;\r\n        #}\r\n        location / {\r\n            proxy_pass   http://uidevserver;\r\n        }\r\n\r\n        location /api/ {\r\n                proxy_pass http://gatewayserver/;\r\n        } \r\n        \r\n        \r\n   }\r\n```\r\n\r\nåŠ è½½nginx é…ç½®ã€‚\r\n\r\n \r\n\r\n2ã€åœ¨èµ„æºæœåŠ¡é›†æˆSpring Security\r\n\r\nåœ¨éœ€è¦æˆæƒçš„æ¥å£å¤„ä½¿ç”¨`@PreAuthorize(\"hasAuthority('æƒé™æ ‡è¯†ç¬¦')\")`è¿›è¡Œæ§åˆ¶\r\n\r\nä¸‹è¾¹ä»£ç æŒ‡å®š`/course/list`æ¥å£éœ€è¦æ‹¥æœ‰`xc_teachmanager_course_list` æƒé™ã€‚\r\n\r\n![image-20230705225657359](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225657359.png) \r\n\r\nè®¾ç½®äº†`@PreAuthorize`è¡¨ç¤ºæ‰§è¡Œæ­¤æ–¹æ³•éœ€è¦æˆæƒï¼Œå¦‚æœå½“å‰ç”¨æˆ·è¯·æ±‚æ¥å£æ²¡æœ‰æƒé™åˆ™æŠ›å‡ºå¼‚å¸¸\r\n\r\n`org.springframework.security.access.AccessDeniedException`: ä¸å…è®¸è®¿é—®\r\n\r\n3ã€åœ¨ç»Ÿä¸€å¼‚å¸¸å¤„ç†å¤„è§£ææ­¤å¼‚å¸¸ä¿¡æ¯\r\n\r\n```java\r\n@ResponseBody\r\n@ExceptionHandler(Exception.class)\r\n@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)\r\npublic RestErrorResponse exception(Exception e) {\r\n\r\n   log.error(\"ã€ç³»ç»Ÿå¼‚å¸¸ã€‘{}\",e.getMessage(),e);\r\n   e.printStackTrace();\r\n   if(e.getMessage().equals(\"ä¸å…è®¸è®¿é—®\")){\r\n      return new RestErrorResponse(\"æ²¡æœ‰æ“ä½œæ­¤åŠŸèƒ½çš„æƒé™\");\r\n   }\r\n   return new RestErrorResponse(CommonError.UNKOWN_ERROR.getErrMessage());\r\n\r\n\r\n}\r\n```\r\n\r\n4ã€é‡å¯èµ„æºæœåŠ¡è¿›è¡Œæµ‹è¯•\r\n\r\nä½¿ç”¨æ•™å­¦æœºæ„ç”¨æˆ·ç™»å½•ç³»ç»Ÿ\r\n\r\nè¿™é‡Œä½¿ç”¨t1ç”¨æˆ·ç™»å½•ï¼Œè´¦å·:t1ã€å¯†ç ï¼š111111\r\n\r\nç™»å½•æˆåŠŸï¼Œç‚¹å‡»â€œæ•™å­¦æœºæ„â€\r\n\r\n![image-20230705225706766](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225706766.png) \r\n\r\nå½“ç”¨æˆ·æ²¡æœ‰æƒé™æ—¶é¡µé¢æç¤ºï¼šæ²¡æœ‰æ“ä½œæ­¤åŠŸèƒ½çš„æƒé™ã€‚\r\n\r\n![image-20230705225713175](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225713175.png) \r\n\r\n### **5.3 æˆæƒç›¸å…³çš„æ•°æ®æ¨¡å‹**\r\n\r\nå¦‚ä½•ç»™ç”¨æˆ·åˆ†é…æƒé™å‘¢ï¼Ÿ\r\n\r\né¦–å…ˆè¦å­¦ä¹ æ•°æ®æ¨¡å‹ï¼Œæœ¬é¡¹ç›®æˆæƒç›¸å…³çš„æ•°æ®è¡¨å¦‚ä¸‹ï¼š\r\n\r\n![image-20230705225720492](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225720492.png) \r\n\r\nè¯´æ˜å¦‚ä¸‹ï¼š\r\n\r\n`xc_user`ï¼šç”¨æˆ·è¡¨ï¼Œå­˜å‚¨äº†ç³»ç»Ÿç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·ç±»å‹åŒ…æ‹¬ï¼šå­¦ç”Ÿã€è€å¸ˆã€ç®¡ç†å‘˜ç­‰\r\n\r\n`xc_role`ï¼šè§’è‰²è¡¨ï¼Œå­˜å‚¨äº†ç³»ç»Ÿçš„è§’è‰²ä¿¡æ¯ï¼Œå­¦ç”Ÿã€è€å¸ˆã€æ•™å­¦ç®¡ç†å‘˜ã€ç³»ç»Ÿç®¡ç†å‘˜ç­‰ã€‚\r\n\r\n`xc_user_role`ï¼šç”¨æˆ·è§’è‰²è¡¨ï¼Œä¸€ä¸ªç”¨æˆ·å¯æ‹¥æœ‰å¤šä¸ªè§’è‰²ï¼Œä¸€ä¸ªè§’è‰²å¯è¢«å¤šä¸ªç”¨æˆ·æ‰€æ‹¥æœ‰\r\n\r\n`xc_menu`ï¼šæ¨¡å—è¡¨ï¼Œè®°å½•äº†èœå•åŠèœå•ä¸‹çš„æƒé™\r\n\r\n`xc_permission`ï¼šè§’è‰²æƒé™è¡¨ï¼Œä¸€ä¸ªè§’è‰²å¯æ‹¥æœ‰å¤šä¸ªæƒé™ï¼Œä¸€ä¸ªæƒé™å¯è¢«å¤šä¸ªè§’è‰²æ‰€æ‹¥æœ‰\r\n\r\n \r\n\r\næœ¬é¡¹ç›®æ•™å­¦é˜¶æ®µä¸å†å®ç°æƒé™å®šä¹‰åŠç”¨æˆ·æƒé™åˆ†é…çš„åŠŸèƒ½ï¼Œæƒé™åˆ†é…çš„ç•Œé¢åŸå‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\r\n\r\n![image-20230705225732787](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225732787.png) \r\n\r\n \r\n\r\næœ¬é¡¹ç›®è¦æ±‚æŒæ¡åŸºäºæƒé™æ•°æ®æ¨¡å‹ï¼ˆ5å¼ æ•°æ®è¡¨ï¼‰ï¼Œè¦æ±‚åœ¨æ•°æ®åº“ä¸­æ“ä½œå®Œæˆç»™ç”¨æˆ·åˆ†é…æƒé™ã€æŸ¥è¯¢ç”¨æˆ·æƒé™ç­‰éœ€æ±‚ã€‚\r\n\r\n1ã€æŸ¥è¯¢ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™\r\n\r\næ­¥éª¤ï¼š\r\n\r\næŸ¥è¯¢ç”¨æˆ·çš„id\r\n\r\næŸ¥è¯¢ç”¨æˆ·æ‰€æ‹¥æœ‰çš„è§’è‰²\r\n\r\næŸ¥è¯¢ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™\r\n\r\nä¾‹å­ï¼š\r\n\r\n```sql\r\nSELECT * FROM xc_menu WHERE id IN(\r\n  SELECT menu_id FROM xc_permission WHERE role_id IN(\r\n    SELECT role_id FROM xc_user_role WHERE user_id = '49'\r\n  )\r\n)\r\n```\r\n\r\n2ã€ç»™ç”¨æˆ·åˆ†é…æƒé™\r\n\r\n1ï¼‰æ·»åŠ æƒé™\r\n\r\næŸ¥è¯¢ç”¨æˆ·çš„id\r\n\r\næŸ¥è¯¢æƒé™çš„id\r\n\r\næŸ¥è¯¢ç”¨æˆ·çš„è§’è‰²ï¼Œå¦‚æœæ²¡æœ‰è§’è‰²éœ€è¦å…ˆç»™ç”¨æˆ·æŒ‡å®šè§’è‰²\r\n\r\nå‘è§’è‰²æƒé™è¡¨æ·»åŠ è®°å½•\r\n\r\n2ï¼‰åˆ é™¤ç”¨æˆ·æƒé™\r\n\r\næœ¬é¡¹ç›®æ˜¯åŸºäºè§’è‰²åˆ†é…æƒé™ï¼Œå¦‚æœè¦åˆ é™¤ç”¨æˆ·çš„æƒé™å¯ä»¥ç»™ç”¨æˆ·æ¢è§’è‰²ï¼Œé‚£ä¹ˆæ–°è§’è‰²ä¸‹çš„æƒé™å°±æ˜¯ç”¨æˆ·çš„æƒé™ï¼›å¦‚æœä¸æ¢ç”¨æˆ·çš„è§’è‰²å¯ä»¥åˆ é™¤è§’è‰²ä¸‹çš„æƒé™å³åˆ é™¤è§’è‰²æƒé™å…³ç³»è¡¨ç›¸åº”è®°å½•ï¼Œè¿™æ ·æ“ä½œæ˜¯å°†è§’è‰²ä¸‹çš„æƒé™åˆ é™¤ï¼Œå±äºè¯¥è§’è‰²çš„ç”¨æˆ·éƒ½å°†åˆ é™¤æ­¤æƒé™ã€‚\r\n\r\n \r\n\r\n### **5.4 æŸ¥è¯¢ç”¨æˆ·æƒé™**\r\n\r\nä½¿ç”¨Spring Securityè¿›è¡Œæˆæƒï¼Œé¦–å…ˆåœ¨ç”Ÿæˆjwtå‰ä¼šæŸ¥è¯¢ç”¨æˆ·çš„æƒé™ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![image-20230705225743413](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225743413.png) \r\n\r\næ¥ä¸‹æ¥éœ€è¦ä¿®æ”¹UserServiceImplå’ŒPasswordAuthServiceImplä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·çš„æƒé™ã€‚\r\n\r\n1ã€å®šä¹‰mapperæ¥å£\r\n\r\n```java\r\npublic interface XcMenuMapper extends BaseMapper<XcMenu> {\r\n    @Select(\"SELECT    * FROM xc_menu WHERE id IN (SELECT menu_id FROM xc_permission WHERE role_id IN ( SELECT role_id FROM xc_user_role WHERE user_id = #{userId} ))\")\r\n    List<XcMenu> selectPermissionByUserId(@Param(\"userId\") String userId);\r\n}\r\n```\r\n\r\n2ã€ä¿®æ”¹PasswordAuthServiceImpl\r\n\r\nä¿®æ”¹UserServiceImplç±»çš„getUserPrincipalæ–¹æ³•ï¼ŒæŸ¥è¯¢æƒé™ä¿¡æ¯\r\n\r\n```java\r\n\r\n//æŸ¥è¯¢ç”¨æˆ·èº«ä»½\r\npublic UserDetails getUserPrincipal(XcUserExt user){\r\n    String password = user.getPassword();\r\n    //æŸ¥è¯¢ç”¨æˆ·æƒé™\r\n    List<XcMenu> xcMenus = menuMapper.selectPermissionByUserId(user.getId());\r\n    List<String> permissions = new ArrayList<>();\r\n    if(xcMenus.size()<=0){\r\n        //ç”¨æˆ·æƒé™,å¦‚æœä¸åŠ åˆ™æŠ¥Cannot pass a null GrantedAuthority collection\r\n        permissions.add(\"p1\");\r\n    }else{\r\n        xcMenus.forEach(menu->{\r\n            permissions.add(menu.getCode());\r\n        });\r\n    }\r\n    //å°†ç”¨æˆ·æƒé™æ”¾åœ¨XcUserExtä¸­\r\n    user.setPermissions(permissions);\r\n\r\n    //ä¸ºäº†å®‰å…¨åœ¨ä»¤ç‰Œä¸­ä¸æ”¾å¯†ç \r\n    user.setPassword(null);\r\n    //å°†userå¯¹è±¡è½¬json\r\n    String userString = JSON.toJSONString(user);\r\n    String[] authorities = permissions.toArray(new String[0]);\r\n    UserDetails userDetails = User.withUsername(userString).password(password).authorities(authorities).build();\r\n    return userDetails;\r\n\r\n}\r\n```\r\n\r\n### **5.5 æˆæƒæµ‹è¯•**\r\n\r\nä»¥ä¸Šå®ç°äº†è®¤è¯æ—¶ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·çš„æƒé™ï¼Œä¸‹è¾¹è¿›è¡Œç”¨æˆ·æˆæƒæµ‹è¯•ã€‚\r\n\r\n \r\n\r\né‡å¯è®¤è¯æœåŠ¡ï¼Œä½¿ç”¨å†…å®¹ç®¡ç†è¯¾ç¨‹åˆ—è¡¨æŸ¥è¯¢ä¸ºä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š\r\n\r\n![image-20230705225751417](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225751417.png) \r\n\r\nç”¨æˆ·æ‹¥æœ‰`xc_teachmanager_course_list`æƒé™æ–¹å¯è®¿é—®è¯¾ç¨‹æŸ¥è¯¢æ¥å£ã€‚\r\n\r\nä»¥ç”¨æˆ·stu1ä¸ºä¾‹ï¼Œå½“å®ƒæ²¡æœ‰æ­¤æƒé™æ—¶é¡µé¢æŠ¥â€œæ²¡æœ‰æ­¤æ“ä½œçš„æƒé™â€é”™è¯¯\r\n\r\n![image-20230705225757328](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225757328.png) \r\n\r\nå°†`xc_teachmanager_course_list`æƒé™åˆ†é…ç»™ç”¨æˆ·ã€‚\r\n\r\n1ï¼‰é¦–å…ˆæ‰¾åˆ°å½“å‰ç”¨æˆ·çš„è§’è‰²\r\n\r\n2ï¼‰æ‰¾åˆ°`xc_teachmanager_course_list`æƒé™çš„ä¸»é”®\r\n\r\n3ï¼‰åœ¨è§’è‰²æƒé™å…³ç³»è¡¨ä¸­æ·»åŠ è®°å½•\r\n\r\nåˆ†é…å®Œæƒé™éœ€è¦é‡æ–°ç™»å½•\r\n\r\nç”±äºç”¨æˆ·åˆ†é…äº†`xc_teachmanager_course_list`æƒé™ï¼Œç”¨æˆ·å…·æœ‰è®¿é—®è¯¾ç¨‹æŸ¥è¯¢æ¥å£çš„æƒé™ã€‚\r\n\r\n \r\n\r\n### **5.6 ç»†ç²’åº¦æˆæƒ**\r\n\r\n#### **5.6.1 ä»€ä¹ˆæ˜¯ç»†ç²’åº¦æˆæƒ**\r\n\r\nä»€ä¹ˆæ˜¯ç»†ç²’åº¦æˆæƒï¼Ÿ\r\n\r\nç»†ç²’åº¦æˆæƒä¹Ÿå«æ•°æ®èŒƒå›´æˆæƒï¼Œå³ä¸åŒçš„ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æ“ä½œæƒé™ç›¸åŒï¼Œä½†æ˜¯èƒ½å¤Ÿæ“ä½œçš„æ•°æ®èŒƒå›´æ˜¯ä¸ä¸€æ ·çš„ã€‚ä¸€ä¸ªä¾‹å­ï¼šç”¨æˆ·Aå’Œç”¨æˆ·Béƒ½æ˜¯æ•™å­¦æœºæ„ï¼Œä»–ä»¬éƒ½æ‹¥æœ‰â€œæˆ‘çš„è¯¾ç¨‹â€æƒé™ï¼Œä½†æ˜¯ä¸¤ä¸ªç”¨æˆ·æ‰€æŸ¥è¯¢åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€æ ·çš„ã€‚\r\n\r\næœ¬é¡¹ç›®æœ‰å“ªäº›ç»†ç²’åº¦æˆæƒï¼Ÿ\r\n\r\næ¯”å¦‚ï¼š\r\n\r\næˆ‘çš„è¯¾ç¨‹ï¼Œæ•™å­¦æœºæ„åªå…è®¸æŸ¥è¯¢æœ¬æ•™å­¦æœºæ„ä¸‹çš„è¯¾ç¨‹ä¿¡æ¯ã€‚\r\n\r\næˆ‘çš„é€‰è¯¾ï¼Œå­¦ç”Ÿåªå…è®¸æŸ¥è¯¢è‡ªå·±æ‰€é€‰è¯¾ã€‚\r\n\r\nå¦‚ä½•å®ç°ç»†ç²’åº¦æˆæƒï¼Ÿ\r\n\r\nç»†ç²’åº¦æˆæƒæ¶‰åŠåˆ°ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼Œé€šå¸¸åœ¨serviceå±‚å®ç°ï¼Œæ ¹æ®ä¸åŒçš„ç”¨æˆ·è¿›è¡Œæ ¡éªŒï¼Œæ ¹æ®ä¸åŒçš„å‚æ•°æŸ¥è¯¢ä¸åŒçš„æ•°æ®æˆ–æ“ä½œä¸åŒçš„æ•°æ®ã€‚\r\n\r\n#### **5.6.2 æ•™å­¦æœºæ„ç»†ç²’åº¦æˆæƒ**\r\n\r\næ•™å­¦æœºæ„åœ¨ç»´æŠ¤è¯¾ç¨‹æ—¶åªå…è®¸ç»´æŠ¤æœ¬æœºæ„çš„è¯¾ç¨‹ï¼Œæ•™å­¦æœºæ„ç»†ç²’åº¦æˆæƒè¿‡ç¨‹å¦‚ä¸‹ï¼š\r\n\r\n- 1ï¼‰è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·èº«ä»½\r\n- 2ï¼‰å¾—åˆ°ç”¨æˆ·æ‰€å±æ•™è‚²æœºæ„çš„Id\r\n- 3ï¼‰æŸ¥è¯¢è¯¥æ•™å­¦æœºæ„ä¸‹çš„è¯¾ç¨‹ä¿¡æ¯\r\n\r\næœ€ç»ˆå®ç°äº†ç”¨æˆ·åªå…è®¸æŸ¥è¯¢è‡ªå·±æœºæ„çš„è¯¾ç¨‹ä¿¡æ¯ã€‚\r\n\r\næ ¹æ®å…¬å¸IdæŸ¥è¯¢è¯¾ç¨‹ï¼Œæµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n- 1ï¼‰æ•™å­¦æœºæ„ç”¨æˆ·ç™»å½•ç³»ç»Ÿï¼Œä»ç”¨æˆ·èº«ä»½ä¸­å–å‡ºæ‰€å±æœºæ„çš„id\r\n- åœ¨ç”¨æˆ·è¡¨ä¸­è®¾è®¡äº†`company_id`å­—æ®µå­˜å‚¨è¯¥ç”¨æˆ·æ‰€å±çš„æœºæ„id.\r\n- 2ï¼‰æ¥å£å±‚å–å‡ºå½“å‰ç™»å½•ç”¨æˆ·çš„èº«ä»½ï¼Œå–å‡ºæœºæ„id\r\n- 3ï¼‰å°†æœºæ„idä¼ å…¥serviceæ–¹æ³•ã€‚\r\n- 4ï¼‰serviceæ–¹æ³•å°†æœºæ„idä¼ å…¥Daoæ–¹æ³•ï¼Œæœ€ç»ˆæŸ¥è¯¢å‡ºæœ¬æœºæ„çš„è¯¾ç¨‹ä¿¡æ¯ã€‚\r\n\r\nä»£ç å®ç°å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n@ApiOperation(\"è¯¾ç¨‹æŸ¥è¯¢æ¥å£\")\r\n@PreAuthorize(\"hasAuthority('xc_teachmanager_course_list')\")//æ‹¥æœ‰è¯¾ç¨‹åˆ—è¡¨æŸ¥è¯¢çš„æƒé™æ–¹å¯è®¿é—®\r\n@PostMapping(\"/course/list\")\r\npublic PageResult<CourseBase> list(PageParams pageParams, @RequestBody QueryCourseParamsDto queryCourseParams){\r\n    //å–å‡ºç”¨æˆ·èº«ä»½\r\n    XcUser user = SecurityUtil.getUser();\r\n    //æœºæ„id\r\n    String companyId = user.getCompanyId();\r\n    return courseBaseInfoService.queryCourseBaseList(Long.parseLong(companyId),pageParams,queryCourseParams);\r\n}\r\n```\r\n\r\n\r\n\r\nServiceæ–¹æ³•å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n@Override\r\npublic PageResult<CourseBase> queryCourseBaseList(Long companyId,PageParams pageParams, QueryCourseParamsDto queryCourseParamsDto) {\r\n\r\n //æ„å»ºæŸ¥è¯¢æ¡ä»¶å¯¹è±¡\r\n LambdaQueryWrapper<CourseBase> queryWrapper = new LambdaQueryWrapper<>();\r\n //æœºæ„id\r\n queryWrapper.eq(CourseBase::getCompanyId,companyId);\r\n ....\r\n```\r\n\r\n#### **5.6.3 æ•™å­¦æœºæ„ç»†ç²’åº¦æˆæƒæµ‹è¯•**\r\n\r\nä½¿ç”¨ä¸€ä¸ªæ•™å­¦æœºæ„çš„ç”¨æˆ·ç™»å½•é¡¹ç›®ï¼Œå¹¶ä¸”æ­¤ç”¨æˆ·å…·æœ‰æŸ¥è¯¢è¯¾ç¨‹çš„æƒé™ã€‚\r\n\r\næ‰‹æœºä¿®æ”¹æ•°æ®åº“æŒ‡å®šç”¨æˆ·å½’å±åˆ°ä¸€ä¸ªæœºæ„ä¸­ï¼Œæ¶‰åŠä»¥ä¸‹æ•°æ®è¡¨ï¼š\r\n\r\n`xc_company`ä¸ºæœºæ„è¡¨\r\n\r\n`xc_company_user`ä¸ºæœºæ„ç”¨æˆ·å…³ç³»è¡¨\r\n\r\n`xc_user`è¡¨ä¸­æœ‰`company_id`å­—æ®µã€‚\r\n\r\næˆ‘ä»¬å‡†å¤‡äº†t1 ç”¨æˆ·ä½œä¸ºæ­¤æ¬¡æµ‹è¯•çš„ç”¨æˆ·ï¼Œä½¿ç”¨æ­¤ç”¨æˆ·ç™»å½•ç³»ç»Ÿï¼š\r\n\r\næå‰åœ¨æŸ¥è¯¢è¯¾ç¨‹åˆ—è¡¨æ¥å£å¤„æ‰“ä¸Šæ–­ç‚¹ã€‚\r\n\r\nç»è¿‡æµ‹è¯•å¯ä»¥æ­£å¸¸å–å‡ºç”¨æˆ·æ‰€å±çš„æœºæ„id\r\n\r\n![image-20230705225810633](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225810633.png) \r\n\r\nè·Ÿè¸ªæŒä¹…å±‚æ—¥å¿—å‘ç°å·²å°†æœºæ„idä¼ å…¥daoæ–¹æ³•ï¼Œæ‹¼è£…sqlè¯­å¥ï¼ŒæŸ¥è¯¢æœ¬æœºæ„çš„è¯¾ç¨‹ä¿¡æ¯\r\n\r\n![image-20230705225815714](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225815714.png) \r\n\r\n \r\n\r\n## **6 å®æˆ˜**\r\n\r\n### **6.1 æ‰¾å›å¯†ç (å®æˆ˜)**\r\n\r\néœ€æ±‚ï¼šå¿˜è®°å¯†ç éœ€è¦æ‰¾å›ï¼Œå¯ä»¥é€šè¿‡æ‰‹æœºå·æ‰¾å›å¯†ç ï¼Œé€šè¿‡é‚®ç®±æ‰¾å›å¯†ç ä»¥åŠäººå·¥é€šé“ã€‚\r\n\r\nç•Œé¢è®¿é—®åœ°å€ï¼š`http://www.51xuecheng.cn/findpassword.html`\r\n\r\n![image-20230705225823457](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225823457.png) \r\n\r\næ¥å£ï¼š\r\n\r\næ‰‹æœºéªŒè¯ç ï¼š`/api/checkcode/phone?param1=æ‰‹æœºå·`\r\n\r\né‚®ç®±éªŒè¯ç ï¼š/api/checkcode/phone?param1=ç”µå­é‚®ç®±åœ°å€\r\n\r\næ‰¾å›å¯†ç ï¼š`/api/auth/findpassword`\r\n\r\nè¯·æ±‚ï¼š\r\n\r\n```json\r\n{\r\n     cellphone:'',\r\n     email:'',\r\n     checkcodekey:'',\r\n     checkcode:'',\r\n     confirmpwd:'',\r\n     password:''\r\n }\r\n```\r\n\r\nå“åº”ï¼š\r\n\r\n200: æ‰¾å›æˆåŠŸ\r\n\r\nå…¶å®ƒï¼šæ‰¾å›å¤±è´¥ï¼Œå¤±è´¥åŸå› ä½¿ç”¨ç»Ÿä¸€å¼‚å¸¸å¤„ç†è¿”å›çš„ä¿¡æ¯æ ¼å¼\r\n\r\næ‰§è¡Œæµç¨‹\r\n1ã€æ ¡éªŒéªŒè¯ç ï¼Œä¸ä¸€è‡´åˆ™æŠ›å‡ºå¼‚å¸¸\r\n\r\n2ã€åˆ¤æ–­ä¸¤æ¬¡å¯†ç æ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´åˆ™æŠ›å‡ºå¼‚å¸¸\r\n\r\n3ã€æ ¹æ®æ‰‹æœºå·å’Œé‚®ç®±æŸ¥è¯¢ç”¨æˆ·\r\n\r\n4ã€å¦‚æœæ‰¾åˆ°ç”¨æˆ·æ›´æ–°ä¸ºæ–°å¯†ç \r\n\r\n \r\n\r\n \r\n\r\n### **6.2 æ³¨å†Œ(å®æˆ˜)**\r\n\r\néœ€æ±‚ï¼šä¸ºå­¦ç”Ÿæä¾›æ³¨å†Œå…¥å£ï¼Œé€šè¿‡æ­¤å…¥å£æ³¨å†Œçš„ç”¨æˆ·ä¸ºå­¦ç”Ÿç”¨æˆ·ã€‚\r\n\r\nç•Œé¢è®¿é—®åœ°å€ï¼š`http://www.51xuecheng.cn/register.html`\r\n\r\n![image-20230705225845103](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705225845103.png) \r\n\r\næ¥å£ï¼š\r\n\r\næ‰‹æœºéªŒè¯ç ï¼š`/api/checkcode/phone?param1=æ‰‹æœºå·`\r\n\r\næ³¨å†Œï¼š`/api/auth/register`\r\n\r\nè¯·æ±‚ï¼š\r\n\r\n```json\r\n\r\n{\r\n   cellphone:'',\r\n   username:'',\r\n   email:'',\r\n   nickname:'',\r\n   password:'',\r\n   confirmpwd:'',\r\n   checkcodekey:'',\r\n   checkcode:''\r\n}\r\n```\r\n\r\nå“åº”ï¼š\r\n\r\n200: æ³¨å†ŒæˆåŠŸ\r\n\r\nå…¶å®ƒï¼šæ³¨å†Œå¤±è´¥ï¼Œå¤±è´¥åŸå› ä½¿ç”¨ç»Ÿä¸€å¼‚å¸¸å¤„ç†è¿”å›çš„ä¿¡æ¯æ ¼å¼\r\n\r\næ‰§è¡Œæµç¨‹ï¼š\r\n\r\n1ã€æ ¡éªŒéªŒè¯ç ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™æŠ›å‡ºå¼‚å¸¸\r\n\r\n2ã€æ ¡éªŒä¸¤æ¬¡å¯†ç æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™æŠ›å‡ºå¼‚å¸¸\r\n\r\n3ã€æ ¡éªŒç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸\r\n\r\n4ã€å‘ç”¨æˆ·è¡¨ã€ç”¨æˆ·è§’è‰²å…³ç³»è¡¨æ·»åŠ æ•°æ®ã€‚è§’è‰²ä¸ºå­¦ç”Ÿè§’è‰²ã€‚\r\n\r\n \r\n\r\n "},{"title":"Spring Cloudç»„ä»¶","tags":["Spring Cloud","Spring Cloud Alibaba","gateway"],"categories":["Java","å¾®æœåŠ¡"],"author":"imklaus","excerpt":"\r\n\r\n## 1ã€SpringCloud Alibaba ç®€ä»‹\r\n\r\n### 1ï¼‰ã€ç®€ä»‹\r\n\r\n- Spring Cloud Alibaba è‡´åŠ›äºæä¾›å¾®æœåŠ¡å¼€å‘çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆã€‚æ­¤é¡¹ç›®åŒ…å«å¼€å‘åˆ†å¸ƒå¼åº”ç”¨å¾®æœåŠ¡çš„å¿…éœ€ç»„ä»¶ï¼Œæ–¹ä¾¿å¼€å‘è€…é€šè¿‡ Spring Cloud ç¼–ç¨‹æ¨¡å‹è½»æ¾ä½¿ç”¨è¿™äº›ç»„ä»¶æ¥å¼€å‘åˆ†å¸ƒå¼åº”ç”¨æœåŠ¡ã€‚\r\n\r\n- ä¾æ‰˜ Spring Cloud Alibabaï¼Œæ‚¨åªéœ€è¦æ·»åŠ ä¸€äº›æ³¨è§£å’Œå°‘é‡é…ç½®ï¼Œå°±å¯ä»¥å°† Spring Cloud åº”ç”¨æ¥å…¥é˜¿é‡Œå¾®æœåŠ¡è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡é˜¿é‡Œä¸­é—´ä»¶æ¥è¿…é€Ÿæ­å»ºåˆ†å¸ƒå¼åº”ç”¨ç³»ç»Ÿã€‚\r\n- https://github.com/alibaba/spring-cloud-alibaba\r\n","link":"/posts/SpringCloud-Component","content":"\r\n\r\n## 1ã€SpringCloud Alibaba ç®€ä»‹\r\n\r\n### 1ï¼‰ã€ç®€ä»‹\r\n\r\n- Spring Cloud Alibaba è‡´åŠ›äºæä¾›å¾®æœåŠ¡å¼€å‘çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆã€‚æ­¤é¡¹ç›®åŒ…å«å¼€å‘åˆ†å¸ƒå¼åº”ç”¨å¾®æœåŠ¡çš„å¿…éœ€ç»„ä»¶ï¼Œæ–¹ä¾¿å¼€å‘è€…é€šè¿‡ Spring Cloud ç¼–ç¨‹æ¨¡å‹è½»æ¾ä½¿ç”¨è¿™äº›ç»„ä»¶æ¥å¼€å‘åˆ†å¸ƒå¼åº”ç”¨æœåŠ¡ã€‚\r\n\r\n- ä¾æ‰˜ Spring Cloud Alibabaï¼Œæ‚¨åªéœ€è¦æ·»åŠ ä¸€äº›æ³¨è§£å’Œå°‘é‡é…ç½®ï¼Œå°±å¯ä»¥å°† Spring Cloud åº”ç”¨æ¥å…¥é˜¿é‡Œå¾®æœåŠ¡è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡é˜¿é‡Œä¸­é—´ä»¶æ¥è¿…é€Ÿæ­å»ºåˆ†å¸ƒå¼åº”ç”¨ç³»ç»Ÿã€‚\r\n- https://github.com/alibaba/spring-cloud-alibaba\r\n<!-- more -->\r\n\r\n### 2ï¼‰ã€ä¸ºä»€ä¹ˆä½¿ç”¨\r\n\r\n![image-20230426190744205](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426190744205.png)\r\n\r\n- **SpringCloud çš„å‡ å¤§ç—›ç‚¹**\r\n  - SpringCloud éƒ¨åˆ†ç»„ä»¶åœæ­¢ç»´æŠ¤å’Œæ›´æ–°ï¼Œç»™å¼€å‘å¸¦æ¥ä¸ä¾¿ï¼›\r\n  - SpringCloud éƒ¨åˆ†ç¯å¢ƒæ­å»ºå¤æ‚ï¼Œæ²¡æœ‰å®Œå–„çš„å¯è§†åŒ–ç•Œé¢ï¼Œæˆ‘ä»¬éœ€è¦å¤§é‡çš„äºŒæ¬¡å¼€å‘å’Œå®šåˆ¶\r\n  - SpringCloud é…ç½®å¤æ‚ï¼Œéš¾ä»¥ä¸Šæ‰‹ï¼Œéƒ¨åˆ†é…ç½®å·®åˆ«éš¾ä»¥åŒºåˆ†å’Œåˆç†åº”ç”¨\r\n- SpringCloud Alibaba çš„ä¼˜åŠ¿ï¼š\r\n  - é˜¿é‡Œä½¿ç”¨è¿‡çš„ç»„ä»¶ç»å†äº†è€ƒéªŒï¼Œæ€§èƒ½å¼ºæ‚ï¼Œè®¾è®¡åˆç†ï¼Œç°åœ¨å¼€æºå‡ºæ¥å¤§å®¶ç”¨æˆå¥—çš„äº§å“æ­é…å®Œå–„çš„å¯è§†åŒ–ç•Œé¢ç»™å¼€å‘è¿ç»´å¸¦æ¥æå¤§çš„ä¾¿åˆ©æ­å»ºç®€å•ï¼Œå­¦ä¹ æ›²çº¿ä½ã€‚\r\n- ç»“åˆ SpringCloud Alibaba æˆ‘ä»¬æœ€ç»ˆçš„æŠ€æœ¯æ­é…æ–¹æ¡ˆï¼š\r\n  - SpringCloud Alibaba - Nacosï¼šæ³¨å†Œä¸­å¿ƒï¼ˆæœåŠ¡å‘ç°/æ³¨å†Œï¼‰\r\n  - SpringCloud Alibaba - Nacosï¼šé…ç½®ä¸­å¿ƒï¼ˆåŠ¨æ€é…ç½®ç®¡ç†ï¼‰\r\n  - SpringCloud - Ribbonï¼šè´Ÿè½½å‡è¡¡\r\n  - SpringCloud - Feignï¼šå£°æ˜å¼ HTTP å®¢æˆ·ç«¯ï¼ˆè°ƒç”¨è¿œç¨‹æœåŠ¡ï¼‰\r\n  - SpringCloud Alibaba - Sentinelï¼šæœåŠ¡å®¹é”™ï¼ˆé™æµã€é™çº§ã€ç†”æ–­ï¼‰\r\n  - SpringCloud - Gatewayï¼šAPI ç½‘å…³ï¼ˆwebflux ç¼–ç¨‹æ¨¡å¼ï¼‰\r\n  - SpringCloud - Sleuthï¼šè°ƒç”¨é“¾ç›‘æ§\r\n  - SpringCloud Alibaba - Seataï¼šåŸ Fescarï¼Œå³åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ\r\n\r\n\r\n\r\n### 3ï¼‰ã€ç‰ˆæœ¬é€‰æ‹©\r\n\r\nç”±äº Spring Boot 1 å’Œ Spring Boot 2 åœ¨ Actuator æ¨¡å—çš„æ¥å£å’Œæ³¨è§£æœ‰å¾ˆå¤§çš„å˜æ›´ï¼Œä¸”spring-cloud-commons ä» 1.x.x ç‰ˆæœ¬å‡çº§åˆ° 2.0.0 ç‰ˆæœ¬ä¹Ÿæœ‰è¾ƒå¤§çš„å˜æ›´ï¼Œå› æ­¤æˆ‘ä»¬é‡‡å–è·ŸSpringBoot ç‰ˆæœ¬å·ä¸€è‡´çš„ç‰ˆæœ¬:\r\n\r\n- 1.5.x ç‰ˆæœ¬é€‚ç”¨äº Spring Boot 1.5.x\r\n- 2.0.x ç‰ˆæœ¬é€‚ç”¨äº Spring Boot 2.0.x\r\n- 2.1.x ç‰ˆæœ¬é€‚ç”¨äº Spring Boot 2.1.x\r\n\r\n### 4ï¼‰ã€é¡¹ç›®ä¸­çš„ä¾èµ–\r\n\r\n```xml\r\n<dependencyManagement>\r\n        <dependencies>\r\n            <dependency>\r\n                <groupId>com.alibaba.cloud</groupId>\r\n                <artifactId>spring-cloud-alibaba-dependencies</artifactId>\r\n                <version>2.1.0.RELEASE</version>\r\n                <type>pom</type>\r\n                <scope>import</scope>\r\n            </dependency>\r\n        </dependencies>\r\n    </dependencyManagement>\r\n```\r\n\r\n\r\n\r\n## 2ã€SpringCloud Alibaba-Nacos[ä½œä¸ºæ³¨å†Œä¸­å¿ƒ]\r\n\r\n- Nacos æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚ä»–æ˜¯ä½¿ç”¨ java ç¼–å†™ã€‚éœ€è¦ä¾èµ– java ç¯å¢ƒ\r\n\r\n- Nacos æ–‡æ¡£åœ°å€ï¼š https://nacos.io/zh-cn/docs/quick-start.html\r\n\r\n\r\n\r\n### 1ï¼‰ã€ä¸‹è½½ nacos-server\r\n\r\nhttps://github.com/alibaba/nacos/releases\r\n\r\n\r\n\r\n### 2ï¼‰ã€å¯åŠ¨ nacos-server\r\n\r\n- åŒå‡» bin ä¸­çš„ startup.cmd æ–‡ä»¶\r\n\r\n- è®¿é—® `http://localhost:8848/nacos/`\r\n\r\n- ä½¿ç”¨é»˜è®¤çš„ nacos/nacos è¿›è¡Œç™»å½•\r\n\r\n![image-20230426191639545](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426191639545.png)\r\n\r\n\r\n\r\n### 3ï¼‰ã€å°†å¾®æœåŠ¡æ³¨å†Œåˆ° nacos ä¸­\r\n\r\n#### 1ã€é¦–å…ˆï¼Œä¿®æ”¹ pom.xml æ–‡ä»¶ï¼Œå¼•å…¥ Nacos Discovery Starterã€‚\r\n\r\n```xml\r\n<dependency>\r\n  <groupId>com.alibaba.cloud</groupId>\r\n  <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\r\n</dependency>\r\n```\r\n\r\n\r\n\r\n#### 2ã€åœ¨åº”ç”¨çš„ /src/main/resources/application.properties é…ç½®æ–‡ä»¶ä¸­é…ç½® Nacos Server åœ°å€\r\n\r\n```properties\r\nspring.cloud.nacos.discovery.server-addr=127.0.0.1:8848\r\n```\r\n\r\n\r\n\r\n#### 3ã€ä½¿ç”¨@EnableDiscoveryClient å¼€å¯æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½\r\n\r\n```java\r\n@SpringBootApplication\r\n@EnableDiscoveryClient\r\npublic class ProviderApplication {\r\n\tpublic static void main(String[] args) {\r\n\t\tSpringApplication.run(Application.class, args);\r\n\t}\r\n}\r\n```\r\n\r\n\r\n\r\n#### 4ã€å¯åŠ¨åº”ç”¨ï¼Œè§‚å¯Ÿ nacos æœåŠ¡åˆ—è¡¨æ˜¯å¦å·²ç»æ³¨å†Œä¸ŠæœåŠ¡\r\n\r\n- æ³¨æ„ï¼šæ¯ä¸€ä¸ªåº”ç”¨éƒ½åº”è¯¥æœ‰åå­—ï¼Œè¿™æ ·æ‰èƒ½æ³¨å†Œä¸Šå»ã€‚ä¿®æ”¹ application.properties æ–‡ä»¶\r\n\r\n```properties\r\nspring.application.name=service-provider\r\nserver.port=8000\r\n```\r\n\r\n\r\n\r\n#### 5ã€æ³¨å†Œæ›´å¤šçš„æœåŠ¡ä¸Šå»ï¼Œæµ‹è¯•ä½¿ç”¨ feign è¿œç¨‹è°ƒç”¨\r\n\r\n- Nacos ä½¿ç”¨ä¸‰æ­¥\r\n  - 1ã€å¯¼åŒ… nacos-discovery\r\n  - 2ã€å†™é…ç½®ï¼ŒæŒ‡å®š nacos åœ°å€ï¼ŒæŒ‡å®šåº”ç”¨çš„åå­—\r\n  - 3ã€å¼€å¯æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½@EnableDiscoveryClient\r\n- Feign ä½¿ç”¨ä¸‰æ­¥\r\n  - 1ã€å¯¼åŒ… openfeign\r\n  - 2ã€å¼€å¯@EnableFeignClients åŠŸèƒ½\r\n  - 3ã€ç¼–å†™æ¥å£ï¼Œè¿›è¡Œè¿œç¨‹è°ƒç”¨\r\n\r\n```java\r\n@FeignClient(\"stores\")\r\npublic interface StoreClient {\r\n    \r\n\t@RequestMapping(method = RequestMethod.GET, value = \"/stores\")\r\n\tList<Store> getStores();\r\n    \r\n\t@RequestMapping(method=RequestMethod.POST,value=\"/stores/{storeId}\",consumes = \t\t\"application/json\")\r\n\tStore update(@PathVariable(\"storeId\") Long storeId, Store store);\r\n}\r\n```\r\n\r\n\r\n\r\n#### 6ã€æ›´å¤šé…ç½®\r\n\r\nhttps://github.com/alibaba/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-examples/nacos-example/nacos-discovery-example/readme-zh.md#more\r\n\r\n\r\n\r\n## 3ã€SpringCloud Alibaba-Nacos[ä½œä¸ºé…ç½®ä¸­å¿ƒ]\r\n\r\n### 1ã€pom.xml å¼•å…¥ Nacos Config Starterã€‚\r\n\r\n```xml\r\n<dependency>\r\n  <groupId>com.alibaba.cloud</groupId>\r\n  <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>\r\n</dependency>\r\n```\r\n\r\n\r\n\r\n### 2ã€åœ¨åº”ç”¨çš„ /src/main/resources/bootstrap.properties é…ç½®æ–‡ä»¶ä¸­é…ç½® Nacos Config å…ƒæ•°æ®\r\n\r\n- ä¸»è¦é…ç½®åº”ç”¨åå’Œé…ç½®ä¸­å¿ƒåœ°å€\r\n\r\n```properties\r\nspring.application.name=nacos-config-example\r\nspring.cloud.nacos.config.server-addr=127.0.0.1:8848\r\n```\r\n\r\n\r\n\r\n### 3ã€åœ¨ nacos ä¸­æ·»åŠ é…ç½®\r\n\r\n- åœ¨ nacos ä¸­åˆ›å»ºä¸€ä¸ªåº”ç”¨å.properties é…ç½®æ–‡ä»¶å¹¶ç¼–å†™é…ç½®\r\n  - Nacos Config æ•°æ®ç»“æ„\r\n  - Nacos Config ä¸»è¦é€šè¿‡ dataId å’Œ group æ¥å”¯ä¸€ç¡®å®šä¸€æ¡é…ç½®ã€‚\r\n  - Nacos Client ä» Nacos Server ç«¯è·å–æ•°æ®æ—¶ï¼Œè°ƒç”¨çš„æ˜¯æ­¤æ¥å£ ConfigService.getConfig(String dataId, String group, long timeoutMs)ã€‚\r\n- Spring Cloud åº”ç”¨è·å–æ•°æ®\r\n  - dataIDï¼š\r\n  - åœ¨ Nacos Config Starter ä¸­ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å¦‚ä¸‹\r\n    - ${prefix} - ${spring.profiles.active} . ${file-extension} prefix é»˜è®¤ä¸º spring.application.nameçš„å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.prefix æ¥é…ç½®ã€‚\r\n    - spring.profiles.active å³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profile\r\n  - æ³¨æ„ï¼Œå½“ activeprofile ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦ - ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å˜æˆ`${prefix}.${file-extension}`\r\n  - file-extension ä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹spring.cloud.nacos.config.file-extension æ¥é…ç½®ã€‚ ç›®å‰åªæ”¯æŒ properties ç±»å‹ã€‚\r\n  - Groupï¼š\r\n    - Group é»˜è®¤ä¸º DEFAULT_GROUPï¼Œå¯ä»¥é€šè¿‡ spring.cloud.nacos.config.group é…ç½®ã€‚\r\n\r\n\r\n\r\n### 4ã€åœ¨åº”ç”¨ä¸­ä½¿ç”¨@Value å’Œ@RefreshScope\r\n\r\nå®Œæˆä¸Šè¿°ä¸¤æ­¥åï¼Œåº”ç”¨ä¼šä» Nacos Config ä¸­è·å–ç›¸åº”çš„é…ç½®ï¼Œå¹¶æ·»åŠ åœ¨ Spring Environmentçš„\r\nPropertySourcesä¸­ ã€‚ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨@Value æ³¨è§£æ¥å°†å¯¹åº”çš„é…ç½®æ³¨å…¥åˆ°SampleController çš„ userName å’Œ age å­—æ®µï¼Œå¹¶æ·»åŠ  @RefreshScope æ‰“å¼€åŠ¨æ€åˆ·æ–°åŠŸèƒ½\r\n\r\n```java\r\n@RefreshScope\r\nclass SampleController {\r\n\t@Value(\"${user.name}\")\r\n\tString userName;\r\n\t@Value(\"${user.age}\")\r\n\tint age;\r\n}\r\n```\r\n\r\n\r\n\r\n### 5ã€è¿›é˜¶\r\n\r\n#### 1ã€æ ¸å¿ƒæ¦‚å¿µ\r\n\r\n- å‘½åç©ºé—´ï¼š\r\n  - ç”¨äºè¿›è¡Œç§Ÿæˆ·ç²’åº¦çš„é…ç½®éš”ç¦»ã€‚ä¸åŒçš„å‘½åç©ºé—´ä¸‹ï¼Œå¯ä»¥å­˜åœ¨ç›¸åŒçš„ Group æˆ– Data ID çš„é…ç½®ã€‚Namespace çš„å¸¸ç”¨åœºæ™¯ä¹‹ä¸€æ˜¯ä¸åŒç¯å¢ƒçš„é…ç½®çš„åŒºåˆ†éš”ç¦»ï¼Œä¾‹å¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„èµ„æºï¼ˆå¦‚é…ç½®ã€æœåŠ¡ï¼‰éš”ç¦»ç­‰ã€‚\r\n- é…ç½®é›†ï¼š\r\n  - ä¸€ç»„ç›¸å…³æˆ–è€…ä¸ç›¸å…³çš„é…ç½®é¡¹çš„é›†åˆç§°ä¸ºé…ç½®é›†ã€‚åœ¨ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªé…ç½®æ–‡ä»¶é€šå¸¸å°±æ˜¯ä¸€ä¸ªé…ç½®é›†ï¼ŒåŒ…å«äº†ç³»ç»Ÿå„ä¸ªæ–¹é¢çš„é…ç½®ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªé…ç½®é›†å¯èƒ½åŒ…å«äº†æ•°æ®æºã€çº¿ç¨‹æ± ã€æ—¥å¿—çº§åˆ«ç­‰é…ç½®é¡¹ã€‚\r\n- é…ç½®é›† IDï¼š\r\n  - Nacos ä¸­çš„æŸä¸ªé…ç½®é›†çš„ IDã€‚é…ç½®é›† ID æ˜¯ç»„ç»‡åˆ’åˆ†é…ç½®çš„ç»´åº¦ä¹‹ä¸€ã€‚Data ID é€šå¸¸ç”¨äºç»„ç»‡åˆ’åˆ†ç³»ç»Ÿçš„é…ç½®é›†ã€‚ä¸€ä¸ªç³»ç»Ÿæˆ–è€…åº”ç”¨å¯ä»¥åŒ…å«å¤šä¸ªé…ç½®é›†ï¼Œæ¯ä¸ªé…ç½®é›†éƒ½å¯ä»¥è¢«ä¸€ä¸ªæœ‰æ„ä¹‰çš„åç§°æ ‡è¯†ã€‚Data ID é€šå¸¸é‡‡ç”¨ç±» Java åŒ…ï¼ˆå¦‚ com.taobao.tc.refund.log.levelï¼‰çš„å‘½åè§„åˆ™ä¿è¯å…¨å±€å”¯ä¸€æ€§ã€‚æ­¤å‘½åè§„åˆ™éå¼ºåˆ¶ã€‚\r\n- é…ç½®åˆ†ç»„ï¼š\r\n  - Nacos ä¸­çš„ä¸€ç»„é…ç½®é›†ï¼Œæ˜¯ç»„ç»‡é…ç½®çš„ç»´åº¦ä¹‹ä¸€ã€‚é€šè¿‡ä¸€ä¸ªæœ‰æ„ä¹‰çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ Buy æˆ–Trade ï¼‰å¯¹é…ç½®é›†è¿›è¡Œåˆ†ç»„ï¼Œä»è€ŒåŒºåˆ† Data ID ç›¸åŒçš„é…ç½®é›†ã€‚å½“æ‚¨åœ¨ Nacos ä¸Šåˆ›å»ºä¸€ä¸ªé…ç½®æ—¶ï¼Œå¦‚æœæœªå¡«å†™é…ç½®åˆ†ç»„çš„åç§°ï¼Œåˆ™é…ç½®åˆ†ç»„çš„åç§°é»˜è®¤é‡‡ç”¨ DEFAULT_GROUP ã€‚é…ç½®åˆ†ç»„çš„å¸¸è§åœºæ™¯ï¼šä¸åŒçš„åº”ç”¨æˆ–ç»„ä»¶ä½¿ç”¨äº†ç›¸åŒçš„é…ç½®ç±»å‹ï¼Œå¦‚ database_url é…ç½®å’ŒMQ_topic é…ç½®ã€‚\r\n\r\n\r\n\r\n#### 2ã€åŸç†\r\n\r\n- è‡ªåŠ¨æ³¨å…¥ï¼š\r\n  - NacosConfigStarter å®ç°äº†org.springframework.cloud.bootstrap.config.PropertySourceLocatoræ¥å£ï¼Œå¹¶å°†ä¼˜å…ˆçº§è®¾ç½®æˆäº†æœ€é«˜ã€‚\r\n  - åœ¨ Spring Cloud åº”ç”¨å¯åŠ¨é˜¶æ®µï¼Œä¼šä¸»åŠ¨ä» Nacos Server ç«¯è·å–å¯¹åº”çš„æ•°æ®ï¼Œå¹¶å°†è·å–åˆ°çš„æ•°æ®è½¬æ¢æˆ PropertySource ä¸”æ³¨å…¥åˆ° Environment çš„ PropertySources å±æ€§ä¸­ï¼Œæ‰€ä»¥ä½¿ç”¨@Value æ³¨è§£ä¹Ÿèƒ½ç›´æ¥è·å– Nacos Server ç«¯é…ç½®çš„å†…å®¹ã€‚\r\n- åŠ¨æ€åˆ·æ–°ï¼š\r\n  - Nacos Config Starter é»˜è®¤ä¸ºæ‰€æœ‰è·å–æ•°æ®æˆåŠŸçš„ Nacos çš„é…ç½®é¡¹æ·»åŠ äº†ç›‘å¬åŠŸèƒ½ï¼Œåœ¨ç›‘å¬åˆ°æœåŠ¡ç«¯é…ç½®å‘ç”Ÿå˜åŒ–æ—¶ä¼šå®æ—¶è§¦å‘org.springframework.cloud.context.refresh.ContextRefresher çš„ refresh æ–¹æ³• ã€‚\r\n  - å¦‚æœéœ€è¦å¯¹ Bean è¿›è¡ŒåŠ¨æ€åˆ·æ–°ï¼Œè¯·å‚ç…§ Spring å’Œ Spring Cloud è§„èŒƒã€‚æ¨èç»™ç±»æ·»åŠ @RefreshScope æˆ– @ConfigurationProperties æ³¨è§£\r\n\r\n\r\n\r\n#### 3ã€åŠ è½½å¤šé…ç½®æ–‡ä»¶\r\n\r\n```properties\r\nspring.cloud.nacos.config.server-addr=127.0.0.1:8848\r\nspring.cloud.nacos.config.namespace=31098de9-fa28-41c9-b0bd-c754ce319ed4\r\nspring.cloud.nacos.config.ext-config[0].data-id=gulimall-datasource.yml\r\nspring.cloud.nacos.config.ext-config[0].refresh=false\r\nspring.cloud.nacos.config.ext-config[0].group=dev\r\n```\r\n\r\n\r\n\r\n#### 4ã€namespace ä¸ group æœ€ä½³å®è·µ\r\n\r\n- æ¯ä¸ªå¾®æœåŠ¡åˆ›å»ºè‡ªå·±çš„ namespace è¿›è¡Œéš”ç¦»ï¼Œgroup æ¥åŒºåˆ† devï¼Œbetaï¼Œprod ç­‰ç¯å¢ƒ\r\n\r\n## 4ã€SpringCloud Alibaba-Sentinel\r\n\r\n### 1ã€ç®€ä»‹\r\n\r\n#### 1ï¼‰ã€ç†”æ–­é™çº§é™æµ\r\n\r\n- ä»€ä¹ˆæ˜¯ç†”æ–­\r\n\r\nâ€‹       A æœåŠ¡è°ƒç”¨ B æœåŠ¡çš„æŸä¸ªåŠŸèƒ½ï¼Œç”±äºç½‘ç»œä¸ç¨³å®šé—®é¢˜ï¼Œæˆ–è€… B æœåŠ¡å¡æœºï¼Œå¯¼è‡´åŠŸèƒ½æ—¶é—´è¶…é•¿ã€‚å¦‚æœè¿™æ ·å­çš„æ¬¡æ•°å¤ªå¤šã€‚æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å°† B æ–­è·¯äº†ï¼ˆA ä¸å†è¯·æ±‚ B æ¥å£ï¼‰ï¼Œå‡¡æ˜¯è°ƒç”¨ B çš„ç›´æ¥è¿”å›é™çº§æ•°æ®ï¼Œä¸å¿…ç­‰å¾… B çš„è¶…é•¿æ‰§è¡Œã€‚ è¿™æ · B çš„æ•…éšœé—®é¢˜ï¼Œå°±ä¸ä¼šçº§è”å½±å“åˆ° Aã€‚\r\n\r\n- ä»€ä¹ˆæ˜¯é™çº§\r\n\r\nâ€‹        æ•´ä¸ªç½‘ç«™å¤„äºæµé‡é«˜å³°æœŸï¼ŒæœåŠ¡å™¨å‹åŠ›å‰§å¢ï¼Œæ ¹æ®å½“å‰ä¸šåŠ¡æƒ…å†µåŠæµé‡ï¼Œå¯¹ä¸€äº›æœåŠ¡å’Œé¡µé¢è¿›è¡Œæœ‰ç­–ç•¥çš„é™çº§[åœæ­¢æœåŠ¡ï¼Œæ‰€æœ‰çš„è°ƒç”¨ç›´æ¥è¿”å›é™çº§æ•°æ®]ã€‚ä»¥æ­¤ç¼“è§£æœåŠ¡å™¨èµ„æºçš„çš„å‹åŠ›ï¼Œä»¥ä¿è¯æ ¸å¿ƒä¸šåŠ¡çš„æ­£å¸¸è¿è¡Œï¼ŒåŒæ—¶ä¹Ÿä¿æŒäº†å®¢æˆ·å’Œå¤§éƒ¨åˆ†å®¢æˆ·çš„å¾—åˆ°æ­£ç¡®çš„ç›¸åº”ã€‚\r\n\r\n- å¼‚åŒï¼š\r\n\r\n  - ç›¸åŒç‚¹ï¼š\r\n\r\n    - 1ã€ä¸ºäº†ä¿è¯é›†ç¾¤å¤§éƒ¨åˆ†æœåŠ¡çš„å¯ç”¨æ€§å’Œå¯é æ€§ï¼Œé˜²æ­¢å´©æºƒï¼Œç‰ºç‰²å°æˆ‘\r\n\r\n    - 2ã€ç”¨æˆ·æœ€ç»ˆéƒ½æ˜¯ä½“éªŒåˆ°æŸä¸ªåŠŸèƒ½ä¸å¯ç”¨\r\n\r\n  - ä¸åŒç‚¹ï¼š\r\n\r\n  - 1ã€ç†”æ–­æ˜¯è¢«è°ƒç”¨æ–¹æ•…éšœï¼Œè§¦å‘çš„ç³»ç»Ÿä¸»åŠ¨è§„åˆ™\r\n\r\n  - 2ã€é™çº§æ˜¯åŸºäºå…¨å±€è€ƒè™‘ï¼Œåœæ­¢ä¸€äº›æ­£å¸¸æœåŠ¡ï¼Œé‡Šæ”¾èµ„æº\r\n\r\n- ä»€ä¹ˆæ˜¯é™æµ\r\n  - å¯¹æ‰“å…¥æœåŠ¡çš„è¯·æ±‚æµé‡è¿›è¡Œæ§åˆ¶ï¼Œä½¿æœåŠ¡èƒ½å¤Ÿæ‰¿æ‹…ä¸è¶…è¿‡è‡ªå·±èƒ½åŠ›çš„æµé‡å‹åŠ›\r\n\r\n\r\n\r\n#### 2ï¼‰ã€Sentinel ç®€ä»‹\r\n\r\n- å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D\r\n- é¡¹ç›®åœ°å€ï¼šhttps://github.com/alibaba/Sentinel\r\n\r\nâ€‹        éšç€å¾®æœåŠ¡çš„æµè¡Œï¼ŒæœåŠ¡å’ŒæœåŠ¡ä¹‹é—´çš„ç¨³å®šæ€§å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚Sentinel ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚\r\n\r\n- Sentinel å…·æœ‰ä»¥ä¸‹ç‰¹å¾:\r\n  - **ä¸°å¯Œçš„åº”ç”¨åœºæ™¯**ï¼šSentinel æ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿‘ 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯ï¼Œä¾‹å¦‚ç§’æ€ï¼ˆå³çªå‘æµé‡æ§åˆ¶åœ¨ç³»ç»Ÿå®¹é‡å¯ä»¥æ‰¿å—çš„èŒƒå›´ï¼‰ã€æ¶ˆæ¯å‰Šå³°å¡«è°·ã€é›†ç¾¤æµé‡æ§åˆ¶ã€å®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ç­‰ã€‚\r\n  - **å®Œå¤‡çš„å®æ—¶ç›‘æ§**ï¼šSentinel åŒæ—¶æä¾›å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚æ‚¨å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°æœºå™¨ç§’çº§æ•°æ®ï¼Œç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µã€‚\r\n  - **å¹¿æ³›çš„å¼€æºç”Ÿæ€**ï¼šSentinel æä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶/åº“çš„æ•´åˆæ¨¡å—ï¼Œä¾‹å¦‚ä¸ Spring Cloudã€Dubboã€gRPC çš„æ•´åˆã€‚æ‚¨åªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å¹¶è¿›è¡Œç®€å•çš„é…ç½®å³å¯å¿«é€Ÿåœ°æ¥å…¥ Sentinelã€‚\r\n  - **å®Œå–„çš„ SPI æ‰©å±•ç‚¹**ï¼šSentinel æä¾›ç®€å•æ˜“ç”¨ã€å®Œå–„çš„ SPI æ‰©å±•æ¥å£ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°æ‰©å±•æ¥å£æ¥å¿«é€Ÿåœ°å®šåˆ¶é€»è¾‘ã€‚ä¾‹å¦‚å®šåˆ¶è§„åˆ™ç®¡ç†ã€é€‚é…åŠ¨æ€æ•°æ®æºç­‰ã€‚\r\n\r\n![image-20230426200648761](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426200648761.png)\r\n\r\n- Sentinel åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†:\r\n  - æ ¸å¿ƒåº“ï¼ˆJava å®¢æˆ·ç«¯ï¼‰ä¸ä¾èµ–ä»»ä½•æ¡†æ¶/åº“ï¼Œèƒ½å¤Ÿè¿è¡Œäºæ‰€æœ‰ Java è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒæ—¶å¯¹ Dubbo / Spring Cloud ç­‰æ¡†æ¶ä¹Ÿæœ‰è¾ƒå¥½çš„æ”¯æŒã€‚\r\n  - æ§åˆ¶å°ï¼ˆDashboardï¼‰åŸºäº Spring Boot å¼€å‘ï¼Œæ‰“åŒ…åå¯ä»¥ç›´æ¥è¿è¡Œï¼Œä¸éœ€è¦é¢å¤–çš„Tomcat ç­‰åº”ç”¨å®¹å™¨ã€‚\r\n\r\n- Sentinel åŸºæœ¬æ¦‚å¿µ\r\n- èµ„æº\r\n  - èµ„æºæ˜¯ Sentinel çš„å…³é”®æ¦‚å¿µã€‚å®ƒå¯ä»¥æ˜¯ Java åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›çš„æœåŠ¡ï¼Œæˆ–ç”±åº”ç”¨ç¨‹åºè°ƒç”¨çš„å…¶å®ƒåº”ç”¨æä¾›çš„æœåŠ¡ï¼Œç”šè‡³å¯ä»¥æ˜¯ä¸€æ®µä»£ç ã€‚åœ¨æ¥ä¸‹æ¥çš„æ–‡æ¡£ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¼šç”¨èµ„æºæ¥æè¿°ä»£ç å—ã€‚\r\n\r\n> åªè¦é€šè¿‡ Sentinel API å®šä¹‰çš„ä»£ç ï¼Œå°±æ˜¯èµ„æºï¼Œèƒ½å¤Ÿè¢« Sentinel ä¿æŠ¤èµ·æ¥ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³•ç­¾åï¼ŒURLï¼Œç”šè‡³æœåŠ¡åç§°ä½œä¸ºèµ„æºåæ¥æ ‡ç¤ºèµ„æºã€‚\r\n\r\n- è§„åˆ™\r\n  - å›´ç»•èµ„æºçš„å®æ—¶çŠ¶æ€è®¾å®šçš„è§„åˆ™ï¼Œå¯ä»¥åŒ…æ‹¬æµé‡æ§åˆ¶è§„åˆ™ã€ç†”æ–­é™çº§è§„åˆ™ä»¥åŠç³»ç»Ÿä¿æŠ¤è§„åˆ™ã€‚æ‰€æœ‰è§„åˆ™å¯ä»¥åŠ¨æ€å®æ—¶è°ƒæ•´ã€‚\r\n\r\n\r\n\r\n### 2ã€Hystrix ä¸ Sentinel æ¯”è¾ƒ\r\n\r\n![image-20230426223918898](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426223918898.png)\r\n\r\n\r\n\r\n### 3ã€æ•´åˆ Feign+Sentinel æµ‹è¯•ç†”æ–­é™çº§\r\n\r\nhttps://github.com/alibaba/Sentinel/wiki/%E4%B8%BB%E9%A1%B5\r\n\r\n- ä»€ä¹ˆæ˜¯ç†”æ–­é™çº§\r\n  - é™¤äº†æµé‡æ§åˆ¶ä»¥å¤–ï¼Œé™ä½è°ƒç”¨é“¾è·¯ä¸­çš„ä¸ç¨³å®šèµ„æºä¹Ÿæ˜¯ Sentinel çš„ä½¿å‘½ä¹‹ä¸€ã€‚ç”±äºè°ƒç”¨å…³ç³»çš„å¤æ‚æ€§ï¼Œå¦‚æœè°ƒç”¨é“¾è·¯ä¸­çš„æŸä¸ªèµ„æºå‡ºç°äº†ä¸ç¨³å®šï¼Œæœ€ç»ˆä¼šå¯¼è‡´è¯·æ±‚å‘ç”Ÿå †ç§¯ã€‚\r\n\r\n![image-20230426201450220](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426201450220.png)\r\n\r\n- Sentinel å’Œ Hystrix çš„åŸåˆ™æ˜¯ä¸€è‡´çš„: å½“æ£€æµ‹åˆ°è°ƒç”¨é“¾è·¯ä¸­æŸä¸ªèµ„æºå‡ºç°ä¸ç¨³å®šçš„è¡¨ç°ï¼Œä¾‹å¦‚è¯·æ±‚å“åº”æ—¶é—´é•¿æˆ–å¼‚å¸¸æ¯”ä¾‹å‡é«˜çš„æ—¶å€™ï¼Œåˆ™å¯¹è¿™ä¸ªèµ„æºçš„è°ƒç”¨è¿›è¡Œé™åˆ¶ï¼Œè®©è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼Œé¿å…å½±å“åˆ°å…¶å®ƒçš„èµ„æºè€Œå¯¼è‡´çº§è”æ•…éšœã€‚\r\n\r\n- ç†”æ–­é™çº§è®¾è®¡ç†å¿µ\r\n  - åœ¨é™åˆ¶çš„æ‰‹æ®µä¸Šï¼ŒSentinel å’Œ Hystrix é‡‡å–äº†å®Œå…¨ä¸ä¸€æ ·çš„æ–¹æ³•ã€‚\r\n  - Hystrix é€šè¿‡ çº¿ç¨‹æ± éš”ç¦» çš„æ–¹å¼ï¼Œæ¥å¯¹ä¾èµ–ï¼ˆåœ¨ Sentinel çš„æ¦‚å¿µä¸­å¯¹åº” èµ„æºï¼‰è¿›è¡Œäº†éš”ç¦»ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯èµ„æºå’Œèµ„æºä¹‹é—´åšåˆ°äº†æœ€å½»åº•çš„éš”ç¦»ã€‚ç¼ºç‚¹æ˜¯é™¤äº†å¢åŠ äº†çº¿ç¨‹åˆ‡æ¢çš„æˆæœ¬ï¼ˆè¿‡å¤šçš„çº¿ç¨‹æ± å¯¼è‡´çº¿ç¨‹æ•°ç›®è¿‡å¤šï¼‰ï¼Œè¿˜éœ€è¦é¢„å…ˆç»™å„ä¸ªèµ„æºåšçº¿ç¨‹æ± å¤§å°çš„åˆ†é…ã€‚\r\n\r\n- Sentinel å¯¹è¿™ä¸ªé—®é¢˜é‡‡å–äº†ä¸¤ç§æ‰‹æ®µ:\r\n\r\n  - é€šè¿‡å¹¶å‘çº¿ç¨‹æ•°è¿›è¡Œé™åˆ¶\r\n    - å’Œèµ„æºæ± éš”ç¦»çš„æ–¹æ³•ä¸åŒï¼ŒSentinel é€šè¿‡é™åˆ¶èµ„æºå¹¶å‘çº¿ç¨‹çš„æ•°é‡ï¼Œæ¥å‡å°‘ä¸ç¨³å®šèµ„æºå¯¹å…¶å®ƒèµ„æºçš„å½±å“ã€‚è¿™æ ·ä¸ä½†æ²¡æœ‰çº¿ç¨‹åˆ‡æ¢çš„æŸè€—ï¼Œä¹Ÿä¸éœ€è¦æ‚¨é¢„å…ˆåˆ†é…çº¿ç¨‹æ± çš„å¤§å°ã€‚å½“æŸä¸ªèµ„æºå‡ºç°ä¸ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚å“åº”æ—¶é—´å˜é•¿ï¼Œå¯¹èµ„æºçš„ç›´æ¥å½±å“å°±æ˜¯ä¼šé€ æˆçº¿ç¨‹æ•°çš„é€æ­¥å †ç§¯ã€‚å½“çº¿ç¨‹æ•°åœ¨ç‰¹å®šèµ„æºä¸Šå †ç§¯åˆ°ä¸€å®šçš„æ•°é‡ä¹‹åï¼Œå¯¹è¯¥èµ„æºçš„æ–°è¯·æ±‚å°±ä¼šè¢«æ‹’ç»ã€‚å †ç§¯çš„çº¿ç¨‹å®Œæˆä»»åŠ¡åæ‰å¼€å§‹ç»§ç»­æ¥æ”¶è¯·æ±‚ã€‚\r\n\r\n  - é€šè¿‡å“åº”æ—¶é—´å¯¹èµ„æºè¿›è¡Œé™çº§\r\n    - é™¤äº†å¯¹å¹¶å‘çº¿ç¨‹æ•°è¿›è¡Œæ§åˆ¶ä»¥å¤–ï¼ŒSentinel è¿˜å¯ä»¥é€šè¿‡å“åº”æ—¶é—´æ¥å¿«é€Ÿé™çº§ä¸ç¨³å®šçš„èµ„æºã€‚å½“ä¾èµ–çš„èµ„æºå‡ºç°å“åº”æ—¶é—´è¿‡é•¿åï¼Œæ‰€æœ‰å¯¹è¯¥èµ„æºçš„è®¿é—®éƒ½ä¼šè¢«ç›´æ¥æ‹’ç»ï¼Œç›´åˆ°è¿‡äº†æŒ‡å®šçš„æ—¶é—´çª—å£ä¹‹åæ‰é‡æ–°æ¢å¤ã€‚\r\n\r\n- æ•´åˆæµ‹è¯•ï¼š\r\n\r\nhttps://github.com/alibaba/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-examples/sentinel-example/sentinel-feign-example/readme-zh.md\r\n\r\n\r\n\r\n#### 1ï¼‰ã€å¼•å…¥ä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n\t<groupId>org.springframework.cloud</groupId>\r\n\t<artifactId>spring-cloud-starter-openfeign</artifactId>\r\n</dependency>\r\n<dependency>\r\n\t<groupId>com.alibaba.cloud</groupId>\r\n\t<artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>\r\n</dependency>\r\n```\r\n\r\n\r\n\r\n#### 2ï¼‰ã€ä½¿ç”¨ Nacos æ³¨å†Œä¸­å¿ƒ\r\n\r\n```xml\r\n<dependency>\r\n\t<groupId>com.alibaba.cloud</groupId>\r\n\t<artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\r\n</dependency>\r\n```\r\n\r\n\r\n\r\n#### 3ï¼‰ã€å®šä¹‰ fallback å®ç°\r\n\r\n- åœ¨æœåŠ¡æ¶ˆè´¹è€…ä¸­ï¼Œå®ç° feign è¿œç¨‹æ¥å£ï¼Œæ¥å£çš„å®ç°æ–¹æ³•å³ä¸ºè°ƒç”¨é”™è¯¯çš„å®¹é”™æ–¹æ³•\r\n\r\n```java\r\npublic class OrderFeignServiceFallBack implements OrderFeignService {\r\n\t@Override\r\n\tpublic Resp<OrderVo> getOrderInfo(String orderSn) {\r\n\t\treturn null;\r\n\t}\r\n}\r\n```\r\n\r\n\r\n\r\n#### 4ï¼‰ã€å®šä¹‰ fallbackfactory å¹¶æ”¾åœ¨å®¹å™¨ä¸­\r\n\r\n```java\r\n@Component\r\npublic class OrderFeignFallbackFactory implements FallbackFactory<OrderFeignServiceFallBack> {\r\n\t@Override\r\n\tpublic OrderFeignServiceFallBack create(Throwable throwable) {\r\n\t\treturn new OrderFeignServiceFallBack(throwable);\r\n\t}\r\n}\r\n```\r\n\r\n\r\n\r\n#### 5ï¼‰ã€æ”¹é€  fallback ç±»æ¥å—å¼‚å¸¸å¹¶å®ç°å®¹é”™æ–¹æ³•\r\n\r\n```java\r\npublic class OrderFeignServiceFallBack implements OrderFeignService {\r\n\tprivate Throwable throwable;\r\n\tpublic OrderFeignServiceFallBack(Throwable throwable){\r\n\t\tthis.throwable = throwable;\r\n\t}\r\n\r\n\t@Override\r\n\tpublic Resp<OrderVo> getOrderInfo(String orderSn) {\r\n\t\treturn Resp.fail(new OrderVo());\r\n\t}\r\n}\r\n```\r\n\r\n\r\n\r\n#### 6ã€è¿œç¨‹æ¥å£é…ç½® feign å®¢æˆ·ç«¯å®¹é”™\r\n\r\n```java\r\n@FeignClient(value = \"gulimall-oms\",fallbackFactory = OrderFeignFallbackFactory.class)\r\npublic interface OrderFeignService {\r\n\t@GetMapping(\"/oms/order/bysn/{orderSn}\")\r\n\tpublic Resp<OrderVo> getOrderInfo(@PathVariable(\"orderSn\") StringorderSn);\r\n}\r\n```\r\n\r\n\r\n\r\n#### 7ï¼‰ã€å¼€å¯ sentinel ä»£ç† feign åŠŸèƒ½ï¼›åœ¨ application.properties ä¸­é…ç½®\r\n\r\n```properties\r\nfeign.sentinel.enabled=true\r\n```\r\n\r\n- æµ‹è¯•ç†”æ–­æ•ˆæœã€‚å½“è¿œç¨‹æœåŠ¡å‡ºç°é—®é¢˜ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨å›è°ƒæ–¹æ³•è¿”å›é»˜è®¤æ•°æ®ï¼Œå¹¶ä¸”æ›´å¿«çš„å®¹é”™æ–¹å¼\r\n\r\n##### iï¼‰ã€ä½¿ç”¨@SentinelResourceï¼Œå¹¶å®šä¹‰ fallback\r\n\r\n```java\r\n@SentinelResource(value = \"order\",fallback = \"e\")\r\n```\r\n\r\n- Fallback å’ŒåŸæ–¹æ³•ç­¾åä¸€è‡´ï¼Œä½†æ˜¯æœ€å¤šå¤šä¸€ä¸ª Throwable ç±»å‹çš„å˜é‡æ¥å—å¼‚å¸¸ã€‚\r\n\r\nhttps://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81\r\n\r\n- éœ€è¦ç»™å®¹å™¨ä¸­é…ç½®æ³¨è§£åˆ‡é¢\r\n\r\n```java\r\n@Bean\r\npublic SentinelResourceAspect sentinelResourceAspect() {\r\n\treturn new SentinelResourceAspect();\r\n}\r\n```\r\n\r\n- åœ¨æ§åˆ¶å°æ·»åŠ é™çº§ç­–ç•¥\r\n\r\n![image-20230426203412661](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426203412661.png)\r\n\r\n\r\n\r\n##### iiï¼‰ã€æµ‹è¯•é™çº§æ•ˆæœ\r\n\r\n- å½“è¿œç¨‹æœåŠ¡åœæ­¢ï¼Œå‰å‡ ä¸ªæœåŠ¡ä¼šå°è¯•è°ƒç”¨è¿œç¨‹æœåŠ¡ï¼Œæ»¡è¶³é™çº§ç­–ç•¥æ¡ä»¶ä»¥ååˆ™ä¸ä¼šå†å°è¯•è°ƒç”¨è¿œç¨‹æœåŠ¡\r\n\r\n\r\n\r\n### 4ã€æ•´åˆ Sentinel æµ‹è¯•é™æµï¼ˆæµé‡æ§åˆ¶ï¼‰\r\n\r\nhttps://github.com/alibaba/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-examples/sentinel-example/sentinel-core-example/readme-zh.md\r\n\r\n- ä»€ä¹ˆæ˜¯æµé‡æ§åˆ¶\r\n\r\nâ€‹\t\tæµé‡æ§åˆ¶åœ¨ç½‘ç»œä¼ è¾“ä¸­æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ¦‚å¿µï¼Œå®ƒç”¨äºè°ƒæ•´ç½‘ç»œåŒ…çš„å‘é€æ•°æ®ã€‚ç„¶è€Œï¼Œä»ç³»ç»Ÿç¨³å®šæ€§è§’åº¦è€ƒè™‘ï¼Œåœ¨å¤„ç†è¯·æ±‚çš„é€Ÿåº¦ä¸Šï¼Œä¹Ÿæœ‰éå¸¸å¤šçš„è®²ç©¶ã€‚ä»»æ„æ—¶é—´åˆ°æ¥çš„è¯·æ±‚å¾€å¾€æ˜¯éšæœºä¸å¯æ§çš„ï¼Œè€Œç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›æ˜¯æœ‰é™çš„ã€‚æˆ‘ä»¬éœ€è¦æ ¹æ®ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›å¯¹æµé‡è¿›è¡Œæ§åˆ¶ã€‚\r\n\r\n- Sentinel ä½œä¸ºä¸€ä¸ªè°ƒé…å™¨ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æŠŠéšæœºçš„è¯·æ±‚è°ƒæ•´æˆåˆé€‚çš„å½¢çŠ¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\r\n\r\n![image-20230426203735032](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426203735032.png)\r\n\r\n- æµé‡æ§åˆ¶è®¾è®¡ç†å¿µ\r\n\r\n  - æµé‡æ§åˆ¶æœ‰ä»¥ä¸‹å‡ ä¸ªè§’åº¦:\r\n\r\n    - èµ„æºçš„è°ƒç”¨å…³ç³»ï¼Œä¾‹å¦‚èµ„æºçš„è°ƒç”¨é“¾è·¯ï¼Œèµ„æºå’Œèµ„æºä¹‹é—´çš„å…³ç³»ï¼›\r\n\r\n    - è¿è¡ŒæŒ‡æ ‡ï¼Œä¾‹å¦‚ QPSã€çº¿ç¨‹æ± ã€ç³»ç»Ÿè´Ÿè½½ç­‰ï¼›\r\n\r\n    - æ§åˆ¶çš„æ•ˆæœï¼Œä¾‹å¦‚ç›´æ¥é™æµã€å†·å¯åŠ¨ã€æ’é˜Ÿç­‰ã€‚\r\n\r\n- Sentinel çš„è®¾è®¡ç†å¿µæ˜¯è®©æ‚¨è‡ªç”±é€‰æ‹©æ§åˆ¶çš„è§’åº¦ï¼Œå¹¶è¿›è¡Œçµæ´»ç»„åˆï¼Œä»è€Œè¾¾åˆ°æƒ³è¦çš„æ•ˆæœã€‚\r\n\r\n#### 1ï¼‰ã€å¼•å…¥ Sentinel starter\r\n\r\n```xml\r\n<dependency>\r\n\t<groupId>com.alibaba.cloud</groupId>\r\n\t<artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>\r\n</dependency>\r\n```\r\n\r\n\r\n\r\n#### 2ï¼‰ã€æ¥å…¥é™æµåŸ‹ç‚¹\r\n\r\n- HTTP åŸ‹ç‚¹\r\n  - Sentinel starter é»˜è®¤ä¸ºæ‰€æœ‰çš„ HTTP æœåŠ¡æä¾›äº†é™æµåŸ‹ç‚¹ï¼Œå¦‚æœåªæƒ³å¯¹ HTTP æœåŠ¡è¿›è¡Œé™æµï¼Œé‚£ä¹ˆåªéœ€è¦å¼•å…¥ä¾èµ–ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚\r\n\r\n- è‡ªå®šä¹‰åŸ‹ç‚¹\r\n  - å¦‚æœéœ€è¦å¯¹æŸä¸ªç‰¹å®šçš„æ–¹æ³•è¿›è¡Œé™æµæˆ–é™çº§ï¼Œå¯ä»¥é€šè¿‡ @SentinelResource æ³¨è§£æ¥å®Œæˆé™æµçš„åŸ‹ç‚¹ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n@SentinelResource(\"resource\")\r\npublic String hello() {\r\nreturn \"Hello\";\r\n}\r\n```\r\n\r\n> å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡åŸå§‹çš„ SphU.entry(xxx) æ–¹æ³•è¿›è¡ŒåŸ‹ç‚¹ï¼Œå¯ä»¥å‚è§Sentinel æ–‡ æ¡£ï¼ˆ https://github.com/alibaba/Sentinel/wiki/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8#%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90 ï¼‰ã€‚\r\n\r\n\r\n\r\n#### 3ï¼‰ã€é…ç½®é™æµè§„åˆ™\r\n\r\n- Sentinel æä¾›äº†ä¸¤ç§é…ç½®é™æµè§„åˆ™çš„æ–¹å¼ï¼šä»£ç é…ç½® å’Œ æ§åˆ¶å°é…ç½®ã€‚\r\n- é€šè¿‡ä»£ç æ¥å®ç°é™æµè§„åˆ™çš„é…ç½®ã€‚ä¸€ä¸ªç®€å•çš„é™æµè§„åˆ™é…ç½®ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼Œæ›´å¤šé™æµè§„åˆ™é…ç½®è¯¦æƒ…è¯·å‚è€ƒ Sentinel æ–‡æ¡£ã€‚\r\n  - ï¼ˆ https://github.com/alibaba/Sentinel/wiki/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8#%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99 ï¼‰\r\n\r\n\r\n```java\r\nList<FlowRule> rules = new ArrayList<FlowRule>();\r\nFlowRule rule = new FlowRule();\r\nrule.setResource(str);\r\n// set limit qps to 10\r\nrule.setCount(10);\r\nrule.setGrade(RuleConstant.FLOW_GRADE_QPS);\r\nrule.setLimitApp(\"default\");\r\nrules.add(rule);\r\nFlowRuleManager.loadRules(rules);\r\n```\r\n\r\n- é€šè¿‡æ§åˆ¶å°è¿›è¡Œé™æµè§„åˆ™é…ç½®\r\n  - 1ã€ä¸‹è½½æ§åˆ¶å°ï¼š`http://edas-public.oss-cn-hangzhou.aliyuncs.com/install_package/demo/sentinel-dashboard.jar`\r\n  - 2ã€å¯åŠ¨æ§åˆ¶å°ï¼Œæ‰§è¡Œ Java å‘½ä»¤ java -jar sentinel-dashboard.jar å®Œæˆ Sentinel æ§åˆ¶å°çš„å¯åŠ¨ã€‚ æ§åˆ¶å°é»˜è®¤çš„ç›‘å¬ç«¯å£ä¸º 8080ã€‚\r\n\r\n\r\n\r\n#### 4ï¼‰ã€å¯åŠ¨åº”ç”¨å¹¶é…ç½®\r\n\r\n- å¢åŠ é…ç½®ï¼Œåœ¨åº”ç”¨çš„ /src/main/resources/application.properties ä¸­æ·»åŠ åŸºæœ¬é…ç½®ä¿¡æ¯\r\n\r\n```properties\r\nspring.application.name=sentinel-example\r\nserver.port=18083\r\nspring.cloud.sentinel.transport.dashboard=localhost:8080\r\n```\r\n\r\n\r\n\r\n#### 5ï¼‰ã€æ§åˆ¶å°é…ç½®é™æµè§„åˆ™å¹¶éªŒè¯\r\n\r\n- è®¿é—® `http://localhost:8080` é¡µé¢ã€‚\r\n\r\n![image-20230426204723727](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426204723727.png)\r\n\r\n- å¦‚æœæ‚¨åœ¨æ§åˆ¶å°æ²¡æœ‰æ‰¾åˆ°åº”ç”¨ï¼Œè¯·è°ƒç”¨ä¸€ä¸‹è¿›è¡Œäº† Sentinel åŸ‹ç‚¹çš„ URL æˆ–æ–¹æ³•ï¼Œå› ä¸º Sentinel ä½¿ç”¨äº† lazy load ç­–ç•¥ã€‚\r\n- ä»»æ„å‘é€è¯·æ±‚ï¼Œå¯ä»¥åœ¨ç°‡ç‚¹é“¾è·¯é‡Œé¢çœ‹åˆ°åˆšæ‰çš„è¯·æ±‚ï¼Œå¯ä»¥å¯¹è¯·æ±‚è¿›è¡Œæµæ§ï¼›\r\n\r\n![image-20230426204910942](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426204910942.png)\r\n\r\n- æµ‹è¯•æµæ§æ•ˆæœ\r\n\r\n![image-20230426204933235](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426204933235.png)\r\n\r\n\r\n\r\n#### 6ï¼‰ã€è‡ªå®šä¹‰æµæ§å“åº”\r\n\r\n```java\r\npublic enum BizCodeEnum {\r\n\t...\r\n    TOO_MANY_REQUESTS(10003, \"è¯·æ±‚æµé‡è¿‡å¤§\"),\r\n    ...\r\n}\r\n```\r\n\r\n```java\r\n/**\r\n * Sentinelé…ç½®è‡ªå®šä¹‰å¼‚å¸¸è¿”å›ç»“æœ\r\n * @author Klaus\r\n * @date 2023/3/12\r\n */\r\n@Configuration\r\npublic class OrderSentinelConfig {\r\n\r\n    public OrderSentinelConfig(){\r\n        WebCallbackManager.setUrlBlockHandler(new UrlBlockHandler() {\r\n            @Override\r\n            public void blocked(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, BlockException e) throws IOException {\r\n                R error = R.error(BizCodeEnum.TOO_MANY_REQUESTS.getCode(), BizCodeEnum.TOO_MANY_REQUESTS.getMsg());\r\n                httpServletResponse.setCharacterEncoding(\"UTF-8\");\r\n                httpServletResponse.setContentType(\"application/json\");\r\n                httpServletResponse.getWriter().write(JSON.toJSONString(error));\r\n            }\r\n        });\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n#### 7ï¼‰ã€æŒä¹…åŒ–æµæ§è§„åˆ™\r\n\r\n- é»˜è®¤çš„æµæ§è§„åˆ™æ˜¯ä¿å­˜åœ¨é¡¹ç›®çš„å†…å­˜ä¸­ï¼Œé¡¹ç›®åœæ­¢å†å¯åŠ¨ï¼Œæµæ§è§„åˆ™å°±æ˜¯å¤±æ•ˆã€‚æˆ‘ä»¬å¯ä»¥æŒä¹…åŒ–ä¿å­˜è§„åˆ™ï¼›\r\n\r\nhttps://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95#datasource-%E6%89%A9%E5%B1%95\r\n\r\n- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ¨¡å¼ï¼š\r\n- æˆ‘ä»¬æ¨è**é€šè¿‡æ§åˆ¶å°è®¾ç½®è§„åˆ™åå°†è§„åˆ™æ¨é€åˆ°ç»Ÿä¸€çš„è§„åˆ™ä¸­å¿ƒï¼Œå®¢æˆ·ç«¯å®ç° ReadableDataSource æ¥å£ç«¯ç›‘å¬è§„åˆ™ä¸­å¿ƒå®æ—¶è·å–å˜æ›´**\r\n\r\n![image-20230426205909812](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426205909812.png)\r\n\r\n- è§£å†³æ–¹æ¡ˆï¼š\r\n  - DataSource æ‰©å±•å¸¸è§çš„å®ç°æ–¹å¼æœ‰:\r\n    - æ‹‰æ¨¡å¼ï¼šå®¢æˆ·ç«¯ä¸»åŠ¨å‘æŸä¸ªè§„åˆ™ç®¡ç†ä¸­å¿ƒå®šæœŸè½®è¯¢æ‹‰å–è§„åˆ™ï¼Œè¿™ä¸ªè§„åˆ™ä¸­å¿ƒå¯ä»¥æ˜¯RDBMSã€æ–‡ä»¶ï¼Œç”šè‡³æ˜¯ VCS ç­‰ã€‚è¿™æ ·åšçš„æ–¹å¼æ˜¯ç®€å•ï¼Œç¼ºç‚¹æ˜¯æ— æ³•åŠæ—¶è·å–å˜æ›´ï¼›\r\n    - æ¨æ¨¡å¼ï¼šè§„åˆ™ä¸­å¿ƒç»Ÿä¸€æ¨é€ï¼Œå®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œç›‘å¬å™¨çš„æ–¹å¼æ—¶åˆ»ç›‘å¬å˜åŒ–ï¼Œæ¯”å¦‚ä½¿ç”¨Nacosã€Zookeeper ç­‰é…ç½®ä¸­å¿ƒã€‚è¿™ç§æ–¹å¼æœ‰æ›´å¥½çš„å®æ—¶æ€§å’Œä¸€è‡´æ€§ä¿è¯ã€‚\r\n\r\n- æ¨æ¨¡å¼ï¼šä½¿ç”¨ Nacos é…ç½®è§„åˆ™\r\n- 1ã€å¼•å…¥ä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n\t<groupId>com.alibaba.csp</groupId>\r\n\t<artifactId>sentinel-datasource-nacos</artifactId>\r\n\t<version>1.6.3</version>\r\n</dependency>\r\n```\r\n\r\n- 2ã€ç¼–å†™é…ç½®ç±»\r\n\r\nhttps://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95#%E6%8E%A8%E6%A8%A1%E5%BC%8F%E4%BD%BF%E7%94%A8-nacos-%E9%85%8D%E7%BD%AE%E8%A7%84%E5%88%99\r\n\r\n```java\r\n@Configuration\r\npublic class SentinelConfig {\r\n\tpublic SentinelConfig(){\r\n        //1ã€åŠ è½½æµæ§ç­–ç•¥\r\n        ReadableDataSource<String, List<FlowRule>> flowRuleDataSource = new\r\n        NacosDataSource<>(\"127.0.0.1:8848\", \"demo\", \"sentinel\",\r\n        source -> JSON.parseObject(source, new TypeReference<List<FlowRule>>() {}));\r\n        FlowRuleManager.register2Property(flowRuleDataSource.getProperty());\r\n\r\n        //2ã€åŠ è½½é™çº§ç­–ç•¥\r\n        ReadableDataSource<String, List<DegradeRule>> degradeRuleDataSource =\r\n        new NacosDataSource<>(\"127.0.0.1:8848\", \"demo\", \"sentinel\",\r\n        source -> JSON.parseObject(source, new TypeReference<List<DegradeRule>>() {}));\r\n        DegradeRuleManager.register2Property(degradeRuleDataSource.getProperty());\r\n        //3ã€åŠ è½½ç³»ç»Ÿè§„åˆ™\r\n        ReadableDataSource<String, List<SystemRule>> systemRuleDataSource =\r\n        new NacosDataSource<>(\"127.0.0.1:8848\", \"demo\", \"sentinel\",\r\n        source -> JSON.parseObject(source, new TypeReference<List<SystemRule>>() {}));\r\n        SystemRuleManager.register2Property(systemRuleDataSource.getProperty());\r\n        //4ã€åŠ è½½æƒé™ç­–ç•¥\r\n        ReadableDataSource<String, List<AuthorityRule>> authorityRuleDataSource = new \t\t             NacosDataSource<>(\"127.0.0.1:8848\", \"demo\", \"sentinel\",\r\n        source -> JSON.parseObject(source, new TypeReference<List<AuthorityRule>>() {}));\r\n        AuthorityRuleManager.register2Property(authorityRuleDataSource.getProperty());\r\n\t}\r\n}\r\n```\r\n\r\n> å‚ç…§ https://github.com/alibaba/Sentinel/wiki/Dynamic-Rule-Configuration æŸ¥çœ‹æ›´å¤šæ§åˆ¶è§„åˆ™\r\n\r\n- 3ã€åœ¨ nacos ä¸­åˆ›å»º dataIdï¼Œå¹¶ä½¿ç”¨ json æ ¼å¼\r\n\r\n![image-20230426210614070](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426210614070.png)\r\n\r\n- 4ã€æ·»åŠ ä¸€æ¡æµæ§è§„åˆ™æµ‹è¯•\r\n\r\n```json\r\n[\r\n    {\r\n        \"resource\": \"/ums/member/list\",\r\n        \"limitApp\": \"default\",\r\n        \"grade\": 1,\r\n        \"count\": 5,\r\n        \"strategy\": 0,\r\n        \"controlBehavior\": 0,\r\n        \"clusterMode\": false\r\n    }\r\n]\r\n```\r\n\r\n- é…ç½®å«ä¹‰è¯´æ˜ï¼š\r\n\r\n  https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6\r\n\r\n  - resourceï¼šèµ„æºåï¼Œå³é™æµè§„åˆ™çš„ä½œç”¨å¯¹è±¡\r\n\r\n  - count: é™æµé˜ˆå€¼\r\n\r\n  - grade: é™æµé˜ˆå€¼ç±»å‹ï¼ˆQPS æˆ–å¹¶å‘çº¿ç¨‹æ•°ï¼‰\r\n\r\n  - limitApp: æµæ§é’ˆå¯¹çš„è°ƒç”¨æ¥æºï¼Œè‹¥ä¸º default åˆ™ä¸åŒºåˆ†è°ƒç”¨æ¥æº\r\n\r\n  - strategy: è°ƒç”¨å…³ç³»é™æµç­–ç•¥\r\n\r\n  - controlBehavior: æµé‡æ§åˆ¶æ•ˆæœï¼ˆç›´æ¥æ‹’ç»ã€Warm Upã€åŒ€é€Ÿæ’é˜Ÿï¼‰\r\n\r\n- 5ã€ç³»ç»Ÿè§„åˆ™ï¼Œé™çº§è§„åˆ™ç­‰å‡å¯æ·»åŠ \r\n\r\n```json\r\n[\r\n    {\r\n        \"resource\": \"/ums/member/list\",\r\n        \"limitApp\": \"default\",\r\n        \"grade\": 1,\r\n        \"count\": 5,\r\n        \"strategy\": 0,\r\n        \"controlBehavior\": 0,\r\n        \"clusterMode\": false\r\n    },\r\n    {\r\n        \"highestSystemLoad\": -1,\r\n        \"highestCpuUsage\": 0.99,\r\n        \"qps\": 2,\r\n        \"avgRt\": 10,\r\n        \"maxThread\": 10\r\n    }\r\n]\r\n```\r\n\r\n\r\n\r\n- 6ã€æœ€ç»ˆæ•ˆæœ\r\n  - Sentinel æ§åˆ¶å°æ”¹å˜æµæ§è§„åˆ™ï¼Œä¸èƒ½æ¨é€åˆ° nacos ä¸­ï¼ŒNacos ä¸­æ”¹å˜æµæ§è§„åˆ™å¯ä»¥å®æ—¶è§‚å¯Ÿåˆ°å˜åŒ–\r\n\r\n![image-20230426211149631](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426211149631.png)\r\n\r\n- ç¬¬ 2 æ­¥ API çš„æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥å˜ä¸ºé…ç½®æ–¹å¼ï¼›åœ¨ application.properties ä¸­é…ç½®\r\n\r\n```properties\r\nspring.cloud.sentinel.datasource.ds.nacos.server-addr=127.0.0.1:8848\r\nspring.cloud.sentinel.datasource.ds.nacos.data-id=sentinel\r\nspring.cloud.sentinel.datasource.ds.nacos.group-id=demo\r\nspring.cloud.sentinel.datasource.ds.nacos.rule-type=flow\r\nspring.cloud.sentinel.datasource.ds1.nacos.server-addr=127.0.0.1:8848\r\nspring.cloud.sentinel.datasource.ds1.nacos.data-id=sentinel\r\nspring.cloud.sentinel.datasource.ds1.nacos.group-id=demo\r\nspring.cloud.sentinel.datasource.ds1.nacos.rule-type=system\r\n```\r\n\r\n> ds,ds1 æ˜¯éšä¾¿å†™çš„ã€‚\r\n\r\n\r\n\r\n## 5ã€SpringCloud Alibaba-Seata\r\n\r\n### 1ã€ç®€ä»‹\r\n\r\n- Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹æä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚\r\n\r\nhttps://seata.io/zh-cn/\r\n\r\n\r\n\r\n### 2ã€æ ¸å¿ƒæ¦‚å¿µ\r\n\r\n- TC - äº‹åŠ¡åè°ƒè€…\r\n  - ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚\r\n\r\n- TM - äº‹åŠ¡ç®¡ç†å™¨\r\n  - å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼šå¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚\r\n\r\n- RM - èµ„æºç®¡ç†å™¨\r\n  - ç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸ TC äº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚\r\n- å·¥ä½œåŸç†ï¼š\r\n\r\n![image-20230322152804762](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322152804762.png)\r\n\r\n\r\n\r\n### 3ã€ä½¿ç”¨æ­¥éª¤ï¼ˆæµ‹è¯• AT æ¨¡å¼ï¼‰\r\n\r\n#### 1ã€ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»º undo_log è¡¨\r\n\r\n```sql\r\nDROP TABLE IF EXISTS `undo_log`;\r\nCREATE TABLE `undo_log` (\r\n`id` bigint(20) NOT NULL AUTO_INCREMENT,\r\n`branch_id` bigint(20) NOT NULL,\r\n`xid` varchar(100) NOT NULL,\r\n`context` varchar(128) NOT NULL,\r\n`rollback_info` longblob NOT NULL,\r\n`log_status` int(11) NOT NULL,\r\n`log_created` datetime NOT NULL,\r\n`log_modified` datetime NOT NULL,\r\n`ext` varchar(100) DEFAULT NULL,\r\nPRIMARY KEY (`id`),\r\nUNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)\r\n) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;\r\n```\r\n\r\n\r\n\r\n#### 2ã€éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„æœåŠ¡å¯¼å…¥ seata-starter\r\n\r\n```xml\r\n<dependency>\r\n\t<groupId>com.alibaba.cloud</groupId>\r\n    <artifactId>spring-cloud-alibaba-seata</artifactId>\r\n    <version>2.0.0.RELEASE</version>\r\n</dependency>\r\n```\r\n\r\n\r\n\r\n#### 3ã€ä½¿ç”¨ seata æ•°æ®æºä»£ç†åŸæ•°æ®æº\r\n\r\n```java\r\n  @Configuration\r\n  public class DataSourceConfig {\r\n  \t  @Bean\r\n      @ConfigurationProperties(prefix = \"spring.datasource\")\r\n      public DruidDataSource druidDataSource() {\r\n      return new DruidDataSource();\r\n  }\r\n      /**\r\n      * éœ€è¦å°† DataSourceProxy è®¾ç½®ä¸ºä¸»æ•°æ®æºï¼Œå¦åˆ™äº‹åŠ¡æ— æ³•å›æ»š\r\n      *\r\n      * @param druidDataSource The DruidDataSource\r\n      * @return The default datasource\r\n      */\r\n      @Primary\r\n      @Bean(\"dataSource\")\r\n      public DataSource dataSource(DruidDataSource druidDataSource) {\r\n     \t return new DataSourceProxy(druidDataSource);\t\r\n      }\r\n  }\r\n```\r\n\r\n  \r\n\r\n#### 4ã€ç»™å¾®æœåŠ¡åŠ å…¥ file.conf å’Œ registry.conf\r\n\r\n```java\r\nregistry.conf\r\nregistry {\r\n\r\n    # file ã€nacos ã€eurekaã€redisã€zk\r\n    type = \"file\"\r\n    nacos {\r\n    serverAddr = \"localhost\"\r\n    namespace = \"public\"\r\n    cluster = \"default\"\r\n    }\r\n    eureka {\r\n    serviceUrl = \"http://localhost:1001/eureka\"\r\n    application = \"default\"\r\n    weight = \"1\"\r\n    }\r\n    redis {\r\n    serverAddr = \"localhost:6381\"\r\n    db = \"0\"\r\n    }\r\n    zk {\r\n    cluster = \"default\"\r\n    serverAddr = \"127.0.0.1:2181\"\r\n    session.timeout = 6000\r\n    connect.timeout = 2000\r\n    }\r\n    file {\r\n    name = \"file.conf\"\r\n    }\r\n}\r\nconfig {\r\n    # fileã€nacos ã€apolloã€zk\r\n    type = \"file\"\r\n    nacos {\r\n    serverAddr = \"localhost\"\r\n    namespace = \"public\"\r\n    cluster = \"default\"\r\n    }\r\n    apollo {\r\n    app.id = \"fescar-server\"\r\n    apollo.meta = \"http://192.168.1.204:8801\"\r\n    }\r\n    zk {\r\n    serverAddr = \"127.0.0.1:2181\"\r\n    session.timeout = 6000\r\n    connect.timeout = 2000\r\n    }\r\n    file {\r\n    name = \"file.conf\"\r\n    }\r\n}\r\n\r\nfile.conf\r\ntransport {\r\n    # tcp udt unix-domain-socket\r\n    type = \"TCP\"\r\n    #NIO NATIVE\r\n    server = \"NIO\"\r\n    #enable heartbeat\r\n    heartbeat = true\r\n    #thread factory for netty\r\n    thread-factory {\r\n    boss-thread-prefix = \"NettyBoss\"\r\n    worker-thread-prefix = \"NettyServerNIOWorker\"\r\n    server-executor-thread-prefix = \"NettyServerBizHandler\"\r\n    share-boss-worker = false\r\n    client-selector-thread-prefix = \"NettyClientSelector\"\r\n    client-selector-thread-size = 1\r\n    client-worker-thread-prefix = \"NettyClientWorkerThread\"\r\n    # netty boss thread size,will not be used for UDT\r\n    boss-thread-size = 1\r\n    #auto default pin or 8\r\n    worker-thread-size = 8\r\n}\r\nshutdown {\r\n    # when destroy server, wait seconds\r\n    wait = 3\r\n}\r\nserialization = \"seata\"\r\ncompressor = \"none\"\r\n}\r\nservice {\r\n    #vgroup->rgroup\r\n    vgroup_mapping.order-service-fescar-service-group=\"default\"\r\n    #only support single node\r\n    default.grouplist = \"127.0.0.1:8091\"\r\n    #degrade current not support\r\n    enableDegrade = false\r\n    #disable\r\n    disable = false\r\n    #unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent\r\n    max.commit.retry.timeout = \"-1\"\r\n    max.rollback.retry.timeout = \"-1\"\r\n    disableGlobalTransaction = false\r\n}\r\nclient {\r\n    async.commit.buffer.limit = 10000\r\n    lock {\r\n    retry.internal = 10\r\n    retry.times = 30\r\n    }\r\n    report.retry.count = 5\r\n    tm.commit.retry.count = 1\r\n    tm.rollback.retry.count = 1\r\n}\r\ntransaction {\r\n    undo.data.validation = true\r\n    undo.log.serialization = \"jackson\"\r\n    undo.log.save.days = 7\r\n    #schedule delete expired undo_log in milliseconds\r\n    undo.log.delete.period = 86400000\r\n    undo.log.table = \"undo_log\"\r\n}\r\nsupport {\r\n    ## spring\r\n    spring {\r\n        # auto proxy the DataSource bean\r\n        datasource.autoproxy = false\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n#### 5ã€å¯åŠ¨ seata æœåŠ¡å™¨\r\n\r\n- ä» https://github.com/seata/seata/releases ,ä¸‹è½½æœåŠ¡å™¨è½¯ä»¶åŒ…ï¼Œå°†å…¶è§£å‹ç¼©ã€‚\r\n\r\n\r\n\r\n#### 6ã€ä½¿ç”¨äº‹åŠ¡æ³¨è§£\r\n\r\n- @GlobalTransactionalï¼šæ ‡æ³¨åœ¨æ€»äº‹åŠ¡ä¸­ï¼Œå…¶ä»–åˆ†æ”¯äº‹åŠ¡ï¼Œç»§ç»­ä½¿ç”¨@Transactional å³å¯\r\n\r\n\r\n\r\n#### 7ã€æµ‹è¯•å›æ»šæ•ˆæœ\r\n\r\n- æµ‹è¯•æœ¬åœ°äº‹åŠ¡å‡ºç°é—®é¢˜åï¼Œè¿œç¨‹äº‹åŠ¡æ˜¯å¦å¯ä»¥å›æ»š\r\n\r\n\r\n\r\n#### 8ã€å®˜æ–¹æ›´å¤šç¤ºä¾‹\r\n\r\n- https://github.com/seata/seata-samples/tree/master/springcloud-nacos-seata æ•´åˆ nacos\r\n\r\n- https://github.com/seata/seata-samples/tree/master/springcloud-jpa-seata æ•´åˆ jpa\r\n- https://github.com/seata/seata-samples/tree/master/springboot-dubbo-seata æ•´åˆ dubbo\r\n- https://github.com/seata/seata-samples/tree/master/springboot-shardingsphere-seata\r\n\r\n\r\n\r\n\r\n\r\n## 6ã€SpringCloud Alibaba-OSS\r\n\r\n### 1ã€ç®€ä»‹\r\n\r\nå¯¹è±¡å­˜å‚¨æœåŠ¡ï¼ˆObject Storage Serviceï¼ŒOSSï¼‰æ˜¯ä¸€ç§æµ·é‡ã€å®‰å…¨ã€ä½æˆæœ¬ã€é«˜å¯é çš„äº‘å­˜å‚¨æœåŠ¡ï¼Œé€‚åˆå­˜æ”¾ä»»æ„ç±»å‹çš„æ–‡ä»¶ã€‚å®¹é‡å’Œå¤„ç†èƒ½åŠ›å¼¹æ€§æ‰©å±•ï¼Œå¤šç§å­˜å‚¨ç±»å‹ä¾›é€‰æ‹©ï¼Œå…¨é¢ä¼˜åŒ–å­˜å‚¨æˆæœ¬ã€‚\r\n\r\n\r\n\r\n### 2ã€ä½¿ç”¨æ­¥éª¤\r\n\r\n#### 1ã€å¼€é€šé˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨æœåŠ¡\r\n\r\n![image-20230426213046758](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426213046758.png)\r\n\r\nhttps://www.aliyun.com/product/oss\r\n\r\n\r\n\r\n#### 2ã€å¼•å…¥ SpringCloud Alibaba-OSS\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>com.alibaba.cloud</groupId>\r\n    <artifactId>spring-cloud-alicloud-oss</artifactId>\r\n</dependency>\r\n```\r\n\r\n\r\n\r\n#### 3ã€é…ç½®é˜¿é‡Œäº‘ oss ç›¸å…³çš„è´¦å·ä¿¡æ¯\r\n\r\n```yaml\r\nspring:\r\n    cloud:\r\n        alicloud:\r\n            oss:\r\n            \tendpoint: oss-cn-shanghai.aliyuncs.com\r\n            access-key: xxxxxx\r\n            secret-key: xxxxxx\r\n```\r\n\r\n> æ³¨æ„ï¼šå¿…é¡»ç”³è¯· RAM è´¦å·ä¿¡æ¯ï¼Œå¹¶ä¸”åˆ†é… OSS æ“ä½œæƒé™\r\n\r\n\r\n\r\n#### 4ã€æµ‹è¯•ä½¿ç”¨ OssClient ä¸Šä¼ \r\n\r\n```java\r\n@Autowired\r\nOSSClient ossClient;\r\n@Test\r\npublic void contextLoads2() throws FileNotFoundException {\r\n    InputStream inputStream = new\r\n    FileInputStream(\"C:\\\\Users\\\\lfy\\\\Pictures\\\\bug.jpg\");\r\n    ossClient.putObject(\"gulimall\", \"aaa/bug222.jpg\", inputStream);\r\n    System.out.println(\"ok\");\r\n}\r\n```\r\n\r\n\r\n\r\n# äºŒã€SpringCloud\r\n\r\n## 1ã€Feign å£°æ˜å¼è¿œç¨‹è°ƒç”¨\r\n\r\n### 1ã€ç®€ä»‹\r\n\r\n- Feign æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ HTTP å®¢æˆ·ç«¯ï¼Œå®ƒçš„ç›®çš„å°±æ˜¯è®©è¿œç¨‹è°ƒç”¨æ›´åŠ ç®€å•ã€‚Feign æä¾›äº† HTTPè¯·æ±‚çš„æ¨¡æ¿ï¼Œé€šè¿‡ç¼–å†™ç®€å•çš„æ¥å£å’Œæ’å…¥æ³¨è§£ï¼Œå°±å¯ä»¥å®šä¹‰å¥½ HTTP è¯·æ±‚çš„å‚æ•°ã€æ ¼å¼ã€åœ°å€ç­‰ä¿¡æ¯ã€‚\r\n- Feign æ•´åˆäº† Ribbonï¼ˆè´Ÿè½½å‡è¡¡ï¼‰å’Œ Hystrix(æœåŠ¡ç†”æ–­)ï¼Œå¯ä»¥è®©æˆ‘ä»¬ä¸å†éœ€è¦æ˜¾å¼åœ°ä½¿ç”¨è¿™ä¸¤ä¸ªç»„ä»¶ã€‚\r\n- SpringCloudFeign åœ¨ NetflixFeign çš„åŸºç¡€ä¸Šæ‰©å±•äº†å¯¹ SpringMVC æ³¨è§£çš„æ”¯æŒï¼Œåœ¨å…¶å®ç°ä¸‹ï¼Œæˆ‘ä»¬åªéœ€åˆ›å»ºä¸€ä¸ªæ¥å£å¹¶ç”¨æ³¨è§£çš„æ–¹å¼æ¥é…ç½®å®ƒï¼Œå³å¯å®Œæˆå¯¹æœåŠ¡æä¾›æ–¹çš„æ¥å£ç»‘å®šã€‚ç®€åŒ–äº†SpringCloudRibbon è‡ªè¡Œå°è£…æœåŠ¡è°ƒç”¨å®¢æˆ·ç«¯çš„å¼€å‘é‡ã€‚\r\n\r\n\r\n\r\n### 2ã€ä½¿ç”¨\r\n\r\n- 1ã€å¼•å…¥ä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n  <groupId>org.springframework.cloud</groupId>\r\n  <artifactId>spring-cloud-starter-openfeign</artifactId>\r\n</dependency>\r\n```\r\n\r\n- 2ã€å¼€å¯ feign åŠŸèƒ½\r\n\r\n```java\r\n@EnableFeignClients(basePackages = \"com.atguigu.gulimall.pms.feign\")\r\n```\r\n\r\n- 3ã€å£°æ˜è¿œç¨‹æ¥å£\r\n\r\n```java\r\n@FeignClient(\"gulimall-ware\")\r\npublic interface WareFeignService {\r\n\t@PostMapping(\"/ware/waresku/skus\")\r\n\tpublic Resp<List<SkuStockVo>> skuWareInfos(@RequestBody List<Long> skuIds);\r\n}\r\n```\r\n\r\n\r\n\r\n### 3ã€åŸç†\r\n\r\n![image-20230426214256506](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426214256506.png)\r\n\r\n\r\n\r\n## 2ã€Gateway\r\n\r\n### 1ã€ç®€ä»‹\r\n\r\n- ç½‘å…³ä½œä¸ºæµé‡çš„å…¥å£ï¼Œå¸¸ç”¨åŠŸèƒ½åŒ…æ‹¬è·¯ç”±è½¬å‘ã€æƒé™æ ¡éªŒã€é™æµæ§åˆ¶ç­‰ã€‚è€Œ springcloud gateway ä½œä¸º SpringCloud å®˜æ–¹æ¨å‡ºçš„ç¬¬äºŒä»£ç½‘å…³æ¡†æ¶ï¼Œå–ä»£äº† Zuul ç½‘å…³ã€‚\r\n\r\n![image-20230426214409516](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426214409516.png)\r\n\r\n- ç½‘å…³æä¾› API å…¨æ‰˜ç®¡æœåŠ¡ï¼Œä¸°å¯Œçš„ API ç®¡ç†åŠŸèƒ½ï¼Œè¾…åŠ©ä¼ä¸šç®¡ç†å¤§è§„æ¨¡çš„ APIï¼Œä»¥é™ä½ç®¡ç†æˆæœ¬å’Œå®‰å…¨é£é™©ï¼ŒåŒ…æ‹¬åè®®é€‚é…ã€åè®®è½¬å‘ã€å®‰å…¨ç­–ç•¥ã€é˜²åˆ·ã€æµé‡ã€ç›‘æ§æ—¥å¿—ç­‰åŠŸèƒ½ã€‚\r\n- Spring Cloud Gateway æ—¨åœ¨æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„æ–¹å¼æ¥å¯¹ API è¿›è¡Œè·¯ç”±ï¼Œå¹¶ä¸ºä»–ä»¬æä¾›åˆ‡é¢ï¼Œä¾‹å¦‚ï¼šå®‰å…¨æ€§ï¼Œç›‘æ§/æŒ‡æ ‡ å’Œå¼¹æ€§ç­‰ã€‚\r\n- å®˜æ–¹æ–‡æ¡£åœ°å€ï¼š\r\n\r\nhttps://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.3.RELEASE/single/spring-cloud-gateway.html\r\n\r\n- Spring Cloud Gateway ç‰¹ç‚¹:\r\n\r\n  - åŸºäº Spring5ï¼Œæ”¯æŒå“åº”å¼ç¼–ç¨‹å’Œ SpringBoot2.0\r\n\r\n  - æ”¯æŒä½¿ç”¨ä»»ä½•è¯·æ±‚å±æ€§è¿›è¡Œè·¯ç”±åŒ¹é…\r\n\r\n  - ç‰¹å®šäºè·¯ç”±çš„æ–­è¨€å’Œè¿‡æ»¤å™¨\r\n\r\n  - é›†æˆ Hystrix è¿›è¡Œæ–­è·¯ä¿æŠ¤\r\n\r\n  - é›†æˆæœåŠ¡å‘ç°åŠŸèƒ½\r\n\r\n  - æ˜“äºç¼–å†™ Predicates å’Œ Filters\r\n\r\n  - æ”¯æŒè¯·æ±‚é€Ÿç‡é™åˆ¶\r\n\r\n  - æ”¯æŒè·¯å¾„é‡å†™\r\n\r\n- æ€è€ƒï¼š\r\n- ä¸ºä»€ä¹ˆä½¿ç”¨ API ç½‘å…³ï¼Ÿ\r\n- API ç½‘å…³å‡ºç°çš„åŸå› æ˜¯å¾®æœåŠ¡æ¶æ„çš„å‡ºç°ï¼Œä¸åŒçš„å¾®æœåŠ¡ä¸€èˆ¬ä¼šæœ‰ä¸åŒçš„ç½‘ç»œåœ°å€ï¼Œè€Œå¤–éƒ¨å®¢æˆ·ç«¯å¯èƒ½éœ€è¦è°ƒç”¨å¤šä¸ªæœåŠ¡çš„æ¥å£æ‰èƒ½å®Œæˆä¸€ä¸ªä¸šåŠ¡éœ€æ±‚ï¼Œå¦‚æœè®©å®¢æˆ·ç«¯ç›´æ¥ä¸å„ä¸ªå¾®æœåŠ¡é€šä¿¡ï¼Œä¼šæœ‰ä»¥ä¸‹çš„é—®é¢˜ï¼š\r\n  - å®¢æˆ·ç«¯ä¼šå¤šæ¬¡è¯·æ±‚ä¸åŒçš„å¾®æœåŠ¡ï¼Œå¢åŠ äº†å®¢æˆ·ç«¯çš„å¤æ‚æ€§ã€‚\r\n  - å­˜åœ¨è·¨åŸŸè¯·æ±‚ï¼Œåœ¨ä¸€å®šåœºæ™¯ä¸‹å¤„ç†ç›¸å¯¹å¤æ‚ã€‚\r\n  - è®¤è¯å¤æ‚ï¼Œæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦ç‹¬ç«‹è®¤è¯ã€‚\r\n  - éš¾ä»¥é‡æ„ï¼Œéšç€é¡¹ç›®çš„è¿­ä»£ï¼Œå¯èƒ½éœ€è¦é‡æ–°åˆ’åˆ†å¾®æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¯èƒ½å°†å¤šä¸ªæœåŠ¡åˆå¹¶æˆä¸€ä¸ªæˆ–è€…å°†ä¸€ä¸ªæœåŠ¡æ‹†åˆ†æˆå¤šä¸ªã€‚å¦‚æœå®¢æˆ·ç«¯ç›´æ¥ä¸å¾®æœåŠ¡é€šä¿¡ï¼Œé‚£ä¹ˆé‡æ„å°†ä¼šå¾ˆéš¾å®æ–½ã€‚\r\n  - æŸäº›å¾®æœåŠ¡å¯èƒ½ä½¿ç”¨äº†é˜²ç«å¢™ / æµè§ˆå™¨ä¸å‹å¥½çš„åè®®ï¼Œç›´æ¥è®¿é—®ä¼šæœ‰ä¸€å®šçš„å›°éš¾ã€‚\r\n- ä»¥ä¸Šè¿™äº›é—®é¢˜å¯ä»¥å€ŸåŠ© API ç½‘å…³è§£å†³ã€‚API ç½‘å…³æ˜¯ä»‹äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¹‹é—´çš„ä¸­é—´å±‚ï¼Œæ‰€æœ‰çš„å¤–éƒ¨è¯·æ±‚éƒ½ä¼šå…ˆç»è¿‡ API ç½‘å…³è¿™ä¸€å±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒAPI çš„å®ç°æ–¹é¢æ›´å¤šçš„è€ƒè™‘ä¸šåŠ¡é€»è¾‘ï¼Œè€Œå®‰å…¨ã€æ€§èƒ½ã€ç›‘æ§å¯ä»¥äº¤ç”± API ç½‘å…³æ¥åšï¼Œè¿™æ ·æ—¢æé«˜ä¸šåŠ¡çµæ´»æ€§åˆä¸ç¼ºå®‰å…¨æ€§ï¼šä½¿ç”¨ API ç½‘å…³åçš„ä¼˜ç‚¹å¦‚ä¸‹ï¼š\r\n  - æ˜“äºç›‘æ§ã€‚å¯ä»¥åœ¨ç½‘å…³æ”¶é›†ç›‘æ§æ•°æ®å¹¶å°†å…¶æ¨é€åˆ°å¤–éƒ¨ç³»ç»Ÿè¿›è¡Œåˆ†æã€‚\r\n  - æ˜“äºè®¤è¯ã€‚å¯ä»¥åœ¨ç½‘å…³ä¸Šè¿›è¡Œè®¤è¯ï¼Œç„¶åå†å°†è¯·æ±‚è½¬å‘åˆ°åç«¯çš„å¾®æœåŠ¡ï¼Œè€Œæ— é¡»åœ¨æ¯ä¸ªå¾®æœåŠ¡ä¸­è¿›è¡Œè®¤è¯ã€‚\r\n  - å‡å°‘äº†å®¢æˆ·ç«¯ä¸å„ä¸ªå¾®æœåŠ¡ä¹‹é—´çš„äº¤äº’æ¬¡æ•°ã€‚\r\n\r\n\r\n\r\n### 2ã€æ ¸å¿ƒæ¦‚å¿µ\r\n\r\n- è·¯ç”±ã€‚è·¯ç”±æ˜¯ç½‘å…³æœ€åŸºç¡€çš„éƒ¨åˆ†ï¼Œè·¯ç”±ä¿¡æ¯æœ‰ä¸€ä¸ª IDã€ä¸€ä¸ªç›®çš„ URLã€ä¸€ç»„æ–­è¨€å’Œä¸€ç»„Filter ç»„æˆã€‚å¦‚æœæ–­è¨€è·¯ç”±ä¸ºçœŸï¼Œåˆ™è¯´æ˜è¯·æ±‚çš„ URL å’Œé…ç½®åŒ¹é…\r\n- æ–­è¨€ã€‚Java8 ä¸­çš„æ–­è¨€å‡½æ•°ã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°è¾“å…¥ç±»å‹æ˜¯ Spring5.0 æ¡†æ¶ä¸­çš„ ServerWebExchangeã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é…æ¥è‡ªäº http request ä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰ã€‚\r\n- è¿‡æ»¤å™¨ã€‚ä¸€ä¸ªæ ‡å‡†çš„ Spring webFilterã€‚Spring cloud gateway ä¸­çš„ filter åˆ†ä¸ºä¸¤ç§ç±»å‹çš„Filterï¼Œåˆ†åˆ«æ˜¯ Gateway Filter å’Œ Global Filterã€‚è¿‡æ»¤å™¨ Filter å°†ä¼šå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œä¿®æ”¹å¤„ç†\r\n\r\n**å·¥ä½œåŸç†ï¼š**\r\n\r\n![image-20230426215740384](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426215740384.png)\r\n\r\n> å®¢æˆ·ç«¯å‘é€è¯·æ±‚ç»™ç½‘å…³ï¼Œå¼¯ç®¡ HandlerMapping åˆ¤æ–­æ˜¯å¦è¯·æ±‚æ»¡è¶³æŸä¸ªè·¯ç”±ï¼Œæ»¡è¶³å°±å‘ç»™ç½‘å…³çš„ WebHandlerã€‚è¿™ä¸ª WebHandler å°†è¯·æ±‚äº¤ç»™ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œè¯·æ±‚åˆ°è¾¾ç›®æ ‡æœåŠ¡ä¹‹å‰ï¼Œä¼šæ‰§è¡Œæ‰€æœ‰è¿‡æ»¤å™¨çš„ pre æ–¹æ³•ã€‚è¯·æ±‚åˆ°è¾¾ç›®æ ‡æœåŠ¡å¤„ç†ä¹‹åå†ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰è¿‡æ»¤å™¨çš„ post æ–¹æ³•\r\n>\r\n> ä¸€å¥è¯ï¼š**æ»¡è¶³æŸäº›æ–­è¨€ï¼ˆpredicatesï¼‰å°±è·¯ç”±åˆ°æŒ‡å®šçš„åœ°å€ï¼ˆuriï¼‰ï¼Œä½¿ç”¨æŒ‡å®šçš„è¿‡æ»¤å™¨ï¼ˆfilterï¼‰**\r\n\r\n\r\n\r\n### 3ã€ä½¿ç”¨\r\n\r\n#### 1ã€HelloWorld\r\n\r\n- 1ã€åˆ›å»ºç½‘å…³é¡¹ç›®ï¼Œå¼•å…¥ç½‘å…³\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>org.springframework.cloud</groupId>\r\n    <artifactId>spring-cloud-starter-gateway</artifactId>\r\n</dependency>\r\n```\r\n\r\n- 2ã€ç¼–å†™ç½‘å…³é…ç½®æ–‡ä»¶\r\n\r\n```yaml\r\nspring:\r\n    cloud:\r\n        gateway:\r\n            routes:\r\n                id: add_request_parameter_route\r\n                uri: https://example.org\r\n                predicates:\r\n                Query=baz\r\n                filters:\r\n                AddRequestParameter=foo, bar\r\n```\r\n\r\n- 3ã€æ³¨æ„\r\n  - å„ç§ Predicates åŒæ—¶å­˜åœ¨äºåŒä¸€ä¸ªè·¯ç”±æ—¶ï¼Œè¯·æ±‚å¿…é¡»åŒæ—¶æ»¡è¶³æ‰€æœ‰çš„æ¡ä»¶æ‰è¢«è¿™ä¸ªè·¯ç”±åŒ¹é…ã€‚\r\n  - ä¸€ä¸ªè¯·æ±‚æ»¡è¶³å¤šä¸ªè·¯ç”±çš„è°“è¯æ¡ä»¶æ—¶ï¼Œè¯·æ±‚åªä¼šè¢«é¦–ä¸ªæˆåŠŸåŒ¹é…çš„è·¯ç”±è½¬å‘\r\n- 4ã€æµ‹è¯•\r\n  - å¯ä»¥ä½¿ç”¨ postman è¿›è¡Œæµ‹è¯•ç½‘å…³çš„è·¯ç”±åŠŸèƒ½\r\n\r\n\r\n\r\n#### 2ã€æ–­è¨€ï¼ˆPredicatesï¼‰\r\n\r\n![image-20230426220240928](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426220240928.png)\r\n\r\n\r\n\r\n#### 3ã€è¿‡æ»¤å™¨ï¼ˆfiltersï¼‰\r\n\r\n- 1ã€GatewayFilter\r\n\r\n![image-20230426220419538](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426220419538.png)\r\n\r\n\r\n\r\n- 2ã€GlobalFilter\r\n\r\n![image-20230426220449447](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426220449447.png)\r\n\r\n\r\n\r\n## 3ã€Sleuth+Zipkin æœåŠ¡é“¾è·¯è¿½è¸ª\r\n\r\n### 1ã€ä¸ºä»€ä¹ˆç”¨\r\n\r\n- å¾®æœåŠ¡æ¶æ„æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ¶æ„ï¼Œå®ƒæŒ‰ä¸šåŠ¡åˆ’åˆ†æœåŠ¡å•å…ƒï¼Œä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¾€å¾€æœ‰å¾ˆå¤šä¸ªæœåŠ¡å•å…ƒã€‚ç”±äºæœåŠ¡å•å…ƒæ•°é‡ä¼—å¤šï¼Œä¸šåŠ¡çš„å¤æ‚æ€§ï¼Œå¦‚æœå‡ºç°äº†é”™è¯¯å’Œå¼‚å¸¸ï¼Œå¾ˆéš¾å»å®šä½ã€‚ä¸»è¦ä½“ç°åœ¨ï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½éœ€è¦è°ƒç”¨å¾ˆå¤šä¸ªæœåŠ¡ï¼Œè€Œå†…éƒ¨æœåŠ¡çš„è°ƒç”¨å¤æ‚æ€§ï¼Œå†³å®šäº†é—®é¢˜éš¾ä»¥å®šä½ã€‚æ‰€ä»¥å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¿…é¡»å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼Œå»è·Ÿè¿›ä¸€ä¸ªè¯·æ±‚åˆ°åº•æœ‰å“ªäº›æœåŠ¡å‚ä¸ï¼Œå‚ä¸çš„é¡ºåºåˆæ˜¯æ€æ ·çš„ï¼Œä»è€Œè¾¾åˆ°æ¯ä¸ªè¯·æ±‚çš„æ­¥éª¤æ¸…æ™°å¯è§ï¼Œå‡ºäº†é—®é¢˜ï¼Œå¾ˆå¿«å®šä½ã€‚\r\n\r\n- é“¾è·¯è¿½è¸ªç»„ä»¶æœ‰ Google çš„ Dapperï¼ŒTwitter çš„ Zipkinï¼Œä»¥åŠé˜¿é‡Œçš„ Eagleeye ï¼ˆé¹°çœ¼ï¼‰ç­‰ï¼Œå®ƒä»¬éƒ½æ˜¯éå¸¸ä¼˜ç§€çš„é“¾è·¯è¿½è¸ªå¼€æºç»„ä»¶ã€‚\r\n\r\n\r\n\r\n### 2ã€åŸºæœ¬æœ¯è¯­\r\n\r\n- Spanï¼ˆè·¨åº¦ï¼‰ï¼šåŸºæœ¬å·¥ä½œå•å…ƒï¼Œå‘é€ä¸€ä¸ªè¿œç¨‹è°ƒåº¦ä»»åŠ¡ å°±ä¼šäº§ç”Ÿä¸€ä¸ª Spanï¼ŒSpan æ˜¯ä¸€ä¸ª 64 ä½ ID å”¯ä¸€æ ‡è¯†çš„ï¼ŒTrace æ˜¯ç”¨å¦ä¸€ä¸ª 64 ä½ ID å”¯ä¸€æ ‡è¯†çš„ï¼ŒSpan è¿˜æœ‰å…¶ä»–æ•°æ®ä¿¡æ¯ï¼Œæ¯”å¦‚æ‘˜è¦ã€æ—¶é—´æˆ³äº‹ä»¶ã€Span çš„ IDã€ä»¥åŠè¿›åº¦ IDã€‚\r\n- Traceï¼ˆè·Ÿè¸ªï¼‰ï¼šä¸€ç³»åˆ— Span ç»„æˆçš„ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ã€‚è¯·æ±‚ä¸€ä¸ªå¾®æœåŠ¡ç³»ç»Ÿçš„ API æ¥å£ï¼Œè¿™ä¸ª API æ¥å£ï¼Œéœ€è¦è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡ï¼Œè°ƒç”¨æ¯ä¸ªå¾®æœåŠ¡éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ Spanï¼Œæ‰€æœ‰ç”±è¿™ä¸ªè¯·æ±‚äº§ç”Ÿçš„ Span ç»„æˆäº†è¿™ä¸ª Traceã€‚\r\n- Annotationï¼ˆæ ‡æ³¨ï¼‰ï¼šç”¨æ¥åŠæ—¶è®°å½•ä¸€ä¸ªäº‹ä»¶çš„ï¼Œä¸€äº›æ ¸å¿ƒæ³¨è§£ç”¨æ¥å®šä¹‰ä¸€ä¸ªè¯·æ±‚çš„å¼€\r\n- å§‹å’Œç»“æŸ ã€‚è¿™äº›æ³¨è§£åŒ…æ‹¬ä»¥ä¸‹ï¼š\r\n  - cs - Client Sent -å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè¿™ä¸ªæ³¨è§£æè¿°äº†è¿™ä¸ª Span çš„å¼€å§‹\r\n  - sr - Server Received -æœåŠ¡ç«¯è·å¾—è¯·æ±‚å¹¶å‡†å¤‡å¼€å§‹å¤„ç†å®ƒï¼Œå¦‚æœå°†å…¶ sr å‡å» cs æ—¶é—´æˆ³ä¾¿å¯å¾—åˆ°ç½‘ç»œä¼ è¾“çš„æ—¶é—´ã€‚\r\n  - ss - Server Sent ï¼ˆæœåŠ¡ç«¯å‘é€å“åº”ï¼‰â€“è¯¥æ³¨è§£è¡¨æ˜è¯·æ±‚å¤„ç†çš„å®Œæˆ(å½“è¯·æ±‚è¿”å›å®¢æˆ·ç«¯)ï¼Œå¦‚æœ ss çš„æ—¶é—´æˆ³å‡å» sr æ—¶é—´æˆ³ï¼Œå°±å¯ä»¥å¾—åˆ°æœåŠ¡å™¨è¯·æ±‚çš„æ—¶é—´ã€‚\r\n  - cr - Client Received ï¼ˆå®¢æˆ·ç«¯æ¥æ”¶å“åº”ï¼‰-æ­¤æ—¶ Span çš„ç»“æŸï¼Œå¦‚æœ cr çš„æ—¶é—´æˆ³å‡å»cs æ—¶é—´æˆ³ä¾¿å¯ä»¥å¾—åˆ°æ•´ä¸ªè¯·æ±‚æ‰€æ¶ˆè€—çš„æ—¶é—´ã€‚\r\n\r\n- å®˜æ–¹æ–‡æ¡£ï¼š\r\n\r\nhttps://cloud.spring.io/spring-cloud-static/spring-cloud-sleuth/2.1.3.RELEASE/single/spring-cloud-sleuth.html\r\n\r\n- å¦‚æœæœåŠ¡è°ƒç”¨é¡ºåºå¦‚ä¸‹\r\n\r\n![image-20230426221503561](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426221503561.png)\r\n\r\n- é‚£ä¹ˆç”¨ä»¥ä¸Šæ¦‚å¿µå®Œæ•´çš„è¡¨ç¤ºå‡ºæ¥å¦‚ä¸‹ï¼š\r\n\r\n![image-20230426221545654](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426221545654.png)\r\n\r\n- Span ä¹‹é—´çš„çˆ¶å­å…³ç³»å¦‚ä¸‹ï¼š\r\n\r\n![image-20230426221605154](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426221605154.png)\r\n\r\n\r\n\r\n\r\n\r\n### 3ã€æ•´åˆ Sleuth\r\n\r\n- 1ã€æœåŠ¡æä¾›è€…ä¸æ¶ˆè´¹è€…å¯¼å…¥ä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>org.springframework.cloud</groupId>\r\n    <artifactId>spring-cloud-starter-sleuth</artifactId>\r\n</dependency>\r\n```\r\n\r\n- 2ã€æ‰“å¼€ debug æ—¥å¿—\r\n\r\n```yaml\r\nlogging:\r\n    level:\r\n        org.springframework.cloud.openfeign: debug\r\n        org.springframework.cloud.sleuth: debug\r\n```\r\n\r\n- 3ã€å‘èµ·ä¸€æ¬¡è¿œç¨‹è°ƒç”¨ï¼Œè§‚å¯Ÿæ§åˆ¶å°\r\n  - DEBUG [user-service,541450f08573fff5,541450f08573fff5,false]\r\n  - user-serviceï¼šæœåŠ¡å\r\n  - 541450f08573fff5ï¼šæ˜¯ TranceIdï¼Œä¸€æ¡é“¾è·¯ä¸­ï¼Œåªæœ‰ä¸€ä¸ª TranceId\r\n  - 541450f08573fff5ï¼šæ˜¯ spanIdï¼Œé“¾è·¯ä¸­çš„åŸºæœ¬å·¥ä½œå•å…ƒ id\r\n  - falseï¼šè¡¨ç¤ºæ˜¯å¦å°†æ•°æ®è¾“å‡ºåˆ°å…¶ä»–æœåŠ¡ï¼Œtrue åˆ™ä¼šæŠŠä¿¡æ¯è¾“å‡ºåˆ°å…¶ä»–å¯è§†åŒ–çš„æœåŠ¡ä¸Šè§‚å¯Ÿ\r\n\r\n\r\n\r\n### 4ã€æ•´åˆ zipkin å¯è§†åŒ–è§‚å¯Ÿ\r\n\r\n- é€šè¿‡ Sleuth äº§ç”Ÿçš„è°ƒç”¨é“¾ç›‘æ§ä¿¡æ¯ï¼Œå¯ä»¥å¾—çŸ¥å¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨é“¾è·¯ï¼Œä½†ç›‘æ§ä¿¡æ¯åªè¾“å‡ºåˆ°æ§åˆ¶å°ä¸æ–¹ä¾¿æŸ¥çœ‹ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå›¾å½¢åŒ–çš„å·¥å…·-zipkinã€‚Zipkin æ˜¯ Twitter å¼€æºçš„åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿï¼Œä¸»è¦ç”¨æ¥æ”¶é›†ç³»ç»Ÿçš„æ—¶åºæ•°æ®ï¼Œä»è€Œè¿½è¸ªç³»ç»Ÿçš„è°ƒç”¨é—®é¢˜ã€‚zipkin å®˜ç½‘åœ°å€å¦‚ä¸‹ï¼š\r\n\r\nhttps://zipkin.io/\r\n\r\n![image-20230426222010516](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426222010516.png)\r\n\r\n- 1ã€docker å®‰è£… zipkin æœåŠ¡å™¨\r\n\r\n`docker run -d -p 9411:9411 openzipkin/zipkin`\r\n\r\n- 2ã€å¯¼å…¥\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>org.springframework.cloud</groupId>\r\n    <artifactId>spring-cloud-starter-zipkin</artifactId>\r\n</dependency>\r\n```\r\n\r\n> zipkin ä¾èµ–ä¹ŸåŒæ—¶åŒ…å«äº† sleuthï¼Œå¯ä»¥çœç•¥ sleuth çš„å¼•ç”¨\r\n\r\n- 3ã€æ·»åŠ  zipkin ç›¸å…³é…ç½®\r\n\r\n```yaml\r\nspring:\r\n    application:\r\n  \t  name: user-service\r\n    zipkin:\r\n        base-url: http://192.168.56.10:9411/ # zipkin æœåŠ¡å™¨çš„åœ°å€\r\n        # å…³é—­æœåŠ¡å‘ç°ï¼Œå¦åˆ™ Spring Cloud ä¼šæŠŠ zipkin çš„ url å½“åšæœåŠ¡åç§°\r\n        discoveryClientEnabled: false\r\n        sender:\r\n        \ttype: web # è®¾ç½®ä½¿ç”¨ http çš„æ–¹å¼ä¼ è¾“æ•°æ®\r\n    sleuth:\r\n    \tsampler:\r\n   \t \t\tprobability: 1 # è®¾ç½®æŠ½æ ·é‡‡é›†ç‡ä¸º 100%ï¼Œé»˜è®¤ä¸º 0.1ï¼Œå³ 10%\r\n```\r\n\r\n> å‘é€è¿œç¨‹è¯·æ±‚ï¼Œæµ‹è¯• zipkinã€‚\r\n\r\n- æœåŠ¡è°ƒç”¨é“¾è¿½è¸ªä¿¡æ¯ç»Ÿè®¡\r\n\r\n![image-20230426222654484](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426222654484.png)\r\n\r\n- æœåŠ¡ä¾èµ–ä¿¡æ¯ç»Ÿè®¡\r\n\r\n![image-20230426222740970](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426222740970.png)\r\n\r\n\r\n\r\n### 5ã€Zipkin æ•°æ®æŒä¹…åŒ–\r\n\r\n- Zipkin é»˜è®¤æ˜¯å°†ç›‘æ§æ•°æ®å­˜å‚¨åœ¨å†…å­˜çš„ï¼Œå¦‚æœ Zipkin æŒ‚æ‰æˆ–é‡å¯çš„è¯ï¼Œé‚£ä¹ˆç›‘æ§æ•°æ®å°±ä¼šä¸¢å¤±ã€‚æ‰€ä»¥å¦‚æœæƒ³è¦æ­å»ºç”Ÿäº§å¯ç”¨çš„ Zipkinï¼Œå°±éœ€è¦å®ç°ç›‘æ§æ•°æ®çš„æŒä¹…åŒ–ã€‚è€Œæƒ³è¦å®ç°æ•°æ®æŒä¹…åŒ–ï¼Œè‡ªç„¶å°±æ˜¯å¾—å°†æ•°æ®å­˜å‚¨è‡³æ•°æ®åº“ã€‚å¥½åœ¨ Zipkin æ”¯æŒå°†æ•°æ®å­˜å‚¨è‡³ï¼š\r\n  - å†…å­˜ï¼ˆé»˜è®¤ï¼‰\r\n  - MySQL\r\n  - Elasticsearch\r\n  - Cassandra\r\n- Zipkin æ•°æ®æŒä¹…åŒ–ç›¸å…³çš„å®˜æ–¹æ–‡æ¡£åœ°å€å¦‚ä¸‹ï¼š\r\n\r\nhttps://github.com/openzipkin/zipkin#storage-component\r\n\r\n\r\n\r\n- Zipkin æ”¯æŒçš„è¿™å‡ ç§å­˜å‚¨æ–¹å¼ä¸­ï¼Œå†…å­˜æ˜¾ç„¶æ˜¯ä¸é€‚ç”¨äºç”Ÿäº§çš„ï¼Œè¿™ä¸€ç‚¹å¼€å§‹ä¹Ÿè¯´äº†ã€‚è€Œä½¿ç”¨MySQL çš„è¯ï¼Œå½“æ•°æ®é‡å¤§æ—¶ï¼ŒæŸ¥è¯¢è¾ƒä¸ºç¼“æ…¢ï¼Œä¹Ÿä¸å»ºè®®ä½¿ç”¨ã€‚Twitter å®˜æ–¹ä½¿ç”¨çš„æ˜¯ Cassandraä½œä¸º Zipkin çš„å­˜å‚¨æ•°æ®åº“ï¼Œä½†å›½å†…å¤§è§„æ¨¡ç”¨ Cassandra çš„å…¬å¸è¾ƒå°‘ï¼Œè€Œä¸” Cassandra ç›¸å…³æ–‡æ¡£ä¹Ÿä¸å¤šã€‚\r\n\r\n- ç»¼ä¸Šï¼Œæ•…é‡‡ç”¨ Elasticsearch æ˜¯ä¸ªæ¯”è¾ƒå¥½çš„é€‰æ‹©ï¼Œå…³äºä½¿ç”¨ Elasticsearch ä½œä¸º Zipkin çš„å­˜å‚¨æ•°æ®åº“çš„å®˜æ–¹æ–‡æ¡£å¦‚ä¸‹ï¼š\r\n\r\n  - elasticsearch-storageï¼š\r\n\r\n    https://github.com/openzipkin/zipkin/tree/master/zipkin-server#elasticsearch-storage\r\n\r\n  - zipkin-storage/elasticsearch\r\n\r\n    https://github.com/openzipkin/zipkin/tree/master/zipkin-storage/elasticsearch\r\n\r\n- é€šè¿‡ docker çš„æ–¹å¼\r\n\r\n- `docker run --env STORAGE_TYPE=elasticsearch --env ES_HOSTS=192.168.56.10:9200 openzipkin/zipkin-dependencies`\r\n\r\n![image-20230426224650512](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426224650512.png)\r\n\r\n- ä½¿ç”¨ es æ—¶ Zipkin Dependencies æ”¯æŒçš„ç¯å¢ƒå˜é‡\r\n\r\n![image-20230426223556598](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230426223556598.png)"},{"title":"ç³»ç»Ÿæ¥å£","tags":["Spring Boot","Spring Cloud","gateway","Swagger2","Knife4j"],"categories":["Java","æœªåˆ†ç±»"],"author":"imklaus","excerpt":"\r\n\r\n## åŸºæœ¬ä»‹ç»\r\n\r\n[å‚è€ƒç³»ç»Ÿæ¥å£å®ç°](https://doc.ruoyi.vip/ruoyi/document/htsc.html#ç³»ç»Ÿæ¥å£)\r\n\r\nåœ¨ç°åœ¨çš„å¼€å‘è¿‡ç¨‹ä¸­è¿˜æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†å…¬å¸éƒ½æ˜¯ä»¥å£å£ç›¸ä¼ çš„æ–¹å¼æ¥è¿›è¡Œå‰åç«¯çš„è”è°ƒï¼Œè€Œæ¥å£æ–‡æ¡£å¾ˆå¤§ä¸€éƒ¨åˆ†éƒ½åªåœç•™åœ¨äº†è¯´è¯´è€Œå·²çš„åœ°æ­¥ï¼Œæˆ–è€…å†™äº†ä»£ç å†å†™æ–‡æ¡£ã€‚ è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯æ–‡æ¡£çš„ä¿®æ”¹ï¼Œå®šä¹‰å¥½çš„æ¥å£å¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œå¯èƒ½åœ¨å¼€å‘è¿‡ç¨‹ä¸­æ–‡æ¡£ä¿®æ”¹ä¸æ­¢ä¸€æ¬¡çš„å˜åŒ–ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå¾ˆéš¾å—äº†ã€‚ åªè¦ä¸æ˜¯å¼ºåˆ¶æ€§è¦æ±‚ï¼Œæ²¡äººä¼šæ„¿æ„å†™è¿™ä¸œè¥¿ï¼Œè€Œä¸”åœ¨å†™çš„è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªå­—æ¯çš„é”™è¯¯å°±ä¼šå¯¼è‡´è”è°ƒæ—¶å€™çš„å¾ˆå¤§éº»çƒ¦ï¼Œä½†æ˜¯é€šè¿‡`Swagger`ï¼Œæˆ‘ä»¬å¯ä»¥çœç•¥äº†è¿™ä¸€æ­¥ï¼Œè€Œä¸”æ–‡æ¡£å‡ºé”™ç‡è¿‘ä¹äºé›¶ï¼Œ åªè¦ä½ åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œç¨åŠ å‡ ä¸ªæ³¨è§£ï¼Œæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆã€‚\r\n","link":"/posts/System_interface","content":"\r\n\r\n## åŸºæœ¬ä»‹ç»\r\n\r\n[å‚è€ƒç³»ç»Ÿæ¥å£å®ç°](https://doc.ruoyi.vip/ruoyi/document/htsc.html#ç³»ç»Ÿæ¥å£)\r\n\r\nåœ¨ç°åœ¨çš„å¼€å‘è¿‡ç¨‹ä¸­è¿˜æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†å…¬å¸éƒ½æ˜¯ä»¥å£å£ç›¸ä¼ çš„æ–¹å¼æ¥è¿›è¡Œå‰åç«¯çš„è”è°ƒï¼Œè€Œæ¥å£æ–‡æ¡£å¾ˆå¤§ä¸€éƒ¨åˆ†éƒ½åªåœç•™åœ¨äº†è¯´è¯´è€Œå·²çš„åœ°æ­¥ï¼Œæˆ–è€…å†™äº†ä»£ç å†å†™æ–‡æ¡£ã€‚ è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯æ–‡æ¡£çš„ä¿®æ”¹ï¼Œå®šä¹‰å¥½çš„æ¥å£å¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œå¯èƒ½åœ¨å¼€å‘è¿‡ç¨‹ä¸­æ–‡æ¡£ä¿®æ”¹ä¸æ­¢ä¸€æ¬¡çš„å˜åŒ–ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå¾ˆéš¾å—äº†ã€‚ åªè¦ä¸æ˜¯å¼ºåˆ¶æ€§è¦æ±‚ï¼Œæ²¡äººä¼šæ„¿æ„å†™è¿™ä¸œè¥¿ï¼Œè€Œä¸”åœ¨å†™çš„è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªå­—æ¯çš„é”™è¯¯å°±ä¼šå¯¼è‡´è”è°ƒæ—¶å€™çš„å¾ˆå¤§éº»çƒ¦ï¼Œä½†æ˜¯é€šè¿‡`Swagger`ï¼Œæˆ‘ä»¬å¯ä»¥çœç•¥äº†è¿™ä¸€æ­¥ï¼Œè€Œä¸”æ–‡æ¡£å‡ºé”™ç‡è¿‘ä¹äºé›¶ï¼Œ åªè¦ä½ åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œç¨åŠ å‡ ä¸ªæ³¨è§£ï¼Œæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆã€‚\r\n<!-- more -->\r\n\r\n1ã€åœ¨æ§åˆ¶å±‚`Controller`ä¸­æ·»åŠ æ³¨è§£æ¥æè¿°æ¥å£ä¿¡æ¯å¦‚:\r\n\r\n```java\r\n@Api(\"å‚æ•°é…ç½®\")\r\n@Controller\r\n@RequestMapping(\"/system/config\")\r\npublic class ConfigController\r\n```\r\n\r\n2ã€åœ¨æ–¹æ³•ä¸­é…ç½®æ¥å£çš„æ ‡é¢˜ä¿¡æ¯\r\n\r\n```sql\r\n@ApiOperation(\"æŸ¥è¯¢å‚æ•°åˆ—è¡¨\")\r\n@ResponseBody\r\npublic TableDataInfo list(Config config)\r\n{\r\n\tstartPage();\r\n\tList<Config> list = configService.selectConfigList(config);\r\n\treturn getDataTable(list);\r\n}\r\n```\r\n\r\n3ã€åœ¨`ç³»ç»Ÿå·¥å…·-ç³»ç»Ÿæ¥å£`æµ‹è¯•ç›¸å…³æ¥å£\r\n\r\n```\r\næ³¨æ„ï¼šSwaggerConfigå¯ä»¥æŒ‡å®šæ ¹æ®æ³¨è§£æˆ–è€…åŒ…åæ‰«æå…·ä½“çš„API\r\n```\r\n\r\n#### APIè¯¦ç»†è¯´æ˜\r\n\r\n| ä½œç”¨èŒƒå›´           | API                | ä½¿ç”¨ä½ç½®                         |\r\n| ------------------ | ------------------ | -------------------------------- |\r\n| åè®®é›†æè¿°         | @Api               | ç”¨äºcontrollerç±»ä¸Š               |\r\n| å¯¹è±¡å±æ€§           | @ApiModelProperty  | ç”¨åœ¨å‡ºå…¥å‚æ•°å¯¹è±¡çš„å­—æ®µä¸Š         |\r\n| åè®®æè¿°           | @ApiOperation      | ç”¨åœ¨controllerçš„æ–¹æ³•ä¸Š           |\r\n| Responseé›†         | @ApiResponses      | ç”¨åœ¨controllerçš„æ–¹æ³•ä¸Š           |\r\n| Response           | @ApiResponse       | ç”¨åœ¨ @ApiResponsesé‡Œè¾¹           |\r\n| éå¯¹è±¡å‚æ•°é›†       | @ApiImplicitParams | ç”¨åœ¨controllerçš„æ–¹æ³•ä¸Š           |\r\n| éå¯¹è±¡å‚æ•°æè¿°     | @ApiImplicitParam  | ç”¨åœ¨@ApiImplicitParamsçš„æ–¹æ³•é‡Œè¾¹ |\r\n| æè¿°è¿”å›å¯¹è±¡çš„æ„ä¹‰ | @ApiModel          | ç”¨åœ¨è¿”å›å¯¹è±¡ç±»ä¸Š                 |\r\n\r\n`api`æ ‡è®°ï¼Œç”¨åœ¨ç±»ä¸Šï¼Œè¯´æ˜è¯¥ç±»çš„ä½œç”¨ã€‚å¯ä»¥æ ‡è®°ä¸€ä¸ª`Controller`ç±»åšä¸º`Swagger`æ–‡æ¡£èµ„æºï¼Œä½¿ç”¨æ–¹å¼ï¼š\r\n\r\n```java\r\n@Api(value = \"/user\", description = \"ç”¨æˆ·ç®¡ç†\")\r\n```\r\n\r\nä¸`Controller`æ³¨è§£å¹¶åˆ—ä½¿ç”¨ã€‚ å±æ€§é…ç½®ï¼š\r\n\r\n| å±æ€§åç§°       | å¤‡æ³¨                                             |\r\n| -------------- | ------------------------------------------------ |\r\n| value          | urlçš„è·¯å¾„å€¼                                      |\r\n| tags           | å¦‚æœè®¾ç½®è¿™ä¸ªå€¼ã€valueçš„å€¼ä¼šè¢«è¦†ç›–                |\r\n| description    | å¯¹apièµ„æºçš„æè¿°                                  |\r\n| basePath       | åŸºæœ¬è·¯å¾„å¯ä»¥ä¸é…ç½®                               |\r\n| position       | å¦‚æœé…ç½®å¤šä¸ªApi æƒ³æ”¹å˜æ˜¾ç¤ºçš„é¡ºåºä½ç½®             |\r\n| produces       | For example, \"application/json, application/xml\" |\r\n| consumes       | For example, \"application/json, application/xml\" |\r\n| protocols      | Possible values: http, https, ws, wss.           |\r\n| authorizations | é«˜çº§ç‰¹æ€§è®¤è¯æ—¶é…ç½®                               |\r\n| hidden         | é…ç½®ä¸ºtrue å°†åœ¨æ–‡æ¡£ä¸­éšè—                        |\r\n\r\n`ApiOperation`æ ‡è®°ï¼Œç”¨åœ¨æ–¹æ³•ä¸Šï¼Œè¯´æ˜æ–¹æ³•çš„ä½œç”¨ï¼Œæ¯ä¸€ä¸ª`url`èµ„æºçš„å®šä¹‰,ä½¿ç”¨æ–¹å¼ï¼š\r\n\r\n```java\r\n@ApiOperation(\"è·å–ç”¨æˆ·ä¿¡æ¯\")\r\n```\r\n\r\nä¸`Controller`ä¸­çš„æ–¹æ³•å¹¶åˆ—ä½¿ç”¨ï¼Œå±æ€§é…ç½®ï¼š\r\n\r\n| å±æ€§åç§°          | å¤‡æ³¨                                                         |\r\n| ----------------- | ------------------------------------------------------------ |\r\n| value             | urlçš„è·¯å¾„å€¼                                                  |\r\n| tags              | å¦‚æœè®¾ç½®è¿™ä¸ªå€¼ã€valueçš„å€¼ä¼šè¢«è¦†ç›–                            |\r\n| description       | å¯¹apièµ„æºçš„æè¿°                                              |\r\n| basePath          | åŸºæœ¬è·¯å¾„å¯ä»¥ä¸é…ç½®                                           |\r\n| position          | å¦‚æœé…ç½®å¤šä¸ªApi æƒ³æ”¹å˜æ˜¾ç¤ºçš„é¡ºåºä½ç½®                         |\r\n| produces          | For example, \"application/json, application/xml\"             |\r\n| consumes          | For example, \"application/json, application/xml\"             |\r\n| protocols         | Possible values: http, https, ws, wss.                       |\r\n| authorizations    | é«˜çº§ç‰¹æ€§è®¤è¯æ—¶é…ç½®                                           |\r\n| hidden            | é…ç½®ä¸ºtrueå°†åœ¨æ–‡æ¡£ä¸­éšè—                                     |\r\n| response          | è¿”å›çš„å¯¹è±¡                                                   |\r\n| responseContainer | è¿™äº›å¯¹è±¡æ˜¯æœ‰æ•ˆçš„ \"List\", \"Set\" or \"Map\".ï¼Œå…¶ä»–æ— æ•ˆ           |\r\n| httpMethod        | \"GET\", \"HEAD\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\" and \"PATCH\" |\r\n| code              | httpçš„çŠ¶æ€ç  é»˜è®¤ 200                                        |\r\n| extensions        | æ‰©å±•å±æ€§                                                     |\r\n\r\n`ApiParam`æ ‡è®°ï¼Œè¯·æ±‚å±æ€§ï¼Œä½¿ç”¨æ–¹å¼ï¼š\r\n\r\n```java\r\npublic TableDataInfo list(@ApiParam(value = \"æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨\", required = true)User user)\r\n```\r\n\r\nä¸Controllerä¸­çš„æ–¹æ³•å¹¶åˆ—ä½¿ç”¨ï¼Œå±æ€§é…ç½®ï¼š\r\n\r\n| å±æ€§åç§°        | å¤‡æ³¨         |\r\n| --------------- | ------------ |\r\n| name            | å±æ€§åç§°     |\r\n| value           | å±æ€§å€¼       |\r\n| defaultValue    | é»˜è®¤å±æ€§å€¼   |\r\n| allowableValues | å¯ä»¥ä¸é…ç½®   |\r\n| required        | æ˜¯å¦å±æ€§å¿…å¡« |\r\n| access          | ä¸è¿‡å¤šæè¿°   |\r\n| allowMultiple   | é»˜è®¤ä¸ºfalse  |\r\n| hidden          | éšè—è¯¥å±æ€§   |\r\n| example         | ä¸¾ä¾‹å­       |\r\n\r\n`piResponse`æ ‡è®°ï¼Œå“åº”é…ç½®ï¼Œä½¿ç”¨æ–¹å¼ï¼š\r\n\r\n```java\r\n@ApiResponse(code = 400, message = \"æŸ¥è¯¢ç”¨æˆ·å¤±è´¥\")\r\n```\r\n\r\nä¸`Controller`ä¸­çš„æ–¹æ³•å¹¶åˆ—ä½¿ç”¨ï¼Œå±æ€§é…ç½®ï¼š\r\n\r\n| å±æ€§åç§°          | å¤‡æ³¨                             |\r\n| ----------------- | -------------------------------- |\r\n| code              | httpçš„çŠ¶æ€ç                      |\r\n| message           | æè¿°                             |\r\n| response          | é»˜è®¤å“åº”ç±» Void                  |\r\n| reference         | å‚è€ƒApiOperationä¸­é…ç½®           |\r\n| responseHeaders   | å‚è€ƒ ResponseHeader å±æ€§é…ç½®è¯´æ˜ |\r\n| responseContainer | å‚è€ƒApiOperationä¸­é…ç½®           |\r\n\r\n`ApiResponses`æ ‡è®°ï¼Œå“åº”é›†é…ç½®ï¼Œä½¿ç”¨æ–¹å¼:\r\n\r\n```java\r\n@ApiResponses({ @ApiResponse(code = 400, message = \"æ— æ•ˆçš„ç”¨æˆ·\") })\r\n```\r\n\r\nä¸`Controller`ä¸­çš„æ–¹æ³•å¹¶åˆ—ä½¿ç”¨ï¼Œå±æ€§é…ç½®ï¼š\r\n\r\n| å±æ€§åç§° | å¤‡æ³¨                |\r\n| -------- | ------------------- |\r\n| value    | å¤šä¸ªApiResponseé…ç½® |\r\n\r\n`ResponseHeader`æ ‡è®°ï¼Œå“åº”å¤´è®¾ç½®ï¼Œä½¿ç”¨æ–¹æ³•\r\n\r\n```java\r\n@ResponseHeader(name=\"head\",description=\"å“åº”å¤´è®¾è®¡\")\r\n```\r\n\r\nä¸`Controller`ä¸­çš„æ–¹æ³•å¹¶åˆ—ä½¿ç”¨ï¼Œå±æ€§é…ç½®ï¼š\r\n\r\n| å±æ€§åç§°          | å¤‡æ³¨                   |\r\n| ----------------- | ---------------------- |\r\n| name              | å“åº”å¤´åç§°             |\r\n| description       | æè¿°                   |\r\n| response          | é»˜è®¤å“åº”ç±» void        |\r\n| responseContainer | å‚è€ƒApiOperationä¸­é…ç½® |\r\n\r\n\r\n\r\n## å¦‚ä½•ä½¿ç”¨\r\n\r\n1ã€æ·»åŠ ä¾èµ–\r\n\r\n```xml\r\n<!-- SpringBoot Web -->\r\n<dependency>\r\n\t<groupId>org.springframework.boot</groupId>\r\n\t<artifactId>spring-boot-starter-web</artifactId>\r\n</dependency>\r\n\r\n<!-- Swagger -->\r\n<dependency>\r\n\t<groupId>io.springfox</groupId>\r\n\t<artifactId>springfox-swagger2</artifactId>\r\n\t<version>${swagger.fox.version}</version>\r\n</dependency>\r\n\r\n<!-- Swagger UI -->\r\n<dependency>\r\n\t<groupId>io.springfox</groupId>\r\n\t<artifactId>springfox-swagger-ui</artifactId>\r\n\t<version>${swagger.fox.version}</version>\r\n</dependency>\r\n```\r\n\r\n2ã€åœ¨`application.yml`æ·»åŠ æœåŠ¡é…ç½®\r\n\r\n```yml\r\nserver:\r\n  port: 6666\r\n\r\nspring:\r\n  application:\r\n    name: ruoyi-xxxx\r\n```\r\n\r\n3ã€åœ¨`Application`å¯åŠ¨ç±»åŠ å…¥æ³¨è§£`@SpringBootApplication`ã€‚\r\n\r\n```java\r\n@EnableSwagger2\r\n@SpringBootApplication\r\npublic class RuoYiSwaggerApplication\r\n{\r\n    public static void main(String[] args)\r\n    {\r\n        SpringApplication.run(RuoYiSwaggerApplication.class, args);\r\n        System.out.println(\"(â™¥â— â€¿â— )ï¾‰ï¾  Swaggerå¯åŠ¨æˆåŠŸ   áƒš(Â´Ú¡`áƒš)ï¾  \\n\" +\r\n                \" .-------.       ____     __        \\n\" +\r\n                \" |  _ _   \\\\      \\\\   \\\\   /  /    \\n\" +\r\n                \" | ( ' )  |       \\\\  _. /  '       \\n\" +\r\n                \" |(_ o _) /        _( )_ .'         \\n\" +\r\n                \" | (_,_).' __  ___(_ o _)'          \\n\" +\r\n                \" |  |\\\\ \\\\  |  ||   |(_,_)'         \\n\" +\r\n                \" |  | \\\\ `'   /|   `-'  /           \\n\" +\r\n                \" |  |  \\\\    /  \\\\      /           \\n\" +\r\n                \" ''-'   `'-'    `-..-'              \");\r\n    }\r\n}\r\n```\r\n\r\n4ã€æ·»åŠ `TestUserController.java`ï¼Œæ¨¡æ‹Ÿæ¥å£è¿”å›ç”¨æˆ·ä¿¡æ¯ã€‚\r\n\r\n```java\r\nimport org.springframework.web.bind.annotation.GetMapping;\r\nimport org.springframework.web.bind.annotation.RestController;\r\n\r\n@RestController\r\npublic class TestUserController\r\n{\r\n    @GetMapping(\"/user/info\")\r\n    public Object info()\r\n    {\r\n        return \"{\\\"username\\\":\\\"admin\\\",\\\"password\\\":\\\"admin123\\\"}\";\r\n    }\r\n}\r\n```\r\n\r\n5ã€è®¿é—®`http://localhost:6666/swagger-ui/index.html`ï¼Œæµ‹è¯•éªŒè¯æ¥å£è¿”å›æ­£ç¡®æ•°æ®è¡¨ç¤ºæµ‹è¯•é€šè¿‡ã€‚\r\n\r\n## æ¥å£æ¨¡å—\r\n\r\né¡¹ç›®ä¸­å­˜åœ¨`common-swagger`æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥ä¾èµ–åä½¿ç”¨ã€‚\r\n\r\n- `common-swagger`æ¨¡å—ï¼š`gulimall-swagger-spring-boot-starter`\r\n\r\n  - å¼•å…¥ä¾èµ–\r\n\r\n  ```xml\r\n  <!-- SpringBoot Web -->\r\n  <dependency>\r\n      <groupId>org.springframework.boot</groupId>\r\n      <artifactId>spring-boot-starter-web</artifactId>\r\n  </dependency>\r\n  \r\n  <!-- Swagger -->\r\n  <dependency>\r\n      <groupId>io.springfox</groupId>\r\n      <artifactId>springfox-swagger2</artifactId>\r\n      <version>${swagger.fox.version}</version>\r\n  </dependency>\r\n  ```\r\n\r\n  - è‡ªå®šä¹‰Swaggeræ³¨è§£\r\n\r\n  ```java\r\n  @Target({ ElementType.TYPE })\r\n  @Retention(RetentionPolicy.RUNTIME)\r\n  @Documented\r\n  @Inherited\r\n  @Import({ SwaggerAutoConfiguration.class })\r\n  public @interface EnableCustomSwagger2\r\n  {\r\n  \r\n  }\r\n  ```\r\n\r\n  - Swaggerç›¸å…³å±æ€§\r\n\r\n  ```java\r\n  /**\r\n   * Swagger é…ç½®\r\n   */\r\n  @Data\r\n  @ConfigurationProperties(\"swagger\")\r\n  public class SwaggerProperties\r\n  {\r\n      /**\r\n       * æ˜¯å¦å¼€å¯swagger\r\n       */\r\n      private Boolean enabled;\r\n  \r\n      /**\r\n       * swaggerä¼šè§£æçš„åŒ…è·¯å¾„\r\n       **/\r\n      private String basePackage = \"\";\r\n  \r\n      /**\r\n       * swaggerä¼šè§£æçš„urlè§„åˆ™\r\n       **/\r\n      private List<String> basePath = new ArrayList<>();\r\n  \r\n      /**\r\n       * åœ¨basePathåŸºç¡€ä¸Šéœ€è¦æ’é™¤çš„urlè§„åˆ™\r\n       **/\r\n      private List<String> excludePath = new ArrayList<>();\r\n  \r\n      /**\r\n       * æ ‡é¢˜\r\n       **/\r\n      private String title = \"\";\r\n  \r\n      /**\r\n       * æè¿°\r\n       **/\r\n      private String description = \"\";\r\n  \r\n      /**\r\n       * ç‰ˆæœ¬\r\n       **/\r\n      private String version = \"\";\r\n  \r\n      /**\r\n       * è®¸å¯è¯\r\n       **/\r\n      private String license = \"\";\r\n  \r\n      /**\r\n       * è®¸å¯è¯URL\r\n       **/\r\n      private String licenseUrl = \"\";\r\n  \r\n      /**\r\n       * æœåŠ¡æ¡æ¬¾URL\r\n       **/\r\n      private String termsOfServiceUrl = \"\";\r\n  \r\n      /**\r\n       * hostä¿¡æ¯\r\n       **/\r\n      private String host = \"\";\r\n  \r\n      /**\r\n       * è”ç³»äººä¿¡æ¯\r\n       */\r\n      private Contact contact = new Contact();\r\n  \r\n      /**\r\n       * å…¨å±€ç»Ÿä¸€é‰´æƒé…ç½®\r\n       **/\r\n      private Authorization authorization = new Authorization();\r\n  \r\n     \r\n  \t@Data\r\n      public static class Contact\r\n      {\r\n          /**\r\n           * è”ç³»äºº\r\n           **/\r\n          private String name = \"\";\r\n          /**\r\n           * è”ç³»äººurl\r\n           **/\r\n          private String url = \"\";\r\n          /**\r\n           * è”ç³»äººemail\r\n           **/\r\n          private String email = \"\";\r\n      }\r\n          \r\n  \t@Data\r\n      public static class Authorization\r\n      {\r\n          /**\r\n           * é‰´æƒç­–ç•¥IDï¼Œéœ€è¦å’ŒSecurityReferences IDä¿æŒä¸€è‡´\r\n           */\r\n          private String name = \"\";\r\n  \r\n          /**\r\n           * éœ€è¦å¼€å¯é‰´æƒURLçš„æ­£åˆ™\r\n           */\r\n          private String authRegex = \"^.*$\";\r\n  \r\n          /**\r\n           * é‰´æƒä½œç”¨åŸŸåˆ—è¡¨\r\n           */\r\n          private List<AuthorizationScope> authorizationScopeList = new ArrayList<>();\r\n  \r\n          private List<String> tokenUrlList = new ArrayList<>();\r\n  \r\n          \r\n      }\r\n  \r\n      @Data\r\n      public static class AuthorizationScope\r\n      {\r\n          /**\r\n           * ä½œç”¨åŸŸåç§°\r\n           */\r\n          private String scope = \"\";\r\n  \r\n          /**\r\n           * ä½œç”¨åŸŸæè¿°\r\n           */\r\n          private String description = \"\";\r\n  \r\n  \r\n      }\r\n  }\r\n  ```\r\n\r\n  - swaggeré…ç½®ç±»\r\n\r\n  ```java\r\n  @Primary\r\n  @Configuration\r\n  @EnableSwagger2\r\n  @EnableConfigurationProperties(SwaggerProperties.class)\r\n  @ConditionalOnProperty(name = \"swagger.enabled\", matchIfMissing = true)\r\n  @Import({SwaggerWebConfiguration.class})\r\n  public class SwaggerAutoConfiguration\r\n  {\r\n      /**\r\n       * é»˜è®¤çš„æ’é™¤è·¯å¾„ï¼Œæ’é™¤Spring Booté»˜è®¤çš„é”™è¯¯å¤„ç†è·¯å¾„å’Œç«¯ç‚¹\r\n       */\r\n      private static final List<String> DEFAULT_EXCLUDE_PATH = Arrays.asList(\"/error\", \"/actuator/**\");\r\n  \r\n      private static final String BASE_PATH = \"/**\";\r\n  \r\n      @Bean\r\n      public Docket api(SwaggerProperties swaggerProperties)\r\n      {\r\n          // base-pathå¤„ç†\r\n          if (swaggerProperties.getBasePath().isEmpty())\r\n          {\r\n              swaggerProperties.getBasePath().add(BASE_PATH);\r\n          }\r\n          // noinspection unchecked\r\n          List<Predicate<String>> basePath = new ArrayList<Predicate<String>>();\r\n          swaggerProperties.getBasePath().forEach(path -> basePath.add(PathSelectors.ant(path)));\r\n  \r\n          // exclude-pathå¤„ç†\r\n          if (swaggerProperties.getExcludePath().isEmpty())\r\n          {\r\n              swaggerProperties.getExcludePath().addAll(DEFAULT_EXCLUDE_PATH);\r\n          }\r\n  \r\n          List<Predicate<String>> excludePath = new ArrayList<>();\r\n          swaggerProperties.getExcludePath().forEach(path -> excludePath.add(PathSelectors.ant(path)));\r\n  \r\n          ApiSelectorBuilder builder = new Docket(DocumentationType.SWAGGER_2).host(swaggerProperties.getHost())\r\n                  .apiInfo(apiInfo(swaggerProperties)).select()\r\n                  .apis(RequestHandlerSelectors.basePackage(swaggerProperties.getBasePackage()));\r\n  \r\n          swaggerProperties.getBasePath().forEach(p -> builder.paths(PathSelectors.ant(p)));\r\n          swaggerProperties.getExcludePath().forEach(p -> builder.paths(PathSelectors.ant(p).negate()));\r\n  \r\n          return builder.build().securitySchemes(securitySchemes()).securityContexts(securityContexts()).pathMapping(\"/\");\r\n      }\r\n  \r\n      /**\r\n       * å®‰å…¨æ¨¡å¼ï¼Œè¿™é‡ŒæŒ‡å®štokené€šè¿‡Authorizationå¤´è¯·æ±‚å¤´ä¼ é€’\r\n       */\r\n      private List<SecurityScheme> securitySchemes()\r\n      {\r\n          List<SecurityScheme> apiKeyList = new ArrayList<SecurityScheme>();\r\n          apiKeyList.add(new ApiKey(\"Authorization\", \"Authorization\", \"header\"));\r\n          return apiKeyList;\r\n      }\r\n  \r\n      /**\r\n       * å®‰å…¨ä¸Šä¸‹æ–‡\r\n       */\r\n      private List<SecurityContext> securityContexts()\r\n      {\r\n          List<SecurityContext> securityContexts = new ArrayList<>();\r\n          securityContexts.add(\r\n                  SecurityContext.builder()\r\n                          .securityReferences(defaultAuth())\r\n                          .operationSelector(o -> o.requestMappingPattern().matches(\"/.*\"))\r\n                          .build());\r\n          return securityContexts;\r\n      }\r\n  \r\n      /**\r\n       * é»˜è®¤çš„å…¨å±€é‰´æƒç­–ç•¥\r\n       *\r\n       * @return\r\n       */\r\n      private List<SecurityReference> defaultAuth()\r\n      {\r\n          AuthorizationScope authorizationScope = new AuthorizationScope(\"global\", \"accessEverything\");\r\n          AuthorizationScope[] authorizationScopes = new AuthorizationScope[1];\r\n          authorizationScopes[0] = authorizationScope;\r\n          List<SecurityReference> securityReferences = new ArrayList<>();\r\n          securityReferences.add(new SecurityReference(\"Authorization\", authorizationScopes));\r\n          return securityReferences;\r\n      }\r\n  \r\n      private ApiInfo apiInfo(SwaggerProperties swaggerProperties)\r\n      {\r\n          return new ApiInfoBuilder()\r\n                  .title(swaggerProperties.getTitle())\r\n                  .description(swaggerProperties.getDescription())\r\n                  .license(swaggerProperties.getLicense())\r\n                  .licenseUrl(swaggerProperties.getLicenseUrl())\r\n                  .termsOfServiceUrl(swaggerProperties.getTermsOfServiceUrl())\r\n                  .contact(new Contact(swaggerProperties.getContact().getName(), swaggerProperties.getContact().getUrl(), swaggerProperties.getContact().getEmail()))\r\n                  .version(swaggerProperties.getVersion())\r\n                  .build();\r\n      }\r\n  }\r\n  ```\r\n\r\n  - swagger èµ„æºæ˜ å°„è·¯å¾„\r\n\r\n  ```java\r\n  public class SwaggerWebConfiguration implements WebMvcConfigurer\r\n  {\r\n      @Override\r\n      public void addResourceHandlers(ResourceHandlerRegistry registry)\r\n      {\r\n          /** swagger-ui åœ°å€ */\r\n          registry.addResourceHandler(\"/swagger-ui/**\")\r\n                  .addResourceLocations(\"classpath:/META-INF/resources/webjars/springfox-swagger-ui/\");\r\n      }\r\n  }\r\n  ```\r\n\r\n  - åœ¨src/main/resources/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.importsæ–‡ä»¶ä¸­åŠ å…¥Springå®¹å™¨ç®¡ç†\r\n\r\n  ```tex\r\n  # com.klaus.gulimall.springboot.starter.swagger.config.SwaggerAutoConfiguration\r\n  # com.klaus.gulimall.springboot.starter.swagger.config.SwaggerWebConfiguration\r\n  ```\r\n\r\n  \r\n\r\n1ã€ä¸šåŠ¡æ¨¡å—æ·»åŠ ä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>com.klaus.gulimall</groupId>\r\n    <artifactId>gulimall-swagger-spring-boot-starter</artifactId>\r\n    <version>0.0.1-SNAPSHOT</version>\r\n</dependency>\r\n```\r\n\r\n2ã€åœ¨`xxxx-dev.yml`æ·»åŠ swaggeré…ç½®\r\n\r\n```yml\r\n# swaggeré…ç½®\r\nswagger:\r\n  title: ç³»ç»Ÿæ¨¡å—æ¥å£æ–‡æ¡£\r\n  license: Powered By imklaus\r\n  licenseUrl: https://imlklaus.github.io/\r\n```\r\n\r\n3ã€åœ¨`Application`å¯åŠ¨ç±»åŠ å…¥ç³»ç»Ÿæ¥å£æ³¨è§£`@EnableCustomSwagger2`\r\n\r\n```java\r\n@EnableCustomConfig\r\n@EnableCustomSwagger2\r\n@EnableRyFeignClients\r\n@SpringCloudApplication\r\npublic class RuoYiSystemApplication\r\n{\r\n    public static void main(String[] args)\r\n    {\r\n        SpringApplication.run(RuoYiSystemApplication.class, args);\r\n        System.out.println(\"(â™¥â— â€¿â— )ï¾‰ï¾  ç³»ç»Ÿæ¨¡å—å¯åŠ¨æˆåŠŸ   áƒš(Â´Ú¡`áƒš)ï¾  \\n\" +\r\n                \" .-------.       ____     __        \\n\" +\r\n                \" |  _ _   \\\\      \\\\   \\\\   /  /    \\n\" +\r\n                \" | ( ' )  |       \\\\  _. /  '       \\n\" +\r\n                \" |(_ o _) /        _( )_ .'         \\n\" +\r\n                \" | (_,_).' __  ___(_ o _)'          \\n\" +\r\n                \" |  |\\\\ \\\\  |  ||   |(_,_)'         \\n\" +\r\n                \" |  | \\\\ `'   /|   `-'  /           \\n\" +\r\n                \" |  |  \\\\    /  \\\\      /           \\n\" +\r\n                \" ''-'   `'-'    `-..-'              \");\r\n    }\r\n}\r\n```\r\n\r\n4ã€æµ‹è¯•éªŒè¯\r\n\r\nè®¿é—®`http://{ip}:{port}/swagger-ui/index.html`åœ°å€ï¼Œå‡ºç°å¦‚ä¸‹å›¾è¡¨ç¤ºæˆåŠŸã€‚\r\n\r\n![swagger](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/up-24a0d329ed368fa86c6da597ed158898e4f.png)\r\n\r\n## æ¥å£èšåˆ\r\n\r\nè®¿é—®`swagger-ui.html`çš„æ—¶å€™ä¼šå‘ç°å³ä¸Šè§’çš„`Select a spec`è¿™ä¸ªä¸‹æ‹‰é€‰é¡¹\r\n\r\n![swagger](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/up-9d740e616ac8523c9d8285ce553689ca20b.png)\r\n\r\nå½“å¯åŠ¨ä¸€ä¸ª`springboot`é¡¹ç›®çš„æ—¶å€™ä¼šå‘ç°è¿™ä¸ªä¸‹æ‹‰é€‰é¡¹æ¯«æ— ç”¨å¤„ï¼Œä¸è¿‡å®ƒçš„å¼ºå¤§æ˜¯åœ¨äºè¿™ä¸ªä¸‹æ‹‰å¯ä»¥ç”¨æ¥åˆ‡æ¢ä¸åŒé¡¹ç›®çš„`swagger`æ¥å£åœ°å€ï¼Œè¿™å°±å®ç°äº†ä½¿ç”¨ä¸€ä¸ªç½‘å…³çš„`url`è®¿é—®æ‰€æœ‰çš„é¡¹ç›®æ¥å£ã€‚\r\n\r\n1ã€ç½‘å…³æ¨¡å—æ·»åŠ ä¾èµ–\r\n\r\n```xml\r\n<!-- SpringCloud Gateway -->\r\n<dependency>\r\n\t<groupId>org.springframework.cloud</groupId>\r\n\t<artifactId>spring-cloud-starter-gateway</artifactId>\r\n</dependency>\r\n\r\n<!-- SpringCloud Alibaba Nacos -->\r\n<dependency>\r\n\t<groupId>com.alibaba.cloud</groupId>\r\n\t<artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\r\n</dependency>\r\n\t\t\r\n<!-- Swagger UI -->\r\n<dependency>\r\n\t<groupId>io.springfox</groupId>\r\n\t<artifactId>springfox-swagger-ui</artifactId>\r\n\t<version>${swagger.fox.version}</version>\r\n</dependency>\r\n\r\n<!-- Swagger -->\r\n<dependency>\r\n\t<groupId>io.springfox</groupId>\r\n\t<artifactId>springfox-swagger2</artifactId>\r\n\t<version>${swagger.fox.version}</version>\r\n</dependency>\r\n```\r\n\r\n2ã€ç½‘å…³æœåŠ¡åˆ›å»ºä¸€ä¸ªç±»`SwaggerProvider.java`å®ç°`SwaggerResourcesProvider`\r\n\r\n```java\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport org.springframework.beans.factory.annotation.Autowired;\r\nimport org.springframework.cloud.gateway.config.GatewayProperties;\r\nimport org.springframework.cloud.gateway.route.RouteLocator;\r\nimport org.springframework.cloud.gateway.support.NameUtils;\r\nimport org.springframework.stereotype.Component;\r\nimport springfox.documentation.swagger.web.SwaggerResource;\r\nimport springfox.documentation.swagger.web.SwaggerResourcesProvider;\r\n\r\n/**\r\n * èšåˆç³»ç»Ÿæ¥å£\r\n */\r\n@Component\r\npublic class SwaggerProvider implements SwaggerResourcesProvider\r\n{\r\n    /**\r\n     * Swagger2é»˜è®¤çš„urlåç¼€\r\n     */\r\n    public static final String SWAGGER2URL = \"/v2/api-docs\";\r\n    /**\r\n     * ç½‘å…³è·¯ç”±\r\n     */\r\n    @Autowired\r\n    private RouteLocator routeLocator;\r\n\r\n    @Autowired\r\n    private GatewayProperties gatewayProperties;\r\n\r\n    /**\r\n     * èšåˆå…¶ä»–æœåŠ¡æ¥å£\r\n     * \r\n     * @return\r\n     */\r\n    @Override\r\n    public List<SwaggerResource> get()\r\n    {\r\n        List<SwaggerResource> resourceList = new ArrayList<>();\r\n        List<String> routes = new ArrayList<>();\r\n        // è·å–ç½‘å…³ä¸­é…ç½®çš„route\r\n        routeLocator.getRoutes().subscribe(route -> routes.add(route.getId()));\r\n        gatewayProperties.getRoutes().stream()\r\n                .filter(routeDefinition -> routes\r\n                        .contains(routeDefinition.getId()))\r\n                .forEach(routeDefinition -> routeDefinition.getPredicates().stream()\r\n                        .filter(predicateDefinition -> \"Path\".equalsIgnoreCase(predicateDefinition.getName()))\r\n                        .filter(predicateDefinition -> !\"ruoyi-auth\".equalsIgnoreCase(routeDefinition.getId()))\r\n                        .forEach(predicateDefinition -> resourceList\r\n                                .add(swaggerResource(routeDefinition.getId(), predicateDefinition.getArgs()\r\n                                        .get(NameUtils.GENERATED_NAME_PREFIX + \"0\").replace(\"/**\", SWAGGER2URL)))));\r\n        return resourceList;\r\n    }\r\n\r\n    private SwaggerResource swaggerResource(String name, String location)\r\n    {\r\n        SwaggerResource swaggerResource = new SwaggerResource();\r\n        swaggerResource.setName(name);\r\n        swaggerResource.setLocation(location);\r\n        swaggerResource.setSwaggerVersion(\"2.0\");\r\n        return swaggerResource;\r\n    }\r\n}\r\n```\r\n\r\n3ã€åˆ›å»ºä¸€ä¸ªèšåˆæ¥å£ç±»`SwaggerHandler.java`\r\n\r\n```java\r\nimport java.util.Optional;\r\nimport org.springframework.beans.factory.annotation.Autowired;\r\nimport org.springframework.http.HttpStatus;\r\nimport org.springframework.http.ResponseEntity;\r\nimport org.springframework.web.bind.annotation.GetMapping;\r\nimport org.springframework.web.bind.annotation.RequestMapping;\r\nimport org.springframework.web.bind.annotation.RestController;\r\nimport reactor.core.publisher.Mono;\r\nimport springfox.documentation.swagger.web.SecurityConfiguration;\r\nimport springfox.documentation.swagger.web.SecurityConfigurationBuilder;\r\nimport springfox.documentation.swagger.web.SwaggerResourcesProvider;\r\nimport springfox.documentation.swagger.web.UiConfiguration;\r\nimport springfox.documentation.swagger.web.UiConfigurationBuilder;\r\n\r\n@RestController\r\n@RequestMapping(\"/swagger-resources\")\r\npublic class SwaggerHandler\r\n{\r\n    @Autowired(required = false)\r\n    private SecurityConfiguration securityConfiguration;\r\n\r\n    @Autowired(required = false)\r\n    private UiConfiguration uiConfiguration;\r\n\r\n    private final SwaggerResourcesProvider swaggerResources;\r\n\r\n    @Autowired\r\n    public SwaggerHandler(SwaggerResourcesProvider swaggerResources)\r\n    {\r\n        this.swaggerResources = swaggerResources;\r\n    }\r\n\r\n    @GetMapping(\"/configuration/security\")\r\n    public Mono<ResponseEntity<SecurityConfiguration>> securityConfiguration()\r\n    {\r\n        return Mono.just(new ResponseEntity<>(\r\n                Optional.ofNullable(securityConfiguration).orElse(SecurityConfigurationBuilder.builder().build()),\r\n                HttpStatus.OK));\r\n    }\r\n\r\n    @GetMapping(\"/configuration/ui\")\r\n    public Mono<ResponseEntity<UiConfiguration>> uiConfiguration()\r\n    {\r\n        return Mono.just(new ResponseEntity<>(\r\n                Optional.ofNullable(uiConfiguration).orElse(UiConfigurationBuilder.builder().build()), HttpStatus.OK));\r\n    }\r\n\r\n    @SuppressWarnings(\"rawtypes\")\r\n    @GetMapping(\"\")\r\n    public Mono<ResponseEntity> swaggerResources()\r\n    {\r\n        return Mono.just((new ResponseEntity<>(swaggerResources.get(), HttpStatus.OK)));\r\n    }\r\n}\r\n```\r\n\r\n4ã€é…ç½®æ³¨å†Œä¸­å¿ƒåŠè·¯ç”±ä¿¡æ¯\r\n\r\n```yml\r\nspring:\r\n  profiles:\r\n    # ç¯å¢ƒé…ç½®\r\n    active: dev\r\n  cloud:\r\n  \tnacos:\r\n      discovery:\r\n        # æœåŠ¡æ³¨å†Œåœ°å€\r\n        server-addr: 127.0.0.1:8848\r\n    gateway:\r\n      discovery:\r\n        locator:\r\n          enabled: false\r\n          # æœåŠ¡åé»˜è®¤å¿…é¡»å¤§å†™ï¼Œå¦åˆ™ä¼šæŠ›404é”™è¯¯ï¼Œå¦‚æœæœåŠ¡åè¦ç”¨å°å†™ï¼Œå¯åœ¨å±æ€§é…ç½®æ–‡ä»¶ä¸­æ·»åŠ spring.cloud.gateway.discovery.locator.lowerCaseServiceId=trueé…ç½®è§£å†³\r\n          lower-case-service-id: true\r\n      #default-filters:  #å…¨å±€ç”¨äºé…ç½®æ‰€æœ‰è·¯ç”±å…±äº«è¿‡æ»¤å™¨\r\n      #  - StripPrefix=1 #å»æ‰- Path=/auth å‰ç¼€\r\n      #  - PreserveHostHeader #å‘é€åŸä¸»æœºå¤´\r\n      routes:\r\n#          uri: https://www.baidu.com\r\n#          predicates:\r\n#            - Query=url,baidu\r\n#        - id: qq_route\r\n#          uri: https://www.qq.com\r\n#          predicates:\r\n#            - Query=url,qq  # localhost:88?url=qq\r\n        #TODO é¡µé¢ http://localhost:88/product/api/product/**\r\n\r\n        #-> http://localhost:10000/product/**\r\n        - id: product_route\r\n          uri: lb://gulimall-product # è·¯ç”±ç»™å•†å“ç³»ç»Ÿhttp://localhost:10000/product/**\r\n          predicates:\r\n            - Path=/api/product/**\r\n          filters:\r\n            # http://localhost:10000/api/product/**\r\n            #->http://localhost:10000/product/**\r\n            - StripPrefix=2\r\n            - RewritePath=/api/(?<segment>.*),/$\\{segment}\r\n        #é¡µé¢ http://localhost:88/api/api/member/*\r\n\r\n       #->http://localhost:8000/member/**\r\n        - id: coupon_route\r\n          uri: lb://gulimall-coupon # è·¯ç”±ç»™ç”¨æˆ·ç³»ç»Ÿhttp://localhost:8000/member/**\r\n          predicates:\r\n            - Path=/api/coupon/**\r\n          filters:\r\n            # ä¸å•†å“æ ¼å¼ä¸€è‡´\r\n            # http://localhost:8000/api/member/**\r\n            #->http://localhost:8000/member/**\r\n            - StripPrefix=2\r\n            - RewritePath=/api/(?<segment>.*),/$\\{segment}\r\n        # é¡µé¢è·¯ç”±ç½‘å…³éƒ½ä»¥http://localhost:88/api/å¼€å¤´ï¼Œç½‘å…³å¯ä»¥è·¯ç”±åˆ°æŒ‡å®šæœåŠ¡\r\n\r\n\r\n        # é¡µé¢ http://localhost:88/api/thirdparty/oss/policy/*\r\n        #-> http://localhost:30000/oss/policy/*\r\n        - id: third_party_route\r\n          uri: lb://gulimall-third-party # è·¯ç”±ç»™ç¬¬ä¸‰æ–¹æœåŠ¡http://localhost:30000/oss/policy\r\n          predicates: # ä»€ä¹ˆæƒ…å†µä¸‹è·¯ç”±ç»™å®ƒ  ä»¥ä¸‹å‰ç¼€è·¯ç”±ç»™ç¬¬ä¸‰æ–¹æœåŠ¡\r\n            - Path=/api/thirdparty/**\r\n          # è·¯å¾„é‡å†™ æˆªæ‰/api/thirdparty/ï¼Œç•™ä¸‹/api/thirdparty/åçš„è·¯å¾„ä¸ç½‘å…³è·¯å¾„æ‹¼æ¥\r\n          filters:\r\n            # http://localhost:30000/api/thirdparty/oss/policy\r\n            #-> http://localhost:30000/oss/policy\r\n            - StripPrefix=2\r\n            - RewritePath=/api/thirdparty/(?<segment>.*),/$\\{segment}\r\n        #é¡µé¢ http://localhost:88/api/api/member/*\r\n\r\n        #->http://localhost:8000/member/**\r\n        - id: member_route\r\n          uri: lb://gulimall-member # è·¯ç”±ç»™ç”¨æˆ·ç³»ç»Ÿhttp://localhost:8000/member/**\r\n          predicates:\r\n            - Path=/api/member/**\r\n          filters:\r\n            # ä¸å•†å“æ ¼å¼ä¸€è‡´\r\n            # http://localhost:8000/api/member/**\r\n            #->http://localhost:8000/member/**\r\n            - StripPrefix=2\r\n            - RewritePath=/api/(?<segment>.*),/$\\{segment}\r\n        #é¡µé¢ http://localhost:88/api/api/ware/*\r\n\r\n        #->http://localhost:11000/ware/**\r\n        - id: ware_route\r\n          uri: lb://gulimall-ware # è·¯ç”±ç»™ä»“åº“ç³»ç»Ÿhttp://localhost:11000/ware/**\r\n          predicates:\r\n            - Path=/api/ware/**\r\n          filters:\r\n            # ä¸å•†å“æ ¼å¼ä¸€è‡´\r\n            # http://localhost:11000/api/ware/**\r\n            #->http://localhost:11000/ware/**\r\n            - StripPrefix=2\r\n            - RewritePath=/api/(?<segment>.*),/$\\{segment}\r\n```\r\n\r\n5ã€æµ‹è¯•éªŒè¯\r\n\r\næ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥ï¼š`http://localhost:88/swagger-ui/index.html`\r\n\r\n![swagger](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/up-7455b9e8a7850faebf31f2a869412e2132d.png)\r\n\r\né€‰æ‹©åˆ‡æ¢ä¸åŒæœåŠ¡çš„`swagger`æ¥å£\r\n\r\n## å…¨å±€æˆæƒ\r\n\r\nåœ¨æµ‹è¯•ç³»ç»Ÿæ¥å£ä¸­å¯èƒ½å­˜åœ¨ä¸€äº›æ¥å£ç”¨åˆ°ç”¨æˆ·ä¿¡æ¯æˆ–æƒé™éªŒè¯ï¼Œæ­¤æ—¶éœ€è¦æ·»åŠ å…¨å±€çš„`token`å‚æ•°ã€‚å¦‚å›¾\r\n\r\n![swagger](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/up-a474910efef3e0739b42f3d5cc329f8ef66.png)\r\n\r\n`token`æ˜¯åœ¨ç™»å½•æˆåŠŸåè¿”å›çš„ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨é€šè¿‡F12æŸ¥çœ‹`Network`ä¸­çš„è¯·æ±‚åœ°å€ï¼Œå¯¹åº”å‚æ•°`Authorization`ã€‚å¤åˆ¶æˆªå›¾å†…å®¹åˆ°`swagger`å…¨å±€`Authorization`å±æ€§`value`å‚æ•°ä¸­ï¼Œç‚¹å‡»`Authorize`ï¼Œä»¥åæ¯æ¬¡è®¿é—®æ¥å£ä¼šæºå¸¦æ­¤`token`ä¿¡æ¯ã€‚\r\n\r\n![swagger](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/up-4f771cfc906fa9dcc173f20fae80c7f5191.png)\r\n\r\n## æ•´åˆknife4j\r\n\r\nåœ¨`Spring Cloud`çš„å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œæ¯ä¸ªå¾®æœåŠ¡å¹¶ä¸éœ€è¦å¼•å…¥å‰ç«¯çš„`ui`èµ„æºï¼Œå› æ­¤åœ¨æ¯ä¸ªå¾®æœåŠ¡çš„`Spring Boot`é¡¹ç›®ä¸‹ï¼Œå¼•å…¥`ruoyi-common-swagger`æä¾›çš„`starter`å³å¯ã€‚\r\n\r\n1ã€åœ¨`ruoyi-gateway`ç½‘å…³æ¨¡å—ä¸‹ï¼ŒæŠŠ`knife4j`ä¾èµ–èµ„æºå¼•å…¥\r\n\r\n```xml\r\n<!-- knife4j -->\r\n<dependency>\r\n\t<groupId>com.github.xiaoymin</groupId>\r\n\t<!--  <artifactId>knife4j-spring-ui</artifactId> -->\r\n    <artifactId>knife4j-micro-spring-boot-starter</artifactId>\r\n\t<version>3.0.3</version>\r\n</dependency>\r\n<dependency>\r\n\t<groupId>com.github.xiaoymin</groupId>\r\n\t<artifactId>knife4j-spring-boot-starter</artifactId>\r\n\t<version>3.0.3</version>\r\n</dependency>\r\n```\r\n\r\n\r\n\r\n2ã€åœ¨`common-swagger`ç³»ç»Ÿæ¥å£æ¨¡å—ä¸‹ï¼ŒæŠŠ`knife4j`ä¾èµ–èµ„æºå¼•å…¥\r\n\r\n```xml\r\n<!-- knife4j -->\r\n<dependency>\r\n\t<groupId>com.github.xiaoymin</groupId>\r\n\t<artifactId>knife4j-spring-boot-starter</artifactId>\r\n\t<version>3.0.3</version>\r\n</dependency>\r\n```\r\n\r\n3ã€åœ¨å…¶ä»–`mall-xxxx-xxxx`æœåŠ¡ä¸‹ï¼ŒæŠŠ`common-swagger`ä¾èµ–èµ„æºå¼•å…¥\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>com.klaus.gulimall</groupId>\r\n    <artifactId>gulimall-swagger-spring-boot-starter</artifactId>\r\n    <version>0.0.1-SNAPSHOT</version>\r\n</dependency>\r\n```\r\n\r\n4ã€åœ¨`SwaggerProvider.java`çš„ç±»æ³¨è§£è¿½åŠ `@Primary`\r\n\r\n```java\r\n@Slf4j\r\n@Component\r\n@Primary\r\n@AllArgsConstructor\r\n```\r\n\r\n5ã€æµ‹è¯•éªŒè¯\r\n\r\nè®¿é—®`http://{ip}:{port}/doc.html`åœ°å€ï¼Œå‡ºç°å¦‚ä¸‹å›¾è¡¨ç¤ºæˆåŠŸã€‚\r\n\r\n![knife4j](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/up-860f80bd38f5998dfc319b2514cf1bae169.png)\r\n\r\n> é‡å¤swaggerä¾èµ–å‰”é™¤\r\n>\r\n> åœ¨`ruoyi-common-swagger`å¼•ç”¨`knife4j-spring-boot-starter`ä¾èµ–ï¼Œå…¶ä¸­çš„`springfox-swagger2`ä¾èµ–å¯ä»¥åˆ é™¤ã€‚\r\n> åœ¨`ruoyi-gateway`å¼•ç”¨`knife4j-spring-ui`ã€`knife4j-spring-boot-starter`ä¾èµ–ï¼Œå…¶ä¸­çš„`springfox-swagger-ui`ã€`springfox-swagger2`ä¾èµ–å¯ä»¥åˆ é™¤ã€‚\r\n>\r\n> `swagger3.0`å’Œ`knife4j`éƒ½éœ€è¦SpringBoot2.3ä»¥ä¸Šï¼Œå¦åˆ™æŠ¥é”™"},{"title":"ç¬¬ä¸‰ç« . åç«¯ä¹‹äºå‰ç«¯ - Vue","tags":["Vue"],"categories":["å‰ç«¯"],"author":"imklaus","excerpt":"\r\n\r\n\r\n## 1. Vue åŸºç¡€\r\n\r\n### 1) ç¯å¢ƒå‡†å¤‡\r\n\r\n#### å®‰è£…è„šæ‰‹æ¶\r\n\r\n```\r\nnpm install -g @vue/cli\r\n```\r\n\r\n* -g å‚æ•°è¡¨ç¤ºå…¨å±€å®‰","link":"/posts/Vue","content":"\r\n\r\n\r\n## 1. Vue åŸºç¡€\r\n\r\n### 1) ç¯å¢ƒå‡†å¤‡\r\n\r\n#### å®‰è£…è„šæ‰‹æ¶\r\n\r\n```\r\nnpm install -g @vue/cli\r\n```\r\n\r\n* -g å‚æ•°è¡¨ç¤ºå…¨å±€å®‰è£…ï¼Œè¿™æ ·åœ¨ä»»æ„ç›®å½•éƒ½å¯ä»¥ä½¿ç”¨ vue è„šæœ¬åˆ›å»ºé¡¹ç›®\r\n\r\n#### åˆ›å»ºé¡¹ç›®\r\n\r\n```cmd\r\nvue ui\r\n```\r\n\r\nä½¿ç”¨å›¾å½¢å‘å¯¼æ¥åˆ›å»º vue é¡¹ç›®ï¼Œå¦‚ä¸‹å›¾ï¼Œè¾“å…¥é¡¹ç›®å\r\n\r\n![image-20220815141136895](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220815141136895.png)\r\n\r\né€‰æ‹©æ‰‹åŠ¨é…ç½®é¡¹ç›®\r\n\r\n![image-20220815141312244](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220815141312244.png)\r\n\r\næ·»åŠ  vue router å’Œ vuex\r\n\r\n![image-20220815141412380](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220815141412380.png)\r\n\r\né€‰æ‹©ç‰ˆæœ¬ï¼Œåˆ›å»ºé¡¹ç›®\r\n\r\n![image-20220815141459878](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220815141459878.png)\r\n\r\n#### å®‰è£… devtools\r\n\r\n* devtools æ’ä»¶ç½‘å€ï¼šhttps://devtools.vuejs.org/guide/installation.html\r\n\r\n![image-20251114022019263](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251114022019263.png)\r\n\r\n#### è¿è¡Œé¡¹ç›®\r\n\r\nè¿›å…¥é¡¹ç›®ç›®å½•ï¼Œæ‰§è¡Œ\r\n\r\n```cmd\r\nnpm run serve\r\n```\r\n\r\n#### ä¿®æ”¹ç«¯å£\r\n\r\nå‰ç«¯æœåŠ¡å™¨é»˜è®¤å ç”¨äº† 8080 ç«¯å£ï¼Œéœ€è¦ä¿®æ”¹ä¸€ä¸‹\r\n\r\n* æ–‡æ¡£åœ°å€ï¼š[DevServer | webpack](https://webpack.js.org/configuration/dev-server/#devserverport)\r\n\r\n* æ‰“å¼€ vue.config.js æ·»åŠ \r\n\r\n  ```js\r\n  const { defineConfig } = require('@vue/cli-service')\r\n  module.exports = defineConfig({\r\n    \r\n    // ...\r\n      \r\n    devServer: {\r\n      port: 7070\r\n    }\r\n    \r\n  })\r\n  ```\r\n\r\n#### æ·»åŠ ä»£ç†\r\n\r\nä¸ºäº†é¿å…å‰åç«¯æœåŠ¡å™¨è”è°ƒæ—¶ï¼Œ fetchã€xhr è¯·æ±‚äº§ç”Ÿè·¨åŸŸé—®é¢˜ï¼Œéœ€è¦é…ç½®ä»£ç†\r\n\r\n* æ–‡æ¡£åœ°å€åŒä¸Š\r\n\r\n* æ‰“å¼€ vue.config.js æ·»åŠ \r\n\r\n  ```js\r\n  const { defineConfig } = require('@vue/cli-service')\r\n  module.exports = defineConfig({\r\n      \r\n    // ...\r\n      \r\n    devServer: {\r\n      port: 7070,\r\n      proxy: {\r\n        '/api': {\r\n          target: 'http://localhost:8080',\r\n          changeOrigin: true\r\n        }\r\n      }\r\n    }\r\n      \r\n  })\r\n  ```\r\n\r\n  \r\n\r\n#### Vue é¡¹ç›®ç»“æ„\r\n\r\n```\r\nPS E:\\BD\\å‰ç«¯\\ä»£ç \\ç¬¬3ç« \\client> tree src\r\nE:\\BD\\å‰ç«¯\\ä»£ç \\ç¬¬3ç« \\CLIENT\\SRC\r\nâ”œâ”€assets\r\nâ”œâ”€components\r\nâ”œâ”€router\r\nâ”œâ”€store\r\nâ””â”€views\r\n```\r\n\r\n* assets - é™æ€èµ„æº\r\n* components - å¯é‡ç”¨ç»„ä»¶\r\n* router - è·¯ç”±\r\n* store - æ•°æ®å…±äº«\r\n* views - è§†å›¾ç»„ä»¶\r\n\r\nä»¥åè¿˜ä¼šæ·»åŠ \r\n\r\n* api - è·Ÿåå°äº¤äº’ï¼Œå‘é€ fetchã€xhr è¯·æ±‚ï¼Œæ¥æ”¶å“åº”\r\n* plugins - æ’ä»¶\r\n\r\n\r\n\r\n### 2) Vue ç»„ä»¶\r\n\r\nVue çš„ç»„ä»¶æ–‡ä»¶ä»¥ .vue ç»“å°¾ï¼Œæ¯ä¸ªç»„ä»¶ç”±ä¸‰éƒ¨åˆ†ç»„æˆ\r\n\r\n```vue\r\n<template></template>\r\n\r\n<script></script>\r\n\r\n<style></style>\r\n```\r\n\r\n* template æ¨¡æ¿éƒ¨åˆ†ï¼Œç”±å®ƒç”Ÿæˆ html ä»£ç \r\n* script ä»£ç éƒ¨åˆ†ï¼Œæ§åˆ¶æ¨¡æ¿çš„æ•°æ®æ¥æºå’Œè¡Œä¸º\r\n* style æ ·å¼éƒ¨åˆ†ï¼Œä¸€èˆ¬ä¸å’‹å…³å¿ƒ\r\n\r\n\r\n\r\nå…¥å£ç»„ä»¶æ˜¯ App.vue\r\n\r\nå…ˆåˆ é™¤åŸæœ‰ä»£ç ï¼Œæ¥ä¸ª Hello, World ä¾‹å­\r\n\r\n```vue\r\n<template>\r\n  <h1>{{msg}}</h1>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  data() {\r\n    return {\r\n      msg: \"Hello, Vue!\"\r\n    }\r\n  }\r\n}\r\n</script>\r\n```\r\n\r\nè§£é‡Š\r\n\r\n* export default å¯¼å‡ºç»„ä»¶å¯¹è±¡ï¼Œä¾› main.js å¯¼å…¥ä½¿ç”¨\r\n* è¿™ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ª data æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ª**å¯¹è±¡**ï¼Œç»™ template æä¾›æ•°æ®\r\n* `{{}}` åœ¨ Vue é‡Œç§°ä¹‹ä¸ºæ’å€¼è¡¨è¾¾å¼ï¼Œç”¨æ¥**ç»‘å®š** data æ–¹æ³•è¿”å›çš„**å¯¹è±¡**å±æ€§ï¼Œ**ç»‘å®š**çš„å«ä¹‰æ˜¯æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé¡µé¢æ˜¾ç¤ºä¼šåŒæ­¥å˜åŒ–\r\n\r\n\r\n\r\n#### æ–‡æœ¬æ’å€¼\r\n\r\n```vue\r\n<template>\r\n    <div>\r\n        <h1>{{ name }}</h1>\r\n        <h1>{{ age > 60 ? 'è€å¹´' : 'é’å¹´' }}</h1>\r\n    </div>\r\n</template>\r\n<script>\r\nconst options = {\r\n    data: function () {\r\n        return { name: 'å¼ ä¸‰', age: 70 };\r\n    }\r\n};\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* `{{}}` é‡Œåªèƒ½ç»‘å®šä¸€ä¸ªå±æ€§ï¼Œç»‘å®šå¤šä¸ªå±æ€§éœ€è¦ç”¨å¤šä¸ª `{{}}` åˆ†åˆ«ç»‘å®š\r\n* template å†…åªèƒ½æœ‰ä¸€ä¸ªæ ¹å…ƒç´ \r\n* æ’å€¼å†…å¯ä»¥è¿›è¡Œç®€å•çš„è¡¨è¾¾å¼è®¡ç®—\r\n\r\n\r\n\r\n#### å±æ€§ç»‘å®š\r\n\r\n```vue\r\n<template>\r\n    <div>\r\n        <div><input type=\"text\" v-bind:value=\"name\"></div>\r\n        <div><input type=\"date\" v-bind:value=\"birthday\"></div>\r\n        <div><input type=\"text\" :value=\"age\"></div>\r\n    </div>\r\n</template>\r\n<script>\r\nconst options = {\r\n    data: function () {\r\n        return { name: 'ç‹äº”', birthday: '1995-05-01', age: 20 };\r\n    }\r\n};\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* ç®€å†™æ–¹å¼ï¼šå¯ä»¥çœç•¥ v-bind åªä¿ç•™å†’å·\r\n\r\n\r\n\r\n#### äº‹ä»¶ç»‘å®š\r\n\r\n```vue\r\n<!-- äº‹ä»¶ç»‘å®š -->\r\n<template>\r\n    <div>\r\n        <div><input type=\"button\" value=\"ç‚¹æˆ‘æ‰§è¡Œm1\" v-on:click=\"m1\"></div>\r\n        <div><input type=\"button\" value=\"ç‚¹æˆ‘æ‰§è¡Œm2\" @click=\"m2\"></div>\r\n        <div>{{count}}</div>\r\n    </div>\r\n</template>\r\n<script>\r\nconst options = {\r\n    data: function () {\r\n        return { count: 0 };\r\n    },\r\n    methods: {\r\n        m1() {\r\n            this.count ++;\r\n            console.log(\"m1\")\r\n        },\r\n        m2() {\r\n            this.count --;\r\n            console.log(\"m2\")\r\n        }\r\n    }\r\n};\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* ç®€å†™æ–¹å¼ï¼šå¯ä»¥æŠŠ v-on: æ›¿æ¢ä¸º @\r\n* åœ¨ methods æ–¹æ³•ä¸­çš„ this ä»£è¡¨çš„æ˜¯ data å‡½æ•°è¿”å›çš„æ•°æ®å¯¹è±¡\r\n\r\n\r\n\r\n#### åŒå‘ç»‘å®š\r\n\r\n```vue\r\n<template>\r\n    <div>\r\n        <div>\r\n            <label for=\"\">è¯·è¾“å…¥å§“å</label>\r\n            <input type=\"text\" v-model=\"name\">\r\n        </div>\r\n        <div>\r\n            <label for=\"\">è¯·è¾“å…¥å¹´é¾„</label>\r\n            <input type=\"text\" v-model=\"age\">\r\n        </div>\r\n        <div>\r\n            <label for=\"\">è¯·é€‰æ‹©æ€§åˆ«</label>\r\n            ç”· <input type=\"radio\" value=\"ç”·\" v-model=\"sex\">\r\n            å¥³ <input type=\"radio\" value=\"å¥³\" v-model=\"sex\">\r\n        </div>\r\n        <div>\r\n            <label for=\"\">è¯·é€‰æ‹©çˆ±å¥½</label>\r\n            æ¸¸æ³³ <input type=\"checkbox\" value=\"æ¸¸æ³³\" v-model=\"fav\">\r\n            æ‰“çƒ <input type=\"checkbox\" value=\"æ‰“çƒ\" v-model=\"fav\">\r\n            å¥èº« <input type=\"checkbox\" value=\"å¥èº«\" v-model=\"fav\">\r\n        </div>\r\n    </div>\r\n</template>\r\n<script>\r\nconst options = {\r\n    data: function () {\r\n        return { name: '', age: null, sex:'ç”·' , fav:['æ‰“çƒ']};\r\n    },\r\n    methods: {\r\n    }\r\n};\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* ç”¨ v-model å®ç°åŒå‘ç»‘å®šï¼Œå³ \r\n  * javascript æ•°æ®å¯ä»¥åŒæ­¥åˆ°è¡¨å•æ ‡ç­¾\r\n  * åè¿‡æ¥ç”¨æˆ·åœ¨è¡¨å•æ ‡ç­¾è¾“å…¥çš„æ–°å€¼ä¹Ÿä¼šåŒæ­¥åˆ° javascript è¿™è¾¹\r\n* åŒå‘ç»‘å®šåªé€‚ç”¨äºè¡¨å•è¿™ç§å¸¦ã€è¾“å…¥ã€‘åŠŸèƒ½çš„æ ‡ç­¾ï¼Œå…¶å®ƒæ ‡ç­¾çš„æ•°æ®ç»‘å®šï¼Œå•å‘å°±è¶³å¤Ÿäº†\r\n* å¤é€‰æ¡†è¿™ç§æ ‡ç­¾ï¼ŒåŒå‘ç»‘å®šçš„ javascript æ•°æ®ç±»å‹ä¸€èˆ¬ç”¨æ•°ç»„\r\n\r\n\r\n\r\n#### è®¡ç®—å±æ€§\r\n\r\n```vue\r\n<!-- è®¡ç®—å±æ€§ -->\r\n<template>\r\n    <div>\r\n        <h2>{{fullName}}</h2>\r\n        <h2>{{fullName}}</h2>\r\n        <h2>{{fullName}}</h2>\r\n    </div>\r\n</template>\r\n<script>\r\nconst options = {\r\n    data: function () {\r\n        return { firstName: 'ä¸‰', lastName: 'å¼ ' };\r\n    },\r\n    /* methods: {\r\n        fullName() {\r\n            console.log('è¿›å…¥äº† fullName')\r\n            return this.lastName + this.firstName;\r\n        }\r\n    },*/\r\n    computed: {\r\n        fullName() {\r\n            console.log('è¿›å…¥äº† fullName')\r\n            return this.lastName + this.firstName;\r\n        }\r\n    }\r\n};\r\nexport default options;\r\n```\r\n\r\n* æ™®é€šæ–¹æ³•è°ƒç”¨å¿…é¡»åŠ  ()ï¼Œæ²¡æœ‰ç¼“å­˜åŠŸèƒ½\r\n* è®¡ç®—å±æ€§ä½¿ç”¨æ—¶å°±æŠŠå®ƒå½“å±æ€§æ¥ç”¨ï¼Œä¸åŠ  ()ï¼Œæœ‰ç¼“å­˜åŠŸèƒ½ï¼š\r\n  * ä¸€æ¬¡è®¡ç®—åï¼Œä¼šå°†ç»“æœç¼“å­˜ï¼Œä¸‹æ¬¡å†è®¡ç®—æ—¶ï¼Œåªè¦æ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œä¸ä¼šé‡æ–°è®¡ç®—ï¼Œç›´æ¥è¿”å›ç¼“å­˜ç»“æœ\r\n\r\n\r\n\r\n#### axios\r\n\r\naxios å®ƒçš„åº•å±‚æ˜¯ç”¨äº† XMLHttpRequestï¼ˆxhrï¼‰æ–¹å¼å‘é€è¯·æ±‚å’Œæ¥æ”¶å“åº”ï¼Œxhr ç›¸å¯¹äºä¹‹å‰è®²è¿‡çš„ fetch api æ¥è¯´ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼Œä½†ç”±äºæ˜¯æ¯”è¾ƒè€çš„ apiï¼Œä¸æ”¯æŒ Promiseï¼Œaxios å¯¹ xhr è¿›è¡Œäº†å°è£…ï¼Œä½¿ä¹‹æ”¯æŒ Promiseï¼Œå¹¶æä¾›äº†å¯¹è¯·æ±‚ã€å“åº”çš„ç»Ÿä¸€æ‹¦æˆªåŠŸèƒ½\r\n\r\nå®‰è£…\r\n\r\n```cmd\r\nnpm install axios -S\r\n```\r\n\r\nå¯¼å…¥\r\n\r\n```js\r\nimport axios from 'axios'\r\n```\r\n\r\n* axios é»˜è®¤å¯¼å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿™é‡Œçš„ import å¯¼å…¥çš„å°±æ˜¯å®ƒé»˜è®¤å¯¼å‡ºçš„å¯¹è±¡\r\n\r\næ–¹æ³•\r\n\r\n| è¯·æ±‚                               | å¤‡æ³¨   |\r\n| ---------------------------------- | ------ |\r\n| axios.get(url[, config])           | :star: |\r\n| axios.delete(url[, config])        |        |\r\n| axios.head(url[, config])          |        |\r\n| axios.options(url[, config])       |        |\r\n| axios.post(url[, data[, config]])  | :star: |\r\n| axios.put(url[, data[, config]])   |        |\r\n| axios.patch(url[, data[, config]]) |        |\r\n\r\n* config - é€‰é¡¹å¯¹è±¡ã€ä¾‹å¦‚æŸ¥è¯¢å‚æ•°ã€è¯·æ±‚å¤´...\r\n* data - è¯·æ±‚ä½“æ•°æ®ã€æœ€å¸¸è§çš„æ˜¯ json æ ¼å¼æ•°æ®\r\n* getã€head è¯·æ±‚æ— æ³•æºå¸¦è¯·æ±‚ä½“ï¼Œè¿™åº”å½“æ˜¯æµè§ˆå™¨çš„é™åˆ¶æ‰€è‡´ï¼ˆxhrã€fetch api å‡æœ‰é™åˆ¶ï¼‰\r\n* optionsã€delete è¯·æ±‚å¯ä»¥é€šè¿‡ config ä¸­çš„ data æºå¸¦è¯·æ±‚ä½“\r\n\r\n\r\n\r\nä¾‹å­\r\n\r\n```vue\r\n<template>\r\n    <div>\r\n        <input type=\"button\" value=\"è·å–è¿œç¨‹æ•°æ®\" @click=\"sendReq()\">\r\n    </div>\r\n</template>\r\n<script>\r\nimport axios from 'axios'\r\nconst options = {\r\n    methods: {\r\n        async sendReq() {\r\n            // 1. æ¼”ç¤º get, post\r\n            // const resp = await axios.post('/api/a2');\r\n\r\n            // 2. å‘é€è¯·æ±‚å¤´\r\n            // const resp = await axios.post('/api/a3',{},{\r\n            //     headers:{\r\n            //         Authorization:'abc'\r\n            //     }\r\n            // });\r\n\r\n            // 3. å‘é€è¯·æ±‚æ—¶æºå¸¦æŸ¥è¯¢å‚æ•° ?name=xxx&age=xxx\r\n            // const name = encodeURIComponent('&&&');\r\n            // const age = 18;\r\n            // const resp = await axios.post(`/api/a4?name=${name}&age=${age}`);\r\n\r\n            // ä¸æƒ³è‡ªå·±æ‹¼ä¸²ã€å¤„ç†ç‰¹æ®Šå­—ç¬¦ã€å°±ç”¨ä¸‹é¢çš„åŠæ³•\r\n            // const resp = await axios.post('/api/a4', {}, {\r\n            //     params: {\r\n            //         name:'&&&&',\r\n            //         age: 20\r\n            //     }\r\n            // });\r\n\r\n            // 4. ç”¨è¯·æ±‚ä½“å‘æ•°æ®ï¼Œæ ¼å¼ä¸º urlencoded\r\n            // const params = new URLSearchParams();\r\n            // params.append(\"name\", \"å¼ ä¸‰\");\r\n            // params.append(\"age\", 24)\r\n\r\n            // const resp = await axios.post('/api/a4', params);\r\n\r\n            // 5. ç”¨è¯·æ±‚ä½“å‘æ•°æ®ï¼Œæ ¼å¼ä¸º multipart\r\n            // const params = new FormData();\r\n            // params.append(\"name\", \"æå››\");\r\n            // params.append(\"age\", 30);\r\n            // const resp = await axios.post('/api/a5', params);\r\n\r\n            // 6. ç”¨è¯·æ±‚ä½“å‘æ•°æ®ï¼Œæ ¼å¼ä¸º json\r\n            const resp = await axios.post('/api/a5json', {\r\n                name: 'ç‹äº”',\r\n                age: 50\r\n            });\r\n\r\n            console.log(resp);\r\n        }\r\n    }\r\n};\r\nexport default options;\r\n</script>\r\n```\r\n\r\n\r\n\r\nåˆ›å»ºå®ä¾‹\r\n\r\n```js\r\nconst _axios = axios.create(config);\r\n```\r\n\r\n* axios å¯¹è±¡å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä½†ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„è®¾ç½®\r\n* ç”¨ axios.create åˆ›å»ºçš„å¯¹è±¡ï¼Œå¯ä»¥è¦†ç›–é»˜è®¤è®¾ç½®ï¼Œconfig è§ä¸‹é¢è¯´æ˜\r\n\r\n\r\n\r\nå¸¸è§çš„ config é¡¹æœ‰\r\n\r\n| åç§°            | å«ä¹‰                                                       |\r\n| --------------- | ---------------------------------------------------------- |\r\n| baseURL         | å°†è‡ªåŠ¨åŠ åœ¨ url å‰é¢                                        |\r\n| headers         | è¯·æ±‚å¤´ï¼Œç±»å‹ä¸ºç®€å•å¯¹è±¡                                     |\r\n| params          | è·Ÿåœ¨ URL åçš„è¯·æ±‚å‚æ•°ï¼Œç±»å‹ä¸ºç®€å•å¯¹è±¡æˆ– URLSearchParams    |\r\n| data            | è¯·æ±‚ä½“ï¼Œç±»å‹æœ‰ç®€å•å¯¹è±¡ã€FormDataã€URLSearchParamsã€File ç­‰ |\r\n| withCredentials | è·¨åŸŸæ—¶æ˜¯å¦æºå¸¦ Cookie ç­‰å‡­è¯ï¼Œé»˜è®¤ä¸º false                 |\r\n| responseType    | å“åº”ç±»å‹ï¼Œé»˜è®¤ä¸º json                                      |\r\n\r\nä¾‹\r\n\r\n```js\r\nconst _axios = axios.create({\r\n    baseURL: 'http://localhost:8080',\r\n    withCredentials: true\r\n});\r\nawait _axios.post('/api/a6set')\r\nawait _axios.post('/api/a6get')\r\n```\r\n\r\n* ç”Ÿäº§ç¯å¢ƒå¸Œæœ› xhr è¯·æ±‚ä¸èµ°ä»£ç†ï¼Œå¯ä»¥ç”¨ baseURL ç»Ÿä¸€ä¿®æ”¹\r\n* å¸Œæœ›è·¨åŸŸè¯·æ±‚æºå¸¦ cookieï¼Œéœ€è¦é…ç½® withCredentials: trueï¼ŒæœåŠ¡å™¨ä¹Ÿè¦é…ç½® allowCredentials = trueï¼Œå¦åˆ™æµè§ˆå™¨è·å–è·¨åŸŸè¿”å›çš„ cookie æ—¶ä¼šæŠ¥é”™\r\n\r\n\r\n\r\nå“åº”æ ¼å¼\r\n\r\n| åç§°    | å«ä¹‰              |\r\n| ------- | ----------------- |\r\n| data    | å“åº”ä½“æ•°æ® :star: |\r\n| status  | çŠ¶æ€ç  :star:     |\r\n| headers | å“åº”å¤´            |\r\n\r\n* 200 è¡¨ç¤ºå“åº”æˆåŠŸ\r\n* 400 è¯·æ±‚æ•°æ®ä¸æ­£ç¡® age=abc\r\n* 401 èº«ä»½éªŒè¯æ²¡é€šè¿‡\r\n* 403 æ²¡æœ‰æƒé™\r\n* 404 èµ„æºä¸å­˜åœ¨\r\n* 405 ä¸æ”¯æŒè¯·æ±‚æ–¹å¼ post\r\n* 500 æœåŠ¡å™¨å†…éƒ¨é”™è¯¯\r\n\r\n\r\n\r\nè¯·æ±‚æ‹¦æˆªå™¨\r\n\r\n```js\r\n_axios.interceptors.request.use(\r\n  function(config) {\r\n    // æ¯”å¦‚åœ¨è¿™é‡Œæ·»åŠ ç»Ÿä¸€çš„ headers\r\n    return config;\r\n  },\r\n  function(error) {\r\n    return Promise.reject(error);\r\n  }\r\n);\r\n```\r\n\r\nå“åº”æ‹¦æˆªå™¨\r\n\r\n```js\r\n_axios.interceptors.response.use(\r\n  function(response) {\r\n    // 2xx èŒƒå›´å†…èµ°è¿™é‡Œ\r\n    return response;\r\n  },\r\n  function(error) {\r\n    // è¶…å‡º 2xx, æ¯”å¦‚ 4xx, 5xx èµ°è¿™é‡Œ\r\n    return Promise.reject(error);\r\n  }\r\n);\r\n```\r\n\r\n\r\n\r\n#### æ¡ä»¶æ¸²æŸ“\r\n\r\n```vue\r\n<template>\r\n    <div>\r\n        <input type=\"button\" value=\"è·å–è¿œç¨‹æ•°æ®\" @click=\"sendReq()\">\r\n        <div class=\"title\">å­¦ç”Ÿåˆ—è¡¨</div>\r\n        <div class=\"thead\">\r\n            <div class=\"row bold\">\r\n                <div class=\"col\">ç¼–å·</div>\r\n                <div class=\"col\">å§“å</div>\r\n                <div class=\"col\">æ€§åˆ«</div>\r\n                <div class=\"col\">å¹´é¾„</div>\r\n            </div>\r\n        </div>\r\n        <div class=\"tbody\">\r\n            <div class=\"row\" v-if=\"students.length > 0\">æ˜¾ç¤ºå­¦ç”Ÿæ•°æ®</div>\r\n            <div class=\"row\" v-else>æš‚æ— å­¦ç”Ÿæ•°æ®</div>\r\n        </div>\r\n    </div>\r\n</template>\r\n<script>\r\nimport axios from '../util/myaxios'\r\nconst options = {\r\n    data: function() {\r\n        return {\r\n            students: []\r\n        };\r\n    },\r\n    methods : {\r\n        async sendReq() {\r\n            const resp = await axios.get(\"/api/students\");\r\n            console.log(resp.data.data)\r\n            this.students = resp.data.data;\r\n        }\r\n    }\r\n};\r\nexport default options;\r\n</script>\r\n<style scoped>\r\n    div {\r\n        font-family: åæ–‡è¡Œæ¥·;\r\n        font-size: 20px;\r\n    }\r\n\r\n    .title {\r\n        margin-bottom: 10px;\r\n        font-size: 30px;\r\n        color: #333;\r\n        text-align: center;\r\n    }\r\n\r\n    .row {\r\n        background-color: #fff;\r\n        display: flex;\r\n        justify-content: center;\r\n    }\r\n\r\n    .col {\r\n        border: 1px solid #f0f0f0;\r\n        width: 15%;\r\n        height: 35px;\r\n        text-align: center;\r\n        line-height: 35px;\r\n    }\r\n\r\n    .bold .col {\r\n        background-color: #f1f1f1;\r\n    }\r\n</style>\r\n```\r\n\r\n\r\n\r\n#### åˆ—è¡¨æ¸²æŸ“\r\n\r\n```vue\r\n<template>\r\n    <div>\r\n        <!-- <input type=\"button\" value=\"è·å–è¿œç¨‹æ•°æ®\" @click=\"sendReq()\"> -->\r\n        <div class=\"title\">å­¦ç”Ÿåˆ—è¡¨</div>\r\n        <div class=\"thead\">\r\n            <div class=\"row bold\">\r\n                <div class=\"col\">ç¼–å·</div>\r\n                <div class=\"col\">å§“å</div>\r\n                <div class=\"col\">æ€§åˆ«</div>\r\n                <div class=\"col\">å¹´é¾„</div>\r\n            </div>\r\n        </div>\r\n        <div class=\"tbody\">\r\n            <div v-if=\"students.length > 0\">\r\n                <div class=\"row\" v-for=\"s of students\" :key=\"s.id\">\r\n                    <div class=\"col\">{{s.id}}</div>\r\n                    <div class=\"col\">{{s.name}}</div>\r\n                    <div class=\"col\">{{s.sex}}</div>\r\n                    <div class=\"col\">{{s.age}}</div>\r\n                </div>\r\n            </div>\r\n            <div class=\"row\" v-else>æš‚æ— å­¦ç”Ÿæ•°æ®</div>\r\n        </div>\r\n    </div>\r\n</template>\r\n<script>\r\nimport axios from '../util/myaxios'\r\nconst options = {\r\n    mounted: function(){\r\n        this.sendReq()\r\n    },\r\n    data: function() {\r\n        return {\r\n            students: []\r\n        };\r\n    },\r\n    methods : {\r\n        async sendReq() {\r\n            const resp = await axios.get(\"/api/students\");\r\n            console.log(resp.data.data)\r\n            this.students = resp.data.data;\r\n        }\r\n    }\r\n};\r\nexport default options;\r\n</script>\r\n<style scoped>\r\n    div {\r\n        font-family: åæ–‡è¡Œæ¥·;\r\n        font-size: 20px;\r\n    }\r\n\r\n    .title {\r\n        margin-bottom: 10px;\r\n        font-size: 30px;\r\n        color: #333;\r\n        text-align: center;\r\n    }\r\n\r\n    .row {\r\n        background-color: #fff;\r\n        display: flex;\r\n        justify-content: center;\r\n    }\r\n\r\n    .col {\r\n        border: 1px solid #f0f0f0;\r\n        width: 15%;\r\n        height: 35px;\r\n        text-align: center;\r\n        line-height: 35px;\r\n    }\r\n\r\n    .bold .col {\r\n        background-color: #f1f1f1;\r\n    }\r\n</style>\r\n```\r\n\r\n* v-if å’Œ v-for ä¸èƒ½ç”¨äºåŒä¸€ä¸ªæ ‡ç­¾\r\n* v-for éœ€è¦é…åˆç‰¹æ®Šçš„æ ‡ç­¾å±æ€§ key ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ä¸” key å±æ€§è¦ç»‘å®šåˆ°ä¸€ä¸ªèƒ½èµ·åˆ°å”¯ä¸€æ ‡è¯†ä½œç”¨çš„æ•°æ®ä¸Šï¼Œæœ¬ä¾‹ç»‘å®šåˆ°äº†å­¦ç”Ÿç¼–å·ä¸Š\r\n* options çš„ mounted å±æ€§å¯¹åº”ä¸€ä¸ªå‡½æ•°ï¼Œæ­¤å‡½æ•°ä¼šåœ¨ç»„ä»¶æŒ‚è½½åï¼ˆå‡†å¤‡å°±ç»ªï¼‰è¢«è°ƒç”¨ï¼Œå¯ä»¥åœ¨å®ƒå†…éƒ¨å‘èµ·è¯·æ±‚ï¼Œå»è·å–å­¦ç”Ÿæ•°æ®\r\n\r\n\r\n\r\n#### é‡ç”¨ç»„ä»¶\r\n\r\næŒ‰é’®ç»„ä»¶\r\n\r\n```vue\r\n<template>\r\n    <div class=\"button\" :class=\"[type,size]\">\r\n        a<slot></slot>b\r\n    </div>\r\n</template>\r\n<script>\r\nconst options = {\r\n    props: [\"type\", \"size\"]\r\n};\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* æ³¨æ„ï¼Œçœç•¥äº†æ ·å¼éƒ¨åˆ†\r\n\r\nä½¿ç”¨ç»„ä»¶\r\n\r\n```vue\r\n<template>\r\n    <div>\r\n        <h1>çˆ¶ç»„ä»¶</h1>\r\n        <my-button type=\"primary\" size=\"small\">1</my-button>\r\n        <my-button type=\"danger\" size=\"middle\">2</my-button>\r\n        <my-button type=\"success\" size=\"large\">3</my-button>\r\n    </div>\r\n</template>\r\n<script>\r\nimport MyButton from '../components/MyButton.vue'\r\nconst options = {\r\n    components: {\r\n        MyButton\r\n    }\r\n};\r\nexport default options;\r\n</script>\r\n```\r\n\r\n\r\n\r\n## 2. Vue è¿›é˜¶\r\n\r\n### 1) ElementUI\r\n\r\nå®‰è£…\r\n\r\n```cmd\r\nnpm install element-ui -S\r\n```\r\n\r\n\r\n\r\nå¼•å…¥ç»„ä»¶\r\n\r\n```js\r\nimport Element from 'element-ui'\r\nimport 'element-ui/lib/theme-chalk/index.css'\r\n\r\nVue.use(Element)\r\n```\r\n\r\n\r\n\r\næµ‹è¯•ï¼Œåœ¨è‡ªå·±çš„ç»„ä»¶ä¸­ä½¿ç”¨ ElementUI çš„ç»„ä»¶\r\n\r\n```vue\r\n<el-button>æŒ‰é’®</el-button>\r\n```\r\n\r\n\r\n\r\n#### è¡¨æ ¼ç»„ä»¶\r\n\r\n```vue\r\n<template>\r\n    <div>\r\n        <el-table :data=\"students\">\r\n            <el-table-column label=\"ç¼–å·\" prop=\"id\"></el-table-column>\r\n            <el-table-column label=\"å§“å\" prop=\"name\"></el-table-column>\r\n            <el-table-column label=\"æ€§åˆ«\" prop=\"sex\"></el-table-column>\r\n            <el-table-column label=\"å¹´é¾„\" prop=\"age\"></el-table-column>\r\n        </el-table>\r\n    </div>\r\n</template>\r\n<script>\r\nimport axios from '../util/myaxios'\r\nconst options = {\r\n    async mounted() {\r\n        const resp = await axios.get('/api/students');\r\n        this.students = resp.data.data\r\n    },\r\n    data() {\r\n        return {\r\n            students: []\r\n        }\r\n    }\r\n}\r\nexport default options;\r\n</script>\r\n```\r\n\r\n\r\n\r\n#### åˆ†é¡µç»„ä»¶\r\n\r\n```vue\r\n<template>\r\n    <div>\r\n        <el-table v-bind:data=\"students\">\r\n            <el-table-column label=\"ç¼–å·\" prop=\"id\"></el-table-column>\r\n            <el-table-column label=\"å§“å\" prop=\"name\"></el-table-column>\r\n            <el-table-column label=\"æ€§åˆ«\" prop=\"sex\"></el-table-column>\r\n            <el-table-column label=\"å¹´é¾„\" prop=\"age\"></el-table-column>\r\n        </el-table>\r\n        <el-pagination \r\n            :total=\"total\"\r\n            :page-size=\"queryDto.size\"\r\n            :current-page=\"queryDto.page\"\r\n            layout=\"prev,pager,next,sizes,->,total\"\r\n            :page-sizes=\"[5,10,15,20]\"\r\n            @current-change=\"currentChange\"\r\n            @size-change=\"sizeChange\"\r\n        ></el-pagination>\r\n    </div>\r\n</template>\r\n<script>\r\nimport axios from '../util/myaxios'\r\nconst options = {\r\n    mounted() {\r\n        this.query();\r\n    },\r\n    methods: {\r\n        currentChange(page) {\r\n            this.queryDto.page = page;\r\n            this.query();\r\n        },\r\n        sizeChange(size){\r\n            this.queryDto.size = size;\r\n            this.query();\r\n        },\r\n        async query() {\r\n            const resp = await axios.get('/api/students/q', {\r\n                params: this.queryDto\r\n            });\r\n            this.students = resp.data.data.list;\r\n            this.total = resp.data.data.total;\r\n        }\r\n    },\r\n    data() {\r\n        return {\r\n            students: [],\r\n            total: 0,\r\n            queryDto: {\r\n                page: 1,\r\n                size: 5\r\n            }\r\n        }\r\n    }\r\n}\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* ä¸‰ç§æƒ…å†µéƒ½åº”è¯¥è§¦å‘æŸ¥è¯¢\r\n  * mounted ç»„ä»¶æŒ‚è½½å®Œæˆå\r\n  * é¡µå·å˜åŒ–æ—¶\r\n  * é¡µå¤§å°å˜åŒ–æ—¶\r\n* æŸ¥è¯¢ä¼ å‚åº”è¯¥æ ¹æ®åå°éœ€æ±‚ï¼Œçµæ´»é‡‡ç”¨ä¸åŒæ–¹å¼\r\n  * æœ¬ä¾‹ä¸­å› ä¸ºæ˜¯ get è¯·æ±‚ï¼Œæ— æ³•é‡‡ç”¨è¯·æ±‚ä½“ï¼Œåªèƒ½ç”¨ params æ–¹å¼ä¼ å‚\r\n* è¿”å›å“åº”çš„æ ¼å¼ä¹Ÿè®¸ä¼šå¾ˆå¤æ‚ï¼Œéœ€è¦æŒæ¡ã€æ ¹æ®è¿”å›çš„å“åº”ç»“æ„ï¼Œè·å–æ•°æ®ã€‘çš„èƒ½åŠ›\r\n\r\n\r\n\r\n#### åˆ†é¡µæœç´¢\r\n\r\n```vue\r\n<template>\r\n    <div>\r\n        <el-input placeholder=\"è¯·è¾“å…¥å§“å\" size=\"mini\" v-model=\"queryDto.name\"></el-input>\r\n        <el-select placeholder=\"è¯·é€‰æ‹©æ€§åˆ«\" size=\"mini\" v-model=\"queryDto.sex\" clearable>\r\n            <el-option value=\"ç”·\"></el-option>\r\n            <el-option value=\"å¥³\"></el-option>\r\n        </el-select>\r\n        <el-select placeholder=\"è¯·é€‰æ‹©å¹´é¾„\" size=\"mini\" v-model=\"queryDto.age\" clearable>\r\n            <el-option value=\"0,20\" label=\"0åˆ°20å²\"></el-option>\r\n            <el-option value=\"21,30\" label=\"21åˆ°30å²\"></el-option>\r\n            <el-option value=\"31,40\" label=\"31åˆ°40å²\"></el-option>\r\n            <el-option value=\"41,120\" label=\"41åˆ°120å²\"></el-option>\r\n        </el-select>\r\n        <el-button type=\"primary\" size=\"mini\" @click=\"search()\">æœç´¢</el-button>\r\n        <el-divider></el-divider>\r\n        <el-table v-bind:data=\"students\">\r\n            <el-table-column label=\"ç¼–å·\" prop=\"id\"></el-table-column>\r\n            <el-table-column label=\"å§“å\" prop=\"name\"></el-table-column>\r\n            <el-table-column label=\"æ€§åˆ«\" prop=\"sex\"></el-table-column>\r\n            <el-table-column label=\"å¹´é¾„\" prop=\"age\"></el-table-column>\r\n        </el-table>\r\n        <el-pagination :total=\"total\" :page-size=\"queryDto.size\" :current-page=\"queryDto.page\"\r\n            layout=\"prev,pager,next,sizes,->,total\" :page-sizes=\"[5, 10, 15, 20]\" @current-change=\"currentChange\"\r\n            @size-change=\"sizeChange\"></el-pagination>\r\n    </div>\r\n</template>\r\n<script>\r\nimport axios from '../util/myaxios'\r\nconst options = {\r\n    mounted() {\r\n        this.query();\r\n    },\r\n    methods: {\r\n        currentChange(page) {\r\n            this.queryDto.page = page;\r\n            this.query();\r\n        },\r\n        sizeChange(size) {\r\n            this.queryDto.size = size;\r\n            this.query();\r\n        },\r\n        async query() {\r\n            const resp = await axios.get('/api/students/q', {\r\n                params: this.queryDto\r\n            });\r\n            this.students = resp.data.data.list;\r\n            this.total = resp.data.data.total;\r\n        },\r\n        search() {\r\n            this.query();\r\n        }\r\n    },\r\n    data() {\r\n        return {\r\n            students: [],\r\n            total: 0,\r\n            queryDto: {\r\n                name: '',\r\n                sex: '',\r\n                age: '',  \r\n                page: 1,\r\n                size: 5\r\n            }\r\n        }\r\n    }\r\n}\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* sex ä¸  age å‡ç”¨ `''` è¡¨ç¤ºç”¨æˆ·æ²¡æœ‰é€‰æ‹©çš„æƒ…å†µ\r\n* age å–å€¼ `0,20` ä¼šè¢« spring è½¬æ¢ä¸º `new int[]{0, 20}`\r\n* age å–å€¼ `''` ä¼šè¢« spring è½¬æ¢ä¸º `new int[0]`\r\n\r\n\r\n\r\n#### çº§è”é€‰æ‹©\r\n\r\nçº§è”é€‰æ‹©å™¨ä¸­é€‰é¡¹çš„æ•°æ®ç»“æ„ä¸º\r\n\r\n```js\r\n[\r\n    {value:100, label:'ä¸»é¡µ',children:[\r\n        {value:101, label:'èœå•1', children:[\r\n            {value:105, label:'å­é¡¹1'},\r\n            {value:106, label:'å­é¡¹2'}\r\n        ]},\r\n        {value:102, label:'èœå•2', children:[\r\n            {value:107, label:'å­é¡¹3'},\r\n            {value:108, label:'å­é¡¹4'},\r\n            {value:109, label:'å­é¡¹5'}\r\n        ]},\r\n        {value:103, label:'èœå•3', children:[\r\n            {value:110, label:'å­é¡¹6'},\r\n            {value:111, label:'å­é¡¹7'}\r\n        ]},\r\n        {value:104, label:'èœå•4'}\r\n    ]}\r\n]\r\n```\r\n\r\nä¸‹é¢çš„ä¾‹å­æ˜¯å°†åç«¯è¿”å›çš„ä¸€ç»´æ•°ç»„ã€æ ‘åŒ–ã€‘\r\n\r\n```vue\r\n<template>\r\n    <el-cascader :options=\"ops\"></el-cascader>\r\n</template>\r\n<script>\r\nimport axios from '../util/myaxios'\r\nconst options = {\r\n    async mounted() {\r\n        const resp = await axios.get('/api/menu')\r\n        console.log(resp.data.data)\r\n        const array = resp.data.data;\r\n\r\n        const map = new Map(); \r\n\r\n        // 1. å°†æ‰€æœ‰æ•°æ®å­˜å…¥ map é›†åˆ(ä¸ºäº†æ¥ä¸‹æ¥æŸ¥æ‰¾æ•ˆç‡)\r\n        for(const {id,name,pid} of array) {\r\n            map.set(id, {value:id, label:name, pid:pid})\r\n        }\r\n        // 2. å»ºç«‹çˆ¶å­å…³ç³»\r\n        // 3. æ‰¾åˆ°é¡¶å±‚å¯¹è±¡\r\n        const top = [];\r\n        for(const obj of map.values()) {\r\n            const parent = map.get(obj.pid);\r\n            if(parent !== undefined) {\r\n                parent.children ??= [];\r\n                parent.children.push(obj);\r\n            } else {\r\n                top.push(obj)\r\n            }\r\n        }\r\n        this.ops = top;\r\n    },\r\n    data(){\r\n        return {\r\n            ops: []\r\n        }\r\n    }\r\n};\r\nexport default options;\r\n</script>\r\n```\r\n\r\n\r\n\r\n### 2) Vue-Router\r\n\r\nvue å±äºå•é¡µé¢åº”ç”¨ï¼Œæ‰€è°“çš„è·¯ç”±ï¼Œå°±æ˜¯æ ¹æ®æµè§ˆå™¨è·¯å¾„ä¸åŒï¼Œç”¨ä¸åŒçš„**è§†å›¾ç»„ä»¶**æ›¿æ¢è¿™ä¸ªé¡µé¢å†…å®¹å±•ç¤º\r\n\r\n\r\n\r\n#### é…ç½®è·¯ç”±\r\n\r\næ–°å»ºä¸€ä¸ªè·¯ç”± js æ–‡ä»¶ï¼Œä¾‹å¦‚ src/router/example14.jsï¼Œå†…å®¹å¦‚ä¸‹\r\n\r\n```js\r\nimport Vue from 'vue'\r\nimport VueRouter from 'vue-router'\r\nimport ContainerView from '@/views/example14/ContainerView.vue'\r\nimport LoginView from '@/views/example14/LoginView.vue'\r\nimport NotFoundView from '@/views/example14/NotFoundView.vue'\r\n\r\nVue.use(VueRouter)\r\n\r\nconst routes = [\r\n  {\r\n    path:'/',\r\n    component: ContainerView\r\n  },\r\n  {\r\n    path:'/login',\r\n    component: LoginView\r\n  },\r\n  {\r\n    path:'/404',\r\n    component: NotFoundView\r\n  }\r\n]\r\n\r\nconst router = new VueRouter({\r\n  routes\r\n})\r\n\r\nexport default router\r\n```\r\n\r\n* æœ€é‡è¦çš„å°±æ˜¯å»ºç«‹äº†ã€è·¯å¾„ã€‘ä¸ã€è§†å›¾ç»„ä»¶ã€‘ä¹‹é—´çš„æ˜ å°„å…³ç³»\r\n* æœ¬ä¾‹ä¸­æ˜ å°„äº† 3 ä¸ªè·¯å¾„ä¸å¯¹åº”çš„è§†å›¾ç»„ä»¶\r\n\r\nåœ¨ main.js ä¸­é‡‡ç”¨æˆ‘ä»¬çš„è·¯ç”± js\r\n\r\n```js\r\nimport Vue from 'vue'\r\nimport e14 from './views/Example14View.vue'\r\nimport router from './router/example14'  // ä¿®æ”¹è¿™é‡Œ\r\nimport store from './store'\r\nimport Element from 'element-ui'\r\nimport 'element-ui/lib/theme-chalk/index.css'\r\n\r\nVue.config.productionTip = false\r\n\r\nVue.use(Element)\r\nnew Vue({\r\n  router,\r\n  store,\r\n  render: h => h(e14)\r\n}).$mount('#app')\r\n```\r\n\r\næ ¹ç»„ä»¶æ˜¯ Example14View.vueï¼Œå†…å®¹ä¸ºï¼š\r\n\r\n```vue\r\n<template>\r\n    <div class=\"all\">\r\n        <router-view></router-view>\r\n    </div>\r\n</template>\r\n```\r\n\r\n* æ ·å¼ç•¥\r\n* å…¶ä¸­ `<router-view>` èµ·åˆ°å ä½ä½œç”¨ï¼Œæ”¹å˜è·¯å¾„åï¼Œè¿™ä¸ªè·¯å¾„å¯¹åº”çš„è§†å›¾ç»„ä»¶å°±ä¼šå æ® `<router-view>` çš„ä½ç½®ï¼Œæ›¿æ¢æ‰å®ƒä¹‹å‰çš„å†…å®¹\r\n\r\n\r\n\r\n#### åŠ¨æ€å¯¼å…¥\r\n\r\n```js\r\nimport Vue from 'vue'\r\nimport VueRouter from 'vue-router'\r\n\r\nVue.use(VueRouter)\r\n\r\nconst routes = [\r\n  {\r\n    path:'/',\r\n    component: () => import('@/views/example14/ContainerView.vue')\r\n  },\r\n  {\r\n    path:'/login',\r\n    component: () => import('@/views/example14/LoginView.vue')\r\n  },\r\n  {\r\n    path:'/404',\r\n    component: () => import('@/views/example14/NotFoundView.vue')\r\n  }\r\n]\r\n\r\nconst router = new VueRouter({\r\n  routes\r\n})\r\n\r\nexport default router\r\n```\r\n\r\n* é™æ€å¯¼å…¥æ˜¯å°†æ‰€æœ‰ç»„ä»¶çš„ js ä»£ç æ‰“åŒ…åˆ°ä¸€èµ·ï¼Œå¦‚æœç»„ä»¶éå¸¸å¤šï¼Œæ‰“åŒ…åçš„ js æ–‡ä»¶ä¼šå¾ˆå¤§ï¼Œå½±å“é¡µé¢åŠ è½½é€Ÿåº¦\r\n* åŠ¨æ€å¯¼å…¥æ˜¯å°†ç»„ä»¶çš„ js ä»£ç æ”¾å…¥ç‹¬ç«‹çš„æ–‡ä»¶ï¼Œç”¨åˆ°æ—¶æ‰åŠ è½½\r\n\r\n\r\n\r\n#### åµŒå¥—è·¯ç”±\r\n\r\nç»„ä»¶å†…å†è¦åˆ‡æ¢å†…å®¹ï¼Œå°±éœ€è¦ç”¨åˆ°åµŒå¥—è·¯ç”±ï¼ˆå­è·¯ç”±ï¼‰ï¼Œä¸‹é¢çš„ä¾‹å­æ˜¯åœ¨ã€ContainerView ç»„ä»¶ã€‘å†…å®šä¹‰äº† 3 ä¸ªå­è·¯ç”±\r\n\r\n```js\r\nconst routes = [\r\n  {\r\n    path:'/',\r\n    component: () => import('@/views/example14/ContainerView.vue'),\r\n    redirect: '/c/p1',\r\n    children: [\r\n      { \r\n        path:'c/p1',\r\n        component: () => import('@/views/example14/container/P1View.vue')\r\n      },\r\n      { \r\n        path:'c/p2',\r\n        component: () => import('@/views/example14/container/P2View.vue')\r\n      },\r\n      { \r\n        path:'c/p3',\r\n        component: () => import('@/views/example14/container/P3View.vue')\r\n      }\r\n    ]\r\n  },\r\n  {\r\n    path:'/login',\r\n    component: () => import('@/views/example14/LoginView.vue')\r\n  },\r\n  {\r\n    path:'/404',\r\n    component: () => import('@/views/example14/NotFoundView.vue')\r\n  },\r\n  {\r\n    path:'*',\r\n    redirect: '/404'\r\n  }\r\n]\r\n```\r\n\r\nå­è·¯ç”±å˜åŒ–ï¼Œåˆ‡æ¢çš„æ˜¯ã€ContainerView ç»„ä»¶ã€‘ä¸­ `<router-view></router-view>` éƒ¨åˆ†çš„å†…å®¹\r\n\r\n```java\r\n<template>\r\n    <div class=\"container\">\r\n        <router-view></router-view>\r\n    </div>\r\n</template>\r\n```\r\n\r\n* redirect å¯ä»¥ç”¨æ¥é‡å®šå‘ï¼ˆè·³è½¬ï¼‰åˆ°ä¸€ä¸ªæ–°çš„åœ°å€\r\n* path çš„å–å€¼ä¸º * è¡¨ç¤ºåŒ¹é…ä¸åˆ°å…¶å®ƒ path æ—¶ï¼Œå°±ä¼šåŒ¹é…å®ƒ\r\n\r\n\r\n\r\n#### ElementUI å¸ƒå±€\r\n\r\né€šå¸¸ä¸»é¡µè¦åšå¸ƒå±€ï¼Œä¸‹é¢çš„ä»£ç æ˜¯ ElementUI æä¾›çš„ã€ä¸Š-ã€å·¦-å³ã€‘ã€‘å¸ƒå±€\r\n\r\n```vue\r\n<template>\r\n    <div class=\"container\">\r\n        <el-container>\r\n            <el-header></el-header>\r\n            <el-container>\r\n                <el-aside width=\"200px\"></el-aside>\r\n                <el-main>\r\n                    <router-view></router-view>\r\n                </el-main>\r\n            </el-container>\r\n        </el-container>\r\n    </div>\r\n</template>\r\n```\r\n\r\n\r\n\r\n#### è·¯ç”±è·³è½¬\r\n\r\n##### æ ‡ç­¾å¼\r\n\r\n```vue\r\n<el-aside width=\"200px\">\r\n    <router-link to=\"/c1/p1\">P1</router-link>\r\n    <router-link to=\"/c1/p2\">P2</router-link>\r\n    <router-link to=\"/c1/p3\">P3</router-link>\r\n</el-aside>\r\n```\r\n\r\n\r\n\r\n##### ç¼–ç¨‹å¼\r\n\r\n```vue\r\n<el-header>\r\n    <el-button type=\"primary\" icon=\"el-icon-edit\" \r\n               circle size=\"mini\" @click=\"jump('/c1/p1')\"></el-button>\r\n    <el-button type=\"success\" icon=\"el-icon-check\" \r\n               circle size=\"mini\" @click=\"jump('/c1/p2')\"></el-button>\r\n    <el-button type=\"warning\" icon=\"el-icon-star-off\" \r\n               circle size=\"mini\" @click=\"jump('/c1/p3')\"></el-button>\r\n</el-header>\r\n```\r\n\r\njump æ–¹æ³•\r\n\r\n```vue\r\n<script>\r\nconst options = {\r\n    methods : {\r\n        jump(url) {\r\n            this.$router.push(url);\r\n        }\r\n    }\r\n}\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* å…¶ä¸­ this.$router æ˜¯æ‹¿åˆ°è·¯ç”±å¯¹è±¡\r\n* push æ–¹æ³•æ ¹æ® url è¿›è¡Œè·³è½¬\r\n\r\n\r\n\r\n##### å¯¼èˆªèœå•\r\n\r\n```vue\r\n<el-menu router background-color=\"#545c64\" text-color=\"#fff\" active-text-color=\"#ffd04b\">\r\n    <el-submenu index=\"/c1\">\r\n        <span slot=\"title\">\r\n            <i class=\"el-icon-platform-eleme\"></i>\r\n            èœå•1\r\n        </span>\r\n        <el-menu-item index=\"/c1/p1\">å­é¡¹1</el-menu-item>\r\n        <el-menu-item index=\"/c1/p2\">å­é¡¹2</el-menu-item>\r\n        <el-menu-item index=\"/c1/p3\">å­é¡¹3</el-menu-item>\r\n    </el-submenu>\r\n    <el-menu-item index=\"/c2\">\r\n        <span slot=\"title\">\r\n            <i class=\"el-icon-phone\"></i>\r\n            èœå•2\r\n        </span>\r\n    </el-menu-item>\r\n    <el-menu-item index=\"/c3\">\r\n        <span slot=\"title\">\r\n            <i class=\"el-icon-star-on\"></i>\r\n            èœå•3\r\n        </span>\r\n    </el-menu-item>\r\n</el-menu>\r\n```\r\n\r\n* å›¾æ ‡å’Œèœå•é¡¹æ–‡å­—å»ºè®®ç”¨ `<span slot='title'></span>` åŒ…è£¹èµ·æ¥\r\n* `el-menu` æ ‡ç­¾ä¸ŠåŠ ä¸Š `router` å±æ€§ï¼Œè¡¨ç¤ºç»“åˆå¯¼èˆªèœå•ä¸è·¯ç”±å¯¹è±¡ï¼Œæ­¤æ—¶ï¼Œå°±å¯ä»¥åˆ©ç”¨èœå•é¡¹çš„ `index` å±æ€§æ¥è·¯ç”±è·³è½¬\r\n\r\n\r\n\r\n#### åŠ¨æ€è·¯ç”±ä¸èœå•\r\n\r\nå°†èœå•ã€è·¯ç”±ä¿¡æ¯ï¼ˆä»…ä¸»é¡µçš„ï¼‰å­˜å…¥æ•°æ®åº“ä¸­\r\n\r\n```sql\r\ninsert into menu(id, name, pid, path, component, icon) values\r\n    (101, 'èœå•1', 0,   '/m1',    null,         'el-icon-platform-eleme'),\r\n    (102, 'èœå•2', 0,   '/m2',    null,         'el-icon-delete-solid'),\r\n    (103, 'èœå•3', 0,   '/m3',    null,         'el-icon-s-tools'),\r\n    (104, 'èœå•4', 0,   '/m4',    'M4View.vue', 'el-icon-user-solid'),\r\n    (105, 'å­é¡¹1', 101, '/m1/c1', 'C1View.vue', 'el-icon-s-goods'),\r\n    (106, 'å­é¡¹2', 101, '/m1/c2', 'C2View.vue', 'el-icon-menu'),\r\n    (107, 'å­é¡¹3', 102, '/m2/c3', 'C3View.vue', 'el-icon-s-marketing'),\r\n    (108, 'å­é¡¹4', 102, '/m2/c4', 'C4View.vue', 'el-icon-s-platform'),\r\n    (109, 'å­é¡¹5', 102, '/m2/c5', 'C5View.vue', 'el-icon-picture'),\r\n    (110, 'å­é¡¹6', 103, '/m3/c6', 'C6View.vue', 'el-icon-upload'),\r\n    (111, 'å­é¡¹7', 103, '/m3/c7', 'C7View.vue', 'el-icon-s-promotion');\r\n```\r\n\r\nä¸åŒçš„ç”¨æˆ·æŸ¥è¯¢çš„çš„èœå•ã€è·¯ç”±ä¿¡æ¯æ˜¯ä¸ä¸€æ ·çš„\r\n\r\nä¾‹å¦‚ï¼šè®¿é—® `/api/menu/admin` è¿”å›æ‰€æœ‰çš„æ•°æ®\r\n\r\n```json\r\n[\r\n    {\r\n        \"id\": 102,\r\n        \"name\": \"èœå•2\",\r\n        \"icon\": \"el-icon-delete-solid\",\r\n        \"path\": \"/m2\",\r\n        \"pid\": 0,\r\n        \"component\": null\r\n    },\r\n    {\r\n        \"id\": 107,\r\n        \"name\": \"å­é¡¹3\",\r\n        \"icon\": \"el-icon-s-marketing\",\r\n        \"path\": \"/m2/c3\",\r\n        \"pid\": 102,\r\n        \"component\": \"C3View.vue\"\r\n    },\r\n    {\r\n        \"id\": 108,\r\n        \"name\": \"å­é¡¹4\",\r\n        \"icon\": \"el-icon-s-platform\",\r\n        \"path\": \"/m2/c4\",\r\n        \"pid\": 102,\r\n        \"component\": \"C4View.vue\"\r\n    },\r\n    {\r\n        \"id\": 109,\r\n        \"name\": \"å­é¡¹5\",\r\n        \"icon\": \"el-icon-picture\",\r\n        \"path\": \"/m2/c5\",\r\n        \"pid\": 102,\r\n        \"component\": \"C5View.vue\"\r\n    }\r\n]\r\n```\r\n\r\nè®¿é—® `/api/menu/wang` è¿”å›\r\n\r\n```json\r\n[\r\n    {\r\n        \"id\": 103,\r\n        \"name\": \"èœå•3\",\r\n        \"icon\": \"el-icon-s-tools\",\r\n        \"path\": \"/m3\",\r\n        \"pid\": 0,\r\n        \"component\": null\r\n    },\r\n    {\r\n        \"id\": 110,\r\n        \"name\": \"å­é¡¹6\",\r\n        \"icon\": \"el-icon-upload\",\r\n        \"path\": \"/m3/c6\",\r\n        \"pid\": 103,\r\n        \"component\": \"C6View.vue\"\r\n    },\r\n    {\r\n        \"id\": 111,\r\n        \"name\": \"å­é¡¹7\",\r\n        \"icon\": \"el-icon-s-promotion\",\r\n        \"path\": \"/m3/c7\",\r\n        \"pid\": 103,\r\n        \"component\": \"C7View.vue\"\r\n    }\r\n]\r\n```\r\n\r\nå‰ç«¯æ ¹æ®ä»–ä»¬èº«ä»½ä¸åŒï¼ŒåŠ¨æ€æ·»åŠ è·¯ç”±å’Œæ˜¾ç¤ºèœå•\r\n\r\n##### åŠ¨æ€è·¯ç”±\r\n\r\n```js\r\nexport function addServerRoutes(array) {\r\n  for (const { id, path, component } of array) {\r\n    if (component !== null) {\r\n      // åŠ¨æ€æ·»åŠ è·¯ç”±\r\n      // å‚æ•°1ï¼šçˆ¶è·¯ç”±åç§°\r\n      // å‚æ•°2ï¼šè·¯ç”±ä¿¡æ¯å¯¹è±¡\r\n      router.addRoute('c', {\r\n        path: path,\r\n        name: id,\r\n        component: () => import(`@/views/example15/container/${component}`)\r\n      });\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n* js è¿™è¾¹åªä¿ç•™å‡ ä¸ªå›ºå®šè·¯ç”±ï¼Œå¦‚ä¸»é¡µã€404 å’Œ login\r\n* ä»¥ä¸Šæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œå°†æœåŠ¡å™¨è¿”å›çš„è·¯ç”±ä¿¡æ¯åŠ å…¥åˆ°åä¸º c çš„çˆ¶è·¯ç”±ä¸­å»\r\n* è¿™é‡Œè¦æ³¨æ„ç»„ä»¶è·¯å¾„ï¼Œå‰é¢ @/views æ˜¯å¿…é¡»åœ¨ js è¿™è¾¹å®Œæˆæ‹¼æ¥çš„ï¼Œå¦åˆ™ import å‡½æ•°ä¼šå¤±æ•ˆ\r\n\r\n##### é‡ç½®è·¯ç”±\r\n\r\nåœ¨ç”¨æˆ·æ³¨é”€æ—¶åº”å½“é‡ç½®è·¯ç”±\r\n\r\n```js\r\nexport function resetRouter() {\r\n  router.matcher = new VueRouter({ routes }).matcher\r\n}\r\n```\r\n\r\n##### é¡µé¢åˆ·æ–°\r\n\r\né¡µé¢åˆ·æ–°åï¼Œä¼šå¯¼è‡´åŠ¨æ€æ·»åŠ çš„è·¯ç”±å¤±æ•ˆï¼Œè§£å†³æ–¹æ³•æ˜¯å°†è·¯ç”±æ•°æ®å­˜å…¥ sessionStorage\r\n\r\n```vue\r\n<script>\r\nimport axios from '@/util/myaxios'\r\nimport {resetRouter, addServerRoutes} from '@/router/example15'\r\nconst options = {\r\n    data() {\r\n        return {\r\n            username: 'admin'\r\n        }\r\n    },\r\n    methods: {\r\n        async login() {       \r\n            resetRouter(); // é‡ç½®è·¯ç”±     \r\n            const resp = await axios.get(`/api/menu/${this.username}`)\r\n            const array = resp.data.data;\r\n            // localStorage     å³ä½¿æµè§ˆå™¨å…³é—­ï¼Œå­˜å‚¨çš„æ•°æ®ä»åœ¨\r\n            // sessionStorage   ä»¥æ ‡ç­¾é¡µä¸ºå•ä½ï¼Œå…³é—­æ ‡ç­¾é¡µæ—¶ï¼Œæ•°æ®è¢«æ¸…é™¤\r\n            sessionStorage.setItem('serverRoutes', JSON.stringify(array))\r\n            addServerRoutes(array); // åŠ¨æ€æ·»åŠ è·¯ç”±\r\n            this.$router.push('/');\r\n        }\r\n    }\r\n}\r\nexport default options;\r\n</script>\r\n```\r\n\r\né¡µé¢åˆ·æ–°ï¼Œé‡æ–°åˆ›å»ºè·¯ç”±å¯¹è±¡æ—¶ï¼Œä» sessionStorage é‡Œæ¢å¤è·¯ç”±æ•°æ®\r\n\r\n```js\r\nconst router = new VueRouter({\r\n  routes\r\n})\r\n\r\n// ä» sessionStorage ä¸­æ¢å¤è·¯ç”±æ•°æ®\r\nconst serverRoutes = sessionStorage.getItem('serverRoutes');\r\nif(serverRoutes) {\r\n  const array = JSON.parse(serverRoutes);\r\n  addServerRoutes(array) // åŠ¨æ€æ·»åŠ è·¯ç”±\r\n}\r\n```\r\n\r\n##### åŠ¨æ€èœå•\r\n\r\nä»£ç éƒ¨åˆ†\r\n\r\n```vue\r\n<script>\r\nconst options = {\r\n    mounted() {\r\n        const serverRoutes = sessionStorage.getItem('serverRoutes');\r\n        const array = JSON.parse(serverRoutes);\r\n        const map = new Map();\r\n        for(const obj of array) {\r\n            map.set(obj.id, obj);\r\n        }\r\n        const top = [];\r\n        for(const obj of array) {\r\n            const parent = map.get(obj.pid);\r\n            if(parent) {\r\n                parent.children ??= [];\r\n                parent.children.push(obj);\r\n            } else {\r\n                top.push(obj);\r\n            }\r\n        }\r\n        this.top = top;\r\n    },\r\n    data() {\r\n        return {\r\n            top: []\r\n        }\r\n    }\r\n}\r\nexport default options;\r\n</script>\r\n```\r\n\r\nèœå•éƒ¨åˆ†\r\n\r\n```vue\r\n<el-menu router background-color=\"#545c64\" text-color=\"#fff\" active-text-color=\"#ffd04b\" :unique-opened=\"true\">\r\n    <template v-for=\"m1 of top\">\r\n<el-submenu v-if=\"m1.children\" :key=\"m1.id\" :index=\"m1.path\">\r\n    <span slot=\"title\">\r\n        <i :class=\"m1.icon\"></i> {{m1.name}}\r\n        </span>\r\n    <el-menu-item v-for=\"m2 of m1.children\" :key=\"m2.id\" :index=\"m2.path\">\r\n        <span slot=\"title\">\r\n            <i :class=\"m2.icon\"></i> {{m2.name}}\r\n        </span>\r\n        </el-menu-item>\r\n        </el-submenu>\r\n<el-menu-item v-else :key=\"m1.id\" :index=\"m1.path\">\r\n    <span slot=\"title\">\r\n        <i :class=\"m1.icon\"></i> {{m1.name}}\r\n        </span>\r\n        </el-menu-item>\r\n    </template>\r\n</el-menu>\r\n```\r\n\r\n* æ²¡æœ‰è€ƒè™‘é€’å½’èœå•é—®é¢˜ï¼Œè®¤ä¸ºèœå•åªæœ‰ä¸¤çº§\r\n\r\n\r\n\r\n### 3) Vuex\r\n\r\n#### å…¥é—¨\r\n\r\nvuex å¯ä»¥åœ¨å¤šä¸ªç»„ä»¶ä¹‹é—´å…±äº«æ•°æ®ï¼Œå¹¶ä¸”å…±äº«çš„æ•°æ®æ˜¯ã€å“åº”å¼ã€‘çš„ï¼Œå³æ•°æ®çš„å˜æ›´èƒ½åŠæ—¶æ¸²æŸ“åˆ°æ¨¡æ¿\r\n\r\n* ä¸ä¹‹å¯¹æ¯” localStorage ä¸ sessionStorage ä¹Ÿèƒ½å…±äº«æ•°æ®ï¼Œä½†ç¼ºç‚¹æ˜¯æ•°æ®å¹¶éã€å“åº”å¼ã€‘\r\n\r\né¦–å…ˆéœ€è¦å®šä¹‰ state ä¸ mutations ä»–ä»¬ä¸€ä¸ªç”¨æ¥è¯»å–å…±äº«æ•°æ®ï¼Œä¸€ä¸ªç”¨æ¥ä¿®æ”¹å…±äº«æ•°æ®\r\n\r\nsrc/store/index.js\r\n\r\n```js\r\nimport Vue from 'vue'\r\nimport Vuex from 'vuex'\r\n\r\nVue.use(Vuex)\r\n\r\n/*\r\n  è¯»å–æ•°æ®ï¼Œèµ° state, getters\r\n  ä¿®æ”¹æ•°æ®ï¼Œèµ° mutations, actions\r\n*/\r\nexport default new Vuex.Store({\r\n  state: {\r\n    name: '',\r\n    age: 18\r\n  },\r\n  getters: {\r\n  },\r\n  mutations: {\r\n    updateName(state, name) {\r\n      state.name = name;\r\n    }\r\n  },\r\n  actions: {\r\n  },\r\n  modules: {\r\n  }\r\n})\r\n```\r\n\r\nä¿®æ”¹å…±äº«æ•°æ®\r\n\r\n```vue\r\n<template>\r\n    <div class=\"p\">\r\n        <el-input placeholder=\"è¯·ä¿®æ”¹ç”¨æˆ·å§“å\" \r\n            size=\"mini\" v-model=\"name\"></el-input>\r\n        <el-button type=\"primary\" size=\"mini\" @click=\"update()\">ä¿®æ”¹</el-button>\r\n    </div>\r\n</template>\r\n<script>\r\nconst options = {\r\n    methods: {\r\n        update(){\r\n            this.$store.commit('updateName', this.name);\r\n        }\r\n    },\r\n    data () {\r\n        return {\r\n            name:''\r\n        }\r\n    }\r\n}\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* mutations æ–¹æ³•ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡ `store.commit(mutationæ–¹æ³•å, å‚æ•°)` æ¥é—´æ¥è°ƒç”¨\r\n\r\nè¯»å–å…±äº«æ•°æ®\r\n\r\n```vue\r\n<template>\r\n    <div class=\"container\">\r\n        <el-container>\r\n            <el-header>\r\n                <div class=\"t\">\r\n                    æ¬¢è¿æ‚¨ï¼š{{ $store.state.name }}, {{ $store.state.age }}\r\n          </div>\r\n            </el-header>\r\n            <el-container>\r\n                <el-aside width=\"200px\">\r\n                </el-aside>\r\n                <el-main>\r\n                    <router-view></router-view>\r\n                </el-main>\r\n            </el-container>\r\n        </el-container>\r\n    </div>\r\n</template>\r\n```\r\n\r\n\r\n\r\n#### mapState\r\n\r\næ¯æ¬¡å»å†™ `$store.state.name` è¿™æ ·çš„ä»£ç æ˜¾å¾—éå¸¸ç¹çï¼Œå¯ä»¥ç”¨ vuex å¸®æˆ‘ä»¬ç”Ÿæˆè®¡ç®—å±æ€§\r\n\r\n```vue\r\n<template>\r\n    <div class=\"container\">\r\n        <el-container>\r\n            <el-header>\r\n                <div class=\"t\">æ¬¢è¿æ‚¨ï¼š{{ name }}, {{ age }}</div>\r\n            </el-header>\r\n            <el-container>\r\n                <el-aside width=\"200px\">\r\n                </el-aside>\r\n                <el-main>\r\n                    <router-view></router-view>\r\n                </el-main>\r\n            </el-container>\r\n        </el-container>\r\n    </div>\r\n</template>\r\n<script>\r\nimport { mapState } from 'vuex'\r\nconst options = {\r\n    computed: {\r\n        ...mapState(['name', 'age'])\r\n    }\r\n}\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* mapState è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡å†…åŒ…å«äº† name() å’Œ age() çš„è¿™ä¸¤ä¸ªæ–¹æ³•ä½œä¸ºè®¡ç®—å±æ€§\r\n* æ­¤å¯¹è±¡é…åˆ `...` å±•å¼€è¿ç®—ç¬¦ï¼Œå¡«å……å…¥ computed å³å¯ä½¿ç”¨\r\n\r\n\r\n\r\n#### mapMutations\r\n\r\n```vue\r\n<template>\r\n    <div class=\"p\">\r\n        <el-input placeholder=\"è¯·ä¿®æ”¹ç”¨æˆ·å§“å\" \r\n            size=\"mini\" v-model=\"name\"></el-input>\r\n        <el-button type=\"primary\" size=\"mini\" @click=\"updateName(name)\">ä¿®æ”¹</el-button>\r\n    </div>\r\n</template>\r\n<script>\r\nimport {mapMutations} from 'vuex'\r\nconst options = {\r\n    methods: {\r\n        ...mapMutations(['updateName'])\r\n    },\r\n    data () {\r\n        return {\r\n            name:''\r\n        }\r\n    }\r\n}\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* ç±»ä¼¼çš„ï¼Œè°ƒç”¨ mutation ä¿®æ”¹å…±äº«æ•°æ®ä¹Ÿå¯ä»¥ç®€åŒ–\r\n* mapMutations è¿”å›çš„å¯¹è±¡ä¸­åŒ…å«çš„æ–¹æ³•ï¼Œå°±ä¼šè°ƒç”¨ store.commit() æ¥æ‰§è¡Œ mutation æ–¹æ³•\r\n* æ³¨æ„å‚æ•°ä¼ é€’ç•¥æœ‰ä¸åŒ\r\n\r\n\r\n\r\n#### actions\r\n\r\nmutations æ–¹æ³•å†…ä¸èƒ½åŒ…æ‹¬ä¿®æ”¹ä¸èƒ½ç«‹åˆ»ç”Ÿæ•ˆçš„ä»£ç ï¼Œå¦åˆ™ä¼šé€ æˆ Vuex è°ƒè¯•å·¥å…·å·¥ä½œä¸å‡†ç¡®ï¼Œå¿…é¡»æŠŠè¿™äº›ä»£ç å†™åœ¨ actions æ–¹æ³•ä¸­\r\n\r\n```js\r\nimport Vue from 'vue'\r\nimport Vuex from 'vuex'\r\n\r\nVue.use(Vuex)\r\n\r\n/*\r\n  è¯»å–æ•°æ®ï¼Œèµ° state, getters\r\n  ä¿®æ”¹æ•°æ®ï¼Œèµ° mutations, actions\r\n*/\r\nimport axios from '@/util/myaxios'\r\nexport default new Vuex.Store({\r\n  state: {\r\n    name: '',\r\n    age: 18\r\n  },\r\n  getters: {\r\n  },\r\n  mutations: {\r\n    updateName(state, name) {\r\n      state.name = name;\r\n    },\r\n    // é”™è¯¯çš„ç”¨æ³•ï¼Œå¦‚æœåœ¨mutationsæ–¹æ³•ä¸­åŒ…å«äº†å¼‚æ­¥æ“ä½œï¼Œä¼šé€ æˆå¼€å‘å·¥å…·ä¸å‡†ç¡®\r\n    /* async updateServerName(state) {\r\n      const resp = await axios.get('/api/user');\r\n      const {name, age} = resp.data.data;\r\n      state.name = name;\r\n      state.age = age;\r\n    } */\r\n    updateServerName(state, user) {\r\n      const { name, age } = user;\r\n      state.name = name;\r\n      state.age = age;\r\n    }\r\n  },\r\n  actions: {\r\n    async updateServerName(context) {\r\n      const resp = await axios.get('/api/user');\r\n      context.commit('updateServerName', resp.data.data)\r\n    }\r\n  },\r\n  modules: {\r\n  }\r\n})\r\n```\r\n\r\n* é¦–å…ˆåº”å½“è°ƒç”¨ actions çš„ updateServerName è·å–æ•°æ®\r\n* ç„¶åå†ç”±å®ƒé—´æ¥è°ƒç”¨ mutations çš„ updateServerName æ›´æ–°å…±äº«æ•°æ®\r\n\r\né¡µé¢ä½¿ç”¨ actions çš„æ–¹æ³•å¯ä»¥è¿™ä¹ˆå†™\r\n\r\n```vue\r\n<template>\r\n    <div class=\"p\">\r\n        <el-button type=\"primary\" size=\"mini\"\r\n            @click=\"updateServerName()\">ä»æœåŠ¡å™¨è·å–æ•°æ®,å­˜å…¥store</el-button>\r\n    </div>\r\n</template>\r\n<script>\r\nimport { mapActions } from 'vuex'\r\nconst options = {\r\n    methods: {\r\n        ...mapActions(['updateServerName'])\r\n    }\r\n}\r\nexport default options;\r\n</script>\r\n```\r\n\r\n* mapActions ä¼šç”Ÿæˆè°ƒç”¨ actions ä¸­æ–¹æ³•çš„ä»£ç \r\n\r\n* è°ƒç”¨ actions çš„ä»£ç å†…éƒ¨ç­‰ä»·äºï¼Œå®ƒè¿”å›çš„æ˜¯ Promise å¯¹è±¡ï¼Œå¯ä»¥ç”¨åŒæ­¥æˆ–å¼‚æ­¥æ–¹å¼æ¥æ”¶ç»“æœ\r\n\r\n  ```js\r\n  this.$store.dispatch('actionåç§°', å‚æ•°)\r\n  ```\r\n\r\n  \r\n\r\n\r\n\r\n## 3. Vue å®æˆ˜\r\n\r\nè¯¾ç¨‹ä¸å‡†å¤‡ä»å¤´å¼€å‘ä¸€ä¸ª Vue é¡¹ç›®ï¼Œè¿™é‡Œæˆ‘å‡†å¤‡é‡‡ç”¨è¿™æ ·çš„æ•™å­¦æ–¹æ³•ï¼šå¸¦ç€å¤§å®¶çœ‹ä¸€ä¸ªè¾ƒä¸ºå…¸å‹çš„åŸºäº Vue çš„é¡¹ç›®å®ç°ï¼Œåˆ†æå…¶ä¸­å‡ ä¸ªé‡ç‚¹æµç¨‹\r\n\r\nè¿™é‡Œé€‰æ‹©äº† vue-element-admin è¿™ä¸ªé¡¹ç›®éª¨æ¶ï¼Œå®ƒé‡‡ç”¨çš„æŠ€æœ¯ä¸æˆ‘ä»¬ä¹‹å‰å­¦è¿‡çš„è¾ƒä¸ºå¥‘åˆ\r\n\r\n* vue 2\r\n* element-ui 2\r\n* vue-router 3\r\n* vuex 3\r\n* axios\r\n\r\n\r\n\r\n### å®‰è£…\r\n\r\n```cmd\r\ngit clone https://gitee.com/panjiachen/vue-element-admin.git client-action\r\n\r\ncd client-action\r\n\r\ngit branch -a\r\n\r\ngit checkout -b i18n remotes/origin/i18n\r\n\r\ngit config --global url.\"https://\".insteadOf git://\r\n\r\nnpm install\r\n\r\nnpm run dev\r\n```\r\n\r\n* éœ€è¦åˆ‡æ¢åˆ†æ”¯åˆ° i18nï¼Œå¦åˆ™ä¸æ”¯æŒå›½é™…åŒ–ï¼ˆä¸­æ–‡ï¼‰åŠŸèƒ½\r\n* npm install è¦å¤šè¯•å‡ æ¬¡ï¼Œå› ä¸ºä¸­é—´ä¼šè¿æ¥ gitbub ä¸‹è½½ä¸€äº›ä¾èµ–ï¼Œç½‘ç»œä¸ç¨³å®šä¼šå¯¼è‡´å¤±è´¥\r\n* npm run dev è¿è¡Œåå›è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œä½¿ç”¨çš„ç«¯å£æ˜¯ 9527\r\n\r\n\r\n\r\n### åç«¯è·¯å¾„\r\n\r\nå¼€å‘ç¯å¢ƒä¸‹æ‰§è¡Œä¸‹é¢å‘½ä»¤\r\n\r\n```\r\nnpm run dev\r\n```\r\n\r\n* ä¼šåŒæ—¶å¯åŠ¨ mock-server\r\n\r\nåœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œåç«¯è®¿é—®è·¯å¾„èµ·å§‹è·¯å¾„é…ç½®åœ¨æ–‡ä»¶ `.env.development` ä¸­\r\n\r\n```properties\r\nVUE_APP_BASE_API = '/dev-api'\r\n```\r\n\r\n* é»˜è®¤å‘åå°çš„è¯·æ±‚éƒ½å‘ç»™ `http://localhost:9527/dev-api` çš„ mock-server è·å¾—çš„éƒ½æ˜¯æ¨¡æ‹Ÿæ•°æ®\r\n* éœ€è¦è·ŸçœŸå®åå°è”è°ƒæ—¶ï¼Œå¯ä»¥æ”¹åŠ¨ä»¥ä¸Šåœ°å€ä¸º `VUE_APP_BASE_API = 'http://localhost:8080/api'`\r\n\r\nå‘é€è¯·æ±‚çš„ axios å·¥å…·è¢«å°è£…åœ¨ src/utils/request.js ä¸­\r\n\r\n```js\r\nimport axios from 'axios'\r\nimport { MessageBox, Message } from 'element-ui'\r\nimport store from '@/store'\r\nimport { getToken } from '@/utils/auth'\r\n\r\n// create an axios instance\r\nconst service = axios.create({\r\n  baseURL: process.env.VUE_APP_BASE_API, // url = base url + request url\r\n  // withCredentials: true, // send cookies when cross-domain requests\r\n  timeout: 5000 // request timeout\r\n})\r\n\r\n// ...\r\n```\r\n\r\nåŸæœ‰ä»£ç çš„ URI è·¯å¾„éƒ½æ˜¯è¿™æ ·çš„ï¼š\r\n\r\n```\r\n/vue-element-admin/user/login\r\n/vue-element-admin/user/info\r\n/vue-element-admin/user/logout\r\n...\r\n```\r\n\r\nå¦‚æœè§‰å¾—ä¸çˆ½ï¼Œå¯ä»¥æ¥ä¸€ä¸ªå…¨å±€æ›¿æ¢\r\n\r\n```\r\n/user/login\r\n/user/info\r\n/user/logout\r\n...\r\n```\r\n\r\ntoken çš„è¯·æ±‚å¤´ä¿®æ”¹ä¸€ä¸‹ï¼Œåœ¨ src/utils/request.js ä¸­\r\n\r\n```js\r\n...\r\nservice.interceptors.request.use(\r\n  config => {\r\n    // do something before request is sent\r\n\r\n    if (store.getters.token) {\r\n      // let each request carry token\r\n      // ['X-Token'] is a custom headers key\r\n      // please modify it according to the actual situation\r\n      config.headers['Authorization'] = getToken()\r\n    }\r\n    return config\r\n  },\r\n  error => {\r\n    // do something with request error\r\n    console.log(error) // for debug\r\n    return Promise.reject(error)\r\n  }\r\n)\r\n...\r\n```\r\n\r\n\r\n\r\n### ç™»å½•æµç¨‹\r\n\r\n#### 1. `src/views/login/index.vue`\r\n\r\n```vue\r\n<script>\r\nimport { validUsername } from '@/utils/validate'\r\nimport LangSelect from '@/components/LangSelect'\r\nimport SocialSign from './components/SocialSignin'\r\n\r\nexport default {\r\n  // ...\r\n  methods: {    \r\n    handleLogin() {\r\n      this.$refs.loginForm.validate(valid => {\r\n        if (valid) {\r\n          this.loading = true\r\n          this.$store.dispatch('user/login', this.loginForm)\r\n            .then(() => {\r\n              this.$router.push({ path: this.redirect || '/', query: this.otherQuery })\r\n              this.loading = false\r\n            })\r\n            .catch(() => {\r\n              this.loading = false\r\n            })\r\n        } else {\r\n          console.log('error submit!!')\r\n          return false\r\n        }\r\n      })\r\n    }\r\n    // ...\r\n  }\r\n}\r\n</script>\r\n```\r\n\r\nè¿™é‡Œè°ƒç”¨äº† store çš„ actionsï¼Œ`user/login`\r\n\r\n* å› ä¸ºæ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œå› æ­¤åªèƒ½ç”¨ actions\r\n* ç™»å½•æˆåŠŸä¼šä¼˜å…ˆè·³è½¬è‡³ this.redirect è·¯å¾„ã€å¦åˆ™è·³è½¬è‡³ /\r\n* / æŸ¥çœ‹ `src/router/index.js` çš„è·¯ç”±è¡¨å¯çŸ¥ï¼Œä¼šé‡å®šå‘è‡³ /dashboard\r\n\r\n\r\n\r\n#### 2. `src/store/modules/user.js`\r\n\r\n```js\r\nimport { login, logout, getInfo } from '@/api/user'\r\n// ...\r\nconst actions = {\r\n  // user login\r\n  login({ commit }, userInfo) {\r\n    const { username, password } = userInfo\r\n    return new Promise((resolve, reject) => {\r\n      login({ username: username.trim(), password: password }).then(response => {\r\n        const { data } = response\r\n        commit('SET_TOKEN', data.token)\r\n        setToken(data.token)\r\n        resolve()\r\n      }).catch(error => {\r\n        reject(error)\r\n      })\r\n    })\r\n  }\r\n  // ...\r\n}\r\n```\r\n\r\n* å‘è¯·æ±‚ç”¨äº† `src/api/user.js`ï¼Œè¯·æ±‚æˆåŠŸä½¿ç”¨ commit å°† token å­˜å…¥ mutationsï¼ŒåŒæ—¶å¾€ cookie å­˜å‚¨äº†ä¸€ä»½\r\n* è¿™é‡Œçš„ response å…¶å®æ˜¯çœŸæ­£çš„ response.dataï¼Œè§åé¢çš„è¯´æ˜\r\n* è¯„ä»·\r\n  * å‘ cookie æˆ– sessionStorage å­˜å‚¨ token å³å¯ï¼Œtoken æ— éœ€åšæˆå“åº”å¼ï¼Œä¸å¿…æ”¾å…¥ store\r\n  * ä½œè€…ä½¿ç”¨äº† Promise APIï¼Œå…¶å®å¯ä»¥æ”¹å˜ä¸º await æ–¹å¼ï¼Œæé«˜å¯è¯»æ€§\r\n\r\n\r\n\r\n#### 3. `src/api/user.js`\r\n\r\n```js\r\nimport request from '@/utils/request'\r\n\r\nexport function login(data) {\r\n  return request({\r\n    url: '/user/login',\r\n    method: 'post',\r\n    data\r\n  })\r\n}\r\n\r\n// ...\r\n```\r\n\r\n* å…¶ä¸­ request ç›¸å½“äºæˆ‘ä»¬ä¹‹å‰å°è£…çš„ myaxios\r\n\r\n\r\n\r\n#### 4. `src/utils/request.js`\r\n\r\n```js\r\nimport axios from 'axios'\r\nimport { MessageBox, Message } from 'element-ui'\r\nimport store from '@/store'\r\nimport { getToken } from '@/utils/auth'\r\n\r\n// create an axios instance\r\nconst service = axios.create({\r\n  baseURL: process.env.VUE_APP_BASE_API, // url = base url + request url\r\n  // withCredentials: true, // send cookies when cross-domain requests\r\n  timeout: 5000 // request timeout\r\n})\r\n\r\n// ... \r\n\r\nservice.interceptors.response.use(\r\n  // ...\r\n  response => {\r\n    const res = response.data\r\n    if (res.code !== 20000) {\r\n      // ...\r\n    } else {\r\n      return res\r\n    }\r\n  },\r\n  error => {\r\n    // ...\r\n  }\r\n)\r\n\r\nexport default service\r\n```\r\n\r\n* å…¶ä¸­å“åº”æ‹¦æˆªå™¨å‘ç°å“åº”æ­£ç¡®ï¼Œè¿”å› resp.data è¿™æ ·ï¼Œå…¶å®ƒå¤„ä»£ç è§£æ„æ—¶å°‘äº†ä¸€å±‚ data\r\n\r\n\r\n\r\n#### 5. `src/permission.js`\r\n\r\nç™»å½•æˆåŠŸåï¼Œåªæ˜¯è·å¾—äº† tokenï¼Œè¿˜æœªè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯æ˜¯åœ¨è·¯ç”±è·³è½¬çš„ beforeEach é‡Œåšçš„\r\n\r\n```mermaid\r\nsequenceDiagram \r\n\r\nparticipant c as ç™»å½•é¡µ\r\nparticipant r as Router\r\nparticipant s as Store\r\nparticipant t as Tomcat\r\n\r\nrect rgba(255,0,0,0.2)\r\nc ->> +s: login(username,password)\r\ns ->> +t: login(username,password)\r\nt -->> -s: token\r\ns ->> s: å­˜å‚¨ token\r\ns -->> -c: \r\nend\r\n\r\nrect rgba(0,255,0,0.2)\r\nc ->> +r: è·³è½¬è‡³ /\r\nr ->> +s: beforeEach getInfo(token)\r\ns ->> +t: getInfo(token)\r\nt -->> -s: name,avatar,rolesç­‰\r\ns ->> s: å­˜å‚¨ç”¨æˆ·ä¿¡æ¯\r\ns -->> -r: \r\nr ->> r: æ ¹æ®rolesåŠ¨æ€ç”Ÿæˆè·¯ç”±\r\nr -->> -c: \r\nend\r\n\r\n```\r\n\r\nå…³é”®ä»£ç \r\n\r\n```js\r\nimport router from './router'\r\n\r\n// ...\r\n\r\nrouter.beforeEach(async(to, from, next) => {\r\n  // ...\r\n  const hasToken = getToken()\r\n\r\n  if (hasToken) {\r\n    if (to.path === '/login') {\r\n      // ...\r\n    } else {\r\n      // ...\r\n      const { roles } = await store.dispatch('user/getInfo')\r\n      // ...\r\n    }\r\n  } else {\r\n    // ...\r\n  }\r\n})\r\n```\r\n\r\n* ç™»å½•åè·³è½¬è‡³ / ä¹‹å‰è¿›å…¥è¿™é‡Œçš„ beforeEach æ–¹æ³•ï¼Œæ–¹æ³•å†…ä¸»è¦åšä¸¤ä»¶äº‹\r\n  * ä¸€æ˜¯è°ƒç”¨ actions æ–¹æ³•è·å–ç”¨æˆ·è§’è‰²ï¼Œè§ 6\r\n  * äºŒæ˜¯æ ¹æ®ç”¨æˆ·è§’è‰²ï¼ŒåŠ¨æ€ç”Ÿæˆè·¯ç”±ï¼Œè§ 7\r\n\r\n\r\n\r\n\r\n#### 6. `src/store/modules/user.js`\r\n\r\nè¿™é‡Œç”¨å…¶ä¸­ getInfo æ–¹æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå…¶ä¸­è§’è‰²è¿”å›ç»™ beforeEach \r\n\r\n```js\r\nimport { login, logout, getInfo } from '@/api/user'\r\n// ...\r\nconst actions = {\r\n  getInfo({ commit, state }) {\r\n    return new Promise((resolve, reject) => {\r\n      getInfo(state.token).then(response => {\r\n        const { data } = response\r\n\r\n        if (!data) {\r\n          reject('Verification failed, please Login again.')\r\n        }\r\n\r\n        const { roles, name, avatar, introduction } = data\r\n\r\n        if (!roles || roles.length <= 0) {\r\n          reject('getInfo: roles must be a non-null array!')\r\n        }\r\n\r\n        commit('SET_ROLES', roles)\r\n        commit('SET_NAME', name)\r\n        commit('SET_AVATAR', avatar)\r\n        commit('SET_INTRODUCTION', introduction)\r\n        resolve(data)\r\n      }).catch(error => {\r\n        reject(error)\r\n      })\r\n    })\r\n  }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n\r\n#### 7. `src/router/index.js`\r\n\r\nè·¯ç”±è¡¨ä¸­è·¯ç”±åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œé™æ€è·¯ç”±ä¸åŠ¨æ€è·¯ç”±\r\n\r\n```js\r\nexport const constantRoutes = [\r\n  // ...\r\n  {\r\n    path: '/login',\r\n    component: () => import('@/views/login/index'),\r\n    hidden: true\r\n  },\r\n  {\r\n    path: '/',\r\n    component: Layout,\r\n    redirect: '/dashboard',\r\n    children: [\r\n      {\r\n        path: 'dashboard',\r\n        component: () => import('@/views/dashboard/index'),\r\n        name: 'Dashboard',\r\n        meta: { title: 'dashboard', icon: 'dashboard', affix: true }\r\n      }\r\n    ]\r\n  }\r\n  // ...\r\n]\r\n```\r\n\r\n* å…¶ä¸­ hidden: true çš„è·¯ç”±åªåšè·¯ç”±è·³è½¬ï¼Œä¸ä¼šåœ¨å·¦ä¾§å¯¼èˆªèœå•å±•ç¤º\r\n\r\nåŠ¨æ€è·¯ç”±\r\n\r\n```js\r\nexport const asyncRoutes = [\r\n  {\r\n    path: '/permission',\r\n    component: Layout,\r\n    redirect: '/permission/page',\r\n    alwaysShow: true, // will always show the root menu\r\n    name: 'Permission',\r\n    meta: {\r\n      title: 'permission',\r\n      icon: 'lock',\r\n      roles: ['admin', 'editor'] // you can set roles in root nav\r\n    },\r\n    children: [\r\n      {\r\n        path: 'page',\r\n        component: () => import('@/views/permission/page'),\r\n        name: 'PagePermission',\r\n        meta: {\r\n          title: 'pagePermission',\r\n          roles: ['admin'] // or you can only set roles in sub nav\r\n        }\r\n      },\r\n      {\r\n        path: 'directive',\r\n        component: () => import('@/views/permission/directive'),\r\n        name: 'DirectivePermission',\r\n        meta: {\r\n          title: 'directivePermission'\r\n          // if do not set roles, means: this page does not require permission\r\n        }\r\n      },\r\n      {\r\n        path: 'role',\r\n        component: () => import('@/views/permission/role'),\r\n        name: 'RolePermission',\r\n        meta: {\r\n          title: 'rolePermission',\r\n          roles: ['admin']\r\n        }\r\n      }\r\n    ]\r\n  },\r\n\r\n  {\r\n    path: '/icon',\r\n    component: Layout,\r\n    children: [\r\n      {\r\n        path: 'index',\r\n        component: () => import('@/views/icons/index'),\r\n        name: 'Icons',\r\n        meta: { title: 'icons', icon: 'icon', noCache: true, roles: ['admin'] }\r\n      }\r\n    ]\r\n  }\r\n  // ...\r\n}\r\n```\r\n\r\n* åŠ¨æ€è·¯ç”±ä¸­å…³è”äº†è§’è‰²ä¿¡æ¯ï¼Œæ ¹æ®ç”¨æˆ·çš„è§’è‰²å†³å®šé‚£äº›è·¯ç”±å¯ç”¨ï¼Œä½†è¿™æ ·åšçš„ç¼ºç‚¹æ˜¯æŠŠè§’è‰²å’Œè·¯ç”±ç»‘å®šæ­»äº†\r\n\r\n\r\n\r\n#### 8. `src/layout/index.vue`\r\n\r\nå®ƒå¯¹åº”çš„æ˜¯æˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„ Container.vue å®Œæˆä¸»é¡µå¸ƒå±€çš„ï¼Œè·¯ç”±è·¯å¾„æ˜¯ /\r\n\r\n![image-20220827194047788](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220827194047788.png)\r\n\r\nå…¶ä¸­åˆç”±å¤šéƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­å›ºå®šä¸å˜çš„æ˜¯\r\n\r\n* ä¾§è¾¹æ \r\n* å¯¼èˆªæ \r\n* æ ‡ç­¾æ \r\n* è®¾ç½®\r\n\r\nå˜åŒ–çš„æ˜¯ä¸­é—´çš„ dashboard éƒ¨åˆ†ï¼ˆAppMainï¼‰ï¼Œå®ƒç”± router-view é…åˆå­è·¯ç”±åˆ‡æ¢æ˜¾ç¤º\r\n\r\n* è¿›å…¥ / åï¼Œå°±ä¼š redirect é‡å®šå‘åˆ° /dashboard å­è·¯ç”±\r\n* è¿›å…¥é¦–é¡µåï¼Œä¼šæœ‰ä¸€ä¸ª `/api/transaction/list` çš„åå°è¯·æ±‚æŠ¥ 404ï¼Œä½œä¸ºç»ƒä¹ ï¼ŒæŠŠå®ƒè¡¥å……å®Œæ•´\r\n\r\n\r\n\r\n### ç¬¬ä¸‰æ–¹ç™»å½•\r\n\r\n```mermaid\r\nsequenceDiagram\r\nparticipant a7 as å‰ç«¯(9527)\r\nparticipant a8 as åç«¯(8080)\r\nparticipant g as gitee\r\n\r\nrect rgba(0,255,0,0.2) \r\na7 ->> +g: æ‰“å¼€æ–°çª—å£, è¯·æ±‚ /oauth/authorize\r\ng ->> g: è®¤è¯é€šè¿‡\r\nend\r\nrect rgba(255,0,0,0.2)\r\ng ->> -a8: é‡å®šå‘ redirect uri\r\nend\r\nrect rgba(0,255,0,0.2)\r\na8 ->> +g: è¯·æ±‚ /oauth/token\r\ng ->> -a8: è¿”å› access_token(gitee)\r\nend\r\nrect rgba(0,255,0,0.2)\r\na8 ->> +g: è¯·æ±‚ /api/v5/user\r\ng -->> -a8: \r\nend\r\na8 ->> 8: ç”Ÿæˆ token(8080)\r\nrect rgba(0,0,255,0.2)\r\na8 ->> +a7: æ–°çª—å£å°† token(8080) å‘é€ç»™è€çª—å£(9527)\r\nend\r\n```\r\n\r\n1. 9527 æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ±‚ `https://gitee.com/oauth/authorize?client_id=${client_id}&redirect_uri=${redirect_uri}&response_type=code`\r\n\r\n2. gitee è®¤è¯é€šè¿‡ï¼Œé‡å®šå‘è‡³ 8080ï¼Œå¹¶æºå¸¦ code\r\n\r\n3. 8080 å‘é€è¯·æ±‚ `https://gitee.com/oauth/token` æºå¸¦ client_idã€client_secretã€codeï¼Œgitee è¿”å› access_token ç»™ 8080\r\n\r\n   * è¿™æ—¶èµ°çš„æ˜¯ https åè®®ï¼Œå¹¶ä¸”ä¸ç»è¿‡æµè§ˆå™¨ï¼Œèƒ½å¤Ÿä¿è¯æ•°æ®ä¼ è¾“çš„å®‰å…¨æ€§\r\n\r\n   * é‡å®šå‘åˆ° 8080 æ—¶ï¼Œå¦‚æœè¢«æœ‰å¿ƒäººæ‹¿åˆ°äº† codeï¼Œä¹Ÿæ²¡äº‹ï¼Œå› ä¸ºæ¥ä¸‹æ¥ä¼šæŠŠ client_secret å‘ç»™ gitee éªŒè¯ï¼ˆclient_secret åº”å½“åªå­˜åœ¨ 8080ï¼‰ï¼Œåªè¦ client_secret ä¸æ³„éœ²ï¼Œå°±å¯ä»¥ä¿è¯å®‰å…¨\r\n\r\n   * å¦‚æœæ”¹æˆå‰ç«¯æ‹¿ code æ¢ access_tokenï¼Œé‚£å°±æ„å‘³ç€ access_token å¾—ä¿å­˜åœ¨å‰ç«¯ï¼Œæ‰€æœ‰ä¿å­˜åœ¨å‰ç«¯çš„éƒ½æœ‰é£é™©\r\n\r\n4. 8080 å¯ä»¥è®¿é—® gitee çš„ api äº†ï¼Œæ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå­˜å…¥æ•°æ®åº“ï¼Œè¿”å› 8080 çš„ token\r\n\r\n5. 8080 å¯ä»¥é€šè¿‡ window.opener.postMessage æŠŠ token ç»™ 9527 çš„è€çª—å£\r\n\r\n   * è¿™é‡Œåˆä¼šæ¶‰åŠåˆ°è·¨åŸŸï¼Œä¸è¿‡ 9527 ä¸ 8080 ç›´æ¥å­˜åœ¨ä¿¡ä»»å…³ç³»ï¼Œè®¾ç½®ä¸€ä¸‹å°±å¥½\r\n\r\n6. 9527 å†èµ°ä¹‹å‰çš„é€»è¾‘å°±å¯ä»¥äº†ï¼Œåœ¨ router çš„ beforeEach æ–¹æ³•é‡Œï¼Œç”¨ 8080 token æ¢ç”¨æˆ·ä¿¡æ¯\r\n\r\n\r\n\r\n### å¢åˆ æ”¹æŸ¥\r\n\r\né¦–å…ˆï¼Œåœ¨ api é‡Œæ·»åŠ ä¸åç«¯äº¤äº’çš„ä»£ç ï¼š`src/api/student.js`\r\n\r\n```js\r\nimport axios from '@/utils/request'\r\n\r\nexport function all() {\r\n  return axios({\r\n    url: '/students',\r\n    method: 'get'\r\n  })\r\n}\r\n\r\nexport function deleteById(id) {\r\n  return axios({\r\n    url: `/students/${id}`,\r\n    method: 'delete'\r\n  })\r\n}\r\n\r\nexport function update(id, dto) {\r\n  return axios({\r\n    url: `/students/${id}`,\r\n    method: 'put',\r\n    data: dto\r\n  })\r\n}\r\n\r\nexport function insert(dto) {\r\n  return axios({\r\n    url: `/students`,\r\n    method: 'post',\r\n    data: dto\r\n  })\r\n}\r\n```\r\n\r\nç„¶åï¼Œæ·»åŠ æ–°çš„è·¯ç”±ï¼š`src/router/index.js`\r\n\r\n```js\r\nexport const asyncRoutes = [\r\n  // ...\r\n  {\r\n    path: '/student',\r\n    component: Layout,\r\n    children: [\r\n      {\r\n        path: 'index',\r\n        component: () => import('@/views/student/index'),\r\n        meta: { title: 'å­¦ç”Ÿç®¡ç†', icon: 'el-icon-s-help', roles: ['admin'] }\r\n      }\r\n    ]\r\n  },\r\n  // ...\r\n]\r\n```\r\n\r\n* æ³¨æ„ title è¿™é‡Œæ²¡æœ‰è€ƒè™‘å›½é™…åŒ–\r\n\r\næœ€åï¼Œæ·»åŠ æ–°çš„è§†å›¾ç•Œé¢ï¼š`src/views/student/index.vue`\r\n\r\n```vue\r\n<template>\r\n  <div>\r\n    <el-table :data=\"students\">\r\n      <el-table-column label=\"ç¼–å·\" prop=\"id\"></el-table-column>\r\n      <el-table-column label=\"å§“å\" prop=\"name\"></el-table-column>\r\n      <el-table-column label=\"æ€§åˆ«\" prop=\"sex\"></el-table-column>\r\n      <el-table-column label=\"å¹´é¾„\" prop=\"age\"></el-table-column>\r\n      <el-table-column fixed=\"right\" label=\"æ“ä½œ\" width=\"100\">\r\n        <template slot-scope=\"scope\">\r\n          <el-button @click=\"handleUpdate(scope.row)\" type=\"text\" size=\"small\">ä¿®æ”¹</el-button>\r\n          <el-button @click=\"handleDelete(scope.row)\" type=\"text\" size=\"small\">åˆ é™¤</el-button>\r\n        </template>\r\n      </el-table-column>\r\n    </el-table>\r\n\r\n    <el-dialog width=\"22%\" :visible.sync=\"updateDialogVisible\">\r\n      <el-form :model=\"updateForm\">\r\n        <el-form-item label=\"ç¼–å·\">\r\n          <el-input size=\"mini\" :readonly=\"true\" v-model=\"updateForm.id\"></el-input>\r\n        </el-form-item>\r\n        <el-form-item label=\"å§“å\">\r\n          <el-input size=\"mini\" v-model=\"updateForm.name\"></el-input>\r\n        </el-form-item>\r\n        <el-form-item label=\"æ€§åˆ«\">\r\n          <el-select size=\"mini\" v-model=\"updateForm.sex\">\r\n            <el-option value=\"ç”·\"></el-option>\r\n            <el-option value=\"å¥³\"></el-option>\r\n          </el-select>\r\n        </el-form-item>\r\n        <el-form-item label=\"å¹´é¾„\">\r\n          <el-input size=\"mini\" v-model=\"updateForm.age\"></el-input>\r\n        </el-form-item>\r\n        <el-form-item>\r\n          <el-button type=\"primary\" size=\"mini\" @click=\"confirmUpdate()\">ç¡®å®š</el-button>\r\n        </el-form-item>\r\n      </el-form>\r\n    </el-dialog>\r\n  </div>\r\n</template>\r\n<script>\r\nimport { all, deleteById, update, insert } from '@/api/student'\r\nconst options = {\r\n  mounted() {\r\n    this.all()\r\n  },\r\n  data() {\r\n    return {\r\n      students: [],\r\n      updateDialogVisible: false,\r\n      updateForm: {\r\n        id: 0,\r\n        name: '',\r\n        sex: 'ç”·',\r\n        age: 0\r\n      }\r\n    }\r\n  },\r\n  methods: {\r\n    async confirmUpdate() {\r\n      await update(this.updateForm.id, this.updateForm)\r\n      this.updateDialogVisible = false\r\n      this.all()\r\n    },\r\n    handleUpdate(row) { // {id, name, sex, age}\r\n      this.updateDialogVisible = true\r\n      this.updateForm = { ...row }\r\n      // this.updateForm = row // é”™è¯¯å†™æ³•ï¼Œä¸èƒ½è®©ä»–ä¿©æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡\r\n    },\r\n    async handleDelete(row) {\r\n      try {\r\n        await this.$confirm('æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥å­¦ç”Ÿ, æ˜¯å¦ç»§ç»­?', 'æç¤º', {\r\n          confirmButtonText: 'ç¡®å®š',\r\n          cancelButtonText: 'å–æ¶ˆ',\r\n          type: 'warning'\r\n        })\r\n        await deleteById(row.id)\r\n        this.all()\r\n      } catch (e) {\r\n        console.log('å–æ¶ˆåˆ é™¤')\r\n      }\r\n    },\r\n    async all() {\r\n      const { data } = await all()\r\n      this.students = data\r\n    }\r\n  }\r\n}\r\nexport default options\r\n</script>\r\n<style scoped>\r\n.el-input,\r\n.el-select {\r\n  width: 180px;\r\n}\r\n</style>\r\n```\r\n\r\n* å…¶ä¸­ handleUpdate å’Œ handleDelete æ¥æ”¶çš„å‚æ•°ï¼Œéƒ½æ˜¯ä»£è¡¨äº†å½“å‰è¡Œçš„å­¦ç”Ÿå¯¹è±¡"},{"title":"ç¬¬å››ç« . åç«¯ä¹‹äºå‰ç«¯ - Vue3","tags":["Vue3"],"categories":["å‰ç«¯"],"author":"imklaus","excerpt":"\r\n\r\n\r\n## 1. TypeScript\r\n\r\n### 1) åŠ¨æ€ç±»å‹çš„é—®é¢˜\r\n\r\nå‰é¢æˆ‘ä»¬è®²è¿‡ js å±äºåŠ¨æ€ç±»å‹è¯­è¨€ï¼Œä¾‹å¦‚\r\n\r\n```js\r\nfunction test(obj) {    ","link":"/posts/Vue3","content":"\r\n\r\n\r\n## 1. TypeScript\r\n\r\n### 1) åŠ¨æ€ç±»å‹çš„é—®é¢˜\r\n\r\nå‰é¢æˆ‘ä»¬è®²è¿‡ js å±äºåŠ¨æ€ç±»å‹è¯­è¨€ï¼Œä¾‹å¦‚\r\n\r\n```js\r\nfunction test(obj) {    \r\n}\r\n```\r\n\r\nobj å¯èƒ½åªæ˜¯ä¸ªå­—ç¬¦ä¸²\r\n\r\n```js\r\ntest('hello, world')\r\n```\r\n\r\nobj ä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸ªå‡½æ•°\r\n\r\n```js\r\ntest(()=>console.log('hello, world'))\r\n```\r\n\r\nobj ç±»å‹ä¸ç¡®å®šï¼Œå°±ç»™åæœŸä½¿ç”¨è€…å¸¦æ¥äº†éº»çƒ¦ï¼Œä¸€æ—¦å‚æ•°ä¼ ä¸å¯¹ï¼Œä»£ç å°±å´©æºƒäº†\r\n\r\n\r\n\r\nåŠ¨æ€ç±»å‹æ„å‘³ç€\r\n\r\n* è¿è¡Œä»£ç æ—¶æ‰çŸ¥é“å‘ç”Ÿä»€ä¹ˆ (running the code to see what happens)\r\n\r\né™æ€ç±»å‹æ„å‘³ç€\r\n\r\n* åœ¨ä»£ç è¿è¡Œå‰ï¼Œå°±å¯¹å®ƒçš„è¡Œä¸ºåšå‡ºé¢„æµ‹ (make predications about what code is expected before it runs)\r\n\r\n\r\n\r\nä¸‹é¢çš„ typescript ä»£ç ï¼Œå°±åœ¨ä»£ç è¿è¡Œå‰å¯¹å‚æ•°åŠ å…¥äº†çº¦æŸé™åˆ¶\r\n\r\n```typescript\r\nfunction test(msg : string) {\r\n}\r\n```\r\n\r\n* é™åˆ¶äº†å‚æ•°åªèƒ½åš string é‚£äº›äº‹\r\n\r\n```typescript\r\nfunction test(msg : Function) {\r\n  msg()\r\n}\r\n```\r\n\r\n* é™åˆ¶äº†å‚æ•°åªèƒ½åšå‡½æ•°é‚£äº›äº‹\r\n\r\n\r\n\r\n### 2) å…¥é—¨\r\n\r\nå®‰è£… typescript ç¼–è¯‘å™¨\r\n\r\n```cmd\r\nnpm install -g typescript\r\n```\r\n\r\nç¼–å†™ ts ä»£ç \r\n\r\n```typescript\r\nfunction hello(msg: string) {\r\n  console.log(msg)\r\n}\r\n\r\nhello('hello,world')\r\n```\r\n\r\næ‰§è¡Œ tsc ç¼–è¯‘å‘½ä»¤\r\n\r\n```cmd\r\ntsc xxx.ts\r\n```\r\n\r\nç¼–è¯‘ç”Ÿæˆ js ä»£ç ï¼Œç¼–è¯‘åè¿›è¡Œäº†ç±»å‹æ“¦é™¤\r\n\r\n```js\r\nfunction hello(msg) {\r\n    console.log(msg);\r\n}\r\nhello('hello,world');\r\n```\r\n\r\n\r\n\r\nå†æ¥ä¸€ä¸ªä¾‹å­ï¼Œç”¨ interface å®šä¹‰ç”¨æˆ·ç±»å‹\r\n\r\n```ts\r\ninterface User {\r\n  name: string,\r\n  age: number\r\n}\r\n\r\nfunction test(u: User): void {\r\n  console.log(u.name)\r\n  console.log(u.age)\r\n}\r\n\r\ntest({ name: 'zhangs', age: 18 })\r\n```\r\n\r\nç¼–è¯‘å\r\n\r\n```js\r\nfunction test(u) {\r\n    console.log(u.name);\r\n    console.log(u.age);\r\n}\r\ntest({ name: 'zhangs', age: 18 });\r\n```\r\n\r\n\r\n\r\nå¯è§ï¼Œtypescript å±äºç¼–è¯‘æ—¶å®æ–½ç±»å‹æ£€æŸ¥ï¼ˆé™æ€ç±»å‹ï¼‰çš„æŠ€æœ¯\r\n\r\n\r\n\r\n### 3) ç±»å‹\r\n\r\n| ç±»å‹        | ä¾‹                                    | å¤‡æ³¨                         |\r\n| ----------- | ------------------------------------- | ---------------------------- |\r\n| å­—ç¬¦ä¸²ç±»å‹  | string                                |                              |\r\n| æ•°å­—ç±»å‹    | number                                |                              |\r\n| å¸ƒå°”ç±»å‹    | boolean                               |                              |\r\n| æ•°ç»„ç±»å‹    | number[],string[], boolean[] ä¾æ­¤ç±»æ¨ |                              |\r\n| ä»»æ„ç±»å‹    | any                                   | ç›¸å½“äºåˆå›åˆ°äº†æ²¡æœ‰ç±»å‹çš„æ—¶ä»£ |\r\n| å¤æ‚ç±»å‹    | type ä¸ interface                     |                              |\r\n| å‡½æ•°ç±»å‹    | () => void                            | å¯¹å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼è¿›è¡Œè¯´æ˜ |\r\n| å­—é¢é‡ç±»å‹  | \"a\"\\|\"b\"\\|\"c\"                         | é™åˆ¶å˜é‡æˆ–å‚æ•°çš„å–å€¼         |\r\n| nullishç±»å‹ | null ä¸ undefined                     |                              |\r\n| æ³›å‹        | `<T>`ï¼Œ`<T extends çˆ¶ç±»å‹>`           |                              |\r\n\r\n\r\n\r\n#### æ ‡æ³¨ä½ç½®\r\n\r\n##### æ ‡æ³¨å˜é‡\r\n\r\n```typescript\r\nlet message: string = 'hello,world'\r\n```\r\n\r\n* ä¸€èˆ¬å¯ä»¥çœç•¥ï¼Œå› ä¸ºå¯ä»¥æ ¹æ®åé¢çš„å­—é¢é‡æ¨æ–­å‡ºå‰é¢å˜é‡ç±»å‹\r\n\r\n```typescript\r\nlet message = 'hello,world'\r\n```\r\n\r\n\r\n\r\n##### æ ‡æ³¨å‚æ•°\r\n\r\n```typescript\r\nfunction greet(name: string) {\r\n    \r\n}\r\n```\r\n\r\nå¾ˆå¤šæ—¶å€™ï¼Œéƒ½èƒ½å¤Ÿæ¨æ–­å‡ºå‚æ•°ç±»å‹\r\n\r\n```typescript\r\nconst names = ['Alice', 'Bob', 'Eve']\r\nconst lowercaseNames = names.map((e: string) => e.toLowerCase())\r\n```\r\n\r\n* å¯ä»¥ç”¨ç±»å‹æ¨æ–­ï¼Œæ¨æ–­å‡º e æ˜¯ string ç±»å‹\r\n\r\n\r\n\r\n##### æ ‡æ³¨è¿”å›å€¼\r\n\r\n```typescript\r\nfunction add(a: number, b: number) : number {\r\n    return a + b\r\n}\r\n```\r\n\r\n* ä¸€èˆ¬ä¹Ÿå¯ä»¥çœç•¥ï¼Œå› ä¸ºå¯ä»¥æ ¹æ®è¿”å›å€¼åšç±»å‹æ¨æ–­\r\n\r\n\r\n\r\n#### å¤æ‚ç±»å‹\r\n\r\n##### type\r\n\r\n```typescript\r\ntype Cat = {\r\n  name: string,\r\n  age: number\r\n}\r\n\r\nconst c1: Cat = { name: 'å°ç™½', age: 1 }\r\nconst c2: Cat = { name: 'å°èŠ±' }\t\t\t\t\t  // é”™è¯¯: ç¼ºå°‘ age å±æ€§\r\nconst c3: Cat = { name: 'å°é»‘', age: 1, sex: 'å…¬' } // é”™è¯¯: å¤šå‡º sex å±æ€§\r\n```\r\n\r\n\r\n\r\n##### interface\r\n\r\n```typescript\r\ninterface Cat {\r\n  name: string,\r\n  age: number\r\n}\r\n\r\nconst c1: Cat = { name: 'å°ç™½', age: 1 }\r\nconst c2: Cat = { name: 'å°èŠ±' }\t\t\t\t\t  // é”™è¯¯: ç¼ºå°‘ age å±æ€§\r\nconst c3: Cat = { name: 'å°é»‘', age: 1, sex: 'å…¬' } // é”™è¯¯: å¤šå‡º sex å±æ€§\r\n```\r\n\r\n\r\n\r\n##### å¯é€‰å±æ€§\r\n\r\nå¦‚æœéœ€è¦æŸä¸ªå±æ€§å¯é€‰ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„è¯­æ³•\r\n\r\n```typescript\r\ninterface Cat {\r\n  name: string,\r\n  age?: number\r\n}\r\n\r\nconst c1: Cat = { name: 'å°ç™½', age: 1 }\r\nconst c2: Cat = { name: 'å°èŠ±' }\t\t\t\t\t  // æ­£ç¡®: age å±æ€§å¯é€‰\r\n```\r\n\r\n* å¯é€‰å±æ€§è¦æ³¨æ„å¤„ç† undefined å€¼\r\n\r\n\r\n\r\n##### é¸­å­ç±»å‹\r\n\r\n```typescript\r\ninterface Cat {\r\n  name: string\r\n}\r\n\r\nfunction test(cat: Cat) {\r\n  console.log(cat.name)\r\n}\r\n\r\nconst c1 = { name: 'å°ç™½', age: 1 } \r\ntest(c1)\r\n```\r\n\r\n* const c1 å¹¶æ²¡æœ‰å£°æ˜ç±»å‹ä¸º Catï¼Œä½†å®ƒä¸ Cat ç±»å‹æœ‰ä¸€æ ·çš„å±æ€§ï¼Œä¹Ÿå¯ä»¥è¢«å½“ä½œæ˜¯ Cat ç±»å‹\r\n\r\n\r\n\r\n#### æ–¹æ³•ç±»å‹\r\n\r\n```typescript\r\ninterface Api {\r\n  foo(): void,\r\n  bar(str: string): string\r\n}\r\n\r\nfunction test(api: Api) {\r\n  api.foo()\r\n  console.log(api.bar('hello'))\r\n}\r\n\r\ntest({\r\n  foo() { console.log('ok') },\r\n  bar(str: string) { return str.toUpperCase() }\r\n})\r\n```\r\n\r\n\r\n\r\n#### å­—é¢é‡ç±»å‹\r\n\r\n```typescript\r\nfunction printText(s: string, alignment: \"left\" | \"right\" | \"center\") {\r\n  console.log(s, alignment)\r\n}\r\n\r\nprintText('hello', 'left')\r\nprintText('hello', 'aaa') // é”™è¯¯: å–å€¼åªèƒ½æ˜¯ left | right | center\r\n```\r\n\r\n\r\n\r\n#### nullish ç±»å‹\r\n\r\n```typescript\r\nfunction test(x?: string | null) {\r\n  console.log(x?.toUpperCase())\r\n}\r\n\r\ntest('aaa')\r\ntest(null)\r\ntest()\r\n```\r\n\r\n* x?: string | null è¡¨ç¤ºå¯èƒ½æ˜¯ undefined æˆ–è€…æ˜¯ string æˆ–è€…æ˜¯ null\r\n\r\n\r\n\r\n#### æ³›å‹\r\n\r\nä¸‹é¢çš„å‡ ä¸ªç±»å‹å£°æ˜æ˜¾ç„¶æœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§\r\n\r\n```typescript\r\ninterface RefString {\r\n  value: string\r\n}\r\n\r\ninterface RefNumber {\r\n  value: number\r\n}\r\n\r\ninterface RefBoolean {\r\n  value: boolean\r\n}\r\n\r\nconst r1: RefString = { value: 'hello' }\r\nconst r2: RefNumber = { value: 123 }\r\nconst r3: RefBoolean = { value: true }\r\n```\r\n\r\nå¯ä»¥æ”¹è¿›ä¸º\r\n\r\n```typescript\r\ninterface Ref<T> {\r\n  value: T\r\n}\r\n\r\nconst r1: Ref<string> = { value: 'hello' }\r\nconst r2: Ref<number> = { value: 123 }\r\nconst r3: Ref<boolean> = { value: true }\r\n```\r\n\r\n* æ³›å‹çš„è¦ç‚¹å°±æ˜¯ `<ç±»å‹å‚æ•°>`ï¼ŒæŠŠã€ç±»å‹ã€‘ä¹Ÿå½“ä½œä¸€ä¸ªå˜åŒ–çš„è¦ç´ ï¼Œåƒå‚æ•°ä¸€æ ·ä¼ é€’è¿‡æ¥ï¼Œè¿™æ ·å°±å¯ä»¥æ´¾ç”Ÿå‡ºç»“æ„ç›¸ä¼¼çš„æ–°ç±»å‹\r\n\r\n\r\n\r\nå‡½æ•°å®šä¹‰ä¹Ÿæ”¯æŒæ³›å‹\r\n\r\n```typescript\r\nfunction ref<T>(n: T): Ref<T> {\r\n  return { value: n }\r\n}\r\n\r\nconst v1 = ref(\"hello\"); \t// Ref<string>\r\nconst v2 = ref(123.3333);\t// Ref<number>\r\n\r\nv1.value.toLocaleLowerCase()\r\nv2.value.toFixed(2)\r\n```\r\n\r\n\r\n\r\n### 4) æ„ä¹‰\r\n\r\n#### æ›´å¥½ç†è§£æ¡†æ¶\r\n\r\nç°åœ¨è¶Šæ¥è¶Šå¤šçš„å‰ç«¯æ¡†æ¶é‡‡ç”¨ typescriptï¼Œå¦‚æœæ‡‚ typescript è¯­æ³•ï¼Œå¯ä»¥æ›´å¥½åœ°é˜…è¯»æ¡†æ¶ä»£ç \r\n\r\nä»¥ Map ä¸ºä¾‹\r\n\r\n```typescript\r\nconst map = new Map<string, string>()\r\nmap\r\n  .set(\"a\", \"b\")\r\n  .set(\"c\", \"d\")\r\n\r\nmap.forEach((value,key,m)=>{\r\n  console.log(value, key)\r\n})\r\n```\r\n\r\n* æ³¨æ„ç¼–è¯‘éœ€è¦ `tsc --target es6 .\\xxx.ts`\r\n\r\n\r\n\r\n#### æ›´å¥½çš„æç¤º\r\n\r\nä¾‹å¦‚ï¼Œä»æœåŠ¡å™¨è¿”å›çš„ä¸€æ®µ jsonï¼Œå¦‚æœä¸ç”¨ typescriptï¼Œåˆ™ç¼–è¾‘å™¨ä¹Ÿä¸èƒ½ç»™å‡ºå‡†ç¡®çš„æç¤º\r\n\r\n```typescript\r\ninterface User {\r\n  name: string,\r\n  age: number\r\n}\r\n\r\nconst user: User = JSON.parse(`{ \"name\":\"å¼ ä¸‰\", \"age\":18 }`)\r\n```\r\n\r\n\r\n\r\n### 5) ç±»\r\n\r\n> å…³äº TypeScript ä¸ JavaScript ä¸­çš„ç±»è¯­æ³•ä¸æ˜¯é‡ç‚¹ï¼Œclass ç›¸å…³è¯­æ³•åªæ˜¯èµ·åˆ°è¾…åŠ©ä½œç”¨ï¼Œæ›´é‡è¦çš„æ˜¯å‰é¢è®²çš„ interface\r\n\r\n#### åŸºæœ¬è¯­æ³•\r\n\r\n```typescript\r\nclass User {\r\n    name: string;\r\n    \r\n    constructor(name: string) {\r\n        this.name = name\r\n    }\r\n}\r\n\r\nconst u = new User('å¼ ä¸‰')\r\n```\r\n\r\nå…¶å®ä¼šè¢«ç¼–è¯‘æˆè¿™ä¸ªæ ·å­ï¼ˆé»˜è®¤ --target=es3ï¼‰\r\n\r\n```js\r\nvar User = /** @class */ (function () {\r\n    function User(name) {\r\n        this.name = name;\r\n    }\r\n    return User;\r\n}());\r\nvar u = new User('å¼ ä¸‰');\r\n```\r\n\r\næ‰€ä»¥ js ä¸­çš„ classï¼Œå¹¶ä¸ç­‰ä»·äº java ä¸­çš„ classï¼Œå®ƒè¿˜æ˜¯åŸºäºåŸå‹å®ç°çš„ï¼ŒåŸç†å‚è€ƒç¬¬äºŒç« ï¼ˆ036ã€037ï¼‰\r\n\r\n\r\n\r\n#### åªè¯»å±æ€§\r\n\r\n```typescript\r\nclass User {\r\n  readonly name: string;\r\n  \r\n  constructor(name: string) {\r\n      this.name = name\r\n  }\r\n}\r\n\r\nconst u = new User('å¼ ä¸‰')\r\nu.name = 'æå››'\t\t\t\t// ç¼–è¯‘é”™è¯¯\r\n```\r\n\r\n* readonly æ˜¯ typescript ç‰¹æœ‰çš„ï¼Œè¡¨ç¤ºè¯¥å±æ€§åªè¯»\r\n\r\n\r\n\r\n#### æ–¹æ³•\r\n\r\n```typescript\r\nclass User {\r\n  readonly name: string;\r\n  \r\n  constructor(name: string) {\r\n      this.name = name\r\n  }\r\n\r\n  study() {\r\n    console.log(`[${this.name}]æ­£åœ¨å­¦ä¹ `)\r\n  }\r\n}\r\n\r\nconst u = new User('å¼ ä¸‰')\r\nu.study()\r\n```\r\n\r\n\r\n\r\n#### getï¼Œset\r\n\r\n```typescript\r\nclass User {\r\n  _name: string;\r\n\r\n  constructor(name: string) {\r\n    this._name = name\r\n  }\r\n\r\n  get name() {\r\n    return this._name\r\n  }\r\n\r\n  set name(name: string) {\r\n    this._name = name\r\n  }\r\n}\r\n\r\nconst u = new User('å¼ ä¸‰')\r\nconsole.log(u.name)\r\nu.name = 'æå››'\r\nconsole.log(u.name)\r\n```\r\n\r\n* æ³¨æ„ï¼Œéœ€è¦åœ¨ç¼–è¯‘æ—¶åŠ ä¸Š `tsc --target es6 .\\xxx.ts` é€‰é¡¹\r\n* es6 ç­‰ä»·äº es2015ï¼Œå†æ­¤ä¹‹ä¸Šè¿˜æœ‰ es2016 ... es2022\r\n\r\n\r\n\r\n#### ç±»ä¸æ¥å£\r\n\r\n```typescript\r\ninterface User {\r\n  name: string\r\n  study(course: string): void\r\n}\r\n\r\nclass UserImpl implements User {\r\n  name: string;\r\n  constructor(name: string) {\r\n    this.name = name\r\n  }\r\n  study(course: string) {\r\n    console.log(`[${this.name}]æ­£åœ¨å­¦ä¹ [${course}]`)\r\n  }\r\n  foo() { }\r\n}\r\n\r\nconst user: User = new UserImpl('å¼ ä¸‰')\r\nuser.study('Typescript')\r\nuser.foo() // é”™è¯¯ï¼Œå¿…é¡»æ˜¯æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•\r\n```\r\n\r\n\r\n\r\n#### ç»§æ‰¿ä¸æ¥å£\r\n\r\n```typescript\r\ninterface Flyable {\r\n  fly(): void\r\n}\r\n\r\nclass Animal {\r\n  name: string;\r\n  constructor(name: string) {\r\n    this.name = name\r\n  }\r\n}\r\n\r\nclass Bird extends Animal implements Flyable {\r\n  fly() {\r\n    console.log(`${this.name}åœ¨é£ç¿”`)\r\n  }\r\n}\r\n\r\nconst b: Flyable & Animal = new Bird(\"å°èŠ±\")\r\nb.fly()\r\n```\r\n\r\n* Flyable & Animal è¡¨ç¤ºå˜é‡æ˜¯ flyable ç±»å‹ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ Animal ç±»å‹\r\n\r\n\r\n\r\n#### æ–¹æ³•é‡å†™\r\n\r\n```typescript\r\nclass Father {\r\n  study(): void {\r\n    console.log(`father study`)\r\n  }\r\n}\r\n\r\nclass Son extends Father {  \r\n  study(): void {\r\n    super.study()\r\n    console.log(`son study`)\r\n  }\r\n}\r\n\r\nconst f: Father = new Son()\r\nf.study()\r\n```\r\n\r\n\r\n\r\n## 2. Vue3 åŸºç¡€\r\n\r\næŠ€æœ¯é€‰å‹\r\n\r\n* Vue \r\n  * **é€‰é¡¹å¼ API** è¿˜æ˜¯ **ç»„åˆå¼ API**âœ”ï¸\r\n  * **HTML** è¿˜æ˜¯ **å•æ–‡ä»¶ç»„ä»¶**âœ”ï¸\r\n* è¯­æ³•\r\n  * **javascript** è¿˜æ˜¯ **typescript**âœ”ï¸\r\n* æ„å»ºå·¥å…·\r\n  * **@vue/cli** è¿˜æ˜¯ **vite**âœ”ï¸\r\n* è·¯ç”±\r\n  * **vue-router**âœ”ï¸\r\n* å…±äº«å­˜å‚¨\r\n  * **vuex** è¿˜æ˜¯ **pinia**âœ”ï¸\r\n* è§†å›¾ç»„ä»¶\r\n  * **ElementUI** è¿˜æ˜¯ **Antdv**âœ”ï¸\r\n\r\n\r\n\r\n### 1) ç¯å¢ƒå‡†å¤‡\r\n\r\n#### åˆ›å»ºé¡¹ç›®\r\n\r\né‡‡ç”¨ vite ä½œä¸ºå‰ç«¯é¡¹ç›®çš„æ‰“åŒ…ï¼Œæ„å»ºå·¥å…·\r\n\r\n```cmd\r\nnpm init vite@latest\r\n```\r\n\r\næŒ‰æç¤ºæ“ä½œ\r\n\r\n```cmd\r\ncd é¡¹ç›®ç›®å½•\r\nnpm install\r\nnpm run dev\r\n```\r\n\r\n\r\n\r\n#### ç¼–ç  IDE\r\n\r\næ¨èé‡‡ç”¨å¾®è½¯çš„ VSCode ä½œä¸ºå¼€å‘å·¥å…·ï¼Œåˆ°å®ƒçš„å®˜ç½‘ [Visual Studio Code - Code Editing. Redefined](https://code.visualstudio.com/) ä¸‹è½½å®‰è£…å³å¯\r\n\r\n![image-20220911090418621](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220911090418621.png)\r\n\r\nè¦å¯¹ *.vue åšè¯­æ³•æ”¯æŒï¼Œè¿˜è¦å®‰è£…ä¸€ä¸ª Volar æ’ä»¶\r\n\r\n![image-20220911090756694](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220911090756694.png)\r\n\r\n\r\n\r\n#### å®‰è£… devtools\r\n\r\n* devtools æ’ä»¶ç½‘å€ï¼šhttps://devtools.vuejs.org/guide/installation.html\r\n\r\n![image-20220815141648040](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220815141648040.png)\r\n\r\n\r\n\r\n#### ä¿®æ”¹ç«¯å£\r\n\r\næ‰“å¼€é¡¹ç›®æ ¹ç›®å½•ä¸‹ vite.config.ts\r\n\r\n```typescript\r\nimport { defineConfig } from 'vite'\r\nimport vue from '@vitejs/plugin-vue'\r\n\r\n// https://vitejs.dev/config/\r\nexport default defineConfig({\r\n  plugins: [vue()],\r\n  server: {\r\n    port: 7070\r\n  }\r\n})\r\n```\r\n\r\n* æ–‡æ¡£åœ°å€ï¼š[é…ç½® Vite {#configuring-vite} | Viteä¸­æ–‡ç½‘ (vitejs.cn)](https://vitejs.cn/config/#server-port)\r\n\r\n\r\n\r\n#### é…ç½®ä»£ç†\r\n\r\nä¸ºäº†é¿å…å‰åç«¯æœåŠ¡å™¨è”è°ƒæ—¶ï¼Œ fetchã€xhr è¯·æ±‚äº§ç”Ÿè·¨åŸŸé—®é¢˜ï¼Œéœ€è¦é…ç½®ä»£ç†ï¼ŒåŒæ ·æ˜¯ä¿®æ”¹é¡¹ç›®æ ¹ç›®å½•ä¸‹ vite.config.ts\r\n\r\n```typescript\r\nimport { defineConfig } from 'vite'\r\nimport vue from '@vitejs/plugin-vue'\r\n\r\n// https://vitejs.dev/config/\r\nexport default defineConfig({\r\n  plugins: [vue()],\r\n  server: {\r\n    port: 7070,\r\n    proxy: {\r\n      '/api': {\r\n        target: 'http://localhost:8080',\r\n        changeOrigin: true\r\n      }\r\n    }\r\n  }\r\n})\r\n```\r\n\r\n* æ–‡æ¡£åœ°å€ï¼š[é…ç½® Vite {#configuring-vite} | Viteä¸­æ–‡ç½‘ (vitejs.cn)](https://vitejs.cn/config/#server-proxy)\r\n\r\n\r\n\r\n#### é¡¹ç›®ç»“æ„\r\n\r\n```\r\nindex.html\r\npackage.json\r\ntsconfig.json\r\nvite.config.ts\r\nâ”œâ”€public\r\nâ””â”€src\r\n    â”œâ”€assets\r\n    â”œâ”€components\r\n    â”œâ”€model\r\n    â”œâ”€router\r\n    â”œâ”€store\r\n    â””â”€views\r\n```\r\n\r\n* index.html ä¸ºä¸»é¡µé¢\r\n* package.json npm é…ç½®æ–‡ä»¶\r\n* tsconfig.json typescript é…ç½®æ–‡ä»¶\r\n* vite.config.ts vite é…ç½®æ–‡ä»¶\r\n* public é™æ€èµ„æº\r\n* src/components å¯é‡ç”¨ç»„ä»¶\r\n* src/model æ¨¡å‹å®šä¹‰\r\n* src/router è·¯ç”±\r\n* src/store å…±äº«å­˜å‚¨\r\n* src/views è§†å›¾ç»„ä»¶\r\n\r\n\r\n\r\n### 2) Vue ç»„ä»¶\r\n\r\nVue çš„ç»„ä»¶æ–‡ä»¶ä»¥ .vue ç»“å°¾ï¼Œæ¯ä¸ªç»„ä»¶ç”±ä¸‰éƒ¨åˆ†ç»„æˆ\r\n\r\n```vue\r\n<script setup lang=\"ts\"></script>\r\n\r\n<template></template>\r\n\r\n<style scoped></style>\r\n```\r\n\r\n* script ä»£ç éƒ¨åˆ†ï¼Œæ§åˆ¶æ¨¡æ¿çš„æ•°æ®æ¥æºå’Œè¡Œä¸º\r\n* template æ¨¡æ¿éƒ¨åˆ†ï¼Œç”±å®ƒç”Ÿæˆ html ä»£ç \r\n* style æ ·å¼éƒ¨åˆ†ï¼Œä¸€èˆ¬ä¸å’‹å…³å¿ƒ\r\n\r\n\r\n\r\næ ¹ç»„ä»¶æ˜¯ src/App.vueï¼Œå…ˆæ¥ä¸ª Hello,world ä¾‹å­\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref } from \"vue\";\r\nlet msg = ref(\"hello\"); // æŠŠæ•°æ®å˜æˆå“åº”å¼çš„\r\n\r\nfunction change() {\r\n  msg.value = \"world\";\r\n  console.log(msg);\r\n}\r\n</script>\r\n<template>\r\n  <h1>{{ msg }}</h1>\r\n  <input type=\"button\" value=\"ä¿®æ”¹msg\" @click=\"change\" />\r\n</template>\r\n```\r\n\r\n* {{msg}} ç”¨æ¥æŠŠä¸€ä¸ªå˜é‡ç»‘å®šåˆ°é¡µé¢ä¸ŠæŸä¸ªä½ç½®\r\n* ç»‘å®šçš„å˜é‡å¿…é¡»ç”¨ ref å‡½æ•°æ¥å°è£…\r\n  * ref è¿”å›çš„æ˜¯ã€å“åº”å¼ã€‘æ•°æ®ï¼Œå³æ•°æ®ä¸€æ—¦å˜åŒ–ï¼Œé¡µé¢å±•ç¤ºä¹Ÿè·Ÿç€å˜åŒ–\r\n\r\n\r\n\r\n#### main.ts\r\n\r\n```typescript\r\nimport { createApp } from 'vue'\r\nimport './style.css'\r\nimport App from './App.vue'\r\n\r\ncreateApp(App)\r\n  .mount('#app')\r\n```\r\n\r\n* createApp æ˜¯åˆ›å»ºä¸€ä¸ª Vue åº”ç”¨ç¨‹åºï¼Œå®ƒæ¥æ”¶çš„å‚æ•° App å³ä¹‹å‰æˆ‘ä»¬çœ‹åˆ°çš„æ ¹ç»„ä»¶\r\n* mount å°±æ˜¯æŠŠæ ¹ç»„ä»¶ç”Ÿæˆçš„ html ä»£ç ç‰‡æ®µã€æŒ‚è½½ã€‘åˆ° index.html ä¸­ id ä¸º app çš„ html å…ƒç´ ä¸Š\r\n\r\n\r\n\r\nå¯ä»¥ä¿®æ”¹è‡ªå·±çš„ç»„ä»¶æ–‡ä»¶ï¼ŒæŒ‚è½½åˆ°ä¸»é¡µé¢\r\n\r\næ–°å»º src/views/E0.vueï¼Œå†…å®¹å¦‚ä¸‹\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref } from 'vue'\r\nconst msg = ref('Hello, World!!')\r\n</script>\r\n<template>\r\n  <h1>{{ msg }}</h1>\r\n</template>\r\n```\r\n\r\nä¿®æ”¹ main.ts å°†è‡ªå·±çš„ç»„ä»¶æ–‡ä»¶æŒ‚è½½\r\n\r\n```typescript\r\nimport { createApp } from 'vue'\r\nimport './style.css'\r\n// import App from './App.vue'\r\nimport E0 from './views/E0.vue'\r\n\r\ncreateApp(E0).mount('#app')\r\n```\r\n\r\n* ä»¥åæˆ‘ä»¬ç”¨è¿™æ ·çš„æ–¹å¼æ¼”ç¤ºè¯¾å ‚æ¡ˆä¾‹\r\n\r\n\r\n\r\næ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œè¿›å…¥ Vue çš„å¼€å‘å·¥å…·ï¼Œå°è¯•åšå¦‚ä¸‹ä¿®æ”¹\r\n\r\n![image-20220906141650435](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220906141650435.png)\r\n\r\nå½“æŠŠ msg çš„å€¼ç”± \"Hello, World\" æ”¹ä¸º \"ä½ å¥½\" æ—¶ï¼Œä¼šå‘ç°é¡µé¢å±•ç¤ºåŒæ­¥å‘ç”Ÿäº†å˜åŒ–\r\n\r\n\r\n\r\n#### ref ä¸ reactive\r\n\r\nvue æä¾›äº†ä¸¤ä¸ªå‡½æ•°ï¼Œéƒ½å¯ä»¥å°†æ•°æ®å˜ä¸ºã€å“åº”å¼ã€‘çš„\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref, reactive } from 'vue'\r\nconst msg = ref('Hello, World')\r\nconst user = reactive({ name: 'å¼ ä¸‰' })\r\n</script>\r\n\r\n<template>\r\n  <h2>{{msg}}</h2>\r\n  <h2>{{user.name}}</h2>\r\n</template>\r\n```\r\n\r\n* ref èƒ½å°†ä»»æ„ç±»å‹çš„æ•°æ®å˜ä¸ºã€å“åº”å¼ã€‘çš„\r\n* reactive åªèƒ½å°†å¯¹è±¡ç±»å‹å˜ä¸ºã€å“åº”å¼ã€‘ï¼Œå¯¹åŸºæœ¬ç±»å‹æ— æ•ˆï¼ˆä¾‹å¦‚ stringï¼Œnumberï¼Œbooleanï¼‰\r\n\r\n\r\n\r\nè¿˜æœ‰ä¸€ç‚¹ä¸åŒ\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref, reactive } from 'vue'\r\nconst u1 = ref({ name: 'å¼ ä¸‰' })\r\nconst u2 = reactive({ name: 'å¼ ä¸‰' })\r\n\r\nfunction test() {\r\n  console.log(u1.value)\r\n  console.log(u2)\r\n}\r\n\r\ntest()\r\n</script>\r\n  \r\n<template>\r\n  <h2>{{u1.name}}</h2>\r\n  <h2>{{u2.name}}</h2>\r\n</template>\r\n```\r\n\r\n* åœ¨ template æ¨¡æ¿ä¸­ä½¿ç”¨ ref åŒ…è£…çš„æ•°æ®ï¼Œç›´æ¥å†™ã€å˜é‡åã€‘å°±å¯ä»¥äº†\r\n* ä½†åœ¨ä»£ç ä¸­è¦ä½¿ç”¨ ref åŒ…è£…çš„æ•°æ®ï¼Œå¿…é¡»ç”¨ã€å˜é‡å.valueã€‘æ‰èƒ½è®¿é—®åˆ°\r\n* reactive åŒ…è£…çš„æ•°æ®ï¼Œåœ¨æ¨¡æ¿ä¸­å’Œä»£ç ä¸­éƒ½æ˜¯ä¸€è‡´çš„\r\n\r\n\r\n\r\n#### å±æ€§ç»‘å®š\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref } from 'vue'\r\nconst path = ref('/src/assets/vue.svg')\r\n\r\n</script>\r\n\r\n<template>\r\n  <img :src=\"path\" alt=\"\">\r\n</template>\r\n```\r\n\r\n* ã€:å±æ€§åã€‘ç”¨æ¥å°†æ ‡ç­¾å±æ€§ä¸ã€å“åº”å¼ã€‘å˜é‡ç»‘å®š\r\n\r\n\r\n\r\n#### äº‹ä»¶ç»‘å®š\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref } from 'vue'\r\nconst count = ref(0)\r\nfunction dec() {\r\n  count.value--\r\n}\r\nfunction inc() {\r\n  count.value++\r\n}\r\n</script>\r\n\r\n<template>\r\n  <input type=\"button\" value=\"-\" @click=\"dec\">\r\n  <h2>{{count}}</h2>\r\n  <input type=\"button\" value=\"+\" @click=\"inc\">\r\n</template>\r\n```\r\n\r\n* ã€@äº‹ä»¶åã€‘ç”¨æ¥å°†æ ‡ç­¾å±æ€§ä¸å‡½æ•°ç»‘å®šï¼Œäº‹ä»¶å‘ç”Ÿåæ‰§è¡Œå‡½æ•°å†…ä»£ç \r\n\r\n\r\n\r\n#### è¡¨å•ç»‘å®š\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref } from \"vue\";\r\nconst user = ref({\r\n  name:'å¼ ä¸‰',\r\n  age:18,\r\n  sex:'ç”·',\r\n  fav:['æ¸¸æ³³','æ‰“çƒ']\r\n})\r\n\r\nfunction saveUser() {\r\n  console.log(user.value)\r\n}\r\n</script>\r\n\r\n<template>\r\n  <div class=\"outer\">\r\n    <div>\r\n      <label for=\"\">è¯·è¾“å…¥å§“å</label>\r\n      <input type=\"text\" v-model=\"user.name\"/>\r\n    </div>\r\n    <div>\r\n      <label for=\"\">è¯·è¾“å…¥å¹´é¾„</label>\r\n      <input type=\"text\" v-model=\"user.age\"/>\r\n    </div>\r\n    <div>\r\n      <label for=\"\">è¯·é€‰æ‹©æ€§åˆ«</label>\r\n      ç”· <input type=\"radio\" value=\"ç”·\" v-model=\"user.sex\"/> \r\n      å¥³ <input type=\"radio\" value=\"å¥³\" v-model=\"user.sex\"/>\r\n    </div>\r\n    <div>\r\n      <label for=\"\">è¯·é€‰æ‹©çˆ±å¥½</label>\r\n      æ¸¸æ³³ <input type=\"checkbox\" value=\"æ¸¸æ³³\" v-model=\"user.fav\"/> \r\n      æ‰“çƒ <input type=\"checkbox\" value=\"æ‰“çƒ\" v-model=\"user.fav\"/> \r\n      å¥èº« <input type=\"checkbox\" value=\"å¥èº«\" v-model=\"user.fav\"/>\r\n    </div>\r\n    <div>\r\n      <input type=\"button\" value=\"ä¿å­˜\" @click=\"saveUser\">\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<style scoped>\r\n  div {\r\n    margin-bottom: 8px;\r\n  }\r\n  .outer {\r\n    width: 100%;\r\n    position: relative;\r\n    padding-left: 80px;\r\n  }\r\n  label {\r\n    text-align: left;\r\n    width: 100px;\r\n    display: inline-block;\r\n    position: absolute;\r\n    left :0;\r\n  }\r\n</style>\r\n```\r\n\r\n* ç”¨ v-model å®ç°åŒå‘ç»‘å®šï¼Œå³ \r\n  * javascript æ•°æ®å¯ä»¥åŒæ­¥åˆ°è¡¨å•æ ‡ç­¾\r\n  * åè¿‡æ¥ç”¨æˆ·åœ¨è¡¨å•æ ‡ç­¾è¾“å…¥çš„æ–°å€¼ä¹Ÿä¼šåŒæ­¥åˆ° javascript è¿™è¾¹\r\n* åŒå‘ç»‘å®šåªé€‚ç”¨äºè¡¨å•è¿™ç§å¸¦ã€è¾“å…¥ã€‘åŠŸèƒ½çš„æ ‡ç­¾ï¼Œå…¶å®ƒæ ‡ç­¾çš„æ•°æ®ç»‘å®šï¼Œå•å‘å°±è¶³å¤Ÿäº†\r\n* å¤é€‰æ¡†è¿™ç§æ ‡ç­¾ï¼ŒåŒå‘ç»‘å®šçš„ javascript æ•°æ®ç±»å‹ä¸€èˆ¬ç”¨æ•°ç»„\r\n\r\n\r\n\r\n#### è®¡ç®—å±æ€§\r\n\r\næœ‰æ—¶åœ¨æ•°æ®å±•ç¤ºæ—¶è¦åšç®€å•çš„è®¡ç®—\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref } from 'vue'\r\nconst firstName = ref('ä¸‰')\r\nconst lastName = ref('å¼ ')\r\n\r\n</script>\r\n\r\n<template>\r\n  <h2>{{lastName + firstName}}</h2>\r\n  <h3>{{lastName + firstName}}</h3>\r\n  <h4>{{lastName + firstName}}</h4>\r\n</template>\r\n```\r\n\r\nçœ‹èµ·æ¥è¾ƒä¸ºç¹çï¼Œå¯ä»¥ç”¨è®¡ç®—å±æ€§æ”¹è¿›\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref, computed } from 'vue'\r\nconst firstName = ref('ä¸‰')\r\nconst lastName = ref('å¼ ')\r\nconst fullName = computed(() => {\r\n  console.log('enter')\r\n  return lastName.value + firstName.value\r\n})\r\n</script>\r\n\r\n<template>\r\n  <h2>{{fullName}}</h2>\r\n  <h3>{{fullName}}</h3>\r\n  <h4>{{fullName}}</h4>\r\n</template>\r\n```\r\n\r\n* fullName å³ä¸ºè®¡ç®—å±æ€§ï¼Œå®ƒå…·å¤‡ç¼“å­˜åŠŸèƒ½ï¼Œå³ firstName å’Œ lastName çš„å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œæ‰ä¼šé‡æ–°è®¡ç®—\r\n* å¦‚æœç”¨å‡½æ•°å®ç°ç›¸åŒåŠŸèƒ½ï¼Œåˆ™æ²¡æœ‰ç¼“å­˜åŠŸèƒ½\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref } from 'vue'\r\nconst firstName = ref('ä¸‰')\r\nconst lastName = ref('å¼ ')\r\nfunction fullName() {\r\n  console.log('enter')\r\n  return lastName.value + firstName.value\r\n}\r\n</script>\r\n  \r\n<template>\r\n  <h2>{{fullName()}}</h2>\r\n  <h3>{{fullName()}}</h3>\r\n  <h4>{{fullName()}}</h4>\r\n</template>\r\n```\r\n\r\n\r\n\r\n#### xhr\r\n\r\næµè§ˆå™¨ä¸­æœ‰ä¸¤å¥— API å¯ä»¥å’Œåç«¯äº¤äº’ï¼Œå‘é€è¯·æ±‚ã€æ¥æ”¶å“åº”ï¼Œfetch api å‰é¢æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡äº†ï¼Œå¦ä¸€å¥— api æ˜¯ xhrï¼ŒåŸºæœ¬ç”¨æ³•å¦‚ä¸‹\r\n\r\n```js\r\nconst xhr = new XMLHttpRequest()\r\nxhr.onload = function() {\r\n    console.log(xhr.response)\r\n}\r\nxhr.open('GET', 'http://localhost:8080/api/students')\r\nxhr.responseType = \"json\"\r\nxhr.send()\r\n```\r\n\r\nä½†è¿™å¥— api è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†æ¯”è¾ƒè€ï¼Œä¸ç›´æ¥æ”¯æŒ Promiseï¼Œå› æ­¤æœ‰å¿…è¦å¯¹å…¶è¿›è¡Œæ”¹é€ \r\n\r\n```typescript\r\nfunction get(url: string) {\r\n  return new Promise((resolve, reject)=>{\r\n    const xhr = new XMLHttpRequest()\r\n    xhr.onload = function() {\r\n      if(xhr.status === 200){\r\n        resolve(xhr.response)\r\n      } else if(xhr.status === 404) {\r\n        reject(xhr.response)\r\n      } // å…¶å®ƒæƒ…å†µä¹Ÿéœ€è€ƒè™‘ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†\r\n    }\r\n    xhr.open('GET', url)\r\n    xhr.responseType = 'json'\r\n    xhr.send()\r\n  })\r\n}\r\n```\r\n\r\n* Promise å¯¹è±¡é€‚åˆç”¨æ¥å°è£…å¼‚æ­¥æ“ä½œï¼Œå¹¶å¯ä»¥é…åˆ await ä¸€é½ä½¿ç”¨\r\n* Promise åœ¨æ„é€ æ—¶ï¼Œéœ€è¦ä¸€ä¸ªç®­å¤´å‡½æ•°ï¼Œç®­å¤´å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•° resolve å’Œ reject\r\n  * resolve æ˜¯å¼‚æ­¥æ“ä½œæˆåŠŸæ—¶è¢«è°ƒç”¨ï¼ŒæŠŠæˆåŠŸçš„ç»“æœä¼ é€’ç»™å®ƒï¼Œæœ€åä¼šä½œä¸º await çš„ç»“æœè¿”å›\r\n  * reject åœ¨å¼‚æ­¥æ“ä½œå¤±è´¥æ—¶è¢«è°ƒç”¨ï¼ŒæŠŠå¤±è´¥çš„ç»“æœä¼ é€’ç»™å®ƒï¼Œæœ€ååœ¨ catch å—è¢«æ‰ä½\r\n* await ä¼šä¸€ç›´ç­‰åˆ° Promise å†…è°ƒç”¨äº† resolve æˆ– reject æ‰ä¼šç»§ç»­å‘ä¸‹è¿è¡Œ\r\n\r\n\r\n\r\nè°ƒç”¨ç¤ºä¾‹1ï¼šåŒæ­¥æ¥æ”¶ç»“æœï¼Œä¸èµ°ä»£ç†\r\n\r\n```js\r\ntry {\r\n  const resp = await get(\"http://localhost:8080/api/students\")\r\n  console.log(resp)\r\n} catch (e) {\r\n  console.error(e)\r\n}\r\n```\r\n\r\nè°ƒç”¨ç¤ºä¾‹2ï¼šèµ°ä»£ç†\r\n\r\n```js\r\ntry {\r\n  const resp = await get('/api/students')\r\n  console.log(resp)  \r\n} catch(e) {\r\n  console.log(e)\r\n}\r\n```\r\n\r\n* èµ°ä»£ç†æ˜æ˜¾æ…¢ä¸å°‘\r\n\r\n\r\n\r\n#### axios\r\n\r\n##### åŸºæœ¬ç”¨æ³•\r\n\r\naxios å°±æ˜¯å¯¹ xhr api çš„å°è£…ï¼Œæ‰‹æ³•ä¸å‰é¢ä¾‹å­ç±»ä¼¼\r\n\r\nå®‰è£…\r\n\r\n```cmd\r\nnpm install axios\r\n```\r\n\r\nä¸€ä¸ªç®€å•çš„ä¾‹å­\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref, onMounted } from \"vue\";\r\nimport axios from \"axios\";\r\n\r\nlet count = ref(0);\r\n\r\nasync function getStudents() {\r\n  try {\r\n    const resp = await axios.get(\"/api/students\");\r\n    count.value = resp.data.data.length;\r\n  } catch (e) {\r\n    console.log(e);\r\n  }\r\n}\r\n\r\nonMounted(() => {\r\n  getStudents()\r\n})\r\n</script>\r\n\r\n<template>\r\n  <h2>å­¦ç”Ÿäººæ•°ä¸ºï¼š{{ count }}</h2>\r\n</template>\r\n```\r\n\r\n* onMounted æŒ‡ vue ç»„ä»¶ç”Ÿæˆçš„ html ä»£ç ç‰‡æ®µï¼ŒæŒ‚è½½å®Œæ¯•åè¢«æ‰§è¡Œ\r\n\r\n\r\n\r\nå†æ¥çœ‹ä¸€ä¸ª post ä¾‹å­\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport { ref } from \"vue\";\r\nimport axios from \"axios\";\r\n\r\nconst student = ref({\r\n  name: '',\r\n  sex: 'ç”·',\r\n  age: 18\r\n})\r\n\r\nasync function addStudent() {\r\n  console.log(student.value)\r\n  const resp = await axios.post('/api/students', student.value)\r\n  console.log(resp.data.data)\r\n}\r\n</script>\r\n\r\n<template>\r\n  <div>\r\n    <div>\r\n      <input type=\"text\" placeholder=\"è¯·è¾“å…¥å§“å\" v-model=\"student.name\"/>\r\n    </div>\r\n    <div>\r\n      <label for=\"\">è¯·é€‰æ‹©æ€§åˆ«</label>\r\n      ç”· <input type=\"radio\" value=\"ç”·\" v-model=\"student.sex\"/> \r\n      å¥³ <input type=\"radio\" value=\"å¥³\" v-model=\"student.sex\"/>\r\n    </div>\r\n    <div>\r\n      <input type=\"number\" placeholder=\"è¯·è¾“å…¥å¹´é¾„\" v-model=\"student.age\"/>\r\n    </div>\r\n    <div>\r\n      <input type=\"button\" value=\"æ·»åŠ \" @click=\"addStudent\"/>\r\n    </div>\r\n  </div>\r\n</template>\r\n<style scoped>\r\ndiv {\r\n  font-size: 14px;\r\n}\r\n</style>\r\n```\r\n\r\n\r\n\r\n##### ç¯å¢ƒå˜é‡\r\n\r\n* å¼€å‘ç¯å¢ƒä¸‹ï¼Œè”è°ƒçš„åç«¯æœåŠ¡å™¨åœ°å€æ˜¯ `http://localhost:8080`ï¼Œ\r\n* ä¸Šçº¿æ”¹ä¸ºç”Ÿäº§ç¯å¢ƒåï¼Œåç«¯æœåŠ¡å™¨åœ°å€ä¸º `http://itheima.com`\r\n\r\nè¿™å°±è¦æ±‚æˆ‘ä»¬åŒºåˆ†å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒï¼Œè¿™ä»¶äº‹äº¤ç»™æ„å»ºå·¥å…· vite æ¥åš\r\n\r\n\r\n\r\né»˜è®¤æƒ…å†µä¸‹ï¼Œvite æ”¯æŒä¸Šé¢ä¸¤ç§ç¯å¢ƒï¼Œåˆ†åˆ«å¯¹åº”æ ¹ç›®å½•ä¸‹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ \r\n\r\n* .env.development - å¼€å‘ç¯å¢ƒ\r\n* .env.production - ç”Ÿäº§ç¯å¢ƒ\r\n\r\né’ˆå¯¹ä»¥ä¸Šéœ€æ±‚ï¼Œåˆ†åˆ«åœ¨ä¸¤ä¸ªæ–‡ä»¶ä¸­åŠ å…¥\r\n\r\n```properties\r\nVITE_BACKEND_API_BASE_URL = 'http://localhost:8080'\r\n```\r\n\r\nå’Œ\r\n\r\n```properties\r\nVITE_BACKEND_API_BASE_URL = 'http://itheima.com'\r\n```\r\n\r\nç„¶ååœ¨ä»£ç ä¸­ä½¿ç”¨ vite ç»™æˆ‘ä»¬æä¾›çš„ç‰¹æ®Šå¯¹è±¡ `import.meta.env`ï¼Œå°±å¯ä»¥è·å–åˆ° `VITE_BACKEND_API_BASE_URL` åœ¨ä¸åŒç¯å¢ƒä¸‹çš„å€¼\r\n\r\n```js\r\nimport.meta.env.VITE_BACKEND_API_BASE_URL\r\n```\r\n\r\n\r\n\r\né»˜è®¤æƒ…å†µä¸‹ï¼Œä¸èƒ½æ™ºèƒ½æç¤ºè‡ªå®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼Œåšå¦‚ä¸‹é…ç½®ï¼šæ–°å¢æ–‡ä»¶ `src/env.d.ts` å¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹\r\n\r\n```typescript\r\n/// <reference types=\"vite/client\" />\r\n\r\ninterface ImportMetaEnv {\r\n  readonly VITE_BACKEND_API_BASE_URL: string\r\n  // æ›´å¤šç¯å¢ƒå˜é‡...\r\n}\r\n\r\ninterface ImportMeta {\r\n  readonly env: ImportMetaEnv\r\n}\r\n```\r\n\r\n* å‚è€ƒæ–‡æ¡£åœ°å€ [ç¯å¢ƒå˜é‡å’Œæ¨¡å¼ | Vite å®˜æ–¹ä¸­æ–‡æ–‡æ¡£ (vitejs.dev)](https://cn.vitejs.dev/guide/env-and-mode.html)\r\n\r\n\r\n\r\n##### baseURL\r\n\r\nå¯ä»¥è‡ªå·±åˆ›å»ºä¸€ä¸ª axios å¯¹è±¡ï¼Œæ–¹ä¾¿æ·»åŠ é»˜è®¤è®¾ç½®ï¼Œæ–°å»ºæ–‡ä»¶ /src/api/request.ts\r\n\r\n```typescript\r\n// åˆ›å»ºæ–°çš„ axios å¯¹è±¡\r\nimport axios from 'axios'\r\nconst _axios = axios.create({\r\n  baseURL: import.meta.env.VITE_BACKEND_API_BASE_URL\r\n})\r\n\r\nexport default _axios\r\n```\r\n\r\nç„¶ååœ¨å…¶å®ƒç»„ä»¶ä¸­å¼•ç”¨è¿™ä¸ª ts æ–‡ä»¶ï¼Œä¾‹å¦‚ /src/views/E8.vueï¼Œå°±ä¸ç”¨è‡ªå·±æ‹¼æ¥è·¯å¾„å‰ç¼€äº†\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport axios from '../api/request'\r\n// ...\r\nawait axios.post('/api/students', ...)    \r\n</script>\r\n```\r\n\r\n\r\n\r\n##### æ‹¦æˆªå™¨\r\n\r\n```typescript\r\n// åˆ›å»ºæ–°çš„ axios å¯¹è±¡\r\nimport axios from 'axios'\r\nconst _axios = axios.create({\r\n  baseURL: import.meta.env.VITE_BACKEND_API_BASE_URL\r\n})\r\n\r\n// è¯·æ±‚æ‹¦æˆªå™¨\r\n_axios.interceptors.request.use(\r\n  (config)=>{ // ç»Ÿä¸€æ·»åŠ è¯·æ±‚å¤´\r\n    config.headers = {\r\n      Authorization: 'aaa.bbb.ccc'\r\n    }\r\n    return config\r\n  },\r\n  (error)=>{ // è¯·æ±‚å‡ºé”™æ—¶çš„å¤„ç†\r\n    return Promise.reject(error)\r\n  }\r\n)\r\n\r\n// å“åº”æ‹¦æˆªå™¨\r\n_axios.interceptors.response.use(\r\n  (response)=>{ // çŠ¶æ€ç   2xx\r\n    // è¿™é‡Œçš„codeæ˜¯è‡ªå®šä¹‰çš„é”™è¯¯ç \r\n    if(response.data.code === 200) {\r\n      return response\r\n    }     \r\n    else if(response.data.code === 401) {       \r\n      // æƒ…å†µ1\r\n      return Promise.resolve({})\r\n    }\r\n    // ... \r\n  },\r\n  (error)=>{ // çŠ¶æ€ç  > 2xx, 400,401,403,404,500\r\n    console.error(error) // å¤„ç†äº†å¼‚å¸¸\r\n    if(error.response.status === 400) {\r\n      // æƒ…å†µ1\r\n    } else if(error.response.status === 401) {\r\n      // æƒ…å†µ2\r\n    } \r\n    // ...\r\n    return Promise.resolve({})\r\n  }\r\n)\r\n\r\nexport default _axios\r\n```\r\n\r\nå¤„ç†å“åº”æ—¶ï¼Œåˆåˆ†æˆä¸¤ç§æƒ…å†µ\r\n\r\n1. åç«¯è¿”å›çš„æ˜¯æ ‡å‡†å“åº”çŠ¶æ€ç ï¼Œè¿™æ—¶ä¼šèµ°å“åº”æ‹¦æˆªå™¨ç¬¬äºŒä¸ªç®­å¤´å‡½æ•°ï¼Œç”¨ error.response.status åšåˆ†æ”¯åˆ¤æ–­\r\n2. åç«¯è¿”å›çš„å“åº”çŠ¶æ€ç æ€»æ˜¯200ï¼Œç”¨è‡ªå®šä¹‰é”™è¯¯ç è¡¨ç¤ºå‡ºé”™ï¼Œè¿™æ—¶ä¼šèµ°å“åº”æ‹¦æˆªå™¨ç¬¬ä¸€ä¸ªç®­å¤´å‡½æ•°ï¼Œç”¨ response.data.code åšåˆ†æ”¯åˆ¤æ–­\r\n\r\nå¦å¤–\r\n\r\n* Promise.reject(error) ç±»ä¼¼äºå°†å¼‚å¸¸ç»§ç»­å‘ä¸ŠæŠ›å‡ºï¼Œå¼‚å¸¸ç”±è°ƒç”¨è€…ï¼ˆVueç»„ä»¶ï¼‰æ¥é…åˆ try ... catch æ¥å¤„ç†\r\n* Promise.resolve({}) è¡¨ç¤ºé”™è¯¯å·²è§£å†³ï¼Œè¿”å›ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œè°ƒç”¨è€…ä¸­æ¥åˆ°è¿™ä¸ªç©ºå¯¹è±¡æ—¶ï¼Œéœ€è¦é…åˆ ?. æ¥é¿å…è®¿é—®ä¸å­˜åœ¨çš„å±æ€§\r\n\r\n\r\n\r\n#### æ¡ä»¶ä¸åˆ—è¡¨\r\n\r\né¦–å…ˆï¼Œæ–°å¢æ¨¡å‹æ•°æ® src/model/Model8080.ts\r\n\r\n```typescript\r\nexport interface Student {\r\n  id: number;\r\n  name: string;\r\n  sex: string;\r\n  age: number;\r\n}\r\n\r\n// å¦‚æœ spring é”™è¯¯ï¼Œè¿”å›çš„å¯¹è±¡æ ¼å¼\r\nexport interface SpringError {\r\n  timestamp: string,\r\n  status: number,\r\n  error: string,\r\n  message: string,\r\n  path: string\r\n}\r\n\r\n// å¦‚æœ spring æˆåŠŸï¼Œè¿”å› list æƒ…å†µ\r\nexport interface SpringList<T> {\r\n  data: T[],\r\n  message?: string,\r\n  code: number\r\n}\r\n\r\n// å¦‚æœ spring æˆåŠŸï¼Œè¿”å› page æƒ…å†µ\r\nexport interface SpringPage<T> {\r\n  data: { list: T[], total: number },\r\n  message?: string,\r\n  code: number\r\n}\r\n\r\n// å¦‚æœ spring æˆåŠŸï¼Œè¿”å› string æƒ…å†µ\r\nexport interface SpringString {\r\n  data: string,\r\n  message?: string,\r\n  code: number\r\n}\r\n\r\nimport { AxiosResponse } from 'axios'\r\nexport interface AxiosRespError extends AxiosResponse<SpringError> { }\r\nexport interface AxiosRespList<T> extends AxiosResponse<SpringList<T>> { }\r\nexport interface AxiosRespPage<T> extends AxiosResponse<SpringPage<T>> { }\r\nexport interface AxiosRespString extends AxiosResponse<SpringString> { }\r\n```\r\n\r\nå…¶ä¸­ \r\n\r\n* AxiosRespPage ä»£è¡¨åˆ†é¡µæ—¶çš„å“åº”ç±»å‹\r\n* AxiosRespList ä»£è¡¨è¿”å›é›†åˆæ—¶çš„å“åº”ç±»å‹\r\n* AxiosRespString ä»£è¡¨è¿”å›å­—ç¬¦ä¸²æ—¶çš„å“åº”ç±»å‹\r\n* AxiosRespError ä»£è¡¨ Spring å‡ºé”™æ—¶æ—¶çš„å“åº”ç±»å‹\r\n\r\n```vue\r\n<script lang=\"ts\" setup>\r\nimport { ref, onMounted } from \"vue\";\r\nimport axios from \"../api/request\";\r\nimport { Student, SpringList } from \"../model/Model8080\";\r\n\r\n// è¯´æ˜ students æ•°ç»„ç±»å‹ä¸º Student[]\r\nconst students = ref<Student[]>([]);\r\n\r\nasync function getStudents() {\r\n  // è¯´æ˜ resp.data ç±»å‹æ˜¯ SpringList<Student>\r\n  const resp = await axios.get<SpringList<Student>>(\"/api/students\");  \r\n  console.log(resp.data.data);\r\n  students.value = resp.data.data;\r\n}\r\n\r\nonMounted(() => getStudents());\r\n</script>\r\n<template>\r\n  <div class=\"outer\">\r\n    <div class=\"title\">å­¦ç”Ÿåˆ—è¡¨</div>\r\n    <div class=\"thead\">\r\n      <div class=\"row bold\">\r\n        <div class=\"col\">ç¼–å·</div>\r\n        <div class=\"col\">å§“å</div>\r\n        <div class=\"col\">æ€§åˆ«</div>\r\n        <div class=\"col\">å¹´é¾„</div>\r\n      </div>\r\n    </div>\r\n    <div class=\"tbody\">\r\n      <div v-if=\"students.length === 0\">æš‚æ— æ•°æ®</div>\r\n      <template v-else>\r\n        <div class=\"row\" v-for=\"s of students\" :key=\"s.id\">\r\n          <div class=\"col\">{{ s.id }}</div>\r\n          <div class=\"col\">{{ s.name }}</div>\r\n          <div class=\"col\">{{ s.sex }}</div>\r\n          <div class=\"col\">{{ s.age }}</div>\r\n        </div>\r\n      </template>\r\n    </div>\r\n  </div>\r\n</template>\r\n<style scoped>\r\n.outer {\r\n  font-family: åæ–‡è¡Œæ¥·;\r\n  font-size: 20px;\r\n  width: 500px;\r\n}\r\n\r\n.title {\r\n  margin-bottom: 10px;\r\n  font-size: 30px;\r\n  color: #333;\r\n  text-align: center;\r\n}\r\n\r\n.row {\r\n  background-color: #fff;\r\n  display: flex;\r\n  justify-content: center;\r\n}\r\n\r\n.col {\r\n  border: 1px solid #f0f0f0;\r\n  width: 15%;\r\n  height: 35px;\r\n  text-align: center;\r\n  line-height: 35px;\r\n}\r\n\r\n.bold .col {\r\n  background-color: #f1f1f1;\r\n}\r\n</style>\r\n```\r\n\r\n* åŠ å…¥æ³›å‹æ˜¯ä¸ºäº†æ›´å¥½çš„æç¤º\r\n* v-if ä¸ v-else ä¸èƒ½å’Œ v-for å¤„äºåŒä¸€æ ‡ç­¾\r\n* template æ ‡ç­¾è¿˜æœ‰ä¸€ä¸ªç”¨é€”ï¼Œå°±æ˜¯ç”¨å®ƒå°‘ç”Ÿæˆä¸€å±‚çœŸæ­£ html ä»£ç \r\n* å¯ä»¥çœ‹åˆ°å°†ç»“æœå°è£…ä¸ºå“åº”å¼æ•°æ®è¿˜æ˜¯æ¯”è¾ƒç¹ççš„ï¼Œåé¢ä¼šä½¿ç”¨ useRequest æ”¹è¿›\r\n\r\n\r\n\r\n#### ç›‘å¬å™¨\r\n\r\nåˆ©ç”¨ç›‘å¬å™¨ï¼Œå¯ä»¥åœ¨ã€å“åº”å¼ã€‘çš„åŸºç¡€ä¸Šæ·»åŠ ä¸€äº›å‰¯ä½œç”¨ï¼ŒæŠŠæ›´å¤šçš„ä¸œè¥¿å˜æˆã€å“åº”å¼çš„ã€‘\r\n\r\n* åŸæœ¬åªæ˜¯æ•°æ®å˜åŒ– => é¡µé¢æ›´æ–°\r\n\r\n* watch å¯ä»¥åœ¨æ•°æ®å˜åŒ–æ—¶ => å…¶å®ƒæ›´æ–°\r\n\r\n```vue\r\n<template>\r\n  <input type=\"text\" v-model=\"name\" />\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { ref, watch } from \"vue\";\r\nfunction useStorage(name: string) {\r\n  const data = ref(sessionStorage.getItem(name) ?? \"\");\r\n  watch(data, (newValue) => {\r\n    sessionStorage.setItem(name, newValue);\r\n  });\r\n  return data;\r\n}\r\nconst name = useStorage(\"name\");\r\n</script>\r\n```\r\n\r\n* åç§°ä¸º useXXXX çš„å‡½æ•°ï¼Œä½œç”¨æ˜¯è¿”å›å¸¦æ‰©å±•åŠŸèƒ½çš„ã€å“åº”å¼ã€‘æ•°æ®\r\n* localStorage   å³ä½¿æµè§ˆå™¨å…³é—­ï¼Œæ•°æ®è¿˜åœ¨\r\n* sessionStorage  æ•°æ®å·¥ä½œåœ¨æµè§ˆå™¨æ´»åŠ¨æœŸé—´\r\n\r\n\r\n\r\n#### vueuse\r\n\r\nå®‰è£…\r\n\r\n```cmd\r\nnpm install @vueuse/core\r\n```\r\n\r\nä¸€äº›å‡½æ•°çš„ç”¨æ³•\r\n\r\n```vue\r\n<template>\r\n  <h3>X: {{x}}</h3>\r\n  <h3>Y: {{y}}</h3>\r\n\r\n  <h3>{{count}}</h3>\r\n  <input type=\"button\" @click=\"inc()\" value=\"+\">\r\n  <input type=\"button\" @click=\"dec()\" value=\"-\">\r\n\r\n  <input type=\"text\" v-model=\"name\">\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport { useMouse, useCounter, useStorage } from '@vueuse/core'\r\n\r\nconst {x, y} = useMouse()\r\n\r\nconst {count, inc, dec} = useCounter()\r\n\r\nconst name = useStorage(\"name\", \"\")\r\n</script>\r\n```\r\n\r\n\r\n\r\n#### useRequest\r\n\r\nå“åº”å¼çš„ axios å°è£…ï¼Œå®˜ç½‘åœ°å€ [ä¸€ä¸ª Vue è¯·æ±‚åº“ | VueRequest (attojs.org)](https://next.cn.attojs.org/)\r\n\r\né¦–å…ˆå®‰è£… vue-request\r\n\r\n```cmd\r\nnpm install vue-request@next\r\n```\r\n\r\nç»„ä»¶\r\n\r\n```vue\r\n<template>\r\n  <h3 v-if=\"students.length === 0\">æš‚æ— æ•°æ®</h3>\r\n  <ul v-else>\r\n    <li v-for=\"s of students\" :key=\"s.id\">\r\n      <span>{{s.name}}</span>\r\n      <span>{{s.sex}}</span>\r\n      <span>{{s.age}}</span>\r\n    </li>\r\n  </ul>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport axios from \"../api/request\"\r\nimport { useRequest } from 'vue-request'\r\nimport { computed } from 'vue'\r\nimport { AxiosRespList, Student } from '../model/Model8080'\r\n\r\n// data ä»£è¡¨å°±æ˜¯ axios çš„å“åº”å¯¹è±¡\r\nconst { data } = useRequest<AxiosRespList<Student>>(() => axios.get('/api/students'))\r\n\r\nconst students = computed(()=>{\r\n  return data?.value?.data.data || []\r\n})\r\n</script>\r\n<style scoped>\r\nul li {\r\n  list-style: none;\r\n  font-family: \"åæ–‡è¡Œæ¥·\";\r\n}\r\n\r\nli span:nth-child(1) {\r\n  font-size: 24px;\r\n}\r\nli span:nth-child(2) {\r\n  font-size: 12px;\r\n  color: crimson;\r\n  vertical-align: bottom;\r\n}\r\nli span:nth-child(3) {\r\n  font-size: 12px;\r\n  color: darkblue;\r\n  vertical-align: top;\r\n}\r\n</style>\r\n```\r\n\r\n* data.value çš„å–å€¼ä¸€å¼€å§‹æ˜¯ undefinedï¼Œéšç€å“åº”è¿”å›å˜æˆ axios çš„å“åº”å¯¹è±¡\r\n* ç”¨ computed è¿›è¡Œé€‚é…\r\n\r\n\r\n\r\n#### usePagination\r\n\r\nåœ¨ src/model/Model8080.ts ä¸­è¡¥å……ç±»å‹è¯´æ˜\r\n\r\n```typescript\r\nexport interface StudentQueryDto {\r\n  name?: string,\r\n  sex?: string,\r\n  age?: string, // 18,20\r\n  page: number,\r\n  size: number\r\n}\r\n```\r\n\r\n* js ä¸­ç±»ä¼¼äº 18,20 è¿™æ ·ä»¥é€—å·åˆ†éš”å­—ç¬¦ä¸²ï¼Œä¼šåœ¨ get ä¼ å‚æ—¶è½¬æ¢ä¸º java ä¸­çš„æ•´æ•°æ•°ç»„\r\n\r\nç¼–å†™ç»„ä»¶\r\n\r\n```vue\r\n<template>\r\n  <input type=\"text\" placeholder=\"è¯·è¾“å…¥å§“å\" v-model=\"dto.name\">\r\n  <select v-model=\"dto.sex\">\r\n    <option value=\"\" selected>è¯·é€‰æ‹©æ€§åˆ«</option>\r\n    <option value=\"ç”·\">ç”·</option>\r\n    <option value=\"å¥³\">å¥³</option>\r\n  </select>\r\n  <input type=\"text\" placeholder=\"è¯·è¾“å…¥å¹´é¾„èŒƒå›´\" v-model=\"dto.age\">\r\n  <br>\r\n  <input type=\"text\" placeholder=\"è¯·è¾“å…¥é¡µç \" v-model=\"dto.page\">\r\n  <input type=\"text\" placeholder=\"è¯·è¾“å…¥é¡µå¤§å°\" v-model=\"dto.size\">\r\n  <input type=\"button\" value=\"æœç´¢\" @click=\"search\">\r\n  <hr>\r\n  <h3 v-if=\"students.length === 0\">æš‚æ— æ•°æ®</h3>\r\n  <ul v-else>\r\n    <li v-for=\"s of students\" :key=\"s.id\">\r\n      <span>{{s.name}}</span>\r\n      <span>{{s.sex}}</span>\r\n      <span>{{s.age}}</span>\r\n    </li>\r\n  </ul>\r\n  <hr>\r\n  æ€»è®°å½•æ•°{{total}} æ€»é¡µæ•°{{totalPage}}\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport axios from \"../api/request\"\r\nimport { usePagination } from 'vue-request'\r\nimport { computed, ref } from 'vue'\r\nimport { AxiosRespPage, Student, StudentQueryDto } from '../model/Model8080'\r\n\r\nconst dto = ref<StudentQueryDto>({name:'', sex:'', age:'', page:1, size:5})\r\n\r\n// data ä»£è¡¨å°±æ˜¯ axios çš„å“åº”å¯¹è±¡\r\n// æ³›å‹å‚æ•°1: å“åº”ç±»å‹\r\n// æ³›å‹å‚æ•°2: è¯·æ±‚ç±»å‹\r\nconst { data, total, totalPage, run } = usePagination<AxiosRespPage<Student>, StudentQueryDto[]>(\r\n  (d) => axios.get('/api/students/q', {params: d}), // ç®­å¤´å‡½æ•°\r\n  {\r\n    defaultParams: [ dto.value ], // é»˜è®¤å‚æ•°, ä¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸Šé¢çš„ç®­å¤´å‡½æ•°\r\n    pagination: {\r\n      currentKey: 'page', // æŒ‡æ˜å½“å‰é¡µå±æ€§\r\n      pageSizeKey: 'size', // æŒ‡æ˜é¡µå¤§å°å±æ€§\r\n      totalKey: 'data.data.total' // æŒ‡æ˜æ€»è®°å½•æ•°å±æ€§\r\n    } \r\n  } // é€‰é¡¹\r\n)\r\n\r\nconst students = computed(()=>{\r\n  return data?.value?.data.data.list || []\r\n})\r\n\r\nfunction search() {\r\n  run(dto.value) // ä¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™usePaginationçš„ç®­å¤´å‡½æ•°\r\n}\r\n</script>\r\n<style scoped>\r\nul li {\r\n  list-style: none;\r\n  font-family: \"åæ–‡è¡Œæ¥·\";\r\n}\r\n\r\nli span:nth-child(1) {\r\n  font-size: 24px;\r\n}\r\nli span:nth-child(2) {\r\n  font-size: 12px;\r\n  color: crimson;\r\n  vertical-align: bottom;\r\n}\r\nli span:nth-child(3) {\r\n  font-size: 12px;\r\n  color: darkblue;\r\n  vertical-align: top;\r\n}\r\ninput,select {\r\n  width: 100px;\r\n}\r\n</style>\r\n```\r\n\r\n* usePagination åªéœ€è¦å®šä¹‰ä¸€æ¬¡ï¼Œåç»­è¿˜æƒ³ç”¨å®ƒå†…éƒ¨çš„ axios å‘è¯·æ±‚ï¼Œåªéœ€è°ƒç”¨ run å‡½æ•°\r\n\r\n\r\n\r\n#### å­ç»„ä»¶\r\n\r\n##### ä¾‹1\r\n\r\nå®šä¹‰å­ç»„ä»¶ Child1\r\n\r\n```vue\r\n<template>\r\n  <div class=\"container\">\r\n    <div class=\"card\">\r\n      <div>\r\n        <p class=\"name\">{{name}}</p>\r\n        <p class=\"location\">{{country}}</p>\r\n      </div>\r\n      <img :src=\"avatar || '/src/assets/vue.svg'\"/>\r\n    </div>\r\n  </div>\r\n</template>\r\n<script setup lang=\"ts\">\r\n// å®šä¹‰å±æ€§,  ç¼–è¯‘å®\r\ndefineProps<{name:string,country:string,avatar?:string}>()\r\n</script>\r\n<style scoped>\r\n.container {\r\n  width: 100%;\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n  justify-content: space-evenly;\r\n  flex-direction: row-reverse;\r\n}\r\n.name {\r\n  font-weight: bold;\r\n}\r\n.location {\r\n  font-size: 0.8em;\r\n  color: #6d597a;\r\n}\r\n.card {\r\n  display: flex;\r\n  justify-content: space-evenly;\r\n  padding: 1em;\r\n  margin: 1rem;\r\n  border-radius: 5px;\r\n  background: #fff;\r\n  width: 200px;\r\n  box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);\r\n}\r\n\r\n.card:hover {\r\n  transform: rotate(-5deg);\r\n}\r\n\r\n.card img {\r\n  margin-left: 1em;\r\n  border-radius: 50%;\r\n  max-width: 55px;\r\n  max-height: 55px;\r\n}\r\n</style>\r\n```\r\n\r\nçˆ¶ç»„ä»¶å¼•ç”¨\r\n\r\n```vue\r\n<template>\r\n  <Child1 name=\"å¼ ä¸‰\" country=\"ä¸­å›½\" avatar=\"/src/assets/vue.svg\"></Child1>\r\n  <Child1 name=\"æå››\" country=\"å°åº¦\" avatar=\"/vite.svg\"></Child1>\r\n  <Child1 name=\"ç‹äº”\" country=\"éŸ©å›½\" ></Child1>\r\n</template>\r\n<script lang=\"ts\" setup>\r\nimport Child1 from '../components/Child1.vue';\r\n</script>\r\n```\r\n\r\n\r\n\r\n##### ä¾‹2\r\n\r\né¦–å…ˆæ·»åŠ ç±»å‹è¯´æ˜ model/ModelRandomUser.ts\r\n\r\n```typescript\r\nimport { AxiosResponse } from \"axios\";\r\nexport interface AxiosRespResults extends AxiosResponse<Results>{}\r\n\r\nexport interface Results {\r\n  info: {\r\n    page: number,\r\n    results: number\r\n  },\r\n  results: Result[]\r\n}\r\n\r\nexport interface Result {\r\n  gender: 'male' | 'female',\r\n  name: {\r\n    first: string,\r\n    last: string\r\n  },\r\n  location: {\r\n    country: string\r\n  },\r\n  picture: {\r\n    medium: string\r\n  },\r\n  login: {\r\n    username: string\r\n  }\r\n}\r\n```\r\n\r\nå­ç»„ä»¶ä¸å˜ï¼Œçˆ¶ç»„ä»¶ä½¿ç”¨å­ç»„ä»¶\r\n\r\n```vue\r\n<!-- çˆ¶ç»„ä»¶ -->\r\n<template>\r\n  <Child1 v-for=\"u of users\" \r\n    :name=\"u.name.first\" \r\n    :country=\"u.location.country\" \r\n    :avatar=\"u.picture.medium\"\r\n    :key=\"u.login.username\"></Child1>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport axios from \"axios\";\r\nimport { useRequest } from \"vue-request\";\r\nimport { computed } from \"vue\";\r\nimport { AxiosRespResults } from '../model/ModelRandomUser'\r\nimport Child1 from \"../components/Child1.vue\";\r\n\r\nconst { data } = useRequest<AxiosRespResults>(\r\n  ()=>axios.get('https://randomuser.me/api/?results=3')\r\n)\r\n\r\nconst users = computed(()=>{\r\n  return data.value?.data.results || []\r\n})\r\n</script>\r\n```\r\n\r\nå¦‚æœè§‰å¾— Result æ•°æ®ç»“æ„åµŒå¥—å¤ªå¤æ‚ï¼Œè¿˜å¯ä»¥åšä¸€ä¸ªç±»å‹æ˜ å°„\r\n\r\n```vue\r\n<!-- çˆ¶ç»„ä»¶ -->\r\n<template>\r\n  <Child1 v-for=\"u of users\" \r\n    :name=\"u.name\" \r\n    :country=\"u.country\" \r\n    :avatar=\"u.avatar\"\r\n    :key=\"u.username\"></Child1>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport axios from \"axios\";\r\nimport { useRequest } from \"vue-request\";\r\nimport { computed } from \"vue\";\r\nimport { AxiosRespResults, Result } from '../model/ModelRandomUser'\r\nimport Child1 from \"../components/Child1.vue\";\r\n\r\nconst { data } = useRequest<AxiosRespResults>(\r\n  ()=>axios.get('https://randomuser.me/api/?results=3')\r\n)\r\n\r\nconst users = computed(()=>{\r\n  return data.value?.data.results.map(resultToUser) || []\r\n})\r\n\r\ninterface User {\r\n  name: string,\r\n  country: string,\r\n  avatar: string,\r\n  username: string\r\n}\r\nfunction resultToUser(r:Result):User {\r\n  return {\r\n    name: r.name.first,\r\n    country: r.location.country,\r\n    avatar: r.picture.medium,\r\n    username: r.login.username\r\n  }\r\n}\r\n</script>\r\n```\r\n\r\n* resultToUser å°† Result ç±»å‹æ˜ å°„ä¸º User ç±»å‹\r\n\r\n\r\n\r\n## 3. Vue è¿›é˜¶\r\n\r\n### 1) Antdv\r\n\r\næ·»åŠ å¿…è¦æ’ä»¶\r\n\r\n```cmd\r\nnpm install ant-design-vue\r\n```\r\n\r\n* ant-design-vue ç»„ä»¶åº“æ’ä»¶\r\n\r\nå¼•å…¥ antdv åŠŸèƒ½ï¼Œä¿®æ”¹ main.ts\r\n\r\n```typescript\r\nimport { createApp } from 'vue'\r\nimport './style.css'\r\nimport App from './App.vue'\r\nimport antd from 'ant-design-vue'\r\nimport 'ant-design-vue/dist/antd.css'\r\n\r\ncreateApp(App).use(antd).mount('#app')\r\n```\r\n\r\n\r\n\r\n#### è¡¨æ ¼\r\n\r\n```vue\r\n<template>\r\n  <!-- <a-table :columns=\"columns\" :dataSource=\"students\" rowKey=\"id\"></a-table> -->\r\n  <a-table :columns=\"columns\" :dataSource=\"students\" :rowKey=\"rowKey\"></a-table>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport axios from \"../api/request\";\r\nimport { ref, computed } from \"vue\";\r\nimport { useRequest } from \"vue-request\";\r\nimport { AxiosRespList, Student } from \"../model/Model8080\";\r\n\r\nconst {data} = useRequest<AxiosRespList<Student>>(\r\n  ()=>axios.get('/api/students')\r\n)\r\n\r\nconst students = computed(()=>{\r\n  return data.value?.data.data || []\r\n})\r\n\r\nfunction rowKey(r:Student) {\r\n  return r.id\r\n}\r\n\r\nconst columns = ref([\r\n  {\r\n    title:'ç¼–å·',\r\n    dataIndex:'id'\r\n  },\r\n  {\r\n    title:'å§“å',\r\n    dataIndex:'name'\r\n  },\r\n  {\r\n    title:'æ€§åˆ«',\r\n    dataIndex:'sex'\r\n  },\r\n  {\r\n    title:'å¹´é¾„',\r\n    dataIndex:'age'\r\n  }\r\n])\r\n</script>\r\n```\r\n\r\n\r\n\r\n#### åˆ†é¡µ\r\n\r\n```vue\r\n<template>\r\n  <a-table :columns=\"columns\" :data-source=\"students\" row-key=\"id\"\r\n   :pagination=\"pagination\" @change=\"tableChange\"></a-table>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport axios from \"../api/request\";\r\nimport { ref, computed } from \"vue\";\r\nimport { usePagination } from \"vue-request\";\r\nimport { AxiosRespPage, Student, StudentQueryDto } from \"../model/Model8080\";\r\nimport { PaginationProps } from \"ant-design-vue\";\r\nimport DateBody from \"ant-design-vue/lib/vc-picker/panels/DatePanel/DateBody\";\r\n\r\nconst dto = ref({page: 1, size: 5})\r\n\r\nconst {data, total, run} = usePagination<AxiosRespPage<Student>, StudentQueryDto[]>(\r\n  (d)=> axios.get('/api/students/q', {params:d}),\r\n  {\r\n    defaultParams: [dto.value],\r\n    pagination: {\r\n      currentKey: \"page\",\r\n      pageSizeKey: 'size',\r\n      totalKey: 'data.data.total'\r\n    }\r\n  }\r\n)\r\n\r\n// åœ¨é¡µå·æˆ–é¡µå¤§å°æ”¹å˜æ—¶è°ƒç”¨\r\nfunction tableChange(pagination: PaginationProps) { \r\n  console.log(pagination)\r\n  dto.value.page = pagination.current ?? 1\r\n  dto.value.size = pagination.pageSize ?? 5\r\n  run(dto.value)\r\n}\r\n\r\nconst pagination = computed<PaginationProps>(()=>{\r\n  return {\r\n    current: dto.value.page, // å½“å‰é¡µ\r\n    pageSize: dto.value.size, // é¡µå¤§å°\r\n    total: total.value,       // æ€»è®°å½•æ•°\r\n    showSizeChanger: true,    // æ˜¾ç¤ºé¡µå¤§å°çš„ä¸‹æ‹‰åˆ—è¡¨\r\n    pageSizeOptions: [\"1\",\"2\",\"3\",\"4\",\"5\"] // è‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨å†…å®¹\r\n  }\r\n})\r\n\r\nconst students = computed(()=>{\r\n  return data.value?.data.data.list || []\r\n})\r\n\r\nconst columns = ref([\r\n  {\r\n    title: \"ç¼–å·\",\r\n    dataIndex: \"id\",\r\n  },\r\n  {\r\n    title: \"å§“å\",\r\n    dataIndex: \"name\",\r\n  },\r\n  {\r\n    title: \"æ€§åˆ«\",\r\n    dataIndex: \"sex\",\r\n  },\r\n  {\r\n    title: \"å¹´é¾„\",\r\n    dataIndex: \"age\",\r\n  },\r\n]);\r\n</script>\r\n```\r\n\r\n\r\n\r\n#### æœç´¢ã€åˆ é™¤\r\n\r\n```vue\r\n<template>\r\n  <a-row>\r\n    <a-col :span=\"2\">\r\n      <a-button type=\"primary\" size=\"small\">æ–°å¢</a-button>\r\n    </a-col>\r\n    <a-col :span=\"4\">\r\n      <a-popconfirm title=\"ç¡®è®¤è¦åˆ é™¤é€‰ä¸­å­¦ç”Ÿå—?\"\r\n        ok-text=\"ç¡®å®š\" cancel-text=\"å–æ¶ˆ\" @confirm=\"onDeleteIds\"\r\n        @visibleChange=\"onVisibleChange\" :visible=\"visible\">\r\n        <a-button type=\"primary\" size=\"small\">åˆ é™¤é€‰ä¸­</a-button>\r\n      </a-popconfirm>\r\n    </a-col>\r\n    <a-col :span=\"4\">\r\n    </a-col>\r\n    <a-col :span=\"4\">\r\n      <a-input v-model:value=\"dto.name\" placeholder=\"è¾“å§“å\" size=\"small\"></a-input>\r\n    </a-col>\r\n    <a-col :span=\"4\">\r\n      <a-select v-model:value=\"dto.sex\" placeholder=\"é€‰æ€§åˆ«\" :allowClear=\"true\" size=\"small\">\r\n        <a-select-option value=\"ç”·\">ç”·</a-select-option>\r\n        <a-select-option value=\"å¥³\">å¥³</a-select-option>\r\n      </a-select>\r\n    </a-col>\r\n    <a-col :span=\"4\">\r\n      <a-select v-model:value=\"dto.age\" placeholder=\"é€‰å¹´é¾„\" :allowClear=\"true\" size=\"small\">\r\n        <a-select-option value=\"0,20\">20ä»¥ä¸‹</a-select-option>\r\n        <a-select-option value=\"21,30\">21~30</a-select-option>\r\n        <a-select-option value=\"31,40\">31~40</a-select-option>\r\n        <a-select-option value=\"40,120\">40ä»¥ä¸Š</a-select-option>\r\n      </a-select>\r\n    </a-col>\r\n    <a-col :span=\"2\">\r\n      <a-button @click=\"tableChange\" type=\"primary\" size=\"small\">æœç´¢</a-button>\r\n    </a-col>\r\n  </a-row>\r\n  <hr>\r\n  <a-table :columns=\"columns\" :data-source=\"students\" row-key=\"id\"\r\n    :pagination=\"pagination\" @change=\"tableChange\"\r\n    :row-selection=\"{selectedRowKeys:ids,onChange:onSelectChange}\">\r\n    <template #bodyCell=\"{column, record}\">\r\n      <template v-if=\"column.dataIndex==='name'\">\r\n      {{record.name + (record.sex==='ç”·'?'(å¤§ä¾ )':'(å¥³ä¾ )')}}\r\n      </template>\r\n\r\n      <template v-else-if=\"column.dataIndex==='operation'\">\r\n      <a>ä¿®æ”¹</a>\r\n      <a-divider type=\"vertical\"></a-divider>\r\n      <a-popconfirm title=\"ç¡®è®¤è¦åˆ é™¤è¯¥å­¦ç”Ÿå—?\"\r\n        ok-text=\"ç¡®å®š\" cancel-text=\"å–æ¶ˆ\" @confirm=\"onDelete(record.id)\">\r\n        <a>åˆ é™¤</a>   \r\n      </a-popconfirm>         \r\n      </template>\r\n    </template>\r\n  </a-table>\r\n  \r\n</template>\r\n<script setup lang=\"ts\">\r\nimport axios from \"../api/request\";\r\nimport { ref, computed } from \"vue\";\r\nimport { usePagination, useRequest } from \"vue-request\";\r\nimport { AxiosRespPage, AxiosRespString, Student, StudentQueryDto } from \"../model/Model8080\";\r\nimport { PaginationProps } from \"ant-design-vue\";\r\n\r\n// >>>>>>>>>>>>>> æœç´¢åŠŸèƒ½å¼€å§‹\r\nconst dto = ref({page: 1, size: 5, name: '', sex: null, age: null})\r\n\r\nconst {data, total, run: search} = usePagination<AxiosRespPage<Student>, StudentQueryDto[]>(\r\n  (d) => axios.get('/api/students/q', {params:d}),\r\n  {\r\n    defaultParams: [dto.value],\r\n    pagination: {\r\n      currentKey: \"page\",\r\n      pageSizeKey: 'size',\r\n      totalKey: 'data.data.total'\r\n    }\r\n  }\r\n)\r\n\r\nfunction tableChange(pagination: PaginationProps) { \r\n  // console.log(pagination)\r\n  dto.value.page = pagination.current ?? 1\r\n  dto.value.size = pagination.pageSize ?? 5\r\n  search(dto.value)\r\n}\r\n\r\nconst pagination = computed<PaginationProps>(()=>{\r\n  return {\r\n    current: dto.value.page, // å½“å‰é¡µ\r\n    pageSize: dto.value.size, // é¡µå¤§å°\r\n    total: total.value,       // æ€»è®°å½•æ•°\r\n    showSizeChanger: true,    // æ˜¾ç¤ºé¡µå¤§å°çš„ä¸‹æ‹‰åˆ—è¡¨\r\n    pageSizeOptions: [\"1\",\"2\",\"3\",\"4\",\"5\"] // è‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨å†…å®¹\r\n  }\r\n})\r\n\r\nconst students = computed(()=>{\r\n  return data.value?.data.data.list || []\r\n})\r\n// <<<<<<<<<<<<<< æœç´¢åŠŸèƒ½ç»“æŸ\r\n\r\n\r\n// >>>>>>>>>>>>>> åˆ é™¤åŠŸèƒ½å¼€å§‹\r\nasync function onDelete(id:number) {\r\n  // console.log(\"å­¦ç”Ÿidæ˜¯:\"+id)\r\n  await deleteById(id)      // åˆ é™¤è¯·æ±‚ åˆ é™¤å“åº”\r\n  search(dto.value)        //                   æŸ¥è¯¢è¯·æ±‚ æŸ¥è¯¢å“åº”\r\n}\r\n\r\nconst { runAsync: deleteById } = useRequest<AxiosRespString, number[]>(\r\n  (id) => axios.delete(`/api/students/${id}`),\r\n  {\r\n    manual: true\r\n  }\r\n)\r\n// <<<<<<<<<<<<<< åˆ é™¤åŠŸèƒ½ç»“æŸ\r\n\r\n// >>>>>>>>>>>>>> åˆ é™¤é€‰ä¸­å¼€å§‹\r\nconst ids = ref<number[]>([])\r\n\r\nfunction onSelectChange(keys:number[]) {\r\n  // console.log(keys)\r\n  ids.value = keys\r\n}\r\n\r\nasync function onDeleteIds() {\r\n  await deleteByIds(ids.value)\r\n  ids.value = []\r\n  search(dto.value)\r\n}\r\n\r\nconst { runAsync: deleteByIds } = useRequest<AxiosRespString, number[][]>(\r\n  (ids)=>axios.delete('/api/students', {data: ids}),\r\n  {\r\n    manual: true\r\n  }\r\n)\r\n\r\nconst visible = ref(false)\r\n\r\nfunction onVisibleChange(v:boolean) {\r\n  if(!v) { // å¸Œæœ›éšè—\r\n    visible.value = false\r\n  } else { // å¸Œæœ›æ˜¾ç¤º\r\n    visible.value = ids.value.length > 0\r\n  }\r\n}\r\n// <<<<<<<<<<<<<< åˆ é™¤é€‰ä¸­ç»“æŸ\r\n\r\nconst columns = ref([\r\n  {\r\n    title: \"ç¼–å·\",\r\n    dataIndex: \"id\",\r\n  },\r\n  {\r\n    title: \"å§“å\",\r\n    dataIndex: \"name\",\r\n  },\r\n  {\r\n    title: \"æ€§åˆ«\",\r\n    dataIndex: \"sex\",\r\n  },\r\n  {\r\n    title: \"å¹´é¾„\",\r\n    dataIndex: \"age\",\r\n  },\r\n  {\r\n    title: 'æ“ä½œ',\r\n    dataIndex: 'operation'\r\n  }\r\n]);\r\n</script>\r\n<style scoped>\r\n  .ant-input, .ant-select {\r\n    width: 80px;\r\n  }\r\n</style>\r\n```\r\n\r\n\r\n\r\n#### æ–°å¢ã€ä¿®æ”¹\r\n\r\nå­ç»„ä»¶\r\n\r\n```vue\r\n<template>\r\n  <a-modal :visible=\"visible\" :title=\"title\" \r\n    @ok=\"onOk\" @cancel=\"onCancel\">\r\n    <a-form>\r\n      <a-form-item label=\"ç¼–å·\" v-if=\"id\">\r\n        <a-input readonly v-model:value=\"id\"></a-input>\r\n      </a-form-item>\r\n      <a-form-item label=\"å§“å\">\r\n        <a-input v-model:value=\"dto.name\"></a-input>\r\n      </a-form-item>\r\n      <a-form-item label=\"æ€§åˆ«\">\r\n        <a-radio-group v-model:value=\"dto.sex\">\r\n          <a-radio-button value=\"ç”·\">ç”·</a-radio-button>\r\n          <a-radio-button value=\"å¥³\">å¥³</a-radio-button>\r\n        </a-radio-group>\r\n      </a-form-item>\r\n      <a-form-item label=\"å¹´é¾„\">\r\n        <a-input-number v-model:value=\"dto.age\"></a-input-number>\r\n      </a-form-item>\r\n    </a-form>\r\n  </a-modal>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport axios from \"../api/request\";\r\nimport { ref, computed } from \"vue\";\r\nimport { useRequest } from \"vue-request\";\r\nimport { StudentSaveDto, AxiosRespString } from \"../model/Model8080\";\r\nimport { Form } from 'ant-design-vue'\r\n\r\n// å®šä¹‰å±æ€§\r\nconst props = defineProps<{id:number, dto:StudentSaveDto, visible:boolean}>()\r\n\r\nconst title = computed(()=> props.id===0?'æ–°å¢å­¦ç”Ÿ':'ä¿®æ”¹å­¦ç”Ÿ')\r\n\r\n// å®šä¹‰äº‹ä»¶\r\nconst emit = defineEmits(['update:visible', 'saved'])\r\n\r\nasync function onOk() {\r\n  if(props.id === 0) {\r\n    await insert(props.dto)\r\n  } else {\r\n    await update(props.dto)\r\n  }\r\n  emit('saved')\r\n  // å‘é€äº‹ä»¶ç»™çˆ¶ç»„ä»¶, å¸Œæœ›æŠŠ visible æ”¹ä¸º false\r\n  emit('update:visible', false) \r\n}\r\n\r\nfunction onCancel() {\r\n  // å‘é€äº‹ä»¶ç»™çˆ¶ç»„ä»¶, å¸Œæœ›æŠŠ visible æ”¹ä¸º false\r\n  emit('update:visible', false)\r\n}\r\n\r\nconst {runAsync:insert} = useRequest<AxiosRespString,StudentSaveDto[]>(\r\n  (dto)=>axios.post('/api/students', dto),\r\n  {\r\n    manual: true\r\n  }\r\n)\r\n\r\nconst {runAsync:update} = useRequest<AxiosRespString,StudentSaveDto[]>(\r\n  (dto)=>axios.put(`/api/students/${props.id}`, dto),\r\n  {\r\n    manual: true\r\n  }\r\n)\r\n</script>\r\n```\r\n\r\nçˆ¶ç»„ä»¶ä½¿ç”¨å­ç»„ä»¶\r\n\r\n```vue\r\n<A4Save :id=\"id\" :dto=\"saveDto\" v-model:visible=\"saveVisible\"></A4Save>\r\n\r\n<script setup lang=\"ts\">\r\n// ...\r\n// >>>>>>>>>>>>>> æ–°å¢ã€ä¿®æ”¹å¼€å§‹\r\nconst saveVisible = ref(false)\r\nconst id = ref(0)\r\nconst saveDto = reactive({name:'', sex:'ç”·', age:18})\r\n\r\nfunction onInsert() {\r\n  saveVisible.value = true\r\n  id.value = 0\r\n  Object.assign(saveDto, {name:'', sex:'ç”·', age:18})\r\n}\r\n\r\nfunction onUpdate(record: Student) {\r\n  saveVisible.value = true\r\n  id.value = record.id\r\n  Object.assign(saveDto, record)\r\n}\r\n\r\nfunction onSaved() {\r\n  search(dto.value)\r\n}    \r\n// <<<<<<<<<<<<<< æ–°å¢ã€ä¿®æ”¹ç»“æŸ\r\n</script>\r\n```\r\n\r\n* saveDto ä½¿ç”¨ reactive åŒ…è£…ï¼Œæ˜¯ä¸ºäº†è§£å†³åç»­è¡¨å•æ ¡éªŒå¤±æ•ˆé—®é¢˜\r\n\r\n* Object.assign æ˜¯å°†æºå¯¹è±¡ï¼ˆå‚æ•°2ï¼‰çš„å±æ€§å€¼èµ‹å€¼ç»™ç›®æ ‡å¯¹è±¡ï¼ˆå‚æ•°1ï¼‰çš„åŒåå±æ€§ï¼Œæ•ˆæœç­‰ä»·äº\r\n\r\n  ```js\r\n  saveDto.name = record.name\r\n  saveDto.sex = record.sex\r\n  saveDto.age = record.age\r\n  ```\r\n\r\n\r\n\r\n#### å…¨å±€æ¶ˆæ¯\r\n\r\nåœ¨ request.ts ä¸­å¯¹å“åº”æ¶ˆæ¯ç»Ÿä¸€å¤„ç†\r\n\r\n```typescript\r\nimport { message } from 'ant-design-vue'\r\n\r\n// ...\r\n// å“åº”æ‹¦æˆªå™¨\r\n_axios.interceptors.response.use(\r\n  (response)=>{ // çŠ¶æ€ç   2xx\r\n    if(response.data.message) {\r\n      message.success(response.data.message, 3)\r\n    }    \r\n    // ... \r\n  },\r\n  (error)=>{ // çŠ¶æ€ç  > 2xx, 400,401,403,404,500\r\n    // ...\r\n  }\r\n)\r\n```\r\n\r\n\r\n\r\n#### è¡¨å•æ ¡éªŒ\r\n\r\n```vue\r\n<template>\r\n  <a-modal :visible=\"visible\" :title=\"title\" \r\n    @ok=\"onOk\" @cancel=\"onCancel\">\r\n    <a-form>\r\n      <a-form-item label=\"ç¼–å·\" v-if=\"id\">\r\n        <a-input readonly v-model:value=\"id\"></a-input>\r\n      </a-form-item>\r\n      <a-form-item label=\"å§“å\" v-bind=\"validateInfos.name\">\r\n        <a-input v-model:value=\"dto.name\"></a-input>\r\n      </a-form-item>\r\n      <a-form-item label=\"æ€§åˆ«\" v-bind=\"validateInfos.sex\">\r\n        <a-radio-group v-model:value=\"dto.sex\">\r\n          <a-radio-button value=\"ç”·\">ç”·</a-radio-button>\r\n          <a-radio-button value=\"å¥³\">å¥³</a-radio-button>\r\n        </a-radio-group>\r\n      </a-form-item>\r\n      <a-form-item label=\"å¹´é¾„\" v-bind=\"validateInfos.age\">\r\n        <a-input-number v-model:value=\"dto.age\"></a-input-number>\r\n      </a-form-item>\r\n    </a-form>\r\n  </a-modal>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport axios from \"../api/request\";\r\nimport { ref, computed } from \"vue\";\r\nimport { useRequest } from \"vue-request\";\r\nimport { StudentSaveDto, AxiosRespString } from \"../model/Model8080\";\r\nimport { Form } from 'ant-design-vue'\r\n\r\n// å®šä¹‰å±æ€§\r\nconst props = defineProps<{id:number, dto:StudentSaveDto, visible:boolean}>()\r\n\r\nconst title = computed(()=> props.id===0?'æ–°å¢å­¦ç”Ÿ':'ä¿®æ”¹å­¦ç”Ÿ')\r\n\r\n// å®šä¹‰äº‹ä»¶\r\nconst emit = defineEmits(['update:visible', 'saved'])\r\n\r\nasync function onOk() {\r\n  try {\r\n    // æäº¤å‰æ ¡éªŒ\r\n    await validate()\r\n    if(props.id === 0) {\r\n      await insert(props.dto)\r\n    } else {\r\n      await update(props.dto)\r\n    }\r\n    emit('saved')\r\n    // å‘é€äº‹ä»¶ç»™çˆ¶ç»„ä»¶, å¸Œæœ›æŠŠ visible æ”¹ä¸º false\r\n    emit('update:visible', false) \r\n  } catch (e) {\r\n    console.error(e)\r\n  }\r\n}\r\n\r\nfunction onCancel() {\r\n  // å‘é€äº‹ä»¶ç»™çˆ¶ç»„ä»¶, å¸Œæœ›æŠŠ visible æ”¹ä¸º false\r\n  emit('update:visible', false)\r\n}\r\n\r\nconst {runAsync:insert} = useRequest<AxiosRespString,StudentSaveDto[]>(\r\n  (dto)=>axios.post('/api/students', dto),\r\n  {\r\n    manual: true\r\n  }\r\n)\r\n\r\nconst {runAsync:update} = useRequest<AxiosRespString,StudentSaveDto[]>(\r\n  (dto)=>axios.put(`/api/students/${props.id}`, dto),\r\n  {\r\n    manual: true\r\n  }\r\n)\r\n\r\nconst rules = ref({\r\n  name: [\r\n    {required: true, message:'å§“åå¿…é¡»'},\r\n    {min:2, message:'å­—ç¬¦æ•°è‡³å°‘ä¸º2'}\r\n  ],\r\n  sex: [\r\n    {required: true, message:'æ€§åˆ«å¿…é¡»'}\r\n  ],\r\n  age: [\r\n    {required: true, message:'å¹´é¾„å¿…é¡»'},\r\n    {min:10, message:'å¹´é¾„æœ€å°ä¸º10å²', type:'number'},\r\n    {max:120, message:'å¹´é¾„æœ€å¤§ä¸º120å²', type:'number'}\r\n  ]\r\n})\r\n\r\n// å‚æ•°1: å¾…æ ¡éªŒçš„æ•°æ®\r\n// å‚æ•°2: æ ¡éªŒè§„åˆ™\r\nconst { validateInfos, validate } = Form.useForm(props.dto, rules)\r\n</script>\r\n```\r\n\r\n\r\n\r\n### 2) vue-router\r\n\r\n#### å®‰è£…\r\n\r\n```cmd\r\nnpm install vue-router@4\r\n```\r\n\r\n\r\n\r\n#### åˆ›å»º router\r\n\r\né¦–å…ˆåˆ›å»ºä¸€ä¸ª /src/router/a5router.ts æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­å®šä¹‰è·¯ç”±\r\n\r\n```typescript\r\nimport {createRouter, createWebHashHistory} from 'vue-router'\r\nimport A51 from '../views/A51.vue'\r\nimport A52 from '../views/A52.vue'\r\n// è·¯ç”± => è·¯å¾„å’Œç»„ä»¶ä¹‹é—´çš„å¯¹åº”å…³ç³»\r\nconst routes = [\r\n  {\r\n    path: '/a1',\r\n    component: A51\r\n  },\r\n  {\r\n    path: '/a2', \r\n    component: A52\r\n  }\r\n]\r\n\r\nconst router = createRouter({ \r\n  history: createWebHashHistory(), // è·¯å¾„æ ¼å¼\r\n  routes: routes // è·¯ç”±æ•°ç»„\r\n})\r\n\r\nexport default router\r\n```\r\n\r\n* createWebHashHistory æ˜¯ç”¨ # ç¬¦å·ä½œä¸ºã€å•é¡µé¢ã€‘è·³è½¬æŠ€æœ¯ï¼Œä¸Šé¢ä¸¤ä¸ªè·¯ç”±è®¿é—®æ—¶è·¯å¾„æ ¼å¼ä¸º\r\n  * `http://localhost:7070/#/a1`\r\n  * `http://localhost:7070/#/a2`\r\n\r\n* æ¯ä¸ªè·¯ç”±éƒ½æœ‰ä¸¤ä¸ªå¿…é¡»å±æ€§\r\n\r\n  * pathï¼šè·¯å¾„\r\n\r\n  * componentï¼šç»„ä»¶\r\n\r\n* createRouter ç”¨æ¥åˆ›å»º router å¯¹è±¡ï¼Œä½œä¸ºé»˜è®¤å¯¼å‡º\r\n\r\néœ€è¦åœ¨ main.ts ä¸­å¯¼å…¥ router å¯¹è±¡ï¼š\r\n\r\n```typescript\r\n// ...\r\nimport A5 from './views/A5.vue'  // vue-router\r\nimport router from './router/a5router'\r\ncreateApp(A5).use(antdv).use(router).mount('#app')\r\n```\r\n\r\nA5 æ˜¯æ ¹ç»„ä»¶ï¼Œä¸å¿…åœ¨ router ä¸­å®šä¹‰ï¼Œä½†éœ€è¦åœ¨å…¶ä¸­å®šä¹‰ router-viewï¼Œç”¨æ¥æ§åˆ¶è·¯ç”±è·³è½¬åï¼ŒA51ã€A52 è¿™äº›ç»„ä»¶çš„æ˜¾ç¤ºä½ç½®ï¼Œå†…å®¹å¦‚ä¸‹\r\n\r\n```vue\r\n<template>\r\n  <div class=\"a5\">\r\n    <router-view></router-view>\r\n  </div>\r\n</template>\r\n```\r\n\r\næ•ˆæœå¦‚ä¸‹\r\n\r\n![image-20220926145812121](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220926145812121.png)\r\n\r\n![image-20220926145959690](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220926145959690.png)\r\n\r\n\r\n\r\n#### åŠ¨æ€å¯¼å…¥\r\n\r\n```typescript\r\nimport {createRouter, createWebHashHistory} from 'vue-router'\r\nimport A51 from '../views/A51.vue'\r\nimport A52 from '../views/A52.vue'\r\nconst routes = [\r\n  // ...\r\n  {\r\n    path: '/a3',\r\n    component: () => import('../views/A53.vue')\r\n  }\r\n]\r\n```\r\n\r\n* ç”¨ import å…³é”®å­—å¯¼å…¥ï¼Œæ•ˆæœæ˜¯æ‰“åŒ…æ—¶ä¼šå°†ç»„ä»¶çš„ js ä»£ç éƒ½æ‰“åŒ…æˆä¸€ä¸ªå¤§çš„ js æ–‡ä»¶ï¼Œå¦‚æœç»„ä»¶éå¸¸å¤šï¼Œä¼šå½±å“é¡µé¢åŠ è½½é€Ÿåº¦\r\n* è€Œ import å‡½æ•°å¯¼å…¥ï¼ˆåŠ¨æ€å¯¼å…¥ï¼‰ï¼Œåˆ™æ˜¯æŒ‰éœ€åŠ è½½ï¼Œå³\r\n  * å½“è·¯ç”±è·³è½¬åˆ° /a3 è·¯å¾„æ—¶ï¼Œæ‰ä¼šå»åŠ è½½ A53 ç»„ä»¶å¯¹åº”çš„ js ä»£ç \r\n  * vue-router å®˜æ–¹æ¨èé‡‡ç”¨åŠ¨æ€å¯¼å…¥\r\n\r\n\r\n\r\n#### åµŒå¥—è·¯ç”±\r\n\r\nå¦‚æœå¸Œæœ›å†åµŒå¥—æ›´æ·±å±‚æ¬¡çš„è·¯ç”±è·³è½¬ï¼Œä¾‹å¦‚ï¼šå¸Œæœ›åœ¨ A53 ç»„ä»¶å†…å†è¿›è¡Œè·¯ç”±è·³è½¬\r\n\r\n![image-20220926150819624](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220926150819624.png)\r\n\r\né¦–å…ˆï¼Œä¿®æ”¹ A53.vue\r\n\r\n```vue\r\n<template>\r\n  <div class=\"a53\">\r\n    <router-view></router-view>\r\n  </div>\r\n</template>\r\n```\r\n\r\nå…¶æ¬¡ï¼Œå†ä¿®æ”¹ /src/router/a5router.ts æ–‡ä»¶ å†…å®¹\r\n\r\n```typescript\r\nimport {createRouter, createWebHashHistory} from 'vue-router'\r\nimport A51 from '../views/A51.vue'\r\nimport A52 from '../views/A52.vue'\r\nconst routes = [\r\n  // ...\r\n  {\r\n    path: '/a3',\r\n    component: () => import('../views/A53.vue'),\r\n    children: [\r\n      {\r\n        path: 'student',\r\n        component: () => import('../views/A531.vue')\r\n      },\r\n      {\r\n        path: 'teacher',\r\n        component: () => import('../views/A532.vue')\r\n      }\r\n    ]\r\n  }\r\n]\r\n\r\n// ...\r\n```\r\n\r\nå°†æ¥è®¿é—® /a3/student æ—¶ï¼Œæ•ˆæœä¸º\r\n\r\n![image-20220926151216217](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220926151216217.png)\r\n\r\nè®¿é—® /a3/teacher æ—¶ï¼Œæ•ˆæœä¸º\r\n\r\n![image-20220926151249403](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220926151249403.png)\r\n\r\n\r\n\r\n#### é‡å®šå‘\r\n\r\nç”¨æ³•1\r\n\r\n```typescript\r\nimport {createRouter, createWebHashHistory} from 'vue-router'\r\nimport A51 from '../views/A51.vue'\r\nimport A52 from '../views/A52.vue'\r\nconst routes = [\r\n  // ...\r\n  {\r\n    path: '/a3',\r\n    component: () => import('../views/A53.vue'),\r\n    redirect: '/a3/student', // é‡å®šå‘åˆ°å¦å¤–è·¯å¾„\r\n    children: [\r\n      {\r\n        path: 'student',\r\n        component: () => import('../views/A531.vue')\r\n      },\r\n      {\r\n        path: 'teacher',\r\n        component: () => import('../views/A532.vue')\r\n      }\r\n    ]\r\n  }\r\n]\r\n// ...\r\n```\r\n\r\næ•ˆæœæ˜¯ï¼Œé¡µé¢è¾“å…¥ /a3ï¼Œç´§æ¥ç€ä¼šé‡å®šå‘è·³è½¬åˆ° /a3/student\r\n\r\n\r\n\r\nç”¨æ³•2\r\n\r\n```typescript\r\nimport {createRouter, createWebHashHistory} from 'vue-router'\r\nimport A51 from '../views/A51.vue'\r\nimport A52 from '../views/A52.vue'\r\nconst routes = [\r\n  {\r\n    path: '/a1',\r\n    component: A51\r\n  },\r\n  {\r\n    path: '/a2', \r\n    component: A52\r\n  },\r\n  // ...\r\n  {\r\n    path: '/:pathMatcher(.*)*', // å¯ä»¥åŒ¹é…å‰©ä½™çš„è·¯å¾„\r\n    redirect: '/a2'\r\n  }\r\n]\r\n// ...\r\n```\r\n\r\næ•ˆæœæ˜¯ï¼Œå½“é¡µé¢è¾“å…¥ä¸€ä¸ªä¸å­˜åœ¨è·¯å¾„ /aaa æ—¶ï¼Œä¼šè¢« `path: '/:pathMatcher(.*)*'` åŒ¹é…åˆ°ï¼Œç„¶åé‡å®šå‘è·³è½¬åˆ° A52 ç»„ä»¶å»\r\n\r\n\r\n\r\n#### ä¸»é¡µå¸ƒå±€\r\n\r\nå€ŸåŠ© antdv çš„ layout ç»„ä»¶ï¼Œå¯ä»¥å®ç°ä¸»é¡µã€ä¸Šã€‘ã€å·¦ã€‘ã€å³ã€‘å¸ƒå±€\r\n\r\n```vue\r\n<template>\r\n  <div class=\"a53\">\r\n    <a-layout>\r\n      <a-layout-header></a-layout-header>\r\n      <a-layout>\r\n        <a-layout-sider></a-layout-sider>\r\n        <a-layout-content>\r\n          <router-view></router-view>\r\n        </a-layout-content>\r\n      </a-layout>\r\n    </a-layout>\r\n  </div>\r\n</template>\r\n<style scoped>\r\n.a53 {\r\n  height: 100%;\r\n  background-color: rgb(220, 225, 255);\r\n  background-image: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='35' y='10' font-size='14' font-family='system-ui, sans-serif' text-anchor='middle' dominant-baseline='middle'%3EA53(ä¸»é¡µ)%3C/text%3E%3C/svg%3E\");\r\n  padding: 20px;\r\n  box-sizing: border-box;\r\n}\r\n.ant-layout-header {\r\n  height: 50px;\r\n  background-color:darkseagreen;\r\n}\r\n\r\n.ant-layout-sider {\r\n  background-color:lightsalmon;\r\n}\r\n\r\n.ant-layout-content {\r\n  background-color: aliceblue;\r\n}\r\n\r\n.ant-layout-footer {\r\n  background-color:darkslateblue;\r\n  height: 30px;\r\n}\r\n\r\n.ant-layout {\r\n  height: 100%;\r\n}\r\n\r\n.ant-layout-has-sider {\r\n  height: calc(100% - 50px);\r\n}\r\n</style>\r\n```\r\n\r\n\r\n\r\n#### ä¾§è¾¹æ èœå•\r\n\r\n```vue\r\n<template>\r\n  <div class=\"a53\">\r\n    <a-layout>\r\n      <a-layout-header></a-layout-header>\r\n      <a-layout>\r\n        <a-layout-sider>\r\n          <a-menu theme=\"dark\" mode=\"inline\">\r\n            <a-menu-item :key=\"1\">\r\n              <router-link to=\"/a3/student\">èœå•1</router-link>\r\n            </a-menu-item>\r\n            <a-menu-item :key=\"2\">\r\n              <router-link to=\"/a3/teacher\">èœå•2</router-link>\r\n            </a-menu-item>\r\n            <a-menu-item :key=\"3\">èœå•3</a-menu-item>\r\n            <a-sub-menu :key=\"4\" title=\"èœå•4\">\r\n              <a-menu-item :key=\"41\">èœå•41</a-menu-item>\r\n              <a-menu-item :key=\"42\">èœå•42</a-menu-item>\r\n            </a-sub-menu>\r\n          </a-menu>\r\n        </a-layout-sider>\r\n        <a-layout-content>\r\n          <router-view></router-view>\r\n        </a-layout-content>\r\n      </a-layout>\r\n    </a-layout>\r\n  </div>\r\n</template>\r\n```\r\n\r\n* a-menu-item ä¸ a-sub-menu éƒ½å¿…é¡»ä¸º key å±æ€§å”¯ä¸€èµ‹å€¼ï¼Œå¦åˆ™ä¼šäº§ç”Ÿæ··ä¹±\r\n* router-link æ ‡ç­¾ç”¨æ¥åˆ‡æ¢è·¯ç”±ï¼Œto æ˜¯ç›®æ ‡è·¯ç”±çš„è·¯å¾„\r\n* theme å±æ€§å®šä¹‰èœå•çš„ä¸»é¢˜ï¼ˆé»˜è®¤äº®è‰²ä¸»é¢˜ï¼Œdark ä¸ºæš—è‰²ä¸»é¢˜ï¼‰\r\n* mode å±æ€§å®šä¹‰å­èœå•çš„å±•ç¤ºæ¨¡å¼ï¼ˆé»˜è®¤å¼¹å‡ºï¼Œinline æ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼‰\r\n\r\n\r\n\r\n#### èœå•å›¾æ ‡\r\n\r\nå®‰è£…å›¾æ ‡ä¾èµ–\r\n\r\n```cmd\r\nnpm install @ant-design/icons-vue\r\n```\r\n\r\nèœå•ä¸­ä½¿ç”¨å›¾æ ‡\r\n\r\n```vue\r\n<template>\r\n  <div class=\"a53\">\r\n    <a-layout>\r\n      <a-layout-header></a-layout-header>\r\n      <a-layout>\r\n        <a-layout-sider>\r\n          <a-menu theme=\"dark\" mode=\"inline\">\r\n            <a-menu-item :key=\"1\">\r\n              <template #icon>\r\n                <highlight-outlined />\r\n              </template>\r\n              <router-link to=\"/a3/student\">èœå•1</router-link>\r\n            </a-menu-item>\r\n            <a-menu-item :key=\"2\">\r\n              <template #icon>\r\n                <align-center-outlined />\r\n              </template>\r\n              <router-link to=\"/a3/teacher\">èœå•2</router-link>\r\n            </a-menu-item>\r\n            <a-menu-item :key=\"3\">\r\n              <template #icon>\r\n                <strikethrough-outlined />\r\n              </template>\r\n              èœå•3</a-menu-item>\r\n            <a-sub-menu :key=\"4\" title=\"èœå•4\">\r\n              <template #icon>\r\n                <sort-descending-outlined />\r\n              </template>\r\n              <a-menu-item :key=\"41\">èœå•41</a-menu-item>\r\n              <a-menu-item :key=\"42\">èœå•42</a-menu-item>\r\n            </a-sub-menu>\r\n          </a-menu>\r\n        </a-layout-sider>\r\n        <a-layout-content>\r\n          <router-view></router-view>\r\n        </a-layout-content>\r\n      </a-layout>\r\n    </a-layout>\r\n  </div>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport {HighlightOutlined, AlignCenterOutlined, StrikethroughOutlined, SortDescendingOutlined} from '@ant-design/icons-vue'\r\n</script>\r\n```\r\n\r\n* å›¾æ ‡ç»„ä»¶æ²¡æœ‰å…¨å±€ç»‘å®šï¼Œéœ€è¦ import ä¹‹åæ‰èƒ½ä½¿ç”¨\r\n* ç”¨ `<template #icon></template>` æ’æ§½ï¼Œæ‰èƒ½ç¡®å®šå›¾æ ‡å±•ç¤ºçš„ä½ç½®ï¼ˆèœå•æ–‡å­—ä¹‹å‰ï¼‰\r\n\r\n\r\n\r\n#### äºŒæ¬¡å°è£…å›¾æ ‡ç»„ä»¶\r\n\r\næœ€ç»ˆå¸Œæœ›ç”¨ç»Ÿä¸€çš„å›¾æ ‡ç»„ä»¶å»ä½¿ç”¨å›¾æ ‡ï¼Œå›¾æ ‡ååªæ˜¯ä½œä¸ºä¸€ä¸ªå±æ€§å€¼ä¼ é€’è¿›å»ï¼Œä¾‹å¦‚ï¼š\r\n\r\nä½¿ç”¨è€…\r\n\r\n```vue\r\n<template>\r\n  <a-icon icon=\"highlight-outlined\"></a-icon>\r\n  <a-icon icon=\"align-center-outlined\"></a-icon>\r\n  <a-icon icon=\"strikethrough-outlined\"></a-icon>\r\n  <a-icon icon=\"sort-descending-outlined\"></a-icon>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport AIcon from '../components/AIcon1.vue'\r\n</script>\r\n```\r\n\r\n##### æ–¹æ³•1ï¼Œä½¿ç”¨ vue ç»„ä»¶\r\n\r\n```vue\r\n<script lang=\"ts\" setup>\r\nimport {HighlightOutlined, AlignCenterOutlined, StrikethroughOutlined, SortDescendingOutlined} from '@ant-design/icons-vue'\r\nconst props = defineProps<{icon:string}>()\r\n</script>\r\n<template>\r\n  <highlight-outlined v-if=\"icon==='highlight-outlined'\"></highlight-outlined>\r\n  <align-center-outlined v-else-if=\"icon==='align-center-outlined'\"></align-center-outlined>\r\n  <strikethrough-outlined v-else-if=\"icon==='strikethrough-outlined'\"></strikethrough-outlined>\r\n  <sort-descending-outlined v-else-if=\"icon==='sort-descending-outlined'\"></sort-descending-outlined>\r\n</template>\r\n```\r\n\r\n* ç¼ºç‚¹ï¼šå®ç°å¤ªç¬¨\r\n\r\n##### æ–¹æ³•2ï¼Œä½¿ç”¨å‡½æ•°å¼ç»„ä»¶\r\n\r\n```typescript\r\nimport { h } from \"vue\"\r\nimport * as Icons from '@ant-design/icons-vue'\r\n\r\ninterface Module {\r\n  [p:string]: any\r\n}\r\n\r\n// å‚æ•°1: ç»„ä»¶å±æ€§\r\nconst AIcon = (props:{icon:string}) => {\r\n  // console.log(props.icon)\r\n  // console.log(Icons)\r\n  // å‚æ•°1: ç»„ä»¶å¯¹è±¡\r\n  const im: Module = Icons\r\n  return h(im[toCamelCase(props.icon)])\r\n}\r\n\r\nexport default AIcon\r\n\r\n// å°†-åˆ†éš”çš„å•è¯è½¬æ¢ä¸ºå¤§é©¼å³°å‘½åçš„å•è¯\r\nfunction toCamelCase(str: string) { // highlight-outlined\r\n  return str.split('-') // ['highlight', 'outlined']\r\n    .map((e)=> e.charAt(0).toUpperCase() + e.slice(1) ) // ['Highlight', 'Outlined']\r\n    .join('')\r\n}\r\n/*\r\nIcons çš„ç»“æ„å¦‚ä¸‹\r\n{\r\n  HighlightOutlined: HighlightOutlinedç»„ä»¶å¯¹è±¡,\r\n  MonitorOutlined: MonitorOutlinedç»„ä»¶å¯¹è±¡,\r\n  ...\r\n}\r\n*/\r\n```\r\n\r\n* éœ€è¦åŠ¨æ€ç”Ÿæˆæ ‡ç­¾çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å‡½æ•°å¼ç»„ä»¶\r\n\r\n##### æ–¹æ³•3ï¼Œä½¿ç”¨ jsx ç»„ä»¶\r\n\r\né¦–å…ˆï¼Œå®‰è£…  \r\n\r\n```cmd\r\nnpm install @vitejs/plugin-vue-jsx -D\r\n```\r\n\r\né…ç½® vite.config.ts\r\n\r\n```typescript\r\nimport { defineConfig } from 'vite'\r\nimport vue from '@vitejs/plugin-vue'\r\nimport vueJsx from '@vitejs/plugin-vue-jsx'\r\n\r\n// https://vitejs.dev/config/\r\nexport default defineConfig({\r\n  plugins: [vue(), vueJsx()]\r\n})\r\n```\r\n\r\nç¼–å†™ä¸€ä¸ª Hi.tsx ç»„ä»¶\r\n\r\n```tsx\r\nexport default {\r\n  props: {\r\n    msg: String\r\n  },\r\n  setup(props: { msg: string }) {\r\n    return () => <h5>{props.msg}</h5>\r\n  }\r\n}\r\n```\r\n\r\nç„¶åè¢«å…¶å®ƒç»„ä»¶ä½¿ç”¨\r\n\r\n```vue\r\n<script setup lang=\"ts\">\r\nimport Hi from '../components/Hi'\r\n</script>\r\n\r\n<template>\r\n  <Hi msg=\"Hello,World\"></Hi>\r\n</template>\r\n```\r\n\r\nç”¨ jsx å®ç°å›¾æ ‡ç»„ä»¶\r\n\r\n```typescript\r\nimport * as Icons from '@ant-design/icons-vue'\r\n\r\ninterface Module {\r\n  [p:string]: any\r\n}\r\n\r\nfunction toCamelCase(str: string) { // highlight-outlined\r\n  return str\r\n    .split(\"-\") // ['highlight', 'outlined']\r\n    .map((e) => e.charAt(0).toUpperCase() + e.slice(1)) // ['Highlight', 'Outlined']\r\n    .join(\"\"); // HighlightOutlined\r\n}\r\n\r\nexport default {\r\n  props: {\r\n    icon: String\r\n  },\r\n  setup(props: {icon: string}) {\r\n    const im: Module = Icons\r\n    const tag = im[toCamelCase(props.icon)] // å›¾æ ‡ç»„ä»¶\r\n    // HighlightOutlined\r\n    return ()=> <tag></tag> // è¿”å›ç»„ä»¶æ ‡ç­¾\r\n  }\r\n}\r\n```\r\n\r\n\r\n\r\n#### åŠ¨æ€è·¯ç”±ä¸èœå•\r\n\r\n##### è·¯ç”±æ–‡ä»¶\r\n\r\na6router.js\r\n\r\n```typescript\r\nimport { createRouter, createWebHashHistory } from 'vue-router'\r\nimport { useStorage } from '@vueuse/core'\r\nimport { Route, Menu } from '../model/Model8080'\r\nconst clientRoutes = [\r\n  {\r\n    path: '/login',\r\n    name: 'login',\r\n    component: () => import('../views/A6Login.vue')\r\n  },\r\n  {\r\n    path: '/404',\r\n    name: '404',\r\n    component: () => import('../views/A6NotFound.vue')\r\n  },\r\n  {\r\n    path: '/',\r\n    name: 'main',\r\n    component: () => import('../views/A6Main.vue')\r\n  },\r\n  {\r\n    path: '/:pathMatcher(.*)*',\r\n    name: 'remaining',\r\n    redirect: '/404'\r\n  }\r\n]\r\n\r\nconst router = createRouter({\r\n  history: createWebHashHistory(),\r\n  routes: clientRoutes\r\n})\r\n\r\nexport const serverMenus = useStorage<Menu[]>('serverMenus', [])\r\nconst serverRoutes = useStorage<Route[]>('serverRoutes', [])\r\naddServerRoutes(serverRoutes.value)\r\n\r\nexport function addServerRoutes(routeList: Route[]) {\r\n  for (const r of routeList) {\r\n    if (r.parentName) {\r\n      router.addRoute(r.parentName, {\r\n        path: r.path,\r\n        component: () => import(r.component),\r\n        name: r.name\r\n      })\r\n    }\r\n  }\r\n  serverRoutes.value = routeList\r\n}\r\n\r\nexport function resetRoutes() {\r\n  for (const r of clientRoutes) {\r\n    router.addRoute(r)\r\n  }\r\n  serverRoutes.value = null\r\n  serverMenus.value = null\r\n}\r\n\r\nexport default router\r\n```\r\n\r\næœ¬æ–‡ä»¶é‡è¦çš„å‡½æ•°åŠå˜é‡\r\n\r\n* addServerRoutes å‡½æ•°å‘è·¯ç”±è¡¨ä¸­æ·»åŠ ç”±æœåŠ¡å™¨æä¾›çš„è·¯ç”±ï¼Œè·¯ç”±åˆ†æˆä¸¤éƒ¨åˆ†\r\n  * clientRoutes è¿™æ˜¯å®¢æˆ·ç«¯å›ºå®šçš„è·¯ç”±\r\n  * serverRoutes è¿™æ˜¯æœåŠ¡å™¨å˜åŒ–çš„è·¯ç”±ï¼Œå­˜å‚¨äº localStorage\r\n* resetRoutes å‡½æ•°ç”¨æ¥å°†è·¯ç”±é‡ç½®ä¸º clientRoutes \r\n  * vue-router@4 ä¸­çš„ addRoute æ–¹æ³•ä¼šã€è¦†ç›–ã€‘åŒåè·¯ç”±ï¼Œè¿™æ˜¯è¿™ç§å®ç°çš„å…³é”®\r\n  * å› æ­¤ï¼ŒæœåŠ¡å™¨è¿”å›çš„è·¯ç”±æœ€å¥½æ˜¯ main çš„å­è·¯ç”±ï¼Œè¿™æ ·é‡ç½®æ—¶å°±ä¼šæ¯”è¾ƒç®€å•ï¼Œç”¨ä¹‹å‰çš„ main ä¸€è¦†ç›–å°±å®Œäº‹äº†\r\n* serverMenus å˜é‡è®°å½•æœåŠ¡å™¨å˜åŒ–çš„èœå•ï¼Œå­˜å‚¨äº localStorage\r\n\r\n\r\n\r\n##### ç™»å½•ç»„ä»¶\r\n\r\nåŠ¨æ€è·¯ç”±åº”å½“åœ¨ç™»å½•æ—¶ç”Ÿæˆï¼ŒA6Login.vue\r\n\r\n```vue\r\n<template>\r\n  <div class=\"login\">\r\n    <a-form :label-col=\"{ span: 6 }\" autocomplete=\"off\">\r\n      <a-form-item label=\"ç”¨æˆ·å\" v-bind=\"validateInfos.username\">\r\n        <a-input v-model:value=\"dto.username\" />\r\n      </a-form-item>\r\n      <a-form-item label=\"å¯†ç \" v-bind=\"validateInfos.password\">\r\n        <a-input-password v-model:value=\"dto.password\" />\r\n      </a-form-item>\r\n      <a-form-item :wrapper-col=\"{ offset: 6, span: 16 }\">\r\n        <a-button type=\"primary\" @click=\"onClick\">Submit</a-button>\r\n      </a-form-item>      \r\n    </a-form>\r\n  </div>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport { ref, onMounted } from 'vue'\r\nimport { Form } from 'ant-design-vue'\r\nimport { useRouter } from 'vue-router'\r\nimport axios from '../api/request'\r\nimport { useRequest } from 'vue-request'\r\nimport { AxiosRespToken, LoginDto, AxiosRespMenuAndRoute } from '../model/Model8080'\r\nimport { resetRoutes, addServerRoutes, serverMenus } from '../router/a6router'\r\nconst dto = ref({username:'', password:''})\r\nconst rules = ref({\r\n  username: [\r\n    {required: true, message:'ç”¨æˆ·åå¿…å¡«'}\r\n  ],\r\n  password:[\r\n    {required: true, message:'å¯†ç å¿…å¡«'}\r\n  ]\r\n})\r\nconst { validateInfos, validate } = Form.useForm(dto, rules)\r\nconst router = useRouter()\r\nconst { runAsync:login } = useRequest<AxiosRespToken, LoginDto[]>((dto)=> axios.post('/api/loginJwt', dto), {manual:true})\r\nconst { runAsync:menu } = useRequest<AxiosRespMenuAndRoute, string[]>((username)=> axios.get(`/api/menu/${username}`), {manual:true})\r\nasync function onClick() {\r\n  try {\r\n    await validate()\r\n    const loginResp = await login(dto.value\r\n    if(loginResp.data.code === 200) { // ç™»å½•æˆåŠŸ\r\n      const token = loginResp.data.data.token\r\n      const menuResp = await menu(dto.value.username)\r\n      const routeList = menuResp.data.data.routeList\r\n      addServerRoutes(routeList)\r\n      serverMenus.value = menuResp.data.data.menuTree\r\n      router.push('/')\r\n    })\r\n  } catch (e) {\r\n    console.error(e)\r\n  }\r\n}\r\nonMounted(()=>{\r\n  resetRoutes()\r\n})\r\n</script>\r\n<style scoped>\r\n.login{\r\n  margin: 200px auto;\r\n  width: 25%;\r\n  padding: 20px;\r\n  height: 180px;\r\n  background-color: antiquewhite;\r\n}\r\n</style>\r\n```\r\n\r\n* ç™»å½•æˆåŠŸåå»è¯·æ±‚ `/api/menu/{username}`  è·å–è¯¥ç”¨æˆ·çš„èœå•å’Œè·¯ç”±\r\n* router.push æ–¹æ³•ç”¨æ¥ä»¥ç¼–ç¨‹æ–¹å¼è·³è½¬è‡³ä¸»é¡µè·¯ç”±\r\n\r\n\r\n\r\n##### ä¸»é¡µç»„ä»¶\r\n\r\nA6Main.vue\r\n\r\n```vue\r\n<template>\r\n  <div class=\"a6main\">\r\n    <a-layout>\r\n      <a-layout-header>\r\n      </a-layout-header>\r\n      <a-layout>\r\n        <a-layout-sider>\r\n          <a-menu mode=\"inline\" theme=\"dark\">\r\n            <template v-for=\"m1 of serverMenus\">\r\n              <a-sub-menu v-if=\"m1.children\" :key=\"m1.id\" :title=\"m1.title\">\r\n                <template #icon><a-icon :icon=\"m1.icon\"></a-icon></template>\r\n                <a-menu-item v-for=\"m2 of m1.children\" :key=\"m2.id\">\r\n                  <template #icon><a-icon :icon=\"m2.icon\"></a-icon></template>\r\n                  <router-link v-if=\"m2.routePath\" :to=\"m2.routePath\">{{m2.title}}</router-link>\r\n                  <span v-else>{{m2.title}}</span>\r\n                </a-menu-item>\r\n              </a-sub-menu>\r\n              <a-menu-item v-else :key=\"m1.id\">\r\n                <template #icon><a-icon :icon=\"m1.icon\"></a-icon></template>\r\n                <router-link v-if=\"m1.routePath\" :to=\"m1.routePath\">{{m1.title}}</router-link>\r\n                <span v-else>{{m1.title}}</span>\r\n              </a-menu-item>\r\n            </template>            \r\n          </a-menu>\r\n        </a-layout-sider>\r\n        <a-layout-content>\r\n          <router-view></router-view>\r\n        </a-layout-content>\r\n      </a-layout>\r\n    </a-layout>\r\n  </div>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport AIcon from '../components/AIcon3' // jsx icon ç»„ä»¶\r\nimport { serverMenus } from '../router/a6router'\r\n</script>\r\n<style scoped>\r\n.a6main {\r\n  height: 100%;\r\n  background-color: rgb(220, 225, 255);\r\n  box-sizing: border-box;\r\n}\r\n.ant-layout-header {\r\n  height: 50px;\r\n  background-color:darkseagreen;\r\n}\r\n\r\n.ant-layout-sider {\r\n  background-color:lightsalmon;\r\n}\r\n\r\n.ant-layout-content {\r\n  background-color: aliceblue;\r\n}\r\n\r\n.ant-layout-footer {\r\n  background-color:darkslateblue;\r\n  height: 30px;\r\n}\r\n\r\n.ant-layout {\r\n  height: 100%;\r\n}\r\n\r\n.ant-layout-has-sider {\r\n  height: calc(100% - 50px);\r\n}\r\n\r\n</style>\r\n```\r\n\r\n\r\n\r\n#### token ä½¿ç”¨\r\n\r\n1. è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä¾‹å¦‚æœåŠ¡å™¨ç«¯å¯ä»¥æŠŠç”¨æˆ·åã€è¯¥ç”¨æˆ·çš„è·¯ç”±ã€èœå•ä¿¡æ¯éƒ½ç»Ÿä¸€ä» token è¿”å›\r\n2. å‰ç«¯è·¯ç”±è·³è½¬ä¾æ®ï¼Œä¾‹å¦‚è·³è½¬å‰æ£€æŸ¥ tokenï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè¡¨ç¤ºæœªç™»å½•ï¼Œå°±é¿å…è·³è½¬è‡³æŸäº›è·¯ç”±\r\n3. åç«¯ api è®¿é—®ä¾æ®ï¼Œä¾‹å¦‚æ¯æ¬¡å‘è¯·æ±‚æºå¸¦ tokenï¼Œåç«¯éœ€è¦èº«ä»½æ ¡éªŒçš„ api éœ€è¦ç”¨åˆ°\r\n\r\n\r\n\r\n### 3) pinia\r\n\r\néœ€æ±‚ï¼šåœ¨ç»„ä»¶ p1 é‡Œæ›´æ–°äº†æ•°æ®ï¼Œä¸»é¡µç»„ä»¶ä¹ŸåŒæ­¥æ›´æ–°æ˜¾ç¤º\r\n\r\n![image-20220930172635166](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220930172635166.png)\r\n\r\n* storage è™½ç„¶å¯ä»¥å®ç°å¤šä¸ªç»„ä»¶çš„æ•°æ®å…±äº«ï¼Œä½†æ˜¯éœ€è¦ã€ä¸»åŠ¨è®¿é—®ã€‘æ‰èƒ½è·å–æ›´æ–°åçš„æ•°æ®\r\n* æœ¬ä¾‹ä¸­ç”±äºæ²¡æœ‰æ¶‰åŠä¸»é¡µç»„ä»¶çš„ mounted æ“ä½œï¼Œå› æ­¤å¹¶ä¸ä¼šã€ä¸»åŠ¨ã€‘è·å– storage çš„æ•°æ® \r\n\r\n\r\n\r\n#### å®‰è£…\r\n\r\n```cmd\r\nnpm install pinia\r\n```\r\n\r\nåœ¨ main.ts ä¸­å¼•å…¥\r\n\r\n```typescript\r\nimport { createPinia } from 'pinia'\r\n\r\n// ...\r\ncreateApp(A6).use(antdv).use(router).use(createPinia()).mount('#app')\r\n```\r\n\r\n\r\n\r\n#### å®šä¹‰Store\r\n\r\nå†æ–°å»º store ç›®å½•æ¥ç®¡ç†å…±äº«æ•°æ®ï¼Œä¸‹é¢æ˜¯ /src/store/UserInfo.ts\r\n\r\n```typescript\r\nimport axios from '../api/request'\r\nimport { defineStore } from \"pinia\"\r\nimport { UserInfoDto } from '../model/Model8080'\r\n\r\nexport const useUserInfo = defineStore('userInfo', {\r\n  state: () => {\r\n    return { username: '', name: '', sex: '' }\r\n  },\r\n  actions: {\r\n    async get(username: string) {\r\n      const resp = await axios.get(`/api/info/${username}`)\r\n      Object.assign(this, resp.data.data)\r\n    },\r\n    async update(dto: UserInfoDto) {\r\n      await axios.post('/api/info', dto)\r\n      Object.assign(this, dto)\r\n    }\r\n  }\r\n})\r\n```\r\n\r\n* å®šä¹‰äº† useUserInfo å‡½æ•°ï¼Œç”¨æ¥è·å–å…±äº«æ•°æ®ï¼Œå®ƒå¯èƒ½ç”¨äºå¤šä¸ªç»„ä»¶\r\n\r\n  * å‘½åä¹ æƒ¯ä¸Šï¼Œå‡½æ•°å˜é‡ä»¥ use æ‰“å¤´\r\n\r\n* state å®šä¹‰æ•°æ®æ ¼å¼\r\n\r\n* actions å®šä¹‰æ“ä½œæ•°æ®çš„æ–¹æ³•\r\n\r\n  * get æ–¹æ³•ç”¨æ¥è·å–ç”¨æˆ·ä¿¡æ¯\r\n\r\n  * update æ–¹æ³•ç”¨æ¥ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯\r\n\r\n\r\n* ç”±äº useRequest å¿…é¡»æ”¾åœ¨ setup å‡½æ•°å†…ï¼Œè¿™é‡Œç®€åŒ–èµ·è§ï¼Œç›´æ¥ä½¿ç”¨äº† axios\r\n\r\n\r\n\r\nè·å–ç”¨æˆ·ä¿¡æ¯\r\n\r\n```vue\r\n<template>\r\n  <div class=\"a6main\">\r\n    <a-layout>\r\n      <a-layout-header>\r\n        <span>{{serverUsername}} ã€{{userInfo.name}} - {{userInfo.sex}}ã€‘</span>\r\n      </a-layout-header>\r\n      <a-layout>\r\n        <!-- ... -->\r\n      </a-layout>\r\n    </a-layout>\r\n  </div>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport { onMounted } from 'vue';\r\nimport AIcon from '../components/AIcon3' // jsx icon ç»„ä»¶\r\nimport { serverMenus, serverUsername } from '../router/a6router'\r\nimport { useUserInfo } from '../store/UserInfo'\r\nconst userInfo = useUserInfo()\r\n\r\nonMounted(()=>{\r\n  userInfo.get(serverUsername.value)\r\n})\r\n</script>\r\n```\r\n\r\n\r\n\r\nä¿®æ”¹ç”¨æˆ·ä¿¡æ¯\r\n\r\n```vue\r\n<template>\r\n  <div class=\"a6p1\">\r\n    <h3>ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯</h3>\r\n    <hr>\r\n    <a-form>\r\n      <a-form-item label=\"ç”¨æˆ·å\">\r\n        <a-input readonly v-model:value=\"dto.username\"></a-input>\r\n      </a-form-item>\r\n      <a-form-item label=\"å§“å\" v-bind=\"validateInfos.name\">\r\n        <a-input v-model:value=\"dto.name\"></a-input>\r\n      </a-form-item>\r\n      <a-form-item label=\"æ€§åˆ«\">\r\n        <a-radio-group v-model:value=\"dto.sex\">\r\n          <a-radio-button value=\"ç”·\">ç”·</a-radio-button>\r\n          <a-radio-button value=\"å¥³\">å¥³</a-radio-button>\r\n        </a-radio-group>\r\n      </a-form-item>\r\n    </a-form>\r\n    <a-button type=\"primary\" @click=\"onClick\">ç¡®å®š</a-button>\r\n  </div>\r\n</template>\r\n<script setup lang=\"ts\">\r\nimport { Form } from 'ant-design-vue'\r\nimport { onMounted, ref } from 'vue'\r\nimport { UserInfoDto } from '../model/Model8080'\r\nimport { useUserInfo } from '../store/UserInfo';\r\nconst dto = ref<UserInfoDto>({ username: '', name: '', sex: '' })\r\nconst userInfo = useUserInfo()\r\nonMounted(()=>{\r\n  Object.assign(dto.value, userInfo)\r\n})\r\nconst rules = ref({\r\n  name: [\r\n    {required: true, message:'å§“åå¿…å¡«'}\r\n  ]\r\n})\r\nconst { validateInfos, validate } = Form.useForm(dto, rules)\r\nasync function onClick() {\r\n  try {\r\n    await validate()\r\n    await userInfo.update(dto.value)\r\n  } catch (e) {\r\n    console.error(e)\r\n  }\r\n}\r\n</script>\r\n```\r\n\r\n* ä¸èƒ½ç›´æ¥æŠŠ userInfo ç»‘å®šåˆ°è¡¨å•ï¼Œéœ€è¦ dto ä¸­è½¬ä¸€ä¸‹\r\n* userInfo.update å’Œ useInfo.get è¿”å›çš„éƒ½æ˜¯ Promise å¯¹è±¡ï¼Œå¯ä»¥é…åˆ await ä¸€èµ·ç”¨\r\n\r\n\r\n\r\n### åè®°\r\n\r\nvite + vue3 + vue-router + ts è¿˜æ²¡æœ‰å¤ªå¤šæˆç†Ÿçš„é¡¹ç›®èŒƒä¾‹ï¼Œå¯ä»¥å‚è€ƒ [GitHub - sendya/preview-pro: Use pro-layout in vitejs. preview https://sendya.github.io/preview-pro/index.html](https://github.com/sendya/preview-pro)ï¼Œå®ƒæä¾›äº†åŸºæœ¬çš„å¸ƒå±€å’Œæ ·ä¾‹ä»£ç \r\n"},{"title":"åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦-xxlJob","tags":["Spring Cloud","Spring Boot","minio","xxlJob","freemarker","elasticsearch"],"categories":["Java","å¾®ç³»ç»Ÿä¸ç¬¬ä¸‰æ–¹æ¡†æ¶"],"author":"imklaus","excerpt":"\r\n\r\nå‚è€ƒè§†é¢‘ï¼š[é»‘é©¬å­¦æˆåœ¨çº¿é¡¹ç›®](https://www.bilibili.com/video/BV1j8411N7Bm/)\r\n\r\n","link":"/posts/xxlJob","content":"\r\n\r\nå‚è€ƒè§†é¢‘ï¼š[é»‘é©¬å­¦æˆåœ¨çº¿é¡¹ç›®](https://www.bilibili.com/video/BV1j8411N7Bm/)\r\n\r\n<!-- more -->\r\n\r\n\r\n\r\n## **ä¸€ åˆ†å¸ƒå¼ä»»åŠ¡å¤„ç†**\r\n\r\n### **1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦**\r\n\r\nå¯¹ä¸€ä¸ªè§†é¢‘çš„è½¬ç å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œï¼Œå¦‚æœè§†é¢‘çš„æ•°é‡æ¯”è¾ƒå¤šï¼Œå¦‚ä½•å»é«˜æ•ˆå¤„ç†ä¸€æ‰¹ä»»åŠ¡å‘¢ï¼Ÿ\r\n\r\n1ã€å¤šçº¿ç¨‹\r\n\r\nå¤šçº¿ç¨‹æ˜¯å……åˆ†åˆ©ç”¨å•æœºçš„èµ„æºã€‚\r\n\r\n2ã€åˆ†å¸ƒå¼åŠ å¤šçº¿ç¨‹\r\n\r\nå……åˆ†åˆ©ç”¨å¤šå°è®¡ç®—æœºï¼Œæ¯å°è®¡ç®—æœºä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†ã€‚\r\n\r\næ–¹æ¡ˆ2å¯æ‰©å±•æ€§æ›´å¼ºã€‚\r\n\r\næ–¹æ¡ˆ2æ˜¯ä¸€ç§åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦çš„å¤„ç†æ–¹æ¡ˆã€‚\r\n\r\nä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ï¼Ÿ\r\n\r\næˆ‘ä»¬å¯ä»¥å…ˆæ€è€ƒä¸€ä¸‹ä¸‹é¢ä¸šåŠ¡åœºæ™¯çš„è§£å†³æ–¹æ¡ˆï¼š\r\n\r\n- æ¯éš”24å°æ—¶æ‰§è¡Œæ•°æ®å¤‡ä»½ä»»åŠ¡ã€‚\r\n\r\n- 12306ç½‘ç«™ä¼šæ ¹æ®è½¦æ¬¡ä¸åŒï¼Œè®¾ç½®å‡ ä¸ªæ—¶é—´ç‚¹åˆ†æ‰¹æ¬¡æ”¾ç¥¨ã€‚\r\n- æŸè´¢åŠ¡ç³»ç»Ÿéœ€è¦åœ¨æ¯å¤©ä¸Šåˆ10ç‚¹å‰ç»“ç®—å‰ä¸€å¤©çš„è´¦å•æ•°æ®ï¼Œç»Ÿè®¡æ±‡æ€»ã€‚\r\n\r\n- å•†å“æˆåŠŸå‘è´§åï¼Œéœ€è¦å‘å®¢æˆ·å‘é€çŸ­ä¿¡æé†’ã€‚\r\n\r\n\r\nç±»ä¼¼çš„åœºæ™¯è¿˜æœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å®ç°ï¼Ÿ\r\n\r\n**å¤šçº¿ç¨‹æ–¹å¼å®ç°ï¼š**\r\n\r\nå­¦è¿‡å¤šçº¿ç¨‹çš„åŒå­¦ï¼Œå¯èƒ½ä¼šæƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯sleepä¸€æ®µæ—¶é—´ï¼Œå°±å»æ£€æŸ¥æ˜¯å¦å·²åˆ°é¢„æœŸæ‰§è¡Œæ—¶é—´ã€‚\r\n\r\nä»¥ä¸‹ä»£ç ç®€å•å®ç°äº†ä»»åŠ¡è°ƒåº¦çš„åŠŸèƒ½ï¼š\r\n\r\n```java\r\npublic static void main(String[] args) {    \r\n    //ä»»åŠ¡æ‰§è¡Œé—´éš”æ—¶é—´\r\n    final long timeInterval = 1000;\r\n    Runnable runnable = new Runnable() {\r\n        public void run() {\r\n            while (true) {\r\n                //TODOï¼šsomething\r\n                try {\r\n                    Thread.sleep(timeInterval);\r\n                } catch (InterruptedException e) {\r\n                    e.printStackTrace();\r\n                }\r\n            }\r\n        }\r\n    };\r\n    Thread thread = new Thread(runnable);\r\n    thread.start();\r\n}\r\n```\r\n\r\nä¸Šé¢çš„ä»£ç å®ç°äº†æŒ‰ä¸€å®šçš„é—´éš”æ—¶é—´æ‰§è¡Œä»»åŠ¡è°ƒåº¦çš„åŠŸèƒ½ã€‚\r\n\r\nJdkä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†ç›¸å…³æ”¯æŒï¼Œå¦‚Timerã€ScheduledExecutorï¼Œä¸‹è¾¹æˆ‘ä»¬äº†è§£ä¸‹ã€‚\r\n\r\n**Timeræ–¹å¼å®ç°**ï¼š\r\n\r\n```java\r\npublic static void main(String[] args){  \r\n    Timer timer = new Timer();  \r\n    timer.schedule(new TimerTask(){\r\n        @Override  \r\n        public void run() {  \r\n           //TODOï¼šsomething\r\n        }  \r\n    }, 1000, 2000);  //1ç§’åå¼€å§‹è°ƒåº¦ï¼Œæ¯2ç§’æ‰§è¡Œä¸€æ¬¡\r\n}\r\n```\r\n\r\n- Timer çš„ä¼˜ç‚¹åœ¨äºç®€å•æ˜“ç”¨ï¼Œæ¯ä¸ªTimerå¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œå› æ­¤å¯ä»¥åŒæ—¶å¯åŠ¨å¤šä¸ªTimerå¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼ŒåŒä¸€ä¸ªTimerä¸­çš„ä»»åŠ¡æ˜¯ä¸²è¡Œæ‰§è¡Œã€‚\r\n\r\n**ScheduledExecutoræ–¹å¼å®ç°**ï¼š\r\n\r\n```java\r\npublic static void main(String [] agrs){\r\n    ScheduledExecutorService service = Executors.newScheduledThreadPool(10);\r\n    service.scheduleAtFixedRate(\r\n            new Runnable() {\r\n                @Override\r\n                public void run() {\r\n                    //TODOï¼šsomething\r\n                    System.out.println(\"todo something\");\r\n                }\r\n            }, 1,\r\n            2, TimeUnit.SECONDS);\r\n}\r\n```\r\n\r\n- Java 5 æ¨å‡ºäº†åŸºäºçº¿ç¨‹æ± è®¾è®¡çš„ ScheduledExecutorï¼Œå…¶è®¾è®¡æ€æƒ³æ˜¯ï¼Œæ¯ä¸€ä¸ªè¢«è°ƒåº¦çš„ä»»åŠ¡éƒ½ä¼šç”±çº¿ç¨‹æ± ä¸­ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œï¼Œå› æ­¤ä»»åŠ¡æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œç›¸äº’ä¹‹é—´ä¸ä¼šå—åˆ°å¹²æ‰°ã€‚\r\n\r\n- Timer å’Œ ScheduledExecutor éƒ½ä»…èƒ½æä¾›åŸºäºå¼€å§‹æ—¶é—´ä¸é‡å¤é—´éš”çš„ä»»åŠ¡è°ƒåº¦ï¼Œä¸èƒ½èƒœä»»æ›´åŠ å¤æ‚çš„è°ƒåº¦éœ€æ±‚ã€‚æ¯”å¦‚ï¼Œè®¾ç½®æ¯æœˆç¬¬ä¸€å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œä»»åŠ¡ã€å¤æ‚è°ƒåº¦ä»»åŠ¡çš„ç®¡ç†ã€ä»»åŠ¡é—´ä¼ é€’æ•°æ®ç­‰ç­‰ã€‚\r\n\r\n \r\n\r\n**ç¬¬ä¸‰æ–¹Quartzæ–¹å¼å®ç°ï¼Œé¡¹ç›®åœ°å€ï¼šhttps://github.com/quartz-scheduler/quartz**  \r\n\r\n- Quartz æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ä»»åŠ¡è°ƒåº¦æ¡†æ¶ï¼Œå®ƒå¯ä»¥æ»¡è¶³æ›´å¤šæ›´å¤æ‚çš„è°ƒåº¦éœ€æ±‚ï¼ŒQuartz è®¾è®¡çš„æ ¸å¿ƒç±»åŒ…æ‹¬ Scheduler, Job ä»¥åŠ Triggerã€‚å…¶ä¸­ï¼ŒJob è´Ÿè´£å®šä¹‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ŒTrigger è´Ÿè´£è®¾ç½®è°ƒåº¦ç­–ç•¥ï¼ŒScheduler å°†äºŒè€…ç»„è£…åœ¨ä¸€èµ·ï¼Œå¹¶è§¦å‘ä»»åŠ¡å¼€å§‹æ‰§è¡Œã€‚Quartzæ”¯æŒç®€å•çš„æŒ‰æ—¶é—´é—´éš”è°ƒåº¦ã€è¿˜æ”¯æŒæŒ‰æ—¥å†è°ƒåº¦æ–¹å¼ï¼Œé€šè¿‡è®¾ç½®CronTriggerè¡¨è¾¾å¼ï¼ˆåŒ…æ‹¬ï¼šç§’ã€åˆ†ã€æ—¶ã€æ—¥ã€æœˆã€å‘¨ã€å¹´ï¼‰è¿›è¡Œä»»åŠ¡è°ƒåº¦ã€‚\r\n\r\nä¸‹è¾¹æ˜¯ä¸€ä¸ªä¾‹å­ä»£ç ï¼š\r\n\r\n```java\r\npublic static void main(String [] agrs) throws SchedulerException {\r\n    //åˆ›å»ºä¸€ä¸ªScheduler\r\n    SchedulerFactory schedulerFactory = new StdSchedulerFactory();\r\n    Scheduler scheduler = schedulerFactory.getScheduler();\r\n    //åˆ›å»ºJobDetail\r\n    JobBuilder jobDetailBuilder = JobBuilder.newJob(MyJob.class);\r\n    jobDetailBuilder.withIdentity(\"jobName\",\"jobGroupName\");\r\n    JobDetail jobDetail = jobDetailBuilder.build();\r\n    //åˆ›å»ºè§¦å‘çš„CronTrigger æ”¯æŒæŒ‰æ—¥å†è°ƒåº¦\r\n        CronTrigger trigger = TriggerBuilder.newTrigger()\r\n                .withIdentity(\"triggerName\", \"triggerGroupName\")\r\n                .startNow()\r\n                .withSchedule(CronScheduleBuilder.cronSchedule(\"0/2 * * * * ?\"))\r\n                .build();\r\n    scheduler.scheduleJob(jobDetail,trigger);\r\n    scheduler.start();\r\n}\r\n\r\npublic class MyJob implements Job {\r\n    @Override\r\n    public void execute(JobExecutionContext jobExecutionContext){\r\n        System.out.println(\"todo something\");\r\n    }\r\n}\r\n```\r\n\r\né€šè¿‡ä»¥ä¸Šå†…å®¹æˆ‘ä»¬å­¦ä¹ äº†ä»€ä¹ˆæ˜¯ä»»åŠ¡è°ƒåº¦ï¼Œä»»åŠ¡è°ƒåº¦æ‰€è§£å†³çš„é—®é¢˜ï¼Œä»¥åŠä»»åŠ¡è°ƒåº¦çš„å¤šç§å®ç°æ–¹å¼ã€‚\r\n\r\n**ä»»åŠ¡è°ƒåº¦é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¯¹ä»»åŠ¡çš„è°ƒåº¦ï¼Œå®ƒæ˜¯æŒ‡ç³»ç»Ÿä¸ºäº†å®Œæˆç‰¹å®šä¸šåŠ¡ï¼ŒåŸºäºç»™å®šæ—¶é—´ç‚¹ï¼Œç»™å®šæ—¶é—´é—´éš”æˆ–è€…ç»™å®šæ‰§è¡Œæ¬¡æ•°è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡ã€‚**\r\n\r\n**ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ï¼Ÿ**\r\n\r\n- é€šå¸¸ä»»åŠ¡è°ƒåº¦çš„ç¨‹åºæ˜¯é›†æˆåœ¨åº”ç”¨ä¸­çš„ï¼Œæ¯”å¦‚ï¼šä¼˜æƒ å·æœåŠ¡ä¸­åŒ…æ‹¬äº†å®šæ—¶å‘æ”¾ä¼˜æƒ å·çš„çš„è°ƒåº¦ç¨‹åºï¼Œç»“ç®—æœåŠ¡ä¸­åŒ…æ‹¬äº†å®šæœŸç”ŸæˆæŠ¥è¡¨çš„ä»»åŠ¡è°ƒåº¦ç¨‹åºï¼Œç”±äºé‡‡ç”¨åˆ†å¸ƒå¼æ¶æ„ï¼Œä¸€ä¸ªæœåŠ¡å¾€å¾€ä¼šéƒ¨ç½²å¤šä¸ªå†—ä½™å®ä¾‹æ¥è¿è¡Œæˆ‘ä»¬çš„ä¸šåŠ¡ï¼Œåœ¨è¿™ç§åˆ†å¸ƒå¼ç³»ç»Ÿç¯å¢ƒä¸‹è¿è¡Œä»»åŠ¡è°ƒåº¦ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º**åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦**ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps95.jpg) \r\n\r\n**åˆ†å¸ƒå¼è°ƒåº¦è¦å®ç°çš„ç›®æ ‡ï¼š**\r\n\r\n- ä¸ç®¡æ˜¯ä»»åŠ¡è°ƒåº¦ç¨‹åºé›†æˆåœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œè¿˜æ˜¯å•ç‹¬æ„å»ºçš„ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼Œå¦‚æœé‡‡ç”¨åˆ†å¸ƒå¼è°ƒåº¦ä»»åŠ¡çš„æ–¹å¼å°±ç›¸å½“äºå°†ä»»åŠ¡è°ƒåº¦ç¨‹åºåˆ†å¸ƒå¼æ„å»ºï¼Œè¿™æ ·å°±å¯ä»¥å…·æœ‰åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç‰¹ç‚¹ï¼Œå¹¶ä¸”æé«˜ä»»åŠ¡çš„è°ƒåº¦å¤„ç†èƒ½åŠ›ï¼š\r\n\r\n1ã€å¹¶è¡Œä»»åŠ¡è°ƒåº¦\r\n\r\n- å¹¶è¡Œä»»åŠ¡è°ƒåº¦å®ç°é å¤šçº¿ç¨‹ï¼Œå¦‚æœæœ‰å¤§é‡ä»»åŠ¡éœ€è¦è°ƒåº¦ï¼Œæ­¤æ—¶å…‰é å¤šçº¿ç¨‹å°±ä¼šæœ‰ç“¶é¢ˆäº†ï¼Œå› ä¸ºä¸€å°è®¡ç®—æœºCPUçš„å¤„ç†èƒ½åŠ›æ˜¯æœ‰é™çš„ã€‚\r\n\r\n- å¦‚æœå°†ä»»åŠ¡è°ƒåº¦ç¨‹åºåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæ¯ä¸ªç»“ç‚¹è¿˜å¯ä»¥éƒ¨ç½²ä¸ºé›†ç¾¤ï¼Œè¿™æ ·å°±å¯ä»¥è®©å¤šå°è®¡ç®—æœºå…±åŒå»å®Œæˆä»»åŠ¡è°ƒåº¦ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»åŠ¡åˆ†å‰²ä¸ºè‹¥å¹²ä¸ªåˆ†ç‰‡ï¼Œç”±ä¸åŒçš„å®ä¾‹å¹¶è¡Œæ‰§è¡Œï¼Œæ¥æé«˜ä»»åŠ¡è°ƒåº¦çš„å¤„ç†æ•ˆç‡ã€‚\r\n\r\n2ã€é«˜å¯ç”¨\r\n\r\n- è‹¥æŸä¸€ä¸ªå®ä¾‹å®•æœºï¼Œä¸å½±å“å…¶ä»–å®ä¾‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚\r\n\r\n3ã€å¼¹æ€§æ‰©å®¹\r\n\r\n- å½“é›†ç¾¤ä¸­å¢åŠ å®ä¾‹å°±å¯ä»¥æé«˜å¹¶æ‰§è¡Œä»»åŠ¡çš„å¤„ç†æ•ˆç‡ã€‚\r\n\r\n4ã€ä»»åŠ¡ç®¡ç†ä¸ç›‘æµ‹\r\n\r\n- å¯¹ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰å®šæ—¶ä»»åŠ¡è¿›è¡Œç»Ÿä¸€çš„ç®¡ç†åŠç›‘æµ‹ã€‚è®©å¼€å‘äººå‘˜åŠè¿ç»´äººå‘˜èƒ½å¤Ÿæ—¶åˆ»äº†è§£ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼Œä»è€Œåšå‡ºå¿«é€Ÿçš„åº”æ€¥å¤„ç†å“åº”ã€‚\r\n\r\n5ã€é¿å…ä»»åŠ¡é‡å¤æ‰§è¡Œ\r\n\r\n- å½“ä»»åŠ¡è°ƒåº¦ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼ŒåŒä¸€ä¸ªä»»åŠ¡è°ƒåº¦å¯èƒ½ä¼šæ‰§è¡Œå¤šæ¬¡ï¼Œæ¯”å¦‚åœ¨ä¸Šé¢æåˆ°çš„ç”µå•†ç³»ç»Ÿä¸­åˆ°ç‚¹å‘ä¼˜æƒ åˆ¸çš„ä¾‹å­ï¼Œå°±ä¼šå‘æ”¾å¤šæ¬¡ä¼˜æƒ åˆ¸ï¼Œå¯¹å…¬å¸é€ æˆå¾ˆå¤šæŸå¤±ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ§åˆ¶ç›¸åŒçš„ä»»åŠ¡åœ¨å¤šä¸ªè¿è¡Œå®ä¾‹ä¸Šåªæ‰§è¡Œä¸€æ¬¡ã€‚\r\n\r\n \r\n\r\n### **1.2 XXL-JOBä»‹ç»**\r\n\r\nXXL-JOBæ˜¯ä¸€ä¸ªè½»é‡çº§åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯å¼€å‘è¿…é€Ÿã€å­¦ä¹ ç®€å•ã€è½»é‡çº§ã€æ˜“æ‰©å±•ã€‚ç°å·²å¼€æ”¾æºä»£ç å¹¶æ¥å…¥å¤šå®¶å…¬å¸çº¿ä¸Šäº§å“çº¿ï¼Œå¼€ç®±å³ç”¨ã€‚\r\n\r\nå®˜ç½‘ï¼šhttps://www.xuxueli.com/xxl-job/\r\n\r\næ–‡æ¡£ï¼šhttps://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B\r\n\r\nXXL-JOBä¸»è¦æœ‰è°ƒåº¦ä¸­å¿ƒã€æ‰§è¡Œå™¨ã€ä»»åŠ¡ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps96.jpg) \r\n\r\n**è°ƒåº¦ä¸­å¿ƒï¼š**\r\n\r\n- è´Ÿè´£ç®¡ç†è°ƒåº¦ä¿¡æ¯ï¼ŒæŒ‰ç…§è°ƒåº¦é…ç½®å‘å‡ºè°ƒåº¦è¯·æ±‚ï¼Œè‡ªèº«ä¸æ‰¿æ‹…ä¸šåŠ¡ä»£ç ï¼›\r\n\r\n- ä¸»è¦èŒè´£ä¸ºæ‰§è¡Œå™¨ç®¡ç†ã€ä»»åŠ¡ç®¡ç†ã€ç›‘æ§è¿ç»´ã€æ—¥å¿—ç®¡ç†ç­‰\r\n\r\n**ä»»åŠ¡æ‰§è¡Œå™¨ï¼š**\r\n\r\n- è´Ÿè´£æ¥æ”¶è°ƒåº¦è¯·æ±‚å¹¶æ‰§è¡Œä»»åŠ¡é€»è¾‘ï¼›\r\n\r\n- åªè¦èŒè´£æ˜¯æ³¨å†ŒæœåŠ¡ã€ä»»åŠ¡æ‰§è¡ŒæœåŠ¡ï¼ˆæ¥æ”¶åˆ°ä»»åŠ¡åä¼šæ”¾å…¥çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—ï¼‰ã€æ‰§è¡Œç»“æœä¸ŠæŠ¥ã€æ—¥å¿—æœåŠ¡ç­‰\r\n\r\n**ä»»åŠ¡ï¼š**è´Ÿè´£æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡å¤„ç†ã€‚\r\n\r\n \r\n\r\nè°ƒåº¦ä¸­å¿ƒä¸æ‰§è¡Œå™¨ä¹‹é—´çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![image-20230704234905831](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230704234905831.png)\r\n\r\n \r\n\r\n**æ‰§è¡Œæµç¨‹ï¼š**\r\n\r\n- 1.ä»»åŠ¡æ‰§è¡Œå™¨æ ¹æ®é…ç½®çš„è°ƒåº¦ä¸­å¿ƒçš„åœ°å€ï¼Œè‡ªåŠ¨æ³¨å†Œåˆ°è°ƒåº¦ä¸­å¿ƒ\r\n- 2.è¾¾åˆ°ä»»åŠ¡è§¦å‘æ¡ä»¶ï¼Œè°ƒåº¦ä¸­å¿ƒä¸‹å‘ä»»åŠ¡\r\n- 3.æ‰§è¡Œå™¨åŸºäºçº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶æŠŠæ‰§è¡Œç»“æœæ”¾å…¥å†…å­˜é˜Ÿåˆ—ä¸­ã€æŠŠæ‰§è¡Œæ—¥å¿—å†™å…¥æ—¥å¿—æ–‡ä»¶ä¸­\r\n- 4.æ‰§è¡Œå™¨æ¶ˆè´¹å†…å­˜é˜Ÿåˆ—ä¸­çš„æ‰§è¡Œç»“æœï¼Œä¸»åŠ¨ä¸ŠæŠ¥ç»™è°ƒåº¦ä¸­å¿ƒ\r\n- 5.å½“ç”¨æˆ·åœ¨è°ƒåº¦ä¸­å¿ƒæŸ¥çœ‹ä»»åŠ¡æ—¥å¿—ï¼Œè°ƒåº¦ä¸­å¿ƒè¯·æ±‚ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œä»»åŠ¡æ‰§è¡Œå™¨è¯»å–ä»»åŠ¡æ—¥å¿—æ–‡ä»¶å¹¶è¿”å›æ—¥å¿—è¯¦æƒ…\r\n\r\n \r\n\r\n## **äºŒ ä»»åŠ¡è°ƒåº¦å®æˆ˜â€”è§†é¢‘å¤„ç†**\r\n\r\n### **2.1 è§†é¢‘è½¬ç éœ€æ±‚**\r\n\r\n \r\n\r\n#### **2.1.1 ä»€ä¹ˆæ˜¯è§†é¢‘ç¼–ç **\r\n\r\nè§†é¢‘ä¸Šä¼ æˆåŠŸåéœ€è¦å¯¹è§†é¢‘è¿›è¡Œè½¬ç å¤„ç†ã€‚\r\n\r\nä»€ä¹ˆæ˜¯è§†é¢‘ç¼–ç ï¼ŸæŸ¥é˜…ç™¾åº¦ç™¾ç§‘å¦‚ä¸‹ï¼š\r\n\r\n![image-20230704234151230](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230704234151230.png)\r\n\r\nè¯¦æƒ…å‚è€ƒ ï¼š[https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038](https://baike.baidu.com/item/è§†é¢‘ç¼–ç /839038)\r\n\r\né¦–å…ˆæˆ‘ä»¬è¦åˆ†æ¸…æ–‡ä»¶æ ¼å¼å’Œç¼–ç æ ¼å¼ï¼š\r\n\r\næ–‡ä»¶æ ¼å¼ï¼šæ˜¯æŒ‡`.mp4ã€.aviã€.rmvb`ç­‰ è¿™äº›ä¸åŒæ‰©å±•åçš„è§†é¢‘æ–‡ä»¶çš„æ–‡ä»¶æ ¼å¼  ï¼Œè§†é¢‘æ–‡ä»¶çš„å†…å®¹ä¸»è¦åŒ…æ‹¬è§†é¢‘å’ŒéŸ³é¢‘ï¼Œå…¶æ–‡ä»¶æ ¼å¼æ˜¯æŒ‰ç…§ä¸€ å®šçš„ç¼–ç æ ¼å¼å»ç¼–ç ï¼Œå¹¶ä¸”æŒ‰ç…§è¯¥æ–‡ä»¶æ‰€è§„å®šçš„å°è£…æ ¼å¼å°†è§†é¢‘ã€éŸ³é¢‘ã€å­—å¹•ç­‰ä¿¡æ¯å°è£…åœ¨ä¸€èµ·ï¼Œæ’­æ”¾å™¨ä¼šæ ¹æ®å®ƒä»¬çš„å°è£…æ ¼å¼å»æå–å‡ºç¼–ç ï¼Œç„¶åç”±æ’­æ”¾å™¨è§£ç ï¼Œæœ€ç»ˆæ’­æ”¾éŸ³è§†é¢‘ã€‚\r\n\r\néŸ³è§†é¢‘ç¼–ç æ ¼å¼ï¼šé€šè¿‡éŸ³è§†é¢‘çš„å‹ç¼©æŠ€æœ¯ï¼Œå°†è§†é¢‘æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§è§†é¢‘æ ¼å¼ï¼Œé€šè¿‡è§†é¢‘ç¼–ç å®ç°æµåª’ä½“çš„ä¼ è¾“ã€‚æ¯”å¦‚ï¼šä¸€ä¸ª`.avi`çš„è§†é¢‘æ–‡ä»¶åŸæ¥çš„ç¼–ç æ˜¯aï¼Œé€šè¿‡ç¼–ç åç¼–ç æ ¼å¼å˜ä¸ºbï¼ŒéŸ³é¢‘åŸæ¥ä¸ºcï¼Œé€šè¿‡ç¼–ç åå˜ä¸ºdã€‚\r\n\r\n \r\n\r\néŸ³è§†é¢‘ç¼–ç æ ¼å¼å„ç±»ç¹å¤šï¼Œä¸»è¦æœ‰å‡ ä¸‹å‡ ç±»ï¼š\r\n\r\nMPEGç³»åˆ—\r\n\r\n> ï¼ˆç”±ISO[å›½é™…æ ‡å‡†ç»„ç»‡æœºæ„]ä¸‹å±çš„MPEG[è¿åŠ¨å›¾è±¡ä¸“å®¶ç»„]å¼€å‘ ï¼‰è§†é¢‘ç¼–ç æ–¹é¢ä¸»è¦æ˜¯Mpeg1ï¼ˆvcdç”¨çš„å°±æ˜¯å®ƒï¼‰ã€Mpeg2ï¼ˆDVDä½¿ç”¨ï¼‰ã€Mpeg4ï¼ˆçš„DVDRIPä½¿ç”¨çš„éƒ½æ˜¯å®ƒçš„å˜ç§ï¼Œå¦‚ï¼šdivxï¼Œxvidç­‰ï¼‰ã€Mpeg4 AVCï¼ˆæ­£çƒ­é—¨ï¼‰ï¼›éŸ³é¢‘ç¼–ç æ–¹é¢ä¸»è¦æ˜¯MPEG Audio Layer 1/2ã€MPEG Audio Layer 3ï¼ˆå¤§åé¼é¼çš„mp3ï¼‰ã€MPEG-2 AAC ã€MPEG-4 AACç­‰ç­‰ã€‚æ³¨æ„ï¼šDVDéŸ³é¢‘æ²¡æœ‰é‡‡ç”¨Mpegçš„ã€‚\r\n>\r\n\r\nH.26Xç³»åˆ—\r\n\r\n> ï¼ˆç”±ITU[å›½é™…ç”µä¼ è§†è®¯è”ç›Ÿ]ä¸»å¯¼ï¼Œä¾§é‡ç½‘ç»œä¼ è¾“ï¼Œæ³¨æ„ï¼šåªæ˜¯è§†é¢‘ç¼–ç ï¼‰\r\n>\r\n> åŒ…æ‹¬`H.261ã€H.262ã€H.263ã€H.263+ã€H.263++ã€H.264`ï¼ˆå°±æ˜¯`MPEG4 AVC-`åˆä½œçš„ç»“æ™¶ï¼‰\r\n>\r\n> ç›®å‰æœ€å¸¸ç”¨çš„ç¼–ç æ ‡å‡†æ˜¯è§†é¢‘`H.264`ï¼ŒéŸ³é¢‘`AAC`ã€‚\r\n>\r\n\r\næé—®ï¼š\r\n\r\n- `H.264`æ˜¯ç¼–ç æ ¼å¼è¿˜æ˜¯æ–‡ä»¶æ ¼å¼ï¼Ÿ\r\n- `mp4`æ˜¯ç¼–ç æ ¼å¼è¿˜æ˜¯æ–‡ä»¶æ ¼å¼ï¼Ÿ\r\n\r\n \r\n\r\n#### **2.1.2 FFmpeg çš„åŸºæœ¬ä½¿ç”¨**\r\n\r\næˆ‘ä»¬å°†è§†é¢‘å½•åˆ¶å®Œæˆåï¼Œä½¿ç”¨è§†é¢‘ç¼–ç è½¯ä»¶å¯¹è§†é¢‘è¿›è¡Œç¼–ç ï¼Œæœ¬é¡¹ç›® ä½¿ç”¨FFmpegå¯¹è§†é¢‘è¿›è¡Œç¼–ç  ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps92.jpg) \r\n\r\n> FFmpegè¢«è®¸å¤šå¼€æºé¡¹ç›®é‡‡ç”¨ï¼ŒQQå½±éŸ³ã€æš´é£å½±éŸ³ã€VLCç­‰ã€‚\r\n>\r\n> ä¸‹è½½ï¼šFFmpeg https://www.ffmpeg.org/download.html#build-windows\r\n>\r\n> è¯·ä»å¸¸ç”¨å·¥å…·è½¯ä»¶ç›®å½•æ‰¾åˆ°ffmpeg.exeï¼Œå¹¶å°†ffmpeg.exeåŠ å…¥ç¯å¢ƒå˜é‡pathä¸­ã€‚\r\n>\r\n> æµ‹è¯•æ˜¯å¦æ­£å¸¸ï¼šcmdè¿è¡Œ `ffmpeg -version`\r\n>\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps93.jpg) \r\n\r\n> å®‰è£…æˆåŠŸï¼Œä½œä¸‹ç®€å•æµ‹è¯•\r\n>\r\n> å°†ä¸€ä¸ª.aviæ–‡ä»¶è½¬æˆmp4ã€mp3ã€gifç­‰ã€‚\r\n>\r\n> æ¯”å¦‚æˆ‘ä»¬å°†nacos.aviæ–‡ä»¶è½¬æˆmp4ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š\r\n>\r\n> `D:\\soft\\ffmpeg\\ffmpeg.exe -i 1.avi 1.mp4`\r\n>\r\n> å¯ä»¥å°†ffmpeg.exeé…ç½®åˆ°ç¯å¢ƒå˜é‡pathä¸­ï¼Œè¿›å…¥è§†é¢‘ç›®å½•ç›´æ¥è¿è¡Œï¼š`ffmpeg.exe -i 1.avi 1.mp4`\r\n>\r\n> è½¬æˆmp3ï¼š`ffmpeg -i nacos.avi nacos.mp3`\r\n>\r\n> è½¬æˆgifï¼š`ffmpeg -i nacos.avi nacos.gif`\r\n>\r\n> å®˜æ–¹æ–‡æ¡£ï¼ˆè‹±æ–‡ï¼‰ï¼š`http://ffmpeg.org/ffmpeg.html`\r\n>\r\n\r\n#### **2.1.3 è§†é¢‘å¤„ç†å·¥å…·ç±»**\r\n\r\nå°†è¯¾ç¨‹èµ„æ–™çš„å·¥å…·ç±»ä¸­çš„utilæ‹·è´è‡³baseå·¥ç¨‹ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps94.jpg) \r\n\r\nå…¶ä¸­Mp4VideoUtilç±»æ˜¯ç”¨äºå°†è§†é¢‘è½¬ä¸ºmp4æ ¼å¼ï¼Œæ˜¯æˆ‘ä»¬é¡¹ç›®è¦ä½¿ç”¨çš„å·¥å…·ç±»ã€‚\r\n\r\nä¸‹è¾¹çœ‹ä¸‹è¿™ä¸ªç±»çš„ä»£ç ï¼Œå¹¶è¿›è¡Œæµ‹è¯•ã€‚\r\n\r\næˆ‘ä»¬è¦é€šè¿‡ffmpegå¯¹è§†é¢‘è½¬ç ï¼ŒJavaç¨‹åºè°ƒç”¨ffmpegï¼Œä½¿ç”¨`java.lang.ProcessBuilder`å»å®Œæˆï¼Œå…·ä½“åœ¨Mp4VideoUtilç±»çš„63è¡Œï¼Œä¸‹è¾¹è¿›è¡Œç®€å•çš„æµ‹è¯•ï¼Œä¸‹è¾¹çš„ä»£ç è¿è¡Œæœ¬æœºå®‰è£…çš„QQè½¯ä»¶ã€‚\r\n\r\n```java\r\nProcessBuilder builder = new ProcessBuilder();\r\nbuilder.command(\"C:\\\\Program Files (x86)\\\\Tencent\\\\QQ\\\\Bin\\\\QQScLauncher.exe\");\r\n//å°†æ ‡å‡†è¾“å…¥æµå’Œé”™è¯¯è¾“å…¥æµåˆå¹¶ï¼Œé€šè¿‡æ ‡å‡†è¾“å…¥æµç¨‹è¯»å–ä¿¡æ¯\r\nbuilder.redirectErrorStream(true);\r\nProcess p = builder.start();\r\n```\r\n\r\nå¯¹Mp4VideoUtilç±»éœ€è¦å­¦ä¹ ä½¿ç”¨æ–¹æ³•ï¼Œä¸‹è¾¹ä»£ç å°†ä¸€ä¸ªaviè§†é¢‘è½¬ä¸ºmp4è§†é¢‘ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\npublic static void main(String[] args) throws IOException {\r\n    //ffmpegçš„è·¯å¾„\r\n    String ffmpeg_path = \"D:\\\\soft\\\\ffmpeg\\\\ffmpeg.exe\";//ffmpegçš„å®‰è£…ä½ç½®\r\n    //æºaviè§†é¢‘çš„è·¯å¾„\r\n    String video_path = \"D:\\\\develop\\\\bigfile_test\\\\nacos01.avi\";\r\n    //è½¬æ¢åmp4æ–‡ä»¶çš„åç§°\r\n    String mp4_name = \"nacos01.mp4\";\r\n    //è½¬æ¢åmp4æ–‡ä»¶çš„è·¯å¾„\r\n    String mp4_path = \"D:\\\\develop\\\\bigfile_test\\\\nacos01.mp4\";\r\n    //åˆ›å»ºå·¥å…·ç±»å¯¹è±¡\r\n    Mp4VideoUtil videoUtil = new Mp4VideoUtil(ffmpeg_path,video_path,mp4_name,mp4_path);\r\n    //å¼€å§‹è§†é¢‘è½¬æ¢ï¼ŒæˆåŠŸå°†è¿”å›success\r\n    String s = videoUtil.generateMp4();\r\n    System.out.println(s);\r\n}\r\n```\r\n\r\næ‰§è¡Œmainæ–¹æ³•ï¼Œæœ€ç»ˆåœ¨æ§åˆ¶å°è¾“å‡º success è¡¨ç¤ºæ‰§è¡ŒæˆåŠŸã€‚\r\n\r\n\r\n\r\n### **2.2 æ­å»ºXXL-JOB**\r\n\r\n#### **2.2.1 è°ƒåº¦ä¸­å¿ƒ**\r\n\r\n1ï¼‰åˆ›å»ºæŒ‚è½½ç›®å½•\r\n\r\n```bash\r\nmkdir -p -m 777 /mydata/xxl-job/{logs,conf}\r\n```\r\n\r\n`conf` ç›®å½•ä¸‹åˆ›å»º `application.properties` æ–‡ä»¶ã€‚\r\n\r\n```properties\r\n### web\r\nserver.port=8088\r\nserver.servlet.context-path=/xxl-job-admin\r\n\r\n### actuator\r\nmanagement.server.servlet.context-path=/actuator\r\nmanagement.health.mail.enabled=false\r\n\r\n### resources\r\nspring.mvc.servlet.load-on-startup=0\r\nspring.mvc.static-path-pattern=/static/**\r\nspring.resources.static-locations=classpath:/static/\r\n\r\n### freemarker\r\nspring.freemarker.templateLoaderPath=classpath:/templates/\r\nspring.freemarker.suffix=.ftl\r\nspring.freemarker.charset=UTF-8\r\nspring.freemarker.request-context-attribute=request\r\nspring.freemarker.settings.number_format=0.##########\r\n\r\n### mybatis\r\nmybatis.mapper-locations=classpath:/mybatis-mapper/*Mapper.xml\r\n#mybatis.type-aliases-package=com.xxl.job.admin.core.model\r\n\r\n###æ›´æ”¹é…ç½®æ–‡ä»¶è¿æ¥mysqlä¿¡æ¯\r\n### xxl-job, datasource\r\nspring.datasource.url=jdbc:mysql://dockermysql:3306/xxl_job?characterEncoding=UTF-8&serverTimezone=UTC&useSSL=false&autoReconnect=true ###ip\r\nspring.datasource.username=root\r\nspring.datasource.password=1234\r\nspring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver\r\n\r\n### datasource-pool\r\nspring.datasource.type=com.zaxxer.hikari.HikariDataSource\r\nspring.datasource.hikari.minimum-idle=10\r\nspring.datasource.hikari.maximum-pool-size=30\r\nspring.datasource.hikari.auto-commit=true\r\nspring.datasource.hikari.idle-timeout=30000\r\nspring.datasource.hikari.pool-name=HikariCP\r\nspring.datasource.hikari.max-lifetime=900000\r\nspring.datasource.hikari.connection-timeout=10000\r\nspring.datasource.hikari.connection-test-query=SELECT 1\r\nspring.datasource.hikari.validation-timeout=1000\r\n\r\n### xxl-job, email\r\nspring.mail.host=smtp.qq.com\r\nspring.mail.port=25\r\nspring.mail.username=xxx@qq.com\r\nspring.mail.from=xxx@qq.com\r\nspring.mail.password=xxx\r\nspring.mail.properties.mail.smtp.auth=true\r\nspring.mail.properties.mail.smtp.starttls.enable=true\r\nspring.mail.properties.mail.smtp.starttls.required=true\r\nspring.mail.properties.mail.smtp.socketFactory.class=javax.net.ssl.SSLSocketFactory\r\n\r\n### xxl-job, access token\r\nxxl.job.accessToken=default_token\r\n\r\n### xxl-job, i18n (default is zh_CN, and you can choose \"zh_CN\", \"zh_TC\" and \"en\")\r\nxxl.job.i18n=zh_CN\r\n\r\n## xxl-job, triggerpool max size\r\nxxl.job.triggerpool.fast.max=200\r\nxxl.job.triggerpool.slow.max=100\r\n\r\n### xxl-job, log retention days\r\nxxl.job.logretentiondays=30\r\n\r\n```\r\n\r\n2ï¼‰ä¸‹è½½XXL-JOB\r\n\r\nGitHubï¼šhttps://github.com/xuxueli/xxl-job\r\n\r\nç äº‘ï¼šhttps://gitee.com/xuxueli0323/xxl-job\r\n\r\né¡¹ç›®ä½¿ç”¨2.3.1ç‰ˆæœ¬ï¼š https://github.com/xuxueli/xxl-job/releases/tag/2.3.1\r\n\r\nä¹Ÿå¯ä»è¯¾ç¨‹èµ„æ–™ç›®å½•è·å–ï¼Œè§£å‹xxl-job-2.3.1.zip\r\n\r\nä½¿ç”¨IDEAæ‰“å¼€è§£å‹åçš„ç›®å½•\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps98.jpg) \r\n\r\nxxl-job-adminï¼šè°ƒåº¦ä¸­å¿ƒ\r\n\r\nxxl-job-coreï¼šå…¬å…±ä¾èµ–\r\n\r\nxxl-job-executor-samplesï¼šæ‰§è¡Œå™¨Sampleç¤ºä¾‹ï¼ˆé€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬æ‰§è¡Œå™¨ï¼Œå¯ç›´æ¥ä½¿ç”¨ï¼‰\r\n\r\n  ï¼šxxl-job-executor-sample-springbootï¼šSpringbootç‰ˆæœ¬ï¼Œé€šè¿‡Springbootç®¡ç†æ‰§è¡Œå™¨ï¼Œæ¨èè¿™ç§æ–¹å¼ï¼›\r\n\r\n  ï¼šxxl-job-executor-sample-framelessï¼šæ— æ¡†æ¶ç‰ˆæœ¬ï¼›\r\n\r\ndoc :æ–‡æ¡£èµ„æ–™ï¼ŒåŒ…å«æ•°æ®åº“è„šæœ¬\r\n\r\nåœ¨ä¸‹å‘çš„è™šæ‹Ÿæœºçš„MySQLä¸­å·²ç»åˆ›å»ºäº†xxl_job_2.3.1æ•°æ®åº“\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps99.jpg) \r\n\r\nå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps100.jpg) \r\n\r\næ‰§è¡Œ`sh /data/soft/restart.sh`è‡ªåŠ¨å¯åŠ¨xxl-jobè°ƒåº¦ä¸­å¿ƒ\r\n\r\n3ï¼‰åˆ›å»ºå®¹å™¨\r\n\r\n```shell\r\ndocker run -d \\\r\n-p 8088:8080 \\\r\n--name=xxl-job-admin \\\r\n--link mysql:dockermysql \\\r\n--restart=always \\\r\n-v ~/docker/software/xxl-job/conf/application.properties:/application.properties \\\r\n-e PARAMS='--spring.config.location=/application.properties' \\\r\nxuxueli/xxl-job-admin:2.3.1\r\n```\r\n\r\n`--link`ï¼šè¯·ç¡®ä¿ Docker ä¸­è¿è¡Œç€åä¸º mysql çš„å®¹å™¨ã€‚è¿æ¥ä¸Š MySQL å®¹å™¨åï¼Œå®ç°ç½‘ç»œäº’é€šã€‚\r\n\r\n4ï¼‰è®¿é—®åå°\r\n\r\nè®¿é—®ï¼š`http://192.168.2.203:8088/xxl-job-admin/`\r\n\r\nè´¦å·å’Œå¯†ç ï¼šadmin/123456\r\n\r\nå¦‚æœæ— æ³•ä½¿ç”¨è™šæ‹Ÿæœºè¿è¡Œxxl-jobå¯ä»¥åœ¨æœ¬æœºideaè¿è¡Œxxl-jobè°ƒåº¦ä¸­å¿ƒã€‚\r\n\r\n#### **2.2.2 æ‰§è¡Œå™¨**\r\n\r\nä¸‹è¾¹é…ç½®æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œå™¨è´Ÿè´£ä¸è°ƒåº¦ä¸­å¿ƒé€šä¿¡æ¥æ”¶è°ƒåº¦ä¸­å¿ƒå‘èµ·çš„ä»»åŠ¡è°ƒåº¦è¯·æ±‚ã€‚\r\n\r\n1ã€ä¸‹è¾¹è¿›å…¥è°ƒåº¦ä¸­å¿ƒæ·»åŠ æ‰§è¡Œå™¨\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps101.jpg) \r\n\r\n \r\n\r\nç‚¹å‡»æ–°å¢ï¼Œå¡«å†™æ‰§è¡Œå™¨ä¿¡æ¯ï¼Œappnameæ˜¯å‰è¾¹åœ¨nacosä¸­é…ç½®xxlä¿¡æ¯æ—¶æŒ‡å®šçš„æ‰§è¡Œå™¨çš„åº”ç”¨åã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps102.jpg) \r\n\r\næ·»åŠ æˆåŠŸï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps103.jpg) \r\n\r\n \r\n\r\n2ã€é¦–å…ˆåœ¨åª’èµ„ç®¡ç†æ¨¡å—çš„serviceå·¥ç¨‹æ·»åŠ ä¾èµ–ï¼Œåœ¨é¡¹ç›®çš„çˆ¶å·¥ç¨‹å·²çº¦å®šäº†ç‰ˆæœ¬2.3.1\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>com.xuxueli</groupId>\r\n    <artifactId>xxl-job-core</artifactId>\r\n</dependency>\r\n```\r\n\r\n3ã€åœ¨nacosä¸‹çš„media-service-dev.yamlä¸‹é…ç½®xxl-job\r\n\r\n```yaml\r\nxxl:\r\n  job:\r\n    admin: \r\n      addresses: http://192.168.2.203:8088/xxl-job-admin\r\n    executor:\r\n      appname: media-process-service\r\n      address: \r\n      ip: \r\n      port: 9999\r\n      logpath: /data/applogs/xxl-job/jobhandler\r\n      logretentiondays: 30\r\n    accessToken: default_token\r\n```\r\n\r\næ³¨æ„é…ç½®ä¸­çš„appnameè¿™æ˜¯æ‰§è¡Œå™¨çš„åº”ç”¨åï¼Œportæ˜¯æ‰§è¡Œå™¨å¯åŠ¨çš„ç«¯å£ï¼Œå¦‚æœæœ¬åœ°å¯åŠ¨å¤šä¸ªæ‰§è¡Œå™¨æ³¨æ„ç«¯å£ä¸èƒ½é‡å¤ã€‚\r\n\r\n4ã€é…ç½®xxl-jobçš„æ‰§è¡Œå™¨\r\n\r\nå°†xxl-jobç¤ºä¾‹å·¥ç¨‹ä¸‹é…ç½®ç±»æ‹·è´åˆ°åª’èµ„ç®¡ç†çš„serviceå·¥ç¨‹ä¸‹\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps104.jpg) \r\n\r\n```java\r\n/**\r\n * @author Klaus\r\n * @date 2023/06/24 1:52\r\n * @description TODO\r\n */\r\n@Configuration\r\npublic class XxlJobConfig {\r\n    private Logger logger = LoggerFactory.getLogger(XxlJobConfig.class);\r\n\r\n    @Value(\"${xxl.job.admin.addresses}\")\r\n    private String adminAddresses;\r\n\r\n    @Value(\"${xxl.job.accessToken}\")\r\n    private String accessToken;\r\n\r\n    @Value(\"${xxl.job.executor.appname}\")\r\n    private String appname;\r\n\r\n    @Value(\"${xxl.job.executor.address}\")\r\n    private String address;\r\n\r\n    @Value(\"${xxl.job.executor.ip}\")\r\n    private String ip;\r\n\r\n    @Value(\"${xxl.job.executor.port}\")\r\n    private int port;\r\n\r\n    @Value(\"${xxl.job.executor.logpath}\")\r\n    private String logPath;\r\n\r\n    @Value(\"${xxl.job.executor.logretentiondays}\")\r\n    private int logRetentionDays;\r\n\r\n\r\n    @Bean\r\n    public XxlJobSpringExecutor xxlJobExecutor() {\r\n        logger.info(\">>>>>>>>>>> xxl-job config init.\");\r\n        XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();\r\n        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);\r\n        xxlJobSpringExecutor.setAppname(appname);\r\n        xxlJobSpringExecutor.setAddress(address);\r\n        xxlJobSpringExecutor.setIp(ip);\r\n        xxlJobSpringExecutor.setPort(port);\r\n        xxlJobSpringExecutor.setAccessToken(accessToken);\r\n        xxlJobSpringExecutor.setLogPath(logPath);\r\n        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);\r\n\r\n        return xxlJobSpringExecutor;\r\n    }\r\n\r\n    /**\r\n     * é’ˆå¯¹å¤šç½‘å¡ã€å®¹å™¨å†…éƒ¨ç½²ç­‰æƒ…å†µï¼Œå¯å€ŸåŠ© \"spring-cloud-commons\" æä¾›çš„ \"InetUtils\" ç»„ä»¶çµæ´»å®šåˆ¶æ³¨å†ŒIPï¼›\r\n     *\r\n     *      1ã€å¼•å…¥ä¾èµ–ï¼š\r\n     *          <dependency>\r\n     *             <groupId>org.springframework.cloud</groupId>\r\n     *             <artifactId>spring-cloud-commons</artifactId>\r\n     *             <version>${version}</version>\r\n     *         </dependency>\r\n     *\r\n     *      2ã€é…ç½®æ–‡ä»¶ï¼Œæˆ–è€…å®¹å™¨å¯åŠ¨å˜é‡\r\n     *          spring.cloud.inetutils.preferred-networks: 'xxx.xxx.xxx.'\r\n     *\r\n     *      3ã€è·å–IP\r\n     *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();\r\n     */\r\n\r\n\r\n}\r\n```\r\n\r\n \r\n\r\n \r\n\r\nåˆ°æ­¤å®Œæˆåª’èµ„ç®¡ç†æ¨¡å—serviceå·¥ç¨‹é…ç½®xxl-jobæ‰§è¡Œå™¨ï¼Œåœ¨xxl-jobè°ƒåº¦ä¸­å¿ƒæ·»åŠ æ‰§è¡Œå™¨ï¼Œä¸‹è¾¹å‡†å¤‡æµ‹è¯•æ‰§è¡Œå™¨ä¸è°ƒåº¦ä¸­å¿ƒæ˜¯å¦æ­£å¸¸é€šä¿¡ï¼Œå› ä¸ºæ¥å£å·¥ç¨‹ä¾èµ–äº†serviceå·¥ç¨‹ï¼Œæ‰€ä»¥å¯åŠ¨åª’èµ„ç®¡ç†æ¨¡å—çš„æ¥å£å·¥ç¨‹ã€‚\r\n\r\nå¯åŠ¨åè§‚å¯Ÿæ—¥å¿—ï¼Œå‡ºç°ä¸‹è¾¹çš„æ—¥å¿—è¡¨ç¤ºæ‰§è¡Œå™¨åœ¨è°ƒåº¦ä¸­å¿ƒæ³¨å†ŒæˆåŠŸ\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps106.jpg) \r\n\r\nåŒæ—¶è§‚å¯Ÿè°ƒåº¦ä¸­å¿ƒä¸­çš„æ‰§è¡Œå™¨ç•Œé¢\r\n\r\n![image-20230704235939281](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230704235939281.png)\r\n\r\nåœ¨çº¿æœºå™¨åœ°å€å¤„å·²æ˜¾ç¤º1ä¸ªæ‰§è¡Œå™¨ã€‚\r\n\r\n \r\n\r\n#### **2.2.3 æ‰§è¡Œä»»åŠ¡**\r\n\r\nä¸‹è¾¹ç¼–å†™ä»»åŠ¡ï¼Œå‚è€ƒç¤ºä¾‹å·¥ç¨‹ä¸­ä»»åŠ¡ç±»çš„ç¼–å†™æ–¹æ³•\r\n\r\nåœ¨åª’èµ„æœåŠ¡serviceåŒ…ä¸‹æ–°å»ºjobhandlerå­˜æ”¾ä»»åŠ¡ç±»ï¼Œä¸‹è¾¹å‚è€ƒç¤ºä¾‹å·¥ç¨‹ç¼–å†™ä¸€ä¸ªä»»åŠ¡ç±»\r\n\r\n```java\r\n/**\r\n * @description æµ‹è¯•æ‰§è¡Œå™¨\r\n */\r\n @Component\r\n @Slf4j\r\npublic class SampleJob {\r\n\r\n /**\r\n  * 1ã€ç®€å•ä»»åŠ¡ç¤ºä¾‹ï¼ˆBeanæ¨¡å¼ï¼‰\r\n  */\r\n @XxlJob(\"testJob\")\r\n public void testJob() throws Exception {\r\n  log.info(\"å¼€å§‹æ‰§è¡Œ.....\");\r\n\r\n }\r\n\r\n}\r\n```\r\n\r\nä¸‹è¾¹åœ¨è°ƒåº¦ä¸­å¿ƒæ·»åŠ ä»»åŠ¡ï¼Œè¿›å…¥ä»»åŠ¡ç®¡ç†\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps109.jpg) \r\n\r\nç‚¹å‡»æ–°å¢ï¼Œå¡«å†™ä»»åŠ¡ä¿¡æ¯\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps110.jpg) \r\n\r\næ³¨æ„çº¢è‰²æ ‡è®°å¤„ï¼š\r\n\r\nè°ƒåº¦ç±»å‹ï¼š\r\n\r\nå›ºå®šé€Ÿåº¦æŒ‡æŒ‰å›ºå®šçš„é—´éš”å®šæ—¶è°ƒåº¦ã€‚\r\n\r\nCronï¼Œé€šè¿‡Cronè¡¨è¾¾å¼å®ç°æ›´ä¸°å¯Œçš„å®šæ—¶è°ƒåº¦ç­–ç•¥ã€‚\r\n\r\nCronè¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé€šè¿‡å®ƒå¯ä»¥å®šä¹‰è°ƒåº¦ç­–ç•¥ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\r\n\r\n`{ç§’æ•°} {åˆ†é’Ÿ} {å°æ—¶} {æ—¥æœŸ} {æœˆä»½} {æ˜ŸæœŸ} {å¹´ä»½(å¯ä¸ºç©º)}`\r\n\r\nxxl-jobæä¾›å›¾å½¢ç•Œé¢å»é…ç½®ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps111.jpg) \r\n\r\n> ä¸€äº›ä¾‹å­å¦‚ä¸‹ï¼š\r\n>\r\n> `30 10 1 * * ?`  æ¯å¤©1ç‚¹10åˆ†30ç§’è§¦å‘\r\n>\r\n> `0/30 * * * * ?` æ¯30ç§’è§¦å‘ä¸€æ¬¡\r\n>\r\n> `\\* 0/10 * * * ?` æ¯10åˆ†é’Ÿè§¦å‘ä¸€æ¬¡\r\n>\r\n> è¿è¡Œæ¨¡å¼æœ‰BEANå’ŒGLUEï¼Œbeanæ¨¡å¼è¾ƒå¸¸ç”¨å°±æ˜¯åœ¨é¡¹ç›®å·¥ç¨‹ä¸­ç¼–å†™æ‰§è¡Œå™¨çš„ä»»åŠ¡ä»£ç ï¼ŒGLUEæ˜¯å°†ä»»åŠ¡ä»£ç ç¼–å†™åœ¨è°ƒåº¦ä¸­å¿ƒã€‚\r\n>\r\n> JobHandlerå³ä»»åŠ¡æ–¹æ³•åï¼Œå¡«å†™ä»»åŠ¡æ–¹æ³•ä¸Šè¾¹@XxlJobæ³¨è§£ä¸­çš„åç§°ã€‚\r\n>\r\n> è·¯ç”±ç­–ç•¥ï¼šå½“æ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œè°ƒåº¦ä¸­å¿ƒå‘å“ªä¸ªæ‰§è¡Œå™¨ä¸‹å‘ä»»åŠ¡ï¼Œè¿™é‡Œé€‰æ‹©ç¬¬ä¸€ä¸ªè¡¨ç¤ºåªå‘ç¬¬ä¸€ä¸ªæ‰§è¡Œå™¨ä¸‹å‘ä»»åŠ¡ï¼Œè·¯ç”±ç­–ç•¥çš„å…¶å®ƒé€‰é¡¹ç¨ååœ¨åˆ†ç‰‡å¹¿æ’­ç« èŠ‚è¯¦ç»†è§£é‡Šã€‚\r\n>\r\n> é«˜çº§é…ç½®çš„å…¶å®ƒé…ç½®é¡¹ç¨ååœ¨åˆ†ç‰‡å¹¿æ’­ç« èŠ‚è¯¦ç»†è§£é‡Šã€‚\r\n\r\n \r\n\r\næ·»åŠ æˆåŠŸï¼Œå¯åŠ¨ä»»åŠ¡\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps112.jpg) \r\n\r\né€šè¿‡è°ƒåº¦æ—¥å¿—æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæƒ…å†µ\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps113.jpg) \r\n\r\n \r\n\r\nä¸‹è¾¹å¯åŠ¨åª’èµ„ç®¡ç†çš„serviceå·¥ç¨‹ï¼Œå¯åŠ¨æ‰§è¡Œå™¨ã€‚\r\n\r\nè§‚å¯Ÿæ‰§è¡Œå™¨æ–¹æ³•çš„æ‰§è¡Œã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps114.jpg) \r\n\r\nå¦‚æœè¦åœæ­¢ä»»åŠ¡éœ€è¦åœ¨è°ƒåº¦ä¸­å¿ƒæ“ä½œ\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps115.jpg) \r\n\r\nä»»åŠ¡è·‘ä¸€æ®µæ—¶é—´æ³¨æ„æ¸…ç†æ—¥å¿—\r\n\r\n![image-20230705001455431](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705001455431.png)\r\n\r\n **2.3 åˆ†ç‰‡å¹¿æ’­**\r\n\r\næŒæ¡äº†xxl-jobçš„åŸºæœ¬ä½¿ç”¨ï¼Œä¸‹è¾¹æ€è€ƒå¦‚ä½•è¿›è¡Œåˆ†å¸ƒå¼ä»»åŠ¡å¤„ç†å‘¢ï¼Ÿå¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬ä¼šå¯åŠ¨å¤šä¸ªæ‰§è¡Œå™¨ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œå»æ‰§è¡Œä»»åŠ¡ã€‚\r\n\r\n![image-20230705001607572](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230705001607572.png)\r\n\r\n \r\n\r\næ‰§è¡Œå™¨åœ¨é›†ç¾¤éƒ¨ç½²ä¸‹è°ƒåº¦ä¸­å¿ƒæœ‰å“ªäº›è·¯ç”±ç­–ç•¥å‘¢ï¼Ÿ\r\n\r\næŸ¥çœ‹xxl-jobå®˜æ–¹æ–‡æ¡£ï¼Œé˜…è¯»é«˜çº§é…ç½®ç›¸å…³çš„å†…å®¹ï¼š\r\n\r\n> é«˜çº§é…ç½®ï¼š\r\n> \\- è·¯ç”±ç­–ç•¥ï¼šå½“æ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œæä¾›ä¸°å¯Œçš„è·¯ç”±ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼›\r\n> FIRSTï¼ˆç¬¬ä¸€ä¸ªï¼‰ï¼šå›ºå®šé€‰æ‹©ç¬¬ä¸€ä¸ªæœºå™¨ï¼›\r\n> LASTï¼ˆæœ€åä¸€ä¸ªï¼‰ï¼šå›ºå®šé€‰æ‹©æœ€åä¸€ä¸ªæœºå™¨ï¼›\r\n> ROUNDï¼ˆè½®è¯¢ï¼‰ï¼šï¼›\r\n> RANDOMï¼ˆéšæœºï¼‰ï¼šéšæœºé€‰æ‹©åœ¨çº¿çš„æœºå™¨ï¼›\r\n> CONSISTENT_HASHï¼ˆä¸€è‡´æ€§HASHï¼‰ï¼šæ¯ä¸ªä»»åŠ¡æŒ‰ç…§Hashç®—æ³•å›ºå®šé€‰æ‹©æŸä¸€å°æœºå™¨ï¼Œä¸”æ‰€æœ‰ä»»åŠ¡å‡åŒ€æ•£åˆ—åœ¨ä¸åŒæœºå™¨ä¸Šã€‚\r\n> LEAST_FREQUENTLY_USEDï¼ˆæœ€ä¸ç»å¸¸ä½¿ç”¨ï¼‰ï¼šä½¿ç”¨é¢‘ç‡æœ€ä½çš„æœºå™¨ä¼˜å…ˆè¢«é€‰ä¸¾ï¼›\r\n> LEAST_RECENTLY_USEDï¼ˆæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ï¼‰ï¼šæœ€ä¹…æœªä½¿ç”¨çš„æœºå™¨ä¼˜å…ˆè¢«é€‰ä¸¾ï¼›\r\n> FAILOVERï¼ˆæ•…éšœè½¬ç§»ï¼‰ï¼šæŒ‰ç…§é¡ºåºä¾æ¬¡è¿›è¡Œå¿ƒè·³æ£€æµ‹ï¼Œç¬¬ä¸€ä¸ªå¿ƒè·³æ£€æµ‹æˆåŠŸçš„æœºå™¨é€‰å®šä¸ºç›®æ ‡æ‰§è¡Œå™¨å¹¶å‘èµ·è°ƒåº¦ï¼›\r\n> BUSYOVERï¼ˆå¿™ç¢Œè½¬ç§»ï¼‰ï¼šæŒ‰ç…§é¡ºåºä¾æ¬¡è¿›è¡Œç©ºé—²æ£€æµ‹ï¼Œç¬¬ä¸€ä¸ªç©ºé—²æ£€æµ‹æˆåŠŸçš„æœºå™¨é€‰å®šä¸ºç›®æ ‡æ‰§è¡Œå™¨å¹¶å‘èµ·è°ƒåº¦ï¼›\r\n> SHARDING_BROADCAST(åˆ†ç‰‡å¹¿æ’­)ï¼šå¹¿æ’­è§¦å‘å¯¹åº”é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ï¼ŒåŒæ—¶ç³»ç»Ÿè‡ªåŠ¨ä¼ é€’åˆ†ç‰‡å‚æ•°ï¼›å¯æ ¹æ®åˆ†ç‰‡å‚æ•°å¼€å‘åˆ†ç‰‡ä»»åŠ¡ï¼›\r\n>\r\n> \\- å­ä»»åŠ¡ï¼šæ¯ä¸ªä»»åŠ¡éƒ½æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€çš„ä»»åŠ¡ID(ä»»åŠ¡IDå¯ä»¥ä»ä»»åŠ¡åˆ—è¡¨è·å–)ï¼Œå½“æœ¬ä»»åŠ¡æ‰§è¡Œç»“æŸå¹¶ä¸”æ‰§è¡ŒæˆåŠŸæ—¶ï¼Œå°†ä¼šè§¦å‘å­ä»»åŠ¡IDæ‰€å¯¹åº”çš„ä»»åŠ¡çš„ä¸€æ¬¡ä¸»åŠ¨è°ƒåº¦ï¼Œé€šè¿‡å­ä»»åŠ¡å¯ä»¥å®ç°ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆå»æ‰§è¡Œå¦ä¸€ä¸ªä»»åŠ¡ã€‚\r\n> \\- è°ƒåº¦è¿‡æœŸç­–ç•¥ï¼š\r\n> \\- å¿½ç•¥ï¼šè°ƒåº¦è¿‡æœŸåï¼Œå¿½ç•¥è¿‡æœŸçš„ä»»åŠ¡ï¼Œä»å½“å‰æ—¶é—´å¼€å§‹é‡æ–°è®¡ç®—ä¸‹æ¬¡è§¦å‘æ—¶é—´ï¼›\r\n> \\- ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼šè°ƒåº¦è¿‡æœŸåï¼Œç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ä»å½“å‰æ—¶é—´å¼€å§‹é‡æ–°è®¡ç®—ä¸‹æ¬¡è§¦å‘æ—¶é—´ï¼›\r\n> \\- é˜»å¡å¤„ç†ç­–ç•¥ï¼šè°ƒåº¦è¿‡äºå¯†é›†æ‰§è¡Œå™¨æ¥ä¸åŠå¤„ç†æ—¶çš„å¤„ç†ç­–ç•¥ï¼›\r\n> å•æœºä¸²è¡Œï¼ˆé»˜è®¤ï¼‰ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œè°ƒåº¦è¯·æ±‚è¿›å…¥FIFOé˜Ÿåˆ—å¹¶ä»¥ä¸²è¡Œæ–¹å¼è¿è¡Œï¼›\r\n> ä¸¢å¼ƒåç»­è°ƒåº¦ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œå‘ç°æ‰§è¡Œå™¨å­˜åœ¨è¿è¡Œçš„è°ƒåº¦ä»»åŠ¡ï¼Œæœ¬æ¬¡è¯·æ±‚å°†ä¼šè¢«ä¸¢å¼ƒå¹¶æ ‡è®°ä¸ºå¤±è´¥ï¼›\r\n> è¦†ç›–ä¹‹å‰è°ƒåº¦ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œå‘ç°æ‰§è¡Œå™¨å­˜åœ¨è¿è¡Œçš„è°ƒåº¦ä»»åŠ¡ï¼Œå°†ä¼šç»ˆæ­¢è¿è¡Œä¸­çš„è°ƒåº¦ä»»åŠ¡å¹¶æ¸…ç©ºé˜Ÿåˆ—ï¼Œç„¶åè¿è¡Œæœ¬åœ°è°ƒåº¦ä»»åŠ¡ï¼›\r\n> \\- ä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼šæ”¯æŒè‡ªå®šä¹‰ä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼Œä»»åŠ¡è¿è¡Œè¶…æ—¶å°†ä¼šä¸»åŠ¨ä¸­æ–­ä»»åŠ¡ï¼›\r\n> \\- å¤±è´¥é‡è¯•æ¬¡æ•°ï¼›æ”¯æŒè‡ªå®šä¹‰ä»»åŠ¡å¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œå½“ä»»åŠ¡å¤±è´¥æ—¶å°†ä¼šæŒ‰ç…§é¢„è®¾çš„å¤±è´¥é‡è¯•æ¬¡æ•°ä¸»åŠ¨è¿›è¡Œé‡è¯•ï¼›\r\n\r\nä¸‹è¾¹è¦é‡ç‚¹è¯´çš„æ˜¯åˆ†ç‰‡å¹¿æ’­ç­–ç•¥ï¼Œåˆ†ç‰‡æ˜¯æŒ‡æ˜¯è°ƒåº¦ä¸­å¿ƒä»¥æ‰§è¡Œå™¨ä¸ºç»´åº¦è¿›è¡Œåˆ†ç‰‡ï¼Œå°†é›†ç¾¤ä¸­çš„æ‰§è¡Œå™¨æ ‡ä¸Šåºå·ï¼š0ï¼Œ1ï¼Œ2ï¼Œ3...ï¼Œå¹¿æ’­æ˜¯æŒ‡æ¯æ¬¡è°ƒåº¦ä¼šå‘é›†ç¾¤ä¸­çš„æ‰€æœ‰æ‰§è¡Œå™¨å‘é€ä»»åŠ¡è°ƒåº¦ï¼Œè¯·æ±‚ä¸­æºå¸¦åˆ†ç‰‡å‚æ•°ã€‚\r\n\r\nå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps118.jpg) \r\n\r\n \r\n\r\næ¯ä¸ªæ‰§è¡Œå™¨æ”¶åˆ°è°ƒåº¦è¯·æ±‚åŒæ—¶æ¥æ”¶åˆ†ç‰‡å‚æ•°ã€‚\r\n\r\nxxl-jobæ”¯æŒåŠ¨æ€æ‰©å®¹æ‰§è¡Œå™¨é›†ç¾¤ä»è€ŒåŠ¨æ€å¢åŠ åˆ†ç‰‡æ•°é‡ï¼Œå½“æœ‰ä»»åŠ¡é‡å¢åŠ å¯ä»¥éƒ¨ç½²æ›´å¤šçš„æ‰§è¡Œå™¨åˆ°é›†ç¾¤ä¸­ï¼Œè°ƒåº¦ä¸­å¿ƒä¼šåŠ¨æ€ä¿®æ”¹åˆ†ç‰‡çš„æ•°é‡ã€‚\r\n\r\n**ä½œä¸šåˆ†ç‰‡é€‚ç”¨å“ªäº›åœºæ™¯å‘¢ï¼Ÿ**\r\n\r\nâ€¢ åˆ†ç‰‡ä»»åŠ¡åœºæ™¯ï¼š10ä¸ªæ‰§è¡Œå™¨çš„é›†ç¾¤æ¥å¤„ç†10wæ¡æ•°æ®ï¼Œæ¯å°æœºå™¨åªéœ€è¦å¤„ç†1wæ¡æ•°æ®ï¼Œè€—æ—¶é™ä½10å€ï¼›\r\n\r\nâ€¢ å¹¿æ’­ä»»åŠ¡åœºæ™¯ï¼šå¹¿æ’­æ‰§è¡Œå™¨åŒæ—¶è¿è¡Œshellè„šæœ¬ã€å¹¿æ’­é›†ç¾¤èŠ‚ç‚¹è¿›è¡Œç¼“å­˜æ›´æ–°ç­‰ã€‚\r\n\r\næ‰€ä»¥ï¼Œå¹¿æ’­åˆ†ç‰‡æ–¹å¼ä¸ä»…å¯ä»¥å……åˆ†å‘æŒ¥æ¯ä¸ªæ‰§è¡Œå™¨çš„èƒ½åŠ›ï¼Œå¹¶ä¸”æ ¹æ®åˆ†ç‰‡å‚æ•°å¯ä»¥æ§åˆ¶ä»»åŠ¡æ˜¯å¦æ‰§è¡Œï¼Œæœ€ç»ˆçµæ´»æ§åˆ¶äº†æ‰§è¡Œå™¨é›†ç¾¤åˆ†å¸ƒå¼å¤„ç†ä»»åŠ¡ã€‚\r\n\r\n \r\n\r\n**ä½¿ç”¨è¯´æ˜ï¼š**\r\n\r\n\"åˆ†ç‰‡å¹¿æ’­\" å’Œæ™®é€šä»»åŠ¡å¼€å‘æµç¨‹ä¸€è‡´ï¼Œä¸åŒä¹‹å¤„åœ¨äºå¯ä»¥è·å–åˆ†ç‰‡å‚æ•°è¿›è¡Œåˆ†ç‰‡ä¸šåŠ¡å¤„ç†ã€‚\r\n\r\nJavaè¯­è¨€ä»»åŠ¡è·å–åˆ†ç‰‡å‚æ•°æ–¹å¼ï¼š\r\n\r\nBEANã€GLUEæ¨¡å¼(Java)ï¼Œå¯å‚è€ƒSampleç¤ºä¾‹æ‰§è¡Œå™¨ä¸­çš„ç¤ºä¾‹ä»»åŠ¡\"ShardingJobHandler\"ï¼š\r\n\r\n```java\r\n/**\r\n * 2ã€åˆ†ç‰‡å¹¿æ’­ä»»åŠ¡\r\n */\r\n@XxlJob(\"shardingJobHandler\")\r\npublic void shardingJobHandler() throws Exception {\r\n    // åˆ†ç‰‡åºå·ï¼Œä»0å¼€å§‹\r\n    int shardIndex = XxlJobHelper.getShardIndex();\r\n    // åˆ†ç‰‡æ€»æ•°\r\n    int shardTotal = XxlJobHelper.getShardTotal();\r\n    ....\r\n```\r\n\r\n \r\n\r\nä¸‹è¾¹æµ‹è¯•ä½œä¸šåˆ†ç‰‡ï¼š\r\n\r\n1ã€å®šä¹‰ä½œä¸šåˆ†ç‰‡çš„ä»»åŠ¡æ–¹æ³•\r\n\r\n```java\r\n/**\r\n  * 2ã€åˆ†ç‰‡å¹¿æ’­ä»»åŠ¡\r\n  */\r\n @XxlJob(\"shardingJobHandler\")\r\n public void shardingJobHandler() throws Exception {\r\n\r\n  // åˆ†ç‰‡å‚æ•°\r\n  int shardIndex = XxlJobHelper.getShardIndex();\r\n  int shardTotal = XxlJobHelper.getShardTotal();\r\n\r\nlog.info(\"åˆ†ç‰‡å‚æ•°ï¼šå½“å‰åˆ†ç‰‡åºå· = {}, æ€»åˆ†ç‰‡æ•° = {}\", shardIndex, shardTotal);\r\nlog.info(\"å¼€å§‹æ‰§è¡Œç¬¬\"+shardIndex+\"æ‰¹ä»»åŠ¡\");\r\n\r\n }\r\n```\r\n\r\n2ã€åœ¨è°ƒåº¦ä¸­å¿ƒæ·»åŠ ä»»åŠ¡\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps119.jpg) \r\n\r\n \r\n\r\næ·»åŠ æˆåŠŸï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps120.jpg) \r\n\r\nå¯åŠ¨ä»»åŠ¡ï¼Œè§‚å¯Ÿæ—¥å¿—\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps121.jpg) \r\n\r\nä¸‹è¾¹å¯åŠ¨ä¸¤ä¸ªæ‰§è¡Œå™¨å®ä¾‹ï¼Œè§‚å¯Ÿæ¯ä¸ªå®ä¾‹çš„æ‰§è¡Œæƒ…å†µ\r\n\r\né¦–å…ˆåœ¨nacosä¸­é…ç½®media-serviceçš„æœ¬åœ°ä¼˜å…ˆé…ç½®ï¼š\r\n\r\n```yaml\r\n#é…ç½®æœ¬åœ°ä¼˜å…ˆ \r\nspring:  \r\n  cloud:  \r\n   config:   \r\n \t override-none: true\r\n```\r\n\r\nå°†media-serviceå¯åŠ¨ä¸¤ä¸ªå®ä¾‹\r\n\r\nä¸¤ä¸ªå®ä¾‹çš„åœ¨å¯åŠ¨æ—¶æ³¨æ„ç«¯å£ä¸èƒ½å†²çªï¼š\r\n\r\nå®ä¾‹1 åœ¨VM optionså¤„æ·»åŠ ï¼š`-Dserver.port=63051 -Dxxl.job.executor.port=9998`\r\n\r\nå®ä¾‹2 åœ¨VM optionså¤„æ·»åŠ ï¼š`-Dserver.port=63050 -Dxxl.job.executor.port=9999`\r\n\r\nä¾‹å¦‚ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps122.jpg) \r\n\r\nå¯åŠ¨ä¸¤ä¸ªå®ä¾‹\r\n\r\nè§‚å¯Ÿä»»åŠ¡è°ƒåº¦ä¸­å¿ƒï¼Œç¨ç­‰ç‰‡åˆ»æ‰§è¡Œå™¨æœ‰ä¸¤ä¸ª\r\n\r\n \r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps123.jpg) \r\n\r\nè§‚å¯Ÿä¸¤ä¸ªæ‰§è¡Œå®ä¾‹çš„æ—¥å¿—ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps124.jpg) \r\n\r\nå¦ä¸€å®ä¾‹çš„æ—¥å¿—å¦‚ä¸‹ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps125.jpg) \r\n\r\nä»æ—¥å¿—å¯ä»¥çœ‹æ¯ä¸ªå®ä¾‹çš„åˆ†ç‰‡åºå·ä¸åŒã€‚\r\n\r\nå¦‚æœå…¶ä¸­ä¸€ä¸ªæ‰§è¡Œå™¨æŒ‚æ‰ï¼Œåªå‰©ä¸‹ä¸€ä¸ªæ‰§è¡Œå™¨åœ¨å·¥ä½œï¼Œç¨ç­‰ç‰‡åˆ»è°ƒç”¨ä¸­å¿ƒå‘ç°å°‘äº†ä¸€ä¸ªæ‰§è¡Œå™¨å°†åŠ¨æ€è°ƒæ•´æ€»åˆ†ç‰‡æ•°ä¸º1ã€‚\r\n\r\nåˆ°æ­¤ä½œä¸šåˆ†ç‰‡ä»»åŠ¡è°ƒè¯•å®Œæˆï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ€è€ƒï¼š\r\n\r\nå½“ä¸€æ¬¡åˆ†ç‰‡å¹¿æ’­åˆ°æ¥ï¼Œå„æ‰§è¡Œå™¨å¦‚ä½•æ ¹æ®åˆ†ç‰‡å‚æ•°å»åˆ†å¸ƒå¼æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰§è¡Œå™¨ä¹‹é—´æ‰§è¡Œçš„ä»»åŠ¡ä¸é‡å¤å‘¢ï¼Ÿ\r\n\r\n \r\n\r\n \r\n\r\n### **2.4 æŠ€æœ¯æ–¹æ¡ˆ**\r\n\r\n#### **2.4.1 ä½œä¸šåˆ†ç‰‡æ–¹æ¡ˆ**\r\n\r\næŒæ¡äº†xxl-jobçš„åˆ†ç‰‡å¹¿æ’­è°ƒåº¦æ–¹å¼ï¼Œä¸‹è¾¹æ€è€ƒå¦‚ä½•åˆ†å¸ƒå¼å»æ‰§è¡Œå­¦æˆåœ¨çº¿å¹³å°ä¸­çš„è§†é¢‘å¤„ç†ä»»åŠ¡ã€‚\r\n\r\nä»»åŠ¡æ·»åŠ æˆåŠŸåï¼Œå¯¹äºè¦å¤„ç†çš„ä»»åŠ¡ä¼šæ·»åŠ åˆ°å¾…å¤„ç†ä»»åŠ¡è¡¨ä¸­ï¼Œç°åœ¨å¯åŠ¨å¤šä¸ªæ‰§è¡Œå™¨å®ä¾‹å»æŸ¥è¯¢è¿™äº›å¾…å¤„ç†ä»»åŠ¡ï¼Œæ­¤æ—¶å¦‚ä½•ä¿è¯å¤šä¸ªæ‰§è¡Œå™¨ä¸ä¼šæŸ¥è¯¢åˆ°é‡å¤çš„ä»»åŠ¡å‘¢ï¼Ÿ\r\n\r\nXXL-JOBå¹¶ä¸ç›´æ¥æä¾›æ•°æ®å¤„ç†çš„åŠŸèƒ½ï¼Œå®ƒåªä¼šç»™æ‰§è¡Œå™¨åˆ†é…å¥½åˆ†ç‰‡åºå·ï¼Œåœ¨å‘æ‰§è¡Œå™¨ä»»åŠ¡è°ƒåº¦çš„åŒæ—¶ä¸‹å‘åˆ†ç‰‡æ€»æ•°ä»¥åŠåˆ†ç‰‡åºå·ç­‰å‚æ•°ï¼Œæ‰§è¡Œå™¨æ”¶åˆ°è¿™äº›å‚æ•°æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚å»åˆ©ç”¨è¿™äº›å‚æ•°ã€‚\r\n\r\nä¸‹å›¾è¡¨ç¤ºäº†å¤šä¸ªæ‰§è¡Œå™¨è·å–è§†é¢‘å¤„ç†ä»»åŠ¡çš„ç»“æ„ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps126.jpg) \r\n\r\næ¯ä¸ªæ‰§è¡Œå™¨æ”¶åˆ°å¹¿æ’­ä»»åŠ¡æœ‰ä¸¤ä¸ªå‚æ•°ï¼šåˆ†ç‰‡æ€»æ•°ã€åˆ†ç‰‡åºå·ã€‚æ¯ä¸ªæ‰§è¡Œä»æ•°æ®è¡¨å–ä»»åŠ¡æ—¶å¯ä»¥è®©ä»»åŠ¡id æ¨¡ä¸Š åˆ†ç‰‡æ€»æ•°ï¼Œå¦‚æœç­‰äºåˆ†ç‰‡åºå·åˆ™æ‰§è¡Œæ­¤ä»»åŠ¡ã€‚\r\n\r\nä¸Šè¾¹ä¸¤ä¸ªæ‰§è¡Œå™¨å®ä¾‹é‚£ä¹ˆåˆ†ç‰‡æ€»æ•°ä¸º2ï¼Œåºå·ä¸º0ã€1ï¼Œä»ä»»åŠ¡1å¼€å§‹ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n`1  %  2 = 1`   æ‰§è¡Œå™¨2æ‰§è¡Œ\r\n\r\n`2  %  2 =  0`   æ‰§è¡Œå™¨1æ‰§è¡Œ\r\n\r\n`3  %  2 =  1`   æ‰§è¡Œå™¨2æ‰§è¡Œ\r\n\r\nä»¥æ­¤ç±»æ¨.\r\n\r\n#### **2.4.2 ä¿è¯ä»»åŠ¡ä¸é‡å¤æ‰§è¡Œ**\r\n\r\né€šè¿‡ä½œä¸šåˆ†ç‰‡æ–¹æ¡ˆä¿è¯äº†æ‰§è¡Œå™¨ä¹‹é—´æŸ¥è¯¢åˆ°ä¸é‡å¤çš„ä»»åŠ¡ï¼Œå¦‚æœä¸€ä¸ªæ‰§è¡Œå™¨åœ¨å¤„ç†ä¸€ä¸ªè§†é¢‘è¿˜æ²¡æœ‰å®Œæˆï¼Œæ­¤æ—¶è°ƒåº¦ä¸­å¿ƒåˆä¸€æ¬¡è¯·æ±‚è°ƒåº¦ï¼Œä¸ºäº†ä¸é‡å¤å¤„ç†åŒä¸€ä¸ªè§†é¢‘è¯¥æ€ä¹ˆåŠï¼Ÿ\r\n\r\né¦–å…ˆé…ç½®è°ƒåº¦è¿‡æœŸç­–ç•¥ï¼š\r\n\r\næŸ¥çœ‹æ–‡æ¡£å¦‚ä¸‹ï¼š\r\n\r\n  \\- è°ƒåº¦è¿‡æœŸç­–ç•¥ï¼šè°ƒåº¦ä¸­å¿ƒé”™è¿‡è°ƒåº¦æ—¶é—´çš„è¡¥å¿å¤„ç†ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼šå¿½ç•¥ã€ç«‹å³è¡¥å¿è§¦å‘ä¸€æ¬¡ç­‰ï¼›\r\n    \\- å¿½ç•¥ï¼šè°ƒåº¦è¿‡æœŸåï¼Œå¿½ç•¥è¿‡æœŸçš„ä»»åŠ¡ï¼Œä»å½“å‰æ—¶é—´å¼€å§‹é‡æ–°è®¡ç®—ä¸‹æ¬¡è§¦å‘æ—¶é—´ï¼›\r\n    \\- ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼šè°ƒåº¦è¿‡æœŸåï¼Œç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ä»å½“å‰æ—¶é—´å¼€å§‹é‡æ–°è®¡ç®—ä¸‹æ¬¡è§¦å‘æ—¶é—´ï¼›\r\n  \\- é˜»å¡å¤„ç†ç­–ç•¥ï¼šè°ƒåº¦è¿‡äºå¯†é›†æ‰§è¡Œå™¨æ¥ä¸åŠå¤„ç†æ—¶çš„å¤„ç†ç­–ç•¥ï¼›\r\n\r\nè¿™é‡Œæˆ‘ä»¬é€‰æ‹©å¿½ç•¥ï¼Œå¦‚æœç«‹å³æ‰§è¡Œä¸€æ¬¡å°±å¯èƒ½é‡å¤æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps127.jpg) \r\n\r\nå…¶æ¬¡ï¼Œå†çœ‹é˜»å¡å¤„ç†ç­–ç•¥ï¼Œé˜»å¡å¤„ç†ç­–ç•¥å°±æ˜¯å½“å‰æ‰§è¡Œå™¨æ­£åœ¨æ‰§è¡Œä»»åŠ¡è¿˜æ²¡æœ‰ç»“æŸæ—¶è°ƒåº¦ä¸­å¿ƒè¿›è¡Œä»»åŠ¡è°ƒåº¦ï¼Œæ­¤æ—¶è¯¥å¦‚ä½•å¤„ç†ã€‚\r\n\r\næŸ¥çœ‹æ–‡æ¡£å¦‚ä¸‹ï¼š\r\n    å•æœºä¸²è¡Œï¼ˆé»˜è®¤ï¼‰ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œè°ƒåº¦è¯·æ±‚è¿›å…¥FIFOé˜Ÿåˆ—å¹¶ä»¥ä¸²è¡Œæ–¹å¼è¿è¡Œï¼›\r\n    ä¸¢å¼ƒåç»­è°ƒåº¦ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œå‘ç°æ‰§è¡Œå™¨å­˜åœ¨è¿è¡Œçš„è°ƒåº¦ä»»åŠ¡ï¼Œæœ¬æ¬¡è¯·æ±‚å°†ä¼šè¢«ä¸¢å¼ƒå¹¶æ ‡è®°ä¸ºå¤±è´¥ï¼›\r\n    è¦†ç›–ä¹‹å‰è°ƒåº¦ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œå‘ç°æ‰§è¡Œå™¨å­˜åœ¨è¿è¡Œçš„è°ƒåº¦ä»»åŠ¡ï¼Œå°†ä¼šç»ˆæ­¢è¿è¡Œä¸­çš„è°ƒåº¦ä»»åŠ¡å¹¶æ¸…ç©ºé˜Ÿåˆ—ï¼Œç„¶åè¿è¡Œæœ¬åœ°è°ƒåº¦ä»»åŠ¡ï¼›\r\n\r\nè¿™é‡Œå¦‚æœé€‰æ‹©è¦†ç›–ä¹‹å‰è°ƒåº¦åˆ™å¯èƒ½é‡å¤æ‰§è¡Œä»»åŠ¡ï¼Œè¿™é‡Œé€‰æ‹© ä¸¢å¼ƒåç»­è°ƒåº¦æˆ–å•æœºä¸²è¡Œæ–¹å¼æ¥é¿å…ä»»åŠ¡é‡å¤æ‰§è¡Œã€‚\r\n\r\nåªåšè¿™äº›é…ç½®å¯ä»¥ä¿è¯ä»»åŠ¡ä¸ä¼šé‡å¤æ‰§è¡Œå—ï¼Ÿ\r\n\r\nåšä¸åˆ°ï¼Œè¿˜éœ€è¦ä¿è¯ä»»åŠ¡å¤„ç†çš„å¹‚ç­‰æ€§ï¼Œä»€ä¹ˆæ˜¯ä»»åŠ¡çš„å¹‚ç­‰æ€§ï¼Ÿä»»åŠ¡çš„å¹‚ç­‰æ€§æ˜¯æŒ‡ï¼šå¯¹äºæ•°æ®çš„æ“ä½œä¸è®ºå¤šå°‘æ¬¡ï¼Œæ“ä½œçš„ç»“æœå§‹ç»ˆæ˜¯ä¸€è‡´çš„ã€‚åœ¨æœ¬é¡¹ç›®ä¸­è¦å®ç°çš„æ˜¯ä¸è®ºå¤šå°‘æ¬¡ä»»åŠ¡è°ƒåº¦åŒä¸€ä¸ªè§†é¢‘åªæ‰§è¡Œä¸€æ¬¡æˆåŠŸçš„è½¬ç ã€‚\r\n\r\nä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§ï¼Ÿ\r\n\r\nå®ƒæè¿°äº†ä¸€æ¬¡å’Œå¤šæ¬¡è¯·æ±‚æŸä¸€ä¸ªèµ„æºå¯¹äºèµ„æºæœ¬èº«åº”è¯¥å…·æœ‰åŒæ ·çš„ç»“æœã€‚\r\n\r\nå¹‚ç­‰æ€§æ˜¯ä¸ºäº†è§£å†³é‡å¤æäº¤é—®é¢˜ï¼Œæ¯”å¦‚ï¼šæ¶æ„åˆ·å•ï¼Œé‡å¤æ”¯ä»˜ç­‰ã€‚\r\n\r\nè§£å†³å¹‚ç­‰æ€§å¸¸ç”¨çš„æ–¹æ¡ˆï¼š\r\n\r\n1ï¼‰æ•°æ®åº“çº¦æŸï¼Œæ¯”å¦‚ï¼šå”¯ä¸€ç´¢å¼•ï¼Œä¸»é”®ã€‚\r\n\r\n2ï¼‰ä¹è§‚é”ï¼Œå¸¸ç”¨äºæ•°æ®åº“ï¼Œæ›´æ–°æ•°æ®æ—¶æ ¹æ®ä¹è§‚é”çŠ¶æ€å»æ›´æ–°ã€‚\r\n\r\n3ï¼‰å”¯ä¸€åºåˆ—å·ï¼Œæ“ä½œä¼ é€’ä¸€ä¸ªå”¯ä¸€åºåˆ—å·ï¼Œæ“ä½œæ—¶åˆ¤æ–­ä¸è¯¥åºåˆ—å·ç›¸ç­‰åˆ™æ‰§è¡Œã€‚\r\n\r\nåŸºäºä»¥ä¸Šåˆ†æï¼Œåœ¨æ‰§è¡Œå™¨æ¥æ”¶è°ƒåº¦è¯·æ±‚å»æ‰§è¡Œè§†é¢‘å¤„ç†ä»»åŠ¡æ—¶è¦å®ç°è§†é¢‘å¤„ç†çš„å¹‚ç­‰æ€§ï¼Œè¦æœ‰åŠæ³•å»åˆ¤æ–­è¯¥è§†é¢‘æ˜¯å¦å¤„ç†å®Œæˆï¼Œå¦‚æœæ­£åœ¨å¤„ç†ä¸­æˆ–å¤„ç†å®Œåˆ™ä¸å†å¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬åœ¨æ•°æ®åº“è§†é¢‘å¤„ç†è¡¨ä¸­æ·»åŠ å¤„ç†çŠ¶æ€å­—æ®µï¼Œè§†é¢‘å¤„ç†å®Œæˆæ›´æ–°çŠ¶æ€ä¸ºå®Œæˆï¼Œæ‰§è¡Œè§†é¢‘å¤„ç†å‰åˆ¤æ–­çŠ¶æ€æ˜¯å¦å®Œæˆï¼Œå¦‚æœå®Œæˆåˆ™ä¸å†å¤„ç†ã€‚\r\n\r\n \r\n\r\n#### **2.4.3 è§†é¢‘å¤„ç†æ–¹æ¡ˆ**\r\n\r\nç¡®å®šäº†åˆ†ç‰‡æ–¹æ¡ˆï¼Œä¸‹è¾¹æ¢³ç†æ•´ä¸ªè§†é¢‘ä¸Šä¼ åŠå¤„ç†çš„ä¸šåŠ¡æµç¨‹ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps128.jpg) \r\n\r\nä¸Šä¼ è§†é¢‘æˆåŠŸå‘è§†é¢‘å¤„ç†å¾…å¤„ç†è¡¨æ·»åŠ è®°å½•ã€‚\r\n\r\nè§†é¢‘å¤„ç†çš„è¯¦ç»†æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps129.jpg) \r\n\r\n1ã€ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒå¹¿æ’­ä½œä¸šåˆ†ç‰‡ã€‚\r\n\r\n2ã€æ‰§è¡Œå™¨æ”¶åˆ°å¹¿æ’­ä½œä¸šåˆ†ç‰‡ï¼Œä»æ•°æ®åº“è¯»å–å¾…å¤„ç†ä»»åŠ¡ï¼Œè¯»å–æœªå¤„ç†åŠå¤„ç†å¤±è´¥çš„ä»»åŠ¡ã€‚\r\n\r\n3ã€æ‰§è¡Œå™¨æ›´æ–°ä»»åŠ¡ä¸ºå¤„ç†ä¸­ï¼Œæ ¹æ®ä»»åŠ¡å†…å®¹ä»MinIOä¸‹è½½è¦å¤„ç†çš„æ–‡ä»¶ã€‚\r\n\r\n4ã€æ‰§è¡Œå™¨å¯åŠ¨å¤šçº¿ç¨‹å»å¤„ç†ä»»åŠ¡ã€‚\r\n\r\n5ã€ä»»åŠ¡å¤„ç†å®Œæˆï¼Œä¸Šä¼ å¤„ç†åçš„è§†é¢‘åˆ°MinIOã€‚\r\n\r\n6ã€å°†æ›´æ–°ä»»åŠ¡å¤„ç†ç»“æœï¼Œå¦‚æœè§†é¢‘å¤„ç†å®Œæˆé™¤äº†æ›´æ–°ä»»åŠ¡å¤„ç†ç»“æœä»¥å¤–è¿˜è¦å°†æ–‡ä»¶çš„è®¿é—®åœ°å€æ›´æ–°è‡³ä»»åŠ¡å¤„ç†è¡¨åŠæ–‡ä»¶è¡¨ä¸­ï¼Œæœ€åå°†ä»»åŠ¡å®Œæˆè®°å½•å†™å…¥å†å²è¡¨ã€‚\r\n\r\n \r\n\r\n \r\n\r\n### **2.5 æŸ¥è¯¢å¾…å¤„ç†ä»»åŠ¡**\r\n\r\n#### **2.5.1 éœ€æ±‚åˆ†æ**\r\n\r\næŸ¥è¯¢å¾…å¤„ç†ä»»åŠ¡åªå¤„ç†æœªæäº¤åŠå¤„ç†å¤±è´¥çš„ä»»åŠ¡ï¼Œä»»åŠ¡å¤„ç†å¤±è´¥åè¿›è¡Œé‡è¯•ï¼Œæœ€å¤šé‡è¯•3æ¬¡ã€‚\r\n\r\nä»»åŠ¡å¤„ç†æˆåŠŸå°†å¾…å¤„ç†è®°å½•ç§»åŠ¨åˆ°å†å²ä»»åŠ¡è¡¨ã€‚\r\n\r\nä¸‹å›¾æ˜¯å¾…å¤„ç†ä»»åŠ¡è¡¨ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps130.jpg) \r\n\r\nå†å²ä»»åŠ¡è¡¨ä¸å¾…å¤„ç†ä»»åŠ¡è¡¨çš„ç»“æ„ç›¸åŒã€‚\r\n\r\n \r\n\r\n \r\n\r\n#### **2.5.2æ·»åŠ å¾…å¤„ç†ä»»åŠ¡**\r\n\r\nä¸Šä¼ è§†é¢‘æˆåŠŸå‘è§†é¢‘å¤„ç†å¾…å¤„ç†è¡¨æ·»åŠ è®°å½•ï¼Œæš‚æ—¶åªæ·»åŠ å¯¹aviè§†é¢‘çš„å¤„ç†è®°å½•ã€‚\r\n\r\næ ¹æ®MIME Typeå»åˆ¤æ–­æ˜¯å¦æ˜¯aviè§†é¢‘ï¼Œä¸‹è¾¹åˆ—å‡ºéƒ¨åˆ†MIME Type\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps131.jpg) \r\n\r\naviè§†é¢‘çš„MIME Typeæ˜¯`video/x-msvideo`\r\n\r\nä¿®æ”¹æ–‡ä»¶ä¿¡æ¯å…¥åº“æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n@Transactional\r\npublic MediaFiles addMediaFilesToDb(Long companyId, String fileMd5, UploadFileParamsDto uploadFileParamsDto, String bucket, String objectName) {\r\n    //ä»æ•°æ®åº“æŸ¥è¯¢æ–‡ä»¶\r\n    MediaFiles mediaFiles = mediaFilesMapper.selectById(fileMd5);\r\n    if (mediaFiles == null) {\r\n        mediaFiles = new MediaFiles();\r\n        //æ‹·è´åŸºæœ¬ä¿¡æ¯\r\n        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);\r\n        mediaFiles.setId(fileMd5);\r\n        mediaFiles.setFileId(fileMd5);\r\n        mediaFiles.setCompanyId(companyId);\r\n        //åª’ä½“ç±»å‹\r\n        mediaFiles.setUrl(\"/\" + bucket + \"/\" + objectName);\r\n        mediaFiles.setBucket(bucket);\r\n        mediaFiles.setFilePath(objectName);\r\n        mediaFiles.setCreateDate(LocalDateTime.now());\r\n        mediaFiles.setAuditStatus(\"002003\");\r\n        mediaFiles.setStatus(\"1\");\r\n        //ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°æ–‡ä»¶è¡¨\r\n        int insert = mediaFilesMapper.insert(mediaFiles);\r\n        if (insert < 0) {\r\n            log.error(\"ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°æ•°æ®åº“å¤±è´¥,{}\", mediaFiles.toString());\r\n            XueChengPlusException.cast(\"ä¿å­˜æ–‡ä»¶ä¿¡æ¯å¤±è´¥\");\r\n        }\r\n        //æ·»åŠ åˆ°å¾…å¤„ç†ä»»åŠ¡è¡¨\r\n        addWaitingTask(mediaFiles);\r\n        log.debug(\"ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°æ•°æ®åº“æˆåŠŸ,{}\", mediaFiles.toString());\r\n\r\n    }\r\n    return mediaFiles;\r\n\r\n}\r\n\r\n/**\r\n * æ·»åŠ å¾…å¤„ç†ä»»åŠ¡\r\n * @param mediaFiles åª’èµ„æ–‡ä»¶ä¿¡æ¯\r\n */\r\nprivate void addWaitingTask(MediaFiles mediaFiles){\r\n    //æ–‡ä»¶åç§°\r\n    String filename = mediaFiles.getFilename();\r\n    //æ–‡ä»¶æ‰©å±•å\r\n    String extension = filename.substring(filename.lastIndexOf(\".\"));\r\n    //æ–‡ä»¶mimeType\r\n    String mimeType = getMimeType(extension);\r\n    //å¦‚æœæ˜¯aviè§†é¢‘æ·»åŠ åˆ°è§†é¢‘å¾…å¤„ç†è¡¨\r\n    if(mimeType.equals(\"video/x-msvideo\")){\r\n        MediaProcess mediaProcess = new MediaProcess();\r\n        BeanUtils.copyProperties(mediaFiles,mediaProcess);\r\n        mediaProcess.setStatus(\"1\");//æœªå¤„ç†\r\n        mediaProcess.setFailCount(0);//å¤±è´¥æ¬¡æ•°é»˜è®¤ä¸º0\r\n        mediaProcessMapper.insert(mediaProcess);\r\n    }\r\n}\r\n```\r\n\r\n \r\n\r\nè¿›è¡Œå‰åç«¯æµ‹è¯•ï¼Œä¸Šä¼ 4ä¸ªaviè§†é¢‘ï¼Œè§‚å¯Ÿå¾…å¤„ç†ä»»åŠ¡è¡¨æ˜¯å¦å­˜åœ¨è®°å½•ï¼Œè®°å½•æ˜¯å¦å®Œæˆã€‚\r\n\r\n \r\n\r\n \r\n\r\n#### **2.5.3 æŸ¥è¯¢å¾…å¤„ç†ä»»åŠ¡**\r\n\r\nå¦‚ä½•ä¿è¯æŸ¥è¯¢åˆ°çš„å¾…å¤„ç†è§†é¢‘è®°å½•ä¸é‡å¤ï¼Ÿ\r\n\r\nç¼–å†™æ ¹æ®åˆ†ç‰‡å‚æ•°è·å–å¾…å¤„ç†ä»»åŠ¡çš„DAOæ–¹æ³•ï¼Œå®šä¹‰DAOæ¥å£å¦‚ä¸‹ï¼š\r\n\r\n```java\r\npublic interface MediaProcessMapper extends BaseMapper<MediaProcess> {\r\n    /**\r\n     * @description æ ¹æ®åˆ†ç‰‡å‚æ•°è·å–å¾…å¤„ç†ä»»åŠ¡\r\n     * @param shardTotal  åˆ†ç‰‡æ€»æ•°\r\n     * @param shardindex  åˆ†ç‰‡åºå·\r\n     * @param count ä»»åŠ¡æ•°\r\n     * @return java.util.List<com.xuecheng.media.model.po.MediaProcess> \r\n    */\r\n    @Select(\"select * from media_process t where t.id % #{shardTotal} = #{shardIndex} and (t.status = '1' or t.status = '3') and t.fail_count < 3 limit #{count}\")\r\n    List<MediaProcess> selectListByShardIndex(@Param(\"shardTotal\") int shardTotal,@Param(\"shardIndex\") int shardIndex,@Param(\"count\") int count);\r\n}\r\n```\r\n\r\nå®šä¹‰Serviceæ¥å£ï¼ŒæŸ¥è¯¢å¾…å¤„ç†\r\n\r\n```java\r\n/**\r\n * @description åª’èµ„æ–‡ä»¶å¤„ç†ä¸šåŠ¡æ–¹æ³•\r\n */\r\npublic interface MediaFileProcessService {\r\n\r\n    /**\r\n     * @description è·å–å¾…å¤„ç†ä»»åŠ¡\r\n     * @param shardIndex åˆ†ç‰‡åºå·\r\n     * @param shardTotal åˆ†ç‰‡æ€»æ•°\r\n     * @param count è·å–è®°å½•æ•°\r\n     * @return java.util.List<com.xuecheng.media.model.po.MediaProcess>\r\n    */\r\n    public List<MediaProcess> getMediaProcessList(int shardIndex,int shardTotal,int count);\r\n\r\n\r\n}\r\n```\r\n\r\nserviceæ¥å£å®ç°\r\n\r\n```java\r\n@Slf4j\r\n@Service\r\npublic class MediaFileProcessServiceImpl implements MediaFileProcessService {\r\n\r\n @Autowired\r\n MediaFilesMapper mediaFilesMapper;\r\n\r\n @Autowired\r\n MediaProcessMapper mediaProcessMapper;\r\n\r\n @Override\r\n public List<MediaProcess> getMediaProcessList(int shardIndex, int shardTotal, int count) {\r\n  List<MediaProcess> mediaProcesses = mediaProcessMapper.selectListByShardIndex(shardTotal, shardIndex, count);\r\n   return mediaProcesses;\r\n }\r\n}\r\n```\r\n\r\n\r\n\r\n### **2.6 å¼€å§‹æ‰§è¡Œä»»åŠ¡**\r\n\r\n#### **2.6.1 åˆ†å¸ƒå¼é”**\r\n\r\nå‰è¾¹åˆ†æäº†ä¿è¯ä»»åŠ¡ä¸é‡å¤æ‰§è¡Œçš„æ–¹æ¡ˆï¼Œç†è®ºä¸Šæ¯ä¸ªæ‰§è¡Œå™¨åˆ†åˆ°çš„ä»»åŠ¡æ˜¯ä¸é‡å¤çš„ï¼Œä½†æ˜¯å½“åœ¨æ‰§è¡Œå™¨å¼¹æ€§æ‰©å®¹æ—¶æ— æ³•ç»å¯¹é¿å…ä»»åŠ¡ä¸é‡å¤æ‰§è¡Œï¼Œæ¯”å¦‚ï¼šåŸæ¥æœ‰å››ä¸ªæ‰§è¡Œå™¨æ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œç”±äºç½‘ç»œé—®é¢˜åŸæœ‰çš„0ã€1å·æ‰§è¡Œå™¨æ— æ³•ä¸è°ƒåº¦ä¸­å¿ƒé€šä¿¡ï¼Œè°ƒåº¦ä¸­å¿ƒå°±ä¼šå¯¹æ‰§è¡Œå™¨é‡æ–°ç¼–å·ï¼ŒåŸæ¥çš„3ã€4æ‰§è¡Œå™¨å¯èƒ½å°±ä¼šæ‰§è¡Œå’Œ0ã€1å·æ‰§è¡Œå™¨ç›¸åŒçš„ä»»åŠ¡ã€‚\r\n\r\nä¸ºäº†é¿å…å¤šçº¿ç¨‹å»äº‰æŠ¢åŒä¸€ä¸ªä»»åŠ¡å¯ä»¥ä½¿ç”¨`synchronized`åŒæ­¥é”å»è§£å†³ï¼Œå¦‚ä¸‹ä»£ç ï¼š\r\n\r\n```java\r\nsynchronized(é”å¯¹è±¡){   \r\n    æ‰§è¡Œä»»åŠ¡... \r\n}\r\n```\r\n\r\nsynchronizedåªèƒ½ä¿è¯åŒä¸€ä¸ªè™šæ‹Ÿæœºä¸­å¤šä¸ªçº¿ç¨‹å»äº‰æŠ¢é”ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps132.jpg) \r\n\r\nå¦‚æœæ˜¯å¤šä¸ªæ‰§è¡Œå™¨åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå¹¶ä¸èƒ½ä¿è¯åŒä¸€ä¸ªè§†é¢‘åªæœ‰ä¸€ä¸ªæ‰§è¡Œå™¨å»å¤„ç†ã€‚\r\n\r\nç°åœ¨è¦å®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ‰€æœ‰è™šæ‹Ÿæœºä¸­çš„çº¿ç¨‹å»åŒæ­¥æ‰§è¡Œå°±éœ€è¦è®©å¤šä¸ªè™šæ‹Ÿæœºå»å…±ç”¨ä¸€ä¸ªé”ï¼Œè™šæ‹Ÿæœºå¯ä»¥åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œé”ä¹Ÿå¯ä»¥åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps133.jpg) \r\n\r\n \r\n\r\nè™šæ‹Ÿæœºéƒ½å»æŠ¢å åŒä¸€ä¸ªé”ï¼Œé”æ˜¯ä¸€ä¸ªå•ç‹¬çš„ç¨‹åºæä¾›åŠ é”ã€è§£é”æœåŠ¡ã€‚\r\n\r\n**è¯¥é”å·²ä¸å±äºæŸä¸ªè™šæ‹Ÿæœºï¼Œè€Œæ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œç”±å¤šä¸ªè™šæ‹Ÿæœºæ‰€å…±äº«ï¼Œè¿™ç§é”å«åˆ†å¸ƒå¼é”ã€‚**\r\n\r\nå®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œå¸¸ç”¨çš„å¦‚ä¸‹ï¼š\r\n\r\n1ã€åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒé”\r\n\r\nåˆ©ç”¨æ•°æ®åº“ä¸»é”®å”¯ä¸€æ€§çš„ç‰¹ç‚¹ï¼Œæˆ–åˆ©ç”¨æ•°æ®åº“å”¯ä¸€ç´¢å¼•ã€è¡Œçº§é”çš„ç‰¹ç‚¹ï¼Œæ¯”å¦‚ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶å‘æ•°æ®åº“æ’å…¥ä¸»é”®ç›¸åŒçš„åŒä¸€æ¡è®°å½•ï¼Œè°æ’å…¥æˆåŠŸè°å°±è·å–é”ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶å»æ›´æ–°ç›¸åŒçš„è®°å½•ï¼Œè°æ›´æ–°æˆåŠŸè°å°±æŠ¢åˆ°é”ã€‚\r\n\r\n2ã€åŸºäº`redis`å®ç°é”\r\n\r\n`redis`æä¾›äº†åˆ†å¸ƒå¼é”çš„å®ç°æ–¹æ¡ˆï¼Œæ¯”å¦‚ï¼š`SETNXã€set nxã€redisson`ç­‰ã€‚\r\n\r\næ‹¿`SETNX`ä¸¾ä¾‹è¯´æ˜ï¼Œ`SETNX`å‘½ä»¤çš„å·¥ä½œè¿‡ç¨‹æ˜¯å»setä¸€ä¸ªä¸å­˜åœ¨çš„keyï¼Œå¤šä¸ªçº¿ç¨‹å»è®¾ç½®åŒä¸€ä¸ªkeyåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹è®¾ç½®æˆåŠŸï¼Œè®¾ç½®æˆåŠŸçš„çš„çº¿ç¨‹æ‹¿åˆ°é”ã€‚\r\n\r\n3ã€ä½¿ç”¨`zookeeper`å®ç°\r\n\r\n`zookeeper`æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œä¸»è¦è§£å†³åˆ†å¸ƒå¼ç¨‹åºä¹‹é—´çš„åŒæ­¥çš„é—®é¢˜ã€‚`zookeeper`çš„ç»“æ„ç±»ä¼¼çš„æ–‡ä»¶ç›®å½•ï¼Œå¤šçº¿ç¨‹å‘`zookeeper`åˆ›å»ºä¸€ä¸ªå­ç›®å½•(èŠ‚ç‚¹)åªä¼šæœ‰ä¸€ä¸ªåˆ›å»ºæˆåŠŸï¼Œåˆ©ç”¨æ­¤ç‰¹ç‚¹å¯ä»¥å®ç°åˆ†å¸ƒå¼é”ï¼Œè°åˆ›å»ºè¯¥ç»“ç‚¹æˆåŠŸè°å°±è·å¾—é”ã€‚\r\n\r\næœ¬æ¬¡æˆ‘ä»¬é€‰ç”¨æ•°æ®åº“å®ç°åˆ†å¸ƒé”ï¼Œåè¾¹çš„æ¨¡å—ä¼šé€‰ç”¨å…¶å®ƒæ–¹æ¡ˆåˆ°æ—¶å†è¯¦ç»†ä»‹ç»ã€‚\r\n\r\n#### **2.6.2 å¼€å¯ä»»åŠ¡**\r\n\r\nä¸‹è¾¹åŸºäºæ•°æ®åº“æ–¹å¼å®ç°åˆ†å¸ƒé”ï¼Œå¼€å§‹æ‰§è¡Œä»»åŠ¡å°†ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€æ›´æ–°ä¸º4è¡¨ç¤ºä»»åŠ¡æ‰§è¡Œä¸­ã€‚\r\n\r\nä¸‹è¾¹çš„sqlè¯­å¥å¯ä»¥å®ç°æ›´æ–°æ“ä½œï¼š\r\n\r\n```sql\r\nupdate media_process m set m.status='4' where  m.id=?\r\n```\r\n\r\nå¦‚æœæ˜¯å¤šä¸ªçº¿ç¨‹å»æ‰§è¡Œè¯¥sqléƒ½å°†ä¼šæ‰§è¡ŒæˆåŠŸï¼Œä½†éœ€æ±‚æ˜¯åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŠ¢åˆ°é”ï¼Œæ‰€ä»¥æ­¤sqlæ— æ³•æ»¡è¶³éœ€æ±‚ã€‚\r\n\r\nä½¿ç”¨ä¹è§‚é”æ–¹å¼å®ç°æ›´æ–°æ“ä½œï¼š\r\n\r\n```sql\r\n update media_process m set m.status='4' where (m.status='1' or m.status='3') and m.fail_count<3 and m.id=?\r\n```\r\n\r\nå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä¸Šè¾¹çš„sqlåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒæˆåŠŸã€‚\r\n\r\nä»€ä¹ˆæ˜¯ä¹è§‚é”ã€æ‚²è§‚é”ï¼Ÿ\r\n\r\n`synchronized`æ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œåœ¨æ‰§è¡Œè¢«synchronizedåŒ…è£¹çš„ä»£ç æ—¶éœ€è¦é¦–å…ˆè·å–é”ï¼Œæ²¡æœ‰æ‹¿åˆ°é”åˆ™æ— æ³•æ‰§è¡Œï¼Œæ˜¯æ€»æ‚²è§‚çš„è®¤ä¸ºåˆ«çš„çº¿ç¨‹ä¼šå»æŠ¢ï¼Œæ‰€ä»¥è¦æ‚²è§‚é”ã€‚\r\n\r\nä¹è§‚é”çš„æ€æƒ³æ˜¯å®ƒä¸è®¤ä¸ºä¼šæœ‰çº¿ç¨‹å»äº‰æŠ¢ï¼Œå°½ç®¡å»æ‰§è¡Œï¼Œå¦‚æœæ²¡æœ‰æ‰§è¡ŒæˆåŠŸå°±å†å»é‡è¯•ã€‚\r\n\r\næ•°æ®åº“çš„ä¹è§‚é”å®ç°æ–¹å¼æ˜¯åœ¨è¡¨ä¸­å¢åŠ ä¸€ä¸ª`version`å­—æ®µï¼Œæ›´æ–°æ—¶åˆ¤æ–­æ˜¯å¦ç­‰äºæŸä¸ªç‰ˆæœ¬ï¼Œç­‰äºåˆ™æ›´æ–°å¦åˆ™æ›´æ–°å¤±è´¥ï¼Œå¦‚ä¸‹æ–¹å¼ã€‚\r\n\r\n```sql\r\nupdate t1 set t1.data1 = '',t1.version='2' where t1.version='1'\r\n```\r\n\r\nå®ç°å¦‚ä¸‹ï¼š\r\n\r\n1ã€å®šä¹‰mapper\r\n\r\n```java\r\npublic interface MediaProcessMapper extends BaseMapper<MediaProcess> {\r\n\r\n    /**\r\n     * å¼€å¯ä¸€ä¸ªä»»åŠ¡\r\n     * @param id ä»»åŠ¡id\r\n     * @return æ›´æ–°è®°å½•æ•°\r\n     */\r\n    @Update(\"update media_process m set m.status='4' where (m.status='1' or m.status='3') and m.fail_count<3 and m.id=#{id}\")\r\n    int startTask(@Param(\"id\") long id);\r\n\r\n}\r\n```\r\n\r\n2ã€åœ¨MediaFileProcessServiceä¸­å®šä¹‰æ¥å£\r\n\r\n```java\r\n/**\r\n *  å¼€å¯ä¸€ä¸ªä»»åŠ¡\r\n * @param id ä»»åŠ¡id\r\n * @return trueå¼€å¯ä»»åŠ¡æˆåŠŸï¼Œfalseå¼€å¯ä»»åŠ¡å¤±è´¥\r\n */\r\npublic boolean startTask(long id);\r\n\r\n//å®ç°å¦‚ä¸‹\r\npublic boolean startTask(long id) {\r\n    int result = mediaProcessMapper.startTask(id);\r\n    return result<=0?false:true;\r\n}\r\n```\r\n\r\n \r\n\r\n### **2.7 æ›´æ–°ä»»åŠ¡çŠ¶æ€**\r\n\r\nä»»åŠ¡å¤„ç†å®Œæˆéœ€è¦æ›´æ–°ä»»åŠ¡å¤„ç†ç»“æœï¼Œä»»åŠ¡æ‰§è¡ŒæˆåŠŸæ›´æ–°è§†é¢‘çš„URLã€åŠä»»åŠ¡å¤„ç†ç»“æœï¼Œå°†å¾…å¤„ç†ä»»åŠ¡è®°å½•åˆ é™¤ï¼ŒåŒæ—¶å‘å†å²ä»»åŠ¡è¡¨æ·»åŠ è®°å½•ã€‚\r\n\r\nåœ¨MediaFileProcessServiceæ¥å£æ·»åŠ æ–¹æ³•\r\n\r\n```java\r\n/**\r\n * @description ä¿å­˜ä»»åŠ¡ç»“æœ\r\n * @param taskId  ä»»åŠ¡id\r\n * @param status ä»»åŠ¡çŠ¶æ€\r\n * @param fileId  æ–‡ä»¶id\r\n * @param url url\r\n * @param errorMsg é”™è¯¯ä¿¡æ¯\r\n * @return void\r\n */\r\nvoid saveProcessFinishStatus(Long taskId,String status,String fileId,String url,String errorMsg);\r\n```\r\n\r\nserviceæ¥å£æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n@Slf4j\r\n@Service\r\npublic class MediaFileProcessServiceImpl implements MediaFileProcessService {\r\n\r\n @Autowired\r\n MediaFilesMapper mediaFilesMapper;\r\n\r\n @Autowired\r\n MediaProcessMapper mediaProcessMapper;\r\n\r\n @Autowired\r\n MediaProcessHistoryMapper mediaProcessHistoryMapper;\r\n\r\n\r\n\r\n@Transactional\r\n@Override\r\npublic void saveProcessFinishStatus(Long taskId, String status, String fileId, String url, String errorMsg) {\r\n    //æŸ¥å‡ºä»»åŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç›´æ¥è¿”å›\r\n    MediaProcess mediaProcess = mediaProcessMapper.selectById(taskId);\r\n    if(mediaProcess == null){\r\n        return ;\r\n    }\r\n    //å¤„ç†å¤±è´¥ï¼Œæ›´æ–°ä»»åŠ¡å¤„ç†ç»“æœ\r\n    LambdaQueryWrapper<MediaProcess> queryWrapperById = new LambdaQueryWrapper<MediaProcess>().eq(MediaProcess::getId, taskId);\r\n    //å¤„ç†å¤±è´¥\r\n    if(status.equals(\"3\")){\r\n        MediaProcess mediaProcess_u = new MediaProcess();\r\n        mediaProcess_u.setStatus(\"3\");\r\n        mediaProcess_u.setErrormsg(errorMsg);\r\n        mediaProcess_u.setFailCount(mediaProcess.getFailCount()+1);\r\n        mediaProcessMapper.update(mediaProcess_u,queryWrapperById);\r\n        log.debug(\"æ›´æ–°ä»»åŠ¡å¤„ç†çŠ¶æ€ä¸ºå¤±è´¥ï¼Œä»»åŠ¡ä¿¡æ¯:{}\",mediaProcess_u);\r\n        return ;\r\n    }\r\n    //ä»»åŠ¡å¤„ç†æˆåŠŸ\r\n    MediaFiles mediaFiles = mediaFilesMapper.selectById(fileId);\r\n    if(mediaFiles!=null){\r\n        //æ›´æ–°åª’èµ„æ–‡ä»¶ä¸­çš„è®¿é—®url\r\n        mediaFiles.setUrl(url);\r\n        mediaFilesMapper.updateById(mediaFiles);\r\n    }\r\n    //å¤„ç†æˆåŠŸï¼Œæ›´æ–°urlå’ŒçŠ¶æ€\r\n    mediaProcess.setUrl(url);\r\n    mediaProcess.setStatus(\"2\");\r\n    mediaProcess.setFinishDate(LocalDateTime.now());\r\n    mediaProcessMapper.updateById(mediaProcess);\r\n\r\n    //æ·»åŠ åˆ°å†å²è®°å½•\r\n    MediaProcessHistory mediaProcessHistory = new MediaProcessHistory();\r\n    BeanUtils.copyProperties(mediaProcess, mediaProcessHistory);\r\n    mediaProcessHistoryMapper.insert(mediaProcessHistory);\r\n    //åˆ é™¤mediaProcess\r\n    mediaProcessMapper.deleteById(mediaProcess.getId());\r\n\r\n}\r\n\r\n @Override\r\n public List<MediaProcess> getMediaProcessList(int shardIndex, int shardTotal, int count) {\r\n  List<MediaProcess> mediaProcesses = mediaProcessMapper.selectListByShardIndex(shardTotal, shardIndex, count);\r\n   return mediaProcesses;\r\n }\r\n\r\n}\r\n```\r\n\r\n \r\n\r\n### **2.8 è§†é¢‘å¤„ç†**\r\n\r\nè§†é¢‘é‡‡ç”¨å¹¶å‘å¤„ç†ï¼Œæ¯ä¸ªè§†é¢‘ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ï¼Œæ¯æ¬¡å¤„ç†çš„è§†é¢‘æ•°é‡ä¸è¦è¶…è¿‡cpuæ ¸å¿ƒæ•°ã€‚\r\n\r\næ‰€æœ‰è§†é¢‘å¤„ç†å®Œæˆç»“æŸæœ¬æ¬¡æ‰§è¡Œï¼Œä¸ºé˜²æ­¢ä»£ç å¼‚å¸¸å‡ºç°æ— é™æœŸç­‰å¾…åˆ™æ·»åŠ è¶…æ—¶è®¾ç½®ï¼Œåˆ°è¾¾è¶…æ—¶æ—¶é—´è¿˜æ²¡æœ‰å¤„ç†å®Œæˆä»ç»“æŸä»»åŠ¡ã€‚\r\n\r\nå®šä¹‰ä»»åŠ¡ç±»VideoTask å¦‚ä¸‹ï¼š\r\n\r\n```java\r\n@Slf4j\r\n@Component\r\npublic class VideoTask {\r\n\r\n    @Autowired\r\n    MediaFileService mediaFileService;\r\n    @Autowired\r\n    MediaFileProcessService mediaFileProcessService;\r\n\r\n\r\n    @Value(\"${videoprocess.ffmpegpath}\")\r\n    String ffmpegpath;\r\n\r\n    @XxlJob(\"videoJobHandler\")\r\n    public void videoJobHandler() throws Exception {\r\n\r\n        // åˆ†ç‰‡å‚æ•°\r\n    int shardIndex = XxlJobHelper.getShardIndex();\r\n    int shardTotal = XxlJobHelper.getShardTotal();\r\n    List<MediaProcess> mediaProcessList = null;\r\n    int size = 0;\r\n    try {\r\n        //å–å‡ºcpuæ ¸å¿ƒæ•°ä½œä¸ºä¸€æ¬¡å¤„ç†æ•°æ®çš„æ¡æ•°\r\n        int processors = Runtime.getRuntime().availableProcessors();\r\n        //ä¸€æ¬¡å¤„ç†è§†é¢‘æ•°é‡ä¸è¦è¶…è¿‡cpuæ ¸å¿ƒæ•°\r\n        mediaProcessList = mediaFileProcessService.getMediaProcessList(shardIndex, shardTotal, processors);\r\n        size = mediaProcessList.size();\r\n        log.debug(\"å–å‡ºå¾…å¤„ç†è§†é¢‘ä»»åŠ¡{}æ¡\", size);\r\n        if (size <= 0) {\r\n            return;\r\n        }\r\n    } catch (Exception e) {\r\n        e.printStackTrace();\r\n        return;\r\n    }\r\n    //å¯åŠ¨sizeä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± \r\n    ExecutorService threadPool = Executors.newFixedThreadPool(size);\r\n    //è®¡æ•°å™¨\r\n    CountDownLatch countDownLatch = new CountDownLatch(size);\r\n    //å°†å¤„ç†ä»»åŠ¡åŠ å…¥çº¿ç¨‹æ± \r\n    mediaProcessList.forEach(mediaProcess -> {\r\n        threadPool.execute(() -> {\r\n            try {\r\n                //ä»»åŠ¡id\r\n                Long taskId = mediaProcess.getId();\r\n                //æŠ¢å ä»»åŠ¡\r\n                boolean b = mediaFileProcessService.startTask(taskId);\r\n                if (!b) {\r\n                    return;\r\n                }\r\n                log.debug(\"å¼€å§‹æ‰§è¡Œä»»åŠ¡:{}\", mediaProcess);\r\n                //ä¸‹è¾¹æ˜¯å¤„ç†é€»è¾‘\r\n                //æ¡¶\r\n                String bucket = mediaProcess.getBucket();\r\n                //å­˜å‚¨è·¯å¾„\r\n                String filePath = mediaProcess.getFilePath();\r\n                //åŸå§‹è§†é¢‘çš„md5å€¼\r\n                String fileId = mediaProcess.getFileId();\r\n                //åŸå§‹æ–‡ä»¶åç§°\r\n                String filename = mediaProcess.getFilename();\r\n                //å°†è¦å¤„ç†çš„æ–‡ä»¶ä¸‹è½½åˆ°æœåŠ¡å™¨ä¸Š\r\n                File originalFile = mediaFileService.downloadFileFromMinIO(mediaProcess.getBucket(), mediaProcess.getFilePath());\r\n                if (originalFile == null) {\r\n                    log.debug(\"ä¸‹è½½å¾…å¤„ç†æ–‡ä»¶å¤±è´¥,originalFile:{}\", mediaProcess.getBucket().concat(mediaProcess.getFilePath()));\r\n                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), \"3\", fileId, null, \"ä¸‹è½½å¾…å¤„ç†æ–‡ä»¶å¤±è´¥\");\r\n                    return;\r\n                }\r\n                //å¤„ç†ä¸‹è½½çš„è§†é¢‘æ–‡ä»¶\r\n                File mp4File = null;\r\n                try {\r\n                    mp4File = File.createTempFile(\"mp4\", \".mp4\");\r\n                } catch (IOException e) {\r\n                    log.error(\"åˆ›å»ºmp4ä¸´æ—¶æ–‡ä»¶å¤±è´¥\");\r\n                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), \"3\", fileId, null, \"åˆ›å»ºmp4ä¸´æ—¶æ–‡ä»¶å¤±è´¥\");\r\n                    return;\r\n                }\r\n                //è§†é¢‘å¤„ç†ç»“æœ\r\n                String result = \"\";\r\n                try {\r\n                    //å¼€å§‹å¤„ç†è§†é¢‘\r\n                    Mp4VideoUtil videoUtil = new Mp4VideoUtil(ffmpegpath, originalFile.getAbsolutePath(), mp4File.getName(), mp4File.getAbsolutePath());\r\n                    //å¼€å§‹è§†é¢‘è½¬æ¢ï¼ŒæˆåŠŸå°†è¿”å›success\r\n                    result = videoUtil.generateMp4();\r\n                } catch (Exception e) {\r\n                    e.printStackTrace();\r\n                    log.error(\"å¤„ç†è§†é¢‘æ–‡ä»¶:{},å‡ºé”™:{}\", mediaProcess.getFilePath(), e.getMessage());\r\n                }\r\n                if (!result.equals(\"success\")) {\r\n                    //è®°å½•é”™è¯¯ä¿¡æ¯\r\n                    log.error(\"å¤„ç†è§†é¢‘å¤±è´¥,è§†é¢‘åœ°å€:{},é”™è¯¯ä¿¡æ¯:{}\", bucket + filePath, result);\r\n                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), \"3\", fileId, null, result);\r\n                    return;\r\n                }\r\n    \r\n                //å°†mp4ä¸Šä¼ è‡³minio\r\n                //mp4åœ¨minioçš„å­˜å‚¨è·¯å¾„\r\n                String objectName = getFilePath(fileId, \".mp4\");\r\n                //è®¿é—®url\r\n                String url = \"/\" + bucket + \"/\" + objectName;\r\n                try {\r\n                    mediaFileService.addMediaFilesToMinIO(mp4File.getAbsolutePath(), \"video/mp4\", bucket, objectName);\r\n                    //å°†urlå­˜å‚¨è‡³æ•°æ®ï¼Œå¹¶æ›´æ–°çŠ¶æ€ä¸ºæˆåŠŸï¼Œå¹¶å°†å¾…å¤„ç†è§†é¢‘è®°å½•åˆ é™¤å­˜å…¥å†å²\r\n                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), \"2\", fileId, url, null);\r\n                } catch (Exception e) {\r\n                    log.error(\"ä¸Šä¼ è§†é¢‘å¤±è´¥æˆ–å…¥åº“å¤±è´¥,è§†é¢‘åœ°å€:{},é”™è¯¯ä¿¡æ¯:{}\", bucket + objectName, e.getMessage());\r\n                    //æœ€ç»ˆè¿˜æ˜¯å¤±è´¥äº†\r\n                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), \"3\", fileId, null, \"å¤„ç†åè§†é¢‘ä¸Šä¼ æˆ–å…¥åº“å¤±è´¥\");\r\n                }\r\n            }finally {\r\n                countDownLatch.countDown();\r\n            }\r\n        });\r\n    });\r\n    //ç­‰å¾…,ç»™ä¸€ä¸ªå……è£•çš„è¶…æ—¶æ—¶é—´,é˜²æ­¢æ— é™ç­‰å¾…ï¼Œåˆ°è¾¾è¶…æ—¶æ—¶é—´è¿˜æ²¡æœ‰å¤„ç†å®Œæˆåˆ™ç»“æŸä»»åŠ¡\r\n    countDownLatch.await(30, TimeUnit.MINUTES);\r\n    }\r\n\r\n    private String getFilePath(String fileMd5,String fileExt){\r\n        return   fileMd5.substring(0,1) + \"/\" + fileMd5.substring(1,2) + \"/\" + fileMd5 + \"/\" +fileMd5 +fileExt;\r\n    }\r\n\r\n}\r\n```\r\n\r\n \r\n\r\n### **2.9 æµ‹è¯•**\r\n\r\n#### **2.9.1 åŸºæœ¬æµ‹è¯•**\r\n\r\nè¿›å…¥xxl-jobè°ƒåº¦ä¸­å¿ƒæ·»åŠ æ‰§è¡Œå™¨å’Œè§†é¢‘å¤„ç†ä»»åŠ¡\r\n\r\nåœ¨xxl-jobé…ç½®ä»»åŠ¡è°ƒåº¦ç­–ç•¥ï¼š\r\n\r\n1ï¼‰é…ç½®é˜»å¡å¤„ç†ç­–ç•¥ä¸ºï¼šä¸¢å¼ƒåç»­è°ƒåº¦ã€‚\r\n\r\n2ï¼‰é…ç½®è§†é¢‘å¤„ç†è°ƒåº¦æ—¶é—´é—´éš”ä¸ç”¨æ ¹æ®è§†é¢‘å¤„ç†æ—¶é—´å»ç¡®å®šï¼Œå¯ä»¥é…ç½®çš„å°ä¸€äº›ï¼Œå¦‚ï¼š5åˆ†é’Ÿï¼Œå³ä½¿åˆ°è¾¾è°ƒåº¦æ—¶é—´å¦‚æœè§†é¢‘æ²¡æœ‰å¤„ç†å®Œä¼šä¸¢å¼ƒè°ƒåº¦è¯·æ±‚ã€‚\r\n\r\né…ç½®å®Œæˆå¼€å§‹æµ‹è¯•è§†é¢‘å¤„ç†ï¼š\r\n\r\n1ã€é¦–å…ˆä¸Šä¼ è‡³å°‘4ä¸ªè§†é¢‘ï¼Œémp4æ ¼å¼ã€‚\r\n\r\n2ã€åœ¨xxl-jobå¯åŠ¨è§†é¢‘å¤„ç†ä»»åŠ¡\r\n\r\n3ã€è§‚å¯Ÿåª’èµ„ç®¡ç†æœåŠ¡åå°æ—¥å¿—\r\n\r\n#### **2.9.2 å¤±è´¥æµ‹è¯•**\r\n\r\n1ã€å…ˆåœæ­¢è°ƒåº¦ä¸­å¿ƒçš„è§†é¢‘å¤„ç†ä»»åŠ¡ã€‚\r\n\r\n2ã€ä¸Šä¼ è§†é¢‘ï¼Œæ‰‹åŠ¨ä¿®æ”¹å¾…å¤„ç†ä»»åŠ¡è¡¨ä¸­file_pathå­—æ®µä¸ºä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶åœ°å€\r\n\r\n3ã€å¯åŠ¨ä»»åŠ¡\r\n\r\nè§‚å¯Ÿä»»åŠ¡å¤„ç†å¤±è´¥åæ˜¯å¦ä¼šé‡è¯•ï¼Œå¹¶è®°å½•å¤±è´¥æ¬¡æ•°ã€‚\r\n\r\n#### **2.9.3 æŠ¢å ä»»åŠ¡æµ‹è¯•**\r\n\r\n1ã€ä¿®æ”¹è°ƒåº¦ä¸­å¿ƒä¸­è§†é¢‘å¤„ç†ä»»åŠ¡çš„é˜»å¡å¤„ç†ç­–ç•¥ä¸ºâ€œè¦†ç›–ä¹‹é—´çš„è°ƒåº¦â€\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps134.jpg) \r\n\r\n2ã€åœ¨æŠ¢å ä»»åŠ¡ä»£ç å¤„æ‰“æ–­ç‚¹å¹¶é€‰æ‹©æ”¯æŒå¤šçº¿ç¨‹æ–¹å¼\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps135.jpg) \r\n\r\n3ã€åœ¨æŠ¢å ä»»åŠ¡ä»£ç å¤„çš„ä¸‹è¾¹ä¸¤è¡Œä»£ç åˆ†åˆ«æ‰“ä¸Šæ–­ç‚¹ï¼Œé¿å…è§‚å¯Ÿæ—¶ä»£ç ç»§ç»­æ‰§è¡Œã€‚\r\n\r\n4ã€å¯åŠ¨ä»»åŠ¡\r\n\r\næ­¤æ—¶å¤šä¸ªçº¿ç¨‹æ‰§è¡Œéƒ½åœç•™åœ¨æ–­ç‚¹å¤„\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps136.jpg) \r\n\r\nä¾æ¬¡æ”¾è¡Œï¼Œè§‚å¯ŸåŒä¸€ä¸ªä»»åŠ¡åªä¼šè¢«ä¸€ä¸ªçº¿ç¨‹æŠ¢å æˆåŠŸã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps137.jpg) \r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps138.jpg) \r\n\r\n \r\n\r\n### **2.10 å…¶å®ƒé—®é¢˜**\r\n\r\n#### **2.10.1 ä»»åŠ¡è¡¥å¿æœºåˆ¶**\r\n\r\nå¦‚æœæœ‰çº¿ç¨‹æŠ¢å äº†æŸä¸ªè§†é¢‘çš„å¤„ç†ä»»åŠ¡ï¼Œå¦‚æœçº¿ç¨‹å¤„ç†è¿‡ç¨‹ä¸­æŒ‚æ‰äº†ï¼Œè¯¥è§†é¢‘çš„çŠ¶æ€å°†ä¼šä¸€ç›´æ˜¯å¤„ç†ä¸­ï¼Œå…¶å®ƒçº¿ç¨‹å°†æ— æ³•å¤„ç†ï¼Œè¿™ä¸ªé—®é¢˜éœ€è¦ç”¨è¡¥å¿æœºåˆ¶ã€‚\r\n\r\nå•ç‹¬å¯åŠ¨ä¸€ä¸ªä»»åŠ¡æ‰¾åˆ°å¾…å¤„ç†ä»»åŠ¡è¡¨ä¸­è¶…è¿‡æ‰§è¡ŒæœŸé™ä½†ä»åœ¨å¤„ç†ä¸­çš„ä»»åŠ¡ï¼Œå°†ä»»åŠ¡çš„çŠ¶æ€æ”¹ä¸ºæ‰§è¡Œå¤±è´¥ã€‚\r\n\r\nä»»åŠ¡æ‰§è¡ŒæœŸé™æ˜¯å¤„ç†ä¸€ä¸ªè§†é¢‘çš„æœ€å¤§æ—¶é—´ï¼Œæ¯”å¦‚å®šä¸º30åˆ†é’Ÿï¼Œé€šè¿‡ä»»åŠ¡çš„å¯åŠ¨æ—¶é—´å»åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¶…è¿‡æ‰§è¡ŒæœŸé™ã€‚\r\n\r\nå¤§å®¶æ€è€ƒè¿™ä¸ªsqlè¯¥å¦‚ä½•å®ç°ï¼Ÿ\r\n\r\nå¤§å®¶å°è¯•è‡ªå·±å®ç°æ­¤ä»»åŠ¡è¡¥å¿æœºåˆ¶ã€‚\r\n\r\n#### **2.10.2 è¾¾åˆ°æœ€å¤§å¤±è´¥æ¬¡æ•°**\r\n\r\nå½“ä»»åŠ¡è¾¾åˆ°æœ€å¤§å¤±è´¥æ¬¡æ•°æ—¶ä¸€èˆ¬å°±è¯´æ˜ç¨‹åºå¤„ç†æ­¤è§†é¢‘å­˜åœ¨é—®é¢˜ï¼Œè¿™ç§æƒ…å†µå°±éœ€è¦äººå·¥å¤„ç†ï¼Œåœ¨é¡µé¢ä¸Šä¼šæç¤ºå¤±è´¥çš„ä¿¡æ¯ï¼Œäººå·¥å¯æ‰‹åŠ¨æ‰§è¡Œè¯¥è§†é¢‘è¿›è¡Œå¤„ç†ï¼Œæˆ–é€šè¿‡å…¶å®ƒè½¬ç å·¥å…·è¿›è¡Œè§†é¢‘è½¬ç ï¼Œè½¬ç åç›´æ¥ä¸Šä¼ mp4è§†é¢‘ã€‚\r\n\r\n \r\n\r\n#### **2.10.3  åˆ†å—æ–‡ä»¶æ¸…ç†é—®é¢˜**\r\n\r\nä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œåˆ†å—ä¸Šä¼ ï¼Œä¸Šä¼ ä¸€åŠä¸ä¼ äº†ï¼Œä¹‹å‰ä¸Šä¼ åˆ°minioçš„åˆ†å—æ–‡ä»¶è¦æ¸…ç†å—ï¼Ÿæ€ä¹ˆåšçš„ï¼Ÿ\r\n\r\n1ã€åœ¨æ•°æ®åº“ä¸­æœ‰ä¸€å¼ æ–‡ä»¶è¡¨è®°å½•minioä¸­å­˜å‚¨çš„æ–‡ä»¶ä¿¡æ¯ã€‚\r\n\r\n2ã€æ–‡ä»¶å¼€å§‹ä¸Šä¼ æ—¶ä¼šå†™å…¥æ–‡ä»¶è¡¨ï¼ŒçŠ¶æ€ä¸ºä¸Šä¼ ä¸­ï¼Œä¸Šä¼ å®Œæˆä¼šæ›´æ–°çŠ¶æ€ä¸ºä¸Šä¼ å®Œæˆã€‚\r\n\r\n3ã€å½“ä¸€ä¸ªæ–‡ä»¶ä¼ äº†ä¸€åŠä¸å†ä¸Šä¼ äº†è¯´æ˜è¯¥æ–‡ä»¶æ²¡æœ‰ä¸Šä¼ å®Œæˆï¼Œä¼šæœ‰å®šæ—¶ä»»åŠ¡å»æŸ¥è¯¢æ–‡ä»¶è¡¨ä¸­çš„è®°å½•ï¼Œå¦‚æœæ–‡ä»¶æœªä¸Šä¼ å®Œæˆåˆ™åˆ é™¤minioä¸­æ²¡æœ‰ä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶ç›®å½•ã€‚\r\n\r\n\r\n\r\n## **ä¸‰ ä»»åŠ¡è°ƒåº¦å®æˆ˜â€”è¯¾ç¨‹å‘å¸ƒ**\r\n\r\n### **3.1 éœ€æ±‚åˆ†æ**\r\n\r\n#### **3.1.1 æ•°æ®æ¨¡å‹**\r\n\r\næ•™å­¦æœºæ„äººå‘˜åœ¨è¯¾ç¨‹å®¡æ ¸é€šè¿‡åå³å¯å‘å¸ƒè¯¾ç¨‹ï¼Œè¯¾ç¨‹å‘å¸ƒåä¼šå…¬å¼€å±•ç¤ºåœ¨ç½‘ç«™ä¸Šä¾›å­¦ç”ŸæŸ¥çœ‹ã€é€‰è¯¾å’Œå­¦ä¹ ã€‚\r\n\r\nåœ¨ç½‘ç«™ä¸Šå±•ç¤ºè¯¾ç¨‹ä¿¡æ¯éœ€è¦è§£å†³è¯¾ç¨‹ä¿¡æ¯æ˜¾ç¤ºçš„æ€§èƒ½é—®é¢˜ï¼Œå¦‚æœé€Ÿåº¦æ…¢(æ’é™¤ç½‘é€Ÿ)ä¼šå½±å“ç”¨æˆ·çš„ä½“éªŒæ€§ã€‚\r\n\r\nå¦‚ä½•å»å¿«é€Ÿæœç´¢è¯¾ç¨‹ï¼Ÿ\r\n\r\næ‰“å¼€è¯¾ç¨‹è¯¦æƒ…é¡µé¢ä»ç„¶å»æŸ¥è¯¢æ•°æ®åº“å¯è¡Œå—ï¼Ÿ\r\n\r\nä¸ºäº†æé«˜ç½‘ç«™çš„é€Ÿåº¦éœ€è¦å°†è¯¾ç¨‹ä¿¡æ¯è¿›è¡Œç¼“å­˜ï¼Œå¹¶ä¸”è¦å°†è¯¾ç¨‹ä¿¡æ¯åŠ å…¥ç´¢å¼•åº“æ–¹ä¾¿æœç´¢ï¼Œä¸‹å›¾æ˜¾ç¤ºäº†è¯¾ç¨‹å‘å¸ƒåè¯¾ç¨‹ä¿¡æ¯çš„æµè½¬æƒ…å†µï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps1.jpg) \r\n\r\n1ã€å‘å†…å®¹ç®¡ç†æ•°æ®åº“çš„è¯¾ç¨‹å‘å¸ƒè¡¨å­˜å‚¨è¯¾ç¨‹å‘å¸ƒä¿¡æ¯ï¼Œæ›´æ–°è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯è¡¨ä¸­å‘å¸ƒçŠ¶æ€ä¸ºå·²å‘å¸ƒã€‚\r\n\r\n2ã€å‘Rediså­˜å‚¨è¯¾ç¨‹ç¼“å­˜ä¿¡æ¯ã€‚\r\n\r\n3ã€å‘Elasticsearchå­˜å‚¨è¯¾ç¨‹ç´¢å¼•ä¿¡æ¯ã€‚\r\n\r\n4ã€è¯·æ±‚åˆ†å¸ƒæ–‡ä»¶ç³»ç»Ÿå­˜å‚¨è¯¾ç¨‹é™æ€åŒ–é¡µé¢(å³htmlé¡µé¢)ï¼Œå®ç°å¿«é€Ÿæµè§ˆè¯¾ç¨‹è¯¦æƒ…é¡µé¢ã€‚\r\n\r\n \r\n\r\nè¯¾ç¨‹å‘å¸ƒè¡¨çš„æ•°æ®æ¥æºäºè¯¾ç¨‹é¢„å‘å¸ƒè¡¨ï¼Œå®ƒä»¬çš„ç»“æ„åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯è¯¾ç¨‹å‘å¸ƒè¡¨ä¸­çš„çŠ¶æ€æ˜¯è¯¾ç¨‹å‘å¸ƒçŠ¶æ€ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps2.jpg) \r\n\r\nredisä¸­çš„è¯¾ç¨‹ç¼“å­˜ä¿¡æ¯æ˜¯å°†è¯¾ç¨‹å‘å¸ƒè¡¨ä¸­çš„æ•°æ®è½¬ä¸ºjsonè¿›è¡Œå­˜å‚¨ã€‚\r\n\r\nelasticsearchä¸­çš„è¯¾ç¨‹ç´¢å¼•ä¿¡æ¯æ˜¯æ ¹æ®æœç´¢éœ€è¦å°†è¯¾ç¨‹åç§°ã€è¯¾ç¨‹ä»‹ç»ç­‰ä¿¡æ¯è¿›è¡Œç´¢å¼•å­˜å‚¨ã€‚\r\n\r\nMinIOä¸­å­˜å‚¨äº†è¯¾ç¨‹çš„é™æ€åŒ–é¡µé¢æ–‡ä»¶ï¼ˆhtmlç½‘é¡µï¼‰ï¼ŒæŸ¥çœ‹è¯¾ç¨‹è¯¦æƒ…æ˜¯é€šè¿‡æ–‡ä»¶ç³»ç»Ÿå»æµè§ˆè¯¾ç¨‹è¯¦æƒ…é¡µé¢ã€‚\r\n\r\n\r\n\r\n### **3.2 è¯¾ç¨‹å‘å¸ƒçš„åœºæ™¯æ–¹æ¡ˆ**\r\n\r\n\r\n\r\nç›®å‰æˆ‘ä»¬å·²ç»æœ‰äº†ä»»åŠ¡è°ƒåº¦çš„æŠ€æœ¯ç§¯ç´¯ï¼Œè¿™é‡Œé€‰ç”¨ä»»åŠ¡è°ƒåº¦çš„æ–¹æ¡ˆå»å®ç°åˆ†å¸ƒå¼äº‹åŠ¡æ§åˆ¶ï¼Œè¯¾ç¨‹å‘å¸ƒæ»¡è¶³ï¼šè¯¾ç¨‹å‘å¸ƒæ“ä½œåï¼Œå…ˆæ›´æ–°æ•°æ®åº“ä¸­çš„è¯¾ç¨‹å‘å¸ƒçŠ¶æ€ï¼Œæ›´æ–°åå‘redisã€elasticsearchã€MinIOå†™è¯¾ç¨‹ä¿¡æ¯ï¼Œåªè¦åœ¨ä¸€å®šæ—¶é—´å†…æœ€ç»ˆå‘redisã€elasticsearchã€MinIOå†™æ•°æ®æˆåŠŸå³å¯ã€‚\r\n\r\nä¸‹å›¾æ˜¯å…·ä½“çš„æŠ€æœ¯æ–¹æ¡ˆï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps3.jpg) \r\n\r\n \r\n\r\n1ã€åœ¨å†…å®¹ç®¡ç†æœåŠ¡çš„æ•°æ®åº“ä¸­æ·»åŠ ä¸€ä¸ªæ¶ˆæ¯è¡¨ï¼Œæ¶ˆæ¯è¡¨å’Œè¯¾ç¨‹å‘å¸ƒè¡¨åœ¨åŒä¸€ä¸ªæ•°æ®åº“ã€‚\r\n\r\n2ã€ç‚¹å‡»è¯¾ç¨‹å‘å¸ƒé€šè¿‡æœ¬åœ°äº‹åŠ¡å‘è¯¾ç¨‹å‘å¸ƒè¡¨å†™å…¥è¯¾ç¨‹å‘å¸ƒä¿¡æ¯ï¼ŒåŒæ—¶å‘æ¶ˆæ¯è¡¨å†™è¯¾ç¨‹å‘å¸ƒçš„æ¶ˆæ¯ã€‚é€šè¿‡æ•°æ®åº“è¿›è¡Œæ§åˆ¶ï¼Œåªè¦è¯¾ç¨‹å‘å¸ƒè¡¨æ’å…¥æˆåŠŸæ¶ˆæ¯è¡¨ä¹Ÿæ’å…¥æˆåŠŸï¼Œæ¶ˆæ¯è¡¨çš„æ•°æ®å°±è®°å½•äº†æŸé—¨è¯¾ç¨‹å‘å¸ƒçš„ä»»åŠ¡ã€‚\r\n\r\n3ã€å¯åŠ¨ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿå®šæ—¶è°ƒåº¦å†…å®¹ç®¡ç†æœåŠ¡å»å®šæ—¶æ‰«ææ¶ˆæ¯è¡¨çš„è®°å½•ã€‚\r\n\r\n4ã€å½“æ‰«æåˆ°è¯¾ç¨‹å‘å¸ƒçš„æ¶ˆæ¯æ—¶å³å¼€å§‹å®Œæˆå‘redisã€elasticsearchã€MinIOåŒæ­¥æ•°æ®çš„æ“ä½œã€‚\r\n\r\n5ã€åŒæ­¥æ•°æ®çš„ä»»åŠ¡å®Œæˆååˆ é™¤æ¶ˆæ¯è¡¨è®°å½•ã€‚\r\n\r\næ—¶åºå›¾å¦‚ä¸‹ï¼š\r\n\r\nä¸‹å›¾æ˜¯è¯¾ç¨‹å‘å¸ƒæ“ä½œçš„æµç¨‹ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps4.jpg) \r\n\r\n1ã€æ‰§è¡Œå‘å¸ƒæ“ä½œï¼Œå†…å®¹ç®¡ç†æœåŠ¡å­˜å‚¨è¯¾ç¨‹å‘å¸ƒè¡¨çš„åŒæ—¶å‘æ¶ˆæ¯è¡¨æ·»åŠ ä¸€æ¡â€œè¯¾ç¨‹å‘å¸ƒä»»åŠ¡â€ã€‚è¿™é‡Œä½¿ç”¨æœ¬åœ°äº‹åŠ¡ä¿è¯è¯¾ç¨‹å‘å¸ƒä¿¡æ¯ä¿å­˜æˆåŠŸï¼ŒåŒæ—¶æ¶ˆæ¯è¡¨ä¹Ÿä¿å­˜æˆåŠŸã€‚\r\n\r\n2ã€ä»»åŠ¡è°ƒåº¦æœåŠ¡å®šæ—¶è°ƒåº¦å†…å®¹ç®¡ç†æœåŠ¡æ‰«ææ¶ˆæ¯è¡¨ï¼Œç”±äºè¯¾ç¨‹å‘å¸ƒæ“ä½œåå‘æ¶ˆæ¯è¡¨æ’å…¥ä¸€æ¡è¯¾ç¨‹å‘å¸ƒä»»åŠ¡ï¼Œæ­¤æ—¶æ‰«æåˆ°ä¸€æ¡ä»»åŠ¡ã€‚\r\n\r\n3ã€æ‹¿åˆ°ä»»åŠ¡å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼Œåˆ†åˆ«å‘redisã€elasticsearchåŠæ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ•°æ®ã€‚\r\n\r\n4ã€ä»»åŠ¡å®Œæˆååˆ é™¤æ¶ˆæ¯è¡¨è®°å½•ã€‚\r\n\r\n\r\n\r\n### **3.3 è¯¾ç¨‹å‘å¸ƒæ¥å£**\r\n\r\n**3.3.1 æ¥å£å®šä¹‰**\r\n\r\næ ¹æ®è¯¾ç¨‹å‘å¸ƒçš„åˆ†å¸ƒå¼äº‹åŠ¡æ§åˆ¶æ–¹æ¡ˆï¼Œè¯¾ç¨‹å‘å¸ƒæ“ä½œé¦–å…ˆé€šè¿‡æœ¬åœ°äº‹åŠ¡å‘è¯¾ç¨‹å‘å¸ƒè¡¨å†™å…¥è¯¾ç¨‹å‘å¸ƒä¿¡æ¯å¹¶å‘æ¶ˆæ¯è¡¨æ’å…¥ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™é‡Œå®šä¹‰çš„è¯¾ç¨‹å‘å¸ƒæ¥å£è¦å®ç°è¯¥åŠŸèƒ½ã€‚\r\n\r\nåœ¨å†…å®¹ç®¡ç†æ¥å£å·¥ç¨‹ä¸­å®šä¹‰è¯¾ç¨‹å‘å¸ƒæ¥å£ã€‚\r\n\r\n```java\r\n\r\n /**\r\n * @description è¯¾ç¨‹é¢„è§ˆï¼Œå‘å¸ƒ\r\n */\r\n@Api(value = \"è¯¾ç¨‹é¢„è§ˆå‘å¸ƒæ¥å£\",tags = \"è¯¾ç¨‹é¢„è§ˆå‘å¸ƒæ¥å£\")\r\n@Controller\r\npublic class CoursePublishController {\r\n...\r\n @ApiOperation(\"è¯¾ç¨‹å‘å¸ƒ\")\r\n @ResponseBody\r\n @PostMapping (\"/coursepublish/{courseId}\")\r\npublic void coursepublish(@PathVariable(\"courseId\") Long courseId){\r\n\r\n}\r\n...\r\n```\r\n\r\n#### **3.3.2 æ¥å£å¼€å‘**\r\n\r\n##### **3.3.2.1 DAOå¼€å‘**\r\n\r\nè¯¾ç¨‹å‘å¸ƒæ“ä½œå¯¹æ•°æ®åº“æ“ä½œå¦‚ä¸‹ï¼š\r\n\r\n1ã€å‘è¯¾ç¨‹å‘å¸ƒè¡¨course_publishæ’å…¥ä¸€æ¡è®°å½•,è®°å½•æ¥æºäºè¯¾ç¨‹é¢„å‘å¸ƒè¡¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–°ï¼Œå‘å¸ƒçŠ¶æ€ä¸ºï¼šå·²å‘å¸ƒã€‚\r\n\r\n2ã€æ›´æ–°course_baseè¡¨çš„è¯¾ç¨‹å‘å¸ƒçŠ¶æ€ä¸ºï¼šå·²å‘å¸ƒ\r\n\r\n3ã€åˆ é™¤è¯¾ç¨‹é¢„å‘å¸ƒè¡¨çš„å¯¹åº”è®°å½•ã€‚\r\n\r\n4ã€å‘mq_messageæ¶ˆæ¯è¡¨æ’å…¥ä¸€æ¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯ç±»å‹ä¸ºï¼šcourse_publish\r\n\r\nçº¦æŸï¼š\r\n\r\n1ã€è¯¾ç¨‹å®¡æ ¸é€šè¿‡æ–¹å¯å‘å¸ƒã€‚\r\n\r\n2ã€æœ¬æœºæ„åªå…è®¸å‘å¸ƒæœ¬æœºæ„çš„è¯¾ç¨‹ã€‚\r\n\r\n \r\n\r\nä»¥ä¸ŠåŠŸèƒ½ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„mapperæ¥å£å³å¯å®Œæˆã€‚\r\n\r\n \r\n\r\n1ã€åœ¨å†…å®¹ç®¡ç†æ•°æ®åº“åˆ›å»ºmq_messageæ¶ˆæ¯è¡¨åŠæ¶ˆæ¯å†å²æ¶ˆæ¯è¡¨ï¼ˆå†å²è¡¨å­˜å‚¨å·²ç»å®Œæˆçš„æ¶ˆæ¯ï¼‰ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps5.jpg) \r\n\r\næ¶ˆæ¯è¡¨ç»“æ„å¦‚ä¸‹ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps6.jpg) \r\n\r\n \r\n\r\n2ã€ç”Ÿæˆmq_messageæ¶ˆæ¯è¡¨ã€course_publishè¯¾ç¨‹å‘å¸ƒè¡¨çš„poå’Œmapperæ¥å£\r\n\r\nç¨åä¼šå¼€å‘ä¸€ä¸ªé€šç”¨çš„æ¶ˆæ¯å¤„ç†ç»„ä»¶ï¼Œè¿™é‡Œå…ˆä¸ç”Ÿæˆä»£ç ã€‚\r\n\r\n \r\n\r\n##### **3.3.2.2 Serviceå¼€å‘**\r\n\r\nå®šä¹‰Serviceæ¥å£ï¼š\r\n\r\n```java\r\n\r\n/**\r\n * @description è¯¾ç¨‹å‘å¸ƒæ¥å£\r\n * @param companyId æœºæ„id\r\n * @param courseId è¯¾ç¨‹id\r\n * @return void\r\n*/\r\npublic void publish(Long companyId,Long courseId);\r\n```\r\n\r\nç¼–å†™è¯¾ç¨‹å‘å¸ƒçš„Serviceæ–¹æ³•ï¼š\r\n\r\n```java\r\n\r\n @Transactional\r\n @Override\r\n public void publish(Long companyId, Long courseId) {\r\n\r\n  //çº¦æŸæ ¡éªŒ\r\n  //æŸ¥è¯¢è¯¾ç¨‹é¢„å‘å¸ƒè¡¨\r\n  CoursePublishPre coursePublishPre = coursePublishPreMapper.selectById(courseId);\r\n  if(coursePublishPre == null){\r\n     XueChengPlusException.cast(\"è¯·å…ˆæäº¤è¯¾ç¨‹å®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡æ‰å¯ä»¥å‘å¸ƒ\");\r\n  }\r\n  //æœ¬æœºæ„åªå…è®¸æäº¤æœ¬æœºæ„çš„è¯¾ç¨‹\r\n  if(!coursePublishPre.getCompanyId().equals(companyId)){\r\n   XueChengPlusException.cast(\"ä¸å…è®¸æäº¤å…¶å®ƒæœºæ„çš„è¯¾ç¨‹ã€‚\");\r\n  }\r\n\r\n\r\n  //è¯¾ç¨‹å®¡æ ¸çŠ¶æ€\r\n  String auditStatus = coursePublishPre.getStatus();\r\n  //å®¡æ ¸é€šè¿‡æ–¹å¯å‘å¸ƒ\r\n  if(!\"202004\".equals(auditStatus)){\r\n   XueChengPlusException.cast(\"æ“ä½œå¤±è´¥ï¼Œè¯¾ç¨‹å®¡æ ¸é€šè¿‡æ–¹å¯å‘å¸ƒã€‚\");\r\n  }\r\n\r\n  //ä¿å­˜è¯¾ç¨‹å‘å¸ƒä¿¡æ¯\r\n  saveCoursePublish(courseId);\r\n\r\n  //ä¿å­˜æ¶ˆæ¯è¡¨\r\n  saveCoursePublishMessage(courseId);\r\n\r\n //åˆ é™¤è¯¾ç¨‹é¢„å‘å¸ƒè¡¨å¯¹åº”è®°å½•\r\n  coursePublishPreMapper.deleteById(courseId);\r\n\r\n }\r\n\r\n/**\r\n * @description ä¿å­˜è¯¾ç¨‹å‘å¸ƒä¿¡æ¯\r\n * @param courseId  è¯¾ç¨‹id\r\n * @return void\r\n*/\r\n private void saveCoursePublish(Long courseId){\r\n   //æ•´åˆè¯¾ç¨‹å‘å¸ƒä¿¡æ¯\r\n  //æŸ¥è¯¢è¯¾ç¨‹é¢„å‘å¸ƒè¡¨\r\n  CoursePublishPre coursePublishPre = coursePublishPreMapper.selectById(courseId);\r\n  if(coursePublishPre == null){\r\n   XueChengPlusException.cast(\"è¯¾ç¨‹é¢„å‘å¸ƒæ•°æ®ä¸ºç©º\");\r\n  }\r\n\r\n  CoursePublish coursePublish = new CoursePublish();\r\n\r\n  //æ‹·è´åˆ°è¯¾ç¨‹å‘å¸ƒå¯¹è±¡\r\n  BeanUtils.copyProperties(coursePublishPre,coursePublish);\r\n  coursePublish.setStatus(\"203002\");\r\n  CoursePublish coursePublishUpdate = coursePublishMapper.selectById(courseId);\r\n  if(coursePublishUpdate == null){\r\n   coursePublishMapper.insert(coursePublish);\r\n  }else{\r\n   coursePublishMapper.updateById(coursePublish);\r\n  }\r\n  //æ›´æ–°è¯¾ç¨‹åŸºæœ¬è¡¨çš„å‘å¸ƒçŠ¶æ€\r\n  CourseBase courseBase = courseBaseMapper.selectById(courseId);\r\n  courseBase.setStatus(\"203002\");\r\n  courseBaseMapper.updateById(courseBase);\r\n\r\n }\r\n\r\n /**\r\n  * @description ä¿å­˜æ¶ˆæ¯è¡¨è®°å½•ï¼Œç¨åå®ç°\r\n  * @param courseId  è¯¾ç¨‹id\r\n  * @return void\r\n  */\r\nprivate void saveCoursePublishMessage(Long courseId){\r\n\r\n\r\n}\r\n```\r\n\r\n##### **3.3.2.3 æ¥å£å®Œå–„**\r\n\r\nå®Œå–„æ¥å£å±‚ä»£ç \r\n\r\n```java\r\n\r\n @ApiOperation(\"è¯¾ç¨‹å‘å¸ƒ\")\r\n @ResponseBody\r\n @PostMapping (\"/coursepublish/{courseId}\")\r\npublic void coursepublish(@PathVariable(\"courseId\") Long courseId){\r\n     Long companyId = 1232141425L;\r\n     coursePublishService.publish(companyId,courseId);\r\n\r\n }\r\n```\r\n\r\n#### **3.3.3 æ¥å£æµ‹è¯•**\r\n\r\nå…ˆä½¿ç”¨httpclientæ–¹æ³•æµ‹è¯•ï¼š\r\n\r\n```http\r\n### è¯¾ç¨‹å‘å¸ƒ\r\nPOST {{content_host}}/content/coursepublish/2\r\n```\r\n\r\nå…ˆæµ‹è¯•çº¦æŸæ¡ä»¶ï¼š\r\n\r\n1ã€åœ¨æœªæäº¤å®¡æ ¸æ—¶è¿›è¡Œè¯¾ç¨‹å‘å¸ƒæµ‹è¯•ã€‚\r\n\r\n2ã€åœ¨è¯¾ç¨‹æœªå®¡æ ¸é€šè¿‡æ—¶è¿›è¡Œå‘å¸ƒã€‚\r\n\r\næ­£å¸¸æµç¨‹æµ‹è¯•ï¼š\r\n\r\n1ã€æäº¤å®¡æ ¸è¯¾ç¨‹\r\n\r\n2ã€æ‰‹åŠ¨ä¿®æ”¹è¯¾ç¨‹é¢„å‘å¸ƒè¡¨ä¸è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯çš„å®¡æ ¸çŠ¶æ€ä¸ºå®¡æ ¸é€šè¿‡ã€‚\r\n\r\n3ã€æ‰§è¡Œè¯¾ç¨‹å‘å¸ƒ\r\n\r\n4ã€è§‚å¯Ÿè¯¾ç¨‹å‘å¸ƒè¡¨è®°å½•æ˜¯å¦æ­£å¸¸ï¼Œè¯¾ç¨‹é¢„å‘å¸ƒè¡¨è®°å½•å·²ç»åˆ é™¤ï¼Œè¯¾ç¨‹åŸºæœ¬ä¿¡æ¯è¡¨ä¸è¯¾ç¨‹å‘å¸ƒè¡¨çš„å‘å¸ƒçŠ¶æ€ä¸ºâ€å‘å¸ƒâ€œã€‚\r\n\r\nä½¿ç”¨å‰åç«¯è”è°ƒæ–¹å¼æµ‹è¯•ã€‚\r\n\r\n### **3.4 æ¶ˆæ¯å¤„ç†SDK**\r\n\r\n#### **3.4.1 æ¶ˆæ¯æ¨¡å—æŠ€æœ¯æ–¹æ¡ˆ**\r\n\r\nè¯¾ç¨‹å‘å¸ƒæ“ä½œæ‰§è¡Œåéœ€è¦æ‰«ææ¶ˆæ¯è¡¨çš„è®°å½•ï¼Œæœ‰å…³æ¶ˆæ¯è¡¨å¤„ç†çš„æœ‰å“ªäº›ï¼Ÿ\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps7.jpg) \r\n\r\nä¸Šå›¾ä¸­çº¢è‰²æ¡†å†…çš„éƒ½æ˜¯ä¸æ¶ˆæ¯å¤„ç†ç›¸å…³çš„æ“ä½œï¼š\r\n\r\n1ã€æ–°å¢æ¶ˆæ¯è¡¨\r\n\r\n2ã€æ‰«ææ¶ˆæ¯è¡¨ã€‚\r\n\r\n3ã€æ›´æ–°æ¶ˆæ¯è¡¨ã€‚\r\n\r\n4ã€åˆ é™¤æ¶ˆæ¯è¡¨ã€‚\r\n\r\nä½¿ç”¨æ¶ˆæ¯è¡¨è¿™ç§æ–¹å¼å®ç°æœ€ç»ˆäº‹åŠ¡ä¸€è‡´æ€§çš„åœ°æ–¹é™¤äº†è¯¾ç¨‹å‘å¸ƒè¿˜æœ‰å…¶å®ƒä¸šåŠ¡åœºæ™¯ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps8.jpg) \r\n\r\nå¦‚æœåœ¨æ¯ä¸ªåœ°æ–¹éƒ½å®ç°ä¸€å¥—é’ˆå¯¹æ¶ˆæ¯è¡¨å®šæ—¶æ‰«æã€å¤„ç†çš„é€»è¾‘åŸºæœ¬ä¸Šéƒ½æ˜¯é‡å¤çš„ï¼Œè½¯ä»¶çš„å¯å¤ç”¨æ€§å¤ªä½ï¼Œæˆæœ¬å¤ªé«˜ã€‚\r\n\r\nå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ\r\n\r\né’ˆå¯¹è¿™ä¸ªé—®é¢˜å¯ä»¥æƒ³åˆ°å°†æ¶ˆæ¯å¤„ç†ç›¸å…³çš„é€»è¾‘åšæˆä¸€ä¸ªé€šç”¨çš„ä¸œè¥¿ã€‚\r\n\r\næ˜¯åšæˆé€šç”¨çš„æœåŠ¡ï¼Œè¿˜æ˜¯åšæˆé€šç”¨çš„ä»£ç ç»„ä»¶å‘¢ï¼Ÿ\r\n\r\né€šç”¨çš„æœåŠ¡æ˜¯å®Œæˆä¸€ä¸ªé€šç”¨çš„ç‹¬ç«‹åŠŸèƒ½ï¼Œå¹¶æä¾›ç‹¬ç«‹çš„ç½‘ç»œæ¥å£ï¼Œæ¯”å¦‚ï¼šé¡¹ç›®ä¸­çš„æ–‡ä»¶ç³»ç»ŸæœåŠ¡ï¼Œæä¾›æ–‡ä»¶çš„åˆ†å¸ƒå¼å­˜å‚¨æœåŠ¡ã€‚\r\n\r\nä»£ç ç»„ä»¶ä¹Ÿæ˜¯å®Œæˆä¸€ä¸ªé€šç”¨çš„ç‹¬ç«‹åŠŸèƒ½ï¼Œé€šå¸¸ä¼šæä¾›APIçš„æ–¹å¼ä¾›å¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ï¼Œæ¯”å¦‚ï¼šfastjsonã€Apache commonså·¥å…·åŒ…ç­‰ã€‚\r\n\r\nå¦‚æœå°†æ¶ˆæ¯å¤„ç†åšæˆä¸€ä¸ªé€šç”¨çš„æœåŠ¡ï¼Œè¯¥æœåŠ¡éœ€è¦è¿æ¥å¤šä¸ªæ•°æ®åº“ï¼Œå› ä¸ºå®ƒè¦æ‰«æå¾®æœåŠ¡æ•°æ®åº“ä¸‹çš„æ¶ˆæ¯è¡¨ï¼Œå¹¶ä¸”è¦æä¾›ä¸å¾®æœåŠ¡é€šä¿¡çš„ç½‘ç»œæ¥å£ï¼Œå•å°±é’ˆå¯¹å½“å‰éœ€æ±‚è€Œè¨€å¼€å‘æˆæœ¬æœ‰ç‚¹é«˜ã€‚\r\n\r\nå¦‚æœå°†æ¶ˆæ¯å¤„ç†åšä¸€ä¸ªSDKå·¥å…·åŒ…ç›¸æ¯”é€šç”¨æœåŠ¡ä¸ä»…å¯ä»¥è§£å†³å°†æ¶ˆæ¯å¤„ç†é€šç”¨åŒ–çš„éœ€æ±‚ï¼Œè¿˜å¯ä»¥é™ä½æˆæœ¬ã€‚\r\n\r\næ‰€ä»¥ï¼Œæœ¬é¡¹ç›®ç¡®å®šå°†å¯¹æ¶ˆæ¯è¡¨ç›¸å…³çš„å¤„ç†åšæˆä¸€ä¸ªSDKç»„ä»¶ä¾›å„å¾®æœåŠ¡ä½¿ç”¨,å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps9.jpg) \r\n\r\nä¸‹è¾¹å¯¹æ¶ˆæ¯SDKçš„è®¾è®¡å†…å®¹è¿›è¡Œè¯´æ˜ï¼š\r\n\r\nsdkéœ€è¦æä¾›æ‰§è¡Œä»»åŠ¡çš„é€»è¾‘å—ï¼Ÿ\r\n\r\næ‹¿è¯¾ç¨‹å‘å¸ƒä»»åŠ¡ä¸¾ä¾‹ï¼Œæ‰§è¡Œè¯¾ç¨‹å‘å¸ƒä»»åŠ¡æ˜¯è¦å‘redisã€ç´¢å¼•åº“ç­‰åŒæ­¥æ•°æ®ï¼Œå…¶å®ƒä»»åŠ¡çš„æ‰§è¡Œé€»è¾‘æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥æ‰§è¡Œä»»åŠ¡åœ¨sdkä¸­ä¸ç”¨å®ç°ä»»åŠ¡é€»è¾‘ï¼Œåªéœ€è¦æä¾›ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ç”±å…·ä½“çš„æ‰§è¡Œä»»åŠ¡æ–¹å»å®ç°ã€‚\r\n\r\nå¦‚ä½•ä¿è¯ä»»åŠ¡çš„å¹‚ç­‰æ€§ï¼Ÿ\r\n\r\nåœ¨è§†é¢‘å¤„ç†ç« èŠ‚ä»‹ç»çš„è§†é¢‘å¤„ç†çš„å¹‚ç­‰æ€§æ–¹æ¡ˆï¼Œè¿™é‡Œå¯ä»¥é‡‡ç”¨ç±»ä¼¼æ–¹æ¡ˆï¼Œä»»åŠ¡æ‰§è¡Œå®Œæˆåä¼šä»æ¶ˆæ¯è¡¨åˆ é™¤ï¼Œå¦‚æœæ¶ˆæ¯çš„çŠ¶æ€æ˜¯å®Œæˆæˆ–ä¸å­˜åœ¨æ¶ˆæ¯è¡¨ä¸­åˆ™ä¸ç”¨æ‰§è¡Œã€‚\r\n\r\nå¦‚ä½•ä¿è¯ä»»åŠ¡ä¸é‡å¤æ‰§è¡Œï¼Ÿ\r\n\r\né‡‡ç”¨å’Œè§†é¢‘å¤„ç†ç« èŠ‚ä¸€è‡´æ–¹æ¡ˆï¼Œé™¤äº†ä¿è¯ä»»åŠ¡çš„å¹‚ç­‰æ€§å¤–ï¼Œä»»åŠ¡è°ƒåº¦é‡‡ç”¨åˆ†ç‰‡å¹¿æ’­ï¼Œæ ¹æ®åˆ†ç‰‡å‚æ•°å»è·å–ä»»åŠ¡ï¼Œå¦å¤–é˜»å¡è°ƒåº¦ç­–ç•¥ä¸ºä¸¢å¼ƒä»»åŠ¡ã€‚\r\n\r\næ³¨æ„ï¼šè¿™é‡Œæ˜¯ä¿¡æ¯åŒæ­¥ç±»ä»»åŠ¡ï¼Œå³ä½¿ä»»åŠ¡é‡å¤æ‰§è¡Œä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œä¸å†ä½¿ç”¨æŠ¢å ä»»åŠ¡çš„æ–¹å¼ä¿è¯ä»»åŠ¡ä¸é‡å¤æ‰§è¡Œã€‚\r\n\r\nè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ ¹æ®æ¶ˆæ¯è¡¨è®°å½•æ˜¯å¦å­˜åœ¨æˆ–æ¶ˆæ¯è¡¨ä¸­çš„ä»»åŠ¡çŠ¶æ€å»ä¿è¯ä»»åŠ¡çš„å¹‚ç­‰æ€§ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡æœ‰å¥½å‡ ä¸ªå°ä»»åŠ¡ï¼Œæ¯”å¦‚ï¼šè¯¾ç¨‹å‘å¸ƒä»»åŠ¡éœ€è¦æ‰§è¡Œä¸‰ä¸ªåŒæ­¥æ“ä½œï¼šå­˜å‚¨è¯¾ç¨‹åˆ°redisã€å­˜å‚¨è¯¾ç¨‹åˆ°ç´¢å¼•åº“ï¼Œå­˜å‚¨è¯¾ç¨‹é¡µé¢åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªå°ä»»åŠ¡å·²ç»å®Œæˆä¹Ÿä¸åº”è¯¥å»é‡å¤æ‰§è¡Œã€‚è¿™é‡Œè¯¥å¦‚ä½•è®¾è®¡ï¼Ÿ\r\n\r\n \r\n\r\nå°†å°ä»»åŠ¡ä½œä¸ºä»»åŠ¡çš„ä¸åŒçš„é˜¶æ®µï¼Œåœ¨æ¶ˆæ¯è¡¨ä¸­è®¾è®¡é˜¶æ®µçŠ¶æ€ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps10.jpg) \r\n\r\næ¯å®Œæˆä¸€ä¸ªé˜¶æ®µåœ¨ç›¸åº”çš„é˜¶æ®µçŠ¶æ€å­—æ®µæ‰“ä¸Šå®Œæˆæ ‡è®°ï¼Œå³ä½¿è¿™ä¸ªå¤§ä»»åŠ¡æ²¡æœ‰å®Œæˆå†é‡æ–°æ‰§è¡Œæ—¶ï¼Œå¦‚æœå°é˜¶æ®µä»»åŠ¡å®Œæˆäº†ä¹Ÿä¸ä¼šé‡å¤æ‰§è¡ŒæŸä¸ªå°é˜¶æ®µçš„ä»»åŠ¡ã€‚\r\n\r\nç»¼ä¸Šæ‰€è¿°ï¼Œé™¤äº†æ¶ˆæ¯è¡¨çš„åŸºæœ¬çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥çš„æ¥å£å¤–ï¼Œæ¶ˆæ¯SDKè¿˜å…·æœ‰å¦‚ä¸‹æ¥å£åŠŸèƒ½ï¼š\r\n\r\n```java\r\n\r\npackage com.xuecheng.messagesdk.service;\r\n\r\nimport com.baomidou.mybatisplus.extension.service.IService;\r\nimport com.xuecheng.messagesdk.model.po.MqMessage;\r\n\r\nimport java.util.List;\r\n\r\n/**\r\n * <p>\r\n *  æœåŠ¡ç±»\r\n * </p>\r\n */\r\npublic interface MqMessageService extends IService<MqMessage> {\r\n\r\n    /**\r\n     * @description æ‰«ææ¶ˆæ¯è¡¨è®°å½•ï¼Œé‡‡ç”¨ä¸æ‰«æè§†é¢‘å¤„ç†è¡¨ç›¸åŒçš„æ€è·¯\r\n     * @param shardIndex åˆ†ç‰‡åºå·\r\n     * @param shardTotal åˆ†ç‰‡æ€»æ•°\r\n     * @param count æ‰«æè®°å½•æ•°\r\n     * @return java.util.List æ¶ˆæ¯è®°å½•\r\n     */\r\n    public List<MqMessage> getMessageList(int shardIndex, int shardTotal,  String messageType,int count);\r\n\r\n    /**\r\n     * @description å®Œæˆä»»åŠ¡\r\n     * @param id æ¶ˆæ¯id\r\n     * @return int æ›´æ–°æˆåŠŸï¼š1\r\n     */\r\n    public int completed(long id);\r\n\r\n    /**\r\n     * @description å®Œæˆé˜¶æ®µä»»åŠ¡\r\n     * @param id æ¶ˆæ¯id\r\n     * @return int æ›´æ–°æˆåŠŸï¼š1\r\n     */\r\n    public int completedStageOne(long id);\r\n    public int completedStageTwo(long id);\r\n    public int completedStageThree(long id);\r\n    public int completedStageFour(long id);\r\n\r\n    /**\r\n     * @description æŸ¥è¯¢é˜¶æ®µçŠ¶æ€\r\n     * @param id\r\n     * @return int\r\n    */\r\n    public int getStageOne(long id);\r\n    public int getStageTwo(long id);\r\n    public int getStageThree(long id);\r\n    public int getStageFour(long id);\r\n\r\n}\r\n```\r\n\r\næ¶ˆæ¯SDKæä¾›æ¶ˆæ¯å¤„ç†æŠ½è±¡ç±»ï¼Œæ­¤æŠ½è±¡ç±»ä¾›ä½¿ç”¨æ–¹å»ç»§æ‰¿ä½¿ç”¨ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\nJava\r\npackage com.xuecheng.messagesdk.service;\r\n\r\nimport com.xuecheng.messagesdk.model.po.MqMessage;\r\nimport lombok.extern.slf4j.Slf4j;\r\nimport org.springframework.beans.factory.annotation.Autowired;\r\n\r\nimport java.util.List;\r\nimport java.util.concurrent.*;\r\n\r\n/**\r\n * @description æ¶ˆæ¯å¤„ç†æŠ½è±¡ç±»\r\n */\r\n@Slf4j\r\n@Data\r\npublic abstract class MessageProcessAbstract {\r\n\r\n    @Autowired\r\n    MqMessageService mqMessageService;\r\n\r\n\r\n    /**\r\n     * @param mqMessage æ‰§è¡Œä»»åŠ¡å†…å®¹\r\n     * @return boolean true:å¤„ç†æˆåŠŸï¼Œfalseå¤„ç†å¤±è´¥\r\n     * @description ä»»åŠ¡å¤„ç†\r\n     */\r\n    public abstract boolean execute(MqMessage mqMessage);\r\n\r\n\r\n    /**\r\n     * @description æ‰«ææ¶ˆæ¯è¡¨å¤šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡\r\n     * @param shardIndex åˆ†ç‰‡åºå·\r\n     * @param shardTotal åˆ†ç‰‡æ€»æ•°\r\n     * @param messageType  æ¶ˆæ¯ç±»å‹\r\n     * @param count  ä¸€æ¬¡å–å‡ºä»»åŠ¡æ€»æ•°\r\n     * @param timeout é¢„ä¼°ä»»åŠ¡æ‰§è¡Œæ—¶é—´,åˆ°æ­¤æ—¶é—´å¦‚æœä»»åŠ¡è¿˜æ²¡æœ‰ç»“æŸåˆ™å¼ºåˆ¶ç»“æŸ å•ä½ç§’\r\n     * @return void\r\n    */\r\n    public void process(int shardIndex, int shardTotal,  String messageType,int count,long timeout) {\r\n\r\n        try {\r\n            //æ‰«ææ¶ˆæ¯è¡¨è·å–ä»»åŠ¡æ¸…å•\r\n            List<MqMessage> messageList = mqMessageService.getMessageList(shardIndex, shardTotal,messageType, count);\r\n            //ä»»åŠ¡ä¸ªæ•°\r\n            int size = messageList.size();\r\n            log.debug(\"å–å‡ºå¾…å¤„ç†æ¶ˆæ¯\"+size+\"æ¡\");\r\n            if(size<=0){\r\n                return ;\r\n            }\r\n\r\n            //åˆ›å»ºçº¿ç¨‹æ± \r\n            ExecutorService threadPool = Executors.newFixedThreadPool(size);\r\n            //è®¡æ•°å™¨\r\n            CountDownLatch countDownLatch = new CountDownLatch(size);\r\n            messageList.forEach(message -> {\r\n                threadPool.execute(() -> {\r\n                    log.debug(\"å¼€å§‹ä»»åŠ¡:{}\",message);\r\n                    //å¤„ç†ä»»åŠ¡\r\n                    try {\r\n                        boolean result = execute(message);\r\n                        if(result){\r\n                            log.debug(\"ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ:{})\",message);\r\n                            //æ›´æ–°ä»»åŠ¡çŠ¶æ€,åˆ é™¤æ¶ˆæ¯è¡¨è®°å½•,æ·»åŠ åˆ°å†å²è¡¨\r\n                            int completed = mqMessageService.completed(message.getId());\r\n                            if (completed>0){\r\n                                log.debug(\"ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ:{}\",message);\r\n                            }else{\r\n                                log.debug(\"ä»»åŠ¡æ‰§è¡Œå¤±è´¥:{}\",message);\r\n                            }\r\n                        }\r\n                    } catch (Exception e) {\r\n                        e.printStackTrace();\r\n                        log.debug(\"ä»»åŠ¡å‡ºç°å¼‚å¸¸:{},ä»»åŠ¡:{}\",e.getMessage(),message);\r\n                    }\r\n                    //è®¡æ•°\r\n                    countDownLatch.countDown();\r\n                    log.debug(\"ç»“æŸä»»åŠ¡:{}\",message);\r\n\r\n                });\r\n            });\r\n\r\n            //ç­‰å¾…,ç»™ä¸€ä¸ªå……è£•çš„è¶…æ—¶æ—¶é—´,é˜²æ­¢æ— é™ç­‰å¾…ï¼Œåˆ°è¾¾è¶…æ—¶æ—¶é—´è¿˜æ²¡æœ‰å¤„ç†å®Œæˆåˆ™ç»“æŸä»»åŠ¡\r\n            countDownLatch.await(timeout,TimeUnit.SECONDS);\r\n            System.out.println(\"ç»“æŸ....\");\r\n        } catch (InterruptedException e) {\r\n           e.printStackTrace();\r\n\r\n        }\r\n\r\n    }\r\n\r\n}\r\n```\r\n\r\n#### **3.4.2 æ¶ˆæ¯æ¨¡å—SDKæµ‹è¯•**\r\n\r\n1ã€åœ¨å†…å®¹ç®¡ç†æ•°æ®åº“åˆ›å»ºæ¶ˆæ¯è¡¨å’Œæ¶ˆæ¯å†å²è¡¨\r\n\r\n2ã€æ‹·è´è¯¾ç¨‹èµ„æ–™ä¸­çš„xuecheng-plus-message-sdkåˆ°å·¥ç¨‹ç›®å½•ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps11.jpg) \r\n\r\n3ã€ä¿®æ”¹testä¸‹çš„bootstrap.ymlä¸­çš„æ•°æ®åº“è¿æ¥\r\n\r\nä¸‹è¾¹æµ‹è¯•æ¶ˆæ¯SDKçš„æ¥å£ï¼š\r\n\r\n1ã€ç»§æ‰¿MessageProcessAbstract æŠ½è±¡ç±»ç¼–å†™ä»»åŠ¡æ‰§è¡Œæ–¹æ³•\r\n\r\n```java\r\n\r\npackage com.xuecheng.messagesdk;\r\n\r\nimport com.xuecheng.messagesdk.model.po.MqMessage;\r\nimport com.xuecheng.messagesdk.service.MessageProcessAbstract;\r\nimport com.xuecheng.messagesdk.service.MqMessageService;\r\nimport lombok.extern.slf4j.Slf4j;\r\nimport org.springframework.beans.factory.annotation.Autowired;\r\nimport org.springframework.stereotype.Component;\r\nimport org.springframework.stereotype.Service;\r\n\r\n/**\r\n * @description æ¶ˆæ¯å¤„ç†æµ‹è¯•ç±»ï¼Œç»§æ‰¿MessageProcessAbstract\r\n */\r\n@Slf4j\r\n@Component\r\npublic class MessageProcessClass extends MessageProcessAbstract {\r\n\r\n\r\n    @Autowired\r\n    MqMessageService mqMessageService;\r\n\r\n    //æ‰§è¡Œä»»åŠ¡\r\n    @Override\r\n    public boolean execute(MqMessage mqMessage) {\r\n        Long id = mqMessage.getId();\r\n        log.debug(\"å¼€å§‹æ‰§è¡Œä»»åŠ¡:{}\",id);\r\n        try {\r\n            Thread.sleep(5000);\r\n        } catch (InterruptedException e) {\r\n            throw new RuntimeException(e);\r\n        }\r\n\r\n        //å–å‡ºé˜¶æ®µçŠ¶æ€\r\n        int stageOne = mqMessageService.getStageOne(id);\r\n        if(stageOne<1){\r\n            log.debug(\"å¼€å§‹æ‰§è¡Œç¬¬ä¸€é˜¶æ®µä»»åŠ¡\");\r\n            System.out.println();\r\n            int i = mqMessageService.completedStageOne(id);\r\n            if(i>0){\r\n                log.debug(\"å®Œæˆç¬¬ä¸€é˜¶æ®µä»»åŠ¡\");\r\n            }\r\n\r\n        }else{\r\n            log.debug(\"æ— éœ€æ‰§è¡Œç¬¬ä¸€é˜¶æ®µä»»åŠ¡\");\r\n        }\r\n\r\n        return true;\r\n    }\r\n}\r\n```\r\n\r\n2ã€ç¼–å†™æµ‹è¯•ç±»\r\n\r\n```java\r\n\r\n@SpringBootTest\r\npublic class MessageProcessClassTest {\r\n\r\n    @Autowired\r\n    MessageProcessClass messageProcessClass;\r\n\r\n    @Test\r\n    public void test() {\r\n\r\n        System.out.println(\"å¼€å§‹æ‰§è¡Œ-----ã€‹\" + LocalDateTime.now());\r\n        messageProcessClass.process(0, 1, \"test\", 5, 30);\r\n        System.out.println(\"ç»“æŸæ‰§è¡Œ-----ã€‹\" + LocalDateTime.now());\r\n        Thread.sleep(9000000);\r\n    }\r\n}\r\n```\r\n\r\n3ã€å‡†å¤‡æµ‹è¯•æ•°æ®ï¼Œåœ¨æ¶ˆæ¯è¡¨æ·»åŠ æ¶ˆæ¯ç±»å‹ä¸º\"test\"çš„æ¶ˆæ¯\r\n\r\n4ã€æ‰§è¡ŒMessageProcessClassTest ç±»ä¸­çš„test()æ–¹æ³•ï¼Œè§‚å¯Ÿæ§åˆ¶å°ä»»åŠ¡æ‰§è¡Œçš„æ—¥å¿—ä¿¡æ¯ã€‚\r\n\r\n \r\n\r\n#### **3.4.3 é›†æˆæ¶ˆæ¯SDK**\r\n\r\n##### **3.4.3.1 æ·»åŠ æ¶ˆæ¯**\r\n\r\n1ã€åœ¨å†…å®¹ç®¡ç†æ•°æ®åº“åˆ›å»ºæ¶ˆæ¯è¡¨å’Œæ¶ˆæ¯å†å²è¡¨\r\n\r\n2ã€æ‹·è´è¯¾ç¨‹èµ„æ–™ä¸­çš„xuecheng-plus-message-sdkåˆ°å·¥ç¨‹ç›®å½•ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps12.jpg) \r\n\r\n3ã€åœ¨å†…å®¹ç®¡ç†serviceå·¥ç¨‹ä¸­æ·»åŠ sdkä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>com.xuecheng</groupId>\r\n    <artifactId>xuecheng-plus-message-sdk</artifactId>\r\n    <version>0.0.1-SNAPSHOT</version>\r\n</dependency>\r\n```\r\n\r\n4ã€è¯¾ç¨‹å‘å¸ƒæ“ä½œä½¿ç”¨æœ¬åœ°äº‹åŠ¡ä¿å­˜è¯¾ç¨‹å‘å¸ƒä¿¡æ¯ã€æ·»åŠ æ¶ˆæ¯è¡¨ã€‚\r\n\r\nå›åˆ°å½“åˆç¼–å†™è¯¾ç¨‹å‘å¸ƒæ—¶çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n@Transactional\r\n@Override\r\npublic void publish(Long companyId, Long courseId) {\r\n\r\n //çº¦æŸæ ¡éªŒ\r\n //æŸ¥è¯¢è¯¾ç¨‹é¢„å‘å¸ƒè¡¨\r\n CoursePublishPre coursePublishPre = coursePublishPreMapper.selectById(courseId);\r\n if(coursePublishPre == null){\r\n    XueChengPlusException.cast(\"è¯·å…ˆæäº¤è¯¾ç¨‹å®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡æ‰å¯ä»¥å‘å¸ƒ\");\r\n }\r\n //æœ¬æœºæ„åªå…è®¸æäº¤æœ¬æœºæ„çš„è¯¾ç¨‹\r\n if(!coursePublishPre.getCompanyId().equals(companyId)){\r\n  XueChengPlusException.cast(\"ä¸å…è®¸æäº¤å…¶å®ƒæœºæ„çš„è¯¾ç¨‹ã€‚\");\r\n }\r\n\r\n //è¯¾ç¨‹å®¡æ ¸çŠ¶æ€\r\n String auditStatus = coursePublishPre.getStatus();\r\n //å®¡æ ¸é€šè¿‡æ–¹å¯å‘å¸ƒ\r\n if(!\"202004\".equals(auditStatus)){\r\n  XueChengPlusException.cast(\"æ“ä½œå¤±è´¥ï¼Œè¯¾ç¨‹å®¡æ ¸é€šè¿‡æ–¹å¯å‘å¸ƒã€‚\");\r\n }\r\n //ä¿å­˜è¯¾ç¨‹å‘å¸ƒä¿¡æ¯\r\n saveCoursePublish(courseId);\r\n\r\n //ä¿å­˜æ¶ˆæ¯è¡¨\r\n saveCoursePublishMessage(courseId);\r\n\r\n//åˆ é™¤è¯¾ç¨‹é¢„å‘å¸ƒè¡¨å¯¹åº”è®°å½•\r\n coursePublishPreMapper.deleteById(courseId);\r\n\r\n}\r\n```\r\n\r\næˆ‘ä»¬è¦å¡«å……çš„saveCoursePublishMessage(courseId)æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\r\n\r\n```java\r\n\r\n /**\r\n  * @description ä¿å­˜æ¶ˆæ¯è¡¨è®°å½•\r\n  * @param courseId  è¯¾ç¨‹id\r\n  * @return void\r\n  */\r\nprivate void saveCoursePublishMessage(Long courseId){\r\n MqMessage mqMessage = mqMessageService.addMessage(\"course_publish\", String.valueOf(courseId), null, null);\r\n if(mqMessage==null){\r\n  XueChengPlusException.cast(CommonError.UNKOWN_ERROR);\r\n }\r\n}\r\n```\r\n\r\nä¸‹è¾¹è¿›è¡Œæµ‹è¯•ï¼š\r\n\r\nå‘å¸ƒä¸€é—¨è¯¾ç¨‹ï¼Œè§‚å¯Ÿæ¶ˆæ¯è¡¨æ˜¯å¦æ­£å¸¸æ·»åŠ æ¶ˆæ¯ã€‚\r\n\r\néœ€è¦æ‰‹åŠ¨ä¿®æ”¹è¯¾ç¨‹å®¡æ ¸çŠ¶æ€ä¸ºå®¡æ ¸é€šè¿‡æ‰§è¡Œå‘å¸ƒæ“ä½œï¼Œå‘å¸ƒåå¯ä»¥ä¿®æ”¹å‘å¸ƒçŠ¶æ€ä¸ºä¸‹æ¶é‡æ–°å‘å¸ƒæµ‹è¯•ã€‚\r\n\r\n##### **3.4.3.2 è¯¾ç¨‹å‘å¸ƒä»»åŠ¡å¤„ç†**\r\n\r\nåœ¨å†…å®¹ç®¡ç†æœåŠ¡æ·»åŠ æ¶ˆæ¯å¤„ç†sdkçš„ä¾èµ–å³å¯ä½¿ç”¨å®ƒï¼Œå®ç°sdkä¸­çš„MessageProcessAbstractç±»ï¼Œé‡å†™execteæ–¹æ³•ã€‚\r\n\r\nå®ç°sdkä¸­çš„MessageProcessAbstractç±»ï¼š\r\n\r\n```java\r\n\r\n@Slf4j\r\n@Component\r\npublic class CoursePublishTask extends MessageProcessAbstract {\r\n\r\n    //è¯¾ç¨‹å‘å¸ƒä»»åŠ¡å¤„ç†\r\n    @Override\r\n    public boolean execute(MqMessage mqMessage) {\r\n        //è·å–æ¶ˆæ¯ç›¸å…³çš„ä¸šåŠ¡ä¿¡æ¯\r\n        String businessKey1 = mqMessage.getBusinessKey1();\r\n        long courseId = Integer.parseInt(businessKey1);\r\n        //è¯¾ç¨‹é™æ€åŒ–\r\n        generateCourseHtml(mqMessage,courseId);\r\n        //è¯¾ç¨‹ç´¢å¼•\r\n        saveCourseIndex(mqMessage,courseId);\r\n        //è¯¾ç¨‹ç¼“å­˜\r\n        saveCourseCache(mqMessage,courseId);\r\n        return true;\r\n    }\r\n\r\n\r\n    //ç”Ÿæˆè¯¾ç¨‹é™æ€åŒ–é¡µé¢å¹¶ä¸Šä¼ è‡³æ–‡ä»¶ç³»ç»Ÿ\r\n    public void generateCourseHtml(MqMessage mqMessage,long courseId){\r\n\r\n        log.debug(\"å¼€å§‹è¿›è¡Œè¯¾ç¨‹é™æ€åŒ–,è¯¾ç¨‹id:{}\",courseId);\r\n        //æ¶ˆæ¯id\r\n        Long id = mqMessage.getId();\r\n        //æ¶ˆæ¯å¤„ç†çš„service\r\n        MqMessageService mqMessageService = this.getMqMessageService();\r\n        //æ¶ˆæ¯å¹‚ç­‰æ€§å¤„ç†\r\n        int stageOne = mqMessageService.getStageOne(id);\r\n        if(stageOne >0){\r\n            log.debug(\"è¯¾ç¨‹é™æ€åŒ–å·²å¤„ç†ç›´æ¥è¿”å›ï¼Œè¯¾ç¨‹id:{}\",courseId);\r\n            return ;\r\n        }\r\n        try {\r\n            TimeUnit.SECONDS.sleep(10);\r\n        } catch (InterruptedException e) {\r\n            throw new RuntimeException(e);\r\n        }\r\n        //ä¿å­˜ç¬¬ä¸€é˜¶æ®µçŠ¶æ€\r\n        mqMessageService.completedStageOne(id);\r\n\r\n    }\r\n\r\n    //å°†è¯¾ç¨‹ä¿¡æ¯ç¼“å­˜è‡³redis\r\n    public void saveCourseCache(MqMessage mqMessage,long courseId){\r\n        log.debug(\"å°†è¯¾ç¨‹ä¿¡æ¯ç¼“å­˜è‡³redis,è¯¾ç¨‹id:{}\",courseId);\r\n        try {\r\n            TimeUnit.SECONDS.sleep(2);\r\n        } catch (InterruptedException e) {\r\n            throw new RuntimeException(e);\r\n        }\r\n\r\n\r\n    }\r\n    //ä¿å­˜è¯¾ç¨‹ç´¢å¼•ä¿¡æ¯\r\n    public void saveCourseIndex(MqMessage mqMessage,long courseId){\r\n        log.debug(\"ä¿å­˜è¯¾ç¨‹ç´¢å¼•ä¿¡æ¯,è¯¾ç¨‹id:{}\",courseId);\r\n        try {\r\n            TimeUnit.SECONDS.sleep(2);\r\n        } catch (InterruptedException e) {\r\n            throw new RuntimeException(e);\r\n        }\r\n\r\n    }\r\n\r\n}\r\n```\r\n\r\n##### **3.4.3.3 å¼€å¯ä»»åŠ¡è°ƒåº¦**\r\n\r\n1ã€é¦–å…ˆåœ¨å†…å®¹ç®¡ç†serviceå·¥ç¨‹ä¸­æ·»åŠ xxl-jobä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>com.xuxueli</groupId>\r\n    <artifactId>xxl-job-core</artifactId>\r\n</dependency>\r\n```\r\n\r\n2ã€é…ç½®æ‰§è¡Œå™¨\r\n\r\nåœ¨nacosä¸­åœ¨content-service-dev.yamlä¸­é…ç½®\r\n\r\n```yaml\r\n\r\nxxl:\r\n  job:\r\n    admin: \r\n      addresses: http://192.168.2.203:8088/xxl-job-admin\r\n    executor:\r\n      appname: coursepublish-job\r\n      address: \r\n      ip: \r\n      port: 8999\r\n      logpath: /data/applogs/xxl-job/jobhandler\r\n      logretentiondays: 30\r\n    accessToken: default_token\r\n```\r\n\r\n3ã€ä»åª’èµ„ç®¡ç†æœåŠ¡å±‚å·¥ç¨‹ä¸­æ‹·è´ä¸€ä¸ªXxlJobConfigé…ç½®ç±»åˆ°å†…å®¹ç®¡ç†serviceå·¥ç¨‹ä¸­ã€‚\r\n\r\n \r\n\r\nåœ¨xxl-job-adminæ§åˆ¶å°ä¸­æ·»åŠ æ‰§è¡Œå™¨\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps13.jpg) \r\n\r\n \r\n\r\n3ã€ç¼–å†™ä»»åŠ¡è°ƒåº¦å…¥å£\r\n\r\n```java\r\n\r\n@Slf4j\r\n@Component\r\npublic class CoursePublishTask extends MessageProcessAbstract {\r\n\r\n    //ä»»åŠ¡è°ƒåº¦å…¥å£\r\n    @XxlJob(\"CoursePublishJobHandler\")\r\n    public void coursePublishJobHandler() throws Exception {\r\n        // åˆ†ç‰‡å‚æ•°\r\n        int shardIndex = XxlJobHelper.getShardIndex();\r\n        int shardTotal = XxlJobHelper.getShardTotal();\r\n        log.debug(\"shardIndex=\"+shardIndex+\",shardTotal=\"+shardTotal);\r\n        //å‚æ•°:åˆ†ç‰‡åºå·ã€åˆ†ç‰‡æ€»æ•°ã€æ¶ˆæ¯ç±»å‹ã€ä¸€æ¬¡æœ€å¤šå–åˆ°çš„ä»»åŠ¡æ•°é‡ã€ä¸€æ¬¡ä»»åŠ¡è°ƒåº¦æ‰§è¡Œçš„è¶…æ—¶æ—¶é—´\r\n        process(shardIndex,shardTotal,\"course_publish\",30,60);\r\n    }\r\n    ....\r\n```\r\n\r\n4ã€åœ¨xxl-jobæ·»åŠ ä»»åŠ¡\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps14.jpg) \r\n\r\nä»»åŠ¡é…ç½®å¦‚ä¸‹ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps15.jpg) \r\n\r\nåˆ°æ­¤SDKå¼€å‘ã€é›†æˆå®Œæˆï¼Œä¸‹ä¸€æ­¥æ·»åŠ è¯¾ç¨‹å‘å¸ƒåé¡µé¢é™æ€åŒ–ã€è¯¾ç¨‹ç¼“å­˜ã€è¯¾ç¨‹ç´¢å¼•ç­‰ä»»åŠ¡ã€‚\r\n\r\n##### **3.4.3.4 æµ‹è¯•**\r\n\r\nåœ¨æ¶ˆæ¯è¡¨æ·»åŠ è¯¾ç¨‹å‘å¸ƒçš„æ¶ˆæ¯ï¼Œæ¶ˆæ¯ç±»å‹ä¸ºcourse_publish,business_key1ä¸ºå‘å¸ƒè¯¾ç¨‹çš„ID\r\n\r\n1ã€æµ‹è¯•æ˜¯å¦å¯ä»¥æ­£å¸¸è°ƒåº¦æ‰§è¡Œã€‚\r\n\r\n2ã€æµ‹è¯•ä»»åŠ¡å¹‚ç­‰æ€§\r\n\r\nåœ¨ saveCourseCache(mqMessage,courseId);å¤„æ‰“æ–­ç‚¹ï¼Œå¾…æ‰§è¡Œåˆ°è¿™é‡Œè§‚å¯Ÿæ•°æ®åº“ç¬¬ä¸€é˜¶æ®µå®Œæˆçš„æ ‡è®°é¢„æœŸæ ‡è®°ä¸º1ã€‚\r\n\r\nç»“æŸè¿›ç¨‹ï¼Œå†é‡æ–°å¯åŠ¨ï¼Œè§‚å¯Ÿç¬¬ä¸€é˜¶æ®µçš„ä»»åŠ¡é¢„æœŸä¸å†æ‰§è¡Œã€‚\r\n\r\n3ã€ä»»åŠ¡æ‰§è¡Œå®Œæˆåˆ é™¤æ¶ˆæ¯è¡¨è®°å½•ï¼Œæ’å…¥å†å²è¡¨ï¼ŒstateçŠ¶æ€å­—æ®µä¸º1\r\n\r\n \r\n\r\n### **3.5 é¡µé¢é™æ€åŒ–**\r\n\r\n#### **3.5.1 ä»€ä¹ˆæ˜¯é¡µé¢é™æ€åŒ–**\r\n\r\næ ¹æ®è¯¾ç¨‹å‘å¸ƒçš„æ“ä½œæµç¨‹ï¼Œæ‰§è¡Œè¯¾ç¨‹å‘å¸ƒåè¦å°†è¯¾ç¨‹è¯¦æƒ…ä¿¡æ¯é¡µé¢é™æ€åŒ–ï¼Œç”Ÿæˆhtmlé¡µé¢ä¸Šä¼ è‡³æ–‡ä»¶ç³»ç»Ÿã€‚\r\n\r\nä»€ä¹ˆæ˜¯é¡µé¢é™æ€åŒ–ï¼Ÿ\r\n\r\nè¯¾ç¨‹é¢„è§ˆåŠŸèƒ½é€šè¿‡æ¨¡æ¿å¼•æ“æŠ€æœ¯åœ¨é¡µé¢æ¨¡æ¿ä¸­å¡«å……æ•°æ®ï¼Œç”Ÿæˆhtmlé¡µé¢ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å½“å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨æ—¶æœåŠ¡å™¨æ‰å¼€å§‹æ¸²æŸ“ç”Ÿæˆhtmlé¡µé¢ï¼Œæœ€åå“åº”ç»™æµè§ˆå™¨ï¼ŒæœåŠ¡ç«¯æ¸²æŸ“çš„å¹¶å‘èƒ½åŠ›æ˜¯æœ‰é™çš„ã€‚\r\n\r\né¡µé¢é™æ€åŒ–åˆ™å¼ºè°ƒå°†ç”Ÿæˆhtmlé¡µé¢çš„è¿‡ç¨‹æå‰ï¼Œæå‰ä½¿ç”¨æ¨¡æ¿å¼•æ“æŠ€æœ¯ç”Ÿæˆhtmlé¡µé¢ï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚æ—¶ç›´æ¥è¯·æ±‚htmlé¡µé¢ï¼Œç”±äºæ˜¯é™æ€é¡µé¢å¯ä»¥ä½¿ç”¨nginxã€apacheç­‰é«˜æ€§èƒ½çš„webæœåŠ¡å™¨ï¼Œå¹¶å‘æ€§èƒ½é«˜ã€‚\r\n\r\nä»€ä¹ˆæ—¶å€™èƒ½ç”¨é¡µé¢é™æ€åŒ–æŠ€æœ¯ï¼Ÿ\r\n\r\nå½“æ•°æ®å˜åŒ–ä¸é¢‘ç¹ï¼Œä¸€æ—¦ç”Ÿæˆé™æ€é¡µé¢å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…å¾ˆå°‘å˜åŒ–ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨é¡µé¢é™æ€åŒ–ã€‚å› ä¸ºå¦‚æœæ•°æ®å˜åŒ–é¢‘ç¹ï¼Œä¸€æ—¦æ”¹å˜å°±éœ€è¦é‡æ–°ç”Ÿæˆé™æ€é¡µé¢ï¼Œå¯¼è‡´ç»´æŠ¤é™æ€é¡µé¢çš„å·¥ä½œé‡å¾ˆå¤§ã€‚\r\n\r\næ ¹æ®è¯¾ç¨‹å‘å¸ƒçš„ä¸šåŠ¡éœ€æ±‚ï¼Œè™½ç„¶è¯¾ç¨‹å‘å¸ƒåä»å¯ä»¥ä¿®æ”¹è¯¾ç¨‹ä¿¡æ¯ï¼Œä½†éœ€è¦ç»è¿‡è¯¾ç¨‹å®¡æ ¸ï¼Œä¸”ä¿®æ”¹é¢‘åº¦ä¸å¤§ï¼Œæ‰€ä»¥é€‚åˆä½¿ç”¨é¡µé¢é™æ€åŒ–ã€‚\r\n\r\n \r\n\r\n#### **3.5.2 é™æ€åŒ–æµ‹è¯•**\r\n\r\nä¸‹è¾¹ä½¿ç”¨freemarkeræŠ€æœ¯å¯¹é¡µé¢é™æ€åŒ–ç”Ÿæˆhtmlé¡µé¢ã€‚\r\n\r\nåœ¨å†…å®¹ç®¡ç†serviceå·¥ç¨‹ä¸­æ·»åŠ freemarkerä¾èµ–\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>org.springframework.boot</groupId>\r\n    <artifactId>spring-boot-starter-freemarker</artifactId>\r\n</dependency>\r\n```\r\n\r\nç¼–å†™æµ‹è¯•æ–¹æ³•\r\n\r\n```java\r\n\r\n@SpringBootTest\r\npublic class FreemarkerTest {\r\n\r\n    @Autowired\r\n    CoursePublishService coursePublishService;\r\n\r\n\r\n    //æµ‹è¯•é¡µé¢é™æ€åŒ–\r\n    @Test\r\n    public void testGenerateHtmlByTemplate() throws IOException, TemplateException {\r\n        //é…ç½®freemarker\r\n        Configuration configuration = new Configuration(Configuration.getVersion());\r\n\r\n        //åŠ è½½æ¨¡æ¿\r\n        //é€‰æŒ‡å®šæ¨¡æ¿è·¯å¾„,classpathä¸‹templatesä¸‹\r\n        //å¾—åˆ°classpathè·¯å¾„\r\n        String classpath = this.getClass().getResource(\"/\").getPath();\r\n        configuration.setDirectoryForTemplateLoading(new File(classpath + \"/templates/\"));\r\n        //è®¾ç½®å­—ç¬¦ç¼–ç \r\n        configuration.setDefaultEncoding(\"utf-8\");\r\n\r\n        //æŒ‡å®šæ¨¡æ¿æ–‡ä»¶åç§°\r\n        Template template = configuration.getTemplate(\"course_template.ftl\");\r\n\r\n        //å‡†å¤‡æ•°æ®\r\n        CoursePreviewDto coursePreviewInfo = coursePublishService.getCoursePreviewInfo(2L);\r\n\r\n        Map<String, Object> map = new HashMap<>();\r\n        map.put(\"model\", coursePreviewInfo);\r\n\r\n        //é™æ€åŒ–\r\n        //å‚æ•°1ï¼šæ¨¡æ¿ï¼Œå‚æ•°2ï¼šæ•°æ®æ¨¡å‹\r\n        String content = FreeMarkerTemplateUtils.processTemplateIntoString(template, map);\r\n        System.out.println(content);\r\n        //å°†é™æ€åŒ–å†…å®¹è¾“å‡ºåˆ°æ–‡ä»¶ä¸­\r\n        InputStream inputStream = IOUtils.toInputStream(content);\r\n        //è¾“å‡ºæµ\r\n        FileOutputStream outputStream = new FileOutputStream(\"D:\\\\develop\\\\test.html\");\r\n        IOUtils.copy(inputStream, outputStream);\r\n\r\n    }\r\n\r\n}\r\n```\r\n\r\nå°†content-apiå·¥ç¨‹ä¸‹çš„æ¨¡æ¿æ‹·è´åˆ°content-serviceå·¥ç¨‹ä¸‹ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps16.jpg) \r\n\r\n \r\n\r\næ‰§è¡Œæµ‹è¯•æ–¹æ³•ï¼Œè§‚å¯ŸD:\\\\develop\\\\test.html æ˜¯å¦æˆåŠŸç”Ÿæˆã€‚\r\n\r\n \r\n\r\n#### **3.5.3 ä¸Šä¼ æ–‡ä»¶æµ‹è¯•**\r\n\r\n##### **3.5.3.1 é…ç½®è¿œç¨‹è°ƒç”¨ç¯å¢ƒ**\r\n\r\né™æ€åŒ–ç”Ÿæˆæ–‡ä»¶åéœ€è¦ä¸Šä¼ è‡³åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œæ ¹æ®å¾®æœåŠ¡çš„èŒè´£åˆ’åˆ†ï¼Œåª’èµ„ç®¡ç†æœåŠ¡è´Ÿè´£ç»´æŠ¤æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ï¼Œæ‰€ä»¥å†…å®¹ç®¡ç†æœåŠ¡å¯¹é¡µé¢é™æ€åŒ–ç”Ÿæˆhtmlæ–‡ä»¶éœ€è¦è°ƒç”¨åª’èµ„ç®¡ç†æœåŠ¡çš„ä¸Šä¼ æ–‡ä»¶æ¥å£ã€‚å¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps17.jpg) \r\n\r\nå¾®æœåŠ¡ä¹‹é—´éš¾å…ä¼šå­˜åœ¨è¿œç¨‹è°ƒç”¨ï¼Œåœ¨Spring Cloudä¸­å¯ä»¥ä½¿ç”¨Feignè¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œ\r\n\r\nFeignæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„httpå®¢æˆ·ç«¯ï¼Œå®˜æ–¹åœ°å€ï¼šhttps://github.com/OpenFeign/feign\r\n\r\nå…¶ä½œç”¨å°±æ˜¯å¸®åŠ©æˆ‘ä»¬ä¼˜é›…çš„å®ç°httpè¯·æ±‚çš„å‘é€ï¼Œè§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚\r\n\r\nä¸‹è¾¹å…ˆå‡†å¤‡Feignçš„å¼€å‘ç¯å¢ƒ:\r\n\r\n1ã€åœ¨å†…å®¹ç®¡ç†content-serviceå·¥ç¨‹æ·»åŠ ä¾èµ–ï¼š\r\n\r\n```xml\r\n\r\n<dependency>\r\n    <groupId>com.alibaba.cloud</groupId>\r\n    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\r\n</dependency>\r\n<!-- Spring Cloud å¾®æœåŠ¡è¿œç¨‹è°ƒç”¨ -->\r\n<dependency>\r\n    <groupId>org.springframework.cloud</groupId>\r\n    <artifactId>spring-cloud-starter-openfeign</artifactId>\r\n</dependency>\r\n<dependency>\r\n    <groupId>io.github.openfeign</groupId>\r\n    <artifactId>feign-httpclient</artifactId>\r\n</dependency>\r\n<!--feignæ”¯æŒMultipartæ ¼å¼ä¼ å‚-->\r\n<dependency>\r\n    <groupId>io.github.openfeign.form</groupId>\r\n    <artifactId>feign-form</artifactId>\r\n    <version>3.8.0</version>\r\n</dependency>\r\n<dependency>\r\n    <groupId>io.github.openfeign.form</groupId>\r\n    <artifactId>feign-form-spring</artifactId>\r\n    <version>3.8.0</version>\r\n</dependency>\r\n```\r\n\r\n2ã€åœ¨nacosé…ç½®feign-dev.yamlå…¬ç”¨é…ç½®æ–‡ä»¶\r\n\r\n```yaml\r\n\r\nfeign:\r\n  hystrix:\r\n    enabled: true\r\n  circuitbreaker:\r\n    enabled: true\r\nhystrix:\r\n  command:\r\n    default:\r\n      execution:\r\n        isolation:\r\n          thread:\r\n            timeoutInMilliseconds: 30000  #ç†”æ–­è¶…æ—¶æ—¶é—´\r\nribbon:\r\n  ConnectTimeout: 60000 #è¿æ¥è¶…æ—¶æ—¶é—´\r\n  ReadTimeout: 60000 #è¯»è¶…æ—¶æ—¶é—´\r\n  MaxAutoRetries: 0 #é‡è¯•æ¬¡æ•°\r\n  MaxAutoRetriesNextServer: 1 #åˆ‡æ¢å®ä¾‹çš„é‡è¯•æ¬¡æ•°\r\n\r\n```\r\n\r\n3ã€åœ¨å†…å®¹ç®¡ç†serviceå·¥ç¨‹å’Œå†…å®¹ç®¡ç†apiå·¥ç¨‹éƒ½å¼•å…¥æ­¤é…ç½®æ–‡ä»¶\r\n\r\n```yaml\r\n\r\nshared-configs:\r\n  - data-id: feign-${spring.profiles.active}.yaml\r\n    group: xuecheng-plus-common\r\n    refresh: true\r\n```\r\n\r\n4ã€åœ¨å†…å®¹ç®¡ç†serviceå·¥ç¨‹é…ç½®feignæ”¯æŒMultipartï¼Œæ‹·è´è¯¾ç¨‹èµ„æ–™ä¸‹çš„MultipartSupportConfig åˆ°content-serviceå·¥ç¨‹ä¸‹çš„configåŒ…ä¸‹ã€‚\r\n\r\n \r\n\r\n##### **3.5.3.2 æ‰©å……ä¸Šä¼ æ–‡ä»¶æ¥å£**\r\n\r\nç°åœ¨éœ€è¦å°†è¯¾ç¨‹çš„é™æ€æ–‡ä»¶ä¸Šä¼ åˆ°minioï¼Œå•ç‹¬å­˜å‚¨åˆ°courseç›®å½•ä¸‹ï¼Œæ–‡ä»¶çš„objectnameä¸º\"è¯¾ç¨‹id.html\"ï¼ŒåŸæœ‰çš„ä¸Šä¼ æ–‡ä»¶æ¥å£éœ€è¦å¢åŠ ä¸€ä¸ªå‚æ•° objectnameã€‚\r\n\r\nä¸‹è¾¹æ‰©å……åª’èµ„æœåŠ¡çš„ä¸Šä¼ æ–‡ä»¶æ¥å£\r\n\r\n```java\r\n\r\n@ApiOperation(\"ä¸Šä¼ æ–‡ä»¶\")\r\n@RequestMapping(value = \"/upload/coursefile\",consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\r\npublic UploadFileResultDto upload(@RequestPart(\"filedata\") MultipartFile filedata,\r\n                                  @RequestParam(value= \"objectName\",required=false) String objectName) throws IOException{\r\n                                  //....\r\n }\r\n```\r\n\r\nserviceæ¥å£ä¹Ÿå¢åŠ ä¸€ä¸ªå‚æ•°ï¼š\r\n\r\n```java\r\n\r\n/**\r\n * ä¸Šä¼ æ–‡ä»¶\r\n * @param companyId æœºæ„id\r\n * @param uploadFileParamsDto ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯\r\n * @param localFilePath æ–‡ä»¶ç£ç›˜è·¯å¾„\r\n * @param objectName å¯¹è±¡å\r\n * @return æ–‡ä»¶ä¿¡æ¯\r\n */\r\npublic UploadFileResultDto uploadFile(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath,String objectName);\r\n```\r\n\r\nä¿®æ”¹åŸæœ‰uploadFileæ–¹æ³•ï¼Œåˆ¤æ–­å¦‚æœobjectNameä¸ºç©ºåˆ™é‡‡å–å¹´æœˆæ—¥æ ·å¼çš„è·¯å¾„æ–¹å¼ã€‚\r\n\r\n```java\r\n\r\n//å­˜å‚¨åˆ°minioä¸­çš„å¯¹è±¡å(å¸¦ç›®å½•)\r\nif(StringUtils.isEmpty(objectName)){\r\n    objectName =  defaultFolderPath + fileMd5 + extension;\r\n}\r\n//        String objectName = defaultFolderPath + fileMd5 + extension;\r\n```\r\n\r\n##### **3.5.3.3 è¿œç¨‹è°ƒç”¨æµ‹è¯•**\r\n\r\nåœ¨content-serviceä¸‹ç¼–å†™feignæ¥å£\r\n\r\n```java\r\n\r\n\r\n/**\r\n * @description åª’èµ„ç®¡ç†æœåŠ¡è¿œç¨‹æ¥å£\r\n */\r\n @FeignClient(value = \"media-api\",configuration = MultipartSupportConfig.class)\r\npublic interface MediaServiceClient {\r\n\r\n @RequestMapping(value = \"/media/upload/coursefile\",consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\r\n String uploadFile(@RequestPart(\"filedata\") MultipartFile upload,@RequestParam(value = \"objectName\",required=false) String objectName);\r\n}\r\n```\r\n\r\nåœ¨å¯åŠ¨ç±»æ·»åŠ @EnableFeignClientsæ³¨è§£\r\n\r\n`@EnableFeignClients(basePackages={\"com.xuecheng.content.feignclient\"})`\r\n\r\nç¼–å†™æµ‹è¯•æ–¹æ³•\r\n\r\n```java\r\n\r\n\r\n/**\r\n * @description æµ‹è¯•ä½¿ç”¨feignè¿œç¨‹ä¸Šä¼ æ–‡ä»¶\r\n */\r\n@SpringBootTest\r\npublic class FeignUploadTest {\r\n\r\n    @Autowired\r\n    MediaServiceClient mediaServiceClient;\r\n\r\n    //è¿œç¨‹è°ƒç”¨ï¼Œä¸Šä¼ æ–‡ä»¶\r\n    @Test\r\n    public void test() {\r\n    \r\n        MultipartFile multipartFile = MultipartSupportConfig.getMultipartFile(new File(\"D:\\\\develop\\\\test.html\"));\r\n        mediaServiceClient.uploadFile(multipartFile,\"course\",\"test.html\");\r\n    }\r\n\r\n}\r\n```\r\n\r\nä¸‹è¾¹è¿›è¡Œæµ‹è¯•ï¼Œå¯åŠ¨åª’èµ„æœåŠ¡ï¼Œæ‰§è¡Œæµ‹è¯•æ–¹æ³•ï¼Œä¸Šä¼ æ–‡ä»¶æˆåŠŸï¼Œè¿›å…¥minIOæŸ¥çœ‹æ–‡ä»¶\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps18.jpg) \r\n\r\nè®¿é—®ï¼š`http://192.168.101.65:9000/mediafiles/course/74b386417bb9f3764009dc94068a5e44.html`\r\n\r\næŸ¥çœ‹æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®ã€‚\r\n\r\n\r\n\r\n#### **3.5.4 è¯¾ç¨‹é™æ€åŒ–å¼€å‘**\r\n\r\nè¯¾ç¨‹é¡µé¢é™æ€åŒ–å’Œé™æ€é¡µé¢è¿œç¨‹ä¸Šä¼ æµ‹è¯•é€šè¿‡ï¼Œä¸‹ä¸€æ­¥å¼€å‘è¯¾ç¨‹é™æ€åŒ–åŠŸèƒ½ï¼Œæœ€ç»ˆä½¿ç”¨æ¶ˆæ¯å¤„ç†SDKå»è°ƒåº¦æ‰§è¡Œã€‚\r\n\r\n \r\n\r\n##### **3.5.4.1 é™æ€åŒ–å®ç°**\r\n\r\nè¯¾ç¨‹é™æ€åŒ–åŒ…æ‹¬ä¸¤éƒ¨åˆ†å·¥ä½œï¼šç”Ÿæˆè¯¾ç¨‹é™æ€åŒ–é¡µé¢ï¼Œä¸Šä¼ é™æ€é¡µé¢åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚\r\n\r\nåœ¨è¯¾ç¨‹å‘å¸ƒçš„serviceç¼–å†™è¿™ä¸¤éƒ¨åˆ†å†…å®¹ï¼Œæœ€åé€šè¿‡æ¶ˆæ¯å»è°ƒåº¦æ‰§è¡Œã€‚\r\n\r\n1ã€æ¥å£å®šä¹‰\r\n\r\n```java\r\n\r\n/**\r\n * @description è¯¾ç¨‹é™æ€åŒ–\r\n * @param courseId  è¯¾ç¨‹id\r\n * @return File é™æ€åŒ–æ–‡ä»¶\r\n*/\r\npublic File generateCourseHtml(Long courseId);\r\n/**\r\n * @description ä¸Šä¼ è¯¾ç¨‹é™æ€åŒ–é¡µé¢\r\n * @param file  é™æ€åŒ–æ–‡ä»¶\r\n * @return void\r\n*/\r\npublic void  uploadCourseHtml(Long courseId,File file);\r\n```\r\n\r\n2ã€æ¥å£å®ç°\r\n\r\nå°†ä¹‹å‰ç¼–å†™çš„é™æ€åŒ–æµ‹è¯•ä»£ç ä»¥åŠä¸Šä¼ é™æ€æ–‡ä»¶æµ‹è¯•ä»£ç æ‹·è´è¿‡æ¥ä½¿ç”¨\r\n\r\n```java\r\n\r\n\t@Override\r\n    public File generateCourseHtml(Long courseId) {\r\n\r\n        //é™æ€åŒ–æ–‡ä»¶\r\n        File htmlFile  = null;\r\n\r\n        try {\r\n            //é…ç½®freemarker\r\n            Configuration configuration = new Configuration(Configuration.getVersion());\r\n\r\n            //åŠ è½½æ¨¡æ¿\r\n            //é€‰æŒ‡å®šæ¨¡æ¿è·¯å¾„,classpathä¸‹templatesä¸‹\r\n            //å¾—åˆ°classpathè·¯å¾„\r\n            String classpath = this.getClass().getResource(\"/\").getPath();\r\n            configuration.setDirectoryForTemplateLoading(new File(classpath + \"/templates/\"));\r\n            //è®¾ç½®å­—ç¬¦ç¼–ç \r\n            configuration.setDefaultEncoding(\"utf-8\");\r\n\r\n            //æŒ‡å®šæ¨¡æ¿æ–‡ä»¶åç§°\r\n            Template template = configuration.getTemplate(\"course_template.ftl\");\r\n\r\n            //å‡†å¤‡æ•°æ®\r\n            CoursePreviewDto coursePreviewInfo = this.getCoursePreviewInfo(courseId);\r\n\r\n            Map<String, Object> map = new HashMap<>();\r\n            map.put(\"model\", coursePreviewInfo);\r\n\r\n            //é™æ€åŒ–\r\n            //å‚æ•°1ï¼šæ¨¡æ¿ï¼Œå‚æ•°2ï¼šæ•°æ®æ¨¡å‹\r\n            String content = FreeMarkerTemplateUtils.processTemplateIntoString(template, map);\r\n//            System.out.println(content);\r\n            //å°†é™æ€åŒ–å†…å®¹è¾“å‡ºåˆ°æ–‡ä»¶ä¸­\r\n            InputStream inputStream = IOUtils.toInputStream(content);\r\n            //åˆ›å»ºé™æ€åŒ–æ–‡ä»¶\r\n            htmlFile = File.createTempFile(\"course\",\".html\");\r\n            log.debug(\"è¯¾ç¨‹é™æ€åŒ–ï¼Œç”Ÿæˆé™æ€æ–‡ä»¶:{}\",htmlFile.getAbsolutePath());\r\n            //è¾“å‡ºæµ\r\n            FileOutputStream outputStream = new FileOutputStream(htmlFile);\r\n            IOUtils.copy(inputStream, outputStream);\r\n        } catch (Exception e) {\r\n            log.error(\"è¯¾ç¨‹é™æ€åŒ–å¼‚å¸¸:{}\",e.toString());\r\n            XueChengPlusException.cast(\"è¯¾ç¨‹é™æ€åŒ–å¼‚å¸¸\");\r\n        }\r\n\r\n        return htmlFile;\r\n    }\r\n\r\n    @Override\r\n    public void uploadCourseHtml(Long courseId, File file) {\r\n        MultipartFile multipartFile = MultipartSupportConfig.getMultipartFile(file);\r\n        String course = mediaServiceClient.uploadFile(multipartFile, \"course/\"+courseId+\".html\");\r\n        if(course==null){\r\n            XueChengPlusException.cast(\"ä¸Šä¼ é™æ€æ–‡ä»¶å¼‚å¸¸\");\r\n        }\r\n    }\r\n```\r\n\r\nå®Œå–„è¯¾ç¨‹å‘å¸ƒä»»åŠ¡CoursePublishTaskç±»çš„ä»£ç ï¼š\r\n\r\n```java\r\nJava\r\n//ç”Ÿæˆè¯¾ç¨‹é™æ€åŒ–é¡µé¢å¹¶ä¸Šä¼ è‡³æ–‡ä»¶ç³»ç»Ÿ\r\npublic void generateCourseHtml(MqMessage mqMessage,long courseId){\r\n    log.debug(\"å¼€å§‹è¿›è¡Œè¯¾ç¨‹é™æ€åŒ–,è¯¾ç¨‹id:{}\",courseId);\r\n    //æ¶ˆæ¯id\r\n    Long id = mqMessage.getId();\r\n    //æ¶ˆæ¯å¤„ç†çš„service\r\n    MqMessageService mqMessageService = this.getMqMessageService();\r\n    //æ¶ˆæ¯å¹‚ç­‰æ€§å¤„ç†\r\n    int stageOne = mqMessageService.getStageOne(id);\r\n    if(stageOne == 1){\r\n        log.debug(\"è¯¾ç¨‹é™æ€åŒ–å·²å¤„ç†ç›´æ¥è¿”å›ï¼Œè¯¾ç¨‹id:{}\",courseId);\r\n        return ;\r\n    }\r\n\r\n    //ç”Ÿæˆé™æ€åŒ–é¡µé¢\r\n    File file = coursePublishService.generateCourseHtml(courseId);\r\n    //ä¸Šä¼ é™æ€åŒ–é¡µé¢\r\n    if(file!=null){\r\n        coursePublishService.uploadCourseHtml(courseId,file);\r\n    }\r\n    //ä¿å­˜ç¬¬ä¸€é˜¶æ®µçŠ¶æ€\r\n    mqMessageService.completedStageOne(id);\r\n\r\n}\r\n```\r\n\r\n##### **3.5.4.2 æµ‹è¯•**\r\n\r\n1ã€å¯åŠ¨ç½‘å…³ã€åª’èµ„ç®¡ç†æœåŠ¡å·¥ç¨‹ã€‚\r\n\r\n2ã€åœ¨å†…å®¹ç®¡ç†apiå·¥ç¨‹çš„å¯åŠ¨ç±»ä¸Šé…ç½®FeignClient\r\n\r\n `@EnableFeignClients(basePackages={\"com.xuecheng.content.feignclient\"})`\r\n\r\nåœ¨bootstrap.ymlå¼•ç”¨feign-dev.yaml\r\n\r\n```yaml\r\n\r\n- data-id: feign-${spring.profiles.active}.yaml\r\n  group: xuecheng-plus-common\r\n  refresh: true  #profilesé»˜è®¤ä¸ºdev\r\n```\r\n\r\nå¯åŠ¨å†…å®¹ç®¡ç†æ¥å£å·¥ç¨‹ã€‚\r\n\r\nåœ¨CoursePublishTaskç±»çš„executeæ–¹æ³•ä¸­æ‰“ä¸Šæ–­ç‚¹ã€‚\r\n\r\n \r\n\r\n3ã€å‘å¸ƒä¸€é—¨è¯¾ç¨‹ï¼Œä¿å­˜æ¶ˆæ¯è¡¨å­˜åœ¨æœªå¤„ç†çš„å¤„ç†ã€‚\r\n\r\n \r\n\r\n4ã€å¯åŠ¨xxl-jobè°ƒåº¦ä¸­å¿ƒã€å¯åŠ¨è¯¾ç¨‹å‘å¸ƒä»»åŠ¡ï¼Œç­‰å¾…å®šæ—¶è°ƒåº¦ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps19.jpg) \r\n\r\n \r\n\r\n \r\n\r\n5ã€è§‚å¯Ÿä»»åŠ¡è°ƒåº¦æ—¥å¿—ï¼Œè§‚å¯Ÿä»»åŠ¡æ˜¯å¦å¯ä»¥æ­£å¸¸å¤„ç†ã€‚\r\n\r\n6ã€å¤„ç†å®Œæˆè¿›å…¥æ–‡ä»¶ç³»ç»Ÿï¼ŒæŸ¥è¯¢mediafilesæ¡¶å†…æ˜¯å¦å­˜åœ¨ä»¥è¯¾ç¨‹idå‘½åçš„htmlæ–‡ä»¶\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps20.jpg) \r\n\r\nå¦‚æœä¸å­˜åœ¨è¯´æ˜è¯¾ç¨‹é™æ€åŒ–å­˜åœ¨é—®é¢˜ï¼Œå†ä»”ç»†æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—ï¼Œæ’æŸ¥é—®é¢˜ã€‚\r\n\r\nå¦‚æœå­˜åœ¨åˆ™è¯´æ˜è¯¾ç¨‹é™æ€åŒ–å¹¶ä¸Šä¼ åˆ°minioæˆåŠŸã€‚\r\n\r\n##### **3.5.4.3 æµè§ˆè¯¦ç»†é¡µé¢**\r\n\r\nè¯¾ç¨‹é™æ€åŒ–æˆåŠŸåå¯ä»¥ç”¨æµè§ˆå™¨è®¿é—®htmlæ–‡ä»¶æ˜¯å¦å¯ä»¥æ­£å¸¸æµè§ˆï¼Œä¸‹å›¾è¡¨ç¤ºå¯ä»¥æ­£å¸¸æµè§ˆã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps21.jpg) \r\n\r\né¡µé¢è¿˜æ²¡æœ‰æ ·å¼ï¼Œéœ€è¦åœ¨nginxé…ç½®è™šæ‹Ÿç›®å½•ï¼Œåœ¨www.51xuecheng.cnä¸‹é…ç½®ï¼š\r\n\r\n```http\r\nlocation /course/ {  \r\n        proxy_pass http://fileserver/mediafiles/course/;\r\n} \r\n```\r\n\r\nåŠ è½½nginxé…ç½®æ–‡ä»¶\r\n\r\nè®¿é—®ï¼š`http://www.51xuecheng.cn/course/2.html`\r\n\r\n2.htmlä¸ºä»¥è¯¾ç¨‹idå‘½åçš„htmlæ–‡ä»¶ã€‚\r\n\r\n### **3.6 è¯¾ç¨‹æœç´¢**\r\n\r\n#### **3.6.1 éœ€æ±‚åˆ†æ**\r\n\r\n##### **3.6.1.1 æ¨¡å—ä»‹ç»**\r\n\r\næœç´¢åŠŸèƒ½æ˜¯ä¸€ä¸ªç³»ç»Ÿçš„é‡è¦åŠŸèƒ½ï¼Œæ˜¯ä¿¡æ¯æŸ¥è¯¢çš„æ–¹å¼ã€‚è¯¾ç¨‹æœç´¢æ˜¯è¯¾ç¨‹å±•ç¤ºçš„æ¸ é“ï¼Œç”¨æˆ·é€šè¿‡è¯¾ç¨‹æœç´¢æ‰¾åˆ°è¯¾ç¨‹ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥å»æŸ¥çœ‹è¯¾ç¨‹çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¿›è¡Œé€‰è¯¾ã€æ”¯ä»˜ã€å­¦ä¹ ã€‚\r\n\r\næœ¬é¡¹ç›®çš„è¯¾ç¨‹æœç´¢æ”¯æŒå…¨æ–‡æ£€ç´¢æŠ€æœ¯ï¼Œä»€ä¹ˆæ˜¯å…¨æ–‡æ£€ç´¢ï¼Ÿ\r\n\r\n[å…¨æ–‡æ£€ç´¢](https://baike.baidu.com/item/å…¨æ–‡æ£€ç´¢/8028630?fromModule=lemma_inlink)æ˜¯æŒ‡è®¡ç®—æœºç´¢å¼•ç¨‹åºé€šè¿‡æ‰«ææ–‡ç« ä¸­çš„æ¯ä¸€ä¸ªè¯ï¼Œå¯¹æ¯ä¸€ä¸ªè¯å»ºç«‹ä¸€ä¸ªç´¢å¼•ï¼ŒæŒ‡æ˜è¯¥è¯åœ¨æ–‡ç« ä¸­å‡ºç°çš„æ¬¡æ•°å’Œä½ç½®ï¼Œå½“ç”¨æˆ·æŸ¥è¯¢æ—¶ï¼Œæ£€ç´¢ç¨‹åºå°±æ ¹æ®äº‹å…ˆå»ºç«‹çš„ç´¢å¼•è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¹¶å°†æŸ¥æ‰¾çš„ç»“æœåé¦ˆç»™ç”¨æˆ·çš„æ£€ç´¢æ–¹å¼ã€‚è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºé€šè¿‡å­—å…¸ä¸­çš„æ£€ç´¢å­—è¡¨æŸ¥å­—çš„è¿‡ç¨‹ã€‚\r\n\r\nå…¨æ–‡æ£€ç´¢å¯ä»¥ç®€å•ç†è§£ä¸ºé€šè¿‡ç´¢å¼•æœç´¢æ–‡ç« ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps22.jpg) \r\n\r\nå…¨æ–‡æ£€ç´¢çš„é€Ÿåº¦éå¸¸å¿«ï¼Œæ—©æœŸåº”ç”¨åœ¨æœç´¢å¼•æ“æŠ€æœ¯ä¸­ï¼Œæ¯”å¦‚ï¼šç™¾åº¦ã€googleç­‰ï¼Œç°åœ¨é€šå¸¸ä¸€äº›å¤§å‹ç½‘ç«™çš„æœç´¢åŠŸèƒ½éƒ½æ˜¯é‡‡ç”¨å…¨æ–‡æ£€ç´¢æŠ€æœ¯ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps23.jpg) \r\n\r\nè¯¾ç¨‹æœç´¢ä¹Ÿè¦å°†è¯¾ç¨‹ä¿¡æ¯å»ºç«‹ç´¢å¼•ï¼Œåœ¨è¯¾ç¨‹å‘å¸ƒæ—¶å»ºç«‹è¯¾ç¨‹ç´¢å¼•ï¼Œç´¢å¼•å»ºç«‹å¥½ç”¨æˆ·å¯é€šè¿‡æœç´¢ç½‘é¡µå»æŸ¥è¯¢è¯¾ç¨‹ä¿¡æ¯ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps24.jpg) \r\n\r\næ‰€ä»¥ï¼Œè¯¾ç¨‹æœç´¢æ¨¡å—åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šè¯¾ç¨‹ç´¢å¼•ã€è¯¾ç¨‹æœç´¢ã€‚\r\n\r\nè¯¾ç¨‹ç´¢å¼•æ˜¯å°†è¯¾ç¨‹ä¿¡æ¯å»ºç«‹ç´¢å¼•ã€‚\r\n\r\nè¯¾ç¨‹æœç´¢æ˜¯é€šè¿‡å‰ç«¯ç½‘é¡µï¼Œé€šè¿‡å…³é”®å­—ç­‰æ¡ä»¶å»æœç´¢è¯¾ç¨‹ã€‚\r\n\r\n \r\n\r\n##### **3.6.1.2 ä¸šåŠ¡æµç¨‹**\r\n\r\næ ¹æ®æ¨¡å—ä»‹ç»çš„å†…å®¹ï¼Œè¯¾ç¨‹æœç´¢æ¨¡å—åŒ…æ‹¬è¯¾ç¨‹ç´¢å¼•ã€è¯¾ç¨‹æœç´¢ä¸¤éƒ¨åˆ†ã€‚\r\n\r\n1ã€è¯¾ç¨‹ç´¢å¼•\r\n\r\nåœ¨è¯¾ç¨‹å‘å¸ƒæ“ä½œæ‰§è¡Œåé€šè¿‡æ¶ˆæ¯å¤„ç†æ–¹å¼åˆ›å»ºè¯¾ç¨‹ç´¢å¼•ï¼Œå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps25.jpg) \r\n\r\næœ¬é¡¹ç›®ä½¿ç”¨elasticsearchä½œä¸ºç´¢å¼•åŠæœç´¢æœåŠ¡ã€‚\r\n\r\n \r\n\r\n2ã€è¯¾ç¨‹æœç´¢\r\n\r\nè¯¾ç¨‹ç´¢å¼•åˆ›å»ºå®Œæˆï¼Œç”¨æˆ·æ‰å¯ä»¥é€šè¿‡å‰ç«¯æœç´¢è¯¾ç¨‹ä¿¡æ¯ã€‚\r\n\r\nè¯¾ç¨‹æœç´¢å¯ä»¥ä»é¦–é¡µè¿›å…¥æœç´¢é¡µé¢ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps26.jpg) \r\n\r\nä¸‹å›¾æ˜¯æœç´¢ç•Œé¢ï¼Œå¯ä»¥é€šè¿‡è¯¾ç¨‹åˆ†ç±»ã€è¯¾ç¨‹éš¾åº¦ç­‰çº§ç­‰æ¡ä»¶è¿›è¡Œæœç´¢ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps27.jpg) \r\n\r\n#### **3.6.2 å‡†å¤‡ç¯å¢ƒ**\r\n\r\n##### **3.6.2.1 æ­å»ºelasticsearch**\r\n\r\nåœ¨è¯¾å‰ä¸‹å‘çš„è™šæ‹Ÿä¸­å·²ç»åœ¨dockerå®¹å™¨ä¸­å®‰è£…äº†elasticsearchå’Œkibanaã€‚\r\n\r\nkibana æ˜¯ ELKï¼ˆElasticsearch , Logstash, Kibana ï¼‰ä¹‹ä¸€ï¼Œkibana ä¸€æ¬¾å¼€æºçš„æ•°æ®åˆ†æå’Œå¯è§†åŒ–å¹³å°ï¼Œé€šè¿‡å¯è§†åŒ–ç•Œé¢è®¿é—®elasticsearchçš„ç´¢å¼•åº“ï¼Œå¹¶å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ•°æ®æŠ¥è¡¨ã€‚\r\n\r\nå¼€å‘ä¸­ä¸»è¦ä½¿ç”¨kibanaé€šè¿‡apiå¯¹elasticsearchè¿›è¡Œç´¢å¼•å’Œæœç´¢æ“ä½œï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—® `http://192.168.101.65:5601/app/dev_tools#/console`è¿›å…¥kibanaçš„å¼€å‘å·¥å…·ç•Œé¢ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps28.jpg)\r\n\r\n \r\n\r\nå¯é€šè¿‡å‘½ä»¤ï¼šGET /_cat/indices?v  æŸ¥çœ‹æ‰€æœ‰çš„ç´¢å¼•ï¼Œé€šè¿‡æ­¤å‘½ä»¤åˆ¤æ–­kibanaæ˜¯å¦æ­£å¸¸è¿æ¥elasticsearchã€‚\r\n\r\nç´¢å¼•ç›¸å½“äºMySQLä¸­çš„è¡¨ï¼ŒElasticsearchä¸MySQLä¹‹é—´æ¦‚å¿µçš„å¯¹åº”å…³ç³»è§ä¸‹è¡¨ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps29.jpg) \r\n\r\nè¦ä½¿ç”¨elasticsearchéœ€è¦å»ºç«‹ç´¢å¼•ï¼ŒMappingç›¸å½“äºè¡¨ç»“æ„ï¼ŒMappingåˆ›å»ºåå…¶å­—æ®µä¸èƒ½åˆ é™¤ï¼Œå¦‚æœè¦åˆ é™¤éœ€è¦åˆ é™¤æ•´ä¸ªç´¢å¼•ï¼Œä¸‹è¾¹ä»‹ç»åˆ›å»ºç´¢å¼•ã€æŸ¥è¯¢ç´¢å¼•ã€åˆ é™¤ç´¢å¼•çš„æ–¹æ³•ï¼š\r\n\r\n1ã€åˆ›å»ºç´¢å¼•ï¼Œå¹¶æŒ‡å®šMappingã€‚\r\n\r\n`PUT /course-publish`\r\n\r\n```json\r\n\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 1,\r\n    \"number_of_replicas\": 0\r\n  },\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"id\": {\r\n        \"type\": \"keyword\"\r\n      },\r\n      \"companyId\": {\r\n        \"type\": \"keyword\"\r\n      },\r\n      \"companyName\": {\r\n        \"analyzer\": \"ik_max_word\",\r\n        \"search_analyzer\": \"ik_smart\",\r\n        \"type\": \"text\"\r\n      },\r\n      \"name\": {\r\n        \"analyzer\": \"ik_max_word\",\r\n        \"search_analyzer\": \"ik_smart\",\r\n        \"type\": \"text\"\r\n      },\r\n      \"users\": {\r\n        \"index\": false,\r\n        \"type\": \"text\"\r\n      },\r\n      \"tags\": {\r\n        \"analyzer\": \"ik_max_word\",\r\n        \"search_analyzer\": \"ik_smart\",\r\n        \"type\": \"text\"\r\n      },\r\n      \"mt\": {\r\n        \"type\": \"keyword\"\r\n      },\r\n      \"mtName\": {\r\n        \"type\": \"keyword\"\r\n      },\r\n      \"st\": {\r\n        \"type\": \"keyword\"\r\n      },\r\n      \"stName\": {\r\n        \"type\": \"keyword\"\r\n      },\r\n      \"grade\": {\r\n        \"type\": \"keyword\"\r\n      },\r\n      \"teachmode\": {\r\n        \"type\": \"keyword\"\r\n      },\r\n      \"pic\": {\r\n        \"index\": false,\r\n        \"type\": \"text\"\r\n      },\r\n      \"description\": {\r\n        \"analyzer\": \"ik_max_word\",\r\n        \"search_analyzer\": \"ik_smart\",\r\n        \"type\": \"text\"\r\n      },\r\n      \"createDate\": {\r\n        \"format\": \"yyyy-MM-dd HH:mm:ss\",\r\n        \"type\": \"date\"\r\n      },\r\n      \"status\": {\r\n        \"type\": \"keyword\"\r\n      },\r\n      \"remark\": {\r\n        \"index\": false,\r\n        \"type\": \"text\"\r\n      },\r\n      \"charge\": {\r\n        \"type\": \"keyword\"\r\n      },\r\n      \"price\": {\r\n        \"type\": \"scaled_float\",\r\n        \"scaling_factor\": 100\r\n      },\r\n      \"originalPrice\": {\r\n        \"type\": \"scaled_float\",\r\n        \"scaling_factor\": 100\r\n      },\r\n      \"validDays\": {\r\n        \"type\": \"integer\"\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n```\r\n\r\n2ã€æŸ¥è¯¢ç´¢å¼•\r\n\r\né€šè¿‡ `GET /_cat/indices?v` æŸ¥è¯¢æ‰€æœ‰çš„ç´¢å¼•ï¼ŒæŸ¥æ‰¾course-publishæ˜¯å¦åˆ›å»ºæˆåŠŸã€‚\r\n\r\né€šè¿‡`GET /course-publish/_mapping` æŸ¥è¯¢course-publishçš„ç´¢å¼•ç»“æ„ã€‚\r\n\r\n```json\r\n\r\n{\r\n  \"course-publish\" : {\r\n    \"mappings\" : {\r\n      \"properties\" : {\r\n        \"charge\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"companyId\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"companyName\" : {\r\n          \"type\" : \"text\",\r\n          \"analyzer\" : \"ik_max_word\",\r\n          \"search_analyzer\" : \"ik_smart\"\r\n        },\r\n        \"createDate\" : {\r\n          \"type\" : \"date\",\r\n          \"format\" : \"yyyy-MM-dd HH:mm:ss\"\r\n        },\r\n        \"description\" : {\r\n          \"type\" : \"text\",\r\n          \"analyzer\" : \"ik_max_word\",\r\n          \"search_analyzer\" : \"ik_smart\"\r\n        },\r\n        \"grade\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"id\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"mt\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"mtName\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"name\" : {\r\n          \"type\" : \"text\",\r\n          \"analyzer\" : \"ik_max_word\",\r\n          \"search_analyzer\" : \"ik_smart\"\r\n        },\r\n        \"originalPrice\" : {\r\n          \"type\" : \"scaled_float\",\r\n          \"scaling_factor\" : 100.0\r\n        },\r\n        \"pic\" : {\r\n          \"type\" : \"text\",\r\n          \"index\" : false\r\n        },\r\n        \"price\" : {\r\n          \"type\" : \"scaled_float\",\r\n          \"scaling_factor\" : 100.0\r\n        },\r\n        \"remark\" : {\r\n          \"type\" : \"text\",\r\n          \"index\" : false\r\n        },\r\n        \"st\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"stName\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"status\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"tags\" : {\r\n          \"type\" : \"text\",\r\n          \"analyzer\" : \"ik_max_word\",\r\n          \"search_analyzer\" : \"ik_smart\"\r\n        },\r\n        \"teachmode\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"users\" : {\r\n          \"type\" : \"text\",\r\n          \"index\" : false\r\n        },\r\n        \"validDays\" : {\r\n          \"type\" : \"integer\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n```\r\n\r\n3ã€åˆ é™¤ç´¢å¼•\r\n\r\nå¦‚æœå‘ç°åˆ›å»ºçš„course-publishä¸æ­£ç¡®å¯ä»¥åˆ é™¤é‡æ–°åˆ›å»ºã€‚\r\n\r\nåˆ é™¤ç´¢å¼•åå½“ä¸­çš„æ–‡æ¡£æ•°æ®ä¹ŸåŒæ—¶åˆ é™¤ï¼Œä¸€å®šè¦è°¨æ…æ“ä½œï¼\r\n\r\nåˆ é™¤ç´¢å¼•å‘½ä»¤ï¼šDELETE /course-publish\r\n\r\n##### **3.6.2.2 éƒ¨ç½²æœç´¢å·¥ç¨‹**\r\n\r\næ‹·è´è¯¾ç¨‹èµ„æ–™ä¸­çš„xuecheng-plus-searchæœç´¢å·¥ç¨‹åˆ°è‡ªå·±çš„å·¥ç¨‹ç›®å½•ã€‚\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps30.jpg) \r\n\r\nä¿®æ”¹bootstrap.xmlä¸­nacosçš„namespaceä¸ºè‡ªå·±çš„å‘½åç©ºé—´ã€‚\r\n\r\nå¯åŠ¨ç½‘å…³ã€æœç´¢æœåŠ¡ã€‚\r\n\r\néƒ¨ç½²å®Œæˆé€šè¿‡httpclientè¿›è¡Œæµ‹è¯•\r\n\r\n```http\r\nJava\r\n### æ·»åŠ è¯¾ç¨‹ç´¢å¼•\r\nPOST {{search_host}}/search/index/course\r\nContent-Type: application/json\r\n\r\n{\r\n  \"charge\" : \"201000\",\r\n  \"companyId\" : 100000,\r\n  \"companyName\" : \"åŒ—äº¬é»‘é©¬ç¨‹åº\",\r\n  \"createDate\" : \"2022-09-25 09:36:11\",\r\n  \"description\" : \"ã€ŠSpringç¼–ç¨‹æ€æƒ³ã€‹æ˜¯2007å¹´6æœˆ1æ—¥æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾å‡ºç‰ˆçš„å›¾ä¹¦ï¼Œä½œè€…æ˜¯åŸƒå…‹å°”ï¼Œè¯‘è€…æ˜¯é™ˆæ˜Šé¹ã€‚ä¸»è¦å†…å®¹æœ¬ä¹¦èµ¢å¾—äº†å…¨çƒç¨‹åºå‘˜çš„å¹¿æ³›èµèª‰ï¼Œå³ä½¿æ˜¯æœ€æ™¦æ¶©çš„æ¦‚å¿µï¼Œåœ¨Bruce Eckelçš„æ–‡å­—äº²å’ŒåŠ›å’Œå°è€Œç›´æ¥çš„ç¼–ç¨‹ç¤ºä¾‹é¢å‰ä¹Ÿä¼šåŒ–è§£äºæ— å½¢ã€‚ä»Javaçš„åŸºç¡€è¯­æ³•åˆ°æœ€é«˜çº§ç‰¹æ€§ï¼ˆæ·±å…¥çš„é¢å‘å¯¹è±¡æ¦‚å¿µã€å¤šçº¿ç¨‹ã€è‡ªåŠ¨é¡¹ç›®æ„å»ºã€å•å…ƒæµ‹è¯•å’Œè°ƒè¯•ç­‰ï¼‰ï¼Œæœ¬ä¹¦éƒ½èƒ½é€æ­¥æŒ‡å¯¼ä½ è½»æ¾æŒæ¡ã€‚ä»æœ¬ä¹¦è·å¾—çš„å„é¡¹å¤§å¥–ä»¥åŠæ¥è‡ªä¸–ç•Œå„åœ°çš„è¯»è€…è¯„è®ºä¸­ï¼Œä¸éš¾çœ‹å‡ºè¿™æ˜¯ä¸€æœ¬ç»å…¸ä¹‹ä½œ\",\r\n  \"grade\" : \"204001\",\r\n  \"id\" : 102,\r\n  \"mt\" : \"1-3\",\r\n  \"mtName\" : \"ç¼–ç¨‹å¼€å‘\",\r\n  \"name\" : \"Springç¼–ç¨‹æ€æƒ³\",\r\n  \"originalPrice\" : 200.0,\r\n  \"pic\" : \"/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png\",\r\n  \"price\" : 100.0,\r\n  \"remark\" : \"æ²¡æœ‰å¤‡æ³¨\",\r\n  \"st\" : \"1-3-2\",\r\n  \"stName\" : \"Javaè¯­è¨€\",\r\n  \"status\" : \"203002\",\r\n  \"tags\" : \"æ²¡æœ‰æ ‡ç­¾\",\r\n  \"teachmode\" : \"200002\",\r\n  \"validDays\" : 222\r\n}\r\n```\r\n\r\n```http\r\n### æœç´¢è¯¾ç¨‹\r\nGET {{search_host}}/search/course/list?pageNo=1&keywords=spring\r\nContent-Type: application/json\r\n```\r\n\r\nè¿›å…¥å‰ç«¯æœç´¢ç•Œé¢`http://www.51xuecheng.cn/course/search.html`\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps31.jpg) \r\n\r\n \r\n\r\n#### **3.6.3 è¯¾ç¨‹ä¿¡æ¯ç´¢å¼•åŒæ­¥**\r\n\r\n##### **3.6.3.1 æŠ€æœ¯æ–¹æ¡ˆ**\r\n\r\né€šè¿‡å‘ç´¢å¼•ä¸­æ·»åŠ è¯¾ç¨‹ä¿¡æ¯æœ€ç»ˆå®ç°äº†è¯¾ç¨‹çš„æœç´¢ï¼Œæˆ‘ä»¬å‘ç°è¯¾ç¨‹ä¿¡æ¯æ˜¯å…ˆä¿å­˜åœ¨å…³ç³»æ•°æ®åº“ä¸­ï¼Œè€Œåå†å†™å…¥ç´¢å¼•ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å°†å…³ç³»æ•°æ®ä¸­çš„æ•°æ®åŒæ­¥åˆ°elasticsearchç´¢å¼•ä¸­çš„è¿‡ç¨‹ï¼Œå¯ä»¥ç®€å•æˆä¸ºç´¢å¼•åŒæ­¥ã€‚\r\n\r\né€šå¸¸é¡¹ç›®ä¸­ä½¿ç”¨elasticsearchéœ€è¦å®Œæˆç´¢å¼•åŒæ­¥ï¼Œç´¢å¼•åŒæ­¥çš„æ–¹æ³•å¾ˆå¤šï¼š\r\n\r\n1ã€é’ˆå¯¹å®æ—¶æ€§éå¸¸é«˜çš„åœºæ™¯éœ€è¦æ»¡è¶³æ•°æ®çš„åŠæ—¶åŒæ­¥ï¼Œå¯ä»¥åŒæ­¥è°ƒç”¨ï¼Œæˆ–ä½¿ç”¨Canalå»å®ç°ã€‚\r\n\r\n1ï¼‰åŒæ­¥è°ƒç”¨å³åœ¨å‘MySQLå†™æ•°æ®åè¿œç¨‹è°ƒç”¨æœç´¢æœåŠ¡çš„æ¥å£å†™å…¥ç´¢å¼•ï¼Œæ­¤æ–¹æ³•ç®€å•ä½†æ˜¯è€¦åˆä»£ç å¤ªé«˜ã€‚\r\n\r\n2ï¼‰å¯ä»¥ä½¿ç”¨ä¸€ä¸ªä¸­é—´çš„è½¯ä»¶canalè§£å†³è€¦åˆæ€§çš„é—®é¢˜ï¼Œä½†å­˜åœ¨å­¦ä¹ ä¸ç»´æŠ¤æˆæœ¬ã€‚\r\n\r\ncanalä¸»è¦ç”¨é€”æ˜¯åŸºäº MySQL æ•°æ®åº“å¢é‡æ—¥å¿—è§£æï¼Œå¹¶èƒ½æä¾›å¢é‡æ•°æ®è®¢é˜…å’Œæ¶ˆè´¹ï¼Œå®ç°å°†MySQLçš„æ•°æ®åŒæ­¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€Elasticsearchã€å…¶å®ƒæ•°æ®åº“ç­‰ï¼Œåº”ç”¨åœºæ™¯ååˆ†ä¸°å¯Œã€‚ \r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps32.jpg) \r\n\r\nå®ƒçš„åœ°å€ï¼š\r\n\r\ngithubåœ°å€ï¼šhttps://github.com/alibaba/canal \r\n\r\nç‰ˆæœ¬ä¸‹è½½åœ°å€ï¼šhttps://github.com/alibaba/canal/releases \r\n\r\næ–‡æ¡£åœ°å€ï¼šhttps://github.com/alibaba/canal/wiki/Docker-QuickStart \r\n\r\n \r\n\r\nCanalåŸºäºmysqlçš„binlogæŠ€æœ¯å®ç°æ•°æ®åŒæ­¥ï¼Œä»€ä¹ˆæ˜¯binlogï¼Œå®ƒæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼ŒäºŒè¿›åˆ¶æ ¼å¼ï¼Œè®°å½•äº†å¯¹æ•°æ®åº“æ›´æ–°çš„SQLè¯­å¥ï¼Œå‘æ•°æ®åº“å†™æ•°æ®çš„åŒæ—¶å‘binlogæ–‡ä»¶é‡Œè®°å½•å¯¹åº”çš„sqlè¯­å¥ã€‚å½“æ•°æ®åº“æœåŠ¡å™¨å‘ç”Ÿäº†æ•…éšœå°±å¯ä»¥ä½¿ç”¨binlogæ–‡ä»¶å¯¹æ•°æ®åº“è¿›è¡Œæ¢å¤ã€‚\r\n\r\næ‰€ä»¥ï¼Œä½¿ç”¨canalæ˜¯éœ€è¦å¼€å¯mysqlçš„binlogå†™å…¥åŠŸèƒ½ï¼ŒCanalå·¥ä½œåŸç†å¦‚ä¸‹ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps33.jpg) \r\n\r\n1ã€canal æ¨¡æ‹Ÿ MySQL slave çš„äº¤äº’åè®®ï¼Œä¼ªè£…è‡ªå·±ä¸º MySQL slave ï¼Œå‘ MySQL master å‘é€dump \r\n\r\nåè®® \r\n\r\n2ã€MySQL master æ”¶åˆ° dump è¯·æ±‚ï¼Œå¼€å§‹æ¨é€ binary log ç»™ slave (å³ canal ) \r\n\r\n3ã€canal è§£æ binary log å¯¹è±¡(åŸå§‹ä¸º byte æµ)\r\n\r\nè¯¦ç»†ä½¿ç”¨Canalè¿›è¡Œç´¢å¼•åŒæ­¥çš„æ­¥éª¤å‚è€ƒï¼šCanalå®ç°ç´¢å¼•åŒæ­¥.pdf\r\n\r\n \r\n\r\n2ã€å½“ç´¢å¼•åŒæ­¥çš„å®æ—¶æ€§è¦æ±‚ä¸é«˜æ—¶å¯ç”¨çš„æŠ€æœ¯æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚ï¼šMQã€Logstashã€ä»»åŠ¡è°ƒåº¦ç­‰ã€‚\r\n\r\nMQï¼šå‘mysqlå†™æ•°æ®çš„æ—¶å€™å‘mqå†™å…¥æ¶ˆæ¯ï¼Œæœç´¢æœåŠ¡ç›‘å¬MQï¼Œæ”¶åˆ°æ¶ˆæ¯åå†™å…¥ç´¢å¼•ã€‚ä½¿ç”¨MQçš„ä¼˜åŠ¿æ˜¯ä»£ç è§£è€¦ï¼Œä½†æ˜¯éœ€è¦å¤„ç†æ¶ˆæ¯å¯é æ€§çš„é—®é¢˜æœ‰ä¸€å®šçš„æŠ€æœ¯æˆæœ¬ï¼Œåšåˆ°æ¶ˆæ¯å¯é æ€§éœ€è¦åšåˆ°ç”Ÿäº§è€…æŠ•é€’æˆåŠŸã€æ¶ˆæ¯æŒä¹…åŒ–ä»¥åŠæ¶ˆè´¹è€…æ¶ˆè´¹æˆåŠŸä¸‰ä¸ªæ–¹é¢ï¼Œå¦å¤–è¿˜è¦åšå¥½æ¶ˆæ¯å¹‚ç­‰æ€§é—®é¢˜ã€‚\r\n\r\nLogstashï¼š å¼€æºå®æ—¶æ—¥å¿—åˆ†æå¹³å° ELKåŒ…æ‹¬Elasticsearchã€Kibanaã€Logstashï¼ŒLogstashè´Ÿè´£æ”¶é›†ã€è§£æå’Œè½¬æ¢æ—¥å¿—ä¿¡æ¯ï¼Œå¯ä»¥å®ç°MySQLä¸Elasticsearchä¹‹é—´çš„æ•°æ®åŒæ­¥ã€‚ä¹Ÿå¯ä»¥å®ç°è§£è€¦åˆå¹¶ä¸”æ˜¯å®˜æ–¹æ¨èï¼Œä½†éœ€è¦å¢åŠ å­¦ä¹ ä¸ç»´æŠ¤æˆæœ¬ã€‚\r\n\r\nä»»åŠ¡è°ƒåº¦ï¼šå‘mysqlå†™æ•°æ®çš„æ—¶å€™è®°å½•ä¿®æ”¹è®°å½•ï¼Œå¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ ¹æ®ä¿®æ”¹è®°å½•å°†æ•°æ®åŒæ­¥åˆ°Elasticsearchã€‚\r\n\r\n \r\n\r\næ ¹æ®æœ¬é¡¹ç›®çš„éœ€æ±‚ï¼Œè¯¾ç¨‹å‘å¸ƒåä¿¡æ¯åŒæ­¥çš„å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼Œä»æäº¤å®¡æ ¸åˆ°å‘å¸ƒæˆåŠŸä¸€èˆ¬ä¸¤ä¸ªå·¥ä½œæ—¥å®Œæˆã€‚ç»¼åˆæ¯”è¾ƒä»¥ä¸ŠæŠ€æœ¯æ–¹æ¡ˆæœ¬é¡¹ç›®çš„ç´¢å¼•åŒæ­¥æŠ€æœ¯ä½¿ç”¨ä»»åŠ¡è°ƒåº¦çš„æ–¹æ³•ã€‚\r\n\r\nå¦‚ä¸‹å›¾ï¼š\r\n\r\n![img](https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/wps34.jpg) \r\n\r\n1ã€è¯¾ç¨‹å‘å¸ƒå‘æ¶ˆæ¯è¡¨æ’å…¥è®°å½•ã€‚\r\n\r\n2ã€ç”±ä»»åŠ¡è°ƒåº¦ç¨‹åºé€šè¿‡æ¶ˆæ¯å¤„ç†SDKå¯¹æ¶ˆæ¯è®°å½•è¿›è¡Œå¤„ç†ã€‚\r\n\r\n3ã€å‘elasticsearchç´¢å¼•ä¸­ä¿å­˜è¯¾ç¨‹ä¿¡æ¯ã€‚\r\n\r\nå¦‚ä½•å‘å‘elasticsearchç´¢å¼•ä¸­ä¿å­˜è¯¾ç¨‹ä¿¡æ¯ï¼Ÿ\r\n\r\næ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š\r\n\r\nç”±å†…å®¹ç®¡ç†æœåŠ¡è¿œç¨‹è°ƒç”¨æœç´¢æœåŠ¡æ·»åŠ è¯¾ç¨‹ä¿¡æ¯ç´¢å¼•ï¼Œæœç´¢æœåŠ¡å†è¯·æ±‚elasticsearchå‘è¯¾ç¨‹ç´¢å¼•ä¸­æ·»åŠ æ–‡æ¡£ã€‚\r\n\r\n \r\n\r\n##### **3.6.3.2 è¯¾ç¨‹ç´¢å¼•ä»»åŠ¡å¼€å‘**\r\n\r\n1ã€æ‹·è´CourseIndex æ¨¡å‹ç±»åˆ°å†…å®¹ç®¡ç†model å·¥ç¨‹çš„dtoåŒ…ä¸‹ã€‚\r\n\r\n2ã€åœ¨å†…å®¹ç®¡ç†æœåŠ¡ä¸­æ·»åŠ FeignClient\r\n\r\n```java\r\n\r\n\r\n/**\r\n * @description æœç´¢æœåŠ¡è¿œç¨‹æ¥å£\r\n */\r\n@FeignClient(value = \"search\",fallbackFactory = SearchServiceClientFallbackFactory.class)\r\npublic interface SearchServiceClient {\r\n\r\n @PostMapping(\"/search/index/course\")\r\n public Boolean add(@RequestBody CourseIndex courseIndex);\r\n}\r\n```\r\n\r\nå®šä¹‰SearchServiceClientFallbackFactory ï¼š\r\n\r\n```java\r\n\r\n@Slf4j\r\n@Component\r\npublic class SearchServiceClientFallbackFactory implements FallbackFactory<SearchServiceClient> {\r\n    @Override\r\n    public SearchServiceClient create(Throwable throwable) {\r\n\r\n        return new SearchServiceClient() {\r\n\r\n            @Override\r\n            public Boolean add(CourseIndex courseIndex) {\r\n                throwable.printStackTrace();\r\n                log.debug(\"è°ƒç”¨æœç´¢å‘ç”Ÿç†”æ–­èµ°é™çº§æ–¹æ³•,ç†”æ–­å¼‚å¸¸:\", throwable.getMessage());\r\n\r\n                return false;\r\n            }\r\n        };\r\n    }\r\n}\r\n```\r\n\r\n3ã€ç¼–å†™è¯¾ç¨‹ç´¢å¼•ä»»åŠ¡æ‰§è¡Œæ–¹æ³•\r\n\r\nå®Œå–„CoursePublishTaskç±»ä¸­çš„saveCourseIndexæ–¹æ³•\r\n\r\n```java\r\n\r\n//ä¿å­˜è¯¾ç¨‹ç´¢å¼•ä¿¡æ¯\r\npublic void saveCourseIndex(MqMessage mqMessage,long courseId){\r\n    log.debug(\"ä¿å­˜è¯¾ç¨‹ç´¢å¼•ä¿¡æ¯,è¯¾ç¨‹id:{}\",courseId);\r\n\r\n    //æ¶ˆæ¯id\r\n    Long id = mqMessage.getId();\r\n    //æ¶ˆæ¯å¤„ç†çš„service\r\n    MqMessageService mqMessageService = this.getMqMessageService();\r\n    //æ¶ˆæ¯å¹‚ç­‰æ€§å¤„ç†\r\n    int stageTwo = mqMessageService.getStageTwo(id);\r\n    if(stageTwo > 0){\r\n        log.debug(\"è¯¾ç¨‹ç´¢å¼•å·²å¤„ç†ç›´æ¥è¿”å›ï¼Œè¯¾ç¨‹id:{}\",courseId);\r\n        return ;\r\n    }\r\n\r\n    Boolean result = saveCourseIndex(courseId);\r\n    if(result){\r\n        //ä¿å­˜ç¬¬ä¸€é˜¶æ®µçŠ¶æ€\r\n        mqMessageService.completedStageTwo(id);\r\n    }\r\n}\r\n\r\nprivate Boolean saveCourseIndex(Long courseId) {\r\n\r\n    //å–å‡ºè¯¾ç¨‹å‘å¸ƒä¿¡æ¯\r\n    CoursePublish coursePublish = coursePublishMapper.selectById(courseId);\r\n    //æ‹·è´è‡³è¯¾ç¨‹ç´¢å¼•å¯¹è±¡\r\n    CourseIndex courseIndex = new CourseIndex();\r\n    BeanUtils.copyProperties(coursePublish,courseIndex);\r\n    //è¿œç¨‹è°ƒç”¨æœç´¢æœåŠ¡apiæ·»åŠ è¯¾ç¨‹ä¿¡æ¯åˆ°ç´¢å¼•\r\n    Boolean add = searchServiceClient.add(courseIndex);\r\n    if(!add){\r\n        XueChengPlusException.cast(\"æ·»åŠ ç´¢å¼•å¤±è´¥\");\r\n    }\r\n    return add;\r\n\r\n}\r\n```\r\n\r\n##### **3.6.3.3 æµ‹è¯•**\r\n\r\næµ‹è¯•æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n1ã€å¯åŠ¨elasticsearchã€kibanaã€‚\r\n\r\n2ã€å¯åŠ¨ç½‘å…³ã€å†…å®¹ç®¡ç†ã€æœç´¢æœåŠ¡ã€nginxã€‚\r\n\r\n3ã€å¯åŠ¨xxl-jobè°ƒåº¦ä¸­å¿ƒã€‚\r\n\r\n4ã€åœ¨ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒå¼€å§‹è¯¾ç¨‹å‘å¸ƒä»»åŠ¡ã€‚\r\n\r\n5ã€å‘å¸ƒä¸€é—¨è¯¾ç¨‹ï¼Œé¡µé¢æç¤ºæ“ä½œæˆåŠŸï¼ŒæŸ¥çœ‹å‘å¸ƒè¯¾ç¨‹ä»»åŠ¡æ˜¯å¦å†™åˆ°ä»»åŠ¡è¡¨ã€‚\r\n\r\n6ã€ç»è¿‡ä»»åŠ¡è°ƒåº¦å°†è¯¾ç¨‹ä¿¡æ¯å†™å…¥ç´¢å¼•ã€‚\r\n\r\n7ã€é€šè¿‡é—¨æˆ·è¿›å…¥æœç´¢é¡µé¢ï¼ŒæŸ¥çœ‹è¯¾ç¨‹ä¿¡æ¯æ˜¯å¦å±•ç¤ºã€‚"},{"title":"","tags":[],"categories":[],"author":"","excerpt":"","link":"/tags","content":""}]
