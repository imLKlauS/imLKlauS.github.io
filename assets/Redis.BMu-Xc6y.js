import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang.C44lIQJn.js";import"./chunks/@vueuse/motion.D4J2SB46.js";import{d as s,a as l,u as a}from"./chunks/vue-router.Dq2gs_fP.js";import{a1 as h,a3 as k,a4 as t,a5 as n,a7 as e,a6 as E,F as r,a2 as p,Z as d}from"./framework.GzYmdVjK.js";import"./app.DNNK9eY1.js";import"./chunks/dayjs.Dto65haK.js";import"./chunks/vue-i18n.BvWwj3SI.js";import"./chunks/pinia.BcfqlbOB.js";import"./chunks/nprogress.W5IEJXTh.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.DtNJVFPV.js";import"./index.TQnGKZgq.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.KHJRstPN.js";import"./post.CLjzu-Y_.js";const g=s("/posts/Redis",async i=>JSON.parse('{"title":"Redis 从入门到精通","description":"","frontmatter":{"cover":"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/cat_night_lights_74375_1920x1080.jpg","title":"Redis 从入门到精通","top":100,"author":"imklaus","tags":["Redis"],"categories":["中间件"],"date":"2025-12-4 20:00:10","outline":"deep","excerpt_type":"html","end":false},"headers":[],"relativePath":"pages/posts/Redis.md","lastUpdated":null}'),{lazy:(i,s)=>i.name===s.name}),y={__name:"Redis",setup(s,{expose:y}){const{data:c}=g(),o=a(),F=l(),u=Object.assign(F.meta.frontmatter||{},c.value?.frontmatter||{});o.currentRoute.value.data=c.value,d("valaxy:frontmatter",u),globalThis.$frontmatter=u;return y({frontmatter:{cover:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/cat_night_lights_74375_1920x1080.jpg",title:"Redis 从入门到精通",top:100,author:"imklaus",tags:["Redis"],categories:["中间件"],date:"2025-12-4 20:00:10",outline:"deep",excerpt_type:"html",end:!1}}),(s,l)=>{const a=i;return p(),h(a,{frontmatter:r(u)},{"main-content-md":k(()=>[l[0]||(l[0]=n("p",null,[E("参考视频："),n("a",{href:"https://www.bilibili.com/video/BV1cr4y1671t",target:"_blank",rel:"noreferrer"},[E("黑马"),n("code",null,"Redis"),E("快速入门")])],-1)),l[1]||(l[1]=n("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),e(" more "),l[2]||(l[2]=n("h2",{id:"redis-快速入门",tabindex:"-1"},[E("Redis 快速入门 "),n("a",{class:"header-anchor",href:"#redis-快速入门","aria-label":'Permalink to "Redis 快速入门"'},"​")],-1)),l[3]||(l[3]=n("p",null,"Redis的常见命令和客户端使用",-1)),l[4]||(l[4]=n("hr",null,null,-1)),l[5]||(l[5]=n("h3",{id:"_1-初识-redis",tabindex:"-1"},[E("1. 初识 Redis "),n("a",{class:"header-anchor",href:"#_1-初识-redis","aria-label":'Permalink to "1. 初识 Redis"'},"​")],-1)),l[6]||(l[6]=n("p",null,"Redis是一种键值型的NoSql数据库，这里有两个关键字：",-1)),l[7]||(l[7]=n("ul",null,[n("li",null,[n("p",null,"键值型")]),n("li",null,[n("p",null,"NoSql")])],-1)),l[8]||(l[8]=n("p",null,[E("其中"),n("strong",null,"键值型"),E("，是指Redis中存储的数据都是以key、value对的形式存储，而value的形式多种多样，可以是字符串、数值、甚至json：")],-1)),l[9]||(l[9]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/6U1Rhxo.png",alt:"image-20220502190959608",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[10]||(l[10]=n("p",null,"而NoSql则是相对于传统关系型数据库而言，有很大差异的一种数据库。",-1)),l[11]||(l[11]=n("hr",null,null,-1)),l[12]||(l[12]=n("h4",{id:"_1-1-认识-nosql",tabindex:"-1"},[E("1.1 认识 NoSQL "),n("a",{class:"header-anchor",href:"#_1-1-认识-nosql","aria-label":'Permalink to "1.1 认识 NoSQL"'},"​")],-1)),l[13]||(l[13]=n("p",null,[n("strong",null,"NoSql"),E("可以翻译做Not Only Sql（不仅仅是SQL），或者是No Sql（非Sql的）数据库。是相对于传统关系型数据库而言，有很大差异的一种特殊的数据库，因此也称之为"),n("strong",null,"非关系型数据库"),E("。")],-1)),l[14]||(l[14]=n("hr",null,null,-1)),l[15]||(l[15]=n("h5",{id:"_1-1-1-结构化与非结构化",tabindex:"-1"},[E("1.1.1 结构化与非结构化 "),n("a",{class:"header-anchor",href:"#_1-1-1-结构化与非结构化","aria-label":'Permalink to "1.1.1 结构化与非结构化"'},"​")],-1)),l[16]||(l[16]=n("p",null,"传统关系型数据库是结构化数据，每一张表都有严格的约束信息：字段名、字段数据类型、字段约束等等信息，插入的数据必须遵守这些约束：",-1)),l[17]||(l[17]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/4tUgFo6.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[18]||(l[18]=n("p",null,"而NoSql则对数据库格式没有严格约束，往往形式松散，自由。",-1)),l[19]||(l[19]=n("p",null,"可以是键值型：",-1)),l[20]||(l[20]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/GdqOSsj.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[21]||(l[21]=n("p",null,"也可以是文档型：",-1)),l[22]||(l[22]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/zBBQfcc.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[23]||(l[23]=n("p",null,"甚至可以是图格式：",-1)),l[24]||(l[24]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/zBnKxWf.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[25]||(l[25]=n("h5",{id:"_1-1-2-关联和非关联",tabindex:"-1"},[E("1.1.2 关联和非关联 "),n("a",{class:"header-anchor",href:"#_1-1-2-关联和非关联","aria-label":'Permalink to "1.1.2 关联和非关联"'},"​")],-1)),l[26]||(l[26]=n("p",null,"传统数据库的表与表之间往往存在关联，例如外键：",-1)),l[27]||(l[27]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/tXYSl5x.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[28]||(l[28]=n("p",null,"而非关系型数据库不存在关联关系，要维护关系要么靠代码中的业务逻辑，要么靠数据之间的耦合：",-1)),l[29]||(l[29]=n("div",{class:"language-json max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"json"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"  id"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"  name"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"张三"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"  orders"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": [")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"       id"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"       item"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"\t id"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"title"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"荣耀6"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"price"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"4999")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"       }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    },")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"       id"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"       item"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"\t id"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"title"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"小米11"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"price"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3999")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"       }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  ]")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[30]||(l[30]=n("p",null,"此处要维护“张三”的订单与商品“荣耀”和“小米11”的关系，不得不冗余的将这两个商品保存在张三的订单文档中，不够优雅。还是建议用业务来维护关联关系。",-1)),l[31]||(l[31]=n("h5",{id:"_1-1-3-查询方式",tabindex:"-1"},[E("1.1.3 查询方式 "),n("a",{class:"header-anchor",href:"#_1-1-3-查询方式","aria-label":'Permalink to "1.1.3 查询方式"'},"​")],-1)),l[32]||(l[32]=n("p",null,"传统关系型数据库会基于Sql语句做查询，语法有统一标准；",-1)),l[33]||(l[33]=n("p",null,"而不同的非关系数据库查询语法差异极大，五花八门各种各样。",-1)),l[34]||(l[34]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/AzaHOTF.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[35]||(l[35]=n("h5",{id:"_1-1-4-事务",tabindex:"-1"},[E("1.1.4 事务 "),n("a",{class:"header-anchor",href:"#_1-1-4-事务","aria-label":'Permalink to "1.1.4 事务"'},"​")],-1)),l[36]||(l[36]=n("p",null,"传统关系型数据库能满足事务ACID的原则。",-1)),l[37]||(l[37]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/J1MqOJM.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[38]||(l[38]=n("p",null,"而非关系型数据库往往不支持事务，或者不能严格保证ACID的特性，只能实现基本的一致性。",-1)),l[39]||(l[39]=n("h5",{id:"_1-1-5-总结",tabindex:"-1"},[E("1.1.5 总结 "),n("a",{class:"header-anchor",href:"#_1-1-5-总结","aria-label":'Permalink to "1.1.5 总结"'},"​")],-1)),l[40]||(l[40]=n("p",null,"除了上述四点以外，在存储方式、扩展性、查询性能上关系型与非关系型也都有着显著差异，总结如下：",-1)),l[41]||(l[41]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/kZP40dQ.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[42]||(l[42]=n("ul",null,[n("li",null,[E("存储方式 "),n("ul",null,[n("li",null,"关系型数据库基于磁盘进行存储，会有大量的磁盘IO，对性能有一定影响"),n("li",null,"非关系型数据库，他们的操作更多的是依赖于内存来操作，内存的读写速度会非常快，性能自然会好一些")])])],-1)),l[43]||(l[43]=n("ul",null,[n("li",null,[E("扩展性 "),n("ul",null,[n("li",null,"关系型数据库集群模式一般是主从，主从数据一致，起到数据备份的作用，称为垂直扩展。"),n("li",null,"非关系型数据库可以将数据拆分，存储在不同机器上，可以保存海量数据，解决内存大小有限的问题。称为水平扩展。"),n("li",null,"关系型数据库因为表之间存在关联关系，如果做水平扩展会给数据查询带来很多麻烦")])])],-1)),l[44]||(l[44]=n("hr",null,null,-1)),l[45]||(l[45]=n("h4",{id:"_1-2-认识-redis",tabindex:"-1"},[E("1.2 认识 Redis "),n("a",{class:"header-anchor",href:"#_1-2-认识-redis","aria-label":'Permalink to "1.2 认识 Redis"'},"​")],-1)),l[46]||(l[46]=n("p",null,[E("Redis诞生于2009年全称是"),n("strong",null,"Re"),E("mote "),n("strong",null,"D"),E("ictionary "),n("strong",null,"S"),E("erver 远程词典服务器，是一个基于内存的键值型NoSQL数据库。")],-1)),l[47]||(l[47]=n("p",null,[n("strong",null,"特征"),E("：")],-1)),l[48]||(l[48]=n("ul",null,[n("li",null,"键值（key-value）型，value支持多种不同数据结构，功能丰富"),n("li",null,"单线程，每个命令具备原子性"),n("li",null,"低延迟，速度快（基于内存、IO多路复用、良好的编码）。"),n("li",null,"支持数据持久化"),n("li",null,"支持主从集群、分片集群"),n("li",null,"支持多语言客户端")],-1)),l[49]||(l[49]=n("p",null,[n("strong",null,"作者"),E("：Antirez")],-1)),l[50]||(l[50]=n("p",null,[E("Redis的官方网站地址："),n("a",{href:"https://redis.io/",target:"_blank",rel:"noreferrer"},"https://redis.io/")],-1)),l[51]||(l[51]=n("hr",null,null,-1)),l[52]||(l[52]=n("h4",{id:"_1-3-安装-redis",tabindex:"-1"},[E("1.3 安装 Redis "),n("a",{class:"header-anchor",href:"#_1-3-安装-redis","aria-label":'Permalink to "1.3 安装 Redis"'},"​")],-1)),l[53]||(l[53]=n("p",null,"大多数企业都是基于Linux服务器来部署项目，而且Redis官方也没有提供Windows版本的安装包。因此课程中我们会基于Linux系统来安装Redis.",-1)),l[54]||(l[54]=n("p",null,"此处选择的Linux版本为CentOS 7.",-1)),l[55]||(l[55]=n("h5",{id:"_1-3-1-依赖库",tabindex:"-1"},[E("1.3.1 依赖库 "),n("a",{class:"header-anchor",href:"#_1-3-1-依赖库","aria-label":'Permalink to "1.3.1 依赖库"'},"​")],-1)),l[56]||(l[56]=n("p",null,"Redis是基于C语言编写的，因此首先需要安装Redis所需要的gcc依赖：",-1)),l[57]||(l[57]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"yum"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -y"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," gcc"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," tcl")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[58]||(l[58]=n("h5",{id:"_1-3-2-上传安装包并解压",tabindex:"-1"},[E("1.3.2 上传安装包并解压 "),n("a",{class:"header-anchor",href:"#_1-3-2-上传安装包并解压","aria-label":'Permalink to "1.3.2 上传安装包并解压"'},"​")],-1)),l[59]||(l[59]=n("p",null,"然后将课前资料提供的Redis安装包上传到虚拟机的任意目录：",-1)),l[60]||(l[60]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/SyjanS5.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[61]||(l[61]=n("p",null,[E("例如，我放到了"),n("code",null,"/usr/local/src"),E(" 目录：")],-1)),l[62]||(l[62]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/01DTNCf.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[63]||(l[63]=n("p",null,"解压缩：",-1)),l[64]||(l[64]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tar"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -xzf"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis-6.2.6.tar.gz")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[65]||(l[65]=n("p",null,"解压后：",-1)),l[66]||(l[66]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/8V6zvCD.png",alt:"image-20211211080339076",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[67]||(l[67]=n("p",null,"进入redis目录：",-1)),l[68]||(l[68]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis-6.2.6")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[69]||(l[69]=n("p",null,"运行编译命令：",-1)),l[70]||(l[70]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"make"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," && "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"make"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[71]||(l[71]=n("p",null,"如果没有出错，应该就安装成功了。",-1)),l[72]||(l[72]=n("p",null,[E("默认的安装路径是在 "),n("code",null,"/usr/local/bin"),E("目录下：")],-1)),l[73]||(l[73]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251204153339523.png",alt:"image-20251204153339523",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[74]||(l[74]=n("p",null,"该目录已经默认配置到环境变量，因此可以在任意目录下运行这些命令。其中：",-1)),l[75]||(l[75]=n("ul",null,[n("li",null,"redis-cli：是redis提供的命令行客户端"),n("li",null,"redis-server：是redis的服务端启动脚本"),n("li",null,"redis-sentinel：是redis的哨兵启动脚本")],-1)),l[76]||(l[76]=n("h5",{id:"_1-3-3-启动",tabindex:"-1"},[E("1.3.3 启动 "),n("a",{class:"header-anchor",href:"#_1-3-3-启动","aria-label":'Permalink to "1.3.3 启动"'},"​")],-1)),l[77]||(l[77]=n("p",null,"redis的启动方式有很多种，例如：",-1)),l[78]||(l[78]=n("ul",null,[n("li",null,"默认启动"),n("li",null,"指定配置启动"),n("li",null,"开机自启")],-1)),l[79]||(l[79]=n("h5",{id:"_1-3-4-默认启动",tabindex:"-1"},[E("1.3.4 默认启动 "),n("a",{class:"header-anchor",href:"#_1-3-4-默认启动","aria-label":'Permalink to "1.3.4 默认启动"'},"​")],-1)),l[80]||(l[80]=n("p",null,"安装完成后，在任意目录输入redis-server命令即可启动Redis：",-1)),l[81]||(l[81]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-server")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[82]||(l[82]=n("p",null,"如图：",-1)),l[83]||(l[83]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/v7xWsqC.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[84]||(l[84]=n("p",null,[E("这种启动属于"),n("code",null,"前台启动"),E("，会阻塞整个会话窗口，窗口关闭或者按下"),n("code",null,"CTRL + C"),E("则Redis停止。不推荐使用。")],-1)),l[85]||(l[85]=n("h5",{id:"_1-3-5-指定配置启动",tabindex:"-1"},[E("1.3.5 指定配置启动 "),n("a",{class:"header-anchor",href:"#_1-3-5-指定配置启动","aria-label":'Permalink to "1.3.5 指定配置启动"'},"​")],-1)),l[86]||(l[86]=n("p",null,[E("如果要让Redis以"),n("code",null,"后台"),E("方式启动，则必须修改Redis配置文件，就在我们之前解压的redis安装包下（"),n("code",null,"/usr/local/src/redis-6.2.6"),E("），名字叫redis.conf：")],-1)),l[87]||(l[87]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20211211082225509.png",alt:"image-20211211082225509",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[88]||(l[88]=n("p",null,"我们先将这个配置文件备份一份：",-1)),l[89]||(l[89]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis.conf"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis.conf.bck")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[90]||(l[90]=n("p",null,"然后修改redis.conf文件中的一些配置：",-1)),l[91]||(l[91]=n("div",{class:"language-properties max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"properties"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 允许访问的地址，默认是127.0.0.1，会导致只能在本地访问。修改为0.0.0.0则可以在任意IP访问，生产环境不要设置为0.0.0.0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"bind 0.0.0.0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 守护进程，修改为yes后即可后台运行")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"daemonize yes ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 密码，设置后访问Redis必须输入密码")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"requirepass 123321")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[92]||(l[92]=n("p",null,"Redis的其它常见配置：",-1)),l[93]||(l[93]=n("div",{class:"language-properties max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"properties"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 监听的端口")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"port 6379")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 工作目录，默认是当前目录，也就是运行redis-server时的命令，日志、持久化等文件会保存在这个目录")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dir .")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 数据库数量，设置为1，代表只使用1个库，默认有16个库，编号0~15")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"databases 1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 设置redis能够使用的最大内存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"maxmemory 512mb")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 日志文件，默认为空，不记录日志，可以指定日志文件名")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"logfile "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis.log"')])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[94]||(l[94]=n("p",null,"启动Redis：",-1)),l[95]||(l[95]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 进入redis安装目录 ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /usr/local/src/redis-6.2.6")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 启动")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-server"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis.conf")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[96]||(l[96]=n("p",null,"停止服务：",-1)),l[97]||(l[97]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 利用redis-cli来执行 shutdown 命令，即可停止 Redis 服务，")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 因为之前配置了密码，因此需要通过 -u 来指定密码")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 123321"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," shutdown")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[98]||(l[98]=n("h5",{id:"_1-3-6-开机自启",tabindex:"-1"},[E("1.3.6 开机自启 "),n("a",{class:"header-anchor",href:"#_1-3-6-开机自启","aria-label":'Permalink to "1.3.6 开机自启"'},"​")],-1)),l[99]||(l[99]=n("p",null,"我们也可以通过配置来实现开机自启。",-1)),l[100]||(l[100]=n("p",null,"首先，新建一个系统服务文件：",-1)),l[101]||(l[101]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vi"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/systemd/system/redis.service")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[102]||(l[102]=n("p",null,"内容如下：",-1)),l[103]||(l[103]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[Unit]")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Description"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"redis-server")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"After"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"network.target")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[Service]")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Type"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"forking")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ExecStart"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/usr/local/bin/redis-server"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," /usr/local/src/redis-6.2.6/redis.conf")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"PrivateTmp"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"true")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[Install]")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"WantedBy"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"multi-user.target")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[104]||(l[104]=n("p",null,"然后重载系统服务：",-1)),l[105]||(l[105]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," daemon-reload")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[106]||(l[106]=n("p",null,"现在，我们可以用下面这组命令来操作redis了：",-1)),l[107]||(l[107]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 启动")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," start"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 停止")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 重启")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," restart"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 查看状态")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," status"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[108]||(l[108]=n("p",null,"执行下面的命令，可以让redis开机自启：",-1)),l[109]||(l[109]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," enable"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[110]||(l[110]=n("hr",null,null,-1)),l[111]||(l[111]=n("h4",{id:"_1-4-redis-桌面客户端",tabindex:"-1"},[E("1.4 Redis 桌面客户端 "),n("a",{class:"header-anchor",href:"#_1-4-redis-桌面客户端","aria-label":'Permalink to "1.4 Redis 桌面客户端"'},"​")],-1)),l[112]||(l[112]=n("p",null,"安装完成Redis，我们就可以操作Redis，实现数据的CRUD了。这需要用到Redis客户端，包括：",-1)),l[113]||(l[113]=n("ul",null,[n("li",null,"命令行客户端"),n("li",null,"图形化桌面客户端"),n("li",null,"编程客户端")],-1)),l[114]||(l[114]=n("h5",{id:"_1-4-1-redis-命令行客户端",tabindex:"-1"},[E("1.4.1 Redis 命令行客户端 "),n("a",{class:"header-anchor",href:"#_1-4-1-redis-命令行客户端","aria-label":'Permalink to "1.4.1 Redis 命令行客户端"'},"​")],-1)),l[115]||(l[115]=n("p",null,"Redis安装完成后就自带了命令行客户端：redis-cli，使用方式如下：",-1)),l[116]||(l[116]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," [options] [commonds]")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[117]||(l[117]=n("p",null,"其中常见的options有：",-1)),l[118]||(l[118]=n("ul",null,[n("li",null,[n("code",null,"-h 127.0.0.1"),E("：指定要连接的redis节点的IP地址，默认是127.0.0.1")]),n("li",null,[n("code",null,"-p 6379"),E("：指定要连接的redis节点的端口，默认是6379")]),n("li",null,[n("code",null,"-a 123321"),E("：指定redis的访问密码")])],-1)),l[119]||(l[119]=n("p",null,"其中的commonds就是Redis的操作命令，例如：",-1)),l[120]||(l[120]=n("ul",null,[n("li",null,[n("code",null,"ping"),E("：与redis服务端做心跳测试，服务端正常会返回"),n("code",null,"pong")])],-1)),l[121]||(l[121]=n("p",null,[E("不指定commond时，会进入"),n("code",null,"redis-cli"),E("的交互控制台：")],-1)),l[122]||(l[122]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/OYYWPNo.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[123]||(l[123]=n("h5",{id:"_1-4-2-图形化桌面客户端",tabindex:"-1"},[E("1.4.2 图形化桌面客户端 "),n("a",{class:"header-anchor",href:"#_1-4-2-图形化桌面客户端","aria-label":'Permalink to "1.4.2 图形化桌面客户端"'},"​")],-1)),l[124]||(l[124]=n("p",null,[E("GitHub上的大神编写了Redis的图形化桌面客户端，地址："),n("a",{href:"https://github.com/uglide/RedisDesktopManager",target:"_blank",rel:"noreferrer"},"https://github.com/uglide/RedisDesktopManager")],-1)),l[125]||(l[125]=n("p",null,"不过该仓库提供的是RedisDesktopManager的源码，并未提供windows安装包。",-1)),l[126]||(l[126]=n("p",null,[E("在下面这个仓库可以找到安装包："),n("a",{href:"https://github.com/lework/RedisDesktopManager-Windows/releases",target:"_blank",rel:"noreferrer"},"https://github.com/lework/RedisDesktopManager-Windows/releases")],-1)),l[127]||(l[127]=n("h5",{id:"_1-4-3-安装",tabindex:"-1"},[E("1.4.3 安装 "),n("a",{class:"header-anchor",href:"#_1-4-3-安装","aria-label":'Permalink to "1.4.3 安装"'},"​")],-1)),l[128]||(l[128]=n("p",null,"在课前资料中可以找到Redis的图形化桌面客户端：",-1)),l[129]||(l[129]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/BZ4Agbi.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[130]||(l[130]=n("p",null,"解压缩后，运行安装程序即可安装：",-1)),l[131]||(l[131]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/hguGHbX.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[132]||(l[132]=n("p",null,"安装完成后，在安装目录下找到rdm.exe文件：",-1)),l[133]||(l[133]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/hwK5LQ8.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[134]||(l[134]=n("p",null,"双击即可运行：",-1)),l[135]||(l[135]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/6hUqslY.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[136]||(l[136]=n("h5",{id:"_1-4-4-建立连接",tabindex:"-1"},[E("1.4.4 建立连接 "),n("a",{class:"header-anchor",href:"#_1-4-4-建立连接","aria-label":'Permalink to "1.4.4 建立连接"'},"​")],-1)),l[137]||(l[137]=n("p",null,[E("点击左上角的"),n("code",null,"连接到Redis服务器"),E("按钮：")],-1)),l[138]||(l[138]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/9qTGyoN.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[139]||(l[139]=n("p",null,"在弹出的窗口中填写Redis服务信息：",-1)),l[140]||(l[140]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/DshNnKC.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[141]||(l[141]=n("p",null,"点击确定后，在左侧菜单会出现这个链接：",-1)),l[142]||(l[142]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/A2cOm7Q.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[143]||(l[143]=n("p",null,"点击即可建立连接了。",-1)),l[144]||(l[144]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/ja8Fd9s.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[145]||(l[145]=n("p",null,"Redis默认有16个仓库，编号从0至15. 通过配置文件可以设置仓库数量，但是不超过16，并且不能自定义仓库名称。",-1)),l[146]||(l[146]=n("p",null,"如果是基于redis-cli连接Redis服务，可以通过select命令来选择数据库：",-1)),l[147]||(l[147]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 选择 0号库")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"select"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 0")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[148]||(l[148]=n("hr",null,null,-1)),l[149]||(l[149]=n("h3",{id:"_2-redis-常见命令",tabindex:"-1"},[E("2. Redis 常见命令 "),n("a",{class:"header-anchor",href:"#_2-redis-常见命令","aria-label":'Permalink to "2. Redis 常见命令"'},"​")],-1)),l[150]||(l[150]=n("p",null,"Redis是典型的key-value数据库，key一般是字符串，而value包含很多不同的数据类型：",-1)),l[151]||(l[151]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/8tli2o9.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[152]||(l[152]=n("p",null,[E("Redis为了方便我们学习，将操作不同数据类型的命令也做了分组，在官网（ "),n("a",{href:"https://redis.io/commands",target:"_blank",rel:"noreferrer"},"https://redis.io/commands "),E("）可以查看到不同的命令：")],-1)),l[153]||(l[153]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/5Lcr3BE.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[154]||(l[154]=n("p",null,"不同类型的命令称为一个group，我们也可以通过help命令来查看各种不同group的命令：",-1)),l[155]||(l[155]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/suevOIR.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[156]||(l[156]=n("p",null,"接下来，我们就学习常见的五种基本数据类型的相关命令。",-1)),l[157]||(l[157]=n("h4",{id:"_2-1-redis-通用命令",tabindex:"-1"},[E("2.1 Redis 通用命令 "),n("a",{class:"header-anchor",href:"#_2-1-redis-通用命令","aria-label":'Permalink to "2.1 Redis 通用命令"'},"​")],-1)),l[158]||(l[158]=n("p",null,"通用指令是部分数据类型的，都可以使用的指令，常见的有：",-1)),l[159]||(l[159]=n("ul",null,[n("li",null,"KEYS：查看符合模板的所有key"),n("li",null,"DEL：删除一个指定的key"),n("li",null,"EXISTS：判断key是否存在"),n("li",null,"EXPIRE：给一个key设置有效期，有效期到期时该key会被自动删除"),n("li",null,"TTL：查看一个KEY的剩余有效期")],-1)),l[160]||(l[160]=n("p",null,[E("通过"),n("code",null,"help [command]"),E(" 可以查看一个命令的具体用法，例如：")],-1)),l[161]||(l[161]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 查看keys命令的帮助信息：")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"127.0.0.1:6379"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"help"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," keys")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"KEYS"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," pattern")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"summary:"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Find"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," all"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," keys"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," matching"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," the"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," given"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," pattern")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"since:"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1.0.0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"group:"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," generic")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[162]||(l[162]=n("h4",{id:"_2-2-string-类型",tabindex:"-1"},[E("2.2 String 类型 "),n("a",{class:"header-anchor",href:"#_2-2-string-类型","aria-label":'Permalink to "2.2 String 类型"'},"​")],-1)),l[163]||(l[163]=n("p",null,"String类型，也就是字符串类型，是Redis中最简单的存储类型。",-1)),l[164]||(l[164]=n("p",null,"其value是字符串，不过根据字符串的格式不同，又可以分为3类：",-1)),l[165]||(l[165]=n("ul",null,[n("li",null,"string：普通字符串"),n("li",null,"int：整数类型，可以做自增、自减操作"),n("li",null,"float：浮点类型，可以做自增、自减操作")],-1)),l[166]||(l[166]=n("p",null,"不管是哪种格式，底层都是字节数组形式存储，只不过是编码方式不同。字符串类型的最大空间不能超过512m.",-1)),l[167]||(l[167]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/VZqpv73.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[168]||(l[168]=n("h5",{id:"_2-2-1-string-的常见命令",tabindex:"-1"},[E("2.2.1 String 的常见命令 "),n("a",{class:"header-anchor",href:"#_2-2-1-string-的常见命令","aria-label":'Permalink to "2.2.1 String 的常见命令"'},"​")],-1)),l[169]||(l[169]=n("p",null,"String的常见命令有：",-1)),l[170]||(l[170]=n("ul",null,[n("li",null,"SET：添加或者修改已经存在的一个String类型的键值对"),n("li",null,"GET：根据key获取String类型的value"),n("li",null,"MSET：批量添加多个String类型的键值对"),n("li",null,"MGET：根据多个key获取多个String类型的value"),n("li",null,"INCR：让一个整型的key自增1"),n("li",null,"INCRBY:让一个整型的key自增并指定步长，例如：incrby num 2 让num值自增2"),n("li",null,"INCRBYFLOAT：让一个浮点类型的数字自增并指定步长"),n("li",null,"SETNX：添加一个String类型的键值对，前提是这个key不存在，否则不执行"),n("li",null,"SETEX：添加一个String类型的键值对，并且指定有效期")],-1)),l[171]||(l[171]=n("h5",{id:"_2-2-2-key-结构",tabindex:"-1"},[E("2.2.2 Key 结构 "),n("a",{class:"header-anchor",href:"#_2-2-2-key-结构","aria-label":'Permalink to "2.2.2 Key 结构"'},"​")],-1)),l[172]||(l[172]=n("p",null,"Redis没有类似MySQL中的Table的概念，我们该如何区分不同类型的key呢？",-1)),l[173]||(l[173]=n("p",null,"例如，需要存储用户、商品信息到redis，有一个用户id是1，有一个商品id恰好也是1，此时如果使用id作为key，那就会冲突了，该怎么办？",-1)),l[174]||(l[174]=n("p",null,"我们可以通过给key添加前缀加以区分，不过这个前缀不是随便加的，有一定的规范：",-1)),l[175]||(l[175]=n("p",null,"Redis的key允许有多个单词形成层级结构，多个单词之间用’:'隔开，格式如下：",-1)),l[176]||(l[176]=n("div",{class:"language-tcl max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"tcl"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t项目名:业务名:类型:id")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[177]||(l[177]=n("p",null,"这个格式并非固定，也可以根据自己的需求来删除或添加词条。这样以来，我们就可以把不同类型的数据区分开了。从而避免了key的冲突问题。",-1)),l[178]||(l[178]=n("p",null,"例如我们的项目名称叫 heima，有user和product两种不同类型的数据，我们可以这样定义key：",-1)),l[179]||(l[179]=n("ul",null,[n("li",null,[n("p",null,[E("user相关的key："),n("strong",null,"heima:user:1")])]),n("li",null,[n("p",null,[E("product相关的key："),n("strong",null,"heima:product:1")])])],-1)),l[180]||(l[180]=n("p",null,"如果Value是一个Java对象，例如一个User对象，则可以将对象序列化为JSON字符串后存储：",-1)),l[181]||(l[181]=n("table",null,[n("thead",null,[n("tr",null,[n("th",null,[n("strong",null,"KEY")]),n("th",null,[n("strong",null,"VALUE")])])]),n("tbody",null,[n("tr",null,[n("td",null,[n("code",null,"heima:user:1")]),n("td",null,[n("code",null,'{"id":1, "name": "Jack", "age": 21}')])]),n("tr",null,[n("td",null,[n("code",null,"heima:product:1")]),n("td",null,[n("code",null,'{"id":1, "name": "小米11", "price": 4999}')])])])],-1)),l[182]||(l[182]=n("p",null,"并且，在Redis的桌面客户端中，还会以相同前缀作为层级结构，让数据看起来层次分明，关系清晰：",-1)),l[183]||(l[183]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/InWMfeD.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[184]||(l[184]=n("h4",{id:"_2-3-hash-类型",tabindex:"-1"},[E("2.3 Hash 类型 "),n("a",{class:"header-anchor",href:"#_2-3-hash-类型","aria-label":'Permalink to "2.3 Hash 类型"'},"​")],-1)),l[185]||(l[185]=n("p",null,"Hash类型，也叫散列，其value是一个无序字典，类似于Java中的HashMap结构。",-1)),l[186]||(l[186]=n("p",null,"String结构是将对象序列化为JSON字符串后存储，当需要修改对象某个字段时很不方便：",-1)),l[187]||(l[187]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/x2zDBjf.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[188]||(l[188]=n("p",null,"Hash结构可以将对象中的每个字段独立存储，可以针对单个字段做CRUD：",-1)),l[189]||(l[189]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/VF2EPt0.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[190]||(l[190]=n("p",null,"Hash的常见命令有：",-1)),l[191]||(l[191]=n("ul",null,[n("li",null,[n("p",null,"HSET key field value：添加或者修改hash类型key的field的值")]),n("li",null,[n("p",null,"HGET key field：获取一个hash类型key的field的值")]),n("li",null,[n("p",null,"HMSET：批量添加多个hash类型key的field的值")]),n("li",null,[n("p",null,"HMGET：批量获取多个hash类型key的field的值")]),n("li",null,[n("p",null,"HGETALL：获取一个hash类型的key中的所有的field和value")]),n("li",null,[n("p",null,"HKEYS：获取一个hash类型的key中的所有的field")]),n("li",null,[n("p",null,"HINCRBY:让一个hash类型key的字段值自增并指定步长")]),n("li",null,[n("p",null,"HSETNX：添加一个hash类型的key的field值，前提是这个field不存在，否则不执行")])],-1)),l[192]||(l[192]=n("p",null,[n("code",null,"HSET klaus:user:3 name Lucy")],-1)),l[193]||(l[193]=n("p",null,[n("code",null,"HSET klaus:user:3 age 23")],-1)),l[194]||(l[194]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505013039825.png",alt:"image-20230505013039825",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[195]||(l[195]=n("h4",{id:"_2-4-list-类型",tabindex:"-1"},[E("2.4 List 类型 "),n("a",{class:"header-anchor",href:"#_2-4-list-类型","aria-label":'Permalink to "2.4 List 类型"'},"​")],-1)),l[196]||(l[196]=n("p",null,"Redis中的List类型与Java中的LinkedList类似，可以看做是一个双向链表结构。既可以支持正向检索和也可以支持反向检索。",-1)),l[197]||(l[197]=n("p",null,"特征也与LinkedList类似：",-1)),l[198]||(l[198]=n("ul",null,[n("li",null,"有序"),n("li",null,"元素可以重复"),n("li",null,"插入和删除快"),n("li",null,"查询速度一般")],-1)),l[199]||(l[199]=n("p",null,"常用来存储一个有序数据，例如：朋友圈点赞列表，评论列表等。",-1)),l[200]||(l[200]=n("p",null,"List的常见命令有：",-1)),l[201]||(l[201]=n("ul",null,[n("li",null,[n("code",null,"LPUSH key element ..."),E(" ：向列表左侧插入一个或多个元素")]),n("li",null,"LPOP key：移除并返回列表左侧的第一个元素，没有则返回nil"),n("li",null,[n("code",null,"RPUSH key element ..."),E(" ：向列表右侧插入一个或多个元素")]),n("li",null,"RPOP key：移除并返回列表右侧的第一个元素"),n("li",null,[n("code",null,"LRANGE key star end"),E("：返回一段角标范围内的所有元素")])],-1)),l[202]||(l[202]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505013249460.png",alt:"image-20230505013249460",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[203]||(l[203]=n("ul",null,[n("li",null,"BLPOP和BRPOP：与LPOP和RPOP类似，只不过在没有元素时等待指定时间，而不是直接返回nil")],-1)),l[204]||(l[204]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505013146760.png",alt:"image-20230505013146760",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[205]||(l[205]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505013214995.png",alt:"image-20230505013214995",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[206]||(l[206]=n("h4",{id:"_2-5-set-类型",tabindex:"-1"},[E("2.5 Set 类型 "),n("a",{class:"header-anchor",href:"#_2-5-set-类型","aria-label":'Permalink to "2.5 Set 类型"'},"​")],-1)),l[207]||(l[207]=n("p",null,"Redis的Set结构与Java中的HashSet类似，可以看做是一个value为null的HashMap。因为也是一个hash表，因此具备与HashSet类似的特征：",-1)),l[208]||(l[208]=n("ul",null,[n("li",null,[n("p",null,"无序")]),n("li",null,[n("p",null,"元素不可重复")]),n("li",null,[n("p",null,"查找快")]),n("li",null,[n("p",null,"支持交集、并集、差集等功能")])],-1)),l[209]||(l[209]=n("p",null,"Set的常见命令有：",-1)),l[210]||(l[210]=n("ul",null,[n("li",null,[n("code",null,"SADD key member ..."),E(" ：向set中添加一个或多个元素")]),n("li",null,[n("code",null,"SREM key member ..."),E(" : 移除set中的指定元素")]),n("li",null,"SCARD key： 返回set中元素的个数"),n("li",null,[n("code",null,"SISMEMBER key member"),E("：判断一个元素是否存在于set中")]),n("li",null,"SMEMBERS：获取set中的所有元素"),n("li",null,[n("code",null,"SINTER key1 key2 ..."),E(" ：求key1与key2的交集")]),n("li",null,[n("code",null,"SDIFF key1 key2 ..."),E(" ：求key1与key2的差集")]),n("li",null,[n("code",null,"SUNION key1 key2 ..."),E(" ：求key1与key2的并集")])],-1)),l[211]||(l[211]=n("p",null,"例如两个集合：s1和s2:",-1)),l[212]||(l[212]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/ha8x86R.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[213]||(l[213]=n("p",null,[E("求交集："),n("code",null,"SINTER s1 s2")],-1)),l[214]||(l[214]=n("p",null,[E("求s1与s2的不同："),n("code",null,"SDIFF s1 s2")],-1)),l[215]||(l[215]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/L9vTv2X.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[216]||(l[216]=n("p",null,"练习：",-1)),l[217]||(l[217]=n("ol",null,[n("li",null,"将下列数据用Redis的Set集合来存储：")],-1)),l[218]||(l[218]=n("ul",null,[n("li",null,"张三的好友有：李四、王五、赵六"),n("li",null,"李四的好友有：王五、麻子、二狗")],-1)),l[219]||(l[219]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505011809735.png",alt:"image-20230505011809735",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[220]||(l[220]=n("ol",{start:"2"},[n("li",null,"利用Set的命令实现下列功能：")],-1)),l[221]||(l[221]=n("ul",null,[n("li",null,"计算张三的好友有几人")],-1)),l[222]||(l[222]=n("p",null,"SCARD zs",-1)),l[223]||(l[223]=n("ul",null,[n("li",null,"计算张三和李四有哪些共同好友")],-1)),l[224]||(l[224]=n("p",null,"SINTER zs ls",-1)),l[225]||(l[225]=n("ul",null,[n("li",null,"查询哪些人是张三的好友却不是李四的好友")],-1)),l[226]||(l[226]=n("p",null,"SDIFF zs ls",-1)),l[227]||(l[227]=n("ul",null,[n("li",null,"查询张三和李四的好友总共有哪些人")],-1)),l[228]||(l[228]=n("p",null,"SUNION zs ls",-1)),l[229]||(l[229]=n("ul",null,[n("li",null,"判断李四是否是张三的好友")],-1)),l[230]||(l[230]=n("p",null,"SISMEMBER zs lisi",-1)),l[231]||(l[231]=n("ul",null,[n("li",null,"判断张三是否是李四的好友")],-1)),l[232]||(l[232]=n("p",null,"SISMEMBER ls zhangsan",-1)),l[233]||(l[233]=n("ul",null,[n("li",null,"将李四从张三的好友列表中移除")],-1)),l[234]||(l[234]=n("p",null,"SREM zs lisi",-1)),l[235]||(l[235]=n("h4",{id:"_2-6-sortedset-类型",tabindex:"-1"},[E("2.6 SortedSet 类型 "),n("a",{class:"header-anchor",href:"#_2-6-sortedset-类型","aria-label":'Permalink to "2.6 SortedSet 类型"'},"​")],-1)),l[236]||(l[236]=n("p",null,"Redis的SortedSet是一个可排序的set集合，与Java中的TreeSet有些类似，但底层数据结构却差别很大。SortedSet中的每一个元素都带有一个score属性，可以基于score属性对元素排序，底层的实现是一个跳表（SkipList）加 hash表。",-1)),l[237]||(l[237]=n("p",null,"SortedSet具备下列特性：",-1)),l[238]||(l[238]=n("ul",null,[n("li",null,"可排序"),n("li",null,"元素不重复"),n("li",null,"查询速度快")],-1)),l[239]||(l[239]=n("p",null,"因为SortedSet的可排序特性，经常被用来实现排行榜这样的功能。",-1)),l[240]||(l[240]=n("p",null,"SortedSet的常见命令有：",-1)),l[241]||(l[241]=n("ul",null,[n("li",null,"ZADD key score member：添加一个或多个元素到sorted set ，如果已经存在则更新其score值"),n("li",null,"ZREM key member：删除sorted set中的一个指定元素"),n("li",null,"ZSCORE key member : 获取sorted set中的指定元素的score值"),n("li",null,"ZRANK key member：获取sorted set 中的指定元素的排名"),n("li",null,"ZCARD key：获取sorted set中的元素个数"),n("li",null,"ZCOUNT key min max：统计score值在给定范围内的所有元素的个数"),n("li",null,"ZINCRBY key increment member：让sorted set中的指定元素自增，步长为指定的increment值"),n("li",null,"ZRANGE key min max：按照score排序后，获取指定排名范围内的元素"),n("li",null,"ZRANGEBYSCORE key min max：按照score排序后，获取指定score范围内的元素"),n("li",null,"ZDIFF、ZINTER、ZUNION：求差集、交集、并集")],-1)),l[242]||(l[242]=n("p",null,"注意：所有的排名默认都是升序，如果要降序则在命令的Z后面添加REV即可，例如：",-1)),l[243]||(l[243]=n("ul",null,[n("li",null,[n("p",null,[n("strong",null,"升序"),E("获取sorted set 中的指定元素的排名：ZRANK key member")])]),n("li",null,[n("p",null,[n("strong",null,"降序"),E("获取sorted set 中的指定元素的排名：ZREVRANK key memeber")])])],-1)),l[244]||(l[244]=n("p",null,"练习题：",-1)),l[245]||(l[245]=n("p",null,"将班级的下列学生得分存入Redis的SortedSet中：",-1)),l[246]||(l[246]=n("p",null,"Jack 85, Lucy 89, Rose 82, Tom 95, Jerry 78, Amy 92, Miles 76",-1)),l[247]||(l[247]=n("div",{class:"language-shell max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"shell"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ZADD"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stus"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 85"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Jack"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 89"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Lucy"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 82"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Rose"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 95"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Tom"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 78"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Jerry"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 92"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Amy"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 76"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Miles")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[248]||(l[248]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505010557819.png",alt:"image-20230505010557819",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[249]||(l[249]=n("p",null,"并实现下列功能：",-1)),l[250]||(l[250]=n("ul",null,[n("li",null,"删除Tom同学")],-1)),l[251]||(l[251]=n("p",null,"ZREM stus Tom",-1)),l[252]||(l[252]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505010832672.png",alt:"image-20230505010832672",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[253]||(l[253]=n("ul",null,[n("li",null,"获取Amy同学的分数")],-1)),l[254]||(l[254]=n("p",null,"ZSCORE stus Amy",-1)),l[255]||(l[255]=n("ul",null,[n("li",null,"获取Rose同学的排名")],-1)),l[256]||(l[256]=n("p",null,"ZRANK stus Rose",-1)),l[257]||(l[257]=n("p",null,"ZREVRANK stus Rose",-1)),l[258]||(l[258]=n("ul",null,[n("li",null,"查询80分以下有几个学生")],-1)),l[259]||(l[259]=n("p",null,"ZCOUNT stus 0 80",-1)),l[260]||(l[260]=n("ul",null,[n("li",null,"给Amy同学加2分")],-1)),l[261]||(l[261]=n("p",null,"ZINCRBY stus 2 Amy",-1)),l[262]||(l[262]=n("ul",null,[n("li",null,"查出成绩前3名的同学")],-1)),l[263]||(l[263]=n("p",null,"ZREVRANGE stus 0 2",-1)),l[264]||(l[264]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505011317949.png",alt:"image-20230505011317949",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[265]||(l[265]=n("ul",null,[n("li",null,"查出成绩80分以下的所有同学")],-1)),l[266]||(l[266]=n("p",null,"ZRANGEBYSCORE stus 0 80",-1)),l[267]||(l[267]=n("hr",null,null,-1)),l[268]||(l[268]=n("h3",{id:"_3-redis-的-java-客户端",tabindex:"-1"},[E("3. Redis 的 Java 客户端 "),n("a",{class:"header-anchor",href:"#_3-redis-的-java-客户端","aria-label":'Permalink to "3. Redis 的 Java 客户端"'},"​")],-1)),l[269]||(l[269]=n("p",null,[E("在Redis官网中提供了各种语言的客户端，地址："),n("a",{href:"https://redis.io/docs/clients/",target:"_blank",rel:"noreferrer"},"https://redis.io/docs/clients/")],-1)),l[270]||(l[270]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/9f68ivq.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[271]||(l[271]=n("p",null,"其中Java客户端也包含很多：",-1)),l[272]||(l[272]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220609102817435-165735883948534.png",alt:"image-20220609102817435",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[273]||(l[273]=n("p",null,"标记为*的就是推荐使用的java客户端，包括：",-1)),l[274]||(l[274]=n("ul",null,[n("li",null,"Jedis和Lettuce：这两个主要是提供了Redis命令对应的API，方便我们操作Redis，而SpringDataRedis又对这两种做了抽象和封装，因此我们后期会直接以SpringDataRedis来学习。"),n("li",null,"Redisson：是在Redis基础上实现了分布式的可伸缩的java数据结构，例如Map、Queue等，而且支持跨进程的同步机制：Lock、Semaphore等待，比较适合用来实现特殊的功能需求。")],-1)),l[275]||(l[275]=n("hr",null,null,-1)),l[276]||(l[276]=n("h4",{id:"_3-1-jedis客户端",tabindex:"-1"},[E("3.1 Jedis客户端 "),n("a",{class:"header-anchor",href:"#_3-1-jedis客户端","aria-label":'Permalink to "3.1 Jedis客户端"'},"​")],-1)),l[277]||(l[277]=n("p",null,[E("Jedis的官网地址： "),n("a",{href:"https://github.com/redis/jedis",target:"_blank",rel:"noreferrer"},"https://github.com/redis/jedis")],-1)),l[278]||(l[278]=n("h5",{id:"_3-1-1-快速入门",tabindex:"-1"},[E("3.1.1 快速入门 "),n("a",{class:"header-anchor",href:"#_3-1-1-快速入门","aria-label":'Permalink to "3.1.1 快速入门"'},"​")],-1)),l[279]||(l[279]=n("p",null,"我们先来个快速入门：",-1)),l[280]||(l[280]=n("p",null,"1）引入依赖：",-1)),l[281]||(l[281]=n("div",{class:"language-xml max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"xml"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\x3c!--jedis--\x3e")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">redis.clients</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">jedis</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">3.7.0</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\x3c!--单元测试--\x3e")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.junit.jupiter</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">junit-jupiter</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">5.7.0</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"scope"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">test</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"scope"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[282]||(l[282]=n("p",null,"2）建立连接",-1)),l[283]||(l[283]=n("p",null,"新建一个单元测试类，内容如下：",-1)),l[284]||(l[284]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Jedis jedis;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"BeforeEach")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setUp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.建立连接")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'    // jedis = new Jedis("192.168.150.101", 6379);')]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    jedis "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JedisConnectionFactory."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getJedis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.设置密码")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    jedis."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"auth"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.选择库")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    jedis."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"select"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[285]||(l[285]=n("p",null,"3）测试：",-1)),l[286]||(l[286]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 存入数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"虎哥"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"result = "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String name "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name = "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testHash"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 插入hash数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    jedis."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hset"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user:1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Jack"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    jedis."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hset"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user:1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"age"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"21"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hgetAll"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user:1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[287]||(l[287]=n("p",null,"4）释放资源",-1)),l[288]||(l[288]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"AfterEach")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tearDown"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (jedis "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedis."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[289]||(l[289]=n("h5",{id:"_3-1-2-连接池",tabindex:"-1"},[E("3.1.2 连接池 "),n("a",{class:"header-anchor",href:"#_3-1-2-连接池","aria-label":'Permalink to "3.1.2 连接池"'},"​")],-1)),l[290]||(l[290]=n("p",null,"Jedis本身是线程不安全的，并且频繁的创建和销毁连接会有性能损耗，因此我们推荐大家使用Jedis连接池代替Jedis的直连方式。",-1)),l[291]||(l[291]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.jedis.util;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis.clients.jedis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"*"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JedisConnectionFactory"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JedisPool jedisPool;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 配置连接池")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        JedisPoolConfig poolConfig "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JedisPoolConfig"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMaxTotal"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMaxIdle"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMinIdle"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMaxWaitMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建连接池对象，参数：连接池配置、服务端ip、服务端端口、超时时间、密码")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedisPool "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JedisPool"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(poolConfig, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Jedis "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getJedis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedisPool."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getResource"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[292]||(l[292]=n("hr",null,null,-1)),l[293]||(l[293]=n("h4",{id:"_3-2-springdataredis-客户端",tabindex:"-1"},[E("3.2 SpringDataRedis 客户端 "),n("a",{class:"header-anchor",href:"#_3-2-springdataredis-客户端","aria-label":'Permalink to "3.2 SpringDataRedis 客户端"'},"​")],-1)),l[294]||(l[294]=n("p",null,[E("SpringData是Spring中数据操作的模块，包含对各种数据库的集成，其中对Redis的集成模块就叫做SpringDataRedis，官网地址："),n("a",{href:"https://spring.io/projects/spring-data-redis",target:"_blank",rel:"noreferrer"},"https://spring.io/projects/spring-data-redis")],-1)),l[295]||(l[295]=n("ul",null,[n("li",null,"提供了对不同Redis客户端的整合（Lettuce和Jedis）"),n("li",null,"提供了RedisTemplate统一API来操作Redis"),n("li",null,"支持Redis的发布订阅模型"),n("li",null,"支持Redis哨兵和Redis集群"),n("li",null,"支持基于Lettuce的响应式编程"),n("li",null,"支持基于JDK、JSON、字符串、Spring对象的数据序列化及反序列化"),n("li",null,"支持基于Redis的JDKCollection实现")],-1)),l[296]||(l[296]=n("p",null,"SpringDataRedis中提供了RedisTemplate工具类，其中封装了各种对Redis的操作。并且将不同数据类型的操作API封装到了不同的类型中：",-1)),l[297]||(l[297]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/UFlNIV0.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[298]||(l[298]=n("h5",{id:"_3-2-1-快速入门",tabindex:"-1"},[E("3.2.1 快速入门 "),n("a",{class:"header-anchor",href:"#_3-2-1-快速入门","aria-label":'Permalink to "3.2.1 快速入门"'},"​")],-1)),l[299]||(l[299]=n("p",null,"SpringBoot已经提供了对SpringDataRedis的支持，使用非常简单。",-1)),l[300]||(l[300]=n("p",null,"首先，新建一个maven项目，然后按照下面步骤执行：",-1)),l[301]||(l[301]=n("h6",{id:"_1-引入依赖",tabindex:"-1"},[E("1）引入依赖 "),n("a",{class:"header-anchor",href:"#_1-引入依赖","aria-label":'Permalink to "1）引入依赖"'},"​")],-1)),l[302]||(l[302]=n("div",{class:"language-xml max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"xml"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<?"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"xml"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"1.0"'),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," encoding"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"UTF-8"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"?>")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"project"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xmlns"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http://maven.apache.org/POM/4.0.0"'),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xmlns:xsi"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http://www.w3.org/2001/XMLSchema-instance"')]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"         xsi:schemaLocation"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"modelVersion"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">4.0.0</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"modelVersion"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"parent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-parent</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">2.5.7</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"relativePath"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"/> "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\x3c!-- lookup parent from repository --\x3e")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"parent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.heima</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">redis-demo</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">0.0.1-SNAPSHOT</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"name"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">redis-demo</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"name"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"description"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">Demo project for Spring Boot</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"description"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"properties"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"java.version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">1.8</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"java.version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"properties"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependencies"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        \x3c!--redis依赖--\x3e")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-data-redis</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        \x3c!--common-pool--\x3e")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.apache.commons</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">commons-pool2</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        \x3c!--Jackson依赖--\x3e")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.fasterxml.jackson.core</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">jackson-databind</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.projectlombok</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">lombok</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">true</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-test</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"scope"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">test</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"scope"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependencies"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"build"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"plugins"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"plugin"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-maven-plugin</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"configuration"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"excludes"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclude"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.projectlombok</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">lombok</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclude"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"excludes"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"configuration"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"plugin"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"plugins"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"build"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"project"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[303]||(l[303]=n("h6",{id:"_2-配置-redis",tabindex:"-1"},[E("2）配置 Redis "),n("a",{class:"header-anchor",href:"#_2-配置-redis","aria-label":'Permalink to "2）配置 Redis"'},"​")],-1)),l[304]||(l[304]=n("div",{class:"language-yaml max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"yaml"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  redis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    host"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"192.168.150.101")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    port"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    password"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    lettuce"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      pool"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        max-active"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        max-idle"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        min-idle"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        max-wait"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"100ms")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[305]||(l[305]=n("h6",{id:"_3-注入-redistemplate",tabindex:"-1"},[E("3）注入 RedisTemplate "),n("a",{class:"header-anchor",href:"#_3-注入-redistemplate","aria-label":'Permalink to "3）注入 RedisTemplate"'},"​")],-1)),l[306]||(l[306]=n("p",null,"因为有了SpringBoot的自动装配，我们可以拿来就用：",-1)),l[307]||(l[307]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SpringBootTest")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisStringTests"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisTemplate redisTemplate;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[308]||(l[308]=n("h6",{id:"_4-编写测试",tabindex:"-1"},[E("4）编写测试 "),n("a",{class:"header-anchor",href:"#_4-编写测试","aria-label":'Permalink to "4）编写测试"'},"​")],-1)),l[309]||(l[309]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SpringBootTest")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisStringTests"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisTemplate redisTemplate;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写入一条String数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"虎哥"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取string数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Object name "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name = "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[310]||(l[310]=n("h5",{id:"_3-2-2-自定义序列化",tabindex:"-1"},[E("3.2.2 自定义序列化 "),n("a",{class:"header-anchor",href:"#_3-2-2-自定义序列化","aria-label":'Permalink to "3.2.2 自定义序列化"'},"​")],-1)),l[311]||(l[311]=n("p",null,"RedisTemplate可以接收任意Object作为值写入Redis：",-1)),l[312]||(l[312]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/OEMcbuu.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[313]||(l[313]=n("p",null,"只不过写入前会把Object序列化为字节形式，默认是采用JDK序列化，得到的结果是这样的：",-1)),l[314]||(l[314]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/5FjtWk5.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[315]||(l[315]=n("p",null,"缺点：",-1)),l[316]||(l[316]=n("ul",null,[n("li",null,"可读性差"),n("li",null,"内存占用较大")],-1)),l[317]||(l[317]=n("p",null,"我们可以自定义RedisTemplate的序列化方式，代码如下：",-1)),l[318]||(l[318]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisConfig"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisTemplate<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redisTemplate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RedisConnectionFactory "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"connectionFactory"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建RedisTemplate对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RedisTemplate<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> template "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisTemplate<>();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置连接工厂")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        template."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setConnectionFactory"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(connectionFactory);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建JSON序列化工具")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        GenericJackson2JsonRedisSerializer jsonRedisSerializer "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            \t\t\t\t\t\t\tnew"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," GenericJackson2JsonRedisSerializer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置Key的序列化")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        template."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setKeySerializer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RedisSerializer."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"string"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        template."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHashKeySerializer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RedisSerializer."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"string"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置Value的序列化")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        template."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setValueSerializer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(jsonRedisSerializer);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        template."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHashValueSerializer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(jsonRedisSerializer);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," template;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[319]||(l[319]=n("p",null,"这里采用了JSON序列化来代替默认的JDK序列化方式。最终结果如图：",-1)),l[320]||(l[320]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/XOAq3cN.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[321]||(l[321]=n("p",null,"整体可读性有了很大提升，并且能将Java对象自动的序列化为JSON字符串，并且查询时能自动把JSON反序列化为Java对象。不过，其中记录了序列化时对应的class名称，目的是为了查询时实现自动反序列化。这会带来额外的内存开销。",-1)),l[322]||(l[322]=n("h5",{id:"_3-2-3-stringredistemplate",tabindex:"-1"},[E("3.2.3 StringRedisTemplate "),n("a",{class:"header-anchor",href:"#_3-2-3-stringredistemplate","aria-label":'Permalink to "3.2.3 StringRedisTemplate"'},"​")],-1)),l[323]||(l[323]=n("p",null,"为了节省内存空间，我们可以不使用JSON序列化器来处理value，而是统一使用String序列化器，要求只能存储String类型的key和value。当需要存储Java对象时，手动完成对象的序列化和反序列化。",-1)),l[324]||(l[324]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/Ip9TKSY.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[325]||(l[325]=n("p",null,"因为存入和读取时的序列化及反序列化都是我们自己实现的，SpringDataRedis就不会将class信息写入Redis了。",-1)),l[326]||(l[326]=n("p",null,"这种用法比较普遍，因此SpringDataRedis就提供了RedisTemplate的子类：StringRedisTemplate，它的key和value的序列化方式默认就是String方式。",-1)),l[327]||(l[327]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/zXH6Qn6.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[328]||(l[328]=n("p",null,"省去了我们自定义RedisTemplate的序列化方式的步骤，而是直接使用：",-1)),l[329]||(l[329]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate stringRedisTemplate;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// JSON序列化工具")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectMapper mapper "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ObjectMapper"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSaveUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws JsonProcessingException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    User user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," User"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"虎哥"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"21"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 手动序列化")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String json "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," mapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 写入数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user:200"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", json);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String jsonUser "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user:200"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 手动反序列化")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    User user1 "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," mapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"readValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(jsonUser, User.class);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user1 = "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," user1);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[330]||(l[330]=n("h2",{id:"实战篇-redis",tabindex:"-1"},[E("实战篇 Redis "),n("a",{class:"header-anchor",href:"#实战篇-redis","aria-label":'Permalink to "实战篇 Redis"'},"​")],-1)),l[331]||(l[331]=n("h3",{id:"开篇导读",tabindex:"-1"},[E("开篇导读 "),n("a",{class:"header-anchor",href:"#开篇导读","aria-label":'Permalink to "开篇导读"'},"​")],-1)),l[332]||(l[332]=n("p",null,"亲爱的小伙伴们大家好，马上咱们就开始实战篇的内容了，相信通过本章的学习，小伙伴们就能理解各种redis的使用啦，接下来咱们来一起看看实战篇我们要学习一些什么样的内容",-1)),l[333]||(l[333]=n("ul",null,[n("li",null,"短信登录")],-1)),l[334]||(l[334]=n("p",null,"这一块我们会使用redis共享session来实现",-1)),l[335]||(l[335]=n("ul",null,[n("li",null,"商户查询缓存")],-1)),l[336]||(l[336]=n("p",null,"通过本章节，我们会理解缓存击穿，缓存穿透，缓存雪崩等问题，让小伙伴的对于这些概念的理解不仅仅是停留在概念上，更是能在代码中看到对应的内容",-1)),l[337]||(l[337]=n("ul",null,[n("li",null,"优惠卷秒杀")],-1)),l[338]||(l[338]=n("p",null,"通过本章节，我们可以学会Redis的计数器功能， 结合Lua完成高性能的redis操作，同时学会Redis分布式锁的原理，包括Redis的三种消息队列",-1)),l[339]||(l[339]=n("ul",null,[n("li",null,"附近的商户")],-1)),l[340]||(l[340]=n("p",null,"我们利用Redis的GEOHash来完成对于地理坐标的操作",-1)),l[341]||(l[341]=n("ul",null,[n("li",null,"UV统计")],-1)),l[342]||(l[342]=n("p",null,"主要是使用Redis来完成统计功能",-1)),l[343]||(l[343]=n("ul",null,[n("li",null,"用户签到")],-1)),l[344]||(l[344]=n("p",null,"使用Redis的BitMap数据统计功能",-1)),l[345]||(l[345]=n("ul",null,[n("li",null,"好友关注")],-1)),l[346]||(l[346]=n("p",null,"基于Set集合的关注、取消关注，共同关注等等功能，这一块知识咱们之前就讲过，这次我们在项目中来使用一下",-1)),l[347]||(l[347]=n("ul",null,[n("li",null,"打人探店")],-1)),l[348]||(l[348]=n("p",null,"基于List来完成点赞列表的操作，同时基于SortedSet来完成点赞的排行榜功能",-1)),l[349]||(l[349]=n("p",null,"以上这些内容咱们统统都会给小伙伴们讲解清楚，让大家充分理解如何使用Redis",-1)),l[350]||(l[350]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653056228879.png",alt:"1653056228879",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[351]||(l[351]=n("h3",{id:"_1-短信登录",tabindex:"-1"},[E("1. 短信登录 "),n("a",{class:"header-anchor",href:"#_1-短信登录","aria-label":'Permalink to "1. 短信登录"'},"​")],-1)),l[352]||(l[352]=n("h4",{id:"_1-1-导入黑马点评项目",tabindex:"-1"},[E("1.1 导入黑马点评项目 "),n("a",{class:"header-anchor",href:"#_1-1-导入黑马点评项目","aria-label":'Permalink to "1.1 导入黑马点评项目"'},"​")],-1)),l[353]||(l[353]=n("h5",{id:"_1-1-1-导入-sql",tabindex:"-1"},[E("1.1.1 导入 SQL "),n("a",{class:"header-anchor",href:"#_1-1-1-导入-sql","aria-label":'Permalink to "1.1.1 导入 SQL"'},"​")],-1)),l[354]||(l[354]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653057872536.png",alt:"1653057872536",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[355]||(l[355]=n("h5",{id:"_1-1-2-有关当前模型",tabindex:"-1"},[E("1.1.2 有关当前模型 "),n("a",{class:"header-anchor",href:"#_1-1-2-有关当前模型","aria-label":'Permalink to "1.1.2 有关当前模型"'},"​")],-1)),l[356]||(l[356]=n("p",null,"手机或者app端发起请求，请求我们的nginx服务器，nginx基于七层模型走的事HTTP协议，可以实现基于Lua直接绕开tomcat访问redis，也可以作为静态资源服务器，轻松扛下上万并发， 负载均衡到下游tomcat服务器，打散流量，我们都知道一台4核8G的tomcat，在优化和处理简单业务的加持下，大不了就处理1000左右的并发， 经过nginx的负载均衡分流后，利用集群支撑起整个项目，同时nginx在部署了前端项目后，更是可以做到动静分离，进一步降低tomcat服务的压力，这些功能都得靠nginx起作用，所以nginx是整个项目中重要的一环。",-1)),l[357]||(l[357]=n("p",null,"在tomcat支撑起并发流量后，我们如果让tomcat直接去访问Mysql，根据经验Mysql企业级服务器只要上点并发，一般是16或32 核心cpu，32 或64G内存，像企业级mysql加上固态硬盘能够支撑的并发，大概就是4000起~7000左右，上万并发， 瞬间就会让Mysql服务器的cpu，硬盘全部打满，容易崩溃，所以我们在高并发场景下，会选择使用mysql集群，同时为了进一步降低Mysql的压力，同时增加访问的性能，我们也会加入Redis，同时使用Redis集群使得Redis对外提供更好的服务。",-1)),l[358]||(l[358]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653059409865.png",alt:"1653059409865",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[359]||(l[359]=n("h5",{id:"_1-1-3-导入后端项目",tabindex:"-1"},[E("1.1.3 导入后端项目 "),n("a",{class:"header-anchor",href:"#_1-1-3-导入后端项目","aria-label":'Permalink to "1.1.3 导入后端项目"'},"​")],-1)),l[360]||(l[360]=n("p",null,"在资料中提供了一个项目源码：",-1)),l[361]||(l[361]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653060237073.png",alt:"1653060237073",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[362]||(l[362]=n("h5",{id:"_1-1-4-导入前端工程",tabindex:"-1"},[E("1.1.4 导入前端工程 "),n("a",{class:"header-anchor",href:"#_1-1-4-导入前端工程","aria-label":'Permalink to "1.1.4 导入前端工程"'},"​")],-1)),l[363]||(l[363]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653060337562.png",alt:"1653060337562",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[364]||(l[364]=n("h5",{id:"_1-1-5-运行前端项目",tabindex:"-1"},[E("1.1.5 运行前端项目 "),n("a",{class:"header-anchor",href:"#_1-1-5-运行前端项目","aria-label":'Permalink to "1.1.5 运行前端项目"'},"​")],-1)),l[365]||(l[365]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653060588190.png",alt:"1653060588190",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[366]||(l[366]=n("h4",{id:"_1-2-基于-session-实现登录流程",tabindex:"-1"},[E("1.2 基于 Session 实现登录流程 "),n("a",{class:"header-anchor",href:"#_1-2-基于-session-实现登录流程","aria-label":'Permalink to "1.2 基于 Session 实现登录流程"'},"​")],-1)),l[367]||(l[367]=n("p",null,[n("strong",null,"发送验证码：")],-1)),l[368]||(l[368]=n("p",null,"用户在提交手机号后，会校验手机号是否合法，如果不合法，则要求用户重新输入手机号",-1)),l[369]||(l[369]=n("p",null,"如果手机号合法，后台此时生成对应的验证码，同时将验证码进行保存，然后再通过短信的方式将验证码发送给用户",-1)),l[370]||(l[370]=n("p",null,[n("strong",null,"短信验证码登录、注册：")],-1)),l[371]||(l[371]=n("p",null,"用户将验证码和手机号进行输入，后台从session中拿到当前验证码，然后和用户输入的验证码进行校验，如果不一致，则无法通过校验，如果一致，则后台根据手机号查询用户，如果用户不存在，则为用户创建账号信息，保存到数据库，无论是否存在，都会将用户信息保存到session中，方便后续获得当前登录信息",-1)),l[372]||(l[372]=n("p",null,[n("strong",null,"校验登录状态:")],-1)),l[373]||(l[373]=n("p",null,"用户在请求时候，会从cookie中携带者JsessionId到后台，后台通过JsessionId从session中拿到用户信息，如果没有session信息，则进行拦截，如果有session信息，则将用户信息保存到threadLocal中，并且放行",-1)),l[374]||(l[374]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653066208144.png",alt:"1653066208144",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[375]||(l[375]=n("h4",{id:"_1-3-实现发送短信验证码功能",tabindex:"-1"},[E("1.3 实现发送短信验证码功能 "),n("a",{class:"header-anchor",href:"#_1-3-实现发送短信验证码功能","aria-label":'Permalink to "1.3 实现发送短信验证码功能"'},"​")],-1)),l[376]||(l[376]=n("p",null,[n("strong",null,"页面流程")],-1)),l[377]||(l[377]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653067054461.png",alt:"1653067054461",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[378]||(l[378]=n("p",null,[n("strong",null,"具体代码如下")],-1)),l[379]||(l[379]=n("p",null,[n("strong",null,"贴心小提示：")],-1)),l[380]||(l[380]=n("p",null,"具体逻辑上文已经分析，我们仅仅只需要按照提示的逻辑写出代码即可。",-1)),l[381]||(l[381]=n("ul",null,[n("li",null,"发送验证码")],-1)),l[382]||(l[382]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sendCode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String phone, HttpSession session) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.校验手机号")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (RegexUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isPhoneInvalid"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(phone)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.如果不符合，返回错误信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"手机号格式错误！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.符合，生成验证码")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String code "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RandomUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomNumbers"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.保存验证码到 session")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        session."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAttribute"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"code"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",code);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.发送验证码")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"发送短信验证码成功，验证码：{}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", code);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 返回ok")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[383]||(l[383]=n("ul",null,[n("li",null,"登录")],-1)),l[384]||(l[384]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"login"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LoginFormDTO loginForm, HttpSession session) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.校验手机号")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String phone "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," loginForm."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPhone"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (RegexUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isPhoneInvalid"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(phone)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.如果不符合，返回错误信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"手机号格式错误！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.校验验证码")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Object cacheCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," session."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAttribute"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"code"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String code "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," loginForm."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cacheCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," !"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cacheCode."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(code)){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"             //3.不一致，报错")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"验证码错误"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //一致，根据手机号查询用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        User user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"phone"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", phone)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"one"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //5.判断用户是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //不存在，则创建")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  createUserWithPhone"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(phone);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //7.保存用户信息到session中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        session."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAttribute"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",user);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[385]||(l[385]=n("h4",{id:"_1-4-实现登录拦截功能",tabindex:"-1"},[E("1.4 实现登录拦截功能 "),n("a",{class:"header-anchor",href:"#_1-4-实现登录拦截功能","aria-label":'Permalink to "1.4 实现登录拦截功能"'},"​")],-1)),l[386]||(l[386]=n("p",null,[n("strong",null,"温馨小贴士：tomcat的运行原理")],-1)),l[387]||(l[387]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653068196656.png",alt:"1653068196656",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[388]||(l[388]=n("p",null,"当用户发起请求时，会访问我们像tomcat注册的端口，任何程序想要运行，都需要有一个线程对当前端口号进行监听，tomcat也不例外，当监听线程知道用户想要和tomcat连接连接时，那会由监听线程创建socket连接，socket都是成对出现的，用户通过socket像互相传递数据，当tomcat端的socket接受到数据后，此时监听线程会从tomcat的线程池中取出一个线程执行用户请求，在我们的服务部署到tomcat后，线程会找到用户想要访问的工程，然后用这个线程转发到工程中的controller，service，dao中，并且访问对应的DB，在用户执行完请求后，再统一返回，再找到tomcat端的socket，再将数据写回到用户端的socket，完成请求和响应",-1)),l[389]||(l[389]=n("p",null,"通过以上讲解，我们可以得知 每个用户其实对应都是去找tomcat线程池中的一个线程来完成工作的， 使用完成后再进行回收，既然每个请求都是独立的，所以在每个用户去访问我们的工程时，我们可以使用threadlocal来做到线程隔离，每个线程操作自己的一份数据",-1)),l[390]||(l[390]=n("p",null,[n("strong",null,"温馨小贴士：关于threadlocal")],-1)),l[391]||(l[391]=n("p",null,"如果小伙伴们看过threadLocal的源码，你会发现在threadLocal中，无论是他的put方法和他的get方法， 都是先从获得当前用户的线程，然后从线程中取出线程的成员变量map，只要线程不一样，map就不一样，所以可以通过这种方式来做到线程隔离",-1)),l[392]||(l[392]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653068874258.png",alt:"1653068874258",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[393]||(l[393]=n("p",null,"拦截器代码",-1)),l[394]||(l[394]=n("div",{class:"language-Java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"Java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," LoginInterceptor"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HandlerInterceptor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," preHandle"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"handler"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"       //1.获取session")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        HttpSession session "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSession"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //2.获取session中的用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Object user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," session."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAttribute"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //3.判断用户是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"              //4.不存在，拦截，返回401状态码")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"              response."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStatus"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"401"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"              return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //5.存在，保存用户信息到Threadlocal")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((User)user);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //6.放行")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[395]||(l[395]=n("p",null,"让拦截器生效",-1)),l[396]||(l[396]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," MvcConfig"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," WebMvcConfigurer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Resource")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate stringRedisTemplate;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addInterceptors"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(InterceptorRegistry "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"registry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 登录拦截器")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        registry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addInterceptor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," LoginInterceptor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"excludePathPatterns"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/shop/**"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/voucher/**"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/shop-type/**"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/upload/**"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/blog/hot"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/user/code"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/user/login"')]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                )."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"order"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // token刷新的拦截器")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        registry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addInterceptor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RefreshTokenInterceptor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stringRedisTemplate))."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addPathPatterns"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/**"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"order"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[397]||(l[397]=n("h4",{id:"_1-5-隐藏用户敏感信息",tabindex:"-1"},[E("1.5 隐藏用户敏感信息 "),n("a",{class:"header-anchor",href:"#_1-5-隐藏用户敏感信息","aria-label":'Permalink to "1.5 隐藏用户敏感信息"'},"​")],-1)),l[398]||(l[398]=n("p",null,"我们通过浏览器观察到此时用户的全部信息都在，这样极为不靠谱，所以我们应当在返回用户信息之前，将用户的敏感信息进行隐藏，采用的核心思路就是书写一个UserDto对象，这个UserDto对象就没有敏感信息了，我们在返回前，将有用户敏感信息的User对象转化成没有敏感信息的UserDto对象，那么就能够避免这个尴尬的问题了",-1)),l[399]||(l[399]=n("p",null,[n("strong",null,"在登录方法处修改")],-1)),l[400]||(l[400]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//7.保存用户信息到session中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"session."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAttribute"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", BeanUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user,UserDTO.class));")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[401]||(l[401]=n("p",null,[n("strong",null,"在拦截器处：")],-1)),l[402]||(l[402]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//5.存在，保存用户信息到Threadlocal")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((UserDTO) user);")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[403]||(l[403]=n("p",null,[n("strong",null,"在UserHolder处：将user对象换成UserDTO")],-1)),l[404]||(l[404]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserHolder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UserDTO"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> tl "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ThreadLocal<>();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," saveUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UserDTO "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"user"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        tl."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserDTO "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tl."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," removeUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        tl."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[405]||(l[405]=n("h4",{id:"_1-6-session-共享问题",tabindex:"-1"},[E("1.6 session 共享问题 "),n("a",{class:"header-anchor",href:"#_1-6-session-共享问题","aria-label":'Permalink to "1.6 session 共享问题"'},"​")],-1)),l[406]||(l[406]=n("p",null,[n("strong",null,"核心思路分析：")],-1)),l[407]||(l[407]=n("p",null,"每个tomcat中都有一份属于自己的session,假设用户第一次访问第一台tomcat，并且把自己的信息存放到第一台服务器的session中，但是第二次这个用户访问到了第二台tomcat，那么在第二台服务器上，肯定没有第一台服务器存放的session，所以此时 整个登录拦截功能就会出现问题，我们能如何解决这个问题呢？早期的方案是session拷贝，就是说虽然每个tomcat上都有不同的session，但是每当任意一台服务器的session修改时，都会同步给其他的Tomcat服务器的session，这样的话，就可以实现session的共享了",-1)),l[408]||(l[408]=n("p",null,"但是这种方案具有两个大问题",-1)),l[409]||(l[409]=n("p",null,"1、每台服务器中都有完整的一份session数据，服务器压力过大。",-1)),l[410]||(l[410]=n("p",null,"2、session拷贝数据时，可能会出现延迟",-1)),l[411]||(l[411]=n("p",null,"所以咱们后来采用的方案都是基于redis来完成，我们把session换成redis，redis数据本身就是共享的，就可以避免session共享的问题了",-1)),l[412]||(l[412]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653069893050.png",alt:"1653069893050",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[413]||(l[413]=n("h4",{id:"_1-7-redis-代替-session-的业务流程",tabindex:"-1"},[E("1.7 Redis 代替 session 的业务流程 "),n("a",{class:"header-anchor",href:"#_1-7-redis-代替-session-的业务流程","aria-label":'Permalink to "1.7 Redis 代替 session 的业务流程"'},"​")],-1)),l[414]||(l[414]=n("h5",{id:"_1-7-1-设计-key-的结构",tabindex:"-1"},[E("1.7.1 设计 key 的结构 "),n("a",{class:"header-anchor",href:"#_1-7-1-设计-key-的结构","aria-label":'Permalink to "1.7.1 设计 key 的结构"'},"​")],-1)),l[415]||(l[415]=n("p",null,"首先我们要思考一下利用redis来存储数据，那么到底使用哪种结构呢？由于存入的数据比较简单，我们可以考虑使用String，或者是使用哈希，如下图，如果使用String，同学们注意他的value，用多占用一点空间，如果使用哈希，则他的value中只会存储他数据本身，如果不是特别在意内存，其实使用String就可以啦。",-1)),l[416]||(l[416]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653319261433.png",alt:"1653319261433",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[417]||(l[417]=n("h5",{id:"_1-7-2-设计-key-的具体细节",tabindex:"-1"},[E("1.7.2 设计 key 的具体细节 "),n("a",{class:"header-anchor",href:"#_1-7-2-设计-key-的具体细节","aria-label":'Permalink to "1.7.2 设计 key 的具体细节"'},"​")],-1)),l[418]||(l[418]=n("p",null,"所以我们可以使用String结构，就是一个简单的key，value键值对的方式，但是关于key的处理，session他是每个用户都有自己的session，但是redis的key是共享的，咱们就不能使用code了",-1)),l[419]||(l[419]=n("p",null,"在设计这个key的时候，我们之前讲过需要满足两点",-1)),l[420]||(l[420]=n("p",null,"1、key要具有唯一性",-1)),l[421]||(l[421]=n("p",null,"2、key要方便携带",-1)),l[422]||(l[422]=n("p",null,"如果我们采用phone：手机号这个的数据来存储当然是可以的，但是如果把这样的敏感数据存储到redis中并且从页面中带过来毕竟不太合适，所以我们在后台生成一个随机串token，然后让前端带来这个token就能完成我们的整体逻辑了",-1)),l[423]||(l[423]=n("h5",{id:"_1-7-3-整体访问流程",tabindex:"-1"},[E("1.7.3 整体访问流程 "),n("a",{class:"header-anchor",href:"#_1-7-3-整体访问流程","aria-label":'Permalink to "1.7.3 整体访问流程"'},"​")],-1)),l[424]||(l[424]=n("p",null,"当注册完成后，用户去登录会去校验用户提交的手机号和验证码，是否一致，如果一致，则根据手机号查询用户信息，不存在则新建，最后将用户数据保存到redis，并且生成token作为redis的key，当我们校验用户是否登录时，会去携带着token进行访问，从redis中取出token对应的value，判断是否存在这个数据，如果没有则拦截，如果存在则将其保存到threadLocal中，并且放行。",-1)),l[425]||(l[425]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653319474181.png",alt:"1653319474181",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[426]||(l[426]=n("h4",{id:"_1-8-基于-redis-实现短信登录",tabindex:"-1"},[E("1.8 基于 Redis 实现短信登录 "),n("a",{class:"header-anchor",href:"#_1-8-基于-redis-实现短信登录","aria-label":'Permalink to "1.8 基于 Redis 实现短信登录"'},"​")],-1)),l[427]||(l[427]=n("p",null,"这里具体逻辑就不分析了，之前咱们已经重点分析过这个逻辑啦。",-1)),l[428]||(l[428]=n("p",null,[n("strong",null,"UserServiceImpl代码")],-1)),l[429]||(l[429]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"login"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LoginFormDTO loginForm, HttpSession session) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.校验手机号")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String phone "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," loginForm."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPhone"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (RegexUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isPhoneInvalid"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(phone)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.如果不符合，返回错误信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"手机号格式错误！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.从redis获取验证码并校验")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String cacheCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LOGIN_CODE_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," phone);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String code "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," loginForm."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (cacheCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," !"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cacheCode."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(code)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 不一致，报错")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"验证码错误"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.一致，根据手机号查询用户 select * from tb_user where phone = ?")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    User user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"phone"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", phone)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"one"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.判断用户是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.不存在，创建新用户并保存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createUserWithPhone"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(phone);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.保存用户信息到 redis中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.1.随机生成token，作为登录令牌")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String token "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UUID."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomUUID"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.2.将User对象转为HashMap存储")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    UserDTO userDTO "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user, UserDTO.class);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> userMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"beanToMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userDTO, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            CopyOptions."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIgnoreNullValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setFieldValueEditor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((fieldName, fieldValue) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," fieldValue."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.3.存储")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String tokenKey "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LOGIN_USER_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," token;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForHash"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"putAll"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(tokenKey, userMap);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.4.设置token有效期")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"expire"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(tokenKey, LOGIN_USER_TTL, TimeUnit.MINUTES);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 8.返回token")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(token);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[430]||(l[430]=n("h4",{id:"_1-9-解决状态登录刷新问题",tabindex:"-1"},[E("1.9 解决状态登录刷新问题 "),n("a",{class:"header-anchor",href:"#_1-9-解决状态登录刷新问题","aria-label":'Permalink to "1.9 解决状态登录刷新问题"'},"​")],-1)),l[431]||(l[431]=n("h5",{id:"_1-9-1-初始方案思路总结",tabindex:"-1"},[E("1.9.1 初始方案思路总结： "),n("a",{class:"header-anchor",href:"#_1-9-1-初始方案思路总结","aria-label":'Permalink to "1.9.1 初始方案思路总结："'},"​")],-1)),l[432]||(l[432]=n("p",null,"在这个方案中，他确实可以使用对应路径的拦截，同时刷新登录token令牌的存活时间，但是现在这个拦截器他只是拦截需要被拦截的路径，假设当前用户访问了一些不需要拦截的路径，那么这个拦截器就不会生效，所以此时令牌刷新的动作实际上就不会执行，所以这个方案他是存在问题的",-1)),l[433]||(l[433]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653320822964.png",alt:"1653320822964",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[434]||(l[434]=n("h5",{id:"_1-9-2-优化方案",tabindex:"-1"},[E("1.9.2 优化方案 "),n("a",{class:"header-anchor",href:"#_1-9-2-优化方案","aria-label":'Permalink to "1.9.2 优化方案"'},"​")],-1)),l[435]||(l[435]=n("p",null,"既然之前的拦截器无法对不需要拦截的路径生效，那么我们可以添加一个拦截器，在第一个拦截器中拦截所有的路径，把第二个拦截器做的事情放入到第一个拦截器中，同时刷新令牌，因为第一个拦截器有了threadLocal的数据，所以此时第二个拦截器只需要判断拦截器中的user对象是否存在即可，完成整体刷新功能。",-1)),l[436]||(l[436]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653320764547.png",alt:"1653320764547",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[437]||(l[437]=n("h5",{id:"_1-9-3-代码",tabindex:"-1"},[E("1.9.3 代码 "),n("a",{class:"header-anchor",href:"#_1-9-3-代码","aria-label":'Permalink to "1.9.3 代码"'},"​")],-1)),l[438]||(l[438]=n("p",null,[n("strong",null,"RefreshTokenInterceptor")],-1)),l[439]||(l[439]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RefreshTokenInterceptor"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HandlerInterceptor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate stringRedisTemplate;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RefreshTokenInterceptor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StringRedisTemplate "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"stringRedisTemplate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".stringRedisTemplate "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," preHandle"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"handler"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取请求头中的token")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String token "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getHeader"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"authorization"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBlank"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(token)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.基于TOKEN获取redis中的用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key  "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LOGIN_USER_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," token;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> userMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForHash"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entries"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.判断用户是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (userMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.将查询到的hash数据转为UserDTO")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserDTO userDTO "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fillBeanWithMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userMap, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserDTO"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.存在，保存用户信息到 ThreadLocal")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userDTO);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.刷新token有效期")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"expire"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, LOGIN_USER_TTL, TimeUnit.MINUTES);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 8.放行")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," afterCompletion"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"handler"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"ex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 移除用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"removeUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[440]||(l[440]=n("p",null,[n("strong",null,"LoginInterceptor")],-1)),l[441]||(l[441]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," LoginInterceptor"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HandlerInterceptor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," preHandle"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"handler"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.判断是否需要拦截（ThreadLocal中是否有用户）")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 没有，需要拦截，设置状态码")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            response."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStatus"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"401"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 拦截")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 有用户，则放行")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[442]||(l[442]=n("h3",{id:"_2-商户查询缓存",tabindex:"-1"},[E("2. 商户查询缓存 "),n("a",{class:"header-anchor",href:"#_2-商户查询缓存","aria-label":'Permalink to "2. 商户查询缓存"'},"​")],-1)),l[443]||(l[443]=n("h4",{id:"_2-1-什么是缓存",tabindex:"-1"},[E("2.1 什么是缓存? "),n("a",{class:"header-anchor",href:"#_2-1-什么是缓存","aria-label":'Permalink to "2.1 什么是缓存?"'},"​")],-1)),l[444]||(l[444]=n("p",null,[n("strong",null,"前言"),E(":"),n("strong",null,"什么是缓存?")],-1)),l[445]||(l[445]=n("p",null,[E("就像自行车,越野车的避震器"),n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1.gif",alt:""})],-1)),l[446]||(l[446]=n("p",null,[E('举个例子:越野车,山地自行车,都拥有"避震器",'),n("strong",null,"防止"),E('车体加速后因惯性,在酷似"U"字母的地形上飞跃,硬着陆导致的'),n("strong",null,"损害"),E(",像个弹簧一样;")],-1)),l[447]||(l[447]=n("p",null,'同样,实际开发中,系统也需要"避震器",防止过高的数据访问猛冲系统,导致其操作线程无法及时处理信息而瘫痪;',-1)),l[448]||(l[448]=n("p",null,"这在实际开发中对企业讲,对产品口碑,用户评价都是致命的;所以企业非常重视缓存技术;",-1)),l[449]||(l[449]=n("p",null,[n("strong",null,[E("缓存("),n("strong",null,"Cache),就是数据交换的"),E("缓冲区")]),E(",俗称的缓存就是"),n("strong",null,"缓冲区内的数据"),E(",一般从数据库中获取,存储于本地代码(例如:")],-1)),l[450]||(l[450]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"例1"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Static "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ConcurrentHashMap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"K"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"V"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ConcurrentHashMap<>(); 本地用于高并发")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"例2"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"K"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"V"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> USER_CACHE "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CacheBuilder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(); 用于redis等缓存")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"例3"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Static "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"K"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"V"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HashMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(); 本地缓存")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[451]||(l[451]=n("p",null,[E("由于其被"),n("strong",null,"Static"),E("修饰,所以随着类的加载而被加载到"),n("strong",null,"内存之中"),E(",作为本地缓存,由于其又被"),n("strong",null,"final"),E("修饰,所以其引用"),n("code",null,"(例3:map)"),E("和对象"),n("code",null,"(例3:new HashMap())"),E("之间的关系是固定的,不能改变,因此不用担心赋值(=)导致缓存失效;")],-1)),l[452]||(l[452]=n("h5",{id:"_2-1-1-为什么要使用缓存",tabindex:"-1"},[E("2.1.1 为什么要使用缓存 "),n("a",{class:"header-anchor",href:"#_2-1-1-为什么要使用缓存","aria-label":'Permalink to "2.1.1 为什么要使用缓存"'},"​")],-1)),l[453]||(l[453]=n("p",null,[E("一句话:因为"),n("strong",null,"速度快,好用")],-1)),l[454]||(l[454]=n("p",null,[E("缓存数据存储于代码中,而代码运行在内存中,内存的读写性能远高于磁盘,缓存可以大大降低"),n("strong",null,"用户访问并发量带来的"),E("服务器读写压力")],-1)),l[455]||(l[455]=n("p",null,'实际开发过程中,企业的数据量,少则几十万,多则几千万,这么大数据量,如果没有缓存来作为"避震器",系统是几乎撑不住的,所以企业会大量运用到缓存技术;',-1)),l[456]||(l[456]=n("p",null,"但是缓存也会增加代码复杂度和运营的成本:",-1)),l[457]||(l[457]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220523214414123.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[458]||(l[458]=n("h5",{id:"_2-1-2-如何使用缓存",tabindex:"-1"},[E("2.1.2 如何使用缓存 "),n("a",{class:"header-anchor",href:"#_2-1-2-如何使用缓存","aria-label":'Permalink to "2.1.2 如何使用缓存"'},"​")],-1)),l[459]||(l[459]=n("p",null,"实际开发中,会构筑多级缓存来使系统运行速度进一步提升,例如:本地缓存与redis中的缓存并发使用",-1)),l[460]||(l[460]=n("p",null,[n("strong",null,"浏览器缓存"),E("：主要是存在于浏览器端的缓存")],-1)),l[461]||(l[461]=n("p",null,"**应用层缓存：**可以分为tomcat本地缓存，比如之前提到的map，或者是使用redis作为缓存",-1)),l[462]||(l[462]=n("p",null,"**数据库缓存：**在数据库中有一片空间是 buffer pool，增改查数据都会先加载到mysql的缓存中",-1)),l[463]||(l[463]=n("p",null,"**CPU缓存：**当代计算机最大的问题是 cpu性能提升了，但内存读写速度没有跟上，所以为了适应当下的情况，增加了cpu的L1，L2，L3级的缓存",-1)),l[464]||(l[464]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220523212915666.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[465]||(l[465]=n("h4",{id:"_2-2-添加商户缓存",tabindex:"-1"},[E("2.2 添加商户缓存 "),n("a",{class:"header-anchor",href:"#_2-2-添加商户缓存","aria-label":'Permalink to "2.2 添加商户缓存"'},"​")],-1)),l[466]||(l[466]=n("p",null,"在我们查询商户信息时，我们是直接操作从数据库中去进行查询的，大致逻辑是这样，直接查询数据库那肯定慢咯，所以我们需要增加缓存",-1)),l[467]||(l[467]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/{id}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryShopById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long id) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //这里是直接查询数据库")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shopService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[468]||(l[468]=n("h5",{id:"_2-2-1-缓存模型和思路",tabindex:"-1"},[E("2.2.1 缓存模型和思路 "),n("a",{class:"header-anchor",href:"#_2-2-1-缓存模型和思路","aria-label":'Permalink to "2.2.1 缓存模型和思路"'},"​")],-1)),l[469]||(l[469]=n("p",null,"标准的操作方式就是查询数据库之前先查询缓存，如果缓存数据存在，则直接从缓存中返回，如果缓存数据不存在，再查询数据库，然后将数据存入redis。",-1)),l[470]||(l[470]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653322097736.png",alt:"1653322097736",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[471]||(l[471]=n("h5",{id:"_2-1-2-代码如下",tabindex:"-1"},[E("2.1.2 代码如下 "),n("a",{class:"header-anchor",href:"#_2-1-2-代码如下","aria-label":'Permalink to "2.1.2 代码如下"'},"​")],-1)),l[472]||(l[472]=n("p",null,"代码思路：如果缓存有，则直接返回，如果缓存不存在，则查询数据库，然后存入redis。",-1)),l[473]||(l[473]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653322190155.png",alt:"1653322190155",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[474]||(l[474]=n("h4",{id:"_2-3-缓存更新策略",tabindex:"-1"},[E("2.3 缓存更新策略 "),n("a",{class:"header-anchor",href:"#_2-3-缓存更新策略","aria-label":'Permalink to "2.3 缓存更新策略"'},"​")],-1)),l[475]||(l[475]=n("p",null,"缓存更新是redis为了节约内存而设计出来的一个东西，主要是因为内存数据宝贵，当我们向redis插入太多数据，此时就可能会导致缓存中的数据过多，所以redis会对部分数据进行更新，或者把他叫为淘汰更合适。",-1)),l[476]||(l[476]=n("p",null,"**内存淘汰：**redis自动进行，当redis内存达到咱们设定的max-memery的时候，会自动触发淘汰机制，淘汰掉一些不重要的数据(可以自己设置策略方式)",-1)),l[477]||(l[477]=n("p",null,"**超时剔除：**当我们给redis设置了过期时间ttl之后，redis会将超时的数据进行删除，方便咱们继续使用缓存",-1)),l[478]||(l[478]=n("p",null,"**主动更新：**我们可以手动调用方法把缓存删掉，通常用于解决缓存和数据库不一致问题",-1)),l[479]||(l[479]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653322506393.png",alt:"1653322506393",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[480]||(l[480]=n("h5",{id:"_2-3-1-数据库缓存不一致解决方案",tabindex:"-1"},[E("2.3.1 数据库缓存不一致解决方案： "),n("a",{class:"header-anchor",href:"#_2-3-1-数据库缓存不一致解决方案","aria-label":'Permalink to "2.3.1 数据库缓存不一致解决方案："'},"​")],-1)),l[481]||(l[481]=n("p",null,[E("由于我们的"),n("strong",null,"缓存的数据源来自于数据库"),E(",而数据库的"),n("strong",null,"数据是会发生变化的"),E(",因此,如果当数据库中"),n("strong",null,"数据发生变化,而缓存却没有同步"),E(",此时就会有"),n("strong",null,"一致性问题存在"),E(",其后果是:")],-1)),l[482]||(l[482]=n("p",null,"用户使用缓存中的过时数据,就会产生类似多线程数据安全问题,从而影响业务,产品口碑等;怎么解决呢？有如下几种方案",-1)),l[483]||(l[483]=n("p",null,"Cache Aside Pattern 人工编码方式：缓存调用者在更新完数据库后再去更新缓存，也称之为双写方案",-1)),l[484]||(l[484]=n("p",null,"Read/Write Through Pattern : 由系统本身完成，数据库与缓存的问题交由系统本身去处理",-1)),l[485]||(l[485]=n("p",null,"Write Behind Caching Pattern ：调用者只操作缓存，其他线程去异步处理数据库，实现最终一致",-1)),l[486]||(l[486]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653322857620.png",alt:"1653322857620",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[487]||(l[487]=n("h5",{id:"_2-3-2-数据库和缓存不一致采用什么方案",tabindex:"-1"},[E("2.3.2 数据库和缓存不一致采用什么方案 "),n("a",{class:"header-anchor",href:"#_2-3-2-数据库和缓存不一致采用什么方案","aria-label":'Permalink to "2.3.2 数据库和缓存不一致采用什么方案"'},"​")],-1)),l[488]||(l[488]=n("p",null,"综合考虑使用方案一，但是方案一调用者如何处理呢？这里有几个问题",-1)),l[489]||(l[489]=n("p",null,"操作缓存和数据库时有三个问题需要考虑：",-1)),l[490]||(l[490]=n("p",null,"如果采用第一个方案，那么假设我们每次操作数据库后，都操作缓存，但是中间如果没有人查询，那么这个更新动作实际上只有最后一次生效，中间的更新动作意义并不大，我们可以把缓存删除，等待再次查询时，将缓存中的数据加载出来",-1)),l[491]||(l[491]=n("ul",null,[n("li",null,[n("p",null,"删除缓存还是更新缓存？"),n("ul",null,[n("li",null,"更新缓存：每次更新数据库都更新缓存，无效写操作较多"),n("li",null,"删除缓存：更新数据库时让缓存失效，查询时再更新缓存")])]),n("li",null,[n("p",null,"如何保证缓存与数据库的操作的同时成功或失败？"),n("ul",null,[n("li",null,"单体系统，将缓存与数据库操作放在一个事务"),n("li",null,"分布式系统，利用TCC等分布式事务方案")])])],-1)),l[492]||(l[492]=n("p",null,"应该具体操作缓存还是操作数据库，我们应当是先操作数据库，再删除缓存，原因在于，如果你选择第一种方案，在两个线程并发来访问时，假设线程1先来，他先把缓存删了，此时线程2过来，他查询缓存数据并不存在，此时他写入缓存，当他写入缓存后，线程1再执行更新动作时，实际上写入的就是旧的数据，新的数据被旧数据覆盖了。",-1)),l[493]||(l[493]=n("ul",null,[n("li",null,[E("先操作缓存还是先操作数据库？ "),n("ul",null,[n("li",null,"先删除缓存，再操作数据库"),n("li",null,"先操作数据库，再删除缓存")])])],-1)),l[494]||(l[494]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653323595206.png",alt:"1653323595206",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[495]||(l[495]=n("h4",{id:"_2-4-实现商铺和缓存与数据库双写一致",tabindex:"-1"},[E("2.4 实现商铺和缓存与数据库双写一致 "),n("a",{class:"header-anchor",href:"#_2-4-实现商铺和缓存与数据库双写一致","aria-label":'Permalink to "2.4 实现商铺和缓存与数据库双写一致"'},"​")],-1)),l[496]||(l[496]=n("p",null,"核心思路如下：",-1)),l[497]||(l[497]=n("p",null,"修改ShopController中的业务逻辑，满足下面的需求：",-1)),l[498]||(l[498]=n("p",null,"根据id查询店铺时，如果缓存未命中，则查询数据库，将数据库结果写入缓存，并设置超时时间",-1)),l[499]||(l[499]=n("p",null,"根据id修改店铺时，先修改数据库，再删除缓存",-1)),l[500]||(l[500]=n("p",null,[n("strong",null,"修改重点代码1"),E("：修改"),n("strong",null,"ShopServiceImpl"),E("的queryById方法")],-1)),l[501]||(l[501]=n("p",null,[n("strong",null,"设置redis缓存时添加过期时间")],-1)),l[502]||(l[502]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653325871232.png",alt:"1653325871232",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[503]||(l[503]=n("p",null,[n("strong",null,"修改重点代码2")],-1)),l[504]||(l[504]=n("p",null,"代码分析：通过之前的淘汰，我们确定了采用删除策略，来解决双写问题，当我们修改了数据之后，然后把缓存中的数据进行删除，查询时发现缓存中没有数据，则会从mysql中加载最新的数据，从而避免数据库和缓存不一致的问题",-1)),l[505]||(l[505]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653325929549.png",alt:"1653325929549",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[506]||(l[506]=n("h4",{id:"_2-5-缓存穿透问题的解决思路",tabindex:"-1"},[E("2.5 缓存穿透问题的解决思路 "),n("a",{class:"header-anchor",href:"#_2-5-缓存穿透问题的解决思路","aria-label":'Permalink to "2.5 缓存穿透问题的解决思路"'},"​")],-1)),l[507]||(l[507]=n("p",null,"缓存穿透 ：缓存穿透是指客户端请求的数据在缓存中和数据库中都不存在，这样缓存永远不会生效，这些请求都会打到数据库。",-1)),l[508]||(l[508]=n("p",null,"常见的解决方案有两种：",-1)),l[509]||(l[509]=n("ul",null,[n("li",null,[E("缓存空对象 "),n("ul",null,[n("li",null,"优点：实现简单，维护方便"),n("li",null,[E("缺点： "),n("ul",null,[n("li",null,"额外的内存消耗"),n("li",null,"可能造成短期的不一致")])])])]),n("li",null,[E("布隆过滤 "),n("ul",null,[n("li",null,"优点：内存占用较少，没有多余key"),n("li",null,[E("缺点： "),n("ul",null,[n("li",null,"实现复杂"),n("li",null,"存在误判可能")])])])])],-1)),l[510]||(l[510]=n("p",null,"**缓存空对象思路分析：**当我们客户端访问不存在的数据时，先请求redis，但是此时redis中没有数据，此时会访问到数据库，但是数据库中也没有数据，这个数据穿透了缓存，直击数据库，我们都知道数据库能够承载的并发不如redis这么高，如果大量的请求同时过来访问这种不存在的数据，这些请求就都会访问到数据库，简单的解决方案就是哪怕这个数据在数据库中也不存在，我们也把这个数据存入到redis中去，这样，下次用户过来访问这个不存在的数据，那么在redis中也能找到这个数据就不会进入到缓存了",-1)),l[511]||(l[511]=n("p",null,"**布隆过滤：**布隆过滤器其实采用的是哈希思想来解决这个问题，通过一个庞大的二进制数组，走哈希思想去判断当前这个要查询的这个数据是否存在，如果布隆过滤器判断存在，则放行，这个请求会去访问redis，哪怕此时redis中的数据过期了，但是数据库中一定存在这个数据，在数据库中查询出来这个数据后，再将其放入到redis中，",-1)),l[512]||(l[512]=n("p",null,"假设布隆过滤器判断这个数据不存在，则直接返回",-1)),l[513]||(l[513]=n("p",null,"这种方式优点在于节约内存空间，存在误判，误判原因在于：布隆过滤器走的是哈希思想，只要哈希思想，就可能存在哈希冲突",-1)),l[514]||(l[514]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653326156516.png",alt:"1653326156516",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[515]||(l[515]=n("h4",{id:"_2-6-编码解决商品查询的缓存穿透问题",tabindex:"-1"},[E("2.6 编码解决商品查询的缓存穿透问题： "),n("a",{class:"header-anchor",href:"#_2-6-编码解决商品查询的缓存穿透问题","aria-label":'Permalink to "2.6 编码解决商品查询的缓存穿透问题："'},"​")],-1)),l[516]||(l[516]=n("p",null,"核心思路如下：",-1)),l[517]||(l[517]=n("p",null,"在原来的逻辑中，我们如果发现这个数据在mysql中不存在，直接就返回404了，这样是会存在缓存穿透问题的",-1)),l[518]||(l[518]=n("p",null,"现在的逻辑中：如果这个数据不存在，我们不会返回404 ，还是会把这个数据写入到Redis中，并且将value设置为空，欧当再次发起查询时，我们如果发现命中之后，判断这个value是否是null，如果是null，则是之前写入的数据，证明是缓存穿透数据，如果不是，则直接返回数据。",-1)),l[519]||(l[519]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653327124561.png",alt:"1653327124561",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[520]||(l[520]=n("p",null,[n("strong",null,"小总结：")],-1)),l[521]||(l[521]=n("p",null,"缓存穿透产生的原因是什么？",-1)),l[522]||(l[522]=n("ul",null,[n("li",null,"用户请求的数据在缓存中和数据库中都不存在，不断发起这样的请求，给数据库带来巨大压力")],-1)),l[523]||(l[523]=n("p",null,"缓存穿透的解决方案有哪些？",-1)),l[524]||(l[524]=n("ul",null,[n("li",null,"缓存null值"),n("li",null,"布隆过滤"),n("li",null,"增强id的复杂度，避免被猜测id规律"),n("li",null,"做好数据的基础格式校验"),n("li",null,"加强用户权限校验"),n("li",null,"做好热点参数的限流")],-1)),l[525]||(l[525]=n("h4",{id:"_2-7-缓存雪崩问题及解决思路",tabindex:"-1"},[E("2.7 缓存雪崩问题及解决思路 "),n("a",{class:"header-anchor",href:"#_2-7-缓存雪崩问题及解决思路","aria-label":'Permalink to "2.7 缓存雪崩问题及解决思路"'},"​")],-1)),l[526]||(l[526]=n("p",null,"缓存雪崩是指在同一时段大量的缓存key同时失效或者Redis服务宕机，导致大量请求到达数据库，带来巨大压力。",-1)),l[527]||(l[527]=n("p",null,"解决方案：",-1)),l[528]||(l[528]=n("ul",null,[n("li",null,"给不同的Key的TTL添加随机值"),n("li",null,"利用Redis集群提高服务的可用性"),n("li",null,"给缓存业务添加降级限流策略"),n("li",null,"给业务添加多级缓存")],-1)),l[529]||(l[529]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653327884526.png",alt:"1653327884526",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[530]||(l[530]=n("h4",{id:"_2-8-缓存击穿问题及解决思路",tabindex:"-1"},[E("2.8 缓存击穿问题及解决思路 "),n("a",{class:"header-anchor",href:"#_2-8-缓存击穿问题及解决思路","aria-label":'Permalink to "2.8 缓存击穿问题及解决思路"'},"​")],-1)),l[531]||(l[531]=n("p",null,"缓存击穿问题也叫热点Key问题，就是一个被高并发访问并且缓存重建业务较复杂的key突然失效了，无数的请求访问会在瞬间给数据库带来巨大的冲击。",-1)),l[532]||(l[532]=n("p",null,"常见的解决方案有两种：",-1)),l[533]||(l[533]=n("ul",null,[n("li",null,"互斥锁"),n("li",null,"逻辑过期")],-1)),l[534]||(l[534]=n("p",null,"逻辑分析：假设线程1在查询缓存之后，本来应该去查询数据库，然后把这个数据重新加载到缓存的，此时只要线程1走完这个逻辑，其他线程就都能从缓存中加载这些数据了，但是假设在线程1没有走完的时候，后续的线程2，线程3，线程4同时过来访问当前这个方法， 那么这些线程都不能从缓存中查询到数据，那么他们就会同一时刻来访问查询缓存，都没查到，接着同一时间去访问数据库，同时的去执行数据库代码，对数据库访问压力过大",-1)),l[535]||(l[535]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653328022622.png",alt:"1653328022622",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[536]||(l[536]=n("p",null,[n("strong",null,"解决方案一：使用锁来解决")],-1)),l[537]||(l[537]=n("p",null,"因为锁能实现互斥性。假设线程过来，只能一个人一个人的来访问数据库，从而避免对于数据库访问压力过大，但这也会影响查询的性能，因为此时会让查询的性能从并行变成了串行，我们可以采用tryLock方法 + double check来解决这样的问题。",-1)),l[538]||(l[538]=n("p",null,"假设现在线程1过来访问，他查询缓存没有命中，但是此时他获得到了锁的资源，那么线程1就会一个人去执行逻辑，假设现在线程2过来，线程2在执行过程中，并没有获得到锁，那么线程2就可以进行到休眠，直到线程1把锁释放后，线程2获得到锁，然后再来执行逻辑，此时就能够从缓存中拿到数据了。",-1)),l[539]||(l[539]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653328288627.png",alt:"1653328288627",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[540]||(l[540]=n("p",null,[n("strong",null,"解决方案二：逻辑过期方案")],-1)),l[541]||(l[541]=n("p",null,"方案分析：我们之所以会出现这个缓存击穿问题，主要原因是在于我们对key设置了过期时间，假设我们不设置过期时间，其实就不会有缓存击穿的问题，但是不设置过期时间，这样数据不就一直占用我们内存了吗，我们可以采用逻辑过期方案。",-1)),l[542]||(l[542]=n("p",null,"我们把过期时间设置在 redis的value中，注意：这个过期时间并不会直接作用于redis，而是我们后续通过逻辑去处理。假设线程1去查询缓存，然后从value中判断出来当前的数据已经过期了，此时线程1去获得互斥锁，那么其他线程会进行阻塞，获得了锁的线程他会开启一个 线程去进行 以前的重构数据的逻辑，直到新开的线程完成这个逻辑后，才释放锁， 而线程1直接进行返回，假设现在线程3过来访问，由于线程线程2持有着锁，所以线程3无法获得锁，线程3也直接返回数据，只有等到新开的线程2把重建数据构建完后，其他线程才能走返回正确的数据。",-1)),l[543]||(l[543]=n("p",null,"这种方案巧妙在于，异步的构建缓存，缺点在于在构建完缓存之前，返回的都是脏数据。",-1)),l[544]||(l[544]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653328663897.png",alt:"1653328663897",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[545]||(l[545]=n("p",null,"进行对比",-1)),l[546]||(l[546]=n("p",null,"**互斥锁方案：**由于保证了互斥性，所以数据一致，且实现简单，因为仅仅只需要加一把锁而已，也没其他的事情需要操心，所以没有额外的内存消耗，缺点在于有锁就有死锁问题的发生，且只能串行执行性能肯定受到影响",-1)),l[547]||(l[547]=n("p",null,[n("strong",null,"逻辑过期方案："),E(" 线程读取过程中不需要等待，性能好，有一个额外的线程持有锁去进行重构数据，但是在重构数据完成前，其他的线程只能返回之前的数据，且实现起来麻烦")],-1)),l[548]||(l[548]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653357522914.png",alt:"1653357522914",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[549]||(l[549]=n("h4",{id:"_2-9-利用互斥锁解决缓存击穿问题",tabindex:"-1"},[E("2.9 利用互斥锁解决缓存击穿问题 "),n("a",{class:"header-anchor",href:"#_2-9-利用互斥锁解决缓存击穿问题","aria-label":'Permalink to "2.9 利用互斥锁解决缓存击穿问题"'},"​")],-1)),l[550]||(l[550]=n("p",null,"核心思路：相较于原来从缓存中查询不到数据后直接查询数据库而言，现在的方案是 进行查询之后，如果从缓存没有查询到数据，则进行互斥锁的获取，获取互斥锁后，判断是否获得到了锁，如果没有获得到，则休眠，过一会再进行尝试，直到获取到锁为止，才能进行查询",-1)),l[551]||(l[551]=n("p",null,"如果获取到了锁的线程，再去进行查询，查询后将数据写入redis，再释放锁，返回数据，利用互斥锁就能保证只有一个线程去执行操作数据库的逻辑，防止缓存击穿",-1)),l[552]||(l[552]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653357860001.png",alt:"1653357860001",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[553]||(l[553]=n("p",null,[n("strong",null,"操作锁的代码：")],-1)),l[554]||(l[554]=n("p",null,"核心思路就是利用redis的setnx方法来表示获取锁，该方法含义是redis中如果没有这个key，则插入成功，返回1，在stringRedisTemplate中返回true， 如果有这个key则插入失败，则返回0，在stringRedisTemplate返回false，我们可以通过true，或者是false，来表示是否有线程成功插入key，成功插入的key的线程我们认为他就是获得到锁的线程。",-1)),l[555]||(l[555]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Boolean flag "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIfAbsent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit.SECONDS);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BooleanUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isTrue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(flag);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"delete"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[556]||(l[556]=n("p",null,[n("strong",null,"操作代码：")],-1)),l[557]||(l[557]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Shop "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithMutex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id)  {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CACHE_SHOP_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1、从redis中查询商铺缓存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String shopJson "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"key"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2、判断是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotBlank"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopJson)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 存在,直接返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopJson, Shop.class);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //判断命中的值是否是空值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (shopJson "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //返回一个错误信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.实现缓存重构")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //4.1 获取互斥锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String lockKey "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "lock:shop:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Shop shop "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.2 判断否获取成功")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isLock){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //4.3 失败，则休眠重试")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"50"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," queryWithMutex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //4.4 成功，根据id查询数据库")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"             shop "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 5.不存在，返回错误")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shop "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                 //将空值写入redis")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key,"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",CACHE_NULL_TTL,TimeUnit.MINUTES);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //返回错误信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //6.写入redis")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key,JSONUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJsonStr"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shop),CACHE_NULL_TTL,TimeUnit.MINUTES);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //7.释放互斥锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shop;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[558]||(l[558]=n("h4",{id:"_3-0-利用逻辑过期解决缓存击穿问题",tabindex:"-1"},[E("3.0 利用逻辑过期解决缓存击穿问题 "),n("a",{class:"header-anchor",href:"#_3-0-利用逻辑过期解决缓存击穿问题","aria-label":'Permalink to "3.0 利用逻辑过期解决缓存击穿问题"'},"​")],-1)),l[559]||(l[559]=n("p",null,[n("strong",null,"需求：修改根据id查询商铺的业务，基于逻辑过期方式来解决缓存击穿问题")],-1)),l[560]||(l[560]=n("p",null,"思路分析：当用户开始查询redis时，判断是否命中，如果没有命中则直接返回空数据，不查询数据库，而一旦命中后，将value取出，判断value中的过期时间是否满足，如果没有过期，则直接返回redis中的数据，如果过期，则在开启独立线程后直接返回之前的数据，独立线程去重构数据，重构完成后释放互斥锁。",-1)),l[561]||(l[561]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653360308731.png",alt:"1653360308731",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[562]||(l[562]=n("p",null,"如果封装数据：因为现在redis中存储的数据的value需要带上过期时间，此时要么你去修改原来的实体类，要么你",-1)),l[563]||(l[563]=n("p",null,[n("strong",null,"步骤一"),E("：")],-1)),l[564]||(l[564]=n("p",null,"新建一个实体类，我们采用第二个方案，这个方案，对原来代码没有侵入性。",-1)),l[565]||(l[565]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Data")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisData"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalDateTime expireTime;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Object data;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[566]||(l[566]=n("p",null,[n("strong",null,"步骤二"),E("：")],-1)),l[567]||(l[567]=n("p",null,[E("在"),n("strong",null,"ShopServiceImpl"),E(" 新增此方法，利用单元测试进行缓存预热")],-1)),l[568]||(l[568]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653360807133.png",alt:"1653360807133",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[569]||(l[569]=n("p",null,[n("strong",null,"在测试类中")],-1)),l[570]||(l[570]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653360864839.png",alt:"1653360864839",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[571]||(l[571]=n("p",null,[n("strong",null,"步骤三：正式代码")],-1)),l[572]||(l[572]=n("p",null,[n("strong",null,"ShopServiceImpl")],-1)),l[573]||(l[573]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExecutorService CACHE_REBUILD_EXECUTOR "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Executors."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newFixedThreadPool"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Shop "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithLogicalExpire"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"( Long id ) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CACHE_SHOP_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.从redis查询商铺缓存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String json "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.判断是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBlank"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.存在，直接返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.命中，需要先把json反序列化为对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    RedisData redisData "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json, RedisData.class);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Shop shop "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((JSONObject) redisData."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getData"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), Shop.class);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    LocalDateTime expireTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisData."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getExpireTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.判断是否过期")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(expireTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.1.未过期，直接返回店铺信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shop;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.2.已过期，需要缓存重建")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.缓存重建")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.1.获取互斥锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String lockKey "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LOCK_SHOP_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.2.判断是否获取锁成功")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isLock){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        CACHE_REBUILD_EXECUTOR."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"( ()"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //重建缓存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"                this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveShop2Redis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id,"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20L"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.4.返回过期的商铺信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shop;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[574]||(l[574]=n("h4",{id:"_3-1-封装-redis-工具类",tabindex:"-1"},[E("3.1 封装 Redis 工具类 "),n("a",{class:"header-anchor",href:"#_3-1-封装-redis-工具类","aria-label":'Permalink to "3.1 封装 Redis 工具类"'},"​")],-1)),l[575]||(l[575]=n("p",null,"基于StringRedisTemplate封装一个缓存工具类，满足下列需求：",-1)),l[576]||(l[576]=n("ul",null,[n("li",null,[n("p",null,"方法1：将任意Java对象序列化为json并存储在string类型的key中，并且可以设置TTL过期时间")]),n("li",null,[n("p",null,"方法2：将任意Java对象序列化为json并存储在string类型的key中，并且可以设置逻辑过期时间，用于处理缓存击穿问题")]),n("li",null,[n("p",null,"方法3：根据指定的key查询缓存，并反序列化为指定类型，利用缓存空值的方式解决缓存穿透问题")]),n("li",null,[n("p",null,"方法4：根据指定的key查询缓存，并反序列化为指定类型，需要利用逻辑过期解决缓存击穿问题将逻辑进行封装")])],-1)),l[577]||(l[577]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Slf4j")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CacheClient"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate stringRedisTemplate;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExecutorService CACHE_REBUILD_EXECUTOR "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Executors."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newFixedThreadPool"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CacheClient"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StringRedisTemplate "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"stringRedisTemplate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".stringRedisTemplate "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"key"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"value"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Long "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"time"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, JSONUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJsonStr"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value), time, unit);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setWithLogicalExpire"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"key"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"value"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Long "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"time"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置逻辑过期")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RedisData redisData "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisData"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisData."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setData"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisData."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setExpireTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"plusSeconds"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(unit."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toSeconds"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(time)));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写入Redis")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, JSONUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJsonStr"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(redisData));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," <"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> R "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithPassThrough"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"keyPrefix"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ID "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Class<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"type"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Function<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"dbFallback"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Long "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"time"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keyPrefix "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.从redis查询商铺缓存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String json "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotBlank"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.存在，直接返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json, type);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 判断命中的是否是空值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (json "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 返回一个错误信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.不存在，根据id查询数据库")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        R r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dbFallback."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"apply"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.不存在，返回错误")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 将空值写入redis")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", CACHE_NULL_TTL, TimeUnit.MINUTES);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 返回错误信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.存在，写入redis")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, r, time, unit);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," <"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> R "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithLogicalExpire"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"keyPrefix"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ID "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Class<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"type"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Function<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"dbFallback"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Long "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"time"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keyPrefix "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.从redis查询商铺缓存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String json "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBlank"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.存在，直接返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.命中，需要先把json反序列化为对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RedisData redisData "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json, RedisData.class);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        R r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((JSONObject) redisData."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getData"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), type);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        LocalDateTime expireTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisData."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getExpireTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.判断是否过期")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(expireTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 5.1.未过期，直接返回店铺信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.2.已过期，需要缓存重建")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.缓存重建")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.1.获取互斥锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String lockKey "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LOCK_SHOP_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.2.判断是否获取锁成功")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isLock){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 6.3.成功，开启独立线程，实现缓存重建")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            CACHE_REBUILD_EXECUTOR."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 查询数据库")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    R newR "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dbFallback."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"apply"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 重建缓存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"                    this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setWithLogicalExpire"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, newR, time, unit);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 释放锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                    unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            });")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.4.返回过期的商铺信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," <"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> R "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithMutex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"keyPrefix"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ID "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Class<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"type"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Function<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"dbFallback"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Long "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"time"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keyPrefix "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.从redis查询商铺缓存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String shopJson "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotBlank"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopJson)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.存在，直接返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopJson, type);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 判断命中的是否是空值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (shopJson "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 返回一个错误信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.实现缓存重建")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.1.获取互斥锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String lockKey "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LOCK_SHOP_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        R r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.2.判断是否获取成功")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isLock) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 4.3.获取锁失败，休眠并重试")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"50"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," queryWithMutex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(keyPrefix, id, type, dbFallback, time, unit);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.4.获取锁成功，根据id查询数据库")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dbFallback."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"apply"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 5.不存在，返回错误")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 将空值写入redis")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", CACHE_NULL_TTL, TimeUnit.MINUTES);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 返回错误信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 6.存在，写入redis")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"            this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, r, time, unit);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (InterruptedException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 7.释放锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 8.返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"key"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Boolean flag "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIfAbsent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit.SECONDS);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BooleanUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isTrue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(flag);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"key"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"delete"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[578]||(l[578]=n("p",null,"在ShopServiceImpl 中",-1)),l[579]||(l[579]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Resource")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CacheClient cacheClient;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 解决缓存穿透")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Shop shop "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cacheClient")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithPassThrough"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CACHE_SHOP_KEY, id, Shop.class, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 互斥锁解决缓存击穿")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // Shop shop = cacheClient")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //         .queryWithMutex(CACHE_SHOP_KEY, id, Shop.class, this::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 逻辑过期解决缓存击穿")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // Shop shop = cacheClient")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //         .queryWithLogicalExpire(CACHE_SHOP_KEY, id, Shop.class, this::getById, 20L, TimeUnit.SECONDS);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (shop "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"店铺不存在！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shop);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[580]||(l[580]=n("h3",{id:"_3-优惠卷秒杀",tabindex:"-1"},[E("3. 优惠卷秒杀 "),n("a",{class:"header-anchor",href:"#_3-优惠卷秒杀","aria-label":'Permalink to "3. 优惠卷秒杀"'},"​")],-1)),l[581]||(l[581]=n("h4",{id:"_3-1-全局唯一id",tabindex:"-1"},[E("3.1 全局唯一ID "),n("a",{class:"header-anchor",href:"#_3-1-全局唯一id","aria-label":'Permalink to "3.1 全局唯一ID"'},"​")],-1)),l[582]||(l[582]=n("p",null,"每个店铺都可以发布优惠券：",-1)),l[583]||(l[583]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653362612286.png",alt:"1653362612286",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[584]||(l[584]=n("p",null,[E("当用户抢购时，就会生成订单并保存到"),n("code",null,"tb_voucher_order"),E("这张表中，而订单表如果使用数据库自增ID就存在一些问题：")],-1)),l[585]||(l[585]=n("ul",null,[n("li",null,"id的规律性太明显"),n("li",null,"受单表数据量的限制")],-1)),l[586]||(l[586]=n("p",null,"场景分析：如果我们的id具有太明显的规则，用户或者说商业对手很容易猜测出来我们的一些敏感信息，比如商城在一天时间内，卖出了多少单，这明显不合适。",-1)),l[587]||(l[587]=n("p",null,"场景分析二：随着我们商城规模越来越大，mysql的单表的容量不宜超过500W，数据量过大之后，我们要进行拆库拆表，但拆分表了之后，他们从逻辑上讲他们是同一张表，所以他们的id是不能一样的， 于是乎我们需要保证id的唯一性。",-1)),l[588]||(l[588]=n("p",null,[n("strong",null,"全局ID生成器"),E("，是一种在分布式系统下用来生成全局唯一ID的工具，一般要满足下列特性：")],-1)),l[589]||(l[589]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653363100502.png",alt:"1653363100502",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[590]||(l[590]=n("p",null,"为了增加ID的安全性，我们可以不直接使用Redis自增的数值，而是拼接一些其它信息：",-1)),l[591]||(l[591]=n("p",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653363172079.png",alt:"1653363172079"}),E("ID的组成部分：符号位：1bit，永远为0")],-1)),l[592]||(l[592]=n("p",null,"时间戳：31bit，以秒为单位，可以使用69年",-1)),l[593]||(l[593]=n("p",null,"序列号：32bit，秒内的计数器，支持每秒产生2^32个不同ID",-1)),l[594]||(l[594]=n("h4",{id:"_3-2-redis-实现全局唯一id",tabindex:"-1"},[E("3.2 Redis 实现全局唯一Id "),n("a",{class:"header-anchor",href:"#_3-2-redis-实现全局唯一id","aria-label":'Permalink to "3.2 Redis 实现全局唯一Id"'},"​")],-1)),l[595]||(l[595]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisIdWorker"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 开始时间戳")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BEGIN_TIMESTAMP "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1640995200L"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 序列号的位数")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," COUNT_BITS "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 32"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate stringRedisTemplate;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisIdWorker"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StringRedisTemplate "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"stringRedisTemplate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".stringRedisTemplate "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"keyPrefix"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.生成时间戳")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        LocalDateTime now "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," nowSecond "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toEpochSecond"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ZoneOffset.UTC);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," timestamp "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," nowSecond "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BEGIN_TIMESTAMP;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.生成序列号")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.1.获取当前日期，精确到天")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String date "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"format"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(DateTimeFormatter."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ofPattern"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"yyyy:MM:dd"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.2.自增长")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"increment"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"icr:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keyPrefix "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ":"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," date);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.拼接并返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," timestamp "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," COUNT_BITS "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"|"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[596]||(l[596]=n("p",null,"测试类",-1)),l[597]||(l[597]=n("p",null,"知识小贴士：关于countdownlatch",-1)),l[598]||(l[598]=n("p",null,"countdownlatch名为信号枪：主要的作用是同步协调在多线程的等待于唤醒问题",-1)),l[599]||(l[599]=n("p",null,"我们如果没有CountDownLatch ，那么由于程序是异步的，当异步程序没有执行完时，主线程就已经执行完了，然后我们期望的是分线程全部走完之后，主线程再走，所以我们此时需要使用到CountDownLatch",-1)),l[600]||(l[600]=n("p",null,"CountDownLatch 中有两个最重要的方法",-1)),l[601]||(l[601]=n("p",null,"1、countDown",-1)),l[602]||(l[602]=n("p",null,"2、await",-1)),l[603]||(l[603]=n("p",null,"await 方法 是阻塞方法，我们担心分线程没有执行完时，main线程就先执行，所以使用await可以让main线程阻塞，那么什么时候main线程不再阻塞呢？当CountDownLatch 内部维护的 变量变为0时，就不再阻塞，直接放行，那么什么时候CountDownLatch 维护的变量变为0 呢，我们只需要调用一次countDown ，内部变量就减少1，我们让分线程和变量绑定， 执行完一个分线程就减少一个变量，当分线程全部走完，CountDownLatch 维护的变量就是0，此时await就不再阻塞，统计出来的时间也就是所有分线程执行完后的时间。",-1)),l[604]||(l[604]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testIdWorker"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws InterruptedException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CountDownLatch latch "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CountDownLatch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"300"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Runnable task "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," () "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id = "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        latch."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"countDown"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    };")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," begin "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 300"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        es."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(task);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    latch."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"await"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," end "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"time = "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (end "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," begin));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[605]||(l[605]=n("h4",{id:"_3-3-添加优惠卷",tabindex:"-1"},[E("3.3 添加优惠卷 "),n("a",{class:"header-anchor",href:"#_3-3-添加优惠卷","aria-label":'Permalink to "3.3 添加优惠卷"'},"​")],-1)),l[606]||(l[606]=n("p",null,"每个店铺都可以发布优惠券，分为平价券和特价券。平价券可以任意购买，而特价券需要秒杀抢购：",-1)),l[607]||(l[607]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653365145124.png",alt:"1653365145124",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[608]||(l[608]=n("p",null,[n("code",null,"tb_voucher"),E("：优惠券的基本信息，优惠金额、使用规则等 "),n("code",null,"tb_seckill_voucher"),E("：优惠券的库存、开始抢购时间，结束抢购时间。特价优惠券才需要填写这些信息")],-1)),l[609]||(l[609]=n("p",null,"平价卷由于优惠力度并不是很大，所以是可以任意领取",-1)),l[610]||(l[610]=n("p",null,"而代金券由于优惠力度大，所以像第二种卷，就得限制数量，从表结构上也能看出，特价卷除了具有优惠卷的基本信息以外，还具有库存，抢购时间，结束时间等等字段",-1)),l[611]||(l[611]=n("p",null,"**新增普通卷代码： **VoucherController",-1)),l[612]||(l[612]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestBody"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Voucher voucher) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[613]||(l[613]=n("p",null,[n("strong",null,"新增秒杀卷代码：")],-1)),l[614]||(l[614]=n("p",null,[n("strong",null,"VoucherController")],-1)),l[615]||(l[615]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"seckill"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addSeckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestBody"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Voucher voucher) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addSeckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[616]||(l[616]=n("p",null,[n("strong",null,"VoucherServiceImpl")],-1)),l[617]||(l[617]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addSeckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Voucher voucher) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存优惠券")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存秒杀信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SeckillVoucher seckillVoucher "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SeckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setBeginTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setEndTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(seckillVoucher);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存秒杀库存到Redis中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SECKILL_STOCK_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[618]||(l[618]=n("h4",{id:"_3-4-实现秒杀下单",tabindex:"-1"},[E("3.4 实现秒杀下单 "),n("a",{class:"header-anchor",href:"#_3-4-实现秒杀下单","aria-label":'Permalink to "3.4 实现秒杀下单"'},"​")],-1)),l[619]||(l[619]=n("p",null,"下单核心思路：当我们点击抢购时，会触发右侧的请求，我们只需要编写对应的controller即可",-1)),l[620]||(l[620]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653365839526.png",alt:"1653365839526",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[621]||(l[621]=n("p",null,"秒杀下单应该思考的内容：",-1)),l[622]||(l[622]=n("p",null,"下单时需要判断两点：",-1)),l[623]||(l[623]=n("ul",null,[n("li",null,"秒杀是否开始或结束，如果尚未开始或已经结束则无法下单"),n("li",null,"库存是否充足，不足则无法下单")],-1)),l[624]||(l[624]=n("p",null,"下单核心逻辑分析：",-1)),l[625]||(l[625]=n("p",null,"当用户开始进行下单，我们应当去查询优惠卷信息，查询到优惠卷信息，判断是否满足秒杀条件",-1)),l[626]||(l[626]=n("p",null,"比如时间是否充足，如果时间充足，则进一步判断库存是否足够，如果两者都满足，则扣减库存，创建订单，然后返回订单id，如果有一个条件不满足则直接结束。",-1)),l[627]||(l[627]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653366238564.png",alt:"1653366238564",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[628]||(l[628]=n("p",null,[n("strong",null,"VoucherOrderServiceImpl")],-1)),l[629]||(l[629]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.查询优惠券")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SeckillVoucher voucher "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.判断秒杀是否开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 尚未开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀尚未开始！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.判断秒杀是否已经结束")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBefore"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 尚未开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀已经结束！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.判断库存是否充足")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 库存不足")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //5，扣减库存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock= stock -1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //扣减库存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //6.创建订单")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    VoucherOrder voucherOrder "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.1.订单id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.2.用户id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.3.代金券id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[630]||(l[630]=n("h4",{id:"_3-5-库存超卖问题分析",tabindex:"-1"},[E("3.5 库存超卖问题分析 "),n("a",{class:"header-anchor",href:"#_3-5-库存超卖问题分析","aria-label":'Permalink to "3.5 库存超卖问题分析"'},"​")],-1)),l[631]||(l[631]=n("p",null,"有关超卖问题分析：在我们原有代码中是这么写的",-1)),l[632]||(l[632]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 库存不足")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //5，扣减库存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock= stock -1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //扣减库存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[633]||(l[633]=n("p",null,"假设线程1过来查询库存，判断出来库存大于1，正准备去扣减库存，但是还没有来得及去扣减，此时线程2过来，线程2也去查询库存，发现这个数量一定也大于1，那么这两个线程都会去扣减库存，最终多个线程相当于一起去扣减库存，此时就会出现库存的超卖问题。",-1)),l[634]||(l[634]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653368335155.png",alt:"1653368335155",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[635]||(l[635]=n("p",null,"超卖问题是典型的多线程安全问题，针对这一问题的常见解决方案就是加锁：而对于加锁，我们通常有两种解决方案：见下图：",-1)),l[636]||(l[636]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653368562591.png",alt:"1653368562591",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[637]||(l[637]=n("p",null,[n("strong",null,"悲观锁：")],-1)),l[638]||(l[638]=n("p",null,"悲观锁可以实现对于数据的串行化执行，比如syn，和lock都是悲观锁的代表，同时，悲观锁中又可以再细分为公平锁，非公平锁，可重入锁，等等",-1)),l[639]||(l[639]=n("p",null,[n("strong",null,"乐观锁：")],-1)),l[640]||(l[640]=n("p",null,"乐观锁：会有一个版本号，每次操作数据会对版本号+1，再提交回数据时，会去校验是否比之前的版本大1 ，如果大1 ，则进行操作成功，这套机制的核心逻辑在于，如果在操作过程中，版本号只比原来大1 ，那么就意味着操作过程中没有人对他进行过修改，他的操作就是安全的，如果不大1，则数据被修改过，当然乐观锁还有一些变种的处理方式比如cas",-1)),l[641]||(l[641]=n("p",null,"乐观锁的典型代表：就是cas，利用cas进行无锁化机制加锁，var5 是操作前读取的内存值，while中的var1+var2 是预估值，如果预估值 == 内存值，则代表中间没有被人修改过，此时就将新值去替换 内存值",-1)),l[642]||(l[642]=n("p",null,"其中do while 是为了在操作失败时，再次进行自旋操作，即把之前的逻辑再操作一次。",-1)),l[643]||(l[643]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," var5;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"do"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    var5 "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIntVolatile"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(var1, var2);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSwapInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(var1, var2, var5, var5 "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," var4));")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," var5;")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[644]||(l[644]=n("p",null,[n("strong",null,"课程中的使用方式：")],-1)),l[645]||(l[645]=n("p",null,"课程中的使用方式是没有像cas一样带自旋的操作，也没有对version的版本号+1 ，他的操作逻辑是在操作时，对版本号进行+1 操作，然后要求version 如果是1 的情况下，才能操作，那么第一个线程在操作后，数据库中的version变成了2，但是他自己满足version=1 ，所以没有问题，此时线程2执行，线程2 最后也需要加上条件version =1 ，但是现在由于线程1已经操作过了，所以线程2，操作时就不满足version=1 的条件了，所以线程2无法执行成功",-1)),l[646]||(l[646]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653369268550.png",alt:"1653369268550",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[647]||(l[647]=n("h4",{id:"_3-6-乐观锁解决超卖问题",tabindex:"-1"},[E("3.6 乐观锁解决超卖问题 "),n("a",{class:"header-anchor",href:"#_3-6-乐观锁解决超卖问题","aria-label":'Permalink to "3.6 乐观锁解决超卖问题"'},"​")],-1)),l[648]||(l[648]=n("p",null,[n("strong",null,"修改代码方案一"),E("：")],-1)),l[649]||(l[649]=n("p",null,"VoucherOrderServiceImpl 在扣减库存时，改为：",-1)),l[650]||(l[650]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock= stock -1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//set stock = stock -1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(); "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//where id = ？ and stock = ?")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[651]||(l[651]=n("p",null,"以上逻辑的核心含义是：只要我扣减库存时的库存和之前我查询到的库存是一样的，就意味着没有人在中间修改过库存，那么此时就是安全的，但是以上这种方式通过测试发现会有很多失败的情况，失败的原因在于：在使用乐观锁过程中假设100个线程同时都拿到了100的库存，然后大家一起去进行扣减，但是100个人中只有1个人能扣减成功，其他的人在处理时，他们在扣减时，库存已经被修改过了，所以此时其他线程都会失败",-1)),l[652]||(l[652]=n("p",null,[n("strong",null,"修改代码方案二"),E("：")],-1)),l[653]||(l[653]=n("p",null,"之前的方式要修改前后都保持一致，但是这样我们分析过，成功的概率太低，所以我们的乐观锁需要变一下，改成stock大于0 即可",-1)),l[654]||(l[654]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock= stock -1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"); "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//where id = ? and stock > 0")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[655]||(l[655]=n("p",null,[n("strong",null,"知识小扩展：")],-1)),l[656]||(l[656]=n("p",null,"针对cas中的自旋压力过大，我们可以使用Longaddr这个类去解决",-1)),l[657]||(l[657]=n("p",null,"Java8 提供的一个对AtomicLong改进后的一个类，LongAdder",-1)),l[658]||(l[658]=n("p",null,"大量线程并发更新一个原子性的时候，天然的问题就是自旋，会导致并发性问题，当然这也比我们直接使用syn来的好",-1)),l[659]||(l[659]=n("p",null,"所以利用这么一个类，LongAdder来进行优化",-1)),l[660]||(l[660]=n("p",null,"如果获取某个值，则会对cell和base的值进行递增，最后返回一个完整的值",-1)),l[661]||(l[661]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653370271627.png",alt:"1653370271627",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[662]||(l[662]=n("h4",{id:"_3-6-优惠券秒杀-一人一单",tabindex:"-1"},[E("3.6 优惠券秒杀 - 一人一单 "),n("a",{class:"header-anchor",href:"#_3-6-优惠券秒杀-一人一单","aria-label":'Permalink to "3.6 优惠券秒杀 - 一人一单"'},"​")],-1)),l[663]||(l[663]=n("p",null,"需求：修改秒杀业务，要求同一个优惠券，一个用户只能下一单",-1)),l[664]||(l[664]=n("p",null,[n("strong",null,"现在的问题在于：")],-1)),l[665]||(l[665]=n("p",null,"优惠卷是为了引流，但是目前的情况是，一个人可以无限制的抢这个优惠卷，所以我们应当增加一层逻辑，让一个用户只能下一个单，而不是让一个用户下多个单",-1)),l[666]||(l[666]=n("p",null,"具体操作逻辑如下：比如时间是否充足，如果时间充足，则进一步判断库存是否足够，然后再根据优惠卷id和用户id查询是否已经下过这个订单，如果下过这个订单，则不再下单，否则进行下单",-1)),l[667]||(l[667]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653371854389.png",alt:"1653371854389",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[668]||(l[668]=n("p",null,[n("strong",null,"VoucherOrderServiceImpl")],-1)),l[669]||(l[669]=n("p",null,[n("strong",null,"初步代码：增加一人一单逻辑")],-1)),l[670]||(l[670]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.查询优惠券")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SeckillVoucher voucher "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.判断秒杀是否开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 尚未开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀尚未开始！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.判断秒杀是否已经结束")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBefore"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 尚未开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀已经结束！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.判断库存是否充足")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 库存不足")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.一人一单逻辑")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.1.用户id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.2.判断是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 用户已经购买过了")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"用户已经购买过一次！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //6，扣减库存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock= stock -1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //扣减库存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //7.创建订单")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    VoucherOrder voucherOrder "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.1.订单id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.3.代金券id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[671]||(l[671]=n("p",null,"**存在问题：**现在的问题还是和之前一样，并发过来，查询数据库，都不存在订单，所以我们还是需要加锁，但是乐观锁比较适合更新数据，而现在是插入数据，所以我们需要使用悲观锁操作",-1)),l[672]||(l[672]=n("p",null,"**注意：**在这里提到了非常多的问题，我们需要慢慢的来思考，首先我们的初始方案是封装了一个createVoucherOrder方法，同时为了确保他线程安全，在方法上添加了一把synchronized 锁，",-1)),l[673]||(l[673]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," synchronized"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createVoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\tLong userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         // 5.1.查询订单")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.2.判断是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 用户已经购买过了")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"用户已经购买过一次！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.扣减库存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock = stock - 1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// set stock = stock - 1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// where id = ? and stock > 0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 扣减失败")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.创建订单")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        VoucherOrder voucherOrder "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.1.订单id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.2.用户id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.3.代金券id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.返回订单id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[674]||(l[674]=n("p",null,[E("但是这样添加锁，锁的粒度太粗了，在使用锁过程中，控制"),n("strong",null,"锁粒度"),E(" 是一个非常重要的事情，因为如果锁的粒度太大，会导致每个线程进来都会锁住，所以我们需要去控制锁的粒度，以下这段代码需要修改为： "),n("code",null,"intern()"),E(" 这个方法是从常量池中拿到数据，如果我们直接使用"),n("code",null,"userId.toString()"),E(" 他拿到的对象实际上是不同的对象，new出来的对象，我们使用锁必须保证锁必须是同一把，所以我们需要使用intern()方法")],-1)),l[675]||(l[675]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createVoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\tLong userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tsynchronized"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"intern"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         // 5.1.查询订单")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.2.判断是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 用户已经购买过了")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"用户已经购买过一次！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.扣减库存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock = stock - 1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// set stock = stock - 1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// where id = ? and stock > 0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 扣减失败")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.创建订单")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        VoucherOrder voucherOrder "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.1.订单id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.2.用户id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.3.代金券id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.返回订单id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[676]||(l[676]=n("p",null,"但是以上代码还是存在问题，问题的原因在于当前方法被spring的事务控制，如果你在方法内部加锁，可能会导致当前方法事务还没有提交，但是锁已经释放也会导致问题，所以我们选择将当前方法整体包裹起来，确保事务不会出现问题：如下：",-1)),l[677]||(l[677]=n("p",null,"在seckillVoucher 方法中，添加以下逻辑，这样就能保证事务的特性，同时也控制了锁的粒度",-1)),l[678]||(l[678]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653373434815.png",alt:"1653373434815",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[679]||(l[679]=n("p",null,"但是以上做法依然有问题，因为你调用的方法，其实是this.的方式调用的，事务想要生效，还得利用代理来生效，所以这个地方，我们需要获得原始的事务对象， 来操作事务",-1)),l[680]||(l[680]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653383810643.png",alt:"1653383810643",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[681]||(l[681]=n("h4",{id:"_3-7-集群环境下的并发问题",tabindex:"-1"},[E("3.7 集群环境下的并发问题 "),n("a",{class:"header-anchor",href:"#_3-7-集群环境下的并发问题","aria-label":'Permalink to "3.7 集群环境下的并发问题"'},"​")],-1)),l[682]||(l[682]=n("p",null,"通过加锁可以解决在单机情况下的一人一单安全问题，但是在集群模式下就不行了。",-1)),l[683]||(l[683]=n("p",null,"1、我们将服务启动两份，端口分别为8081和8082：",-1)),l[684]||(l[684]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653373887844.png",alt:"1653373887844",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[685]||(l[685]=n("p",null,"2、然后修改nginx的conf目录下的nginx.conf文件，配置反向代理和负载均衡：",-1)),l[686]||(l[686]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653373908620.png",alt:"1653373908620",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[687]||(l[687]=n("p",null,[n("strong",null,"具体操作(略)")],-1)),l[688]||(l[688]=n("p",null,[n("strong",null,"有关锁失效原因分析")],-1)),l[689]||(l[689]=n("p",null,"由于现在我们部署了多个tomcat，每个tomcat都有一个属于自己的jvm，那么假设在服务器A的tomcat内部，有两个线程，这两个线程由于使用的是同一份代码，那么他们的锁对象是同一个，是可以实现互斥的，但是如果现在是服务器B的tomcat内部，又有两个线程，但是他们的锁对象写的虽然和服务器A一样，但是锁对象却不是同一个，所以线程3和线程4可以实现互斥，但是却无法和线程1和线程2实现互斥，这就是 集群环境下，syn锁失效的原因，在这种情况下，我们就需要使用分布式锁来解决这个问题。",-1)),l[690]||(l[690]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653374044740.png",alt:"1653374044740",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[691]||(l[691]=n("h3",{id:"_4-分布式锁",tabindex:"-1"},[E("4. 分布式锁 "),n("a",{class:"header-anchor",href:"#_4-分布式锁","aria-label":'Permalink to "4. 分布式锁"'},"​")],-1)),l[692]||(l[692]=n("h4",{id:"_4-1-基本原理和实现方式对比",tabindex:"-1"},[E("4.1 基本原理和实现方式对比 "),n("a",{class:"header-anchor",href:"#_4-1-基本原理和实现方式对比","aria-label":'Permalink to "4.1 基本原理和实现方式对比"'},"​")],-1)),l[693]||(l[693]=n("p",null,"分布式锁：满足分布式系统或集群模式下多进程可见并且互斥的锁。",-1)),l[694]||(l[694]=n("p",null,"分布式锁的核心思想就是让大家都使用同一把锁，只要大家使用的是同一把锁，那么我们就能锁住线程，不让线程进行，让程序串行执行，这就是分布式锁的核心思路",-1)),l[695]||(l[695]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653374296906.png",alt:"1653374296906",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[696]||(l[696]=n("p",null,"那么分布式锁他应该满足一些什么样的条件呢？",-1)),l[697]||(l[697]=n("p",null,"可见性：多个线程都能看到相同的结果，注意：这个地方说的可见性并不是并发编程中指的内存可见性，只是说多个进程之间都能感知到变化的意思",-1)),l[698]||(l[698]=n("p",null,"互斥：互斥是分布式锁的最基本的条件，使得程序串行执行",-1)),l[699]||(l[699]=n("p",null,"高可用：程序不易崩溃，时时刻刻都保证较高的可用性",-1)),l[700]||(l[700]=n("p",null,"高性能：由于加锁本身就让性能降低，所有对于分布式锁本身需要他就较高的加锁性能和释放锁性能",-1)),l[701]||(l[701]=n("p",null,"安全性：安全也是程序中必不可少的一环",-1)),l[702]||(l[702]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653381992018.png",alt:"1653381992018",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[703]||(l[703]=n("p",null,"常见的分布式锁有三种",-1)),l[704]||(l[704]=n("p",null,"Mysql：mysql本身就带有锁机制，但是由于mysql性能本身一般，所以采用分布式锁的情况下，其实使用mysql作为分布式锁比较少见",-1)),l[705]||(l[705]=n("p",null,"Redis：redis作为分布式锁是非常常见的一种使用方式，现在企业级开发中基本都使用redis或者zookeeper作为分布式锁，利用setnx这个方法，如果插入key成功，则表示获得到了锁，如果有人插入成功，其他人插入失败则表示无法获得到锁，利用这套逻辑来实现分布式锁",-1)),l[706]||(l[706]=n("p",null,"Zookeeper：zookeeper也是企业级开发中较好的一个实现分布式锁的方案，由于本套视频并不讲解zookeeper的原理和分布式锁的实现，所以不过多阐述",-1)),l[707]||(l[707]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653382219377.png",alt:"1653382219377",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[708]||(l[708]=n("h4",{id:"_4-2-redis-分布式锁的实现核心思路",tabindex:"-1"},[E("4.2 Redis 分布式锁的实现核心思路 "),n("a",{class:"header-anchor",href:"#_4-2-redis-分布式锁的实现核心思路","aria-label":'Permalink to "4.2 Redis 分布式锁的实现核心思路"'},"​")],-1)),l[709]||(l[709]=n("p",null,"实现分布式锁时需要实现的两个基本方法：",-1)),l[710]||(l[710]=n("ul",null,[n("li",null,[n("p",null,"获取锁："),n("ul",null,[n("li",null,"互斥：确保只能有一个线程获取锁"),n("li",null,"非阻塞：尝试一次，成功返回true，失败返回false")])]),n("li",null,[n("p",null,"释放锁："),n("ul",null,[n("li",null,"手动释放"),n("li",null,"超时释放：获取锁时添加一个超时时间")]),n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653382669900.png",alt:"1653382669900",loading:"lazy",decoding:"async",class:"lazy"})])])],-1)),l[711]||(l[711]=n("p",null,"核心思路：",-1)),l[712]||(l[712]=n("p",null,"我们利用redis 的setNx 方法，当有多个线程进入时，我们就利用该方法，第一个线程进入时，redis 中就有这个key 了，返回了1，如果结果是1，则表示他抢到了锁，那么他去执行业务，然后再删除锁，退出锁逻辑，没有抢到锁的哥们，等待一定时间后重试即可",-1)),l[713]||(l[713]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653382830810.png",alt:"1653382830810",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[714]||(l[714]=n("h4",{id:"_4-3-实现分布式锁版本一",tabindex:"-1"},[E("4.3 实现分布式锁版本一 "),n("a",{class:"header-anchor",href:"#_4-3-实现分布式锁版本一","aria-label":'Permalink to "4.3 实现分布式锁版本一"'},"​")],-1)),l[715]||(l[715]=n("ul",null,[n("li",null,"加锁逻辑")],-1)),l[716]||(l[716]=n("p",null,[n("strong",null,"锁的基本接口")],-1)),l[717]||(l[717]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1656079017728.png",alt:"1656079017728",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[718]||(l[718]=n("p",null,[n("strong",null,"SimpleRedisLock")],-1)),l[719]||(l[719]=n("p",null,"利用setnx方法进行加锁，同时增加过期时间，防止死锁，此方法可以保证加锁和增加过期时间具有原子性",-1)),l[720]||(l[720]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String KEY_PREFIX"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lock:"')]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," timeoutSec) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取线程标示")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String threadId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Boolean success "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIfAbsent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name, threadId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ""'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", timeoutSec, TimeUnit.SECONDS);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean.TRUE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(success);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[721]||(l[721]=n("ul",null,[n("li",null,"释放锁逻辑")],-1)),l[722]||(l[722]=n("p",null,"SimpleRedisLock",-1)),l[723]||(l[723]=n("p",null,"释放锁，防止删除别人的锁",-1)),l[724]||(l[724]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //通过del删除锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"delete"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[725]||(l[725]=n("ul",null,[n("li",null,"修改业务代码")],-1)),l[726]||(l[726]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.查询优惠券")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SeckillVoucher voucher "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断秒杀是否开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 尚未开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀尚未开始！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.判断秒杀是否已经结束")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBefore"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 尚未开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀已经结束！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.判断库存是否充足")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 库存不足")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //创建锁对象(新增代码)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SimpleRedisLock lock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SimpleRedisLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId, stringRedisTemplate);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //获取锁对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lock."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1200"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t//加锁失败")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isLock) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"不允许重复下单"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //获取代理对象(事务)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            IVoucherOrderService proxy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (IVoucherOrderService) AopContext."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentProxy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," proxy."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createVoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //释放锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            lock."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[727]||(l[727]=n("h4",{id:"_4-4-redis-分布式锁误删情况说明",tabindex:"-1"},[E("4.4 Redis 分布式锁误删情况说明 "),n("a",{class:"header-anchor",href:"#_4-4-redis-分布式锁误删情况说明","aria-label":'Permalink to "4.4 Redis 分布式锁误删情况说明"'},"​")],-1)),l[728]||(l[728]=n("p",null,"逻辑说明：",-1)),l[729]||(l[729]=n("p",null,"持有锁的线程在锁的内部出现了阻塞，导致他的锁自动释放，这时其他线程，线程2来尝试获得锁，就拿到了这把锁，然后线程2在持有锁执行过程中，线程1反应过来，继续执行，而线程1执行过程中，走到了删除锁逻辑，此时就会把本应该属于线程2的锁进行删除，这就是误删别人锁的情况说明",-1)),l[730]||(l[730]=n("p",null,"解决方案：解决方案就是在每个线程释放锁的时候，去判断一下当前这把锁是否属于自己，如果属于自己，则不进行锁的删除，假设还是上边的情况，线程1卡顿，锁自动释放，线程2进入到锁的内部执行逻辑，此时线程1反应过来，然后删除锁，但是线程1，一看当前这把锁不是属于自己，于是不进行删除锁逻辑，当线程2走到删除锁逻辑时，如果没有卡过自动释放锁的时间点，则判断当前这把锁是属于自己的，于是删除这把锁。",-1)),l[731]||(l[731]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653385920025.png",alt:"1653385920025",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[732]||(l[732]=n("h4",{id:"_4-5-解决-redis-分布式锁误删问题",tabindex:"-1"},[E("4.5 解决 Redis 分布式锁误删问题 "),n("a",{class:"header-anchor",href:"#_4-5-解决-redis-分布式锁误删问题","aria-label":'Permalink to "4.5 解决 Redis 分布式锁误删问题"'},"​")],-1)),l[733]||(l[733]=n("p",null,"需求：修改之前的分布式锁实现，满足：在获取锁时存入线程标示（可以用UUID表示） 在释放锁时先获取锁中的线程标示，判断是否与当前线程标示一致",-1)),l[734]||(l[734]=n("ul",null,[n("li",null,"如果一致则释放锁"),n("li",null,"如果不一致则不释放锁")],-1)),l[735]||(l[735]=n("p",null,"核心逻辑：在存入锁时，放入自己线程的标识，在删除锁时，判断当前这把锁的标识是不是自己存入的，如果是，则进行删除，如果不是，则不进行删除。",-1)),l[736]||(l[736]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653387398820.png",alt:"1653387398820",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[737]||(l[737]=n("p",null,"具体代码如下：加锁",-1)),l[738]||(l[738]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String ID_PREFIX "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UUID."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomUUID"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "-"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," timeoutSec) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   // 获取线程标示")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"   String threadId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ID_PREFIX "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   // 获取锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"   Boolean success "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIfAbsent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name, threadId, timeoutSec, TimeUnit.SECONDS);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"   return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean.TRUE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(success);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[739]||(l[739]=n("p",null,"释放锁",-1)),l[740]||(l[740]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取线程标示")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String threadId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ID_PREFIX "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取锁中的标示")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String id "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断标示是否一致")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(threadId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 释放锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"delete"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[741]||(l[741]=n("p",null,[n("strong",null,"有关代码实操说明：")],-1)),l[742]||(l[742]=n("p",null,"在我们修改完此处代码后，我们重启工程，然后启动两个线程，第一个线程持有锁后，手动释放锁，第二个线程 此时进入到锁内部，再放行第一个线程，此时第一个线程由于锁的value值并非是自己，所以不能释放锁，也就无法删除别人的锁，此时第二个线程能够正确释放锁，通过这个案例初步说明我们解决了锁误删的问题。",-1)),l[743]||(l[743]=n("h4",{id:"_4-6-分布式锁的原子性问题",tabindex:"-1"},[E("4.6 分布式锁的原子性问题 "),n("a",{class:"header-anchor",href:"#_4-6-分布式锁的原子性问题","aria-label":'Permalink to "4.6 分布式锁的原子性问题"'},"​")],-1)),l[744]||(l[744]=n("p",null,"更为极端的误删逻辑说明：",-1)),l[745]||(l[745]=n("p",null,"线程1现在持有锁之后，在执行业务逻辑过程中，他正准备删除锁，而且已经走到了条件判断的过程中，比如他已经拿到了当前这把锁确实是属于他自己的，正准备删除锁，但是此时他的锁到期了，那么此时线程2进来，但是线程1他会接着往后执行，当他卡顿结束后，他直接就会执行删除锁那行代码，相当于条件判断并没有起到作用，这就是删锁时的原子性问题，之所以有这个问题，是因为线程1的拿锁，比锁，删锁，实际上并不是原子性的，我们要防止刚才的情况发生，",-1)),l[746]||(l[746]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653387764938.png",alt:"1653387764938",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[747]||(l[747]=n("h4",{id:"_4-7-lua-脚本解决多条命令原子性问题",tabindex:"-1"},[E("4.7 Lua 脚本解决多条命令原子性问题 "),n("a",{class:"header-anchor",href:"#_4-7-lua-脚本解决多条命令原子性问题","aria-label":'Permalink to "4.7 Lua 脚本解决多条命令原子性问题"'},"​")],-1)),l[748]||(l[748]=n("p",null,[E("Redis提供了Lua脚本功能，在一个脚本中编写多条Redis命令，确保多条命令执行时的原子性。Lua是一种编程语言，它的基本语法大家可以参考网站："),n("a",{href:"https://www.runoob.com/lua/lua-tutorial.html%EF%BC%8C%E8%BF%99%E9%87%8C%E9%87%8D%E7%82%B9%E4%BB%8B%E7%BB%8DRedis%E6%8F%90%E4%BE%9B%E7%9A%84%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8lua%E5%8E%BB%E6%93%8D%E4%BD%9Credis%EF%BC%8C%E5%8F%88%E8%83%BD%E4%BF%9D%E8%AF%81%E4%BB%96%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E6%8B%BF%E9%94%81%E6%AF%94%E9%94%81%E5%88%A0%E9%94%81%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8E%9F%E5%AD%90%E6%80%A7%E5%8A%A8%E4%BD%9C%E4%BA%86%EF%BC%8C%E4%BD%9C%E4%B8%BAJava%E7%A8%8B%E5%BA%8F%E5%91%98%E8%BF%99%E4%B8%80%E5%9D%97%E5%B9%B6%E4%B8%8D%E4%BD%9C%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E8%A6%81%E6%B1%82%EF%BC%8C%E5%B9%B6%E4%B8%8D%E9%9C%80%E8%A6%81%E5%A4%A7%E5%AE%B6%E8%BF%87%E4%BA%8E%E7%B2%BE%E9%80%9A%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E4%BB%96%E6%9C%89%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8%E5%8D%B3%E5%8F%AF%E3%80%82",target:"_blank",rel:"noreferrer"},"https://www.runoob.com/lua/lua-tutorial.html，这里重点介绍Redis提供的调用函数，我们可以使用lua去操作redis，又能保证他的原子性，这样就可以实现拿锁比锁删锁是一个原子性动作了，作为Java程序员这一块并不作一个简单要求，并不需要大家过于精通，只需要知道他有什么作用即可。")],-1)),l[749]||(l[749]=n("p",null,"这里重点介绍Redis提供的调用函数，语法如下：",-1)),l[750]||(l[750]=n("div",{class:"language-lua max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"lua"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'命令名称'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'key'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'其它参数'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"..."),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[751]||(l[751]=n("p",null,"例如，我们要执行set name jack，则脚本是这样：",-1)),l[752]||(l[752]=n("div",{class:"language-lua max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"lua"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"#"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 执行 set name jack")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'set'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'name'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'jack'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[753]||(l[753]=n("p",null,"例如，我们要先执行set name Rose，再执行get name，则脚本如下：",-1)),l[754]||(l[754]=n("div",{class:"language-lua max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"lua"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"#"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 先执行 set name jack")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'set'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'name'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'Rose'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"#"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 再执行 get name")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'get'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'name'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"#"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[755]||(l[755]=n("p",null,"写好脚本以后，需要用Redis命令来调用脚本，调用脚本的常见命令如下：",-1)),l[756]||(l[756]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653392181413.png",alt:"1653392181413",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[757]||(l[757]=n("p",null,"例如，我们要执行 redis.call('set', 'name', 'jack') 这个脚本，语法如下：",-1)),l[758]||(l[758]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653392218531.png",alt:"1653392218531",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[759]||(l[759]=n("p",null,"如果脚本中的key、value不想写死，可以作为参数传递。key类型参数会放入KEYS数组，其它参数会放入ARGV数组，在脚本中可以从KEYS和ARGV数组获取这些参数：",-1)),l[760]||(l[760]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653392438917.png",alt:"1653392438917",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[761]||(l[761]=n("p",null,"接下来我们来回一下我们释放锁的逻辑：",-1)),l[762]||(l[762]=n("p",null,"释放锁的业务流程是这样的",-1)),l[763]||(l[763]=n("p",null,"​ 1、获取锁中的线程标示",-1)),l[764]||(l[764]=n("p",null,"​ 2、判断是否与指定的标示（当前线程标示）一致",-1)),l[765]||(l[765]=n("p",null,"​ 3、如果一致则释放锁（删除）",-1)),l[766]||(l[766]=n("p",null,"​ 4、如果不一致则什么都不做",-1)),l[767]||(l[767]=n("p",null,"如果用Lua脚本来表示则是这样的：",-1)),l[768]||(l[768]=n("p",null,"最终我们操作redis的拿锁比锁删锁的lua脚本就会变成这样",-1)),l[769]||(l[769]=n("div",{class:"language-lua max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"lua"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 这里的 KEYS[1] 就是锁的key，这里的ARGV[1] 就是当前线程标示")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取锁中的标示，判断是否与当前线程标示一致")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (redis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'GET'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", KEYS["),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ARGV["),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  -- 一致，则删除锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DEL'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", KEYS["),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 不一致，则直接返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[770]||(l[770]=n("h4",{id:"_4-8-利用-java-代码调用-lua-脚本改造分布式锁",tabindex:"-1"},[E("4.8 利用 Java 代码调用 Lua 脚本改造分布式锁 "),n("a",{class:"header-anchor",href:"#_4-8-利用-java-代码调用-lua-脚本改造分布式锁","aria-label":'Permalink to "4.8 利用 Java 代码调用 Lua 脚本改造分布式锁"'},"​")],-1)),l[771]||(l[771]=n("p",null,"lua脚本本身并不需要大家花费太多时间去研究，只需要知道如何调用，大致是什么意思即可，所以在笔记中并不会详细的去解释这些lua表达式的含义。",-1)),l[772]||(l[772]=n("p",null,"我们的RedisTemplate中，可以利用execute方法去执行lua脚本，参数对应关系就如下图股",-1)),l[773]||(l[773]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653393304844.png",alt:"1653393304844",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[774]||(l[774]=n("p",null,[n("strong",null,"Java代码")],-1)),l[775]||(l[775]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DefaultRedisScript<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> UNLOCK_SCRIPT;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UNLOCK_SCRIPT "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DefaultRedisScript<>();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UNLOCK_SCRIPT."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setLocation"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ClassPathResource"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"unlock.lua"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UNLOCK_SCRIPT."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setResultType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long.class);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 调用lua脚本")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"execute"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            UNLOCK_SCRIPT,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Collections."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"singletonList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ID_PREFIX "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"经过以上代码改造后，我们就能够实现 拿锁比锁删锁的原子性动作了"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"~")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[776]||(l[776]=n("p",null,"小总结：",-1)),l[777]||(l[777]=n("p",null,"基于Redis的分布式锁实现思路：",-1)),l[778]||(l[778]=n("ul",null,[n("li",null,[E("利用"),n("code",null,"set nx ex"),E("获取锁，并设置过期时间，保存线程标示")]),n("li",null,[E("释放锁时先判断线程标示是否与自己一致，一致则删除锁 "),n("ul",null,[n("li",null,[E("特性： "),n("ul",null,[n("li",null,"利用set nx满足互斥性"),n("li",null,"利用set ex保证故障时锁依然能释放，避免死锁，提高安全性"),n("li",null,"利用Redis集群保证高可用和高并发特性")])])])])],-1)),l[779]||(l[779]=n("p",null,"笔者总结：我们一路走来，利用添加过期时间，防止死锁问题的发生，但是有了过期时间之后，可能出现误删别人锁的问题，这个问题我们开始是利用删之前 通过拿锁，比锁，删锁这个逻辑来解决的，也就是删之前判断一下当前这把锁是否是属于自己的，但是现在还有原子性问题，也就是我们没法保证拿锁比锁删锁是一个原子性的动作，最后通过lua表达式来解决这个问题",-1)),l[780]||(l[780]=n("p",null,"但是目前还剩下一个问题锁不住，什么是锁不住呢，你想一想，如果当过期时间到了之后，我们可以给他续期一下，比如续个30s，就好像是网吧上网， 网费到了之后，然后说，来，网管，再给我来10块的，是不是后边的问题都不会发生了，那么续期问题怎么解决呢，可以依赖于我们接下来要学习redission啦",-1)),l[781]||(l[781]=n("p",null,[n("strong",null,"测试逻辑：")],-1)),l[782]||(l[782]=n("p",null,"第一个线程进来，得到了锁，手动删除锁，模拟锁超时了，其他线程会执行lua来抢锁，当第一天线程利用lua删除锁时，lua能保证他不能删除他的锁，第二个线程删除锁时，利用lua同样可以保证不会删除别人的锁，同时还能保证原子性。",-1)),l[783]||(l[783]=n("h3",{id:"_5-分布式锁-redission",tabindex:"-1"},[E("5. 分布式锁 - Redission "),n("a",{class:"header-anchor",href:"#_5-分布式锁-redission","aria-label":'Permalink to "5. 分布式锁 - Redission"'},"​")],-1)),l[784]||(l[784]=n("h4",{id:"_5-1-分布式锁-redission-功能介绍",tabindex:"-1"},[E("5.1 分布式锁 - Redission 功能介绍 "),n("a",{class:"header-anchor",href:"#_5-1-分布式锁-redission-功能介绍","aria-label":'Permalink to "5.1 分布式锁 - Redission 功能介绍"'},"​")],-1)),l[785]||(l[785]=n("p",null,"基于setnx实现的分布式锁存在下面的问题：",-1)),l[786]||(l[786]=n("p",null,[n("strong",null,"重入问题"),E("：重入问题是指 获得锁的线程可以再次进入到相同的锁的代码块中，可重入锁的意义在于防止死锁，比如HashTable这样的代码中，他的方法都是使用synchronized修饰的，假如他在一个方法内，调用另一个方法，那么此时如果是不可重入的，不就死锁了吗？所以可重入锁他的主要意义是防止死锁，我们的synchronized和Lock锁都是可重入的。")],-1)),l[787]||(l[787]=n("p",null,[n("strong",null,"不可重试"),E("：是指目前的分布式只能尝试一次，我们认为合理的情况是：当线程在获得锁失败后，他应该能再次尝试获得锁。")],-1)),l[788]||(l[788]=n("p",null,"**超时释放：**我们在加锁时增加了过期时间，这样的我们可以防止死锁，但是如果卡顿的时间超长，虽然我们采用了lua表达式防止删锁的时候，误删别人的锁，但是毕竟没有锁住，有安全隐患",-1)),l[789]||(l[789]=n("p",null,[n("strong",null,"主从一致性："),E(" 如果Redis提供了主从集群，当我们向集群写数据时，主机需要异步的将数据同步给从机，而万一在同步过去之前，主机宕机了，就会出现死锁问题。")],-1)),l[790]||(l[790]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653546070602.png",alt:"1653546070602",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[791]||(l[791]=n("p",null,"那么什么是Redission呢",-1)),l[792]||(l[792]=n("p",null,"Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务，其中就包含了各种分布式锁的实现。",-1)),l[793]||(l[793]=n("p",null,"Redission提供了分布式锁的多种多样的功能",-1)),l[794]||(l[794]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653546736063.png",alt:"1653546736063",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[795]||(l[795]=n("h4",{id:"_5-2-分布式锁-redission-快速入门",tabindex:"-1"},[E("5.2 分布式锁 - Redission 快速入门 "),n("a",{class:"header-anchor",href:"#_5-2-分布式锁-redission-快速入门","aria-label":'Permalink to "5.2 分布式锁 - Redission 快速入门"'},"​")],-1)),l[796]||(l[796]=n("p",null,"引入依赖：",-1)),l[797]||(l[797]=n("div",{class:"language-xml max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"xml"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t<"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.redisson</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t<"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">redisson</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t<"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">3.13.6</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[798]||(l[798]=n("p",null,"配置Redisson客户端：",-1)),l[799]||(l[799]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedissonConfig"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedissonClient "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redissonClient"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 配置")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Config config "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Config"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        config."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"useSingleServer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAddress"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis://192.168.150.101:6379"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPassword"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建RedissonClient对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Redisson."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(config);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[800]||(l[800]=n("p",null,"如何使用Redission的分布式锁",-1)),l[801]||(l[801]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Resource")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedissionClient redissonClient;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testRedisson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws Exception{")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //获取锁(可重入)，指定锁的名称")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    RLock lock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redissonClient."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"anyLock"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //尝试获取锁，参数分别是：获取锁的最大等待时间(期间会重试)，锁自动释放时间，时间单位")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lock."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",TimeUnit.SECONDS);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //判断获取锁成功")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(isLock){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"执行业务"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");          ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //释放锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            lock."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[802]||(l[802]=n("p",null,"在 VoucherOrderServiceImpl",-1)),l[803]||(l[803]=n("p",null,"注入RedissonClient",-1)),l[804]||(l[804]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Resource")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedissonClient redissonClient;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.查询优惠券")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SeckillVoucher voucher "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断秒杀是否开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 尚未开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀尚未开始！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.判断秒杀是否已经结束")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBefore"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 尚未开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀已经结束！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.判断库存是否充足")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 库存不足")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //创建锁对象 这个代码不用了，因为我们现在要使用分布式锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'        //SimpleRedisLock lock = new SimpleRedisLock("order:" + userId, stringRedisTemplate);')]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RLock lock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redissonClient."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lock:order:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //获取锁对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lock."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"       ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t//加锁失败")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isLock) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"不允许重复下单"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //获取代理对象(事务)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            IVoucherOrderService proxy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (IVoucherOrderService) AopContext."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentProxy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," proxy."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createVoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //释放锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            lock."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[805]||(l[805]=n("h4",{id:"_5-3-分布式锁-redission-可重入锁原理",tabindex:"-1"},[E("5.3 分布式锁 - Redission 可重入锁原理 "),n("a",{class:"header-anchor",href:"#_5-3-分布式锁-redission-可重入锁原理","aria-label":'Permalink to "5.3 分布式锁 - Redission 可重入锁原理"'},"​")],-1)),l[806]||(l[806]=n("p",null,"在Lock锁中，他是借助于底层的一个voaltile的一个state变量来记录重入的状态的，比如当前没有人持有这把锁，那么state=0，假如有人持有这把锁，那么state=1，如果持有这把锁的人再次持有这把锁，那么state就会+1 ，如果是对于synchronized而言，他在c语言代码中会有一个count，原理和state类似，也是重入一次就加一，释放一次就-1 ，直到减少成0 时，表示当前这把锁没有被人持有。",-1)),l[807]||(l[807]=n("p",null,"在redission中，我们的也支持支持可重入锁",-1)),l[808]||(l[808]=n("p",null,"在分布式锁中，他采用hash结构用来存储锁，其中大key表示表示这把锁是否存在，用小key表示当前这把锁被哪个线程持有，所以接下来我们一起分析一下当前的这个lua表达式",-1)),l[809]||(l[809]=n("p",null,"这个地方一共有3个参数",-1)),l[810]||(l[810]=n("p",null,[n("strong",null,"KEYS[1] ： 锁名称")],-1)),l[811]||(l[811]=n("p",null,[n("strong",null,"ARGV[1]： 锁失效时间")],-1)),l[812]||(l[812]=n("p",null,[n("strong",null,[E("ARGV[2]： "),n("code",null,'id + ":" + threadId'),E("; 锁的小key")])],-1)),l[813]||(l[813]=n("p",null,"exists: 判断数据是否存在 name：是lock是否存在,如果==0，就表示当前这把锁不存在",-1)),l[814]||(l[814]=n("p",null,[n("code",null,"redis.call('hset', KEYS[1], ARGV[2], 1)"),E(";此时他就开始往redis里边去写数据 ，写成一个hash结构")],-1)),l[815]||(l[815]=n("p",null,[n("code",null,"Lock{")],-1)),l[816]||(l[816]=n("p",null,[E("​ "),n("code",null,'id + **":"** + threadId : 1')],-1)),l[817]||(l[817]=n("p",null,[n("code",null,"}")],-1)),l[818]||(l[818]=n("p",null,"如果当前这把锁存在，则第一个条件不满足，再判断",-1)),l[819]||(l[819]=n("p",null,[n("code",null,"redis.call('hexists', KEYS[1], ARGV[2]) == 1")],-1)),l[820]||(l[820]=n("p",null,"此时需要通过大key+小key判断当前这把锁是否是属于自己的，如果是自己的，则进行",-1)),l[821]||(l[821]=n("p",null,[n("code",null,"redis.call('hincrby', KEYS[1], ARGV[2], 1)")],-1)),l[822]||(l[822]=n("p",null,[E("将当前这个锁的value进行+1 ，"),n("code",null,"redis.call('pexpire', KEYS[1], ARGV[1])"),E("; 然后再对其设置过期时间，如果以上两个条件都不满足，则表示当前这把锁抢锁失败，最后返回pttl，即为当前这把锁的失效时间")],-1)),l[823]||(l[823]=n("p",null,[E("如果小伙帮们看了前边的源码， 你会发现他会去判断当前这个方法的返回值是否为null，如果是null，则对应则前两个if对应的条件，退出抢锁逻辑，如果返回的不是null，即走了第三个分支，在源码处会进行"),n("code",null,"while(true)"),E("的自旋抢锁。")],-1)),l[824]||(l[824]=n("div",{class:"language-lua max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"lua"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"\"if (redis.call('exists', KEYS[1]) == 0) then \" "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"                  \"redis.call('hset', KEYS[1], ARGV[2], 1); \" "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"                  \"redis.call('pexpire', KEYS[1], ARGV[1]); \" "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                  "return nil; " '),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'              "end; " '),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"              \"if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then \" "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"                  \"redis.call('hincrby', KEYS[1], ARGV[2], 1); \" "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"                  \"redis.call('pexpire', KEYS[1], ARGV[1]); \" "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                  "return nil; " '),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'              "end; " '),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"              \"return redis.call('pttl', KEYS[1]);\"")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[825]||(l[825]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653548087334.png",alt:"1653548087334",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[826]||(l[826]=n("h4",{id:"_5-4-分布式锁-redission-锁重试和-watchdog-机制",tabindex:"-1"},[E("5.4 分布式锁 - Redission 锁重试和 WatchDog 机制 "),n("a",{class:"header-anchor",href:"#_5-4-分布式锁-redission-锁重试和-watchdog-机制","aria-label":'Permalink to "5.4 分布式锁 - Redission 锁重试和 WatchDog 机制"'},"​")],-1)),l[827]||(l[827]=n("p",null,[n("strong",null,"说明"),E("：由于课程中已经说明了有关tryLock的源码解析以及其看门狗原理，所以笔者在这里给大家分析"),n("code",null,"lock()"),E("方法的源码解析，希望大家在学习过程中，能够掌握更多的知识")],-1)),l[828]||(l[828]=n("p",null,"抢锁过程中，获得当前线程，通过tryAcquire进行抢锁，该抢锁逻辑和之前逻辑相同",-1)),l[829]||(l[829]=n("p",null,"1、先判断当前这把锁是否存在，如果不存在，插入一把锁，返回null",-1)),l[830]||(l[830]=n("p",null,"2、判断当前这把锁是否是属于当前线程，如果是，则返回null",-1)),l[831]||(l[831]=n("p",null,[E("所以如果返回是null，则代表着当前这哥们已经抢锁完毕，或者可重入完毕，但是如果以上两个条件都不满足，则进入到第三个条件，返回的是锁的失效时间，同学们可以自行往下翻一点点，你能发现有个"),n("code",null,"while( true)"),E(" 再次进行tryAcquire进行抢锁")],-1)),l[832]||(l[832]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," threadId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Long ttl "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryAcquire"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", leaseTime, unit, threadId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// lock acquired")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ttl "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[833]||(l[833]=n("p",null,[E("接下来会有一个条件分支，因为lock方法有重载方法，一个是带参数，一个是不带参数，如果带带参数传入的值是-1，如果传入参数，则leaseTime是他本身，所以如果传入了参数，此时"),n("code",null,"leaseTime != -1"),E(" 则会进去抢锁，抢锁的逻辑就是之前说的那三个逻辑")],-1)),l[834]||(l[834]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (leaseTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLockInnerAsync"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[835]||(l[835]=n("p",null,[E("如果是没有传入时间，则此时也会进行抢锁， 而且抢锁时间是默认看门狗时间 "),n("code",null,"commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout()")],-1)),l[836]||(l[836]=n("p",null,[n("code",null,"ttlRemainingFuture.onComplete((ttlRemaining, e)"),E(" 这句话相当于对以上抢锁进行了监听，也就是说当上边抢锁完毕后，此方法会被调用，具体调用的逻辑就是去后台开启一个线程，进行续约逻辑，也就是看门狗线程")],-1)),l[837]||(l[837]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"RFuture<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ttlRemainingFuture "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLockInnerAsync"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(waitTime,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                        commandExecutor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getConnectionManager"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCfg"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLockWatchdogTimeout"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                        TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ttlRemainingFuture."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"onComplete"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((ttlRemaining, e) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // lock acquired")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ttlRemaining "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        scheduleExpirationRenewal"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(threadId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"});")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ttlRemainingFuture;")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[838]||(l[838]=n("p",null,[E("此逻辑就是续约逻辑，注意看"),n("code",null,"commandExecutor.getConnectionManager().newTimeout()"),E(" 此方法")],-1)),l[839]||(l[839]=n("p",null,[n("code",null,"Method(new TimerTask(){},参数2,参数3)")],-1)),l[840]||(l[840]=n("p",null,"指的是：通过参数2，参数3 去描述什么时候去做参数1的事情，现在的情况是：10s之后去做参数一的事情",-1)),l[841]||(l[841]=n("p",null,[E("因为锁的失效时间是30s，当10s之后，此时这个timeTask 就触发了，他就去进行续约，把当前这把锁续约成30s，如果操作成功，那么此时就会递归调用自己，再重新设置一个"),n("code",null,"timeTask()"),E("，于是再过10s后又再设置一个timerTask，完成不停的续约")],-1)),l[842]||(l[842]=n("p",null,"那么大家可以想一想，假设我们的线程出现了宕机他还会续约吗？当然不会，因为没有人再去调用renewExpiration这个方法，所以等到时间之后自然就释放了。",-1)),l[843]||(l[843]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," renewExpiration"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ExpirationEntry ee "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," EXPIRATION_RENEWAL_MAP."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEntryName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ee "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Timeout task "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," commandExecutor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getConnectionManager"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newTimeout"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," TimerTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Timeout "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"timeout"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ExpirationEntry ent "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," EXPIRATION_RENEWAL_MAP."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEntryName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ent "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Long threadId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ent."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getFirstThreadId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (threadId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            RFuture<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> future "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," renewExpirationAsync"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(threadId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            future."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"onComplete"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((res, e) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Can\'t update lock "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' " expiration"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (res) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // reschedule itself")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                    renewExpiration"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            });")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }, internalLockLeaseTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 3"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit.MILLISECONDS);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ee."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setTimeout"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(task);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[844]||(l[844]=n("h4",{id:"_5-5-分布式锁-redission-锁的-mutilock-原理",tabindex:"-1"},[E("5.5 分布式锁 - Redission 锁的 MutiLock 原理 "),n("a",{class:"header-anchor",href:"#_5-5-分布式锁-redission-锁的-mutilock-原理","aria-label":'Permalink to "5.5 分布式锁 - Redission 锁的 MutiLock 原理"'},"​")],-1)),l[845]||(l[845]=n("p",null,"为了提高redis的可用性，我们会搭建集群或者主从，现在以主从为例",-1)),l[846]||(l[846]=n("p",null,"此时我们去写命令，写在主机上， 主机会将数据同步给从机，但是假设在主机还没有来得及把数据写入到从机去的时候，此时主机宕机，哨兵会发现主机宕机，并且选举一个slave变成master，而此时新的master中实际上并没有锁信息，此时锁信息就已经丢掉了。",-1)),l[847]||(l[847]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653553998403.png",alt:"1653553998403",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[848]||(l[848]=n("p",null,"为了解决这个问题，redission提出来了MutiLock锁，使用这把锁咱们就不使用主从了，每个节点的地位都是一样的， 这把锁加锁的逻辑需要写入到每一个主丛节点上，只有所有的服务器都写入成功，此时才是加锁成功，假设现在某个节点挂了，那么他去获得锁的时候，只要有一个节点拿不到，都不能算是加锁成功，就保证了加锁的可靠性。",-1)),l[849]||(l[849]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653554055048.png",alt:"1653554055048",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[850]||(l[850]=n("p",null,"那么 MutiLock 加锁原理是什么呢？笔者画了一幅图来说明",-1)),l[851]||(l[851]=n("p",null,[E("当我们去设置了多个锁时，redission会将多个锁添加到一个集合中，然后用while循环去不停去尝试拿锁，但是会有一个总共的加锁时间，这个时间是用"),n("code",null,"需要加锁的个数 * 1500ms"),E(" ，假设有3个锁，那么时间就是4500ms，假设在这4500ms内，所有的锁都加锁成功， 那么此时才算是加锁成功，如果在4500ms有线程加锁失败，则会再次去进行重试.")],-1)),l[852]||(l[852]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653553093967.png",alt:"1653553093967",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[853]||(l[853]=n("h3",{id:"_6-秒杀优化",tabindex:"-1"},[E("6. 秒杀优化 "),n("a",{class:"header-anchor",href:"#_6-秒杀优化","aria-label":'Permalink to "6. 秒杀优化"'},"​")],-1)),l[854]||(l[854]=n("h4",{id:"_6-1-秒杀优化-异步秒杀思路",tabindex:"-1"},[E("6.1 秒杀优化 - 异步秒杀思路 "),n("a",{class:"header-anchor",href:"#_6-1-秒杀优化-异步秒杀思路","aria-label":'Permalink to "6.1 秒杀优化 - 异步秒杀思路"'},"​")],-1)),l[855]||(l[855]=n("p",null,"我们来回顾一下下单流程",-1)),l[856]||(l[856]=n("p",null,"当用户发起请求，此时会请求nginx，nginx会访问到tomcat，而tomcat中的程序，会进行串行操作，分成如下几个步骤",-1)),l[857]||(l[857]=n("ol",null,[n("li",null,"查询优惠卷"),n("li",null,"判断秒杀库存是否足够"),n("li",null,"查询订单"),n("li",null,"校验是否是一人一单"),n("li",null,"扣减库存"),n("li",null,"创建订单")],-1)),l[858]||(l[858]=n("p",null,"在这六步操作中，又有很多操作是要去操作数据库的，而且还是一个线程串行执行， 这样就会导致我们的程序执行的很慢，所以我们需要异步程序执行，那么如何加速呢？",-1)),l[859]||(l[859]=n("p",null,"在这里笔者想给大家分享一下课程内没有的思路，看看有没有小伙伴这么想，比如，我们可以不可以使用异步编排来做，或者说我开启N多线程，N多个线程，一个线程执行查询优惠卷，一个执行判断扣减库存，一个去创建订单等等，然后再统一做返回，这种做法和课程中有哪种好呢？答案是课程中的好，因为如果你采用我刚说的方式，如果访问的人很多，那么线程池中的线程可能一下子就被消耗完了，而且你使用上述方案，最大的特点在于，你觉得时效性会非常重要，但是你想想是吗？并不是，比如我只要确定他能做这件事，然后我后边慢慢做就可以了，我并不需要他一口气做完这件事，所以我们应当采用的是课程中，类似消息队列的方式来完成我们的需求，而不是使用线程池或者是异步编排的方式来完成这个需求",-1)),l[860]||(l[860]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653560986599.png",alt:"1653560986599",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[861]||(l[861]=n("p",null,"优化方案：我们将耗时比较短的逻辑判断放入到redis中，比如是否库存足够，比如是否一人一单，这样的操作，只要这种逻辑可以完成，就意味着我们是一定可以下单完成的，我们只需要进行快速的逻辑判断，根本就不用等下单逻辑走完，我们直接给用户返回成功， 再在后台开一个线程，后台线程慢慢的去执行queue里边的消息，这样程序不就超级快了吗？而且也不用担心线程池消耗殆尽的问题，因为这里我们的程序中并没有手动使用任何线程池，当然这里边有两个难点",-1)),l[862]||(l[862]=n("p",null,"第一个难点是我们怎么在redis中去快速校验一人一单，还有库存判断",-1)),l[863]||(l[863]=n("p",null,"第二个难点是由于我们校验和tomct下单是两个线程，那么我们如何知道到底哪个单他最后是否成功，或者是下单完成，为了完成这件事我们在redis操作完之后，我们会将一些信息返回给前端，同时也会把这些信息丢到异步queue中去，后续操作中，可以通过这个id来查询我们tomcat中的下单逻辑是否完成了。",-1)),l[864]||(l[864]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653561657295.png",alt:"1653561657295",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[865]||(l[865]=n("p",null,"我们现在来看看整体思路：当用户下单之后，判断库存是否充足只需要导redis中去根据key找对应的value是否大于0即可，如果不充足，则直接结束，如果充足，继续在redis中判断用户是否可以下单，如果set集合中没有这条数据，说明他可以下单，如果set集合中没有这条记录，则将userId和优惠卷存入到redis中，并且返回0，整个过程需要保证是原子性的，我们可以使用lua来操作",-1)),l[866]||(l[866]=n("p",null,"当以上判断逻辑走完之后，我们可以判断当前redis中返回的结果是否是0 ，如果是0，则表示可以下单，则将之前说的信息存入到到queue中去，然后返回，然后再来个线程异步的下单，前端可以通过返回的订单id来判断是否下单成功。",-1)),l[867]||(l[867]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653562234886.png",alt:"1653562234886",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[868]||(l[868]=n("h4",{id:"_6-2-秒杀优化-redis-完成秒杀资格判断",tabindex:"-1"},[E("6.2 秒杀优化 - Redis 完成秒杀资格判断 "),n("a",{class:"header-anchor",href:"#_6-2-秒杀优化-redis-完成秒杀资格判断","aria-label":'Permalink to "6.2 秒杀优化 - Redis 完成秒杀资格判断"'},"​")],-1)),l[869]||(l[869]=n("p",null,"需求：",-1)),l[870]||(l[870]=n("ul",null,[n("li",null,[n("p",null,"新增秒杀优惠券的同时，将优惠券信息保存到Redis中")]),n("li",null,[n("p",null,"基于Lua脚本，判断秒杀库存、一人一单，决定用户是否抢购成功")]),n("li",null,[n("p",null,"如果抢购成功，将优惠券id和用户id封装后存入阻塞队列")]),n("li",null,[n("p",null,"开启线程任务，不断从阻塞队列中获取信息，实现异步下单功能"),n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1656080546603.png",alt:"1656080546603",loading:"lazy",decoding:"async",class:"lazy"})])])],-1)),l[871]||(l[871]=n("p",null,[n("strong",null,"VoucherServiceImpl")],-1)),l[872]||(l[872]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addSeckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Voucher voucher) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存优惠券")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存秒杀信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SeckillVoucher seckillVoucher "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SeckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setBeginTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setEndTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(seckillVoucher);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存秒杀库存到Redis中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //SECKILL_STOCK_KEY 这个变量定义在RedisConstans中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'    //private static final String SECKILL_STOCK_KEY ="seckill:stock:"')]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SECKILL_STOCK_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), voucher."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[873]||(l[873]=n("p",null,"完整lua表达式",-1)),l[874]||(l[874]=n("div",{class:"language-lua max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"lua"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 1.参数列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 1.1.优惠券id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucherId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ARGV["),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 1.2.用户id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ARGV["),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 1.3.订单id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ARGV["),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 2.数据key")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 2.1.库存key")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockKey "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'seckill:stock:' "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucherId")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 2.2.订单key")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderKey "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'seckill:order:' "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucherId")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.脚本业务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.1.判断库存是否充足 get stockKey")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"tonumber"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(redis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'get'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", stockKey)) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 3.2.库存不足，返回1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.2.判断用户是否下单 SISMEMBER orderKey userId")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(redis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'sismember'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", orderKey, userId) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 3.3.存在，说明是重复下单，返回2")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.4.扣库存 incrby stockKey -1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'incrby'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", stockKey, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.5.下单（保存用户）sadd orderKey userId")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'sadd'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", orderKey, userId)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.6.发送消息到队列中， XADD stream.orders * k1 v1 k2 v2 ...")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'xadd'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'stream.orders'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'*'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'userId'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'voucherId'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'id'"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", orderId)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[875]||(l[875]=n("p",null,"当以上lua表达式执行完毕后，剩下的就是根据步骤3,4来执行我们接下来的任务了",-1)),l[876]||(l[876]=n("p",null,[n("strong",null,"VoucherOrderServiceImpl")],-1)),l[877]||(l[877]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //获取用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.执行lua脚本")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"execute"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            SECKILL_SCRIPT,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Collections."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            voucherId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), userId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), String."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    );")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"intValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.判断结果是否为0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.1.不为0 ，代表没有购买资格")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ?"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "库存不足"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," :"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "不能重复下单"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //TODO 保存阻塞队列")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.返回订单id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[878]||(l[878]=n("h4",{id:"_6-3-秒杀优化-基于阻塞队列实现秒杀优化",tabindex:"-1"},[E("6.3 秒杀优化 - 基于阻塞队列实现秒杀优化 "),n("a",{class:"header-anchor",href:"#_6-3-秒杀优化-基于阻塞队列实现秒杀优化","aria-label":'Permalink to "6.3 秒杀优化 - 基于阻塞队列实现秒杀优化"'},"​")],-1)),l[879]||(l[879]=n("p",null,[n("strong",null,"VoucherOrderServiceImpl")],-1)),l[880]||(l[880]=n("p",null,"修改下单动作，现在我们去下单时，是通过lua表达式去原子执行判断逻辑，如果判断我出来不为0 ，则要么是库存不足，要么是重复下单，返回错误信息，如果是0，则把下单的逻辑保存到队列中去，然后异步执行",-1)),l[881]||(l[881]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//异步处理线程池")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExecutorService SECKILL_ORDER_EXECUTOR "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Executors."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newSingleThreadExecutor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//在类初始化之后执行，因为当这个类初始化好了之后，随时都是有可能要执行的")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostConstruct")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," init"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"   SECKILL_ORDER_EXECUTOR."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrderHandler"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 用于线程池处理的任务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 当初始化完毕后，就会去从对列中去拿信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrderHandler"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Runnable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 1.获取队列中的订单信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    VoucherOrder voucherOrder "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderTasks."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"take"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 2.创建订单")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                    handleVoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"处理订单异常"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"          \t }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"     ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"       private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleVoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(VoucherOrder "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"voucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //1.获取用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.创建锁对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            RLock redisLock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redissonClient."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lock:order:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.尝试获取锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisLock."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.判断是否获得锁成功")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isLock) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 获取锁失败，直接返回失败或者重试")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"不允许重复下单！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t\t//注意：由于是spring的事务是放在threadLocal中，此时的是多线程，事务会失效")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                proxy."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createVoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 释放锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                redisLock."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     //a")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tprivate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BlockingQueue<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> orderTasks "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  ArrayBlockingQueue<>("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1024"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1024"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"voucherId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.执行lua脚本")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"execute"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                SECKILL_SCRIPT,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Collections."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                voucherId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), userId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), String."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        );")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"intValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断结果是否为0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.1.不为0 ，代表没有购买资格")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ?"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "库存不足"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," :"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "不能重复下单"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        VoucherOrder voucherOrder "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.3.订单id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.4.用户id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.5.代金券id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.6.放入阻塞队列")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        orderTasks."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //3.获取代理对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"         proxy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (IVoucherOrderService)AopContext."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentProxy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //4.返回订单id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"     ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createVoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(VoucherOrder "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"voucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.1.查询订单")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getVoucherId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.2.判断是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 用户已经购买过了")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"           log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"用户已经购买过了"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"           return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.扣减库存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock = stock - 1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// set stock = stock - 1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherOrder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getVoucherId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// where id = ? and stock > 0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 扣减失败")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[882]||(l[882]=n("p",null,[n("strong",null,"小总结：")],-1)),l[883]||(l[883]=n("p",null,"秒杀业务的优化思路是什么？",-1)),l[884]||(l[884]=n("ul",null,[n("li",null,"先利用Redis完成库存余量、一人一单判断，完成抢单业务"),n("li",null,"再将下单业务放入阻塞队列，利用独立线程异步下单"),n("li",null,[E("基于阻塞队列的异步秒杀存在哪些问题？ "),n("ul",null,[n("li",null,"内存限制问题"),n("li",null,"数据安全问题")])])],-1)),l[885]||(l[885]=n("h3",{id:"_7-redis-消息队列",tabindex:"-1"},[E("7. Redis 消息队列 "),n("a",{class:"header-anchor",href:"#_7-redis-消息队列","aria-label":'Permalink to "7. Redis 消息队列"'},"​")],-1)),l[886]||(l[886]=n("h4",{id:"_7-1-redis-消息队列-认识消息队列",tabindex:"-1"},[E("7.1 Redis 消息队列 - 认识消息队列 "),n("a",{class:"header-anchor",href:"#_7-1-redis-消息队列-认识消息队列","aria-label":'Permalink to "7.1 Redis 消息队列 - 认识消息队列"'},"​")],-1)),l[887]||(l[887]=n("p",null,"什么是消息队列：字面意思就是存放消息的队列。最简单的消息队列模型包括3个角色：",-1)),l[888]||(l[888]=n("ul",null,[n("li",null,"消息队列：存储和管理消息，也被称为消息代理（Message Broker）"),n("li",null,"生产者：发送消息到消息队列"),n("li",null,"消费者：从消息队列获取消息并处理消息")],-1)),l[889]||(l[889]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653574849336.png",alt:"1653574849336",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[890]||(l[890]=n("p",null,"使用队列的好处在于 **解耦：**所谓解耦，举一个生活中的例子就是：快递员(生产者)把快递放到快递柜里边(Message Queue)去，我们(消费者)从快递柜里边去拿东西，这就是一个异步，如果耦合，那么这个快递员相当于直接把快递交给你，这事固然好，但是万一你不在家，那么快递员就会一直等你，这就浪费了快递员的时间，所以这种思想在我们日常开发中，是非常有必要的。",-1)),l[891]||(l[891]=n("p",null,"这种场景在我们秒杀中就变成了：我们下单之后，利用redis去进行校验下单条件，再通过队列把消息发送出去，然后再启动一个线程去消费这个消息，完成解耦，同时也加快我们的响应速度。",-1)),l[892]||(l[892]=n("p",null,"这里我们可以使用一些现成的mq，比如kafka，rabbitmq等等，但是呢，如果没有安装mq，我们也可以直接使用redis提供的mq方案，降低我们的部署和学习成本。",-1)),l[893]||(l[893]=n("h4",{id:"_7-2-redis-消息队列-基于-list-实现消息队列",tabindex:"-1"},[E("7.2 Redis 消息队列 - 基于 List 实现消息队列 "),n("a",{class:"header-anchor",href:"#_7-2-redis-消息队列-基于-list-实现消息队列","aria-label":'Permalink to "7.2 Redis 消息队列 - 基于 List 实现消息队列"'},"​")],-1)),l[894]||(l[894]=n("p",null,[n("strong",null,"基于List结构模拟消息队列")],-1)),l[895]||(l[895]=n("p",null,"消息队列（Message Queue），字面意思就是存放消息的队列。而Redis的list数据结构是一个双向链表，很容易模拟出队列效果。",-1)),l[896]||(l[896]=n("p",null,"队列是入口和出口不在一边，因此我们可以利用：LPUSH 结合 RPOP、或者 RPUSH 结合 LPOP来实现。 不过要注意的是，当队列中没有消息时RPOP或LPOP操作会返回null，并不像JVM的阻塞队列那样会阻塞并等待消息。因此这里应该使用BRPOP或者BLPOP来实现阻塞效果。",-1)),l[897]||(l[897]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653575176451.png",alt:"1653575176451",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[898]||(l[898]=n("p",null,"基于List的消息队列有哪些优缺点？ 优点：",-1)),l[899]||(l[899]=n("ul",null,[n("li",null,"利用Redis存储，不受限于JVM内存上限"),n("li",null,"基于Redis的持久化机制，数据安全性有保证"),n("li",null,"可以满足消息有序性")],-1)),l[900]||(l[900]=n("p",null,"缺点：",-1)),l[901]||(l[901]=n("ul",null,[n("li",null,"无法避免消息丢失"),n("li",null,"只支持单消费者")],-1)),l[902]||(l[902]=n("h4",{id:"_7-3-redis-消息队列-基于-pubsub-的消息队列",tabindex:"-1"},[E("7.3 Redis 消息队列 - 基于 PubSub 的消息队列 "),n("a",{class:"header-anchor",href:"#_7-3-redis-消息队列-基于-pubsub-的消息队列","aria-label":'Permalink to "7.3 Redis 消息队列 - 基于 PubSub 的消息队列"'},"​")],-1)),l[903]||(l[903]=n("p",null,"PubSub（发布订阅）是Redis2.0版本引入的消息传递模型。顾名思义，消费者可以订阅一个或多个channel，生产者向对应channel发送消息后，所有订阅者都能收到相关消息。",-1)),l[904]||(l[904]=n("p",null,[n("code",null,"SUBSCRIBE channel [channel]"),E(" ：订阅一个或多个频道 "),n("code",null,"PUBLISH channel msg"),E(" ：向一个频道发送消息 "),n("code",null,"PSUBSCRIBE pattern[pattern]"),E(" ：订阅与pattern格式匹配的所有频道")],-1)),l[905]||(l[905]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653575506373.png",alt:"1653575506373",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[906]||(l[906]=n("p",null,"基于PubSub的消息队列有哪些优缺点？ 优点：",-1)),l[907]||(l[907]=n("ul",null,[n("li",null,"采用发布订阅模型，支持多生产、多消费")],-1)),l[908]||(l[908]=n("p",null,"缺点：",-1)),l[909]||(l[909]=n("ul",null,[n("li",null,"不支持数据持久化"),n("li",null,"无法避免消息丢失"),n("li",null,"消息堆积有上限，超出时数据丢失")],-1)),l[910]||(l[910]=n("h4",{id:"_7-4-redis-消息队列-基于-stream-的消息队列",tabindex:"-1"},[E("7.4 Redis 消息队列 - 基于 Stream 的消息队列 "),n("a",{class:"header-anchor",href:"#_7-4-redis-消息队列-基于-stream-的消息队列","aria-label":'Permalink to "7.4 Redis 消息队列 - 基于 Stream 的消息队列"'},"​")],-1)),l[911]||(l[911]=n("p",null,"Stream 是 Redis 5.0 引入的一种新数据类型，可以实现一个功能非常完善的消息队列。",-1)),l[912]||(l[912]=n("p",null,"发送消息的命令：",-1)),l[913]||(l[913]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577301737.png",alt:"1653577301737",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[914]||(l[914]=n("p",null,"例如：",-1)),l[915]||(l[915]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577349691.png",alt:"1653577349691",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[916]||(l[916]=n("p",null,"读取消息的方式之一：XREAD",-1)),l[917]||(l[917]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577445413.png",alt:"1653577445413",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[918]||(l[918]=n("p",null,"例如，使用XREAD读取第一个消息：",-1)),l[919]||(l[919]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577643629.png",alt:"1653577643629",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[920]||(l[920]=n("p",null,"XREAD阻塞方式，读取最新的消息：",-1)),l[921]||(l[921]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577659166.png",alt:"1653577659166",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[922]||(l[922]=n("p",null,"在业务开发中，我们可以循环的调用XREAD阻塞方式来查询最新消息，从而实现持续监听队列的效果，伪代码如下",-1)),l[923]||(l[923]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577689129.png",alt:"1653577689129",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[924]||(l[924]=n("p",null,"注意：当我们指定起始ID为$时，代表读取最新的消息，如果我们处理一条消息的过程中，又有超过1条以上的消息到达队列，则下次获取时也只能获取到最新的一条，会出现漏读消息的问题",-1)),l[925]||(l[925]=n("p",null,"STREAM类型消息队列的XREAD命令特点：",-1)),l[926]||(l[926]=n("ul",null,[n("li",null,"消息可回溯"),n("li",null,"一个消息可以被多个消费者读取"),n("li",null,"可以阻塞读取"),n("li",null,"有消息漏读的风险")],-1)),l[927]||(l[927]=n("h4",{id:"_7-5-redis-消息队列-基于-stream-的消息队列-消费者组",tabindex:"-1"},[E("7.5 Redis 消息队列 - 基于 Stream 的消息队列 - 消费者组 "),n("a",{class:"header-anchor",href:"#_7-5-redis-消息队列-基于-stream-的消息队列-消费者组","aria-label":'Permalink to "7.5 Redis 消息队列 - 基于 Stream 的消息队列 - 消费者组"'},"​")],-1)),l[928]||(l[928]=n("p",null,"消费者组（Consumer Group）：将多个消费者划分到一个组中，监听同一个队列。具备下列特点：",-1)),l[929]||(l[929]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577801668.png",alt:"1653577801668",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[930]||(l[930]=n("p",null,[E("创建消费者组： "),n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577984924.png",alt:"1653577984924"})],-1)),l[931]||(l[931]=n("ul",null,[n("li",null,"key：队列名称"),n("li",null,"groupName：消费者组名称"),n("li",null,"ID：起始ID标示，$代表队列中最后一个消息，0则代表队列中第一个消息"),n("li",null,"MKSTREAM：队列不存在时自动创建队列"),n("li",null,"其它常见命令：")],-1)),l[932]||(l[932]=n("p",null,[n("strong",null,"删除指定的消费者组")],-1)),l[933]||(l[933]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"XGROUP"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," DESTORY"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," key"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," groupName")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[934]||(l[934]=n("p",null,[n("strong",null,"给指定的消费者组添加消费者")],-1)),l[935]||(l[935]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"XGROUP"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," CREATECONSUMER"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," key"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," groupname"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," consumername")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[936]||(l[936]=n("p",null,[n("strong",null,"删除消费者组中的指定消费者")],-1)),l[937]||(l[937]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"XGROUP"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," DELCONSUMER"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," key"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," groupname"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," consumername")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[938]||(l[938]=n("p",null,"从消费者组读取消息：",-1)),l[939]||(l[939]=n("div",{class:"language-sh max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"sh"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"XREADGROUP"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," GROUP"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," group"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," consumer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," [COUNT "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"count]"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," [BLOCK "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"milliseconds]"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," [NOACK] STREAMS key [key ...] ID [ID ...]")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[940]||(l[940]=n("ul",null,[n("li",null,"group：消费组名称"),n("li",null,"consumer：消费者名称，如果消费者不存在，会自动创建一个消费者"),n("li",null,"count：本次查询的最大数量"),n("li",null,"BLOCK milliseconds：当没有消息时最长等待时间"),n("li",null,"NOACK：无需手动ACK，获取到消息后自动确认"),n("li",null,"STREAMS key：指定队列名称"),n("li",null,"ID：获取消息的起始ID：")],-1)),l[941]||(l[941]=n("p",null,[E('"'),n("code",null,">"),E('"：从下一个未消费的消息开始 其它：根据指定id从pending-list中获取已消费但未确认的消息，例如0，是从pending-list中的第一个消息开始')],-1)),l[942]||(l[942]=n("p",null,"消费者监听消息的基本思路：",-1)),l[943]||(l[943]=n("p",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653578211854.png",alt:"1653578211854"}),E("STREAM类型消息队列的XREADGROUP命令特点：")],-1)),l[944]||(l[944]=n("ul",null,[n("li",null,"消息可回溯"),n("li",null,"可以多消费者争抢消息，加快消费速度"),n("li",null,"可以阻塞读取"),n("li",null,"没有消息漏读的风险"),n("li",null,"有消息确认机制，保证消息至少被消费一次")],-1)),l[945]||(l[945]=n("p",null,"最后我们来个小对比",-1)),l[946]||(l[946]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653578560691.png",alt:"1653578560691",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[947]||(l[947]=n("h4",{id:"_7-6-基于-redis-的-stream-结构作为消息队列-实现异步秒杀下单",tabindex:"-1"},[E("7.6 基于 Redis 的 Stream 结构作为消息队列，实现异步秒杀下单 "),n("a",{class:"header-anchor",href:"#_7-6-基于-redis-的-stream-结构作为消息队列-实现异步秒杀下单","aria-label":'Permalink to "7.6 基于 Redis 的 Stream 结构作为消息队列，实现异步秒杀下单"'},"​")],-1)),l[948]||(l[948]=n("p",null,"需求：",-1)),l[949]||(l[949]=n("ul",null,[n("li",null,[E("创建一个Stream类型的消息队列，名为"),n("code",null,"stream.orders")]),n("li",null,[E("修改之前的秒杀下单Lua脚本，在认定有抢购资格后，直接向"),n("code",null,"stream.orders"),E("中添加消息，内容包含voucherId、userId、orderId")]),n("li",null,[E("项目启动时，开启一个线程任务，尝试获取"),n("code",null,"stream.orders"),E("中的消息，完成下单")])],-1)),l[950]||(l[950]=n("p",null,"修改lua表达式,新增3.6",-1)),l[951]||(l[951]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1656082824939.png",alt:"1656082824939",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[952]||(l[952]=n("p",null,[n("strong",null,"VoucherOrderServiceImpl")],-1)),l[953]||(l[953]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrderHandler"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Runnable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 1.获取消息队列中的订单信息 XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 >")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                List<MapRecord<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> list "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForStream"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Consumer."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"from"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"g1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"c1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    StreamReadOptions."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"empty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"block"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Duration."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ofSeconds"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    StreamOffset."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stream.orders"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ReadOffset."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lastConsumed"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                );")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 2.判断订单信息是否为空")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (list "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 如果为null，说明没有消息，继续下一次循环")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    continue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 解析数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                MapRecord<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> record "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," record."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                VoucherOrder voucherOrder "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fillBeanWithMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 3.创建订单")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                createVoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 4.确认消息 XACK")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForStream"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"acknowledge"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"s1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"g1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", record."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"处理订单异常"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //处理异常消息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                handlePendingList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handlePendingList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 1.获取pending-list中的订单信息 XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                List<MapRecord<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> list "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForStream"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Consumer."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"from"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"g1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"c1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    StreamReadOptions."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"empty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    StreamOffset."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stream.orders"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ReadOffset."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"from"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"0"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                );")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 2.判断订单信息是否为空")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (list "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 如果为null，说明没有异常消息，结束循环")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    break"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 解析数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                MapRecord<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> record "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," record."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                VoucherOrder voucherOrder "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fillBeanWithMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 3.创建订单")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                createVoucherOrder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 4.确认消息 XACK")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForStream"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"acknowledge"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"s1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"g1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", record."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"处理pendding订单异常"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"printStackTrace"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[954]||(l[954]=n("h3",{id:"_8-达人探店",tabindex:"-1"},[E("8. 达人探店 "),n("a",{class:"header-anchor",href:"#_8-达人探店","aria-label":'Permalink to "8. 达人探店"'},"​")],-1)),l[955]||(l[955]=n("h4",{id:"_8-1-达人探店-发布探店笔记",tabindex:"-1"},[E("8.1 达人探店-发布探店笔记 "),n("a",{class:"header-anchor",href:"#_8-1-达人探店-发布探店笔记","aria-label":'Permalink to "8.1 达人探店-发布探店笔记"'},"​")],-1)),l[956]||(l[956]=n("p",null,"发布探店笔记",-1)),l[957]||(l[957]=n("p",null,[E("探店笔记类似点评网站的评价，往往是图文结合。对应的表有两个： "),n("code",null,"tb_blog"),E("：探店笔记表，包含笔记中的标题、文字、图片等 "),n("code",null,"tb_blog_comments"),E("：其他用户对探店笔记的评价")],-1)),l[958]||(l[958]=n("p",null,[n("strong",null,"具体发布流程")],-1)),l[959]||(l[959]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653578992639.png",alt:"1653578992639",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[960]||(l[960]=n("p",null,"上传接口",-1)),l[961]||(l[961]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Slf4j")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RestController")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"upload"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UploadController"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"blog"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"uploadImage"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"file"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") MultipartFile "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"image"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 获取原始文件名称")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String originalFilename "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," image."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOriginalFilename"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 生成新文件名")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String fileName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createNewFileName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(originalFilename);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 保存文件")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            image."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"transferTo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," File"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SystemConstants.IMAGE_UPLOAD_DIR, fileName));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 返回结果")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"文件上传成功，{}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", fileName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(fileName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (IOException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"文件上传失败"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[962]||(l[962]=n("p",null,[E("注意：同学们在操作时，需要修改"),n("code",null,"SystemConstants.IMAGE_UPLOAD_DIR"),E(" 自己图片所在的地址，在实际开发中图片一般会放在nginx上或者是云存储上。")],-1)),l[963]||(l[963]=n("p",null,"BlogController",-1)),l[964]||(l[964]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RestController")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/blog"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BlogController"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Resource")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IBlogService blogService;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveBlog"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestBody"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Blog "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"blog"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //获取登录用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserDTO user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        blog."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUpdateTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //保存探店博文")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        blogService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveBlog"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //返回id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[965]||(l[965]=n("h4",{id:"_8-2-达人探店-查看探店笔记",tabindex:"-1"},[E("8.2 达人探店 - 查看探店笔记 "),n("a",{class:"header-anchor",href:"#_8-2-达人探店-查看探店笔记","aria-label":'Permalink to "8.2 达人探店 - 查看探店笔记"'},"​")],-1)),l[966]||(l[966]=n("p",null,"实现查看发布探店笔记的接口",-1)),l[967]||(l[967]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653579931626.png",alt:"1653579931626",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[968]||(l[968]=n("p",null,"实现代码：",-1)),l[969]||(l[969]=n("p",null,[n("strong",null,"BlogServiceImpl")],-1)),l[970]||(l[970]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.查询blog")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Blog blog "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (blog "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"笔记不存在！"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.查询blog有关的用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    queryBlogUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[971]||(l[971]=n("h4",{id:"_8-3-达人探店-点赞功能",tabindex:"-1"},[E("8.3 达人探店 - 点赞功能 "),n("a",{class:"header-anchor",href:"#_8-3-达人探店-点赞功能","aria-label":'Permalink to "8.3 达人探店 - 点赞功能"'},"​")],-1)),l[972]||(l[972]=n("p",null,"初始代码",-1)),l[973]||(l[973]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/likes/{id}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogLikes"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long id) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //修改点赞数量")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    blogService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"liked = liked +1 "'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",id)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[974]||(l[974]=n("p",null,"问题分析：这种方式会导致一个用户无限点赞，明显是不合理的",-1)),l[975]||(l[975]=n("p",null,"造成这个问题的原因是，我们现在的逻辑，发起请求只是给数据库+1，所以才会出现这个问题",-1)),l[976]||(l[976]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653581590453.png",alt:"1653581590453",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[977]||(l[977]=n("p",null,"完善点赞功能",-1)),l[978]||(l[978]=n("p",null,"需求：",-1)),l[979]||(l[979]=n("ul",null,[n("li",null,"同一个用户只能点赞一次，再次点击则取消点赞"),n("li",null,"如果当前用户已经点赞，则点赞按钮高亮显示（前端已实现，判断字段Blog类的isLike属性）")],-1)),l[980]||(l[980]=n("p",null,"实现步骤：",-1)),l[981]||(l[981]=n("ul",null,[n("li",null,"给Blog类中添加一个isLike字段，标示是否被当前用户点赞"),n("li",null,"修改点赞功能，利用Redis的set集合判断是否点赞过，未点赞过则点赞数+1，已点赞过则点赞数-1"),n("li",null,"修改根据id查询Blog的业务，判断当前登录用户是否点赞过，赋值给isLike字段"),n("li",null,"修改分页查询Blog业务，判断当前登录用户是否点赞过，赋值给isLike字段")],-1)),l[982]||(l[982]=n("p",null,"为什么采用set集合：",-1)),l[983]||(l[983]=n("p",null,"因为我们的数据是不能重复的，当用户操作过之后，无论他怎么操作，都是",-1)),l[984]||(l[984]=n("p",null,"具体步骤：",-1)),l[985]||(l[985]=n("p",null,"1、在Blog 添加一个字段",-1)),l[986]||(l[986]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TableField"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exist"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean isLike;")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[987]||(l[987]=n("p",null,"2、修改代码",-1)),l[988]||(l[988]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"likeBlog"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取登录用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断当前登录用户是否已经点赞")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BLOG_LIKED_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Boolean isMember "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isMember"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, userId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(BooleanUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFalse"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(isMember)){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"             //3.如果未点赞，可以点赞")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //3.1 数据库点赞数+1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"liked = liked + 1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //3.2 保存用户到Redis的set集合")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(isSuccess){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key,userId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"             //4.如果已点赞，取消点赞")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //4.1 数据库点赞数-1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"liked = liked - 1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //4.2 把用户从Redis的set集合移除")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(isSuccess){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key,userId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[989]||(l[989]=n("h4",{id:"_8-4-达人探店-点赞排行榜",tabindex:"-1"},[E("8.4 达人探店 - 点赞排行榜 "),n("a",{class:"header-anchor",href:"#_8-4-达人探店-点赞排行榜","aria-label":'Permalink to "8.4 达人探店 - 点赞排行榜"'},"​")],-1)),l[990]||(l[990]=n("p",null,"在探店笔记的详情页面，应该把给该笔记点赞的人显示出来，比如最早点赞的TOP5，形成点赞排行榜：",-1)),l[991]||(l[991]=n("p",null,"之前的点赞是放到set集合，但是set集合是不能排序的，所以这个时候，咱们可以采用一个可以排序的set集合，就是咱们的sortedSet",-1)),l[992]||(l[992]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653805077118.png",alt:"1653805077118",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[993]||(l[993]=n("p",null,"我们接下来来对比一下这些集合的区别是什么",-1)),l[994]||(l[994]=n("p",null,"所有点赞的人，需要是唯一的，所以我们应当使用set或者是sortedSet",-1)),l[995]||(l[995]=n("p",null,"其次我们需要排序，就可以直接锁定使用sortedSet啦",-1)),l[996]||(l[996]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653805203758.png",alt:"1653805203758",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[997]||(l[997]=n("p",null,"修改代码",-1)),l[998]||(l[998]=n("p",null,"BlogServiceImpl",-1)),l[999]||(l[999]=n("p",null,"点赞逻辑代码",-1)),l[1e3]||(l[1e3]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"   @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"likeBlog"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取登录用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断当前登录用户是否已经点赞")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BLOG_LIKED_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Double score "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"score"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, userId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (score "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.如果未点赞，可以点赞")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.1.数据库点赞数 + 1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"liked = liked + 1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.2.保存用户到Redis的set集合  zadd key value score")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isSuccess) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, userId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.如果已点赞，取消点赞")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.1.数据库点赞数 -1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"liked = liked - 1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.2.把用户从Redis的set集合移除")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isSuccess) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, userId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," isBlogLiked"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Blog blog) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取登录用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserDTO user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 用户未登录，无需查询是否点赞")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," user."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断当前登录用户是否已经点赞")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "blog:liked:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," blog."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Double score "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"score"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, userId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        blog."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIsLike"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(score "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1001]||(l[1001]=n("p",null,"点赞列表查询列表",-1)),l[1002]||(l[1002]=n("p",null,"BlogController",-1)),l[1003]||(l[1003]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/likes/{id}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogLikes"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long id) {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," blogService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogLikes"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1004]||(l[1004]=n("p",null,"BlogService",-1)),l[1005]||(l[1005]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogLikes"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BLOG_LIKED_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.查询top5的点赞用户 zrange key 0 4")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Set<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> top5 "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"range"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"4"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (top5 "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," top5."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collections."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.解析出其中的用户id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ids "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," top5."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"valueOf)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String idStr "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StrUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"join"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.根据用户id查询用户 WHERE id IN ( 5 , 1 ) ORDER BY FIELD(id, 5, 1)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UserDTO"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> userDTOS "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"in"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"last"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ORDER BY FIELD(id,"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," idStr "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ")"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user, UserDTO.class))")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userDTOS);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1006]||(l[1006]=n("h3",{id:"_9-好友关注",tabindex:"-1"},[E("9. 好友关注 "),n("a",{class:"header-anchor",href:"#_9-好友关注","aria-label":'Permalink to "9. 好友关注"'},"​")],-1)),l[1007]||(l[1007]=n("h4",{id:"_9-1-好友关注-关注和取消关注",tabindex:"-1"},[E("9.1 好友关注 - 关注和取消关注 "),n("a",{class:"header-anchor",href:"#_9-1-好友关注-关注和取消关注","aria-label":'Permalink to "9.1 好友关注 - 关注和取消关注"'},"​")],-1)),l[1008]||(l[1008]=n("p",null,"针对用户的操作：可以对用户进行关注和取消关注功能。",-1)),l[1009]||(l[1009]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653806140822.png",alt:"1653806140822",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1010]||(l[1010]=n("p",null,"实现思路：",-1)),l[1011]||(l[1011]=n("p",null,"需求：基于该表数据结构，实现两个接口：",-1)),l[1012]||(l[1012]=n("ul",null,[n("li",null,"关注和取关接口"),n("li",null,"判断是否关注的接口")],-1)),l[1013]||(l[1013]=n("p",null,[E("关注是User之间的关系，是博主与粉丝的关系，数据库中有一张"),n("code",null,"tb_follow"),E("表来标示：")],-1)),l[1014]||(l[1014]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653806253817.png",alt:"1653806253817",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1015]||(l[1015]=n("p",null,"注意: 这里需要把主键修改为自增长，简化开发。",-1)),l[1016]||(l[1016]=n("p",null,[n("strong",null,"FollowController")],-1)),l[1017]||(l[1017]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//关注")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PutMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/{id}/{isFollow}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"follow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long followUserId, @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"isFollow"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Boolean isFollow) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," followService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"follow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(followUserId, isFollow);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//取消关注")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/or/not/{id}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFollow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long followUserId) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"      return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," followService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFollow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(followUserId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1018]||(l[1018]=n("p",null,[n("strong",null,"FollowService")],-1)),l[1019]||(l[1019]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"取消关注service")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFollow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long followUserId) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取登录用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.查询是否关注 select count(*) from tb_follow where user_id = ? and follow_user_id = ?")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Integer count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"follow_user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", followUserId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.判断")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 关注service")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"follow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long followUserId, Boolean isFollow) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取登录用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "follows:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.判断到底是关注还是取关")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isFollow) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.关注，新增数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Follow follow "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Follow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            follow."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            follow."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setFollowUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(followUserId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(follow);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.取关，删除 delete from tb_follow where user_id = ? and follow_user_id = ?")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueryWrapper<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Follow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"follow_user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", followUserId));")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1020]||(l[1020]=n("h4",{id:"_9-2-好友关注-共同关注",tabindex:"-1"},[E("9.2 好友关注 - 共同关注 "),n("a",{class:"header-anchor",href:"#_9-2-好友关注-共同关注","aria-label":'Permalink to "9.2 好友关注 - 共同关注"'},"​")],-1)),l[1021]||(l[1021]=n("p",null,"想要去看共同关注的好友，需要首先进入到这个页面，这个页面会发起两个请求",-1)),l[1022]||(l[1022]=n("p",null,"1、去查询用户的详情",-1)),l[1023]||(l[1023]=n("p",null,"2、去查询用户的笔记",-1)),l[1024]||(l[1024]=n("p",null,"以上两个功能和共同关注没有什么关系，大家可以自行将笔记中的代码拷贝到idea中就可以实现这两个功能了，我们的重点在于共同关注功能。",-1)),l[1025]||(l[1025]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653806706296.png",alt:"1653806706296",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1026]||(l[1026]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// UserController 根据id查询用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/{id}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryUserById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long userId){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 查询详情")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\tUser user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tif"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\treturn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\tUserDTO userDTO "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user, UserDTO.class);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\treturn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userDTO);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// BlogController  根据id查询博主的探店笔记")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/of/user"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogByUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "current"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"defaultValue"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Integer current,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long id) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 根据用户查询")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\tPage<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Blog"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> page "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," blogService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"page"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Page<>(current, SystemConstants.MAX_PAGE_SIZE));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 获取当前页数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\tList<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Blog"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> records "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," page."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRecords"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\treturn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(records);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1027]||(l[1027]=n("p",null,"接下来我们来看看共同关注如何实现：",-1)),l[1028]||(l[1028]=n("p",null,"需求：利用Redis中恰当的数据结构，实现共同关注功能。在博主个人页面展示出当前用户与博主的共同关注呢。",-1)),l[1029]||(l[1029]=n("p",null,"当然是使用我们之前学习过的set集合咯，在set集合中，有交集并集补集的api，我们可以把两人的关注的人分别放入到一个set集合中，然后再通过api去查看这两个set集合中的交集数据。",-1)),l[1030]||(l[1030]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653806973212.png",alt:"1653806973212",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1031]||(l[1031]=n("p",null,"我们先来改造当前的关注列表",-1)),l[1032]||(l[1032]=n("p",null,"改造原因是因为我们需要在用户关注了某位用户后，需要将数据放入到set集合中，方便后续进行共同关注，同时当取消关注时，也需要从set集合中进行删除",-1)),l[1033]||(l[1033]=n("p",null,[n("strong",null,"FollowServiceImpl")],-1)),l[1034]||(l[1034]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"follow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long followUserId, Boolean isFollow) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取登录用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "follows:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.判断到底是关注还是取关")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isFollow) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.关注，新增数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Follow follow "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Follow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        follow."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        follow."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setFollowUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(followUserId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(follow);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isSuccess) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 把关注用户的id，放入redis的set集合 sadd userId followerUserId")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, followUserId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.取关，删除 delete from tb_follow where user_id = ? and follow_user_id = ?")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueryWrapper<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Follow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"follow_user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", followUserId));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isSuccess) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 把关注用户的id从Redis集合中移除")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, followUserId."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1035]||(l[1035]=n("p",null,[n("strong",null,"具体的关注代码：")],-1)),l[1036]||(l[1036]=n("p",null,[n("strong",null,"FollowServiceImpl")],-1)),l[1037]||(l[1037]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"followCommons"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取当前用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "follows:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.求交集")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key2 "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "follows:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Set<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> intersect "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"intersect"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, key2);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (intersect "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," intersect."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 无交集")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collections."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.解析id集合")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ids "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," intersect."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"valueOf)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.查询用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UserDTO"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> users "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"listByIds"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ids)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user, UserDTO.class))")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(users);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1038]||(l[1038]=n("h4",{id:"_9-3-好友关注-feed-流实现方案",tabindex:"-1"},[E("9.3 好友关注 - Feed 流实现方案 "),n("a",{class:"header-anchor",href:"#_9-3-好友关注-feed-流实现方案","aria-label":'Permalink to "9.3 好友关注 - Feed 流实现方案"'},"​")],-1)),l[1039]||(l[1039]=n("p",null,"当我们关注了用户后，这个用户发了动态，那么我们应该把这些数据推送给用户，这个需求，其实我们又把他叫做Feed流，关注推送也叫做Feed流，直译为投喂。为用户持续的提供“沉浸式”的体验，通过无限下拉刷新获取新的信息。",-1)),l[1040]||(l[1040]=n("p",null,"对于传统的模式的内容解锁：我们是需要用户去通过搜索引擎或者是其他的方式去解锁想要看的内容",-1)),l[1041]||(l[1041]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653808641260.png",alt:"1653808641260",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1042]||(l[1042]=n("p",null,"对于新型的Feed流的的效果：不需要我们用户再去推送信息，而是系统分析用户到底想要什么，然后直接把内容推送给用户，从而使用户能够更加的节约时间，不用主动去寻找。",-1)),l[1043]||(l[1043]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653808993693.png",alt:"1653808993693",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1044]||(l[1044]=n("p",null,"Feed流的实现有两种模式：",-1)),l[1045]||(l[1045]=n("p",null,"Feed流产品有两种常见模式： Timeline：不做内容筛选，简单的按照内容发布时间排序，常用于好友或关注。例如朋友圈",-1)),l[1046]||(l[1046]=n("ul",null,[n("li",null,"优点：信息全面，不会有缺失。并且实现也相对简单"),n("li",null,"缺点：信息噪音较多，用户不一定感兴趣，内容获取效率低")],-1)),l[1047]||(l[1047]=n("p",null,"智能排序：利用智能算法屏蔽掉违规的、用户不感兴趣的内容。推送用户感兴趣信息来吸引用户",-1)),l[1048]||(l[1048]=n("ul",null,[n("li",null,"优点：投喂用户感兴趣信息，用户粘度很高，容易沉迷"),n("li",null,"缺点：如果算法不精准，可能起到反作用 本例中的个人页面，是基于关注的好友来做Feed流，因此采用Timeline的模式。该模式的实现方案有三种：")],-1)),l[1049]||(l[1049]=n("p",null,"我们本次针对好友的操作，采用的就是Timeline的方式，只需要拿到我们关注用户的信息，然后按照时间排序即可",-1)),l[1050]||(l[1050]=n("p",null,"，因此采用Timeline的模式。该模式的实现方案有三种：",-1)),l[1051]||(l[1051]=n("ul",null,[n("li",null,"拉模式"),n("li",null,"推模式"),n("li",null,"推拉结合")],-1)),l[1052]||(l[1052]=n("p",null,[n("strong",null,"拉模式"),E("：也叫做读扩散")],-1)),l[1053]||(l[1053]=n("p",null,"该模式的核心含义就是：当张三和李四和王五发了消息后，都会保存在自己的邮箱中，假设赵六要读取信息，那么他会从读取他自己的收件箱，此时系统会从他关注的人群中，把他关注人的信息全部都进行拉取，然后在进行排序",-1)),l[1054]||(l[1054]=n("p",null,"优点：比较节约空间，因为赵六在读信息时，并没有重复读取，而且读取完之后可以把他的收件箱进行清楚。",-1)),l[1055]||(l[1055]=n("p",null,"缺点：比较延迟，当用户读取数据时才去关注的人里边去读取数据，假设用户关注了大量的用户，那么此时就会拉取海量的内容，对服务器压力巨大。",-1)),l[1056]||(l[1056]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653809450816.png",alt:"1653809450816",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1057]||(l[1057]=n("p",null,[n("strong",null,"推模式"),E("：也叫做写扩散。")],-1)),l[1058]||(l[1058]=n("p",null,"推模式是没有写邮箱的，当张三写了一个内容，此时会主动的把张三写的内容发送到他的粉丝收件箱中去，假设此时李四再来读取，就不用再去临时拉取了",-1)),l[1059]||(l[1059]=n("p",null,"优点：时效快，不用临时拉取",-1)),l[1060]||(l[1060]=n("p",null,"缺点：内存压力大，假设一个大V写信息，很多人关注他， 就会写很多分数据到粉丝那边去",-1)),l[1061]||(l[1061]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653809875208.png",alt:"1653809875208",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1062]||(l[1062]=n("p",null,[n("strong",null,"推拉结合模式"),E("：也叫做读写混合，兼具推和拉两种模式的优点。")],-1)),l[1063]||(l[1063]=n("p",null,"推拉模式是一个折中的方案，站在发件人这一段，如果是个普通的人，那么我们采用写扩散的方式，直接把数据写入到他的粉丝中去，因为普通的人他的粉丝关注量比较小，所以这样做没有压力，如果是大V，那么他是直接将数据先写入到一份到发件箱里边去，然后再直接写一份到活跃粉丝收件箱里边去，现在站在收件人这端来看，如果是活跃粉丝，那么大V和普通的人发的都会直接写入到自己收件箱里边来，而如果是普通的粉丝，由于他们上线不是很频繁，所以等他们上线时，再从发件箱里边去拉信息。",-1)),l[1064]||(l[1064]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653812346852.png",alt:"1653812346852",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1065]||(l[1065]=n("h4",{id:"_9-4-好友关注-推送到粉丝收件箱",tabindex:"-1"},[E("9.4 好友关注 - 推送到粉丝收件箱 "),n("a",{class:"header-anchor",href:"#_9-4-好友关注-推送到粉丝收件箱","aria-label":'Permalink to "9.4 好友关注 - 推送到粉丝收件箱"'},"​")],-1)),l[1066]||(l[1066]=n("p",null,"需求：",-1)),l[1067]||(l[1067]=n("ul",null,[n("li",null,"修改新增探店笔记的业务，在保存blog到数据库的同时，推送到粉丝的收件箱"),n("li",null,"收件箱满足可以根据时间戳排序，必须用Redis的数据结构实现"),n("li",null,"查询收件箱数据时，可以实现分页查询")],-1)),l[1068]||(l[1068]=n("p",null,"Feed流中的数据会不断更新，所以数据的角标也在变化，因此不能采用传统的分页模式。",-1)),l[1069]||(l[1069]=n("p",null,"传统了分页在feed流是不适用的，因为我们的数据会随时发生变化",-1)),l[1070]||(l[1070]=n("p",null,"假设在t1 时刻，我们去读取第一页，此时page = 1 ，size = 5 ，那么我们拿到的就是10~6 这几条记录，假设现在t2时候又发布了一条记录，此时t3 时刻，我们来读取第二页，读取第二页传入的参数是page=2 ，size=5 ，那么此时读取到的第二页实际上是从6 开始，然后是6~2 ，那么我们就读取到了重复的数据，所以feed流的分页，不能采用原始方案来做。",-1)),l[1071]||(l[1071]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653813047671.png",alt:"1653813047671",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1072]||(l[1072]=n("p",null,"Feed流的滚动分页",-1)),l[1073]||(l[1073]=n("p",null,"我们需要记录每次操作的最后一条，然后从这个位置开始去读取数据",-1)),l[1074]||(l[1074]=n("p",null,"举个例子：我们从t1时刻开始，拿第一页数据，拿到了10~6，然后记录下当前最后一次拿取的记录，就是6，t2时刻发布了新的记录，此时这个11放到最顶上，但是不会影响我们之前记录的6，此时t3时刻来拿第二页，第二页这个时候拿数据，还是从6后一点的5去拿，就拿到了5-1的记录。我们这个地方可以采用sortedSet来做，可以进行范围查询，并且还可以记录当前获取数据时间戳最小值，就可以实现滚动分页了",-1)),l[1075]||(l[1075]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653813462834.png",alt:"1653813462834",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1076]||(l[1076]=n("p",null,"核心的意思：就是我们在保存完探店笔记后，获得到当前笔记的粉丝，然后把数据推送到粉丝的redis中去。",-1)),l[1077]||(l[1077]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveBlog"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Blog blog) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取登录用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    UserDTO user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    blog."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.保存探店笔记")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," save"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isSuccess){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"新增笔记失败!"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.查询笔记作者的所有粉丝 select * from tb_follow where follow_user_id = ?")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Follow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> follows "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," followService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"follow_user_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", user."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.推送笔记id给所有粉丝")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Follow follow "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," follows) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.1.获取粉丝id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," follow."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.2.推送")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," FEED_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, blog."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.返回id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1078]||(l[1078]=n("h4",{id:"_9-5-好友关注-实现分页查询收邮箱",tabindex:"-1"},[E("9.5 好友关注 - 实现分页查询收邮箱 "),n("a",{class:"header-anchor",href:"#_9-5-好友关注-实现分页查询收邮箱","aria-label":'Permalink to "9.5 好友关注 - 实现分页查询收邮箱"'},"​")],-1)),l[1079]||(l[1079]=n("p",null,"需求：在个人主页的“关注”卡片中，查询并展示推送的Blog信息：",-1)),l[1080]||(l[1080]=n("p",null,"具体操作如下：",-1)),l[1081]||(l[1081]=n("p",null,"1、每次查询完成后，我们要分析出查询出数据的最小时间戳，这个值会作为下一次查询的条件",-1)),l[1082]||(l[1082]=n("p",null,"2、我们需要找到与上一次查询相同的查询个数作为偏移量，下次查询时，跳过这些查询过的数据，拿到我们需要的数据",-1)),l[1083]||(l[1083]=n("p",null,"综上：我们的请求参数中就需要携带 lastId：上一次查询的最小时间戳 和偏移量这两个参数。",-1)),l[1084]||(l[1084]=n("p",null,"这两个参数第一次会由前端来指定，以后的查询就根据后台结果作为条件，再次传递到后台。",-1)),l[1085]||(l[1085]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653819821591.png",alt:"1653819821591",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1086]||(l[1086]=n("p",null,"一、定义出来具体的返回值实体类",-1)),l[1087]||(l[1087]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Data")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ScrollResult"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> list;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Long minTime;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer offset;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1088]||(l[1088]=n("p",null,"BlogController",-1)),l[1089]||(l[1089]=n("p",null,"注意：RequestParam 表示接受url地址栏传参的注解，当方法上参数的名称和url地址栏不相同时，可以通过RequestParam 来进行指定",-1)),l[1090]||(l[1090]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/of/follow"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogOfFollow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lastId"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long max, @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "offset"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"defaultValue"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "0"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Integer offset){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," blogService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogOfFollow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(max, offset);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1091]||(l[1091]=n("p",null,"BlogServiceImpl",-1)),l[1092]||(l[1092]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogOfFollow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long max, Integer offset) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取当前用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.查询收件箱 ZREVRANGEBYSCORE key Max Min LIMIT offset count")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," FEED_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Set<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ZSetOperations"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TypedTuple"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> typedTuples "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"reverseRangeByScoreWithScores"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", max, offset, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.非空判断")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (typedTuples "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," typedTuples."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.解析数据：blogId、minTime（时间戳）、offset")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ids "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>(typedTuples."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," minTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 2")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," os "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 2")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ZSetOperations.TypedTuple<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> tuple "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," typedTuples) { "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 5 4 4 2 2")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.1.获取id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ids."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(tuple."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.2.获取分数(时间戳）")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," time "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tuple."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getScore"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"longValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(time "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," minTime){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            os"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            minTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," time;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            os "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\tos "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," minTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," max "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," os "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," os "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," offset;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.根据id查询blog")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String idStr "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StrUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"join"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Blog"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> blogs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"in"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"last"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ORDER BY FIELD(id,"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," idStr "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ")"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Blog blog "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," blogs) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.1.查询blog有关的用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        queryBlogUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.2.查询blog是否被点赞")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        isBlogLiked"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.封装并返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ScrollResult r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ScrollResult"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    r."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blogs);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    r."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setOffset"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(os);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    r."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMinTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(minTime);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(r);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1093]||(l[1093]=n("h3",{id:"_10-附近商户",tabindex:"-1"},[E("10. 附近商户 "),n("a",{class:"header-anchor",href:"#_10-附近商户","aria-label":'Permalink to "10. 附近商户"'},"​")],-1)),l[1094]||(l[1094]=n("h4",{id:"_10-1-附近商户-geo-数据结构的基本用法",tabindex:"-1"},[E("10.1 附近商户 - GEO 数据结构的基本用法 "),n("a",{class:"header-anchor",href:"#_10-1-附近商户-geo-数据结构的基本用法","aria-label":'Permalink to "10.1 附近商户 - GEO 数据结构的基本用法"'},"​")],-1)),l[1095]||(l[1095]=n("p",null,"GEO就是Geolocation的简写形式，代表地理坐标。Redis在3.2版本中加入了对GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据。常见的命令有：",-1)),l[1096]||(l[1096]=n("ul",null,[n("li",null,"GEOADD：添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）"),n("li",null,"GEODIST：计算指定的两个点之间的距离并返回"),n("li",null,"GEOHASH：将指定member的坐标转为hash字符串形式并返回"),n("li",null,"GEOPOS：返回指定member的坐标"),n("li",null,"GEORADIUS：指定圆心、半径，找到该圆内包含的所有member，并按照与圆心之间的距离排序后返回。6.以后已废弃"),n("li",null,"GEOSEARCH：在指定范围内搜索member，并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形。6.2.新功能"),n("li",null,"GEOSEARCHSTORE：与GEOSEARCH功能一致，不过可以把结果存储到一个指定的key。 6.2.新功能")],-1)),l[1097]||(l[1097]=n("h4",{id:"_10-2-附近商户-导入店铺数据到-geo",tabindex:"-1"},[E("10.2 附近商户 - 导入店铺数据到 GEO "),n("a",{class:"header-anchor",href:"#_10-2-附近商户-导入店铺数据到-geo","aria-label":'Permalink to "10.2 附近商户 - 导入店铺数据到 GEO"'},"​")],-1)),l[1098]||(l[1098]=n("p",null,"具体场景说明：",-1)),l[1099]||(l[1099]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653822036941.png",alt:"1653822036941",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1100]||(l[1100]=n("p",null,"当我们点击美食之后，会出现一系列的商家，商家中可以按照多种排序方式，我们此时关注的是距离，这个地方就需要使用到我们的GEO，向后台传入当前app收集的地址(我们此处是写死的) ，以当前坐标作为圆心，同时绑定相同的店家类型type，以及分页信息，把这几个条件传入后台，后台查询出对应的数据再返回。",-1)),l[1101]||(l[1101]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653822021827.png",alt:"1653822021827",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1102]||(l[1102]=n("p",null,"我们要做的事情是：将数据库表中的数据导入到redis中去，redis中的GEO，GEO在redis中就一个menber和一个经纬度，我们把x和y轴传入到redis做的经纬度位置去，但我们不能把所有的数据都放入到menber中去，毕竟作为redis是一个内存级数据库，如果存海量数据，redis还是力不从心，所以我们在这个地方存储他的id即可。",-1)),l[1103]||(l[1103]=n("p",null,"但是这个时候还有一个问题，就是在redis中并没有存储type，所以我们无法根据type来对数据进行筛选，所以我们可以按照商户类型做分组，类型相同的商户作为同一组，以typeId为key存入同一个GEO集合中即可",-1)),l[1104]||(l[1104]=n("p",null,"代码",-1)),l[1105]||(l[1105]=n("p",null,[n("strong",null,"HmDianPingApplicationTests")],-1)),l[1106]||(l[1106]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," loadShopData"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.查询店铺信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> list "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shopService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.把店铺分组，按照typeId分组，typeId一致的放到一个集合")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> map "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"groupingBy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Shop"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getTypeId));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.分批完成写入Redis")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Map.Entry<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," map."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entrySet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.1.获取类型id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long typeId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SHOP_GEO_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," typeId;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.2.获取同类型的店铺的集合")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RedisGeoCommands"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GeoLocation"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> locations "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>(value."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.3.写入redis GEOADD key 经度 纬度 member")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Shop shop "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," value) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            locations."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisGeoCommands.GeoLocation<>(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    shop."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Point"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shop."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getX"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), shop."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getY"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForGeo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, locations);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1107]||(l[1107]=n("h4",{id:"_10-3-附近商户-实现附近商户功能",tabindex:"-1"},[E("10.3 附近商户 - 实现附近商户功能 "),n("a",{class:"header-anchor",href:"#_10-3-附近商户-实现附近商户功能","aria-label":'Permalink to "10.3 附近商户 - 实现附近商户功能"'},"​")],-1)),l[1108]||(l[1108]=n("p",null,"SpringDataRedis的2.3.9版本并不支持Redis 6.2提供的GEOSEARCH命令，因此我们需要提示其版本，修改自己的POM",-1)),l[1109]||(l[1109]=n("p",null,"第一步：导入pom",-1)),l[1110]||(l[1110]=n("div",{class:"language-xml max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"xml"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-data-redis</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusions"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusion"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-data-redis</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.data</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusion"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusion"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">lettuce-core</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">io.lettuce</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusion"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    </"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusions"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.data</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-data-redis</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">2.6.2</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">io.lettuce</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">lettuce-core</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">6.1.6.RELEASE</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1111]||(l[1111]=n("p",null,"第二步：",-1)),l[1112]||(l[1112]=n("p",null,[n("strong",null,"ShopController")],-1)),l[1113]||(l[1113]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/of/type"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryShopByType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"typeId"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Integer typeId,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "current"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"defaultValue"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Integer current,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "x"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"required"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Double x,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "y"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"required"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Double y")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"   return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shopService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryShopByType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(typeId, current, x, y);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1114]||(l[1114]=n("p",null,[n("strong",null,"ShopServiceImpl")],-1)),l[1115]||(l[1115]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryShopByType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Integer typeId, Integer current, Double x, Double y) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.判断是否需要根据坐标查询")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (x "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," y "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 不需要坐标查询，按数据库查询")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Page<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> page "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"type_id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", typeId)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"page"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Page<>(current, SystemConstants.DEFAULT_PAGE_SIZE));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 返回数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(page."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRecords"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.计算分页参数")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," from "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (current "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SystemConstants.DEFAULT_PAGE_SIZE;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," end "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," current "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SystemConstants.DEFAULT_PAGE_SIZE;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.查询redis、按照距离排序、分页。结果：shopId、distance")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SHOP_GEO_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," typeId;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        GeoResults<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RedisGeoCommands"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GeoLocation"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> results "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForGeo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"search"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        key,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        GeoReference."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fromCoordinate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(x, y),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Distance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5000"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        RedisGeoCommands.GeoSearchCommandArgs."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newGeoSearchArgs"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"includeDistance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"limit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(end)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                );")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.解析出id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (results "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collections."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<GeoResult<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RedisGeoCommands"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GeoLocation"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">>> list "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," results."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getContent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (list."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," from) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 没有下一页了，结束")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collections."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.1.截取 from ~ end的部分")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ids "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>(list."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Distance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> distanceMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(list."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        list."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"skip"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(from)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"forEach"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.2.获取店铺id")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String shopIdStr "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getContent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ids."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopIdStr));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.3.获取距离")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Distance distance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDistance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            distanceMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopIdStr, distance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.根据id查询Shop")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String idStr "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StrUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"join"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> shops "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"in"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"last"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ORDER BY FIELD(id,"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," idStr "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ")"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Shop shop "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shops) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            shop."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setDistance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(distanceMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shop."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shops);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1116]||(l[1116]=n("h3",{id:"_11-用户签到",tabindex:"-1"},[E("11. 用户签到 "),n("a",{class:"header-anchor",href:"#_11-用户签到","aria-label":'Permalink to "11. 用户签到"'},"​")],-1)),l[1117]||(l[1117]=n("h4",{id:"_11-1-用户签到-bitmap-功能演示",tabindex:"-1"},[E("11.1 用户签到 - BitMap 功能演示 "),n("a",{class:"header-anchor",href:"#_11-1-用户签到-bitmap-功能演示","aria-label":'Permalink to "11.1 用户签到 - BitMap 功能演示"'},"​")],-1)),l[1118]||(l[1118]=n("p",null,"我们针对签到功能完全可以通过mysql来完成，比如说以下这张表",-1)),l[1119]||(l[1119]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653823145495.png",alt:"1653823145495",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1120]||(l[1120]=n("p",null,"用户一次签到，就是一条记录，假如有1000万用户，平均每人每年签到次数为10次，则这张表一年的数据量为 1亿条",-1)),l[1121]||(l[1121]=n("p",null,"每签到一次需要使用（8 + 8 + 1 + 1 + 3 + 1）共22 字节的内存，一个月则最多需要600多字节",-1)),l[1122]||(l[1122]=n("p",null,"我们如何能够简化一点呢？其实可以考虑小时候一个挺常见的方案，就是小时候，咱们准备一张小小的卡片，你只要签到就打上一个勾，我最后判断你是否签到，其实只需要到小卡片上看一看就知道了",-1)),l[1123]||(l[1123]=n("p",null,"我们可以采用类似这样的方案来实现我们的签到需求。",-1)),l[1124]||(l[1124]=n("p",null,"我们按月来统计用户签到信息，签到记录为1，未签到则记录为0.",-1)),l[1125]||(l[1125]=n("p",null,"把每一个bit位对应当月的每一天，形成了映射关系。用0和1标示业务状态，这种思路就称为位图（BitMap）。这样我们就用极小的空间，来实现了大量数据的表示",-1)),l[1126]||(l[1126]=n("p",null,"Redis中是利用string类型数据结构实现BitMap，因此最大上限是512M，转换为bit则是 2^32个bit位。",-1)),l[1127]||(l[1127]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653824498278.png",alt:"1653824498278",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1128]||(l[1128]=n("p",null,"BitMap的操作命令有：",-1)),l[1129]||(l[1129]=n("ul",null,[n("li",null,"SETBIT：向指定位置（offset）存入一个0或1"),n("li",null,"GETBIT ：获取指定位置（offset）的bit值"),n("li",null,"BITCOUNT ：统计BitMap中值为1的bit位的数量"),n("li",null,"BITFIELD ：操作（查询、修改、自增）BitMap中bit数组中的指定位置（offset）的值"),n("li",null,"BITFIELD_RO ：获取BitMap中bit数组，并以十进制形式返回"),n("li",null,"BITOP ：将多个BitMap的结果做位运算（与 、或、异或）"),n("li",null,"BITPOS ：查找bit数组中指定范围内第一个0或1出现的位置")],-1)),l[1130]||(l[1130]=n("h4",{id:"_11-2-用户签到-实现签到功能",tabindex:"-1"},[E("11.2 用户签到-实现签到功能 "),n("a",{class:"header-anchor",href:"#_11-2-用户签到-实现签到功能","aria-label":'Permalink to "11.2 用户签到-实现签到功能"'},"​")],-1)),l[1131]||(l[1131]=n("p",null,"需求：实现签到接口，将当前用户当天签到信息保存到Redis中",-1)),l[1132]||(l[1132]=n("p",null,"思路：我们可以把年和月作为bitMap的key，然后保存到一个bitMap中，每次签到就到对应的位上把数字从0变成1，只要对应是1，就表明说明这一天已经签到了，反之则没有签到。",-1)),l[1133]||(l[1133]=n("p",null,"我们通过接口文档发现，此接口并没有传递任何的参数，没有参数怎么确实是哪一天签到呢？这个很容易，可以通过后台代码直接获取即可，然后到对应的地址上去修改bitMap。",-1)),l[1134]||(l[1134]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653833970361.png",alt:"1653833970361",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1135]||(l[1135]=n("p",null,[n("strong",null,"代码")],-1)),l[1136]||(l[1136]=n("p",null,"UserController",-1)),l[1137]||(l[1137]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/sign"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sign"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sign"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1138]||(l[1138]=n("p",null,"UserServiceImpl",-1)),l[1139]||(l[1139]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sign"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取当前登录用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.获取日期")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    LocalDateTime now "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.拼接key")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String keySuffix "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"format"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(DateTimeFormatter."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ofPattern"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":yyyyMM"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," USER_SIGN_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keySuffix;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.获取今天是本月的第几天")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dayOfMonth "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDayOfMonth"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.写入Redis SETBIT key offset 1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setBit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, dayOfMonth "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1140]||(l[1140]=n("h4",{id:"_11-3-用户签到-签到统计",tabindex:"-1"},[E("11.3 用户签到-签到统计 "),n("a",{class:"header-anchor",href:"#_11-3-用户签到-签到统计","aria-label":'Permalink to "11.3 用户签到-签到统计"'},"​")],-1)),l[1141]||(l[1141]=n("p",null,"**问题1：**什么叫做连续签到天数？ 从最后一次签到开始向前统计，直到遇到第一次未签到为止，计算总的签到次数，就是连续签到天数。",-1)),l[1142]||(l[1142]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653834455899.png",alt:"1653834455899",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1143]||(l[1143]=n("p",null,"Java逻辑代码：获得当前这个月的最后一次签到数据，定义一个计数器，然后不停的向前统计，直到获得第一个非0的数字即可，每得到一个非0的数字计数器+1，直到遍历完所有的数据，就可以获得当前月的签到总天数了",-1)),l[1144]||(l[1144]=n("p",null,"**问题2：**如何得到本月到今天为止的所有签到数据？",-1)),l[1145]||(l[1145]=n("p",null,[n("code",null,"BITFIELD key GET u[dayOfMonth] 0")],-1)),l[1146]||(l[1146]=n("p",null,"假设今天是10号，那么我们就可以从当前月的第一天开始，获得到当前这一天的位数，是10号，那么就是10位，去拿这段时间的数据，就能拿到所有的数据了，那么这10天里边签到了多少次呢？统计有多少个1即可。",-1)),l[1147]||(l[1147]=n("p",null,[n("strong",null,"问题3：如何从后向前遍历每个bit位？")],-1)),l[1148]||(l[1148]=n("p",null,"注意：bitMap返回的数据是10进制，哪假如说返回一个数字8，那么我哪儿知道到底哪些是0，哪些是1呢？我们只需要让得到的10进制数字和1做与运算就可以了，因为1只有遇见1 才是1，其他数字都是0 ，我们把签到结果和1进行与操作，每与一次，就把签到结果向右移动一位，依次内推，我们就能完成逐个遍历的效果了。",-1)),l[1149]||(l[1149]=n("p",null,"需求：实现下面接口，统计当前用户截止当前时间在本月的连续签到天数",-1)),l[1150]||(l[1150]=n("p",null,"有用户有时间我们就可以组织出对应的key，此时就能找到这个用户截止这天的所有签到记录，再根据这套算法，就能统计出来他连续签到的次数了",-1)),l[1151]||(l[1151]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653835784444.png",alt:"1653835784444",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1152]||(l[1152]=n("p",null,"代码",-1)),l[1153]||(l[1153]=n("p",null,[n("strong",null,"UserController")],-1)),l[1154]||(l[1154]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/sign/count"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"signCount"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"signCount"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1155]||(l[1155]=n("p",null,[n("strong",null,"UserServiceImpl")],-1)),l[1156]||(l[1156]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"signCount"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取当前登录用户")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.获取日期")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    LocalDateTime now "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalDateTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.拼接key")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String keySuffix "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"format"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(DateTimeFormatter."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ofPattern"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":yyyyMM"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," USER_SIGN_KEY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keySuffix;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.获取今天是本月的第几天")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dayOfMonth "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDayOfMonth"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.获取本月截止今天为止的所有的签到记录，返回的是一个十进制的数字 BITFIELD sign:5:202203 GET u14 0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bitField"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            key,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            BitFieldSubCommands."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(BitFieldSubCommands.BitFieldType."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unsigned"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(dayOfMonth))."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueAt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    );")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 没有任何签到结果")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long num "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (num "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," num "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.循环遍历")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.1.让这个数字与1做与运算，得到数字的最后一个bit位"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  // 判断这个bit位是否为0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((num "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果为0，说明未签到，结束")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            break"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果不为0，说明已签到，计数器+1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            count"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 把数字右移一位，抛弃最后一个bit位，继续下一个bit位")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        num "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">>>="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[1157]||(l[1157]=n("h4",{id:"_11-4-额外加餐-关于使用-bitmap-来解决缓存穿透的方案",tabindex:"-1"},[E("11.4 额外加餐 - 关于使用 bitmap 来解决缓存穿透的方案 "),n("a",{class:"header-anchor",href:"#_11-4-额外加餐-关于使用-bitmap-来解决缓存穿透的方案","aria-label":'Permalink to "11.4 额外加餐 - 关于使用 bitmap 来解决缓存穿透的方案"'},"​")],-1)),l[1158]||(l[1158]=n("p",null,[E("回顾"),n("strong",null,"缓存穿透"),E("：")],-1)),l[1159]||(l[1159]=n("p",null,"发起了一个数据库不存在的，redis里边也不存在的数据，通常你可以把他看成一个攻击",-1)),l[1160]||(l[1160]=n("p",null,"解决方案：",-1)),l[1161]||(l[1161]=n("ul",null,[n("li",null,[n("p",null,[E("判断"),n("code",null,"id<0")])]),n("li",null,[n("p",null,"如果数据库是空，那么就可以直接往redis里边把这个空数据缓存起来")])],-1)),l[1162]||(l[1162]=n("p",null,"第一种解决方案：遇到的问题是如果用户访问的是id不存在的数据，则此时就无法生效",-1)),l[1163]||(l[1163]=n("p",null,"第二种解决方案：遇到的问题是：如果是不同的id那就可以防止下次过来直击数据",-1)),l[1164]||(l[1164]=n("p",null,"所以我们如何解决呢？",-1)),l[1165]||(l[1165]=n("p",null,"我们可以将数据库的数据，所对应的id写入到一个list集合中，当用户过来访问的时候，我们直接去判断list中是否包含当前的要查询的数据，如果说用户要查询的id数据并不在list集合中，则直接返回，如果list中包含对应查询的id数据，则说明不是一次缓存穿透数据，则直接放行。",-1)),l[1166]||(l[1166]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653836416586.png",alt:"1653836416586",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1167]||(l[1167]=n("p",null,"现在的问题是这个主键其实并没有那么短，而是很长的一个 主键",-1)),l[1168]||(l[1168]=n("p",null,"哪怕你单独去提取这个主键，但是在11年左右，淘宝的商品总量就已经超过10亿个",-1)),l[1169]||(l[1169]=n("p",null,"所以如果采用以上方案，这个list也会很大，所以我们可以使用bitmap来减少list的存储空间",-1)),l[1170]||(l[1170]=n("p",null,"我们可以把list数据抽象成一个非常大的bitmap，我们不再使用list，而是将db中的id数据利用哈希思想，比如：",-1)),l[1171]||(l[1171]=n("p",null,[n("code",null,"id % bitmap.size"),E(" = 算出当前这个id对应应该落在bitmap的哪个索引上，然后将这个值从0变成1，然后当用户来查询数据时，此时已经没有了list，让用户用他查询的id去用相同的哈希算法， 算出来当前这个id应当落在bitmap的哪一位，然后判断这一位是0，还是1，如果是0则表明这一位上的数据一定不存在， 采用这种方式来处理，需要重点考虑一个事情，就是误差率，所谓的误差率就是指当发生哈希冲突的时候，产生的误差。")],-1)),l[1172]||(l[1172]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653836578970.png",alt:"1653836578970",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1173]||(l[1173]=n("h3",{id:"_12-uv统计",tabindex:"-1"},[E("12. UV统计 "),n("a",{class:"header-anchor",href:"#_12-uv统计","aria-label":'Permalink to "12. UV统计"'},"​")],-1)),l[1174]||(l[1174]=n("h4",{id:"_12-1-uv-统计-hyperloglog",tabindex:"-1"},[E("12.1 UV 统计 - HyperLogLog "),n("a",{class:"header-anchor",href:"#_12-1-uv-统计-hyperloglog","aria-label":'Permalink to "12.1 UV 统计 - HyperLogLog"'},"​")],-1)),l[1175]||(l[1175]=n("p",null,"首先我们搞懂两个概念：",-1)),l[1176]||(l[1176]=n("ul",null,[n("li",null,"UV：全称Unique Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录1次。"),n("li",null,"PV：全称Page View，也叫页面访问量或点击量，用户每访问网站的一个页面，记录1次PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。"),n("li",null,"通常来说UV会比PV大很多，所以衡量同一个网站的访问量，我们需要综合考虑很多因素，所以我们只是单纯的把这两个值作为一个参考值"),n("li",null,"UV统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。但是如果每个访问的用户都保存到Redis中，数据量会非常恐怖，那怎么处理呢？"),n("li",null,[E("Hyperloglog(HLL)是从Loglog算法派生的概率算法，用于确定非常大的集合的基数，而不需要存储其所有值。相关算法原理大家可以参考："),n("a",{href:"https://juejin.cn/post/6844903785744056333#heading-0",target:"_blank",rel:"noreferrer"},"https://juejin.cn/post/6844903785744056333#heading-0")]),n("li",null,[E("Redis中的HLL是基于string结构实现的，单个HLL的内存"),n("strong",null,"永远小于16kb"),E("，"),n("strong",null,"内存占用低"),E("的令人发指！作为代价，其测量结果是概率性的，"),n("strong",null,"有小于0.81％的误差"),E("。不过对于UV统计来说，这完全可以忽略。")]),n("li",null,[E("常用的三个方法"),n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653837988985.png",alt:"1653837988985"})])],-1)),l[1177]||(l[1177]=n("h4",{id:"_12-2-uv-统计-测试百万数据的统计",tabindex:"-1"},[E("12.2 UV 统计 - 测试百万数据的统计 "),n("a",{class:"header-anchor",href:"#_12-2-uv-统计-测试百万数据的统计","aria-label":'Permalink to "12.2 UV 统计 - 测试百万数据的统计"'},"​")],-1)),l[1178]||(l[1178]=n("p",null,"测试思路：我们直接利用单元测试，向HyperLogLog中添加100万条数据，看看内存占用和统计效果如何",-1)),l[1179]||(l[1179]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653838053608.png",alt:"1653838053608",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1180]||(l[1180]=n("p",null,"经过测试：我们会发生他的误差是在允许范围内，并且内存占用极小",-1))]),"main-header":k(()=>[t(s.$slots,"main-header")]),"main-header-after":k(()=>[t(s.$slots,"main-header-after")]),"main-nav":k(()=>[t(s.$slots,"main-nav")]),"main-content-before":k(()=>[t(s.$slots,"main-content-before")]),"main-content":k(()=>[t(s.$slots,"main-content")]),"main-content-after":k(()=>[t(s.$slots,"main-content-after")]),"main-nav-before":k(()=>[t(s.$slots,"main-nav-before")]),"main-nav-after":k(()=>[t(s.$slots,"main-nav-after")]),comment:k(()=>[t(s.$slots,"comment")]),footer:k(()=>[t(s.$slots,"footer")]),aside:k(()=>[t(s.$slots,"aside")]),"aside-custom":k(()=>[t(s.$slots,"aside-custom")]),default:k(()=>[t(s.$slots,"default")]),_:3},8,["frontmatter"])}}};export{y as default,g as usePageData};
