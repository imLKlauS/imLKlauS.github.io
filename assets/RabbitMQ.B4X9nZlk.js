var y=(e,r,k)=>new Promise((E,g)=>{var p=a=>{try{h(k.next(a))}catch(s){g(s)}},d=a=>{try{h(k.throw(a))}catch(s){g(s)}},h=a=>a.done?E(a.value):Promise.resolve(a.value).then(p,d);h((k=k.apply(e,r)).next())});import{_ as o}from"./ValaxyMain.vue_vue_type_style_index_0_lang.39opEnV_.js";import"./chunks/@vueuse/motion.C0680yyY.js";import{d as F,a as b,u as m}from"./chunks/vue-router.BaQM4Kc2.js";import{a1 as C,a3 as n,a4 as t,a5 as i,a6 as B,a7 as l,F as D,a2 as A,Z as f}from"./framework.CyQERZzy.js";import"./app.yrEQeKqa.js";import"./chunks/dayjs.BSMtxqtT.js";import"./chunks/vue-i18n.CvwbWgfE.js";import"./chunks/pinia.CyvRWuDa.js";import"./chunks/nprogress.c3ZdlDjC.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.XbFefrGO.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.Du2MZPyS.js";import"./post.C7a2r-qQ.js";const v=F("/posts/RabbitMQ",e=>y(null,null,function*(){return JSON.parse('{"title":"RabbitMQ 从入门到实战","description":"","frontmatter":{"title":"RabbitMQ 从入门到实战","top":99,"author":"imklaus","tags":["RabbitMQ"],"categories":["中间件"],"date":"2025-12-5 15:00:10","outline":"deep","excerpt_type":"html","postTitleClass":"text-#f49a31","end":false},"headers":[],"relativePath":"pages/posts/RabbitMQ.md","lastUpdated":null}')}),{lazy:(e,r)=>e.name===r.name}),U={__name:"RabbitMQ",setup(e,{expose:r}){var h;const{data:k}=v(),E=m(),g=b(),p=Object.assign(g.meta.frontmatter||{},((h=k.value)==null?void 0:h.frontmatter)||{});return E.currentRoute.value.data=k.value,f("valaxy:frontmatter",p),globalThis.$frontmatter=p,r({frontmatter:{title:"RabbitMQ 从入门到实战",top:99,author:"imklaus",tags:["RabbitMQ"],categories:["中间件"],date:"2025-12-5 15:00:10",outline:"deep",excerpt_type:"html",postTitleClass:"text-#f49a31",end:!1}}),(a,s)=>{const u=o;return A(),C(u,{frontmatter:D(p)},{"main-content-md":n(()=>[s[0]||(s[0]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/rabbitmq-beginners-updated.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1]||(s[1]=i("p",null,[l("参考视频："),i("a",{href:"https://www.bilibili.com/video/BV1mN4y1Z7t9",target:"_blank",rel:"noreferrer"},"黑马RabbitMQ深入学习")],-1)),s[2]||(s[2]=i("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),s[3]||(s[3]=i("p",null,[i("strong",null,"目录指引"),l("：")],-1)),s[4]||(s[4]=i("nav",{class:"table-of-contents"},[i("ul",null,[i("li",null,[i("a",{href:"#服务异步通信-实用篇"},"服务异步通信-实用篇"),i("ul",null,[i("li",null,[i("a",{href:"#_1-初识mq"},"1. 初识MQ"),i("ul",null,[i("li",null,[i("a",{href:"#_1-1-同步和异步通讯"},"1.1 同步和异步通讯")]),i("li",null,[i("a",{href:"#_1-2-技术对比"},"1.2 技术对比：")])])]),i("li",null,[i("a",{href:"#_2-快速入门"},"2. 快速入门"),i("ul",null,[i("li",null,[i("a",{href:"#_2-1-安装rabbitmq"},"2.1 安装RabbitMQ")]),i("li",null,[i("a",{href:"#_2-2-rabbitmq消息模型"},"2.2 RabbitMQ消息模型")]),i("li",null,[i("a",{href:"#_2-3-导入demo工程"},"2.3 导入Demo工程")]),i("li",null,[i("a",{href:"#_2-4-入门案例"},"2.4 入门案例")]),i("li",null,[i("a",{href:"#_2-5-总结"},"2.5 总结")])])]),i("li",null,[i("a",{href:"#_3-springamqp"},"3. SpringAMQP"),i("ul",null,[i("li",null,[i("a",{href:"#_3-1-basic-queue-简单队列模型"},"3.1 Basic Queue 简单队列模型")]),i("li",null,[i("a",{href:"#_3-2-workqueue"},"3.2 WorkQueue")]),i("li",null,[i("a",{href:"#_3-3-发布-订阅"},"3.3 发布/订阅")]),i("li",null,[i("a",{href:"#_3-4-fanout"},"3.4 Fanout")]),i("li",null,[i("a",{href:"#_3-5-direct"},"3.5 Direct")]),i("li",null,[i("a",{href:"#_3-6-topic"},"3.6 Topic")]),i("li",null,[i("a",{href:"#_3-7-消息转换器"},"3.7 消息转换器")])])])])]),i("li",null,[i("a",{href:"#rabbitmq部署指南"},"RabbitMQ部署指南"),i("ul",null,[i("li",null,[i("a",{href:"#_1-单机部署"},"1. 单机部署"),i("ul",null,[i("li",null,[i("a",{href:"#_1-1-下载镜像"},"1.1 下载镜像")]),i("li",null,[i("a",{href:"#_1-2-安装mq"},"1.2 安装MQ")])])]),i("li",null,[i("a",{href:"#_2-安装delayexchange插件"},"2. 安装DelayExchange插件"),i("ul",null,[i("li",null,[i("a",{href:"#_2-1-下载插件"},"2.1 下载插件")]),i("li",null,[i("a",{href:"#_2-2-上传插件"},"2.2 上传插件")]),i("li",null,[i("a",{href:"#_2-3-安装插件"},"2.3 安装插件")])])]),i("li",null,[i("a",{href:"#_3-集群部署"},"3. 集群部署"),i("ul",null,[i("li",null,[i("a",{href:"#_3-1-集群分类"},"3.1 集群分类")]),i("li",null,[i("a",{href:"#_3-2-获取cookie"},"3.2 获取cookie")]),i("li",null,[i("a",{href:"#_3-3-准备集群配置"},"3.3 准备集群配置")]),i("li",null,[i("a",{href:"#_3-4-启动集群"},"3.4 启动集群")]),i("li",null,[i("a",{href:"#_3-5-测试"},"3.5 测试")])])]),i("li",null,[i("a",{href:"#_4-镜像模式"},"4. 镜像模式"),i("ul",null,[i("li",null,[i("a",{href:"#_4-1-镜像模式的特征"},"4.1 镜像模式的特征")]),i("li",null,[i("a",{href:"#_4-2-镜像模式的配置"},"4.2 镜像模式的配置")]),i("li",null,[i("a",{href:"#_4-3-测试"},"4.3 测试")])])]),i("li",null,[i("a",{href:"#_5-仲裁队列"},"5. 仲裁队列"),i("ul",null,[i("li",null,[i("a",{href:"#_5-1-添加仲裁队列"},"5.1 添加仲裁队列")]),i("li",null,[i("a",{href:"#_5-2-测试"},"5.2 测试")]),i("li",null,[i("a",{href:"#_5-3-集群扩容"},"5.3 集群扩容")])])])])]),i("li",null,[i("a",{href:"#服务异步通信-高级篇"},"服务异步通信-高级篇"),i("ul",null,[i("li",null,[i("a",{href:"#_1-消息可靠性"},"1. 消息可靠性"),i("ul",null,[i("li",null,[i("a",{href:"#_1-1-生产者消息确认"},"1.1 生产者消息确认")]),i("li",null,[i("a",{href:"#_1-2-消息持久化"},"1.2 消息持久化")]),i("li",null,[i("a",{href:"#_1-3-消费者消息确认"},"1.3 消费者消息确认")]),i("li",null,[i("a",{href:"#_1-4-消费失败重试机制"},"1.4 消费失败重试机制")]),i("li",null,[i("a",{href:"#_1-5-总结"},"1.5 总结")])])]),i("li",null,[i("a",{href:"#_2-死信交换机"},"2. 死信交换机"),i("ul",null,[i("li",null,[i("a",{href:"#_2-1-初识死信交换机"},"2.1 初识死信交换机")]),i("li",null,[i("a",{href:"#_2-2-ttl"},"2.2 TTL")]),i("li",null,[i("a",{href:"#_2-3-延迟队列"},"2.3 延迟队列")])])]),i("li",null,[i("a",{href:"#_3-惰性队列"},"3. 惰性队列"),i("ul",null,[i("li",null,[i("a",{href:"#_3-1-消息堆积问题"},"3.1 消息堆积问题")]),i("li",null,[i("a",{href:"#_3-2-惰性队列"},"3.2 惰性队列")]),i("li",null,[i("a",{href:"#_3-3-总结"},"3.3 总结")])])]),i("li",null,[i("a",{href:"#_4-mq集群"},"4. MQ集群"),i("ul",null,[i("li",null,[i("a",{href:"#_4-1-集群分类"},"4.1 集群分类")]),i("li",null,[i("a",{href:"#_4-2-普通集群"},"4.2 普通集群")]),i("li",null,[i("a",{href:"#_4-3-镜像集群"},"4.3 镜像集群")]),i("li",null,[i("a",{href:"#_4-4-仲裁队列"},"4.4 仲裁队列")])])])])])])],-1)),s[5]||(s[5]=i("h2",{id:"服务异步通信-实用篇",tabindex:"-1"},[l("服务异步通信-实用篇 "),i("a",{class:"header-anchor",href:"#服务异步通信-实用篇","aria-label":'Permalink to "服务异步通信-实用篇"'},"​")],-1)),s[6]||(s[6]=i("hr",null,null,-1)),s[7]||(s[7]=i("h3",{id:"_1-初识mq",tabindex:"-1"},[l("1. 初识MQ "),i("a",{class:"header-anchor",href:"#_1-初识mq","aria-label":'Permalink to "1. 初识MQ"'},"​")],-1)),s[8]||(s[8]=i("h4",{id:"_1-1-同步和异步通讯",tabindex:"-1"},[l("1.1 同步和异步通讯 "),i("a",{class:"header-anchor",href:"#_1-1-同步和异步通讯","aria-label":'Permalink to "1.1 同步和异步通讯"'},"​")],-1)),s[9]||(s[9]=i("p",null,"微服务间通讯有同步和异步两种方式：",-1)),s[10]||(s[10]=i("p",null,"同步通讯：就像打电话，需要实时响应。",-1)),s[11]||(s[11]=i("p",null,"异步通讯：就像发邮件，不需要马上回复。",-1)),B(" more "),s[12]||(s[12]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717161939695.png",alt:"image-20210717161939695",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[13]||(s[13]=i("p",null,"两种方式各有优劣，打电话可以立即得到响应，但是你却不能跟多个人同时通话。发送邮件可以同时与多个人收发邮件，但是往往响应会有延迟。",-1)),s[14]||(s[14]=i("h5",{id:"_1-1-1-同步通讯",tabindex:"-1"},[l("1.1.1 同步通讯 "),i("a",{class:"header-anchor",href:"#_1-1-1-同步通讯","aria-label":'Permalink to "1.1.1 同步通讯"'},"​")],-1)),s[15]||(s[15]=i("p",null,"我们之前学习的Feign调用就属于同步方式，虽然调用可以实时得到结果，但存在下面的问题：",-1)),s[16]||(s[16]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717162004285.png",alt:"image-20210717162004285",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[17]||(s[17]=i("p",null,"总结：",-1)),s[18]||(s[18]=i("p",null,"同步调用的优点：",-1)),s[19]||(s[19]=i("ul",null,[i("li",null,"时效性较强，可以立即得到结果")],-1)),s[20]||(s[20]=i("p",null,"同步调用的问题：",-1)),s[21]||(s[21]=i("ul",null,[i("li",null,"耦合度高"),i("li",null,"性能和吞吐能力下降"),i("li",null,"有额外的资源消耗"),i("li",null,"有级联失败问题")],-1)),s[22]||(s[22]=i("h5",{id:"_1-1-2-异步通讯",tabindex:"-1"},[l("1.1.2 异步通讯 "),i("a",{class:"header-anchor",href:"#_1-1-2-异步通讯","aria-label":'Permalink to "1.1.2 异步通讯"'},"​")],-1)),s[23]||(s[23]=i("p",null,"异步调用则可以避免上述问题：",-1)),s[24]||(s[24]=i("p",null,"我们以购买商品为例，用户支付后需要调用订单服务完成订单状态修改，调用物流服务，从仓库分配响应的库存并准备发货。",-1)),s[25]||(s[25]=i("p",null,"在事件模式中，支付服务是事件发布者（publisher），在支付完成后只需要发布一个支付成功的事件（event），事件中带上订单id。",-1)),s[26]||(s[26]=i("p",null,"订单服务和物流服务是事件订阅者（Consumer），订阅支付成功的事件，监听到事件后完成自己业务即可。",-1)),s[27]||(s[27]=i("p",null,"为了解除事件发布者与订阅者之间的耦合，两者并不是直接通信，而是有一个中间人（Broker）。发布者发布事件到Broker，不关心谁来订阅事件。订阅者从Broker订阅事件，不关心谁发来的消息。",-1)),s[28]||(s[28]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210422095356088.png",alt:"image-20210422095356088",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[29]||(s[29]=i("p",null,"Broker 是一个像数据总线一样的东西，所有的服务要接收数据和发送数据都发到这个总线上，这个总线就像协议一样，让服务间的通讯变得标准和可控。",-1)),s[30]||(s[30]=i("p",null,"好处：",-1)),s[31]||(s[31]=i("ul",null,[i("li",null,[i("p",null,"吞吐量提升：无需等待订阅者处理完成，响应更快速")]),i("li",null,[i("p",null,"故障隔离：服务没有直接调用，不存在级联失败问题")]),i("li",null,[i("p",null,"调用间没有阻塞，不会造成无效的资源占用")]),i("li",null,[i("p",null,"耦合度极低，每个服务都可以灵活插拔，可替换")]),i("li",null,[i("p",null,"流量削峰：不管发布事件的流量波动多大，都由Broker接收，订阅者可以按照自己的速度去处理事件")])],-1)),s[32]||(s[32]=i("p",null,"缺点：",-1)),s[33]||(s[33]=i("ul",null,[i("li",null,"架构复杂了，业务没有明显的流程线，不好管理"),i("li",null,"需要依赖于Broker的可靠、安全、性能")],-1)),s[34]||(s[34]=i("p",null,"好在现在开源软件或云平台上 Broker 的软件是非常成熟的，比较常见的一种就是我们今天要学习的MQ技术。",-1)),s[35]||(s[35]=i("h4",{id:"_1-2-技术对比",tabindex:"-1"},[l("1.2 技术对比： "),i("a",{class:"header-anchor",href:"#_1-2-技术对比","aria-label":'Permalink to "1.2 技术对比："'},"​")],-1)),s[36]||(s[36]=i("p",null,"MQ，中文是消息队列（MessageQueue），字面来看就是存放消息的队列。也就是事件驱动架构中的Broker。",-1)),s[37]||(s[37]=i("p",null,"比较常见的MQ实现：",-1)),s[38]||(s[38]=i("ul",null,[i("li",null,"ActiveMQ"),i("li",null,"RabbitMQ"),i("li",null,"RocketMQ"),i("li",null,"Kafka")],-1)),s[39]||(s[39]=i("p",null,"几种常见MQ的对比：",-1)),s[40]||(s[40]=i("table",null,[i("thead",null,[i("tr",null,[i("th"),i("th",null,[i("strong",null,"RabbitMQ")]),i("th",null,[i("strong",null,"ActiveMQ")]),i("th",null,[i("strong",null,"RocketMQ")]),i("th",null,[i("strong",null,"Kafka")])])]),i("tbody",null,[i("tr",null,[i("td",null,"公司/社区"),i("td",null,"Rabbit"),i("td",null,"Apache"),i("td",null,"阿里"),i("td",null,"Apache")]),i("tr",null,[i("td",null,"开发语言"),i("td",null,"Erlang"),i("td",null,"Java"),i("td",null,"Java"),i("td",null,"Scala&Java")]),i("tr",null,[i("td",null,"协议支持"),i("td",null,"AMQP，XMPP，SMTP，STOMP"),i("td",null,"OpenWire,STOMP，REST,XMPP,AMQP"),i("td",null,"自定义协议"),i("td",null,"自定义协议")]),i("tr",null,[i("td",null,"可用性"),i("td",null,"高"),i("td",null,"一般"),i("td",null,"高"),i("td",null,"高")]),i("tr",null,[i("td",null,"单机吞吐量"),i("td",null,"一般"),i("td",null,"差"),i("td",null,"高"),i("td",null,"非常高")]),i("tr",null,[i("td",null,"消息延迟"),i("td",null,"微秒级"),i("td",null,"毫秒级"),i("td",null,"毫秒级"),i("td",null,"毫秒以内")]),i("tr",null,[i("td",null,"消息可靠性"),i("td",null,"高"),i("td",null,"一般"),i("td",null,"高"),i("td",null,"一般")])])],-1)),s[41]||(s[41]=i("p",null,"追求可用性：Kafka、 RocketMQ 、RabbitMQ",-1)),s[42]||(s[42]=i("p",null,"追求可靠性：RabbitMQ、RocketMQ",-1)),s[43]||(s[43]=i("p",null,"追求吞吐能力：RocketMQ、Kafka",-1)),s[44]||(s[44]=i("p",null,"追求消息低延迟：RabbitMQ、Kafka",-1)),s[45]||(s[45]=i("hr",null,null,-1)),s[46]||(s[46]=i("h3",{id:"_2-快速入门",tabindex:"-1"},[l("2. 快速入门 "),i("a",{class:"header-anchor",href:"#_2-快速入门","aria-label":'Permalink to "2. 快速入门"'},"​")],-1)),s[47]||(s[47]=i("h4",{id:"_2-1-安装rabbitmq",tabindex:"-1"},[l("2.1 安装RabbitMQ "),i("a",{class:"header-anchor",href:"#_2-1-安装rabbitmq","aria-label":'Permalink to "2.1 安装RabbitMQ"'},"​")],-1)),s[48]||(s[48]=i("p",null,"安装RabbitMQ，参考课前资料：",-1)),s[49]||(s[49]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717162628635.png",alt:"image-20210717162628635",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[50]||(s[50]=i("p",null,"MQ的基本结构：",-1)),s[51]||(s[51]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717162752376.png",alt:"image-20210717162752376",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[52]||(s[52]=i("p",null,"RabbitMQ中的一些角色：",-1)),s[53]||(s[53]=i("ul",null,[i("li",null,"publisher：生产者"),i("li",null,"consumer：消费者"),i("li",null,"exchange个：交换机，负责消息路由"),i("li",null,"queue：队列，存储消息"),i("li",null,"virtualHost：虚拟主机，隔离不同租户的exchange、queue、消息的隔离")],-1)),s[54]||(s[54]=i("h4",{id:"_2-2-rabbitmq消息模型",tabindex:"-1"},[l("2.2 RabbitMQ消息模型 "),i("a",{class:"header-anchor",href:"#_2-2-rabbitmq消息模型","aria-label":'Permalink to "2.2 RabbitMQ消息模型"'},"​")],-1)),s[55]||(s[55]=i("p",null,"RabbitMQ官方提供了5个不同的Demo示例，对应了不同的消息模型：",-1)),s[56]||(s[56]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717163332646.png",alt:"image-20210717163332646",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[57]||(s[57]=i("h4",{id:"_2-3-导入demo工程",tabindex:"-1"},[l("2.3 导入Demo工程 "),i("a",{class:"header-anchor",href:"#_2-3-导入demo工程","aria-label":'Permalink to "2.3 导入Demo工程"'},"​")],-1)),s[58]||(s[58]=i("p",null,"课前资料提供了一个Demo工程，mq-demo:",-1)),s[59]||(s[59]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717163253264.png",alt:"image-20210717163253264",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[60]||(s[60]=i("p",null,"导入后可以看到结构如下：",-1)),s[61]||(s[61]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717163604330.png",alt:"image-20210717163604330",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[62]||(s[62]=i("p",null,"包括三部分：",-1)),s[63]||(s[63]=i("ul",null,[i("li",null,"mq-demo：父工程，管理项目依赖"),i("li",null,"publisher：消息的发送者"),i("li",null,"consumer：消息的消费者")],-1)),s[64]||(s[64]=i("h4",{id:"_2-4-入门案例",tabindex:"-1"},[l("2.4 入门案例 "),i("a",{class:"header-anchor",href:"#_2-4-入门案例","aria-label":'Permalink to "2.4 入门案例"'},"​")],-1)),s[65]||(s[65]=i("p",null,"简单队列模式的模型图：",-1)),s[66]||(s[66]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717163434647.png",alt:"image-20210717163434647",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[67]||(s[67]=i("p",null,"官方的HelloWorld是基于最基础的消息队列模型来实现的，只包括三个角色：",-1)),s[68]||(s[68]=i("ul",null,[i("li",null,"publisher：消息发布者，将消息发送到队列queue"),i("li",null,"queue：消息队列，负责接受并缓存消息"),i("li",null,"consumer：订阅队列，处理队列中的消息")],-1)),s[69]||(s[69]=i("h5",{id:"_2-4-1-publisher实现",tabindex:"-1"},[l("2.4.1 publisher实现 "),i("a",{class:"header-anchor",href:"#_2-4-1-publisher实现","aria-label":'Permalink to "2.4.1 publisher实现"'},"​")],-1)),s[70]||(s[70]=i("p",null,"思路：",-1)),s[71]||(s[71]=i("ul",null,[i("li",null,"建立连接"),i("li",null,"创建Channel"),i("li",null,"声明队列"),i("li",null,"发送消息"),i("li",null,"关闭连接和channel")],-1)),s[72]||(s[72]=i("p",null,"代码实现：",-1)),s[73]||(s[73]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.helloworld;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.rabbitmq.client.Channel;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.rabbitmq.client.Connection;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.rabbitmq.client.ConnectionFactory;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.Test;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.io.IOException;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.concurrent.TimeoutException;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," PublisherTest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSendMessage"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IOException, TimeoutException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.建立连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ConnectionFactory factory "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ConnectionFactory"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHost"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPort"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5672"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVirtualHost"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUsername"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"itcast"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPassword"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.2.建立连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Connection connection "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newConnection"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.创建通道Channel")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Channel channel "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," connection."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createChannel"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.创建队列")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String queueName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queueDeclare"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(queueName, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.发送消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, rabbitmq!"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"basicPublish"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", queueName, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBytes"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"发送消息成功：【"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.关闭通道和连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        connection."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[74]||(s[74]=i("h5",{id:"_2-4-2-consumer实现",tabindex:"-1"},[l("2.4.2 consumer实现 "),i("a",{class:"header-anchor",href:"#_2-4-2-consumer实现","aria-label":'Permalink to "2.4.2 consumer实现"'},"​")],-1)),s[75]||(s[75]=i("p",null,"代码思路：",-1)),s[76]||(s[76]=i("ul",null,[i("li",null,"建立连接"),i("li",null,"创建Channel"),i("li",null,"声明队列"),i("li",null,"订阅消息")],-1)),s[77]||(s[77]=i("p",null,"代码实现：",-1)),s[78]||(s[78]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.helloworld;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.rabbitmq.client."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"*"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.io.IOException;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.concurrent.TimeoutException;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ConsumerTest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"args"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IOException, TimeoutException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.建立连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ConnectionFactory factory "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ConnectionFactory"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHost"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPort"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5672"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVirtualHost"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUsername"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"itcast"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPassword"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.2.建立连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Connection connection "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," factory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newConnection"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.创建通道Channel")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Channel channel "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," connection."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createChannel"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.创建队列")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String queueName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queueDeclare"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(queueName, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.订阅消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"basicConsume"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(queueName, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DefaultConsumer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(channel){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleDelivery"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"consumerTag"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Envelope "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"envelope"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                       AMQP.BasicProperties "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"properties"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"byte"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"body"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IOException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 5.处理消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                String message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(body);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"接收到消息：【"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"等待接收消息。。。。"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[79]||(s[79]=i("h4",{id:"_2-5-总结",tabindex:"-1"},[l("2.5 总结 "),i("a",{class:"header-anchor",href:"#_2-5-总结","aria-label":'Permalink to "2.5 总结"'},"​")],-1)),s[80]||(s[80]=i("p",null,"基本消息队列的消息发送流程：",-1)),s[81]||(s[81]=i("ol",null,[i("li",null,[i("p",null,"建立connection")]),i("li",null,[i("p",null,"创建channel")]),i("li",null,[i("p",null,"利用channel声明队列")]),i("li",null,[i("p",null,"利用channel向队列发送消息")])],-1)),s[82]||(s[82]=i("p",null,"基本消息队列的消息接收流程：",-1)),s[83]||(s[83]=i("ol",null,[i("li",null,[i("p",null,"建立connection")]),i("li",null,[i("p",null,"创建channel")]),i("li",null,[i("p",null,"利用channel声明队列")]),i("li",null,[i("p",null,"定义consumer的消费行为handleDelivery()")]),i("li",null,[i("p",null,"利用channel将消费者与队列绑定")])],-1)),s[84]||(s[84]=i("hr",null,null,-1)),s[85]||(s[85]=i("h3",{id:"_3-springamqp",tabindex:"-1"},[l("3. SpringAMQP "),i("a",{class:"header-anchor",href:"#_3-springamqp","aria-label":'Permalink to "3. SpringAMQP"'},"​")],-1)),s[86]||(s[86]=i("p",null,"SpringAMQP是基于RabbitMQ封装的一套模板，并且还利用SpringBoot对其实现了自动装配，使用起来非常方便。",-1)),s[87]||(s[87]=i("p",null,[l("SpringAmqp的官方地址："),i("a",{href:"https://spring.io/projects/spring-amqp",target:"_blank",rel:"noreferrer"},"https://spring.io/projects/spring-amqp")],-1)),s[88]||(s[88]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717164024967.png",alt:"image-20210717164024967",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[89]||(s[89]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717164038678.png",alt:"image-20210717164038678",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[90]||(s[90]=i("p",null,"SpringAMQP提供了三个功能：",-1)),s[91]||(s[91]=i("ul",null,[i("li",null,"自动声明队列、交换机及其绑定关系"),i("li",null,"基于注解的监听器模式，异步接收消息"),i("li",null,"封装了RabbitTemplate工具，用于发送消息")],-1)),s[92]||(s[92]=i("h4",{id:"_3-1-basic-queue-简单队列模型",tabindex:"-1"},[l("3.1 Basic Queue 简单队列模型 "),i("a",{class:"header-anchor",href:"#_3-1-basic-queue-简单队列模型","aria-label":'Permalink to "3.1 Basic Queue 简单队列模型"'},"​")],-1)),s[93]||(s[93]=i("p",null,"在父工程mq-demo中引入依赖",-1)),s[94]||(s[94]=i("div",{class:"language-xml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"xml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"<!--AMQP依赖，包含RabbitMQ-->")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-amqp</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[95]||(s[95]=i("h5",{id:"_3-1-1-消息发送",tabindex:"-1"},[l("3.1.1 消息发送 "),i("a",{class:"header-anchor",href:"#_3-1-1-消息发送","aria-label":'Permalink to "3.1.1 消息发送"'},"​")],-1)),s[96]||(s[96]=i("p",null,"首先配置MQ地址，在publisher服务的application.yml中添加配置：",-1)),s[97]||(s[97]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    host"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"192.168.150.101"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 主机名")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    port"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5672"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 端口")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    virtual-host"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 虚拟主机")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    username"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"itcast"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 用户名")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    password"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 密码")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[98]||(s[98]=i("p",null,"然后在publisher服务中编写测试类SpringAmqpTest，并利用RabbitTemplate实现消息发送：",-1)),s[99]||(s[99]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.spring;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.Test;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.runner.RunWith;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.core.RabbitTemplate;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.annotation.Autowired;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.boot.test.context.SpringBootTest;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.test.context.junit4.SpringRunner;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RunWith"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SpringRunner.class)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SpringBootTest")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SpringAmqpTest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RabbitTemplate rabbitTemplate;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSimpleQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 队列名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String queueName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, spring amqp!"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 发送消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        rabbitTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(queueName, message);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[100]||(s[100]=i("h5",{id:"_3-1-2-消息接收",tabindex:"-1"},[l("3.1.2 消息接收 "),i("a",{class:"header-anchor",href:"#_3-1-2-消息接收","aria-label":'Permalink to "3.1.2 消息接收"'},"​")],-1)),s[101]||(s[101]=i("p",null,"首先配置MQ地址，在consumer服务的application.yml中添加配置：",-1)),s[102]||(s[102]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    host"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"192.168.150.101"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 主机名")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    port"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5672"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 端口")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    virtual-host"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 虚拟主机")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    username"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"itcast"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 用户名")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    password"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 密码")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[103]||(s[103]=i("p",null,[l("然后在consumer服务的"),i("code",null,"cn.itcast.mq.listener"),l("包中新建一个类SpringRabbitListener，代码如下：")],-1)),s[104]||(s[104]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.listener;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.annotation.RabbitListener;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SpringRabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenSimpleQueueMessage"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"msg"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," InterruptedException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"spring 消费者接收到消息：【"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[105]||(s[105]=i("h5",{id:"_3-1-3-测试",tabindex:"-1"},[l("3.1.3 测试 "),i("a",{class:"header-anchor",href:"#_3-1-3-测试","aria-label":'Permalink to "3.1.3 测试"'},"​")],-1)),s[106]||(s[106]=i("p",null,"启动consumer服务，然后在publisher服务中运行测试代码，发送MQ消息",-1)),s[107]||(s[107]=i("h4",{id:"_3-2-workqueue",tabindex:"-1"},[l("3.2 WorkQueue "),i("a",{class:"header-anchor",href:"#_3-2-workqueue","aria-label":'Permalink to "3.2 WorkQueue"'},"​")],-1)),s[108]||(s[108]=i("p",null,[l("Work queues，也被称为（Task queues），任务模型。简单来说就是"),i("strong",null,"让多个消费者绑定到一个队列，共同消费队列中的消息"),l("。")],-1)),s[109]||(s[109]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717164238910.png",alt:"image-20210717164238910",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[110]||(s[110]=i("p",null,"当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。",-1)),s[111]||(s[111]=i("p",null,"此时就可以使用work 模型，多个消费者共同处理消息处理，速度就能大大提高了。",-1)),s[112]||(s[112]=i("h5",{id:"_3-2-1-消息发送",tabindex:"-1"},[l("3.2.1 消息发送 "),i("a",{class:"header-anchor",href:"#_3-2-1-消息发送","aria-label":'Permalink to "3.2.1 消息发送"'},"​")],-1)),s[113]||(s[113]=i("p",null,"这次我们循环发送，模拟大量消息堆积现象。",-1)),s[114]||(s[114]=i("p",null,"在publisher服务中的SpringAmqpTest类中添加一个测试方法：",-1)),s[115]||(s[115]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * workQueue")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 向队列中不停发送消息，模拟消息堆积。")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testWorkQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws InterruptedException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 队列名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String queueName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, message_"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 50"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 发送消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        rabbitTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(queueName, message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[116]||(s[116]=i("h5",{id:"_3-2-2-消息接收",tabindex:"-1"},[l("3.2.2 消息接收 "),i("a",{class:"header-anchor",href:"#_3-2-2-消息接收","aria-label":'Permalink to "3.2.2 消息接收"'},"​")],-1)),s[117]||(s[117]=i("p",null,"要模拟多个消费者绑定同一个队列，我们在consumer服务的SpringRabbitListener中添加2个新的方法：",-1)),s[118]||(s[118]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenWorkQueue1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg) throws InterruptedException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者1接收到消息：【"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenWorkQueue2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg) throws InterruptedException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.err."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者2........接收到消息：【"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"200"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[119]||(s[119]=i("p",null,"注意到这个消费者sleep了1000秒，模拟任务耗时。",-1)),s[120]||(s[120]=i("h5",{id:"_3-2-3-测试",tabindex:"-1"},[l("3.2.3 测试 "),i("a",{class:"header-anchor",href:"#_3-2-3-测试","aria-label":'Permalink to "3.2.3 测试"'},"​")],-1)),s[121]||(s[121]=i("p",null,"启动ConsumerApplication后，在执行publisher服务中刚刚编写的发送测试方法testWorkQueue。",-1)),s[122]||(s[122]=i("p",null,"可以看到消费者1很快完成了自己的25条消息。消费者2却在缓慢的处理自己的25条消息。",-1)),s[123]||(s[123]=i("p",null,"也就是说消息是平均分配给每个消费者，并没有考虑到消费者的处理能力。这样显然是有问题的。",-1)),s[124]||(s[124]=i("h5",{id:"_3-2-4-能者多劳",tabindex:"-1"},[l("3.2.4 能者多劳 "),i("a",{class:"header-anchor",href:"#_3-2-4-能者多劳","aria-label":'Permalink to "3.2.4 能者多劳"'},"​")],-1)),s[125]||(s[125]=i("p",null,"在spring中有一个简单的配置，可以解决这个问题。我们修改consumer服务的application.yml文件，添加配置：",-1)),s[126]||(s[126]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    listener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      simple"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        prefetch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 每次只能获取一条消息，处理完成才能获取下一个消息")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[127]||(s[127]=i("h5",{id:"_3-2-5-总结",tabindex:"-1"},[l("3.2.5 总结 "),i("a",{class:"header-anchor",href:"#_3-2-5-总结","aria-label":'Permalink to "3.2.5 总结"'},"​")],-1)),s[128]||(s[128]=i("p",null,"Work模型的使用：",-1)),s[129]||(s[129]=i("ul",null,[i("li",null,"多个消费者绑定到一个队列，同一条消息只会被一个消费者处理"),i("li",null,"通过设置prefetch来控制消费者预取的消息数量")],-1)),s[130]||(s[130]=i("h4",{id:"_3-3-发布-订阅",tabindex:"-1"},[l("3.3 发布/订阅 "),i("a",{class:"header-anchor",href:"#_3-3-发布-订阅","aria-label":'Permalink to "3.3 发布/订阅"'},"​")],-1)),s[131]||(s[131]=i("p",null,"发布订阅的模型如图：",-1)),s[132]||(s[132]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717165309625.png",alt:"image-20210717165309625",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[133]||(s[133]=i("p",null,"可以看到，在订阅模型中，多了一个exchange角色，而且过程略有变化：",-1)),s[134]||(s[134]=i("ul",null,[i("li",null,"Publisher：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）"),i("li",null,[l("Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有以下3种类型： "),i("ul",null,[i("li",null,"Fanout：广播，将消息交给所有绑定到交换机的队列"),i("li",null,"Direct：定向，把消息交给符合指定routing key 的队列"),i("li",null,"Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列")])]),i("li",null,"Consumer：消费者，与以前一样，订阅队列，没有变化"),i("li",null,"Queue：消息队列也与以前一样，接收消息、缓存消息。")],-1)),s[135]||(s[135]=i("p",null,[i("strong",null,"Exchange（交换机）只负责转发消息，不具备存储消息的能力"),l("，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！")],-1)),s[136]||(s[136]=i("h4",{id:"_3-4-fanout",tabindex:"-1"},[l("3.4 Fanout "),i("a",{class:"header-anchor",href:"#_3-4-fanout","aria-label":'Permalink to "3.4 Fanout"'},"​")],-1)),s[137]||(s[137]=i("p",null,"Fanout，英文翻译是扇出，我觉得在MQ中叫广播更合适。",-1)),s[138]||(s[138]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717165438225.png",alt:"image-20210717165438225",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[139]||(s[139]=i("p",null,"在广播模式下，消息发送流程是这样的：",-1)),s[140]||(s[140]=i("ul",null,[i("li",null,"1） 可以有多个队列"),i("li",null,"2） 每个队列都要绑定到Exchange（交换机）"),i("li",null,"3） 生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定"),i("li",null,"4） 交换机把消息发送给绑定过的所有队列"),i("li",null,"5） 订阅队列的消费者都能拿到消息")],-1)),s[141]||(s[141]=i("p",null,"我们的计划是这样的：",-1)),s[142]||(s[142]=i("ul",null,[i("li",null,"创建一个交换机 itcast.fanout，类型是Fanout"),i("li",null,"创建两个队列fanout.queue1和fanout.queue2，绑定到交换机itcast.fanout")],-1)),s[143]||(s[143]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717165509466.png",alt:"image-20210717165509466",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[144]||(s[144]=i("h5",{id:"_3-4-1-声明队列和交换机",tabindex:"-1"},[l("3.4.1 声明队列和交换机 "),i("a",{class:"header-anchor",href:"#_3-4-1-声明队列和交换机","aria-label":'Permalink to "3.4.1 声明队列和交换机"'},"​")],-1)),s[145]||(s[145]=i("p",null,"Spring提供了一个接口Exchange，来表示所有不同类型的交换机：",-1)),s[146]||(s[146]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717165552676.png",alt:"image-20210717165552676",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[147]||(s[147]=i("p",null,"在consumer中创建一个类，声明队列和交换机：",-1)),s[148]||(s[148]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.config;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.Binding;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.BindingBuilder;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.FanoutExchange;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.Queue;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Bean;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Configuration;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," FanoutConfig"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 声明交换机")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," Fanout类型交换机")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," FanoutExchange "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fanoutExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," FanoutExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"itcast.fanout"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 第1个队列")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fanoutQueue1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"fanout.queue1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 绑定队列和交换机")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bindingQueue1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Queue "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"fanoutQueue1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", FanoutExchange "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"fanoutExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(fanoutQueue1)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(fanoutExchange);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 第2个队列")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fanoutQueue2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"fanout.queue2"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 绑定队列和交换机")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bindingQueue2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Queue "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"fanoutQueue2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", FanoutExchange "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"fanoutExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(fanoutQueue2)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(fanoutExchange);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[149]||(s[149]=i("h5",{id:"_3-4-2-消息发送",tabindex:"-1"},[l("3.4.2.消息发送 "),i("a",{class:"header-anchor",href:"#_3-4-2-消息发送","aria-label":'Permalink to "3.4.2.消息发送"'},"​")],-1)),s[150]||(s[150]=i("p",null,"在publisher服务的SpringAmqpTest类中添加测试方法：",-1)),s[151]||(s[151]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testFanoutExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 队列名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String exchangeName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.fanout"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, everyone!"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(exchangeName, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[152]||(s[152]=i("h5",{id:"_3-4-3-消息接收",tabindex:"-1"},[l("3.4.3 消息接收 "),i("a",{class:"header-anchor",href:"#_3-4-3-消息接收","aria-label":'Permalink to "3.4.3 消息接收"'},"​")],-1)),s[153]||(s[153]=i("p",null,"在consumer服务的SpringRabbitListener中添加两个方法，作为消费者：",-1)),s[154]||(s[154]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "fanout.queue1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenFanoutQueue1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者1接收到Fanout消息：【"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "fanout.queue2"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenFanoutQueue2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者2接收到Fanout消息：【"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[155]||(s[155]=i("h5",{id:"_3-4-4-总结",tabindex:"-1"},[l("3.4.4 总结 "),i("a",{class:"header-anchor",href:"#_3-4-4-总结","aria-label":'Permalink to "3.4.4 总结"'},"​")],-1)),s[156]||(s[156]=i("p",null,"交换机的作用是什么？",-1)),s[157]||(s[157]=i("ul",null,[i("li",null,"接收publisher发送的消息"),i("li",null,"将消息按照规则路由到与之绑定的队列"),i("li",null,"不能缓存消息，路由失败，消息丢失"),i("li",null,"FanoutExchange的会将消息路由到每个绑定的队列")],-1)),s[158]||(s[158]=i("p",null,"声明队列、交换机、绑定关系的Bean是什么？",-1)),s[159]||(s[159]=i("ul",null,[i("li",null,"Queue"),i("li",null,"FanoutExchange"),i("li",null,"Binding")],-1)),s[160]||(s[160]=i("h4",{id:"_3-5-direct",tabindex:"-1"},[l("3.5 Direct "),i("a",{class:"header-anchor",href:"#_3-5-direct","aria-label":'Permalink to "3.5 Direct"'},"​")],-1)),s[161]||(s[161]=i("p",null,"在Fanout模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到Direct类型的Exchange。",-1)),s[162]||(s[162]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717170041447.png",alt:"image-20210717170041447",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[163]||(s[163]=i("p",null,"在Direct模型下：",-1)),s[164]||(s[164]=i("ul",null,[i("li",null,[l("队列与交换机的绑定，不能是任意绑定了，而是要指定一个"),i("code",null,"RoutingKey"),l("（路由key）")]),i("li",null,[l("消息的发送方在 向 Exchange发送消息时，也必须指定消息的 "),i("code",null,"RoutingKey"),l("。")]),i("li",null,[l("Exchange不再把消息交给每一个绑定的队列，而是根据消息的"),i("code",null,"Routing Key"),l("进行判断，只有队列的"),i("code",null,"Routingkey"),l("与消息的 "),i("code",null,"Routing key"),l("完全一致，才会接收到消息")])],-1)),s[165]||(s[165]=i("p",null,[i("strong",null,"案例需求如下"),l("：")],-1)),s[166]||(s[166]=i("ol",null,[i("li",null,[i("p",null,"利用@RabbitListener声明Exchange、Queue、RoutingKey")]),i("li",null,[i("p",null,"在consumer服务中，编写两个消费者方法，分别监听direct.queue1和direct.queue2")]),i("li",null,[i("p",null,"在publisher中编写测试方法，向itcast. direct发送消息")])],-1)),s[167]||(s[167]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717170223317.png",alt:"image-20210717170223317",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[168]||(s[168]=i("h5",{id:"_3-5-1-基于注解声明队列和交换机",tabindex:"-1"},[l("3.5.1 基于注解声明队列和交换机 "),i("a",{class:"header-anchor",href:"#_3-5-1-基于注解声明队列和交换机","aria-label":'Permalink to "3.5.1 基于注解声明队列和交换机"'},"​")],-1)),s[169]||(s[169]=i("p",null,"基于@Bean的方式声明队列和交换机比较麻烦，Spring还提供了基于注解方式来声明。",-1)),s[170]||(s[170]=i("p",null,"在consumer的SpringRabbitListener中添加两个消费者，同时基于注解来声明队列和交换机：",-1)),s[171]||(s[171]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"bindings"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"QueueBinding"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    value"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Queue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "direct.queue1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    exchange"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Exchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"type"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExchangeTypes.DIRECT),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    key"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"red"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"blue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenDirectQueue1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者接收到direct.queue1的消息：【"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"bindings"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"QueueBinding"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    value"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Queue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "direct.queue2"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    exchange"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Exchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"type"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExchangeTypes.DIRECT),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    key"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"red"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"yellow"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenDirectQueue2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者接收到direct.queue2的消息：【"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[172]||(s[172]=i("h5",{id:"_3-5-2-消息发送",tabindex:"-1"},[l("3.5.2 消息发送 "),i("a",{class:"header-anchor",href:"#_3-5-2-消息发送","aria-label":'Permalink to "3.5.2 消息发送"'},"​")],-1)),s[173]||(s[173]=i("p",null,"在publisher服务的SpringAmqpTest类中添加测试方法：",-1)),s[174]||(s[174]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSendDirectExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 交换机名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String exchangeName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "红色警报！日本乱排核废水，导致海洋生物变异，惊现哥斯拉！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(exchangeName, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"red"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[175]||(s[175]=i("h5",{id:"_3-5-3-总结",tabindex:"-1"},[l("3.5.3 总结 "),i("a",{class:"header-anchor",href:"#_3-5-3-总结","aria-label":'Permalink to "3.5.3 总结"'},"​")],-1)),s[176]||(s[176]=i("p",null,"描述下Direct交换机与Fanout交换机的差异？",-1)),s[177]||(s[177]=i("ul",null,[i("li",null,"Fanout交换机将消息路由给每一个与之绑定的队列"),i("li",null,"Direct交换机根据RoutingKey判断路由给哪个队列"),i("li",null,"如果多个队列具有相同的RoutingKey，则与Fanout功能类似")],-1)),s[178]||(s[178]=i("p",null,"基于@RabbitListener注解声明队列和交换机有哪些常见注解？",-1)),s[179]||(s[179]=i("ul",null,[i("li",null,"@Queue"),i("li",null,"@Exchange")],-1)),s[180]||(s[180]=i("h4",{id:"_3-6-topic",tabindex:"-1"},[l("3.6 Topic "),i("a",{class:"header-anchor",href:"#_3-6-topic","aria-label":'Permalink to "3.6 Topic"'},"​")],-1)),s[181]||(s[181]=i("h5",{id:"_3-6-1-说明",tabindex:"-1"},[l("3.6.1 说明 "),i("a",{class:"header-anchor",href:"#_3-6-1-说明","aria-label":'Permalink to "3.6.1 说明"'},"​")],-1)),s[182]||(s[182]=i("p",null,[i("code",null,"Topic"),l("类型的"),i("code",null,"Exchange"),l("与"),i("code",null,"Direct"),l("相比，都是可以根据"),i("code",null,"RoutingKey"),l("把消息路由到不同的队列。只不过"),i("code",null,"Topic"),l("类型"),i("code",null,"Exchange"),l("可以让队列在绑定"),i("code",null,"Routing key"),l(" 的时候使用通配符！")],-1)),s[183]||(s[183]=i("p",null,[i("code",null,"Routingkey"),l(" 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： "),i("code",null,"item.insert")],-1)),s[184]||(s[184]=i("p",null,"通配符规则：",-1)),s[185]||(s[185]=i("p",null,[i("code",null,"#"),l("：匹配一个或多个词")],-1)),s[186]||(s[186]=i("p",null,[i("code",null,"*"),l("：匹配不多不少恰好1个词")],-1)),s[187]||(s[187]=i("p",null,"举例：",-1)),s[188]||(s[188]=i("p",null,[i("code",null,"item.#"),l("：能够匹配"),i("code",null,"item.spu.insert"),l(" 或者 "),i("code",null,"item.spu")],-1)),s[189]||(s[189]=i("p",null,[i("code",null,"item.*"),l("：只能匹配"),i("code",null,"item.spu")],-1)),s[190]||(s[190]=i("p",null,"​",-1)),s[191]||(s[191]=i("p",null,"图示：",-1)),s[192]||(s[192]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717170705380.png",alt:"image-20210717170705380",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[193]||(s[193]=i("p",null,"解释：",-1)),s[194]||(s[194]=i("ul",null,[i("li",null,[l("Queue1：绑定的是"),i("code",null,"china.#"),l(" ，因此凡是以 "),i("code",null,"china."),l("开头的"),i("code",null,"routing key"),l(" 都会被匹配到。包括china.news和china.weather")]),i("li",null,[l("Queue2：绑定的是"),i("code",null,"#.news"),l(" ，因此凡是以 "),i("code",null,".news"),l("结尾的 "),i("code",null,"routing key"),l(" 都会被匹配。包括china.news和japan.news")])],-1)),s[195]||(s[195]=i("p",null,"案例需求：",-1)),s[196]||(s[196]=i("p",null,"实现思路如下：",-1)),s[197]||(s[197]=i("ol",null,[i("li",null,[i("p",null,"并利用@RabbitListener声明Exchange、Queue、RoutingKey")]),i("li",null,[i("p",null,"在consumer服务中，编写两个消费者方法，分别监听topic.queue1和topic.queue2")]),i("li",null,[i("p",null,"在publisher中编写测试方法，向itcast. topic发送消息")])],-1)),s[198]||(s[198]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717170829229.png",alt:"image-20210717170829229",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[199]||(s[199]=i("h5",{id:"_3-6-2-消息发送",tabindex:"-1"},[l("3.6.2 消息发送 "),i("a",{class:"header-anchor",href:"#_3-6-2-消息发送","aria-label":'Permalink to "3.6.2 消息发送"'},"​")],-1)),s[200]||(s[200]=i("p",null,"在publisher服务的SpringAmqpTest类中添加测试方法：",-1)),s[201]||(s[201]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * topicExchange")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSendTopicExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 交换机名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String exchangeName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.topic"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "喜报！孙悟空大战哥斯拉，胜!"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(exchangeName, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"china.news"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[202]||(s[202]=i("h5",{id:"_3-6-3-消息接收",tabindex:"-1"},[l("3.6.3 消息接收 "),i("a",{class:"header-anchor",href:"#_3-6-3-消息接收","aria-label":'Permalink to "3.6.3 消息接收"'},"​")],-1)),s[203]||(s[203]=i("p",null,"在consumer服务的SpringRabbitListener中添加方法：",-1)),s[204]||(s[204]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"bindings"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"QueueBinding"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    value"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Queue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "topic.queue1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    exchange"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Exchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.topic"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"type"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExchangeTypes.TOPIC),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    key"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "china.#"')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenTopicQueue1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者接收到topic.queue1的消息：【"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"bindings"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"QueueBinding"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    value"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Queue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "topic.queue2"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    exchange"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Exchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.topic"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"type"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExchangeTypes.TOPIC),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    key"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "#.news"')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenTopicQueue2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者接收到topic.queue2的消息：【"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[205]||(s[205]=i("h5",{id:"_3-6-4-总结",tabindex:"-1"},[l("3.6.4 总结 "),i("a",{class:"header-anchor",href:"#_3-6-4-总结","aria-label":'Permalink to "3.6.4 总结"'},"​")],-1)),s[206]||(s[206]=i("p",null,"描述下Direct交换机与Topic交换机的差异？",-1)),s[207]||(s[207]=i("ul",null,[i("li",null,[l("Topic交换机接收的消息RoutingKey必须是多个单词，以 "),i("code",null,"**.**"),l(" 分割")]),i("li",null,"Topic交换机与队列绑定时的bindingKey可以指定通配符"),i("li",null,[i("code",null,"#"),l("：代表0个或多个词")]),i("li",null,[i("code",null,"*"),l("：代表1个词")])],-1)),s[208]||(s[208]=i("h4",{id:"_3-7-消息转换器",tabindex:"-1"},[l("3.7 消息转换器 "),i("a",{class:"header-anchor",href:"#_3-7-消息转换器","aria-label":'Permalink to "3.7 消息转换器"'},"​")],-1)),s[209]||(s[209]=i("p",null,"之前说过，Spring会把你发送的消息序列化为字节发送给MQ，接收消息的时候，还会把字节反序列化为Java对象。",-1)),s[210]||(s[210]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20200525170410401.png",alt:"image-20200525170410401",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[211]||(s[211]=i("p",null,"只不过，默认情况下Spring采用的序列化方式是JDK序列化。众所周知，JDK序列化存在下列问题：",-1)),s[212]||(s[212]=i("ul",null,[i("li",null,"数据体积过大"),i("li",null,"有安全漏洞"),i("li",null,"可读性差")],-1)),s[213]||(s[213]=i("p",null,"我们来测试一下。",-1)),s[214]||(s[214]=i("h5",{id:"_3-7-1-测试默认转换器",tabindex:"-1"},[l("3.7.1 测试默认转换器 "),i("a",{class:"header-anchor",href:"#_3-7-1-测试默认转换器","aria-label":'Permalink to "3.7.1 测试默认转换器"'},"​")],-1)),s[215]||(s[215]=i("p",null,"我们修改消息发送的代码，发送一个Map对象：",-1)),s[216]||(s[216]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSendMap"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws InterruptedException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 准备消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> msg "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    msg."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Jack"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    msg."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"age"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"21"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"simple.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", msg);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[217]||(s[217]=i("p",null,"停止consumer服务",-1)),s[218]||(s[218]=i("p",null,"发送消息后查看控制台：",-1)),s[219]||(s[219]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210422232835363.png",alt:"image-20210422232835363",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[220]||(s[220]=i("h5",{id:"_3-7-2-配置json转换器",tabindex:"-1"},[l("3.7.2 配置JSON转换器 "),i("a",{class:"header-anchor",href:"#_3-7-2-配置json转换器","aria-label":'Permalink to "3.7.2 配置JSON转换器"'},"​")],-1)),s[221]||(s[221]=i("p",null,"显然，JDK序列化方式并不合适。我们希望消息体的体积更小、可读性更高，因此可以使用JSON方式来做序列化和反序列化。",-1)),s[222]||(s[222]=i("p",null,"在publisher和consumer两个服务中都引入依赖：",-1)),s[223]||(s[223]=i("div",{class:"language-xml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"xml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.fasterxml.jackson.dataformat</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">jackson-dataformat-xml</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">2.9.10</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[224]||(s[224]=i("p",null,"配置消息转换器。",-1)),s[225]||(s[225]=i("p",null,"在启动类中添加一个Bean即可：",-1)),s[226]||(s[226]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MessageConverter "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"jsonMessageConverter"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Jackson2JsonMessageConverter"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[227]||(s[227]=i("hr",null,null,-1)),s[228]||(s[228]=i("div",{id:"section1"},null,-1)),s[229]||(s[229]=i("h2",{id:"rabbitmq部署指南",tabindex:"-1"},[l("RabbitMQ部署指南 "),i("a",{class:"header-anchor",href:"#rabbitmq部署指南","aria-label":'Permalink to "RabbitMQ部署指南"'},"​")],-1)),s[230]||(s[230]=i("hr",null,null,-1)),s[231]||(s[231]=i("h3",{id:"_1-单机部署",tabindex:"-1"},[l("1. 单机部署 "),i("a",{class:"header-anchor",href:"#_1-单机部署","aria-label":'Permalink to "1. 单机部署"'},"​")],-1)),s[232]||(s[232]=i("p",null,"我们在Centos7虚拟机中使用Docker来安装。",-1)),s[233]||(s[233]=i("h4",{id:"_1-1-下载镜像",tabindex:"-1"},[l("1.1 下载镜像 "),i("a",{class:"header-anchor",href:"#_1-1-下载镜像","aria-label":'Permalink to "1.1 下载镜像"'},"​")],-1)),s[234]||(s[234]=i("p",null,"方式一：在线拉取",-1)),s[235]||(s[235]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," pull"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq:3.8-management")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[236]||(s[236]=i("p",null,"方式二：从本地加载",-1)),s[237]||(s[237]=i("p",null,"在课前资料已经提供了镜像包：",-1)),s[238]||(s[238]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210423191210349.png",alt:"image-20210423191210349",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[239]||(s[239]=i("p",null,"上传到虚拟机中后，使用命令加载镜像即可：",-1)),s[240]||(s[240]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," load"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq.tar")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[241]||(s[241]=i("h4",{id:"_1-2-安装mq",tabindex:"-1"},[l("1.2 安装MQ "),i("a",{class:"header-anchor",href:"#_1-2-安装mq","aria-label":'Permalink to "1.2 安装MQ"'},"​")],-1)),s[242]||(s[242]=i("p",null,"执行下面的命令来运行MQ容器：",-1)),s[243]||(s[243]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," RABBITMQ_DEFAULT_USER=itcast"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," RABBITMQ_DEFAULT_PASS="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -v"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-plugins:/plugins"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --name"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --hostname"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 15672:15672"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 5672:5672"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq:3.8-management")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[244]||(s[244]=i("hr",null,null,-1)),s[245]||(s[245]=i("h3",{id:"_2-安装delayexchange插件",tabindex:"-1"},[l("2. 安装DelayExchange插件 "),i("a",{class:"header-anchor",href:"#_2-安装delayexchange插件","aria-label":'Permalink to "2. 安装DelayExchange插件"'},"​")],-1)),s[246]||(s[246]=i("p",null,[l("官方的安装指南地址为："),i("a",{href:"https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq",target:"_blank",rel:"noreferrer"},"https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq")],-1)),s[247]||(s[247]=i("p",null,"上述文档是基于linux原生安装RabbitMQ，然后安装插件。",-1)),s[248]||(s[248]=i("p",null,"因为我们之前是基于Docker安装RabbitMQ，所以下面我们会讲解基于Docker来安装RabbitMQ插件。",-1)),s[249]||(s[249]=i("h4",{id:"_2-1-下载插件",tabindex:"-1"},[l("2.1 下载插件 "),i("a",{class:"header-anchor",href:"#_2-1-下载插件","aria-label":'Permalink to "2.1 下载插件"'},"​")],-1)),s[250]||(s[250]=i("p",null,[l("RabbitMQ有一个官方的插件社区，地址为："),i("a",{href:"https://www.rabbitmq.com/community-plugins.html",target:"_blank",rel:"noreferrer"},"https://www.rabbitmq.com/community-plugins.html")],-1)),s[251]||(s[251]=i("p",null,"其中包含各种各样的插件，包括我们要使用的DelayExchange插件：",-1)),s[252]||(s[252]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210713104511055.png",alt:"image-20210713104511055",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[253]||(s[253]=i("p",null,[l("大家可以去对应的GitHub页面下载3.8.9版本的插件，地址为"),i("a",{href:"https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/tag/3.8.9%E8%BF%99%E4%B8%AA%E5%AF%B9%E5%BA%94RabbitMQ%E7%9A%843.8.5%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E3%80%82",target:"_blank",rel:"noreferrer"},"https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/tag/3.8.9这个对应RabbitMQ的3.8.5以上版本。")],-1)),s[254]||(s[254]=i("p",null,"课前资料也提供了下载好的插件：",-1)),s[255]||(s[255]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210713104808909.png",alt:"image-20210713104808909",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[256]||(s[256]=i("h4",{id:"_2-2-上传插件",tabindex:"-1"},[l("2.2 上传插件 "),i("a",{class:"header-anchor",href:"#_2-2-上传插件","aria-label":'Permalink to "2.2 上传插件"'},"​")],-1)),s[257]||(s[257]=i("p",null,"因为我们是基于Docker安装，所以需要先查看RabbitMQ的插件目录对应的数据卷。如果不是基于Docker的同学，请参考第一章部分，重新创建Docker容器。",-1)),s[258]||(s[258]=i("p",null,[l("我们之前设定的RabbitMQ的数据卷名称为"),i("code",null,"mq-plugins"),l("，所以我们使用下面命令查看数据卷：")],-1)),s[259]||(s[259]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," volume"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," inspect"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-plugins")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[260]||(s[260]=i("p",null,"可以得到下面结果：",-1)),s[261]||(s[261]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210713105135701.png",alt:"image-20210713105135701",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[262]||(s[262]=i("p",null,"接下来，将插件上传到这个目录即可：",-1)),s[263]||(s[263]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210713105339785.png",alt:"image-20210713105339785",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[264]||(s[264]=i("h4",{id:"_2-3-安装插件",tabindex:"-1"},[l("2.3 安装插件 "),i("a",{class:"header-anchor",href:"#_2-3-安装插件","aria-label":'Permalink to "2.3 安装插件"'},"​")],-1)),s[265]||(s[265]=i("p",null,[l("最后就是安装了，需要进入MQ容器内部来执行安装。我的容器名为"),i("code",null,"mq"),l("，所以执行下面命令：")],-1)),s[266]||(s[266]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," exec"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -it"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," bash")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[267]||(s[267]=i("p",null,[l("执行时，请将其中的 "),i("code",null,"-it"),l(" 后面的"),i("code",null,"mq"),l("替换为你自己的容器名.")],-1)),s[268]||(s[268]=i("p",null,"进入容器内部后，执行下面命令开启插件：",-1)),s[269]||(s[269]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmq-plugins"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," enable"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq_delayed_message_exchange")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[270]||(s[270]=i("p",null,"结果如下：",-1)),s[271]||(s[271]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210713105829435.png",alt:"image-20210713105829435",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[272]||(s[272]=i("hr",null,null,-1)),s[273]||(s[273]=i("h3",{id:"_3-集群部署",tabindex:"-1"},[l("3. 集群部署 "),i("a",{class:"header-anchor",href:"#_3-集群部署","aria-label":'Permalink to "3. 集群部署"'},"​")],-1)),s[274]||(s[274]=i("p",null,"接下来，我们看看如何安装RabbitMQ的集群。",-1)),s[275]||(s[275]=i("h4",{id:"_3-1-集群分类",tabindex:"-1"},[l("3.1 集群分类 "),i("a",{class:"header-anchor",href:"#_3-1-集群分类","aria-label":'Permalink to "3.1 集群分类"'},"​")],-1)),s[276]||(s[276]=i("p",null,"在RabbitMQ的官方文档中，讲述了两种集群的配置方式：",-1)),s[277]||(s[277]=i("ul",null,[i("li",null,"普通模式：普通模式集群不进行数据同步，每个MQ都有自己的队列、数据信息（其它元数据信息如交换机等会同步）。例如我们有2个MQ：mq1，和mq2，如果你的消息在mq1，而你连接到了mq2，那么mq2会去mq1拉取消息，然后返回给你。如果mq1宕机，消息就会丢失。"),i("li",null,"镜像模式：与普通模式不同，队列会在各个mq的镜像节点之间同步，因此你连接到任何一个镜像节点，均可获取到消息。而且如果一个节点宕机，并不会导致数据丢失。不过，这种方式增加了数据同步的带宽消耗。")],-1)),s[278]||(s[278]=i("p",null,"我们先来看普通模式集群，我们的计划部署3节点的mq集群：",-1)),s[279]||(s[279]=i("table",null,[i("thead",null,[i("tr",null,[i("th",null,"主机名"),i("th",null,"控制台端口"),i("th",null,"amqp通信端口")])]),i("tbody",null,[i("tr",null,[i("td",null,"mq1"),i("td",null,[i("code",null,"8081 ---> 15672")]),i("td",null,[i("code",null,"8071 ---> 5672")])]),i("tr",null,[i("td",null,"mq2"),i("td",null,[i("code",null,"8082 ---> 15672")]),i("td",null,[i("code",null,"8072 ---> 5672")])]),i("tr",null,[i("td",null,"mq3"),i("td",null,[i("code",null,"8083 ---> 15672")]),i("td",null,[i("code",null,"8073 ---> 5672")])])])],-1)),s[280]||(s[280]=i("p",null,[l("集群中的节点标示默认都是："),i("code",null,"rabbit@[hostname]"),l("，因此以上三个节点的名称分别为：")],-1)),s[281]||(s[281]=i("ul",null,[i("li",null,"rabbit@mq1"),i("li",null,"rabbit@mq2"),i("li",null,"rabbit@mq3")],-1)),s[282]||(s[282]=i("h4",{id:"_3-2-获取cookie",tabindex:"-1"},[l("3.2 获取cookie "),i("a",{class:"header-anchor",href:"#_3-2-获取cookie","aria-label":'Permalink to "3.2 获取cookie"'},"​")],-1)),s[283]||(s[283]=i("p",null,"RabbitMQ底层依赖于Erlang，而Erlang虚拟机就是一个面向分布式的语言，默认就支持集群模式。集群模式中的每个RabbitMQ 节点使用 cookie 来确定它们是否被允许相互通信。",-1)),s[284]||(s[284]=i("p",null,[l("要使两个节点能够通信，它们必须具有相同的共享秘密，称为"),i("strong",null,"Erlang cookie"),l("。cookie 只是一串最多 255 个字符的字母数字字符。")],-1)),s[285]||(s[285]=i("p",null,[l("每个集群节点必须具有"),i("strong",null,"相同的 cookie"),l("。实例之间也需要它来相互通信。")],-1)),s[286]||(s[286]=i("p",null,"我们先在之前启动的mq容器中获取一个cookie值，作为集群的cookie。执行下面的命令：",-1)),s[287]||(s[287]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," exec"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -it"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cat"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /var/lib/rabbitmq/.erlang.cookie")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[288]||(s[288]=i("p",null,"可以看到cookie值如下：",-1)),s[289]||(s[289]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"FXZMCVGLBIXZCDEMMVZQ")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[290]||(s[290]=i("p",null,"接下来，停止并删除当前的mq容器，我们重新搭建集群。",-1)),s[291]||(s[291]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rm"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -f"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[292]||(s[292]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717212345165.png",alt:"image-20210717212345165",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[293]||(s[293]=i("h4",{id:"_3-3-准备集群配置",tabindex:"-1"},[l("3.3 准备集群配置 "),i("a",{class:"header-anchor",href:"#_3-3-准备集群配置","aria-label":'Permalink to "3.3 准备集群配置"'},"​")],-1)),s[294]||(s[294]=i("p",null,"在/tmp目录新建一个配置文件 rabbitmq.conf：",-1)),s[295]||(s[295]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建文件")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"touch"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[296]||(s[296]=i("p",null,"文件内容如下：",-1)),s[297]||(s[297]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"loopback_users."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"guest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = false")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"listeners.tcp."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"default"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = 5672")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cluster_formation."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"peer_discovery_backend"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = rabbit_peer_discovery_classic_config")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cluster_formation.classic_config.nodes."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = rabbit@mq1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cluster_formation.classic_config.nodes."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = rabbit@mq2")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cluster_formation.classic_config.nodes."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"3"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = rabbit@mq3")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[298]||(s[298]=i("p",null,"再创建一个文件，记录cookie",-1)),s[299]||(s[299]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建cookie文件")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"touch"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 写入cookie")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"echo"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "FXZMCVGLBIXZCDEMMVZQ"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," >"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 修改cookie文件的权限")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"chmod"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 600"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[300]||(s[300]=i("p",null,"准备三个目录,mq1、mq2、mq3：",-1)),s[301]||(s[301]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mkdir"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq2"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq3")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[302]||(s[302]=i("p",null,"然后拷贝rabbitmq.conf、cookie文件到mq1、mq2、mq3：",-1)),s[303]||(s[303]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 进入/tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 拷贝")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq2")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq3")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq2")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq3")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[304]||(s[304]=i("h4",{id:"_3-4-启动集群",tabindex:"-1"},[l("3.4 启动集群 "),i("a",{class:"header-anchor",href:"#_3-4-启动集群","aria-label":'Permalink to "3.4 启动集群"'},"​")],-1)),s[305]||(s[305]=i("p",null,"创建一个网络：",-1)),s[306]||(s[306]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," network"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," create"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-net")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[307]||(s[307]=i("p",null,"docker volume create",-1)),s[308]||(s[308]=i("p",null,"运行命令",-1)),s[309]||(s[309]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --net"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-net"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/mq1/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_USER=itcast"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_PASS="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--name "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq1"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--hostname "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq1"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8071:5672"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8081:15672"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rabbitmq:3.8-management")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[310]||(s[310]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --net"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-net"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/mq2/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_USER=itcast"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_PASS="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--name "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq2"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--hostname "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq2"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8072:5672"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8082:15672"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rabbitmq:3.8-management")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[311]||(s[311]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --net"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-net"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/mq3/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_USER=itcast"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_PASS="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--name "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq3"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--hostname "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq3"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8073:5672"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8083:15672"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rabbitmq:3.8-management")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[312]||(s[312]=i("h4",{id:"_3-5-测试",tabindex:"-1"},[l("3.5 测试 "),i("a",{class:"header-anchor",href:"#_3-5-测试","aria-label":'Permalink to "3.5 测试"'},"​")],-1)),s[313]||(s[313]=i("p",null,"在mq1这个节点上添加一个队列：",-1)),s[314]||(s[314]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717222833196.png",alt:"image-20210717222833196",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[315]||(s[315]=i("p",null,"如图，在mq2和mq3两个控制台也都能看到：",-1)),s[316]||(s[316]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717223057902.png",alt:"image-20210717223057902",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[317]||(s[317]=i("h5",{id:"_3-5-1-数据共享测试",tabindex:"-1"},[l("3.5.1 数据共享测试 "),i("a",{class:"header-anchor",href:"#_3-5-1-数据共享测试","aria-label":'Permalink to "3.5.1 数据共享测试"'},"​")],-1)),s[318]||(s[318]=i("p",null,"点击这个队列，进入管理页面：",-1)),s[319]||(s[319]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717223421750.png",alt:"image-20210717223421750",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[320]||(s[320]=i("p",null,"然后利用控制台发送一条消息到这个队列：",-1)),s[321]||(s[321]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717223320238.png",alt:"image-20210717223320238",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[322]||(s[322]=i("p",null,"结果在mq2、mq3上都能看到这条消息：",-1)),s[323]||(s[323]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717223603628.png",alt:"image-20210717223603628",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[324]||(s[324]=i("h5",{id:"_3-5-2-可用性测试",tabindex:"-1"},[l("3.5.2 可用性测试 "),i("a",{class:"header-anchor",href:"#_3-5-2-可用性测试","aria-label":'Permalink to "3.5.2 可用性测试"'},"​")],-1)),s[325]||(s[325]=i("p",null,"我们让其中一台节点mq1宕机：",-1)),s[326]||(s[326]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[327]||(s[327]=i("p",null,"然后登录mq2或mq3的控制台，发现simple.queue也不可用了：",-1)),s[328]||(s[328]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717223800203.png",alt:"image-20210717223800203",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[329]||(s[329]=i("p",null,"说明数据并没有拷贝到mq2和mq3。",-1)),s[330]||(s[330]=i("hr",null,null,-1)),s[331]||(s[331]=i("h3",{id:"_4-镜像模式",tabindex:"-1"},[l("4. 镜像模式 "),i("a",{class:"header-anchor",href:"#_4-镜像模式","aria-label":'Permalink to "4. 镜像模式"'},"​")],-1)),s[332]||(s[332]=i("p",null,"在刚刚的案例中，一旦创建队列的主机宕机，队列就会不可用。不具备高可用能力。如果要解决这个问题，必须使用官方提供的镜像集群方案。",-1)),s[333]||(s[333]=i("p",null,[l("官方文档地址："),i("a",{href:"https://www.rabbitmq.com/ha.html",target:"_blank",rel:"noreferrer"},"https://www.rabbitmq.com/ha.html")],-1)),s[334]||(s[334]=i("h4",{id:"_4-1-镜像模式的特征",tabindex:"-1"},[l("4.1 镜像模式的特征 "),i("a",{class:"header-anchor",href:"#_4-1-镜像模式的特征","aria-label":'Permalink to "4.1 镜像模式的特征"'},"​")],-1)),s[335]||(s[335]=i("p",null,[l("默认情况下，队列只保存在创建该队列的节点上。而镜像模式下，创建队列的节点被称为该队列的"),i("strong",null,"主节点"),l("，队列还会拷贝到集群中的其它节点，也叫做该队列的"),i("strong",null,"镜像"),l("节点。")],-1)),s[336]||(s[336]=i("p",null,[l("但是，不同队列可以在集群中的任意节点上创建，因此不同队列的主节点可以不同。甚至，"),i("strong",null,"一个队列的主节点可能是另一个队列的镜像节点"),l("。")],-1)),s[337]||(s[337]=i("p",null,[l("用户发送给队列的一切请求，例如发送消息、消息回执默认都会在主节点完成，如果是从节点接收到请求，也会路由到主节点去完成。"),i("strong",null,"镜像节点仅仅起到备份数据作用"),l("。")],-1)),s[338]||(s[338]=i("p",null,"当主节点接收到消费者的ACK时，所有镜像都会删除节点中的数据。",-1)),s[339]||(s[339]=i("p",null,"总结如下：",-1)),s[340]||(s[340]=i("ul",null,[i("li",null,"镜像队列结构是一主多从（从就是镜像）"),i("li",null,"所有操作都是主节点完成，然后同步给镜像节点"),i("li",null,"主宕机后，镜像节点会替代成新的主（如果在主从同步完成前，主就已经宕机，可能出现数据丢失）"),i("li",null,"不具备负载均衡功能，因为所有操作都会有主节点完成（但是不同队列，其主节点可以不同，可以利用这个提高吞吐量）")],-1)),s[341]||(s[341]=i("h4",{id:"_4-2-镜像模式的配置",tabindex:"-1"},[l("4.2 镜像模式的配置 "),i("a",{class:"header-anchor",href:"#_4-2-镜像模式的配置","aria-label":'Permalink to "4.2 镜像模式的配置"'},"​")],-1)),s[342]||(s[342]=i("p",null,"镜像模式的配置有3种模式：",-1)),s[343]||(s[343]=i("table",null,[i("thead",null,[i("tr",null,[i("th",{style:{"text-align":"left"}},"ha-mode"),i("th",{style:{"text-align":"left"}},"ha-params"),i("th",{style:{"text-align":"left"}},"效果")])]),i("tbody",null,[i("tr",null,[i("td",{style:{"text-align":"left"}},"准确模式exactly"),i("td",{style:{"text-align":"left"}},"队列的副本量count"),i("td",{style:{"text-align":"left"}},"集群中队列副本（主服务器和镜像服务器之和）的数量。count如果为1意味着单个副本：即队列主节点。count值为2表示2个副本：1个队列主和1个队列镜像。换句话说：count = 镜像数量 + 1。如果群集中的节点数少于count，则该队列将镜像到所有节点。如果有集群总数大于count+1，并且包含镜像的节点出现故障，则将在另一个节点上创建一个新的镜像。")]),i("tr",null,[i("td",{style:{"text-align":"left"}},"all"),i("td",{style:{"text-align":"left"}},"(none)"),i("td",{style:{"text-align":"left"}},"队列在群集中的所有节点之间进行镜像。队列将镜像到任何新加入的节点。镜像到所有节点将对所有群集节点施加额外的压力，包括网络I / O，磁盘I / O和磁盘空间使用情况。推荐使用exactly，设置副本数为（N / 2 +1）。")]),i("tr",null,[i("td",{style:{"text-align":"left"}},"nodes"),i("td",{style:{"text-align":"left"}},[i("em",null,"node names")]),i("td",{style:{"text-align":"left"}},"指定队列创建到哪些节点，如果指定的节点全部不存在，则会出现异常。如果指定的节点在集群中存在，但是暂时不可用，会创建节点到当前客户端连接到的节点。")])])],-1)),s[344]||(s[344]=i("p",null,"这里我们以rabbitmqctl命令作为案例来讲解配置语法。",-1)),s[345]||(s[345]=i("p",null,"语法示例：",-1)),s[346]||(s[346]=i("h5",{id:"_4-2-1-exactly模式",tabindex:"-1"},[l("4.2.1 exactly模式 "),i("a",{class:"header-anchor",href:"#_4-2-1-exactly模式","aria-label":'Permalink to "4.2.1 exactly模式"'},"​")],-1)),s[347]||(s[347]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," set_policy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ha-two"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "^two\\."'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},` '{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'`)])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[348]||(s[348]=i("ul",null,[i("li",null,[i("code",null,"rabbitmqctl set_policy"),l("：固定写法")]),i("li",null,[i("code",null,"ha-two"),l("：策略名称，自定义")]),i("li",null,[i("code",null,'"^two\\."'),l("：匹配队列的正则表达式，符合命名规则的队列才生效，这里是任何以"),i("code",null,"two."),l("开头的队列名称")]),i("li",null,[i("code",null,`'{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'`),l(": 策略内容 "),i("ul",null,[i("li",null,[i("code",null,'"ha-mode":"exactly"'),l("：策略模式，此处是exactly模式，指定副本数量")]),i("li",null,[i("code",null,'"ha-params":2'),l("：策略参数，这里是2，就是副本数量为2，1主1镜像")]),i("li",null,[i("code",null,'"ha-sync-mode":"automatic"'),l("：同步策略，默认是manual，即新加入的镜像节点不会同步旧的消息。如果设置为automatic，则新加入的镜像节点会把主节点中所有消息都同步，会带来额外的网络开销")])])])],-1)),s[349]||(s[349]=i("h5",{id:"_4-2-2-all模式",tabindex:"-1"},[l("4.2.2 all模式 "),i("a",{class:"header-anchor",href:"#_4-2-2-all模式","aria-label":'Permalink to "4.2.2 all模式"'},"​")],-1)),s[350]||(s[350]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," set_policy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ha-all"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "^all\\."'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},` '{"ha-mode":"all"}'`)])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[351]||(s[351]=i("ul",null,[i("li",null,[i("code",null,"ha-all"),l("：策略名称，自定义")]),i("li",null,[i("code",null,'"^all\\."'),l("：匹配所有以"),i("code",null,"all."),l("开头的队列名")]),i("li",null,[i("code",null,`'{"ha-mode":"all"}'`),l("：策略内容 "),i("ul",null,[i("li",null,[i("code",null,'"ha-mode":"all"'),l("：策略模式，此处是all模式，即所有节点都会称为镜像节点")])])])],-1)),s[352]||(s[352]=i("h5",{id:"_4-2-3-nodes模式",tabindex:"-1"},[l("4.2.3 nodes模式 "),i("a",{class:"header-anchor",href:"#_4-2-3-nodes模式","aria-label":'Permalink to "4.2.3 nodes模式"'},"​")],-1)),s[353]||(s[353]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," set_policy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ha-nodes"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "^nodes\\."'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},` '{"ha-mode":"nodes","ha-params":["rabbit@nodeA", "rabbit@nodeB"]}'`)])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[354]||(s[354]=i("ul",null,[i("li",null,[i("code",null,"rabbitmqctl set_policy"),l("：固定写法")]),i("li",null,[i("code",null,"ha-nodes"),l("：策略名称，自定义")]),i("li",null,[i("code",null,'"^nodes\\."'),l("：匹配队列的正则表达式，符合命名规则的队列才生效，这里是任何以"),i("code",null,"nodes."),l("开头的队列名称")]),i("li",null,[i("code",null,`'{"ha-mode":"nodes","ha-params":["rabbit@nodeA", "rabbit@nodeB"]}'`),l(": 策略内容 "),i("ul",null,[i("li",null,[i("code",null,'"ha-mode":"nodes"'),l("：策略模式，此处是nodes模式")]),i("li",null,[i("code",null,'"ha-params":["rabbit@mq1", "rabbit@mq2"]'),l("：策略参数，这里指定副本所在节点名称")])])])],-1)),s[355]||(s[355]=i("h4",{id:"_4-3-测试",tabindex:"-1"},[l("4.3 测试 "),i("a",{class:"header-anchor",href:"#_4-3-测试","aria-label":'Permalink to "4.3 测试"'},"​")],-1)),s[356]||(s[356]=i("p",null,"我们使用exactly模式的镜像，因为集群节点数量为3，因此镜像数量就设置为2.",-1)),s[357]||(s[357]=i("p",null,"运行下面的命令：",-1)),s[358]||(s[358]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," exec"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -it"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmqctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," set_policy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ha-two"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "^two\\."'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},` '{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'`)])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[359]||(s[359]=i("p",null,"下面，我们创建一个新的队列：",-1)),s[360]||(s[360]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717231751411.png",alt:"image-20210717231751411",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[361]||(s[361]=i("p",null,"在任意一个mq控制台查看队列：",-1)),s[362]||(s[362]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717231829505.png",alt:"image-20210717231829505",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[363]||(s[363]=i("h5",{id:"_4-3-1-测试数据共享",tabindex:"-1"},[l("4.3.1 测试数据共享 "),i("a",{class:"header-anchor",href:"#_4-3-1-测试数据共享","aria-label":'Permalink to "4.3.1 测试数据共享"'},"​")],-1)),s[364]||(s[364]=i("p",null,"给two.queue发送一条消息：",-1)),s[365]||(s[365]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717231958996.png",alt:"image-20210717231958996",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[366]||(s[366]=i("p",null,"然后在mq1、mq2、mq3的任意控制台查看消息：",-1)),s[367]||(s[367]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717232108584.png",alt:"image-20210717232108584",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[368]||(s[368]=i("h5",{id:"_4-3-2-测试高可用",tabindex:"-1"},[l("4.3.2 测试高可用 "),i("a",{class:"header-anchor",href:"#_4-3-2-测试高可用","aria-label":'Permalink to "4.3.2 测试高可用"'},"​")],-1)),s[369]||(s[369]=i("p",null,"现在，我们让two.queue的主节点mq1宕机：",-1)),s[370]||(s[370]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[371]||(s[371]=i("p",null,"查看集群状态：",-1)),s[372]||(s[372]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717232257420.png",alt:"image-20210717232257420",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[373]||(s[373]=i("p",null,"查看队列状态：",-1)),s[374]||(s[374]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717232322646.png",alt:"image-20210717232322646",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[375]||(s[375]=i("p",null,"发现依然是健康的！并且其主节点切换到了rabbit@mq2上",-1)),s[376]||(s[376]=i("hr",null,null,-1)),s[377]||(s[377]=i("h3",{id:"_5-仲裁队列",tabindex:"-1"},[l("5. 仲裁队列 "),i("a",{class:"header-anchor",href:"#_5-仲裁队列","aria-label":'Permalink to "5. 仲裁队列"'},"​")],-1)),s[378]||(s[378]=i("p",null,"从RabbitMQ 3.8版本开始，引入了新的仲裁队列，他具备与镜像队里类似的功能，但使用更加方便。",-1)),s[379]||(s[379]=i("h4",{id:"_5-1-添加仲裁队列",tabindex:"-1"},[l("5.1 添加仲裁队列 "),i("a",{class:"header-anchor",href:"#_5-1-添加仲裁队列","aria-label":'Permalink to "5.1 添加仲裁队列"'},"​")],-1)),s[380]||(s[380]=i("p",null,"在任意控制台添加一个队列，一定要选择队列类型为Quorum类型。",-1)),s[381]||(s[381]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717234329640.png",alt:"image-20210717234329640",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[382]||(s[382]=i("p",null,"在任意控制台查看队列：",-1)),s[383]||(s[383]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717234426209.png",alt:"image-20210717234426209",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[384]||(s[384]=i("p",null,"可以看到，仲裁队列的 + 2字样。代表这个队列有2个镜像节点。",-1)),s[385]||(s[385]=i("p",null,"因为仲裁队列默认的镜像数为5。如果你的集群有7个节点，那么镜像数肯定是5；而我们集群只有3个节点，因此镜像数量就是3.",-1)),s[386]||(s[386]=i("h4",{id:"_5-2-测试",tabindex:"-1"},[l("5.2 测试 "),i("a",{class:"header-anchor",href:"#_5-2-测试","aria-label":'Permalink to "5.2 测试"'},"​")],-1)),s[387]||(s[387]=i("p",null,"可以参考对镜像集群的测试，效果是一样的。",-1)),s[388]||(s[388]=i("h4",{id:"_5-3-集群扩容",tabindex:"-1"},[l("5.3 集群扩容 "),i("a",{class:"header-anchor",href:"#_5-3-集群扩容","aria-label":'Permalink to "5.3 集群扩容"'},"​")],-1)),s[389]||(s[389]=i("h5",{id:"_5-3-1-加入集群",tabindex:"-1"},[l("5.3.1 加入集群 "),i("a",{class:"header-anchor",href:"#_5-3-1-加入集群","aria-label":'Permalink to "5.3.1 加入集群"'},"​")],-1)),s[390]||(s[390]=i("p",null,"1）启动一个新的MQ容器：",-1)),s[391]||(s[391]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --net"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-net"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_USER=itcast"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_PASS="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--name "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq4"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--hostname "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq5"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8074:15672"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8084:15672"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rabbitmq:3.8-management")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[392]||(s[392]=i("p",null,"2）进入容器控制台：",-1)),s[393]||(s[393]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," exec"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -it"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq4"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," bash")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[394]||(s[394]=i("p",null,"3）停止mq进程",-1)),s[395]||(s[395]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop_app")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[396]||(s[396]=i("p",null,"4）重置RabbitMQ中的数据：",-1)),s[397]||(s[397]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," reset")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[398]||(s[398]=i("p",null,"5）加入mq1：",-1)),s[399]||(s[399]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," join_cluster"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbit@mq1")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[400]||(s[400]=i("p",null,"6）再次启动mq进程",-1)),s[401]||(s[401]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," start_app")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[402]||(s[402]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718001909492.png",alt:"image-20210718001909492",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[403]||(s[403]=i("h5",{id:"_5-3-2-增加仲裁队列副本",tabindex:"-1"},[l("5.3.2 增加仲裁队列副本 "),i("a",{class:"header-anchor",href:"#_5-3-2-增加仲裁队列副本","aria-label":'Permalink to "5.3.2 增加仲裁队列副本"'},"​")],-1)),s[404]||(s[404]=i("p",null,"我们先查看下quorum.queue这个队列目前的副本情况，进入mq1容器：",-1)),s[405]||(s[405]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," exec"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -it"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," bash")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[406]||(s[406]=i("p",null,"执行命令：",-1)),s[407]||(s[407]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmq-queues"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," quorum_status"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "quorum.queue"')])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[408]||(s[408]=i("p",null,"结果：",-1)),s[409]||(s[409]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718002118357.png",alt:"image-20210718002118357",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[410]||(s[410]=i("p",null,"现在，我们让mq4也加入进来：",-1)),s[411]||(s[411]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmq-queues"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," add_member"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "quorum.queue"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "rabbit@mq4"')])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[412]||(s[412]=i("p",null,"结果：",-1)),s[413]||(s[413]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718002253226.png",alt:"image-20210718002253226",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[414]||(s[414]=i("p",null,"再次查看：",-1)),s[415]||(s[415]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmq-queues"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," quorum_status"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "quorum.queue"')])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[416]||(s[416]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718002342603.png",alt:"image-20210718002342603",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[417]||(s[417]=i("p",null,"查看控制台，发现quorum.queue的镜像数量也从原来的 +2 变成了 +3：",-1)),s[418]||(s[418]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718002422365.png",alt:"image-20210718002422365",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[419]||(s[419]=i("hr",null,null,-1)),s[420]||(s[420]=i("h2",{id:"服务异步通信-高级篇",tabindex:"-1"},[l("服务异步通信-高级篇 "),i("a",{class:"header-anchor",href:"#服务异步通信-高级篇","aria-label":'Permalink to "服务异步通信-高级篇"'},"​")],-1)),s[421]||(s[421]=i("p",null,"消息队列在使用过程中，面临着很多实际问题需要思考：",-1)),s[422]||(s[422]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718155003157.png",alt:"image-20210718155003157",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[423]||(s[423]=i("hr",null,null,-1)),s[424]||(s[424]=i("h3",{id:"_1-消息可靠性",tabindex:"-1"},[l("1. 消息可靠性 "),i("a",{class:"header-anchor",href:"#_1-消息可靠性","aria-label":'Permalink to "1. 消息可靠性"'},"​")],-1)),s[425]||(s[425]=i("p",null,"消息从发送，到消费者接收，会经理多个过程：",-1)),s[426]||(s[426]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718155059371.png",alt:"image-20210718155059371",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[427]||(s[427]=i("p",null,"其中的每一步都可能导致消息丢失，常见的丢失原因包括：",-1)),s[428]||(s[428]=i("ul",null,[i("li",null,[l("发送时丢失： "),i("ul",null,[i("li",null,"生产者发送的消息未送达exchange"),i("li",null,"消息到达exchange后未到达queue")])]),i("li",null,"MQ宕机，queue将消息丢失"),i("li",null,"consumer接收到消息后未消费就宕机")],-1)),s[429]||(s[429]=i("p",null,"针对这些问题，RabbitMQ分别给出了解决方案：",-1)),s[430]||(s[430]=i("ul",null,[i("li",null,"生产者确认机制"),i("li",null,"mq持久化"),i("li",null,"消费者确认机制"),i("li",null,"失败重试机制")],-1)),s[431]||(s[431]=i("p",null,"下面我们就通过案例来演示每一个步骤。",-1)),s[432]||(s[432]=i("p",null,"首先，导入课前资料提供的demo工程：",-1)),s[433]||(s[433]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718155328927.png",alt:"image-20210718155328927",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[434]||(s[434]=i("p",null,"项目结构如下：",-1)),s[435]||(s[435]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718155448734.png",alt:"image-20210718155448734",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[436]||(s[436]=i("h4",{id:"_1-1-生产者消息确认",tabindex:"-1"},[l("1.1 生产者消息确认 "),i("a",{class:"header-anchor",href:"#_1-1-生产者消息确认","aria-label":'Permalink to "1.1 生产者消息确认"'},"​")],-1)),s[437]||(s[437]=i("p",null,"RabbitMQ提供了publisher confirm机制来避免消息发送到MQ过程中丢失。这种机制必须给每个消息指定一个唯一ID。消息发送到MQ以后，会返回一个结果给发送者，表示消息是否处理成功。",-1)),s[438]||(s[438]=i("p",null,"返回结果有两种方式：",-1)),s[439]||(s[439]=i("ul",null,[i("li",null,[l("publisher-confirm，发送者确认 "),i("ul",null,[i("li",null,"消息成功投递到交换机，返回ack"),i("li",null,"消息未投递到交换机，返回nack")])]),i("li",null,[l("publisher-return，发送者回执 "),i("ul",null,[i("li",null,"消息投递到交换机了，但是没有路由到队列。返回ACK，及路由失败原因。")])])],-1)),s[440]||(s[440]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718160907166.png",alt:"image-20210718160907166",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[441]||(s[441]=i("p",null,"注意：",-1)),s[442]||(s[442]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718161707992.png",alt:"image-20210718161707992",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[443]||(s[443]=i("h5",{id:"_1-1-1-修改配置",tabindex:"-1"},[l("1.1.1 修改配置 "),i("a",{class:"header-anchor",href:"#_1-1-1-修改配置","aria-label":'Permalink to "1.1.1 修改配置"'},"​")],-1)),s[444]||(s[444]=i("p",null,"首先，修改publisher服务中的application.yml文件，添加下面的内容：",-1)),s[445]||(s[445]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    publisher-confirm-type"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"correlated")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    publisher-returns"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    template"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      mandatory"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[446]||(s[446]=i("p",null,"说明：",-1)),s[447]||(s[447]=i("ul",null,[i("li",null,[i("code",null,"publish-confirm-type"),l("：开启publisher-confirm，这里支持两种类型： "),i("ul",null,[i("li",null,[i("code",null,"simple"),l("：同步等待confirm结果，直到超时")]),i("li",null,[i("code",null,"correlated"),l("：异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback")])])]),i("li",null,[i("code",null,"publish-returns"),l("：开启publish-return功能，同样是基于callback机制，不过是定义ReturnCallback")]),i("li",null,[i("code",null,"template.mandatory"),l("：定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息")])],-1)),s[448]||(s[448]=i("h5",{id:"_1-1-2-定义return回调",tabindex:"-1"},[l("1.1.2 定义Return回调 "),i("a",{class:"header-anchor",href:"#_1-1-2-定义return回调","aria-label":'Permalink to "1.1.2 定义Return回调"'},"​")],-1)),s[449]||(s[449]=i("p",null,"每个RabbitTemplate只能配置一个ReturnCallback，因此需要在项目加载时配置：",-1)),s[450]||(s[450]=i("p",null,"修改publisher服务，添加一个：",-1)),s[451]||(s[451]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.config;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lombok.extern.slf4j.Slf4j;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.core.RabbitTemplate;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.BeansException;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.ApplicationContext;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.ApplicationContextAware;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Configuration;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Slf4j")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CommonConfig"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ApplicationContextAware"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setApplicationContext"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ApplicationContext "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"applicationContext"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeansException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取RabbitTemplate")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RabbitTemplate rabbitTemplate "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," applicationContext."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RabbitTemplate.class);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置ReturnCallback")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        rabbitTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setReturnCallback"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((message, replyCode, replyText, exchange, routingKey) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 投递失败，记录日志")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消息发送失败，应答码{}，原因{}，交换机{}，路由键{},消息{}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                     replyCode, replyText, exchange, routingKey, message."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果有业务需要，可以重发消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[452]||(s[452]=i("h5",{id:"_1-1-3-定义confirmcallback",tabindex:"-1"},[l("1.1.3 定义ConfirmCallback "),i("a",{class:"header-anchor",href:"#_1-1-3-定义confirmcallback","aria-label":'Permalink to "1.1.3 定义ConfirmCallback"'},"​")],-1)),s[453]||(s[453]=i("p",null,"ConfirmCallback可以在发送消息时指定，因为每个业务处理confirm成功或失败的逻辑不一定相同。",-1)),s[454]||(s[454]=i("p",null,"在publisher服务的cn.itcast.mq.spring.SpringAmqpTest类中，定义一个单元测试方法：",-1)),s[455]||(s[455]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSendMessage2SimpleQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws InterruptedException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.消息体")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, spring amqp!"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.全局唯一的消息ID，需要封装到CorrelationData中")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CorrelationData correlationData "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CorrelationData"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UUID."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomUUID"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.添加callback")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    correlationData."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getFuture"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addCallback"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAck"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 3.1.ack，消息成功")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消息发送成功, ID:{}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", correlationData."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 3.2.nack，消息失败")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消息发送失败, ID:{}, 原因{}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",correlationData."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getReason"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        },")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ex "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消息发送异常, ID:{}, 原因{}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",correlationData."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),ex."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessage"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    );")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.发送消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"task.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"task"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message, correlationData);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 休眠一会儿，等待ack回执")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[456]||(s[456]=i("h4",{id:"_1-2-消息持久化",tabindex:"-1"},[l("1.2 消息持久化 "),i("a",{class:"header-anchor",href:"#_1-2-消息持久化","aria-label":'Permalink to "1.2 消息持久化"'},"​")],-1)),s[457]||(s[457]=i("p",null,"生产者确认可以确保消息投递到RabbitMQ的队列中，但是消息发送到RabbitMQ以后，如果突然宕机，也可能导致消息丢失。",-1)),s[458]||(s[458]=i("p",null,"要想确保消息在RabbitMQ中安全保存，必须开启消息持久化机制。",-1)),s[459]||(s[459]=i("ul",null,[i("li",null,"交换机持久化"),i("li",null,"队列持久化"),i("li",null,"消息持久化")],-1)),s[460]||(s[460]=i("h5",{id:"_1-2-1-交换机持久化",tabindex:"-1"},[l("1.2.1 交换机持久化 "),i("a",{class:"header-anchor",href:"#_1-2-1-交换机持久化","aria-label":'Permalink to "1.2.1 交换机持久化"'},"​")],-1)),s[461]||(s[461]=i("p",null,"RabbitMQ中交换机默认是非持久化的，mq重启后就丢失。",-1)),s[462]||(s[462]=i("p",null,"SpringAMQP中可以通过代码指定交换机持久化：",-1)),s[463]||(s[463]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DirectExchange "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"simpleExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DirectExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"simple.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[464]||(s[464]=i("p",null,"事实上，默认情况下，由SpringAMQP声明的交换机都是持久化的。",-1)),s[465]||(s[465]=i("p",null,[l("可以在RabbitMQ控制台看到持久化的交换机都会带上"),i("code",null,"D"),l("的标示：")],-1)),s[466]||(s[466]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718164412450.png",alt:"image-20210718164412450",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[467]||(s[467]=i("h5",{id:"_1-2-2-队列持久化",tabindex:"-1"},[l("1.2.2 队列持久化 "),i("a",{class:"header-anchor",href:"#_1-2-2-队列持久化","aria-label":'Permalink to "1.2.2 队列持久化"'},"​")],-1)),s[468]||(s[468]=i("p",null,"RabbitMQ中队列默认是非持久化的，mq重启后就丢失。",-1)),s[469]||(s[469]=i("p",null,"SpringAMQP中可以通过代码指定交换机持久化：",-1)),s[470]||(s[470]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"simpleQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 使用QueueBuilder构建队列，durable就是持久化的")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueueBuilder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"durable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"simple.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[471]||(s[471]=i("p",null,"事实上，默认情况下，由SpringAMQP声明的队列都是持久化的。",-1)),s[472]||(s[472]=i("p",null,[l("可以在RabbitMQ控制台看到持久化的队列都会带上"),i("code",null,"D"),l("的标示：")],-1)),s[473]||(s[473]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718164729543.png",alt:"image-20210718164729543",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[474]||(s[474]=i("h5",{id:"_1-2-3-消息持久化",tabindex:"-1"},[l("1.2.3 消息持久化 "),i("a",{class:"header-anchor",href:"#_1-2-3-消息持久化","aria-label":'Permalink to "1.2.3 消息持久化"'},"​")],-1)),s[475]||(s[475]=i("p",null,"利用SpringAMQP发送消息时，可以设置消息的属性（MessageProperties），指定delivery-mode：",-1)),s[476]||(s[476]=i("ul",null,[i("li",null,"1：非持久化"),i("li",null,"2：持久化")],-1)),s[477]||(s[477]=i("p",null,"用java代码指定：",-1)),s[478]||(s[478]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718165100016.png",alt:"image-20210718165100016",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[479]||(s[479]=i("p",null,"默认情况下，SpringAMQP发出的任何消息都是持久化的，不用特意指定。",-1)),s[480]||(s[480]=i("h4",{id:"_1-3-消费者消息确认",tabindex:"-1"},[l("1.3 消费者消息确认 "),i("a",{class:"header-anchor",href:"#_1-3-消费者消息确认","aria-label":'Permalink to "1.3 消费者消息确认"'},"​")],-1)),s[481]||(s[481]=i("p",null,[l("RabbitMQ是"),i("strong",null,"阅后即焚"),l("机制，RabbitMQ确认消息被消费者消费后会立刻删除。")],-1)),s[482]||(s[482]=i("p",null,"而RabbitMQ是通过消费者回执来确认消费者是否成功处理消息的：消费者获取消息后，应该向RabbitMQ发送ACK回执，表明自己已经处理消息。",-1)),s[483]||(s[483]=i("p",null,"设想这样的场景：",-1)),s[484]||(s[484]=i("ol",null,[i("li",null,"RabbitMQ投递消息给消费者"),i("li",null,"消费者获取消息后，返回ACK给RabbitMQ"),i("li",null,"RabbitMQ删除消息"),i("li",null,"消费者宕机，消息尚未处理")],-1)),s[485]||(s[485]=i("p",null,"这样，消息就丢失了。因此消费者返回ACK的时机非常重要。",-1)),s[486]||(s[486]=i("p",null,"而SpringAMQP则允许配置三种确认模式：",-1)),s[487]||(s[487]=i("ul",null,[i("li",null,[i("p",null,"manual：手动ack，需要在业务代码结束后，调用api发送ack。")]),i("li",null,[i("p",null,"auto：自动ack，由spring监测listener代码是否出现异常，没有异常则返回ack；抛出异常则返回nack")]),i("li",null,[i("p",null,"none：关闭ack，MQ假定消费者获取消息后会成功处理，因此消息投递后立即被删除")])],-1)),s[488]||(s[488]=i("p",null,"由此可知：",-1)),s[489]||(s[489]=i("ul",null,[i("li",null,"none模式下，消息投递是不可靠的，可能丢失"),i("li",null,"auto模式类似事务机制，出现异常时返回nack，消息回滚到mq；没有异常，返回ack"),i("li",null,"manual：自己根据业务情况，判断什么时候该ack")],-1)),s[490]||(s[490]=i("p",null,"一般，我们都是使用默认的auto即可。",-1)),s[491]||(s[491]=i("h5",{id:"_1-3-1-演示none模式",tabindex:"-1"},[l("1.3.1 演示none模式 "),i("a",{class:"header-anchor",href:"#_1-3-1-演示none模式","aria-label":'Permalink to "1.3.1 演示none模式"'},"​")],-1)),s[492]||(s[492]=i("p",null,"修改consumer服务的application.yml文件，添加下面内容：",-1)),s[493]||(s[493]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    listener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      simple"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        acknowledge-mode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"none"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 关闭ack")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[494]||(s[494]=i("p",null,"修改consumer服务的SpringRabbitListener类中的方法，模拟一个消息处理异常：",-1)),s[495]||(s[495]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenSimpleQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者接收到simple.queue的消息：【{}】"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", msg);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 模拟异常")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消息处理完成！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[496]||(s[496]=i("p",null,"测试可以发现，当消息处理抛异常时，消息依然被RabbitMQ删除了。",-1)),s[497]||(s[497]=i("h5",{id:"_1-3-2-演示auto模式",tabindex:"-1"},[l("1.3.2 演示auto模式 "),i("a",{class:"header-anchor",href:"#_1-3-2-演示auto模式","aria-label":'Permalink to "1.3.2 演示auto模式"'},"​")],-1)),s[498]||(s[498]=i("p",null,"再次把确认机制修改为auto:",-1)),s[499]||(s[499]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    listener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      simple"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        acknowledge-mode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"auto"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 关闭ack")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[500]||(s[500]=i("p",null,"在异常位置打断点，再次发送消息，程序卡在断点时，可以发现此时消息状态为unack（未确定状态）：",-1)),s[501]||(s[501]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718171705383.png",alt:"image-20210718171705383",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[502]||(s[502]=i("p",null,"抛出异常后，因为Spring会自动返回nack，所以消息恢复至Ready状态，并且没有被RabbitMQ删除：",-1)),s[503]||(s[503]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718171759179.png",alt:"image-20210718171759179",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[504]||(s[504]=i("h4",{id:"_1-4-消费失败重试机制",tabindex:"-1"},[l("1.4 消费失败重试机制 "),i("a",{class:"header-anchor",href:"#_1-4-消费失败重试机制","aria-label":'Permalink to "1.4 消费失败重试机制"'},"​")],-1)),s[505]||(s[505]=i("p",null,"当消费者出现异常后，消息会不断requeue（重入队）到队列，再重新发送给消费者，然后再次异常，再次requeue，无限循环，导致mq的消息处理飙升，带来不必要的压力：",-1)),s[506]||(s[506]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718172746378.png",alt:"image-20210718172746378",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[507]||(s[507]=i("p",null,"怎么办呢？",-1)),s[508]||(s[508]=i("h5",{id:"_1-4-1-本地重试",tabindex:"-1"},[l("1.4.1 本地重试 "),i("a",{class:"header-anchor",href:"#_1-4-1-本地重试","aria-label":'Permalink to "1.4.1 本地重试"'},"​")],-1)),s[509]||(s[509]=i("p",null,"我们可以利用Spring的retry机制，在消费者出现异常时利用本地重试，而不是无限制的requeue到mq队列。",-1)),s[510]||(s[510]=i("p",null,"修改consumer服务的application.yml文件，添加内容：",-1)),s[511]||(s[511]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    listener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      simple"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        retry"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          enabled"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 开启消费者失败重试")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          initial-interval"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 初识的失败等待时长为1秒")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          multiplier"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 失败的等待时长倍数，下次等待时长 = multiplier * last-interval")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          max-attempts"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 最大重试次数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          stateless"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # true无状态；false有状态。如果业务中包含事务，这里改为false")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[512]||(s[512]=i("p",null,"重启consumer服务，重复之前的测试。可以发现：",-1)),s[513]||(s[513]=i("ul",null,[i("li",null,"在重试3次后，SpringAMQP会抛出异常AmqpRejectAndDontRequeueException，说明本地重试触发了"),i("li",null,"查看RabbitMQ控制台，发现消息被删除了，说明最后SpringAMQP返回的是ack，mq删除消息了")],-1)),s[514]||(s[514]=i("p",null,"结论：",-1)),s[515]||(s[515]=i("ul",null,[i("li",null,"开启本地重试时，消息处理过程中抛出异常，不会requeue到队列，而是在消费者本地重试"),i("li",null,"重试达到最大次数后，Spring会返回ack，消息会被丢弃")],-1)),s[516]||(s[516]=i("h5",{id:"_1-4-2-失败策略",tabindex:"-1"},[l("1.4.2 失败策略 "),i("a",{class:"header-anchor",href:"#_1-4-2-失败策略","aria-label":'Permalink to "1.4.2 失败策略"'},"​")],-1)),s[517]||(s[517]=i("p",null,"在之前的测试中，达到最大重试次数后，消息会被丢弃，这是由Spring内部机制决定的。",-1)),s[518]||(s[518]=i("p",null,"在开启重试模式后，重试次数耗尽，如果消息依然失败，则需要有MessageRecovery接口来处理，它包含三种不同的实现：",-1)),s[519]||(s[519]=i("ul",null,[i("li",null,[i("p",null,"RejectAndDontRequeueRecoverer：重试耗尽后，直接reject，丢弃消息。默认就是这种方式")]),i("li",null,[i("p",null,"ImmediateRequeueMessageRecoverer：重试耗尽后，返回nack，消息重新入队")]),i("li",null,[i("p",null,"RepublishMessageRecoverer：重试耗尽后，将失败消息投递到指定的交换机")])],-1)),s[520]||(s[520]=i("p",null,"比较优雅的一种处理方案是RepublishMessageRecoverer，失败后将消息投递到一个指定的，专门存放异常消息的队列，后续由人工集中处理。",-1)),s[521]||(s[521]=i("p",null,"1）在consumer服务中定义处理失败消息的交换机和队列",-1)),s[522]||(s[522]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DirectExchange "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorMessageExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DirectExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorBinding"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Queue errorQueue, DirectExchange errorMessageExchange){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(errorQueue)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(errorMessageExchange)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"with"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[523]||(s[523]=i("p",null,"2）定义一个RepublishMessageRecoverer，关联队列和交换机",-1)),s[524]||(s[524]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MessageRecoverer "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"republishMessageRecoverer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RabbitTemplate rabbitTemplate){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RepublishMessageRecoverer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rabbitTemplate, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[525]||(s[525]=i("p",null,"完整代码：",-1)),s[526]||(s[526]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.config;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.Binding;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.BindingBuilder;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.DirectExchange;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.Queue;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.core.RabbitTemplate;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.retry.MessageRecoverer;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.retry.RepublishMessageRecoverer;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Bean;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ErrorMessageConfig"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DirectExchange "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorMessageExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DirectExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorBinding"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Queue "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"errorQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", DirectExchange "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"errorMessageExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(errorQueue)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(errorMessageExchange)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"with"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MessageRecoverer "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"republishMessageRecoverer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RabbitTemplate "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"rabbitTemplate"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RepublishMessageRecoverer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rabbitTemplate, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[527]||(s[527]=i("h4",{id:"_1-5-总结",tabindex:"-1"},[l("1.5 总结 "),i("a",{class:"header-anchor",href:"#_1-5-总结","aria-label":'Permalink to "1.5 总结"'},"​")],-1)),s[528]||(s[528]=i("p",null,"如何确保RabbitMQ消息的可靠性？",-1)),s[529]||(s[529]=i("ul",null,[i("li",null,"开启生产者确认机制，确保生产者的消息能到达队列"),i("li",null,"开启持久化功能，确保消息未消费前在队列中不会丢失"),i("li",null,"开启消费者确认机制为auto，由spring确认消息处理成功后完成ack"),i("li",null,"开启消费者失败重试机制，并设置MessageRecoverer，多次重试失败后将消息投递到异常交换机，交由人工处理")],-1)),s[530]||(s[530]=i("hr",null,null,-1)),s[531]||(s[531]=i("h3",{id:"_2-死信交换机",tabindex:"-1"},[l("2. 死信交换机 "),i("a",{class:"header-anchor",href:"#_2-死信交换机","aria-label":'Permalink to "2. 死信交换机"'},"​")],-1)),s[532]||(s[532]=i("h4",{id:"_2-1-初识死信交换机",tabindex:"-1"},[l("2.1 初识死信交换机 "),i("a",{class:"header-anchor",href:"#_2-1-初识死信交换机","aria-label":'Permalink to "2.1 初识死信交换机"'},"​")],-1)),s[533]||(s[533]=i("h5",{id:"_2-1-1-什么是死信交换机",tabindex:"-1"},[l("2.1.1 什么是死信交换机 "),i("a",{class:"header-anchor",href:"#_2-1-1-什么是死信交换机","aria-label":'Permalink to "2.1.1 什么是死信交换机"'},"​")],-1)),s[534]||(s[534]=i("p",null,"什么是死信？",-1)),s[535]||(s[535]=i("p",null,"当一个队列中的消息满足下列情况之一时，可以成为死信（dead letter）：",-1)),s[536]||(s[536]=i("ul",null,[i("li",null,"消费者使用basic.reject或 basic.nack声明消费失败，并且消息的requeue参数设置为false"),i("li",null,"消息是一个过期消息，超时无人消费"),i("li",null,"要投递的队列消息满了，无法投递")],-1)),s[537]||(s[537]=i("p",null,[l("如果这个包含死信的队列配置了"),i("code",null,"dead-letter-exchange"),l("属性，指定了一个交换机，那么队列中的死信就会投递到这个交换机中，而这个交换机称为"),i("strong",null,"死信交换机"),l("（Dead Letter Exchange，检查DLX）。")],-1)),s[538]||(s[538]=i("p",null,"如图，一个消息被消费者拒绝了，变成了死信：",-1)),s[539]||(s[539]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718174328383.png",alt:"image-20210718174328383",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[540]||(s[540]=i("p",null,"因为simple.queue绑定了死信交换机 dl.direct，因此死信会投递给这个交换机：",-1)),s[541]||(s[541]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718174416160.png",alt:"image-20210718174416160",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[542]||(s[542]=i("p",null,"如果这个死信交换机也绑定了一个队列，则消息最终会进入这个存放死信的队列：",-1)),s[543]||(s[543]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718174506856.png",alt:"image-20210718174506856",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[544]||(s[544]=i("p",null,"另外，队列将死信投递给死信交换机时，必须知道两个信息：",-1)),s[545]||(s[545]=i("ul",null,[i("li",null,"死信交换机名称"),i("li",null,"死信交换机与死信队列绑定的RoutingKey")],-1)),s[546]||(s[546]=i("p",null,"这样才能确保投递的消息能到达死信交换机，并且正确的路由到死信队列。",-1)),s[547]||(s[547]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821073801398.png",alt:"image-20210821073801398",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[548]||(s[548]=i("h5",{id:"_2-1-2-利用死信交换机接收死信-拓展",tabindex:"-1"},[l("2.1.2.利用死信交换机接收死信（拓展） "),i("a",{class:"header-anchor",href:"#_2-1-2-利用死信交换机接收死信-拓展","aria-label":'Permalink to "2.1.2.利用死信交换机接收死信（拓展）"'},"​")],-1)),s[549]||(s[549]=i("p",null,"在失败重试策略中，默认的RejectAndDontRequeueRecoverer会在本地重试次数耗尽后，发送reject给RabbitMQ，消息变成死信，被丢弃。",-1)),s[550]||(s[550]=i("p",null,"我们可以给simple.queue添加一个死信交换机，给死信交换机绑定一个队列。这样消息变成死信后也不会丢弃，而是最终投递到死信交换机，路由到与死信交换机绑定的队列。",-1)),s[551]||(s[551]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251205151738043.png",alt:"image-20251205151738043",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[552]||(s[552]=i("p",null,"我们在consumer服务中，定义一组死信交换机、死信队列：",-1)),s[553]||(s[553]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 声明普通的 simple.queue队列，并且为其指定死信交换机：dl.direct")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"simpleQueue2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueueBuilder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"durable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"simple.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 指定队列名称，并持久化")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"deadLetterExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dl.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 指定死信交换机")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 声明死信交换机 dl.direct")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DirectExchange "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dlExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DirectExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dl.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 声明存储死信的队列 dl.queue")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dlQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dl.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 将死信队列 与 死信交换机绑定")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dlBinding"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dlQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dlExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"with"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"simple"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[554]||(s[554]=i("h5",{id:"_2-1-3-总结",tabindex:"-1"},[l("2.1.3.总结 "),i("a",{class:"header-anchor",href:"#_2-1-3-总结","aria-label":'Permalink to "2.1.3.总结"'},"​")],-1)),s[555]||(s[555]=i("p",null,"什么样的消息会成为死信？",-1)),s[556]||(s[556]=i("ul",null,[i("li",null,"消息被消费者reject或者返回nack"),i("li",null,"消息超时未消费"),i("li",null,"队列满了")],-1)),s[557]||(s[557]=i("p",null,"死信交换机的使用场景是什么？",-1)),s[558]||(s[558]=i("ul",null,[i("li",null,"如果队列绑定了死信交换机，死信会投递到死信交换机；"),i("li",null,"可以利用死信交换机收集所有消费者处理失败的消息（死信），交由人工处理，进一步提高消息队列的可靠性。")],-1)),s[559]||(s[559]=i("h4",{id:"_2-2-ttl",tabindex:"-1"},[l("2.2 TTL "),i("a",{class:"header-anchor",href:"#_2-2-ttl","aria-label":'Permalink to "2.2 TTL"'},"​")],-1)),s[560]||(s[560]=i("p",null,"一个队列中的消息如果超时未消费，则会变为死信，超时分为两种情况：",-1)),s[561]||(s[561]=i("ul",null,[i("li",null,"消息所在的队列设置了超时时间"),i("li",null,"消息本身设置了超时时间")],-1)),s[562]||(s[562]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718182643311.png",alt:"image-20210718182643311",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[563]||(s[563]=i("h5",{id:"_2-2-1-接收超时死信的死信交换机",tabindex:"-1"},[l("2.2.1 接收超时死信的死信交换机 "),i("a",{class:"header-anchor",href:"#_2-2-1-接收超时死信的死信交换机","aria-label":'Permalink to "2.2.1 接收超时死信的死信交换机"'},"​")],-1)),s[564]||(s[564]=i("p",null,"在consumer服务的SpringRabbitListener中，定义一个新的消费者，并且声明 死信交换机、死信队列：",-1)),s[565]||(s[565]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"bindings"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"QueueBinding"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    value"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Queue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "dl.ttl.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"durable"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "true"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    exchange"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Exchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "dl.ttl.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    key"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "ttl"')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenDlQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"接收到 dl.ttl.queue的延迟消息：{}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", msg);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[566]||(s[566]=i("h5",{id:"_2-2-2-声明一个队列-并且指定ttl",tabindex:"-1"},[l("2.2.2 声明一个队列，并且指定TTL "),i("a",{class:"header-anchor",href:"#_2-2-2-声明一个队列-并且指定ttl","aria-label":'Permalink to "2.2.2 声明一个队列，并且指定TTL"'},"​")],-1)),s[567]||(s[567]=i("p",null,"要给队列设置超时时间，需要在声明队列时配置x-message-ttl属性：",-1)),s[568]||(s[568]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttlQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueueBuilder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"durable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 指定队列名称，并持久化")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttl"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 设置队列的超时时间，10秒")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"deadLetterExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dl.ttl.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 指定死信交换机")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[569]||(s[569]=i("p",null,[l("注意，这个队列设定了死信交换机为"),i("code",null,"dl.ttl.direct")],-1)),s[570]||(s[570]=i("p",null,"声明交换机，将ttl与交换机绑定：",-1)),s[571]||(s[571]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DirectExchange "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttlExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DirectExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttlBinding"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttlQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttlExchange"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"with"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[572]||(s[572]=i("p",null,"发送消息，但是不要指定TTL：",-1)),s[573]||(s[573]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testTTLQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, ttl queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息ID，需要封装到CorrelationData中")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CorrelationData correlationData "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CorrelationData"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UUID."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomUUID"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message, correlationData);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 记录日志")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"发送消息成功"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[574]||(s[574]=i("p",null,"发送消息的日志：",-1)),s[575]||(s[575]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718191657478.png",alt:"image-20210718191657478",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[576]||(s[576]=i("p",null,"查看下接收消息的日志：",-1)),s[577]||(s[577]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718191738706.png",alt:"image-20210718191738706",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[578]||(s[578]=i("p",null,"因为队列的TTL值是10000ms，也就是10秒。可以看到消息发送与接收之间的时差刚好是10秒。",-1)),s[579]||(s[579]=i("h5",{id:"_2-2-3-发送消息时-设定ttl",tabindex:"-1"},[l("2.2.3 发送消息时，设定TTL "),i("a",{class:"header-anchor",href:"#_2-2-3-发送消息时-设定ttl","aria-label":'Permalink to "2.2.3 发送消息时，设定TTL"'},"​")],-1)),s[580]||(s[580]=i("p",null,"在发送消息时，也可以指定TTL：",-1)),s[581]||(s[581]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testTTLMsg"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Message message "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MessageBuilder")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"withBody"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"hello, ttl message"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBytes"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StandardCharsets.UTF_8))")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setExpiration"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"5000"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息ID，需要封装到CorrelationData中")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CorrelationData correlationData "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CorrelationData"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UUID."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomUUID"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl.direct"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message, correlationData);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"发送消息成功"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[582]||(s[582]=i("p",null,"查看发送消息日志：",-1)),s[583]||(s[583]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718191939140.png",alt:"image-20210718191939140",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[584]||(s[584]=i("p",null,"接收消息日志：",-1)),s[585]||(s[585]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718192004662.png",alt:"image-20210718192004662",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[586]||(s[586]=i("p",null,"这次，发送与接收的延迟只有5秒。说明当队列、消息都设置了TTL时，任意一个到期就会成为死信。",-1)),s[587]||(s[587]=i("h5",{id:"_2-2-4-总结",tabindex:"-1"},[l("2.2.4 总结 "),i("a",{class:"header-anchor",href:"#_2-2-4-总结","aria-label":'Permalink to "2.2.4 总结"'},"​")],-1)),s[588]||(s[588]=i("p",null,"消息超时的两种方式是？",-1)),s[589]||(s[589]=i("ul",null,[i("li",null,"给队列设置ttl属性，进入队列后超过ttl时间的消息变为死信"),i("li",null,"给消息设置ttl属性，队列接收到消息超过ttl时间后变为死信")],-1)),s[590]||(s[590]=i("p",null,"如何实现发送一个消息20秒后消费者才收到消息？",-1)),s[591]||(s[591]=i("ul",null,[i("li",null,"给消息的目标队列指定死信交换机"),i("li",null,"将消费者监听的队列绑定到死信交换机"),i("li",null,"发送消息时给消息设置超时时间为20秒")],-1)),s[592]||(s[592]=i("h4",{id:"_2-3-延迟队列",tabindex:"-1"},[l("2.3 延迟队列 "),i("a",{class:"header-anchor",href:"#_2-3-延迟队列","aria-label":'Permalink to "2.3 延迟队列"'},"​")],-1)),s[593]||(s[593]=i("p",null,"利用TTL结合死信交换机，我们实现了消息发出后，消费者延迟收到消息的效果。这种消息模式就称为延迟队列（Delay Queue）模式。",-1)),s[594]||(s[594]=i("p",null,"延迟队列的使用场景包括：",-1)),s[595]||(s[595]=i("ul",null,[i("li",null,"延迟发送短信"),i("li",null,"用户下单，如果用户在15 分钟内未支付，则自动取消"),i("li",null,"预约工作会议，20分钟后自动通知所有参会人员")],-1)),s[596]||(s[596]=i("p",null,"因为延迟队列的需求非常多，所以RabbitMQ的官方也推出了一个插件，原生支持延迟队列效果。",-1)),s[597]||(s[597]=i("p",null,[l("这个插件就是DelayExchange插件。参考RabbitMQ的插件列表页面："),i("a",{href:"https://www.rabbitmq.com/community-plugins.html",target:"_blank",rel:"noreferrer"},"https://www.rabbitmq.com/community-plugins.html")],-1)),s[598]||(s[598]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718192529342.png",alt:"image-20210718192529342",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[599]||(s[599]=i("p",null,[l("使用方式可以参考官网地址："),i("a",{href:"https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq",target:"_blank",rel:"noreferrer"},"https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq")],-1)),s[600]||(s[600]=i("h5",{id:"_2-3-1-安装delayexchange插件",tabindex:"-1"},[l("2.3.1 安装DelayExchange插件 "),i("a",{class:"header-anchor",href:"#_2-3-1-安装delayexchange插件","aria-label":'Permalink to "2.3.1 安装DelayExchange插件"'},"​")],-1)),s[601]||(s[601]=i("p",null,"参考课前资料：",-1)),s[602]||(s[602]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718193409812.png",alt:"image-20210718193409812",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[603]||(s[603]=i("h5",{id:"_2-3-2-delayexchange原理",tabindex:"-1"},[l("2.3.2 DelayExchange原理 "),i("a",{class:"header-anchor",href:"#_2-3-2-delayexchange原理","aria-label":'Permalink to "2.3.2 DelayExchange原理"'},"​")],-1)),s[604]||(s[604]=i("p",null,"DelayExchange需要将一个交换机声明为delayed类型。当我们发送消息到delayExchange时，流程如下：",-1)),s[605]||(s[605]=i("ul",null,[i("li",null,"接收消息"),i("li",null,"判断消息是否具备x-delay属性"),i("li",null,"如果有x-delay属性，说明是延迟消息，持久化到硬盘，读取x-delay值，作为延迟时间"),i("li",null,"返回routing not found结果给消息发送者"),i("li",null,"x-delay时间到期后，重新投递消息到指定队列")],-1)),s[606]||(s[606]=i("h5",{id:"_2-3-3-使用delayexchange",tabindex:"-1"},[l("2.3.3 使用DelayExchange "),i("a",{class:"header-anchor",href:"#_2-3-3-使用delayexchange","aria-label":'Permalink to "2.3.3 使用DelayExchange"'},"​")],-1)),s[607]||(s[607]=i("p",null,"插件的使用也非常简单：声明一个交换机，交换机的类型可以是任意类型，只需要设定delayed属性为true即可，然后声明队列与其绑定即可。",-1)),s[608]||(s[608]=i("h6",{id:"_1-声明delayexchange交换机",tabindex:"-1"},[l("1）声明DelayExchange交换机 "),i("a",{class:"header-anchor",href:"#_1-声明delayexchange交换机","aria-label":'Permalink to "1）声明DelayExchange交换机"'},"​")],-1)),s[609]||(s[609]=i("p",null,"基于注解方式（推荐）：",-1)),s[610]||(s[610]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718193747649.png",alt:"image-20210718193747649",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[611]||(s[611]=i("p",null,"也可以基于@Bean的方式：",-1)),s[612]||(s[612]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718193831076.png",alt:"image-20210718193831076",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[613]||(s[613]=i("h6",{id:"_2-发送消息",tabindex:"-1"},[l("2）发送消息 "),i("a",{class:"header-anchor",href:"#_2-发送消息","aria-label":'Permalink to "2）发送消息"'},"​")],-1)),s[614]||(s[614]=i("p",null,"发送消息时，一定要携带x-delay属性，指定延迟的时间：",-1)),s[615]||(s[615]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718193917009.png",alt:"image-20210718193917009",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[616]||(s[616]=i("h5",{id:"_2-3-4-总结",tabindex:"-1"},[l("2.3.4 总结 "),i("a",{class:"header-anchor",href:"#_2-3-4-总结","aria-label":'Permalink to "2.3.4 总结"'},"​")],-1)),s[617]||(s[617]=i("p",null,"延迟队列插件的使用步骤包括哪些？",-1)),s[618]||(s[618]=i("p",null,"•声明一个交换机，添加delayed属性为true",-1)),s[619]||(s[619]=i("p",null,"•发送消息时，添加x-delay头，值为超时时间",-1)),s[620]||(s[620]=i("hr",null,null,-1)),s[621]||(s[621]=i("h3",{id:"_3-惰性队列",tabindex:"-1"},[l("3. 惰性队列 "),i("a",{class:"header-anchor",href:"#_3-惰性队列","aria-label":'Permalink to "3. 惰性队列"'},"​")],-1)),s[622]||(s[622]=i("h4",{id:"_3-1-消息堆积问题",tabindex:"-1"},[l("3.1 消息堆积问题 "),i("a",{class:"header-anchor",href:"#_3-1-消息堆积问题","aria-label":'Permalink to "3.1 消息堆积问题"'},"​")],-1)),s[623]||(s[623]=i("p",null,"当生产者发送消息的速度超过了消费者处理消息的速度，就会导致队列中的消息堆积，直到队列存储消息达到上限。之后发送的消息就会成为死信，可能会被丢弃，这就是消息堆积问题。",-1)),s[624]||(s[624]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718194040498.png",alt:"image-20210718194040498",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[625]||(s[625]=i("p",null,"解决消息堆积有两种思路：",-1)),s[626]||(s[626]=i("ul",null,[i("li",null,"增加更多消费者，提高消费速度。也就是我们之前说的work queue模式"),i("li",null,"扩大队列容积，提高堆积上限")],-1)),s[627]||(s[627]=i("p",null,"要提升队列容积，把消息保存在内存中显然是不行的。",-1)),s[628]||(s[628]=i("h4",{id:"_3-2-惰性队列",tabindex:"-1"},[l("3.2 惰性队列 "),i("a",{class:"header-anchor",href:"#_3-2-惰性队列","aria-label":'Permalink to "3.2 惰性队列"'},"​")],-1)),s[629]||(s[629]=i("p",null,"从RabbitMQ的3.6.0版本开始，就增加了Lazy Queues的概念，也就是惰性队列。惰性队列的特征如下：",-1)),s[630]||(s[630]=i("ul",null,[i("li",null,"接收到消息后直接存入磁盘而非内存"),i("li",null,"消费者要消费消息时才会从磁盘中读取并加载到内存"),i("li",null,"支持数百万条的消息存储")],-1)),s[631]||(s[631]=i("h5",{id:"_3-2-1-基于命令行设置lazy-queue",tabindex:"-1"},[l("3.2.1 基于命令行设置lazy-queue "),i("a",{class:"header-anchor",href:"#_3-2-1-基于命令行设置lazy-queue","aria-label":'Permalink to "3.2.1 基于命令行设置lazy-queue"'},"​")],-1)),s[632]||(s[632]=i("p",null,"而要设置一个队列为惰性队列，只需要在声明队列时，指定x-queue-mode属性为lazy即可。可以通过命令行将一个运行中的队列修改为惰性队列：",-1)),s[633]||(s[633]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," set_policy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Lazy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "^lazy-queue$"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},` '{"queue-mode":"lazy"}'`),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --apply-to"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," queues")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[634]||(s[634]=i("p",null,"命令解读：",-1)),s[635]||(s[635]=i("ul",null,[i("li",null,[i("code",null,"rabbitmqctl"),l(" ：RabbitMQ的命令行工具")]),i("li",null,[i("code",null,"set_policy"),l(" ：添加一个策略")]),i("li",null,[i("code",null,"Lazy"),l(" ：策略名称，可以自定义")]),i("li",null,[i("code",null,'"^lazy-queue$"'),l(" ：用正则表达式匹配队列的名字")]),i("li",null,[i("code",null,`'{"queue-mode":"lazy"}'`),l(" ：设置队列模式为lazy模式")]),i("li",null,[i("code",null,"--apply-to queues "),l("：策略的作用对象，是所有的队列")])],-1)),s[636]||(s[636]=i("h5",{id:"_3-2-2-基于-bean声明lazy-queue",tabindex:"-1"},[l("3.2.2 基于@Bean声明lazy-queue "),i("a",{class:"header-anchor",href:"#_3-2-2-基于-bean声明lazy-queue","aria-label":'Permalink to "3.2.2 基于@Bean声明lazy-queue"'},"​")],-1)),s[637]||(s[637]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718194522223.png",alt:"image-20210718194522223",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[638]||(s[638]=i("h5",{id:"_3-2-3-基于-rabbitlistener声明lazyqueue",tabindex:"-1"},[l("3.2.3 基于@RabbitListener声明LazyQueue "),i("a",{class:"header-anchor",href:"#_3-2-3-基于-rabbitlistener声明lazyqueue","aria-label":'Permalink to "3.2.3 基于@RabbitListener声明LazyQueue"'},"​")],-1)),s[639]||(s[639]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718194539054.png",alt:"image-20210718194539054",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[640]||(s[640]=i("h4",{id:"_3-3-总结",tabindex:"-1"},[l("3.3 总结 "),i("a",{class:"header-anchor",href:"#_3-3-总结","aria-label":'Permalink to "3.3 总结"'},"​")],-1)),s[641]||(s[641]=i("p",null,"消息堆积问题的解决方案？",-1)),s[642]||(s[642]=i("ul",null,[i("li",null,"队列上绑定多个消费者，提高消费速度"),i("li",null,"使用惰性队列，可以再mq中保存更多消息")],-1)),s[643]||(s[643]=i("p",null,"惰性队列的优点有哪些？",-1)),s[644]||(s[644]=i("ul",null,[i("li",null,"基于磁盘存储，消息上限高"),i("li",null,"没有间歇性的page-out，性能比较稳定")],-1)),s[645]||(s[645]=i("p",null,"惰性队列的缺点有哪些？",-1)),s[646]||(s[646]=i("ul",null,[i("li",null,"基于磁盘存储，消息时效性会降低"),i("li",null,"性能受限于磁盘的IO")],-1)),s[647]||(s[647]=i("hr",null,null,-1)),s[648]||(s[648]=i("h3",{id:"_4-mq集群",tabindex:"-1"},[l("4. MQ集群 "),i("a",{class:"header-anchor",href:"#_4-mq集群","aria-label":'Permalink to "4. MQ集群"'},"​")],-1)),s[649]||(s[649]=i("h4",{id:"_4-1-集群分类",tabindex:"-1"},[l("4.1 集群分类 "),i("a",{class:"header-anchor",href:"#_4-1-集群分类","aria-label":'Permalink to "4.1 集群分类"'},"​")],-1)),s[650]||(s[650]=i("p",null,"RabbitMQ的是基于Erlang语言编写，而Erlang又是一个面向并发的语言，天然支持集群模式。RabbitMQ的集群有两种模式：",-1)),s[651]||(s[651]=i("p",null,[l("•"),i("strong",null,"普通集群"),l("：是一种分布式集群，将队列分散到集群的各个节点，从而提高整个集群的并发能力。")],-1)),s[652]||(s[652]=i("p",null,[l("•"),i("strong",null,"镜像集群"),l("：是一种主从集群，普通集群的基础上，添加了主从备份功能，提高集群的数据可用性。")],-1)),s[653]||(s[653]=i("p",null,[l("镜像集群虽然支持主从，但主从同步并不是强一致的，某些情况下可能有数据丢失的风险。因此在RabbitMQ的3.8版本以后，推出了新的功能："),i("strong",null,"仲裁队列"),l("来代替镜像集群，底层采用Raft协议确保主从的数据一致性。")],-1)),s[654]||(s[654]=i("h4",{id:"_4-2-普通集群",tabindex:"-1"},[l("4.2 普通集群 "),i("a",{class:"header-anchor",href:"#_4-2-普通集群","aria-label":'Permalink to "4.2 普通集群"'},"​")],-1)),s[655]||(s[655]=i("h5",{id:"_4-2-1-集群结构和特征",tabindex:"-1"},[l("4.2.1 集群结构和特征 "),i("a",{class:"header-anchor",href:"#_4-2-1-集群结构和特征","aria-label":'Permalink to "4.2.1 集群结构和特征"'},"​")],-1)),s[656]||(s[656]=i("p",null,"普通集群，或者叫标准集群（classic cluster），具备下列特征：",-1)),s[657]||(s[657]=i("ul",null,[i("li",null,"会在集群的各个节点间共享部分数据，包括：交换机、队列元信息。不包含队列中的消息。"),i("li",null,"当访问集群某节点时，如果队列不在该节点，会从数据所在节点传递到当前节点并返回"),i("li",null,"队列所在节点宕机，队列中的消息就会丢失")],-1)),s[658]||(s[658]=i("p",null,"结构如图：",-1)),s[659]||(s[659]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718220843323.png",alt:"image-20210718220843323",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[660]||(s[660]=i("h5",{id:"_4-2-2-部署",tabindex:"-1"},[l("4.2.2 部署 "),i("a",{class:"header-anchor",href:"#_4-2-2-部署","aria-label":'Permalink to "4.2.2 部署"'},"​")],-1)),s[661]||(s[661]=i("blockquote",null,[i("p",null,[l("参考："),i("a",{href:"#section1"},"RabbitMQ部署指南")])],-1)),s[662]||(s[662]=i("h4",{id:"_4-3-镜像集群",tabindex:"-1"},[l("4.3 镜像集群 "),i("a",{class:"header-anchor",href:"#_4-3-镜像集群","aria-label":'Permalink to "4.3 镜像集群"'},"​")],-1)),s[663]||(s[663]=i("h5",{id:"_4-3-1-集群结构和特征",tabindex:"-1"},[l("4.3.1 集群结构和特征 "),i("a",{class:"header-anchor",href:"#_4-3-1-集群结构和特征","aria-label":'Permalink to "4.3.1 集群结构和特征"'},"​")],-1)),s[664]||(s[664]=i("p",null,"镜像集群：本质是主从模式，具备下面的特征：",-1)),s[665]||(s[665]=i("ul",null,[i("li",null,"交换机、队列、队列中的消息会在各个mq的镜像节点之间同步备份。"),i("li",null,[l("创建队列的节点被称为该队列的"),i("strong",null,[l("主节点，"),i("strong",null,"备份到的其它节点叫做该队列的"),l("镜像")]),l("节点。")]),i("li",null,"一个队列的主节点可能是另一个队列的镜像节点"),i("li",null,"所有操作都是主节点完成，然后同步给镜像节点"),i("li",null,"主宕机后，镜像节点会替代成新的主")],-1)),s[666]||(s[666]=i("p",null,"结构如图：",-1)),s[667]||(s[667]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718221039542.png",alt:"image-20210718221039542",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[668]||(s[668]=i("h5",{id:"_4-3-2-部署",tabindex:"-1"},[l("4.3.2 部署 "),i("a",{class:"header-anchor",href:"#_4-3-2-部署","aria-label":'Permalink to "4.3.2 部署"'},"​")],-1)),s[669]||(s[669]=i("blockquote",null,[i("p",null,[l("参考："),i("a",{href:"#section1"},"RabbitMQ部署指南")])],-1)),s[670]||(s[670]=i("h4",{id:"_4-4-仲裁队列",tabindex:"-1"},[l("4.4 仲裁队列 "),i("a",{class:"header-anchor",href:"#_4-4-仲裁队列","aria-label":'Permalink to "4.4 仲裁队列"'},"​")],-1)),s[671]||(s[671]=i("h5",{id:"_4-4-1-集群特征",tabindex:"-1"},[l("4.4.1 集群特征 "),i("a",{class:"header-anchor",href:"#_4-4-1-集群特征","aria-label":'Permalink to "4.4.1 集群特征"'},"​")],-1)),s[672]||(s[672]=i("p",null,"仲裁队列：仲裁队列是3.8版本以后才有的新功能，用来替代镜像队列，具备下列特征：",-1)),s[673]||(s[673]=i("ul",null,[i("li",null,"与镜像队列一样，都是主从模式，支持主从数据同步"),i("li",null,"使用非常简单，没有复杂的配置"),i("li",null,"主从同步基于Raft协议，强一致")],-1)),s[674]||(s[674]=i("h5",{id:"_4-4-2-部署",tabindex:"-1"},[l("4.4.2 部署 "),i("a",{class:"header-anchor",href:"#_4-4-2-部署","aria-label":'Permalink to "4.4.2 部署"'},"​")],-1)),s[675]||(s[675]=i("blockquote",null,[i("p",null,[l("参考："),i("a",{href:"#section1"},"RabbitMQ部署指南")])],-1)),s[676]||(s[676]=i("h5",{id:"_4-4-3-java代码创建仲裁队列",tabindex:"-1"},[l("4.4.3 Java代码创建仲裁队列 "),i("a",{class:"header-anchor",href:"#_4-4-3-java代码创建仲裁队列","aria-label":'Permalink to "4.4.3 Java代码创建仲裁队列"'},"​")],-1)),s[677]||(s[677]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"quorumQueue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueueBuilder")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"durable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"quorum.queue"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 持久化")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"quorum"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 仲裁队列")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[678]||(s[678]=i("h5",{id:"_4-4-4-springamqp连接mq集群",tabindex:"-1"},[l("4.4.4 SpringAMQP连接MQ集群 "),i("a",{class:"header-anchor",href:"#_4-4-4-springamqp连接mq集群","aria-label":'Permalink to "4.4.4 SpringAMQP连接MQ集群"'},"​")],-1)),s[679]||(s[679]=i("p",null,"注意，这里用address来代替host、port方式",-1)),s[680]||(s[680]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    addresses"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.105:8071, 192.168.150.105:8072, 192.168.150.105:8073")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    username"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"itcast")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    password"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    virtual-host"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/")])])]),i("button",{class:"code-block-unfold-btn"})],-1))]),"main-header":n(()=>[t(a.$slots,"main-header")]),"main-header-after":n(()=>[t(a.$slots,"main-header-after")]),"main-nav":n(()=>[t(a.$slots,"main-nav")]),"main-content-before":n(()=>[t(a.$slots,"main-content-before")]),"main-content":n(()=>[t(a.$slots,"main-content")]),"main-content-after":n(()=>[t(a.$slots,"main-content-after")]),"main-nav-before":n(()=>[t(a.$slots,"main-nav-before")]),"main-nav-after":n(()=>[t(a.$slots,"main-nav-after")]),comment:n(()=>[t(a.$slots,"comment")]),footer:n(()=>[t(a.$slots,"footer")]),aside:n(()=>[t(a.$slots,"aside")]),"aside-custom":n(()=>[t(a.$slots,"aside-custom")]),default:n(()=>[t(a.$slots,"default")]),_:3},8,["frontmatter"])}}};export{U as default,v as usePageData};
