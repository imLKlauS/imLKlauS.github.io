import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang.9GM34vdY.js";import"./chunks/@vueuse/motion.BrTBiDBP.js";import{d as l,a as s,u as a}from"./chunks/vue-router.qltZjGpv.js";import{a1 as n,a3 as e,a4 as t,a5 as r,a6 as h,a7 as g,F as p,a2 as d,Z as k}from"./framework.CSpzLJwA.js";import"./app.DWzYFkU-.js";import"./chunks/dayjs.Dto65haK.js";import"./chunks/vue-i18n.C5QQbedb.js";import"./chunks/pinia.CKttsWmm.js";import"./chunks/nprogress.BEPa78Un.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.DXgqq_ye.js";import"./index.TQnGKZgq.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.DIveis5r.js";import"./post.CPG5nlba.js";const c=l("/posts/Microservices_Protection",async i=>JSON.parse('{"title":"微服务保护","description":"","frontmatter":{"title":"微服务保护","author":"imklaus","tags":["Spring Cloud","Sentinel"],"categories":["Java","微服务"],"date":"2025/12/8 1:29:00","outline":"deep","postTitleClass":"text-#62afe9","excerpt_type":"html","end":false},"headers":[],"relativePath":"pages/posts/Microservices_Protection.md","lastUpdated":null}'),{lazy:(i,l)=>i.name===l.name}),o={__name:"Microservices_Protection",setup(l,{expose:o}){const{data:u}=c(),E=a(),y=s(),m=Object.assign(y.meta.frontmatter||{},u.value?.frontmatter||{});E.currentRoute.value.data=u.value,k("valaxy:frontmatter",m),globalThis.$frontmatter=m;return o({frontmatter:{title:"微服务保护",author:"imklaus",tags:["Spring Cloud","Sentinel"],categories:["Java","微服务"],date:"2025/12/8 1:29:00",outline:"deep",postTitleClass:"text-#62afe9",excerpt_type:"html",end:!1}}),(l,s)=>{const a=i;return d(),n(a,{frontmatter:p(m)},{"main-content-md":e(()=>[s[0]||(s[0]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208014226027.png",alt:"image-20251208014226027",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1]||(s[1]=r("p",null,[g("参考视频："),r("a",{href:"https://www.bilibili.com/video/BV1LQ4y127n4",target:"_blank",rel:"noreferrer"},"黑马SpringCloud微服务技术栈高级篇")],-1)),s[2]||(s[2]=r("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),s[3]||(s[3]=r("p",null,[r("strong",null,"目录指引"),g("：")],-1)),s[4]||(s[4]=r("nav",{class:"table-of-contents"},[r("ul",null,[r("li",null,[r("a",{href:"#_1-初识sentinel"},"1. 初识Sentinel"),r("ul",null,[r("li",null,[r("a",{href:"#_1-1-雪崩问题及解决方案"},"1.1 雪崩问题及解决方案")]),r("li",null,[r("a",{href:"#_1-2-服务保护技术对比"},"1.2 服务保护技术对比")]),r("li",null,[r("a",{href:"#_1-3-sentinel介绍和安装"},"1.3 Sentinel介绍和安装")]),r("li",null,[r("a",{href:"#_1-4-微服务整合sentinel"},"1.4 微服务整合Sentinel")])])]),r("li",null,[r("a",{href:"#_2-流量控制"},"2. 流量控制"),r("ul",null,[r("li",null,[r("a",{href:"#_2-1-簇点链路"},"2.1 簇点链路")]),r("li",null,[r("a",{href:"#_2-2-快速入门"},"2.2 快速入门")]),r("li",null,[r("a",{href:"#_2-3-流控模式"},"2.3 流控模式")]),r("li",null,[r("a",{href:"#_2-4-流控效果"},"2.4 流控效果")]),r("li",null,[r("a",{href:"#_2-5-热点参数限流"},"2.5 热点参数限流")])])]),r("li",null,[r("a",{href:"#_3-隔离和降级"},"3. 隔离和降级"),r("ul",null,[r("li",null,[r("a",{href:"#_3-1-feignclient整合sentinel"},"3.1 FeignClient整合Sentinel")]),r("li",null,[r("a",{href:"#_3-2-线程隔离-舱壁模式"},"3.2 线程隔离（舱壁模式）")]),r("li",null,[r("a",{href:"#_3-3-熔断降级"},"3.3 熔断降级")])])]),r("li",null,[r("a",{href:"#_4-授权规则"},"4. 授权规则"),r("ul",null,[r("li",null,[r("a",{href:"#_4-1-授权规则"},"4.1 授权规则")]),r("li",null,[r("a",{href:"#_4-2-自定义异常结果"},"4.2 自定义异常结果")])])]),r("li",null,[r("a",{href:"#_5-规则持久化"},"5. 规则持久化"),r("ul",null,[r("li",null,[r("a",{href:"#_5-1-规则管理模式"},"5.1 规则管理模式")]),r("li",null,[r("a",{href:"#_5-2-实现push模式"},"5.2 实现push模式")])])])])],-1)),s[5]||(s[5]=r("h2",{id:"_1-初识sentinel",tabindex:"-1"},[g("1. 初识Sentinel "),r("a",{class:"header-anchor",href:"#_1-初识sentinel","aria-label":'Permalink to "1. 初识Sentinel"'},"​")],-1)),s[6]||(s[6]=r("h3",{id:"_1-1-雪崩问题及解决方案",tabindex:"-1"},[g("1.1 雪崩问题及解决方案 "),r("a",{class:"header-anchor",href:"#_1-1-雪崩问题及解决方案","aria-label":'Permalink to "1.1 雪崩问题及解决方案"'},"​")],-1)),s[7]||(s[7]=r("h4",{id:"_1-1-1-雪崩问题",tabindex:"-1"},[g("1.1.1 雪崩问题 "),r("a",{class:"header-anchor",href:"#_1-1-1-雪崩问题","aria-label":'Permalink to "1.1.1 雪崩问题"'},"​")],-1)),s[8]||(s[8]=r("p",null,"微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。",-1)),h(" more "),s[9]||(s[9]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1533829099748.png",alt:"1533829099748",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[10]||(s[10]=r("p",null,"如图，如果服务提供者I发生了故障，当前的应用的部分业务因为依赖于服务I，因此也会被阻塞。此时，其它不依赖于服务I的业务似乎不受影响。",-1)),s[11]||(s[11]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1533829198240.png",alt:"1533829198240",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[12]||(s[12]=r("p",null,"但是，依赖服务I的业务请求被阻塞，用户不会得到响应，则tomcat的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞：",-1)),s[13]||(s[13]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1533829307389.png",alt:"1533829307389",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[14]||(s[14]=r("p",null,"服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，那么当前服务也就不可用了。",-1)),s[15]||(s[15]=r("p",null,"那么，依赖于当前服务的其它服务随着时间的推移，最终也都会变的不可用，形成级联失败，雪崩就发生了：",-1)),s[16]||(s[16]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715172710340.png",alt:"image-20210715172710340",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[17]||(s[17]=r("h4",{id:"_1-1-2-超时处理",tabindex:"-1"},[g("1.1.2 超时处理 "),r("a",{class:"header-anchor",href:"#_1-1-2-超时处理","aria-label":'Permalink to "1.1.2 超时处理"'},"​")],-1)),s[18]||(s[18]=r("p",null,"解决雪崩问题的常见方式有四种：",-1)),s[19]||(s[19]=r("ul",null,[r("li",null,"超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待")],-1)),s[20]||(s[20]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715172820438.png",alt:"image-20210715172820438",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[21]||(s[21]=r("h4",{id:"_1-1-3-仓壁模式",tabindex:"-1"},[g("1.1.3 仓壁模式 "),r("a",{class:"header-anchor",href:"#_1-1-3-仓壁模式","aria-label":'Permalink to "1.1.3 仓壁模式"'},"​")],-1)),s[22]||(s[22]=r("p",null,"方案2：仓壁模式",-1)),s[23]||(s[23]=r("p",null,"仓壁模式来源于船舱的设计：",-1)),s[24]||(s[24]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715172946352.png",alt:"image-20210715172946352",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[25]||(s[25]=r("p",null,"船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。",-1)),s[26]||(s[26]=r("p",null,"于此类似，我们可以限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，因此也叫线程隔离。",-1)),s[27]||(s[27]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173215243.png",alt:"image-20210715173215243",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[28]||(s[28]=r("h4",{id:"_1-1-4-断路器",tabindex:"-1"},[g("1.1.4 断路器 "),r("a",{class:"header-anchor",href:"#_1-1-4-断路器","aria-label":'Permalink to "1.1.4 断路器"'},"​")],-1)),s[29]||(s[29]=r("p",null,[g("断路器模式：由"),r("strong",null,"断路器"),g("统计业务执行的异常比例，如果超出阈值则会"),r("strong",null,"熔断"),g("该业务，拦截访问该业务的一切请求。")],-1)),s[30]||(s[30]=r("p",null,"断路器会统计访问某个服务的请求数量，异常比例：",-1)),s[31]||(s[31]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173327075.png",alt:"image-20210715173327075",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[32]||(s[32]=r("p",null,"当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：",-1)),s[33]||(s[33]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173428073.png",alt:"image-20210715173428073",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[34]||(s[34]=r("h4",{id:"_1-1-5-限流",tabindex:"-1"},[g("1.1.5 限流 "),r("a",{class:"header-anchor",href:"#_1-1-5-限流","aria-label":'Permalink to "1.1.5 限流"'},"​")],-1)),s[35]||(s[35]=r("p",null,[r("strong",null,"流量控制"),g("：限制业务访问的QPS，避免服务因流量的突增而故障。")],-1)),s[36]||(s[36]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173555158.png",alt:"image-20210715173555158",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[37]||(s[37]=r("h4",{id:"_1-1-6-总结",tabindex:"-1"},[g("1.1.6 总结 "),r("a",{class:"header-anchor",href:"#_1-1-6-总结","aria-label":'Permalink to "1.1.6 总结"'},"​")],-1)),s[38]||(s[38]=r("p",null,"什么是雪崩问题？",-1)),s[39]||(s[39]=r("ul",null,[r("li",null,"微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。")],-1)),s[40]||(s[40]=r("p",null,"可以认为：",-1)),s[41]||(s[41]=r("p",null,[r("strong",null,"限流"),g("是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种"),r("strong",null,"预防"),g("措施。")],-1)),s[42]||(s[42]=r("p",null,[r("strong",null,"超时处理、线程隔离、降级熔断"),g("是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种"),r("strong",null,"补救"),g("措施。")],-1)),s[43]||(s[43]=r("h3",{id:"_1-2-服务保护技术对比",tabindex:"-1"},[g("1.2 服务保护技术对比 "),r("a",{class:"header-anchor",href:"#_1-2-服务保护技术对比","aria-label":'Permalink to "1.2 服务保护技术对比"'},"​")],-1)),s[44]||(s[44]=r("p",null,"在SpringCloud当中支持多种服务保护技术：",-1)),s[45]||(s[45]=r("ul",null,[r("li",null,[r("a",{href:"https://github.com/Netflix/Hystrix",target:"_blank",rel:"noreferrer"},"Netfix Hystrix")]),r("li",null,[r("a",{href:"https://github.com/alibaba/Sentinel",target:"_blank",rel:"noreferrer"},"Sentinel")]),r("li",null,[r("a",{href:"https://github.com/resilience4j/resilience4j",target:"_blank",rel:"noreferrer"},"Resilience4J")])],-1)),s[46]||(s[46]=r("p",null,"早期比较流行的是Hystrix框架，但目前国内实用最广泛的还是阿里巴巴的Sentinel框架，这里我们做下对比：",-1)),s[47]||(s[47]=r("table",null,[r("thead",null,[r("tr",null,[r("th"),r("th",null,[r("strong",null,"Sentinel")]),r("th",null,[r("strong",null,"Hystrix")])])]),r("tbody",null,[r("tr",null,[r("td",null,"隔离策略"),r("td",null,"信号量隔离"),r("td",null,"线程池隔离/信号量隔离")]),r("tr",null,[r("td",null,"熔断降级策略"),r("td",null,"基于慢调用比例或异常比例"),r("td",null,"基于失败比率")]),r("tr",null,[r("td",null,"实时指标实现"),r("td",null,"滑动窗口"),r("td",null,"滑动窗口（基于 RxJava）")]),r("tr",null,[r("td",null,"规则配置"),r("td",null,"支持多种数据源"),r("td",null,"支持多种数据源")]),r("tr",null,[r("td",null,"扩展性"),r("td",null,"多个扩展点"),r("td",null,"插件的形式")]),r("tr",null,[r("td",null,"基于注解的支持"),r("td",null,"支持"),r("td",null,"支持")]),r("tr",null,[r("td",null,"限流"),r("td",null,"基于 QPS，支持基于调用关系的限流"),r("td",null,"有限的支持")]),r("tr",null,[r("td",null,"流量整形"),r("td",null,"支持慢启动、匀速排队模式"),r("td",null,"不支持")]),r("tr",null,[r("td",null,"系统自适应保护"),r("td",null,"支持"),r("td",null,"不支持")]),r("tr",null,[r("td",null,"控制台"),r("td",null,"开箱即用，可配置规则、查看秒级监控、机器发现等"),r("td",null,"不完善")]),r("tr",null,[r("td",null,"常见框架的适配"),r("td",null,"Servlet、Spring Cloud、Dubbo、gRPC 等"),r("td",null,"Servlet、Spring Cloud Netflix")])])],-1)),s[48]||(s[48]=r("h3",{id:"_1-3-sentinel介绍和安装",tabindex:"-1"},[g("1.3 Sentinel介绍和安装 "),r("a",{class:"header-anchor",href:"#_1-3-sentinel介绍和安装","aria-label":'Permalink to "1.3 Sentinel介绍和安装"'},"​")],-1)),s[49]||(s[49]=r("h4",{id:"_1-3-1-初识sentinel",tabindex:"-1"},[g("1.3.1 初识Sentinel "),r("a",{class:"header-anchor",href:"#_1-3-1-初识sentinel","aria-label":'Permalink to "1.3.1 初识Sentinel"'},"​")],-1)),s[50]||(s[50]=r("p",null,[g("Sentinel是阿里巴巴开源的一款微服务流量控制组件。官网地址："),r("a",{href:"https://sentinelguard.io/zh-cn/index.html",target:"_blank",rel:"noreferrer"},"https://sentinelguard.io/zh-cn/index.html")],-1)),s[51]||(s[51]=r("p",null,"Sentinel 具有以下特征:",-1)),s[52]||(s[52]=r("ul",null,[r("li",null,[r("p",null,[r("strong",null,"丰富的应用场景"),g("：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。")])]),r("li",null,[r("p",null,[r("strong",null,"完备的实时监控"),g("：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。")])]),r("li",null,[r("p",null,[r("strong",null,"广泛的开源生态"),g("：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。")])]),r("li",null,[r("p",null,[r("strong",null,"完善的"),g(),r("strong",null,"SPI"),g(),r("strong",null,"扩展点"),g("：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。")])])],-1)),s[53]||(s[53]=r("h4",{id:"_1-3-2-安装sentinel",tabindex:"-1"},[g("1.3.2 安装Sentinel "),r("a",{class:"header-anchor",href:"#_1-3-2-安装sentinel","aria-label":'Permalink to "1.3.2 安装Sentinel"'},"​")],-1)),s[54]||(s[54]=r("p",null,"1）下载",-1)),s[55]||(s[55]=r("p",null,[g("sentinel官方提供了UI控制台，方便我们对系统做限流设置。大家可以在"),r("a",{href:"https://github.com/alibaba/Sentinel/releases",target:"_blank",rel:"noreferrer"},"GitHub"),g("下载。")],-1)),s[56]||(s[56]=r("p",null,"课前资料也提供了下载好的jar包：",-1)),s[57]||(s[57]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715174252531.png",alt:"image-20210715174252531",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[58]||(s[58]=r("p",null,"2）运行",-1)),s[59]||(s[59]=r("p",null,"将jar包放到任意非中文目录，执行命令：",-1)),s[60]||(s[60]=r("div",{class:"language-sh max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"sh"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"java"),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -jar"),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," sentinel-dashboard-1.8.1.jar")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[61]||(s[61]=r("p",null,"如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：",-1)),s[62]||(s[62]=r("table",null,[r("thead",null,[r("tr",null,[r("th",null,[r("strong",null,"配置项")]),r("th",null,[r("strong",null,"默认值")]),r("th",null,[r("strong",null,"说明")])])]),r("tbody",null,[r("tr",null,[r("td",null,"server.port"),r("td",null,"8080"),r("td",null,"服务端口")]),r("tr",null,[r("td",null,"sentinel.dashboard.auth.username"),r("td",null,"sentinel"),r("td",null,"默认用户名")]),r("tr",null,[r("td",null,"sentinel.dashboard.auth.password"),r("td",null,"sentinel"),r("td",null,"默认密码")])])],-1)),s[63]||(s[63]=r("p",null,"例如，修改端口：",-1)),s[64]||(s[64]=r("div",{class:"language-sh max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"sh"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"java"),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Dserver.port=8090"),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -jar"),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," sentinel-dashboard-1.8.1.jar")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[65]||(s[65]=r("p",null,"3）访问",-1)),s[66]||(s[66]=r("p",null,[g("访问"),r("code",null,"http://localhost:8080"),g("页面，就可以看到sentinel的控制台了：")],-1)),s[67]||(s[67]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715190827846.png",alt:"image-20210715190827846",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[68]||(s[68]=r("p",null,"需要输入账号和密码，默认都是：sentinel",-1)),s[69]||(s[69]=r("p",null,"登录后，发现一片空白，什么都没有：",-1)),s[70]||(s[70]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715191134448.png",alt:"image-20210715191134448",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[71]||(s[71]=r("p",null,"这是因为我们还没有与微服务整合。",-1)),s[72]||(s[72]=r("h3",{id:"_1-4-微服务整合sentinel",tabindex:"-1"},[g("1.4 微服务整合Sentinel "),r("a",{class:"header-anchor",href:"#_1-4-微服务整合sentinel","aria-label":'Permalink to "1.4 微服务整合Sentinel"'},"​")],-1)),s[73]||(s[73]=r("p",null,"我们在order-service中整合sentinel，并连接sentinel的控制台，步骤如下：",-1)),s[74]||(s[74]=r("p",null,"1）引入sentinel依赖",-1)),s[75]||(s[75]=r("div",{class:"language-xml max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"xml"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\x3c!--sentinel--\x3e")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.alibaba.cloud</"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-cloud-starter-alibaba-sentinel</"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[76]||(s[76]=r("p",null,"2）配置控制台",-1)),s[77]||(s[77]=r("p",null,"修改application.yaml文件，添加下面内容：",-1)),s[78]||(s[78]=r("div",{class:"language-yaml max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"yaml"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"server"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  port"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8088")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": ")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    sentinel"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      transport"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        dashboard"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"localhost:8080")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[79]||(s[79]=r("p",null,"3）访问order-service的任意端点",-1)),s[80]||(s[80]=r("p",null,[g("打开浏览器，访问"),r("code",null,"http://localhost:8088/order/101"),g("，这样才能触发sentinel的监控。")],-1)),s[81]||(s[81]=r("p",null,"然后再访问sentinel的控制台，查看效果：",-1)),s[82]||(s[82]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715191241799.png",alt:"image-20210715191241799",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[83]||(s[83]=r("h2",{id:"_2-流量控制",tabindex:"-1"},[g("2. 流量控制 "),r("a",{class:"header-anchor",href:"#_2-流量控制","aria-label":'Permalink to "2. 流量控制"'},"​")],-1)),s[84]||(s[84]=r("p",null,"雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。",-1)),s[85]||(s[85]=r("h3",{id:"_2-1-簇点链路",tabindex:"-1"},[g("2.1 簇点链路 "),r("a",{class:"header-anchor",href:"#_2-1-簇点链路","aria-label":'Permalink to "2.1 簇点链路"'},"​")],-1)),s[86]||(s[86]=r("p",null,[g("当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做"),r("strong",null,"簇点链路"),g("。簇点链路中被监控的每一个接口就是一个"),r("strong",null,"资源"),g("。")],-1)),s[87]||(s[87]=r("p",null,"默认情况下sentinel会监控SpringMVC的每一个端点（Endpoint，也就是controller中的方法），因此SpringMVC的每一个端点（Endpoint）就是调用链路中的一个资源。",-1)),s[88]||(s[88]=r("p",{orderId:""},"例如，我们刚才访问的order-service中的OrderController中的端点：/order/",-1)),s[89]||(s[89]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715191757319.png",alt:"image-20210715191757319",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[90]||(s[90]=r("p",null,"流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：",-1)),s[91]||(s[91]=r("ul",null,[r("li",null,"流控：流量控制"),r("li",null,"降级：降级熔断"),r("li",null,"热点：热点参数限流，是限流的一种"),r("li",null,"授权：请求的权限控制")],-1)),s[92]||(s[92]=r("h3",{id:"_2-2-快速入门",tabindex:"-1"},[g("2.2 快速入门 "),r("a",{class:"header-anchor",href:"#_2-2-快速入门","aria-label":'Permalink to "2.2 快速入门"'},"​")],-1)),s[93]||(s[93]=r("h4",{id:"_2-2-1-示例",tabindex:"-1"},[g("2.2.1 示例 "),r("a",{class:"header-anchor",href:"#_2-2-1-示例","aria-label":'Permalink to "2.2.1 示例"'},"​")],-1)),s[94]||(s[94]=r("p",null,"点击资源/order/{orderId}后面的流控按钮，就可以弹出表单。",-1)),s[95]||(s[95]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715191757319.png",alt:"image-20210715191757319",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[96]||(s[96]=r("p",null,"表单中可以填写限流规则，如下：",-1)),s[97]||(s[97]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715192010657.png",alt:"image-20210715192010657",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[98]||(s[98]=r("p",null,"其含义是限制 /order/{orderId}这个资源的单机QPS为1，即每秒只允许1次请求，超出的请求会被拦截并报错。",-1)),s[99]||(s[99]=r("h4",{id:"_2-2-2-练习",tabindex:"-1"},[g("2.2.2 练习 "),r("a",{class:"header-anchor",href:"#_2-2-2-练习","aria-label":'Permalink to "2.2.2 练习"'},"​")],-1)),s[100]||(s[100]=r("p",null,"需求：给 /order/{orderId}这个资源设置流控规则，QPS不能超过 5，然后测试。",-1)),s[101]||(s[101]=r("p",null,"1）首先在sentinel控制台添加限流规则",-1)),s[102]||(s[102]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715192455429.png",alt:"image-20210715192455429",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[103]||(s[103]=r("p",null,"2）利用jmeter测试",-1)),s[104]||(s[104]=r("h5",{id:"_1-安装jmeter",tabindex:"-1"},[g("1. 安装Jmeter "),r("a",{class:"header-anchor",href:"#_1-安装jmeter","aria-label":'Permalink to "1. 安装Jmeter"'},"​")],-1)),s[105]||(s[105]=r("p",null,"Jmeter依赖于JDK，所以必须确保当前计算机上已经安装了JDK，并且配置了环境变量。",-1)),s[106]||(s[106]=r("h6",{id:"_1-1-下载",tabindex:"-1"},[g("1.1 下载 "),r("a",{class:"header-anchor",href:"#_1-1-下载","aria-label":'Permalink to "1.1 下载"'},"​")],-1)),s[107]||(s[107]=r("p",null,[g("可以Apache Jmeter官网下载，地址："),r("a",{href:"http://jmeter.apache.org/download_jmeter.cgi",target:"_blank",rel:"noreferrer"},"http://jmeter.apache.org/download_jmeter.cgi")],-1)),s[108]||(s[108]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193149837.png",alt:"image-20210715193149837",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[109]||(s[109]=r("p",null,"当然，我们课前资料也提供了下载好的安装包：",-1)),s[110]||(s[110]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193224094.png",alt:"image-20210715193224094",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[111]||(s[111]=r("h6",{id:"_1-2-解压",tabindex:"-1"},[g("1.2 解压 "),r("a",{class:"header-anchor",href:"#_1-2-解压","aria-label":'Permalink to "1.2 解压"'},"​")],-1)),s[112]||(s[112]=r("p",null,"因为下载的是zip包，解压缩即可使用，目录结构如下：",-1)),s[113]||(s[113]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193334367.png",alt:"image-20210715193334367",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[114]||(s[114]=r("p",null,"其中的bin目录就是执行的脚本，其中包含启动脚本：",-1)),s[115]||(s[115]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193414601.png",alt:"image-20210715193414601",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[116]||(s[116]=r("h6",{id:"_1-3-运行",tabindex:"-1"},[g("1.3 运行 "),r("a",{class:"header-anchor",href:"#_1-3-运行","aria-label":'Permalink to "1.3 运行"'},"​")],-1)),s[117]||(s[117]=r("p",null,"双击即可运行，但是有两点注意：",-1)),s[118]||(s[118]=r("ul",null,[r("li",null,"启动速度比较慢，要耐心等待"),r("li",null,"启动后黑窗口不能关闭，否则Jmeter也跟着关闭了")],-1)),s[119]||(s[119]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193730096.png",alt:"image-20210715193730096",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[120]||(s[120]=r("h5",{id:"_2-快速入门",tabindex:"-1"},[g("2. 快速入门 "),r("a",{class:"header-anchor",href:"#_2-快速入门","aria-label":'Permalink to "2. 快速入门"'},"​")],-1)),s[121]||(s[121]=r("h6",{id:"_2-1-设置中文语言",tabindex:"-1"},[g("2.1 设置中文语言 "),r("a",{class:"header-anchor",href:"#_2-1-设置中文语言","aria-label":'Permalink to "2.1 设置中文语言"'},"​")],-1)),s[122]||(s[122]=r("p",null,"默认Jmeter的语言是英文，需要设置：",-1)),s[123]||(s[123]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193838719.png",alt:"image-20210715193838719",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[124]||(s[124]=r("p",null,"效果：",-1)),s[125]||(s[125]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193914039.png",alt:"image-20210715193914039",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[126]||(s[126]=r("blockquote",null,[r("p",null,[r("strong",null,"注意"),g("：上面的配置只能保证本次运行是中文，如果要永久中文，需要修改Jmeter的配置文件")])],-1)),s[127]||(s[127]=r("p",null,[g("打开jmeter文件夹，在bin目录中找到 "),r("strong",null,"jmeter.properties"),g("，添加下面配置：")],-1)),s[128]||(s[128]=r("div",{class:"language-properties max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"properties"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"language"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=zh_CN")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[129]||(s[129]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715194137982.png",alt:"image-20210715194137982",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[130]||(s[130]=r("blockquote",null,[r("p",null,"注意：前面不要出现#，#代表注释，另外这里是下划线，不是中划线")],-1)),s[131]||(s[131]=r("h6",{id:"_2-2-基本用法",tabindex:"-1"},[g("2.2 基本用法 "),r("a",{class:"header-anchor",href:"#_2-2-基本用法","aria-label":'Permalink to "2.2 基本用法"'},"​")],-1)),s[132]||(s[132]=r("p",null,"在测试计划上点鼠标右键，选择添加 > 线程（用户） > 线程组：",-1)),s[133]||(s[133]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715194413178.png",alt:"image-20210715194413178",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[134]||(s[134]=r("p",null,"在新增的线程组中，填写线程信息：",-1)),s[135]||(s[135]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715195053807.png",alt:"image-20210715195053807",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[136]||(s[136]=r("p",null,"给线程组点鼠标右键，添加http取样器：",-1)),s[137]||(s[137]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715195144130.png",alt:"image-20210715195144130",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[138]||(s[138]=r("p",null,"编写取样器内容：",-1)),s[139]||(s[139]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715195410764.png",alt:"image-20210715195410764",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[140]||(s[140]=r("p",null,"添加监听报告：",-1)),s[141]||(s[141]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715195844978.png",alt:"image-20210715195844978",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[142]||(s[142]=r("p",null,"添加监听结果树：",-1)),s[143]||(s[143]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200155537.png",alt:"image-20210715200155537",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[144]||(s[144]=r("p",null,"汇总报告结果：",-1)),s[145]||(s[145]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200243194.png",alt:"image-20210715200243194",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[146]||(s[146]=r("p",null,"结果树：",-1)),s[147]||(s[147]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200336526.png",alt:"image-20210715200336526",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[148]||(s[148]=r("p",null,"课前资料提供了编写好的Jmeter测试样例：",-1)),s[149]||(s[149]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200431615.png",alt:"image-20210715200431615",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[150]||(s[150]=r("p",null,"打开jmeter，导入课前资料提供的测试样例：",-1)),s[151]||(s[151]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200537171.png",alt:"image-20210715200537171",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[152]||(s[152]=r("p",null,"选择：",-1)),s[153]||(s[153]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200635414.png",alt:"image-20210715200635414",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[154]||(s[154]=r("p",null,"20个用户，2秒内运行完，QPS是10，超过了5.",-1)),s[155]||(s[155]=r("p",null,[g("选中"),r("code",null,"流控入门，QPS<5"),g("右键运行：")],-1)),s[156]||(s[156]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200804594.png",alt:"image-20210715200804594",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[157]||(s[157]=r("blockquote",null,[r("p",null,"注意，不要点击菜单中的执行按钮来运行。")],-1)),s[158]||(s[158]=r("p",null,"结果：",-1)),s[159]||(s[159]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200853671.png",alt:"image-20210715200853671",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[160]||(s[160]=r("p",null,"可以看到，成功的请求每次只有5个",-1)),s[161]||(s[161]=r("h3",{id:"_2-3-流控模式",tabindex:"-1"},[g("2.3 流控模式 "),r("a",{class:"header-anchor",href:"#_2-3-流控模式","aria-label":'Permalink to "2.3 流控模式"'},"​")],-1)),s[162]||(s[162]=r("p",null,[g("在添加限流规则时，点击高级选项，可以选择三种"),r("strong",null,"流控模式"),g("：")],-1)),s[163]||(s[163]=r("ul",null,[r("li",null,"直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式"),r("li",null,"关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流"),r("li",null,"链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流")],-1)),s[164]||(s[164]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715201827886.png",alt:"image-20210715201827886",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[165]||(s[165]=r("p",null,"快速入门测试的就是直接模式。",-1)),s[166]||(s[166]=r("h4",{id:"_2-3-1-关联模式",tabindex:"-1"},[g("2.3.1 关联模式 "),r("a",{class:"header-anchor",href:"#_2-3-1-关联模式","aria-label":'Permalink to "2.3.1 关联模式"'},"​")],-1)),s[167]||(s[167]=r("p",null,[r("strong",null,"关联模式"),g("：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流")],-1)),s[168]||(s[168]=r("p",null,[r("strong",null,"配置规则"),g("：")],-1)),s[169]||(s[169]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715202540786.png",alt:"image-20210715202540786",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[170]||(s[170]=r("p",null,[r("strong",null,"语法说明"),g("：当/write资源访问量触发阈值时，就会对/read资源限流，避免影响/write资源。")],-1)),s[171]||(s[171]=r("p",null,[r("strong",null,"使用场景"),g("：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。")],-1)),s[172]||(s[172]=r("p",null,[r("strong",null,"需求说明"),g("：")],-1)),s[173]||(s[173]=r("ul",null,[r("li",null,[r("p",null,"在OrderController新建两个端点：/order/query和/order/update，无需实现业务")]),r("li",null,[r("p",null,"配置流控规则，当/order/ update资源被访问的QPS超过5时，对/order/query请求限流")])],-1)),s[174]||(s[174]=r("p",null,"1）定义/order/query端点，模拟订单查询",-1)),s[175]||(s[175]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/query"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryOrder"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "查询订单成功"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[176]||(s[176]=r("p",null,"2）定义/order/update端点，模拟订单更新",-1)),s[177]||(s[177]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/update"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"updateOrder"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "更新订单成功"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[178]||(s[178]=r("p",null,"重启服务，查看sentinel控制台的簇点链路：",-1)),s[179]||(s[179]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716101805951.png",alt:"image-20210716101805951",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[180]||(s[180]=r("p",null,"3）配置流控规则",-1)),s[181]||(s[181]=r("p",null,"对哪个端点限流，就点击哪个端点后面的按钮。我们是对订单查询/order/query限流，因此点击它后面的按钮：",-1)),s[182]||(s[182]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716101934499.png",alt:"image-20210716101934499",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[183]||(s[183]=r("p",null,"在表单中填写流控规则：",-1)),s[184]||(s[184]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716102103814.png",alt:"image-20210716102103814",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[185]||(s[185]=r("p",null,"4）在Jmeter测试",-1)),s[186]||(s[186]=r("p",null,"选择《流控模式-关联》：",-1)),s[187]||(s[187]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716102416266.png",alt:"image-20210716102416266",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[188]||(s[188]=r("p",null,"可以看到1000个用户，100秒，因此QPS为10，超过了我们设定的阈值：5",-1)),s[189]||(s[189]=r("p",null,"查看http请求：",-1)),s[190]||(s[190]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716102532554.png",alt:"image-20210716102532554",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[191]||(s[191]=r("p",null,"请求的目标是/order/update，这样这个断点就会触发阈值。",-1)),s[192]||(s[192]=r("p",null,"但限流的目标是/order/query，我们在浏览器访问，可以发现：",-1)),s[193]||(s[193]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716102636030.png",alt:"image-20210716102636030",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[194]||(s[194]=r("p",null,"确实被限流了。",-1)),s[195]||(s[195]=r("p",null,"5）总结",-1)),s[196]||(s[196]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716103143002.png",alt:"image-20210716103143002",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[197]||(s[197]=r("h4",{id:"_2-3-2-链路模式",tabindex:"-1"},[g("2.3.2 链路模式 "),r("a",{class:"header-anchor",href:"#_2-3-2-链路模式","aria-label":'Permalink to "2.3.2 链路模式"'},"​")],-1)),s[198]||(s[198]=r("p",null,[r("strong",null,"链路模式"),g("：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。")],-1)),s[199]||(s[199]=r("p",null,[r("strong",null,"配置示例"),g("：")],-1)),s[200]||(s[200]=r("p",null,"例如有两条请求链路：",-1)),s[201]||(s[201]=r("ul",null,[r("li",null,[r("p",null,"/test1 --\x3e /common")]),r("li",null,[r("p",null,"/test2 --\x3e /common")])],-1)),s[202]||(s[202]=r("p",null,"如果只希望统计从/test2进入到/common的请求，则可以这样配置：",-1)),s[203]||(s[203]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716103536346.png",alt:"image-20210716103536346",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[204]||(s[204]=r("p",null,[r("strong",null,"实战案例")],-1)),s[205]||(s[205]=r("p",null,"需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。",-1)),s[206]||(s[206]=r("p",null,"步骤：",-1)),s[207]||(s[207]=r("ol",null,[r("li",null,[r("p",null,"在OrderService中添加一个queryGoods方法，不用实现业务")]),r("li",null,[r("p",null,"在OrderController中，改造/order/query端点，调用OrderService中的queryGoods方法")]),r("li",null,[r("p",null,"在OrderController中添加一个/order/save的端点，调用OrderService的queryGoods方法")]),r("li",null,[r("p",null,"给queryGoods设置限流规则，从/order/query进入queryGoods的方法限制QPS必须小于2")])],-1)),s[208]||(s[208]=r("p",null,"实现：",-1)),s[209]||(s[209]=r("h5",{id:"_1-添加查询商品方法",tabindex:"-1"},[g("1）添加查询商品方法 "),r("a",{class:"header-anchor",href:"#_1-添加查询商品方法","aria-label":'Permalink to "1）添加查询商品方法"'},"​")],-1)),s[210]||(s[210]=r("p",null,"在order-service服务中，给OrderService类添加一个queryGoods方法：",-1)),s[211]||(s[211]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," queryGoods"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.err."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询商品"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[212]||(s[212]=r("h5",{id:"_2-查询订单时-查询商品",tabindex:"-1"},[g("2）查询订单时，查询商品 "),r("a",{class:"header-anchor",href:"#_2-查询订单时-查询商品","aria-label":'Permalink to "2）查询订单时，查询商品"'},"​")],-1)),s[213]||(s[213]=r("p",null,"在order-service的OrderController中，修改/order/query端点的业务逻辑：",-1)),s[214]||(s[214]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/query"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryOrder"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 查询商品")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    orderService."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryGoods"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 查询订单")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询订单"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "查询订单成功"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[215]||(s[215]=r("h5",{id:"_3-新增订单-查询商品",tabindex:"-1"},[g("3）新增订单，查询商品 "),r("a",{class:"header-anchor",href:"#_3-新增订单-查询商品","aria-label":'Permalink to "3）新增订单，查询商品"'},"​")],-1)),s[216]||(s[216]=r("p",null,"在order-service的OrderController中，修改/order/save端点，模拟新增订单：",-1)),s[217]||(s[217]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/save"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveOrder"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 查询商品")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    orderService."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryGoods"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 查询订单")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.err."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"新增订单"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "新增订单成功"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[218]||(s[218]=r("h5",{id:"_4-给查询商品添加资源标记",tabindex:"-1"},[g("4）给查询商品添加资源标记 "),r("a",{class:"header-anchor",href:"#_4-给查询商品添加资源标记","aria-label":'Permalink to "4）给查询商品添加资源标记"'},"​")],-1)),s[219]||(s[219]=r("p",null,"默认情况下，OrderService中的方法是不被Sentinel监控的，需要我们自己通过注解来标记要监控的方法。",-1)),s[220]||(s[220]=r("p",null,"给OrderService的queryGoods方法添加@SentinelResource注解：",-1)),s[221]||(s[221]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SentinelResource"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"goods"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," queryGoods"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.err."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询商品"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[222]||(s[222]=r("p",null,"链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。",-1)),s[223]||(s[223]=r("p",null,"我们需要关闭这种对SpringMVC的资源聚合，修改order-service服务的application.yml文件：",-1)),s[224]||(s[224]=r("div",{class:"language-yaml max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"yaml"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    sentinel"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      web-context-unify"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 关闭context整合")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[225]||(s[225]=r("p",null,"重启服务，访问/order/query和/order/save，可以查看到sentinel的簇点链路规则中，出现了新的资源：",-1)),s[226]||(s[226]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105227163.png",alt:"image-20210716105227163",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[227]||(s[227]=r("h5",{id:"_5-添加流控规则",tabindex:"-1"},[g("5）添加流控规则 "),r("a",{class:"header-anchor",href:"#_5-添加流控规则","aria-label":'Permalink to "5）添加流控规则"'},"​")],-1)),s[228]||(s[228]=r("p",null,"点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：",-1)),s[229]||(s[229]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105408723.png",alt:"image-20210716105408723",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[230]||(s[230]=r("p",null,"只统计从/order/query进入/goods的资源，QPS阈值为2，超出则被限流。",-1)),s[231]||(s[231]=r("h5",{id:"_6-jmeter测试",tabindex:"-1"},[g("6）Jmeter测试 "),r("a",{class:"header-anchor",href:"#_6-jmeter测试","aria-label":'Permalink to "6）Jmeter测试"'},"​")],-1)),s[232]||(s[232]=r("p",null,"选择《流控模式-链路》：",-1)),s[233]||(s[233]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105612312.png",alt:"image-20210716105612312",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[234]||(s[234]=r("p",null,"可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2",-1)),s[235]||(s[235]=r("p",null,"一个http请求是访问/order/save：",-1)),s[236]||(s[236]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105812789.png",alt:"image-20210716105812789",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[237]||(s[237]=r("p",null,"运行的结果：",-1)),s[238]||(s[238]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716110027064.png",alt:"image-20210716110027064",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[239]||(s[239]=r("p",null,"完全不受影响。",-1)),s[240]||(s[240]=r("p",null,"另一个是访问/order/query：",-1)),s[241]||(s[241]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105855951.png",alt:"image-20210716105855951",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[242]||(s[242]=r("p",null,"运行结果：",-1)),s[243]||(s[243]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105956401.png",alt:"image-20210716105956401",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[244]||(s[244]=r("p",null,"每次只有2个通过。",-1)),s[245]||(s[245]=r("h4",{id:"_2-3-3-总结",tabindex:"-1"},[g("2.3.3 总结 "),r("a",{class:"header-anchor",href:"#_2-3-3-总结","aria-label":'Permalink to "2.3.3 总结"'},"​")],-1)),s[246]||(s[246]=r("blockquote",null,[r("ul",null,[r("li",null,[r("p",null,"流控模式有哪些？"),r("ul",null,[r("li",null,[r("p",null,"直接：对当前资源限流")]),r("li",null,[r("p",null,"关联：高优先级资源触发阈值，对低优先级资源限流。")]),r("li",null,[r("p",null,"链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流")])])])])],-1)),s[247]||(s[247]=r("h3",{id:"_2-4-流控效果",tabindex:"-1"},[g("2.4 流控效果 "),r("a",{class:"header-anchor",href:"#_2-4-流控效果","aria-label":'Permalink to "2.4 流控效果"'},"​")],-1)),s[248]||(s[248]=r("p",null,"在流控的高级选项中，还有一个流控效果选项：",-1)),s[249]||(s[249]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716110225104.png",alt:"image-20210716110225104",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[250]||(s[250]=r("p",null,"流控效果是指请求达到流控阈值时应该采取的措施，包括三种：",-1)),s[251]||(s[251]=r("ul",null,[r("li",null,[r("p",null,"快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。")]),r("li",null,[r("p",null,"warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。")]),r("li",null,[r("p",null,"排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长")])],-1)),s[252]||(s[252]=r("h4",{id:"_2-4-1-warm-up",tabindex:"-1"},[g("2.4.1 warm up "),r("a",{class:"header-anchor",href:"#_2-4-1-warm-up","aria-label":'Permalink to "2.4.1 warm up"'},"​")],-1)),s[253]||(s[253]=r("p",null,[g("阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（"),r("strong",null,"冷启动"),g("），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。")],-1)),s[254]||(s[254]=r("p",null,[g("warm up也叫"),r("strong",null,"预热模式"),g("，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。而coldFactor的默认值是3.")],-1)),s[255]||(s[255]=r("p",null,"例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，然后在5秒后逐渐增长到10.",-1)),s[256]||(s[256]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716110629796.png",alt:"image-20210716110629796",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[257]||(s[257]=r("p",null,[r("strong",null,"案例")],-1)),s[258]||(s[258]=r("p",null,"需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒",-1)),s[259]||(s[259]=r("h5",{id:"_1-配置流控规则",tabindex:"-1"},[g("1）配置流控规则： "),r("a",{class:"header-anchor",href:"#_1-配置流控规则","aria-label":'Permalink to "1）配置流控规则："'},"​")],-1)),s[260]||(s[260]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111012387.png",alt:"image-20210716111012387",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[261]||(s[261]=r("h5",{id:"_2-jmeter测试",tabindex:"-1"},[g("2）Jmeter测试 "),r("a",{class:"header-anchor",href:"#_2-jmeter测试","aria-label":'Permalink to "2）Jmeter测试"'},"​")],-1)),s[262]||(s[262]=r("p",null,"选择《流控效果，warm up》：",-1)),s[263]||(s[263]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111136699.png",alt:"image-20210716111136699",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[264]||(s[264]=r("p",null,"QPS为10.",-1)),s[265]||(s[265]=r("p",null,"刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：",-1)),s[266]||(s[266]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111303701.png",alt:"image-20210716111303701",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[267]||(s[267]=r("p",null,"随着时间推移，成功比例越来越高：",-1)),s[268]||(s[268]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111404717.png",alt:"image-20210716111404717",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[269]||(s[269]=r("p",null,"到Sentinel控制台查看实时监控：",-1)),s[270]||(s[270]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111526480.png",alt:"image-20210716111526480",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[271]||(s[271]=r("p",null,"一段时间后：",-1)),s[272]||(s[272]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111658541.png",alt:"image-20210716111658541",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[273]||(s[273]=r("h4",{id:"_2-4-2-排队等待",tabindex:"-1"},[g("2.4.2 排队等待 "),r("a",{class:"header-anchor",href:"#_2-4-2-排队等待","aria-label":'Permalink to "2.4.2 排队等待"'},"​")],-1)),s[274]||(s[274]=r("p",null,"当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。",-1)),s[275]||(s[275]=r("p",null,"而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。",-1)),s[276]||(s[276]=r("p",null,"工作原理",-1)),s[277]||(s[277]=r("p",null,[g("例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着"),r("strong",null,"预期等待时长"),g("超过2000ms的请求会被拒绝并抛出异常。")],-1)),s[278]||(s[278]=r("p",null,"那什么叫做预期等待时长呢？",-1)),s[279]||(s[279]=r("p",null,"比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：",-1)),s[280]||(s[280]=r("ul",null,[r("li",null,[g("第6个请求的"),r("strong",null,"预期等待时长"),g(" = 200 * （6 - 1） = 1000ms")]),r("li",null,"第12个请求的预期等待时长 = 200 * （12-1） = 2200ms")],-1)),s[281]||(s[281]=r("p",null,"现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：",-1)),s[282]||(s[282]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716113147176.png",alt:"image-20210716113147176",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[283]||(s[283]=r("p",null,"如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：",-1)),s[284]||(s[284]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716113426524.png",alt:"image-20210716113426524",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[285]||(s[285]=r("p",null,"平滑的QPS曲线，对于服务器来说是更友好的。",-1)),s[286]||(s[286]=r("p",null,[r("strong",null,"案例")],-1)),s[287]||(s[287]=r("p",null,"需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s",-1)),s[288]||(s[288]=r("h5",{id:"_1-添加流控规则",tabindex:"-1"},[g("1）添加流控规则 "),r("a",{class:"header-anchor",href:"#_1-添加流控规则","aria-label":'Permalink to "1）添加流控规则"'},"​")],-1)),s[289]||(s[289]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716114048918.png",alt:"image-20210716114048918",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[290]||(s[290]=r("h5",{id:"_2-jmeter测试-1",tabindex:"-1"},[g("2）Jmeter测试 "),r("a",{class:"header-anchor",href:"#_2-jmeter测试-1","aria-label":'Permalink to "2）Jmeter测试"'},"​")],-1)),s[291]||(s[291]=r("p",null,"选择《流控效果，队列》：",-1)),s[292]||(s[292]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716114243558.png",alt:"image-20210716114243558",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[293]||(s[293]=r("p",null,"QPS为15，已经超过了我们设定的10。",-1)),s[294]||(s[294]=r("p",null,"如果是之前的 快速失败、warmup模式，超出的请求应该会直接报错。",-1)),s[295]||(s[295]=r("p",null,"但是我们看看队列模式的运行结果：",-1)),s[296]||(s[296]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716114429361.png",alt:"image-20210716114429361",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[297]||(s[297]=r("p",null,"全部都通过了。",-1)),s[298]||(s[298]=r("p",null,"再去sentinel查看实时监控的QPS曲线：",-1)),s[299]||(s[299]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716114522935.png",alt:"image-20210716114522935",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[300]||(s[300]=r("p",null,[g("QPS非常平滑，一致保持在10，但是超出的请求没有被拒绝，而是放入队列。因此"),r("strong",null,"响应时间"),g("（等待时间）会越来越长。")],-1)),s[301]||(s[301]=r("p",null,"当队列满了以后，才会有部分请求失败：",-1)),s[302]||(s[302]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716114651137.png",alt:"image-20210716114651137",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[303]||(s[303]=r("h4",{id:"_2-4-3-总结",tabindex:"-1"},[g("2.4.3 总结 "),r("a",{class:"header-anchor",href:"#_2-4-3-总结","aria-label":'Permalink to "2.4.3 总结"'},"​")],-1)),s[304]||(s[304]=r("blockquote",null,[r("ul",null,[r("li",null,[r("p",null,"流控效果有哪些？"),r("ul",null,[r("li",null,[r("p",null,"快速失败：QPS超过阈值时，拒绝新的请求")]),r("li",null,[r("p",null,"warm up： QPS超过阈值时，拒绝新的请求；QPS阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。")]),r("li",null,[r("p",null,"排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝")])])])])],-1)),s[305]||(s[305]=r("h3",{id:"_2-5-热点参数限流",tabindex:"-1"},[g("2.5 热点参数限流 "),r("a",{class:"header-anchor",href:"#_2-5-热点参数限流","aria-label":'Permalink to "2.5 热点参数限流"'},"​")],-1)),s[306]||(s[306]=r("p",null,[g("之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是"),r("strong",null,"分别统计参数值相同的请求"),g("，判断是否超过QPS阈值。")],-1)),s[307]||(s[307]=r("h4",{id:"_2-5-1-全局参数限流",tabindex:"-1"},[g("2.5.1 全局参数限流 "),r("a",{class:"header-anchor",href:"#_2-5-1-全局参数限流","aria-label":'Permalink to "2.5.1 全局参数限流"'},"​")],-1)),s[308]||(s[308]=r("p",null,"例如，一个根据id查询商品的接口：",-1)),s[309]||(s[309]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716115014663.png",alt:"image-20210716115014663",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[310]||(s[310]=r("p",null,"访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：",-1)),s[311]||(s[311]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716115131463.png",alt:"image-20210716115131463",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[312]||(s[312]=r("p",null,"当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。",-1)),s[313]||(s[313]=r("p",null,"配置示例：",-1)),s[314]||(s[314]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716115232426.png",alt:"image-20210716115232426",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[315]||(s[315]=r("p",null,[g("代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒"),r("strong",null,"相同参数值"),g("的请求数不能超过5")],-1)),s[316]||(s[316]=r("h4",{id:"_2-5-2-热点参数限流",tabindex:"-1"},[g("2.5.2 热点参数限流 "),r("a",{class:"header-anchor",href:"#_2-5-2-热点参数限流","aria-label":'Permalink to "2.5.2 热点参数限流"'},"​")],-1)),s[317]||(s[317]=r("p",null,"刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.",-1)),s[318]||(s[318]=r("p",null,"而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：",-1)),s[319]||(s[319]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716115717523.png",alt:"image-20210716115717523",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[320]||(s[320]=r("p",null,"结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：",-1)),s[321]||(s[321]=r("ul",null,[r("li",null,[r("p",null,"如果参数值是100，则每1秒允许的QPS为10")]),r("li",null,[r("p",null,"如果参数值是101，则每1秒允许的QPS为15")])],-1)),s[322]||(s[322]=r("h4",{id:"_2-5-3-案例",tabindex:"-1"},[g("2.5.3 案例 "),r("a",{class:"header-anchor",href:"#_2-5-3-案例","aria-label":'Permalink to "2.5.3 案例"'},"​")],-1)),s[323]||(s[323]=r("p",null,[r("strong",null,"案例需求"),g("：给/order/{orderId}这个资源添加热点参数限流，规则如下：")],-1)),s[324]||(s[324]=r("ul",null,[r("li",null,"默认的热点参数规则是每1秒请求量不超过2"),r("li",null,"给102这个参数设置例外：每1秒请求量不超过4"),r("li",null,"给103这个参数设置例外：每1秒请求量不超过10")],-1)),s[325]||(s[325]=r("p",null,[r("strong",null,"注意事项"),g("：热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源")],-1)),s[326]||(s[326]=r("h5",{id:"_1-标记资源",tabindex:"-1"},[g("1）标记资源 "),r("a",{class:"header-anchor",href:"#_1-标记资源","aria-label":'Permalink to "1）标记资源"'},"​")],-1)),s[327]||(s[327]=r("p",null,"给order-service中的OrderController中的/order/{orderId}资源添加注解：",-1)),s[328]||(s[328]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120033572.png",alt:"image-20210716120033572",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[329]||(s[329]=r("h5",{id:"_2-热点参数限流规则",tabindex:"-1"},[g("2）热点参数限流规则 "),r("a",{class:"header-anchor",href:"#_2-热点参数限流规则","aria-label":'Permalink to "2）热点参数限流规则"'},"​")],-1)),s[330]||(s[330]=r("p",null,"访问该接口，可以看到我们标记的hot资源出现了：",-1)),s[331]||(s[331]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120208509.png",alt:"image-20210716120208509",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[332]||(s[332]=r("p",null,"这里不要点击hot后面的按钮，页面有BUG",-1)),s[333]||(s[333]=r("p",null,[g("点击左侧菜单中"),r("strong",null,"热点规则"),g("菜单：")],-1)),s[334]||(s[334]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120319009.png",alt:"image-20210716120319009",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[335]||(s[335]=r("p",null,"点击新增，填写表单：",-1)),s[336]||(s[336]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120536714.png",alt:"image-20210716120536714",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[337]||(s[337]=r("h5",{id:"_3-jmeter测试",tabindex:"-1"},[g("3）Jmeter测试 "),r("a",{class:"header-anchor",href:"#_3-jmeter测试","aria-label":'Permalink to "3）Jmeter测试"'},"​")],-1)),s[338]||(s[338]=r("p",null,"选择《热点参数限流 QPS1》：",-1)),s[339]||(s[339]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120754527.png",alt:"image-20210716120754527",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[340]||(s[340]=r("p",null,"这里发起请求的QPS为5.",-1)),s[341]||(s[341]=r("p",null,"包含3个http请求：",-1)),s[342]||(s[342]=r("p",null,"普通参数，QPS阈值为2",-1)),s[343]||(s[343]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120840501.png",alt:"image-20210716120840501",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[344]||(s[344]=r("p",null,"运行结果：",-1)),s[345]||(s[345]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716121105567.png",alt:"image-20210716121105567",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[346]||(s[346]=r("p",null,"例外项，QPS阈值为4",-1)),s[347]||(s[347]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120900365.png",alt:"image-20210716120900365",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[348]||(s[348]=r("p",null,"运行结果：",-1)),s[349]||(s[349]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716121201630.png",alt:"image-20210716121201630",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[350]||(s[350]=r("p",null,"例外项，QPS阈值为10",-1)),s[351]||(s[351]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120919131.png",alt:"image-20210716120919131",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[352]||(s[352]=r("p",null,"运行结果：",-1)),s[353]||(s[353]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716121220305.png",alt:"image-20210716121220305",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[354]||(s[354]=r("hr",null,null,-1)),s[355]||(s[355]=r("h2",{id:"_3-隔离和降级",tabindex:"-1"},[g("3. 隔离和降级 "),r("a",{class:"header-anchor",href:"#_3-隔离和降级","aria-label":'Permalink to "3. 隔离和降级"'},"​")],-1)),s[356]||(s[356]=r("p",null,"限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。",-1)),s[357]||(s[357]=r("p",null,[g("而要将这些故障控制在一定范围，避免雪崩，就要靠"),r("strong",null,"线程隔离"),g("（舱壁模式）和"),r("strong",null,"熔断降级"),g("手段了。")],-1)),s[358]||(s[358]=r("p",null,[r("strong",null,"线程隔离"),g("之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。")],-1)),s[359]||(s[359]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173215243.png",alt:"image-20210715173215243",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[360]||(s[360]=r("p",null,[r("strong",null,"熔断降级"),g("：是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。")],-1)),s[361]||(s[361]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173428073.png",alt:"image-20210715173428073",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[362]||(s[362]=r("p",null,[g("可以看到，不管是线程隔离还是熔断降级，都是对"),r("strong",null,"客户端"),g("（调用方）的保护。需要在"),r("strong",null,"调用方"),g(" 发起远程调用时做线程隔离、或者服务熔断。")],-1)),s[363]||(s[363]=r("p",null,"而我们的微服务远程调用都是基于Feign来完成的，因此我们需要将Feign与Sentinel整合，在Feign里面实现线程隔离和服务熔断。",-1)),s[364]||(s[364]=r("h3",{id:"_3-1-feignclient整合sentinel",tabindex:"-1"},[g("3.1 FeignClient整合Sentinel "),r("a",{class:"header-anchor",href:"#_3-1-feignclient整合sentinel","aria-label":'Permalink to "3.1 FeignClient整合Sentinel"'},"​")],-1)),s[365]||(s[365]=r("p",null,"SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。",-1)),s[366]||(s[366]=r("h4",{id:"_3-1-1-修改配置-开启sentinel功能",tabindex:"-1"},[g("3.1.1 修改配置，开启sentinel功能 "),r("a",{class:"header-anchor",href:"#_3-1-1-修改配置-开启sentinel功能","aria-label":'Permalink to "3.1.1 修改配置，开启sentinel功能"'},"​")],-1)),s[367]||(s[367]=r("p",null,"修改OrderService的application.yml文件，开启Feign的Sentinel功能：",-1)),s[368]||(s[368]=r("div",{class:"language-yaml max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"yaml"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"feign"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  sentinel"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    enabled"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 开启feign对sentinel的支持")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[369]||(s[369]=r("h4",{id:"_3-1-2-编写失败降级逻辑",tabindex:"-1"},[g("3.1.2 编写失败降级逻辑 "),r("a",{class:"header-anchor",href:"#_3-1-2-编写失败降级逻辑","aria-label":'Permalink to "3.1.2 编写失败降级逻辑"'},"​")],-1)),s[370]||(s[370]=r("p",null,"业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。",-1)),s[371]||(s[371]=r("p",null,"给FeignClient编写失败后的降级逻辑",-1)),s[372]||(s[372]=r("p",null,"①方式一：FallbackClass，无法对远程调用的异常做处理",-1)),s[373]||(s[373]=r("p",null,"②方式二：FallbackFactory，可以对远程调用的异常做处理，我们选择这种",-1)),s[374]||(s[374]=r("p",null,"这里我们演示方式二的失败降级处理。",-1)),s[375]||(s[375]=r("p",null,[r("strong",null,"步骤一"),g("：在feing-api项目中定义类，实现FallbackFactory：")],-1)),s[376]||(s[376]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208023848898.png",alt:"image-20251208023848898",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[377]||(s[377]=r("p",null,"代码：",-1)),s[378]||(s[378]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.feign.clients.fallback;")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.feign.clients.UserClient;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.feign.pojo.User;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," feign.hystrix.FallbackFactory;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lombok.extern.slf4j.Slf4j;")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Slf4j")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserClientFallbackFactory"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," FallbackFactory"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UserClient"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserClient "),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Throwable "),r("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"throwable"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserClient"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            @"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            public"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," User "),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findById"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long "),r("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询用户异常"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", throwable);")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," User"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        };")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[379]||(s[379]=r("p",null,[r("strong",null,"步骤二"),g("：在feing-api项目中的DefaultFeignConfiguration类中将UserClientFallbackFactory注册为一个Bean：")],-1)),s[380]||(s[380]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserClientFallbackFactory "),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"userClientFallbackFactory"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserClientFallbackFactory"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[381]||(s[381]=r("p",null,[r("strong",null,"步骤三"),g("：在feing-api项目中的UserClient接口中使用UserClientFallbackFactory：")],-1)),s[382]||(s[382]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.feign.clients.fallback.UserClientFallbackFactory;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.feign.pojo.User;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.cloud.openfeign.FeignClient;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.web.bind.annotation.GetMapping;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.web.bind.annotation.PathVariable;")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"FeignClient"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "userservice"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"fallbackFactory"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserClientFallbackFactory.class)")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," interface"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserClient"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/user/{id}"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    User "),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findById"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long "),r("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[383]||(s[383]=r("p",null,"重启后，访问一次订单查询业务，然后查看sentinel控制台，可以看到新的簇点链路：",-1)),s[384]||(s[384]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208023921576.png",alt:"image-20251208023921576",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[385]||(s[385]=r("h4",{id:"_3-1-3-总结",tabindex:"-1"},[g("3.1.3 总结 "),r("a",{class:"header-anchor",href:"#_3-1-3-总结","aria-label":'Permalink to "3.1.3 总结"'},"​")],-1)),s[386]||(s[386]=r("p",null,"Sentinel支持的雪崩解决方案：",-1)),s[387]||(s[387]=r("ul",null,[r("li",null,"线程隔离（仓壁模式）"),r("li",null,"降级熔断")],-1)),s[388]||(s[388]=r("p",null,"Feign整合Sentinel的步骤：",-1)),s[389]||(s[389]=r("ul",null,[r("li",null,"在application.yml中配置：feign.sentienl.enable=true"),r("li",null,"给FeignClient编写FallbackFactory并注册为Bean"),r("li",null,"将FallbackFactory配置到FeignClient")],-1)),s[390]||(s[390]=r("h3",{id:"_3-2-线程隔离-舱壁模式",tabindex:"-1"},[g("3.2 线程隔离（舱壁模式） "),r("a",{class:"header-anchor",href:"#_3-2-线程隔离-舱壁模式","aria-label":'Permalink to "3.2 线程隔离（舱壁模式）"'},"​")],-1)),s[391]||(s[391]=r("h4",{id:"_3-2-1-线程隔离的实现方式",tabindex:"-1"},[g("3.2.1 线程隔离的实现方式 "),r("a",{class:"header-anchor",href:"#_3-2-1-线程隔离的实现方式","aria-label":'Permalink to "3.2.1 线程隔离的实现方式"'},"​")],-1)),s[392]||(s[392]=r("p",null,"线程隔离有两种方式实现：",-1)),s[393]||(s[393]=r("ul",null,[r("li",null,[r("p",null,"线程池隔离")]),r("li",null,[r("p",null,"信号量隔离（Sentinel默认采用）")])],-1)),s[394]||(s[394]=r("p",null,"如图：",-1)),s[395]||(s[395]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208023947160.png",alt:"image-20251208023947160",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[396]||(s[396]=r("p",null,[r("strong",null,"线程池隔离"),g("：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果")],-1)),s[397]||(s[397]=r("p",null,[r("strong",null,"信号量隔离"),g("：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。")],-1)),s[398]||(s[398]=r("p",null,"两者的优缺点：",-1)),s[399]||(s[399]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024008412.png",alt:"image-20251208024008412",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[400]||(s[400]=r("h4",{id:"_3-2-2-sentinel的线程隔离",tabindex:"-1"},[g("3.2.2 sentinel的线程隔离 "),r("a",{class:"header-anchor",href:"#_3-2-2-sentinel的线程隔离","aria-label":'Permalink to "3.2.2 sentinel的线程隔离"'},"​")],-1)),s[401]||(s[401]=r("p",null,[r("strong",null,"用法说明"),g("：")],-1)),s[402]||(s[402]=r("p",null,"在添加限流规则时，可以选择两种阈值类型：",-1)),s[403]||(s[403]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024048368.png",alt:"image-20251208024048368",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[404]||(s[404]=r("ul",null,[r("li",null,[r("p",null,"QPS：就是每秒的请求数，在快速入门中已经演示过")]),r("li",null,[r("p",null,[g("线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现"),r("strong",null,"线程隔离"),g("（舱壁模式）。")])])],-1)),s[405]||(s[405]=r("p",null,[r("strong",null,"案例需求"),g("：给 order-service服务中的UserClient的查询用户接口设置流控规则，线程数不能超过 2。然后利用jemeter测试。")],-1)),s[406]||(s[406]=r("h5",{id:"_1-配置隔离规则",tabindex:"-1"},[g("1）配置隔离规则 "),r("a",{class:"header-anchor",href:"#_1-配置隔离规则","aria-label":'Permalink to "1）配置隔离规则"'},"​")],-1)),s[407]||(s[407]=r("p",null,"选择feign接口后面的流控按钮：",-1)),s[408]||(s[408]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024124810.png",alt:"image-20210716123831992",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[409]||(s[409]=r("p",null,"填写表单：",-1)),s[410]||(s[410]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024154711.png",alt:"image-20251208024154711",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[411]||(s[411]=r("h5",{id:"_2-jmeter测试-2",tabindex:"-1"},[g("2）Jmeter测试 "),r("a",{class:"header-anchor",href:"#_2-jmeter测试-2","aria-label":'Permalink to "2）Jmeter测试"'},"​")],-1)),s[412]||(s[412]=r("p",null,"选择《阈值类型-线程数<2》：",-1)),s[413]||(s[413]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024219794.png",alt:"image-20251208024219794",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[414]||(s[414]=r("p",null,"一次发生10个请求，有较大概率并发线程数超过2，而超出的请求会走之前定义的失败降级逻辑。",-1)),s[415]||(s[415]=r("p",null,"查看运行结果：",-1)),s[416]||(s[416]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024238141.png",alt:"image-20251208024238141",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[417]||(s[417]=r("p",null,"发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的null信息。",-1)),s[418]||(s[418]=r("h4",{id:"_3-2-3-总结",tabindex:"-1"},[g("3.2.3 总结 "),r("a",{class:"header-anchor",href:"#_3-2-3-总结","aria-label":'Permalink to "3.2.3 总结"'},"​")],-1)),s[419]||(s[419]=r("blockquote",null,[r("p",null,"线程隔离的两种手段是？"),r("ul",null,[r("li",null,[r("p",null,"信号量隔离")]),r("li",null,[r("p",null,"线程池隔离")])]),r("p",null,"信号量隔离的特点是？"),r("ul",null,[r("li",null,"基于计数器模式，简单，开销小")]),r("p",null,"线程池隔离的特点是？"),r("ul",null,[r("li",null,"基于线程池模式，有额外开销，但隔离控制更强")])],-1)),s[420]||(s[420]=r("h3",{id:"_3-3-熔断降级",tabindex:"-1"},[g("3.3 熔断降级 "),r("a",{class:"header-anchor",href:"#_3-3-熔断降级","aria-label":'Permalink to "3.3 熔断降级"'},"​")],-1)),s[421]||(s[421]=r("p",null,[g("熔断降级是解决雪崩问题的重要手段。其思路是由"),r("strong",null,"断路器"),g("统计服务调用的异常比例、慢请求比例，如果超出阈值则会"),r("strong",null,"熔断"),g("该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。")],-1)),s[422]||(s[422]=r("p",null,"断路器控制熔断和放行是通过状态机来完成的：",-1)),s[423]||(s[423]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024309805.png",alt:"image-20251208024309805",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[424]||(s[424]=r("p",null,"状态机包括三个状态：",-1)),s[425]||(s[425]=r("ul",null,[r("li",null,"closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态"),r("li",null,[g("open：打开状态，服务调用被"),r("strong",null,"熔断"),g("，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态")]),r("li",null,[g("half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。 "),r("ul",null,[r("li",null,"请求成功：则切换到closed状态"),r("li",null,"请求失败：则切换到open状态")])])],-1)),s[426]||(s[426]=r("p",null,"断路器熔断策略有三种：慢调用、异常比例、异常数",-1)),s[427]||(s[427]=r("h4",{id:"_3-3-1-慢调用",tabindex:"-1"},[g("3.3.1 慢调用 "),r("a",{class:"header-anchor",href:"#_3-3-1-慢调用","aria-label":'Permalink to "3.3.1 慢调用"'},"​")],-1)),s[428]||(s[428]=r("p",null,[r("strong",null,"慢调用"),g("：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。")],-1)),s[429]||(s[429]=r("p",null,"例如：",-1)),s[430]||(s[430]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024331643.png",alt:"image-20251208024331643",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[431]||(s[431]=r("p",null,"解读：RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。",-1)),s[432]||(s[432]=r("p",null,[r("strong",null,"案例")],-1)),s[433]||(s[433]=r("p",null,"需求：给 UserClient的查询用户接口设置降级规则，慢调用的RT阈值为50ms，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5",-1)),s[434]||(s[434]=r("h5",{id:"_1-设置慢调用",tabindex:"-1"},[g("1）设置慢调用 "),r("a",{class:"header-anchor",href:"#_1-设置慢调用","aria-label":'Permalink to "1）设置慢调用"'},"​")],-1)),s[435]||(s[435]=r("p",null,"修改user-service中的/user/{id}这个接口的业务。通过休眠模拟一个延迟时间：",-1)),s[436]||(s[436]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024357370.png",alt:"image-20251208024357370",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[437]||(s[437]=r("p",null,"此时，orderId=101的订单，关联的是id为1的用户，调用时长为60ms：",-1)),s[438]||(s[438]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024425430.png",alt:"image-20251208024425430",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[439]||(s[439]=r("p",null,"orderId=102的订单，关联的是id为2的用户，调用时长为非常短；",-1)),s[440]||(s[440]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024453874.png",alt:"image-20251208024453874",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[441]||(s[441]=r("h5",{id:"_2-设置熔断规则",tabindex:"-1"},[g("2）设置熔断规则 "),r("a",{class:"header-anchor",href:"#_2-设置熔断规则","aria-label":'Permalink to "2）设置熔断规则"'},"​")],-1)),s[442]||(s[442]=r("p",null,"下面，给feign接口设置降级规则：",-1)),s[443]||(s[443]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024521003.png",alt:"image-20251208024521003",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[444]||(s[444]=r("p",null,"规则：",-1)),s[445]||(s[445]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024542743.png",alt:"image-20251208024542743",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[446]||(s[446]=r("p",null,"超过50ms的请求都会被认为是慢请求",-1)),s[447]||(s[447]=r("h5",{id:"_3-测试",tabindex:"-1"},[g("3）测试 "),r("a",{class:"header-anchor",href:"#_3-测试","aria-label":'Permalink to "3）测试"'},"​")],-1)),s[448]||(s[448]=r("p",null,[g("在浏览器访问："),r("code",null,"http://localhost:8088/order/101"),g("，快速刷新5次，可以发现：")],-1)),s[449]||(s[449]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024648700.png",alt:"image-20251208024648700",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[450]||(s[450]=r("p",null,"触发了熔断，请求时长缩短至5ms，快速失败了，并且走降级逻辑，返回的null",-1)),s[451]||(s[451]=r("p",null,[g("在浏览器访问："),r("code",null,"http://localhost:8088/order/102"),g("，竟然也被熔断了：")],-1)),s[452]||(s[452]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024706349.png",alt:"image-20251208024706349",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[453]||(s[453]=r("h4",{id:"_3-3-2-异常比例、异常数",tabindex:"-1"},[g("3.3.2 异常比例、异常数 "),r("a",{class:"header-anchor",href:"#_3-3-2-异常比例、异常数","aria-label":'Permalink to "3.3.2 异常比例、异常数"'},"​")],-1)),s[454]||(s[454]=r("p",null,[r("strong",null,"异常比例或异常数"),g("：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。")],-1)),s[455]||(s[455]=r("p",null,"例如，一个异常比例设置：",-1)),s[456]||(s[456]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024729436.png",alt:"image-20251208024729436",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[457]||(s[457]=r("p",null,"解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。",-1)),s[458]||(s[458]=r("p",null,"一个异常数设置：",-1)),s[459]||(s[459]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024744780.png",alt:"image-20251208024744780",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[460]||(s[460]=r("p",null,"解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常数不低于2次，则触发熔断。",-1)),s[461]||(s[461]=r("p",null,[r("strong",null,"案例")],-1)),s[462]||(s[462]=r("p",null,"需求：给 UserClient的查询用户接口设置降级规则，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5s",-1)),s[463]||(s[463]=r("h5",{id:"_1-设置异常请求",tabindex:"-1"},[g("1）设置异常请求 "),r("a",{class:"header-anchor",href:"#_1-设置异常请求","aria-label":'Permalink to "1）设置异常请求"'},"​")],-1)),s[464]||(s[464]=r("p",null,"首先，修改user-service中的/user/{id}这个接口的业务。手动抛出异常，以触发异常比例的熔断：",-1)),s[465]||(s[465]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024804980.png",alt:"image-20251208024804980",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[466]||(s[466]=r("p",null,"也就是说，id 为 2时，就会触发异常",-1)),s[467]||(s[467]=r("h5",{id:"_2-设置熔断规则-1",tabindex:"-1"},[g("2）设置熔断规则 "),r("a",{class:"header-anchor",href:"#_2-设置熔断规则-1","aria-label":'Permalink to "2）设置熔断规则"'},"​")],-1)),s[468]||(s[468]=r("p",null,"下面，给feign接口设置降级规则：",-1)),s[469]||(s[469]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024914262.png",alt:"image-20251208024914262",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[470]||(s[470]=r("p",null,"规则：",-1)),s[471]||(s[471]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024928605.png",alt:"image-20251208024928605",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[472]||(s[472]=r("p",null,"在5次请求中，只要异常比例超过0.4，也就是有2次以上的异常，就会触发熔断。",-1)),s[473]||(s[473]=r("h5",{id:"_3-测试-1",tabindex:"-1"},[g("3）测试 "),r("a",{class:"header-anchor",href:"#_3-测试-1","aria-label":'Permalink to "3）测试"'},"​")],-1)),s[474]||(s[474]=r("p",null,[g("在浏览器快速访问："),r("code",null,"http://localhost:8088/order/102"),g("，快速刷新5次，触发熔断：")],-1)),s[475]||(s[475]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024949579.png",alt:"image-20251208024949579",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[476]||(s[476]=r("p",null,"此时，我们去访问本来应该正常的103：",-1)),s[477]||(s[477]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025012356.png",alt:"image-20251208025012356",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[478]||(s[478]=r("hr",null,null,-1)),s[479]||(s[479]=r("h2",{id:"_4-授权规则",tabindex:"-1"},[g("4. 授权规则 "),r("a",{class:"header-anchor",href:"#_4-授权规则","aria-label":'Permalink to "4. 授权规则"'},"​")],-1)),s[480]||(s[480]=r("p",null,"授权规则可以对请求方来源做判断和控制。",-1)),s[481]||(s[481]=r("h3",{id:"_4-1-授权规则",tabindex:"-1"},[g("4.1 授权规则 "),r("a",{class:"header-anchor",href:"#_4-1-授权规则","aria-label":'Permalink to "4.1 授权规则"'},"​")],-1)),s[482]||(s[482]=r("h4",{id:"_4-1-1-基本规则",tabindex:"-1"},[g("4.1.1 基本规则 "),r("a",{class:"header-anchor",href:"#_4-1-1-基本规则","aria-label":'Permalink to "4.1.1 基本规则"'},"​")],-1)),s[483]||(s[483]=r("p",null,"授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。",-1)),s[484]||(s[484]=r("ul",null,[r("li",null,[r("p",null,"白名单：来源（origin）在白名单内的调用者允许访问")]),r("li",null,[r("p",null,"黑名单：来源（origin）在黑名单内的调用者不允许访问")])],-1)),s[485]||(s[485]=r("p",null,"点击左侧菜单的授权，可以看到授权规则：",-1)),s[486]||(s[486]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025038299.png",alt:"image-20251208025038299",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[487]||(s[487]=r("ul",null,[r("li",{orderId:""},[r("p",null,"资源名：就是受保护的资源，例如/order/")]),r("li",null,[r("p",null,"流控应用：是来源者的名单，"),r("ul",null,[r("li",null,"如果是勾选白名单，则名单中的来源被许可访问。"),r("li",null,"如果是勾选黑名单，则名单中的来源被禁止访问。")])])],-1)),s[488]||(s[488]=r("p",null,"比如：",-1)),s[489]||(s[489]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025051405.png",alt:"image-20251208025051405",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[490]||(s[490]=r("p",null,[g("我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写"),r("strong",null,"网关的来源名称（origin）"),g("。")],-1)),s[491]||(s[491]=r("h4",{id:"_4-1-2-如何获取origin",tabindex:"-1"},[g("4.1.2 如何获取origin "),r("a",{class:"header-anchor",href:"#_4-1-2-如何获取origin","aria-label":'Permalink to "4.1.2 如何获取origin"'},"​")],-1)),s[492]||(s[492]=r("p",null,"Sentinel是通过RequestOriginParser这个接口的parseOrigin来获取请求的来源的。",-1)),s[493]||(s[493]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," interface"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RequestOriginParser"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 从请求request对象中获取origin，获取方式自定义")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String "),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseOrigin"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),r("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[494]||(s[494]=r("p",null,"这个方法的作用就是从request对象中，获取请求者的origin值并返回。",-1)),s[495]||(s[495]=r("p",null,"默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。",-1)),s[496]||(s[496]=r("p",null,[g("因此，我们需要自定义这个接口的实现，让"),r("strong",null,"不同的请求，返回不同的origin"),g("。")],-1)),s[497]||(s[497]=r("p",null,"例如order-service服务中，我们定义一个RequestOriginParser的实现类：",-1)),s[498]||(s[498]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.order.sentinel;")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.util.StringUtils;")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," javax.servlet.http.HttpServletRequest;")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HeaderOriginParser"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RequestOriginParser"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseOrigin"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),r("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取请求头")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String origin "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getHeader"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"origin"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.非空判断")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(origin)) {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            origin "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "blank"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," origin;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[499]||(s[499]=r("p",null,"我们会尝试从request-header中获取origin值。",-1)),s[500]||(s[500]=r("h4",{id:"_4-1-3-给网关添加请求头",tabindex:"-1"},[g("4.1.3 给网关添加请求头 "),r("a",{class:"header-anchor",href:"#_4-1-3-给网关添加请求头","aria-label":'Permalink to "4.1.3 给网关添加请求头"'},"​")],-1)),s[501]||(s[501]=r("p",null,[g("既然获取请求origin的方式是从reques-header中获取origin值，我们必须让"),r("strong",null,"所有从gateway路由到微服务的请求都带上origin头"),g("。")],-1)),s[502]||(s[502]=r("p",null,"这个需要利用之前学习的一个GatewayFilter来实现，AddRequestHeaderGatewayFilter。",-1)),s[503]||(s[503]=r("p",null,"修改gateway服务中的application.yml，添加一个defaultFilter：",-1)),s[504]||(s[504]=r("div",{class:"language-yaml max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"yaml"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    gateway"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      default-filters"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        - "),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"AddRequestHeader=origin,gateway")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      routes"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"       # ...略")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[505]||(s[505]=r("p",null,"这样，从gateway路由的所有请求都会带上origin头，值为gateway。而从其它地方到达微服务的请求则没有这个头。",-1)),s[506]||(s[506]=r("h4",{id:"_4-1-4-配置授权规则",tabindex:"-1"},[g("4.1.4 配置授权规则 "),r("a",{class:"header-anchor",href:"#_4-1-4-配置授权规则","aria-label":'Permalink to "4.1.4 配置授权规则"'},"​")],-1)),s[507]||(s[507]=r("p",null,"接下来，我们添加一个授权规则，放行origin值为gateway的请求。",-1)),s[508]||(s[508]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025119977.png",alt:"image-20251208025119977",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[509]||(s[509]=r("p",null,"配置如下：",-1)),s[510]||(s[510]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025323560.png",alt:"image-20251208025323560",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[511]||(s[511]=r("p",null,"现在，我们直接跳过网关，访问order-service服务：",-1)),s[512]||(s[512]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025347127.png",alt:"image-20251208025347127",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[513]||(s[513]=r("p",null,"通过网关访问：",-1)),s[514]||(s[514]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025356719.png",alt:"image-20251208025356719",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[515]||(s[515]=r("h3",{id:"_4-2-自定义异常结果",tabindex:"-1"},[g("4.2 自定义异常结果 "),r("a",{class:"header-anchor",href:"#_4-2-自定义异常结果","aria-label":'Permalink to "4.2 自定义异常结果"'},"​")],-1)),s[516]||(s[516]=r("p",null,"默认情况下，发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是flow limmiting（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。",-1)),s[517]||(s[517]=r("h4",{id:"_4-2-1-异常类型",tabindex:"-1"},[g("4.2.1 异常类型 "),r("a",{class:"header-anchor",href:"#_4-2-1-异常类型","aria-label":'Permalink to "4.2.1 异常类型"'},"​")],-1)),s[518]||(s[518]=r("p",null,"而如果要自定义异常时的返回结果，需要实现BlockExceptionHandler接口：",-1)),s[519]||(s[519]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," interface"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BlockExceptionHandler"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handle"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),r("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),r("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", BlockException "),r("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[520]||(s[520]=r("p",null,"这个方法有三个参数：",-1)),s[521]||(s[521]=r("ul",null,[r("li",null,"HttpServletRequest request：request对象"),r("li",null,"HttpServletResponse response：response对象"),r("li",null,"BlockException e：被sentinel拦截时抛出的异常")],-1)),s[522]||(s[522]=r("p",null,"这里的BlockException包含多个不同的子类：",-1)),s[523]||(s[523]=r("table",null,[r("thead",null,[r("tr",null,[r("th",null,[r("strong",null,"异常")]),r("th",null,[r("strong",null,"说明")])])]),r("tbody",null,[r("tr",null,[r("td",null,"FlowException"),r("td",null,"限流异常")]),r("tr",null,[r("td",null,"ParamFlowException"),r("td",null,"热点参数限流的异常")]),r("tr",null,[r("td",null,"DegradeException"),r("td",null,"降级异常")]),r("tr",null,[r("td",null,"AuthorityException"),r("td",null,"授权规则异常")]),r("tr",null,[r("td",null,"SystemBlockException"),r("td",null,"系统规则异常")])])],-1)),s[524]||(s[524]=r("h4",{id:"_4-2-2-自定义异常处理",tabindex:"-1"},[g("4.2.2 自定义异常处理 "),r("a",{class:"header-anchor",href:"#_4-2-2-自定义异常处理","aria-label":'Permalink to "4.2.2 自定义异常处理"'},"​")],-1)),s[525]||(s[525]=r("p",null,"下面，我们就在order-service定义一个自定义异常处理类：",-1)),s[526]||(s[526]=r("div",{class:"language-java max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.order.sentinel;")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.slots.block.BlockException;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.slots.block.authority.AuthorityException;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.slots.block.degrade.DegradeException;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.slots.block.flow.FlowException;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," javax.servlet.http.HttpServletRequest;")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," javax.servlet.http.HttpServletResponse;")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SentinelExceptionHandler"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BlockExceptionHandler"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handle"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),r("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),r("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", BlockException "),r("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String msg "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "未知异常"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," status "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 429"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"instanceof"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," FlowException) {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            msg "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "请求被限流了"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"instanceof"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ParamFlowException) {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            msg "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "请求被热点参数限流"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"instanceof"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DegradeException) {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            msg "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "请求被降级了"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"instanceof"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AuthorityException) {")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            msg "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "没有权限访问"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            status "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 401"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),g("\n"),r("span",{class:"line"}),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        response."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setContentType"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"application/json;charset=utf-8"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        response."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStatus"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(status);")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        response."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWriter"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"{'),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"msg"),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},': "'),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ", '),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"status"),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},': "'),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," status "),r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "}"'),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[527]||(s[527]=r("p",null,"重启测试，在不同场景下，会返回不同的异常消息.",-1)),s[528]||(s[528]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025422264.png",alt:"image-20251208025422264",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[529]||(s[529]=r("hr",null,null,-1)),s[530]||(s[530]=r("h2",{id:"_5-规则持久化",tabindex:"-1"},[g("5. 规则持久化 "),r("a",{class:"header-anchor",href:"#_5-规则持久化","aria-label":'Permalink to "5. 规则持久化"'},"​")],-1)),s[531]||(s[531]=r("p",null,"现在，sentinel的所有规则都是内存存储，重启后所有规则都会丢失。在生产环境下，我们必须确保这些规则的持久化，避免丢失。",-1)),s[532]||(s[532]=r("h3",{id:"_5-1-规则管理模式",tabindex:"-1"},[g("5.1 规则管理模式 "),r("a",{class:"header-anchor",href:"#_5-1-规则管理模式","aria-label":'Permalink to "5.1 规则管理模式"'},"​")],-1)),s[533]||(s[533]=r("p",null,"规则是否能持久化，取决于规则管理模式，sentinel支持三种规则管理模式：",-1)),s[534]||(s[534]=r("ul",null,[r("li",null,"原始模式：Sentinel的默认模式，将规则保存在内存，重启服务会丢失。"),r("li",null,"pull模式"),r("li",null,"push模式")],-1)),s[535]||(s[535]=r("h4",{id:"_5-1-1-pull模式",tabindex:"-1"},[g("5.1.1 pull模式 "),r("a",{class:"header-anchor",href:"#_5-1-1-pull模式","aria-label":'Permalink to "5.1.1 pull模式"'},"​")],-1)),s[536]||(s[536]=r("p",null,"pull模式：控制台将配置的规则推送到Sentinel客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。",-1)),s[537]||(s[537]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025448053.png",alt:"image-20251208025448053",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[538]||(s[538]=r("h4",{id:"_5-1-2-push模式",tabindex:"-1"},[g("5.1.2 push模式 "),r("a",{class:"header-anchor",href:"#_5-1-2-push模式","aria-label":'Permalink to "5.1.2 push模式"'},"​")],-1)),s[539]||(s[539]=r("p",null,"push模式：控制台将配置规则推送到远程配置中心，例如Nacos。Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置更新。",-1)),s[540]||(s[540]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025458264.png",alt:"image-20251208025458264",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[541]||(s[541]=r("h3",{id:"_5-2-实现push模式",tabindex:"-1"},[g("5.2 实现push模式 "),r("a",{class:"header-anchor",href:"#_5-2-实现push模式","aria-label":'Permalink to "5.2 实现push模式"'},"​")],-1)),s[542]||(s[542]=r("h4",{id:"一、修改order-service服务",tabindex:"-1"},[g("一、修改order-service服务 "),r("a",{class:"header-anchor",href:"#一、修改order-service服务","aria-label":'Permalink to "一、修改order-service服务"'},"​")],-1)),s[543]||(s[543]=r("p",null,"修改OrderService，让其监听Nacos中的sentinel规则配置。",-1)),s[544]||(s[544]=r("p",null,"具体步骤如下：",-1)),s[545]||(s[545]=r("h5",{id:"_1-引入依赖",tabindex:"-1"},[g("1. 引入依赖 "),r("a",{class:"header-anchor",href:"#_1-引入依赖","aria-label":'Permalink to "1. 引入依赖"'},"​")],-1)),s[546]||(s[546]=r("p",null,"在order-service中引入sentinel监听nacos的依赖：",-1)),s[547]||(s[547]=r("div",{class:"language-xml max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"xml"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.alibaba.csp</"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">sentinel-datasource-nacos</"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[548]||(s[548]=r("h5",{id:"_2-配置nacos地址",tabindex:"-1"},[g("2. 配置nacos地址 "),r("a",{class:"header-anchor",href:"#_2-配置nacos地址","aria-label":'Permalink to "2. 配置nacos地址"'},"​")],-1)),s[549]||(s[549]=r("p",null,"在order-service中的application.yml文件配置nacos地址及监听的配置信息：",-1)),s[550]||(s[550]=r("div",{class:"language-yaml max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"yaml"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    sentinel"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      datasource"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        flow"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          nacos"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"            server-addr"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"localhost:8848"),r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # nacos地址")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"            dataId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"orderservice-flow-rules")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"            groupId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"SENTINEL_GROUP")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"            rule-type"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"flow"),r("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 还可以是：degrade、authority、param-flow")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[551]||(s[551]=r("h4",{id:"二、修改sentinel-dashboard源码",tabindex:"-1"},[g("二、修改sentinel-dashboard源码 "),r("a",{class:"header-anchor",href:"#二、修改sentinel-dashboard源码","aria-label":'Permalink to "二、修改sentinel-dashboard源码"'},"​")],-1)),s[552]||(s[552]=r("p",null,"SentinelDashboard默认不支持nacos的持久化，需要修改源码。",-1)),s[553]||(s[553]=r("h5",{id:"_1-解压",tabindex:"-1"},[g("1. 解压 "),r("a",{class:"header-anchor",href:"#_1-解压","aria-label":'Permalink to "1. 解压"'},"​")],-1)),s[554]||(s[554]=r("p",null,"解压课前资料中的sentinel源码包：",-1)),s[555]||(s[555]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618201340086.png",alt:"image-20210618201340086",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[556]||(s[556]=r("p",null,"然后并用IDEA打开这个项目，结构如下：",-1)),s[557]||(s[557]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618201412878.png",alt:"image-20210618201412878",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[558]||(s[558]=r("h5",{id:"_2-修改nacos依赖",tabindex:"-1"},[g("2. 修改nacos依赖 "),r("a",{class:"header-anchor",href:"#_2-修改nacos依赖","aria-label":'Permalink to "2. 修改nacos依赖"'},"​")],-1)),s[559]||(s[559]=r("p",null,"在sentinel-dashboard源码的pom文件中，nacos的依赖默认的scope是test，只能在测试时使用，这里要去除：",-1)),s[560]||(s[560]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618201607831.png",alt:"image-20210618201607831",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[561]||(s[561]=r("p",null,"将sentinel-datasource-nacos依赖的scope去掉：",-1)),s[562]||(s[562]=r("div",{class:"language-xml max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"xml"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.alibaba.csp</"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">sentinel-datasource-nacos</"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),g("\n"),r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),r("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[563]||(s[563]=r("h5",{id:"_3-添加nacos支持",tabindex:"-1"},[g("3. 添加nacos支持 "),r("a",{class:"header-anchor",href:"#_3-添加nacos支持","aria-label":'Permalink to "3. 添加nacos支持"'},"​")],-1)),s[564]||(s[564]=r("p",null,"在sentinel-dashboard的test包下，已经编写了对nacos的支持，我们需要将其拷贝到main下。",-1)),s[565]||(s[565]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618201726280.png",alt:"image-20210618201726280",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[566]||(s[566]=r("h5",{id:"_4-修改nacos地址",tabindex:"-1"},[g("4. 修改nacos地址 "),r("a",{class:"header-anchor",href:"#_4-修改nacos地址","aria-label":'Permalink to "4. 修改nacos地址"'},"​")],-1)),s[567]||(s[567]=r("p",null,"然后，还需要修改测试代码中的NacosConfig类：",-1)),s[568]||(s[568]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618201912078.png",alt:"image-20210618201912078",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[569]||(s[569]=r("p",null,"修改其中的nacos地址，让其读取application.properties中的配置：",-1)),s[570]||(s[570]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202047575.png",alt:"image-20210618202047575",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[571]||(s[571]=r("p",null,"在sentinel-dashboard的application.properties中添加nacos地址配置：",-1)),s[572]||(s[572]=r("div",{class:"language-properties max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"properties"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"nacos.addr"),r("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=localhost:8848")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[573]||(s[573]=r("h5",{id:"_5-配置nacos数据源",tabindex:"-1"},[g("5. 配置nacos数据源 "),r("a",{class:"header-anchor",href:"#_5-配置nacos数据源","aria-label":'Permalink to "5. 配置nacos数据源"'},"​")],-1)),s[574]||(s[574]=r("p",null,"另外，还需要修改com.alibaba.csp.sentinel.dashboard.controller.v2包下的FlowControllerV2类：",-1)),s[575]||(s[575]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202322301.png",alt:"image-20210618202322301",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[576]||(s[576]=r("p",null,"让我们添加的Nacos数据源生效：",-1)),s[577]||(s[577]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202334536.png",alt:"image-20210618202334536",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[578]||(s[578]=r("h5",{id:"_6-修改前端页面",tabindex:"-1"},[g("6. 修改前端页面 "),r("a",{class:"header-anchor",href:"#_6-修改前端页面","aria-label":'Permalink to "6. 修改前端页面"'},"​")],-1)),s[579]||(s[579]=r("p",null,"接下来，还要修改前端页面，添加一个支持nacos的菜单。",-1)),s[580]||(s[580]=r("p",null,"修改src/main/webapp/resources/app/scripts/directives/sidebar/目录下的sidebar.html文件：",-1)),s[581]||(s[581]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202433356.png",alt:"image-20210618202433356",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[582]||(s[582]=r("p",null,"将其中的这部分注释打开：",-1)),s[583]||(s[583]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202449881.png",alt:"image-20210618202449881",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[584]||(s[584]=r("p",null,"修改其中的文本：",-1)),s[585]||(s[585]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202501928.png",alt:"image-20210618202501928",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[586]||(s[586]=r("h5",{id:"_7-重新编译、打包项目",tabindex:"-1"},[g("7. 重新编译、打包项目 "),r("a",{class:"header-anchor",href:"#_7-重新编译、打包项目","aria-label":'Permalink to "7. 重新编译、打包项目"'},"​")],-1)),s[587]||(s[587]=r("p",null,"运行IDEA中的maven插件，编译和打包修改好的Sentinel-Dashboard：",-1)),s[588]||(s[588]=r("figure",null,[r("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202701492.png",alt:"image-20210618202701492",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[589]||(s[589]=r("h5",{id:"_8-启动",tabindex:"-1"},[g("8. 启动 "),r("a",{class:"header-anchor",href:"#_8-启动","aria-label":'Permalink to "8. 启动"'},"​")],-1)),s[590]||(s[590]=r("p",null,"启动方式跟官方一样：",-1)),s[591]||(s[591]=r("div",{class:"language-sh max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"sh"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"java"),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -jar"),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," sentinel-dashboard.jar")])])]),r("button",{class:"code-block-unfold-btn"})],-1)),s[592]||(s[592]=r("p",null,"如果要修改nacos地址，需要添加参数：",-1)),s[593]||(s[593]=r("div",{class:"language-sh max-h-300px"},[r("button",{title:"Copy code",class:"copy"}),r("span",{class:"lang"},"sh"),r("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[r("code",{"v-pre":""},[r("span",{class:"line"},[r("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"java"),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -jar"),r("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Dnacos.addr=localhost:8848"),r("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," sentinel-dashboard.jar")])])]),r("button",{class:"code-block-unfold-btn"})],-1))]),"main-header":e(()=>[t(l.$slots,"main-header")]),"main-header-after":e(()=>[t(l.$slots,"main-header-after")]),"main-nav":e(()=>[t(l.$slots,"main-nav")]),"main-content-before":e(()=>[t(l.$slots,"main-content-before")]),"main-content":e(()=>[t(l.$slots,"main-content")]),"main-content-after":e(()=>[t(l.$slots,"main-content-after")]),"main-nav-before":e(()=>[t(l.$slots,"main-nav-before")]),"main-nav-after":e(()=>[t(l.$slots,"main-nav-after")]),comment:e(()=>[t(l.$slots,"comment")]),footer:e(()=>[t(l.$slots,"footer")]),aside:e(()=>[t(l.$slots,"aside")]),"aside-custom":e(()=>[t(l.$slots,"aside-custom")]),default:e(()=>[t(l.$slots,"default")]),_:3},8,["frontmatter"])}}};export{o as default,c as usePageData};
