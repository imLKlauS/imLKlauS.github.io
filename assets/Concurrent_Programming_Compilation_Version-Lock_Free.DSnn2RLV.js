import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang.DIRfvFTX.js";import{f as s,a as l,u as a}from"./chunks/vue-router.CUoMWEs_.js";import{N as h,$ as k,Q as t,R as n,V as e,W as E,u as p,O as r,D as d}from"./framework.CXYGarVr.js";import"./app.DLZw5Wnn.js";import"./chunks/dayjs.luRsnflP.js";import"./chunks/vue-i18n.BXFR_gsM.js";import"./chunks/nprogress.D_IOsJtP.js";import"./chunks/pinia.Dy_Ta77g.js";import"./chunks/@vueuse/motion.DjOBw7pe.js";import"./YunComment.vue_vue_type_style_index_0_lang.bMvkSx9e.js";import"./index.TQnGKZgq.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.REEBqsfl.js";import"./post.CRwXEgtn.js";const g=s("/posts/Concurrent_Programming_Compilation_Version-Lock_Free",(async i=>JSON.parse('{"title":"并发编程整理版-无锁","description":"","frontmatter":{"cover":"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/Saber_Alter.png","title":"并发编程整理版-无锁","top":301,"author":"imklaus","tags":["CAS","Atomic","volatile","LongAdder","Unsafe","final","ThreadLocal"],"categories":"Java","date":"2023-8-24 18:49:36","outline":"deep","postTitleClass":"text-#FF8EB3","excerpt_type":"html","end":false},"headers":[{"level":2,"title":"无锁","slug":"无锁","link":"#无锁","children":[{"level":3,"title":"CAS","slug":"cas","link":"#cas","children":[]},{"level":3,"title":"Atomic","slug":"atomic","link":"#atomic","children":[]},{"level":3,"title":"Adder","slug":"adder","link":"#adder","children":[]},{"level":3,"title":"ABA","slug":"aba","link":"#aba","children":[]},{"level":3,"title":"Unsafe","slug":"unsafe","link":"#unsafe","children":[]},{"level":3,"title":"final","slug":"final","link":"#final","children":[]},{"level":3,"title":"State","slug":"state","link":"#state","children":[]},{"level":3,"title":"Local","slug":"local","link":"#local","children":[]}]}],"relativePath":"pages/posts/Concurrent_Programming_Compilation_Version-Lock_Free.md","lastUpdated":null}')),{lazy:(i,s)=>i.name===s.name}),y={__name:"Concurrent_Programming_Compilation_Version-Lock_Free",setup(s,{expose:y}){var c;const{data:F}=g(),A=a(),o=l(),D=Object.assign(o.meta.frontmatter||{},(null==(c=F.value)?void 0:c.frontmatter)||{});o.meta.frontmatter=D,A.currentRoute.value.data=F.value,d("valaxy:frontmatter",D),globalThis.$frontmatter=D;return y({frontmatter:{cover:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/Saber_Alter.png",title:"并发编程整理版-无锁",top:301,author:"imklaus",tags:["CAS","Atomic","volatile","LongAdder","Unsafe","final","ThreadLocal"],categories:"Java",date:"2023-8-24 18:49:36",outline:"deep",postTitleClass:"text-#FF8EB3",excerpt_type:"html",end:!1}}),(s,l)=>{const a=i;return r(),h(a,{frontmatter:p(D)},{"main-content-md":k((()=>[l[0]||(l[0]=n("p",null,[E("参考视频："),n("a",{href:"https://www.bilibili.com/video/BV16J411h7Rd",target:"_blank",rel:"noreferrer"},"满神JUC并发编程全套教程")],-1)),l[1]||(l[1]=n("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),e(" more "),l[2]||(l[2]=n("h2",{id:"无锁",tabindex:"-1"},[E("无锁 "),n("a",{class:"header-anchor",href:"#无锁","aria-label":'Permalink to "无锁"'},"​")],-1)),l[3]||(l[3]=n("h3",{id:"cas",tabindex:"-1"},[E("CAS "),n("a",{class:"header-anchor",href:"#cas","aria-label":'Permalink to "CAS"'},"​")],-1)),l[4]||(l[4]=n("h4",{id:"例子",tabindex:"-1"},[E("例子 "),n("a",{class:"header-anchor",href:"#例子","aria-label":'Permalink to "例子"'},"​")],-1)),l[5]||(l[5]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"interface"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Account"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\tInteger "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBalance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tvoid"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," withdraw"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Integer "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"amount"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t/**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作     ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t * 如果初始余额为 10000 那么正确的结果应当是 0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tstatic"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," demo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Account "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"account"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\tList<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Thread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ts "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\tlong"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," start "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nanoTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\tfor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1000"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\tts."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Thread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t\taccount."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"withdraw"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t}));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\tts."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"forEach"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Thread"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"start);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\tts."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"forEach"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(t "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\ttry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t\tt."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"join"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t} "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (InterruptedException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t\te."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"printStackTrace"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t});")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\tlong"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," end "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nanoTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\tSystem.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(account."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBalance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' " cost: "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (end "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," start) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1000_000"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' " ms"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//线程不安全的做法")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AccountUnsafe"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Account"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tprivate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer balance;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tpublic"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AccountUnsafe"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Integer "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"balance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\t\tthis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".balance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," balance;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tpublic"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBalance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\treturn"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".balance;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tpublic"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," synchronized"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," withdraw"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Integer "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"amount"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\tbalance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," amount;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tpublic"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"args"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\tAccount."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"demo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AccountUnsafe"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10000"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\tAccount."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"demo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AccountCas"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10000"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//线程安全的做法")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AccountCas"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Account"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t//使用原子整数")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tprivate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AtomicInteger balance;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tpublic"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AccountCas"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," balance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\t\tthis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".balance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AtomicInteger"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(balance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tpublic"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBalance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t//得到原子整数的值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\treturn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," balance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tpublic"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," withdraw"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Integer "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"amount"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 需要不断尝试，直到成功为止")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 比如拿到了旧值 1000")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prev "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," balance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 在这个基础上 1000-10 = 990")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," next "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prev "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," amount;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            /*")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            compareAndSet 正是做这个检查，在 set 前，先比较 prev 与当前值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            - 不一致了，next 作废，返回 false 表示失败")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            比如，别的线程已经做了减法，当前值已经被减成了 990")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            那么本线程的这次 990 就作废了，进入 while 下次循环重试")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            - 一致，以 next 设置为新值，返回 true 表示成功")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\tif"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(balance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(prev, next)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\t\tbreak"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[6]||(l[6]=n("p",null,[E("前面看到的 AtomicInteger 通过无锁解决线程安全问题，内部并没有用锁来保护共享变量的线程安全。那么它是如何实现的呢？其中的"),n("strong",null,"关键是 compareAndSet"),E("（比较并设置值），它的"),n("strong",null,"简称就是 CAS"),E(" （也有 Compare And Swap 的说法），它必须是"),n("strong",null,"原子操作"),E("。")],-1)),l[7]||(l[7]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608145914.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[8]||(l[8]=n("p",null,[n("strong",null,"工作流程")],-1)),l[9]||(l[9]=n("ul",null,[n("li",null,[E("当一个线程要去修改Account对象中的值时，先获取值pre（调用get方法），然后再将其设置为新的值next（调用cas方法）。在调用cas方法时，会将pre与Account中的余额进行比较。 "),n("ul",null,[n("li",null,[E("如果"),n("strong",null,"两者相等"),E("，就说明该值还未被其他线程修改，此时便可以进行修改操作。")]),n("li",null,[E("如果"),n("strong",null,"两者不相等"),E("，就不设置值，重新获取值pre（调用get方法），然后再将其设置为新的值next（调用cas方法），直到修改成功为止。")])])])],-1)),l[10]||(l[10]=n("hr",null,null,-1)),l[11]||(l[11]=n("h4",{id:"原理",tabindex:"-1"},[E("原理 "),n("a",{class:"header-anchor",href:"#原理","aria-label":'Permalink to "原理"'},"​")],-1)),l[12]||(l[12]=n("p",null,"无锁编程：Lock Free",-1)),l[13]||(l[13]=n("p",null,[E("CAS 的全称是 Compare-And-Swap，是 "),n("strong",null,"CPU 并发原语")],-1)),l[14]||(l[14]=n("ul",null,[n("li",null,"CAS 并发原语体现在 Java 语言中就是 sun.misc.Unsafe 类的各个方法，调用 UnSafe 类中的 CAS 方法，JVM 会实现出 CAS 汇编指令，这是一种完全依赖于硬件的功能，实现了原子操作"),n("li",null,"CAS 是一种系统原语，原语属于操作系统范畴，是由若干条指令组成 ，用于完成某个功能的一个过程，并且原语的执行必须是连续的，执行过程中不允许被中断，所以 CAS 是一条 CPU 的原子指令，不会造成数据不一致的问题，是线程安全的")],-1)),l[15]||(l[15]=n("p",null,[E("底层原理：CAS 的底层是 "),n("code",null,"lock cmpxchg"),E(" 指令（X86 架构），在单核和多核 CPU 下都能够保证比较交换的原子性")],-1)),l[16]||(l[16]=n("ul",null,[n("li",null,[n("p",null,"程序是在单核处理器上运行，会省略 lock 前缀，单处理器自身会维护处理器内的顺序一致性，不需要 lock 前缀的内存屏障效果")]),n("li",null,[n("p",null,[E("程序是在多核处理器上运行，会为 cmpxchg 指令加上 lock 前缀。当某个核执行到带 lock 的指令时，CPU 会执行"),n("strong",null,"总线锁定或缓存锁定"),E("，将修改的变量写入到主存，这个过程不会被线程的调度机制所打断，保证了多个线程对内存操作的原子性")])])],-1)),l[17]||(l[17]=n("p",null,"作用：比较当前工作内存中的值和主物理内存中的值，如果相同则执行规定操作，否则继续比较直到主内存和工作内存的值一致为止",-1)),l[18]||(l[18]=n("hr",null,null,-1)),l[19]||(l[19]=n("h4",{id:"前提",tabindex:"-1"},[E("前提 "),n("a",{class:"header-anchor",href:"#前提","aria-label":'Permalink to "前提"'},"​")],-1)),l[20]||(l[20]=n("p",null,[n("strong",null,"CAS 必须借助 volatile"),E(" 才能读取到共享变量的新值来实现【比较并交换】的效果")],-1)),l[21]||(l[21]=n("hr",null,null,-1)),l[22]||(l[22]=n("h4",{id:"效率高",tabindex:"-1"},[n("strong",null,"效率高"),E(),n("a",{class:"header-anchor",href:"#效率高","aria-label":'Permalink to "**效率高**"'},"​")],-1)),l[23]||(l[23]=n("ul",null,[n("li",null,"无锁情况下，即使重试失败，线程始终在高速运行，没有停歇，而 synchronized 会让线程在没有获得锁的时候，发生上下文切换，进入阻塞。"),n("li",null,"打个比喻，线程就好像高速跑道上的赛车，高速运行时，速度超快，一旦发生上下文切换，就好比赛车要减速、熄火，等被唤醒又得重新打火、启动、加速… 恢复到高速运行，代价比较大"),n("li",null,[E("但无锁情况下，因为线程要保持运行，需要额外 CPU 的支持，CPU 在这里就好比高速跑道，没有额外的跑道，线程想高速运行也无从谈起，虽然不会进入阻塞，但由于没有分到时间片，仍然会进入不可运行状态，还是会导致上下文切换。（超过了CPU核心数也就没有了额外的跑道了，运行也运行不了，只能上下文切换，所以"),n("strong",null,"在线程数小于CPU核心数时用CAS是非常合适的"),E("）")])],-1)),l[24]||(l[24]=n("hr",null,null,-1)),l[25]||(l[25]=n("h4",{id:"优缺点",tabindex:"-1"},[E("优缺点 "),n("a",{class:"header-anchor",href:"#优缺点","aria-label":'Permalink to "优缺点"'},"​")],-1)),l[26]||(l[26]=n("p",null,"CAS 特点:",-1)),l[27]||(l[27]=n("ul",null,[n("li",null,[E("CAS 体现的是"),n("strong",null,"无锁并发、无阻塞并发"),E("，线程不会陷入阻塞，线程不需要频繁切换状态（上下文切换，系统调用）")]),n("li",null,"CAS 是基于乐观锁的思想")],-1)),l[28]||(l[28]=n("p",null,"CAS 缺点：",-1)),l[29]||(l[29]=n("ul",null,[n("li",null,[E("执行的是循环操作，如果比较不成功一直在循环，最差的情况某个线程一直取到的值和预期值都不一样，就会无限循环导致饥饿，"),n("strong",null,"使用 CAS 线程数不要超过 CPU 的核心数"),E("，采用分段 CAS 和自动迁移机制")]),n("li",null,[E("只能保证一个共享变量的原子操作 "),n("ul",null,[n("li",null,"对于一个共享变量执行操作时，可以通过循环 CAS 的方式来保证原子操作"),n("li",null,[E("对于多个共享变量操作时，循环 CAS 就无法保证操作的原子性，这个时候"),n("strong",null,"只能用锁来保证原子性")])])]),n("li",null,"引出来 ABA 问题")],-1)),l[30]||(l[30]=n("hr",null,null,-1)),l[31]||(l[31]=n("h4",{id:"乐观锁",tabindex:"-1"},[E("乐观锁 "),n("a",{class:"header-anchor",href:"#乐观锁","aria-label":'Permalink to "乐观锁"'},"​")],-1)),l[32]||(l[32]=n("p",null,"CAS 与 synchronized 总结：",-1)),l[33]||(l[33]=n("ul",null,[n("li",null,"synchronized 是从悲观的角度出发：总是假设最坏的情况，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会阻塞（共享资源每次只给一个线程使用，其它线程阻塞，用完后再把资源转让给其它线程），因此 synchronized 也称之为悲观锁，ReentrantLock 也是一种悲观锁，性能较差"),n("li",null,[E("CAS 是从乐观的角度出发：总是假设最好的情况，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据。"),n("strong",null,"如果别人修改过，则获取现在最新的值，如果别人没修改过，直接修改共享数据的值"),E("，CAS 这种机制也称之为乐观锁，综合性能较好")])],-1)),l[34]||(l[34]=n("hr",null,null,-1)),l[35]||(l[35]=n("h3",{id:"atomic",tabindex:"-1"},[E("Atomic "),n("a",{class:"header-anchor",href:"#atomic","aria-label":'Permalink to "Atomic"'},"​")],-1)),l[36]||(l[36]=n("h4",{id:"常用api",tabindex:"-1"},[E("常用API "),n("a",{class:"header-anchor",href:"#常用api","aria-label":'Permalink to "常用API"'},"​")],-1)),l[37]||(l[37]=n("p",null,"常见原子类：AtomicInteger、AtomicBoolean、AtomicLong",-1)),l[38]||(l[38]=n("p",null,"构造方法：",-1)),l[39]||(l[39]=n("ul",null,[n("li",null,[n("code",null,"public AtomicInteger()"),E("：初始化一个默认值为 0 的原子型 Integer")]),n("li",null,[n("code",null,"public AtomicInteger(int initialValue)"),E("：初始化一个指定值的原子型 Integer")])],-1)),l[40]||(l[40]=n("p",null,"常用API：",-1)),l[41]||(l[41]=n("table",null,[n("thead",null,[n("tr",null,[n("th",null,"方法"),n("th",null,"作用")])]),n("tbody",null,[n("tr",null,[n("td",null,"public final int get()"),n("td",null,"获取 AtomicInteger 的值")]),n("tr",null,[n("td",null,"public final int getAndIncrement()"),n("td",null,"以原子方式将当前值加 1，返回的是自增前的值")]),n("tr",null,[n("td",null,"public final int incrementAndGet()"),n("td",null,"以原子方式将当前值加 1，返回的是自增后的值")]),n("tr",null,[n("td",null,"public final int getAndSet(int value)"),n("td",null,"以原子方式设置为 newValue 的值，返回旧值")]),n("tr",null,[n("td",null,"public final int addAndGet(int data)"),n("td",null,[E("以原子方式将输入的数值与实例中的值相加并返回"),n("br"),E("实例：AtomicInteger 里的 value")])])])],-1)),l[42]||(l[42]=n("hr",null,null,-1)),l[43]||(l[43]=n("h4",{id:"原理分析",tabindex:"-1"},[E("原理分析 "),n("a",{class:"header-anchor",href:"#原理分析","aria-label":'Permalink to "原理分析"'},"​")],-1)),l[44]||(l[44]=n("p",null,[n("strong",null,"AtomicInteger 原理"),E("：自旋锁 + CAS 算法")],-1)),l[45]||(l[45]=n("p",null,"CAS 算法：有 3 个操作数（内存值 V， 旧的预期值 A，要修改的值 B）",-1)),l[46]||(l[46]=n("ul",null,[n("li",null,"当旧的预期值 A == 内存值 V 此时可以修改，将 V 改为 B"),n("li",null,"当旧的预期值 A != 内存值 V 此时不能修改，并重新获取现在的最新值，重新获取的动作就是自旋")],-1)),l[47]||(l[47]=n("p",null,"分析 getAndSet 方法：",-1)),l[48]||(l[48]=n("ul",null,[n("li",null,[n("p",null,"AtomicInteger："),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," newValue) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    * this: \t\t当前对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    * valueOffset:\t内存偏移量，内存地址")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," unsafe."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAndSetInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", valueOffset, newValue);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})]),n("p",null,"valueOffset：偏移量表示该变量值相对于当前对象地址的偏移，Unsafe 就是根据内存偏移地址获取数据"),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"valueOffset "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," unsafe.objectFieldOffset")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                (AtomicInteger.class."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeclaredField"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"value"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//调用本地方法   --\x3e")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," native"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," objectFieldOffset"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Field var1);")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,"unsafe 类："),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// val1: AtomicInteger对象本身，var2: 该对象值得引用地址，var4: 需要变动的数")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getAndSetInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Object var1, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," var2, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," var4) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," var5;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    do"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // var5: 用 var1 和 var2 找到的内存中的真实值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        var5 "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIntVolatile"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(var1, var2);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSwapInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(var1, var2, var5, var4));")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," var5;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})]),n("p",null,[E("var5：从主内存中拷贝到工作内存中的值（每次都要从主内存拿到最新的值到本地内存），然后执行 "),n("code",null,"compareAndSwapInt()"),E(" 再和主内存的值进行比较，假设方法返回 false，那么就一直执行 while 方法，直到期望的值和真实值一样，修改数据")])]),n("li",null,[n("p",null,[E("变量 value 用 volatile 修饰，保证了多线程之间的内存可见性，避免线程从"),n("strong",null,"工作缓存"),E("中获取失效的变量")]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," volatile"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," value")])])]),n("button",{class:"collapse"})]),n("p",null,[n("strong",null,"CAS 必须借助 volatile 才能读取到共享变量的最新值来实现比较并交换的效果")]),n("blockquote",null,[n("p",null,"在计算机系统中，缓存（cache）是一种存储数据的临时存储器，用于加快数据的访问速度。缓存通常位于CPU和主存之间，用于存储最近或频繁访问的数据，以避免频繁访问主存所带来的延迟。"),n("p",null,"当一个变量被读取或写入时，CPU会首先在缓存中查找该变量的值。如果在缓存中找到了相应的值（即命中缓存），CPU就无需访问主存，从而加快了数据访问速度。但是，当不同的线程同时访问同一个变量时，由于缓存是每个CPU核心独立的，其中的数据可能并不是最新的，这就可能导致线程间的数据不一致性。"),n("p",null,"所以，volatile关键字可以告诉CPU每次访问该变量都要从内存中读取最新的值，而不是从缓存中读取，从而保证了该变量对所有线程的可见性。")])])],-1)),l[49]||(l[49]=n("p",null,"分析 getAndUpdate 方法：",-1)),l[50]||(l[50]=n("ul",null,[n("li",null,[n("p",null,"getAndUpdate："),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getAndUpdate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(IntUnaryOperator updateFunction) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prev, next;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    do"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        prev "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//当前值，cas的期望值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        next "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," updateFunction."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"applyAsInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(prev);"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//期望值更新到该值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(prev, next));"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//自旋")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prev;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})]),n("p",null,"模仿："),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] args) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    AtomicInteger i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AtomicInteger"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"updateAndGet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i, p "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," p "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," updateAndGet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(AtomicInteger i, IntUnaryOperator operator) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prev "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," next "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," operator."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"applyAsInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(prev);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (i."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(prev, next)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," next;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"collapse"})]),n("p",null,"函数式接口：可以自定义操作逻辑"),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"AtomicInteger a "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AtomicInteger"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"a."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAndUpdate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,"compareAndSet："),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," expect, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," update) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    * this: \t\t当前对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    * valueOffset:\t内存偏移量，内存地址")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    * expect:\t\t期望的值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    * update: \t\t更新的值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," unsafe."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSwapInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", valueOffset, expect, update);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])])],-1)),l[51]||(l[51]=n("hr",null,null,-1)),l[52]||(l[52]=n("h4",{id:"原子引用",tabindex:"-1"},[E("原子引用 "),n("a",{class:"header-anchor",href:"#原子引用","aria-label":'Permalink to "原子引用"'},"​")],-1)),l[53]||(l[53]=n("p",null,"原子引用：对 Object 进行原子操作，提供一种读和写都是原子性的对象引用变量",-1)),l[54]||(l[54]=n("p",null,"原子引用类：AtomicReference、AtomicStampedReference、AtomicMarkableReference",-1)),l[55]||(l[55]=n("p",null,"AtomicReference 类：",-1)),l[56]||(l[56]=n("ul",null,[n("li",null,[n("p",null,"构造方法："),n("ul",null,[n("li",null,[n("p",null,[n("code",null,"public AtomicReference(V initialValue)"),E("：初始化一个指定值的原子引用")])]),n("li",null,[n("p",null,[n("code",null,"public AtomicReference()"),E("：初始化一个默认值为 null 的原子引用")])])])]),n("li",null,[n("p",null,"常用 API："),n("ul",null,[n("li",null,[n("code",null,"public final boolean compareAndSet(V expectedValue, V newValue)"),E("：CAS 操作")]),n("li",null,[n("code",null,"public final void set(V newValue)"),E("：将值设置为 newValue")]),n("li",null,[n("code",null,"public final V get()"),E("：返回当前值")])])])],-1)),l[57]||(l[57]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AtomicReferenceDemo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"args"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Student s1 "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Student"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"33"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"z3"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建原子引用包装类")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        AtomicReference<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Student"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> atomicReference "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AtomicReference<>();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置主内存共享变量为s1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        atomicReference."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(s1);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 比较并交换，如果现在主物理内存的值为 z3，那么交换成 l4")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Student s2 "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Student"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"44"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"l4"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (atomicReference."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(s1, s2)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                break"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(atomicReference."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Student"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String name;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //。。。。")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[58]||(l[58]=n("hr",null,null,-1)),l[59]||(l[59]=n("h4",{id:"原子数组",tabindex:"-1"},[E("原子数组 "),n("a",{class:"header-anchor",href:"#原子数组","aria-label":'Permalink to "原子数组"'},"​")],-1)),l[60]||(l[60]=n("p",null,"原子数组类：AtomicIntegerArray、AtomicLongArray、AtomicReferenceArray",-1)),l[61]||(l[61]=n("p",null,"AtomicIntegerArray 类方法：",-1)),l[62]||(l[62]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"*   i\t\tthe index")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"* expect \tthe expected value")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"* update \tthe new value")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"*/")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," expect, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," update) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," compareAndSetRaw"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkedByteOffset"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i), expect, update);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[63]||(l[63]=n("hr",null,null,-1)),l[64]||(l[64]=n("h4",{id:"原子更新器",tabindex:"-1"},[E("原子更新器 "),n("a",{class:"header-anchor",href:"#原子更新器","aria-label":'Permalink to "原子更新器"'},"​")],-1)),l[65]||(l[65]=n("p",null,"原子更新器类：AtomicReferenceFieldUpdater、AtomicIntegerFieldUpdater、AtomicLongFieldUpdater",-1)),l[66]||(l[66]=n("p",null,[E("利用字段更新器，可以针对对象的某个域（Field）进行原子操作，只能配合 volatile 修饰的字段使用，否则会出现异常 "),n("code",null,"IllegalArgumentException: Must be volatile type")],-1)),l[67]||(l[67]=n("p",null,"常用 API：",-1)),l[68]||(l[68]=n("ul",null,[n("li",null,[n("code",null,"static <U> AtomicIntegerFieldUpdater<U> newUpdater(Class<U> c, String fieldName)"),E("：静态方法")]),n("li",null,[n("code",null,"abstract boolean compareAndSet(T obj, int expect, int update)"),E("：CAS")])],-1)),l[69]||(l[69]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UpdateDemo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," volatile"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," field;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"args"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        AtomicIntegerFieldUpdater fieldUpdater "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AtomicIntegerFieldUpdater")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            \t\t."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newUpdater"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UpdateDemo.class, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"field"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UpdateDemo updateDemo "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UpdateDemo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        fieldUpdater."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(updateDemo, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(updateDemo.field);"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//10")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[70]||(l[70]=n("hr",null,null,-1)),l[71]||(l[71]=n("h4",{id:"原子累加器",tabindex:"-1"},[E("原子累加器 "),n("a",{class:"header-anchor",href:"#原子累加器","aria-label":'Permalink to "原子累加器"'},"​")],-1)),l[72]||(l[72]=n("p",null,"原子累加器类：LongAdder、DoubleAdder、LongAccumulator、DoubleAccumulator",-1)),l[73]||(l[73]=n("p",null,"LongAdder 和 LongAccumulator 区别：",-1)),l[74]||(l[74]=n("p",null,"相同点：",-1)),l[75]||(l[75]=n("ul",null,[n("li",null,"LongAdder 与 LongAccumulator 类都是使用非阻塞算法 CAS 实现的"),n("li",null,"LongAdder 类是 LongAccumulator 类的一个特例，只是 LongAccumulator 提供了更强大的功能，可以自定义累加规则，当accumulatorFunction 为 null 时就等价于 LongAdder")],-1)),l[76]||(l[76]=n("p",null,"不同点：",-1)),l[77]||(l[77]=n("ul",null,[n("li",null,[n("p",null,"调用 casBase 时，LongAccumulator 使用 function.applyAsLong(b = base, x) 来计算，LongAdder 使用 casBase(b = base, b + x)")]),n("li",null,[n("p",null,"LongAccumulator 类功能更加强大，构造方法参数中"),n("ul",null,[n("li",null,"accumulatorFunction 是一个双目运算器接口，可以指定累加规则，比如累加或者相乘，其根据输入的两个参数返回一个计算值，LongAdder 内置累加规则"),n("li",null,"identity 则是 LongAccumulator 累加器的初始值，LongAccumulator 可以为累加器提供非0的初始值，而 LongAdder 只能提供默认的 0")])])],-1)),l[78]||(l[78]=n("hr",null,null,-1)),l[79]||(l[79]=n("h3",{id:"adder",tabindex:"-1"},[E("Adder "),n("a",{class:"header-anchor",href:"#adder","aria-label":'Permalink to "Adder"'},"​")],-1)),l[80]||(l[80]=n("h4",{id:"优化机制",tabindex:"-1"},[E("优化机制 "),n("a",{class:"header-anchor",href:"#优化机制","aria-label":'Permalink to "优化机制"'},"​")],-1)),l[81]||(l[81]=n("p",null,"LongAdder 是 Java8 提供的类，跟 AtomicLong 有相同的效果，但对 CAS 机制进行了优化，尝试使用分段 CAS 以及自动分段迁移的方式来大幅度提升多线程高并发执行 CAS 操作的性能",-1)),l[82]||(l[82]=n("p",null,[E("CAS 底层实现是在一个循环中不断地尝试修改目标值，直到修改成功。如果竞争不激烈修改成功率很高，否则失败率很高，失败后这些重复的原子性操作会耗费性能（导致大量线程"),n("strong",null,"空循环，自旋转"),E("）")],-1)),l[83]||(l[83]=n("p",null,[E("优化核心思想：数据分离，将 AtomicLong 的"),n("strong",null,"单点的更新压力分担到各个节点，空间换时间"),E("，在低并发的时候直接更新，可以保障和 AtomicLong 的性能基本一致，而在高并发的时候通过分散减少竞争，提高了性能")],-1)),l[84]||(l[84]=n("p",null,[n("strong",null,"分段 CAS 机制"),E("：")],-1)),l[85]||(l[85]=n("ul",null,[n("li",null,"在发生竞争时，创建 Cell 数组用于将不同线程的操作离散（通过 hash 等算法映射）到不同的节点上"),n("li",null,"设置多个累加单元（会根据需要扩容，最大为 CPU 核数），Therad-0 累加 Cell[0]，而 Thread-1 累加 Cell[1] 等，最后将结果汇总"),n("li",null,"在累加时操作的不同的 Cell 变量，因此减少了 CAS 重试失败，从而提高性能")],-1)),l[86]||(l[86]=n("p",null,[n("strong",null,"自动分段迁移机制"),E("：某个 Cell 的 value 执行 CAS 失败，就会自动寻找另一个 Cell 分段内的 value 值进行 CAS 操作")],-1)),l[87]||(l[87]=n("hr",null,null,-1)),l[88]||(l[88]=n("h4",{id:"伪共享",tabindex:"-1"},[E("伪共享 "),n("a",{class:"header-anchor",href:"#伪共享","aria-label":'Permalink to "伪共享"'},"​")],-1)),l[89]||(l[89]=n("p",null,"Cell 为累加单元：数组访问索引是通过 Thread 里的 threadLocalRandomProbe 域取模实现的，这个域是 ThreadLocalRandom 更新的",-1)),l[90]||(l[90]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// Striped64.Cell")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"sun"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".misc.Contended "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    volatile"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," value;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," x"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") { value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," x; }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 用 cas 方式进行累加, prev 表示旧值, next 表示新值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," cas"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," prev"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," next"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    \treturn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UNSAFE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSwapLong"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", valueOffset, prev, next);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 省略不重要代码")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[91]||(l[91]=n("p",null,[E("Cell 是数组形式，"),n("strong",null,"在内存中是连续存储的"),E("，64 位系统中，一个 Cell 为 24 字节（16 字节的对象头和 8 字节的 value），每一个 cache line 为 64 字节，因此缓存行可以存下 2 个的 Cell 对象，当 Core-0 要修改 Cell[0]、Core-1 要修改 Cell[1]，"),n("strong",null,"无论谁修改成功都会导致当前缓存行失效"),E("，从而导致对方的数据失效，需要重新去主存获取，影响效率")],-1)),l[92]||(l[92]=n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608150111.png",alt:"img",style:{zoom:"67%"}},null,-1)),l[93]||(l[93]=n("p",null,[E("@sun.misc.Contended：防止缓存行伪共享，在使用此注解的对象或字段的前后各增加 128 字节大小的 padding，使用 2 倍于大多数硬件缓存行让 CPU 将对象预读至缓存时"),n("strong",null,"占用不同的缓存行"),E("，这样就不会造成对方缓存行的失效")],-1)),l[94]||(l[94]=n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/20200608150119.png",alt:"img",style:{zoom:"67%"}},null,-1)),l[95]||(l[95]=n("hr",null,null,-1)),l[96]||(l[96]=n("h4",{id:"源码解析",tabindex:"-1"},[E("源码解析 "),n("a",{class:"header-anchor",href:"#源码解析","aria-label":'Permalink to "源码解析"'},"​")],-1)),l[97]||(l[97]=n("p",null,"Striped64 类成员属性：",-1)),l[98]||(l[98]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 表示当前计算机CPU数量")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NCPU "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Runtime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRuntime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"availableProcessors"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 累加单元数组, 懒惰初始化")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"transient"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," volatile"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] cells;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 基础值, 如果没有竞争, 则用 cas 累加这个域，当 cells 扩容时，也会将数据写到 base 中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"transient"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," volatile"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," base;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 在 cells 初始化或扩容时只能有一个线程执行, 通过 CAS 更新 cellsBusy 置为 1 来实现一个锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"transient"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," volatile"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cellsBusy;")])])]),n("button",{class:"collapse"})],-1)),l[99]||(l[99]=n("p",null,"工作流程：",-1)),l[100]||(l[100]=n("ul",null,[n("li",null,[n("p",null,"cells 占用内存是相对比较大的，是惰性加载的，在无竞争或者其他线程正在初始化 cells 数组的情况下，直接更新 base 域")]),n("li",null,[n("p",null,"在第一次发生竞争时（casBase 失败）会创建一个大小为 2 的 cells 数组，将当前累加的值包装为 Cell 对象，放入映射的槽位上")]),n("li",null,[n("p",null,"分段累加的过程中，如果当前线程对应的 cells 槽位为空，就会新建 Cell 填充，如果出现竞争，就会重新计算线程对应的槽位，继续自旋尝试修改")]),n("li",null,[n("p",null,[E("分段迁移后还出现竞争就会扩容 cells 数组长度为原来的两倍，然后 rehash，"),n("strong",null,"数组长度总是 2 的 n 次幂"),E("，默认最大为 CPU 核数，但是可以超过，如果核数是 6 核，数组最长是 8")])])],-1)),l[101]||(l[101]=n("p",null,"方法分析：",-1)),l[102]||(l[102]=n("ul",null,[n("li",null,[n("p",null,[n("code",null,"LongAdder#add"),E("：累加方法")]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," x) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // as 为累加单元数组的引用，b 为基础值，v 表示期望值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // m 表示 cells 数组的长度 - 1，a 表示当前线程命中的 cell 单元格")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] as; "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," b, v; "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," m; Cell a;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // cells 不为空说明 cells 已经被初始化，线程发生了竞争，去更新对应的 cell 槽位")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 进入 || 后的逻辑去更新 base 域，更新失败表示发生竞争进入条件")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((as "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cells) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," !"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"casBase"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(b "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," base, b "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," x)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // uncontended 为 true 表示 cell 没有竞争")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," uncontended "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 条件一: true 说明 cells 未初始化，多线程写 base 发生竞争需要进行初始化 cells 数组")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //\t\t  fasle 说明 cells 已经初始化，进行下一个条件寻找自己的 cell 去累加")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 条件二: getProbe() 获取 hash 值，& m 的逻辑和 HashMap 的逻辑相同，保证散列的均匀性")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // \t\t  true 说明当前线程对应下标的 cell 为空，需要创建 cell")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //        false 说明当前线程对应的 cell 不为空，进行下一个条件【将 x 值累加到对应的 cell 中】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 条件三: 有取反符号，false 说明 cas 成功，直接返回，true 说明失败，当前线程对应的 cell 有竞争")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (as "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (m "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," as.length "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            (a "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," as["),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getProbe"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," m]) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            !"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(uncontended "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," a."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cas"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(v "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," a.value, v "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," x)))")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            longAccumulate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(x, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", uncontended);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        \t// 【uncontended 在对应的 cell 上累加失败的时候才为 false，其余情况均为 true】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,[n("code",null,"Striped64")])])],-1)),l[103]||(l[103]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// Unsafe mechanics")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sun.misc.Unsafe UNSAFE;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BASE;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CELLSBUSY;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," PROBE;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UNSAFE "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sun.misc.Unsafe."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUnsafe"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Class<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> sk "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Striped64.class;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        BASE "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UNSAFE.objectFieldOffset")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            (sk."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeclaredField"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"base"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        CELLSBUSY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UNSAFE.objectFieldOffset")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            (sk."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeclaredField"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cellsBusy"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Class<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> tk "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread.class;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        PROBE "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UNSAFE.objectFieldOffset")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            (tk."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeclaredField"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"threadLocalRandomProbe"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[104]||(l[104]=n("ul",null,[n("li",null,[n("code",null,"Striped64#casBase")])],-1)),l[105]||(l[105]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * CASes the base field.")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," casBase"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cmp, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UNSAFE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSwapLong"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", BASE, cmp, val);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[106]||(l[106]=n("ul",null,[n("li",null,[n("p",null,[n("code",null,"Striped64#longAccumulate"),E("：cell 数组创建")]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// \t\t\t\t\t\t\tx  \t\t\tnull \t\t\tfalse | true")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," longAccumulate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," x, LongBinaryOperator fn, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wasUncontended) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," h;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 当前线程还没有对应的 cell, 需要随机生成一个 hash 值用来将当前线程绑定到 cell")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((h "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getProbe"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 初始化 probe，获取 hash 值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ThreadLocalRandom."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"current"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(); ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        h "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getProbe"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();\t")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 默认情况下 当前线程肯定是写入到了 cells[0] 位置，不把它当做一次真正的竞争")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        wasUncontended "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 表示【扩容意向】，false 一定不会扩容，true 可能会扩容")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," collide "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //自旋")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (;;) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // as 表示cells引用，a 表示当前线程命中的 cell，n 表示 cells 数组长度，v 表示 期望值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] as; Cell a; "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," n; "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," v;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 【CASE1】: 表示 cells 已经初始化了，当前线程应该将数据写入到对应的 cell 中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((as "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cells) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (n "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," as.length) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // CASE1.1: true 表示当前线程对应的索引下标的 Cell 为 null，需要创建 new Cell")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((a "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," as[(n "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," h]) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 判断 cellsBusy 是否被锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (cellsBusy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {   ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 创建 cell, 初始累加值为 x")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Cell r "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(x);  ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 加锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (cellsBusy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," casCellsBusy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        // 创建成功标记，进入【创建 cell 逻辑】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," created "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                            Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] rs; "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," m, j;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                            // 把当前 cells 数组赋值给 rs，并且不为 null")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((rs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cells) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                (m "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rs.length) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                                // 再次判断防止其它线程初始化过该位置，当前线程再次初始化该位置会造成数据丢失")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                                // 因为这里是线程安全的判断，进行的逻辑不会被其他线程影响")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                rs[j "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (m "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," h] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                                // 把新创建的 cell 填充至当前位置")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                rs[j] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                created "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 表示创建完成")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            cellsBusy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 解锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (created)\t\t\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// true 表示创建完成，可以推出循环了")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                            break"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        continue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                collide "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // CASE1.2: 条件成立说明线程对应的 cell 有竞争, 改变线程对应的 cell 来重试 cas")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            else"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"wasUncontended)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                wasUncontended "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // CASE 1.3: 当前线程 rehash 过，如果新命中的 cell 不为空，就尝试累加，false 说明新命中也有竞争")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            else"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (a."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cas"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(v "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," a.value, ((fn "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," v "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," x "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," fn."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"applyAsLong"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(v, x))))")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                break"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // CASE 1.4: cells 长度已经超过了最大长度 CPU 内核的数量或者已经扩容")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            else"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (n "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NCPU "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cells "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," as)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                collide "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; \t\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 扩容意向改为false，【表示不能扩容了】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // CASE 1.5: 更改扩容意向，如果 n >= NCPU，这里就永远不会执行到，case1.4 永远先于 1.5 执行")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            else"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"collide)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                collide "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // CASE 1.6: 【扩容逻辑】，进行加锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            else"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (cellsBusy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," casCellsBusy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 线程安全的检查，防止期间被其他线程扩容了")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (cells "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," as) {     ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        // 扩容为以前的 2 倍")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] rs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[n "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        // 遍历移动值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," n; "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"i)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            rs[i] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," as[i];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        // 把扩容后的引用给 cells")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        cells "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rs;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    cellsBusy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 解锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                collide "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 扩容意向改为 false，表示不扩容了")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                continue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 重置当前线程 Hash 值，这就是【分段迁移机制】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            h "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," advanceProbe"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(h);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 【CASE2】: 运行到这说明 cells 还未初始化，as 为null")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 判断是否没有加锁，没有加锁就用 CAS 加锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 条件二判断是否其它线程在当前线程给 as 赋值之后修改了 cells，这里不是线程安全的判断")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        else"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (cellsBusy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cells "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," as "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," casCellsBusy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 初始化标志，开始 【初始化 cells 数组】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," init "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," { ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"               \t// 再次判断 cells == as 防止其它线程已经提前初始化了，当前线程再次初始化导致丢失数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 因为这里是【线程安全的，重新检查，经典 DCL】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (cells "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," as) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] rs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"];\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 初始化数组大小为2")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    rs[h "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(x);\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 填充线程对应的cell")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    cells "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rs;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    init "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t\t\t\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 初始化成功，标记置为 true")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                cellsBusy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t\t\t\t\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 解锁")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (init)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                break"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t\t\t\t\t\t\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 初始化成功直接跳出自旋")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 【CASE3】: 运行到这说明其他线程在初始化 cells，当前线程将值累加到 base，累加成功直接结束自旋")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        else"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"casBase"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(v "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," base, ((fn "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," v "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," x "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                    fn."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"applyAsLong"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(v, x))))")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            break"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,[n("code",null,"LongAdder#sum"),E("：获取最终结果通过 sum 整合，"),n("strong",null,"保证最终一致性，不保证强一致性")]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," sum"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    Cell"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] as "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cells; Cell a;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sum "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," base;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (as "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 遍历 累加")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," as.length; "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"i) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((a "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," as[i]) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                sum "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," a.value;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sum;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])])],-1)),l[107]||(l[107]=n("hr",null,null,-1)),l[108]||(l[108]=n("h3",{id:"aba",tabindex:"-1"},[E("ABA "),n("a",{class:"header-anchor",href:"#aba","aria-label":'Permalink to "ABA"'},"​")],-1)),l[109]||(l[109]=n("p",null,"ABA 问题：当进行获取主内存值时，该内存值在写入主内存时已经被修改了 N 次，但是最终又改成原来的值",-1)),l[110]||(l[110]=n("p",null,[E("其他线程先把 A 改成 B 又改回 A，主线程"),n("strong",null,"仅能判断出共享变量的值与最初值 A 是否相同"),E("，不能感知到这种从 A 改为 B 又 改回 A 的情况，这时 CAS 虽然成功，但是过程存在问题")],-1)),l[111]||(l[111]=n("h4",{id:"atomicstampedreference",tabindex:"-1"},[n("strong",null,"AtomicStampedReference"),E(),n("a",{class:"header-anchor",href:"#atomicstampedreference","aria-label":'Permalink to "**AtomicStampedReference**"'},"​")],-1)),l[112]||(l[112]=n("ul",null,[n("li",null,[n("p",null,"构造方法："),n("ul",null,[n("li",null,[n("code",null,"public AtomicStampedReference(V initialRef, int initialStamp)"),E("：初始值和初始版本号")])])]),n("li",null,[n("p",null,"常用API："),n("ul",null,[n("li",null,[n("code",null," public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp)"),E("："),n("strong",null,"期望引用和期望版本号都一致"),E("才进行 CAS 修改数据")]),n("li",null,[n("code",null,"public void set(V newReference, int newStamp)"),E("：设置值和版本号")]),n("li",null,[n("code",null,"public V getReference()"),E("：返回引用的值")]),n("li",null,[n("code",null,"public int getStamp()"),E("：返回当前版本号")])])])],-1)),l[113]||(l[113]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] args) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    AtomicStampedReference<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Integer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> atomicReference "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AtomicStampedReference<>("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"100"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," startStamp "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," atomicReference."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStamp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Thread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stamp "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," atomicReference."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStamp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        atomicReference."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"100"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"101"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", stamp, stamp "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stamp "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," atomicReference."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStamp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        atomicReference."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"101"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"100"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", stamp, stamp "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    },"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"t1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"start"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Thread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (InterruptedException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"printStackTrace"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"atomicReference."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"100"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"200"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", startStamp, startStamp "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(atomicReference."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getReference"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//100")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "线程修改失败"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    },"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"t2"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"start"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[114]||(l[114]=n("hr",null,null,-1)),l[115]||(l[115]=n("h4",{id:"atomicmarkablereference",tabindex:"-1"},[E("AtomicMarkableReference "),n("a",{class:"header-anchor",href:"#atomicmarkablereference","aria-label":'Permalink to "AtomicMarkableReference"'},"​")],-1)),l[116]||(l[116]=n("p",null,[E("AtomicStampedReference 可以给原子引用加上版本号，追踪原子引用整个的变化过程，如： A -> B -> A -> C ，通过AtomicStampedReference，我们可以知道，引用变量中途被更改了几次。 但是有时候，并不关心引用变量更改了几次，只是单纯的关心"),n("strong",null,"是否更改过"),E("，所以就有了 "),n("strong",null,"AtomicMarkableReference")],-1)),l[117]||(l[117]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230714183156551.png",alt:"image-20230714183156551",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[118]||(l[118]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Slf4j"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"topic"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "c.Test38"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Test38"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"args"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," InterruptedException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        GarbageBag bag "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," GarbageBag"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"装满了垃圾"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 参数2 mark 可以看作一个标记，表示垃圾袋满了")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        AtomicMarkableReference<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GarbageBag"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ref "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AtomicMarkableReference<>(bag, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"start..."'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        GarbageBag prev "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ref."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getReference"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(prev."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Thread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"start..."'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            bag."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setDesc"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"空垃圾袋"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ref."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(bag, bag, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(bag."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        },"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"保洁阿姨"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"start"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        sleep"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"想换一只新垃圾袋？"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ref."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(prev, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," GarbageBag"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"空垃圾袋"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"), "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"换了么？"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ref."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getReference"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," GarbageBag"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String desc;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," GarbageBag"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"desc"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".desc "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," desc;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setDesc"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"desc"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".desc "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," desc;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," super"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' " "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," desc;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[119]||(l[119]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230714183338108.png",alt:"image-20230714183338108",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[120]||(l[120]=n("hr",null,null,-1)),l[121]||(l[121]=n("h4",{id:"两者的区别",tabindex:"-1"},[E("两者的区别 "),n("a",{class:"header-anchor",href:"#两者的区别","aria-label":'Permalink to "两者的区别"'},"​")],-1)),l[122]||(l[122]=n("ul",null,[n("li",null,[n("strong",null,"AtomicStampedReference"),E(" 需要我们传入"),n("strong",null,"整型变量"),E("作为版本号，来判定是否被更改过")]),n("li",null,[n("strong",null,"AtomicMarkableReference"),E("需要我们传入"),n("strong",null,"布尔变量"),E("作为标记，来判断是否被更改过")])],-1)),l[123]||(l[123]=n("hr",null,null,-1)),l[124]||(l[124]=n("h3",{id:"unsafe",tabindex:"-1"},[E("Unsafe "),n("a",{class:"header-anchor",href:"#unsafe","aria-label":'Permalink to "Unsafe"'},"​")],-1)),l[125]||(l[125]=n("p",null,"Unsafe 是 CAS 的核心类，由于 Java 无法直接访问底层系统，需要通过本地（Native）方法来访问",-1)),l[126]||(l[126]=n("p",null,[E("Unsafe 类存在 sun.misc 包，其中所有方法都是 native 修饰的，都是直接调用"),n("strong",null,"操作系统底层资源"),E("执行相应的任务，基于该类可以直接操作特定的内存数据，其内部方法操作类似 C 的指针")],-1)),l[127]||(l[127]=n("p",null,"模拟实现原子整数：",-1)),l[128]||(l[128]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] args) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    MyAtomicInteger atomicInteger "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," MyAtomicInteger"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (atomicInteger."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSwap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(atomicInteger."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," MyAtomicInteger"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Unsafe UNSAFE;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," VALUE_OFFSET;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," volatile"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," value;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //Unsafe unsafe = Unsafe.getUnsafe()这样会报错，需要反射获取")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Field theUnsafe "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Unsafe.class."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeclaredField"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"theUnsafe"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            theUnsafe."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAccessible"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            UNSAFE "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Unsafe) theUnsafe."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 获取 value 属性的内存地址，value 属性指向该地址，直接设置该地址的值可以修改 value 的值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            VALUE_OFFSET "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UNSAFE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"objectFieldOffset"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                \t\t   MyAtomicInteger.class."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeclaredField"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"value"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (NoSuchFieldException | IllegalAccessException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"printStackTrace"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," MyAtomicInteger"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," value"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," value;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," value;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," compareAndSwap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," update"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prev "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".value;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," next "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," update;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //\t\t\t\t\t\t\t当前对象  内存偏移量    期望值 更新值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (UNSAFE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSwapInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", VALUE_OFFSET, prev, update)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CAS成功"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[129]||(l[129]=n("hr",null,null,-1)),l[130]||(l[130]=n("h3",{id:"final",tabindex:"-1"},[E("final "),n("a",{class:"header-anchor",href:"#final","aria-label":'Permalink to "final"'},"​")],-1)),l[131]||(l[131]=n("h4",{id:"原理-1",tabindex:"-1"},[E("原理 "),n("a",{class:"header-anchor",href:"#原理-1","aria-label":'Permalink to "原理"'},"​")],-1)),l[132]||(l[132]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," TestFinal"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tfinal"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," a "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 20"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[133]||(l[133]=n("p",null,"字节码：",-1)),l[134]||(l[134]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," aload_0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," invokespecial #"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},' // Method java/lang/Object."<init>":()V')]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"4"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," aload_0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," bipush "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 将值直接放入栈中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"7"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," putfield #"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," \t\t// Field a:I")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<--"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 写屏障")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," return")])])]),n("button",{class:"collapse"})],-1)),l[135]||(l[135]=n("p",null,"final 变量的赋值通过 putfield 指令来完成，在这条指令之后也会加入写屏障，保证在其它线程读到它的值时不会出现为 0 的情况",-1)),l[136]||(l[136]=n("p",null,[E("其他线程访问 final 修饰的变量"),n("strong",null,"会复制一份放入栈中"),E("，效率更高")],-1)),l[137]||(l[137]=n("hr",null,null,-1)),l[138]||(l[138]=n("h4",{id:"不可变",tabindex:"-1"},[E("不可变 "),n("a",{class:"header-anchor",href:"#不可变","aria-label":'Permalink to "不可变"'},"​")],-1)),l[139]||(l[139]=n("p",null,"不可变：如果一个对象不能够修改其内部状态（属性），那么就是不可变对象",-1)),l[140]||(l[140]=n("p",null,"不可变对象线程安全的，不存在并发修改和可见性问题，是另一种避免竞争的方式",-1)),l[141]||(l[141]=n("p",null,"String 类也是不可变的，该类和类中所有属性都是 final 的",-1)),l[142]||(l[142]=n("ul",null,[n("li",null,[n("p",null,"类用 final 修饰保证了该类中的方法不能被覆盖，防止子类无意间破坏不可变性")]),n("li",null,[n("p",null,"无写入方法（set）确保外部不能对内部属性进行修改")]),n("li",null,[n("p",null,"属性用 final 修饰保证了该属性是只读的，不能修改"),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," String")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    implements"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.io."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Serializable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Comparable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">, "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"CharSequence"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /** The value is used for character storage. */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," char"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," value[];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //....")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,[E("更改 String 类数据时，会构造新字符串对象，生成新的 char[] value，通过"),n("strong",null,"创建副本对象来避免共享的方式称之为保护性拷贝")])])],-1)),l[143]||(l[143]=n("hr",null,null,-1)),l[144]||(l[144]=n("h3",{id:"state",tabindex:"-1"},[E("State "),n("a",{class:"header-anchor",href:"#state","aria-label":'Permalink to "State"'},"​")],-1)),l[145]||(l[145]=n("p",null,"无状态：成员变量保存的数据也可以称为状态信息，无状态就是没有成员变量",-1)),l[146]||(l[146]=n("p",null,"Servlet 为了保证其线程安全，一般不为 Servlet 设置成员变量，这种没有任何成员变量的类是线程安全的",-1)),l[147]||(l[147]=n("hr",null,null,-1)),l[148]||(l[148]=n("h3",{id:"local",tabindex:"-1"},[E("Local "),n("a",{class:"header-anchor",href:"#local","aria-label":'Permalink to "Local"'},"​")],-1)),l[149]||(l[149]=n("h4",{id:"基本介绍",tabindex:"-1"},[E("基本介绍 "),n("a",{class:"header-anchor",href:"#基本介绍","aria-label":'Permalink to "基本介绍"'},"​")],-1)),l[150]||(l[150]=n("p",null,[E("ThreadLocal 类用来提供线程内部的局部变量，这种变量在多线程环境下访问（通过 get 和 set 方法访问）时能保证各个线程的变量相对独立于其他线程内的变量，分配在堆内的 "),n("strong",null,"TLAB"),E(" 中")],-1)),l[151]||(l[151]=n("p",null,[E("ThreadLocal 实例通常来说都是 "),n("code",null,"private static"),E(" 类型的，属于一个线程的本地变量，用于关联线程和线程上下文。每个线程都会在 ThreadLocal 中保存一份该线程独有的数据，所以是线程安全的")],-1)),l[152]||(l[152]=n("p",null,"ThreadLocal 作用：",-1)),l[153]||(l[153]=n("ul",null,[n("li",null,[n("p",null,"线程并发：应用在多线程并发的场景下")]),n("li",null,[n("p",null,"传递数据：通过 ThreadLocal 实现在同一线程不同函数或组件中传递公共变量，减少传递复杂度")]),n("li",null,[n("p",null,"线程隔离：每个线程的变量都是独立的，不会互相影响")])],-1)),l[154]||(l[154]=n("p",null,"对比 synchronized：",-1)),l[155]||(l[155]=n("table",null,[n("thead",null,[n("tr",null,[n("th"),n("th",null,"synchronized"),n("th",null,"ThreadLocal")])]),n("tbody",null,[n("tr",null,[n("td",null,"原理"),n("td",null,[E("同步机制采用"),n("strong",null,"以时间换空间"),E("的方式，只提供了一份变量，让不同的线程排队访问")]),n("td",null,[E("ThreadLocal 采用"),n("strong",null,"以空间换时间"),E("的方式，为每个线程都提供了一份变量的副本，从而实现同时访问而互不干扰")])]),n("tr",null,[n("td",null,"侧重点"),n("td",null,"多个线程之间访问资源的同步"),n("td",null,"多线程中让每个线程之间的数据相互隔离")])])],-1)),l[156]||(l[156]=n("hr",null,null,-1)),l[157]||(l[157]=n("h4",{id:"基本使用",tabindex:"-1"},[E("基本使用 "),n("a",{class:"header-anchor",href:"#基本使用","aria-label":'Permalink to "基本使用"'},"​")],-1)),l[158]||(l[158]=n("h5",{id:"常用方法",tabindex:"-1"},[E("常用方法 "),n("a",{class:"header-anchor",href:"#常用方法","aria-label":'Permalink to "常用方法"'},"​")],-1)),l[159]||(l[159]=n("table",null,[n("thead",null,[n("tr",null,[n("th",null,"方法"),n("th",null,"描述")])]),n("tbody",null,[n("tr",null,[n("td",null,"ThreadLocal<>()"),n("td",null,"创建 ThreadLocal 对象")]),n("tr",null,[n("td",null,"protected T initialValue()"),n("td",null,"返回当前线程局部变量的初始值")]),n("tr",null,[n("td",null,"public void set( T value)"),n("td",null,"设置当前线程绑定的局部变量")]),n("tr",null,[n("td",null,"public T get()"),n("td",null,"获取当前线程绑定的局部变量")]),n("tr",null,[n("td",null,"public void remove()"),n("td",null,"移除当前线程绑定的局部变量")])])],-1)),l[160]||(l[160]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," MyDemo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> tl "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ThreadLocal<>();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String content;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getContent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取当前线程绑定的变量")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tl."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setContent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"content"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 变量content绑定到当前线程")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        tl."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(content);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"args"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        MyDemo demo "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," MyDemo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 5"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Thread thread "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Thread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Runnable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 设置数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    demo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setContent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "的数据"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"-----------------------"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "---\x3e"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," demo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getContent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            });")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"线程"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"start"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[161]||(l[161]=n("hr",null,null,-1)),l[162]||(l[162]=n("h5",{id:"应用场景",tabindex:"-1"},[E("应用场景 "),n("a",{class:"header-anchor",href:"#应用场景","aria-label":'Permalink to "应用场景"'},"​")],-1)),l[163]||(l[163]=n("p",null,"ThreadLocal 适用于下面两种场景：",-1)),l[164]||(l[164]=n("ul",null,[n("li",null,"每个线程需要有自己单独的实例"),n("li",null,"实例需要在多个方法中共享，但不希望被多线程共享")],-1)),l[165]||(l[165]=n("p",null,"ThreadLocal 方案有两个突出的优势：",-1)),l[166]||(l[166]=n("ol",null,[n("li",null,"传递数据：保存每个线程绑定的数据，在需要的地方可以直接获取，避免参数直接传递带来的代码耦合问题"),n("li",null,"线程隔离：各线程之间的数据相互隔离却又具备并发性，避免同步方式带来的性能损失")],-1)),l[167]||(l[167]=n("p",null,"ThreadLocal 用于数据连接的事务管理：",-1)),l[168]||(l[168]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JdbcUtils"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // ThreadLocal对象，将connection绑定在当前线程中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Connection"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> tl "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ThreadLocal"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // c3p0 数据库连接池对象属性")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ComboPooledDataSource ds "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ComboPooledDataSource"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取连接")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Connection "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getConnection"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SQLException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //取出当前线程绑定的connection对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Connection conn "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tl."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (conn "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //如果没有，则从连接池中取出")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            conn "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ds."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getConnection"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //再将connection对象绑定到当前线程中，非常重要的操作")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            tl."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(conn);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," conn;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// ...")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[169]||(l[169]=n("p",null,"用 ThreadLocal 使 SimpleDateFormat 从独享变量变成单个线程变量：",-1)),l[170]||(l[170]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ThreadLocalDateUtil"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DateFormat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> threadLocal "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DateFormat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        protected"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DateFormat "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"initialValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SimpleDateFormat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"yyyy-MM-dd HH:mm:ss"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    };")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Date "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parse"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"dateStr"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ParseException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," threadLocal."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parse"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(dateStr);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"format"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Date "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"date"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," threadLocal."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"format"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(date);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[171]||(l[171]=n("hr",null,null,-1)),l[172]||(l[172]=n("h4",{id:"实现原理",tabindex:"-1"},[E("实现原理 "),n("a",{class:"header-anchor",href:"#实现原理","aria-label":'Permalink to "实现原理"'},"​")],-1)),l[173]||(l[173]=n("h5",{id:"底层结构",tabindex:"-1"},[E("底层结构 "),n("a",{class:"header-anchor",href:"#底层结构","aria-label":'Permalink to "底层结构"'},"​")],-1)),l[174]||(l[174]=n("p",null,"JDK8 以前：每个 ThreadLocal 都创建一个 Map，然后用线程作为 Map 的 key，要存储的局部变量作为 Map 的 value，达到各个线程的局部变量隔离的效果。这种结构会造成 Map 结构过大和内存泄露，因为 Thread 停止后无法通过 key 删除对应的数据",-1)),l[175]||(l[175]=n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824171552294.png",alt:"image-20230824171552294",style:{zoom:"80%"}},null,-1)),l[176]||(l[176]=n("p",null,"JDK8 以后：每个 Thread 维护一个 ThreadLocalMap，这个 Map 的 key 是 ThreadLocal 实例本身，value 是真正要存储的值",-1)),l[177]||(l[177]=n("ul",null,[n("li",null,[n("strong",null,"每个 Thread 线程内部都有一个 Map (ThreadLocalMap)")]),n("li",null,"Map 里面存储 ThreadLocal 对象（key）和线程的私有变量（value）"),n("li",null,"Thread 内部的 Map 是由 ThreadLocal 维护的，由 ThreadLocal 负责向 map 获取和设置线程的变量值"),n("li",null,"对于不同的线程，每次获取副本值时，别的线程并不能获取到当前线程的副本值，形成副本的隔离，互不干扰")],-1)),l[178]||(l[178]=n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824171625312.png",alt:"image-20230824171625312",style:{zoom:"80%"}},null,-1)),l[179]||(l[179]=n("p",null,"JDK8 前后对比：",-1)),l[180]||(l[180]=n("ul",null,[n("li",null,"每个 Map 存储的 Entry 数量会变少，因为之前的存储数量由 Thread 的数量决定，现在由 ThreadLocal 的数量决定，在实际编程当中，往往 ThreadLocal 的数量要少于 Thread 的数量"),n("li",null,[E("当 Thread 销毁之后，对应的 ThreadLocalMap 也会随之销毁，能减少内存的使用，"),n("strong",null,"防止内存泄露")])],-1)),l[181]||(l[181]=n("hr",null,null,-1)),l[182]||(l[182]=n("h5",{id:"成员变量",tabindex:"-1"},[E("成员变量 "),n("a",{class:"header-anchor",href:"#成员变量","aria-label":'Permalink to "成员变量"'},"​")],-1)),l[183]||(l[183]=n("ul",null,[n("li",null,[n("p",null,[E("Thread 类的相关属性："),n("strong",null,"每一个线程持有一个 ThreadLocalMap 对象"),E("，存放由 ThreadLocal 和数据组成的 Entry 键值对")]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ThreadLocal.ThreadLocalMap threadLocals "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,"计算 ThreadLocal 对象的哈希值："),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," threadLocalHashCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextHashCode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")])])]),n("button",{class:"collapse"})]),n("p",null,[E("使用 "),n("code",null,"threadLocalHashCode & (table.length - 1)"),E(" 计算当前 entry 需要存放的位置")])]),n("li",null,[n("p",null,"每创建一个 ThreadLocal 对象就会使用 nextHashCode 分配一个 hash 值给这个对象："),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AtomicInteger nextHashCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AtomicInteger"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,[E("斐波那契数也叫黄金分割数，hash 的"),n("strong",null,"增量"),E("就是这个数字，带来的好处是 hash 分布非常均匀：")]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HASH_INCREMENT "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0x61c88647")])])]),n("button",{class:"collapse"})])])],-1)),l[184]||(l[184]=n("hr",null,null,-1)),l[185]||(l[185]=n("h5",{id:"成员方法",tabindex:"-1"},[E("成员方法 "),n("a",{class:"header-anchor",href:"#成员方法","aria-label":'Permalink to "成员方法"'},"​")],-1)),l[186]||(l[186]=n("p",null,"方法都是线程安全的，因为 ThreadLocal 属于一个线程的，ThreadLocal 中的方法，逻辑都是获取当前线程维护的 ThreadLocalMap 对象，然后进行数据的增删改查，没有指定初始值的 threadlcoal 对象默认赋值为 null",-1)),l[187]||(l[187]=n("ul",null,[n("li",null,[n("p",null,"initialValue()：返回该线程局部变量的初始值"),n("ul",null,[n("li",null,"延迟调用的方法，在执行 get 方法时才执行"),n("li",null,"该方法缺省（默认）实现直接返回一个 null"),n("li",null,[E("如果想要一个初始值，可以重写此方法， 该方法是一个 "),n("code",null,"protected"),E(" 的方法，为了让子类覆盖而设计的")])]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"protected"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," T "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"initialValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,[E("nextHashCode()：计算哈希值，ThreadLocal 的散列方式称之为"),n("strong",null,"斐波那契散列"),E("，每次获取哈希值都会加上 HASH_INCREMENT，这样做可以尽量避免 hash 冲突，让哈希值能均匀的分布在 2 的 n 次方的数组中")]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextHashCode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 哈希值自增一个 HASH_INCREMENT 数值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," nextHashCode."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAndAdd"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HASH_INCREMENT);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,"set()：修改当前线程与当前 threadlocal 对象相关联的线程局部变量"),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(T value) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取当前线程对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Thread t "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取此线程对象中维护的 ThreadLocalMap 对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ThreadLocalMap map "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(t);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断 map 是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (map "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 调用 threadLocalMap.set 方法进行重写或者添加")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        map."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", value);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    else")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // map 为空，调用 createMap 进行 ThreadLocalMap 对象的初始化。参数1是当前线程，参数2是局部变量")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        createMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(t, value);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 获取当前线程 Thread 对应维护的 ThreadLocalMap ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ThreadLocalMap "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Thread t) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," t.threadLocals;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 创建当前线程Thread对应维护的ThreadLocalMap ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Thread t, T firstValue) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 【这里的 this 是调用此方法的 threadLocal】，创建一个新的 Map 并设置第一个数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    t.threadLocals "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ThreadLocalMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", firstValue);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,"get()：获取当前线程与当前 ThreadLocal 对象相关联的线程局部变量"),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," T "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Thread t "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ThreadLocalMap map "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(t);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果此map存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (map "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 以当前的 ThreadLocal 为 key，调用 getEntry 获取对应的存储实体 e")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ThreadLocalMap.Entry e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," map."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 对 e 进行判空 ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 获取存储实体 e 对应的 value值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            T result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (T)e.value;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /*有两种情况有执行当前代码")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"      第一种情况: map 不存在，表示此线程没有维护的 ThreadLocalMap 对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"      第二种情况: map 存在, 但是【没有与当前 ThreadLocal 关联的 entry】，就会设置为默认值 */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 初始化当前线程与当前 threadLocal 对象相关联的 value")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setInitialValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," T "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInitialValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 调用initialValue获取初始化的值，此方法可以被子类重写, 如果不重写默认返回 null")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    T value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," initialValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Thread t "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ThreadLocalMap map "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(t);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断 map 是否初始化过")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (map "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 存在则调用 map.set 设置此实体 entry，value 是默认的值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        map."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", value);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    else")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 调用 createMap 进行 ThreadLocalMap 对象的初始化中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        createMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(t, value);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 返回线程与当前 threadLocal 关联的局部变量")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," value;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,"remove()：移除当前线程与当前 threadLocal 对象相关联的线程局部变量"),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取当前线程对象中维护的 ThreadLocalMap 对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ThreadLocalMap m "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (m "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // map 存在则调用 map.remove，this时当前ThreadLocal，以this为key删除对应的实体")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        m."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])])],-1)),l[188]||(l[188]=n("hr",null,null,-1)),l[189]||(l[189]=n("h4",{id:"localmap",tabindex:"-1"},[E("LocalMap "),n("a",{class:"header-anchor",href:"#localmap","aria-label":'Permalink to "LocalMap"'},"​")],-1)),l[190]||(l[190]=n("h5",{id:"成员属性",tabindex:"-1"},[E("成员属性 "),n("a",{class:"header-anchor",href:"#成员属性","aria-label":'Permalink to "成员属性"'},"​")],-1)),l[191]||(l[191]=n("p",null,"ThreadLocalMap 是 ThreadLocal 的内部类，没有实现 Map 接口，用独立的方式实现了 Map 的功能，其内部 Entry 也是独立实现",-1)),l[192]||(l[192]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 初始化当前 map 内部散列表数组的初始长度 16")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," INITIAL_CAPACITY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 16"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 存放数据的table，数组长度必须是2的整次幂。")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] table;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 数组里面 entrys 的个数，可以用于判断 table 当前使用量是否超过阈值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," size "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 进行扩容的阈值，表使用量大于它的时候进行扩容。")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," threshold;")])])]),n("button",{class:"collapse"})],-1)),l[193]||(l[193]=n("p",null,"存储结构 Entry：",-1)),l[194]||(l[194]=n("ul",null,[n("li",null,"Entry 继承 WeakReference，key 是弱引用，目的是将 ThreadLocal 对象的生命周期和线程生命周期解绑"),n("li",null,"Entry 限制只能用 ThreadLocal 作为 key，key 为 null (entry.get() == null) 意味着 key 不再被引用，entry 也可以从 table 中清除")],-1)),l[195]||(l[195]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Entry"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," extends"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," WeakReference"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Object value;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"k"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"v"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // this.referent = referent = key;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        super"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(k);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," v;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[196]||(l[196]=n("p",null,"构造方法：延迟初始化的，线程第一次存储 threadLocal - value 时才会创建 threadLocalMap 对象",-1)),l[197]||(l[197]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ThreadLocalMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ThreadLocal"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<?>"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," firstKey, Object firstValue) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 初始化table，创建一个长度为16的Entry数组")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    table "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[INITIAL_CAPACITY];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 【寻址算法】计算索引")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," firstKey.threadLocalHashCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (INITIAL_CAPACITY "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建 entry 对象，存放到指定位置的 slot 中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    table[i] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(firstKey, firstValue);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 数据总量是 1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    size "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 将阈值设置为 （当前数组长度 * 2）/ 3。")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    setThreshold"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(INITIAL_CAPACITY);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[198]||(l[198]=n("hr",null,null,-1)),l[199]||(l[199]=n("h5",{id:"成员方法-1",tabindex:"-1"},[E("成员方法 "),n("a",{class:"header-anchor",href:"#成员方法-1","aria-label":'Permalink to "成员方法"'},"​")],-1)),l[200]||(l[200]=n("ul",null,[n("li",null,[n("p",null,[E("set()：添加数据，ThreadLocalMap 使用"),n("strong",null,"线性探测法来解决哈希冲突")]),n("ul",null,[n("li",null,[n("p",null,"该方法会一直探测下一个地址，直到有空的地址后插入，若插入后 Map 数量超过阈值，数组会扩容为原来的 2 倍"),n("p",null,[E("假设当前 table 长度为16，计算出来 key 的 hash 值为 14，如果 table[14] 上已经有值，并且其 key 与当前 key 不一致，那么就发生了 hash 冲突，这个时候将 14 加 1 得到 15，取 table[15] 进行判断，如果还是冲突会回到 0，取 table[0]，以此类推，直到可以插入，可以把 Entry[] table 看成一个"),n("strong",null,"环形数组")])]),n("li",null,[n("p",null,[E("线性探测法会出现"),n("strong",null,"堆积问题"),E("，可以采取平方探测法解决")])]),n("li",null,[n("p",null,"在探测过程中 ThreadLocal 会复用 key 为 null 的脏 Entry 对象，并进行垃圾清理，防止出现内存泄漏")])]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ThreadLocal"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<?>"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key, Object value) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取散列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ThreadLocal.ThreadLocalMap."),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] tab "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab.length;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 哈希寻址")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key.threadLocalHashCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (len"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 使用线性探测法向后查找元素，碰到 entry 为空时停止探测")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ThreadLocal.ThreadLocalMap.Entry e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab[i]; e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab[i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i, len)]) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取当前元素 key")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // ThreadLocal 对应的 key 存在，【直接覆盖之前的值】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            e.value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," value;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 【这两个条件谁先成立不一定，所以 replaceStaleEntry 中还需要判断 k == key 的情况】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // key 为 null，但是值不为 null，说明之前的 ThreadLocal 对象已经被回收了，当前是【过期数据】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 【碰到一个过期的 slot，当前数据复用该槽位，替换过期数据】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 这个方法还进行了垃圾清理动作，防止内存泄漏")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            replaceStaleEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, value, i);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 逻辑到这说明碰到 slot == null 的位置，则在空元素的位置创建一个新的 Entry")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    tab[i] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, value);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 数量 + 1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sz "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"size;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 【做一次启发式清理】，如果没有清除任何 entry 并且【当前使用量达到了负载因子所定义，那么进行 rehash")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cleanSomeSlots"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i, sz) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sz "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," threshold)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 扩容")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        rehash"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 获取【环形数组】的下一个索引")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 索引越界后从 0 开始继续获取")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," <"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," :"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 在指定位置插入指定的数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," replaceStaleEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ThreadLocal"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<?>"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key, Object value, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," staleSlot) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取散列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] tab "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab.length;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Entry e;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 探测式清理的开始下标，默认从当前 staleSlot 开始")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," slotToExpunge "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," staleSlot;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 以当前 staleSlot 开始【向前迭代查找】，找到索引靠前过期数据，找到以后替换 slotToExpunge 值")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 【保证在一个区间段内，从最前面的过期数据开始清理】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," prevIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(staleSlot, len); (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab[i]) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," prevIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i, len))")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            slotToExpunge "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 以 staleSlot 【向后去查找】，直到碰到 null 为止，还是线性探测")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(staleSlot, len); (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab[i]) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i, len)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取当前节点的 key")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 条件成立说明是【替换逻辑】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            e.value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," value;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 因为本来要在 staleSlot 索引处插入该数据，现在找到了i索引处的key与数据一致")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 但是 i 位置距离正确的位置更远，因为是向后查找，所以还是要在 staleSlot 位置插入当前 entry")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 然后将 table[staleSlot] 这个过期数据放到当前循环到的 table[i] 这个位置，")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            tab[i] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab[staleSlot];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            tab[staleSlot] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 条件成立说明向前查找过期数据并未找到过期的 entry，但 staleSlot 位置已经不是过期数据了，i 位置才是")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (slotToExpunge "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," staleSlot)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                slotToExpunge "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 【清理过期数据，expungeStaleEntry 探测式清理，cleanSomeSlots 启发式清理】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            cleanSomeSlots"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"expungeStaleEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(slotToExpunge), len);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 条件成立说明当前遍历的 entry 是一个过期数据，并且该位置前面也没有过期数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," slotToExpunge "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," staleSlot)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 探测式清理过期数据的开始下标修改为当前循环的 index，因为 staleSlot 会放入要添加的数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            slotToExpunge "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 向后查找过程中并未发现 k == key 的 entry，说明当前是一个【取代过期数据逻辑】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 删除原有的数据引用，防止内存泄露")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    tab[staleSlot].value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // staleSlot 位置添加数据，【上面的所有逻辑都不会更改 staleSlot 的值】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    tab[staleSlot] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, value);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 条件成立说明除了 staleSlot 以外，还发现其它的过期 slot，所以要【开启清理数据的逻辑】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (slotToExpunge "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," staleSlot)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        cleanSomeSlots"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"expungeStaleEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(slotToExpunge), len);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})]),n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824171823217.png",alt:"image-20230824171823217",loading:"lazy",decoding:"async",class:"lazy"})]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," prevIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 形成一个环绕式的访问，头索引越界后置为尾索引")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," >="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," :"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,"getEntry()：ThreadLocal 的 get 方法以当前的 ThreadLocal 为 key，调用 getEntry 获取对应的存储实体 e"),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Entry "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ThreadLocal"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<?>"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 哈希寻址")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key.threadLocalHashCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (table.length "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 访问散列表中指定指定位置的 slot ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Entry e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table[i];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 条件成立，说明 slot 有值并且 key 就是要寻找的 key，直接返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    else")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 进行线性探测")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getEntryAfterMiss"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, i, e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 线性探测寻址")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Entry "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEntryAfterMiss"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ThreadLocal"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<?>"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i, Entry e) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取散列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] tab "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab.length;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 开始遍历，碰到 slot == null 的情况，搜索结束")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 获取当前 slot 中 entry 对象的 key")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 条件成立说明找到了，直接返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"             // 过期数据，【探测式过期数据回收】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            expungeStaleEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        else")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 更新 index 继续向后走")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i, len);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取下一个槽位中的 entry")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab[i];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 说明当前区段没有找到相应数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 【因为存放数据是线性的向后寻找槽位，都是紧挨着的，不可能越过一个 空槽位 在后面放】，可以减少遍历的次数")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,[E("rehash()：触发一次全量清理，如果数组长度大于等于长度的 "),n("code",null,"2/3 * 3/4 = 1/2"),E("，则进行 resize")]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," rehash"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 清除当前散列表内的【所有】过期的数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    expungeStaleEntries"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // threshold = len * 2 / 3，就是 2/3 * (1 - 1/4)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (size "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," threshold "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," threshold "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 4"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        resize"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," expungeStaleEntries"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] tab "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab.length;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 【遍历所有的槽位，清理过期数据】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," j "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; j "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len; j"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Entry e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab[j];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            expungeStaleEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(j);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})]),n("p",null,[E("Entry "),n("strong",null,"数组扩容为原来的 2 倍"),E(" ，重新计算 key 的散列值，如果遇到 key 为 null 的情况，会将其 value 也置为 null，帮助 GC")]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," resize"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] oldTab "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," oldLen "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," oldTab.length;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 新数组的长度是老数组的二倍")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," newLen "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," oldLen "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] newTab "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[newLen];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 统计新table中的entry数量")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 遍历老表，进行【数据迁移】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," j "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; j "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," oldLen; "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"j) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 访问老表的指定位置的 entry")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Entry e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," oldTab[j];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 条件成立说明老表中该位置有数据，可能是过期数据也可能不是")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 过期数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                e.value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; "),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// Help the GC")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 非过期数据，在新表中进行哈希寻址")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," h "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," k.threadLocalHashCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (newLen "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 【线程探测】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (newTab[h] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    h "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(h, newLen);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 将数据存放到新表合适的 slot 中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                newTab[h] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                count"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 设置下一次触发扩容的指标：threshold = len * 2 / 3;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    setThreshold"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(newLen);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    size "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 将扩容后的新表赋值给 threadLocalMap 内部散列表数组引用")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    table "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," newTab;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])]),n("li",null,[n("p",null,"remove()：删除 Entry"),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ThreadLocal"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<?>"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] tab "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab.length;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 哈希寻址")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key.threadLocalHashCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (len"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Entry e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab[i]; e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab[i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i, len)]) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 找到了对应的 key")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 设置 key 为 null")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"clear"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 探测式清理")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            expungeStaleEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])])],-1)),l[201]||(l[201]=n("hr",null,null,-1)),l[202]||(l[202]=n("h5",{id:"清理方法",tabindex:"-1"},[E("清理方法 "),n("a",{class:"header-anchor",href:"#清理方法","aria-label":'Permalink to "清理方法"'},"​")],-1)),l[203]||(l[203]=n("ul",null,[n("li",null,[n("p",null,[E("探测式清理：沿着开始位置向后探测清理过期数据，沿途中碰到未过期数据则将此数据 rehash 在 table 数组中的定位，重定位后的元素理论上更接近 "),n("code",null,"i = entry.key & (table.length - 1)"),E("，让"),n("strong",null,"数据的排列更紧凑"),E("，会优化整个散列表查询性能")]),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// table[staleSlot] 是一个过期数据，以这个位置开始继续向后查找过期数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," expungeStaleEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," staleSlot) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取散列表和数组长度")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] tab "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab.length;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // help gc，先把当前过期的 entry 置空，在取消对 entry 的引用")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    tab[staleSlot].value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    tab[staleSlot] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 数量-1")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    size"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"--"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Entry e;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 从 staleSlot 开始向后遍历，直到碰到 slot == null 结束，【区间内清理过期数据】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(staleSlot, len); (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab[i]) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i, len)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 当前 entry 是过期数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (k "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // help gc")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            e.value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            tab[i] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            size"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"--"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 当前 entry 不是过期数据的逻辑，【rehash】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 重新计算当前 entry 对应的 index")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," h "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," k.threadLocalHashCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (len "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 条件成立说明当前 entry 存储时发生过 hash 冲突，向后偏移过了")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (h "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 当前位置置空")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                tab[i] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 以正确位置 h 开始，向后查找第一个可以存放 entry 的位置")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (tab[h] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    h "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(h, len);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 将当前元素放入到【距离正确位置更近的位置，有可能就是正确位置】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                tab[h] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 返回 slot = null 的槽位索引，图例是 7，这个索引代表【索引前面的区间已经清理完成垃圾了】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})]),n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824171939245.png",alt:"image-20230824171939245",style:{zoom:"80%"}}),n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824172017188.png",alt:"image-20230824172017188",style:{zoom:"80%"}})]),n("li",null,[n("p",null,"启发式清理：向后循环扫描过期数据，发现过期数据调用探测式清理方法，如果连续几次的循环都没有发现过期数据，就停止扫描"),n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//  i 表示启发式清理工作开始位置，一般是空 slot，n 一般传递的是 table.length ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," cleanSomeSlots"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," n) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 表示启发式清理工作是否清除了过期数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," removed "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取当前 map 的散列表引用")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] tab "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab.length;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    do"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取下一个索引，因为探测式返回的 slot 为 null")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i, len);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Entry e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tab[i];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 条件成立说明是过期的数据，key 被 gc 了")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 【发现过期数据重置 n 为数组的长度】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            n "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 表示清理过过期数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            removed "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 以当前过期的 slot 为开始节点 做一次探测式清理工作")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," expungeStaleEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 假设 table 长度为 16")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 16 >>> 1 ==> 8，8 >>> 1 ==> 4，4 >>> 1 ==> 2，2 >>> 1 ==> 1，1 >>> 1 ==> 0")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 连续经过这么多次循环【没有扫描到过期数据】，就停止循环，扫描到空 slot 不算，因为不是过期数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((n "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">>>="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 返回清除标记")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," removed;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})])])],-1)),l[204]||(l[204]=n("p",null,[E("参考视频："),n("a",{href:"https://space.bilibili.com/457326371/",target:"_blank",rel:"noreferrer"},"https://space.bilibili.com/457326371/")],-1)),l[205]||(l[205]=n("hr",null,null,-1)),l[206]||(l[206]=n("h4",{id:"内存泄漏",tabindex:"-1"},[E("内存泄漏 "),n("a",{class:"header-anchor",href:"#内存泄漏","aria-label":'Permalink to "内存泄漏"'},"​")],-1)),l[207]||(l[207]=n("p",null,"Memory leak：内存泄漏是指程序中动态分配的堆内存由于某种原因未释放或无法释放，造成系统内存的浪费，导致程序运行速度减慢甚至系统崩溃等严重后果，内存泄漏的堆积终将导致内存溢出",-1)),l[208]||(l[208]=n("ul",null,[n("li",null,[n("p",null,"如果 key 使用强引用：使用完 ThreadLocal ，threadLocal Ref 被回收，但是 threadLocalMap 的 Entry 强引用了 threadLocal，造成 threadLocal 无法被回收，无法完全避免内存泄漏"),n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824172101315.png",alt:"image-20230824172101315",style:{zoom:"80%"}})]),n("li",null,[n("p",null,"如果 key 使用弱引用：使用完 ThreadLocal ，threadLocal Ref 被回收，ThreadLocalMap 只持有 ThreadLocal 的弱引用，所以threadlocal 也可以被回收，此时 Entry 中的 key = null。但没有手动删除这个 Entry 或者 CurrentThread 依然运行，依然存在强引用链，value 不会被回收，而这块 value 永远不会被访问到，也会导致 value 内存泄漏"),n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230824172141253.png",alt:"image-20230824172141253",style:{zoom:"80%"}})]),n("li",null,[n("p",null,"两个主要原因："),n("ul",null,[n("li",null,"没有手动删除这个 Entry"),n("li",null,"CurrentThread 依然运行")])])],-1)),l[209]||(l[209]=n("p",null,[E("根本原因：ThreadLocalMap 是 Thread的一个属性，"),n("strong",null,"生命周期跟 Thread 一样长"),E("，如果没有手动删除对应 Entry 就会导致内存泄漏")],-1)),l[210]||(l[210]=n("p",null,"解决方法：使用完 ThreadLocal 中存储的内容后将它 remove 掉就可以",-1)),l[211]||(l[211]=n("p",null,[E("ThreadLocal 内部解决方法：在 ThreadLocalMap 中的 set/getEntry 方法中，通过线性探测法对 key 进行判断，如果 key 为 null（ThreadLocal 为 null）会对 Entry 进行垃圾回收。所以"),n("strong",null,"使用弱引用比强引用多一层保障"),E("，就算不调用 remove，也有机会进行 GC")],-1)),l[212]||(l[212]=n("hr",null,null,-1)),l[213]||(l[213]=n("h4",{id:"补充-内存释放时机",tabindex:"-1"},[E("补充：内存释放时机 "),n("a",{class:"header-anchor",href:"#补充-内存释放时机","aria-label":'Permalink to "补充：内存释放时机"'},"​")],-1)),l[214]||(l[214]=n("ul",null,[n("li",null,[E("被动 GC 释放 key "),n("ul",null,[n("li",null,"仅是让 key 的内存释放，关联 value 的内存并不会释放")])]),n("li",null,[E("懒惰被动释放 value "),n("ul",null,[n("li",null,"get key 时，发现是 null key，则释放其 value 内存"),n("li",null,"set key 时，会使用启发式扫描，清除临近的 null key 的 value 内存，启发次数与元素个数，是否发现 null key 有关")])]),n("li",null,[E("主动 remove 释放 key，value "),n("ul",null,[n("li",null,"会同时释放 key，value 的内存，也会清除临近的 null key 的 value 内存"),n("li",null,"推荐使用它，因为一般使用 ThreadLocal 时都把它作为静态变量（即强引用），因此无法被动依靠 GC 回收")])])],-1)),l[215]||(l[215]=n("blockquote",null,[n("ul",null,[n("li",null,"threadLocal是弱引用作为key来存储的，当下面线程1一直处于运行状态，不断的插入元素，这样键值就会越来越多，这时只能等GC垃圾回收了，如果threadLocal设计成强引用就不能被垃圾回收了（即使别的地方都没有引用threadLocal，只要threadLocalMap使用强引用引用资源，那被引用的资源就得不到释放），所以弱引用引用资源将来没人引用了就会被回收，但值是强引用的，GC仅是让key的内存释放，后续还要根据 key 是否为 null来进一步释放值的内存"),n("li",null,"GC垃圾回收时，把未被引用的threadLocal（a）清理掉，变为null，值还在；当新的threadLocal（c）去get这个key为Null的位置时，此时值就会被垃圾回收掉，变为Null；当get一个空闲位置时，map就会把当前新的threadLocal（d）作为key，但值为Null")]),n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421195247137.png",alt:"image-20230421195247137",loading:"lazy",decoding:"async",class:"lazy"})]),n("ul",null,[n("li",null,"当在被垃圾回收掉key的位置set（8）时，不光清理掉当前位置的值（清理并存储），还会把相邻位置也一起清理掉（9,10 的 k v），但离得比较远的位置就不会去清理（14）")]),n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421195536553.png",alt:"image-20230421195536553",loading:"lazy",decoding:"async",class:"lazy"})]),n("ul",null,[n("li",null,"一般情况是没有其他地方引用threadLocal就会被垃圾回收，key=Null，get，set发现Nullkey才会进一步清理value"),n("li",null,"实际情况是用静态变量来引用threadLocal对象，即静态变量跟这个对象为强引用，所以静态变量一直强引用使用对象，垃圾回收不了，即使threadLocal是弱引用，但是静态变量对threadLocal一直保持强引用状态，所以懒惰被动释放 value的两种方式是行不通的"),n("li",null,"使用remove主动清理直接将map的键值清理掉，前两种方式清理（get set）会产生内存泄露，需要用remove来及时清理；假设长时间运行的线程池资源（含threadLocal关联静态资源）没有即使清理的话，就会积累越来越多的键值资源，还有其他的静态变量强引用key，GC也没办法把它们回收，久而久之就会造成内存泄漏")]),n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230421200401064.png",alt:"image-20230421200401064",loading:"lazy",decoding:"async",class:"lazy"})])],-1)),l[216]||(l[216]=n("hr",null,null,-1)),l[217]||(l[217]=n("h4",{id:"变量传递",tabindex:"-1"},[E("变量传递 "),n("a",{class:"header-anchor",href:"#变量传递","aria-label":'Permalink to "变量传递"'},"​")],-1)),l[218]||(l[218]=n("h5",{id:"基本使用-1",tabindex:"-1"},[E("基本使用 "),n("a",{class:"header-anchor",href:"#基本使用-1","aria-label":'Permalink to "基本使用"'},"​")],-1)),l[219]||(l[219]=n("p",null,"父子线程：创建子线程的线程是父线程，比如实例中的 main 线程就是父线程",-1)),l[220]||(l[220]=n("p",null,[E("ThreadLocal 中存储的是线程的局部变量，如果想"),n("strong",null,"实现线程间局部变量传递"),E("可以使用 InheritableThreadLocal 类")],-1)),l[221]||(l[221]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] args) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> threadLocal "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," InheritableThreadLocal<>();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    threadLocal."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"父线程设置的值"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Thread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System.out."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"子线程输出："'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," threadLocal."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()))."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"start"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 子线程输出：父线程设置的值")])])]),n("button",{class:"collapse"})],-1)),l[222]||(l[222]=n("hr",null,null,-1)),l[223]||(l[223]=n("h5",{id:"实现原理-1",tabindex:"-1"},[E("实现原理 "),n("a",{class:"header-anchor",href:"#实现原理-1","aria-label":'Permalink to "实现原理"'},"​")],-1)),l[224]||(l[224]=n("p",null,"InheritableThreadLocal 源码：",-1)),l[225]||(l[225]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InheritableThreadLocal"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"T"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"extends"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ThreadLocal"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"T"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    protected"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," T "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"childValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(T "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"parentValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," parentValue;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ThreadLocalMap "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Thread "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"t"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"       return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," t.inheritableThreadLocals;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Thread "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"t"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", T "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"firstValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        t.inheritableThreadLocals "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ThreadLocalMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", firstValue);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[226]||(l[226]=n("p",null,"实现父子线程间的局部变量共享需要追溯到 Thread 对象的构造方法：",-1)),l[227]||(l[227]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," init"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ThreadGroup g, Runnable target, String name, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stackSize, AccessControlContext acc,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                  // 该参数默认是 true")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                  boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," inheritThreadLocals) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  \t// ...")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Thread parent "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," currentThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断父线程（创建子线程的线程）的 inheritableThreadLocals 属性不为 null")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (inheritThreadLocals "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," parent.inheritableThreadLocals "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 复制父线程的 inheritableThreadLocals 属性，实现父子线程局部变量共享")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".inheritableThreadLocals "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ThreadLocal."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createInheritedMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(parent.inheritableThreadLocals); ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // ..")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 【本质上还是创建 ThreadLocalMap，只是把父类中的可继承数据设置进去了】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ThreadLocalMap "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createInheritedMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ThreadLocalMap parentMap) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ThreadLocalMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(parentMap);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[228]||(l[228]=n("div",{style:{"max-height":"300px"},class:"language-java vp-adaptive-theme"},[n("button",{title:"Copy Code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ThreadLocalMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ThreadLocalMap parentMap) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取父线程的哈希表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] parentTable "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," parentMap.table;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," parentTable.length;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    setThreshold"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(len);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    table "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[len];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 【逐个复制父线程 ThreadLocalMap 中的数据】")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," j "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; j "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len; j"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Entry e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," parentTable[j];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ThreadLocal<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ThreadLocal"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Object"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 调用的是 InheritableThreadLocal#childValue(T parentValue)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Object value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"childValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e.value);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Entry c "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, value);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," h "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key.threadLocalHashCode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (len "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 线性探测")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (table[h] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    h "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextIndex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(h, len);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                table[h] "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," c;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                size"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"collapse"})],-1)),l[229]||(l[229]=n("p",null,[E("参考文章："),n("a",{href:"https://blog.csdn.net/feichitianxia/article/details/110495764",target:"_blank",rel:"noreferrer"},"https://blog.csdn.net/feichitianxia/article/details/110495764")],-1)),l[230]||(l[230]=n("hr",null,null,-1))])),"main-header":k((()=>[t(s.$slots,"main-header")])),"main-header-after":k((()=>[t(s.$slots,"main-header-after")])),"main-nav":k((()=>[t(s.$slots,"main-nav")])),"main-content-before":k((()=>[t(s.$slots,"main-content-before")])),"main-content":k((()=>[t(s.$slots,"main-content")])),"main-content-after":k((()=>[t(s.$slots,"main-content-after")])),"main-nav-before":k((()=>[t(s.$slots,"main-nav-before")])),"main-nav-after":k((()=>[t(s.$slots,"main-nav-after")])),comment:k((()=>[t(s.$slots,"comment")])),footer:k((()=>[t(s.$slots,"footer")])),aside:k((()=>[t(s.$slots,"aside")])),"aside-custom":k((()=>[t(s.$slots,"aside-custom")])),default:k((()=>[t(s.$slots,"default")])),_:3},8,["frontmatter"])}}};export{y as default,g as usePageData};
