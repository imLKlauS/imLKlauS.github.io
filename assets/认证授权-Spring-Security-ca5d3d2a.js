import{_ as D}from"./ValaxyMain.vue_vue_type_style_index_0_lang-33cdb3de.js";import{_ as y,c as i,w as o,o as F,a as s,b as l,d as e,r as t,e as A,p as C}from"./app-05062f04.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-0952838b.js";import"./YunCard.vue_vue_type_style_index_0_lang-111bd468.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-35d95ae8.js";const N8=JSON.parse('{"title":"认证授权-Spring Security","description":"","frontmatter":{"cover":"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/girl_umbrella_anime_141156_1920x1080.jpg","title":"认证授权-Spring Security","top":240,"author":"imklaus","tags":["Spring Cloud","Spring Boot","Spring Security","JWT","OAuth2","Redis"],"categories":"Java","date":"2023-07-05T21:04:49.000Z","updated":"2023-07-05T23:25:29.000Z","outline":"deep"},"headers":[{"level":2,"title":"1 模块需求分析","slug":"_1-模块需求分析","link":"#_1-模块需求分析","children":[{"level":3,"title":"1.1 什么是认证授权","slug":"_1-1-什么是认证授权","link":"#_1-1-什么是认证授权","children":[]},{"level":3,"title":"1.2 业务流程","slug":"_1-2-业务流程","link":"#_1-2-业务流程","children":[]}]},{"level":2,"title":"2 Spring Security 认证研究","slug":"_2-spring-security-认证研究","link":"#_2-spring-security-认证研究","children":[{"level":3,"title":"2.1 Spring Security介绍","slug":"_2-1-spring-security介绍","link":"#_2-1-spring-security介绍","children":[]},{"level":3,"title":"2.2 认证授权入门","slug":"_2-2-认证授权入门","link":"#_2-2-认证授权入门","children":[]},{"level":3,"title":"2.3 什么是OAuth2","slug":"_2-3-什么是oauth2","link":"#_2-3-什么是oauth2","children":[]},{"level":3,"title":"2.4 JWT","slug":"_2-4-jwt","link":"#_2-4-jwt","children":[]},{"level":3,"title":"2.5 网关认证","slug":"_2-5-网关认证","link":"#_2-5-网关认证","children":[]}]},{"level":2,"title":"3 用户认证","slug":"_3-用户认证","link":"#_3-用户认证","children":[{"level":3,"title":"3.1 需求分析","slug":"_3-1-需求分析","link":"#_3-1-需求分析","children":[]},{"level":3,"title":"3.2 连接用户中心数据库","slug":"_3-2-连接用户中心数据库","link":"#_3-2-连接用户中心数据库","children":[]},{"level":3,"title":"3.3 支持认证方式多样","slug":"_3-3-支持认证方式多样","link":"#_3-3-支持认证方式多样","children":[]},{"level":3,"title":"3.4 验证码服务","slug":"_3-4-验证码服务","link":"#_3-4-验证码服务","children":[]},{"level":3,"title":"3.5 账号密码认证","slug":"_3-5-账号密码认证","link":"#_3-5-账号密码认证","children":[]}]},{"level":2,"title":"4 微信扫码登录","slug":"_4-微信扫码登录","link":"#_4-微信扫码登录","children":[{"level":3,"title":"4.1 接入规范","slug":"_4-1-接入规范","link":"#_4-1-接入规范","children":[]},{"level":3,"title":"4.2 准备开发环境","slug":"_4-2-准备开发环境","link":"#_4-2-准备开发环境","children":[]},{"level":3,"title":"4.3 接入微信登录","slug":"_4-3-接入微信登录","link":"#_4-3-接入微信登录","children":[]}]},{"level":2,"title":"5 用户授权","slug":"_5-用户授权","link":"#_5-用户授权","children":[{"level":3,"title":"5.1 RBAC","slug":"_5-1-rbac","link":"#_5-1-rbac","children":[]},{"level":3,"title":"5.2 资源服务授权流程","slug":"_5-2-资源服务授权流程","link":"#_5-2-资源服务授权流程","children":[]},{"level":3,"title":"5.3 授权相关的数据模型","slug":"_5-3-授权相关的数据模型","link":"#_5-3-授权相关的数据模型","children":[]},{"level":3,"title":"5.4 查询用户权限","slug":"_5-4-查询用户权限","link":"#_5-4-查询用户权限","children":[]},{"level":3,"title":"5.5 授权测试","slug":"_5-5-授权测试","link":"#_5-5-授权测试","children":[]},{"level":3,"title":"5.6 细粒度授权","slug":"_5-6-细粒度授权","link":"#_5-6-细粒度授权","children":[]}]},{"level":2,"title":"6 实战","slug":"_6-实战","link":"#_6-实战","children":[{"level":3,"title":"6.1 找回密码(实战)","slug":"_6-1-找回密码-实战","link":"#_6-1-找回密码-实战","children":[]},{"level":3,"title":"6.2 注册(实战)","slug":"_6-2-注册-实战","link":"#_6-2-注册-实战","children":[]}]}],"relativePath":"pages/posts/认证授权-Spring-Security.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-blog\\\\imklaus.github.io-main\\\\pages\\\\posts\\\\认证授权-Spring-Security.md","lastUpdated":null}'),c=JSON.parse('{"title":"认证授权-Spring Security","description":"","frontmatter":{"cover":"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/girl_umbrella_anime_141156_1920x1080.jpg","title":"认证授权-Spring Security","top":240,"author":"imklaus","tags":["Spring Cloud","Spring Boot","Spring Security","JWT","OAuth2","Redis"],"categories":"Java","date":"2023-07-05T21:04:49.000Z","updated":"2023-07-05T23:25:29.000Z","outline":"deep"},"headers":[{"level":2,"title":"1 模块需求分析","slug":"_1-模块需求分析","link":"#_1-模块需求分析","children":[{"level":3,"title":"1.1 什么是认证授权","slug":"_1-1-什么是认证授权","link":"#_1-1-什么是认证授权","children":[]},{"level":3,"title":"1.2 业务流程","slug":"_1-2-业务流程","link":"#_1-2-业务流程","children":[]}]},{"level":2,"title":"2 Spring Security 认证研究","slug":"_2-spring-security-认证研究","link":"#_2-spring-security-认证研究","children":[{"level":3,"title":"2.1 Spring Security介绍","slug":"_2-1-spring-security介绍","link":"#_2-1-spring-security介绍","children":[]},{"level":3,"title":"2.2 认证授权入门","slug":"_2-2-认证授权入门","link":"#_2-2-认证授权入门","children":[]},{"level":3,"title":"2.3 什么是OAuth2","slug":"_2-3-什么是oauth2","link":"#_2-3-什么是oauth2","children":[]},{"level":3,"title":"2.4 JWT","slug":"_2-4-jwt","link":"#_2-4-jwt","children":[]},{"level":3,"title":"2.5 网关认证","slug":"_2-5-网关认证","link":"#_2-5-网关认证","children":[]}]},{"level":2,"title":"3 用户认证","slug":"_3-用户认证","link":"#_3-用户认证","children":[{"level":3,"title":"3.1 需求分析","slug":"_3-1-需求分析","link":"#_3-1-需求分析","children":[]},{"level":3,"title":"3.2 连接用户中心数据库","slug":"_3-2-连接用户中心数据库","link":"#_3-2-连接用户中心数据库","children":[]},{"level":3,"title":"3.3 支持认证方式多样","slug":"_3-3-支持认证方式多样","link":"#_3-3-支持认证方式多样","children":[]},{"level":3,"title":"3.4 验证码服务","slug":"_3-4-验证码服务","link":"#_3-4-验证码服务","children":[]},{"level":3,"title":"3.5 账号密码认证","slug":"_3-5-账号密码认证","link":"#_3-5-账号密码认证","children":[]}]},{"level":2,"title":"4 微信扫码登录","slug":"_4-微信扫码登录","link":"#_4-微信扫码登录","children":[{"level":3,"title":"4.1 接入规范","slug":"_4-1-接入规范","link":"#_4-1-接入规范","children":[]},{"level":3,"title":"4.2 准备开发环境","slug":"_4-2-准备开发环境","link":"#_4-2-准备开发环境","children":[]},{"level":3,"title":"4.3 接入微信登录","slug":"_4-3-接入微信登录","link":"#_4-3-接入微信登录","children":[]}]},{"level":2,"title":"5 用户授权","slug":"_5-用户授权","link":"#_5-用户授权","children":[{"level":3,"title":"5.1 RBAC","slug":"_5-1-rbac","link":"#_5-1-rbac","children":[]},{"level":3,"title":"5.2 资源服务授权流程","slug":"_5-2-资源服务授权流程","link":"#_5-2-资源服务授权流程","children":[]},{"level":3,"title":"5.3 授权相关的数据模型","slug":"_5-3-授权相关的数据模型","link":"#_5-3-授权相关的数据模型","children":[]},{"level":3,"title":"5.4 查询用户权限","slug":"_5-4-查询用户权限","link":"#_5-4-查询用户权限","children":[]},{"level":3,"title":"5.5 授权测试","slug":"_5-5-授权测试","link":"#_5-5-授权测试","children":[]},{"level":3,"title":"5.6 细粒度授权","slug":"_5-6-细粒度授权","link":"#_5-6-细粒度授权","children":[]}]},{"level":2,"title":"6 实战","slug":"_6-实战","link":"#_6-实战","children":[{"level":3,"title":"6.1 找回密码(实战)","slug":"_6-1-找回密码-实战","link":"#_6-1-找回密码-实战","children":[]},{"level":3,"title":"6.2 注册(实战)","slug":"_6-2-注册-实战","link":"#_6-2-注册-实战","children":[]}]}],"relativePath":"pages/posts/认证授权-Spring-Security.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-blog\\\\imklaus.github.io-main\\\\pages\\\\posts\\\\认证授权-Spring-Security.md","lastUpdated":null}'),d={name:"pages/posts/认证授权-Spring-Security.md",data(){return{data:c,frontmatter:c.frontmatter}},setup(){C("pageData",c)}},u={id:"认证授权",tabindex:"-1"},h={id:"_1-模块需求分析",tabindex:"-1"},_=s("strong",null,"1 模块需求分析",-1),g={id:"_1-1-什么是认证授权",tabindex:"-1"},E=s("strong",null,"1.1 什么是认证授权",-1),m=s("p",null,"截至目前，项目已经完成了课程发布功能，课程发布后用户通过在线学习页面点播视频进行学习。如何去记录学生的学习过程呢？要想掌握学生的学习情况就需要知道用户的身份信息，记录哪个用户在什么时间学习什么课程，如果用户要购买课程也需要知道用户的身份信息。所以，去管理学生的学习过程最基本的要实现用户的身份认证。",-1),f=s("p",null,"认证授权模块实现平台所有用户的身份认证与用户授权功能。",-1),b=s("p",null,"什么是用户身份认证？",-1),S=s("p",null,"​ 用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证的表现形式有：用户名密码登录，微信扫码等方式。",-1),x=s("p",null,"项目包括学生、学习机构的老师、平台运营人员三类用户，不管哪一类用户在访问项目受保护资源时都需要进行身份认证。比如：发布课程操作，需要学习机构的老师首先登录系统成功，然后再执行发布课程操作。创建订单，需要学生用户首先登录系统，才可以创建订单。如下图：",-1),v=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps35.jpg",alt:"img"})],-1),w=s("p",null,"什么是用户授权？",-1),k=s("p",null,"​ 用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。比如：用户去发布课程，系统首先进行用户身份认证，认证通过后继续判断用户是否有发布课程的权限，如果没有权限则拒绝继续访问系统，如果有权限则继续发布课程。如下图：",-1),U=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps36.jpg",alt:"img"})],-1),I={id:"_1-2-业务流程",tabindex:"-1"},B=s("strong",null,"1.2 业务流程",-1),j={id:"_1-2-1-统一认证",tabindex:"-1"},T=s("strong",null,"1.2.1 统一认证",-1),P=s("p",null,"项目包括学生、学习机构的老师、平台运营人员三类用户，三类用户将使用统一的认证入口，如下图：",-1),O=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps37.jpg",alt:"img"})],-1),M=s("p",null,"用户输入账号和密码提交认证，认证通过则继续操作。",-1),L=s("p",null,"项目由统一认证服务受理用户的认证请求，如下图：",-1),R=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps38.jpg",alt:"img"})],-1),W=s("p",null,"认证通过由认证服务向给用户颁发令牌，相当于访问系统的通行证，用户拿着令牌去访问系统的资源。",-1),J={id:"_1-2-2-单点登录",tabindex:"-1"},N=s("strong",null,"1.2.2 单点登录",-1),z=s("p",null,"本项目基于微服务架构构建，微服务包括：内容管理服务、媒资管理服务、学习中心服务、系统管理服务等，为了提高用户体验性，用户只需要认证一次便可以在多个拥有访问权限的系统中访问，这个功能叫做单点登录。",-1),X=s("p",null,"引用百度百科：单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。",-1),q=s("p",null,"如下图，用户只需要认证一次，便可以在多个拥有访问权限的系统中访问。",-1),K=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps39.jpg",alt:"img"})],-1),G={id:"_1-2-3-第三方认证",tabindex:"-1"},H=s("strong",null,"1.2.3 第三方认证",-1),V=s("p",null,"为了提高用户体验，很多网站有扫码登录的功能，如：微信扫码登录、QQ扫码登录等。扫码登录的好处是用户不用输入账号和密码，操作简便，另外一个好处就是有利于用户信息的共享，互联网的优势就是资源共享，用户也是一种资源，对于一个新网站如果让用户去注册是很困难的，如果提供了微信扫码登录将省去用户注册的成本，是一种非常有效的推广手段。",-1),Z=s("p",null,"微信扫码登录其中的原理正是使用了第三方认证，如下图：",-1),Q=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps40.jpg",alt:"img"})],-1),Y={id:"_2-spring-security-认证研究",tabindex:"-1"},$=s("strong",null,"2 Spring Security 认证研究",-1),ss={id:"_2-1-spring-security介绍",tabindex:"-1"},ls=s("strong",null,"2.1 Spring Security介绍",-1),os=s("p",null,"认证功能几乎是每个项目都要具备的功能，并且它与业务无关，市面上有很多认证框架，如：Apache Shiro、CAS、Spring Security等。由于本项目基于Spring Cloud技术构建，Spring Security是spring家族的一份子且和Spring Cloud集成的很好，所以本项目选用Spring Security作为认证服务的技术框架。",-1),ns=s("p",null,"Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架，它是一个专注于为 Java 应用程序提供身份验证和授权的框架。",-1),es={id:"_2-2-认证授权入门",tabindex:"-1"},as=s("strong",null,"2.2 认证授权入门",-1),ts={id:"_2-2-1-创建认证服务工程",tabindex:"-1"},cs=s("strong",null,"2.2.1 创建认证服务工程",-1),ps=s("p",null,"下边我们使用Spring Security框架快速构建认证授权功能体系。",-1),rs=s("p",null,"1、部署认证服务工程",-1),Ds=s("p",null,"从课程资料中拷贝xuecheng-plus-auth工程到自己的工程目录下。",-1),ys=s("p",null,"此工程是一个普通的spring boot工程，可以连接数据库。",-1),is=s("p",null,"此工程不具备认证授权的功能。",-1),Fs=s("p",null,"2、创建数据库",-1),As=s("p",null,"创建xc_users数据库",-1),Cs=s("p",null,"导入课程资料中的xcplus_users.sql脚本。",-1),ds=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps41.jpg",alt:"img"})],-1),us=s("p",null,[l("在nacos中新增"),s("code",null,"auth-service-dev.yaml"),l("：")],-1),hs=s("div",{class:"language-yaml"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"server"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#F07178"}},"servlet"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"context-path"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"/auth")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#F07178"}},"port"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"63070")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"spring"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#F07178"}},"datasource"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"driver-class-name"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"com.mysql.cj.jdbc.Driver")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"url"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"jdbc:mysql://192.168.2.203:3306/xc_users?serverTimezone=UTC&userUnicode=true&useSSL=false&")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"username"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"root")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"password"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"1234")]),l(`
`),s("span",{class:"line"})])])],-1),_s=s("p",null,"初始工程自带了一个Controller类，如下：",-1),gs=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Slf4j")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RestController")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"LoginController"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"XcUserMapper"),s("span",{style:{color:"#A6ACCD"}}," userMapper"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RequestMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/login-success"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"loginSuccess"),s("span",{style:{color:"#89DDFF"}},"(){")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"      "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"登录成功"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RequestMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/user/{id}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getuser"),s("span",{style:{color:"#89DDFF"}},"(@"),s("span",{style:{color:"#C792EA"}},"PathVariable"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"id"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"id"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," xcUser "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," userMapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"selectById"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"id"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," xcUser"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RequestMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/r/r1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"r1"),s("span",{style:{color:"#89DDFF"}},"(){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"访问r1资源"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RequestMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/r/r2"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"r2"),s("span",{style:{color:"#89DDFF"}},"(){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"访问r2资源"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Es=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps42.jpg",alt:"img"})],-1),ms=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps43.jpg",alt:"img"})],-1),fs=s("p",null,"以上测试一切正常说明此工程部署成功。",-1),bs={id:"_2-2-2-认证测试",tabindex:"-1"},Ss=s("strong",null,"2.2.2 认证测试",-1),xs=s("p",null,"下边向auth认证工程集成Spring security，向pom.xml加入Spring Security所需要的依赖",-1),vs=s("div",{class:"language-xml"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"org.springframework.cloud"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"spring-cloud-starter-security"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"org.springframework.cloud"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"spring-cloud-starter-oauth2"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"})])])],-1),ws=s("p",null,[l("自动进入"),s("code",null,"/login"),l("登录页面，"),s("code",null,"/login"),l("是spring security提供的,此页面有几个css样式加载会稍微慢点，如下图：")],-1),ks=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps44.jpg",alt:"img"})],-1),Us=s("p",null,"账号和密码是多少呢？下一步需要进行安全配置。",-1),Is=s("p",null,[l("拷贝课程资料下的"),s("code",null,"WebSecurityConfig.java"),l("到config下需要三部分内容：")],-1),Bs=s("p",null,"1、用户信息",-1),js=s("p",null,[l("在内存配置两个用户："),s("code",null,"zhangsan、lisi")],-1),Ts=s("p",null,"zhangsan用户拥有的权限为p1",-1),Ps=s("p",null,"lisi用户拥有的权限为p2",-1),Os=s("p",null,"2、密码方式",-1),Ms=s("p",null,"暂时采用明文方式",-1),Ls=s("p",null,"3、安全拦截机制",-1),Rs=s("p",null,[s("code",null,"/r/**"),l("开头的请求需要认证")],-1),Ws=s("p",null,"登录成功到成功页面",-1),Js=s("p",null,"代码如下：",-1),Ns=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//配置用户信息服务")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UserDetailsService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"userDetailsService"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"InMemoryUserDetailsManager"),s("span",{style:{color:"#A6ACCD"}}," manager "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"InMemoryUserDetailsManager"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            manager"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"createUser"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"zhangsan"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"123"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    manager"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"createUser"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"lisi"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"456"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p2"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," manager"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"PasswordEncoder"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"passwordEncoder"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//密码为明文方式")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," NoOpPasswordEncoder"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getInstance"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//配置安全拦截机制")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"protected"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"configure"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"HttpSecurity"),s("span",{style:{color:"#A6ACCD"}}," http"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," throws Exception "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        http")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"authorizeRequests"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"antMatchers"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/r/**"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authenticated"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//访问/r开始的请求需要认证通过")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"anyRequest"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"permitAll"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//其它请求全部放行")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"and"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"formLogin"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"successForwardUrl"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/login-success"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//登录成功跳转到/login-success")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                http"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"logout"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"logoutUrl"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/logout"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//退出地址")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),zs=s("p",null,"重启工程",-1),Xs=s("p",null,"账号zhangsan，密码为123，如果输入的密码不正确会认证失败，输入正确显示登录成功。",-1),qs=s("p",null,[s("code",null,'http.logout().logoutUrl("/logout");'),l("配置了退出页面，认证成功后访问"),s("code",null,"/logout"),l("可退出登录。")],-1),Ks={id:"_2-2-3-授权测试",tabindex:"-1"},Gs=s("strong",null,"2.2.3 授权测试",-1),Hs=s("p",null,"用户认证通过去访问系统资源时spring security进行授权控制，判断用户是否有该资源的访问权限，如果有则继续访问，如果没有则拒绝访问。",-1),Vs=s("p",null,"下边测试授权功能：",-1),Zs=s("p",null,"1、配置用户拥有哪些权限。",-1),Qs=s("p",null,"在WebSecurityConfig类配置zhangsan拥有p1权限，lisi拥有p2权限。",-1),Ys=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UserDetailsService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"userDetailsService"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"InMemoryUserDetailsManager"),s("span",{style:{color:"#A6ACCD"}}," manager "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"InMemoryUserDetailsManager"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        manager"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"createUser"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"zhangsan"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"123"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        manager"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"createUser"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"lisi"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"456"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p2"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," manager"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),$s=s("p",null,"2、指定资源与权限的关系。",-1),sl=s("p",null,"什么是系统的资源？",-1),ll=s("p",null,"比如：查询一个用户的信息，用户信息就是系统的资源，要访问资源需要通过URL，所以我们在controller中定义的每个http的接口就是访问资源的接口。",-1),ol=s("p",null,[l("下边在controller中配置"),s("code",null,"/r/r1"),l("需要p1权限，"),s("code",null,"/r/r2"),l("需要p2权限。")],-1),nl=s("p",null,[s("code",null,"hasAuthority('p1')"),l("表示拥有p1权限方可访问。")],-1),el=s("p",null,"代码如下：",-1),al=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RestController")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"LoginController"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"....")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RequestMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/r/r1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"PreAuthorize"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"hasAuthority('p1')"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//拥有p1权限方可访问")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"r1"),s("span",{style:{color:"#89DDFF"}},"(){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"      "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"访问r1资源"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RequestMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/r/r2"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"PreAuthorize"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"hasAuthority('p2')"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//拥有p2权限方可访问")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"r2"),s("span",{style:{color:"#89DDFF"}},"(){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"      "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"访问r2资源"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"...")]),l(`
`),s("span",{class:"line"})])])],-1),tl=s("p",null,"现在重启工程。",-1),cl=s("p",null,"当访问以/r/开头的url时会判断用户是否认证，如果没有认证则跳转到登录页面，如果已经认证则判断用户是否具有该URL的访问权限，如果具有该URL的访问权限则继续，否则拒绝访问。",-1),pl=s("p",null,"例如：",-1),rl=s("p",null,[l("访问"),s("code",null,"/r/r1"),l("，使用zhangsan登录可以正常访问，因为在"),s("code",null,"/r/r1"),l("的方法上指定了权限p1，zhangsan用户拥有权限p1,所以可以正常访问。")],-1),Dl=s("p",null,[l("访问"),s("code",null,"/r/r1"),l("，使用lisi登录则拒绝访问，由于lisi用户不具有权限p1需要拒绝访问")],-1),yl=s("p",null,[l("注意：如果访问上不加"),s("code",null,"@PreAuthorize"),l("，此方法没有授权控制。")],-1),il=s("p",null,"整理授权的过程见下图所示：",-1),Fl=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps45.jpg",alt:"img"})],-1),Al={id:"_2-2-4-工作原理",tabindex:"-1"},Cl=s("strong",null,"2.2.4 工作原理",-1),dl=s("p",null,"通过测试认证和授权两个功能，我们了解了Spring Security的基本使用方法，下边了解它的工作流程。",-1),ul=s("p",null,[l("Spring Security所解决的问题就是"),s("strong",null,"安全访问控制"),l("，而安全访问控制功能其实就是对所有进入系统的请求进行拦截，校验每个请求是否能够访问它所期望的资源。根据前边知识的学习，可以通过Filter或AOP等技术来实现，Spring Security对Web资源的保护是靠Filter实现的，所以从这个Filter来入手，逐步深入Spring Security原理。")],-1),hl=s("p",null,[l("​ 当初始化Spring Security时，会创建一个名为SpringSecurityFilterChain的Servlet过滤器，类型为 "),s("code",null,"org.springframework.security.web.FilterChainProxy"),l("，它实现了"),s("code",null,"javax.servlet.Filter"),l("，因此外部的请求会经过此类，下图是Spring Security过虑器链结构图：")],-1),_l=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps46.jpg",alt:"img"})],-1),gl=s("p",null,[l("FilterChainProxy是一个代理，真正起作用的是FilterChainProxy中SecurityFilterChain所包含的各个Filter，同时这些Filter作为Bean被Spring管理，它们是Spring Security核心，各有各的职责，但他们并不直接处理用户的"),s("strong",null,"认证"),l("，也不直接处理用户的"),s("strong",null,"授权"),l("，而是把它们交给了认证管理器（AuthenticationManager）和决策管理器（AccessDecisionManager）进行处理。")],-1),El=s("p",null,"spring Security功能的实现主要是由一系列过滤器链相互配合完成。",-1),ml=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps47.jpg",alt:"img"})],-1),fl=s("p",null,"下面介绍过滤器链中主要的几个过滤器及其作用：",-1),bl=s("p",null,[s("strong",null,"SecurityContextPersistenceFilter"),l(" 这个Filter是整个拦截过程的入口和出口（也就是第一个和最后一个拦截器），会在请求开始时从配置好的 SecurityContextRepository 中获取 SecurityContext，然后把它设置给 SecurityContextHolder。在请求完成后将 SecurityContextHolder 持有的 SecurityContext 再保存到配置好的 SecurityContextRepository，同时清除 securityContextHolder 所持有的 SecurityContext；")],-1),Sl=s("p",null,[s("strong",null,"UsernamePasswordAuthenticationFilter"),l(" 用于处理来自表单提交的认证。该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的 AuthenticationSuccessHandler 和 AuthenticationFailureHandler，这些都可以根据需求做相关改变；")],-1),xl=s("p",null,[s("strong",null,"FilterSecurityInterceptor"),l(" 是用于保护web资源的，使用AccessDecisionManager对当前用户进行授权访问，前面已经详细介绍过了；")],-1),vl=s("p",null,[s("strong",null,"ExceptionTranslationFilter"),l(" 能够捕获来自 FilterChain 所有的异常，并进行处理。但是它只会处理两类异常：AuthenticationException 和 AccessDeniedException，其它的异常它会继续抛出。")],-1),wl=s("p",null,"Spring Security的执行流程如下：",-1),kl=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wps48.jpg",alt:"img"})],-1),Ul=s("ol",null,[s("li",null,[s("p",null,"用户提交用户名、密码被SecurityFilterChain中的UsernamePasswordAuthenticationFilter过滤器获取到，封装为请求Authentication，通常情况下是UsernamePasswordAuthenticationToken这个实现类。")]),s("li",null,[s("p",null,"然后过滤器将Authentication提交至认证管理器（AuthenticationManager）进行认证")]),s("li",null,[s("p",null,"认证成功后，AuthenticationManager身份管理器返回一个被填充满了信息的（包括上面提到的权限信息，身份信息，细节信息，但密码通常会被移除）Authentication实例。")]),s("li",null,[s("p",null,[l("SecurityContextHolder安全上下文容器将第3步填充了信息的Authentication，通过"),s("code",null,"SecurityContextHolder.getContext().setAuthentication(…)"),l("方法，设置到其中。")])]),s("li",null,[s("p",null,[l("可以看出AuthenticationManager接口（认证管理器）是认证相关的核心接口，也是发起认证的出发点，它的实现类为ProviderManager。而Spring Security支持多种认证方式，因此ProviderManager维护着一个"),s("code",null,"List<AuthenticationProvider>"),l("列表，存放多种认证方式，最终实际的认证工作是由AuthenticationProvider完成的。咱们知道web表单的对应的AuthenticationProvider实现类为DaoAuthenticationProvider，它的内部又维护着一个UserDetailsService负责UserDetails的获取。最终AuthenticationProvider将UserDetails填充至Authentication。")])])],-1),Il={id:"_2-3-什么是oauth2",tabindex:"-1"},Bl=s("strong",null,"2.3 什么是OAuth2",-1),jl={id:"_2-3-1-oauth2认证流程",tabindex:"-1"},Tl=s("strong",null,"2.3.1 OAuth2认证流程",-1),Pl=s("p",null,"在前边我们提到微信扫码认证，这是一种第三方认证的方式，这种认证方式是基于OAuth2协议实现，",-1),Ol=s("p",null,[l("OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。同时，任何第三方都可以使用OAUTH认证服务，任何服务提供商都可以实现自身的OAUTH认证服务，因而OAUTH是开放的。业界提供了OAUTH的多种实现如"),s("code",null,"PHP、JavaScript，Java，Ruby"),l("等各种语言开发包，大大节约了程序员的时间，因而OAUTH是简易的。互联网很多服务如Open API，很多大公司如"),s("code",null,"Google，Yahoo，Microsoft"),l("等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准。")],-1),Ml=s("p",null,"​ Oauth协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用。",-1),Ll=s("p",null,"下边分析一个Oauth2认证的例子，黑马程序员网站使用微信认证扫码登录的过程：",-1),Rl=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705222917841.png",alt:"image-20230705222917841"})],-1),Wl=s("p",null,"具体流程如下：",-1),Jl=s("p",null,"1、用户点击微信扫码",-1),Nl=s("p",null,"用户进入黑马程序的登录页面，点击微信的图标开打微信扫码界面。",-1),zl=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223020201.png",alt:"image-20230705223020201"})],-1),Xl=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223055747.png",alt:"image-20230705223055747"})],-1),ql=s("p",null,"微信扫码的目的是通过微信认证登录黑马程序员官网，黑马程序员网站需要从微信获取当前用户的身份信息才会让当前用户在黑马网站登录成功。",-1),Kl=s("p",null,"现在搞清楚几个概念：",-1),Gl=s("p",null,"资源：用户信息，在微信中存储。",-1),Hl=s("p",null,"资源拥有者：用户是用户信息资源的拥有者。",-1),Vl=s("p",null,"认证服务：微信负责认证当前用户的身份，负责为客户端颁发令牌。",-1),Zl=s("p",null,"客户端：客户端会携带令牌请求微信获取用户信息，黑马程序员网站即客户端，黑马网站需要在浏览器打开。",-1),Ql=s("p",null,"2、用户授权黑马网站访问用户信息",-1),Yl=s("p",null,"资源拥有者扫描二维码表示资源拥有者请求微信进行认证，微信认证通过向用户手机返回授权页面，如下图：",-1),$l=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223223906.png",alt:"image-20230705223223906"})],-1),so=s("p",null,"询问用户是否授权黑马程序员访问自己在微信的用户信息，用户点击“确认登录”表示同意授权，微信认证服务器会颁发一个授权码给黑马程序员的网站。",-1),lo=s("p",null,"只有资源拥有者同意微信才允许黑马网站访问资源。",-1),oo=s("p",null,"3、黑马程序员的网站获取到授权码",-1),no=s("p",null,"4、携带授权码请求微信认证服务器申请令牌",-1),eo=s("p",null,"此交互过程用户看不到。",-1),ao=s("p",null,"5、微信认证服务器向黑马程序员的网站响应令牌",-1),to=s("p",null,"此交互过程用户看不到。",-1),co=s("p",null,"6、黑马程序员网站请求微信资源服务器获取资源即用户信息。",-1),po=s("p",null,"黑马程序员网站携带令牌请求访问微信服务器获取用户的基本信息。",-1),ro=s("p",null,"7、资源服务器返回受保护资源即用户信息",-1),Do=s("p",null,"8、黑马网站接收到用户信息，此时用户在黑马网站登录成功。",-1),yo=s("p",null,"理解了微信扫码登录黑马网站的流程，接下来认识Oauth2.0的认证流程，如下：",-1),io=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223310223.png",alt:"image-20230705223310223"})],-1),Fo=s("p",null,"Oauth2包括以下角色：",-1),Ao=s("p",null,"1、客户端",-1),Co=s("p",null,"本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：手机客户端、浏览器等。",-1),uo=s("p",null,"上边示例中黑马网站即为客户端，它需要通过浏览器打开。",-1),ho=s("p",null,"2、资源拥有者",-1),_o=s("p",null,"通常为用户，也可以是应用程序，即该资源的拥有者。",-1),go=s("p",null,"A表示 客户端请求资源拥有者授权。",-1),Eo=s("p",null,"B表示 资源拥有者授权客户端即黑马网站访问自己的用户信息。",-1),mo=s("p",null,"3、授权服务器（也称认证服务器）",-1),fo=s("p",null,"认证服务器对资源拥有者进行认证，还会对客户端进行认证并颁发令牌。",-1),bo=s("p",null,"C 客户端即黑马网站携带授权码请求认证。",-1),So=s("p",null,"D认证通过颁发令牌。",-1),xo=s("p",null,"4、资源服务器",-1),vo=s("p",null,"存储资源的服务器。",-1),wo=s("p",null,"E表示客户端即黑马网站携带令牌请求资源服务器获取资源。",-1),ko=s("p",null,"F表示资源服务器校验令牌通过后提供受保护资源。",-1),Uo={id:"_2-3-2-oauth2在本项目的应用",tabindex:"-1"},Io=s("strong",null,"2.3.2 OAuth2在本项目的应用",-1),Bo=s("p",null,"Oauth2是一个标准的开放的授权协议，应用程序可以根据自己的要求去使用Oauth2，本项目使用Oauth2实现如下目标：",-1),jo=s("p",null,"1、学成在线访问第三方系统的资源。",-1),To=s("p",null,"本项目要接入微信扫码登录所以本项目要使用OAuth2协议访问微信中的用户信息。",-1),Po=s("p",null,"2、外部系统访问学成在线的资源 。",-1),Oo=s("p",null,"同样当第三方系统想要访问学成在线网站的资源也可以基于OAuth2协议。",-1),Mo=s("p",null,"3、学成在线前端（客户端） 访问学成在线微服务的资源。",-1),Lo=s("p",null,"本项目是前后端分离架构，前端访问微服务资源也可以基于OAuth2协议进行认证。",-1),Ro={id:"_2-3-3-oauth2的授权模式",tabindex:"-1"},Wo=s("strong",null,"2.3.3 OAuth2的授权模式",-1),Jo=s("p",null,"Spring Security支持OAuth2认证，OAuth2提供授权码模式、密码模式、简化模式、客户端模式等四种授权模式，前边举的微信扫码登录的例子就是基于授权码模式，这四种模式中授权码模式和密码模式应用较多，本节使用Spring Security演示授权码模式、密码模式，其余两种请自行查阅相关资料。",-1),No={id:"_2-3-3-1-授权码模式",tabindex:"-1"},zo=s("strong",null,"2.3.3.1 授权码模式",-1),Xo=s("p",null,"OAuth2的几个授权模式是根据不同的应用场景以不同的方式去获取令牌，最终目的是要获取认证服务颁发的令牌，最终通过令牌去获取资源。",-1),qo=s("p",null,"授权码模式简单理解是使用授权码去获取令牌，要想获取令牌先要获取授权码，授权码的获取需要资源拥有者亲自授权同意才可以获取。",-1),Ko=s("p",null,"下图是授权码模式的交互图：",-1),Go=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223355846.png",alt:"image-20230705223355846"})],-1),Ho=s("p",null,"还以黑马网站微信扫码登录为例进行说明：",-1),Vo=s("p",null,"1、用户打开浏览器。",-1),Zo=s("p",null,"2、通过浏览器访问客户端即黑马网站。",-1),Qo=s("p",null,"3、用户通过浏览器向认证服务请求授权，请求授权时会携带客户端的URL，此URL为下发授权码的重定向地址。",-1),Yo=s("p",null,"4、认证服务向资源拥有者返回授权页面。",-1),$o=s("p",null,"5、资源拥有者亲自授权同意。",-1),sn=s("p",null,"6、通过浏览器向认证服务发送授权同意。",-1),ln=s("p",null,"7、认证服务向客户端地址重定向并携带授权码。",-1),on=s("p",null,"8、客户端即黑马网站收到授权码。",-1),nn=s("p",null,"9、客户端携带授权码向认证服务申请令牌。",-1),en=s("p",null,"10、认证服务向客户端颁发令牌。",-1),an={id:"_2-3-3-2授权码模式测试",tabindex:"-1"},tn=s("strong",null,"2.3.3.2授权码模式测试",-1),cn=s("p",null,"要想测试授权模式首先要配置授权服务器即上图中的认证服务器，需要配置授权服务及令牌策略。",-1),pn=s("p",null,[l("1、从课程资料中拷贝 "),s("code",null,"AuthorizationServer.java、TokenConfig.java"),l("到认证服务的config包下。")],-1),rn=s("blockquote",null,[s("p",null,[l("说明：AuthorizationServer用 "),s("code",null,"@EnableAuthorizationServer"),l(" 注解标识并继承AuthorizationServerConfigurerAdapter来配置OAuth2.0 授权服务器。")])],-1),Dn=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Configuration")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"EnableAuthorizationServer")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"AuthorizationServer"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"extends"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"AuthorizationServerConfigurerAdapter"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"})])])],-1),yn=s("p",null,"AuthorizationServerConfigurerAdapter要求配置以下几个类：",-1),Fn=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"AuthorizationServerConfigurerAdapter"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"implements"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"AuthorizationServerConfigurer"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"AuthorizationServerConfigurerAdapter"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"configure"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"AuthorizationServerSecurityConfigurer"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"security"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Exception"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"configure"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"ClientDetailsServiceConfigurer"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"clients"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Exception"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"configure"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"AuthorizationServerEndpointsConfigurer"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"endpoints"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Exception"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),An=s("p",null,[s("strong",null,"1）ClientDetailsServiceConfigurer"),l("：用来配置客户端详情服务（ClientDetailsService），")],-1),Cn=s("p",null,"随便一个客户端都可以随便接入到它的认证服务吗？答案是否定的，服务提供商会给批准接入的客户端一个身份，用于接入时的凭据，有客户端标识和客户端秘钥，在这里配置批准接入的客户端的详细信息。",-1),dn=s("p",null,[s("strong",null,"2）AuthorizationServerEndpointsConfigurer"),l("：用来配置令牌（token）的访问端点和令牌服务(token services)。")],-1),un=s("p",null,[s("strong",null,"3）AuthorizationServerSecurityConfigurer"),l("：用来配置令牌端点的安全约束.")],-1),hn=s("p",null,[s("strong",null,"2、TokenConfig为令牌策略配置类")],-1),_n=s("p",null,"暂时先使用InMemoryTokenStore在内存存储令牌，令牌的有效期等信息配置如下：",-1),gn=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//令牌管理服务")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"name"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"authorizationServerTokenServicesCustom"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"AuthorizationServerTokenServices"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"tokenService"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"DefaultTokenServices"),s("span",{style:{color:"#A6ACCD"}}," service"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"DefaultTokenServices"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        service"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setSupportRefreshToken"),s("span",{style:{color:"#89DDFF"}},"(true);"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//支持刷新令牌")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        service"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setTokenStore"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"tokenStore"),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//令牌存储策略")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        service"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setAccessTokenValiditySeconds"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"7200"),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#676E95","font-style":"italic"}},"// 令牌默认有效期2小时")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        service"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setRefreshTokenValiditySeconds"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"259200"),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#676E95","font-style":"italic"}},"// 刷新令牌默认有效期3天")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," service"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),En=s("p",null,"3、配置认证管理bean",-1),mn=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"EnableWebSecurity")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"EnableGlobalMethodSecurity"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"securedEnabled"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true,"),s("span",{style:{color:"#FFCB6B"}},"prePostEnabled"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"WebSecurityConfig"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"extends"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"WebSecurityConfigurerAdapter"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"AuthenticationManager"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"authenticationManagerBean"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Exception"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," super"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"authenticationManagerBean"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"....")]),l(`
`),s("span",{class:"line"})])])],-1),fn=s("p",null,"重启认证服务",-1),bn=s("p",null,"1、get请求获取授权码",-1),Sn=s("p",null,"参数列表如下：",-1),xn=s("p",null,[l("• "),s("code",null,"client_id"),l("：客户端准入标识。")],-1),vn=s("p",null,[l("• "),s("code",null,"response_type"),l("：授权码模式固定为code。")],-1),wn=s("p",null,[l("• "),s("code",null,"scope"),l("：客户端权限。")],-1),kn=s("p",null,[l("• "),s("code",null,"redirect_uri"),l("：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）。")],-1),Un=s("p",null,[l("输入账号zhangsan、密码123登录成功，输入"),s("code",null,"/oauth/authorize?client_id=XcWebApp&response_type=code&scope=all&redirect_uri=http://www.51xuecheng.cn")],-1),In=s("p",null,"显示授权页面",-1),Bn=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223440333.png",alt:"image-20230705223440333"})],-1),jn=s("p",null,"授权“XcWebApp”访问自己的受保护资源?",-1),Tn=s("p",null,"选择同意。",-1),Pn=s("p",null,"3、使用httpclient工具post申请令牌",-1),On=s("p",null,[s("code",null,"/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=authorization_code&code=授权码&redirect_uri=http://www.51xuecheng.cn/")],-1),Mn=s("p",null,"参数列表如下",-1),Ln=s("p",null,[l("• "),s("code",null,"client_id"),l("：客户端准入标识。")],-1),Rn=s("p",null,[l("• "),s("code",null,"client_secret"),l("：客户端秘钥。")],-1),Wn=s("p",null,[l("• "),s("code",null,"grant_type"),l("：授权类型，填写authorization_code，表示授权码模式")],-1),Jn=s("p",null,[l("• "),s("code",null,"code"),l("：授权码，就是刚刚获取的授权码，注意：授权码只使用一次就无效了，需要重新申请。")],-1),Nn=s("p",null,[l("• "),s("code",null,"redirect_uri"),l("：申请授权码时的跳转url，一定和申请授权码时用的redirect_uri一致。")],-1),zn=s("p",null,"httpclient脚本如下：",-1),Xn=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"### 授权码模式")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"### 第一步申请授权码(浏览器请求)/oauth/authorize?client_id=c1&response_type=code&scope=all&redirect_uri=http://www.51xuecheng.cn")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"### 第二步申请令牌")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"POST"),s("span",{style:{color:"#A6ACCD"}}," {{auth_host}}/auth/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=authorization_code&code=CTvCrB&redirect_uri=http://www.51xuecheng.cn")]),l(`
`),s("span",{class:"line"})])])],-1),qn=s("p",null,"申请令牌成功如下所示：",-1),Kn=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"access_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"368b1ee7-a9ee-4e9a-aae6-0fcab243aad2"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"token_type"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"bearer"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"refresh_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"3d56e139-0ee6-4ace-8cbe-1311dfaa991f"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"expires_in"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"7199"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"scope"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"all"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Gn=s("p",null,"说明：",-1),Hn=s("p",null,[l("1、"),s("code",null,"access_token"),l("，访问令牌，用于访问资源使用。")],-1),Vn=s("p",null,[l("2、"),s("code",null,"token_type"),l("，bearer是在RFC6750中定义的一种token类型，在携带令牌访问资源时需要在head中加入bearer 空格 令牌内容")],-1),Zn=s("p",null,[l("3、"),s("code",null,"refresh_token"),l("，当令牌快过期时使用刷新令牌可以再次生成令牌。")],-1),Qn=s("p",null,[l("4、"),s("code",null,"expires_in"),l("：过期时间（秒）")],-1),Yn=s("p",null,[l("5、"),s("code",null,"scope"),l("：令牌的权限范围，服务端可以根据令牌的权限范围去对令牌授权。")],-1),$n={id:"_2-3-3-3-密码模式",tabindex:"-1"},se=s("strong",null,"2.3.3.3 密码模式",-1),le=s("p",null,"密码模式相对授权码模式简单，授权码模式需要借助浏览器供用户亲自授权，密码模式不用借助浏览器，如下图：",-1),oe=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223503678.png",alt:"image-20230705223503678"})],-1),ne=s("p",null,"1、资源拥有者提供账号和密码",-1),ee=s("p",null,"2、客户端向认证服务申请令牌，请求中携带账号和密码",-1),ae=s("p",null,"3、认证服务校验账号和密码正确颁发令牌。",-1),te=s("p",null,"开始测试：",-1),ce=s("p",null,"1、POST请求获取令牌",-1),pe=s("p",null,[s("code",null,"/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=password&username=shangsan&password=123")],-1),re=s("p",null,"参数列表如下：",-1),De=s("ul",null,[s("li",null,[s("code",null,"client_id"),l("：客户端准入标识。")]),s("li",null,[s("code",null,"client_secret"),l("：客户端秘钥。")]),s("li",null,[s("code",null,"grant_type"),l("：授权类型，填写password表示密码模式")]),s("li",null,[s("code",null,"username"),l("：资源拥有者用户名。")]),s("li",null,[s("code",null,"password"),l("：资源拥有者密码。")])],-1),ye=s("p",null,[l("2、授权服务器将令牌（"),s("code",null,"access_token"),l("）发送给client")],-1),ie=s("p",null,"使用httpclient进行测试",-1),Fe=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"### 密码模式")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"POST"),s("span",{style:{color:"#A6ACCD"}}," {{auth_host}}/auth/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=password&username=zhangsan&password=123")]),l(`
`),s("span",{class:"line"})])])],-1),Ae=s("p",null,"返回示例：",-1),Ce=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"access_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"368b1ee7-a9ee-4e9a-aae6-0fcab243aad2"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"token_type"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"bearer"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"refresh_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"3d56e139-0ee6-4ace-8cbe-1311dfaa991f"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"expires_in"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"6806"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"scope"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"all"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),de=s("p",null,"​ 这种模式十分简单，但是却意味着直接将用户敏感信息泄漏给了client，因此这就说明这种模式只能用于client是我们自己开发的情况下。",-1),ue={id:"_2-3-3-4-本项目的应用方式",tabindex:"-1"},he=s("strong",null,"2.3.3.4 本项目的应用方式",-1),_e=s("p",null,"通过演示授权码模式和密码模式，授权码模式适合客户端和认证服务非同一个系统的情况，所以本项目使用授权码模式完成微信扫码认证。本项目采用密码模式作为前端请求微服务的认证方式。",-1),ge={id:"_2-4-jwt",tabindex:"-1"},Ee=s("strong",null,"2.4 JWT",-1),me={id:"_2-4-1-普通令牌的问题",tabindex:"-1"},fe=s("strong",null,"2.4.1 普通令牌的问题",-1),be=s("p",null,"客户端申请到令牌，接下来客户端携带令牌去访问资源，到资源服务器将会校验令牌的合法性。",-1),Se=s("p",null,"资源服务器如何校验令牌的合法性？",-1),xe=s("p",null,"我们以OAuth2的密码模式为例进行说明：",-1),ve=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223542073.png",alt:"image-20230705223542073"})],-1),we=s("p",null,"从第4步开始说明：",-1),ke=s("p",null,"1、客户端携带令牌访问资源服务获取资源。",-1),Ue=s("p",null,"2、资源服务远程请求认证服务校验令牌的合法性",-1),Ie=s("p",null,"3、如果令牌合法资源服务向客户端返回资源。",-1),Be=s("p",null,"这里存在一个问题：",-1),je=s("p",null,"就是校验令牌需要远程请求认证服务，客户端的每次访问都会远程校验，执行性能低。",-1),Te=s("p",null,"如果能够让资源服务自己校验令牌的合法性将省去远程请求认证服务的成本，提高了性能。如下图：",-1),Pe=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223607439.png",alt:"image-20230705223607439"})],-1),Oe=s("p",null,"如何解决上边的问题，实现资源服务自行校验令牌。",-1),Me=s("p",null,"令牌采用JWT格式即可解决上边的问题，用户认证通过后会得到一个JWT令牌，JWT令牌中已经包括了用户相关的信息，客户端只需要携带JWT访问资源服务，资源服务根据事先约定的算法自行完成令牌校验，无需每次都请求认证服务完成授权。",-1),Le={id:"_2-4-2-什么是jwt",tabindex:"-1"},Re=s("strong",null,"2.4.2 什么是JWT",-1),We=s("p",null,"什么是JWT？",-1),Je=s("p",null,"使用JWT可以实现无状态认证，什么是无状态认证？",-1),Ne=s("p",null,"传统的基于session的方式是有状态认证，用户登录成功将用户的身份信息存储在服务端，这样加大了服务端的存储压力，并且这种方式不适合在分布式系统中应用。",-1),ze=s("p",null,"如下图，当用户访问应用服务，每个应用服务都会去服务器查看session信息，如果session中没有该用户则说明用户没有登录，此时就会重新认证，而解决这个问题的方法是Session复制、Session黏贴。",-1),Xe=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223645686.png",alt:"image-20230705223645686"})],-1),qe=s("p",null,"如果是基于令牌技术在分布式系统中实现认证则服务端不用存储session，可以将用户身份信息存储在令牌中，用户认证通过后认证服务颁发令牌给用户，用户将令牌存储在客户端，去访问应用服务时携带令牌去访问，服务端从jwt解析出用户信息。这个过程就是无状态认证。",-1),Ke=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223829078.png",alt:"image-20230705223829078"})],-1),Ge=s("p",null,"JWT令牌的优点：",-1),He=s("p",null,"1、jwt基于json，非常方便解析。",-1),Ve=s("p",null,"2、可以在令牌中自定义丰富的内容，易扩展。",-1),Ze=s("p",null,"3、通过非对称加密算法及数字签名技术，JWT防止篡改，安全性高。",-1),Qe=s("p",null,"4、资源服务使用JWT可不依赖认证服务即可完成授权。",-1),Ye=s("p",null,"缺点：",-1),$e=s("p",null,"１、JWT令牌较长，占存储空间比较大。",-1),sa=s("p",null,"下边是一个JWT令牌的示例：",-1),la=s("div",{class:"language-apl"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"),s("span",{style:{color:"#F78C6C"}},".eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQyNTQ2NzIsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6Ijg4OTEyYjJkLTVkMDUtNGMxNC1iYmMzLWZkZTk5NzdmZWJjNiIsImNsaWVudF9pZCI6ImMxIn0"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"wkDBL7roLrvdBG2oGnXeoXq"),s("span",{style:{color:"#89DDFF"}},"-"),s("span",{style:{color:"#A6ACCD"}},"zZRgE9IVV2nxd"),s("span",{style:{color:"#89DDFF"}},"-"),s("span",{style:{color:"#A6ACCD"}},"ez_oA")]),l(`
`),s("span",{class:"line"})])])],-1),oa=s("p",null,[l("JWT令牌由三部分组成，每部分中间使用点（.）分隔，比如："),s("code",null,"xxxxx.yyyyy.zzzzz")],-1),na=s("ol",null,[s("li",null,"Header")],-1),ea=s("p",null,"头部包括令牌的类型（即JWT）及使用的哈希算法（如HMAC SHA256或RSA）",-1),aa=s("p",null,"一个例子如下：",-1),ta=s("p",null,"下边是Header部分的内容",-1),ca=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"alg"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"HS256"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"typ"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"JWT"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),pa=s("p",null,"将上边的内容使用Base64Url编码，得到一个字符串就是JWT令牌的第一部分。",-1),ra=s("ol",{start:"2"},[s("li",null,"Payload")],-1),Da=s("p",null,"第二部分是负载，内容也是一个json对象，它是存放有效信息的地方，它可以存放jwt提供的信息字段，比如：iss（签发者）,exp（过期时间戳）, sub（面向的用户）等，也可自定义字段。",-1),ya=s("p",null,"此部分不建议存放敏感信息，因为此部分可以解码还原原始内容。",-1),ia=s("p",null,"最后将第二部分负载使用Base64Url编码，得到一个字符串就是JWT令牌的第二部分。",-1),Fa=s("p",null,"一个例子：",-1),Aa=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"sub"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"1234567890"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"name"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"456"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"admin"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Ca=s("ol",{start:"3"},[s("li",null,"Signature")],-1),da=s("p",null,"第三部分是签名，此部分用于防止jwt内容被篡改。",-1),ua=s("p",null,"这个部分使用base64url将前两部分进行编码，编码后使用点（.）连接组成字符串，最后使用header中声明的签名算法进行签名。",-1),ha=s("p",null,"一个例子：",-1),_a=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  HMACSHA"),s("span",{style:{color:"#F78C6C"}},"256"),s("span",{style:{color:"#A6ACCD"}},"(")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    base"),s("span",{style:{color:"#F78C6C"}},"64"),s("span",{style:{color:"#A6ACCD"}},"UrlEncode(header) + "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"."),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}}," +")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    base"),s("span",{style:{color:"#F78C6C"}},"64"),s("span",{style:{color:"#A6ACCD"}},"UrlEncode(payload),")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    secret)")]),l(`
`),s("span",{class:"line"})])])],-1),ga=s("p",null,"base64UrlEncode(header)：jwt令牌的第一部分。",-1),Ea=s("p",null,"base64UrlEncode(payload)：jwt令牌的第二部分。",-1),ma=s("p",null,"secret：签名所使用的密钥。",-1),fa=s("p",null,"为什么JWT可以防止篡改？",-1),ba=s("p",null,"第三部分使用签名算法对第一部分和第二部分的内容进行签名，常用的签名算法是 HS256，常见的还有md5,sha 等，签名算法需要使用密钥进行签名，密钥不对外公开，并且签名是不可逆的，如果第三方更改了内容那么服务器验证签名就会失败，要想保证验证签名正确必须保证内容、密钥与签名前一致。",-1),Sa=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223925811.png",alt:"image-20230705223925811"})],-1),xa=s("p",null,"从上图可以看出认证服务和资源服务使用相同的密钥，这叫对称加密，对称加密效率高，如果一旦密钥泄露可以伪造jwt令牌。",-1),va=s("p",null,"JWT还可以使用非对称加密，认证服务自己保留私钥，将公钥下发给受信任的客户端、资源服务，公钥和私钥是配对的，成对的公钥和私钥才可以正常加密和解密，非对称加密效率低但相比对称加密非对称加密更安全一些。",-1),wa={id:"_2-4-3-测试生成jwt令牌",tabindex:"-1"},ka=s("strong",null,"2.4.3 测试生成JWT令牌",-1),Ua=s("p",null,"在认证服务中配置jwt令牌服务，即可实现生成jwt格式的令牌,",-1),Ia=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Configuration")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"TokenConfig"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," SIGNING_KEY "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"mq123"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"TokenStore"),s("span",{style:{color:"#A6ACCD"}}," tokenStore"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//    @Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//    public TokenStore tokenStore() {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//        //使用内存存储令牌（普通令牌）")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//        return new InMemoryTokenStore();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//    }")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"JwtAccessTokenConverter"),s("span",{style:{color:"#A6ACCD"}}," accessTokenConverter"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"TokenStore"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"tokenStore"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"JwtTokenStore"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"accessTokenConverter"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"JwtAccessTokenConverter"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"accessTokenConverter"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"JwtAccessTokenConverter"),s("span",{style:{color:"#A6ACCD"}}," converter "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"JwtAccessTokenConverter"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        converter"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setSigningKey"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"SIGNING_KEY"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," converter"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//令牌管理服务")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"name"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"authorizationServerTokenServicesCustom"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"AuthorizationServerTokenServices"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"tokenService"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"DefaultTokenServices"),s("span",{style:{color:"#A6ACCD"}}," service"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"DefaultTokenServices"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        service"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setSupportRefreshToken"),s("span",{style:{color:"#89DDFF"}},"(true);"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//支持刷新令牌")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        service"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setTokenStore"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"tokenStore"),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//令牌存储策略")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"TokenEnhancerChain"),s("span",{style:{color:"#A6ACCD"}}," tokenEnhancerChain "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"TokenEnhancerChain"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        tokenEnhancerChain"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setTokenEnhancers"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"Arrays"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"asList"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"accessTokenConverter"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        service"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setTokenEnhancer"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"tokenEnhancerChain"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        service"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setAccessTokenValiditySeconds"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"7200"),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#676E95","font-style":"italic"}},"// 令牌默认有效期2小时")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        service"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setRefreshTokenValiditySeconds"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"259200"),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#676E95","font-style":"italic"}},"// 刷新令牌默认有效期3天")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," service"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Ba=s("p",null,"重启认证服务。",-1),ja=s("p",null,"使用httpclient通过密码模式申请令牌",-1),Ta=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"### 密码模式")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"POST"),s("span",{style:{color:"#A6ACCD"}}," {{auth_host}}/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=password&username=zhangsan&password=123")]),l(`
`),s("span",{class:"line"})])])],-1),Pa=s("p",null,"生成jwt的示例如下：",-1),Oa=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"access_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzMzE2OTUsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImU5ZDNkMGZkLTI0Y2ItNDRjOC04YzEwLTI1NmIzNGY4ZGZjYyIsImNsaWVudF9pZCI6ImMxIn0.-9SKI-qUqKhKcs8Gb80Rascx-JxqsNZxxXoPo82d8SM"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"token_type"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"bearer"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"refresh_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJhdGkiOiJlOWQzZDBmZC0yNGNiLTQ0YzgtOGMxMC0yNTZiMzRmOGRmY2MiLCJleHAiOjE2NjQ1ODM2OTUsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImRjNTRjNTRkLTA0YTMtNDIzNS04MmY3LTFkOWZkMmFjM2VmNSIsImNsaWVudF9pZCI6ImMxIn0.Wsw1Jc-Kd_GFqEugzdfoSsMY6inC8OQsraA21WjWtT8"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"expires_in"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"7199"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"scope"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"all"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"jti"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"e9d3d0fd-24cb-44c8-8c10-256b34f8dfcc"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Ma=s("p",null,[l("1、"),s("code",null,"access_token"),l("，生成的jwt令牌，用于访问资源使用。")],-1),La=s("p",null,[l("2、"),s("code",null,"token_type"),l("，bearer是在RFC6750中定义的一种token类型，在携带jwt访问资源时需要在head中加入bearer jwt令牌内容")],-1),Ra=s("p",null,[l("3、"),s("code",null,"refresh_token"),l("，当jwt令牌快过期时使用刷新令牌可以再次生成jwt令牌。")],-1),Wa=s("p",null,[l("4、"),s("code",null,"expires_in"),l("：过期时间（秒）")],-1),Ja=s("p",null,[l("5、"),s("code",null,"scope"),l("，令牌的权限范围，服务端可以根据令牌的权限范围去对令牌授权。")],-1),Na=s("p",null,[l("6、"),s("code",null,"jti"),l("：令牌的唯一标识。")],-1),za=s("p",null,"我们可以通过check_token接口校验jwt令牌",-1),Xa=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"###校验jwt令牌")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"POST"),s("span",{style:{color:"#A6ACCD"}}," {{auth_host}}/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJzdHUxIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY2NDM3MTc4MCwiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiZjBhM2NkZWItMzk5ZC00OGYwLTg4MDQtZWNhNjM4YWQ4ODU3IiwiY2xpZW50X2lkIjoiYzEifQ.qy46CSCJsH3eXWTHgdcntZhzcSzfRQlBU0dxAjZcsUw")]),l(`
`),s("span",{class:"line"})])])],-1),qa=s("p",null,"响应示例如下：",-1),Ka=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"aud"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"[")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"res1"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"],")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"user_name"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"zhangsan"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"scope"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"[")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"all"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"],")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"active"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true,")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"exp"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"1664371780"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"authorities"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"[")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p1"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"],")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"jti"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"f0a3cdeb-399d-48f0-8804-eca638ad8857"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"client_id"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"c1"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Ga={id:"_2-4-4-测试资源服务校验令牌",tabindex:"-1"},Ha=s("strong",null,"2.4.4 测试资源服务校验令牌",-1),Va=s("p",null,"拿到了jwt令牌下一步就要携带令牌去访问资源服务中的资源，本项目各个微服务就是资源服务，比如：内容管理服务，客户端申请到jwt令牌，携带jwt去内容管理服务查询课程信息，此时内容管理服务要对jwt进行校验，只有jwt合法才可以继续访问。如下图：",-1),Za=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223951357.png",alt:"image-20230705223951357"})],-1),Qa=s("p",null,"1、在内容管理服务的content-api工程中添加依赖",-1),Ya=s("div",{class:"language-xml"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"<!--认证相关-->")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"org.springframework.cloud"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"spring-cloud-starter-security"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"org.springframework.cloud"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"spring-cloud-starter-oauth2"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"})])])],-1),$a=s("p",null,"2、在内容管理服务的content-api工程中添加TokenConfig",-1),st=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Configuration")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"TokenConfig"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//jwt签名密钥,与认证服务保持一致")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," SIGNING_KEY "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"mq123"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"TokenStore"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"tokenStore"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//JWT令牌存储方案")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"JwtTokenStore"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#82AAFF"}},"accessTokenConverter"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"JwtAccessTokenConverter"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"accessTokenConverter"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"JwtAccessTokenConverter"),s("span",{style:{color:"#A6ACCD"}}," converter "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"JwtAccessTokenConverter"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        converter"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setSigningKey"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"SIGNING_KEY"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," converter"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#676E95","font-style":"italic"}},"/* @Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    public TokenStore tokenStore() {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"        //使用内存存储令牌（普通令牌）")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"        return new InMemoryTokenStore();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    }*/")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),lt=s("p",null,"3、添加资源服务配置",-1),ot=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Configuration")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"EnableResourceServer")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"EnableGlobalMethodSecurity"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"securedEnabled"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true,"),s("span",{style:{color:"#FFCB6B"}},"prePostEnabled"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"ResouceServerConfig"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"extends"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"ResourceServerConfigurerAdapter"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//资源服务标识")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"static"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"final"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," RESOURCE_ID "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"xuecheng-plus"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"TokenStore"),s("span",{style:{color:"#A6ACCD"}}," tokenStore"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"configure"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"ResourceServerSecurityConfigurer"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"resources"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        resources"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"resourceId"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"RESOURCE_ID"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//资源 id")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"tokenStore"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"tokenStore"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"stateless"),s("span",{style:{color:"#89DDFF"}},"(true);")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"configure"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"HttpSecurity"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"http"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Exception"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        http"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"csrf"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"disable"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"authorizeRequests"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"antMatchers"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/r/**"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/course/**"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authenticated"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//所有/r/**的请求必须认证通过")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"anyRequest"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"permitAll"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),nt=s("p",null,"根据配置可知/course/**开头的接口需要认证通过。",-1),et=s("p",null,"重启内容管理服务",-1),at=s("p",null,"使用httpclient测试：",-1),tt=s("p",null,"1、访问根据课程id查询课程接口",-1),ct=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"GET"),s("span",{style:{color:"#A6ACCD"}}," http://localhost:63040/content/course/2")]),l(`
`),s("span",{class:"line"})])])],-1),pt=s("p",null,"返回：",-1),rt=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"error"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"unauthorized"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"error_description"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"Full authentication is required to access this resource"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Dt=s("p",null,"从返回信息可知当前没有认证。",-1),yt=s("p",null,"下边携带JWT令牌访问接口：",-1),it=s("p",null,"1、申请jwt令牌",-1),Ft=s("p",null,"采用密码模式申请令牌。",-1),At=s("p",null,"2、携带jwt令牌访问资源服务地址",-1),Ct=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"### 携带token访问资源服务")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"GET"),s("span",{style:{color:"#A6ACCD"}}," http://localhost:63040/content/course/2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"Authorization"),s("span",{style:{color:"#F78C6C"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzMzM0OTgsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6IjhhM2M2OTk1LWU1ZGEtNDQ1Yy05ZDAyLTEwNDFlYzk3NTkwOSIsImNsaWVudF9pZCI6ImMxIn0.73eNDxTX5ifttGCjwc7xrd-Sbp_mCfcIerI3lGetZto")]),l(`
`),s("span",{class:"line"})])])],-1),dt=s("p",null,"如果携带jwt令牌且jwt正确则正常访问资源服务的内容。",-1),ut=s("p",null,"如果不正确则报令牌无效的错误：",-1),ht=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"error"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"invalid_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"error_description"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"Cannot convert access token to JSON"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),_t={id:"_2-4-5-测试获取用户身份",tabindex:"-1"},gt=s("strong",null,"2.4.5 测试获取用户身份",-1),Et=s("p",null,"jwt令牌中记录了用户身份信息，当客户端携带jwt访问资源服务，资源服务验签通过后将前两部分的内容还原即可取出用户的身份信息，并将用户身份信息放在了SecurityContextHolder上下文，SecurityContext与当前线程进行绑定，方便获取用户身份。",-1),mt=s("p",null,"还以查询课程接口为例，进入查询课程接口的代码中，添加获取用户身份的代码",-1),ft=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ApiOperation"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"根据课程id查询课程基础信息"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"GetMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/course/{courseId}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"CourseBaseInfoDto"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getCourseBaseById"),s("span",{style:{color:"#89DDFF"}},"(@"),s("span",{style:{color:"#C792EA"}},"PathVariable"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"courseId"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Long"),s("span",{style:{color:"#A6ACCD"}}," courseId"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//取出当前用户身份")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"Object"),s("span",{style:{color:"#A6ACCD"}}," principal "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," SecurityContextHolder"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getContext"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"getAuthentication"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"getPrincipal"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    System"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"out"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"println"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"principal"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," courseBaseInfoService"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getCourseBaseInfo"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"courseId"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),bt=s("p",null,"测试时需要注意：",-1),St=s("p",null,[l("1、首先在资源服务配置中指定安全拦截机制 "),s("code",null,"/course/"),l("开头的请求需要认证，即请求"),s("code",null,"/course/{courseId}"),l("接口需要携带jwt令牌且签证通过。")],-1),xt=s("p",null,"2、认证服务生成jwt令牌将用户身份信息写入令牌，认证服务哪里获取用户身份。",-1),vt=s("p",null,"目前还是将用户信息硬编码并暂放在内存中，如下：",-1),wt=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UserDetailsService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"userDetailsService"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"InMemoryUserDetailsManager"),s("span",{style:{color:"#A6ACCD"}}," manager "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"InMemoryUserDetailsManager"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    manager"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"createUser"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"zhangsan"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"123"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    manager"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"createUser"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"lisi"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"456"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p2"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," manager"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),kt=s("p",null,"3、我们在使用密码模式生成jwt令牌时用的是zhangsan的信息，所以jwt令牌中存储了zhangsan的信息，那么在资源服务中应该取出zhangsan的信息才对。",-1),Ut=s("p",null,"清楚了以上内容，下边重启内容管理服务，跟踪取到的用户身份是否正确。",-1),It={id:"_2-5-网关认证",tabindex:"-1"},Bt=s("strong",null,"2.5 网关认证",-1),jt={id:"_2-5-1-技术方案",tabindex:"-1"},Tt=s("strong",null,"2.5.1 技术方案",-1),Pt=s("p",null,"到目前为止，测试通过了认证服务颁发jwt令牌，客户端携带jwt访问资源服务，资源服务对jwt的合法性进行验证。如下图：",-1),Ot=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705223951357.png",alt:""})],-1),Mt=s("p",null,"仔细观察此图，遗漏了本项目架构中非常重要的组件：网关，加上网关并完善后如下图所示：",-1),Lt=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224031161.png",alt:"image-20230705224031161"})],-1),Rt=s("blockquote",null,[s("p",null,"所有访问微服务的请求都要经过网关，在网关进行用户身份的认证可以将很多非法的请求拦截到微服务以外，这叫做网关认证。")],-1),Wt=s("p",null,"下边需要明确网关的职责：",-1),Jt=s("p",null,"1、网站白名单维护",-1),Nt=s("p",null,"针对不用认证的URL全部放行。",-1),zt=s("p",null,"2、校验jwt的合法性。",-1),Xt=s("p",null,"除了白名单剩下的就是需要认证的请求，网关需要验证jwt的合法性，jwt合法则说明用户身份合法，否则说明身份不合法则拒绝继续访问。",-1),qt=s("p",null,"网关负责授权吗？",-1),Kt=s("p",null,"网关不负责授权，对请求的授权操作在各个微服务进行，因为微服务最清楚用户有哪些权限访问哪些接口。",-1),Gt={id:"_2-5-2-实现网关认证",tabindex:"-1"},Ht=s("strong",null,"2.5.2 实现网关认证",-1),Vt=s("p",null,"下边实现网关认证，实现以下职责：",-1),Zt=s("p",null,"1、网站白名单维护",-1),Qt=s("p",null,"针对不用认证的URL全部放行。",-1),Yt=s("p",null,"2、校验jwt的合法性。",-1),$t=s("p",null,"除了白名单剩下的就是需要认证的请求，网关需要验证jwt的合法性，jwt合法则说明用户身份合法，否则说明身份不合法则拒绝继续访问。",-1),sc=s("p",null,"1、在网关工程添加依赖",-1),lc=s("div",{class:"language-xml"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"org.springframework.cloud"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"spring-cloud-starter-security"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"org.springframework.cloud"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"spring-cloud-starter-oauth2"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"org.projectlombok"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"lombok"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"com.alibaba"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"groupId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}},"fastjson"),s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"artifactId"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"</"),s("span",{style:{color:"#F07178"}},"dependency"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"})])])],-1),oc=s("p",null,"2、拷贝课程资料下网关认证配置类到网关工程的config包下。",-1),nc=s("p",null,[l("3、配置白名单文件"),s("code",null,"security-whitelist.properties")],-1),ec=s("p",null,"内容如下（持续补充）",-1),ac=s("div",{class:"language-properties"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"/**=临时全部放行")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"/auth/**=认证地址")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"/content/open/**=内容管理公开访问接口")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"/media/open/**=媒资管理公开访问接口")]),l(`
`),s("span",{class:"line"})])])],-1),tc=s("p",null,"重启网关工程，进行测试",-1),cc=s("p",null,"1、申请令牌",-1),pc=s("p",null,"2、通过网关访问资源服务",-1),rc=s("p",null,"这里访问内容管理服务",-1),Dc=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"### 通过网关访问资源服务")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"GET"),s("span",{style:{color:"#A6ACCD"}}," http://localhost:63010/content/course/2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"Authorization"),s("span",{style:{color:"#F78C6C"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzNjIzMTAsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6Ijc2OTkwMGNiLWM1ZjItNGRiNC1hZWJmLWY1MzgxZDQxZWMyZCIsImNsaWVudF9pZCI6ImMxIn0.lOITjUgYg2HCh5mDPK9EvJJqz-tIupKVfmP8yWJQIKs")]),l(`
`),s("span",{class:"line"})])])],-1),yc=s("p",null,"当token正确时可以正常访问资源服务，token验证失败返回token无效：",-1),ic=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"errMessage"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"认证令牌无效"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Fc=s("p",null,"注意：网关鉴权功能调试通过后，由于目前还没有开发认证功能，前端请求网关的URL不在白名单中间时会“没有认证”的错误，暂时在白名单中添加 全部放行配置，待认证功能开发完成再屏蔽全部放行配置，",-1),Ac=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224115205.png",alt:"image-20230705224115205"})],-1),Cc={id:"_3-用户认证",tabindex:"-1"},dc=s("strong",null,"3 用户认证",-1),uc={id:"_3-1-需求分析",tabindex:"-1"},hc=s("strong",null,"3.1 需求分析",-1),_c=s("p",null,"至此我们了解了使用Spring Security进行认证授权的过程，本节实现用户认证功能。",-1),gc=s("p",null,"目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。",-1),Ec=s("p",null,"本项目也要支持多种认证试。",-1),mc={id:"_3-2-连接用户中心数据库",tabindex:"-1"},fc=s("strong",null,"3.2 连接用户中心数据库",-1),bc={id:"_3-2-1-连接数据库认证",tabindex:"-1"},Sc=s("strong",null,"3.2.1 连接数据库认证",-1),xc=s("p",null,"基于的认证流程在研究Spring Security过程中已经测试通过，到目前为止用户认证流程如下：",-1),vc=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224147514.png",alt:"image-20230705224147514"})],-1),wc=s("p",null,"认证所需要的用户信息存储在用户中心数据库，现在需要将认证服务连接数据库查询用户信息。",-1),kc=s("p",null,"在研究Spring Security的过程中是将用户信息硬编码，如下：",-1),Uc=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UserDetailsService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"userDetailsService"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"InMemoryUserDetailsManager"),s("span",{style:{color:"#A6ACCD"}}," manager "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"InMemoryUserDetailsManager"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    manager"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"createUser"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"zhangsan"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"123"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    manager"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"createUser"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"lisi"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"456"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p2"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," manager"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Ic=s("p",null,"我们要认证服务中连接用户中心数据库查询用户信息。",-1),Bc=s("p",null,"如何使用Spring Security连接数据库认证吗？",-1),jc=s("p",null,"前边学习Spring Security工作原理时有一张执行流程图，如下图：",-1),Tc=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224242929.png",alt:"image-20230705224242929"})],-1),Pc=s("p",null,[l("用户提交账号和密码由DaoAuthenticationProvider调用UserDetailsService的"),s("code",null,"loadUserByUsername()"),l("方法获取UserDetails用户信息。")],-1),Oc=s("p",null,"查询DaoAuthenticationProvider的源代码如下：",-1),Mc=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224313517.png",alt:"image-20230705224313517"})],-1),Lc=s("p",null,"UserDetailsService是一个接口，如下：",-1),Rc=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"package"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"org"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"springframework"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"security"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"core"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"userdetails"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"interface"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserDetailsService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"loadUserByUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"var1"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UsernameNotFoundException"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Wc=s("p",null,"UserDetails是用户信息接口",-1),Jc=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"interface"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"extends"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"Serializable"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"Collection"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"?"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"extends"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"GrantedAuthority"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getAuthorities"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getPassword"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"boolean"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"isAccountNonExpired"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"boolean"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"isAccountNonLocked"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"boolean"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"isCredentialsNonExpired"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"boolean"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"isEnabled"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Nc=s("p",null,[l("我们只要实现UserDetailsService 接口查询数据库得到用户信息返回UserDetails 类型的用户信息即可,框架调用"),s("code",null,"loadUserByUsername()"),l("方法拿到用户信息之后是如何执行的，见下图：")],-1),zc=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224342435.png",alt:"image-20230705224342435"})],-1),Xc=s("p",null,"首先屏蔽原来定义的UserDetailsService。",-1),qc=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//配置用户信息服务")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//    @Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//    public UserDetailsService userDetailsService() {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//        //这里配置用户信息,这里暂时使用这种方式将用户存储在内存中")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},'//        manager.createUser(User.withUsername("zhangsan").password("123").authorities("p1").build());')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},'//        manager.createUser(User.withUsername("lisi").password("456").authorities("p2").build());')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//        return manager;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//    }")]),l(`
`),s("span",{class:"line"})])])],-1),Kc=s("p",null,"下边自定义UserDetailsService",-1),Gc=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Service")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserServiceImpl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"implements"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserDetailsService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUserMapper"),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    /**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * @description 根据账号查询用户信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),s("span",{style:{color:"#676E95","font-style":"italic"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"s"),s("span",{style:{color:"#676E95","font-style":"italic"}},"  账号")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return"),s("span",{style:{color:"#676E95","font-style":"italic"}}," org.springframework.security.core.userdetails.UserDetails")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@author"),s("span",{style:{color:"#676E95","font-style":"italic"}}," Mr.M")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * @date 2022/9/28 18:30")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"loadUserByUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"s"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UsernameNotFoundException"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"selectOne"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"LambdaQueryWrapper"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#89DDFF"}},">()."),s("span",{style:{color:"#82AAFF"}},"eq"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"XcUser"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),s("span",{style:{color:"#A6ACCD"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," s"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"            "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//返回空表示用户不存在")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//取出数据库存储的正确密码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," password  "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getPassword"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//用户权限,如果不加报Cannot pass a null GrantedAuthority collection")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},"[]"),s("span",{style:{color:"#A6ACCD"}}," authorities"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"test"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//创建UserDetails对象,权限信息待实现授权功能时再向UserDetail中加入")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," userDetails "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},"())."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"password"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"authorities"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," userDetails"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Hc=s("p",null,"数据库中的密码加过密的，用户输入的密码是明文，我们需要修改密码格式器PasswordEncoder，原来使用的是NoOpPasswordEncoder，它是通过明文方式比较密码，现在我们修改为BCryptPasswordEncoder，它是将用户输入的密码编码为BCrypt格式与数据库中的密码进行比对。",-1),Vc=s("p",null,"如下：",-1),Zc=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"PasswordEncoder"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"passwordEncoder"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//        //密码为明文方式")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//        return NoOpPasswordEncoder.getInstance();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"BCryptPasswordEncoder"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Qc=s("p",null,"我们通过测试代码测试BCryptPasswordEncoder，如下：",-1),Yc=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"static"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"main"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},"[]"),s("span",{style:{color:"#A6ACCD"}}," args"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," password "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"111111"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"PasswordEncoder"),s("span",{style:{color:"#A6ACCD"}}," passwordEncoder "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"BCryptPasswordEncoder"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"for"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#A6ACCD"}}," i"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F78C6C"}},"0"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#A6ACCD"}},"i"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F78C6C"}},"10"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#A6ACCD"}},"i"),s("span",{style:{color:"#89DDFF"}},"++)"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//每个计算出的Hash值都不一样")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," hashPass "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," passwordEncoder"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"encode"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"password"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        System"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"out"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"println"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"hashPass"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//虽然每次计算的密码Hash值不一样但是校验是通过的")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"boolean"),s("span",{style:{color:"#A6ACCD"}}," f "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," passwordEncoder"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"matches"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"password"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," hashPass"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        System"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"out"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"println"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"f"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),$c=s("p",null,"修改数据库中的密码为Bcrypt格式，并且记录明文密码，稍后申请令牌时需要。",-1),sp=s("p",null,"由于修改密码编码方式还需要将客户端的密钥更改为Bcrypt格式.",-1),lp=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"configure"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"ClientDetailsServiceConfigurer"),s("span",{style:{color:"#A6ACCD"}}," clients"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"          throws Exception "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        clients"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"inMemory"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#676E95","font-style":"italic"}},"// 使用in-memory存储")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withClient"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"XcWebApp"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#676E95","font-style":"italic"}},"// client_id")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},'//                .secret("secret")//客户端密钥')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"secret"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"BCryptPasswordEncoder"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"encode"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"XcWebApp"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"))"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//客户端密钥")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"resourceIds"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"xuecheng-plus"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//资源列表")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"authorizedGrantTypes"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"authorization_code"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"password"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"client_credentials"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"implicit"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"refresh_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#676E95","font-style":"italic"}},"// 该client允许的授权类型authorization_code,password,refresh_token,implicit,client_credentials")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"scopes"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"all"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#676E95","font-style":"italic"}},"// 允许的授权范围")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"autoApprove"),s("span",{style:{color:"#89DDFF"}},"(false)"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//false跳转到授权页面")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"                "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//客户端接收授权码的重定向地址")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"redirectUris"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"http://www.51xuecheng.cn"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),op=s("p",null,"现在重启认证服务。",-1),np=s("p",null,"下边使用httpclient进行测试：",-1),ep=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"### 密码模式")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"POST"),s("span",{style:{color:"#A6ACCD"}}," {{auth_host}}/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=password&username=stu1&password=111111")]),l(`
`),s("span",{class:"line"})])])],-1),ap=s("p",null,"输入正确的账号和密码，申请令牌成功。",-1),tp=s("p",null,"输入错误的密码，报错：",-1),cp=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"error"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"invalid_grant"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"error_description"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"用户名或密码错误"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),pp=s("p",null,"输入错误的账号，报错：",-1),rp=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"error"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"unauthorized"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"error_description"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"UserDetailsService returned null, which is an interface contract violation"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Dp={id:"_3-2-2-扩展用户身份信息",tabindex:"-1"},yp=s("strong",null,"3.2.2 扩展用户身份信息",-1),ip=s("p",null,"用户表中存储了用户的账号、手机号、email，昵称、qq等信息，UserDetails接口只返回了username、密码等信息，如下：",-1),Fp=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"interface"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"extends"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"Serializable"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"Collection"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"?"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"extends"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"GrantedAuthority"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getAuthorities"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getPassword"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"boolean"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"isAccountNonExpired"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"boolean"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"isAccountNonLocked"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"boolean"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"isCredentialsNonExpired"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"boolean"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"isEnabled"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Ap=s("p",null,"我们需要扩展用户身份的信息，在jwt令牌中存储用户的昵称、头像、qq等信息。",-1),Cp=s("p",null,"如何扩展Spring Security的用户身份信息呢？",-1),dp=s("p",null,"在认证阶段DaoAuthenticationProvider会调用UserDetailService查询用户的信息，这里是可以获取到齐全的用户信息的。由于JWT令牌中用户身份信息来源于UserDetails，UserDetails中仅定义了username为用户的身份信息，这里有两个思路：第一是可以扩展UserDetails，使之包括更多的自定义属性，第二也可以扩展username的内容 ，比如存入json数据内容作为username的内容。相比较而言，方案二比较简单还不用破坏UserDetails的结构，我们采用方案二。",-1),up=s("p",null,"修改UserServiceImpl如下：",-1),hp=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Service")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserServiceImpl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"implements"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserDetailsService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUserMapper"),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    /**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * @description 根据账号查询用户信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),s("span",{style:{color:"#676E95","font-style":"italic"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"s"),s("span",{style:{color:"#676E95","font-style":"italic"}},"  账号")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return"),s("span",{style:{color:"#676E95","font-style":"italic"}}," org.springframework.security.core.userdetails.UserDetails")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@author"),s("span",{style:{color:"#676E95","font-style":"italic"}}," Mr.M")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * @date 2022/9/28 18:30")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"loadUserByUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"s"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UsernameNotFoundException"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"selectOne"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"LambdaQueryWrapper"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#89DDFF"}},">()."),s("span",{style:{color:"#82AAFF"}},"eq"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"XcUser"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),s("span",{style:{color:"#A6ACCD"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," s"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"            "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//返回空表示用户不存在")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//取出数据库存储的正确密码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," password  "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getPassword"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//用户权限,如果不加报Cannot pass a null GrantedAuthority collection")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},"[]"),s("span",{style:{color:"#A6ACCD"}}," authorities "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"       "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//为了安全在令牌中不放密码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setPassword"),s("span",{style:{color:"#89DDFF"}},"(null);")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//将user对象转json")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," userString "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," JSON"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"toJSONString"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//创建UserDetails对象")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," userDetails "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userString"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"password"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"authorities"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," userDetails"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),_p=s("p",null,"重启认证服务，重新生成令牌，生成成功。",-1),gp=s("p",null,[l("我们可以使用"),s("code",null,"check_token"),l("查询jwt的内容")],-1),Ep=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"###校验jwt令牌")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"POST"),s("span",{style:{color:"#A6ACCD"}}," {{auth_host}}/oauth/check_token?token=")]),l(`
`),s("span",{class:"line"})])])],-1),mp=s("p",null,"响应示例如下，",-1),fp=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"aud"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"[")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"res1"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"],")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"user_name"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"{"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"birthday"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"2022-09-28T19:28:46"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"createTime"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"2022-09-28T08:32:03"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"id"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"50"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"name"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"学生1"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"nickname"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"大水牛"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"password"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"$2a$10$0pt7WlfTbnPDTcWtp/.2Mu5CTXvohnNQhR628qq4RoKSc0dGAdEgm"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"sex"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"1"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"status"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"1"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"username"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"stu1"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"userpic"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"http://file.51xuecheng.cn/dddf"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},","),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"utype"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},":"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"101001"),s("span",{style:{color:"#A6ACCD"}},'\\"'),s("span",{style:{color:"#C3E88D"}},"}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"scope"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"[")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"all"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"],")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"active"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true,")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"exp"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"1664372184"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"authorities"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"[")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p1"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"],")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"jti"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"73da9f7b-bd8c-45ac-9add-46b711d11fb8"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"client_id"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"c1"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),bp=s("p",null,[s("code",null,"user_name"),l("存储了用户信息的json格式，在资源服务中就可以取出该json格式的内容转为用户对象去使用。")],-1),Sp={id:"_3-2-3-资源服务获取用户身份",tabindex:"-1"},xp=s("strong",null,"3.2.3 资源服务获取用户身份",-1),vp=s("p",null,"下边编写一个工具类在各个微服务中去使用，获取当前登录用户的对象。",-1),wp=s("p",null,[l("在"),s("code",null,"content-api"),l("中定义此类：")],-1),kp=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * @description 获取当前用户身份工具类")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"@Slf"),s("span",{style:{color:"#F78C6C"}},"4"),s("span",{style:{color:"#A6ACCD"}},"j")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"public class SecurityUtil "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    public static XcUser getUser() {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        try {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            Object principalObj = SecurityContextHolder.getContext().getAuthentication().getPrincipal();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            if (principalObj instanceof String) {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//取出用户身份信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                String principal = principalObj.toString();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//将json转成对象")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                XcUser user = JSON.parseObject(principal, XcUser.class);")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                return user;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        } catch (Exception e) "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            log.error("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"获取当前登录用户身份出错:{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}},", e.getMessage());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            e.printStackTrace();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        return "),s("span",{style:{color:"#89DDFF"}},"null"),s("span",{style:{color:"#A6ACCD"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    }")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    @Data")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    public static class XcUser implements Serializable "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private static final long serialVersionUID = 1L;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String id;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String username;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String password;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String salt;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String name;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String nickname;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String wxUnionid;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String companyId;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"         * 头像")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"         */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String userpic;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String utype;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private LocalDateTime birthday;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String sex;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String email;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String cellphone;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String qq;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"         * 用户状态")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"         */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private String status;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private LocalDateTime createTime;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        private LocalDateTime updateTime;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Up=s("p",null,"下边在内容管理服务中测试此工具类，以查询课程信息接口为例：",-1),Ip=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ApiOperation"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"根据课程id查询课程基础信息"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"GetMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/course/{courseId}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"CourseBaseInfoDto"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getCourseBaseById"),s("span",{style:{color:"#89DDFF"}},"(@"),s("span",{style:{color:"#C792EA"}},"PathVariable"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"courseId"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Long"),s("span",{style:{color:"#A6ACCD"}}," courseId"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//取出当前用户身份")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//    Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#C792EA"}},"SecurityUtil"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," SecurityUtil"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getUser"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    System"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"out"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"println"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," courseBaseInfoService"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getCourseBaseInfo"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"courseId"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Bp=s("p",null,"重启内容管理服务：",-1),jp=s("p",null,"1、启动认证服务、网关、内容管理服务",-1),Tp=s("p",null,"2、生成新的令牌",-1),Pp=s("p",null,"3、携带令牌访问内容管理服务的查询课程接口",-1),Op=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224419107.png",alt:"image-20230705224419107"})],-1),Mp={id:"_3-3-支持认证方式多样",tabindex:"-1"},Lp=s("strong",null,"3.3 支持认证方式多样",-1),Rp={id:"_3-3-1-统一认证入口",tabindex:"-1"},Wp=s("strong",null,"3.3.1 统一认证入口",-1),Jp=s("p",null,"目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。基于当前研究的Spring Security认证流程如何支持多样化的认证方式呢？",-1),Np=s("p",null,"1、支持账号和密码认证",-1),zp=s("p",null,"采用OAuth2协议的密码模式即可实现。",-1),Xp=s("p",null,"2、支持手机号加验证码认证",-1),qp=s("p",null,"用户认证提交的是手机号和验证码，并不是账号和密码。",-1),Kp=s("p",null,"3、微信扫码认证",-1),Gp=s("p",null,"基于OAuth2协议与微信交互，学成在线网站向微信服务器申请到一个令牌，然后携带令牌去微信查询用户信息，查询成功则用户在学成在线项目认证通过。",-1),Hp=s("p",null,[l("目前我们测试通过OAuth2的密码模式，用户认证会提交账号和密码，由DaoAuthenticationProvider调用UserDetailsService的"),s("code",null,"loadUserByUsername()"),l("方法获取UserDetails用户信息。")],-1),Vp=s("p",null,[l("在前边我们自定义了UserDetailsService接口实现类，通过"),s("code",null,"loadUserByUsername()"),l("方法根据账号查询用户信息。")],-1),Zp=s("p",null,"而不同的认证方式提交的数据不一样，比如：手机加验证码方式会提交手机号和验证码，账号密码方式会提交账号、密码、验证码。",-1),Qp=s("p",null,[l("我们可以在"),s("code",null,"loadUserByUsername()"),l("方法上作文章，将用户原来提交的账号数据改为提交json数据，json数据可以扩展不同认证方式所提交的各种参数。")],-1),Yp=s("p",null,"首先创建一个DTO类表示认证的参数：",-1),$p=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * @description 认证用户请求参数")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Data")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"AuthParamsDto"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," username"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//用户名")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," password"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//域  用于扩展")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," cellphone"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//手机号")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," checkcode"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//验证码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," checkcodekey"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//验证码key")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," authType"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#676E95","font-style":"italic"}},"// 认证的类型   password:用户名密码模式类型    sms:短信模式类型")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Map"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Object"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," payload "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"HashMap"),s("span",{style:{color:"#89DDFF"}},"<>();"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//附加数据，作为扩展，不同认证类型可拥有不同的附加数据。如认证类型为短信时包含smsKey : sms:3d21042d054548b08477142bbca95cfa; 所有情况下都包含clientId")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),sr=s("p",null,[l("此时"),s("code",null,"loadUserByUsername()"),l("方法可以修改如下：")],-1),lr=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * @description 自定义UserDetailsService用来对接Spring Security")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Slf4j")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Service")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserServiceImpl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"implements"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserDetailsService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUserMapper"),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    /**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * @description 查询用户信息组成用户身份信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),s("span",{style:{color:"#676E95","font-style":"italic"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"s"),s("span",{style:{color:"#676E95","font-style":"italic"}},"  AuthParamsDto类型的json数据")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return"),s("span",{style:{color:"#676E95","font-style":"italic"}}," org.springframework.security.core.userdetails.UserDetails")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@author"),s("span",{style:{color:"#676E95","font-style":"italic"}}," Mr.M")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * @date 2022/9/28 18:30")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"loadUserByUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"s"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UsernameNotFoundException"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"AuthParamsDto"),s("span",{style:{color:"#A6ACCD"}}," authParamsDto "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"try"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"            "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//将认证参数转为AuthParamsDto类型")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            authParamsDto "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," JSON"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"parseObject"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"s"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," AuthParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"class"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"catch"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"Exception"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"e"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            log"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"info"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"认证请求不符合项目要求:{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"s"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RuntimeException"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"认证请求数据格式不对"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//账号")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," username "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," authParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"selectOne"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"LambdaQueryWrapper"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#89DDFF"}},">()."),s("span",{style:{color:"#82AAFF"}},"eq"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"XcUser"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),s("span",{style:{color:"#A6ACCD"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," username"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"            "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//返回空表示用户不存在")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//取出数据库存储的正确密码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," password  "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getPassword"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//用户权限,如果不加报Cannot pass a null GrantedAuthority collection")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},"[]"),s("span",{style:{color:"#A6ACCD"}}," authorities "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//将user对象转json")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," userString "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," JSON"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"toJSONString"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//创建UserDetails对象")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," userDetails "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userString"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"password"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"authorities"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," userDetails"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),or=s("p",null,"原来的DaoAuthenticationProvider 会进行密码校验，现在重新定义DaoAuthenticationProviderCustom类，重写类的additionalAuthenticationChecks方法。",-1),nr=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"package"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"com"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"xuecheng"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"auth"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"config"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"import"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"lombok"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"extern"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"slf4j"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"Slf4j"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"import"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"org"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"springframework"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"beans"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"factory"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"annotation"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"Autowired"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"import"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"org"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"springframework"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"security"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"authentication"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"BadCredentialsException"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"import"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"org"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"springframework"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"security"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"authentication"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"UsernamePasswordAuthenticationToken"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"import"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"org"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"springframework"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"security"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"authentication"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"dao"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"DaoAuthenticationProvider"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"import"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"org"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"springframework"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"security"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"core"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"AuthenticationException"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"import"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"org"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"springframework"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"security"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"core"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"userdetails"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"import"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"org"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"springframework"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"security"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"core"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"userdetails"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"UserDetailsService"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"import"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"org"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"springframework"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"stereotype"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#C792EA"}},"Component"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * @description 自定义DaoAuthenticationProvider")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Slf4j")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Component")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"DaoAuthenticationProviderCustom"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"extends"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"DaoAuthenticationProvider"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"setUserDetailsService"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"UserDetailsService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"userDetailsService"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  super"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setUserDetailsService"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userDetailsService"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}}," "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//屏蔽密码对比")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"protected"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"additionalAuthenticationChecks"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"userDetails"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UsernamePasswordAuthenticationToken"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"authentication"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"AuthenticationException"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),er=s("p",null,"修改WebSecurityConfig类指定daoAuthenticationProviderCustom",-1),ar=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"DaoAuthenticationProviderCustom"),s("span",{style:{color:"#A6ACCD"}}," daoAuthenticationProviderCustom"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"protected"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"configure"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"AuthenticationManagerBuilder"),s("span",{style:{color:"#A6ACCD"}}," auth"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," throws Exception "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    auth"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"authenticationProvider"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"daoAuthenticationProviderCustom"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),tr=s("p",null,"此时可以重启认证服务，测试申请令牌接口，传入的账号信息改为json数据，如下：",-1),cr=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"################扩展认证请求参数后######################")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"###密码模式")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"POST"),s("span",{style:{color:"#A6ACCD"}},' {{auth_host}}/auth/oauth/token?client_id=XcWebApp&client_secret=XcWebApp&grant_type=password&username={"username":"stu1","authType":"password","password":"111111"}')]),l(`
`),s("span",{class:"line"})])])],-1),pr=s("p",null,[l("经过测试发现"),s("code",null,"loadUserByUsername()"),l("方法可以正常接收到认证请求中的json数据。")],-1),rr=s("p",null,"有了这些认证参数我们可以定义一个认证Service接口去进行各种方式的认证。",-1),Dr=s("p",null,"定义用户信息，为了扩展性让它继承XcUser",-1),yr=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Data")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"XcUserExt"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"extends"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),ir=s("p",null,"定义认证Service 接口",-1),Fr=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * @description 认证service")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"interface"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"AuthService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"   /**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    * @description 认证方法")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),s("span",{style:{color:"#676E95","font-style":"italic"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"authParamsDto"),s("span",{style:{color:"#676E95","font-style":"italic"}}," 认证参数")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return"),s("span",{style:{color:"#676E95","font-style":"italic"}}," com.xuecheng.ucenter.model.po.XcUser 用户信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"   */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#C792EA"}},"XcUserExt"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"execute"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"AuthParamsDto"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"authParamsDto"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Ar=s("p",null,"loadUserByUsername()修改如下：",-1),Cr=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Slf4j")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Service")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserServiceImpl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"implements"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserDetailsService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUserMapper"),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"ApplicationContext"),s("span",{style:{color:"#A6ACCD"}}," applicationContext"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    /**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * @description 查询用户信息组成用户身份信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),s("span",{style:{color:"#676E95","font-style":"italic"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"s"),s("span",{style:{color:"#676E95","font-style":"italic"}},"  AuthParamsDto类型的json数据")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return"),s("span",{style:{color:"#676E95","font-style":"italic"}}," org.springframework.security.core.userdetails.UserDetails")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"loadUserByUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"s"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UsernameNotFoundException"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"AuthParamsDto"),s("span",{style:{color:"#A6ACCD"}}," authParamsDto "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"try"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"            "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//将认证参数转为AuthParamsDto类型")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            authParamsDto "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," JSON"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"parseObject"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"s"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," AuthParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"class"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"catch"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"Exception"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"e"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            log"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"info"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"认证请求不符合项目要求:{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"s"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RuntimeException"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"认证请求数据格式不对"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//开始认证")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        authService"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"execute"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"authParamsDto"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},".....")]),l(`
`),s("span",{class:"line"})])])],-1),dr=s("p",null,"到此我们基于Spring Security认证流程修改为如下：",-1),ur=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224445890.png",alt:"image-20230705224445890"})],-1),hr={id:"_3-3-2-实现账号密码认证",tabindex:"-1"},_r=s("strong",null,"3.3.2 实现账号密码认证",-1),gr=s("p",null,"上节定义了AuthService认证接口，下边实现该接口实现账号密码认证",-1),Er=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * @description 账号密码认证")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Service"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"password_authservice"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"PasswordAuthServiceImpl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"implements"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"AuthService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"XcUserMapper"),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"PasswordEncoder"),s("span",{style:{color:"#A6ACCD"}}," passwordEncoder"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"XcUserExt"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"execute"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"AuthParamsDto"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"authParamsDto"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"  "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//账号")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," username "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," authParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"selectOne"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"LambdaQueryWrapper"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#89DDFF"}},">()."),s("span",{style:{color:"#82AAFF"}},"eq"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"XcUser"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),s("span",{style:{color:"#A6ACCD"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," username"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"   "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//返回空表示用户不存在")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RuntimeException"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"账号不存在"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"XcUserExt"),s("span",{style:{color:"#A6ACCD"}}," xcUserExt "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"XcUserExt"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  BeanUtils"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"copyProperties"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"xcUserExt"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"  "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//校验密码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"  "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//取出数据库存储的正确密码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," passwordDb  "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getPassword"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," passwordForm "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," authParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getPassword"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"boolean"),s("span",{style:{color:"#A6ACCD"}}," matches "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," passwordEncoder"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"matches"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"passwordForm"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," passwordDb"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"(!"),s("span",{style:{color:"#A6ACCD"}},"matches"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RuntimeException"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"账号或密码错误"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," xcUserExt"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),mr=s("p",null,"修改UserServiceImpl类，根据认证方式使用不同的认证bean",-1),fr=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * @description 自定义UserDetailsService用来对接Spring Security")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Slf4j")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Service")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserServiceImpl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"implements"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"UserDetailsService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUserMapper"),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"ApplicationContext"),s("span",{style:{color:"#A6ACCD"}}," applicationContext"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//    @Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//    AuthService authService;")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    /**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * @description 查询用户信息组成用户身份信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),s("span",{style:{color:"#676E95","font-style":"italic"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"s"),s("span",{style:{color:"#676E95","font-style":"italic"}},"  AuthParamsDto类型的json数据")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return"),s("span",{style:{color:"#676E95","font-style":"italic"}}," org.springframework.security.core.userdetails.UserDetails")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"loadUserByUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"s"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UsernameNotFoundException"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"AuthParamsDto"),s("span",{style:{color:"#A6ACCD"}}," authParamsDto "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"try"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"            "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//将认证参数转为AuthParamsDto类型")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            authParamsDto "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," JSON"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"parseObject"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"s"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," AuthParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"class"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"catch"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"Exception"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"e"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            log"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"info"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"认证请求不符合项目要求:{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"s"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RuntimeException"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"认证请求数据格式不对"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//认证方法")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," authType "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," authParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getAuthType"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"AuthService"),s("span",{style:{color:"#A6ACCD"}}," authService "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}},"  applicationContext"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getBean"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"authType "),s("span",{style:{color:"#89DDFF"}},"+"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"_authservice"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"AuthService"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"class"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"XcUserExt"),s("span",{style:{color:"#A6ACCD"}}," user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," authService"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"execute"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"authParamsDto"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getUserPrincipal"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    /**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * @description 查询用户信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),s("span",{style:{color:"#676E95","font-style":"italic"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"user"),s("span",{style:{color:"#676E95","font-style":"italic"}},"  用户id，主键")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),s("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return"),s("span",{style:{color:"#676E95","font-style":"italic"}}," com.xuecheng.ucenter.model.po.XcUser 用户信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getUserPrincipal"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"XcUserExt"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"user"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//用户权限,如果不加报Cannot pass a null GrantedAuthority collection")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},"[]"),s("span",{style:{color:"#A6ACCD"}}," authorities "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," password "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getPassword"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//为了安全在令牌中不放密码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setPassword"),s("span",{style:{color:"#89DDFF"}},"(null);")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//将user对象转json")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," userString "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," JSON"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"toJSONString"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//创建UserDetails对象")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," userDetails "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userString"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"password "),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"authorities"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," userDetails"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),br=s("p",null,"重启认证服务，测试申请令牌接口。",-1),Sr=s("p",null,"1、测试账号和密码都正确的情况是否可以申请令牌成功。",-1),xr=s("p",null,"2、测试密码错误的情况。",-1),vr=s("p",null,"3、测试账号不存在情况。",-1),wr={id:"_3-4-验证码服务",tabindex:"-1"},kr=s("strong",null,"3.4 验证码服务",-1),Ur={id:"_3-4-1-创建验证码服务工程",tabindex:"-1"},Ir=s("strong",null,"3.4.1 创建验证码服务工程",-1),Br=s("p",null,"在认证时一般都需要输入验证码，验证码有什么用？",-1),jr=s("p",null,"验证码可以防止恶性攻击，比如：XSS跨站脚本攻击、CSRF跨站请求伪造攻击，一些比较复杂的图形验证码可以有效的防止恶性攻击。",-1),Tr=s("p",null,"为了保护系统的安全在一些比较重要的操作都需要验证码。",-1),Pr=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224522221.png",alt:"image-20230705224522221"})],-1),Or=s("p",null,"验证码的类型也有很多：图片、语音、手机短信验证码等。",-1),Mr=s("p",null,"本项目创建单独的验证码服务为各业务提供验证码的生成、校验等服务。",-1),Lr=s("p",null,"拷贝课程资料目录xuecheng-plus-checkcode验证码服务工程到自己的工程目录。",-1),Rr=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224535229.png",alt:"image-20230705224535229"})],-1),Wr=s("p",null,"定义nacos配置文件",-1),Jr=s("div",{class:"language-yaml"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"server"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#F07178"}},"servlet"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"context-path"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"/checkcode")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#F07178"}},"port"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"63075")]),l(`
`),s("span",{class:"line"})])])],-1),Nr=s("p",null,"注意修改bootstrap.yml中的命名空间为自己定义的命名空间。",-1),zr=s("p",null,"配置redis-dev.yaml，",-1),Xr=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224558927.png",alt:"image-20230705224558927"})],-1),qr=s("p",null,"内容如下：",-1),Kr=s("div",{class:"language-yaml"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"spring"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#F07178"}},"redis"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"host"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"192.168.101.65")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"port"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"6379")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"password"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"redis")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"database"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"0")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"lettuce"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"      "),s("span",{style:{color:"#F07178"}},"pool"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#F07178"}},"max-active"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"20")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#F07178"}},"max-idle"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"10")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#F07178"}},"min-idle"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"0")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F07178"}},"timeout"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"10000")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"#redisson:")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"      "),s("span",{style:{color:"#676E95","font-style":"italic"}},"#配置文件目录")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"      "),s("span",{style:{color:"#676E95","font-style":"italic"}},"#config: classpath:singleServerConfig.yaml")]),l(`
`),s("span",{class:"line"})])])],-1),Gr={id:"_3-4-2-验证码接口测试",tabindex:"-1"},Hr=s("strong",null,"3.4.2 验证码接口测试",-1),Vr=s("p",null,"验证码服务对外提供的接口有：",-1),Zr=s("p",null,"1、生成验证码",-1),Qr=s("p",null,"2、校验验证码。",-1),Yr=s("p",null,"如下：",-1),$r=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224626767.png",alt:"image-20230705224626767"})],-1),sD=s("p",null,"验证码服务如何生成并校验验证码？",-1),lD=s("p",null,"拿图片验证码举例：",-1),oD=s("p",null,"1、先生成一个指定位数的验证码，根据需要可能是数字、数字字母组合或文字。",-1),nD=s("p",null,"2、根据生成的验证码生成一个图片并返回给页面",-1),eD=s("p",null,"3、给生成的验证码分配一个key，将key和验证码一同存入缓存。这个key和图片一同返回给页面。",-1),aD=s("p",null,"4、用户输入验证码，连同key一同提交至认证服务。",-1),tD=s("p",null,"5、认证服务拿key和输入的验证码请求验证码服务去校验",-1),cD=s("p",null,"6、验证码服务根据key从缓存取出正确的验证码和用户输入的验证码进行比对，如果相同则校验通过，否则不通过。",-1),pD=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224639354.png",alt:"image-20230705224639354"})],-1),rD=s("p",null,"根据接口分析，验证码服务接口如下：",-1),DD=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Api"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"value"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"验证码服务接口"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RestController")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"CheckCodeController"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ApiOperation"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"value"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"生成验证信息"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"notes"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"生成验证信息"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"PostMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"value"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/pic"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"CheckCodeResultDto"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"generatePicCheckCode"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"CheckCodeParamsDto"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"checkCodeParamsDto"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ApiOperation"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"value"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"校验"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"notes"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"校验"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ApiImplicitParams"),s("span",{style:{color:"#89DDFF"}},"({")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ApiImplicitParam"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"name"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"name"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"value"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"业务名称"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"required"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true,"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"dataType"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"String"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"paramType"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"query"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"),")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ApiImplicitParam"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"name"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"key"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"value"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"验证key"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"required"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true,"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"dataType"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"String"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"paramType"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"query"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"),")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ApiImplicitParam"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"name"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"code"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"value"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"验证码"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"required"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true,"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"dataType"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"String"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"paramType"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"query"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"})")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"PostMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"value"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/verify"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Boolean"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"verify"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"key"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"code"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),yD=s("p",null,"1、生成验证码接口",-1),iD=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"### 申请验证码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"POST"),s("span",{style:{color:"#A6ACCD"}}," {{checkcode_host}}/checkcode/pic")]),l(`
`),s("span",{class:"line"})])])],-1),FD=s("p",null,"2、校验验证码接口",-1),AD=s("p",null,"根据生成验证码返回的key以及日志中输出正确的验证码去测试。",-1),CD=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"### 校验验证码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"POST"),s("span",{style:{color:"#A6ACCD"}}," {{checkcode_host}}/checkcode/verify?key=checkcode4506b95bddbe46cdb0d56810b747db1b&code=70dl")]),l(`
`),s("span",{class:"line"})])])],-1),dD={id:"_3-5-账号密码认证",tabindex:"-1"},uD=s("strong",null,"3.5 账号密码认证",-1),hD={id:"_3-5-1-需求分析",tabindex:"-1"},_D=s("strong",null,"3.5.1 需求分析",-1),gD=s("p",null,"到目前为止账号和密码认证所需要的技术、组件都已开发完毕，下边实现账号密码认证，输出如下图：",-1),ED=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224656789.png",alt:"image-20230705224656789"})],-1),mD=s("p",null,"执行流程如下：",-1),fD=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224709647.png",alt:"image-20230705224709647"})],-1),bD={id:"_3-5-2-账号密码认证开发",tabindex:"-1"},SD=s("strong",null,"3.5.2 账号密码认证开发",-1),xD=s("p",null,"1、在认证服务定义远程调用验证码服务的接口",-1),vD=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * @description 搜索服务远程接口")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"FeignClient"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"value"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"checkcode"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#FFCB6B"}},"fallbackFactory"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," CheckCodeClientFactory"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"class"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RequestMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/checkcode"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"interface"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"CheckCodeClient"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"PostMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"value"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/verify"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Boolean"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"verify"),s("span",{style:{color:"#89DDFF"}},"(@"),s("span",{style:{color:"#C792EA"}},"RequestParam"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"key"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"key"),s("span",{style:{color:"#89DDFF"}},",@"),s("span",{style:{color:"#C792EA"}},"RequestParam"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"code"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"code"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),wD=s("p",null,"CheckCodeClientFactory:",-1),kD=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Slf4j")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Component")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"CheckCodeClientFactory"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"implements"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"FallbackFactory"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"CheckCodeClient"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"CheckCodeClient"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"create"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"Throwable"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"throwable"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"CheckCodeClient"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Boolean"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"verify"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"key"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"code"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                log"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"debug"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"调用验证码服务熔断异常:{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," throwable"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getMessage"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),UD=s("p",null,"启动类添加：",-1),ID=s("p",null,[s("code",null,'@EnableFeignClients(basePackages={"com.xuecheng.*.feignclient"})')],-1),BD=s("p",null,"配置文件引入feign-dev.yaml",-1),jD=s("div",{class:"language-yaml"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"-"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F07178"}},"data-id"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"feign-${spring.profiles.active}.yaml")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#F07178"}},"group"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"xuecheng-plus-common")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#F07178"}},"refresh"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FF9CAC"}},"true")]),l(`
`),s("span",{class:"line"})])])],-1),TD=s("p",null,"2、完善PasswordAuthServiceImpl",-1),PD=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * @description 账号密码认证")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Service"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"password_authservice"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"PasswordAuthServiceImpl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"implements"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"AuthService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"XcUserMapper"),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"PasswordEncoder"),s("span",{style:{color:"#A6ACCD"}}," passwordEncoder"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"CheckCodeClient"),s("span",{style:{color:"#A6ACCD"}}," checkCodeClient"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"execute"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"AuthParamsDto"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"authParamsDto"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"  "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//校验验证码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," checkcode "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," authParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getCheckcode"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," checkcodekey "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," authParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getCheckcodekey"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"StringUtils"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"isBlank"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"checkcodekey"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"||"),s("span",{style:{color:"#A6ACCD"}}," StringUtils"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"isBlank"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"checkcode"),s("span",{style:{color:"#89DDFF"}},")){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RuntimeException"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"验证码为空"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"Boolean"),s("span",{style:{color:"#A6ACCD"}}," verify "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," checkCodeClient"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"verify"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"checkcodekey"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," checkcode"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"(!"),s("span",{style:{color:"#A6ACCD"}},"verify"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RuntimeException"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"验证码输入错误"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"  "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//账号")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," username "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," authParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"selectOne"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"LambdaQueryWrapper"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#89DDFF"}},">()."),s("span",{style:{color:"#82AAFF"}},"eq"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"XcUser"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),s("span",{style:{color:"#A6ACCD"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," username"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"   "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//返回空表示用户不存在")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RuntimeException"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"账号不存在"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"  "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//校验密码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"  "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//取出数据库存储的正确密码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," passwordDb  "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getPassword"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," passwordForm "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," authParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getPassword"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#C792EA"}},"boolean"),s("span",{style:{color:"#A6ACCD"}}," matches "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," passwordEncoder"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"matches"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"passwordForm"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," passwordDb"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"(!"),s("span",{style:{color:"#A6ACCD"}},"matches"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RuntimeException"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"账号或密码错误"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," user"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),OD=s("p",null,"小技巧：目前账号密码方式添加了验证码校验，为了后期获取令牌方便可以重新定义一个不需要验证码校验的认证类AuthService ，AuthService 中去掉验证码的校验，方便生成令牌。",-1),MD={id:"_3-5-3-账号密码认证测试",tabindex:"-1"},LD=s("strong",null,"3.5.3 账号密码认证测试",-1),RD=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224731189.png",alt:"image-20230705224731189"})],-1),WD=s("p",null,"2、首先测试验证码，分别输入正确的验证码和错误的验证码进行测试",-1),JD=s("p",null,"3、输入正确的账号密码和错误的账号密码进行测试",-1),ND=s("p",null,"登录成功将jwt令牌存储cookie.",-1),zD=s("p",null,"4、测试自动登录",-1),XD=s("p",null,"勾选自动登录cookie生成时间为30天，不勾选自动登录关闭浏览器窗口后自动删除cookie。",-1),qD={id:"_4-微信扫码登录",tabindex:"-1"},KD=s("strong",null,"4 微信扫码登录",-1),GD={id:"_4-1-接入规范",tabindex:"-1"},HD=s("strong",null,"4.1 接入规范",-1),VD={id:"_4-1-1-接入流程",tabindex:"-1"},ZD=s("strong",null,"4.1.1 接入流程",-1),QD=s("p",null,"微信扫码登录基于OAuth2协议的授权码模式，",-1),YD=s("p",null,"接口文档：",-1),$D=s("p",null,"流程如下：",-1),sy=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224756059.png",alt:"image-20230705224756059"})],-1),ly=s("p",null,"第三方应用获取access_token令牌后即可请求微信获取用户的信息，成功获取到用户的信息表示用户在第三方应用认证成功。",-1),oy={id:"_4-1-2-请求获取授权码",tabindex:"-1"},ny=s("strong",null,"4.1.2 请求获取授权码",-1),ey=s("code",null,"scope=snsapi_login",-1),ay=s("code",null,"redirect_uri",-1),ty=s("code",null,"snsapi_login",-1),cy=s("p",null,[s("strong",null,"参数说明")],-1),py=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705224807325.png",alt:"image-20230705224807325"})],-1),ry=s("p",null,[s("strong",null,"返回说明")],-1),Dy=s("p",null,[l("用户允许授权后，将会重定向到"),s("code",null,"redirect_uri"),l("的网址上，并且带上 code 和state参数")],-1),yy=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"redirect_uri?code=CODE&state=STATE")]),l(`
`),s("span",{class:"line"})])])],-1),iy=s("p",null,"若用户禁止授权，则不会发生重定向。",-1),Fy=s("p",null,"步骤1：在页面中先引入如下 JS 文件（支持https）：",-1),Ay=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js")]),l(`
`),s("span",{class:"line"})])])],-1),Cy=s("p",null,"步骤2：在需要使用微信登录的地方实例以下 JS 对象：",-1),dy=s("div",{class:"language-js"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"var"),s("span",{style:{color:"#A6ACCD"}}," obj "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"WxLogin"),s("span",{style:{color:"#A6ACCD"}},"("),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F07178"}},"self_redirect"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#FF9CAC"}},"true"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F07178"}},"id"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"login_container"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F07178"}},"appid"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'""'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F07178"}},"scope"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'""'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F07178"}},"redirect_uri"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'""'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#F07178"}},"state"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'""'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F07178"}},"style"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'""'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F07178"}},"href"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'""')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"}"),s("span",{style:{color:"#A6ACCD"}},")"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"})])])],-1),uy=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225019477.png",alt:"image-20230705225019477"})],-1),hy={id:"_4-1-3-通过-code-获取access-token",tabindex:"-1"},_y=s("strong",null,"4.1.3 通过 code 获取access_token",-1),gy=s("p",null,[l("通过 code 获取"),s("code",null,"access_token")],-1),Ey=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&secret=SECRET&code=CODE&grant_type=authorization_code")]),l(`
`),s("span",{class:"line"})])])],-1),my=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225158430.png",alt:"image-20230705225158430"})],-1),fy=s("p",null,[s("strong",null,"返回说明")],-1),by=s("p",null,"正确的返回：",-1),Sy=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"access_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"ACCESS_TOKEN"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"expires_in"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#F78C6C"}},"7200"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"refresh_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"REFRESH_TOKEN"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"openid"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"OPENID"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"scope"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"SCOPE"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"unionid"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"o6_bmasdasdsad6_2sgVt7hMZOPfL"),s("span",{style:{color:"#89DDFF"}},'"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),xy=s("p",null,[s("strong",null,"参数说明")],-1),vy=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225227368.png",alt:"image-20230705225227368"})],-1),wy=s("p",null,"错误返回样例：",-1),ky=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"errcode"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#F78C6C"}},"40029"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C792EA"}},"errmsg"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"invalid code"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Uy={id:"_4-1-4-通过access-token调用接口",tabindex:"-1"},Iy=s("strong",null,"4.1.4 通过access_token调用接口",-1),By=s("p",null,"获取access_token后，进行接口调用，有以下前提：",-1),jy=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"access_token有效且未超时；")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"微信用户已授权给第三方应用帐号相应接口作用域（scope）。")]),l(`
`),s("span",{class:"line"})])])],-1),Ty=s("p",null,"对于接口作用域（scope），能调用的接口有以下：",-1),Py=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225242753.png",alt:"image-20230705225242753"})],-1),Oy=s("code",null,"snsapi_base",-1),My=s("code",null,"snsapi_base",-1),Ly=s("code",null,"snsapi_base",-1),Ry=s("code",null,"snsapi_base",-1),Wy=s("p",null,"接口地址",-1),Jy=s("div",{class:"language-http"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"http请求方式"),s("span",{style:{color:"#F78C6C"}},":"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C3E88D"}},"GET")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&openid=OPENID")]),l(`
`),s("span",{class:"line"})])])],-1),Ny=s("p",null,"如下：",-1),zy=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225302910.png",alt:"image-20230705225302910"})],-1),Xy=s("p",null,"响应：",-1),qy=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225337018.png",alt:"image-20230705225337018"})],-1),Ky=s("p",null,"说明如下：",-1),Gy=s("blockquote",null,[s("p",null,"参数 说明 openid 普通用户的标识，对当前开发者帐号唯一 nickname 普通用户昵称 sex 普通用户性别，1为男性，2为女性 province 普通用户个人资料填写的省份 city 普通用户个人资料填写的城市 country 国家，如中国为CN headimgurl 用户头像，最后一个数值代表正方形头像大小（有0、46、64、96、132数值可选，0代表640*640正方形头像），用户没有头像时该项为空 privilege 用户特权信息，json数组，如微信沃卡用户为（chinaunicom） unionid 用户统一标识。针对一个微信开放平台帐号下的应用，同一用户的 unionid 是唯一的。")],-1),Hy={id:"_4-2-准备开发环境",tabindex:"-1"},Vy=s("strong",null,"4.2 准备开发环境",-1),Zy={id:"_4-2-1-添加应用",tabindex:"-1"},Qy=s("strong",null,"4.2.1 添加应用",-1),Yy=s("p",null,"1、注册微信开放平台",-1),$y=s("p",null,"2、添加应用",-1),si=s("p",null,"进入网站应用，添加应用",-1),li=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225407356.png",alt:"img"})],-1),oi=s("p",null,"3、添加应用需要指定一个外网域名作为微信回调域名",-1),ni=s("p",null,"审核通过后，生成app密钥。",-1),ei=s("p",null,"最终获取appID和AppSecret",-1),ai={id:"_4-2-2-内网穿透",tabindex:"-1"},ti=s("strong",null,"4.2.2 内网穿透",-1),ci=s("p",null,"我们的开发环境在局域网，微信回调指向一个公网域名。",-1),pi=s("p",null,"如何让微信回调请求至我们的开发计算机上呢？",-1),ri=s("p",null,"可以使用内网穿透技术，什么是内网穿透？",-1),Di=s("p",null,"内网穿透简单来说就是将内网外网通过隧道打通,让内网的数据让外网可以获取。比如常用的办公室软件等，一般在办公室或家里，通过拨号上网，这样办公软件只有在本地的局域网之内才能访问，那么问题来了，如果是手机上，或者公司外地的办公人员，如何访问到办公软件呢？这就需要内网穿透工具了。开启隧道之后，网穿透工具会分配一个专属域名/端口,办公软件就已经在公网上了,在外地的办公人员可以在任何地方愉快的访问办公软件了~~",-1),yi=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225437784.png",alt:"image-20230705225437784"})],-1),ii=s("p",null,"1、在内网穿透服务器上开通隧道，配置外网域名，配置穿透内网的端口即本地电脑上的端口。",-1),Fi=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225502880.png",alt:"image-20230705225502880"})],-1),Ai=s("p",null,"这里我们配置认证服务端口，最终实现通过外网域名访问本地认证服务。",-1),Ci=s("p",null,"2、在本地电脑上安装内网穿透的工具，工具上配置内网穿透服务器隧道token。",-1),di=s("p",null,"市面上做内网穿透的商家很多，需要时可以查阅资料了解下。",-1),ui={id:"_4-3-接入微信登录",tabindex:"-1"},hi=s("strong",null,"4.3 接入微信登录",-1),_i={id:"_4-3-1-接入分析",tabindex:"-1"},gi=s("strong",null,"4.3.1 接入分析",-1),Ei=s("p",null,"根据OAuth2协议授权码流程，结合本项目自身特点，分析接入微信扫码登录的流程如下：",-1),mi=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225519898.png",alt:"image-20230705225519898"})],-1),fi=s("p",null,"本项目认证服务需要做哪些事？",-1),bi=s("p",null,"1、需要定义接口接收微信下发的授权码。",-1),Si=s("p",null,"2、收到授权码调用微信接口申请令牌。",-1),xi=s("p",null,"3、申请到令牌调用微信获取用户信息",-1),vi=s("p",null,"4、获取用户信息成功将其写入本项目用户中心数据库。",-1),wi=s("p",null,"5、最后重定向到浏览器自动登录。",-1),ki={id:"_4-3-2-定义接口",tabindex:"-1"},Ui=s("strong",null,"4.3.2 定义接口",-1),Ii=s("p",null,"参考接口规范中“请求获取授权码” 定义接收微信下发的授权码接口，",-1),Bi=s("p",null,"定义WxLoginController类，如下：",-1),ji=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Slf4j")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Controller")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"WxLoginController"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RequestMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/wxLogin"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"wxLogin"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"code"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"state"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"IOException"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        log"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"debug"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"微信扫码回调,code:{},state:{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"code"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"state"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//请求微信申请令牌，拿到令牌查询用户信息，将用户信息写入本项目数据库")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," xcUser "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"XcUser"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//暂时硬编写，目的是调试环境")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"t1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"xcUser"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"redirect:http://www.51xuecheng.cn/error.html"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," username "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"redirect:http://www.51xuecheng.cn/sign.html?username="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"+"),s("span",{style:{color:"#A6ACCD"}},"username"),s("span",{style:{color:"#89DDFF"}},"+"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"&authType=wx"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Ti=s("p",null,"定义微信认证的service",-1),Pi=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * @description 微信扫码认证")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Slf4j")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Service"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"wx_authservice"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"WxAuthServiceImpl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"implements"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"AuthService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUserMapper"),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"XcUserExt"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"execute"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"AuthParamsDto"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"authParamsDto"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//账号")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," username "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," authParamsDto"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"selectOne"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"LambdaQueryWrapper"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#89DDFF"}},">()."),s("span",{style:{color:"#82AAFF"}},"eq"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"XcUser"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),s("span",{style:{color:"#A6ACCD"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," username"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"            "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//返回空表示用户不存在")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RuntimeException"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"账号不存在"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"XcUserExt"),s("span",{style:{color:"#A6ACCD"}}," xcUserExt "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"XcUserExt"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        BeanUtils"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"copyProperties"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"xcUserExt"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," xcUserExt"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),Oi={id:"_4-3-3-接口环境测试",tabindex:"-1"},Mi=s("strong",null,"4.3.3 接口环境测试",-1),Li=s("p",null,"接口定义好下边进行测试下，主要目的是测试接口调度的环境。",-1),Ri=s("p",null,"1、启动内网穿透工具",-1),Wi=s("p",null,"2、在/wxLogin接口中打断点",-1),Ji=s("p",null,"3、打开前端微信扫码页面",-1),Ni=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225557340.png",alt:"image-20230705225557340"})],-1),zi=s("p",null,"点击微信图标打开二维码",-1),Xi=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225604434.png",alt:"image-20230705225604434"})],-1),qi=s("p",null,"用户扫码，确认授权",-1),Ki=s("code",null,"/wxLogin",-1),Gi={id:"_4-3-4-申请令牌",tabindex:"-1"},Hi=s("strong",null,"4.3.4 申请令牌",-1),Vi=s("p",null,"接下来请求微信申请令牌。",-1),Zi=s("p",null,"1、使用restTemplate请求微信，配置RestTemplate bean",-1),Qi=s("p",null,"在启动类配置restTemplate",-1),Yi=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Bean")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"RestTemplate"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"restTemplate"),s("span",{style:{color:"#89DDFF"}},"(){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"RestTemplate"),s("span",{style:{color:"#A6ACCD"}}," restTemplate "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RestTemplate"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"OkHttp3ClientHttpRequestFactory"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}},"  restTemplate"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),$i=s("p",null,"定义与微信认证的service接口：",-1),sF=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * @description 微信认证接口")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"interface"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"WxAuthService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"wxAuth"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"code"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),lF=s("p",null,"继续在WxAuthServiceImpl类写WxAuthService 接口的实现，在其中定义申请令牌的私有方法并由wxAuth方法去调用：",-1),oF=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Slf4j")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Service"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"wx_authservice"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"WxAuthServiceImpl"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"implements"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"AuthService"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"WxAuthService"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"XcUserMapper"),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"RestTemplate"),s("span",{style:{color:"#A6ACCD"}}," restTemplate"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Value"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"${weixin.appid}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," appid"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Value"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"${weixin.secret}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," secret"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"wxAuth"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"code"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//收到code调用微信接口申请access_token")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"Map"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," access_token_map "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getAccess_token"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"code"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"access_token_map"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//获取用户信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//添加用户到数据库")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," xcUser "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," xcUser"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," * 申请访问令牌,响应示例")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "access_token":"ACCESS_TOKEN",')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "expires_in":7200,')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "refresh_token":"REFRESH_TOKEN",')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "openid":"OPENID",')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "scope":"SCOPE",')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "unionid": "o6_bmasdasdsad6_2sgVt7hMZOPfL"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," }")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"*/")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Map"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getAccess_token"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"code"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," wxUrl_template "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&secret=%s&code=%s&grant_type=authorization_code"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//请求微信地址")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," wxUrl "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," String"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"format"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"wxUrl_template"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," appid"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," secret"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," code"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    log"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"info"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"调用微信接口申请access_token, url:{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," wxUrl"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"ResponseEntity"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," exchange "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," restTemplate"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"exchange"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"wxUrl"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," HttpMethod"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"POST"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null,"),s("span",{style:{color:"#A6ACCD"}}," String"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"class"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," result "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," exchange"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getBody"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    log"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"info"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"调用微信接口申请access_token: 返回值:{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," result"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"Map"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," resultMap "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," JSON"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"parseObject"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"result"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," Map"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"class"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," resultMap"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"....")]),l(`
`),s("span",{class:"line"})])])],-1),nF=s("p",null,"下边在controller中调用wxAuth接口：",-1),eF=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Slf4j")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Controller")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"WxLoginController"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"WxAuthService"),s("span",{style:{color:"#A6ACCD"}}," wxAuthService"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RequestMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/wxLogin"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"wxLogin"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"code"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"state"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"throws"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"IOException"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        log"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"debug"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"微信扫码回调,code:{},state:{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"code"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"state"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//请求微信申请令牌，拿到令牌查询用户信息，将用户信息写入本项目数据库")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," xcUser "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," wxAuthService"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"wxAuth"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"code"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"xcUser"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"redirect:http://www.51xuecheng.cn/error.html"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," username "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getUsername"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"redirect:http://www.51xuecheng.cn/sign.html?username="),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},"+"),s("span",{style:{color:"#A6ACCD"}},"username"),s("span",{style:{color:"#89DDFF"}},"+"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"&authType=wx"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),aF=s("p",null,"测试获取用户信息",-1),tF=s("p",null,"1、在wxAuthService中获取用户信息处打断点",-1),cF=s("p",null,"3、手机扫码并授权，观察是否成功申请到令牌",-1),pF={id:"_4-3-5-获取用户信息",tabindex:"-1"},rF=s("strong",null,"4.3.5 获取用户信息",-1),DF=s("p",null,"在WxAuthServiceImpl类中定义获取用户信息方法：",-1),yF=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"/**获取用户信息，示例如下：")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," {")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "openid":"OPENID",')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "nickname":"NICKNAME",')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "sex":1,')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "province":"PROVINCE",')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "city":"CITY",')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "country":"COUNTRY",')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "headimgurl": "https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0",')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "privilege":[')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "PRIVILEGE1",')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "PRIVILEGE2"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," ],")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},' "unionid": " o6_bmasdasdsad6_2sgVt7hMZOPfL"')]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}}," }")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"*/")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"Map"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#A6ACCD"}},"String"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getUserinfo"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," access_token"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," openid"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," wxUrl_template "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"https://api.weixin.qq.com/sns/userinfo?access_token=%s&openid=%s"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//请求微信地址")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," wxUrl "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," String"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"format"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"wxUrl_template"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," access_token"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"openid"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    log"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"info"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"调用微信接口申请access_token, url:{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," wxUrl"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"ResponseEntity"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," exchange "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," restTemplate"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"exchange"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"wxUrl"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," HttpMethod"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"POST"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null,"),s("span",{style:{color:"#A6ACCD"}}," String"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"class"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//防止乱码进行转码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," result "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}},"     "),s("span",{style:{color:"#82AAFF"}},"String"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"exchange"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getBody"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"getBytes"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"StandardCharsets"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"ISO_8859_1"),s("span",{style:{color:"#89DDFF"}},"),"),s("span",{style:{color:"#A6ACCD"}},"StandardCharsets"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"UTF_8"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    log"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"info"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"调用微信接口申请access_token: 返回值:{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," result"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"Map"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," resultMap "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," JSON"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"parseObject"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"result"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," Map"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"class"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," resultMap"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),iF=s("p",null,"调用获取用户信息。",-1),FF=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"wxAuth"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," code"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//收到code调用微信接口申请access_token")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"Map"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," access_token_map "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getAccess_token"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"code"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"access_token_map"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    System"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"out"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"println"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"access_token_map"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," openid "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," access_token_map"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"openid"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," access_token "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," access_token_map"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"access_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//拿access_token查询用户信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"Map"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," userinfo "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getUserinfo"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"access_token"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," openid"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userinfo"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//添加用户到数据库")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," xcUser "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," xcUser"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),AF=s("p",null,"测试获取用户信息",-1),CF=s("p",null,"1、在获取用户信息处打断点",-1),dF=s("p",null,"3、手机扫码授权",-1),uF={id:"_4-3-6-保存用户信息",tabindex:"-1"},hF=s("strong",null,"4.3.6 保存用户信息",-1),_F=s("p",null,"向数据库保存用户信息，如果用户不存在将其保存在数据库。",-1),gF=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"XcUserRoleMapper"),s("span",{style:{color:"#A6ACCD"}}," xcUserRoleMapper"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Transactional")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"addWxUser"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"Map"),s("span",{style:{color:"#A6ACCD"}}," userInfo_map"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," unionid "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," userInfo_map"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"unionid"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"toString"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//根据unionid查询数据库")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," xcUser "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," xcUserMapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"selectOne"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"LambdaQueryWrapper"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#89DDFF"}},">()."),s("span",{style:{color:"#82AAFF"}},"eq"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"XcUser"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),s("span",{style:{color:"#A6ACCD"}},"getWxUnionid"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," unionid"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"xcUser"),s("span",{style:{color:"#89DDFF"}},"!=null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," xcUser"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," userId "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," UUID"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"randomUUID"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"toString"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUser "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"XcUser"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setId"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userId"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setWxUnionid"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"unionid"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//记录从微信得到的昵称")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setNickname"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userInfo_map"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"nickname"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"toString"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setUserpic"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userInfo_map"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"headimgurl"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"toString"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setName"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userInfo_map"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"nickname"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"toString"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"unionid"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setPassword"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"unionid"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setUtype"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"101001"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//学生类型")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setStatus"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//用户状态")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUser"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setCreateTime"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"LocalDateTime"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"now"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUserMapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"insert"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"xcUser"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUserRole"),s("span",{style:{color:"#A6ACCD"}}," xcUserRole "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"XcUserRole"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUserRole"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setId"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"UUID"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"randomUUID"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"toString"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUserRole"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setUserId"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userId"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUserRole"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setRoleId"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"17"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//学生角色")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    xcUserRoleMapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"insert"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"xcUserRole"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," xcUser"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),EF=s("p",null,"调用保存用户信息",-1),mF=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Autowired")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"WxAuthServiceImpl"),s("span",{style:{color:"#A6ACCD"}}," currentProxy"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"wxAuth"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," code"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//收到code调用微信接口申请access_token")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"Map"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," access_token_map "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getAccess_token"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"code"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"access_token_map"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    System"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"out"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"println"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"access_token_map"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," openid "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," access_token_map"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"openid"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," access_token "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," access_token_map"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"access_token"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//拿access_token查询用户信息")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"Map"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," userinfo "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getUserinfo"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"access_token"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," openid"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userinfo"),s("span",{style:{color:"#89DDFF"}},"==null){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"null;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//将用户信息保存到数据库")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," xcUser "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," currentProxy"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"addWxUser"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userinfo"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," xcUser"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),fF=s("p",null,"测试保存用户信息",-1),bF=s("p",null,"1、在保存用户信息处打断点",-1),SF=s("p",null,"3、手机扫码授权",-1),xF=s("p",null,"4、自动跳转到登录页面，提交认证成功。",-1),vF={id:"_5-用户授权",tabindex:"-1"},wF=s("strong",null,"5 用户授权",-1),kF={id:"_5-1-rbac",tabindex:"-1"},UF=s("strong",null,"5.1 RBAC",-1),IF=s("p",null,"如何实现授权？业界通常基于RBAC实现授权。",-1),BF=s("p",null,"RBAC分为两种方式：",-1),jF=s("p",null,"基于角色的访问控制（Role-Based Access Control）",-1),TF=s("p",null,"基于资源的访问控制（Resource-Based Access Control）",-1),PF=s("p",null,"角色的访问控制（Role-Based Access Control）是按角色进行授权，比如：主体的角色为总经理可以查询企业运营报表，查询员工工资信息等，访问控制流程如下：",-1),OF=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225635823.png",alt:"image-20230705225635823"})],-1),MF=s("p",null,"根据上图中的判断逻辑，授权代码可表示如下：",-1),LF=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"主体"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"hasRole"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"总经理角色id"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"查询工资")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),RF=s("p",null,"如果上图中查询工资所需要的角色变化为总经理和部门经理，此时就需要修改判断逻辑为“判断用户的角色是否是总经理或部门经理”，修改代码如下：",-1),WF=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"主体"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"hasRole"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"总经理角色id"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"||"),s("span",{style:{color:"#A6ACCD"}},"  主体"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"hasRole"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"部门经理角色id"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    查询工资")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),JF=s("p",null,"根据上边的例子发现，当需要修改角色的权限时就需要修改授权的相关代码，系统可扩展性差。",-1),NF=s("p",null,"基于资源的访问控制（Resource-Based Access",-1),zF=s("p",null,"Control）是按资源（或权限）进行授权，比如：用户必须具有查询工资权限才可以查询员工工资信息等，访问控制流程如下：",-1),XF=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225645727.png",alt:"image-20230705225645727"})],-1),qF=s("p",null,"根据上图中的判断，授权代码可以表示为：",-1),KF=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"主体"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"hasPermission"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"查询工资权限标识"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    查询工资")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),GF=s("p",null,"优点：系统设计时定义好查询工资的权限标识，即使查询工资所需要的角色变化为总经理和部门经理也不需要修改授权代码，系统可扩展性强。",-1),HF={id:"_5-2-资源服务授权流程",tabindex:"-1"},VF=s("strong",null,"5.2 资源服务授权流程",-1),ZF=s("p",null,"本项目在资源服务内部进行授权，基于资源的授权模式，因为接口在资源服务，通过在接口处添加授权注解实现授权。",-1),QF=s("p",null,"1、首先配置nginx代理",-1),YF=s("div",{class:"language-apl"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   http "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    server_names_hash_bucket_size "),s("span",{style:{color:"#F78C6C"}},"64"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF"}},"#"),s("span",{style:{color:"#A6ACCD"}},"前端开发服务")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  upstream uidevserver"),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    server "),s("span",{style:{color:"#F78C6C"}},"127.0.0.1"),s("span",{style:{color:"#A6ACCD"}},":"),s("span",{style:{color:"#F78C6C"}},"8601"),s("span",{style:{color:"#A6ACCD"}}," weight"),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F78C6C"}},"10"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"}"),s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   server "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        listen       "),s("span",{style:{color:"#F78C6C"}},"80"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        server_name  teacher"),s("span",{style:{color:"#F78C6C"}},".51xuecheng"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"cn"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"#"),s("span",{style:{color:"#A6ACCD"}},"charset koi8"),s("span",{style:{color:"#89DDFF"}},"-"),s("span",{style:{color:"#A6ACCD"}},"r"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        ssi on"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        ssi_silent_errors on"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"#"),s("span",{style:{color:"#A6ACCD"}},"access_log  logs"),s("span",{style:{color:"#89DDFF"}},"/"),s("span",{style:{color:"#A6ACCD"}},"host"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"access"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"log  main"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"#"),s("span",{style:{color:"#A6ACCD"}},"location "),s("span",{style:{color:"#89DDFF"}},"/"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"         "),s("span",{style:{color:"#89DDFF"}},"#"),s("span",{style:{color:"#A6ACCD"}},"   alias   D:"),s("span",{style:{color:"#89DDFF"}},"/"),s("span",{style:{color:"#A6ACCD"}},"itcast2022"),s("span",{style:{color:"#89DDFF"}},"/"),s("span",{style:{color:"#A6ACCD"}},"xc_edu3"),s("span",{style:{color:"#F78C6C"}},".0"),s("span",{style:{color:"#89DDFF"}},"/"),s("span",{style:{color:"#A6ACCD"}},"code_1"),s("span",{style:{color:"#89DDFF"}},"/"),s("span",{style:{color:"#A6ACCD"}},"dist"),s("span",{style:{color:"#89DDFF"}},"/;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"         "),s("span",{style:{color:"#89DDFF"}},"#"),s("span",{style:{color:"#A6ACCD"}},"   index  index"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"html index"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"htm"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"#}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        location "),s("span",{style:{color:"#89DDFF"}},"/"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            proxy_pass   http:"),s("span",{style:{color:"#89DDFF"}},"//"),s("span",{style:{color:"#A6ACCD"}},"uidevserver"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        location "),s("span",{style:{color:"#89DDFF"}},"/"),s("span",{style:{color:"#A6ACCD"}},"api"),s("span",{style:{color:"#89DDFF"}},"/"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"                proxy_pass http:"),s("span",{style:{color:"#89DDFF"}},"//"),s("span",{style:{color:"#A6ACCD"}},"gatewayserver"),s("span",{style:{color:"#89DDFF"}},"/;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"}"),s("span",{style:{color:"#A6ACCD"}}," ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),$F=s("p",null,"加载nginx 配置。",-1),sA=s("p",null,"2、在资源服务集成Spring Security",-1),lA=s("p",null,[l("在需要授权的接口处使用"),s("code",null,`@PreAuthorize("hasAuthority('权限标识符')")`),l("进行控制")],-1),oA=s("p",null,[l("下边代码指定"),s("code",null,"/course/list"),l("接口需要拥有"),s("code",null,"xc_teachmanager_course_list"),l(" 权限。")],-1),nA=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225657359.png",alt:"image-20230705225657359"})],-1),eA=s("p",null,[l("设置了"),s("code",null,"@PreAuthorize"),l("表示执行此方法需要授权，如果当前用户请求接口没有权限则抛出异常")],-1),aA=s("p",null,[s("code",null,"org.springframework.security.access.AccessDeniedException"),l(": 不允许访问")],-1),tA=s("p",null,"3、在统一异常处理处解析此异常信息",-1),cA=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ResponseBody")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ExceptionHandler"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"Exception"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"class"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ResponseStatus"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"HttpStatus"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"INTERNAL_SERVER_ERROR"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"RestErrorResponse"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"exception"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"Exception"),s("span",{style:{color:"#A6ACCD"}}," e"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   log"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"error"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"【系统异常】{}"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"e"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getMessage"),s("span",{style:{color:"#89DDFF"}},"(),"),s("span",{style:{color:"#A6ACCD"}},"e"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   e"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"printStackTrace"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"e"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getMessage"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"equals"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"不允许访问"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"      "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RestErrorResponse"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"没有操作此功能的权限"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"RestErrorResponse"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"CommonError"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"UNKOWN_ERROR"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getErrMessage"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),pA=s("p",null,"4、重启资源服务进行测试",-1),rA=s("p",null,"使用教学机构用户登录系统",-1),DA=s("p",null,"这里使用t1用户登录，账号:t1、密码：111111",-1),yA=s("p",null,"登录成功，点击“教学机构”",-1),iA=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225706766.png",alt:"image-20230705225706766"})],-1),FA=s("p",null,"当用户没有权限时页面提示：没有操作此功能的权限。",-1),AA=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225713175.png",alt:"image-20230705225713175"})],-1),CA={id:"_5-3-授权相关的数据模型",tabindex:"-1"},dA=s("strong",null,"5.3 授权相关的数据模型",-1),uA=s("p",null,"如何给用户分配权限呢？",-1),hA=s("p",null,"首先要学习数据模型，本项目授权相关的数据表如下：",-1),_A=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225720492.png",alt:"image-20230705225720492"})],-1),gA=s("p",null,"说明如下：",-1),EA=s("p",null,[s("code",null,"xc_user"),l("：用户表，存储了系统用户信息，用户类型包括：学生、老师、管理员等")],-1),mA=s("p",null,[s("code",null,"xc_role"),l("：角色表，存储了系统的角色信息，学生、老师、教学管理员、系统管理员等。")],-1),fA=s("p",null,[s("code",null,"xc_user_role"),l("：用户角色表，一个用户可拥有多个角色，一个角色可被多个用户所拥有")],-1),bA=s("p",null,[s("code",null,"xc_menu"),l("：模块表，记录了菜单及菜单下的权限")],-1),SA=s("p",null,[s("code",null,"xc_permission"),l("：角色权限表，一个角色可拥有多个权限，一个权限可被多个角色所拥有")],-1),xA=s("p",null,"本项目教学阶段不再实现权限定义及用户权限分配的功能，权限分配的界面原型如下图所示：",-1),vA=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225732787.png",alt:"image-20230705225732787"})],-1),wA=s("p",null,"本项目要求掌握基于权限数据模型（5张数据表），要求在数据库中操作完成给用户分配权限、查询用户权限等需求。",-1),kA=s("p",null,"1、查询用户所拥有的权限",-1),UA=s("p",null,"步骤：",-1),IA=s("p",null,"查询用户的id",-1),BA=s("p",null,"查询用户所拥有的角色",-1),jA=s("p",null,"查询用户所拥有的权限",-1),TA=s("p",null,"例子：",-1),PA=s("div",{class:"language-sql"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#F78C6C"}},"SELECT"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"*"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"FROM"),s("span",{style:{color:"#A6ACCD"}}," xc_menu "),s("span",{style:{color:"#F78C6C"}},"WHERE"),s("span",{style:{color:"#A6ACCD"}}," id "),s("span",{style:{color:"#F78C6C"}},"IN"),s("span",{style:{color:"#A6ACCD"}},"(")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#F78C6C"}},"SELECT"),s("span",{style:{color:"#A6ACCD"}}," menu_id "),s("span",{style:{color:"#F78C6C"}},"FROM"),s("span",{style:{color:"#A6ACCD"}}," xc_permission "),s("span",{style:{color:"#F78C6C"}},"WHERE"),s("span",{style:{color:"#A6ACCD"}}," role_id "),s("span",{style:{color:"#F78C6C"}},"IN"),s("span",{style:{color:"#A6ACCD"}},"(")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#F78C6C"}},"SELECT"),s("span",{style:{color:"#A6ACCD"}}," role_id "),s("span",{style:{color:"#F78C6C"}},"FROM"),s("span",{style:{color:"#A6ACCD"}}," xc_user_role "),s("span",{style:{color:"#F78C6C"}},"WHERE"),s("span",{style:{color:"#A6ACCD"}}," user_id "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"'"),s("span",{style:{color:"#C3E88D"}},"49"),s("span",{style:{color:"#89DDFF"}},"'")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  )")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},")")]),l(`
`),s("span",{class:"line"})])])],-1),OA=s("p",null,"2、给用户分配权限",-1),MA=s("p",null,"1）添加权限",-1),LA=s("p",null,"查询用户的id",-1),RA=s("p",null,"查询权限的id",-1),WA=s("p",null,"查询用户的角色，如果没有角色需要先给用户指定角色",-1),JA=s("p",null,"向角色权限表添加记录",-1),NA=s("p",null,"2）删除用户权限",-1),zA=s("p",null,"本项目是基于角色分配权限，如果要删除用户的权限可以给用户换角色，那么新角色下的权限就是用户的权限；如果不换用户的角色可以删除角色下的权限即删除角色权限关系表相应记录，这样操作是将角色下的权限删除，属于该角色的用户都将删除此权限。",-1),XA={id:"_5-4-查询用户权限",tabindex:"-1"},qA=s("strong",null,"5.4 查询用户权限",-1),KA=s("p",null,"使用Spring Security进行授权，首先在生成jwt前会查询用户的权限，如下图：",-1),GA=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225743413.png",alt:"image-20230705225743413"})],-1),HA=s("p",null,"接下来需要修改UserServiceImpl和PasswordAuthServiceImpl从数据库查询用户的权限。",-1),VA=s("p",null,"1、定义mapper接口",-1),ZA=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"interface"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"XcMenuMapper"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"extends"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"BaseMapper"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"XcMenu"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Select"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"SELECT    * FROM xc_menu WHERE id IN (SELECT menu_id FROM xc_permission WHERE role_id IN ( SELECT role_id FROM xc_user_role WHERE user_id = #{userId} ))"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"List"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"XcMenu"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"selectPermissionByUserId"),s("span",{style:{color:"#89DDFF"}},"(@"),s("span",{style:{color:"#C792EA"}},"Param"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"userId"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"userId"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),QA=s("p",null,"2、修改PasswordAuthServiceImpl",-1),YA=s("p",null,"修改UserServiceImpl类的getUserPrincipal方法，查询权限信息",-1),$A=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"//查询用户身份")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"getUserPrincipal"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"XcUserExt"),s("span",{style:{color:"#A6ACCD"}}," user"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," password "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getPassword"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//查询用户权限")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"List"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"XcMenu"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," xcMenus "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," menuMapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"selectPermissionByUserId"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getId"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"List"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," permissions "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"ArrayList"),s("span",{style:{color:"#89DDFF"}},"<>();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"xcMenus"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"size"),s("span",{style:{color:"#89DDFF"}},"()<="),s("span",{style:{color:"#F78C6C"}},"0"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"        "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//用户权限,如果不加则报Cannot pass a null GrantedAuthority collection")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        permissions"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"add"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"p1"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        xcMenus"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"forEach"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"menu"),s("span",{style:{color:"#C792EA"}},"->"),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"            permissions"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"add"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"menu"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getCode"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"        "),s("span",{style:{color:"#89DDFF"}},"});")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//将用户权限放在XcUserExt中")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setPermissions"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"permissions"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//为了安全在令牌中不放密码")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"setPassword"),s("span",{style:{color:"#89DDFF"}},"(null);")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//将user对象转json")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," userString "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," JSON"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"toJSONString"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"user"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},"[]"),s("span",{style:{color:"#A6ACCD"}}," authorities "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," permissions"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"toArray"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#F78C6C"}},"0"),s("span",{style:{color:"#89DDFF"}},"]);")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"UserDetails"),s("span",{style:{color:"#A6ACCD"}}," userDetails "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," User"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"withUsername"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"userString"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"password"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"password"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"authorities"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"authorities"),s("span",{style:{color:"#89DDFF"}},")."),s("span",{style:{color:"#82AAFF"}},"build"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," userDetails"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),sC={id:"_5-5-授权测试",tabindex:"-1"},lC=s("strong",null,"5.5 授权测试",-1),oC=s("p",null,"以上实现了认证时从数据库查询用户的权限，下边进行用户授权测试。",-1),nC=s("p",null,"重启认证服务，使用内容管理课程列表查询为例，代码如下：",-1),eC=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225751417.png",alt:"image-20230705225751417"})],-1),aC=s("p",null,[l("用户拥有"),s("code",null,"xc_teachmanager_course_list"),l("权限方可访问课程查询接口。")],-1),tC=s("p",null,"以用户stu1为例，当它没有此权限时页面报“没有此操作的权限”错误",-1),cC=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225757328.png",alt:"image-20230705225757328"})],-1),pC=s("p",null,[l("将"),s("code",null,"xc_teachmanager_course_list"),l("权限分配给用户。")],-1),rC=s("p",null,"1）首先找到当前用户的角色",-1),DC=s("p",null,[l("2）找到"),s("code",null,"xc_teachmanager_course_list"),l("权限的主键")],-1),yC=s("p",null,"3）在角色权限关系表中添加记录",-1),iC=s("p",null,"分配完权限需要重新登录",-1),FC=s("p",null,[l("由于用户分配了"),s("code",null,"xc_teachmanager_course_list"),l("权限，用户具有访问课程查询接口的权限。")],-1),AC={id:"_5-6-细粒度授权",tabindex:"-1"},CC=s("strong",null,"5.6 细粒度授权",-1),dC={id:"_5-6-1-什么是细粒度授权",tabindex:"-1"},uC=s("strong",null,"5.6.1 什么是细粒度授权",-1),hC=s("p",null,"什么是细粒度授权？",-1),_C=s("p",null,"细粒度授权也叫数据范围授权，即不同的用户所拥有的操作权限相同，但是能够操作的数据范围是不一样的。一个例子：用户A和用户B都是教学机构，他们都拥有“我的课程”权限，但是两个用户所查询到的数据是不一样的。",-1),gC=s("p",null,"本项目有哪些细粒度授权？",-1),EC=s("p",null,"比如：",-1),mC=s("p",null,"我的课程，教学机构只允许查询本教学机构下的课程信息。",-1),fC=s("p",null,"我的选课，学生只允许查询自己所选课。",-1),bC=s("p",null,"如何实现细粒度授权？",-1),SC=s("p",null,"细粒度授权涉及到不同的业务逻辑，通常在service层实现，根据不同的用户进行校验，根据不同的参数查询不同的数据或操作不同的数据。",-1),xC={id:"_5-6-2-教学机构细粒度授权",tabindex:"-1"},vC=s("strong",null,"5.6.2 教学机构细粒度授权",-1),wC=s("p",null,"教学机构在维护课程时只允许维护本机构的课程，教学机构细粒度授权过程如下：",-1),kC=s("ul",null,[s("li",null,"1）获取当前登录的用户身份"),s("li",null,"2）得到用户所属教育机构的Id"),s("li",null,"3）查询该教学机构下的课程信息")],-1),UC=s("p",null,"最终实现了用户只允许查询自己机构的课程信息。",-1),IC=s("p",null,"根据公司Id查询课程，流程如下：",-1),BC=s("ul",null,[s("li",null,"1）教学机构用户登录系统，从用户身份中取出所属机构的id"),s("li",null,[l("在用户表中设计了"),s("code",null,"company_id"),l("字段存储该用户所属的机构id.")]),s("li",null,"2）接口层取出当前登录用户的身份，取出机构id"),s("li",null,"3）将机构id传入service方法。"),s("li",null,"4）service方法将机构id传入Dao方法，最终查询出本机构的课程信息。")],-1),jC=s("p",null,"代码实现如下：",-1),TC=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"ApiOperation"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"课程查询接口"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"PreAuthorize"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"hasAuthority('xc_teachmanager_course_list')"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#676E95","font-style":"italic"}},"//拥有课程列表查询的权限方可访问")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"PostMapping"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"/course/list"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"PageResult"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#A6ACCD"}},"CourseBase"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"list"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"PageParams"),s("span",{style:{color:"#A6ACCD"}}," pageParams"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"RequestBody"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"QueryCourseParamsDto"),s("span",{style:{color:"#A6ACCD"}}," queryCourseParams"),s("span",{style:{color:"#89DDFF"}},"){")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//取出用户身份")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"XcUser"),s("span",{style:{color:"#A6ACCD"}}," user "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," SecurityUtil"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getUser"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"    "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//机构id")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#C792EA"}},"String"),s("span",{style:{color:"#A6ACCD"}}," companyId "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," user"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"getCompanyId"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," courseBaseInfoService"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"queryCourseBaseList"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"Long"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"parseLong"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"companyId"),s("span",{style:{color:"#89DDFF"}},"),"),s("span",{style:{color:"#A6ACCD"}},"pageParams"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"queryCourseParams"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),PC=s("p",null,"Service方法如下：",-1),OC=s("div",{class:"language-java"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"@"),s("span",{style:{color:"#C792EA"}},"Override")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"PageResult"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#A6ACCD"}},"CourseBase"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"queryCourseBaseList"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"Long"),s("span",{style:{color:"#A6ACCD"}}," companyId"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#C792EA"}},"PageParams"),s("span",{style:{color:"#A6ACCD"}}," pageParams"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"QueryCourseParamsDto"),s("span",{style:{color:"#A6ACCD"}}," queryCourseParamsDto"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}}," "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//构建查询条件对象")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"LambdaQueryWrapper"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"CourseBase"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," queryWrapper "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"LambdaQueryWrapper"),s("span",{style:{color:"#89DDFF"}},"<>();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}}," "),s("span",{style:{color:"#676E95","font-style":"italic"}},"//机构id")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," queryWrapper"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"eq"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"CourseBase"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),s("span",{style:{color:"#A6ACCD"}},"getCompanyId"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}},"companyId"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"....")]),l(`
`),s("span",{class:"line"})])])],-1),MC={id:"_5-6-3-教学机构细粒度授权测试",tabindex:"-1"},LC=s("strong",null,"5.6.3 教学机构细粒度授权测试",-1),RC=s("p",null,"使用一个教学机构的用户登录项目，并且此用户具有查询课程的权限。",-1),WC=s("p",null,"手机修改数据库指定用户归属到一个机构中，涉及以下数据表：",-1),JC=s("p",null,[s("code",null,"xc_company"),l("为机构表")],-1),NC=s("p",null,[s("code",null,"xc_company_user"),l("为机构用户关系表")],-1),zC=s("p",null,[s("code",null,"xc_user"),l("表中有"),s("code",null,"company_id"),l("字段。")],-1),XC=s("p",null,"我们准备了t1 用户作为此次测试的用户，使用此用户登录系统：",-1),qC=s("p",null,"提前在查询课程列表接口处打上断点。",-1),KC=s("p",null,"经过测试可以正常取出用户所属的机构id",-1),GC=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225810633.png",alt:"image-20230705225810633"})],-1),HC=s("p",null,"跟踪持久层日志发现已将机构id传入dao方法，拼装sql语句，查询本机构的课程信息",-1),VC=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225815714.png",alt:"image-20230705225815714"})],-1),ZC={id:"_6-实战",tabindex:"-1"},QC=s("strong",null,"6 实战",-1),YC={id:"_6-1-找回密码-实战",tabindex:"-1"},$C=s("strong",null,"6.1 找回密码(实战)",-1),s8=s("p",null,"需求：忘记密码需要找回，可以通过手机号找回密码，通过邮箱找回密码以及人工通道。",-1),l8=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225823457.png",alt:"image-20230705225823457"})],-1),o8=s("p",null,"接口：",-1),n8=s("p",null,[l("手机验证码："),s("code",null,"/api/checkcode/phone?param1=手机号")],-1),e8=s("p",null,"邮箱验证码：/api/checkcode/phone?param1=电子邮箱地址",-1),a8=s("p",null,[l("找回密码："),s("code",null,"/api/auth/findpassword")],-1),t8=s("p",null,"请求：",-1),c8=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"     cellphone"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"     email"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"     checkcodekey"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"     checkcode"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"     confirmpwd"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"     password"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),p8=s("p",null,"响应：",-1),r8=s("p",null,"200: 找回成功",-1),D8=s("p",null,"其它：找回失败，失败原因使用统一异常处理返回的信息格式",-1),y8=s("p",null,"执行流程 1、校验验证码，不一致则抛出异常",-1),i8=s("p",null,"2、判断两次密码是否一致，不一致则抛出异常",-1),F8=s("p",null,"3、根据手机号和邮箱查询用户",-1),A8=s("p",null,"4、如果找到用户更新为新密码",-1),C8={id:"_6-2-注册-实战",tabindex:"-1"},d8=s("strong",null,"6.2 注册(实战)",-1),u8=s("p",null,"需求：为学生提供注册入口，通过此入口注册的用户为学生用户。",-1),h8=s("p",null,[s("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230705225845103.png",alt:"image-20230705225845103"})],-1),_8=s("p",null,"接口：",-1),g8=s("p",null,[l("手机验证码："),s("code",null,"/api/checkcode/phone?param1=手机号")],-1),E8=s("p",null,[l("注册："),s("code",null,"/api/auth/register")],-1),m8=s("p",null,"请求：",-1),f8=s("div",{class:"language-json"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[s("code",null,[s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   cellphone"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   username"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   email"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   nickname"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   password"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   confirmpwd"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   checkcodekey"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''"),s("span",{style:{color:"#89DDFF"}},",")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"   checkcode"),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#A6ACCD"}},"''")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"})])])],-1),b8=s("p",null,"响应：",-1),S8=s("p",null,"200: 注册成功",-1),x8=s("p",null,"其它：注册失败，失败原因使用统一异常处理返回的信息格式",-1),v8=s("p",null,"执行流程：",-1),w8=s("p",null,"1、校验验证码，如果不一致则抛出异常",-1),k8=s("p",null,"2、校验两次密码是否一致，如果不一致则抛出异常",-1),U8=s("p",null,"3、校验用户是否存在，如果存在则抛出异常",-1),I8=s("p",null,"4、向用户表、用户角色关系表添加数据。角色为学生角色。",-1);function B8(a,j8,T8,P8,p,O8){const n=A,r=D;return F(),i(r,{frontmatter:p.frontmatter,data:p.data},{"main-content-md":o(()=>[s("h1",u,[l("认证授权 "),e(n,{class:"header-anchor",href:"#认证授权","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h2",h,[_,l(),e(n,{class:"header-anchor",href:"#_1-模块需求分析","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h3",g,[E,l(),e(n,{class:"header-anchor",href:"#_1-1-什么是认证授权","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),m,f,b,S,x,v,w,k,U,s("h3",I,[B,l(),e(n,{class:"header-anchor",href:"#_1-2-业务流程","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",j,[T,l(),e(n,{class:"header-anchor",href:"#_1-2-1-统一认证","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),P,O,M,L,R,W,s("h4",J,[N,l(),e(n,{class:"header-anchor",href:"#_1-2-2-单点登录","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),z,X,q,K,s("h4",G,[H,l(),e(n,{class:"header-anchor",href:"#_1-2-3-第三方认证","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),V,Z,Q,s("h2",Y,[$,l(),e(n,{class:"header-anchor",href:"#_2-spring-security-认证研究","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h3",ss,[ls,l(),e(n,{class:"header-anchor",href:"#_2-1-spring-security介绍","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),os,ns,s("p",null,[l("项目主页："),e(n,{href:"https://spring.io/projects/spring-security",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://spring.io/projects/spring-security")]),_:1})]),s("p",null,[l("Spring cloud Security： "),e(n,{href:"https://spring.io/projects/spring-cloud-security",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://spring.io/projects/spring-cloud-security")]),_:1})]),s("h3",es,[as,l(),e(n,{class:"header-anchor",href:"#_2-2-认证授权入门","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",ts,[cs,l(),e(n,{class:"header-anchor",href:"#_2-2-1-创建认证服务工程","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),ps,rs,Ds,ys,is,Fs,As,Cs,ds,us,hs,_s,gs,s("p",null,[l("启动工程，尝试访问"),e(n,{href:"http://localhost:63070/auth/r/r1",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://localhost:63070/auth/r/r1")]),_:1}),l(" :")]),Es,s("p",null,[l("访问用户信息："),e(n,{href:"http://localhost:63070/auth/user/52",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://localhost:63070/auth/user/52")]),_:1})]),ms,fs,s("h4",bs,[Ss,l(),e(n,{class:"header-anchor",href:"#_2-2-2-认证测试","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),xs,vs,s("p",null,[l("重启工程，访问"),e(n,{href:"http://localhost:63070/auth/r/r1",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://localhost:63070/auth/r/r1")]),_:1})]),ws,ks,Us,Is,Bs,js,Ts,Ps,Os,Ms,Ls,Rs,Ws,Js,Ns,zs,s("p",null,[l("1、访问"),e(n,{href:"http://localhost:63070/auth/user/52",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://localhost:63070/auth/user/52")]),_:1}),l(" 可以正常访问")]),s("p",null,[l("2、访问"),e(n,{href:"http://localhost:63070/auth/r/r1",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://localhost:63070/auth/r/r1")]),_:1}),l(" 显示登录页面")]),Xs,s("p",null,[l("为什么"),e(n,{href:"http://localhost:63070/auth/user/52",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://localhost:63070/auth/user/52")]),_:1}),l(" 可以正常访问，访问"),e(n,{href:"http://localhost:63070/auth/r/r1",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://localhost:63070/auth/r/r1")]),_:1}),l(" 显示登录页面？")]),qs,s("h4",Ks,[Gs,l(),e(n,{class:"header-anchor",href:"#_2-2-3-授权测试","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Hs,Vs,Zs,Qs,Ys,$s,sl,ll,ol,nl,el,al,tl,cl,pl,rl,Dl,yl,il,Fl,s("h4",Al,[Cl,l(),e(n,{class:"header-anchor",href:"#_2-2-4-工作原理","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),dl,ul,hl,_l,gl,El,ml,fl,bl,Sl,xl,vl,wl,kl,Ul,s("h3",Il,[Bl,l(),e(n,{class:"header-anchor",href:"#_2-3-什么是oauth2","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",jl,[Tl,l(),e(n,{class:"header-anchor",href:"#_2-3-1-oauth2认证流程","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Pl,Ol,Ml,s("p",null,[l("参考："),e(n,{href:"https://baike.baidu.com/item/oAuth/7153134?fr=aladdin",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://baike.baidu.com/item/oAuth/7153134?fr=aladdin")]),_:1})]),s("p",null,[l("Oauth协议："),e(n,{href:"https://tools.ietf.org/html/rfc6749",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://tools.ietf.org/html/rfc6749")]),_:1})]),Ll,Rl,Wl,Jl,Nl,zl,Xl,ql,Kl,Gl,Hl,Vl,Zl,Ql,Yl,$l,so,lo,oo,no,eo,ao,to,co,po,ro,Do,yo,s("p",null,[l("引自Oauth2.0协议rfc6749 "),e(n,{href:"https://tools.ietf.org/html/rfc6749",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://tools.ietf.org/html/rfc6749")]),_:1})]),io,Fo,Ao,Co,uo,ho,_o,go,Eo,mo,fo,bo,So,xo,vo,wo,ko,s("h4",Uo,[Io,l(),e(n,{class:"header-anchor",href:"#_2-3-2-oauth2在本项目的应用","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Bo,jo,To,Po,Oo,Mo,Lo,s("h4",Ro,[Wo,l(),e(n,{class:"header-anchor",href:"#_2-3-3-oauth2的授权模式","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Jo,s("h5",No,[zo,l(),e(n,{class:"header-anchor",href:"#_2-3-3-1-授权码模式","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Xo,qo,Ko,Go,Ho,Vo,Zo,Qo,Yo,$o,sn,ln,on,nn,en,s("h5",an,[tn,l(),e(n,{class:"header-anchor",href:"#_2-3-3-2授权码模式测试","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),cn,pn,rn,Dn,yn,Fn,An,Cn,dn,un,hn,_n,gn,En,mn,fn,bn,s("p",null,[l("地址: "),e(n,{href:"http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&response_type=code&scope=all&redirect_uri=http://www.51xuecheng.cn",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&response_type=code&scope=all&redirect_uri=http://www.51xuecheng.cn")]),_:1})]),Sn,xn,vn,wn,kn,Un,In,Bn,jn,Tn,s("p",null,[l("2、请求成功，重定向至"),e(n,{href:"http://www.51xuecheng.cn/?code=%E6%8E%88%E6%9D%83%E7%A0%81%EF%BC%8C%E6%AF%94%E5%A6%82%EF%BC%9Ahttp://www.51xuecheng.cn/?code=Wqjb5H",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://www.51xuecheng.cn/?code=授权码，比如：http://www.51xuecheng.cn/?code=Wqjb5H")]),_:1})]),Pn,On,Mn,Ln,Rn,Wn,Jn,Nn,zn,Xn,qn,Kn,Gn,Hn,Vn,Zn,Qn,Yn,s("h5",$n,[se,l(),e(n,{class:"header-anchor",href:"#_2-3-3-3-密码模式","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),le,oe,ne,ee,ae,te,ce,pe,re,De,ye,ie,Fe,Ae,Ce,de,s("h5",ue,[he,l(),e(n,{class:"header-anchor",href:"#_2-3-3-4-本项目的应用方式","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),_e,s("h3",ge,[Ee,l(),e(n,{class:"header-anchor",href:"#_2-4-jwt","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",me,[fe,l(),e(n,{class:"header-anchor",href:"#_2-4-1-普通令牌的问题","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),be,Se,xe,ve,we,ke,Ue,Ie,Be,je,Te,Pe,Oe,Me,s("h4",Le,[Re,l(),e(n,{class:"header-anchor",href:"#_2-4-2-什么是jwt","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),We,s("p",null,[l("JSON Web Token（JWT）是一种使用JSON格式传递数据的网络令牌技术，它是一个开放的行业标准（RFC 7519），它定义了一种简洁的、自包含的协议格式，用于在通信双方传递json对象，传递的信息经过数字签名可以被验证和信任，它可以使用HMAC算法或使用RSA的公钥/私钥对来签名，防止内容篡改。官网："),e(n,{href:"https://jwt.io/",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://jwt.io/")]),_:1})]),Je,Ne,ze,Xe,qe,Ke,Ge,He,Ve,Ze,Qe,Ye,$e,sa,la,oa,na,ea,aa,ta,ca,pa,ra,Da,ya,ia,Fa,Aa,Ca,da,ua,ha,_a,ga,Ea,ma,fa,ba,Sa,xa,va,s("h4",wa,[ka,l(),e(n,{class:"header-anchor",href:"#_2-4-3-测试生成jwt令牌","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Ua,Ia,Ba,ja,Ta,Pa,Oa,Ma,La,Ra,Wa,Ja,Na,za,Xa,qa,Ka,s("h4",Ga,[Ha,l(),e(n,{class:"header-anchor",href:"#_2-4-4-测试资源服务校验令牌","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Va,Za,Qa,Ya,$a,st,lt,ot,nt,et,at,tt,ct,pt,rt,Dt,yt,it,Ft,At,Ct,dt,ut,ht,s("h4",_t,[gt,l(),e(n,{class:"header-anchor",href:"#_2-4-5-测试获取用户身份","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Et,mt,ft,bt,St,xt,vt,wt,kt,Ut,s("h3",It,[Bt,l(),e(n,{class:"header-anchor",href:"#_2-5-网关认证","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",jt,[Tt,l(),e(n,{class:"header-anchor",href:"#_2-5-1-技术方案","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Pt,Ot,Mt,Lt,Rt,Wt,Jt,Nt,zt,Xt,qt,Kt,s("h4",Gt,[Ht,l(),e(n,{class:"header-anchor",href:"#_2-5-2-实现网关认证","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Vt,Zt,Qt,Yt,$t,sc,lc,oc,nc,ec,ac,tc,cc,pc,rc,Dc,yc,ic,Fc,Ac,s("h2",Cc,[dc,l(),e(n,{class:"header-anchor",href:"#_3-用户认证","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h3",uc,[hc,l(),e(n,{class:"header-anchor",href:"#_3-1-需求分析","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),_c,gc,Ec,s("h3",mc,[fc,l(),e(n,{class:"header-anchor",href:"#_3-2-连接用户中心数据库","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",bc,[Sc,l(),e(n,{class:"header-anchor",href:"#_3-2-1-连接数据库认证","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),xc,vc,wc,kc,Uc,Ic,Bc,jc,Tc,Pc,Oc,Mc,Lc,Rc,Wc,Jc,Nc,zc,Xc,qc,Kc,Gc,Hc,Vc,Zc,Qc,Yc,$c,sp,lp,op,np,ep,ap,tp,cp,pp,rp,s("h4",Dp,[yp,l(),e(n,{class:"header-anchor",href:"#_3-2-2-扩展用户身份信息","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),ip,Fp,Ap,Cp,dp,up,hp,_p,gp,Ep,mp,fp,bp,s("h4",Sp,[xp,l(),e(n,{class:"header-anchor",href:"#_3-2-3-资源服务获取用户身份","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),vp,wp,kp,Up,Ip,Bp,jp,Tp,Pp,Op,s("h3",Mp,[Lp,l(),e(n,{class:"header-anchor",href:"#_3-3-支持认证方式多样","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",Rp,[Wp,l(),e(n,{class:"header-anchor",href:"#_3-3-1-统一认证入口","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Jp,Np,zp,Xp,qp,Kp,Gp,Hp,Vp,Zp,Qp,Yp,$p,sr,lr,or,nr,er,ar,tr,cr,pr,rr,Dr,yr,ir,Fr,Ar,Cr,dr,ur,s("h4",hr,[_r,l(),e(n,{class:"header-anchor",href:"#_3-3-2-实现账号密码认证","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),gr,Er,mr,fr,br,Sr,xr,vr,s("h3",wr,[kr,l(),e(n,{class:"header-anchor",href:"#_3-4-验证码服务","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",Ur,[Ir,l(),e(n,{class:"header-anchor",href:"#_3-4-1-创建验证码服务工程","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Br,jr,Tr,Pr,Or,Mr,Lr,Rr,Wr,Jr,Nr,zr,Xr,qr,Kr,s("h4",Gr,[Hr,l(),e(n,{class:"header-anchor",href:"#_3-4-2-验证码接口测试","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Vr,Zr,Qr,Yr,$r,sD,lD,oD,nD,eD,aD,tD,cD,pD,rD,DD,yD,iD,FD,AD,CD,s("h3",dD,[uD,l(),e(n,{class:"header-anchor",href:"#_3-5-账号密码认证","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",hD,[_D,l(),e(n,{class:"header-anchor",href:"#_3-5-1-需求分析","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),gD,ED,mD,fD,s("h4",bD,[SD,l(),e(n,{class:"header-anchor",href:"#_3-5-2-账号密码认证开发","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),xD,vD,wD,kD,UD,ID,BD,jD,TD,PD,OD,s("h4",MD,[LD,l(),e(n,{class:"header-anchor",href:"#_3-5-3-账号密码认证测试","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("p",null,[l("1、使用浏览器访问 "),e(n,{href:"http://www.51xuecheng.cn/sign.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://www.51xuecheng.cn/sign.html")]),_:1})]),RD,WD,JD,ND,zD,XD,s("h2",qD,[KD,l(),e(n,{class:"header-anchor",href:"#_4-微信扫码登录","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h3",GD,[HD,l(),e(n,{class:"header-anchor",href:"#_4-1-接入规范","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",VD,[ZD,l(),e(n,{class:"header-anchor",href:"#_4-1-1-接入流程","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),QD,YD,s("p",null,[e(n,{href:"https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html")]),_:1})]),$D,sy,ly,s("h4",oy,[ny,l(),e(n,{class:"header-anchor",href:"#_4-1-2-请求获取授权码","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("p",null,[l("第三方使用网站应用授权登录前请注意已获取相应网页授权作用域（"),ey,l("），则可以通过在 PC 端打开以下链接： "),e(n,{href:"https://open.weixin.qq.com/connect/qrconnect?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://open.weixin.qq.com/connect/qrconnect?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect")]),_:1}),l(" 若提示“该链接无法访问”，请检查参数是否填写错误，如"),ay,l("的域名与审核时填写的授权域名不一致或 scope 不为"),ty,l("。")]),cy,py,ry,Dy,yy,iy,s("p",null,[l("登录一号店网站应用 "),e(n,{href:"https://test.yhd.com/wechat/login.do",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://test.yhd.com/wechat/login.do")]),_:1}),l(" 打开后，一号店会生成 state 参数，跳转到 "),e(n,{href:"https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&redirect_uri=https%3A%2F%2Fpassport.yhd.com%2Fwechat%2Fcallback.do&response_type=code&scope=snsapi_login&state=3d6be0a4035d839573b04816624a415e#wechat_redirect",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&redirect_uri=https%3A%2F%2Fpassport.yhd.com%2Fwechat%2Fcallback.do&response_type=code&scope=snsapi_login&state=3d6be0a4035d839573b04816624a415e#wechat_redirect")]),_:1}),l(" 微信用户使用微信扫描二维码并且确认登录后，PC端会跳转到 "),e(n,{href:"https://test.yhd.com/wechat/callback.do?code=CODE&state=3d6be0a40sssssxxxxx6624a415e",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://test.yhd.com/wechat/callback.do?code=CODE&state=3d6be0a40sssssxxxxx6624a415e")]),_:1}),l(" 为了满足网站更定制化的需求，我们还提供了第二种获取 code 的方式，支持网站将微信登录二维码内嵌到自己页面中，用户使用微信扫码授权后通过 JS 将code返回给网站。 JS微信登录主要用途：网站希望用户在网站内就能完成登录，无需跳转到微信域下登录后再返回，提升微信登录的流畅性与成功率。 网站内嵌二维码微信登录 JS 实现办法：")]),Fy,Ay,Cy,dy,uy,s("h4",hy,[_y,l(),e(n,{class:"header-anchor",href:"#_4-1-3-通过-code-获取access-token","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),gy,Ey,my,fy,by,Sy,xy,vy,wy,ky,s("h4",Uy,[Iy,l(),e(n,{class:"header-anchor",href:"#_4-1-4-通过access-token调用接口","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),By,jy,Ty,Py,s("p",null,[l("其中"),Oy,l("属于基础接口，若应用已拥有其它 scope 权限，则默认拥有"),My,l("的权限。使用"),Ly,l("可以让移动端网页授权绕过跳转授权登录页请求用户授权的动作，直接跳转第三方网页带上授权临时票据（code），但会使得用户已授权作用域（scope）仅为"),Ry,l("，从而导致无法获取到需要用户授权才允许获得的数据和基础功能。 接口调用方法可查阅"),e(n,{href:"https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("《微信授权关系接口调用指南》")]),_:1})]),s("p",null,[l("获取用户信息接口文档："),e(n,{href:"https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html")]),_:1})]),Wy,Jy,Ny,zy,Xy,qy,Ky,Gy,s("h3",Hy,[Vy,l(),e(n,{class:"header-anchor",href:"#_4-2-准备开发环境","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",Zy,[Qy,l(),e(n,{class:"header-anchor",href:"#_4-2-1-添加应用","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Yy,s("p",null,[e(n,{href:"https://open.weixin.qq.com/",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://open.weixin.qq.com/")]),_:1})]),$y,si,li,oi,ni,ei,s("h4",ai,[ti,l(),e(n,{class:"header-anchor",href:"#_4-2-2-内网穿透","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),ci,pi,ri,Di,yi,ii,Fi,Ai,Ci,di,s("h3",ui,[hi,l(),e(n,{class:"header-anchor",href:"#_4-3-接入微信登录","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",_i,[gi,l(),e(n,{class:"header-anchor",href:"#_4-3-1-接入分析","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Ei,mi,fi,bi,Si,xi,vi,wi,s("h4",ki,[Ui,l(),e(n,{class:"header-anchor",href:"#_4-3-2-定义接口","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Ii,Bi,ji,Ti,Pi,s("h4",Oi,[Mi,l(),e(n,{class:"header-anchor",href:"#_4-3-3-接口环境测试","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Li,Ri,Wi,Ji,Ni,zi,Xi,qi,s("p",null,[l("此时正常进入 "),Ki,l(" 方法，最后跳转到"),e(n,{href:"http://www.51xuecheng.cn/sign.html?username=t1&authType=wx%E3%80%82",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://www.51xuecheng.cn/sign.html?username=t1&authType=wx。")]),_:1})]),s("h4",Gi,[Hi,l(),e(n,{class:"header-anchor",href:"#_4-3-4-申请令牌","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Vi,Zi,Qi,Yi,$i,sF,lF,oF,nF,eF,aF,tF,s("p",null,[l("2、进入"),e(n,{href:"http://www.51xuecheng.cn/wxsign.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://www.51xuecheng.cn/wxsign.html")]),_:1})]),cF,s("h4",pF,[rF,l(),e(n,{class:"header-anchor",href:"#_4-3-5-获取用户信息","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),DF,yF,iF,FF,AF,CF,s("p",null,[l("2、进入"),e(n,{href:"http://www.51xuecheng.cn/wxsign.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://www.51xuecheng.cn/wxsign.html")]),_:1})]),dF,s("h4",uF,[hF,l(),e(n,{class:"header-anchor",href:"#_4-3-6-保存用户信息","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),_F,gF,EF,mF,fF,bF,s("p",null,[l("2、进入"),e(n,{href:"http://www.51xuecheng.cn/wxsign.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://www.51xuecheng.cn/wxsign.html")]),_:1})]),SF,xF,s("h2",vF,[wF,l(),e(n,{class:"header-anchor",href:"#_5-用户授权","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h3",kF,[UF,l(),e(n,{class:"header-anchor",href:"#_5-1-rbac","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),IF,BF,jF,TF,PF,OF,MF,LF,RF,WF,JF,NF,zF,XF,qF,KF,GF,s("h3",HF,[VF,l(),e(n,{class:"header-anchor",href:"#_5-2-资源服务授权流程","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),ZF,QF,YF,$F,sA,lA,oA,nA,eA,aA,tA,cA,pA,rA,DA,yA,iA,FA,AA,s("h3",CA,[dA,l(),e(n,{class:"header-anchor",href:"#_5-3-授权相关的数据模型","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),uA,hA,_A,gA,EA,mA,fA,bA,SA,xA,vA,wA,kA,UA,IA,BA,jA,TA,PA,OA,MA,LA,RA,WA,JA,NA,zA,s("h3",XA,[qA,l(),e(n,{class:"header-anchor",href:"#_5-4-查询用户权限","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),KA,GA,HA,VA,ZA,QA,YA,$A,s("h3",sC,[lC,l(),e(n,{class:"header-anchor",href:"#_5-5-授权测试","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),oC,nC,eC,aC,tC,cC,pC,rC,DC,yC,iC,FC,s("h3",AC,[CC,l(),e(n,{class:"header-anchor",href:"#_5-6-细粒度授权","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",dC,[uC,l(),e(n,{class:"header-anchor",href:"#_5-6-1-什么是细粒度授权","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),hC,_C,gC,EC,mC,fC,bC,SC,s("h4",xC,[vC,l(),e(n,{class:"header-anchor",href:"#_5-6-2-教学机构细粒度授权","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),wC,kC,UC,IC,BC,jC,TC,PC,OC,s("h4",MC,[LC,l(),e(n,{class:"header-anchor",href:"#_5-6-3-教学机构细粒度授权测试","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),RC,WC,JC,NC,zC,XC,qC,KC,GC,HC,VC,s("h2",ZC,[QC,l(),e(n,{class:"header-anchor",href:"#_6-实战","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h3",YC,[$C,l(),e(n,{class:"header-anchor",href:"#_6-1-找回密码-实战","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s8,s("p",null,[l("界面访问地址："),e(n,{href:"http://www.51xuecheng.cn/findpassword.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://www.51xuecheng.cn/findpassword.html")]),_:1})]),l8,o8,n8,e8,a8,t8,c8,p8,r8,D8,y8,i8,F8,A8,s("h3",C8,[d8,l(),e(n,{class:"header-anchor",href:"#_6-2-注册-实战","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),u8,s("p",null,[l("界面访问地址："),e(n,{href:"http://www.51xuecheng.cn/register.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("http://www.51xuecheng.cn/register.html")]),_:1})]),h8,_8,g8,E8,m8,f8,b8,S8,x8,v8,w8,k8,U8,I8]),"main-header":o(()=>[t(a.$slots,"main-header")]),"main-header-after":o(()=>[t(a.$slots,"main-header-after")]),"main-nav":o(()=>[t(a.$slots,"main-nav")]),"main-content":o(()=>[t(a.$slots,"main-content")]),"main-content-after":o(()=>[t(a.$slots,"main-content-after")]),"main-nav-before":o(()=>[t(a.$slots,"main-nav-before")]),"main-nav-after":o(()=>[t(a.$slots,"main-nav-after")]),comment:o(()=>[t(a.$slots,"comment")]),footer:o(()=>[t(a.$slots,"footer")]),aside:o(()=>[t(a.$slots,"aside")]),"aside-custom":o(()=>[t(a.$slots,"aside-custom")]),default:o(()=>[t(a.$slots,"default")]),_:3},8,["frontmatter","data"])}const z8=y(d,[["render",B8]]);export{N8 as __pageData,z8 as default};
