import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang.NDzr_upu.js";import"./chunks/@vueuse/motion.BrTBiDBP.js";import{d as s,a,u as l}from"./chunks/vue-router.Cmq8qKBB.js";import{a1 as h,a3 as t,a4 as k,a5 as e,a6 as n,a7 as E,F as r,a2 as p,Z as g}from"./framework.CSpzLJwA.js";import"./app.B9pDRBUK.js";import"./chunks/dayjs.Dto65haK.js";import"./chunks/vue-i18n.C5QQbedb.js";import"./chunks/pinia.CKttsWmm.js";import"./chunks/nprogress.BEPa78Un.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.B26MP4Hy.js";import"./index.TQnGKZgq.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.DIveis5r.js";import"./post.DD7hVHl0.js";const d=s("/posts/Nacos-Source_Code_Analysis",async i=>JSON.parse('{"title":"Nacos源码分析","description":"","frontmatter":{"title":"Nacos源码分析","author":"imklaus","tags":["Nacos"],"categories":["Java","微服务"],"date":"2025/12/8 3:44:00","outline":"deep","postTitleClass":"text-#62afe9","excerpt_type":"html","end":false},"headers":[],"relativePath":"pages/posts/Nacos-Source_Code_Analysis.md","lastUpdated":null}'),{lazy:(i,s)=>i.name===s.name}),y={__name:"Nacos-Source_Code_Analysis",setup(s,{expose:y}){const{data:c}=d(),F=l(),o=a(),u=Object.assign(o.meta.frontmatter||{},c.value?.frontmatter||{});F.currentRoute.value.data=c.value,g("valaxy:frontmatter",u),globalThis.$frontmatter=u;return y({frontmatter:{title:"Nacos源码分析",author:"imklaus",tags:["Nacos"],categories:["Java","微服务"],date:"2025/12/8 3:44:00",outline:"deep",postTitleClass:"text-#62afe9",excerpt_type:"html",end:!1}}),(s,a)=>{const l=i;return p(),h(l,{frontmatter:r(u)},{"main-content-md":t(()=>[a[0]||(a[0]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528519-1002970787.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[1]||(a[1]=e("p",null,[E("参考视频："),e("a",{href:"https://www.bilibili.com/video/BV1LQ4y127n4",target:"_blank",rel:"noreferrer"},"黑马SpringCloud微服务技术栈原理篇")],-1)),a[2]||(a[2]=e("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),a[3]||(a[3]=e("p",null,[e("strong",null,"目录指引"),E("：")],-1)),a[4]||(a[4]=e("nav",{class:"table-of-contents"},[e("ul",null,[e("li",null,[e("a",{href:"#_1-下载nacos源码并运行"},"1. 下载Nacos源码并运行"),e("ul",null,[e("li",null,[e("a",{href:"#_1-1-下载nacos源码"},"1.1 下载Nacos源码")]),e("li",null,[e("a",{href:"#_1-2-导入demo工程"},"1.2 导入Demo工程")]),e("li",null,[e("a",{href:"#_1-3-导入nacos源码"},"1.3 导入Nacos源码")]),e("li",null,[e("a",{href:"#_1-4-proto编译"},"1.4 proto编译")]),e("li",null,[e("a",{href:"#_1-5-运行"},"1.5 运行")])])]),e("li",null,[e("a",{href:"#_2-服务注册"},"2. 服务注册"),e("ul",null,[e("li",null,[e("a",{href:"#_2-1-服务注册接口"},"2.1 服务注册接口")]),e("li",null,[e("a",{href:"#_2-2-客户端"},"2.2 客户端")]),e("li",null,[e("a",{href:"#_2-3-服务端"},"2.3 服务端")]),e("li",null,[e("a",{href:"#_2-4-总结"},"2.4 总结")])])]),e("li",null,[e("a",{href:"#_3-服务心跳"},"3.服务心跳"),e("ul",null,[e("li",null,[e("a",{href:"#_3-1-客户端"},"3.1 客户端")]),e("li",null,[e("a",{href:"#_3-2-服务端"},"3.2 服务端")]),e("li",null,[e("a",{href:"#_3-3-总结"},"3.3 总结")])])]),e("li",null,[e("a",{href:"#_4-服务发现"},"4.服务发现"),e("ul",null,[e("li",null,[e("a",{href:"#_4-1-客户端"},"4.1 客户端")]),e("li",null,[e("a",{href:"#_4-2-服务端"},"4.2 服务端")]),e("li",null,[e("a",{href:"#_4-3-总结"},"4.3 总结")])])])])],-1)),a[5]||(a[5]=e("h2",{id:"_1-下载nacos源码并运行",tabindex:"-1"},[E("1. 下载Nacos源码并运行 "),e("a",{class:"header-anchor",href:"#_1-下载nacos源码并运行","aria-label":'Permalink to "1. 下载Nacos源码并运行"'},"​")],-1)),a[6]||(a[6]=e("p",null,"要研究Nacos源码自然不能用打包好的Nacos服务端jar包来运行，需要下载源码自己编译来运行。",-1)),a[7]||(a[7]=e("h3",{id:"_1-1-下载nacos源码",tabindex:"-1"},[E("1.1 下载Nacos源码 "),e("a",{class:"header-anchor",href:"#_1-1-下载nacos源码","aria-label":'Permalink to "1.1 下载Nacos源码"'},"​")],-1)),a[8]||(a[8]=e("p",null,[E("Nacos的GitHub地址："),e("a",{href:"https://github.com/alibaba/nacos",target:"_blank",rel:"noreferrer"},"https://github.com/alibaba/nacos")],-1)),n(" more "),a[9]||(a[9]=e("p",null,"课前资料中已经提供了下载好的1.4.2版本的Nacos源码：",-1)),a[10]||(a[10]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906105652113.png",alt:"image-20210906105652113",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[11]||(a[11]=e("p",null,"如果需要研究其他版本的同学，也可以自行下载：",-1)),a[12]||(a[12]=e("p",null,[E("大家找到其release页面："),e("a",{href:"https://github.com/alibaba/nacos/tags%EF%BC%8C%E6%89%BE%E5%88%B0%E5%85%B6%E4%B8%AD%E7%9A%841.4.2.%E7%89%88%E6%9C%AC%EF%BC%9A",target:"_blank",rel:"noreferrer"},"https://github.com/alibaba/nacos/tags，找到其中的1.4.2.版本：")],-1)),a[13]||(a[13]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906105157409.png",alt:"image-20210906105157409",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[14]||(a[14]=e("p",null,"点击进入后，下载Source code(zip)：",-1)),a[15]||(a[15]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906105102668.png",alt:"image-20210906105102668",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[16]||(a[16]=e("h3",{id:"_1-2-导入demo工程",tabindex:"-1"},[E("1.2 导入Demo工程 "),e("a",{class:"header-anchor",href:"#_1-2-导入demo工程","aria-label":'Permalink to "1.2 导入Demo工程"'},"​")],-1)),a[17]||(a[17]=e("p",null,"我们的课前资料提供了一个微服务Demo，包含了服务注册、发现等业务。",-1)),a[18]||(a[18]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906105858000.png",alt:"image-20210906105858000",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[19]||(a[19]=e("p",null,"导入该项目后，查看其项目结构：",-1)),a[20]||(a[20]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906110014198.png",alt:"image-20210906110014198",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[21]||(a[21]=e("p",null,"结构说明：",-1)),a[22]||(a[22]=e("ul",null,[e("li",null,[E("cloud-source-demo：项目父目录 "),e("ul",null,[e("li",null,[E("cloud-demo：微服务的父工程，管理微服务依赖 "),e("ul",null,[e("li",null,"order-service：订单微服务，业务中需要访问user-service，是一个服务消费者"),e("li",null,"user-service：用户微服务，对外暴露根据id查询用户的接口，是一个服务提供者")])])])])],-1)),a[23]||(a[23]=e("h3",{id:"_1-3-导入nacos源码",tabindex:"-1"},[E("1.3 导入Nacos源码 "),e("a",{class:"header-anchor",href:"#_1-3-导入nacos源码","aria-label":'Permalink to "1.3 导入Nacos源码"'},"​")],-1)),a[24]||(a[24]=e("p",null,"将之前下载好的Nacos源码解压到cloud-source-demo项目目录中：",-1)),a[25]||(a[25]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111053263.png",alt:"image-20210906111053263",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[26]||(a[26]=e("p",null,"然后，使用IDEA将其作为一个module来导入：",-1)),a[27]||(a[27]=e("p",null,"1）选择项目结构选项：",-1)),a[28]||(a[28]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111152447.png",alt:"image-20210906111152447",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[29]||(a[29]=e("p",null,"然后点击导入module：",-1)),a[30]||(a[30]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111259352.png",alt:"image-20210906111259352",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[31]||(a[31]=e("p",null,"在弹出窗口中，选择nacos源码目录：",-1)),a[32]||(a[32]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111422406.png",alt:"image-20210906111422406",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[33]||(a[33]=e("p",null,"然后选择maven模块，finish：",-1)),a[34]||(a[34]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111519198.png",alt:"image-20210906111519198",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[35]||(a[35]=e("p",null,"最后，点击OK即可：",-1)),a[36]||(a[36]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111543747.png",alt:"image-20210906111543747",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[37]||(a[37]=e("p",null,"导入后的项目结构：",-1)),a[38]||(a[38]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111632336.png",alt:"image-20210906111632336",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[39]||(a[39]=e("h3",{id:"_1-4-proto编译",tabindex:"-1"},[E("1.4 proto编译 "),e("a",{class:"header-anchor",href:"#_1-4-proto编译","aria-label":'Permalink to "1.4 proto编译"'},"​")],-1)),a[40]||(a[40]=e("p",null,"Nacos底层的数据通信会基于protobuf对数据做序列化和反序列化。并将对应的proto文件定义在了consistency这个子模块中：",-1)),a[41]||(a[41]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111941399.png",alt:"image-20210906111941399",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[42]||(a[42]=e("p",null,"我们需要先将proto文件编译为对应的Java代码。",-1)),a[43]||(a[43]=e("h4",{id:"_1-4-1-什么是protobuf",tabindex:"-1"},[E("1.4.1 什么是protobuf "),e("a",{class:"header-anchor",href:"#_1-4-1-什么是protobuf","aria-label":'Permalink to "1.4.1 什么是protobuf"'},"​")],-1)),a[44]||(a[44]=e("p",null,"protobuf的全称是Protocol Buffer，是Google提供的一种数据序列化协议，这是Google官方的定义：",-1)),a[45]||(a[45]=e("blockquote",null,[e("p",null,"Protocol Buffers 是一种轻便高效的结构化数据存储格式，可以用于结构化数据序列化，很适合做数据存储或 RPC 数据交换格式。它可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。")],-1)),a[46]||(a[46]=e("p",null,"可以简单理解为，是一种跨语言、跨平台的数据传输格式。与json的功能类似，但是无论是性能，还是数据大小都比json要好很多。",-1)),a[47]||(a[47]=e("p",null,[E("protobuf的之所以可以跨语言，就是因为数据定义的格式为"),e("code",null,".proto"),E("格式，需要基于protoc编译为对应的语言。")],-1)),a[48]||(a[48]=e("h4",{id:"_1-4-2-安装protoc",tabindex:"-1"},[E("1.4.2 安装protoc "),e("a",{class:"header-anchor",href:"#_1-4-2-安装protoc","aria-label":'Permalink to "1.4.2 安装protoc"'},"​")],-1)),a[49]||(a[49]=e("p",null,[E("Protobuf的GitHub地址："),e("a",{href:"https://github.com/protocolbuffers/protobuf/releases",target:"_blank",rel:"noreferrer"},"https://github.com/protocolbuffers/protobuf/releases")],-1)),a[50]||(a[50]=e("p",null,"我们可以下载windows版本的来使用：",-1)),a[51]||(a[51]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906112814549.png",alt:"image-20210906112814549",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[52]||(a[52]=e("p",null,"另外，课前资料也提供了下载好的安装包：",-1)),a[53]||(a[53]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906112920575.png",alt:"image-20210906112920575",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[54]||(a[54]=e("p",null,"解压到任意非中文目录下，其中的bin目录中的protoc.exe可以帮助我们编译：",-1)),a[55]||(a[55]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906113011871.png",alt:"image-20210906113011871",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[56]||(a[56]=e("p",null,"然后将这个bin目录配置到你的环境变量path中，可以参考JDK的配置方式：",-1)),a[57]||(a[57]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906113552081.png",alt:"image-20210906113552081",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[58]||(a[58]=e("h4",{id:"_1-4-3-编译proto",tabindex:"-1"},[E("1.4.3 编译proto "),e("a",{class:"header-anchor",href:"#_1-4-3-编译proto","aria-label":'Permalink to "1.4.3 编译proto"'},"​")],-1)),a[59]||(a[59]=e("p",null,"进入nacos-1.4.2的consistency模块下的src/main目录下：",-1)),a[60]||(a[60]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906113655302.png",alt:"image-20210906113655302",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[61]||(a[61]=e("p",null,"然后打开cmd窗口，运行下面的两个命令：",-1)),a[62]||(a[62]=e("div",{class:"language-powershell max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"protoc "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"--"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"java_out"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"java ."),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"proto"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"consistency.proto")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"protoc "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"--"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"java_out"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"java ."),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"proto"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/Data"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".proto")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[63]||(a[63]=e("p",null,"如图：",-1)),a[64]||(a[64]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906113829647.png",alt:"image-20210906113829647",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[65]||(a[65]=e("p",null,"会在nacos的consistency模块中编译出这些java代码：",-1)),a[66]||(a[66]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906113923430.png",alt:"image-20210906113923430",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[67]||(a[67]=e("h3",{id:"_1-5-运行",tabindex:"-1"},[E("1.5 运行 "),e("a",{class:"header-anchor",href:"#_1-5-运行","aria-label":'Permalink to "1.5 运行"'},"​")],-1)),a[68]||(a[68]=e("p",null,"nacos服务端的入口是在console模块中的Nacos类：",-1)),a[69]||(a[69]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906114035628.png",alt:"image-20210906114035628",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[70]||(a[70]=e("p",null,"我们需要让它单机启动：",-1)),a[71]||(a[71]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906114143669.png",alt:"image-20210906114143669",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[72]||(a[72]=e("p",null,"然后新建一个SpringBootApplication：",-1)),a[73]||(a[73]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906114220412.png",alt:"image-20210906114220412",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[74]||(a[74]=e("p",null,"然后填写应用信息：",-1)),a[75]||(a[75]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906114519073.png",alt:"image-20210906114519073",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[76]||(a[76]=e("p",null,"然后运行Nacos这个main函数：",-1)),a[77]||(a[77]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906114705910.png",alt:"image-20210906114705910",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[78]||(a[78]=e("p",null,"将order-service和user-service服务启动后，可以查看nacos控制台：",-1)),a[79]||(a[79]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906151358154.png",alt:"image-20210906151358154",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[80]||(a[80]=e("hr",null,null,-1)),a[81]||(a[81]=e("h2",{id:"_2-服务注册",tabindex:"-1"},[E("2. 服务注册 "),e("a",{class:"header-anchor",href:"#_2-服务注册","aria-label":'Permalink to "2. 服务注册"'},"​")],-1)),a[82]||(a[82]=e("p",null,"服务注册到Nacos以后，会保存在一个本地注册表中，其结构如下：",-1)),a[83]||(a[83]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922111651314.png",alt:"image-20210922111651314",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[84]||(a[84]=e("p",null,[E("首先最外层是一个Map，结构为："),e("code",null,"Map<String, Map<String, Service>>"),E("：")],-1)),a[85]||(a[85]=e("ul",null,[e("li",null,"key：是namespace_id，起到环境隔离的作用。namespace下可以有多个group"),e("li",null,[E("value：又是一个"),e("code",null,"Map<String, Service>"),E("，代表分组及组内的服务。一个组内可以有多个服务 "),e("ul",null,[e("li",null,"key：代表group分组，不过作为key时格式是group_name:service_name"),e("li",null,[E("value：分组下的某一个服务，例如userservice，用户服务。类型为"),e("code",null,"Service"),E("，内部也包含一个"),e("code",null,"Map<String,Cluster>"),E("，一个服务下可以有多个集群 "),e("ul",null,[e("li",null,"key：集群名称"),e("li",null,[E("value："),e("code",null,"Cluster"),E("类型，包含集群的具体信息。一个集群中可能包含多个实例，也就是具体的节点信息，其中包含一个"),e("code",null,"Set<Instance>"),E("，就是该集群下的实例的集合 "),e("ul",null,[e("li",null,"Instance：实例信息，包含实例的IP、Port、健康状态、权重等等信息")])])])])])])],-1)),a[86]||(a[86]=e("p",null,"每一个服务去注册到Nacos时，就会把信息组织并存入这个Map中。",-1)),a[87]||(a[87]=e("h3",{id:"_2-1-服务注册接口",tabindex:"-1"},[E("2.1 服务注册接口 "),e("a",{class:"header-anchor",href:"#_2-1-服务注册接口","aria-label":'Permalink to "2.1 服务注册接口"'},"​")],-1)),a[88]||(a[88]=e("p",null,"Nacos提供了服务注册的API接口，客户端只需要向该接口发送请求，即可实现服务注册。",-1)),a[89]||(a[89]=e("p",null,"**接口说明：**注册一个实例到Nacos服务。",-1)),a[90]||(a[90]=e("p",null,[e("strong",null,"请求类型"),E("："),e("code",null,"POST")],-1)),a[91]||(a[91]=e("p",null,[e("strong",null,"请求路径"),E("："),e("code",null,"/nacos/v1/ns/instance")],-1)),a[92]||(a[92]=e("p",null,[e("strong",null,"请求参数"),E("：")],-1)),a[93]||(a[93]=e("table",null,[e("thead",null,[e("tr",null,[e("th",{style:{"text-align":"left"}},"名称"),e("th",{style:{"text-align":"left"}},"类型"),e("th",{style:{"text-align":"left"}},"是否必选"),e("th",null,"描述")])]),e("tbody",null,[e("tr",null,[e("td",{style:{"text-align":"left"}},"ip"),e("td",{style:{"text-align":"left"}},"字符串"),e("td",{style:{"text-align":"left"}},"是"),e("td",null,"服务实例IP")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"port"),e("td",{style:{"text-align":"left"}},"int"),e("td",{style:{"text-align":"left"}},"是"),e("td",null,"服务实例port")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"namespaceId"),e("td",{style:{"text-align":"left"}},"字符串"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"命名空间ID")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"weight"),e("td",{style:{"text-align":"left"}},"double"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"权重")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"enabled"),e("td",{style:{"text-align":"left"}},"boolean"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"是否上线")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"healthy"),e("td",{style:{"text-align":"left"}},"boolean"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"是否健康")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"metadata"),e("td",{style:{"text-align":"left"}},"字符串"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"扩展信息")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"clusterName"),e("td",{style:{"text-align":"left"}},"字符串"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"集群名")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"serviceName"),e("td",{style:{"text-align":"left"}},"字符串"),e("td",{style:{"text-align":"left"}},"是"),e("td",null,"服务名")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"groupName"),e("td",{style:{"text-align":"left"}},"字符串"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"分组名")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"ephemeral"),e("td",{style:{"text-align":"left"}},"boolean"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"是否临时实例")])])],-1)),a[94]||(a[94]=e("p",null,[e("strong",null,"错误编码"),E("：")],-1)),a[95]||(a[95]=e("table",null,[e("thead",null,[e("tr",null,[e("th",{style:{"text-align":"left"}},"错误代码"),e("th",{style:{"text-align":"left"}},"描述"),e("th",{style:{"text-align":"left"}},"语义")])]),e("tbody",null,[e("tr",null,[e("td",{style:{"text-align":"left"}},"400"),e("td",{style:{"text-align":"left"}},"Bad Request"),e("td",{style:{"text-align":"left"}},"客户端请求中的语法错误")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"403"),e("td",{style:{"text-align":"left"}},"Forbidden"),e("td",{style:{"text-align":"left"}},"没有权限")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"404"),e("td",{style:{"text-align":"left"}},"Not Found"),e("td",{style:{"text-align":"left"}},"无法找到资源")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"500"),e("td",{style:{"text-align":"left"}},"Internal Server Error"),e("td",{style:{"text-align":"left"}},"服务器内部错误")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"200"),e("td",{style:{"text-align":"left"}},"OK"),e("td",{style:{"text-align":"left"}},"正常")])])],-1)),a[96]||(a[96]=e("h3",{id:"_2-2-客户端",tabindex:"-1"},[E("2.2 客户端 "),e("a",{class:"header-anchor",href:"#_2-2-客户端","aria-label":'Permalink to "2.2 客户端"'},"​")],-1)),a[97]||(a[97]=e("p",null,"首先，我们需要找到服务注册的入口。",-1)),a[98]||(a[98]=e("h4",{id:"_2-2-1-nacosserviceregistryautoconfiguration",tabindex:"-1"},[E("2.2.1 NacosServiceRegistryAutoConfiguration "),e("a",{class:"header-anchor",href:"#_2-2-1-nacosserviceregistryautoconfiguration","aria-label":'Permalink to "2.2.1 NacosServiceRegistryAutoConfiguration"'},"​")],-1)),a[99]||(a[99]=e("p",null,"因为Nacos的客户端是基于SpringBoot的自动装配实现的，我们可以在nacos-discovery依赖：",-1)),a[100]||(a[100]=e("p",null,[e("code",null,"spring-cloud-starter-alibaba-nacos-discovery-2.2.6.RELEASE.jar")],-1)),a[101]||(a[101]=e("p",null,"这个包中找到Nacos自动装配信息：",-1)),a[102]||(a[102]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907201333049.png",alt:"image-20210907201333049",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[103]||(a[103]=e("p",null,"可以看到，有很多个自动配置类被加载了，其中跟服务注册有关的就是NacosServiceRegistryAutoConfiguration这个类，我们跟入其中。",-1)),a[104]||(a[104]=e("p",null,"可以看到，在NacosServiceRegistryAutoConfiguration这个类中，包含一个跟自动注册有关的Bean：",-1)),a[105]||(a[105]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907201612322.png",alt:"image-20210907201612322",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[106]||(a[106]=e("h4",{id:"_2-2-2-nacosautoserviceregistration",tabindex:"-1"},[E("2.2.2 NacosAutoServiceRegistration "),e("a",{class:"header-anchor",href:"#_2-2-2-nacosautoserviceregistration","aria-label":'Permalink to "2.2.2 NacosAutoServiceRegistration"'},"​")],-1)),a[107]||(a[107]=e("p",null,[e("code",null,"NacosAutoServiceRegistration"),E("源码如图：")],-1)),a[108]||(a[108]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907213647145.png",alt:"image-20210907213647145",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[109]||(a[109]=e("p",null,[E("可以看到在初始化时，其父类"),e("code",null,"AbstractAutoServiceRegistration"),E("也被初始化了。")],-1)),a[110]||(a[110]=e("p",null,[e("code",null,"AbstractAutoServiceRegistration"),E("如图：")],-1)),a[111]||(a[111]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907214111801.png",alt:"image-20210907214111801",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[112]||(a[112]=e("p",null,[E("可以看到它实现了"),e("code",null,"ApplicationListener"),E("接口，监听Spring容器启动过程中的事件。")],-1)),a[113]||(a[113]=e("p",null,[E("在监听到"),e("code",null,"WebServerInitializedEvent"),E("（web服务初始化完成）的事件后，执行了"),e("code",null,"bind"),E(" 方法。")],-1)),a[114]||(a[114]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907214411267.png",alt:"image-20210907214411267",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[115]||(a[115]=e("p",null,"其中的bind方法如下：",-1)),a[116]||(a[116]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," bind"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WebServerInitializedEvent event) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取 ApplicationContext")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ApplicationContext context "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," event."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getApplicationContext"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断服务的 namespace,一般都是null")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (context "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"instanceof"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ConfigurableWebServerApplicationContext) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"management"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(((ConfigurableWebServerApplicationContext) context)")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServerNamespace"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 记录当前 web 服务的端口")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".port."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", event."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWebServer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 启动当前服务注册流程")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"start"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[117]||(a[117]=e("p",null,"其中的start方法流程：",-1)),a[118]||(a[118]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," start"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\tif"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEnabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\tif"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (logger."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t\tlogger."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Discovery Lifecycle disabled. Not starting"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t}")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\treturn"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t}")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 当前服务处于未运行状态时，才进行初始化")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\tif"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".running."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 发布服务开始注册的事件")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\t\t\tthis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".context."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"publishEvent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\t\t\tnew"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InstancePreRegisteredEvent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRegistration"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // ☆☆☆☆开始注册☆☆☆☆")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"\t\t\tregister"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\tif"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"shouldRegisterManagement"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"\t\t\t\tregisterManagement"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t}")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 发布注册完成事件")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\t\t\tthis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".context."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"publishEvent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\t\t\tnew"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," InstanceRegisteredEvent<>("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getConfiguration"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 服务状态设置为运行状态，基于AtomicBoolean")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\t\t\tthis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".running."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t}")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[119]||(a[119]=e("p",null,"其中最关键的register()方法就是完成服务注册的关键，代码如下：",-1)),a[120]||(a[120]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"protected"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," register"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".serviceRegistry."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"register"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRegistration"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[121]||(a[121]=e("p",null,"此处的this.serviceRegistry就是NacosServiceRegistry：",-1)),a[122]||(a[122]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907215903335.png",alt:"image-20210907215903335",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[123]||(a[123]=e("h4",{id:"_2-2-3-nacosserviceregistry",tabindex:"-1"},[E("2.2.3 NacosServiceRegistry "),e("a",{class:"header-anchor",href:"#_2-2-3-nacosserviceregistry","aria-label":'Permalink to "2.2.3 NacosServiceRegistry"'},"​")],-1)),a[124]||(a[124]=e("p",null,[e("code",null,"NacosServiceRegistry"),E("是Spring的"),e("code",null,"ServiceRegistry"),E("接口的实现类，而ServiceRegistry接口是服务注册、发现的规约接口，定义了register、deregister等方法的声明。")],-1)),a[125]||(a[125]=e("p",null,[E("而"),e("code",null,"NacosServiceRegistry"),E("对"),e("code",null,"register"),E("的实现如下：")],-1)),a[126]||(a[126]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," register"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Registration registration) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 判断serviceId是否为空，也就是spring.application.name不能为空")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(registration."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"No service to register for nacos client..."'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取Nacos的命名服务，其实就是注册中心服务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingService namingService "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," namingService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取 serviceId 和 Group")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String serviceId "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," registration."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String group "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," nacosDiscoveryProperties."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroup"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 封装服务实例的基本信息，如 cluster-name、是否为临时实例、权重、IP、端口等")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getNacosInstanceFromRegistration"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(registration);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 开始注册服务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        namingService."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerInstance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceId, group, instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"nacos registry, {} {} {}:{} register finished"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", group, serviceId,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                 instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (nacosDiscoveryProperties."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFailFast"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"nacos registry, {} register failed...{},"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceId,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                      registration."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            rethrowRuntimeException"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        else"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Failfast is false. {} register failed...{},"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceId,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                     registration."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[127]||(a[127]=e("p",null,"可以看到方法中最终是调用NamingService的registerInstance方法实现注册的。",-1)),a[128]||(a[128]=e("p",null,"而NamingService接口的默认实现就是NacosNamingService。",-1)),a[129]||(a[129]=e("h4",{id:"_2-2-4-nacosnamingservice",tabindex:"-1"},[E("2.2.4 NacosNamingService "),e("a",{class:"header-anchor",href:"#_2-2-4-nacosnamingservice","aria-label":'Permalink to "2.2.4 NacosNamingService"'},"​")],-1)),a[130]||(a[130]=e("p",null,"NacosNamingService提供了服务注册、订阅等功能。",-1)),a[131]||(a[131]=e("p",null,"其中registerInstance就是注册服务实例，源码如下：",-1)),a[132]||(a[132]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," registerInstance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String groupName, Instance instance) throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 检查超时参数是否异常。心跳超时时间(默认15秒)必须大于心跳周期(默认5秒)")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkInstanceIsLegal"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 拼接得到新的服务名，格式为：groupName@@serviceId")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String groupedServiceName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupedName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, groupName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断是否为临时实例，默认为 true。")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果是临时实例，需要定时向 Nacos 服务发送心跳")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        BeatInfo beatInfo "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beatReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildBeatInfo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        beatReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addBeatInfo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, beatInfo);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送注册服务实例的请求")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    serverProxy."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, groupName, instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[133]||(a[133]=e("p",null,"最终，由NacosProxy的registerService方法，完成服务注册。",-1)),a[134]||(a[134]=e("p",null,"代码如下：",-1)),a[135]||(a[135]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," registerService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String groupName, Instance instance) throws NacosException {")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NAMING_LOGGER."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[REGISTER-SERVICE] {} registering service {} with instance: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", namespaceId, serviceName,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                       instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 组织请求参数")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Map<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> params "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"16"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.NAMESPACE_ID, namespaceId);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.SERVICE_NAME, serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.GROUP_NAME, groupName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CLUSTER_NAME, instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ip"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"port"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"weight"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWeight"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"enable"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEnabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"healthy"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isHealthy"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ephemeral"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"metadata"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMetadata"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 通过POST请求将上述参数，发送到 /nacos/v1/ns/instance")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    reqApi"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UtilAndComs.nacosUrlInstance, params, HttpMethod.POST);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[136]||(a[136]=e("p",null,"这里提交的信息就是Nacos服务注册接口需要的完整参数，核心参数有：",-1)),a[137]||(a[137]=e("ul",null,[e("li",null,"namespace_id：环境"),e("li",null,"service_name：服务名称"),e("li",null,"group_name：组名称"),e("li",null,"cluster_name：集群名称"),e("li",null,"ip: 当前实例的ip地址"),e("li",null,"port: 当前实例的端口")],-1)),a[138]||(a[138]=e("p",null,"而在NacosNamingService的registerInstance方法中，有一段是与服务心跳有关的代码，我们在后续会继续学习。",-1)),a[139]||(a[139]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210908141019175.png",alt:"image-20210908141019175",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[140]||(a[140]=e("h4",{id:"_2-2-5-客户端注册的流程图",tabindex:"-1"},[E("2.2.5 客户端注册的流程图 "),e("a",{class:"header-anchor",href:"#_2-2-5-客户端注册的流程图","aria-label":'Permalink to "2.2.5 客户端注册的流程图"'},"​")],-1)),a[141]||(a[141]=e("p",null,"如图：",-1)),a[142]||(a[142]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923185331470.png",alt:"image-20210923185331470",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[143]||(a[143]=e("h3",{id:"_2-3-服务端",tabindex:"-1"},[E("2.3 服务端 "),e("a",{class:"header-anchor",href:"#_2-3-服务端","aria-label":'Permalink to "2.3 服务端"'},"​")],-1)),a[144]||(a[144]=e("p",null,"在nacos-console的模块中，会引入nacos-naming这个模块：",-1)),a[145]||(a[145]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922112801808.png",alt:"image-20210922112801808",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[146]||(a[146]=e("p",null,"模块结构如下：",-1)),a[147]||(a[147]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922112954630.png",alt:"image-20210922112954630",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[148]||(a[148]=e("p",null,[E("其中的com.alibaba.nacos.naming.controllers包下就有服务注册、发现等相关的各种接口，其中的服务注册是在"),e("code",null,"InstanceController"),E("类中：")],-1)),a[149]||(a[149]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922113158618.png",alt:"image-20210922113158618",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[150]||(a[150]=e("h4",{id:"_2-3-1-instancecontroller",tabindex:"-1"},[E("2.3.1 InstanceController "),e("a",{class:"header-anchor",href:"#_2-3-1-instancecontroller","aria-label":'Permalink to "2.3.1 InstanceController"'},"​")],-1)),a[151]||(a[151]=e("p",null,"进入InstanceController类，可以看到一个register方法，就是服务注册的方法了：",-1)),a[152]||(a[152]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CanDistro")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Secured"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"parser"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingResourceParser.class, "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"action"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ActionTypes.WRITE)")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"register"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest request) throws Exception {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 尝试获取namespaceId")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String namespaceId "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 尝试获取serviceName，其格式为 group_name@@service_name")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String serviceName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"required"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.SERVICE_NAME);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkServiceNameFormat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 解析出实例信息，封装为Instance对象")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," parseInstance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 注册实例")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    serviceManager."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerInstance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "ok"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[153]||(a[153]=e("p",null,"这里，进入到了serviceManager.registerInstance()方法中。",-1)),a[154]||(a[154]=e("h4",{id:"_2-3-2-servicemanager",tabindex:"-1"},[E("2.3.2 ServiceManager "),e("a",{class:"header-anchor",href:"#_2-3-2-servicemanager","aria-label":'Permalink to "2.3.2 ServiceManager"'},"​")],-1)),a[155]||(a[155]=e("p",null,"ServiceManager就是Nacos中管理服务、实例信息的核心API，其中就包含Nacos的服务注册表：",-1)),a[156]||(a[156]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922141703128.png",alt:"image-20210922141703128",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[157]||(a[157]=e("p",null,"而其中的registerInstance方法就是注册服务实例的方法：",-1)),a[158]||(a[158]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * Register an instance to a service in AP mode.")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * <p>This method creates service or cluster silently if they don't exist.")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," namespaceId"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," id of namespace")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," serviceName"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," service name")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," instance"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    instance to register")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@throws"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Exception"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," any error occurred in the process")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," registerInstance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String namespaceId, String serviceName, Instance instance) throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 创建一个空的service（如果是第一次来注册实例，要先创建一个空service出来，放入注册表）")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 此时不包含实例信息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    createEmptyService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 拿到创建好的service")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 拿不到则抛异常")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," NacosException"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(NacosException.INVALID_PARAM,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                                 "service not found, namespace: "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," namespaceId "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ", service: "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 添加要注册的实例到service中")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    addInstance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[159]||(a[159]=e("p",null,"创建好了服务，接下来就要添加实例到服务中：",-1)),a[160]||(a[160]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * Add instance to service.")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," namespaceId"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," namespace")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," serviceName"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," service name")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," ephemeral"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   whether instance is ephemeral")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," ips"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         instances")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@throws"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," NacosException"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," nacos exception")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addInstance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String namespaceId, String serviceName, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral, Instance... ips)")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 监听服务列表用到的key，服务唯一标识，例如：com.alibaba.nacos.naming.iplist.ephemeral.public##DEFAULT_GROUP@@order-service")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," KeyBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildInstanceListKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, ephemeral);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取服务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 同步锁，避免并发修改的安全问题")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    synchronized"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (service) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1）获取要更新的实例列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> instanceList "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addIpAddresses"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service, ephemeral, ips);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 2）封装实例列表到Instances对象")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Instances instances "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Instances"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instances."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInstanceList"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instanceList);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 3）完成 注册表更新 以及 Nacos集群的数据同步")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        consistencyService."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, instances);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[161]||(a[161]=e("p",null,"该方法中对修改服务列表的动作加锁处理，确保线程安全。而在同步代码块中，包含下面几步：",-1)),a[162]||(a[162]=e("ul",null,[e("li",null,[E("1）先获取要更新的实例列表，"),e("code",null,"addIpAddresses(service, ephemeral, ips);")]),e("li",null,[E("2）然后将更新后的数据封装到"),e("code",null,"Instances"),E("对象中，后面更新注册表时使用")]),e("li",null,[E("3）最后，调用"),e("code",null,"consistencyService.put()"),E("方法完成Nacos集群的数据同步，保证集群一致性。")])],-1)),a[163]||(a[163]=e("blockquote",null,[e("p",null,"注意：在第1步的addIPAddress中，会拷贝旧的实例列表，添加新实例到列表中。在第3步中，完成对实例状态更新后，则会用新列表直接覆盖旧实例列表。而在更新过程中，旧实例列表不受影响，用户依然可以读取。"),e("p",null,"这样在更新列表状态过程中，无需阻塞用户的读操作，也不会导致用户读取到脏数据，性能比较好。这种方案称为CopyOnWrite方案。")],-1)),a[164]||(a[164]=e("h5",{id:"_1-更服务列表",tabindex:"-1"},[E("1）更服务列表 "),e("a",{class:"header-anchor",href:"#_1-更服务列表","aria-label":'Permalink to "1）更服务列表"'},"​")],-1)),a[165]||(a[165]=e("p",null,[E("我们来看看实例列表的更新，对应的方法是"),e("code",null,"addIpAddresses(service, ephemeral, ips);"),E("：")],-1)),a[166]||(a[166]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Instance"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addIpAddresses"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Service service, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral, Instance... ips) throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," updateIpAddresses"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service, UtilsAndCommons.UPDATE_INSTANCE_ACTION_ADD, ephemeral, ips);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[167]||(a[167]=e("p",null,[E("继续进入"),e("code",null,"updateIpAddresses"),E("方法：")],-1)),a[168]||(a[168]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Instance"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," updateIpAddresses"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Service service, String action, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral, Instance... ips)")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 根据namespaceId、serviceName获取当前服务的实例列表，返回值是Datum")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 第一次来，肯定是null")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Datum datum "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," consistencyService")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KeyBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildInstanceListKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNamespaceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), ephemeral));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 得到服务中现有的实例列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> currentIPs "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allIPs"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ephemeral);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建map，保存实例列表，key为ip地址，value是Instance对象")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> currentInstances "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(currentIPs."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建Set集合，保存实例的instanceId")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Set<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> currentInstanceIds "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Sets."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newHashSet"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 遍历要现有的实例列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," currentIPs) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 添加到map中")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        currentInstances."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toIpAddr"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 添加instanceId到set中")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        currentInstanceIds."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建map，用来保存更新后的实例列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> instanceMap;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (datum "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," !="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," datum.value) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果服务中已经有旧的数据，则先保存旧的实例列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instanceMap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setValid"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(((Instances) datum.value)."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceList"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), currentInstances);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果没有旧数据，则直接创建新的map")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instanceMap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(ips.length);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 遍历实例列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ips) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 判断服务中是否包含要注册的实例的cluster信息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterMap"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果不包含，创建新的cluster")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Cluster cluster "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Cluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), service);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            cluster."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"init"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 将集群放入service的注册表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterMap"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), cluster);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.SRV_LOG")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cluster: {} not found, ip: {}, will create new cluster with default configuration."'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                      instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 删除实例 or 新增实例 ？")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(action)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instanceMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDatumKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 新增实例，instance生成全新的instanceId")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Instance oldInstance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instanceMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDatumKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (oldInstance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInstanceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(oldInstance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInstanceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"generateInstanceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(currentInstanceIds));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 放入instance列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instanceMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDatumKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instanceMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UtilsAndCommons.UPDATE_INSTANCE_ACTION_ADD."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(action)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," IllegalArgumentException"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'            "ip list can not be empty, service: "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ", ip list: "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instanceMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"values"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 将instanceMap中的所有实例转为List返回")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>(instanceMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"values"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[169]||(a[169]=e("p",null,"简单来讲，就是先获取旧的实例列表，然后把新的实例信息与旧的做对比，新的实例就添加，老的实例同步ID。然后返回最新的实例列表。",-1)),a[170]||(a[170]=e("h5",{id:"_2-nacos集群一致性",tabindex:"-1"},[E("2）Nacos集群一致性 "),e("a",{class:"header-anchor",href:"#_2-nacos集群一致性","aria-label":'Permalink to "2）Nacos集群一致性"'},"​")],-1)),a[171]||(a[171]=e("p",null,"在完成本地服务列表更新后，Nacos又实现了集群一致性更新，调用的是:",-1)),a[172]||(a[172]=e("p",null,[e("code",null,"consistencyService.put(key, instances);")],-1)),a[173]||(a[173]=e("p",null,"这里的ConsistencyService接口，代表集群一致性的接口，有很多中不同实现：",-1)),a[174]||(a[174]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922161705573.png",alt:"image-20210922161705573",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[175]||(a[175]=e("p",null,"我们进入DelegateConsistencyServiceImpl来看：",-1)),a[176]||(a[176]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key, Record value) throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 根据实例是否是临时实例，判断委托对象")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    mapConsistencyService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, value);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[177]||(a[177]=e("p",null,[E("其中的"),e("code",null,"mapConsistencyService(key)"),E("方法就是选择委托方式的：")],-1)),a[178]||(a[178]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ConsistencyService "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mapConsistencyService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断是否是临时实例：")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 是，选择 ephemeralConsistencyService，也就是 DistroConsistencyServiceImpl类")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 否，选择 persistentConsistencyService，也就是PersistentConsistencyServiceDelegateImpl")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," KeyBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"matchEphemeralKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeralConsistencyService "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," persistentConsistencyService;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[179]||(a[179]=e("p",null,"默认情况下，所有实例都是临时实例，我们关注DistroConsistencyServiceImpl即可。",-1)),a[180]||(a[180]=e("h4",{id:"_2-3-4-distroconsistencyserviceimpl",tabindex:"-1"},[E("2.3.4 DistroConsistencyServiceImpl "),e("a",{class:"header-anchor",href:"#_2-3-4-distroconsistencyserviceimpl","aria-label":'Permalink to "2.3.4 DistroConsistencyServiceImpl"'},"​")],-1)),a[181]||(a[181]=e("p",null,"我们来看临时实例的一致性实现：DistroConsistencyServiceImpl类的put方法：",-1)),a[182]||(a[182]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key, Record value) throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 先将要更新的实例信息写入本地实例列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    onPut"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, value);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 开始集群同步")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    distroProtocol."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sync"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DistroKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, KeyBuilder.INSTANCE_LIST_KEY_PREFIX), DataOperation.CHANGE,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        globalConfig."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTaskDispatchPeriod"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[183]||(a[183]=e("p",null,"这里方法只有两行：",-1)),a[184]||(a[184]=e("ul",null,[e("li",null,[e("code",null,"onPut(key, value)"),E("：其中value就是Instances，要更新的服务信息。这行主要是基于线程池方式，异步的将Service信息写入注册表中(就是那个多重Map)")]),e("li",null,[e("code",null,"distroProtocol.sync()"),E("：就是通过Distro协议将数据同步给集群中的其它Nacos节点")])],-1)),a[185]||(a[185]=e("p",null,"我们先看onPut方法",-1)),a[186]||(a[186]=e("h5",{id:"_2-3-4-1-更新本地实例列表",tabindex:"-1"},[E("2.3.4.1 更新本地实例列表 "),e("a",{class:"header-anchor",href:"#_2-3-4-1-更新本地实例列表","aria-label":'Permalink to "2.3.4.1 更新本地实例列表"'},"​")],-1)),a[187]||(a[187]=e("h6",{id:"_1-放入阻塞队列",tabindex:"-1"},[E("1）放入阻塞队列 "),e("a",{class:"header-anchor",href:"#_1-放入阻塞队列","aria-label":'Permalink to "1）放入阻塞队列"'},"​")],-1)),a[188]||(a[188]=e("p",null,"onPut方法如下：",-1)),a[189]||(a[189]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," onPut"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key, Record value) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 判断是否是临时实例")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (KeyBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"matchEphemeralInstanceListKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 封装 Instances 信息到 数据集：Datum")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Datum<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instances"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> datum "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Datum<>();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        datum.value "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instances) value;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        datum.key "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        datum.timestamp."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"incrementAndGet"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入DataStore")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        dataStore."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, datum);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"listeners."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 放入阻塞队列，这里的 notifier维护了一个阻塞队列，并且基于线程池异步执行队列中的任务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    notifier."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, DataOperation.CHANGE);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[190]||(a[190]=e("p",null,[E("notifier的类型就是"),e("code",null,"DistroConsistencyServiceImpl.Notifier"),E("，内部维护了一个阻塞队列，存放服务列表变更的事件：")],-1)),a[191]||(a[191]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922180246555.png",alt:"image-20210922180246555",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[192]||(a[192]=e("p",null,"addTask时，将任务加入该阻塞队列：",-1)),a[193]||(a[193]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// DistroConsistencyServiceImpl.Notifier类的 addTask 方法：")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String datumKey, DataOperation action) {")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (services."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," action "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DataOperation.CHANGE) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (action "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DataOperation.CHANGE) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        services."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey, StringUtils.EMPTY);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 任务放入阻塞队列")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    tasks."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"offer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Pair."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"with"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey, action));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[194]||(a[194]=e("h6",{id:"_2-notifier异步更新",tabindex:"-1"},[E("2）Notifier异步更新 "),e("a",{class:"header-anchor",href:"#_2-notifier异步更新","aria-label":'Permalink to "2）Notifier异步更新"'},"​")],-1)),a[195]||(a[195]=e("p",null,"同时，notifier还是一个Runnable，通过一个单线程的线程池来不断从阻塞队列中获取任务，执行服务列表的更新。来看下其中的run方法：",-1)),a[196]||(a[196]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// DistroConsistencyServiceImpl.Notifier类的run方法：")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Loggers.DISTRO."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"distro notifier started"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 死循环，不断执行任务。因为是阻塞队列，不会导致CPU负载过高")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (; ; ) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 从阻塞队列中获取任务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Pair<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DataOperation"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> pair "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tasks."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"take"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 处理任务，更新服务列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            handle"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pair);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.DISTRO."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DISTRO] Error while handling notifying task"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[197]||(a[197]=e("p",null,"来看看handle方法：",-1)),a[198]||(a[198]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// DistroConsistencyServiceImpl.Notifier类的 handle 方法：")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handle"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Pair"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"String, DataOperation"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pair) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String datumKey "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pair."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        DataOperation action "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pair."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue1"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        services."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"listeners."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 遍历，找到变化的service，这里的 RecordListener就是 Service")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (RecordListener listener "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," listeners."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey)) {")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            count"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 服务的实例列表CHANGE事件")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (action "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DataOperation.CHANGE) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 更新服务列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    listener."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"onChange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey, dataStore."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey).value);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    continue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t\t// 服务的实例列表 DELETE 事件")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (action "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DataOperation.DELETE) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    listener."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"onDelete"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    continue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Loggers.DISTRO."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DISTRO] error while notifying listener of key: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", datumKey, e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Loggers.DISTRO."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.DISTRO")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DISTRO] datum change notified, key: {}, listener count: {}, action: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                       datumKey, count, action."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"name"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.DISTRO."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DISTRO] Error while handling notifying task"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[199]||(a[199]=e("h6",{id:"_3-覆盖实例列表",tabindex:"-1"},[E("3）覆盖实例列表 "),e("a",{class:"header-anchor",href:"#_3-覆盖实例列表","aria-label":'Permalink to "3）覆盖实例列表"'},"​")],-1)),a[200]||(a[200]=e("p",null,"而在Service的onChange方法中，就可以看到更新实例列表的逻辑了：",-1)),a[201]||(a[201]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," onChange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key, Instances value) throws Exception {")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-RAFT] datum is changed, key: {}, value: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key, value);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 更新实例列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    updateIPs"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceList"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), KeyBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"matchEphemeralInstanceListKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key));")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    recalculateChecksum"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[202]||(a[202]=e("p",null,"updateIPs方法：",-1)),a[203]||(a[203]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," updateIPs"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collection"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Instance"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instances, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 准备一个Map，key是cluster，值是集群下的Instance集合")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> ipMap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(clusterMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取服务的所有cluster名称")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (String clusterName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clusterMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"keySet"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ipMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterName, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 遍历要更新的实例")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instances) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DOM] received malformed ip: null"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                continue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 判断实例是否包含clusterName，没有的话用默认cluster")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UtilsAndCommons.DEFAULT_CLUSTER_NAME);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 判断cluster是否存在，不存在则创建新的cluster")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"clusterMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Loggers.SRV_LOG")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cluster: {} not found, ip: {}, will create new cluster with default configuration."'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                          instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Cluster cluster "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Cluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                cluster."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"init"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                getClusterMap"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), cluster);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 获取当前cluster实例的集合，不存在则创建新的")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> clusterIPs "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ipMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clusterIPs "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                clusterIPs "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LinkedList<>();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ipMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), clusterIPs);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 添加新的实例到 Instance 集合")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            clusterIPs."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DOM] failed to process ip: "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance, e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Map.Entry<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> entry "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ipMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entrySet"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //make every ip mine")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> entryIPs "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," entry."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 将实例集合更新到 clusterMap（注册表）")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clusterMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entry."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"updateIps"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entryIPs, ephemeral);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    setLastModifiedMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(System."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发布服务变更的通知消息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    getPushService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"serviceChanged"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    StringBuilder stringBuilder "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," StringBuilder"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," allIPs"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"append"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toIpAddr"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"append"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"_"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"append"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isHealthy"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"append"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Loggers.EVT_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[IP-UPDATED] namespace: {}, service: {}, ips: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNamespaceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                         stringBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[204]||(a[204]=e("p",null,[E("在第45行的代码中："),e("code",null,"clusterMap.get(entry.getKey()).updateIps(entryIPs, ephemeral);")],-1)),a[205]||(a[205]=e("p",null,"就是在更新注册表：",-1)),a[206]||(a[206]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," updateIps"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(List"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Instance"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ips, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取旧实例列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Set<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> toUpdateInstances "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeralInstances "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," persistentInstances;")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    HashMap<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> oldIpMap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(toUpdateInstances."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance ip "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," toUpdateInstances) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        oldIpMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDatumKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), ip);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 检查新加入实例的状态")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> newIPs "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," subtract"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ips, oldIpMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"values"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (newIPs."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.EVT_LOG")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"{} {SYNC} {IP-NEW} cluster: {}, new ips size: {}, content: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                  getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), newIPs."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), newIPs."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance ip "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," newIPs) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            HealthCheckStatus."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"reset"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 移除要删除的实例")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> deadIPs "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," subtract"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(oldIpMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"values"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), ips);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (deadIPs."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.EVT_LOG")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"{} {SYNC} {IP-DEAD} cluster: {}, dead ips size: {}, content: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                  getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), deadIPs."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), deadIPs."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance ip "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," deadIPs) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            HealthCheckStatus."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remv"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    toUpdateInstances "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashSet<>(ips);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 直接覆盖旧实例列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ephemeral) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ephemeralInstances "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," toUpdateInstances;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        persistentInstances "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," toUpdateInstances;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[207]||(a[207]=e("h5",{id:"_2-3-4-2-集群数据同步",tabindex:"-1"},[E("2.3.4.2 集群数据同步 "),e("a",{class:"header-anchor",href:"#_2-3-4-2-集群数据同步","aria-label":'Permalink to "2.3.4.2 集群数据同步"'},"​")],-1)),a[208]||(a[208]=e("p",null,"在DistroConsistencyServiceImpl的put方法中分为两步：",-1)),a[209]||(a[209]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922195603450.png",alt:"image-20210922195603450",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[210]||(a[210]=e("p",null,"其中的onPut方法已经分析过了。",-1)),a[211]||(a[211]=e("p",null,"下面的distroProtocol.sync()就是集群同步的逻辑了。",-1)),a[212]||(a[212]=e("p",null,"DistroProtocol类的sync方法如下：",-1)),a[213]||(a[213]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," sync"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(DistroKey distroKey, DataOperation action, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," delay) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 遍历 Nacos 集群中除自己以外的其它节点")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Member each "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," memberManager."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allMembersWithoutSelf"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        DistroKey distroKeyWithTarget "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DistroKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(distroKey."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getResourceKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), distroKey."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getResourceType"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                                      each."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAddress"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 定义一个Distro的同步任务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        DistroDelayTask distroDelayTask "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DistroDelayTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(distroKeyWithTarget, action, delay);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 交给线程池去执行")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        distroTaskEngineHolder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDelayTaskExecuteEngine"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(distroKeyWithTarget, distroDelayTask);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Loggers.DISTRO."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.DISTRO."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[DISTRO-SCHEDULE] {} to {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", distroKey, each."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAddress"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[214]||(a[214]=e("p",null,[E("其中同步的任务封装为一个"),e("code",null,"DistroDelayTask"),E("对象。")],-1)),a[215]||(a[215]=e("p",null,[E("交给了"),e("code",null,"distroTaskEngineHolder.getDelayTaskExecuteEngine()"),E("执行，这行代码的返回值是：")],-1)),a[216]||(a[216]=e("p",null,[e("code",null,"NacosDelayTaskExecuteEngine"),E("，这个类维护了一个线程池，并且接收任务，执行任务。")],-1)),a[217]||(a[217]=e("p",null,"执行任务的方法为processTasks()方法：",-1)),a[218]||(a[218]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"protected"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," processTasks"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Collection<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> keys "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getAllTaskKeys"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Object taskKey "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keys) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        AbstractDelayTask task "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," removeTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskKey);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," =="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," task) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            continue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NacosTaskProcessor processor "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getProcessor"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskKey);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," =="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," processor) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            getEngineLog"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"processor not found for task, so discarded. "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," task);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            continue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 尝试执行同步任务，如果失败会重试")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"processor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"process"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(task)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                retryFailedTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskKey, task);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            getEngineLog"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Nacos task execute error : "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            retryFailedTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskKey, task);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[219]||(a[219]=e("p",null,"可以看出来基于Distro模式的同步是异步进行的，并且失败时会将任务重新入队并充实，因此不保证同步结果的强一致性，属于AP模式的一致性策略。",-1)),a[220]||(a[220]=e("h4",{id:"_2-3-5-服务端流程图",tabindex:"-1"},[E("2.3.5 服务端流程图 "),e("a",{class:"header-anchor",href:"#_2-3-5-服务端流程图","aria-label":'Permalink to "2.3.5 服务端流程图"'},"​")],-1)),a[221]||(a[221]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923214042926.png",alt:"image-20210923214042926",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[222]||(a[222]=e("h3",{id:"_2-4-总结",tabindex:"-1"},[E("2.4 总结 "),e("a",{class:"header-anchor",href:"#_2-4-总结","aria-label":'Permalink to "2.4 总结"'},"​")],-1)),a[223]||(a[223]=e("blockquote",null,[e("ul",null,[e("li",null,[e("p",null,"Nacos的注册表结构是什么样的？"),e("ul",null,[e("li",null,[e("p",null,"答：Nacos是多级存储模型，最外层通过namespace来实现环境隔离，然后是group分组，分组下就是服务，一个服务有可以分为不同的集群，集群中包含多个实例。因此其注册表结构为一个Map，类型是："),e("p",null,[e("code",null,"Map<String, Map<String, Service>>"),E("，")]),e("p",null,[E("外层key是"),e("code",null,"namespace_id"),E("，内层key是"),e("code",null,"group+serviceName"),E(".")]),e("p",null,[E("Service内部维护一个Map，结构是："),e("code",null,"Map<String,Cluster>"),E("，key是clusterName，值是集群信息")]),e("p",null,"Cluster内部维护一个Set集合，元素是Instance类型，代表集群中的多个实例。")])])]),e("li",null,[e("p",null,"Nacos如何保证并发写的安全性？"),e("ul",null,[e("li",null,"答：首先，在注册实例时，会对service加锁，不同service之间本身就不存在并发写问题，互不影响。相同service时通过锁来互斥。并且，在更新实例列表时，是基于异步的线程池来完成，而线程池的线程数量为1.")])]),e("li",null,[e("p",null,"Nacos如何避免并发读写的冲突？"),e("ul",null,[e("li",null,"答：Nacos在更新实例列表时，会采用CopyOnWrite技术，首先将Old实例列表拷贝一份，然后更新拷贝的实例列表，再用更新后的实例列表来覆盖旧的实例列表。")])]),e("li",null,[e("p",null,"Nacos如何应对阿里内部数十万服务的并发写请求？"),e("ul",null,[e("li",null,"答：Nacos内部会将服务注册的任务放入阻塞队列，采用线程池异步来完成实例更新，从而提高并发写能力。")])])])],-1)),a[224]||(a[224]=e("hr",null,null,-1)),a[225]||(a[225]=e("h2",{id:"_3-服务心跳",tabindex:"-1"},[E("3.服务心跳 "),e("a",{class:"header-anchor",href:"#_3-服务心跳","aria-label":'Permalink to "3.服务心跳"'},"​")],-1)),a[226]||(a[226]=e("p",null,"Nacos的实例分为临时实例和永久实例两种，可以通过在yaml 文件配置：",-1)),a[227]||(a[227]=e("div",{class:"language-yaml max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"yaml"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  application"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    name"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"order-service")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    nacos"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      discovery"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        ephemeral"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 设置实例为永久实例。true：临时; false：永久")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      server-addr"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.1:8845")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[228]||(a[228]=e("p",null,"临时实例基于心跳方式做健康检测，而永久实例则是由Nacos主动探测实例状态。",-1)),a[229]||(a[229]=e("p",null,"其中Nacos提供的心跳的API接口为：",-1)),a[230]||(a[230]=e("p",null,[e("strong",null,"接口描述"),E("：发送某个实例的心跳")],-1)),a[231]||(a[231]=e("p",null,[e("strong",null,"请求类型"),E("：PUT")],-1)),a[232]||(a[232]=e("p",null,[e("strong",null,"请求路径"),E("：")],-1)),a[233]||(a[233]=e("div",{class:"language-plain max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"plain"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",null,"/nacos/v1/ns/instance/beat")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[234]||(a[234]=e("p",null,[e("strong",null,"请求参数"),E("：")],-1)),a[235]||(a[235]=e("table",null,[e("thead",null,[e("tr",null,[e("th",{style:{"text-align":"left"}},"名称"),e("th",{style:{"text-align":"left"}},"类型"),e("th",{style:{"text-align":"left"}},"是否必选"),e("th",null,"描述")])]),e("tbody",null,[e("tr",null,[e("td",{style:{"text-align":"left"}},"serviceName"),e("td",{style:{"text-align":"left"}},"字符串"),e("td",{style:{"text-align":"left"}},"是"),e("td",null,"服务名")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"groupName"),e("td",{style:{"text-align":"left"}},"字符串"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"分组名")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"ephemeral"),e("td",{style:{"text-align":"left"}},"boolean"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"是否临时实例")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"beat"),e("td",{style:{"text-align":"left"}},"JSON格式字符串"),e("td",{style:{"text-align":"left"}},"是"),e("td",null,"实例心跳内容")])])],-1)),a[236]||(a[236]=e("p",null,[e("strong",null,"错误编码"),E("：")],-1)),a[237]||(a[237]=e("table",null,[e("thead",null,[e("tr",null,[e("th",{style:{"text-align":"left"}},"错误代码"),e("th",{style:{"text-align":"left"}},"描述"),e("th",{style:{"text-align":"left"}},"语义")])]),e("tbody",null,[e("tr",null,[e("td",{style:{"text-align":"left"}},"400"),e("td",{style:{"text-align":"left"}},"Bad Request"),e("td",{style:{"text-align":"left"}},"客户端请求中的语法错误")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"403"),e("td",{style:{"text-align":"left"}},"Forbidden"),e("td",{style:{"text-align":"left"}},"没有权限")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"404"),e("td",{style:{"text-align":"left"}},"Not Found"),e("td",{style:{"text-align":"left"}},"无法找到资源")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"500"),e("td",{style:{"text-align":"left"}},"Internal Server Error"),e("td",{style:{"text-align":"left"}},"服务器内部错误")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"200"),e("td",{style:{"text-align":"left"}},"OK"),e("td",{style:{"text-align":"left"}},"正常")])])],-1)),a[238]||(a[238]=e("h3",{id:"_3-1-客户端",tabindex:"-1"},[E("3.1 客户端 "),e("a",{class:"header-anchor",href:"#_3-1-客户端","aria-label":'Permalink to "3.1 客户端"'},"​")],-1)),a[239]||(a[239]=e("p",null,"在2.2.4.服务注册这一节中，我们说过NacosNamingService这个类实现了服务的注册，同时也实现了服务心跳：",-1)),a[240]||(a[240]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," registerInstance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String groupName, Instance instance) throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkInstanceIsLegal"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String groupedServiceName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupedName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, groupName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断是否是临时实例。")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果是临时实例，则构建心跳信息BeatInfo")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        BeatInfo beatInfo "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beatReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildBeatInfo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 添加心跳任务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        beatReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addBeatInfo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, beatInfo);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    serverProxy."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, groupName, instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[241]||(a[241]=e("h4",{id:"_3-1-1-beatinfo",tabindex:"-1"},[E("3.1.1 BeatInfo "),e("a",{class:"header-anchor",href:"#_3-1-1-beatinfo","aria-label":'Permalink to "3.1.1 BeatInfo"'},"​")],-1)),a[242]||(a[242]=e("p",null,"这里的BeanInfo就包含心跳需要的各种信息：",-1)),a[243]||(a[243]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922213313677.png",alt:"image-20210922213313677",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[244]||(a[244]=e("h4",{id:"_3-1-2-beatreactor",tabindex:"-1"},[E("3.1.2 BeatReactor "),e("a",{class:"header-anchor",href:"#_3-1-2-beatreactor","aria-label":'Permalink to "3.1.2 BeatReactor"'},"​")],-1)),a[245]||(a[245]=e("p",null,[E("而"),e("code",null,"BeatReactor"),E("这个类则维护了一个线程池：")],-1)),a[246]||(a[246]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922213455549.png",alt:"image-20210922213455549",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[247]||(a[247]=e("p",null,[E("当调用"),e("code",null,"BeatReactor"),E("的"),e("code",null,".addBeatInfo(groupedServiceName, beatInfo)"),E("方法时，就会执行心跳：")],-1)),a[248]||(a[248]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addBeatInfo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, BeatInfo beatInfo) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NAMING_LOGGER."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[BEAT] adding beat: {} to beat map."'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", beatInfo);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," buildKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    BeatInfo existBeat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //fix #1733")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((existBeat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dom2Beat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        existBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStopped"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    dom2Beat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, beatInfo);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 利用线程池，定期执行心跳任务，周期为 beatInfo.getPeriod()")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    executorService."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"schedule"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BeatTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo), beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPeriod"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), TimeUnit.MILLISECONDS);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    MetricsMonitor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDom2BeatSizeMonitor"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(dom2Beat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[249]||(a[249]=e("p",null,[E("心跳周期的默认值在"),e("code",null,"com.alibaba.nacos.api.common.Constants"),E("类中：")],-1)),a[250]||(a[250]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922213829632.png",alt:"image-20210922213829632",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[251]||(a[251]=e("p",null,"可以看到是5秒，默认5秒一次心跳。",-1)),a[252]||(a[252]=e("h4",{id:"_3-1-3-beattask",tabindex:"-1"},[E("3.1.3 BeatTask "),e("a",{class:"header-anchor",href:"#_3-1-3-beattask","aria-label":'Permalink to "3.1.3 BeatTask"'},"​")],-1)),a[253]||(a[253]=e("p",null,[E("心跳的任务封装在"),e("code",null,"BeatTask"),E("这个类中，是一个Runnable，其run方法如下：")],-1)),a[254]||(a[254]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isStopped"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取心跳周期")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," nextTime "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPeriod"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 发送心跳")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        JsonNode result "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serverProxy."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sendBeat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo, BeatReactor.this.lightBeatEnabled);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," interval "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clientBeatInterval"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"asLong"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lightBeatEnabled "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"has"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.LIGHT_BEAT_ENABLED)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            lightBeatEnabled "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.LIGHT_BEAT_ENABLED)."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"asBoolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        BeatReactor.this.lightBeatEnabled "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lightBeatEnabled;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (interval "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            nextTime "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," interval;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 判断心跳结果")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," code "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingResponseCode.OK;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"has"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CODE)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            code "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CODE)."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"asInt"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (code "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingResponseCode.RESOURCE_NOT_FOUND) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果失败，则需要 重新注册实例")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setWeight"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWeight"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMetadata"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMetadata"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setServiceName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInstanceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setEphemeral"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                serverProxy."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                            NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()), instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"ignore"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (NacosException "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"ex"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NAMING_LOGGER."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] failed to send beat: {}, code: {}, msg: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo), ex."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getErrCode"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), ex."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getErrMsg"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unknownEx"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NAMING_LOGGER."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] failed to send beat: {}, unknown exception msg: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo), unknownEx."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessage"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), unknownEx);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        executorService."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"schedule"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BeatTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo), nextTime, TimeUnit.MILLISECONDS);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[255]||(a[255]=e("h4",{id:"_3-1-4-发送心跳",tabindex:"-1"},[E("3.1.4 发送心跳 "),e("a",{class:"header-anchor",href:"#_3-1-4-发送心跳","aria-label":'Permalink to "3.1.4 发送心跳"'},"​")],-1)),a[256]||(a[256]=e("p",null,[E("最终心跳的发送还是通过"),e("code",null,"NamingProxy"),E("的"),e("code",null,"sendBeat"),E("方法来实现：")],-1)),a[257]||(a[257]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JsonNode "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sendBeat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(BeatInfo beatInfo, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lightBeatEnabled) throws NacosException {")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (NAMING_LOGGER."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NAMING_LOGGER."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[BEAT] {} sending beat to server: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", namespaceId, beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 组织请求参数")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> params "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> bodyMap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"lightBeatEnabled) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        bodyMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"beat"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.NAMESPACE_ID, namespaceId);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.SERVICE_NAME, beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CLUSTER_NAME, beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ip"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"port"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送请求，这个地址就是：/v1/ns/instance/beat")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String result "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," reqApi"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UtilAndComs.nacosUrlBase "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/instance/beat"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", params, bodyMap, HttpMethod.PUT);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toObj"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(result);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[258]||(a[258]=e("h3",{id:"_3-2-服务端",tabindex:"-1"},[E("3.2 服务端 "),e("a",{class:"header-anchor",href:"#_3-2-服务端","aria-label":'Permalink to "3.2 服务端"'},"​")],-1)),a[259]||(a[259]=e("p",null,"对于临时实例，服务端代码分两部分：",-1)),a[260]||(a[260]=e("ul",null,[e("li",null,"1）InstanceController提供了一个接口，处理客户端的心跳请求"),e("li",null,"2）定时检测实例心跳是否按期执行")],-1)),a[261]||(a[261]=e("h4",{id:"_3-2-1-instancecontroller",tabindex:"-1"},[E("3.2.1 InstanceController "),e("a",{class:"header-anchor",href:"#_3-2-1-instancecontroller","aria-label":'Permalink to "3.2.1 InstanceController"'},"​")],-1)),a[262]||(a[262]=e("p",null,"与服务注册时一样，在nacos-naming模块中的InstanceController类中，定义了一个方法用来处理心跳请求：",-1)),a[263]||(a[263]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CanDistro")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PutMapping"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/beat"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Secured"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"parser"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingResourceParser.class, "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"action"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ActionTypes.WRITE)")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectNode "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"beat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest request) throws Exception {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 解析心跳的请求参数")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ObjectNode result "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createEmptyJsonNode"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SwitchEntry.CLIENT_BEAT_INTERVAL, switchDomain."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClientBeatInterval"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String beat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"beat"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    RsInfo clientBeat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotBlank"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clientBeat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toObj"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat, RsInfo.class);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String clusterName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.CLUSTER_NAME, UtilsAndCommons.DEFAULT_CLUSTER_NAME);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String ip "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ip"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," port "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseInt"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"port"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"0"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clientBeat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotBlank"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            clusterName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // fix #2533")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ip "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        port "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String namespaceId "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String serviceName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"required"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.SERVICE_NAME);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkServiceNameFormat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] full arguments: beat: {}, serviceName: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clientBeat, serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 尝试根据参数中的namespaceId、serviceName、clusterName、ip、port等信息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 从Nacos的注册表中 获取实例")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceManager."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, clusterName, ip, port);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 如果获取失败，说明心跳失败，实例尚未注册")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clientBeat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CODE, NamingResponseCode.RESOURCE_NOT_FOUND);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] The instance has been removed for health mechanism, "')]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                             +"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "perform data compensation operations, beat: {}, serviceName: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clientBeat, serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 这里重新注册一个实例")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setWeight"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWeight"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMetadata"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMetadata"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setClusterName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setServiceName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInstanceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setEphemeral"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceManager."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerInstance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 尝试基于namespaceId和serviceName从 注册表中获取Service服务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceManager."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 如果不存在，说明服务不存在，返回404")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," NacosException"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(NacosException.SERVER_ERROR,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                                 "service not found: "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "@"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," namespaceId);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clientBeat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clientBeat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RsInfo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(port);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clientBeat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果心跳没问题，开始处理心跳结果")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"processClientBeat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CODE, NamingResponseCode.OK);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsMetadata"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(PreservedMetadataKeys.HEART_BEAT_INTERVAL)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SwitchEntry.CLIENT_BEAT_INTERVAL, instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceHeartBeatInterval"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SwitchEntry.LIGHT_BEAT_ENABLED, switchDomain."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isLightBeatEnabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[264]||(a[264]=e("p",null,"最终，在确认心跳请求对应的服务、实例都在的情况下，开始交给Service类处理这次心跳请求。调用了Service的processClientBeat方法",-1)),a[265]||(a[265]=e("h4",{id:"_3-2-2-处理心跳请求",tabindex:"-1"},[E("3.2.2 处理心跳请求 "),e("a",{class:"header-anchor",href:"#_3-2-2-处理心跳请求","aria-label":'Permalink to "3.2.2 处理心跳请求"'},"​")],-1)),a[266]||(a[266]=e("p",null,[E("查看"),e("code",null,"Service"),E("的"),e("code",null,"service.processClientBeat(clientBeat);"),E("方法：")],-1)),a[267]||(a[267]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," processClientBeat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RsInfo rsInfo) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ClientBeatProcessor clientBeatProcessor "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ClientBeatProcessor"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    clientBeatProcessor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    clientBeatProcessor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setRsInfo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rsInfo);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    HealthCheckReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleNow"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeatProcessor);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[268]||(a[268]=e("p",null,"可以看到心跳信息被封装到了 ClientBeatProcessor类中，交给了HealthCheckReactor处理，HealthCheckReactor就是对线程池的封装，不用过多查看。",-1)),a[269]||(a[269]=e("p",null,"关键的业务逻辑都在ClientBeatProcessor这个类中，它是一个Runnable，其中的run方法如下：",-1)),a[270]||(a[270]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".service;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Loggers.EVT_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.EVT_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] processing beat: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", rsInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String ip "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rsInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String clusterName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rsInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," port "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rsInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取集群信息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Cluster cluster "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterMap"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取集群中的所有实例信息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> instances "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cluster."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allIPs"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instances) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 找到心跳的这个实例")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," port) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Loggers.EVT_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Loggers.EVT_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] refresh beat: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", rsInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 更新实例的最后一次心跳时间 lastBeat")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setLastBeat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(System."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isMarked"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isHealthy"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHealthy"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Loggers.EVT_LOG")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"service: {} {POS} {IP-ENABLED} valid: {}:{}@{}, region: {}, msg: client beat ok"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                              cluster."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), ip, port, cluster."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                              UtilsAndCommons.LOCALHOST_SITE);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                    getPushService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"serviceChanged"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[271]||(a[271]=e("p",null,"处理心跳请求的核心就是更新心跳实例的最后一次心跳时间，lastBeat，这个会成为判断实例心跳是否过期的关键指标！",-1)),a[272]||(a[272]=e("h4",{id:"_3-3-3-心跳异常检测",tabindex:"-1"},[E("3.3.3 心跳异常检测 "),e("a",{class:"header-anchor",href:"#_3-3-3-心跳异常检测","aria-label":'Permalink to "3.3.3 心跳异常检测"'},"​")],-1)),a[273]||(a[273]=e("p",null,[E("在服务注册时，一定会创建一个"),e("code",null,"Service"),E("对象，而"),e("code",null,"Service"),E("中有一个"),e("code",null,"init"),E("方法，会在注册时被调用：")],-1)),a[274]||(a[274]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," init"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 开启心跳检测的任务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    HealthCheckReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleCheck"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeatCheckTask);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Map.Entry<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Cluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> entry "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clusterMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entrySet"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        entry."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        entry."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"init"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[275]||(a[275]=e("p",null,"其中HealthCheckReactor.scheduleCheck就是执行心跳检测的定时任务：",-1)),a[276]||(a[276]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922221022107.png",alt:"image-20210922221022107",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[277]||(a[277]=e("p",null,"可以看到，该任务是5000ms执行一次，也就是5秒对实例的心跳状态做一次检测。",-1)),a[278]||(a[278]=e("p",null,"此处的ClientBeatCheckTask同样是一个Runnable，其中的run方法为：",-1)),a[279]||(a[279]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 找到所有临时实例的列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> instances "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allIPs"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // first set health status of instances:")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instances) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 判断 心跳间隔（当前时间 - 最后一次心跳时间） 是否大于 心跳超时时间，默认15秒")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (System."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastBeat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceHeartBeatTimeOut"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isMarked"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isHealthy"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        // 如果超时，标记实例为不健康 healthy = false")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHealthy"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        // 发布实例状态变更的事件")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                        getPushService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"serviceChanged"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        ApplicationUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"publishEvent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InstanceHeartbeatTimeoutEvent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", instance));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGlobalConfig"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isExpireInstance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // then remove obsolete instances:")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instances) {")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isMarked"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                continue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"           // 判断心跳间隔（当前时间 - 最后一次心跳时间）是否大于 实例被删除的最长超时时间，默认30秒")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (System."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastBeat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIpDeleteTimeout"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 如果是超过了30秒，则删除实例")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[AUTO-DELETE-IP] service: {}, ip: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                     JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                deleteIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Exception while processing client beat time out."'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[280]||(a[280]=e("p",null,[E("其中的超时时间同样是在"),e("code",null,"com.alibaba.nacos.api.common.Constants"),E("这个类中：")],-1)),a[281]||(a[281]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922221344417.png",alt:"image-20210922221344417",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[282]||(a[282]=e("h4",{id:"_3-3-4-主动健康检测",tabindex:"-1"},[E("3.3.4 主动健康检测 "),e("a",{class:"header-anchor",href:"#_3-3-4-主动健康检测","aria-label":'Permalink to "3.3.4 主动健康检测"'},"​")],-1)),a[283]||(a[283]=e("p",null,"对于非临时实例（ephemeral=false)，Nacos会采用主动的健康检测，定时向实例发送请求，根据响应来判断实例健康状态。",-1)),a[284]||(a[284]=e("p",null,[E("入口在2.3.2小节的"),e("code",null,"ServiceManager"),E("类中的registerInstance方法：")],-1)),a[285]||(a[285]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923100740065.png",alt:"image-20210923100740065",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[286]||(a[286]=e("p",null,"创建空服务时：",-1)),a[287]||(a[287]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createEmptyService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String namespaceId, String serviceName, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," local) throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果服务不存在，创建新的服务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    createServiceIfAbsent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, local, "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[288]||(a[288]=e("p",null,"创建服务流程：",-1)),a[289]||(a[289]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createServiceIfAbsent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String namespaceId, String serviceName, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," local, Cluster cluster)")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 尝试获取服务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 发现服务不存在，开始创建新服务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"creating empty service {}:{}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", namespaceId, serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Service"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setNamespaceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setGroupName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // now validate the service. if failed, exception will be thrown")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setLastModifiedMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(System."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"recalculateChecksum"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (cluster "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            cluster."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterMap"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cluster."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), cluster);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"validate"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// ** 写入注册表并初始化 **")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        putServiceAndInit"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"local) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            addOrReplaceService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[290]||(a[290]=e("p",null,[E("关键在"),e("code",null,"putServiceAndInit(service)"),E("方法中：")],-1)),a[291]||(a[291]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," putServiceAndInit"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Service service) throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 将服务写入注册表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    putService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNamespaceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 完成服务的初始化")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"init"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    consistencyService")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"listen"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KeyBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildInstanceListKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNamespaceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"), service);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    consistencyService")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"listen"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KeyBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildInstanceListKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNamespaceId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"), service);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NEW-SERVICE] {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[292]||(a[292]=e("p",null,[E("进入初始化逻辑："),e("code",null,"service.init()"),E("，这个会进入Service类中：")],-1)),a[293]||(a[293]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * Init service.")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," init"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 开启临时实例的心跳监测任务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    HealthCheckReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleCheck"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeatCheckTask);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 遍历注册表中的集群")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Map.Entry<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Cluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> entry "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clusterMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entrySet"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        entry."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 完成集群初识化")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        entry."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"init"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[294]||(a[294]=e("p",null,[E("这里集群的初始化"),e("code",null," entry.getValue().init();"),E("会进入"),e("code",null,"Cluster"),E("类型的"),e("code",null,"init()"),E("方法：")],-1)),a[295]||(a[295]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * Init cluster.")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," init"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (inited) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建健康检测的任务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    checkTask "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HealthCheckTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 这里会开启对 非临时实例的 定时健康检测")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    HealthCheckReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleCheck"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(checkTask);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    inited "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[296]||(a[296]=e("p",null,[E("这里的"),e("code",null,"HealthCheckReactor.scheduleCheck(checkTask);"),E("会开启定时任务，对非临时实例做健康检测。检测逻辑定义在"),e("code",null,"HealthCheckTask"),E("这个类中，是一个Runnable，其中的run方法：")],-1)),a[297]||(a[297]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (distroMapper."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"responsible"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cluster."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," switchDomain")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isHealthCheckEnabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cluster."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 开始健康检测")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            healthCheckProcessor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"process"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 记录日志 。。。")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"       // 记录日志 。。。")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cancelled) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 结束后，再次进行任务调度，一定延迟后执行")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            HealthCheckReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleCheck"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 。。。")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[298]||(a[298]=e("p",null,[E("健康检测逻辑定义在"),e("code",null,"healthCheckProcessor.process(this);"),E("方法中，在HealthCheckProcessor接口中，这个接口也有很多实现，默认是"),e("code",null,"TcpSuperSenseProcessor"),E("：")],-1)),a[299]||(a[299]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923102824451.png",alt:"image-20210923102824451",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[300]||(a[300]=e("p",null,[E("进入"),e("code",null,"TcpSuperSenseProcessor"),E("的process方法：")],-1)),a[301]||(a[301]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," process"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HealthCheckTask task) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取所有 非临时实例的 集合")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ips "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," task."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allIPs"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (CollectionUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ips)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance ip "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ips) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 封装健康检测信息到 Beat")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Beat beat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Beat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, task);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入一个阻塞队列中")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        taskQueue."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        MetricsMonitor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTcpHealthCheckMonitor"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"incrementAndGet"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[302]||(a[302]=e("p",null,"可以看到，所有的健康检测任务都被放入一个阻塞队列，而不是立即执行了。这里又采用了异步执行的策略，可以看到Nacos中大量这样的设计。",-1)),a[303]||(a[303]=e("p",null,[E("而"),e("code",null,"TcpSuperSenseProcessor"),E("本身就是一个Runnable，在它的构造函数中会把自己放入线程池中去执行，其run方法如下：")],-1)),a[304]||(a[304]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    while"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 处理任务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            processTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // ...")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[HEALTH-CHECK] error while processing NIO task"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[305]||(a[305]=e("p",null,"通过processTask来处理健康检测的任务：",-1)),a[306]||(a[306]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," processTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws Exception {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 将任务封装为一个 TaskProcessor，并放入集合")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Collection<Callable<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Void"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> tasks "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LinkedList<>();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    do"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Beat beat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," taskQueue."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"poll"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CONNECT_TIMEOUT_MS "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit.MILLISECONDS);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (beat "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        tasks."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," TaskProcessor"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"while"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (taskQueue."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tasks."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NIO_THREAD_COUNT "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 64"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 批量处理集合中的任务")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Future<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> f "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," GlobalExecutor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"invokeAllTcpSuperSenseTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(tasks)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        f."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[307]||(a[307]=e("p",null,"任务被封装到了TaskProcessor中去执行了，TaskProcessor是一个Callable，其中的call方法：",-1)),a[308]||(a[308]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Void "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"call"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取检测任务已经等待的时长")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," waited "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStartTime"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (waited "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAX_WAIT_TIME_MILLISECONDS) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"beat task waited too long: "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," waited "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "ms"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SocketChannel channel "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取实例信息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Instance instance "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 通过NIO建立TCP连接")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SocketChannel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"open"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"configureBlocking"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // only by setting this can we make the socket close event asynchronous")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"socket"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSoLinger"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"socket"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setReuseAddress"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"socket"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setKeepAlive"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"socket"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setTcpNoDelay"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Cluster cluster "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," port "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cluster."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isUseIPPort4Check"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cluster."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDefCkport"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"connect"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InetSocketAddress"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), port));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 注册连接、读取事件")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SelectionKey key "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"register"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(selector, SelectionKey.OP_CONNECT "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"|"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SelectionKey.OP_READ);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        key."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"attach"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        keyMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BeatKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key));")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        beat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStartTime"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(System."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        GlobalExecutor")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleTcpSuperSenseTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," TimeOutTask"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key), CONNECT_TIMEOUT_MS, TimeUnit.MILLISECONDS);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        beat."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"finishCheck"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", switchDomain."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTcpHealthParams"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMax"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                         "tcp:error:"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessage"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (channel "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"ignore"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[309]||(a[309]=e("h3",{id:"_3-3-总结",tabindex:"-1"},[E("3.3 总结 "),e("a",{class:"header-anchor",href:"#_3-3-总结","aria-label":'Permalink to "3.3 总结"'},"​")],-1)),a[310]||(a[310]=e("blockquote",null,[e("p",null,"Nacos的健康检测有两种模式："),e("ul",null,[e("li",null,[E("临时实例： "),e("ul",null,[e("li",null,"采用客户端心跳检测模式，心跳周期5秒"),e("li",null,"心跳间隔超过15秒则标记为不健康"),e("li",null,"心跳间隔超过30秒则从服务列表删除")])]),e("li",null,[E("永久实例： "),e("ul",null,[e("li",null,"采用服务端主动健康检测方式"),e("li",null,"周期为2000 + 5000毫秒内的随机数"),e("li",null,"检测异常只会标记为不健康，不会删除")])])]),e("p",null,"那么为什么Nacos有临时和永久两种实例呢？"),e("p",null,[E("以淘宝为例，双十一大促期间，流量会比平常高出很多，此时服务肯定需要增加更多实例来应对高并发，而这些实例在双十一之后就无需继续使用了，采用"),e("strong",null,"临时实例"),E("比较合适。而对于服务的一些常备实例，则使用"),e("strong",null,"永久实例"),E("更合适。")]),e("p",null,"与eureka相比，Nacos与Eureka在临时实例上都是基于心跳模式实现，差别不大，主要是心跳周期不同，eureka是30秒，Nacos是5秒。"),e("p",null,"另外，Nacos支持永久实例，而Eureka不支持，Eureka只提供了心跳模式的健康监测，而没有主动检测功能。")],-1)),a[311]||(a[311]=e("hr",null,null,-1)),a[312]||(a[312]=e("h2",{id:"_4-服务发现",tabindex:"-1"},[E("4.服务发现 "),e("a",{class:"header-anchor",href:"#_4-服务发现","aria-label":'Permalink to "4.服务发现"'},"​")],-1)),a[313]||(a[313]=e("p",null,"Nacos提供了一个根据serviceId查询实例列表的接口：",-1)),a[314]||(a[314]=e("p",null,[e("strong",null,"接口描述"),E("：查询服务下的实例列表")],-1)),a[315]||(a[315]=e("p",null,[e("strong",null,"请求类型"),E("：GET")],-1)),a[316]||(a[316]=e("p",null,[e("strong",null,"请求路径"),E("：")],-1)),a[317]||(a[317]=e("div",{class:"language-plain max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"plain"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",null,"/nacos/v1/ns/instance/list")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[318]||(a[318]=e("p",null,[e("strong",null,"请求参数"),E("：")],-1)),a[319]||(a[319]=e("table",null,[e("thead",null,[e("tr",null,[e("th",{style:{"text-align":"left"}},"名称"),e("th",{style:{"text-align":"left"}},"类型"),e("th",{style:{"text-align":"left"}},"是否必选"),e("th",null,"描述")])]),e("tbody",null,[e("tr",null,[e("td",{style:{"text-align":"left"}},"serviceName"),e("td",{style:{"text-align":"left"}},"字符串"),e("td",{style:{"text-align":"left"}},"是"),e("td",null,"服务名")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"groupName"),e("td",{style:{"text-align":"left"}},"字符串"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"分组名")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"namespaceId"),e("td",{style:{"text-align":"left"}},"字符串"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"命名空间ID")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"clusters"),e("td",{style:{"text-align":"left"}},"字符串，多个集群用逗号分隔"),e("td",{style:{"text-align":"left"}},"否"),e("td",null,"集群名称")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"healthyOnly"),e("td",{style:{"text-align":"left"}},"boolean"),e("td",{style:{"text-align":"left"}},"否，默认为false"),e("td",null,"是否只返回健康实例")])])],-1)),a[320]||(a[320]=e("p",null,[e("strong",null,"错误编码"),E("：")],-1)),a[321]||(a[321]=e("table",null,[e("thead",null,[e("tr",null,[e("th",{style:{"text-align":"left"}},"错误代码"),e("th",{style:{"text-align":"left"}},"描述"),e("th",{style:{"text-align":"left"}},"语义")])]),e("tbody",null,[e("tr",null,[e("td",{style:{"text-align":"left"}},"400"),e("td",{style:{"text-align":"left"}},"Bad Request"),e("td",{style:{"text-align":"left"}},"客户端请求中的语法错误")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"403"),e("td",{style:{"text-align":"left"}},"Forbidden"),e("td",{style:{"text-align":"left"}},"没有权限")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"404"),e("td",{style:{"text-align":"left"}},"Not Found"),e("td",{style:{"text-align":"left"}},"无法找到资源")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"500"),e("td",{style:{"text-align":"left"}},"Internal Server Error"),e("td",{style:{"text-align":"left"}},"服务器内部错误")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"200"),e("td",{style:{"text-align":"left"}},"OK"),e("td",{style:{"text-align":"left"}},"正常")])])],-1)),a[322]||(a[322]=e("h3",{id:"_4-1-客户端",tabindex:"-1"},[E("4.1 客户端 "),e("a",{class:"header-anchor",href:"#_4-1-客户端","aria-label":'Permalink to "4.1 客户端"'},"​")],-1)),a[323]||(a[323]=e("h4",{id:"_4-1-1-定时更新服务列表",tabindex:"-1"},[E("4.1.1 定时更新服务列表 "),e("a",{class:"header-anchor",href:"#_4-1-1-定时更新服务列表","aria-label":'Permalink to "4.1.1 定时更新服务列表"'},"​")],-1)),a[324]||(a[324]=e("h5",{id:"_4-1-1-1-nacosnamingservice",tabindex:"-1"},[E("4.1.1.1 NacosNamingService "),e("a",{class:"header-anchor",href:"#_4-1-1-1-nacosnamingservice","aria-label":'Permalink to "4.1.1.1 NacosNamingService"'},"​")],-1)),a[325]||(a[325]=e("p",null,[E("在2.2.4小节中，我们讲到一个类"),e("code",null,"NacosNamingService"),E("，这个类不仅仅提供了服务注册功能，同样提供了服务发现的功能。")],-1)),a[326]||(a[326]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923153419392.png",alt:"image-20210923153419392",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[327]||(a[327]=e("p",null,"多个重载的方法最终都会进入一个方法：",-1)),a[328]||(a[328]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Instance"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getAllInstances"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String groupName, List"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"String"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clusters,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                                      boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," subscribe) throws NacosException {")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ServiceInfo serviceInfo;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.判断是否需要订阅服务信息（默认为 true）")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (subscribe) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.1.订阅服务信息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfo "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hostReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceInfo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupedName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, groupName),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                                 StringUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"join"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusters, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.2.直接去nacos拉取服务信息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfo "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hostReactor")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceInfoDirectlyFromServer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupedName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, groupName),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                              StringUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"join"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusters, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.从服务信息中获取实例列表并返回")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> list;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (serviceInfo "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CollectionUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(list "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getHosts"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[329]||(a[329]=e("h5",{id:"_4-1-1-2-hostreactor",tabindex:"-1"},[E("4.1.1.2 HostReactor "),e("a",{class:"header-anchor",href:"#_4-1-1-2-hostreactor","aria-label":'Permalink to "4.1.1.2 HostReactor"'},"​")],-1)),a[330]||(a[330]=e("p",null,[E("进入1.1.订阅服务消息，这里是由"),e("code",null,"HostReactor"),E("类的"),e("code",null,"getServiceInfo()"),E("方法来实现的：")],-1)),a[331]||(a[331]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ServiceInfo "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceInfo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String serviceName, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String clusters) {")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NAMING_LOGGER."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"failover-mode: "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," failoverReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFailoverSwitch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 由 服务名@@集群名拼接 key")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ServiceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (failoverReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFailoverSwitch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," failoverReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 读取本地服务列表的缓存，缓存是一个Map，格式：Map<String, ServiceInfo>")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ServiceInfo serviceObj "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getServiceInfo0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断缓存是否存在")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," =="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceObj) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 不存在，创建空ServiceInfo")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceObj "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ServiceInfo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入缓存")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfoMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceObj."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceObj);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入待更新的服务列表（updatingMap）中")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        updatingMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Object"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 立即更新服务列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        updateServiceNow"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 从待更新列表中移除")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        updatingMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (updatingMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 缓存中有，但是需要更新")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (UPDATE_HOLD_INTERVAL "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // hold a moment waiting for update finish 等待5秒中，待更新完成")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            synchronized"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (serviceObj) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    serviceObj."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"wait"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UPDATE_HOLD_INTERVAL);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (InterruptedException "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    NAMING_LOGGER")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[getServiceInfo] serviceName:"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ", clusters:"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clusters, e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 开启定时更新服务列表的功能")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    scheduleUpdateIfAbsent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 返回缓存中的服务信息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfoMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceObj."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[332]||(a[332]=e("p",null,"基本逻辑就是先从本地缓存读，根据结果来选择：",-1)),a[333]||(a[333]=e("ul",null,[e("li",null,[e("p",null,[E("如果本地缓存没有，立即去nacos读取，"),e("code",null,"updateServiceNow(serviceName, clusters)")]),e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923161528710.png",alt:"image-20210923161528710",loading:"lazy",decoding:"async",class:"lazy"})])]),e("li",null,[e("p",null,"如果本地缓存有，则开启定时更新功能，并返回缓存结果："),e("ul",null,[e("li",null,[e("code",null,"scheduleUpdateIfAbsent(serviceName, clusters)")])]),e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923161630575.png",alt:"image-20210923161630575",loading:"lazy",decoding:"async",class:"lazy"})]),e("p",null,"在UpdateTask中，最终还是调用updateService方法："),e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923161752521.png",alt:"image-20210923161752521",loading:"lazy",decoding:"async",class:"lazy"})])])],-1)),a[334]||(a[334]=e("p",null,"不管是立即更新服务列表，还是定时更新服务列表，最终都会执行HostReactor中的updateService()方法：",-1)),a[335]||(a[335]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," updateService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String clusters) throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ServiceInfo oldService "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getServiceInfo0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 基于ServerProxy发起远程调用，查询服务列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String result "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serverProxy."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryList"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters, pushReceiver."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUdpPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotEmpty"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(result)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 处理查询结果")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            processServiceJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(result);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (oldService "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            synchronized"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (oldService) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                oldService."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"notifyAll"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[336]||(a[336]=e("h5",{id:"_4-1-1-3-serverproxy",tabindex:"-1"},[E("4.1.1.3 ServerProxy "),e("a",{class:"header-anchor",href:"#_4-1-1-3-serverproxy","aria-label":'Permalink to "4.1.1.3 ServerProxy"'},"​")],-1)),a[337]||(a[337]=e("p",null,"而ServerProxy的queryList方法如下：",-1)),a[338]||(a[338]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryList"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String clusters, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," udpPort, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," healthyOnly)")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws NacosException {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 准备请求参数")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Map<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> params "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.NAMESPACE_ID, namespaceId);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.SERVICE_NAME, serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clusters"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clusters);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"udpPort"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(udpPort));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clientIP"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", NetUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"localIP"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"healthyOnly"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(healthyOnly));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 发起请求，地址与API接口一致")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," reqApi"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UtilAndComs.nacosUrlBase "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/instance/list"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", params, HttpMethod.GET);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[339]||(a[339]=e("h4",{id:"_4-1-2-处理服务变更通知",tabindex:"-1"},[E("4.1.2 处理服务变更通知 "),e("a",{class:"header-anchor",href:"#_4-1-2-处理服务变更通知","aria-label":'Permalink to "4.1.2 处理服务变更通知"'},"​")],-1)),a[340]||(a[340]=e("p",null,"除了定时更新服务列表的功能外，Nacos还支持服务列表变更时的主动推送功能。",-1)),a[341]||(a[341]=e("p",null,"在HostReactor类的构造函数中，有非常重要的几个步骤：",-1)),a[342]||(a[342]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923164145915.png",alt:"image-20210923164145915",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[343]||(a[343]=e("p",null,"基本思路是：",-1)),a[344]||(a[344]=e("ul",null,[e("li",null,"通过PushReceiver监听服务端推送的变更数据"),e("li",null,"解析数据后，通过NotifyCenter发布服务变更的事件"),e("li",null,"InstanceChangeNotifier监听变更事件，完成对服务列表的更新")],-1)),a[345]||(a[345]=e("h5",{id:"_4-1-2-1-pushreceiver",tabindex:"-1"},[E("4.1.2.1 PushReceiver "),e("a",{class:"header-anchor",href:"#_4-1-2-1-pushreceiver","aria-label":'Permalink to "4.1.2.1 PushReceiver"'},"​")],-1)),a[346]||(a[346]=e("p",null,"我们先看PushReceiver，这个类会以UDP方式接收Nacos服务端推送的服务变更数据。",-1)),a[347]||(a[347]=e("p",null,"先看构造函数：",-1)),a[348]||(a[348]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," PushReceiver"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HostReactor hostReactor) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".hostReactor "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hostReactor;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建 UDP客户端")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String udpPort "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getPushReceiverUdpPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(udpPort)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"            this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".udpSocket "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DatagramSocket"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"            this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".udpSocket "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DatagramSocket"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InetSocketAddress"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Integer."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseInt"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(udpPort)));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 准备线程池")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".executorService "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ScheduledThreadPoolExecutor"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ThreadFactory"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newThread"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Runnable "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"r"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Thread thread "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Thread"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(r);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                thread."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setDaemon"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                thread."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"com.alibaba.nacos.naming.push.receiver"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," thread;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 开启线程任务，准备接收变更数据")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".executorService."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"execute"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NAMING_LOGGER."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NA] init udp socket failed"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[349]||(a[349]=e("p",null,"PushReceiver构造函数中基于线程池来运行任务。这是因为PushReceiver本身也是一个Runnable，其中的run方法业务逻辑如下：",-1)),a[350]||(a[350]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    while"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"closed) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // byte[] is initialized with 0 full filled by default")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            byte"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] buffer "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," byte"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[UDP_MSS];")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            DatagramPacket packet "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DatagramPacket"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(buffer, buffer.length);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 接收推送数据")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            udpSocket."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"receive"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(packet);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 解析为json字符串")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(IoUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tryDecompress"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(packet."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getData"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()), UTF_8)."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"trim"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            NAMING_LOGGER."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"received push data: "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," json "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' " from "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," packet."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAddress"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 反序列化为对象")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            PushPacket pushPacket "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toObj"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json, PushPacket.class);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String ack;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dom"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pushPacket.type) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"||"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "service"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pushPacket.type)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 交给 HostReactor去处理")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                hostReactor."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"processServiceJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pushPacket.data);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // send ack to server 发送ACK回执，略。。")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (closed) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            NAMING_LOGGER."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NA] error while receiving push data"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[351]||(a[351]=e("h5",{id:"_4-1-2-2-hostreactor",tabindex:"-1"},[E("4.1.2.2 HostReactor "),e("a",{class:"header-anchor",href:"#_4-1-2-2-hostreactor","aria-label":'Permalink to "4.1.2.2 HostReactor"'},"​")],-1)),a[352]||(a[352]=e("p",null,[E("通知数据的处理由交给了"),e("code",null,"HostReactor"),E("的"),e("code",null,"processServiceJson"),E("方法：")],-1)),a[353]||(a[353]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ServiceInfo "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"processServiceJson"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String json) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 解析出ServiceInfo信息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ServiceInfo serviceInfo "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toObj"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json, ServiceInfo.class);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String serviceKey "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (serviceKey "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 查询缓存中的 ServiceInfo")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ServiceInfo oldService "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfoMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceKey);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果缓存存在，则需要校验哪些数据要更新")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," changed "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (oldService "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 拉取的数据是否已经过期")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (oldService."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastRefTime"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastRefTime"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            NAMING_LOGGER."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"out of date data received, old-t: "'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," oldService."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastRefTime"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ", new-t: "')]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                               +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastRefTime"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入缓存")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfoMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 中间是缓存与新数据的对比，得到newHosts：新增的实例；remvHosts：待移除的实例;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // modHosts：需要修改的实例")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (newHosts."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," remvHosts."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," modHosts."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 发布实例变更的事件")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            NotifyCenter."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"publishEvent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InstancesChangeEvent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusters"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getHosts"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            DiskCache."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"write"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceInfo, cacheDir);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 本地缓存不存在")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        changed "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入缓存")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfoMap."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 直接发布实例变更的事件")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NotifyCenter."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"publishEvent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InstancesChangeEvent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusters"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getHosts"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfo."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setJsonFromServer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        DiskCache."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"write"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceInfo, cacheDir);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 。。。")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfo;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[354]||(a[354]=e("h3",{id:"_4-2-服务端",tabindex:"-1"},[E("4.2 服务端 "),e("a",{class:"header-anchor",href:"#_4-2-服务端","aria-label":'Permalink to "4.2 服务端"'},"​")],-1)),a[355]||(a[355]=e("h4",{id:"_4-2-1-拉取服务列表接口",tabindex:"-1"},[E("4.2.1 拉取服务列表接口 "),e("a",{class:"header-anchor",href:"#_4-2-1-拉取服务列表接口","aria-label":'Permalink to "4.2.1 拉取服务列表接口"'},"​")],-1)),a[356]||(a[356]=e("p",null,"在2.3.1小节介绍的InstanceController中，提供了拉取服务列表的接口：",-1)),a[357]||(a[357]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * Get all instance of input service.")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," request"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," http request")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," list of instance")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@throws"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Exception"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," any error during list")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/list"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Secured"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"parser"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingResourceParser.class, "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"action"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ActionTypes.READ)")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectNode "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest request) throws Exception {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 从request中获取namespaceId和serviceName")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String namespaceId "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String serviceName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"required"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.SERVICE_NAME);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkServiceNameFormat"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String agent "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUserAgent"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String clusters "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clusters"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String clientIP "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clientIP"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取客户端的 UDP端口")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," udpPort "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseInt"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"udpPort"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"0"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String env "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"env"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isCheck "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseBoolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"isCheck"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"false"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String app "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"app"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String tenant "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"tid"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," healthyOnly "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseBoolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WebUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"healthyOnly"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"false"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取服务列表")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," doSrvIpxt"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, agent, clusters, clientIP, udpPort, env, isCheck, app, tenant,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                     healthyOnly);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[358]||(a[358]=e("p",null,[E("进入"),e("code",null,"doSrvIpxt()"),E("方法来获取服务列表：")],-1)),a[359]||(a[359]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectNode "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"doSrvIpxt"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String namespaceId, String serviceName, String agent,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            String clusters, String clientIP,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                            int"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," udpPort, String env, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isCheck,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            String app, String tid, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," healthyOnly) throws Exception {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ClientInfo clientInfo "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ClientInfo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(agent);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ObjectNode result "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createEmptyJsonNode"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取服务列表信息")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceManager."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cacheMillis "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," switchDomain."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDefaultCacheMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // now try to enable the push")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (udpPort "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pushService."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"canEnablePush"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(agent)) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 添加当前客户端 IP、UDP端口到 PushService 中")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            pushService")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addClient"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, clusters, agent, "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InetSocketAddress"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientIP, udpPort),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                           pushDataSource, tid, app);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            cacheMillis "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," switchDomain."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPushCacheMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.SRV_LOG")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-API] failed to added push client {}, {}:{}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clientInfo, clientIP, udpPort, e);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        cacheMillis "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," switchDomain."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDefaultCacheMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (service "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果没找到，返回空")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.SRV_LOG."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"no instance to serve for service: {}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clusters"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clusters);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cacheMillis"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", cacheMillis);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"replace"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"hosts"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createEmptyArrayNode"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 结果的检测，异常实例的剔除等逻辑省略")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 最终封装结果并返回 。。。")]),E("\n"),e("span",{class:"line"}),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"replace"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"hosts"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", hosts);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clientInfo.type "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ClientInfo.ClientType.JAVA")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        &&"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clientInfo.version."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareTo"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(VersionUtil."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseVersion"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"1.0.0"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dom"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dom"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", NamingUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceName"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceName);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cacheMillis"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", cacheMillis);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lastRefTime"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", System."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"checksum"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getChecksum"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"useSpecifiedURL"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clusters"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clusters);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"env"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", env);")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"replace"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"metadata"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", JacksonUtils."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"transferToJsonNode"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMetadata"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[360]||(a[360]=e("h4",{id:"_4-2-2-发布服务变更的udp通知",tabindex:"-1"},[E("4.2.2 发布服务变更的UDP通知 "),e("a",{class:"header-anchor",href:"#_4-2-2-发布服务变更的udp通知","aria-label":'Permalink to "4.2.2 发布服务变更的UDP通知"'},"​")],-1)),a[361]||(a[361]=e("p",null,[E("在上一节中，"),e("code",null,"InstanceController"),E("中的"),e("code",null,"doSrvIpxt()"),E("方法中，有这样一行代码：")],-1)),a[362]||(a[362]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"pushService."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addClient"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, clusters, agent,")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                      new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InetSocketAddress"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientIP, udpPort),")]),E("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                           pushDataSource, tid, app);")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),a[363]||(a[363]=e("p",null,"其实是把消费者的UDP端口、IP等信息封装为一个PushClient对象，存储PushService中。方便以后服务变更后推送消息。",-1)),a[364]||(a[364]=e("p",null,[E("PushService类本身实现了"),e("code",null,"ApplicationListener"),E("接口：")],-1)),a[365]||(a[365]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923182429636.png",alt:"image-20210923182429636",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[366]||(a[366]=e("p",null,"这个是事件监听器接口，监听的是ServiceChangeEvent（服务变更事件）。",-1)),a[367]||(a[367]=e("p",null,"当服务列表变化时，就会通知我们：",-1)),a[368]||(a[368]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923183017424.png",alt:"image-20210923183017424",loading:"lazy",decoding:"async",class:"lazy"})],-1)),a[369]||(a[369]=e("h3",{id:"_4-3-总结",tabindex:"-1"},[E("4.3 总结 "),e("a",{class:"header-anchor",href:"#_4-3-总结","aria-label":'Permalink to "4.3 总结"'},"​")],-1)),a[370]||(a[370]=e("blockquote",null,[e("p",null,"Nacos的服务发现分为两种模式："),e("ul",null,[e("li",null,"模式一：主动拉取模式，消费者定期主动从Nacos拉取服务列表并缓存起来，再服务调用时优先读取本地缓存中的服务列表。"),e("li",null,"模式二：订阅模式，消费者订阅Nacos中的服务列表，并基于UDP协议来接收服务变更通知。当Nacos中的服务列表更新时，会发送UDP广播给所有订阅者。")]),e("p",null,"与Eureka相比，Nacos的订阅模式服务状态更新更及时，消费者更容易及时发现服务列表的变化，剔除故障服务。")],-1))]),"main-header":t(()=>[k(s.$slots,"main-header")]),"main-header-after":t(()=>[k(s.$slots,"main-header-after")]),"main-nav":t(()=>[k(s.$slots,"main-nav")]),"main-content-before":t(()=>[k(s.$slots,"main-content-before")]),"main-content":t(()=>[k(s.$slots,"main-content")]),"main-content-after":t(()=>[k(s.$slots,"main-content-after")]),"main-nav-before":t(()=>[k(s.$slots,"main-nav-before")]),"main-nav-after":t(()=>[k(s.$slots,"main-nav-after")]),comment:t(()=>[k(s.$slots,"comment")]),footer:t(()=>[k(s.$slots,"footer")]),aside:t(()=>[k(s.$slots,"aside")]),"aside-custom":t(()=>[k(s.$slots,"aside-custom")]),default:t(()=>[k(s.$slots,"default")]),_:3},8,["frontmatter"])}}};export{y as default,d as usePageData};
