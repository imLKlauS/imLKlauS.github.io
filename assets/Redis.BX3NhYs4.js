var y=(e,E,n)=>new Promise((d,p)=>{var r=a=>{try{h(n.next(a))}catch(s){p(s)}},g=a=>{try{h(n.throw(a))}catch(s){p(s)}},h=a=>a.done?d(a.value):Promise.resolve(a.value).then(r,g);h((n=n.apply(e,E)).next())});import{_ as F}from"./ValaxyMain.vue_vue_type_style_index_0_lang.39opEnV_.js";import"./chunks/@vueuse/motion.C0680yyY.js";import{d as D,a as A,u as C}from"./chunks/vue-router.BaQM4Kc2.js";import{a1 as m,a3 as k,a4 as t,a5 as i,a6 as b,a7 as l,W as B,a0 as v,F as f,a2 as S,Z as R}from"./framework.CyQERZzy.js";import"./app.yrEQeKqa.js";import"./chunks/dayjs.BSMtxqtT.js";import"./chunks/vue-i18n.CvwbWgfE.js";import"./chunks/pinia.CyvRWuDa.js";import"./chunks/nprogress.c3ZdlDjC.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.XbFefrGO.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.Du2MZPyS.js";import"./post.C7a2r-qQ.js";const x=D("/posts/Redis",e=>y(null,null,function*(){return JSON.parse('{"title":"Redis 从入门到实战","description":"","frontmatter":{"title":"Redis 从入门到实战","top":100,"author":"imklaus","tags":["Redis"],"categories":["中间件"],"date":"2025-12-4 20:00:10","outline":"deep","excerpt_type":"html","postTitleClass":"text-#9b3841","end":true},"headers":[],"relativePath":"pages/posts/Redis.md","lastUpdated":null}')}),{lazy:(e,E)=>e.name===E.name}),H={__name:"Redis",setup(e,{expose:E}){var h;const{data:n}=x(),d=C(),p=A(),r=Object.assign(p.meta.frontmatter||{},((h=n.value)==null?void 0:h.frontmatter)||{});return d.currentRoute.value.data=n.value,R("valaxy:frontmatter",r),globalThis.$frontmatter=r,E({frontmatter:{title:"Redis 从入门到实战",top:100,author:"imklaus",tags:["Redis"],categories:["中间件"],date:"2025-12-4 20:00:10",outline:"deep",excerpt_type:"html",postTitleClass:"text-#9b3841",end:!0}}),(a,s)=>{const o=v("font"),u=F;return S(),m(u,{frontmatter:f(r)},{"main-content-md":k(()=>[s[2]||(s[2]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251207203742532.png",alt:"image-20251207203742532",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[3]||(s[3]=i("p",null,[l("参考视频："),i("a",{href:"https://www.bilibili.com/video/BV1cr4y1671t",target:"_blank",rel:"noreferrer"},"黑马 Redis 快速入门")],-1)),s[4]||(s[4]=i("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),s[5]||(s[5]=i("p",null,[i("strong",null,"目录指引"),l("：")],-1)),s[6]||(s[6]=i("nav",{class:"table-of-contents"},[i("ul",null,[i("li",null,[i("a",{href:"#redis-快速入门"},"Redis 快速入门"),i("ul",null,[i("li",null,[i("a",{href:"#_1-初识-redis"},"1. 初识 Redis"),i("ul",null,[i("li",null,[i("a",{href:"#_1-1-认识-nosql"},"1.1 认识 NoSQL")]),i("li",null,[i("a",{href:"#_1-2-认识-redis"},"1.2 认识 Redis")]),i("li",null,[i("a",{href:"#_1-3-安装-redis"},"1.3 安装 Redis")]),i("li",null,[i("a",{href:"#_1-4-redis-桌面客户端"},"1.4 Redis 桌面客户端")])])]),i("li",null,[i("a",{href:"#_2-redis-常见命令"},"2. Redis 常见命令"),i("ul",null,[i("li",null,[i("a",{href:"#_2-1-redis-通用命令"},"2.1 Redis 通用命令")]),i("li",null,[i("a",{href:"#_2-2-string-类型"},"2.2 String 类型")]),i("li",null,[i("a",{href:"#_2-3-hash-类型"},"2.3 Hash 类型")]),i("li",null,[i("a",{href:"#_2-4-list-类型"},"2.4 List 类型")]),i("li",null,[i("a",{href:"#_2-5-set-类型"},"2.5 Set 类型")]),i("li",null,[i("a",{href:"#_2-6-sortedset-类型"},"2.6 SortedSet 类型")])])]),i("li",null,[i("a",{href:"#_3-redis-的-java-客户端"},"3. Redis 的 Java 客户端"),i("ul",null,[i("li",null,[i("a",{href:"#_3-1-jedis客户端"},"3.1 Jedis客户端")]),i("li",null,[i("a",{href:"#_3-2-springdataredis-客户端"},"3.2 SpringDataRedis 客户端")])])])])]),i("li",null,[i("a",{href:"#redis-实战篇"},"Redis 实战篇"),i("ul",null,[i("li",null,[i("a",{href:"#_1-短信登录"},"1. 短信登录"),i("ul",null,[i("li",null,[i("a",{href:"#_1-1-导入黑马点评项目"},"1.1 导入黑马点评项目")]),i("li",null,[i("a",{href:"#_1-2-基于-session-实现登录流程"},"1.2 基于 Session 实现登录流程")]),i("li",null,[i("a",{href:"#_1-3-实现发送短信验证码功能"},"1.3 实现发送短信验证码功能")]),i("li",null,[i("a",{href:"#_1-4-实现登录拦截功能"},"1.4 实现登录拦截功能")]),i("li",null,[i("a",{href:"#_1-5-隐藏用户敏感信息"},"1.5 隐藏用户敏感信息")]),i("li",null,[i("a",{href:"#_1-6-session-共享问题"},"1.6 session 共享问题")]),i("li",null,[i("a",{href:"#_1-7-redis-代替-session-的业务流程"},"1.7 Redis 代替 session 的业务流程")]),i("li",null,[i("a",{href:"#_1-8-基于-redis-实现短信登录"},"1.8 基于 Redis 实现短信登录")]),i("li",null,[i("a",{href:"#_1-9-解决状态登录刷新问题"},"1.9 解决状态登录刷新问题")])])]),i("li",null,[i("a",{href:"#_2-商户查询缓存"},"2. 商户查询缓存"),i("ul",null,[i("li",null,[i("a",{href:"#_2-1-什么是缓存"},"2.1 什么是缓存?")]),i("li",null,[i("a",{href:"#_2-2-添加商户缓存"},"2.2 添加商户缓存")]),i("li",null,[i("a",{href:"#_2-3-缓存更新策略"},"2.3 缓存更新策略")]),i("li",null,[i("a",{href:"#_2-4-实现商铺和缓存与数据库双写一致"},"2.4 实现商铺和缓存与数据库双写一致")]),i("li",null,[i("a",{href:"#_2-5-缓存穿透问题的解决思路"},"2.5 缓存穿透问题的解决思路")]),i("li",null,[i("a",{href:"#_2-6-编码解决商品查询的缓存穿透问题"},"2.6 编码解决商品查询的缓存穿透问题：")]),i("li",null,[i("a",{href:"#_2-7-缓存雪崩问题及解决思路"},"2.7 缓存雪崩问题及解决思路")]),i("li",null,[i("a",{href:"#_2-8-缓存击穿问题及解决思路"},"2.8 缓存击穿问题及解决思路")]),i("li",null,[i("a",{href:"#_2-9-利用互斥锁解决缓存击穿问题"},"2.9 利用互斥锁解决缓存击穿问题")]),i("li",null,[i("a",{href:"#_3-0-利用逻辑过期解决缓存击穿问题"},"3.0 利用逻辑过期解决缓存击穿问题")]),i("li",null,[i("a",{href:"#_3-1-封装-redis-工具类"},"3.1 封装 Redis 工具类")])])]),i("li",null,[i("a",{href:"#_3-优惠卷秒杀"},"3. 优惠卷秒杀"),i("ul",null,[i("li",null,[i("a",{href:"#_3-1-全局唯一id"},"3.1 全局唯一ID")]),i("li",null,[i("a",{href:"#_3-2-redis-实现全局唯一id"},"3.2 Redis 实现全局唯一Id")]),i("li",null,[i("a",{href:"#_3-3-添加优惠卷"},"3.3 添加优惠卷")]),i("li",null,[i("a",{href:"#_3-4-实现秒杀下单"},"3.4 实现秒杀下单")]),i("li",null,[i("a",{href:"#_3-5-库存超卖问题分析"},"3.5 库存超卖问题分析")]),i("li",null,[i("a",{href:"#_3-6-乐观锁解决超卖问题"},"3.6 乐观锁解决超卖问题")]),i("li",null,[i("a",{href:"#_3-6-优惠券秒杀-一人一单"},"3.6 优惠券秒杀 - 一人一单")]),i("li",null,[i("a",{href:"#_3-7-集群环境下的并发问题"},"3.7 集群环境下的并发问题")])])]),i("li",null,[i("a",{href:"#_4-分布式锁"},"4. 分布式锁"),i("ul",null,[i("li",null,[i("a",{href:"#_4-1-基本原理和实现方式对比"},"4.1 基本原理和实现方式对比")]),i("li",null,[i("a",{href:"#_4-2-redis-分布式锁的实现核心思路"},"4.2 Redis 分布式锁的实现核心思路")]),i("li",null,[i("a",{href:"#_4-3-实现分布式锁版本一"},"4.3 实现分布式锁版本一")]),i("li",null,[i("a",{href:"#_4-4-redis-分布式锁误删情况说明"},"4.4 Redis 分布式锁误删情况说明")]),i("li",null,[i("a",{href:"#_4-5-解决-redis-分布式锁误删问题"},"4.5 解决 Redis 分布式锁误删问题")]),i("li",null,[i("a",{href:"#_4-6-分布式锁的原子性问题"},"4.6 分布式锁的原子性问题")]),i("li",null,[i("a",{href:"#_4-7-lua-脚本解决多条命令原子性问题"},"4.7 Lua 脚本解决多条命令原子性问题")]),i("li",null,[i("a",{href:"#_4-8-利用-java-代码调用-lua-脚本改造分布式锁"},"4.8 利用 Java 代码调用 Lua 脚本改造分布式锁")])])]),i("li",null,[i("a",{href:"#_5-分布式锁-redission"},"5. 分布式锁 - Redission"),i("ul",null,[i("li",null,[i("a",{href:"#_5-1-分布式锁-redission-功能介绍"},"5.1 分布式锁 - Redission 功能介绍")]),i("li",null,[i("a",{href:"#_5-2-分布式锁-redission-快速入门"},"5.2 分布式锁 - Redission 快速入门")]),i("li",null,[i("a",{href:"#_5-3-分布式锁-redission-可重入锁原理"},"5.3 分布式锁 - Redission 可重入锁原理")]),i("li",null,[i("a",{href:"#_5-4-分布式锁-redission-锁重试和-watchdog-机制"},"5.4 分布式锁 - Redission 锁重试和 WatchDog 机制")]),i("li",null,[i("a",{href:"#_5-5-分布式锁-redission-锁的-mutilock-原理"},"5.5 分布式锁 - Redission 锁的 MutiLock 原理")])])]),i("li",null,[i("a",{href:"#_6-秒杀优化"},"6. 秒杀优化"),i("ul",null,[i("li",null,[i("a",{href:"#_6-1-秒杀优化-异步秒杀思路"},"6.1 秒杀优化 - 异步秒杀思路")]),i("li",null,[i("a",{href:"#_6-2-秒杀优化-redis-完成秒杀资格判断"},"6.2 秒杀优化 - Redis 完成秒杀资格判断")]),i("li",null,[i("a",{href:"#_6-3-秒杀优化-基于阻塞队列实现秒杀优化"},"6.3 秒杀优化 - 基于阻塞队列实现秒杀优化")])])]),i("li",null,[i("a",{href:"#_7-redis-消息队列"},"7. Redis 消息队列"),i("ul",null,[i("li",null,[i("a",{href:"#_7-1-redis-消息队列-认识消息队列"},"7.1 Redis 消息队列 - 认识消息队列")]),i("li",null,[i("a",{href:"#_7-2-redis-消息队列-基于-list-实现消息队列"},"7.2 Redis 消息队列 - 基于 List 实现消息队列")]),i("li",null,[i("a",{href:"#_7-3-redis-消息队列-基于-pubsub-的消息队列"},"7.3 Redis 消息队列 - 基于 PubSub 的消息队列")]),i("li",null,[i("a",{href:"#_7-4-redis-消息队列-基于-stream-的消息队列"},"7.4 Redis 消息队列 - 基于 Stream 的消息队列")]),i("li",null,[i("a",{href:"#_7-5-redis-消息队列-基于-stream-的消息队列-消费者组"},"7.5 Redis 消息队列 - 基于 Stream 的消息队列 - 消费者组")]),i("li",null,[i("a",{href:"#_7-6-基于-redis-的-stream-结构作为消息队列-实现异步秒杀下单"},"7.6 基于 Redis 的 Stream 结构作为消息队列，实现异步秒杀下单")])])]),i("li",null,[i("a",{href:"#_8-达人探店"},"8. 达人探店"),i("ul",null,[i("li",null,[i("a",{href:"#_8-1-达人探店-发布探店笔记"},"8.1 达人探店-发布探店笔记")]),i("li",null,[i("a",{href:"#_8-2-达人探店-查看探店笔记"},"8.2 达人探店 - 查看探店笔记")]),i("li",null,[i("a",{href:"#_8-3-达人探店-点赞功能"},"8.3 达人探店 - 点赞功能")]),i("li",null,[i("a",{href:"#_8-4-达人探店-点赞排行榜"},"8.4 达人探店 - 点赞排行榜")])])]),i("li",null,[i("a",{href:"#_9-好友关注"},"9. 好友关注"),i("ul",null,[i("li",null,[i("a",{href:"#_9-1-好友关注-关注和取消关注"},"9.1 好友关注 - 关注和取消关注")]),i("li",null,[i("a",{href:"#_9-2-好友关注-共同关注"},"9.2 好友关注 - 共同关注")]),i("li",null,[i("a",{href:"#_9-3-好友关注-feed-流实现方案"},"9.3 好友关注 - Feed 流实现方案")]),i("li",null,[i("a",{href:"#_9-4-好友关注-推送到粉丝收件箱"},"9.4 好友关注 - 推送到粉丝收件箱")]),i("li",null,[i("a",{href:"#_9-5-好友关注-实现分页查询收邮箱"},"9.5 好友关注 - 实现分页查询收邮箱")])])]),i("li",null,[i("a",{href:"#_10-附近商户"},"10. 附近商户"),i("ul",null,[i("li",null,[i("a",{href:"#_10-1-附近商户-geo-数据结构的基本用法"},"10.1 附近商户 - GEO 数据结构的基本用法")]),i("li",null,[i("a",{href:"#_10-2-附近商户-导入店铺数据到-geo"},"10.2 附近商户 - 导入店铺数据到 GEO")]),i("li",null,[i("a",{href:"#_10-3-附近商户-实现附近商户功能"},"10.3 附近商户 - 实现附近商户功能")])])]),i("li",null,[i("a",{href:"#_11-用户签到"},"11. 用户签到"),i("ul",null,[i("li",null,[i("a",{href:"#_11-1-用户签到-bitmap-功能演示"},"11.1 用户签到 - BitMap 功能演示")]),i("li",null,[i("a",{href:"#_11-2-用户签到-实现签到功能"},"11.2 用户签到-实现签到功能")]),i("li",null,[i("a",{href:"#_11-3-用户签到-签到统计"},"11.3 用户签到-签到统计")]),i("li",null,[i("a",{href:"#_11-4-额外加餐-关于使用-bitmap-来解决缓存穿透的方案"},"11.4 额外加餐 - 关于使用 bitmap 来解决缓存穿透的方案")])])]),i("li",null,[i("a",{href:"#_12-uv统计"},"12. UV统计"),i("ul",null,[i("li",null,[i("a",{href:"#_12-1-uv-统计-hyperloglog"},"12.1 UV 统计 - HyperLogLog")]),i("li",null,[i("a",{href:"#_12-2-uv-统计-测试百万数据的统计"},"12.2 UV 统计 - 测试百万数据的统计")])])])])]),i("li",null,[i("a",{href:"#redis-原理篇"},"Redis 原理篇"),i("ul",null,[i("li",null,[i("a",{href:"#_1-原理篇-redis-数据结构"},"1. 原理篇 - Redis 数据结构"),i("ul",null,[i("li",null,[i("a",{href:"#_1-1-redis-数据结构-动态字符串"},"1.1 Redis 数据结构 - 动态字符串")]),i("li",null,[i("a",{href:"#_1-2-redis-数据结构-intset"},"1.2 Redis 数据结构 - intset")]),i("li",null,[i("a",{href:"#_1-3-redis-数据结构-dict"},"1.3 Redis 数据结构 - Dict")]),i("li",null,[i("a",{href:"#_1-4-redis-数据结构-ziplist"},"1.4 Redis 数据结构 - ZipList")]),i("li",null,[i("a",{href:"#_1-5-redis-数据结构-ziplist-的连锁更新问题"},"1.5 Redis 数据结构 - ZipList 的连锁更新问题")]),i("li",null,[i("a",{href:"#_1-6-redis-数据结构-quicklist"},"1.6 Redis 数据结构 - QuickList")]),i("li",null,[i("a",{href:"#_1-7-redis-数据结构-redisobject"},"1.7 Redis 数据结构 - RedisObject")]),i("li",null,[i("a",{href:"#_1-8-redis-数据结构-string"},"1.8 Redis 数据结构 - String")]),i("li",null,[i("a",{href:"#_1-9-redis-数据结构-list"},"1.9 Redis 数据结构 - List")]),i("li",null,[i("a",{href:"#_2-0-redis-数据结构-set-结构"},"2.0 Redis 数据结构 - Set 结构")]),i("li",null,[i("a",{href:"#_2-1-redis-数据结构-zset"},"2.1 Redis 数据结构 - ZSET")]),i("li",null,[i("a",{href:"#_2-2-redis-数据结构-hash"},"2.2 Redis 数据结构 - Hash")])])]),i("li",null,[i("a",{href:"#_2-原理篇-redis-网络模型"},"2. 原理篇 - Redis 网络模型"),i("ul",null,[i("li",null,[i("a",{href:"#_2-1-用户空间和内核态空间"},"2.1 用户空间和内核态空间")]),i("li",null,[i("a",{href:"#_2-2-网络模型-阻塞-io"},"2.2 网络模型 - 阻塞 IO")]),i("li",null,[i("a",{href:"#_2-3-网络模型-非阻塞-io"},"2.3 网络模型 - 非阻塞 IO")]),i("li",null,[i("a",{href:"#_2-4-网络模型-io多路复用"},"2.4 网络模型 - IO多路复用")]),i("li",null,[i("a",{href:"#_2-5-网络模型-io-多路复用-select-方式"},"2.5 网络模型 - IO 多路复用 - select 方式")]),i("li",null,[i("a",{href:"#_2-6-网络模型-io-多路复用模型-poll-模式"},"2.6 网络模型 - IO 多路复用模型 - poll 模式")]),i("li",null,[i("a",{href:"#_2-7-网络模型-io-多路复用模型-epoll-函数"},"2.7 网络模型 - IO 多路复用模型 - epoll 函数")]),i("li",null,[i("a",{href:"#_2-8-网络模型-epoll-中的-et-和-lt"},"2.8 网络模型 - epoll 中的 ET 和 LT")]),i("li",null,[i("a",{href:"#_2-9-网络模型-基于-epoll-的服务器端流程"},"2.9 网络模型 - 基于 epoll 的服务器端流程")]),i("li",null,[i("a",{href:"#_3-0-网络模型-信号驱动"},"3.0 网络模型 - 信号驱动")]),i("li",null,[i("a",{href:"#_3-1-网络模型-redis-是单线程的吗-为什么使用单线程"},"3.1 网络模型 - Redis 是单线程的吗？为什么使用单线程")]),i("li",null,[i("a",{href:"#_3-2-redis-的单线程模型-redis-单线程和多线程网络模型变更"},"3.2 Redis 的单线程模型 - Redis 单线程和多线程网络模型变更")])])]),i("li",null,[i("a",{href:"#_3-redis-通信协议-resp-协议"},"3. Redis 通信协议 - RESP 协议"),i("ul",null,[i("li",null,[i("a",{href:"#_3-1-redis-通信协议-基于-socket-自定义-redis-的客户端"},"3.1 Redis 通信协议 - 基于 Socket 自定义 Redis 的客户端")]),i("li",null,[i("a",{href:"#_3-2-redis-内存回收-过期-key-处理"},"3.2 Redis 内存回收 - 过期 key 处理")]),i("li",null,[i("a",{href:"#_3-3-redis-内存回收-内存淘汰策略"},"3.3 Redis 内存回收 - 内存淘汰策略")])])])])]),i("li",null,[i("a",{href:"#redis-高级篇之最佳实践"},"Redis 高级篇之最佳实践"),i("ul",null,[i("li",null,[i("a",{href:"#_1-redis-键值设计"},"1. Redis 键值设计"),i("ul",null,[i("li",null,[i("a",{href:"#_1-1-优雅的-key-结构"},"1.1 优雅的 key 结构")]),i("li",null,[i("a",{href:"#_1-2-拒绝-bigkey"},"1.2 拒绝 BigKey")]),i("li",null,[i("a",{href:"#_1-3-恰当的数据类型"},"1.3 恰当的数据类型")]),i("li",null,[i("a",{href:"#_1-4-总结"},"1.4 总结")])])]),i("li",null,[i("a",{href:"#_2-批处理优化"},"2. 批处理优化"),i("ul",null,[i("li",null,[i("a",{href:"#_2-1-pipeline"},"2.1 Pipeline")]),i("li",null,[i("a",{href:"#_2-2-集群下的批处理"},"2.2 集群下的批处理")])])]),i("li",null,[i("a",{href:"#_3-服务器端优化-持久化配置"},"3. 服务器端优化 - 持久化配置")]),i("li",null,[i("a",{href:"#_4-服务器端优化-慢查询优化"},"4. 服务器端优化 - 慢查询优化"),i("ul",null,[i("li",null,[i("a",{href:"#_4-1-什么是慢查询"},"4.1 什么是慢查询")]),i("li",null,[i("a",{href:"#_4-2-如何查看慢查询"},"4.2 如何查看慢查询")])])]),i("li",null,[i("a",{href:"#_5-服务器端优化-命令及安全配置"},"5. 服务器端优化 - 命令及安全配置")]),i("li",null,[i("a",{href:"#_6-服务器端优化-redis-内存划分和内存配置"},"6. 服务器端优化 - Redis 内存划分和内存配置")]),i("li",null,[i("a",{href:"#_7-服务器端集群优化-集群还是主从"},"7. 服务器端集群优化-集群还是主从")])])]),i("li",null,[i("a",{href:"#分布式缓存"},"分布式缓存"),i("ul",null,[i("li",null,[i("a",{href:"#_1-redis持久化"},"1. Redis持久化"),i("ul",null,[i("li",null,[i("a",{href:"#_1-1-rdb持久化"},"1.1 RDB持久化")]),i("li",null,[i("a",{href:"#_1-2-aof持久化"},"1.2 AOF持久化")]),i("li",null,[i("a",{href:"#_1-3-rdb与aof对比"},"1.3 RDB与AOF对比")])])]),i("li",null,[i("a",{href:"#_2-redis主从"},"2. Redis主从"),i("ul",null,[i("li",null,[i("a",{href:"#_2-1-搭建主从架构"},"2.1 搭建主从架构")]),i("li",null,[i("a",{href:"#_2-2-主从数据同步原理"},"2.2 主从数据同步原理")]),i("li",null,[i("a",{href:"#_2-3-主从同步优化"},"2.3 主从同步优化")]),i("li",null,[i("a",{href:"#_2-4-小结"},"2.4 小结")])])]),i("li",null,[i("a",{href:"#_3-redis哨兵"},"3. Redis哨兵"),i("ul",null,[i("li",null,[i("a",{href:"#_3-1-哨兵原理"},"3.1 哨兵原理")]),i("li",null,[i("a",{href:"#_3-2-搭建哨兵集群"},"3.2 搭建哨兵集群")]),i("li",null,[i("a",{href:"#_3-3-redistemplate"},"3.3 RedisTemplate")])])]),i("li",null,[i("a",{href:"#_4-redis分片集群"},"4. Redis分片集群"),i("ul",null,[i("li",null,[i("a",{href:"#_4-1-搭建分片集群"},"4.1 搭建分片集群")]),i("li",null,[i("a",{href:"#_4-2-散列插槽"},"4.2 散列插槽")]),i("li",null,[i("a",{href:"#_4-3-集群伸缩"},"4.3 集群伸缩")]),i("li",null,[i("a",{href:"#_4-4-故障转移"},"4.4 故障转移")]),i("li",null,[i("a",{href:"#_4-5-redistemplate访问分片集群"},"4.5 RedisTemplate访问分片集群")])])])])])])],-1)),s[7]||(s[7]=i("h2",{id:"redis-快速入门",tabindex:"-1"},[l("Redis 快速入门 "),i("a",{class:"header-anchor",href:"#redis-快速入门","aria-label":'Permalink to "Redis 快速入门"'},"​")],-1)),s[8]||(s[8]=i("p",null,"Redis的常见命令和客户端使用",-1)),s[9]||(s[9]=i("hr",null,null,-1)),s[10]||(s[10]=i("h3",{id:"_1-初识-redis",tabindex:"-1"},[l("1. 初识 Redis "),i("a",{class:"header-anchor",href:"#_1-初识-redis","aria-label":'Permalink to "1. 初识 Redis"'},"​")],-1)),s[11]||(s[11]=i("p",null,"Redis是一种键值型的NoSql数据库，这里有两个关键字：",-1)),s[12]||(s[12]=i("ul",null,[i("li",null,[i("p",null,"键值型")]),i("li",null,[i("p",null,"NoSql")])],-1)),b(" more "),s[13]||(s[13]=i("p",null,[l("其中"),i("strong",null,"键值型"),l("，是指Redis中存储的数据都是以key、value对的形式存储，而value的形式多种多样，可以是字符串、数值、甚至json：")],-1)),s[14]||(s[14]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/6U1Rhxo.png",alt:"image-20220502190959608",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[15]||(s[15]=i("p",null,"而NoSql则是相对于传统关系型数据库而言，有很大差异的一种数据库。",-1)),s[16]||(s[16]=i("hr",null,null,-1)),s[17]||(s[17]=i("h4",{id:"_1-1-认识-nosql",tabindex:"-1"},[l("1.1 认识 NoSQL "),i("a",{class:"header-anchor",href:"#_1-1-认识-nosql","aria-label":'Permalink to "1.1 认识 NoSQL"'},"​")],-1)),s[18]||(s[18]=i("p",null,[i("strong",null,"NoSql"),l("可以翻译做Not Only Sql（不仅仅是SQL），或者是No Sql（非Sql的）数据库。是相对于传统关系型数据库而言，有很大差异的一种特殊的数据库，因此也称之为"),i("strong",null,"非关系型数据库"),l("。")],-1)),s[19]||(s[19]=i("hr",null,null,-1)),s[20]||(s[20]=i("h5",{id:"_1-1-1-结构化与非结构化",tabindex:"-1"},[l("1.1.1 结构化与非结构化 "),i("a",{class:"header-anchor",href:"#_1-1-1-结构化与非结构化","aria-label":'Permalink to "1.1.1 结构化与非结构化"'},"​")],-1)),s[21]||(s[21]=i("p",null,"传统关系型数据库是结构化数据，每一张表都有严格的约束信息：字段名、字段数据类型、字段约束等等信息，插入的数据必须遵守这些约束：",-1)),s[22]||(s[22]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/4tUgFo6.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[23]||(s[23]=i("p",null,"而NoSql则对数据库格式没有严格约束，往往形式松散，自由。",-1)),s[24]||(s[24]=i("p",null,"可以是键值型：",-1)),s[25]||(s[25]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/GdqOSsj.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[26]||(s[26]=i("p",null,"也可以是文档型：",-1)),s[27]||(s[27]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/zBBQfcc.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[28]||(s[28]=i("p",null,"甚至可以是图格式：",-1)),s[29]||(s[29]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/zBnKxWf.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[30]||(s[30]=i("h5",{id:"_1-1-2-关联和非关联",tabindex:"-1"},[l("1.1.2 关联和非关联 "),i("a",{class:"header-anchor",href:"#_1-1-2-关联和非关联","aria-label":'Permalink to "1.1.2 关联和非关联"'},"​")],-1)),s[31]||(s[31]=i("p",null,"传统数据库的表与表之间往往存在关联，例如外键：",-1)),s[32]||(s[32]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/tXYSl5x.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[33]||(s[33]=i("p",null,"而非关系型数据库不存在关联关系，要维护关系要么靠代码中的业务逻辑，要么靠数据之间的耦合：",-1)),s[34]||(s[34]=i("div",{class:"language-json max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"json"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"  id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"  name"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"张三"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"  orders"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": [")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"       id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"       item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"	 id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"title"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"荣耀6"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"price"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"4999")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"       }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    },")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"       id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"       item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"	 id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"title"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"小米11"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"price"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3999")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"       }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  ]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[35]||(s[35]=i("p",null,"此处要维护“张三”的订单与商品“荣耀”和“小米11”的关系，不得不冗余的将这两个商品保存在张三的订单文档中，不够优雅。还是建议用业务来维护关联关系。",-1)),s[36]||(s[36]=i("h5",{id:"_1-1-3-查询方式",tabindex:"-1"},[l("1.1.3 查询方式 "),i("a",{class:"header-anchor",href:"#_1-1-3-查询方式","aria-label":'Permalink to "1.1.3 查询方式"'},"​")],-1)),s[37]||(s[37]=i("p",null,"传统关系型数据库会基于Sql语句做查询，语法有统一标准；",-1)),s[38]||(s[38]=i("p",null,"而不同的非关系数据库查询语法差异极大，五花八门各种各样。",-1)),s[39]||(s[39]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/AzaHOTF.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[40]||(s[40]=i("h5",{id:"_1-1-4-事务",tabindex:"-1"},[l("1.1.4 事务 "),i("a",{class:"header-anchor",href:"#_1-1-4-事务","aria-label":'Permalink to "1.1.4 事务"'},"​")],-1)),s[41]||(s[41]=i("p",null,"传统关系型数据库能满足事务ACID的原则。",-1)),s[42]||(s[42]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/J1MqOJM.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[43]||(s[43]=i("p",null,"而非关系型数据库往往不支持事务，或者不能严格保证ACID的特性，只能实现基本的一致性。",-1)),s[44]||(s[44]=i("h5",{id:"_1-1-5-总结",tabindex:"-1"},[l("1.1.5 总结 "),i("a",{class:"header-anchor",href:"#_1-1-5-总结","aria-label":'Permalink to "1.1.5 总结"'},"​")],-1)),s[45]||(s[45]=i("p",null,"除了上述四点以外，在存储方式、扩展性、查询性能上关系型与非关系型也都有着显著差异，总结如下：",-1)),s[46]||(s[46]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/kZP40dQ.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[47]||(s[47]=i("ul",null,[i("li",null,[l("存储方式 "),i("ul",null,[i("li",null,"关系型数据库基于磁盘进行存储，会有大量的磁盘IO，对性能有一定影响"),i("li",null,"非关系型数据库，他们的操作更多的是依赖于内存来操作，内存的读写速度会非常快，性能自然会好一些")])])],-1)),s[48]||(s[48]=i("ul",null,[i("li",null,[l("扩展性 "),i("ul",null,[i("li",null,"关系型数据库集群模式一般是主从，主从数据一致，起到数据备份的作用，称为垂直扩展。"),i("li",null,"非关系型数据库可以将数据拆分，存储在不同机器上，可以保存海量数据，解决内存大小有限的问题。称为水平扩展。"),i("li",null,"关系型数据库因为表之间存在关联关系，如果做水平扩展会给数据查询带来很多麻烦")])])],-1)),s[49]||(s[49]=i("hr",null,null,-1)),s[50]||(s[50]=i("h4",{id:"_1-2-认识-redis",tabindex:"-1"},[l("1.2 认识 Redis "),i("a",{class:"header-anchor",href:"#_1-2-认识-redis","aria-label":'Permalink to "1.2 认识 Redis"'},"​")],-1)),s[51]||(s[51]=i("p",null,[l("Redis诞生于2009年全称是"),i("strong",null,"Re"),l("mote "),i("strong",null,"D"),l("ictionary "),i("strong",null,"S"),l("erver 远程词典服务器，是一个基于内存的键值型NoSQL数据库。")],-1)),s[52]||(s[52]=i("p",null,[i("strong",null,"特征"),l("：")],-1)),s[53]||(s[53]=i("ul",null,[i("li",null,"键值（key-value）型，value支持多种不同数据结构，功能丰富"),i("li",null,"单线程，每个命令具备原子性"),i("li",null,"低延迟，速度快（基于内存、IO多路复用、良好的编码）。"),i("li",null,"支持数据持久化"),i("li",null,"支持主从集群、分片集群"),i("li",null,"支持多语言客户端")],-1)),s[54]||(s[54]=i("p",null,[i("strong",null,"作者"),l("：Antirez")],-1)),s[55]||(s[55]=i("p",null,[l("Redis的官方网站地址："),i("a",{href:"https://redis.io/",target:"_blank",rel:"noreferrer"},"https://redis.io/")],-1)),s[56]||(s[56]=i("hr",null,null,-1)),s[57]||(s[57]=i("h4",{id:"_1-3-安装-redis",tabindex:"-1"},[l("1.3 安装 Redis "),i("a",{class:"header-anchor",href:"#_1-3-安装-redis","aria-label":'Permalink to "1.3 安装 Redis"'},"​")],-1)),s[58]||(s[58]=i("p",null,"大多数企业都是基于Linux服务器来部署项目，而且Redis官方也没有提供Windows版本的安装包。因此课程中我们会基于Linux系统来安装Redis.",-1)),s[59]||(s[59]=i("p",null,"此处选择的Linux版本为CentOS 7.",-1)),s[60]||(s[60]=i("h5",{id:"_1-3-1-依赖库",tabindex:"-1"},[l("1.3.1 依赖库 "),i("a",{class:"header-anchor",href:"#_1-3-1-依赖库","aria-label":'Permalink to "1.3.1 依赖库"'},"​")],-1)),s[61]||(s[61]=i("p",null,"Redis是基于C语言编写的，因此首先需要安装Redis所需要的gcc依赖：",-1)),s[62]||(s[62]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"yum"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -y"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," gcc"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," tcl")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[63]||(s[63]=i("h5",{id:"_1-3-2-上传安装包并解压",tabindex:"-1"},[l("1.3.2 上传安装包并解压 "),i("a",{class:"header-anchor",href:"#_1-3-2-上传安装包并解压","aria-label":'Permalink to "1.3.2 上传安装包并解压"'},"​")],-1)),s[64]||(s[64]=i("p",null,"然后将课前资料提供的Redis安装包上传到虚拟机的任意目录：",-1)),s[65]||(s[65]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/SyjanS5.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[66]||(s[66]=i("p",null,[l("例如，我放到了"),i("code",null,"/usr/local/src"),l(" 目录：")],-1)),s[67]||(s[67]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/01DTNCf.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[68]||(s[68]=i("p",null,"解压缩：",-1)),s[69]||(s[69]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tar"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -xzf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis-6.2.6.tar.gz")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[70]||(s[70]=i("p",null,"解压后：",-1)),s[71]||(s[71]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/8V6zvCD.png",alt:"image-20211211080339076",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[72]||(s[72]=i("p",null,"进入redis目录：",-1)),s[73]||(s[73]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis-6.2.6")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[74]||(s[74]=i("p",null,"运行编译命令：",-1)),s[75]||(s[75]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"make"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," && "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"make"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[76]||(s[76]=i("p",null,"如果没有出错，应该就安装成功了。",-1)),s[77]||(s[77]=i("p",null,[l("默认的安装路径是在 "),i("code",null,"/usr/local/bin"),l("目录下：")],-1)),s[78]||(s[78]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251204153339523.png",alt:"image-20251204153339523",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[79]||(s[79]=i("p",null,"该目录已经默认配置到环境变量，因此可以在任意目录下运行这些命令。其中：",-1)),s[80]||(s[80]=i("ul",null,[i("li",null,"redis-cli：是redis提供的命令行客户端"),i("li",null,"redis-server：是redis的服务端启动脚本"),i("li",null,"redis-sentinel：是redis的哨兵启动脚本")],-1)),s[81]||(s[81]=i("h5",{id:"_1-3-3-启动",tabindex:"-1"},[l("1.3.3 启动 "),i("a",{class:"header-anchor",href:"#_1-3-3-启动","aria-label":'Permalink to "1.3.3 启动"'},"​")],-1)),s[82]||(s[82]=i("p",null,"redis的启动方式有很多种，例如：",-1)),s[83]||(s[83]=i("ul",null,[i("li",null,"默认启动"),i("li",null,"指定配置启动"),i("li",null,"开机自启")],-1)),s[84]||(s[84]=i("h5",{id:"_1-3-4-默认启动",tabindex:"-1"},[l("1.3.4 默认启动 "),i("a",{class:"header-anchor",href:"#_1-3-4-默认启动","aria-label":'Permalink to "1.3.4 默认启动"'},"​")],-1)),s[85]||(s[85]=i("p",null,"安装完成后，在任意目录输入redis-server命令即可启动Redis：",-1)),s[86]||(s[86]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-server")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[87]||(s[87]=i("p",null,"如图：",-1)),s[88]||(s[88]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/v7xWsqC.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[89]||(s[89]=i("p",null,[l("这种启动属于"),i("code",null,"前台启动"),l("，会阻塞整个会话窗口，窗口关闭或者按下"),i("code",null,"CTRL + C"),l("则Redis停止。不推荐使用。")],-1)),s[90]||(s[90]=i("h5",{id:"_1-3-5-指定配置启动",tabindex:"-1"},[l("1.3.5 指定配置启动 "),i("a",{class:"header-anchor",href:"#_1-3-5-指定配置启动","aria-label":'Permalink to "1.3.5 指定配置启动"'},"​")],-1)),s[91]||(s[91]=i("p",null,[l("如果要让Redis以"),i("code",null,"后台"),l("方式启动，则必须修改Redis配置文件，就在我们之前解压的redis安装包下（"),i("code",null,"/usr/local/src/redis-6.2.6"),l("），名字叫redis.conf：")],-1)),s[92]||(s[92]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20211211082225509.png",alt:"image-20211211082225509",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[93]||(s[93]=i("p",null,"我们先将这个配置文件备份一份：",-1)),s[94]||(s[94]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis.conf.bck")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[95]||(s[95]=i("p",null,"然后修改redis.conf文件中的一些配置：",-1)),s[96]||(s[96]=i("div",{class:"language-properties max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"properties"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 允许访问的地址，默认是127.0.0.1，会导致只能在本地访问。修改为0.0.0.0则可以在任意IP访问，生产环境不要设置为0.0.0.0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"bind 0.0.0.0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 守护进程，修改为yes后即可后台运行")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"daemonize yes ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 密码，设置后访问Redis必须输入密码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"requirepass 123321")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[97]||(s[97]=i("p",null,"Redis的其它常见配置：",-1)),s[98]||(s[98]=i("div",{class:"language-properties max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"properties"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 监听的端口")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"port 6379")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 工作目录，默认是当前目录，也就是运行redis-server时的命令，日志、持久化等文件会保存在这个目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dir .")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 数据库数量，设置为1，代表只使用1个库，默认有16个库，编号0~15")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"databases 1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 设置redis能够使用的最大内存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"maxmemory 512mb")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 日志文件，默认为空，不记录日志，可以指定日志文件名")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"logfile "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis.log"')])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[99]||(s[99]=i("p",null,"启动Redis：",-1)),s[100]||(s[100]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 进入redis安装目录 ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /usr/local/src/redis-6.2.6")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 启动")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-server"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[101]||(s[101]=i("p",null,"停止服务：",-1)),s[102]||(s[102]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 利用redis-cli来执行 shutdown 命令，即可停止 Redis 服务，")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 因为之前配置了密码，因此需要通过 -u 来指定密码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 123321"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," shutdown")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[103]||(s[103]=i("h5",{id:"_1-3-6-开机自启",tabindex:"-1"},[l("1.3.6 开机自启 "),i("a",{class:"header-anchor",href:"#_1-3-6-开机自启","aria-label":'Permalink to "1.3.6 开机自启"'},"​")],-1)),s[104]||(s[104]=i("p",null,"我们也可以通过配置来实现开机自启。",-1)),s[105]||(s[105]=i("p",null,"首先，新建一个系统服务文件：",-1)),s[106]||(s[106]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vi"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/systemd/system/redis.service")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[107]||(s[107]=i("p",null,"内容如下：",-1)),s[108]||(s[108]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[Unit]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Description"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"redis-server")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"After"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"network.target")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[Service]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Type"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"forking")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ExecStart"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/usr/local/bin/redis-server"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," /usr/local/src/redis-6.2.6/redis.conf")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"PrivateTmp"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"true")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[Install]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"WantedBy"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"multi-user.target")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[109]||(s[109]=i("p",null,"然后重载系统服务：",-1)),s[110]||(s[110]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," daemon-reload")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[111]||(s[111]=i("p",null,"现在，我们可以用下面这组命令来操作redis了：",-1)),s[112]||(s[112]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 启动")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," start"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 停止")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 重启")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," restart"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 查看状态")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," status"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[113]||(s[113]=i("p",null,"执行下面的命令，可以让redis开机自启：",-1)),s[114]||(s[114]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"systemctl"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," enable"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[115]||(s[115]=i("hr",null,null,-1)),s[116]||(s[116]=i("h4",{id:"_1-4-redis-桌面客户端",tabindex:"-1"},[l("1.4 Redis 桌面客户端 "),i("a",{class:"header-anchor",href:"#_1-4-redis-桌面客户端","aria-label":'Permalink to "1.4 Redis 桌面客户端"'},"​")],-1)),s[117]||(s[117]=i("p",null,"安装完成Redis，我们就可以操作Redis，实现数据的CRUD了。这需要用到Redis客户端，包括：",-1)),s[118]||(s[118]=i("ul",null,[i("li",null,"命令行客户端"),i("li",null,"图形化桌面客户端"),i("li",null,"编程客户端")],-1)),s[119]||(s[119]=i("h5",{id:"_1-4-1-redis-命令行客户端",tabindex:"-1"},[l("1.4.1 Redis 命令行客户端 "),i("a",{class:"header-anchor",href:"#_1-4-1-redis-命令行客户端","aria-label":'Permalink to "1.4.1 Redis 命令行客户端"'},"​")],-1)),s[120]||(s[120]=i("p",null,"Redis安装完成后就自带了命令行客户端：redis-cli，使用方式如下：",-1)),s[121]||(s[121]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," [options] [commonds]")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[122]||(s[122]=i("p",null,"其中常见的options有：",-1)),s[123]||(s[123]=i("ul",null,[i("li",null,[i("code",null,"-h 127.0.0.1"),l("：指定要连接的redis节点的IP地址，默认是127.0.0.1")]),i("li",null,[i("code",null,"-p 6379"),l("：指定要连接的redis节点的端口，默认是6379")]),i("li",null,[i("code",null,"-a 123321"),l("：指定redis的访问密码")])],-1)),s[124]||(s[124]=i("p",null,"其中的commonds就是Redis的操作命令，例如：",-1)),s[125]||(s[125]=i("ul",null,[i("li",null,[i("code",null,"ping"),l("：与redis服务端做心跳测试，服务端正常会返回"),i("code",null,"pong")])],-1)),s[126]||(s[126]=i("p",null,[l("不指定commond时，会进入"),i("code",null,"redis-cli"),l("的交互控制台：")],-1)),s[127]||(s[127]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/OYYWPNo.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[128]||(s[128]=i("h5",{id:"_1-4-2-图形化桌面客户端",tabindex:"-1"},[l("1.4.2 图形化桌面客户端 "),i("a",{class:"header-anchor",href:"#_1-4-2-图形化桌面客户端","aria-label":'Permalink to "1.4.2 图形化桌面客户端"'},"​")],-1)),s[129]||(s[129]=i("p",null,[l("GitHub上的大神编写了Redis的图形化桌面客户端，地址："),i("a",{href:"https://github.com/uglide/RedisDesktopManager",target:"_blank",rel:"noreferrer"},"https://github.com/uglide/RedisDesktopManager")],-1)),s[130]||(s[130]=i("p",null,"不过该仓库提供的是RedisDesktopManager的源码，并未提供windows安装包。",-1)),s[131]||(s[131]=i("p",null,[l("在下面这个仓库可以找到安装包："),i("a",{href:"https://github.com/lework/RedisDesktopManager-Windows/releases",target:"_blank",rel:"noreferrer"},"https://github.com/lework/RedisDesktopManager-Windows/releases")],-1)),s[132]||(s[132]=i("h5",{id:"_1-4-3-安装",tabindex:"-1"},[l("1.4.3 安装 "),i("a",{class:"header-anchor",href:"#_1-4-3-安装","aria-label":'Permalink to "1.4.3 安装"'},"​")],-1)),s[133]||(s[133]=i("p",null,"在课前资料中可以找到Redis的图形化桌面客户端：",-1)),s[134]||(s[134]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/BZ4Agbi.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[135]||(s[135]=i("p",null,"解压缩后，运行安装程序即可安装：",-1)),s[136]||(s[136]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/hguGHbX.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[137]||(s[137]=i("p",null,"安装完成后，在安装目录下找到rdm.exe文件：",-1)),s[138]||(s[138]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/hwK5LQ8.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[139]||(s[139]=i("p",null,"双击即可运行：",-1)),s[140]||(s[140]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/6hUqslY.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[141]||(s[141]=i("h5",{id:"_1-4-4-建立连接",tabindex:"-1"},[l("1.4.4 建立连接 "),i("a",{class:"header-anchor",href:"#_1-4-4-建立连接","aria-label":'Permalink to "1.4.4 建立连接"'},"​")],-1)),s[142]||(s[142]=i("p",null,[l("点击左上角的"),i("code",null,"连接到Redis服务器"),l("按钮：")],-1)),s[143]||(s[143]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/9qTGyoN.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[144]||(s[144]=i("p",null,"在弹出的窗口中填写Redis服务信息：",-1)),s[145]||(s[145]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/DshNnKC.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[146]||(s[146]=i("p",null,"点击确定后，在左侧菜单会出现这个链接：",-1)),s[147]||(s[147]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/A2cOm7Q.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[148]||(s[148]=i("p",null,"点击即可建立连接了。",-1)),s[149]||(s[149]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/ja8Fd9s.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[150]||(s[150]=i("p",null,"Redis默认有16个仓库，编号从0至15. 通过配置文件可以设置仓库数量，但是不超过16，并且不能自定义仓库名称。",-1)),s[151]||(s[151]=i("p",null,"如果是基于redis-cli连接Redis服务，可以通过select命令来选择数据库：",-1)),s[152]||(s[152]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 选择 0号库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"select"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 0")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[153]||(s[153]=i("hr",null,null,-1)),s[154]||(s[154]=i("h3",{id:"_2-redis-常见命令",tabindex:"-1"},[l("2. Redis 常见命令 "),i("a",{class:"header-anchor",href:"#_2-redis-常见命令","aria-label":'Permalink to "2. Redis 常见命令"'},"​")],-1)),s[155]||(s[155]=i("p",null,"Redis是典型的key-value数据库，key一般是字符串，而value包含很多不同的数据类型：",-1)),s[156]||(s[156]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/8tli2o9.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[157]||(s[157]=i("p",null,[l("Redis为了方便我们学习，将操作不同数据类型的命令也做了分组，在官网（ "),i("a",{href:"https://redis.io/commands",target:"_blank",rel:"noreferrer"},"https://redis.io/commands "),l("）可以查看到不同的命令：")],-1)),s[158]||(s[158]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/5Lcr3BE.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[159]||(s[159]=i("p",null,"不同类型的命令称为一个group，我们也可以通过help命令来查看各种不同group的命令：",-1)),s[160]||(s[160]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/suevOIR.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[161]||(s[161]=i("p",null,"接下来，我们就学习常见的五种基本数据类型的相关命令。",-1)),s[162]||(s[162]=i("h4",{id:"_2-1-redis-通用命令",tabindex:"-1"},[l("2.1 Redis 通用命令 "),i("a",{class:"header-anchor",href:"#_2-1-redis-通用命令","aria-label":'Permalink to "2.1 Redis 通用命令"'},"​")],-1)),s[163]||(s[163]=i("p",null,"通用指令是部分数据类型的，都可以使用的指令，常见的有：",-1)),s[164]||(s[164]=i("ul",null,[i("li",null,"KEYS：查看符合模板的所有key"),i("li",null,"DEL：删除一个指定的key"),i("li",null,"EXISTS：判断key是否存在"),i("li",null,"EXPIRE：给一个key设置有效期，有效期到期时该key会被自动删除"),i("li",null,"TTL：查看一个KEY的剩余有效期")],-1)),s[165]||(s[165]=i("p",null,[l("通过"),i("code",null,"help [command]"),l(" 可以查看一个命令的具体用法，例如：")],-1)),s[166]||(s[166]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 查看keys命令的帮助信息：")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"127.0.0.1:6379"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"help"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," keys")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"KEYS"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," pattern")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"summary:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Find"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," all"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," keys"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," matching"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," the"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," given"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," pattern")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"since:"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1.0.0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"group:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," generic")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[167]||(s[167]=i("h4",{id:"_2-2-string-类型",tabindex:"-1"},[l("2.2 String 类型 "),i("a",{class:"header-anchor",href:"#_2-2-string-类型","aria-label":'Permalink to "2.2 String 类型"'},"​")],-1)),s[168]||(s[168]=i("p",null,"String类型，也就是字符串类型，是Redis中最简单的存储类型。",-1)),s[169]||(s[169]=i("p",null,"其value是字符串，不过根据字符串的格式不同，又可以分为3类：",-1)),s[170]||(s[170]=i("ul",null,[i("li",null,"string：普通字符串"),i("li",null,"int：整数类型，可以做自增、自减操作"),i("li",null,"float：浮点类型，可以做自增、自减操作")],-1)),s[171]||(s[171]=i("p",null,"不管是哪种格式，底层都是字节数组形式存储，只不过是编码方式不同。字符串类型的最大空间不能超过512m.",-1)),s[172]||(s[172]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/VZqpv73.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[173]||(s[173]=i("h5",{id:"_2-2-1-string-的常见命令",tabindex:"-1"},[l("2.2.1 String 的常见命令 "),i("a",{class:"header-anchor",href:"#_2-2-1-string-的常见命令","aria-label":'Permalink to "2.2.1 String 的常见命令"'},"​")],-1)),s[174]||(s[174]=i("p",null,"String的常见命令有：",-1)),s[175]||(s[175]=i("ul",null,[i("li",null,"SET：添加或者修改已经存在的一个String类型的键值对"),i("li",null,"GET：根据key获取String类型的value"),i("li",null,"MSET：批量添加多个String类型的键值对"),i("li",null,"MGET：根据多个key获取多个String类型的value"),i("li",null,"INCR：让一个整型的key自增1"),i("li",null,"INCRBY:让一个整型的key自增并指定步长，例如：incrby num 2 让num值自增2"),i("li",null,"INCRBYFLOAT：让一个浮点类型的数字自增并指定步长"),i("li",null,"SETNX：添加一个String类型的键值对，前提是这个key不存在，否则不执行"),i("li",null,"SETEX：添加一个String类型的键值对，并且指定有效期")],-1)),s[176]||(s[176]=i("h5",{id:"_2-2-2-key-结构",tabindex:"-1"},[l("2.2.2 Key 结构 "),i("a",{class:"header-anchor",href:"#_2-2-2-key-结构","aria-label":'Permalink to "2.2.2 Key 结构"'},"​")],-1)),s[177]||(s[177]=i("p",null,"Redis没有类似MySQL中的Table的概念，我们该如何区分不同类型的key呢？",-1)),s[178]||(s[178]=i("p",null,"例如，需要存储用户、商品信息到redis，有一个用户id是1，有一个商品id恰好也是1，此时如果使用id作为key，那就会冲突了，该怎么办？",-1)),s[179]||(s[179]=i("p",null,"我们可以通过给key添加前缀加以区分，不过这个前缀不是随便加的，有一定的规范：",-1)),s[180]||(s[180]=i("p",null,"Redis的key允许有多个单词形成层级结构，多个单词之间用’:'隔开，格式如下：",-1)),s[181]||(s[181]=i("div",{class:"language-tcl max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"tcl"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	项目名:业务名:类型:id")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[182]||(s[182]=i("p",null,"这个格式并非固定，也可以根据自己的需求来删除或添加词条。这样以来，我们就可以把不同类型的数据区分开了。从而避免了key的冲突问题。",-1)),s[183]||(s[183]=i("p",null,"例如我们的项目名称叫 heima，有user和product两种不同类型的数据，我们可以这样定义key：",-1)),s[184]||(s[184]=i("ul",null,[i("li",null,[i("p",null,[l("user相关的key："),i("strong",null,"heima:user:1")])]),i("li",null,[i("p",null,[l("product相关的key："),i("strong",null,"heima:product:1")])])],-1)),s[185]||(s[185]=i("p",null,"如果Value是一个Java对象，例如一个User对象，则可以将对象序列化为JSON字符串后存储：",-1)),s[186]||(s[186]=i("table",null,[i("thead",null,[i("tr",null,[i("th",null,[i("strong",null,"KEY")]),i("th",null,[i("strong",null,"VALUE")])])]),i("tbody",null,[i("tr",null,[i("td",null,[i("code",null,"heima:user:1")]),i("td",null,[i("code",null,'{"id":1, "name": "Jack", "age": 21}')])]),i("tr",null,[i("td",null,[i("code",null,"heima:product:1")]),i("td",null,[i("code",null,'{"id":1, "name": "小米11", "price": 4999}')])])])],-1)),s[187]||(s[187]=i("p",null,"并且，在Redis的桌面客户端中，还会以相同前缀作为层级结构，让数据看起来层次分明，关系清晰：",-1)),s[188]||(s[188]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/InWMfeD.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[189]||(s[189]=i("h4",{id:"_2-3-hash-类型",tabindex:"-1"},[l("2.3 Hash 类型 "),i("a",{class:"header-anchor",href:"#_2-3-hash-类型","aria-label":'Permalink to "2.3 Hash 类型"'},"​")],-1)),s[190]||(s[190]=i("p",null,"Hash类型，也叫散列，其value是一个无序字典，类似于Java中的HashMap结构。",-1)),s[191]||(s[191]=i("p",null,"String结构是将对象序列化为JSON字符串后存储，当需要修改对象某个字段时很不方便：",-1)),s[192]||(s[192]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/x2zDBjf.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[193]||(s[193]=i("p",null,"Hash结构可以将对象中的每个字段独立存储，可以针对单个字段做CRUD：",-1)),s[194]||(s[194]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/VF2EPt0.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[195]||(s[195]=i("p",null,"Hash的常见命令有：",-1)),s[196]||(s[196]=i("ul",null,[i("li",null,[i("p",null,"HSET key field value：添加或者修改hash类型key的field的值")]),i("li",null,[i("p",null,"HGET key field：获取一个hash类型key的field的值")]),i("li",null,[i("p",null,"HMSET：批量添加多个hash类型key的field的值")]),i("li",null,[i("p",null,"HMGET：批量获取多个hash类型key的field的值")]),i("li",null,[i("p",null,"HGETALL：获取一个hash类型的key中的所有的field和value")]),i("li",null,[i("p",null,"HKEYS：获取一个hash类型的key中的所有的field")]),i("li",null,[i("p",null,"HINCRBY:让一个hash类型key的字段值自增并指定步长")]),i("li",null,[i("p",null,"HSETNX：添加一个hash类型的key的field值，前提是这个field不存在，否则不执行")])],-1)),s[197]||(s[197]=i("p",null,[i("code",null,"HSET klaus:user:3 name Lucy")],-1)),s[198]||(s[198]=i("p",null,[i("code",null,"HSET klaus:user:3 age 23")],-1)),s[199]||(s[199]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505013039825.png",alt:"image-20230505013039825",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[200]||(s[200]=i("h4",{id:"_2-4-list-类型",tabindex:"-1"},[l("2.4 List 类型 "),i("a",{class:"header-anchor",href:"#_2-4-list-类型","aria-label":'Permalink to "2.4 List 类型"'},"​")],-1)),s[201]||(s[201]=i("p",null,"Redis中的List类型与Java中的LinkedList类似，可以看做是一个双向链表结构。既可以支持正向检索和也可以支持反向检索。",-1)),s[202]||(s[202]=i("p",null,"特征也与LinkedList类似：",-1)),s[203]||(s[203]=i("ul",null,[i("li",null,"有序"),i("li",null,"元素可以重复"),i("li",null,"插入和删除快"),i("li",null,"查询速度一般")],-1)),s[204]||(s[204]=i("p",null,"常用来存储一个有序数据，例如：朋友圈点赞列表，评论列表等。",-1)),s[205]||(s[205]=i("p",null,"List的常见命令有：",-1)),s[206]||(s[206]=i("ul",null,[i("li",null,[i("code",null,"LPUSH key element ..."),l(" ：向列表左侧插入一个或多个元素")]),i("li",null,"LPOP key：移除并返回列表左侧的第一个元素，没有则返回nil"),i("li",null,[i("code",null,"RPUSH key element ..."),l(" ：向列表右侧插入一个或多个元素")]),i("li",null,"RPOP key：移除并返回列表右侧的第一个元素"),i("li",null,[i("code",null,"LRANGE key star end"),l("：返回一段角标范围内的所有元素")])],-1)),s[207]||(s[207]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505013249460.png",alt:"image-20230505013249460",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[208]||(s[208]=i("ul",null,[i("li",null,"BLPOP和BRPOP：与LPOP和RPOP类似，只不过在没有元素时等待指定时间，而不是直接返回nil")],-1)),s[209]||(s[209]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505013146760.png",alt:"image-20230505013146760",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[210]||(s[210]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505013214995.png",alt:"image-20230505013214995",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[211]||(s[211]=i("h4",{id:"_2-5-set-类型",tabindex:"-1"},[l("2.5 Set 类型 "),i("a",{class:"header-anchor",href:"#_2-5-set-类型","aria-label":'Permalink to "2.5 Set 类型"'},"​")],-1)),s[212]||(s[212]=i("p",null,"Redis的Set结构与Java中的HashSet类似，可以看做是一个value为null的HashMap。因为也是一个hash表，因此具备与HashSet类似的特征：",-1)),s[213]||(s[213]=i("ul",null,[i("li",null,[i("p",null,"无序")]),i("li",null,[i("p",null,"元素不可重复")]),i("li",null,[i("p",null,"查找快")]),i("li",null,[i("p",null,"支持交集、并集、差集等功能")])],-1)),s[214]||(s[214]=i("p",null,"Set的常见命令有：",-1)),s[215]||(s[215]=i("ul",null,[i("li",null,[i("code",null,"SADD key member ..."),l(" ：向set中添加一个或多个元素")]),i("li",null,[i("code",null,"SREM key member ..."),l(" : 移除set中的指定元素")]),i("li",null,"SCARD key： 返回set中元素的个数"),i("li",null,[i("code",null,"SISMEMBER key member"),l("：判断一个元素是否存在于set中")]),i("li",null,"SMEMBERS：获取set中的所有元素"),i("li",null,[i("code",null,"SINTER key1 key2 ..."),l(" ：求key1与key2的交集")]),i("li",null,[i("code",null,"SDIFF key1 key2 ..."),l(" ：求key1与key2的差集")]),i("li",null,[i("code",null,"SUNION key1 key2 ..."),l(" ：求key1与key2的并集")])],-1)),s[216]||(s[216]=i("p",null,"例如两个集合：s1和s2:",-1)),s[217]||(s[217]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/ha8x86R.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[218]||(s[218]=i("p",null,[l("求交集："),i("code",null,"SINTER s1 s2")],-1)),s[219]||(s[219]=i("p",null,[l("求s1与s2的不同："),i("code",null,"SDIFF s1 s2")],-1)),s[220]||(s[220]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/L9vTv2X.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[221]||(s[221]=i("p",null,"练习：",-1)),s[222]||(s[222]=i("ol",null,[i("li",null,"将下列数据用Redis的Set集合来存储：")],-1)),s[223]||(s[223]=i("ul",null,[i("li",null,"张三的好友有：李四、王五、赵六"),i("li",null,"李四的好友有：王五、麻子、二狗")],-1)),s[224]||(s[224]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505011809735.png",alt:"image-20230505011809735",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[225]||(s[225]=i("ol",{start:"2"},[i("li",null,"利用Set的命令实现下列功能：")],-1)),s[226]||(s[226]=i("ul",null,[i("li",null,"计算张三的好友有几人")],-1)),s[227]||(s[227]=i("p",null,"SCARD zs",-1)),s[228]||(s[228]=i("ul",null,[i("li",null,"计算张三和李四有哪些共同好友")],-1)),s[229]||(s[229]=i("p",null,"SINTER zs ls",-1)),s[230]||(s[230]=i("ul",null,[i("li",null,"查询哪些人是张三的好友却不是李四的好友")],-1)),s[231]||(s[231]=i("p",null,"SDIFF zs ls",-1)),s[232]||(s[232]=i("ul",null,[i("li",null,"查询张三和李四的好友总共有哪些人")],-1)),s[233]||(s[233]=i("p",null,"SUNION zs ls",-1)),s[234]||(s[234]=i("ul",null,[i("li",null,"判断李四是否是张三的好友")],-1)),s[235]||(s[235]=i("p",null,"SISMEMBER zs lisi",-1)),s[236]||(s[236]=i("ul",null,[i("li",null,"判断张三是否是李四的好友")],-1)),s[237]||(s[237]=i("p",null,"SISMEMBER ls zhangsan",-1)),s[238]||(s[238]=i("ul",null,[i("li",null,"将李四从张三的好友列表中移除")],-1)),s[239]||(s[239]=i("p",null,"SREM zs lisi",-1)),s[240]||(s[240]=i("h4",{id:"_2-6-sortedset-类型",tabindex:"-1"},[l("2.6 SortedSet 类型 "),i("a",{class:"header-anchor",href:"#_2-6-sortedset-类型","aria-label":'Permalink to "2.6 SortedSet 类型"'},"​")],-1)),s[241]||(s[241]=i("p",null,"Redis的SortedSet是一个可排序的set集合，与Java中的TreeSet有些类似，但底层数据结构却差别很大。SortedSet中的每一个元素都带有一个score属性，可以基于score属性对元素排序，底层的实现是一个跳表（SkipList）加 hash表。",-1)),s[242]||(s[242]=i("p",null,"SortedSet具备下列特性：",-1)),s[243]||(s[243]=i("ul",null,[i("li",null,"可排序"),i("li",null,"元素不重复"),i("li",null,"查询速度快")],-1)),s[244]||(s[244]=i("p",null,"因为SortedSet的可排序特性，经常被用来实现排行榜这样的功能。",-1)),s[245]||(s[245]=i("p",null,"SortedSet的常见命令有：",-1)),s[246]||(s[246]=i("ul",null,[i("li",null,"ZADD key score member：添加一个或多个元素到sorted set ，如果已经存在则更新其score值"),i("li",null,"ZREM key member：删除sorted set中的一个指定元素"),i("li",null,"ZSCORE key member : 获取sorted set中的指定元素的score值"),i("li",null,"ZRANK key member：获取sorted set 中的指定元素的排名"),i("li",null,"ZCARD key：获取sorted set中的元素个数"),i("li",null,"ZCOUNT key min max：统计score值在给定范围内的所有元素的个数"),i("li",null,"ZINCRBY key increment member：让sorted set中的指定元素自增，步长为指定的increment值"),i("li",null,"ZRANGE key min max：按照score排序后，获取指定排名范围内的元素"),i("li",null,"ZRANGEBYSCORE key min max：按照score排序后，获取指定score范围内的元素"),i("li",null,"ZDIFF、ZINTER、ZUNION：求差集、交集、并集")],-1)),s[247]||(s[247]=i("p",null,"注意：所有的排名默认都是升序，如果要降序则在命令的Z后面添加REV即可，例如：",-1)),s[248]||(s[248]=i("ul",null,[i("li",null,[i("p",null,[i("strong",null,"升序"),l("获取sorted set 中的指定元素的排名：ZRANK key member")])]),i("li",null,[i("p",null,[i("strong",null,"降序"),l("获取sorted set 中的指定元素的排名：ZREVRANK key memeber")])])],-1)),s[249]||(s[249]=i("p",null,"练习题：",-1)),s[250]||(s[250]=i("p",null,"将班级的下列学生得分存入Redis的SortedSet中：",-1)),s[251]||(s[251]=i("p",null,"Jack 85, Lucy 89, Rose 82, Tom 95, Jerry 78, Amy 92, Miles 76",-1)),s[252]||(s[252]=i("div",{class:"language-shell max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"shell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ZADD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stus"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 85"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Jack"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 89"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Lucy"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 82"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Rose"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 95"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Tom"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 78"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Jerry"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 92"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Amy"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 76"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Miles")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[253]||(s[253]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505010557819.png",alt:"image-20230505010557819",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[254]||(s[254]=i("p",null,"并实现下列功能：",-1)),s[255]||(s[255]=i("ul",null,[i("li",null,"删除Tom同学")],-1)),s[256]||(s[256]=i("p",null,"ZREM stus Tom",-1)),s[257]||(s[257]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505010832672.png",alt:"image-20230505010832672",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[258]||(s[258]=i("ul",null,[i("li",null,"获取Amy同学的分数")],-1)),s[259]||(s[259]=i("p",null,"ZSCORE stus Amy",-1)),s[260]||(s[260]=i("ul",null,[i("li",null,"获取Rose同学的排名")],-1)),s[261]||(s[261]=i("p",null,"ZRANK stus Rose",-1)),s[262]||(s[262]=i("p",null,"ZREVRANK stus Rose",-1)),s[263]||(s[263]=i("ul",null,[i("li",null,"查询80分以下有几个学生")],-1)),s[264]||(s[264]=i("p",null,"ZCOUNT stus 0 80",-1)),s[265]||(s[265]=i("ul",null,[i("li",null,"给Amy同学加2分")],-1)),s[266]||(s[266]=i("p",null,"ZINCRBY stus 2 Amy",-1)),s[267]||(s[267]=i("ul",null,[i("li",null,"查出成绩前3名的同学")],-1)),s[268]||(s[268]=i("p",null,"ZREVRANGE stus 0 2",-1)),s[269]||(s[269]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230505011317949.png",alt:"image-20230505011317949",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[270]||(s[270]=i("ul",null,[i("li",null,"查出成绩80分以下的所有同学")],-1)),s[271]||(s[271]=i("p",null,"ZRANGEBYSCORE stus 0 80",-1)),s[272]||(s[272]=i("hr",null,null,-1)),s[273]||(s[273]=i("h3",{id:"_3-redis-的-java-客户端",tabindex:"-1"},[l("3. Redis 的 Java 客户端 "),i("a",{class:"header-anchor",href:"#_3-redis-的-java-客户端","aria-label":'Permalink to "3. Redis 的 Java 客户端"'},"​")],-1)),s[274]||(s[274]=i("p",null,[l("在Redis官网中提供了各种语言的客户端，地址："),i("a",{href:"https://redis.io/docs/clients/",target:"_blank",rel:"noreferrer"},"https://redis.io/docs/clients/")],-1)),s[275]||(s[275]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/9f68ivq.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[276]||(s[276]=i("p",null,"其中Java客户端也包含很多：",-1)),s[277]||(s[277]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220609102817435-165735883948534.png",alt:"image-20220609102817435",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[278]||(s[278]=i("p",null,"标记为*的就是推荐使用的java客户端，包括：",-1)),s[279]||(s[279]=i("ul",null,[i("li",null,"Jedis和Lettuce：这两个主要是提供了Redis命令对应的API，方便我们操作Redis，而SpringDataRedis又对这两种做了抽象和封装，因此我们后期会直接以SpringDataRedis来学习。"),i("li",null,"Redisson：是在Redis基础上实现了分布式的可伸缩的java数据结构，例如Map、Queue等，而且支持跨进程的同步机制：Lock、Semaphore等待，比较适合用来实现特殊的功能需求。")],-1)),s[280]||(s[280]=i("hr",null,null,-1)),s[281]||(s[281]=i("h4",{id:"_3-1-jedis客户端",tabindex:"-1"},[l("3.1 Jedis客户端 "),i("a",{class:"header-anchor",href:"#_3-1-jedis客户端","aria-label":'Permalink to "3.1 Jedis客户端"'},"​")],-1)),s[282]||(s[282]=i("p",null,[l("Jedis的官网地址： "),i("a",{href:"https://github.com/redis/jedis",target:"_blank",rel:"noreferrer"},"https://github.com/redis/jedis")],-1)),s[283]||(s[283]=i("h5",{id:"_3-1-1-快速入门",tabindex:"-1"},[l("3.1.1 快速入门 "),i("a",{class:"header-anchor",href:"#_3-1-1-快速入门","aria-label":'Permalink to "3.1.1 快速入门"'},"​")],-1)),s[284]||(s[284]=i("p",null,"我们先来个快速入门：",-1)),s[285]||(s[285]=i("p",null,"1）引入依赖：",-1)),s[286]||(s[286]=i("div",{class:"language-xml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"xml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"<!--jedis-->")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">redis.clients</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">jedis</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">3.7.0</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"<!--单元测试-->")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.junit.jupiter</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">junit-jupiter</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">5.7.0</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"scope"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">test</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"scope"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[287]||(s[287]=i("p",null,"2）建立连接",-1)),s[288]||(s[288]=i("p",null,"新建一个单元测试类，内容如下：",-1)),s[289]||(s[289]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Jedis jedis;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"BeforeEach")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setUp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.建立连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'    // jedis = new Jedis("192.168.150.101", 6379);')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    jedis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JedisConnectionFactory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getJedis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.设置密码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"auth"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.选择库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"select"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[290]||(s[290]=i("p",null,"3）测试：",-1)),s[291]||(s[291]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 存入数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String result "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"虎哥"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"result = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String name "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testHash"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 插入hash数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user:1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Jack"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user:1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"age"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"21"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hgetAll"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user:1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[292]||(s[292]=i("p",null,"4）释放资源",-1)),s[293]||(s[293]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"AfterEach")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tearDown"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (jedis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[294]||(s[294]=i("h5",{id:"_3-1-2-连接池",tabindex:"-1"},[l("3.1.2 连接池 "),i("a",{class:"header-anchor",href:"#_3-1-2-连接池","aria-label":'Permalink to "3.1.2 连接池"'},"​")],-1)),s[295]||(s[295]=i("p",null,"Jedis本身是线程不安全的，并且频繁的创建和销毁连接会有性能损耗，因此我们推荐大家使用Jedis连接池代替Jedis的直连方式。",-1)),s[296]||(s[296]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.jedis.util;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis.clients.jedis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"*"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JedisConnectionFactory"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JedisPool jedisPool;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    static"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 配置连接池")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        JedisPoolConfig poolConfig "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JedisPoolConfig"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMaxTotal"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMaxIdle"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMinIdle"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMaxWaitMillis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建连接池对象，参数：连接池配置、服务端ip、服务端端口、超时时间、密码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedisPool "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JedisPool"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(poolConfig, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Jedis "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getJedis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedisPool."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getResource"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[297]||(s[297]=i("hr",null,null,-1)),s[298]||(s[298]=i("h4",{id:"_3-2-springdataredis-客户端",tabindex:"-1"},[l("3.2 SpringDataRedis 客户端 "),i("a",{class:"header-anchor",href:"#_3-2-springdataredis-客户端","aria-label":'Permalink to "3.2 SpringDataRedis 客户端"'},"​")],-1)),s[299]||(s[299]=i("p",null,[l("SpringData是Spring中数据操作的模块，包含对各种数据库的集成，其中对Redis的集成模块就叫做SpringDataRedis，官网地址："),i("a",{href:"https://spring.io/projects/spring-data-redis",target:"_blank",rel:"noreferrer"},"https://spring.io/projects/spring-data-redis")],-1)),s[300]||(s[300]=i("ul",null,[i("li",null,"提供了对不同Redis客户端的整合（Lettuce和Jedis）"),i("li",null,"提供了RedisTemplate统一API来操作Redis"),i("li",null,"支持Redis的发布订阅模型"),i("li",null,"支持Redis哨兵和Redis集群"),i("li",null,"支持基于Lettuce的响应式编程"),i("li",null,"支持基于JDK、JSON、字符串、Spring对象的数据序列化及反序列化"),i("li",null,"支持基于Redis的JDKCollection实现")],-1)),s[301]||(s[301]=i("p",null,"SpringDataRedis中提供了RedisTemplate工具类，其中封装了各种对Redis的操作。并且将不同数据类型的操作API封装到了不同的类型中：",-1)),s[302]||(s[302]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/UFlNIV0.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[303]||(s[303]=i("h5",{id:"_3-2-1-快速入门",tabindex:"-1"},[l("3.2.1 快速入门 "),i("a",{class:"header-anchor",href:"#_3-2-1-快速入门","aria-label":'Permalink to "3.2.1 快速入门"'},"​")],-1)),s[304]||(s[304]=i("p",null,"SpringBoot已经提供了对SpringDataRedis的支持，使用非常简单。",-1)),s[305]||(s[305]=i("p",null,"首先，新建一个maven项目，然后按照下面步骤执行：",-1)),s[306]||(s[306]=i("h6",{id:"_1-引入依赖",tabindex:"-1"},[l("1）引入依赖 "),i("a",{class:"header-anchor",href:"#_1-引入依赖","aria-label":'Permalink to "1）引入依赖"'},"​")],-1)),s[307]||(s[307]=i("div",{class:"language-xml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"xml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<?"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"xml"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"1.0"'),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," encoding"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"UTF-8"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"?>")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"project"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xmlns"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http://maven.apache.org/POM/4.0.0"'),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xmlns:xsi"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http://www.w3.org/2001/XMLSchema-instance"')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"         xsi:schemaLocation"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"modelVersion"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">4.0.0</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"modelVersion"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"parent"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-parent</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">2.5.7</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"relativePath"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"/> "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"<!-- lookup parent from repository -->")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"parent"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.heima</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">redis-demo</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">0.0.1-SNAPSHOT</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"name"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">redis-demo</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"name"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"description"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">Demo project for Spring Boot</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"description"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"properties"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"java.version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">1.8</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"java.version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"properties"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependencies"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        <!--redis依赖-->")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-data-redis</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        <!--common-pool-->")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.apache.commons</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">commons-pool2</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        <!--Jackson依赖-->")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.fasterxml.jackson.core</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">jackson-databind</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.projectlombok</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">lombok</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"optional"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">true</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"optional"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-test</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"scope"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">test</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"scope"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependencies"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"plugins"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"plugin"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-maven-plugin</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"configuration"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"excludes"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclude"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.projectlombok</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">lombok</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclude"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"excludes"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"configuration"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"plugin"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"plugins"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"project"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[308]||(s[308]=i("h6",{id:"_2-配置-redis",tabindex:"-1"},[l("2）配置 Redis "),i("a",{class:"header-anchor",href:"#_2-配置-redis","aria-label":'Permalink to "2）配置 Redis"'},"​")],-1)),s[309]||(s[309]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    host"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"192.168.150.101")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    port"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    password"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    lettuce"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      pool"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        max-active"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        max-idle"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        min-idle"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        max-wait"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"100ms")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[310]||(s[310]=i("h6",{id:"_3-注入-redistemplate",tabindex:"-1"},[l("3）注入 RedisTemplate "),i("a",{class:"header-anchor",href:"#_3-注入-redistemplate","aria-label":'Permalink to "3）注入 RedisTemplate"'},"​")],-1)),s[311]||(s[311]=i("p",null,"因为有了SpringBoot的自动装配，我们可以拿来就用：",-1)),s[312]||(s[312]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SpringBootTest")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisStringTests"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisTemplate redisTemplate;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[313]||(s[313]=i("h6",{id:"_4-编写测试",tabindex:"-1"},[l("4）编写测试 "),i("a",{class:"header-anchor",href:"#_4-编写测试","aria-label":'Permalink to "4）编写测试"'},"​")],-1)),s[314]||(s[314]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SpringBootTest")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisStringTests"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisTemplate redisTemplate;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写入一条String数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"虎哥"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取string数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Object name "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[315]||(s[315]=i("h5",{id:"_3-2-2-自定义序列化",tabindex:"-1"},[l("3.2.2 自定义序列化 "),i("a",{class:"header-anchor",href:"#_3-2-2-自定义序列化","aria-label":'Permalink to "3.2.2 自定义序列化"'},"​")],-1)),s[316]||(s[316]=i("p",null,"RedisTemplate可以接收任意Object作为值写入Redis：",-1)),s[317]||(s[317]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/OEMcbuu.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[318]||(s[318]=i("p",null,"只不过写入前会把Object序列化为字节形式，默认是采用JDK序列化，得到的结果是这样的：",-1)),s[319]||(s[319]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/5FjtWk5.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[320]||(s[320]=i("p",null,"缺点：",-1)),s[321]||(s[321]=i("ul",null,[i("li",null,"可读性差"),i("li",null,"内存占用较大")],-1)),s[322]||(s[322]=i("p",null,"我们可以自定义RedisTemplate的序列化方式，代码如下：",-1)),s[323]||(s[323]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisConfig"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisTemplate<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redisTemplate"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RedisConnectionFactory "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"connectionFactory"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建RedisTemplate对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RedisTemplate<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> template "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisTemplate<>();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置连接工厂")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        template."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setConnectionFactory"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(connectionFactory);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建JSON序列化工具")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        GenericJackson2JsonRedisSerializer jsonRedisSerializer "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            							new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," GenericJackson2JsonRedisSerializer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置Key的序列化")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        template."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setKeySerializer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RedisSerializer."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"string"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        template."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHashKeySerializer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RedisSerializer."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"string"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置Value的序列化")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        template."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setValueSerializer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(jsonRedisSerializer);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        template."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHashValueSerializer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(jsonRedisSerializer);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," template;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[324]||(s[324]=i("p",null,"这里采用了JSON序列化来代替默认的JDK序列化方式。最终结果如图：",-1)),s[325]||(s[325]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/XOAq3cN.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[326]||(s[326]=i("p",null,"整体可读性有了很大提升，并且能将Java对象自动的序列化为JSON字符串，并且查询时能自动把JSON反序列化为Java对象。不过，其中记录了序列化时对应的class名称，目的是为了查询时实现自动反序列化。这会带来额外的内存开销。",-1)),s[327]||(s[327]=i("h5",{id:"_3-2-3-stringredistemplate",tabindex:"-1"},[l("3.2.3 StringRedisTemplate "),i("a",{class:"header-anchor",href:"#_3-2-3-stringredistemplate","aria-label":'Permalink to "3.2.3 StringRedisTemplate"'},"​")],-1)),s[328]||(s[328]=i("p",null,"为了节省内存空间，我们可以不使用JSON序列化器来处理value，而是统一使用String序列化器，要求只能存储String类型的key和value。当需要存储Java对象时，手动完成对象的序列化和反序列化。",-1)),s[329]||(s[329]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/Ip9TKSY.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[330]||(s[330]=i("p",null,"因为存入和读取时的序列化及反序列化都是我们自己实现的，SpringDataRedis就不会将class信息写入Redis了。",-1)),s[331]||(s[331]=i("p",null,"这种用法比较普遍，因此SpringDataRedis就提供了RedisTemplate的子类：StringRedisTemplate，它的key和value的序列化方式默认就是String方式。",-1)),s[332]||(s[332]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/zXH6Qn6.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[333]||(s[333]=i("p",null,"省去了我们自定义RedisTemplate的序列化方式的步骤，而是直接使用：",-1)),s[334]||(s[334]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate stringRedisTemplate;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// JSON序列化工具")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectMapper mapper "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ObjectMapper"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSaveUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws JsonProcessingException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    User user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," User"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"虎哥"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"21"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 手动序列化")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," mapper."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 写入数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user:200"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", json);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String jsonUser "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user:200"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 手动反序列化")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    User user1 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," mapper."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"readValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(jsonUser, User.class);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user1 = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," user1);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[335]||(s[335]=i("hr",null,null,-1)),s[336]||(s[336]=i("h2",{id:"redis-实战篇",tabindex:"-1"},[l("Redis 实战篇 "),i("a",{class:"header-anchor",href:"#redis-实战篇","aria-label":'Permalink to "Redis 实战篇"'},"​")],-1)),s[337]||(s[337]=i("ul",null,[i("li",null,[i("p",null,"短信登录"),i("ul",null,[i("li",null,"这一块我们会使用redis共享session来实现")])]),i("li",null,[i("p",null,"商户查询缓存"),i("ul",null,[i("li",null,"通过本章节，我们会理解缓存击穿，缓存穿透，缓存雪崩等问题，让小伙伴的对于这些概念的理解不仅仅是停留在概念上，更是能在代码中看到对应的内容")])]),i("li",null,[i("p",null,"优惠卷秒杀"),i("ul",null,[i("li",null,"通过本章节，我们可以学会Redis的计数器功能， 结合Lua完成高性能的redis操作，同时学会Redis分布式锁的原理，包括Redis的三种消息队列")])]),i("li",null,[i("p",null,"附近的商户"),i("ul",null,[i("li",null,"我们利用Redis的GEOHash来完成对于地理坐标的操作")])]),i("li",null,[i("p",null,"UV统计"),i("ul",null,[i("li",null,"主要是使用Redis来完成统计功能")])]),i("li",null,[i("p",null,"用户签到"),i("ul",null,[i("li",null,"使用Redis的BitMap数据统计功能")])]),i("li",null,[i("p",null,"好友关注"),i("ul",null,[i("li",null,"基于Set集合的关注、取消关注，共同关注等等功能，这一块知识咱们之前就讲过，这次我们在项目中来使用一下")])]),i("li",null,[i("p",null,"打人探店"),i("ul",null,[i("li",null,[i("p",null,"基于List来完成点赞列表的操作，同时基于SortedSet来完成点赞的排行榜功能")]),i("li",null,[i("p",null,"以上这些内容咱们统统都会给小伙伴们讲解清楚，让大家充分理解如何使用Redis")])])])],-1)),s[338]||(s[338]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653056228879.png",alt:"1653056228879",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[339]||(s[339]=i("hr",null,null,-1)),s[340]||(s[340]=i("h3",{id:"_1-短信登录",tabindex:"-1"},[l("1. 短信登录 "),i("a",{class:"header-anchor",href:"#_1-短信登录","aria-label":'Permalink to "1. 短信登录"'},"​")],-1)),s[341]||(s[341]=i("h4",{id:"_1-1-导入黑马点评项目",tabindex:"-1"},[l("1.1 导入黑马点评项目 "),i("a",{class:"header-anchor",href:"#_1-1-导入黑马点评项目","aria-label":'Permalink to "1.1 导入黑马点评项目"'},"​")],-1)),s[342]||(s[342]=i("h5",{id:"_1-1-1-导入-sql",tabindex:"-1"},[l("1.1.1 导入 SQL "),i("a",{class:"header-anchor",href:"#_1-1-1-导入-sql","aria-label":'Permalink to "1.1.1 导入 SQL"'},"​")],-1)),s[343]||(s[343]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653057872536.png",alt:"1653057872536",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[344]||(s[344]=i("h5",{id:"_1-1-2-有关当前模型",tabindex:"-1"},[l("1.1.2 有关当前模型 "),i("a",{class:"header-anchor",href:"#_1-1-2-有关当前模型","aria-label":'Permalink to "1.1.2 有关当前模型"'},"​")],-1)),s[345]||(s[345]=i("p",null,"手机或者app端发起请求，请求我们的nginx服务器，nginx基于七层模型走的事HTTP协议，可以实现基于Lua直接绕开tomcat访问redis，也可以作为静态资源服务器，轻松扛下上万并发， 负载均衡到下游tomcat服务器，打散流量，我们都知道一台4核8G的tomcat，在优化和处理简单业务的加持下，大不了就处理1000左右的并发， 经过nginx的负载均衡分流后，利用集群支撑起整个项目，同时nginx在部署了前端项目后，更是可以做到动静分离，进一步降低tomcat服务的压力，这些功能都得靠nginx起作用，所以nginx是整个项目中重要的一环。",-1)),s[346]||(s[346]=i("p",null,"在tomcat支撑起并发流量后，我们如果让tomcat直接去访问Mysql，根据经验Mysql企业级服务器只要上点并发，一般是16或32 核心cpu，32 或64G内存，像企业级mysql加上固态硬盘能够支撑的并发，大概就是4000起~7000左右，上万并发， 瞬间就会让Mysql服务器的cpu，硬盘全部打满，容易崩溃，所以我们在高并发场景下，会选择使用mysql集群，同时为了进一步降低Mysql的压力，同时增加访问的性能，我们也会加入Redis，同时使用Redis集群使得Redis对外提供更好的服务。",-1)),s[347]||(s[347]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653059409865.png",alt:"1653059409865",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[348]||(s[348]=i("h5",{id:"_1-1-3-导入后端项目",tabindex:"-1"},[l("1.1.3 导入后端项目 "),i("a",{class:"header-anchor",href:"#_1-1-3-导入后端项目","aria-label":'Permalink to "1.1.3 导入后端项目"'},"​")],-1)),s[349]||(s[349]=i("p",null,"在资料中提供了一个项目源码：",-1)),s[350]||(s[350]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653060237073.png",alt:"1653060237073",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[351]||(s[351]=i("h5",{id:"_1-1-4-导入前端工程",tabindex:"-1"},[l("1.1.4 导入前端工程 "),i("a",{class:"header-anchor",href:"#_1-1-4-导入前端工程","aria-label":'Permalink to "1.1.4 导入前端工程"'},"​")],-1)),s[352]||(s[352]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653060337562.png",alt:"1653060337562",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[353]||(s[353]=i("h5",{id:"_1-1-5-运行前端项目",tabindex:"-1"},[l("1.1.5 运行前端项目 "),i("a",{class:"header-anchor",href:"#_1-1-5-运行前端项目","aria-label":'Permalink to "1.1.5 运行前端项目"'},"​")],-1)),s[354]||(s[354]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653060588190.png",alt:"1653060588190",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[355]||(s[355]=i("h4",{id:"_1-2-基于-session-实现登录流程",tabindex:"-1"},[l("1.2 基于 Session 实现登录流程 "),i("a",{class:"header-anchor",href:"#_1-2-基于-session-实现登录流程","aria-label":'Permalink to "1.2 基于 Session 实现登录流程"'},"​")],-1)),s[356]||(s[356]=i("p",null,[i("strong",null,"发送验证码：")],-1)),s[357]||(s[357]=i("p",null,"用户在提交手机号后，会校验手机号是否合法，如果不合法，则要求用户重新输入手机号",-1)),s[358]||(s[358]=i("p",null,"如果手机号合法，后台此时生成对应的验证码，同时将验证码进行保存，然后再通过短信的方式将验证码发送给用户",-1)),s[359]||(s[359]=i("p",null,[i("strong",null,"短信验证码登录、注册：")],-1)),s[360]||(s[360]=i("p",null,"用户将验证码和手机号进行输入，后台从session中拿到当前验证码，然后和用户输入的验证码进行校验，如果不一致，则无法通过校验，如果一致，则后台根据手机号查询用户，如果用户不存在，则为用户创建账号信息，保存到数据库，无论是否存在，都会将用户信息保存到session中，方便后续获得当前登录信息",-1)),s[361]||(s[361]=i("p",null,[i("strong",null,"校验登录状态:")],-1)),s[362]||(s[362]=i("p",null,"用户在请求时候，会从cookie中携带者JsessionId到后台，后台通过JsessionId从session中拿到用户信息，如果没有session信息，则进行拦截，如果有session信息，则将用户信息保存到threadLocal中，并且放行",-1)),s[363]||(s[363]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653066208144.png",alt:"1653066208144",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[364]||(s[364]=i("h4",{id:"_1-3-实现发送短信验证码功能",tabindex:"-1"},[l("1.3 实现发送短信验证码功能 "),i("a",{class:"header-anchor",href:"#_1-3-实现发送短信验证码功能","aria-label":'Permalink to "1.3 实现发送短信验证码功能"'},"​")],-1)),s[365]||(s[365]=i("p",null,[i("strong",null,"页面流程")],-1)),s[366]||(s[366]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653067054461.png",alt:"1653067054461",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[367]||(s[367]=i("p",null,[i("strong",null,"具体代码如下")],-1)),s[368]||(s[368]=i("p",null,[i("strong",null,"贴心小提示：")],-1)),s[369]||(s[369]=i("p",null,"具体逻辑上文已经分析，我们仅仅只需要按照提示的逻辑写出代码即可。",-1)),s[370]||(s[370]=i("ul",null,[i("li",null,"发送验证码")],-1)),s[371]||(s[371]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sendCode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String phone, HttpSession session) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.校验手机号")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (RegexUtils."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isPhoneInvalid"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(phone)) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.如果不符合，返回错误信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"手机号格式错误！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.符合，生成验证码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String code "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RandomUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomNumbers"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.保存验证码到 session")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        session."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAttribute"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"code"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",code);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.发送验证码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"发送短信验证码成功，验证码：{}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", code);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 返回ok")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[372]||(s[372]=i("ul",null,[i("li",null,"登录")],-1)),s[373]||(s[373]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"login"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LoginFormDTO loginForm, HttpSession session) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.校验手机号")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String phone "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," loginForm."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPhone"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (RegexUtils."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isPhoneInvalid"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(phone)) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.如果不符合，返回错误信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"手机号格式错误！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.校验验证码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Object cacheCode "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," session."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAttribute"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"code"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String code "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," loginForm."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cacheCode "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," !"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cacheCode."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(code)){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"             //3.不一致，报错")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"验证码错误"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //一致，根据手机号查询用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        User user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"phone"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", phone)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"one"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //5.判断用户是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //不存在，则创建")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  createUserWithPhone"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(phone);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //7.保存用户信息到session中")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        session."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAttribute"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",user);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[374]||(s[374]=i("h4",{id:"_1-4-实现登录拦截功能",tabindex:"-1"},[l("1.4 实现登录拦截功能 "),i("a",{class:"header-anchor",href:"#_1-4-实现登录拦截功能","aria-label":'Permalink to "1.4 实现登录拦截功能"'},"​")],-1)),s[375]||(s[375]=i("p",null,[i("strong",null,"温馨小贴士：tomcat的运行原理")],-1)),s[376]||(s[376]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653068196656.png",alt:"1653068196656",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[377]||(s[377]=i("p",null,"当用户发起请求时，会访问我们像tomcat注册的端口，任何程序想要运行，都需要有一个线程对当前端口号进行监听，tomcat也不例外，当监听线程知道用户想要和tomcat连接连接时，那会由监听线程创建socket连接，socket都是成对出现的，用户通过socket像互相传递数据，当tomcat端的socket接受到数据后，此时监听线程会从tomcat的线程池中取出一个线程执行用户请求，在我们的服务部署到tomcat后，线程会找到用户想要访问的工程，然后用这个线程转发到工程中的controller，service，dao中，并且访问对应的DB，在用户执行完请求后，再统一返回，再找到tomcat端的socket，再将数据写回到用户端的socket，完成请求和响应",-1)),s[378]||(s[378]=i("p",null,"通过以上讲解，我们可以得知 每个用户其实对应都是去找tomcat线程池中的一个线程来完成工作的， 使用完成后再进行回收，既然每个请求都是独立的，所以在每个用户去访问我们的工程时，我们可以使用threadlocal来做到线程隔离，每个线程操作自己的一份数据",-1)),s[379]||(s[379]=i("p",null,[i("strong",null,"温馨小贴士：关于threadlocal")],-1)),s[380]||(s[380]=i("p",null,"如果小伙伴们看过threadLocal的源码，你会发现在threadLocal中，无论是他的put方法和他的get方法， 都是先从获得当前用户的线程，然后从线程中取出线程的成员变量map，只要线程不一样，map就不一样，所以可以通过这种方式来做到线程隔离",-1)),s[381]||(s[381]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653068874258.png",alt:"1653068874258",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[382]||(s[382]=i("p",null,"拦截器代码",-1)),s[383]||(s[383]=i("div",{class:"language-Java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"Java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," LoginInterceptor"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HandlerInterceptor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," preHandle"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"handler"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"       //1.获取session")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        HttpSession session "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSession"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //2.获取session中的用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Object user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," session."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAttribute"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //3.判断用户是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"              //4.不存在，拦截，返回401状态码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"              response."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStatus"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"401"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"              return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //5.存在，保存用户信息到Threadlocal")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((User)user);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //6.放行")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[384]||(s[384]=i("p",null,"让拦截器生效",-1)),s[385]||(s[385]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," MvcConfig"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," WebMvcConfigurer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Resource")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate stringRedisTemplate;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addInterceptors"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(InterceptorRegistry "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"registry"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 登录拦截器")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        registry."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addInterceptor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," LoginInterceptor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"excludePathPatterns"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/shop/**"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/voucher/**"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/shop-type/**"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/upload/**"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/blog/hot"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/user/code"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                        "/user/login"')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                )."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"order"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // token刷新的拦截器")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        registry."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addInterceptor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RefreshTokenInterceptor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stringRedisTemplate))."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addPathPatterns"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/**"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"order"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[386]||(s[386]=i("h4",{id:"_1-5-隐藏用户敏感信息",tabindex:"-1"},[l("1.5 隐藏用户敏感信息 "),i("a",{class:"header-anchor",href:"#_1-5-隐藏用户敏感信息","aria-label":'Permalink to "1.5 隐藏用户敏感信息"'},"​")],-1)),s[387]||(s[387]=i("p",null,"我们通过浏览器观察到此时用户的全部信息都在，这样极为不靠谱，所以我们应当在返回用户信息之前，将用户的敏感信息进行隐藏，采用的核心思路就是书写一个UserDto对象，这个UserDto对象就没有敏感信息了，我们在返回前，将有用户敏感信息的User对象转化成没有敏感信息的UserDto对象，那么就能够避免这个尴尬的问题了",-1)),s[388]||(s[388]=i("p",null,[i("strong",null,"在登录方法处修改")],-1)),s[389]||(s[389]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//7.保存用户信息到session中")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"session."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAttribute"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", BeanUtils."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user,UserDTO.class));")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[390]||(s[390]=i("p",null,[i("strong",null,"在拦截器处：")],-1)),s[391]||(s[391]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//5.存在，保存用户信息到Threadlocal")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((UserDTO) user);")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[392]||(s[392]=i("p",null,[i("strong",null,"在UserHolder处：将user对象换成UserDTO")],-1)),s[393]||(s[393]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserHolder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ThreadLocal<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UserDTO"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> tl "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ThreadLocal<>();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," saveUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UserDTO "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"user"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        tl."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserDTO "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tl."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," removeUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        tl."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[394]||(s[394]=i("h4",{id:"_1-6-session-共享问题",tabindex:"-1"},[l("1.6 session 共享问题 "),i("a",{class:"header-anchor",href:"#_1-6-session-共享问题","aria-label":'Permalink to "1.6 session 共享问题"'},"​")],-1)),s[395]||(s[395]=i("p",null,[i("strong",null,"核心思路分析：")],-1)),s[396]||(s[396]=i("p",null,"每个tomcat中都有一份属于自己的session,假设用户第一次访问第一台tomcat，并且把自己的信息存放到第一台服务器的session中，但是第二次这个用户访问到了第二台tomcat，那么在第二台服务器上，肯定没有第一台服务器存放的session，所以此时 整个登录拦截功能就会出现问题，我们能如何解决这个问题呢？早期的方案是session拷贝，就是说虽然每个tomcat上都有不同的session，但是每当任意一台服务器的session修改时，都会同步给其他的Tomcat服务器的session，这样的话，就可以实现session的共享了",-1)),s[397]||(s[397]=i("p",null,"但是这种方案具有两个大问题",-1)),s[398]||(s[398]=i("p",null,"1、每台服务器中都有完整的一份session数据，服务器压力过大。",-1)),s[399]||(s[399]=i("p",null,"2、session拷贝数据时，可能会出现延迟",-1)),s[400]||(s[400]=i("p",null,"所以咱们后来采用的方案都是基于redis来完成，我们把session换成redis，redis数据本身就是共享的，就可以避免session共享的问题了",-1)),s[401]||(s[401]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653069893050.png",alt:"1653069893050",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[402]||(s[402]=i("h4",{id:"_1-7-redis-代替-session-的业务流程",tabindex:"-1"},[l("1.7 Redis 代替 session 的业务流程 "),i("a",{class:"header-anchor",href:"#_1-7-redis-代替-session-的业务流程","aria-label":'Permalink to "1.7 Redis 代替 session 的业务流程"'},"​")],-1)),s[403]||(s[403]=i("h5",{id:"_1-7-1-设计-key-的结构",tabindex:"-1"},[l("1.7.1 设计 key 的结构 "),i("a",{class:"header-anchor",href:"#_1-7-1-设计-key-的结构","aria-label":'Permalink to "1.7.1 设计 key 的结构"'},"​")],-1)),s[404]||(s[404]=i("p",null,"首先我们要思考一下利用redis来存储数据，那么到底使用哪种结构呢？由于存入的数据比较简单，我们可以考虑使用String，或者是使用哈希，如下图，如果使用String，同学们注意他的value，用多占用一点空间，如果使用哈希，则他的value中只会存储他数据本身，如果不是特别在意内存，其实使用String就可以啦。",-1)),s[405]||(s[405]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653319261433.png",alt:"1653319261433",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[406]||(s[406]=i("h5",{id:"_1-7-2-设计-key-的具体细节",tabindex:"-1"},[l("1.7.2 设计 key 的具体细节 "),i("a",{class:"header-anchor",href:"#_1-7-2-设计-key-的具体细节","aria-label":'Permalink to "1.7.2 设计 key 的具体细节"'},"​")],-1)),s[407]||(s[407]=i("p",null,"所以我们可以使用String结构，就是一个简单的key，value键值对的方式，但是关于key的处理，session他是每个用户都有自己的session，但是redis的key是共享的，咱们就不能使用code了",-1)),s[408]||(s[408]=i("p",null,"在设计这个key的时候，我们之前讲过需要满足两点",-1)),s[409]||(s[409]=i("p",null,"1、key要具有唯一性",-1)),s[410]||(s[410]=i("p",null,"2、key要方便携带",-1)),s[411]||(s[411]=i("p",null,"如果我们采用phone：手机号这个的数据来存储当然是可以的，但是如果把这样的敏感数据存储到redis中并且从页面中带过来毕竟不太合适，所以我们在后台生成一个随机串token，然后让前端带来这个token就能完成我们的整体逻辑了",-1)),s[412]||(s[412]=i("h5",{id:"_1-7-3-整体访问流程",tabindex:"-1"},[l("1.7.3 整体访问流程 "),i("a",{class:"header-anchor",href:"#_1-7-3-整体访问流程","aria-label":'Permalink to "1.7.3 整体访问流程"'},"​")],-1)),s[413]||(s[413]=i("p",null,"当注册完成后，用户去登录会去校验用户提交的手机号和验证码，是否一致，如果一致，则根据手机号查询用户信息，不存在则新建，最后将用户数据保存到redis，并且生成token作为redis的key，当我们校验用户是否登录时，会去携带着token进行访问，从redis中取出token对应的value，判断是否存在这个数据，如果没有则拦截，如果存在则将其保存到threadLocal中，并且放行。",-1)),s[414]||(s[414]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653319474181.png",alt:"1653319474181",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[415]||(s[415]=i("h4",{id:"_1-8-基于-redis-实现短信登录",tabindex:"-1"},[l("1.8 基于 Redis 实现短信登录 "),i("a",{class:"header-anchor",href:"#_1-8-基于-redis-实现短信登录","aria-label":'Permalink to "1.8 基于 Redis 实现短信登录"'},"​")],-1)),s[416]||(s[416]=i("p",null,"这里具体逻辑就不分析了，之前咱们已经重点分析过这个逻辑啦。",-1)),s[417]||(s[417]=i("p",null,[i("strong",null,"UserServiceImpl代码")],-1)),s[418]||(s[418]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"login"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LoginFormDTO loginForm, HttpSession session) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.校验手机号")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String phone "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," loginForm."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPhone"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (RegexUtils."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isPhoneInvalid"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(phone)) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.如果不符合，返回错误信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"手机号格式错误！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.从redis获取验证码并校验")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String cacheCode "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LOGIN_CODE_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," phone);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String code "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," loginForm."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (cacheCode "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," !"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cacheCode."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(code)) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 不一致，报错")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"验证码错误"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.一致，根据手机号查询用户 select * from tb_user where phone = ?")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    User user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"phone"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", phone)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"one"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.判断用户是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.不存在，创建新用户并保存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createUserWithPhone"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(phone);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.保存用户信息到 redis中")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.1.随机生成token，作为登录令牌")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String token "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UUID."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomUUID"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.2.将User对象转为HashMap存储")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    UserDTO userDTO "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user, UserDTO.class);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> userMap "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"beanToMap"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userDTO, "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            CopyOptions."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIgnoreNullValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setFieldValueEditor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((fieldName, fieldValue) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," fieldValue."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.3.存储")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String tokenKey "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LOGIN_USER_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," token;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForHash"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"putAll"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(tokenKey, userMap);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.4.设置token有效期")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"expire"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(tokenKey, LOGIN_USER_TTL, TimeUnit.MINUTES);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 8.返回token")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(token);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[419]||(s[419]=i("h4",{id:"_1-9-解决状态登录刷新问题",tabindex:"-1"},[l("1.9 解决状态登录刷新问题 "),i("a",{class:"header-anchor",href:"#_1-9-解决状态登录刷新问题","aria-label":'Permalink to "1.9 解决状态登录刷新问题"'},"​")],-1)),s[420]||(s[420]=i("h5",{id:"_1-9-1-初始方案思路总结",tabindex:"-1"},[l("1.9.1 初始方案思路总结： "),i("a",{class:"header-anchor",href:"#_1-9-1-初始方案思路总结","aria-label":'Permalink to "1.9.1 初始方案思路总结："'},"​")],-1)),s[421]||(s[421]=i("p",null,"在这个方案中，他确实可以使用对应路径的拦截，同时刷新登录token令牌的存活时间，但是现在这个拦截器他只是拦截需要被拦截的路径，假设当前用户访问了一些不需要拦截的路径，那么这个拦截器就不会生效，所以此时令牌刷新的动作实际上就不会执行，所以这个方案他是存在问题的",-1)),s[422]||(s[422]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653320822964.png",alt:"1653320822964",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[423]||(s[423]=i("h5",{id:"_1-9-2-优化方案",tabindex:"-1"},[l("1.9.2 优化方案 "),i("a",{class:"header-anchor",href:"#_1-9-2-优化方案","aria-label":'Permalink to "1.9.2 优化方案"'},"​")],-1)),s[424]||(s[424]=i("p",null,"既然之前的拦截器无法对不需要拦截的路径生效，那么我们可以添加一个拦截器，在第一个拦截器中拦截所有的路径，把第二个拦截器做的事情放入到第一个拦截器中，同时刷新令牌，因为第一个拦截器有了threadLocal的数据，所以此时第二个拦截器只需要判断拦截器中的user对象是否存在即可，完成整体刷新功能。",-1)),s[425]||(s[425]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653320764547.png",alt:"1653320764547",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[426]||(s[426]=i("h5",{id:"_1-9-3-代码",tabindex:"-1"},[l("1.9.3 代码 "),i("a",{class:"header-anchor",href:"#_1-9-3-代码","aria-label":'Permalink to "1.9.3 代码"'},"​")],-1)),s[427]||(s[427]=i("p",null,[i("strong",null,"RefreshTokenInterceptor")],-1)),s[428]||(s[428]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RefreshTokenInterceptor"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HandlerInterceptor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate stringRedisTemplate;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RefreshTokenInterceptor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StringRedisTemplate "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"stringRedisTemplate"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".stringRedisTemplate "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," preHandle"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"handler"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取请求头中的token")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String token "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getHeader"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"authorization"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBlank"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(token)) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.基于TOKEN获取redis中的用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key  "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LOGIN_USER_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," token;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> userMap "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForHash"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entries"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.判断用户是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (userMap."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.将查询到的hash数据转为UserDTO")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserDTO userDTO "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fillBeanWithMap"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userMap, "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserDTO"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.存在，保存用户信息到 ThreadLocal")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userDTO);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.刷新token有效期")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"expire"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, LOGIN_USER_TTL, TimeUnit.MINUTES);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 8.放行")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," afterCompletion"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"handler"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Exception "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"ex"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 移除用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"removeUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[429]||(s[429]=i("p",null,[i("strong",null,"LoginInterceptor")],-1)),s[430]||(s[430]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," LoginInterceptor"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HandlerInterceptor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," preHandle"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"handler"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.判断是否需要拦截（ThreadLocal中是否有用户）")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 没有，需要拦截，设置状态码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            response."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStatus"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"401"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 拦截")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 有用户，则放行")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[431]||(s[431]=i("hr",null,null,-1)),s[432]||(s[432]=i("h3",{id:"_2-商户查询缓存",tabindex:"-1"},[l("2. 商户查询缓存 "),i("a",{class:"header-anchor",href:"#_2-商户查询缓存","aria-label":'Permalink to "2. 商户查询缓存"'},"​")],-1)),s[433]||(s[433]=i("h4",{id:"_2-1-什么是缓存",tabindex:"-1"},[l("2.1 什么是缓存? "),i("a",{class:"header-anchor",href:"#_2-1-什么是缓存","aria-label":'Permalink to "2.1 什么是缓存?"'},"​")],-1)),s[434]||(s[434]=i("p",null,[i("strong",null,"前言"),l(":"),i("strong",null,"什么是缓存?")],-1)),s[435]||(s[435]=i("p",null,[l("就像自行车,越野车的避震器"),i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1.gif",alt:""})],-1)),s[436]||(s[436]=i("p",null,[l('举个例子:越野车,山地自行车,都拥有"避震器",'),i("strong",null,"防止"),l('车体加速后因惯性,在酷似"U"字母的地形上飞跃,硬着陆导致的'),i("strong",null,"损害"),l(",像个弹簧一样;")],-1)),s[437]||(s[437]=i("p",null,'同样,实际开发中,系统也需要"避震器",防止过高的数据访问猛冲系统,导致其操作线程无法及时处理信息而瘫痪;',-1)),s[438]||(s[438]=i("p",null,"这在实际开发中对企业讲,对产品口碑,用户评价都是致命的;所以企业非常重视缓存技术;",-1)),s[439]||(s[439]=i("p",null,[i("strong",null,[l("缓存("),i("strong",null,"Cache),就是数据交换的"),l("缓冲区")]),l(",俗称的缓存就是"),i("strong",null,"缓冲区内的数据"),l(",一般从数据库中获取,存储于本地代码(例如:")],-1)),s[440]||(s[440]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"例1"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Static "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ConcurrentHashMap<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"K"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"V"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ConcurrentHashMap<>(); 本地用于高并发")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"例2"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"K"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"V"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> USER_CACHE "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CacheBuilder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(); 用于redis等缓存")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"例3"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Static "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"K"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"V"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HashMap"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(); 本地缓存")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[441]||(s[441]=i("p",null,[l("由于其被"),i("strong",null,"Static"),l("修饰,所以随着类的加载而被加载到"),i("strong",null,"内存之中"),l(",作为本地缓存,由于其又被"),i("strong",null,"final"),l("修饰,所以其引用"),i("code",null,"(例3:map)"),l("和对象"),i("code",null,"(例3:new HashMap())"),l("之间的关系是固定的,不能改变,因此不用担心赋值(=)导致缓存失效;")],-1)),s[442]||(s[442]=i("h5",{id:"_2-1-1-为什么要使用缓存",tabindex:"-1"},[l("2.1.1 为什么要使用缓存 "),i("a",{class:"header-anchor",href:"#_2-1-1-为什么要使用缓存","aria-label":'Permalink to "2.1.1 为什么要使用缓存"'},"​")],-1)),s[443]||(s[443]=i("p",null,[l("一句话:因为"),i("strong",null,"速度快,好用")],-1)),s[444]||(s[444]=i("p",null,[l("缓存数据存储于代码中,而代码运行在内存中,内存的读写性能远高于磁盘,缓存可以大大降低"),i("strong",null,"用户访问并发量带来的"),l("服务器读写压力")],-1)),s[445]||(s[445]=i("p",null,'实际开发过程中,企业的数据量,少则几十万,多则几千万,这么大数据量,如果没有缓存来作为"避震器",系统是几乎撑不住的,所以企业会大量运用到缓存技术;',-1)),s[446]||(s[446]=i("p",null,"但是缓存也会增加代码复杂度和运营的成本:",-1)),s[447]||(s[447]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220523214414123.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[448]||(s[448]=i("h5",{id:"_2-1-2-如何使用缓存",tabindex:"-1"},[l("2.1.2 如何使用缓存 "),i("a",{class:"header-anchor",href:"#_2-1-2-如何使用缓存","aria-label":'Permalink to "2.1.2 如何使用缓存"'},"​")],-1)),s[449]||(s[449]=i("p",null,"实际开发中,会构筑多级缓存来使系统运行速度进一步提升,例如:本地缓存与redis中的缓存并发使用",-1)),s[450]||(s[450]=i("p",null,[i("strong",null,"浏览器缓存"),l("：主要是存在于浏览器端的缓存")],-1)),s[451]||(s[451]=i("p",null,"**应用层缓存：**可以分为tomcat本地缓存，比如之前提到的map，或者是使用redis作为缓存",-1)),s[452]||(s[452]=i("p",null,"**数据库缓存：**在数据库中有一片空间是 buffer pool，增改查数据都会先加载到mysql的缓存中",-1)),s[453]||(s[453]=i("p",null,"**CPU缓存：**当代计算机最大的问题是 cpu性能提升了，但内存读写速度没有跟上，所以为了适应当下的情况，增加了cpu的L1，L2，L3级的缓存",-1)),s[454]||(s[454]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220523212915666.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[455]||(s[455]=i("h4",{id:"_2-2-添加商户缓存",tabindex:"-1"},[l("2.2 添加商户缓存 "),i("a",{class:"header-anchor",href:"#_2-2-添加商户缓存","aria-label":'Permalink to "2.2 添加商户缓存"'},"​")],-1)),s[456]||(s[456]=i("p",null,"在我们查询商户信息时，我们是直接操作从数据库中去进行查询的，大致逻辑是这样，直接查询数据库那肯定慢咯，所以我们需要增加缓存",-1)),s[457]||(s[457]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/{id}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryShopById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long id) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //这里是直接查询数据库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shopService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[458]||(s[458]=i("h5",{id:"_2-2-1-缓存模型和思路",tabindex:"-1"},[l("2.2.1 缓存模型和思路 "),i("a",{class:"header-anchor",href:"#_2-2-1-缓存模型和思路","aria-label":'Permalink to "2.2.1 缓存模型和思路"'},"​")],-1)),s[459]||(s[459]=i("p",null,"标准的操作方式就是查询数据库之前先查询缓存，如果缓存数据存在，则直接从缓存中返回，如果缓存数据不存在，再查询数据库，然后将数据存入redis。",-1)),s[460]||(s[460]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653322097736.png",alt:"1653322097736",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[461]||(s[461]=i("h5",{id:"_2-1-2-代码如下",tabindex:"-1"},[l("2.1.2 代码如下 "),i("a",{class:"header-anchor",href:"#_2-1-2-代码如下","aria-label":'Permalink to "2.1.2 代码如下"'},"​")],-1)),s[462]||(s[462]=i("p",null,"代码思路：如果缓存有，则直接返回，如果缓存不存在，则查询数据库，然后存入redis。",-1)),s[463]||(s[463]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653322190155.png",alt:"1653322190155",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[464]||(s[464]=i("h4",{id:"_2-3-缓存更新策略",tabindex:"-1"},[l("2.3 缓存更新策略 "),i("a",{class:"header-anchor",href:"#_2-3-缓存更新策略","aria-label":'Permalink to "2.3 缓存更新策略"'},"​")],-1)),s[465]||(s[465]=i("p",null,"缓存更新是redis为了节约内存而设计出来的一个东西，主要是因为内存数据宝贵，当我们向redis插入太多数据，此时就可能会导致缓存中的数据过多，所以redis会对部分数据进行更新，或者把他叫为淘汰更合适。",-1)),s[466]||(s[466]=i("p",null,"**内存淘汰：**redis自动进行，当redis内存达到咱们设定的max-memery的时候，会自动触发淘汰机制，淘汰掉一些不重要的数据(可以自己设置策略方式)",-1)),s[467]||(s[467]=i("p",null,"**超时剔除：**当我们给redis设置了过期时间ttl之后，redis会将超时的数据进行删除，方便咱们继续使用缓存",-1)),s[468]||(s[468]=i("p",null,"**主动更新：**我们可以手动调用方法把缓存删掉，通常用于解决缓存和数据库不一致问题",-1)),s[469]||(s[469]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653322506393.png",alt:"1653322506393",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[470]||(s[470]=i("h5",{id:"_2-3-1-数据库缓存不一致解决方案",tabindex:"-1"},[l("2.3.1 数据库缓存不一致解决方案： "),i("a",{class:"header-anchor",href:"#_2-3-1-数据库缓存不一致解决方案","aria-label":'Permalink to "2.3.1 数据库缓存不一致解决方案："'},"​")],-1)),s[471]||(s[471]=i("p",null,[l("由于我们的"),i("strong",null,"缓存的数据源来自于数据库"),l(",而数据库的"),i("strong",null,"数据是会发生变化的"),l(",因此,如果当数据库中"),i("strong",null,"数据发生变化,而缓存却没有同步"),l(",此时就会有"),i("strong",null,"一致性问题存在"),l(",其后果是:")],-1)),s[472]||(s[472]=i("p",null,"用户使用缓存中的过时数据,就会产生类似多线程数据安全问题,从而影响业务,产品口碑等;怎么解决呢？有如下几种方案",-1)),s[473]||(s[473]=i("p",null,"Cache Aside Pattern 人工编码方式：缓存调用者在更新完数据库后再去更新缓存，也称之为双写方案",-1)),s[474]||(s[474]=i("p",null,"Read/Write Through Pattern : 由系统本身完成，数据库与缓存的问题交由系统本身去处理",-1)),s[475]||(s[475]=i("p",null,"Write Behind Caching Pattern ：调用者只操作缓存，其他线程去异步处理数据库，实现最终一致",-1)),s[476]||(s[476]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653322857620.png",alt:"1653322857620",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[477]||(s[477]=i("h5",{id:"_2-3-2-数据库和缓存不一致采用什么方案",tabindex:"-1"},[l("2.3.2 数据库和缓存不一致采用什么方案 "),i("a",{class:"header-anchor",href:"#_2-3-2-数据库和缓存不一致采用什么方案","aria-label":'Permalink to "2.3.2 数据库和缓存不一致采用什么方案"'},"​")],-1)),s[478]||(s[478]=i("p",null,"综合考虑使用方案一，但是方案一调用者如何处理呢？这里有几个问题",-1)),s[479]||(s[479]=i("p",null,"操作缓存和数据库时有三个问题需要考虑：",-1)),s[480]||(s[480]=i("p",null,"如果采用第一个方案，那么假设我们每次操作数据库后，都操作缓存，但是中间如果没有人查询，那么这个更新动作实际上只有最后一次生效，中间的更新动作意义并不大，我们可以把缓存删除，等待再次查询时，将缓存中的数据加载出来",-1)),s[481]||(s[481]=i("ul",null,[i("li",null,[i("p",null,"删除缓存还是更新缓存？"),i("ul",null,[i("li",null,"更新缓存：每次更新数据库都更新缓存，无效写操作较多"),i("li",null,"删除缓存：更新数据库时让缓存失效，查询时再更新缓存")])]),i("li",null,[i("p",null,"如何保证缓存与数据库的操作的同时成功或失败？"),i("ul",null,[i("li",null,"单体系统，将缓存与数据库操作放在一个事务"),i("li",null,"分布式系统，利用TCC等分布式事务方案")])])],-1)),s[482]||(s[482]=i("p",null,"应该具体操作缓存还是操作数据库，我们应当是先操作数据库，再删除缓存，原因在于，如果你选择第一种方案，在两个线程并发来访问时，假设线程1先来，他先把缓存删了，此时线程2过来，他查询缓存数据并不存在，此时他写入缓存，当他写入缓存后，线程1再执行更新动作时，实际上写入的就是旧的数据，新的数据被旧数据覆盖了。",-1)),s[483]||(s[483]=i("ul",null,[i("li",null,[l("先操作缓存还是先操作数据库？ "),i("ul",null,[i("li",null,"先删除缓存，再操作数据库"),i("li",null,"先操作数据库，再删除缓存")])])],-1)),s[484]||(s[484]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653323595206.png",alt:"1653323595206",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[485]||(s[485]=i("h4",{id:"_2-4-实现商铺和缓存与数据库双写一致",tabindex:"-1"},[l("2.4 实现商铺和缓存与数据库双写一致 "),i("a",{class:"header-anchor",href:"#_2-4-实现商铺和缓存与数据库双写一致","aria-label":'Permalink to "2.4 实现商铺和缓存与数据库双写一致"'},"​")],-1)),s[486]||(s[486]=i("p",null,"核心思路如下：",-1)),s[487]||(s[487]=i("p",null,"修改ShopController中的业务逻辑，满足下面的需求：",-1)),s[488]||(s[488]=i("p",null,"根据id查询店铺时，如果缓存未命中，则查询数据库，将数据库结果写入缓存，并设置超时时间",-1)),s[489]||(s[489]=i("p",null,"根据id修改店铺时，先修改数据库，再删除缓存",-1)),s[490]||(s[490]=i("p",null,[i("strong",null,"修改重点代码1"),l("：修改"),i("strong",null,"ShopServiceImpl"),l("的queryById方法")],-1)),s[491]||(s[491]=i("p",null,[i("strong",null,"设置redis缓存时添加过期时间")],-1)),s[492]||(s[492]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653325871232.png",alt:"1653325871232",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[493]||(s[493]=i("p",null,[i("strong",null,"修改重点代码2")],-1)),s[494]||(s[494]=i("p",null,"代码分析：通过之前的淘汰，我们确定了采用删除策略，来解决双写问题，当我们修改了数据之后，然后把缓存中的数据进行删除，查询时发现缓存中没有数据，则会从mysql中加载最新的数据，从而避免数据库和缓存不一致的问题",-1)),s[495]||(s[495]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653325929549.png",alt:"1653325929549",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[496]||(s[496]=i("h4",{id:"_2-5-缓存穿透问题的解决思路",tabindex:"-1"},[l("2.5 缓存穿透问题的解决思路 "),i("a",{class:"header-anchor",href:"#_2-5-缓存穿透问题的解决思路","aria-label":'Permalink to "2.5 缓存穿透问题的解决思路"'},"​")],-1)),s[497]||(s[497]=i("p",null,"缓存穿透 ：缓存穿透是指客户端请求的数据在缓存中和数据库中都不存在，这样缓存永远不会生效，这些请求都会打到数据库。",-1)),s[498]||(s[498]=i("p",null,"常见的解决方案有两种：",-1)),s[499]||(s[499]=i("ul",null,[i("li",null,[l("缓存空对象 "),i("ul",null,[i("li",null,"优点：实现简单，维护方便"),i("li",null,[l("缺点： "),i("ul",null,[i("li",null,"额外的内存消耗"),i("li",null,"可能造成短期的不一致")])])])]),i("li",null,[l("布隆过滤 "),i("ul",null,[i("li",null,"优点：内存占用较少，没有多余key"),i("li",null,[l("缺点： "),i("ul",null,[i("li",null,"实现复杂"),i("li",null,"存在误判可能")])])])])],-1)),s[500]||(s[500]=i("p",null,"**缓存空对象思路分析：**当我们客户端访问不存在的数据时，先请求redis，但是此时redis中没有数据，此时会访问到数据库，但是数据库中也没有数据，这个数据穿透了缓存，直击数据库，我们都知道数据库能够承载的并发不如redis这么高，如果大量的请求同时过来访问这种不存在的数据，这些请求就都会访问到数据库，简单的解决方案就是哪怕这个数据在数据库中也不存在，我们也把这个数据存入到redis中去，这样，下次用户过来访问这个不存在的数据，那么在redis中也能找到这个数据就不会进入到缓存了",-1)),s[501]||(s[501]=i("p",null,"**布隆过滤：**布隆过滤器其实采用的是哈希思想来解决这个问题，通过一个庞大的二进制数组，走哈希思想去判断当前这个要查询的这个数据是否存在，如果布隆过滤器判断存在，则放行，这个请求会去访问redis，哪怕此时redis中的数据过期了，但是数据库中一定存在这个数据，在数据库中查询出来这个数据后，再将其放入到redis中，",-1)),s[502]||(s[502]=i("p",null,"假设布隆过滤器判断这个数据不存在，则直接返回",-1)),s[503]||(s[503]=i("p",null,"这种方式优点在于节约内存空间，存在误判，误判原因在于：布隆过滤器走的是哈希思想，只要哈希思想，就可能存在哈希冲突",-1)),s[504]||(s[504]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653326156516.png",alt:"1653326156516",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[505]||(s[505]=i("h4",{id:"_2-6-编码解决商品查询的缓存穿透问题",tabindex:"-1"},[l("2.6 编码解决商品查询的缓存穿透问题： "),i("a",{class:"header-anchor",href:"#_2-6-编码解决商品查询的缓存穿透问题","aria-label":'Permalink to "2.6 编码解决商品查询的缓存穿透问题："'},"​")],-1)),s[506]||(s[506]=i("p",null,"核心思路如下：",-1)),s[507]||(s[507]=i("p",null,"在原来的逻辑中，我们如果发现这个数据在mysql中不存在，直接就返回404了，这样是会存在缓存穿透问题的",-1)),s[508]||(s[508]=i("p",null,"现在的逻辑中：如果这个数据不存在，我们不会返回404 ，还是会把这个数据写入到Redis中，并且将value设置为空，欧当再次发起查询时，我们如果发现命中之后，判断这个value是否是null，如果是null，则是之前写入的数据，证明是缓存穿透数据，如果不是，则直接返回数据。",-1)),s[509]||(s[509]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653327124561.png",alt:"1653327124561",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[510]||(s[510]=i("p",null,[i("strong",null,"小总结：")],-1)),s[511]||(s[511]=i("p",null,"缓存穿透产生的原因是什么？",-1)),s[512]||(s[512]=i("ul",null,[i("li",null,"用户请求的数据在缓存中和数据库中都不存在，不断发起这样的请求，给数据库带来巨大压力")],-1)),s[513]||(s[513]=i("p",null,"缓存穿透的解决方案有哪些？",-1)),s[514]||(s[514]=i("ul",null,[i("li",null,"缓存null值"),i("li",null,"布隆过滤"),i("li",null,"增强id的复杂度，避免被猜测id规律"),i("li",null,"做好数据的基础格式校验"),i("li",null,"加强用户权限校验"),i("li",null,"做好热点参数的限流")],-1)),s[515]||(s[515]=i("h4",{id:"_2-7-缓存雪崩问题及解决思路",tabindex:"-1"},[l("2.7 缓存雪崩问题及解决思路 "),i("a",{class:"header-anchor",href:"#_2-7-缓存雪崩问题及解决思路","aria-label":'Permalink to "2.7 缓存雪崩问题及解决思路"'},"​")],-1)),s[516]||(s[516]=i("p",null,"缓存雪崩是指在同一时段大量的缓存key同时失效或者Redis服务宕机，导致大量请求到达数据库，带来巨大压力。",-1)),s[517]||(s[517]=i("p",null,"解决方案：",-1)),s[518]||(s[518]=i("ul",null,[i("li",null,"给不同的Key的TTL添加随机值"),i("li",null,"利用Redis集群提高服务的可用性"),i("li",null,"给缓存业务添加降级限流策略"),i("li",null,"给业务添加多级缓存")],-1)),s[519]||(s[519]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653327884526.png",alt:"1653327884526",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[520]||(s[520]=i("h4",{id:"_2-8-缓存击穿问题及解决思路",tabindex:"-1"},[l("2.8 缓存击穿问题及解决思路 "),i("a",{class:"header-anchor",href:"#_2-8-缓存击穿问题及解决思路","aria-label":'Permalink to "2.8 缓存击穿问题及解决思路"'},"​")],-1)),s[521]||(s[521]=i("p",null,"缓存击穿问题也叫热点Key问题，就是一个被高并发访问并且缓存重建业务较复杂的key突然失效了，无数的请求访问会在瞬间给数据库带来巨大的冲击。",-1)),s[522]||(s[522]=i("p",null,"常见的解决方案有两种：",-1)),s[523]||(s[523]=i("ul",null,[i("li",null,"互斥锁"),i("li",null,"逻辑过期")],-1)),s[524]||(s[524]=i("p",null,"逻辑分析：假设线程1在查询缓存之后，本来应该去查询数据库，然后把这个数据重新加载到缓存的，此时只要线程1走完这个逻辑，其他线程就都能从缓存中加载这些数据了，但是假设在线程1没有走完的时候，后续的线程2，线程3，线程4同时过来访问当前这个方法， 那么这些线程都不能从缓存中查询到数据，那么他们就会同一时刻来访问查询缓存，都没查到，接着同一时间去访问数据库，同时的去执行数据库代码，对数据库访问压力过大",-1)),s[525]||(s[525]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653328022622.png",alt:"1653328022622",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[526]||(s[526]=i("p",null,[i("strong",null,"解决方案一：使用锁来解决")],-1)),s[527]||(s[527]=i("p",null,"因为锁能实现互斥性。假设线程过来，只能一个人一个人的来访问数据库，从而避免对于数据库访问压力过大，但这也会影响查询的性能，因为此时会让查询的性能从并行变成了串行，我们可以采用tryLock方法 + double check来解决这样的问题。",-1)),s[528]||(s[528]=i("p",null,"假设现在线程1过来访问，他查询缓存没有命中，但是此时他获得到了锁的资源，那么线程1就会一个人去执行逻辑，假设现在线程2过来，线程2在执行过程中，并没有获得到锁，那么线程2就可以进行到休眠，直到线程1把锁释放后，线程2获得到锁，然后再来执行逻辑，此时就能够从缓存中拿到数据了。",-1)),s[529]||(s[529]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653328288627.png",alt:"1653328288627",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[530]||(s[530]=i("p",null,[i("strong",null,"解决方案二：逻辑过期方案")],-1)),s[531]||(s[531]=i("p",null,"方案分析：我们之所以会出现这个缓存击穿问题，主要原因是在于我们对key设置了过期时间，假设我们不设置过期时间，其实就不会有缓存击穿的问题，但是不设置过期时间，这样数据不就一直占用我们内存了吗，我们可以采用逻辑过期方案。",-1)),s[532]||(s[532]=i("p",null,"我们把过期时间设置在 redis的value中，注意：这个过期时间并不会直接作用于redis，而是我们后续通过逻辑去处理。假设线程1去查询缓存，然后从value中判断出来当前的数据已经过期了，此时线程1去获得互斥锁，那么其他线程会进行阻塞，获得了锁的线程他会开启一个 线程去进行 以前的重构数据的逻辑，直到新开的线程完成这个逻辑后，才释放锁， 而线程1直接进行返回，假设现在线程3过来访问，由于线程线程2持有着锁，所以线程3无法获得锁，线程3也直接返回数据，只有等到新开的线程2把重建数据构建完后，其他线程才能走返回正确的数据。",-1)),s[533]||(s[533]=i("p",null,"这种方案巧妙在于，异步的构建缓存，缺点在于在构建完缓存之前，返回的都是脏数据。",-1)),s[534]||(s[534]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653328663897.png",alt:"1653328663897",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[535]||(s[535]=i("p",null,"进行对比",-1)),s[536]||(s[536]=i("p",null,"**互斥锁方案：**由于保证了互斥性，所以数据一致，且实现简单，因为仅仅只需要加一把锁而已，也没其他的事情需要操心，所以没有额外的内存消耗，缺点在于有锁就有死锁问题的发生，且只能串行执行性能肯定受到影响",-1)),s[537]||(s[537]=i("p",null,[i("strong",null,"逻辑过期方案："),l(" 线程读取过程中不需要等待，性能好，有一个额外的线程持有锁去进行重构数据，但是在重构数据完成前，其他的线程只能返回之前的数据，且实现起来麻烦")],-1)),s[538]||(s[538]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653357522914.png",alt:"1653357522914",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[539]||(s[539]=i("h4",{id:"_2-9-利用互斥锁解决缓存击穿问题",tabindex:"-1"},[l("2.9 利用互斥锁解决缓存击穿问题 "),i("a",{class:"header-anchor",href:"#_2-9-利用互斥锁解决缓存击穿问题","aria-label":'Permalink to "2.9 利用互斥锁解决缓存击穿问题"'},"​")],-1)),s[540]||(s[540]=i("p",null,"核心思路：相较于原来从缓存中查询不到数据后直接查询数据库而言，现在的方案是 进行查询之后，如果从缓存没有查询到数据，则进行互斥锁的获取，获取互斥锁后，判断是否获得到了锁，如果没有获得到，则休眠，过一会再进行尝试，直到获取到锁为止，才能进行查询",-1)),s[541]||(s[541]=i("p",null,"如果获取到了锁的线程，再去进行查询，查询后将数据写入redis，再释放锁，返回数据，利用互斥锁就能保证只有一个线程去执行操作数据库的逻辑，防止缓存击穿",-1)),s[542]||(s[542]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653357860001.png",alt:"1653357860001",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[543]||(s[543]=i("p",null,[i("strong",null,"操作锁的代码：")],-1)),s[544]||(s[544]=i("p",null,"核心思路就是利用redis的setnx方法来表示获取锁，该方法含义是redis中如果没有这个key，则插入成功，返回1，在stringRedisTemplate中返回true， 如果有这个key则插入失败，则返回0，在stringRedisTemplate返回false，我们可以通过true，或者是false，来表示是否有线程成功插入key，成功插入的key的线程我们认为他就是获得到锁的线程。",-1)),s[545]||(s[545]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Boolean flag "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIfAbsent"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit.SECONDS);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BooleanUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isTrue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(flag);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"delete"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[546]||(s[546]=i("p",null,[i("strong",null,"操作代码：")],-1)),s[547]||(s[547]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Shop "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithMutex"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id)  {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CACHE_SHOP_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1、从redis中查询商铺缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String shopJson "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"key"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2、判断是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotBlank"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopJson)) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 存在,直接返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopJson, Shop.class);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //判断命中的值是否是空值")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (shopJson "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //返回一个错误信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.实现缓存重构")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //4.1 获取互斥锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String lockKey "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "lock:shop:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Shop shop "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.2 判断否获取成功")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isLock){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //4.3 失败，则休眠重试")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"50"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," queryWithMutex"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //4.4 成功，根据id查询数据库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"             shop "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 5.不存在，返回错误")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shop "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                 //将空值写入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key,"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",CACHE_NULL_TTL,TimeUnit.MINUTES);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //返回错误信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //6.写入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key,JSONUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJsonStr"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shop),CACHE_NULL_TTL,TimeUnit.MINUTES);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        finally"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //7.释放互斥锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shop;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[548]||(s[548]=i("h4",{id:"_3-0-利用逻辑过期解决缓存击穿问题",tabindex:"-1"},[l("3.0 利用逻辑过期解决缓存击穿问题 "),i("a",{class:"header-anchor",href:"#_3-0-利用逻辑过期解决缓存击穿问题","aria-label":'Permalink to "3.0 利用逻辑过期解决缓存击穿问题"'},"​")],-1)),s[549]||(s[549]=i("p",null,[i("strong",null,"需求：修改根据id查询商铺的业务，基于逻辑过期方式来解决缓存击穿问题")],-1)),s[550]||(s[550]=i("p",null,"思路分析：当用户开始查询redis时，判断是否命中，如果没有命中则直接返回空数据，不查询数据库，而一旦命中后，将value取出，判断value中的过期时间是否满足，如果没有过期，则直接返回redis中的数据，如果过期，则在开启独立线程后直接返回之前的数据，独立线程去重构数据，重构完成后释放互斥锁。",-1)),s[551]||(s[551]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653360308731.png",alt:"1653360308731",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[552]||(s[552]=i("p",null,"如果封装数据：因为现在redis中存储的数据的value需要带上过期时间，此时要么你去修改原来的实体类，要么你",-1)),s[553]||(s[553]=i("p",null,[i("strong",null,"步骤一"),l("：")],-1)),s[554]||(s[554]=i("p",null,"新建一个实体类，我们采用第二个方案，这个方案，对原来代码没有侵入性。",-1)),s[555]||(s[555]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Data")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisData"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalDateTime expireTime;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Object data;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[556]||(s[556]=i("p",null,[i("strong",null,"步骤二"),l("：")],-1)),s[557]||(s[557]=i("p",null,[l("在"),i("strong",null,"ShopServiceImpl"),l(" 新增此方法，利用单元测试进行缓存预热")],-1)),s[558]||(s[558]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653360807133.png",alt:"1653360807133",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[559]||(s[559]=i("p",null,[i("strong",null,"在测试类中")],-1)),s[560]||(s[560]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653360864839.png",alt:"1653360864839",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[561]||(s[561]=i("p",null,[i("strong",null,"步骤三：正式代码")],-1)),s[562]||(s[562]=i("p",null,[i("strong",null,"ShopServiceImpl")],-1)),s[563]||(s[563]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExecutorService CACHE_REBUILD_EXECUTOR "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Executors."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newFixedThreadPool"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Shop "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithLogicalExpire"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"( Long id ) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CACHE_SHOP_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.从redis查询商铺缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.判断是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBlank"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json)) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.存在，直接返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.命中，需要先把json反序列化为对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    RedisData redisData "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json, RedisData.class);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Shop shop "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((JSONObject) redisData."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getData"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), Shop.class);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    LocalDateTime expireTime "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisData."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getExpireTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.判断是否过期")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(expireTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.1.未过期，直接返回店铺信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shop;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.2.已过期，需要缓存重建")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.缓存重建")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.1.获取互斥锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String lockKey "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LOCK_SHOP_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.2.判断是否获取锁成功")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isLock){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        CACHE_REBUILD_EXECUTOR."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"( ()"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //重建缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"                this"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveShop2Redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id,"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20L"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                throw"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.4.返回过期的商铺信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shop;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[564]||(s[564]=i("h4",{id:"_3-1-封装-redis-工具类",tabindex:"-1"},[l("3.1 封装 Redis 工具类 "),i("a",{class:"header-anchor",href:"#_3-1-封装-redis-工具类","aria-label":'Permalink to "3.1 封装 Redis 工具类"'},"​")],-1)),s[565]||(s[565]=i("p",null,"基于StringRedisTemplate封装一个缓存工具类，满足下列需求：",-1)),s[566]||(s[566]=i("ul",null,[i("li",null,[i("p",null,"方法1：将任意Java对象序列化为json并存储在string类型的key中，并且可以设置TTL过期时间")]),i("li",null,[i("p",null,"方法2：将任意Java对象序列化为json并存储在string类型的key中，并且可以设置逻辑过期时间，用于处理缓存击穿问题")]),i("li",null,[i("p",null,"方法3：根据指定的key查询缓存，并反序列化为指定类型，利用缓存空值的方式解决缓存穿透问题")]),i("li",null,[i("p",null,"方法4：根据指定的key查询缓存，并反序列化为指定类型，需要利用逻辑过期解决缓存击穿问题将逻辑进行封装")])],-1)),s[567]||(s[567]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Slf4j")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CacheClient"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate stringRedisTemplate;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExecutorService CACHE_REBUILD_EXECUTOR "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Executors."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newFixedThreadPool"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CacheClient"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StringRedisTemplate "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"stringRedisTemplate"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".stringRedisTemplate "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"key"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"value"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Long "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"time"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, JSONUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJsonStr"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value), time, unit);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setWithLogicalExpire"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"key"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Object "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"value"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Long "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"time"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置逻辑过期")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RedisData redisData "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisData"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisData."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setData"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisData."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setExpireTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"plusSeconds"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(unit."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toSeconds"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(time)));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写入Redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, JSONUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJsonStr"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(redisData));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," <"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> R "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithPassThrough"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"keyPrefix"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ID "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Class<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"type"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Function<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"dbFallback"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Long "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"time"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keyPrefix "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.从redis查询商铺缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotBlank"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json)) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.存在，直接返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json, type);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 判断命中的是否是空值")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 返回一个错误信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.不存在，根据id查询数据库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        R r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dbFallback."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"apply"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.不存在，返回错误")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 将空值写入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", CACHE_NULL_TTL, TimeUnit.MINUTES);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 返回错误信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.存在，写入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, r, time, unit);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," <"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> R "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithLogicalExpire"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"keyPrefix"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ID "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Class<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"type"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Function<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"dbFallback"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Long "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"time"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keyPrefix "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.从redis查询商铺缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBlank"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json)) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.存在，直接返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.命中，需要先把json反序列化为对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RedisData redisData "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json, RedisData.class);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        R r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((JSONObject) redisData."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getData"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), type);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        LocalDateTime expireTime "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisData."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getExpireTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.判断是否过期")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(expireTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 5.1.未过期，直接返回店铺信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.2.已过期，需要缓存重建")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.缓存重建")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.1.获取互斥锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String lockKey "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LOCK_SHOP_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.2.判断是否获取锁成功")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isLock){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 6.3.成功，开启独立线程，实现缓存重建")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            CACHE_REBUILD_EXECUTOR."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 查询数据库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    R newR "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dbFallback."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"apply"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 重建缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"                    this"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setWithLogicalExpire"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, newR, time, unit);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    throw"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 释放锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                    unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            });")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.4.返回过期的商铺信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," <"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> R "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithMutex"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"keyPrefix"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ID "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Class<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"type"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Function<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ID"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"R"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"dbFallback"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Long "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"time"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keyPrefix "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.从redis查询商铺缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String shopJson "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StrUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotBlank"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopJson)) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.存在，直接返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JSONUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toBean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopJson, type);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 判断命中的是否是空值")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (shopJson "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 返回一个错误信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.实现缓存重建")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.1.获取互斥锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String lockKey "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LOCK_SHOP_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        R r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.2.判断是否获取成功")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isLock) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 4.3.获取锁失败，休眠并重试")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"50"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," queryWithMutex"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(keyPrefix, id, type, dbFallback, time, unit);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.4.获取锁成功，根据id查询数据库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dbFallback."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"apply"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 5.不存在，返回错误")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 将空值写入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", CACHE_NULL_TTL, TimeUnit.MINUTES);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 返回错误信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 6.存在，写入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"            this"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, r, time, unit);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (InterruptedException "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 7.释放锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockKey);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 8.返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"key"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Boolean flag "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIfAbsent"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit.SECONDS);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BooleanUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isTrue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(flag);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"key"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"delete"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[568]||(s[568]=i("p",null,"在ShopServiceImpl 中",-1)),s[569]||(s[569]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Resource")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CacheClient cacheClient;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 解决缓存穿透")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Shop shop "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cacheClient")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryWithPassThrough"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CACHE_SHOP_KEY, id, Shop.class, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 互斥锁解决缓存击穿")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // Shop shop = cacheClient")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //         .queryWithMutex(CACHE_SHOP_KEY, id, Shop.class, this::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 逻辑过期解决缓存击穿")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // Shop shop = cacheClient")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //         .queryWithLogicalExpire(CACHE_SHOP_KEY, id, Shop.class, this::getById, 20L, TimeUnit.SECONDS);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (shop "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"店铺不存在！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shop);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[570]||(s[570]=i("hr",null,null,-1)),s[571]||(s[571]=i("h3",{id:"_3-优惠卷秒杀",tabindex:"-1"},[l("3. 优惠卷秒杀 "),i("a",{class:"header-anchor",href:"#_3-优惠卷秒杀","aria-label":'Permalink to "3. 优惠卷秒杀"'},"​")],-1)),s[572]||(s[572]=i("h4",{id:"_3-1-全局唯一id",tabindex:"-1"},[l("3.1 全局唯一ID "),i("a",{class:"header-anchor",href:"#_3-1-全局唯一id","aria-label":'Permalink to "3.1 全局唯一ID"'},"​")],-1)),s[573]||(s[573]=i("p",null,"每个店铺都可以发布优惠券：",-1)),s[574]||(s[574]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653362612286.png",alt:"1653362612286",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[575]||(s[575]=i("p",null,[l("当用户抢购时，就会生成订单并保存到"),i("code",null,"tb_voucher_order"),l("这张表中，而订单表如果使用数据库自增ID就存在一些问题：")],-1)),s[576]||(s[576]=i("ul",null,[i("li",null,"id的规律性太明显"),i("li",null,"受单表数据量的限制")],-1)),s[577]||(s[577]=i("p",null,"场景分析：如果我们的id具有太明显的规则，用户或者说商业对手很容易猜测出来我们的一些敏感信息，比如商城在一天时间内，卖出了多少单，这明显不合适。",-1)),s[578]||(s[578]=i("p",null,"场景分析二：随着我们商城规模越来越大，mysql的单表的容量不宜超过500W，数据量过大之后，我们要进行拆库拆表，但拆分表了之后，他们从逻辑上讲他们是同一张表，所以他们的id是不能一样的， 于是乎我们需要保证id的唯一性。",-1)),s[579]||(s[579]=i("p",null,[i("strong",null,"全局ID生成器"),l("，是一种在分布式系统下用来生成全局唯一ID的工具，一般要满足下列特性：")],-1)),s[580]||(s[580]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653363100502.png",alt:"1653363100502",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[581]||(s[581]=i("p",null,"为了增加ID的安全性，我们可以不直接使用Redis自增的数值，而是拼接一些其它信息：",-1)),s[582]||(s[582]=i("p",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653363172079.png",alt:"1653363172079"}),l("ID的组成部分：符号位：1bit，永远为0")],-1)),s[583]||(s[583]=i("p",null,"时间戳：31bit，以秒为单位，可以使用69年",-1)),s[584]||(s[584]=i("p",null,"序列号：32bit，秒内的计数器，支持每秒产生2^32个不同ID",-1)),s[585]||(s[585]=i("h4",{id:"_3-2-redis-实现全局唯一id",tabindex:"-1"},[l("3.2 Redis 实现全局唯一Id "),i("a",{class:"header-anchor",href:"#_3-2-redis-实现全局唯一id","aria-label":'Permalink to "3.2 Redis 实现全局唯一Id"'},"​")],-1)),s[586]||(s[586]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisIdWorker"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 开始时间戳")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BEGIN_TIMESTAMP "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1640995200L"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 序列号的位数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," COUNT_BITS "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 32"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate stringRedisTemplate;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisIdWorker"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StringRedisTemplate "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"stringRedisTemplate"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".stringRedisTemplate "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nextId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"keyPrefix"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.生成时间戳")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        LocalDateTime now "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," nowSecond "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toEpochSecond"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ZoneOffset.UTC);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," timestamp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," nowSecond "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BEGIN_TIMESTAMP;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.生成序列号")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.1.获取当前日期，精确到天")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String date "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"format"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(DateTimeFormatter."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ofPattern"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"yyyy:MM:dd"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.2.自增长")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"increment"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"icr:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keyPrefix "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ":"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," date);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.拼接并返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," timestamp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<<"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," COUNT_BITS "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"|"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[587]||(s[587]=i("p",null,"测试类",-1)),s[588]||(s[588]=i("p",null,"知识小贴士：关于countdownlatch",-1)),s[589]||(s[589]=i("p",null,"countdownlatch名为信号枪：主要的作用是同步协调在多线程的等待于唤醒问题",-1)),s[590]||(s[590]=i("p",null,"我们如果没有CountDownLatch ，那么由于程序是异步的，当异步程序没有执行完时，主线程就已经执行完了，然后我们期望的是分线程全部走完之后，主线程再走，所以我们此时需要使用到CountDownLatch",-1)),s[591]||(s[591]=i("p",null,"CountDownLatch 中有两个最重要的方法",-1)),s[592]||(s[592]=i("p",null,"1、countDown",-1)),s[593]||(s[593]=i("p",null,"2、await",-1)),s[594]||(s[594]=i("p",null,"await 方法 是阻塞方法，我们担心分线程没有执行完时，main线程就先执行，所以使用await可以让main线程阻塞，那么什么时候main线程不再阻塞呢？当CountDownLatch 内部维护的 变量变为0时，就不再阻塞，直接放行，那么什么时候CountDownLatch 维护的变量变为0 呢，我们只需要调用一次countDown ，内部变量就减少1，我们让分线程和变量绑定， 执行完一个分线程就减少一个变量，当分线程全部走完，CountDownLatch 维护的变量就是0，此时await就不再阻塞，统计出来的时间也就是所有分线程执行完后的时间。",-1)),s[595]||(s[595]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testIdWorker"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws InterruptedException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CountDownLatch latch "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CountDownLatch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"300"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Runnable task "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," () "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        latch."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"countDown"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    };")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," begin "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 300"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        es."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(task);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    latch."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"await"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," end "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"time = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (end "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," begin));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[596]||(s[596]=i("h4",{id:"_3-3-添加优惠卷",tabindex:"-1"},[l("3.3 添加优惠卷 "),i("a",{class:"header-anchor",href:"#_3-3-添加优惠卷","aria-label":'Permalink to "3.3 添加优惠卷"'},"​")],-1)),s[597]||(s[597]=i("p",null,"每个店铺都可以发布优惠券，分为平价券和特价券。平价券可以任意购买，而特价券需要秒杀抢购：",-1)),s[598]||(s[598]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653365145124.png",alt:"1653365145124",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[599]||(s[599]=i("p",null,[i("code",null,"tb_voucher"),l("：优惠券的基本信息，优惠金额、使用规则等 "),i("code",null,"tb_seckill_voucher"),l("：优惠券的库存、开始抢购时间，结束抢购时间。特价优惠券才需要填写这些信息")],-1)),s[600]||(s[600]=i("p",null,"平价卷由于优惠力度并不是很大，所以是可以任意领取",-1)),s[601]||(s[601]=i("p",null,"而代金券由于优惠力度大，所以像第二种卷，就得限制数量，从表结构上也能看出，特价卷除了具有优惠卷的基本信息以外，还具有库存，抢购时间，结束时间等等字段",-1)),s[602]||(s[602]=i("p",null,"**新增普通卷代码： **VoucherController",-1)),s[603]||(s[603]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestBody"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Voucher voucher) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[604]||(s[604]=i("p",null,[i("strong",null,"新增秒杀卷代码：")],-1)),s[605]||(s[605]=i("p",null,[i("strong",null,"VoucherController")],-1)),s[606]||(s[606]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"seckill"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addSeckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestBody"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Voucher voucher) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addSeckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[607]||(s[607]=i("p",null,[i("strong",null,"VoucherServiceImpl")],-1)),s[608]||(s[608]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addSeckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Voucher voucher) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存优惠券")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存秒杀信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SeckillVoucher seckillVoucher "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SeckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setBeginTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setEndTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(seckillVoucher);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存秒杀库存到Redis中")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SECKILL_STOCK_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[609]||(s[609]=i("h4",{id:"_3-4-实现秒杀下单",tabindex:"-1"},[l("3.4 实现秒杀下单 "),i("a",{class:"header-anchor",href:"#_3-4-实现秒杀下单","aria-label":'Permalink to "3.4 实现秒杀下单"'},"​")],-1)),s[610]||(s[610]=i("p",null,"下单核心思路：当我们点击抢购时，会触发右侧的请求，我们只需要编写对应的controller即可",-1)),s[611]||(s[611]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653365839526.png",alt:"1653365839526",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[612]||(s[612]=i("p",null,"秒杀下单应该思考的内容：",-1)),s[613]||(s[613]=i("p",null,"下单时需要判断两点：",-1)),s[614]||(s[614]=i("ul",null,[i("li",null,"秒杀是否开始或结束，如果尚未开始或已经结束则无法下单"),i("li",null,"库存是否充足，不足则无法下单")],-1)),s[615]||(s[615]=i("p",null,"下单核心逻辑分析：",-1)),s[616]||(s[616]=i("p",null,"当用户开始进行下单，我们应当去查询优惠卷信息，查询到优惠卷信息，判断是否满足秒杀条件",-1)),s[617]||(s[617]=i("p",null,"比如时间是否充足，如果时间充足，则进一步判断库存是否足够，如果两者都满足，则扣减库存，创建订单，然后返回订单id，如果有一个条件不满足则直接结束。",-1)),s[618]||(s[618]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653366238564.png",alt:"1653366238564",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[619]||(s[619]=i("p",null,[i("strong",null,"VoucherOrderServiceImpl")],-1)),s[620]||(s[620]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.查询优惠券")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SeckillVoucher voucher "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.判断秒杀是否开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 尚未开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀尚未开始！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.判断秒杀是否已经结束")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBefore"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 尚未开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀已经结束！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.判断库存是否充足")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 库存不足")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //5，扣减库存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock= stock -1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //扣减库存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //6.创建订单")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    VoucherOrder voucherOrder "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.1.订单id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.2.用户id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.3.代金券id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[621]||(s[621]=i("h4",{id:"_3-5-库存超卖问题分析",tabindex:"-1"},[l("3.5 库存超卖问题分析 "),i("a",{class:"header-anchor",href:"#_3-5-库存超卖问题分析","aria-label":'Permalink to "3.5 库存超卖问题分析"'},"​")],-1)),s[622]||(s[622]=i("p",null,"有关超卖问题分析：在我们原有代码中是这么写的",-1)),s[623]||(s[623]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 库存不足")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //5，扣减库存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock= stock -1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //扣减库存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[624]||(s[624]=i("p",null,"假设线程1过来查询库存，判断出来库存大于1，正准备去扣减库存，但是还没有来得及去扣减，此时线程2过来，线程2也去查询库存，发现这个数量一定也大于1，那么这两个线程都会去扣减库存，最终多个线程相当于一起去扣减库存，此时就会出现库存的超卖问题。",-1)),s[625]||(s[625]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653368335155.png",alt:"1653368335155",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[626]||(s[626]=i("p",null,"超卖问题是典型的多线程安全问题，针对这一问题的常见解决方案就是加锁：而对于加锁，我们通常有两种解决方案：见下图：",-1)),s[627]||(s[627]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653368562591.png",alt:"1653368562591",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[628]||(s[628]=i("p",null,[i("strong",null,"悲观锁：")],-1)),s[629]||(s[629]=i("p",null,"悲观锁可以实现对于数据的串行化执行，比如syn，和lock都是悲观锁的代表，同时，悲观锁中又可以再细分为公平锁，非公平锁，可重入锁，等等",-1)),s[630]||(s[630]=i("p",null,[i("strong",null,"乐观锁：")],-1)),s[631]||(s[631]=i("p",null,"乐观锁：会有一个版本号，每次操作数据会对版本号+1，再提交回数据时，会去校验是否比之前的版本大1 ，如果大1 ，则进行操作成功，这套机制的核心逻辑在于，如果在操作过程中，版本号只比原来大1 ，那么就意味着操作过程中没有人对他进行过修改，他的操作就是安全的，如果不大1，则数据被修改过，当然乐观锁还有一些变种的处理方式比如cas",-1)),s[632]||(s[632]=i("p",null,"乐观锁的典型代表：就是cas，利用cas进行无锁化机制加锁，var5 是操作前读取的内存值，while中的var1+var2 是预估值，如果预估值 == 内存值，则代表中间没有被人修改过，此时就将新值去替换 内存值",-1)),s[633]||(s[633]=i("p",null,"其中do while 是为了在操作失败时，再次进行自旋操作，即把之前的逻辑再操作一次。",-1)),s[634]||(s[634]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," var5;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"do"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    var5 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIntVolatile"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(var1, var2);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"while"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSwapInt"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(var1, var2, var5, var5 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," var4));")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," var5;")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[635]||(s[635]=i("p",null,[i("strong",null,"课程中的使用方式：")],-1)),s[636]||(s[636]=i("p",null,"课程中的使用方式是没有像cas一样带自旋的操作，也没有对version的版本号+1 ，他的操作逻辑是在操作时，对版本号进行+1 操作，然后要求version 如果是1 的情况下，才能操作，那么第一个线程在操作后，数据库中的version变成了2，但是他自己满足version=1 ，所以没有问题，此时线程2执行，线程2 最后也需要加上条件version =1 ，但是现在由于线程1已经操作过了，所以线程2，操作时就不满足version=1 的条件了，所以线程2无法执行成功",-1)),s[637]||(s[637]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653369268550.png",alt:"1653369268550",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[638]||(s[638]=i("h4",{id:"_3-6-乐观锁解决超卖问题",tabindex:"-1"},[l("3.6 乐观锁解决超卖问题 "),i("a",{class:"header-anchor",href:"#_3-6-乐观锁解决超卖问题","aria-label":'Permalink to "3.6 乐观锁解决超卖问题"'},"​")],-1)),s[639]||(s[639]=i("p",null,[i("strong",null,"修改代码方案一"),l("：")],-1)),s[640]||(s[640]=i("p",null,"VoucherOrderServiceImpl 在扣减库存时，改为：",-1)),s[641]||(s[641]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock= stock -1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//set stock = stock -1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(); "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//where id = ？ and stock = ?")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[642]||(s[642]=i("p",null,"以上逻辑的核心含义是：只要我扣减库存时的库存和之前我查询到的库存是一样的，就意味着没有人在中间修改过库存，那么此时就是安全的，但是以上这种方式通过测试发现会有很多失败的情况，失败的原因在于：在使用乐观锁过程中假设100个线程同时都拿到了100的库存，然后大家一起去进行扣减，但是100个人中只有1个人能扣减成功，其他的人在处理时，他们在扣减时，库存已经被修改过了，所以此时其他线程都会失败",-1)),s[643]||(s[643]=i("p",null,[i("strong",null,"修改代码方案二"),l("：")],-1)),s[644]||(s[644]=i("p",null,"之前的方式要修改前后都保持一致，但是这样我们分析过，成功的概率太低，所以我们的乐观锁需要变一下，改成stock大于0 即可",-1)),s[645]||(s[645]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock= stock -1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gt"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"); "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//where id = ? and stock > 0")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[646]||(s[646]=i("p",null,[i("strong",null,"知识小扩展：")],-1)),s[647]||(s[647]=i("p",null,"针对cas中的自旋压力过大，我们可以使用Longaddr这个类去解决",-1)),s[648]||(s[648]=i("p",null,"Java8 提供的一个对AtomicLong改进后的一个类，LongAdder",-1)),s[649]||(s[649]=i("p",null,"大量线程并发更新一个原子性的时候，天然的问题就是自旋，会导致并发性问题，当然这也比我们直接使用syn来的好",-1)),s[650]||(s[650]=i("p",null,"所以利用这么一个类，LongAdder来进行优化",-1)),s[651]||(s[651]=i("p",null,"如果获取某个值，则会对cell和base的值进行递增，最后返回一个完整的值",-1)),s[652]||(s[652]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653370271627.png",alt:"1653370271627",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[653]||(s[653]=i("h4",{id:"_3-6-优惠券秒杀-一人一单",tabindex:"-1"},[l("3.6 优惠券秒杀 - 一人一单 "),i("a",{class:"header-anchor",href:"#_3-6-优惠券秒杀-一人一单","aria-label":'Permalink to "3.6 优惠券秒杀 - 一人一单"'},"​")],-1)),s[654]||(s[654]=i("p",null,"需求：修改秒杀业务，要求同一个优惠券，一个用户只能下一单",-1)),s[655]||(s[655]=i("p",null,[i("strong",null,"现在的问题在于：")],-1)),s[656]||(s[656]=i("p",null,"优惠卷是为了引流，但是目前的情况是，一个人可以无限制的抢这个优惠卷，所以我们应当增加一层逻辑，让一个用户只能下一个单，而不是让一个用户下多个单",-1)),s[657]||(s[657]=i("p",null,"具体操作逻辑如下：比如时间是否充足，如果时间充足，则进一步判断库存是否足够，然后再根据优惠卷id和用户id查询是否已经下过这个订单，如果下过这个订单，则不再下单，否则进行下单",-1)),s[658]||(s[658]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653371854389.png",alt:"1653371854389",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[659]||(s[659]=i("p",null,[i("strong",null,"VoucherOrderServiceImpl")],-1)),s[660]||(s[660]=i("p",null,[i("strong",null,"初步代码：增加一人一单逻辑")],-1)),s[661]||(s[661]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.查询优惠券")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SeckillVoucher voucher "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.判断秒杀是否开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 尚未开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀尚未开始！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.判断秒杀是否已经结束")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBefore"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 尚未开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀已经结束！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.判断库存是否充足")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 库存不足")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.一人一单逻辑")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.1.用户id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.2.判断是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 用户已经购买过了")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"用户已经购买过一次！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //6，扣减库存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock= stock -1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //扣减库存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //7.创建订单")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    VoucherOrder voucherOrder "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.1.订单id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 7.3.代金券id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[662]||(s[662]=i("p",null,"**存在问题：**现在的问题还是和之前一样，并发过来，查询数据库，都不存在订单，所以我们还是需要加锁，但是乐观锁比较适合更新数据，而现在是插入数据，所以我们需要使用悲观锁操作",-1)),s[663]||(s[663]=i("p",null,"**注意：**在这里提到了非常多的问题，我们需要慢慢的来思考，首先我们的初始方案是封装了一个createVoucherOrder方法，同时为了确保他线程安全，在方法上添加了一把synchronized 锁，",-1)),s[664]||(s[664]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," synchronized"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createVoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         // 5.1.查询订单")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.2.判断是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 用户已经购买过了")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"用户已经购买过一次！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.扣减库存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock = stock - 1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// set stock = stock - 1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gt"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// where id = ? and stock > 0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 扣减失败")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.创建订单")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        VoucherOrder voucherOrder "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.1.订单id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.2.用户id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.3.代金券id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.返回订单id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[665]||(s[665]=i("p",null,[l("但是这样添加锁，锁的粒度太粗了，在使用锁过程中，控制"),i("strong",null,"锁粒度"),l(" 是一个非常重要的事情，因为如果锁的粒度太大，会导致每个线程进来都会锁住，所以我们需要去控制锁的粒度，以下这段代码需要修改为： "),i("code",null,"intern()"),l(" 这个方法是从常量池中拿到数据，如果我们直接使用"),i("code",null,"userId.toString()"),l(" 他拿到的对象实际上是不同的对象，new出来的对象，我们使用锁必须保证锁必须是同一把，所以我们需要使用intern()方法")],-1)),s[666]||(s[666]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createVoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"	synchronized"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"intern"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         // 5.1.查询订单")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.2.判断是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 用户已经购买过了")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"用户已经购买过一次！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.扣减库存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock = stock - 1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// set stock = stock - 1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gt"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// where id = ? and stock > 0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 扣减失败")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.创建订单")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        VoucherOrder voucherOrder "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.1.订单id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.2.用户id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.3.代金券id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 7.返回订单id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[667]||(s[667]=i("p",null,"但是以上代码还是存在问题，问题的原因在于当前方法被spring的事务控制，如果你在方法内部加锁，可能会导致当前方法事务还没有提交，但是锁已经释放也会导致问题，所以我们选择将当前方法整体包裹起来，确保事务不会出现问题：如下：",-1)),s[668]||(s[668]=i("p",null,"在seckillVoucher 方法中，添加以下逻辑，这样就能保证事务的特性，同时也控制了锁的粒度",-1)),s[669]||(s[669]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653373434815.png",alt:"1653373434815",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[670]||(s[670]=i("p",null,"但是以上做法依然有问题，因为你调用的方法，其实是this.的方式调用的，事务想要生效，还得利用代理来生效，所以这个地方，我们需要获得原始的事务对象， 来操作事务",-1)),s[671]||(s[671]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653383810643.png",alt:"1653383810643",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[672]||(s[672]=i("h4",{id:"_3-7-集群环境下的并发问题",tabindex:"-1"},[l("3.7 集群环境下的并发问题 "),i("a",{class:"header-anchor",href:"#_3-7-集群环境下的并发问题","aria-label":'Permalink to "3.7 集群环境下的并发问题"'},"​")],-1)),s[673]||(s[673]=i("p",null,"通过加锁可以解决在单机情况下的一人一单安全问题，但是在集群模式下就不行了。",-1)),s[674]||(s[674]=i("p",null,"1、我们将服务启动两份，端口分别为8081和8082：",-1)),s[675]||(s[675]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653373887844.png",alt:"1653373887844",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[676]||(s[676]=i("p",null,"2、然后修改nginx的conf目录下的nginx.conf文件，配置反向代理和负载均衡：",-1)),s[677]||(s[677]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653373908620.png",alt:"1653373908620",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[678]||(s[678]=i("p",null,[i("strong",null,"具体操作(略)")],-1)),s[679]||(s[679]=i("p",null,[i("strong",null,"有关锁失效原因分析")],-1)),s[680]||(s[680]=i("p",null,"由于现在我们部署了多个tomcat，每个tomcat都有一个属于自己的jvm，那么假设在服务器A的tomcat内部，有两个线程，这两个线程由于使用的是同一份代码，那么他们的锁对象是同一个，是可以实现互斥的，但是如果现在是服务器B的tomcat内部，又有两个线程，但是他们的锁对象写的虽然和服务器A一样，但是锁对象却不是同一个，所以线程3和线程4可以实现互斥，但是却无法和线程1和线程2实现互斥，这就是 集群环境下，syn锁失效的原因，在这种情况下，我们就需要使用分布式锁来解决这个问题。",-1)),s[681]||(s[681]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653374044740.png",alt:"1653374044740",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[682]||(s[682]=i("hr",null,null,-1)),s[683]||(s[683]=i("h3",{id:"_4-分布式锁",tabindex:"-1"},[l("4. 分布式锁 "),i("a",{class:"header-anchor",href:"#_4-分布式锁","aria-label":'Permalink to "4. 分布式锁"'},"​")],-1)),s[684]||(s[684]=i("h4",{id:"_4-1-基本原理和实现方式对比",tabindex:"-1"},[l("4.1 基本原理和实现方式对比 "),i("a",{class:"header-anchor",href:"#_4-1-基本原理和实现方式对比","aria-label":'Permalink to "4.1 基本原理和实现方式对比"'},"​")],-1)),s[685]||(s[685]=i("p",null,"分布式锁：满足分布式系统或集群模式下多进程可见并且互斥的锁。",-1)),s[686]||(s[686]=i("p",null,"分布式锁的核心思想就是让大家都使用同一把锁，只要大家使用的是同一把锁，那么我们就能锁住线程，不让线程进行，让程序串行执行，这就是分布式锁的核心思路",-1)),s[687]||(s[687]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653374296906.png",alt:"1653374296906",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[688]||(s[688]=i("p",null,"那么分布式锁他应该满足一些什么样的条件呢？",-1)),s[689]||(s[689]=i("p",null,"可见性：多个线程都能看到相同的结果，注意：这个地方说的可见性并不是并发编程中指的内存可见性，只是说多个进程之间都能感知到变化的意思",-1)),s[690]||(s[690]=i("p",null,"互斥：互斥是分布式锁的最基本的条件，使得程序串行执行",-1)),s[691]||(s[691]=i("p",null,"高可用：程序不易崩溃，时时刻刻都保证较高的可用性",-1)),s[692]||(s[692]=i("p",null,"高性能：由于加锁本身就让性能降低，所有对于分布式锁本身需要他就较高的加锁性能和释放锁性能",-1)),s[693]||(s[693]=i("p",null,"安全性：安全也是程序中必不可少的一环",-1)),s[694]||(s[694]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653381992018.png",alt:"1653381992018",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[695]||(s[695]=i("p",null,"常见的分布式锁有三种",-1)),s[696]||(s[696]=i("p",null,"Mysql：mysql本身就带有锁机制，但是由于mysql性能本身一般，所以采用分布式锁的情况下，其实使用mysql作为分布式锁比较少见",-1)),s[697]||(s[697]=i("p",null,"Redis：redis作为分布式锁是非常常见的一种使用方式，现在企业级开发中基本都使用redis或者zookeeper作为分布式锁，利用setnx这个方法，如果插入key成功，则表示获得到了锁，如果有人插入成功，其他人插入失败则表示无法获得到锁，利用这套逻辑来实现分布式锁",-1)),s[698]||(s[698]=i("p",null,"Zookeeper：zookeeper也是企业级开发中较好的一个实现分布式锁的方案，由于本套视频并不讲解zookeeper的原理和分布式锁的实现，所以不过多阐述",-1)),s[699]||(s[699]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653382219377.png",alt:"1653382219377",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[700]||(s[700]=i("h4",{id:"_4-2-redis-分布式锁的实现核心思路",tabindex:"-1"},[l("4.2 Redis 分布式锁的实现核心思路 "),i("a",{class:"header-anchor",href:"#_4-2-redis-分布式锁的实现核心思路","aria-label":'Permalink to "4.2 Redis 分布式锁的实现核心思路"'},"​")],-1)),s[701]||(s[701]=i("p",null,"实现分布式锁时需要实现的两个基本方法：",-1)),s[702]||(s[702]=i("ul",null,[i("li",null,[i("p",null,"获取锁："),i("ul",null,[i("li",null,"互斥：确保只能有一个线程获取锁"),i("li",null,"非阻塞：尝试一次，成功返回true，失败返回false")])]),i("li",null,[i("p",null,"释放锁："),i("ul",null,[i("li",null,"手动释放"),i("li",null,"超时释放：获取锁时添加一个超时时间")]),i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653382669900.png",alt:"1653382669900",loading:"lazy",decoding:"async",class:"lazy"})])])],-1)),s[703]||(s[703]=i("p",null,"核心思路：",-1)),s[704]||(s[704]=i("p",null,"我们利用redis 的setNx 方法，当有多个线程进入时，我们就利用该方法，第一个线程进入时，redis 中就有这个key 了，返回了1，如果结果是1，则表示他抢到了锁，那么他去执行业务，然后再删除锁，退出锁逻辑，没有抢到锁的哥们，等待一定时间后重试即可",-1)),s[705]||(s[705]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653382830810.png",alt:"1653382830810",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[706]||(s[706]=i("h4",{id:"_4-3-实现分布式锁版本一",tabindex:"-1"},[l("4.3 实现分布式锁版本一 "),i("a",{class:"header-anchor",href:"#_4-3-实现分布式锁版本一","aria-label":'Permalink to "4.3 实现分布式锁版本一"'},"​")],-1)),s[707]||(s[707]=i("ul",null,[i("li",null,"加锁逻辑")],-1)),s[708]||(s[708]=i("p",null,[i("strong",null,"锁的基本接口")],-1)),s[709]||(s[709]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1656079017728.png",alt:"1656079017728",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[710]||(s[710]=i("p",null,[i("strong",null,"SimpleRedisLock")],-1)),s[711]||(s[711]=i("p",null,"利用setnx方法进行加锁，同时增加过期时间，防止死锁，此方法可以保证加锁和增加过期时间具有原子性",-1)),s[712]||(s[712]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String KEY_PREFIX"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lock:"')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," timeoutSec) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取线程标示")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String threadId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Boolean success "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIfAbsent"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name, threadId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ""'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", timeoutSec, TimeUnit.SECONDS);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean.TRUE."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(success);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[713]||(s[713]=i("ul",null,[i("li",null,"释放锁逻辑")],-1)),s[714]||(s[714]=i("p",null,"SimpleRedisLock",-1)),s[715]||(s[715]=i("p",null,"释放锁，防止删除别人的锁",-1)),s[716]||(s[716]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //通过del删除锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"delete"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[717]||(s[717]=i("ul",null,[i("li",null,"修改业务代码")],-1)),s[718]||(s[718]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.查询优惠券")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SeckillVoucher voucher "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断秒杀是否开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 尚未开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀尚未开始！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.判断秒杀是否已经结束")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBefore"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 尚未开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀已经结束！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.判断库存是否充足")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 库存不足")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //创建锁对象(新增代码)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SimpleRedisLock lock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SimpleRedisLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId, stringRedisTemplate);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //获取锁对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tryLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1200"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"		//加锁失败")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isLock) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"不允许重复下单"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //获取代理对象(事务)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            IVoucherOrderService proxy "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (IVoucherOrderService) AopContext."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentProxy"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," proxy."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createVoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //释放锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            lock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[719]||(s[719]=i("h4",{id:"_4-4-redis-分布式锁误删情况说明",tabindex:"-1"},[l("4.4 Redis 分布式锁误删情况说明 "),i("a",{class:"header-anchor",href:"#_4-4-redis-分布式锁误删情况说明","aria-label":'Permalink to "4.4 Redis 分布式锁误删情况说明"'},"​")],-1)),s[720]||(s[720]=i("p",null,"逻辑说明：",-1)),s[721]||(s[721]=i("p",null,"持有锁的线程在锁的内部出现了阻塞，导致他的锁自动释放，这时其他线程，线程2来尝试获得锁，就拿到了这把锁，然后线程2在持有锁执行过程中，线程1反应过来，继续执行，而线程1执行过程中，走到了删除锁逻辑，此时就会把本应该属于线程2的锁进行删除，这就是误删别人锁的情况说明",-1)),s[722]||(s[722]=i("p",null,"解决方案：解决方案就是在每个线程释放锁的时候，去判断一下当前这把锁是否属于自己，如果属于自己，则不进行锁的删除，假设还是上边的情况，线程1卡顿，锁自动释放，线程2进入到锁的内部执行逻辑，此时线程1反应过来，然后删除锁，但是线程1，一看当前这把锁不是属于自己，于是不进行删除锁逻辑，当线程2走到删除锁逻辑时，如果没有卡过自动释放锁的时间点，则判断当前这把锁是属于自己的，于是删除这把锁。",-1)),s[723]||(s[723]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653385920025.png",alt:"1653385920025",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[724]||(s[724]=i("h4",{id:"_4-5-解决-redis-分布式锁误删问题",tabindex:"-1"},[l("4.5 解决 Redis 分布式锁误删问题 "),i("a",{class:"header-anchor",href:"#_4-5-解决-redis-分布式锁误删问题","aria-label":'Permalink to "4.5 解决 Redis 分布式锁误删问题"'},"​")],-1)),s[725]||(s[725]=i("p",null,"需求：修改之前的分布式锁实现，满足：在获取锁时存入线程标示（可以用UUID表示） 在释放锁时先获取锁中的线程标示，判断是否与当前线程标示一致",-1)),s[726]||(s[726]=i("ul",null,[i("li",null,"如果一致则释放锁"),i("li",null,"如果不一致则不释放锁")],-1)),s[727]||(s[727]=i("p",null,"核心逻辑：在存入锁时，放入自己线程的标识，在删除锁时，判断当前这把锁的标识是不是自己存入的，如果是，则进行删除，如果不是，则不进行删除。",-1)),s[728]||(s[728]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653387398820.png",alt:"1653387398820",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[729]||(s[729]=i("p",null,"具体代码如下：加锁",-1)),s[730]||(s[730]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String ID_PREFIX "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UUID."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomUUID"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "-"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," timeoutSec) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   // 获取线程标示")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"   String threadId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ID_PREFIX "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   // 获取锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"   Boolean success "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIfAbsent"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name, threadId, timeoutSec, TimeUnit.SECONDS);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"   return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean.TRUE."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(success);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[731]||(s[731]=i("p",null,"释放锁",-1)),s[732]||(s[732]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取线程标示")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String threadId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ID_PREFIX "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取锁中的标示")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String id "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断标示是否一致")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(threadId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id)) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 释放锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"delete"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[733]||(s[733]=i("p",null,[i("strong",null,"有关代码实操说明：")],-1)),s[734]||(s[734]=i("p",null,"在我们修改完此处代码后，我们重启工程，然后启动两个线程，第一个线程持有锁后，手动释放锁，第二个线程 此时进入到锁内部，再放行第一个线程，此时第一个线程由于锁的value值并非是自己，所以不能释放锁，也就无法删除别人的锁，此时第二个线程能够正确释放锁，通过这个案例初步说明我们解决了锁误删的问题。",-1)),s[735]||(s[735]=i("h4",{id:"_4-6-分布式锁的原子性问题",tabindex:"-1"},[l("4.6 分布式锁的原子性问题 "),i("a",{class:"header-anchor",href:"#_4-6-分布式锁的原子性问题","aria-label":'Permalink to "4.6 分布式锁的原子性问题"'},"​")],-1)),s[736]||(s[736]=i("p",null,"更为极端的误删逻辑说明：",-1)),s[737]||(s[737]=i("p",null,"线程1现在持有锁之后，在执行业务逻辑过程中，他正准备删除锁，而且已经走到了条件判断的过程中，比如他已经拿到了当前这把锁确实是属于他自己的，正准备删除锁，但是此时他的锁到期了，那么此时线程2进来，但是线程1他会接着往后执行，当他卡顿结束后，他直接就会执行删除锁那行代码，相当于条件判断并没有起到作用，这就是删锁时的原子性问题，之所以有这个问题，是因为线程1的拿锁，比锁，删锁，实际上并不是原子性的，我们要防止刚才的情况发生，",-1)),s[738]||(s[738]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653387764938.png",alt:"1653387764938",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[739]||(s[739]=i("h4",{id:"_4-7-lua-脚本解决多条命令原子性问题",tabindex:"-1"},[l("4.7 Lua 脚本解决多条命令原子性问题 "),i("a",{class:"header-anchor",href:"#_4-7-lua-脚本解决多条命令原子性问题","aria-label":'Permalink to "4.7 Lua 脚本解决多条命令原子性问题"'},"​")],-1)),s[740]||(s[740]=i("p",null,[l("Redis提供了Lua脚本功能，在一个脚本中编写多条Redis命令，确保多条命令执行时的原子性。Lua是一种编程语言，它的基本语法大家可以参考网站："),i("a",{href:"https://www.runoob.com/lua/lua-tutorial.html%EF%BC%8C%E8%BF%99%E9%87%8C%E9%87%8D%E7%82%B9%E4%BB%8B%E7%BB%8DRedis%E6%8F%90%E4%BE%9B%E7%9A%84%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8lua%E5%8E%BB%E6%93%8D%E4%BD%9Credis%EF%BC%8C%E5%8F%88%E8%83%BD%E4%BF%9D%E8%AF%81%E4%BB%96%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E6%8B%BF%E9%94%81%E6%AF%94%E9%94%81%E5%88%A0%E9%94%81%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8E%9F%E5%AD%90%E6%80%A7%E5%8A%A8%E4%BD%9C%E4%BA%86%EF%BC%8C%E4%BD%9C%E4%B8%BAJava%E7%A8%8B%E5%BA%8F%E5%91%98%E8%BF%99%E4%B8%80%E5%9D%97%E5%B9%B6%E4%B8%8D%E4%BD%9C%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E8%A6%81%E6%B1%82%EF%BC%8C%E5%B9%B6%E4%B8%8D%E9%9C%80%E8%A6%81%E5%A4%A7%E5%AE%B6%E8%BF%87%E4%BA%8E%E7%B2%BE%E9%80%9A%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E4%BB%96%E6%9C%89%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8%E5%8D%B3%E5%8F%AF%E3%80%82",target:"_blank",rel:"noreferrer"},"https://www.runoob.com/lua/lua-tutorial.html，这里重点介绍Redis提供的调用函数，我们可以使用lua去操作redis，又能保证他的原子性，这样就可以实现拿锁比锁删锁是一个原子性动作了，作为Java程序员这一块并不作一个简单要求，并不需要大家过于精通，只需要知道他有什么作用即可。")],-1)),s[741]||(s[741]=i("p",null,"这里重点介绍Redis提供的调用函数，语法如下：",-1)),s[742]||(s[742]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'命令名称'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'key'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'其它参数'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"..."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[743]||(s[743]=i("p",null,"例如，我们要执行set name jack，则脚本是这样：",-1)),s[744]||(s[744]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"#"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 执行 set name jack")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'set'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'name'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'jack'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[745]||(s[745]=i("p",null,"例如，我们要先执行set name Rose，再执行get name，则脚本如下：",-1)),s[746]||(s[746]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"#"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 先执行 set name jack")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'set'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'name'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'Rose'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"#"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 再执行 get name")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'get'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'name'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"#"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[747]||(s[747]=i("p",null,"写好脚本以后，需要用Redis命令来调用脚本，调用脚本的常见命令如下：",-1)),s[748]||(s[748]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653392181413.png",alt:"1653392181413",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[749]||(s[749]=i("p",null,"例如，我们要执行 redis.call('set', 'name', 'jack') 这个脚本，语法如下：",-1)),s[750]||(s[750]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653392218531.png",alt:"1653392218531",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[751]||(s[751]=i("p",null,"如果脚本中的key、value不想写死，可以作为参数传递。key类型参数会放入KEYS数组，其它参数会放入ARGV数组，在脚本中可以从KEYS和ARGV数组获取这些参数：",-1)),s[752]||(s[752]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653392438917.png",alt:"1653392438917",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[753]||(s[753]=i("p",null,"接下来我们来回一下我们释放锁的逻辑：",-1)),s[754]||(s[754]=i("p",null,"释放锁的业务流程是这样的",-1)),s[755]||(s[755]=i("p",null,"​ 1、获取锁中的线程标示",-1)),s[756]||(s[756]=i("p",null,"​ 2、判断是否与指定的标示（当前线程标示）一致",-1)),s[757]||(s[757]=i("p",null,"​ 3、如果一致则释放锁（删除）",-1)),s[758]||(s[758]=i("p",null,"​ 4、如果不一致则什么都不做",-1)),s[759]||(s[759]=i("p",null,"如果用Lua脚本来表示则是这样的：",-1)),s[760]||(s[760]=i("p",null,"最终我们操作redis的拿锁比锁删锁的lua脚本就会变成这样",-1)),s[761]||(s[761]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 这里的 KEYS[1] 就是锁的key，这里的ARGV[1] 就是当前线程标示")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取锁中的标示，判断是否与当前线程标示一致")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (redis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'GET'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", KEYS["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ARGV["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  -- 一致，则删除锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DEL'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", KEYS["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 不一致，则直接返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[762]||(s[762]=i("h4",{id:"_4-8-利用-java-代码调用-lua-脚本改造分布式锁",tabindex:"-1"},[l("4.8 利用 Java 代码调用 Lua 脚本改造分布式锁 "),i("a",{class:"header-anchor",href:"#_4-8-利用-java-代码调用-lua-脚本改造分布式锁","aria-label":'Permalink to "4.8 利用 Java 代码调用 Lua 脚本改造分布式锁"'},"​")],-1)),s[763]||(s[763]=i("p",null,"lua脚本本身并不需要大家花费太多时间去研究，只需要知道如何调用，大致是什么意思即可，所以在笔记中并不会详细的去解释这些lua表达式的含义。",-1)),s[764]||(s[764]=i("p",null,"我们的RedisTemplate中，可以利用execute方法去执行lua脚本，参数对应关系就如下图股",-1)),s[765]||(s[765]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653393304844.png",alt:"1653393304844",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[766]||(s[766]=i("p",null,[i("strong",null,"Java代码")],-1)),s[767]||(s[767]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DefaultRedisScript<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> UNLOCK_SCRIPT;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    static"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UNLOCK_SCRIPT "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DefaultRedisScript<>();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UNLOCK_SCRIPT."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setLocation"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ClassPathResource"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"unlock.lua"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UNLOCK_SCRIPT."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setResultType"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long.class);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 调用lua脚本")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"execute"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            UNLOCK_SCRIPT,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Collections."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"singletonList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KEY_PREFIX "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," name),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ID_PREFIX "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"经过以上代码改造后，我们就能够实现 拿锁比锁删锁的原子性动作了"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"~")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[768]||(s[768]=i("p",null,"小总结：",-1)),s[769]||(s[769]=i("p",null,"基于Redis的分布式锁实现思路：",-1)),s[770]||(s[770]=i("ul",null,[i("li",null,[l("利用"),i("code",null,"set nx ex"),l("获取锁，并设置过期时间，保存线程标示")]),i("li",null,[l("释放锁时先判断线程标示是否与自己一致，一致则删除锁 "),i("ul",null,[i("li",null,[l("特性： "),i("ul",null,[i("li",null,"利用set nx满足互斥性"),i("li",null,"利用set ex保证故障时锁依然能释放，避免死锁，提高安全性"),i("li",null,"利用Redis集群保证高可用和高并发特性")])])])])],-1)),s[771]||(s[771]=i("p",null,"笔者总结：我们一路走来，利用添加过期时间，防止死锁问题的发生，但是有了过期时间之后，可能出现误删别人锁的问题，这个问题我们开始是利用删之前 通过拿锁，比锁，删锁这个逻辑来解决的，也就是删之前判断一下当前这把锁是否是属于自己的，但是现在还有原子性问题，也就是我们没法保证拿锁比锁删锁是一个原子性的动作，最后通过lua表达式来解决这个问题",-1)),s[772]||(s[772]=i("p",null,"但是目前还剩下一个问题锁不住，什么是锁不住呢，你想一想，如果当过期时间到了之后，我们可以给他续期一下，比如续个30s，就好像是网吧上网， 网费到了之后，然后说，来，网管，再给我来10块的，是不是后边的问题都不会发生了，那么续期问题怎么解决呢，可以依赖于我们接下来要学习redission啦",-1)),s[773]||(s[773]=i("p",null,[i("strong",null,"测试逻辑：")],-1)),s[774]||(s[774]=i("p",null,"第一个线程进来，得到了锁，手动删除锁，模拟锁超时了，其他线程会执行lua来抢锁，当第一天线程利用lua删除锁时，lua能保证他不能删除他的锁，第二个线程删除锁时，利用lua同样可以保证不会删除别人的锁，同时还能保证原子性。",-1)),s[775]||(s[775]=i("hr",null,null,-1)),s[776]||(s[776]=i("h3",{id:"_5-分布式锁-redission",tabindex:"-1"},[l("5. 分布式锁 - Redission "),i("a",{class:"header-anchor",href:"#_5-分布式锁-redission","aria-label":'Permalink to "5. 分布式锁 - Redission"'},"​")],-1)),s[777]||(s[777]=i("h4",{id:"_5-1-分布式锁-redission-功能介绍",tabindex:"-1"},[l("5.1 分布式锁 - Redission 功能介绍 "),i("a",{class:"header-anchor",href:"#_5-1-分布式锁-redission-功能介绍","aria-label":'Permalink to "5.1 分布式锁 - Redission 功能介绍"'},"​")],-1)),s[778]||(s[778]=i("p",null,"基于setnx实现的分布式锁存在下面的问题：",-1)),s[779]||(s[779]=i("p",null,[i("strong",null,"重入问题"),l("：重入问题是指 获得锁的线程可以再次进入到相同的锁的代码块中，可重入锁的意义在于防止死锁，比如HashTable这样的代码中，他的方法都是使用synchronized修饰的，假如他在一个方法内，调用另一个方法，那么此时如果是不可重入的，不就死锁了吗？所以可重入锁他的主要意义是防止死锁，我们的synchronized和Lock锁都是可重入的。")],-1)),s[780]||(s[780]=i("p",null,[i("strong",null,"不可重试"),l("：是指目前的分布式只能尝试一次，我们认为合理的情况是：当线程在获得锁失败后，他应该能再次尝试获得锁。")],-1)),s[781]||(s[781]=i("p",null,"**超时释放：**我们在加锁时增加了过期时间，这样的我们可以防止死锁，但是如果卡顿的时间超长，虽然我们采用了lua表达式防止删锁的时候，误删别人的锁，但是毕竟没有锁住，有安全隐患",-1)),s[782]||(s[782]=i("p",null,[i("strong",null,"主从一致性："),l(" 如果Redis提供了主从集群，当我们向集群写数据时，主机需要异步的将数据同步给从机，而万一在同步过去之前，主机宕机了，就会出现死锁问题。")],-1)),s[783]||(s[783]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653546070602.png",alt:"1653546070602",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[784]||(s[784]=i("p",null,"那么什么是Redission呢",-1)),s[785]||(s[785]=i("p",null,"Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务，其中就包含了各种分布式锁的实现。",-1)),s[786]||(s[786]=i("p",null,"Redission提供了分布式锁的多种多样的功能",-1)),s[787]||(s[787]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653546736063.png",alt:"1653546736063",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[788]||(s[788]=i("h4",{id:"_5-2-分布式锁-redission-快速入门",tabindex:"-1"},[l("5.2 分布式锁 - Redission 快速入门 "),i("a",{class:"header-anchor",href:"#_5-2-分布式锁-redission-快速入门","aria-label":'Permalink to "5.2 分布式锁 - Redission 快速入门"'},"​")],-1)),s[789]||(s[789]=i("p",null,"引入依赖：",-1)),s[790]||(s[790]=i("div",{class:"language-xml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"xml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.redisson</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">redisson</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">3.13.6</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[791]||(s[791]=i("p",null,"配置Redisson客户端：",-1)),s[792]||(s[792]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedissonConfig"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedissonClient "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redissonClient"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 配置")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Config config "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Config"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        config."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"useSingleServer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAddress"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis://192.168.150.101:6379"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPassword"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建RedissonClient对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Redisson."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(config);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[793]||(s[793]=i("p",null,"如何使用Redission的分布式锁",-1)),s[794]||(s[794]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Resource")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedissionClient redissonClient;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testRedisson"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws Exception{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //获取锁(可重入)，指定锁的名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    RLock lock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redissonClient."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"anyLock"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //尝试获取锁，参数分别是：获取锁的最大等待时间(期间会重试)，锁自动释放时间，时间单位")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tryLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",TimeUnit.SECONDS);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //判断获取锁成功")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(isLock){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"执行业务"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");          ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //释放锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            lock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[795]||(s[795]=i("p",null,"在 VoucherOrderServiceImpl",-1)),s[796]||(s[796]=i("p",null,"注入RedissonClient",-1)),s[797]||(s[797]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Resource")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedissonClient redissonClient;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.查询优惠券")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SeckillVoucher voucher "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断秒杀是否开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAfter"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 尚未开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀尚未开始！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.判断秒杀是否已经结束")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isBefore"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 尚未开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"秒杀已经结束！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.判断库存是否充足")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 库存不足")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //创建锁对象 这个代码不用了，因为我们现在要使用分布式锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'        //SimpleRedisLock lock = new SimpleRedisLock("order:" + userId, stringRedisTemplate);')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RLock lock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redissonClient."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lock:order:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //获取锁对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tryLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"       ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"		//加锁失败")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isLock) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"不允许重复下单"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //获取代理对象(事务)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            IVoucherOrderService proxy "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (IVoucherOrderService) AopContext."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentProxy"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," proxy."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createVoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //释放锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            lock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[798]||(s[798]=i("h4",{id:"_5-3-分布式锁-redission-可重入锁原理",tabindex:"-1"},[l("5.3 分布式锁 - Redission 可重入锁原理 "),i("a",{class:"header-anchor",href:"#_5-3-分布式锁-redission-可重入锁原理","aria-label":'Permalink to "5.3 分布式锁 - Redission 可重入锁原理"'},"​")],-1)),s[799]||(s[799]=i("p",null,"在Lock锁中，他是借助于底层的一个voaltile的一个state变量来记录重入的状态的，比如当前没有人持有这把锁，那么state=0，假如有人持有这把锁，那么state=1，如果持有这把锁的人再次持有这把锁，那么state就会+1 ，如果是对于synchronized而言，他在c语言代码中会有一个count，原理和state类似，也是重入一次就加一，释放一次就-1 ，直到减少成0 时，表示当前这把锁没有被人持有。",-1)),s[800]||(s[800]=i("p",null,"在redission中，我们的也支持支持可重入锁",-1)),s[801]||(s[801]=i("p",null,"在分布式锁中，他采用hash结构用来存储锁，其中大key表示表示这把锁是否存在，用小key表示当前这把锁被哪个线程持有，所以接下来我们一起分析一下当前的这个lua表达式",-1)),s[802]||(s[802]=i("p",null,"这个地方一共有3个参数",-1)),s[803]||(s[803]=i("p",null,[i("strong",null,"KEYS[1] ： 锁名称")],-1)),s[804]||(s[804]=i("p",null,[i("strong",null,"ARGV[1]： 锁失效时间")],-1)),s[805]||(s[805]=i("p",null,[i("strong",null,[l("ARGV[2]： "),i("code",null,'id + ":" + threadId'),l("; 锁的小key")])],-1)),s[806]||(s[806]=i("p",null,"exists: 判断数据是否存在 name：是lock是否存在,如果==0，就表示当前这把锁不存在",-1)),s[807]||(s[807]=i("p",null,[i("code",null,"redis.call('hset', KEYS[1], ARGV[2], 1)"),l(";此时他就开始往redis里边去写数据 ，写成一个hash结构")],-1)),s[808]||(s[808]=i("p",null,[i("code",null,"Lock{")],-1)),s[809]||(s[809]=i("p",null,[l("​ "),i("code",null,'id + **":"** + threadId : 1')],-1)),s[810]||(s[810]=i("p",null,[i("code",null,"}")],-1)),s[811]||(s[811]=i("p",null,"如果当前这把锁存在，则第一个条件不满足，再判断",-1)),s[812]||(s[812]=i("p",null,[i("code",null,"redis.call('hexists', KEYS[1], ARGV[2]) == 1")],-1)),s[813]||(s[813]=i("p",null,"此时需要通过大key+小key判断当前这把锁是否是属于自己的，如果是自己的，则进行",-1)),s[814]||(s[814]=i("p",null,[i("code",null,"redis.call('hincrby', KEYS[1], ARGV[2], 1)")],-1)),s[815]||(s[815]=i("p",null,[l("将当前这个锁的value进行+1 ，"),i("code",null,"redis.call('pexpire', KEYS[1], ARGV[1])"),l("; 然后再对其设置过期时间，如果以上两个条件都不满足，则表示当前这把锁抢锁失败，最后返回pttl，即为当前这把锁的失效时间")],-1)),s[816]||(s[816]=i("p",null,[l("如果小伙帮们看了前边的源码， 你会发现他会去判断当前这个方法的返回值是否为null，如果是null，则对应则前两个if对应的条件，退出抢锁逻辑，如果返回的不是null，即走了第三个分支，在源码处会进行"),i("code",null,"while(true)"),l("的自旋抢锁。")],-1)),s[817]||(s[817]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`"if (redis.call('exists', KEYS[1]) == 0) then " `),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`                  "redis.call('hset', KEYS[1], ARGV[2], 1); " `),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`                  "redis.call('pexpire', KEYS[1], ARGV[1]); " `),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                  "return nil; " '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'              "end; " '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`              "if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then " `),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`                  "redis.call('hincrby', KEYS[1], ARGV[2], 1); " `),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`                  "redis.call('pexpire', KEYS[1], ARGV[1]); " `),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                  "return nil; " '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'              "end; " '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`              "return redis.call('pttl', KEYS[1]);"`)])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[818]||(s[818]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653548087334.png",alt:"1653548087334",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[819]||(s[819]=i("h4",{id:"_5-4-分布式锁-redission-锁重试和-watchdog-机制",tabindex:"-1"},[l("5.4 分布式锁 - Redission 锁重试和 WatchDog 机制 "),i("a",{class:"header-anchor",href:"#_5-4-分布式锁-redission-锁重试和-watchdog-机制","aria-label":'Permalink to "5.4 分布式锁 - Redission 锁重试和 WatchDog 机制"'},"​")],-1)),s[820]||(s[820]=i("p",null,[i("strong",null,"说明"),l("：由于课程中已经说明了有关tryLock的源码解析以及其看门狗原理，所以笔者在这里给大家分析"),i("code",null,"lock()"),l("方法的源码解析，希望大家在学习过程中，能够掌握更多的知识")],-1)),s[821]||(s[821]=i("p",null,"抢锁过程中，获得当前线程，通过tryAcquire进行抢锁，该抢锁逻辑和之前逻辑相同",-1)),s[822]||(s[822]=i("p",null,"1、先判断当前这把锁是否存在，如果不存在，插入一把锁，返回null",-1)),s[823]||(s[823]=i("p",null,"2、判断当前这把锁是否是属于当前线程，如果是，则返回null",-1)),s[824]||(s[824]=i("p",null,[l("所以如果返回是null，则代表着当前这哥们已经抢锁完毕，或者可重入完毕，但是如果以上两个条件都不满足，则进入到第三个条件，返回的是锁的失效时间，同学们可以自行往下翻一点点，你能发现有个"),i("code",null,"while( true)"),l(" 再次进行tryAcquire进行抢锁")],-1)),s[825]||(s[825]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," threadId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Long ttl "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryAcquire"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", leaseTime, unit, threadId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// lock acquired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ttl "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[826]||(s[826]=i("p",null,[l("接下来会有一个条件分支，因为lock方法有重载方法，一个是带参数，一个是不带参数，如果带带参数传入的值是-1，如果传入参数，则leaseTime是他本身，所以如果传入了参数，此时"),i("code",null,"leaseTime != -1"),l(" 则会进去抢锁，抢锁的逻辑就是之前说的那三个逻辑")],-1)),s[827]||(s[827]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (leaseTime "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLockInnerAsync"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[828]||(s[828]=i("p",null,[l("如果是没有传入时间，则此时也会进行抢锁， 而且抢锁时间是默认看门狗时间 "),i("code",null,"commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout()")],-1)),s[829]||(s[829]=i("p",null,[i("code",null,"ttlRemainingFuture.onComplete((ttlRemaining, e)"),l(" 这句话相当于对以上抢锁进行了监听，也就是说当上边抢锁完毕后，此方法会被调用，具体调用的逻辑就是去后台开启一个线程，进行续约逻辑，也就是看门狗线程")],-1)),s[830]||(s[830]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"RFuture<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ttlRemainingFuture "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryLockInnerAsync"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(waitTime,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                        commandExecutor."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getConnectionManager"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCfg"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLockWatchdogTimeout"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                        TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ttlRemainingFuture."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"onComplete"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((ttlRemaining, e) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // lock acquired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ttlRemaining "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        scheduleExpirationRenewal"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(threadId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"});")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ttlRemainingFuture;")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[831]||(s[831]=i("p",null,[l("此逻辑就是续约逻辑，注意看"),i("code",null,"commandExecutor.getConnectionManager().newTimeout()"),l(" 此方法")],-1)),s[832]||(s[832]=i("p",null,[i("code",null,"Method(new TimerTask(){},参数2,参数3)")],-1)),s[833]||(s[833]=i("p",null,"指的是：通过参数2，参数3 去描述什么时候去做参数1的事情，现在的情况是：10s之后去做参数一的事情",-1)),s[834]||(s[834]=i("p",null,[l("因为锁的失效时间是30s，当10s之后，此时这个timeTask 就触发了，他就去进行续约，把当前这把锁续约成30s，如果操作成功，那么此时就会递归调用自己，再重新设置一个"),i("code",null,"timeTask()"),l("，于是再过10s后又再设置一个timerTask，完成不停的续约")],-1)),s[835]||(s[835]=i("p",null,"那么大家可以想一想，假设我们的线程出现了宕机他还会续约吗？当然不会，因为没有人再去调用renewExpiration这个方法，所以等到时间之后自然就释放了。",-1)),s[836]||(s[836]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," renewExpiration"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ExpirationEntry ee "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," EXPIRATION_RENEWAL_MAP."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEntryName"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ee "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Timeout task "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," commandExecutor."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getConnectionManager"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newTimeout"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," TimerTask"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Timeout "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"timeout"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ExpirationEntry ent "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," EXPIRATION_RENEWAL_MAP."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEntryName"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ent "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Long threadId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ent."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getFirstThreadId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (threadId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            RFuture<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> future "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," renewExpirationAsync"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(threadId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            future."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"onComplete"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((res, e) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`"Can't update lock "`),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getName"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' " expiration"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (res) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // reschedule itself")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                    renewExpiration"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            });")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }, internalLockLeaseTime "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 3"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit.MILLISECONDS);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ee."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setTimeout"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(task);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[837]||(s[837]=i("h4",{id:"_5-5-分布式锁-redission-锁的-mutilock-原理",tabindex:"-1"},[l("5.5 分布式锁 - Redission 锁的 MutiLock 原理 "),i("a",{class:"header-anchor",href:"#_5-5-分布式锁-redission-锁的-mutilock-原理","aria-label":'Permalink to "5.5 分布式锁 - Redission 锁的 MutiLock 原理"'},"​")],-1)),s[838]||(s[838]=i("p",null,"为了提高redis的可用性，我们会搭建集群或者主从，现在以主从为例",-1)),s[839]||(s[839]=i("p",null,"此时我们去写命令，写在主机上， 主机会将数据同步给从机，但是假设在主机还没有来得及把数据写入到从机去的时候，此时主机宕机，哨兵会发现主机宕机，并且选举一个slave变成master，而此时新的master中实际上并没有锁信息，此时锁信息就已经丢掉了。",-1)),s[840]||(s[840]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653553998403.png",alt:"1653553998403",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[841]||(s[841]=i("p",null,"为了解决这个问题，redission提出来了MutiLock锁，使用这把锁咱们就不使用主从了，每个节点的地位都是一样的， 这把锁加锁的逻辑需要写入到每一个主丛节点上，只有所有的服务器都写入成功，此时才是加锁成功，假设现在某个节点挂了，那么他去获得锁的时候，只要有一个节点拿不到，都不能算是加锁成功，就保证了加锁的可靠性。",-1)),s[842]||(s[842]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653554055048.png",alt:"1653554055048",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[843]||(s[843]=i("p",null,"那么 MutiLock 加锁原理是什么呢？笔者画了一幅图来说明",-1)),s[844]||(s[844]=i("p",null,[l("当我们去设置了多个锁时，redission会将多个锁添加到一个集合中，然后用while循环去不停去尝试拿锁，但是会有一个总共的加锁时间，这个时间是用"),i("code",null,"需要加锁的个数 * 1500ms"),l(" ，假设有3个锁，那么时间就是4500ms，假设在这4500ms内，所有的锁都加锁成功， 那么此时才算是加锁成功，如果在4500ms有线程加锁失败，则会再次去进行重试.")],-1)),s[845]||(s[845]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653553093967.png",alt:"1653553093967",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[846]||(s[846]=i("hr",null,null,-1)),s[847]||(s[847]=i("h3",{id:"_6-秒杀优化",tabindex:"-1"},[l("6. 秒杀优化 "),i("a",{class:"header-anchor",href:"#_6-秒杀优化","aria-label":'Permalink to "6. 秒杀优化"'},"​")],-1)),s[848]||(s[848]=i("h4",{id:"_6-1-秒杀优化-异步秒杀思路",tabindex:"-1"},[l("6.1 秒杀优化 - 异步秒杀思路 "),i("a",{class:"header-anchor",href:"#_6-1-秒杀优化-异步秒杀思路","aria-label":'Permalink to "6.1 秒杀优化 - 异步秒杀思路"'},"​")],-1)),s[849]||(s[849]=i("p",null,"我们来回顾一下下单流程",-1)),s[850]||(s[850]=i("p",null,"当用户发起请求，此时会请求nginx，nginx会访问到tomcat，而tomcat中的程序，会进行串行操作，分成如下几个步骤",-1)),s[851]||(s[851]=i("ol",null,[i("li",null,"查询优惠卷"),i("li",null,"判断秒杀库存是否足够"),i("li",null,"查询订单"),i("li",null,"校验是否是一人一单"),i("li",null,"扣减库存"),i("li",null,"创建订单")],-1)),s[852]||(s[852]=i("p",null,"在这六步操作中，又有很多操作是要去操作数据库的，而且还是一个线程串行执行， 这样就会导致我们的程序执行的很慢，所以我们需要异步程序执行，那么如何加速呢？",-1)),s[853]||(s[853]=i("p",null,"在这里笔者想给大家分享一下课程内没有的思路，看看有没有小伙伴这么想，比如，我们可以不可以使用异步编排来做，或者说我开启N多线程，N多个线程，一个线程执行查询优惠卷，一个执行判断扣减库存，一个去创建订单等等，然后再统一做返回，这种做法和课程中有哪种好呢？答案是课程中的好，因为如果你采用我刚说的方式，如果访问的人很多，那么线程池中的线程可能一下子就被消耗完了，而且你使用上述方案，最大的特点在于，你觉得时效性会非常重要，但是你想想是吗？并不是，比如我只要确定他能做这件事，然后我后边慢慢做就可以了，我并不需要他一口气做完这件事，所以我们应当采用的是课程中，类似消息队列的方式来完成我们的需求，而不是使用线程池或者是异步编排的方式来完成这个需求",-1)),s[854]||(s[854]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653560986599.png",alt:"1653560986599",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[855]||(s[855]=i("p",null,"优化方案：我们将耗时比较短的逻辑判断放入到redis中，比如是否库存足够，比如是否一人一单，这样的操作，只要这种逻辑可以完成，就意味着我们是一定可以下单完成的，我们只需要进行快速的逻辑判断，根本就不用等下单逻辑走完，我们直接给用户返回成功， 再在后台开一个线程，后台线程慢慢的去执行queue里边的消息，这样程序不就超级快了吗？而且也不用担心线程池消耗殆尽的问题，因为这里我们的程序中并没有手动使用任何线程池，当然这里边有两个难点",-1)),s[856]||(s[856]=i("p",null,"第一个难点是我们怎么在redis中去快速校验一人一单，还有库存判断",-1)),s[857]||(s[857]=i("p",null,"第二个难点是由于我们校验和tomct下单是两个线程，那么我们如何知道到底哪个单他最后是否成功，或者是下单完成，为了完成这件事我们在redis操作完之后，我们会将一些信息返回给前端，同时也会把这些信息丢到异步queue中去，后续操作中，可以通过这个id来查询我们tomcat中的下单逻辑是否完成了。",-1)),s[858]||(s[858]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653561657295.png",alt:"1653561657295",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[859]||(s[859]=i("p",null,"我们现在来看看整体思路：当用户下单之后，判断库存是否充足只需要导redis中去根据key找对应的value是否大于0即可，如果不充足，则直接结束，如果充足，继续在redis中判断用户是否可以下单，如果set集合中没有这条数据，说明他可以下单，如果set集合中没有这条记录，则将userId和优惠卷存入到redis中，并且返回0，整个过程需要保证是原子性的，我们可以使用lua来操作",-1)),s[860]||(s[860]=i("p",null,"当以上判断逻辑走完之后，我们可以判断当前redis中返回的结果是否是0 ，如果是0，则表示可以下单，则将之前说的信息存入到到queue中去，然后返回，然后再来个线程异步的下单，前端可以通过返回的订单id来判断是否下单成功。",-1)),s[861]||(s[861]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653562234886.png",alt:"1653562234886",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[862]||(s[862]=i("h4",{id:"_6-2-秒杀优化-redis-完成秒杀资格判断",tabindex:"-1"},[l("6.2 秒杀优化 - Redis 完成秒杀资格判断 "),i("a",{class:"header-anchor",href:"#_6-2-秒杀优化-redis-完成秒杀资格判断","aria-label":'Permalink to "6.2 秒杀优化 - Redis 完成秒杀资格判断"'},"​")],-1)),s[863]||(s[863]=i("p",null,"需求：",-1)),s[864]||(s[864]=i("ul",null,[i("li",null,[i("p",null,"新增秒杀优惠券的同时，将优惠券信息保存到Redis中")]),i("li",null,[i("p",null,"基于Lua脚本，判断秒杀库存、一人一单，决定用户是否抢购成功")]),i("li",null,[i("p",null,"如果抢购成功，将优惠券id和用户id封装后存入阻塞队列")]),i("li",null,[i("p",null,"开启线程任务，不断从阻塞队列中获取信息，实现异步下单功能"),i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1656080546603.png",alt:"1656080546603",loading:"lazy",decoding:"async",class:"lazy"})])])],-1)),s[865]||(s[865]=i("p",null,[i("strong",null,"VoucherServiceImpl")],-1)),s[866]||(s[866]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addSeckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Voucher voucher) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存优惠券")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存秒杀信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SeckillVoucher seckillVoucher "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SeckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setBeginTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBeginTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setEndTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(seckillVoucher);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 保存秒杀库存到Redis中")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //SECKILL_STOCK_KEY 这个变量定义在RedisConstans中")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'    //private static final String SECKILL_STOCK_KEY ="seckill:stock:"')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SECKILL_STOCK_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), voucher."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[867]||(s[867]=i("p",null,"完整lua表达式",-1)),s[868]||(s[868]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 1.参数列表")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 1.1.优惠券id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucherId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ARGV["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 1.2.用户id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ARGV["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 1.3.订单id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ARGV["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 2.数据key")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 2.1.库存key")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockKey "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'seckill:stock:' "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucherId")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 2.2.订单key")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderKey "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'seckill:order:' "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucherId")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.脚本业务")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.1.判断库存是否充足 get stockKey")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"tonumber"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(redis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'get'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", stockKey)) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 3.2.库存不足，返回1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.2.判断用户是否下单 SISMEMBER orderKey userId")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(redis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'sismember'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", orderKey, userId) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 3.3.存在，说明是重复下单，返回2")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.4.扣库存 incrby stockKey -1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'incrby'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", stockKey, "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.5.下单（保存用户）sadd orderKey userId")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'sadd'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", orderKey, userId)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 3.6.发送消息到队列中， XADD stream.orders * k1 v1 k2 v2 ...")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"redis."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"call"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'xadd'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'stream.orders'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'*'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'userId'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'voucherId'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherId, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", orderId)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[869]||(s[869]=i("p",null,"当以上lua表达式执行完毕后，剩下的就是根据步骤3,4来执行我们接下来的任务了",-1)),s[870]||(s[870]=i("p",null,[i("strong",null,"VoucherOrderServiceImpl")],-1)),s[871]||(s[871]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long voucherId) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //获取用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.执行lua脚本")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long result "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"execute"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            SECKILL_SCRIPT,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Collections."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            voucherId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), userId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), String."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    );")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"intValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.判断结果是否为0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.1.不为0 ，代表没有购买资格")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ?"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "库存不足"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," :"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "不能重复下单"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //TODO 保存阻塞队列")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.返回订单id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[872]||(s[872]=i("h4",{id:"_6-3-秒杀优化-基于阻塞队列实现秒杀优化",tabindex:"-1"},[l("6.3 秒杀优化 - 基于阻塞队列实现秒杀优化 "),i("a",{class:"header-anchor",href:"#_6-3-秒杀优化-基于阻塞队列实现秒杀优化","aria-label":'Permalink to "6.3 秒杀优化 - 基于阻塞队列实现秒杀优化"'},"​")],-1)),s[873]||(s[873]=i("p",null,[i("strong",null,"VoucherOrderServiceImpl")],-1)),s[874]||(s[874]=i("p",null,"修改下单动作，现在我们去下单时，是通过lua表达式去原子执行判断逻辑，如果判断我出来不为0 ，则要么是库存不足，要么是重复下单，返回错误信息，如果是0，则把下单的逻辑保存到队列中去，然后异步执行",-1)),s[875]||(s[875]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//异步处理线程池")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExecutorService SECKILL_ORDER_EXECUTOR "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Executors."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newSingleThreadExecutor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//在类初始化之后执行，因为当这个类初始化好了之后，随时都是有可能要执行的")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostConstruct")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," init"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"   SECKILL_ORDER_EXECUTOR."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrderHandler"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 用于线程池处理的任务")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 当初始化完毕后，就会去从对列中去拿信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrderHandler"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Runnable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            while"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 1.获取队列中的订单信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    VoucherOrder voucherOrder "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderTasks."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"take"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 2.创建订单")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                    handleVoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"处理订单异常"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"          	 }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"     ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"       private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleVoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(VoucherOrder "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"voucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //1.获取用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.创建锁对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            RLock redisLock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redissonClient."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lock:order:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.尝试获取锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isLock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisLock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.判断是否获得锁成功")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isLock) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 获取锁失败，直接返回失败或者重试")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"不允许重复下单！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"				//注意：由于是spring的事务是放在threadLocal中，此时的是多线程，事务会失效")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                proxy."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createVoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 释放锁")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                redisLock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     //a")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"	private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BlockingQueue<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> orderTasks "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  ArrayBlockingQueue<>("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1024"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1024"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"seckillVoucher"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"voucherId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.执行lua脚本")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long result "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"execute"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                SECKILL_SCRIPT,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Collections."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                voucherId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), userId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), String."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        );")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"intValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断结果是否为0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.1.不为0 ，代表没有购买资格")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ?"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "库存不足"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," :"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "不能重复下单"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        VoucherOrder voucherOrder "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.3.订单id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisIdWorker."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.4.用户id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.5.代金券id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVoucherId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.6.放入阻塞队列")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        orderTasks."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //3.获取代理对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"         proxy "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (IVoucherOrderService)AopContext."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentProxy"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //4.返回订单id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"     ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createVoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(VoucherOrder "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"voucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.1.查询订单")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getVoucherId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.2.判断是否存在")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 用户已经购买过了")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"           log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"用户已经购买过了"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"           return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.扣减库存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," success "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillVoucherService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock = stock - 1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// set stock = stock - 1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"voucher_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", voucherOrder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getVoucherId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gt"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// where id = ? and stock > 0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"success) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 扣减失败")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"库存不足"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[876]||(s[876]=i("p",null,[i("strong",null,"小总结：")],-1)),s[877]||(s[877]=i("p",null,"秒杀业务的优化思路是什么？",-1)),s[878]||(s[878]=i("ul",null,[i("li",null,"先利用Redis完成库存余量、一人一单判断，完成抢单业务"),i("li",null,"再将下单业务放入阻塞队列，利用独立线程异步下单"),i("li",null,[l("基于阻塞队列的异步秒杀存在哪些问题？ "),i("ul",null,[i("li",null,"内存限制问题"),i("li",null,"数据安全问题")])])],-1)),s[879]||(s[879]=i("hr",null,null,-1)),s[880]||(s[880]=i("h3",{id:"_7-redis-消息队列",tabindex:"-1"},[l("7. Redis 消息队列 "),i("a",{class:"header-anchor",href:"#_7-redis-消息队列","aria-label":'Permalink to "7. Redis 消息队列"'},"​")],-1)),s[881]||(s[881]=i("h4",{id:"_7-1-redis-消息队列-认识消息队列",tabindex:"-1"},[l("7.1 Redis 消息队列 - 认识消息队列 "),i("a",{class:"header-anchor",href:"#_7-1-redis-消息队列-认识消息队列","aria-label":'Permalink to "7.1 Redis 消息队列 - 认识消息队列"'},"​")],-1)),s[882]||(s[882]=i("p",null,"什么是消息队列：字面意思就是存放消息的队列。最简单的消息队列模型包括3个角色：",-1)),s[883]||(s[883]=i("ul",null,[i("li",null,"消息队列：存储和管理消息，也被称为消息代理（Message Broker）"),i("li",null,"生产者：发送消息到消息队列"),i("li",null,"消费者：从消息队列获取消息并处理消息")],-1)),s[884]||(s[884]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653574849336.png",alt:"1653574849336",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[885]||(s[885]=i("p",null,"使用队列的好处在于 **解耦：**所谓解耦，举一个生活中的例子就是：快递员(生产者)把快递放到快递柜里边(Message Queue)去，我们(消费者)从快递柜里边去拿东西，这就是一个异步，如果耦合，那么这个快递员相当于直接把快递交给你，这事固然好，但是万一你不在家，那么快递员就会一直等你，这就浪费了快递员的时间，所以这种思想在我们日常开发中，是非常有必要的。",-1)),s[886]||(s[886]=i("p",null,"这种场景在我们秒杀中就变成了：我们下单之后，利用redis去进行校验下单条件，再通过队列把消息发送出去，然后再启动一个线程去消费这个消息，完成解耦，同时也加快我们的响应速度。",-1)),s[887]||(s[887]=i("p",null,"这里我们可以使用一些现成的mq，比如kafka，rabbitmq等等，但是呢，如果没有安装mq，我们也可以直接使用redis提供的mq方案，降低我们的部署和学习成本。",-1)),s[888]||(s[888]=i("h4",{id:"_7-2-redis-消息队列-基于-list-实现消息队列",tabindex:"-1"},[l("7.2 Redis 消息队列 - 基于 List 实现消息队列 "),i("a",{class:"header-anchor",href:"#_7-2-redis-消息队列-基于-list-实现消息队列","aria-label":'Permalink to "7.2 Redis 消息队列 - 基于 List 实现消息队列"'},"​")],-1)),s[889]||(s[889]=i("p",null,[i("strong",null,"基于List结构模拟消息队列")],-1)),s[890]||(s[890]=i("p",null,"消息队列（Message Queue），字面意思就是存放消息的队列。而Redis的list数据结构是一个双向链表，很容易模拟出队列效果。",-1)),s[891]||(s[891]=i("p",null,"队列是入口和出口不在一边，因此我们可以利用：LPUSH 结合 RPOP、或者 RPUSH 结合 LPOP来实现。 不过要注意的是，当队列中没有消息时RPOP或LPOP操作会返回null，并不像JVM的阻塞队列那样会阻塞并等待消息。因此这里应该使用BRPOP或者BLPOP来实现阻塞效果。",-1)),s[892]||(s[892]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653575176451.png",alt:"1653575176451",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[893]||(s[893]=i("p",null,"基于List的消息队列有哪些优缺点？ 优点：",-1)),s[894]||(s[894]=i("ul",null,[i("li",null,"利用Redis存储，不受限于JVM内存上限"),i("li",null,"基于Redis的持久化机制，数据安全性有保证"),i("li",null,"可以满足消息有序性")],-1)),s[895]||(s[895]=i("p",null,"缺点：",-1)),s[896]||(s[896]=i("ul",null,[i("li",null,"无法避免消息丢失"),i("li",null,"只支持单消费者")],-1)),s[897]||(s[897]=i("h4",{id:"_7-3-redis-消息队列-基于-pubsub-的消息队列",tabindex:"-1"},[l("7.3 Redis 消息队列 - 基于 PubSub 的消息队列 "),i("a",{class:"header-anchor",href:"#_7-3-redis-消息队列-基于-pubsub-的消息队列","aria-label":'Permalink to "7.3 Redis 消息队列 - 基于 PubSub 的消息队列"'},"​")],-1)),s[898]||(s[898]=i("p",null,"PubSub（发布订阅）是Redis2.0版本引入的消息传递模型。顾名思义，消费者可以订阅一个或多个channel，生产者向对应channel发送消息后，所有订阅者都能收到相关消息。",-1)),s[899]||(s[899]=i("p",null,[i("code",null,"SUBSCRIBE channel [channel]"),l(" ：订阅一个或多个频道 "),i("code",null,"PUBLISH channel msg"),l(" ：向一个频道发送消息 "),i("code",null,"PSUBSCRIBE pattern[pattern]"),l(" ：订阅与pattern格式匹配的所有频道")],-1)),s[900]||(s[900]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653575506373.png",alt:"1653575506373",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[901]||(s[901]=i("p",null,"基于PubSub的消息队列有哪些优缺点？ 优点：",-1)),s[902]||(s[902]=i("ul",null,[i("li",null,"采用发布订阅模型，支持多生产、多消费")],-1)),s[903]||(s[903]=i("p",null,"缺点：",-1)),s[904]||(s[904]=i("ul",null,[i("li",null,"不支持数据持久化"),i("li",null,"无法避免消息丢失"),i("li",null,"消息堆积有上限，超出时数据丢失")],-1)),s[905]||(s[905]=i("h4",{id:"_7-4-redis-消息队列-基于-stream-的消息队列",tabindex:"-1"},[l("7.4 Redis 消息队列 - 基于 Stream 的消息队列 "),i("a",{class:"header-anchor",href:"#_7-4-redis-消息队列-基于-stream-的消息队列","aria-label":'Permalink to "7.4 Redis 消息队列 - 基于 Stream 的消息队列"'},"​")],-1)),s[906]||(s[906]=i("p",null,"Stream 是 Redis 5.0 引入的一种新数据类型，可以实现一个功能非常完善的消息队列。",-1)),s[907]||(s[907]=i("p",null,"发送消息的命令：",-1)),s[908]||(s[908]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577301737.png",alt:"1653577301737",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[909]||(s[909]=i("p",null,"例如：",-1)),s[910]||(s[910]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577349691.png",alt:"1653577349691",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[911]||(s[911]=i("p",null,"读取消息的方式之一：XREAD",-1)),s[912]||(s[912]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577445413.png",alt:"1653577445413",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[913]||(s[913]=i("p",null,"例如，使用XREAD读取第一个消息：",-1)),s[914]||(s[914]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577643629.png",alt:"1653577643629",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[915]||(s[915]=i("p",null,"XREAD阻塞方式，读取最新的消息：",-1)),s[916]||(s[916]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577659166.png",alt:"1653577659166",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[917]||(s[917]=i("p",null,"在业务开发中，我们可以循环的调用XREAD阻塞方式来查询最新消息，从而实现持续监听队列的效果，伪代码如下",-1)),s[918]||(s[918]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577689129.png",alt:"1653577689129",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[919]||(s[919]=i("p",null,"注意：当我们指定起始ID为$时，代表读取最新的消息，如果我们处理一条消息的过程中，又有超过1条以上的消息到达队列，则下次获取时也只能获取到最新的一条，会出现漏读消息的问题",-1)),s[920]||(s[920]=i("p",null,"STREAM类型消息队列的XREAD命令特点：",-1)),s[921]||(s[921]=i("ul",null,[i("li",null,"消息可回溯"),i("li",null,"一个消息可以被多个消费者读取"),i("li",null,"可以阻塞读取"),i("li",null,"有消息漏读的风险")],-1)),s[922]||(s[922]=i("h4",{id:"_7-5-redis-消息队列-基于-stream-的消息队列-消费者组",tabindex:"-1"},[l("7.5 Redis 消息队列 - 基于 Stream 的消息队列 - 消费者组 "),i("a",{class:"header-anchor",href:"#_7-5-redis-消息队列-基于-stream-的消息队列-消费者组","aria-label":'Permalink to "7.5 Redis 消息队列 - 基于 Stream 的消息队列 - 消费者组"'},"​")],-1)),s[923]||(s[923]=i("p",null,"消费者组（Consumer Group）：将多个消费者划分到一个组中，监听同一个队列。具备下列特点：",-1)),s[924]||(s[924]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577801668.png",alt:"1653577801668",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[925]||(s[925]=i("p",null,[l("创建消费者组： "),i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653577984924.png",alt:"1653577984924"})],-1)),s[926]||(s[926]=i("ul",null,[i("li",null,"key：队列名称"),i("li",null,"groupName：消费者组名称"),i("li",null,"ID：起始ID标示，$代表队列中最后一个消息，0则代表队列中第一个消息"),i("li",null,"MKSTREAM：队列不存在时自动创建队列"),i("li",null,"其它常见命令：")],-1)),s[927]||(s[927]=i("p",null,[i("strong",null,"删除指定的消费者组")],-1)),s[928]||(s[928]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"XGROUP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," DESTORY"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," key"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," groupName")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[929]||(s[929]=i("p",null,[i("strong",null,"给指定的消费者组添加消费者")],-1)),s[930]||(s[930]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"XGROUP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," CREATECONSUMER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," key"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," groupname"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," consumername")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[931]||(s[931]=i("p",null,[i("strong",null,"删除消费者组中的指定消费者")],-1)),s[932]||(s[932]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"XGROUP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," DELCONSUMER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," key"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," groupname"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," consumername")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[933]||(s[933]=i("p",null,"从消费者组读取消息：",-1)),s[934]||(s[934]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"XREADGROUP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," GROUP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," group"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," consumer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," [COUNT "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"count]"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," [BLOCK "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"milliseconds]"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," [NOACK] STREAMS key [key ...] ID [ID ...]")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[935]||(s[935]=i("ul",null,[i("li",null,"group：消费组名称"),i("li",null,"consumer：消费者名称，如果消费者不存在，会自动创建一个消费者"),i("li",null,"count：本次查询的最大数量"),i("li",null,"BLOCK milliseconds：当没有消息时最长等待时间"),i("li",null,"NOACK：无需手动ACK，获取到消息后自动确认"),i("li",null,"STREAMS key：指定队列名称"),i("li",null,"ID：获取消息的起始ID：")],-1)),s[936]||(s[936]=i("p",null,[l('"'),i("code",null,">"),l('"：从下一个未消费的消息开始 其它：根据指定id从pending-list中获取已消费但未确认的消息，例如0，是从pending-list中的第一个消息开始')],-1)),s[937]||(s[937]=i("p",null,"消费者监听消息的基本思路：",-1)),s[938]||(s[938]=i("p",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653578211854.png",alt:"1653578211854"}),l("STREAM类型消息队列的XREADGROUP命令特点：")],-1)),s[939]||(s[939]=i("ul",null,[i("li",null,"消息可回溯"),i("li",null,"可以多消费者争抢消息，加快消费速度"),i("li",null,"可以阻塞读取"),i("li",null,"没有消息漏读的风险"),i("li",null,"有消息确认机制，保证消息至少被消费一次")],-1)),s[940]||(s[940]=i("p",null,"最后我们来个小对比",-1)),s[941]||(s[941]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653578560691.png",alt:"1653578560691",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[942]||(s[942]=i("h4",{id:"_7-6-基于-redis-的-stream-结构作为消息队列-实现异步秒杀下单",tabindex:"-1"},[l("7.6 基于 Redis 的 Stream 结构作为消息队列，实现异步秒杀下单 "),i("a",{class:"header-anchor",href:"#_7-6-基于-redis-的-stream-结构作为消息队列-实现异步秒杀下单","aria-label":'Permalink to "7.6 基于 Redis 的 Stream 结构作为消息队列，实现异步秒杀下单"'},"​")],-1)),s[943]||(s[943]=i("p",null,"需求：",-1)),s[944]||(s[944]=i("ul",null,[i("li",null,[l("创建一个Stream类型的消息队列，名为"),i("code",null,"stream.orders")]),i("li",null,[l("修改之前的秒杀下单Lua脚本，在认定有抢购资格后，直接向"),i("code",null,"stream.orders"),l("中添加消息，内容包含voucherId、userId、orderId")]),i("li",null,[l("项目启动时，开启一个线程任务，尝试获取"),i("code",null,"stream.orders"),l("中的消息，完成下单")])],-1)),s[945]||(s[945]=i("p",null,"修改lua表达式,新增3.6",-1)),s[946]||(s[946]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1656082824939.png",alt:"1656082824939",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[947]||(s[947]=i("p",null,[i("strong",null,"VoucherOrderServiceImpl")],-1)),s[948]||(s[948]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrderHandler"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Runnable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        while"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 1.获取消息队列中的订单信息 XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 >")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                List<MapRecord<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> list "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForStream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Consumer."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"from"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"g1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"c1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    StreamReadOptions."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"empty"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"block"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Duration."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ofSeconds"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    StreamOffset."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stream.orders"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ReadOffset."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lastConsumed"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                );")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 2.判断订单信息是否为空")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (list "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 如果为null，说明没有消息，继续下一次循环")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    continue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 解析数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                MapRecord<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> record "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> value "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," record."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                VoucherOrder voucherOrder "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fillBeanWithMap"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value, "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 3.创建订单")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                createVoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 4.确认消息 XACK")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForStream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"acknowledge"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"s1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"g1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", record."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"处理订单异常"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //处理异常消息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                handlePendingList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handlePendingList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        while"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 1.获取pending-list中的订单信息 XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                List<MapRecord<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> list "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForStream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Consumer."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"from"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"g1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"c1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    StreamReadOptions."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"empty"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    StreamOffset."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stream.orders"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ReadOffset."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"from"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"0"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                );")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 2.判断订单信息是否为空")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (list "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 如果为null，说明没有异常消息，结束循环")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    break"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 解析数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                MapRecord<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> record "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> value "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," record."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                VoucherOrder voucherOrder "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fillBeanWithMap"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value, "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," VoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 3.创建订单")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                createVoucherOrder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(voucherOrder);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 4.确认消息 XACK")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForStream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"acknowledge"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"s1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"g1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", record."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"处理pendding订单异常"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Thread."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Exception "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    e."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"printStackTrace"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[949]||(s[949]=i("hr",null,null,-1)),s[950]||(s[950]=i("h3",{id:"_8-达人探店",tabindex:"-1"},[l("8. 达人探店 "),i("a",{class:"header-anchor",href:"#_8-达人探店","aria-label":'Permalink to "8. 达人探店"'},"​")],-1)),s[951]||(s[951]=i("h4",{id:"_8-1-达人探店-发布探店笔记",tabindex:"-1"},[l("8.1 达人探店-发布探店笔记 "),i("a",{class:"header-anchor",href:"#_8-1-达人探店-发布探店笔记","aria-label":'Permalink to "8.1 达人探店-发布探店笔记"'},"​")],-1)),s[952]||(s[952]=i("p",null,"发布探店笔记",-1)),s[953]||(s[953]=i("p",null,[l("探店笔记类似点评网站的评价，往往是图文结合。对应的表有两个： "),i("code",null,"tb_blog"),l("：探店笔记表，包含笔记中的标题、文字、图片等 "),i("code",null,"tb_blog_comments"),l("：其他用户对探店笔记的评价")],-1)),s[954]||(s[954]=i("p",null,[i("strong",null,"具体发布流程")],-1)),s[955]||(s[955]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653578992639.png",alt:"1653578992639",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[956]||(s[956]=i("p",null,"上传接口",-1)),s[957]||(s[957]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Slf4j")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RestController")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"upload"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UploadController"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"blog"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"uploadImage"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"file"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") MultipartFile "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"image"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 获取原始文件名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String originalFilename "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," image."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOriginalFilename"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 生成新文件名")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String fileName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createNewFileName"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(originalFilename);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 保存文件")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            image."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"transferTo"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," File"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SystemConstants.IMAGE_UPLOAD_DIR, fileName));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 返回结果")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"文件上传成功，{}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", fileName);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(fileName);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (IOException "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"文件上传失败"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[958]||(s[958]=i("p",null,[l("注意：同学们在操作时，需要修改"),i("code",null,"SystemConstants.IMAGE_UPLOAD_DIR"),l(" 自己图片所在的地址，在实际开发中图片一般会放在nginx上或者是云存储上。")],-1)),s[959]||(s[959]=i("p",null,"BlogController",-1)),s[960]||(s[960]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RestController")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/blog"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BlogController"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Resource")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IBlogService blogService;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveBlog"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestBody"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Blog "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"blog"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //获取登录用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserDTO user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        blog."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUpdateTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //保存探店博文")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        blogService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveBlog"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //返回id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[961]||(s[961]=i("h4",{id:"_8-2-达人探店-查看探店笔记",tabindex:"-1"},[l("8.2 达人探店 - 查看探店笔记 "),i("a",{class:"header-anchor",href:"#_8-2-达人探店-查看探店笔记","aria-label":'Permalink to "8.2 达人探店 - 查看探店笔记"'},"​")],-1)),s[962]||(s[962]=i("p",null,"实现查看发布探店笔记的接口",-1)),s[963]||(s[963]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653579931626.png",alt:"1653579931626",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[964]||(s[964]=i("p",null,"实现代码：",-1)),s[965]||(s[965]=i("p",null,[i("strong",null,"BlogServiceImpl")],-1)),s[966]||(s[966]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.查询blog")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Blog blog "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (blog "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"笔记不存在！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.查询blog有关的用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    queryBlogUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[967]||(s[967]=i("h4",{id:"_8-3-达人探店-点赞功能",tabindex:"-1"},[l("8.3 达人探店 - 点赞功能 "),i("a",{class:"header-anchor",href:"#_8-3-达人探店-点赞功能","aria-label":'Permalink to "8.3 达人探店 - 点赞功能"'},"​")],-1)),s[968]||(s[968]=i("p",null,"初始代码",-1)),s[969]||(s[969]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/likes/{id}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogLikes"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long id) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //修改点赞数量")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    blogService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"liked = liked +1 "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",id)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[970]||(s[970]=i("p",null,"问题分析：这种方式会导致一个用户无限点赞，明显是不合理的",-1)),s[971]||(s[971]=i("p",null,"造成这个问题的原因是，我们现在的逻辑，发起请求只是给数据库+1，所以才会出现这个问题",-1)),s[972]||(s[972]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653581590453.png",alt:"1653581590453",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[973]||(s[973]=i("p",null,"完善点赞功能",-1)),s[974]||(s[974]=i("p",null,"需求：",-1)),s[975]||(s[975]=i("ul",null,[i("li",null,"同一个用户只能点赞一次，再次点击则取消点赞"),i("li",null,"如果当前用户已经点赞，则点赞按钮高亮显示（前端已实现，判断字段Blog类的isLike属性）")],-1)),s[976]||(s[976]=i("p",null,"实现步骤：",-1)),s[977]||(s[977]=i("ul",null,[i("li",null,"给Blog类中添加一个isLike字段，标示是否被当前用户点赞"),i("li",null,"修改点赞功能，利用Redis的set集合判断是否点赞过，未点赞过则点赞数+1，已点赞过则点赞数-1"),i("li",null,"修改根据id查询Blog的业务，判断当前登录用户是否点赞过，赋值给isLike字段"),i("li",null,"修改分页查询Blog业务，判断当前登录用户是否点赞过，赋值给isLike字段")],-1)),s[978]||(s[978]=i("p",null,"为什么采用set集合：",-1)),s[979]||(s[979]=i("p",null,"因为我们的数据是不能重复的，当用户操作过之后，无论他怎么操作，都是",-1)),s[980]||(s[980]=i("p",null,"具体步骤：",-1)),s[981]||(s[981]=i("p",null,"1、在Blog 添加一个字段",-1)),s[982]||(s[982]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TableField"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exist"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean isLike;")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[983]||(s[983]=i("p",null,"2、修改代码",-1)),s[984]||(s[984]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"likeBlog"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取登录用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断当前登录用户是否已经点赞")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BLOG_LIKED_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Boolean isMember "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isMember"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, userId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(BooleanUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFalse"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(isMember)){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"             //3.如果未点赞，可以点赞")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //3.1 数据库点赞数+1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"liked = liked + 1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //3.2 保存用户到Redis的set集合")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(isSuccess){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key,userId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"             //4.如果已点赞，取消点赞")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //4.1 数据库点赞数-1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"liked = liked - 1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //4.2 把用户从Redis的set集合移除")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(isSuccess){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key,userId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[985]||(s[985]=i("h4",{id:"_8-4-达人探店-点赞排行榜",tabindex:"-1"},[l("8.4 达人探店 - 点赞排行榜 "),i("a",{class:"header-anchor",href:"#_8-4-达人探店-点赞排行榜","aria-label":'Permalink to "8.4 达人探店 - 点赞排行榜"'},"​")],-1)),s[986]||(s[986]=i("p",null,"在探店笔记的详情页面，应该把给该笔记点赞的人显示出来，比如最早点赞的TOP5，形成点赞排行榜：",-1)),s[987]||(s[987]=i("p",null,"之前的点赞是放到set集合，但是set集合是不能排序的，所以这个时候，咱们可以采用一个可以排序的set集合，就是咱们的sortedSet",-1)),s[988]||(s[988]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653805077118.png",alt:"1653805077118",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[989]||(s[989]=i("p",null,"我们接下来来对比一下这些集合的区别是什么",-1)),s[990]||(s[990]=i("p",null,"所有点赞的人，需要是唯一的，所以我们应当使用set或者是sortedSet",-1)),s[991]||(s[991]=i("p",null,"其次我们需要排序，就可以直接锁定使用sortedSet啦",-1)),s[992]||(s[992]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653805203758.png",alt:"1653805203758",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[993]||(s[993]=i("p",null,"修改代码",-1)),s[994]||(s[994]=i("p",null,"BlogServiceImpl",-1)),s[995]||(s[995]=i("p",null,"点赞逻辑代码",-1)),s[996]||(s[996]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"   @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"likeBlog"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取登录用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断当前登录用户是否已经点赞")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BLOG_LIKED_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Double score "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"score"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, userId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (score "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.如果未点赞，可以点赞")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.1.数据库点赞数 + 1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"liked = liked + 1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.2.保存用户到Redis的set集合  zadd key value score")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isSuccess) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, userId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), System."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.如果已点赞，取消点赞")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.1.数据库点赞数 -1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSql"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"liked = liked - 1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.2.把用户从Redis的set集合移除")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isSuccess) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, userId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," isBlogLiked"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Blog blog) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取登录用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        UserDTO user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 用户未登录，无需查询是否点赞")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," user."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.判断当前登录用户是否已经点赞")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "blog:liked:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," blog."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Double score "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"score"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, userId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        blog."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIsLike"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(score "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[997]||(s[997]=i("p",null,"点赞列表查询列表",-1)),s[998]||(s[998]=i("p",null,"BlogController",-1)),s[999]||(s[999]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/likes/{id}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogLikes"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long id) {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," blogService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogLikes"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1e3]||(s[1e3]=i("p",null,"BlogService",-1)),s[1001]||(s[1001]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogLikes"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BLOG_LIKED_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.查询top5的点赞用户 zrange key 0 4")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Set<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> top5 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"range"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"4"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (top5 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," top5."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collections."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.解析出其中的用户id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ids "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," top5."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"valueOf)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String idStr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StrUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"join"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.根据用户id查询用户 WHERE id IN ( 5 , 1 ) ORDER BY FIELD(id, 5, 1)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UserDTO"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> userDTOS "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"in"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"last"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ORDER BY FIELD(id,"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," idStr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ")"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user, UserDTO.class))")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userDTOS);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1002]||(s[1002]=i("hr",null,null,-1)),s[1003]||(s[1003]=i("h3",{id:"_9-好友关注",tabindex:"-1"},[l("9. 好友关注 "),i("a",{class:"header-anchor",href:"#_9-好友关注","aria-label":'Permalink to "9. 好友关注"'},"​")],-1)),s[1004]||(s[1004]=i("h4",{id:"_9-1-好友关注-关注和取消关注",tabindex:"-1"},[l("9.1 好友关注 - 关注和取消关注 "),i("a",{class:"header-anchor",href:"#_9-1-好友关注-关注和取消关注","aria-label":'Permalink to "9.1 好友关注 - 关注和取消关注"'},"​")],-1)),s[1005]||(s[1005]=i("p",null,"针对用户的操作：可以对用户进行关注和取消关注功能。",-1)),s[1006]||(s[1006]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653806140822.png",alt:"1653806140822",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1007]||(s[1007]=i("p",null,"实现思路：",-1)),s[1008]||(s[1008]=i("p",null,"需求：基于该表数据结构，实现两个接口：",-1)),s[1009]||(s[1009]=i("ul",null,[i("li",null,"关注和取关接口"),i("li",null,"判断是否关注的接口")],-1)),s[1010]||(s[1010]=i("p",null,[l("关注是User之间的关系，是博主与粉丝的关系，数据库中有一张"),i("code",null,"tb_follow"),l("表来标示：")],-1)),s[1011]||(s[1011]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653806253817.png",alt:"1653806253817",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1012]||(s[1012]=i("p",null,"注意: 这里需要把主键修改为自增长，简化开发。",-1)),s[1013]||(s[1013]=i("p",null,[i("strong",null,"FollowController")],-1)),s[1014]||(s[1014]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//关注")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PutMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/{id}/{isFollow}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"follow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long followUserId, @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"isFollow"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Boolean isFollow) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," followService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"follow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(followUserId, isFollow);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//取消关注")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/or/not/{id}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFollow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long followUserId) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"      return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," followService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFollow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(followUserId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1015]||(s[1015]=i("p",null,[i("strong",null,"FollowService")],-1)),s[1016]||(s[1016]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"取消关注service")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFollow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long followUserId) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取登录用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.查询是否关注 select count(*) from tb_follow where user_id = ? and follow_user_id = ?")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Integer count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"follow_user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", followUserId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"count"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.判断")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 关注service")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"follow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long followUserId, Boolean isFollow) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取登录用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "follows:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.判断到底是关注还是取关")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isFollow) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.关注，新增数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Follow follow "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Follow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            follow."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            follow."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setFollowUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(followUserId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(follow);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.取关，删除 delete from tb_follow where user_id = ? and follow_user_id = ?")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            remove"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueryWrapper<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Follow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"follow_user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", followUserId));")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1017]||(s[1017]=i("h4",{id:"_9-2-好友关注-共同关注",tabindex:"-1"},[l("9.2 好友关注 - 共同关注 "),i("a",{class:"header-anchor",href:"#_9-2-好友关注-共同关注","aria-label":'Permalink to "9.2 好友关注 - 共同关注"'},"​")],-1)),s[1018]||(s[1018]=i("p",null,"想要去看共同关注的好友，需要首先进入到这个页面，这个页面会发起两个请求",-1)),s[1019]||(s[1019]=i("p",null,"1、去查询用户的详情",-1)),s[1020]||(s[1020]=i("p",null,"2、去查询用户的笔记",-1)),s[1021]||(s[1021]=i("p",null,"以上两个功能和共同关注没有什么关系，大家可以自行将笔记中的代码拷贝到idea中就可以实现这两个功能了，我们的重点在于共同关注功能。",-1)),s[1022]||(s[1022]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653806706296.png",alt:"1653806706296",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1023]||(s[1023]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// UserController 根据id查询用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/{id}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryUserById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long userId){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"	// 查询详情")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	User user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"	if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"		return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	UserDTO userDTO "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user, UserDTO.class);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"	// 返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"	return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userDTO);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// BlogController  根据id查询博主的探店笔记")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/of/user"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogByUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"		@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "current"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"defaultValue"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Integer current,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"		@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long id) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"	// 根据用户查询")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	Page<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Blog"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> page "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," blogService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"			."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"page"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Page<>(current, SystemConstants.MAX_PAGE_SIZE));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"	// 获取当前页数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Blog"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> records "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," page."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRecords"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"	return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(records);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1024]||(s[1024]=i("p",null,"接下来我们来看看共同关注如何实现：",-1)),s[1025]||(s[1025]=i("p",null,"需求：利用Redis中恰当的数据结构，实现共同关注功能。在博主个人页面展示出当前用户与博主的共同关注呢。",-1)),s[1026]||(s[1026]=i("p",null,"当然是使用我们之前学习过的set集合咯，在set集合中，有交集并集补集的api，我们可以把两人的关注的人分别放入到一个set集合中，然后再通过api去查看这两个set集合中的交集数据。",-1)),s[1027]||(s[1027]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653806973212.png",alt:"1653806973212",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1028]||(s[1028]=i("p",null,"我们先来改造当前的关注列表",-1)),s[1029]||(s[1029]=i("p",null,"改造原因是因为我们需要在用户关注了某位用户后，需要将数据放入到set集合中，方便后续进行共同关注，同时当取消关注时，也需要从set集合中进行删除",-1)),s[1030]||(s[1030]=i("p",null,[i("strong",null,"FollowServiceImpl")],-1)),s[1031]||(s[1031]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"follow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long followUserId, Boolean isFollow) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取登录用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "follows:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.判断到底是关注还是取关")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isFollow) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.关注，新增数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Follow follow "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Follow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        follow."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(userId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        follow."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setFollowUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(followUserId);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(follow);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isSuccess) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 把关注用户的id，放入redis的set集合 sadd userId followerUserId")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, followUserId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.取关，删除 delete from tb_follow where user_id = ? and follow_user_id = ?")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," remove"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueryWrapper<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Follow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", userId)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"follow_user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", followUserId));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (isSuccess) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 把关注用户的id从Redis集合中移除")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, followUserId."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1032]||(s[1032]=i("p",null,[i("strong",null,"具体的关注代码：")],-1)),s[1033]||(s[1033]=i("p",null,[i("strong",null,"FollowServiceImpl")],-1)),s[1034]||(s[1034]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"followCommons"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long id) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取当前用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "follows:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.求交集")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key2 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "follows:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Set<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> intersect "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"intersect"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, key2);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (intersect "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," intersect."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 无交集")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collections."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.解析id集合")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ids "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," intersect."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"valueOf)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.查询用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UserDTO"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> users "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"listByIds"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ids)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeanUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user, UserDTO.class))")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(users);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1035]||(s[1035]=i("h4",{id:"_9-3-好友关注-feed-流实现方案",tabindex:"-1"},[l("9.3 好友关注 - Feed 流实现方案 "),i("a",{class:"header-anchor",href:"#_9-3-好友关注-feed-流实现方案","aria-label":'Permalink to "9.3 好友关注 - Feed 流实现方案"'},"​")],-1)),s[1036]||(s[1036]=i("p",null,"当我们关注了用户后，这个用户发了动态，那么我们应该把这些数据推送给用户，这个需求，其实我们又把他叫做Feed流，关注推送也叫做Feed流，直译为投喂。为用户持续的提供“沉浸式”的体验，通过无限下拉刷新获取新的信息。",-1)),s[1037]||(s[1037]=i("p",null,"对于传统的模式的内容解锁：我们是需要用户去通过搜索引擎或者是其他的方式去解锁想要看的内容",-1)),s[1038]||(s[1038]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653808641260.png",alt:"1653808641260",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1039]||(s[1039]=i("p",null,"对于新型的Feed流的的效果：不需要我们用户再去推送信息，而是系统分析用户到底想要什么，然后直接把内容推送给用户，从而使用户能够更加的节约时间，不用主动去寻找。",-1)),s[1040]||(s[1040]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653808993693.png",alt:"1653808993693",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1041]||(s[1041]=i("p",null,"Feed流的实现有两种模式：",-1)),s[1042]||(s[1042]=i("p",null,"Feed流产品有两种常见模式： Timeline：不做内容筛选，简单的按照内容发布时间排序，常用于好友或关注。例如朋友圈",-1)),s[1043]||(s[1043]=i("ul",null,[i("li",null,"优点：信息全面，不会有缺失。并且实现也相对简单"),i("li",null,"缺点：信息噪音较多，用户不一定感兴趣，内容获取效率低")],-1)),s[1044]||(s[1044]=i("p",null,"智能排序：利用智能算法屏蔽掉违规的、用户不感兴趣的内容。推送用户感兴趣信息来吸引用户",-1)),s[1045]||(s[1045]=i("ul",null,[i("li",null,"优点：投喂用户感兴趣信息，用户粘度很高，容易沉迷"),i("li",null,"缺点：如果算法不精准，可能起到反作用 本例中的个人页面，是基于关注的好友来做Feed流，因此采用Timeline的模式。该模式的实现方案有三种：")],-1)),s[1046]||(s[1046]=i("p",null,"我们本次针对好友的操作，采用的就是Timeline的方式，只需要拿到我们关注用户的信息，然后按照时间排序即可",-1)),s[1047]||(s[1047]=i("p",null,"，因此采用Timeline的模式。该模式的实现方案有三种：",-1)),s[1048]||(s[1048]=i("ul",null,[i("li",null,"拉模式"),i("li",null,"推模式"),i("li",null,"推拉结合")],-1)),s[1049]||(s[1049]=i("p",null,[i("strong",null,"拉模式"),l("：也叫做读扩散")],-1)),s[1050]||(s[1050]=i("p",null,"该模式的核心含义就是：当张三和李四和王五发了消息后，都会保存在自己的邮箱中，假设赵六要读取信息，那么他会从读取他自己的收件箱，此时系统会从他关注的人群中，把他关注人的信息全部都进行拉取，然后在进行排序",-1)),s[1051]||(s[1051]=i("p",null,"优点：比较节约空间，因为赵六在读信息时，并没有重复读取，而且读取完之后可以把他的收件箱进行清楚。",-1)),s[1052]||(s[1052]=i("p",null,"缺点：比较延迟，当用户读取数据时才去关注的人里边去读取数据，假设用户关注了大量的用户，那么此时就会拉取海量的内容，对服务器压力巨大。",-1)),s[1053]||(s[1053]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653809450816.png",alt:"1653809450816",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1054]||(s[1054]=i("p",null,[i("strong",null,"推模式"),l("：也叫做写扩散。")],-1)),s[1055]||(s[1055]=i("p",null,"推模式是没有写邮箱的，当张三写了一个内容，此时会主动的把张三写的内容发送到他的粉丝收件箱中去，假设此时李四再来读取，就不用再去临时拉取了",-1)),s[1056]||(s[1056]=i("p",null,"优点：时效快，不用临时拉取",-1)),s[1057]||(s[1057]=i("p",null,"缺点：内存压力大，假设一个大V写信息，很多人关注他， 就会写很多分数据到粉丝那边去",-1)),s[1058]||(s[1058]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653809875208.png",alt:"1653809875208",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1059]||(s[1059]=i("p",null,[i("strong",null,"推拉结合模式"),l("：也叫做读写混合，兼具推和拉两种模式的优点。")],-1)),s[1060]||(s[1060]=i("p",null,"推拉模式是一个折中的方案，站在发件人这一段，如果是个普通的人，那么我们采用写扩散的方式，直接把数据写入到他的粉丝中去，因为普通的人他的粉丝关注量比较小，所以这样做没有压力，如果是大V，那么他是直接将数据先写入到一份到发件箱里边去，然后再直接写一份到活跃粉丝收件箱里边去，现在站在收件人这端来看，如果是活跃粉丝，那么大V和普通的人发的都会直接写入到自己收件箱里边来，而如果是普通的粉丝，由于他们上线不是很频繁，所以等他们上线时，再从发件箱里边去拉信息。",-1)),s[1061]||(s[1061]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653812346852.png",alt:"1653812346852",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1062]||(s[1062]=i("h4",{id:"_9-4-好友关注-推送到粉丝收件箱",tabindex:"-1"},[l("9.4 好友关注 - 推送到粉丝收件箱 "),i("a",{class:"header-anchor",href:"#_9-4-好友关注-推送到粉丝收件箱","aria-label":'Permalink to "9.4 好友关注 - 推送到粉丝收件箱"'},"​")],-1)),s[1063]||(s[1063]=i("p",null,"需求：",-1)),s[1064]||(s[1064]=i("ul",null,[i("li",null,"修改新增探店笔记的业务，在保存blog到数据库的同时，推送到粉丝的收件箱"),i("li",null,"收件箱满足可以根据时间戳排序，必须用Redis的数据结构实现"),i("li",null,"查询收件箱数据时，可以实现分页查询")],-1)),s[1065]||(s[1065]=i("p",null,"Feed流中的数据会不断更新，所以数据的角标也在变化，因此不能采用传统的分页模式。",-1)),s[1066]||(s[1066]=i("p",null,"传统了分页在feed流是不适用的，因为我们的数据会随时发生变化",-1)),s[1067]||(s[1067]=i("p",null,"假设在t1 时刻，我们去读取第一页，此时page = 1 ，size = 5 ，那么我们拿到的就是10~6 这几条记录，假设现在t2时候又发布了一条记录，此时t3 时刻，我们来读取第二页，读取第二页传入的参数是page=2 ，size=5 ，那么此时读取到的第二页实际上是从6 开始，然后是6~2 ，那么我们就读取到了重复的数据，所以feed流的分页，不能采用原始方案来做。",-1)),s[1068]||(s[1068]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653813047671.png",alt:"1653813047671",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1069]||(s[1069]=i("p",null,"Feed流的滚动分页",-1)),s[1070]||(s[1070]=i("p",null,"我们需要记录每次操作的最后一条，然后从这个位置开始去读取数据",-1)),s[1071]||(s[1071]=i("p",null,"举个例子：我们从t1时刻开始，拿第一页数据，拿到了10~6，然后记录下当前最后一次拿取的记录，就是6，t2时刻发布了新的记录，此时这个11放到最顶上，但是不会影响我们之前记录的6，此时t3时刻来拿第二页，第二页这个时候拿数据，还是从6后一点的5去拿，就拿到了5-1的记录。我们这个地方可以采用sortedSet来做，可以进行范围查询，并且还可以记录当前获取数据时间戳最小值，就可以实现滚动分页了",-1)),s[1072]||(s[1072]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653813462834.png",alt:"1653813462834",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1073]||(s[1073]=i("p",null,"核心的意思：就是我们在保存完探店笔记后，获得到当前笔记的粉丝，然后把数据推送到粉丝的redis中去。",-1)),s[1074]||(s[1074]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveBlog"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Blog blog) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取登录用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    UserDTO user "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    blog."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.保存探店笔记")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isSuccess "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," save"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"isSuccess){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fail"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"新增笔记失败!"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.查询笔记作者的所有粉丝 select * from tb_follow where follow_user_id = ?")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Follow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> follows "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," followService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"follow_user_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", user."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.推送笔记id给所有粉丝")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Follow follow "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," follows) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.1.获取粉丝id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," follow."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUserId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.2.推送")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," FEED_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, blog."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), System."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.返回id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1075]||(s[1075]=i("h4",{id:"_9-5-好友关注-实现分页查询收邮箱",tabindex:"-1"},[l("9.5 好友关注 - 实现分页查询收邮箱 "),i("a",{class:"header-anchor",href:"#_9-5-好友关注-实现分页查询收邮箱","aria-label":'Permalink to "9.5 好友关注 - 实现分页查询收邮箱"'},"​")],-1)),s[1076]||(s[1076]=i("p",null,"需求：在个人主页的“关注”卡片中，查询并展示推送的Blog信息：",-1)),s[1077]||(s[1077]=i("p",null,"具体操作如下：",-1)),s[1078]||(s[1078]=i("p",null,"1、每次查询完成后，我们要分析出查询出数据的最小时间戳，这个值会作为下一次查询的条件",-1)),s[1079]||(s[1079]=i("p",null,"2、我们需要找到与上一次查询相同的查询个数作为偏移量，下次查询时，跳过这些查询过的数据，拿到我们需要的数据",-1)),s[1080]||(s[1080]=i("p",null,"综上：我们的请求参数中就需要携带 lastId：上一次查询的最小时间戳 和偏移量这两个参数。",-1)),s[1081]||(s[1081]=i("p",null,"这两个参数第一次会由前端来指定，以后的查询就根据后台结果作为条件，再次传递到后台。",-1)),s[1082]||(s[1082]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653819821591.png",alt:"1653819821591",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1083]||(s[1083]=i("p",null,"一、定义出来具体的返回值实体类",-1)),s[1084]||(s[1084]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Data")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ScrollResult"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> list;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Long minTime;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer offset;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1085]||(s[1085]=i("p",null,"BlogController",-1)),s[1086]||(s[1086]=i("p",null,"注意：RequestParam 表示接受url地址栏传参的注解，当方法上参数的名称和url地址栏不相同时，可以通过RequestParam 来进行指定",-1)),s[1087]||(s[1087]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/of/follow"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogOfFollow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lastId"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long max, @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "offset"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"defaultValue"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "0"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Integer offset){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," blogService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogOfFollow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(max, offset);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1088]||(s[1088]=i("p",null,"BlogServiceImpl",-1)),s[1089]||(s[1089]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryBlogOfFollow"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long max, Integer offset) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取当前用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.查询收件箱 ZREVRANGEBYSCORE key Max Min LIMIT offset count")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," FEED_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Set<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ZSetOperations"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TypedTuple"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> typedTuples "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForZSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"reverseRangeByScoreWithScores"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", max, offset, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.非空判断")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (typedTuples "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," typedTuples."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.解析数据：blogId、minTime（时间戳）、offset")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ids "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>(typedTuples."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," minTime "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 2")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," os "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 2")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ZSetOperations.TypedTuple<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> tuple "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," typedTuples) { "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 5 4 4 2 2")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.1.获取id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ids."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(tuple."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.2.获取分数(时间戳）")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," time "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tuple."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getScore"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"longValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(time "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," minTime){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            os"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            minTime "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," time;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            os "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"	os "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," minTime "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," max "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," os "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," os "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," offset;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.根据id查询blog")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String idStr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StrUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"join"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Blog"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> blogs "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"in"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"last"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ORDER BY FIELD(id,"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," idStr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ")"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Blog blog "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," blogs) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.1.查询blog有关的用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        queryBlogUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.2.查询blog是否被点赞")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        isBlogLiked"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blog);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.封装并返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ScrollResult r "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ScrollResult"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    r."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(blogs);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    r."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setOffset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(os);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    r."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMinTime"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(minTime);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(r);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1090]||(s[1090]=i("hr",null,null,-1)),s[1091]||(s[1091]=i("h3",{id:"_10-附近商户",tabindex:"-1"},[l("10. 附近商户 "),i("a",{class:"header-anchor",href:"#_10-附近商户","aria-label":'Permalink to "10. 附近商户"'},"​")],-1)),s[1092]||(s[1092]=i("h4",{id:"_10-1-附近商户-geo-数据结构的基本用法",tabindex:"-1"},[l("10.1 附近商户 - GEO 数据结构的基本用法 "),i("a",{class:"header-anchor",href:"#_10-1-附近商户-geo-数据结构的基本用法","aria-label":'Permalink to "10.1 附近商户 - GEO 数据结构的基本用法"'},"​")],-1)),s[1093]||(s[1093]=i("p",null,"GEO就是Geolocation的简写形式，代表地理坐标。Redis在3.2版本中加入了对GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据。常见的命令有：",-1)),s[1094]||(s[1094]=i("ul",null,[i("li",null,"GEOADD：添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）"),i("li",null,"GEODIST：计算指定的两个点之间的距离并返回"),i("li",null,"GEOHASH：将指定member的坐标转为hash字符串形式并返回"),i("li",null,"GEOPOS：返回指定member的坐标"),i("li",null,"GEORADIUS：指定圆心、半径，找到该圆内包含的所有member，并按照与圆心之间的距离排序后返回。6.以后已废弃"),i("li",null,"GEOSEARCH：在指定范围内搜索member，并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形。6.2.新功能"),i("li",null,"GEOSEARCHSTORE：与GEOSEARCH功能一致，不过可以把结果存储到一个指定的key。 6.2.新功能")],-1)),s[1095]||(s[1095]=i("h4",{id:"_10-2-附近商户-导入店铺数据到-geo",tabindex:"-1"},[l("10.2 附近商户 - 导入店铺数据到 GEO "),i("a",{class:"header-anchor",href:"#_10-2-附近商户-导入店铺数据到-geo","aria-label":'Permalink to "10.2 附近商户 - 导入店铺数据到 GEO"'},"​")],-1)),s[1096]||(s[1096]=i("p",null,"具体场景说明：",-1)),s[1097]||(s[1097]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653822036941.png",alt:"1653822036941",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1098]||(s[1098]=i("p",null,"当我们点击美食之后，会出现一系列的商家，商家中可以按照多种排序方式，我们此时关注的是距离，这个地方就需要使用到我们的GEO，向后台传入当前app收集的地址(我们此处是写死的) ，以当前坐标作为圆心，同时绑定相同的店家类型type，以及分页信息，把这几个条件传入后台，后台查询出对应的数据再返回。",-1)),s[1099]||(s[1099]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653822021827.png",alt:"1653822021827",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1100]||(s[1100]=i("p",null,"我们要做的事情是：将数据库表中的数据导入到redis中去，redis中的GEO，GEO在redis中就一个menber和一个经纬度，我们把x和y轴传入到redis做的经纬度位置去，但我们不能把所有的数据都放入到menber中去，毕竟作为redis是一个内存级数据库，如果存海量数据，redis还是力不从心，所以我们在这个地方存储他的id即可。",-1)),s[1101]||(s[1101]=i("p",null,"但是这个时候还有一个问题，就是在redis中并没有存储type，所以我们无法根据type来对数据进行筛选，所以我们可以按照商户类型做分组，类型相同的商户作为同一组，以typeId为key存入同一个GEO集合中即可",-1)),s[1102]||(s[1102]=i("p",null,"代码",-1)),s[1103]||(s[1103]=i("p",null,[i("strong",null,"HmDianPingApplicationTests")],-1)),s[1104]||(s[1104]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," loadShopData"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.查询店铺信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> list "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shopService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.把店铺分组，按照typeId分组，typeId一致的放到一个集合")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> map "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"groupingBy"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Shop"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getTypeId));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.分批完成写入Redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Map.Entry<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> entry "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entrySet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.1.获取类型id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long typeId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," entry."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SHOP_GEO_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," typeId;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.2.获取同类型的店铺的集合")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> value "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," entry."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RedisGeoCommands"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GeoLocation"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> locations "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>(value."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.3.写入redis GEOADD key 经度 纬度 member")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Shop shop "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," value) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            locations."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisGeoCommands.GeoLocation<>(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    shop."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Point"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shop."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getX"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), shop."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getY"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForGeo"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, locations);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1105]||(s[1105]=i("h4",{id:"_10-3-附近商户-实现附近商户功能",tabindex:"-1"},[l("10.3 附近商户 - 实现附近商户功能 "),i("a",{class:"header-anchor",href:"#_10-3-附近商户-实现附近商户功能","aria-label":'Permalink to "10.3 附近商户 - 实现附近商户功能"'},"​")],-1)),s[1106]||(s[1106]=i("p",null,"SpringDataRedis的2.3.9版本并不支持Redis 6.2提供的GEOSEARCH命令，因此我们需要提示其版本，修改自己的POM",-1)),s[1107]||(s[1107]=i("p",null,"第一步：导入pom",-1)),s[1108]||(s[1108]=i("div",{class:"language-xml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"xml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-data-redis</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusions"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusion"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-data-redis</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.data</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusion"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusion"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">lettuce-core</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">io.lettuce</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusion"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    </"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"exclusions"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.data</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-data-redis</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">2.6.2</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">io.lettuce</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">lettuce-core</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">6.1.6.RELEASE</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1109]||(s[1109]=i("p",null,"第二步：",-1)),s[1110]||(s[1110]=i("p",null,[i("strong",null,"ShopController")],-1)),s[1111]||(s[1111]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/of/type"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryShopByType"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"typeId"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Integer typeId,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "current"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"defaultValue"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Integer current,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "x"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"required"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Double x,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "y"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"required"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Double y")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"   return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shopService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryShopByType"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(typeId, current, x, y);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1112]||(s[1112]=i("p",null,[i("strong",null,"ShopServiceImpl")],-1)),s[1113]||(s[1113]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryShopByType"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Integer typeId, Integer current, Double x, Double y) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.判断是否需要根据坐标查询")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (x "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," y "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 不需要坐标查询，按数据库查询")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Page<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> page "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"type_id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", typeId)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"page"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Page<>(current, SystemConstants.DEFAULT_PAGE_SIZE));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 返回数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(page."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRecords"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.计算分页参数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," from "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (current "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SystemConstants.DEFAULT_PAGE_SIZE;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," end "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," current "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SystemConstants.DEFAULT_PAGE_SIZE;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.查询redis、按照距离排序、分页。结果：shopId、distance")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SHOP_GEO_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," typeId;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        GeoResults<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RedisGeoCommands"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GeoLocation"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> results "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForGeo"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"search"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        key,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        GeoReference."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fromCoordinate"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(x, y),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Distance"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        RedisGeoCommands.GeoSearchCommandArgs."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newGeoSearchArgs"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"includeDistance"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"limit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(end)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                );")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.解析出id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (results "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collections."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<GeoResult<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RedisGeoCommands"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GeoLocation"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">>> list "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," results."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getContent"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," from) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 没有下一页了，结束")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collections."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"emptyList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.1.截取 from ~ end的部分")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ids "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>(list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Distance"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> distanceMap "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"skip"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(from)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"forEach"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(result "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.2.获取店铺id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String shopIdStr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getContent"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ids."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopIdStr));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.3.获取距离")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Distance distance "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDistance"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            distanceMap."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shopIdStr, distance);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.根据id查询Shop")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String idStr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StrUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"join"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Shop"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> shops "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"in"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ids)."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"last"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ORDER BY FIELD(id,"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," idStr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ")"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Shop shop "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," shops) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            shop."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setDistance"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(distanceMap."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shop."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(shops);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1114]||(s[1114]=i("hr",null,null,-1)),s[1115]||(s[1115]=i("h3",{id:"_11-用户签到",tabindex:"-1"},[l("11. 用户签到 "),i("a",{class:"header-anchor",href:"#_11-用户签到","aria-label":'Permalink to "11. 用户签到"'},"​")],-1)),s[1116]||(s[1116]=i("h4",{id:"_11-1-用户签到-bitmap-功能演示",tabindex:"-1"},[l("11.1 用户签到 - BitMap 功能演示 "),i("a",{class:"header-anchor",href:"#_11-1-用户签到-bitmap-功能演示","aria-label":'Permalink to "11.1 用户签到 - BitMap 功能演示"'},"​")],-1)),s[1117]||(s[1117]=i("p",null,"我们针对签到功能完全可以通过mysql来完成，比如说以下这张表",-1)),s[1118]||(s[1118]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653823145495.png",alt:"1653823145495",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1119]||(s[1119]=i("p",null,"用户一次签到，就是一条记录，假如有1000万用户，平均每人每年签到次数为10次，则这张表一年的数据量为 1亿条",-1)),s[1120]||(s[1120]=i("p",null,"每签到一次需要使用（8 + 8 + 1 + 1 + 3 + 1）共22 字节的内存，一个月则最多需要600多字节",-1)),s[1121]||(s[1121]=i("p",null,"我们如何能够简化一点呢？其实可以考虑小时候一个挺常见的方案，就是小时候，咱们准备一张小小的卡片，你只要签到就打上一个勾，我最后判断你是否签到，其实只需要到小卡片上看一看就知道了",-1)),s[1122]||(s[1122]=i("p",null,"我们可以采用类似这样的方案来实现我们的签到需求。",-1)),s[1123]||(s[1123]=i("p",null,"我们按月来统计用户签到信息，签到记录为1，未签到则记录为0.",-1)),s[1124]||(s[1124]=i("p",null,"把每一个bit位对应当月的每一天，形成了映射关系。用0和1标示业务状态，这种思路就称为位图（BitMap）。这样我们就用极小的空间，来实现了大量数据的表示",-1)),s[1125]||(s[1125]=i("p",null,"Redis中是利用string类型数据结构实现BitMap，因此最大上限是512M，转换为bit则是 2^32个bit位。",-1)),s[1126]||(s[1126]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653824498278.png",alt:"1653824498278",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1127]||(s[1127]=i("p",null,"BitMap的操作命令有：",-1)),s[1128]||(s[1128]=i("ul",null,[i("li",null,"SETBIT：向指定位置（offset）存入一个0或1"),i("li",null,"GETBIT ：获取指定位置（offset）的bit值"),i("li",null,"BITCOUNT ：统计BitMap中值为1的bit位的数量"),i("li",null,"BITFIELD ：操作（查询、修改、自增）BitMap中bit数组中的指定位置（offset）的值"),i("li",null,"BITFIELD_RO ：获取BitMap中bit数组，并以十进制形式返回"),i("li",null,"BITOP ：将多个BitMap的结果做位运算（与 、或、异或）"),i("li",null,"BITPOS ：查找bit数组中指定范围内第一个0或1出现的位置")],-1)),s[1129]||(s[1129]=i("h4",{id:"_11-2-用户签到-实现签到功能",tabindex:"-1"},[l("11.2 用户签到-实现签到功能 "),i("a",{class:"header-anchor",href:"#_11-2-用户签到-实现签到功能","aria-label":'Permalink to "11.2 用户签到-实现签到功能"'},"​")],-1)),s[1130]||(s[1130]=i("p",null,"需求：实现签到接口，将当前用户当天签到信息保存到Redis中",-1)),s[1131]||(s[1131]=i("p",null,"思路：我们可以把年和月作为bitMap的key，然后保存到一个bitMap中，每次签到就到对应的位上把数字从0变成1，只要对应是1，就表明说明这一天已经签到了，反之则没有签到。",-1)),s[1132]||(s[1132]=i("p",null,"我们通过接口文档发现，此接口并没有传递任何的参数，没有参数怎么确实是哪一天签到呢？这个很容易，可以通过后台代码直接获取即可，然后到对应的地址上去修改bitMap。",-1)),s[1133]||(s[1133]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653833970361.png",alt:"1653833970361",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1134]||(s[1134]=i("p",null,[i("strong",null,"代码")],-1)),s[1135]||(s[1135]=i("p",null,"UserController",-1)),s[1136]||(s[1136]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/sign"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sign"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sign"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1137]||(s[1137]=i("p",null,"UserServiceImpl",-1)),s[1138]||(s[1138]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sign"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取当前登录用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.获取日期")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    LocalDateTime now "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.拼接key")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String keySuffix "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"format"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(DateTimeFormatter."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ofPattern"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":yyyyMM"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," USER_SIGN_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keySuffix;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.获取今天是本月的第几天")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dayOfMonth "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDayOfMonth"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.写入Redis SETBIT key offset 1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setBit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, dayOfMonth "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1139]||(s[1139]=i("h4",{id:"_11-3-用户签到-签到统计",tabindex:"-1"},[l("11.3 用户签到-签到统计 "),i("a",{class:"header-anchor",href:"#_11-3-用户签到-签到统计","aria-label":'Permalink to "11.3 用户签到-签到统计"'},"​")],-1)),s[1140]||(s[1140]=i("p",null,"**问题1：**什么叫做连续签到天数？ 从最后一次签到开始向前统计，直到遇到第一次未签到为止，计算总的签到次数，就是连续签到天数。",-1)),s[1141]||(s[1141]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653834455899.png",alt:"1653834455899",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1142]||(s[1142]=i("p",null,"Java逻辑代码：获得当前这个月的最后一次签到数据，定义一个计数器，然后不停的向前统计，直到获得第一个非0的数字即可，每得到一个非0的数字计数器+1，直到遍历完所有的数据，就可以获得当前月的签到总天数了",-1)),s[1143]||(s[1143]=i("p",null,"**问题2：**如何得到本月到今天为止的所有签到数据？",-1)),s[1144]||(s[1144]=i("p",null,[i("code",null,"BITFIELD key GET u[dayOfMonth] 0")],-1)),s[1145]||(s[1145]=i("p",null,"假设今天是10号，那么我们就可以从当前月的第一天开始，获得到当前这一天的位数，是10号，那么就是10位，去拿这段时间的数据，就能拿到所有的数据了，那么这10天里边签到了多少次呢？统计有多少个1即可。",-1)),s[1146]||(s[1146]=i("p",null,[i("strong",null,"问题3：如何从后向前遍历每个bit位？")],-1)),s[1147]||(s[1147]=i("p",null,"注意：bitMap返回的数据是10进制，哪假如说返回一个数字8，那么我哪儿知道到底哪些是0，哪些是1呢？我们只需要让得到的10进制数字和1做与运算就可以了，因为1只有遇见1 才是1，其他数字都是0 ，我们把签到结果和1进行与操作，每与一次，就把签到结果向右移动一位，依次内推，我们就能完成逐个遍历的效果了。",-1)),s[1148]||(s[1148]=i("p",null,"需求：实现下面接口，统计当前用户截止当前时间在本月的连续签到天数",-1)),s[1149]||(s[1149]=i("p",null,"有用户有时间我们就可以组织出对应的key，此时就能找到这个用户截止这天的所有签到记录，再根据这套算法，就能统计出来他连续签到的次数了",-1)),s[1150]||(s[1150]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653835784444.png",alt:"1653835784444",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1151]||(s[1151]=i("p",null,"代码",-1)),s[1152]||(s[1152]=i("p",null,[i("strong",null,"UserController")],-1)),s[1153]||(s[1153]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/sign/count"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"signCount"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"signCount"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1154]||(s[1154]=i("p",null,[i("strong",null,"UserServiceImpl")],-1)),s[1155]||(s[1155]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"signCount"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.获取当前登录用户")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserHolder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.获取日期")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    LocalDateTime now "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalDateTime."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.拼接key")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String keySuffix "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"format"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(DateTimeFormatter."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ofPattern"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":yyyyMM"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," USER_SIGN_KEY "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userId "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keySuffix;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.获取今天是本月的第几天")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dayOfMonth "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," now."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDayOfMonth"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 5.获取本月截止今天为止的所有的签到记录，返回的是一个十进制的数字 BITFIELD sign:5:202203 GET u14 0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> result "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bitField"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            key,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            BitFieldSubCommands."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(BitFieldSubCommands.BitFieldType."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unsigned"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(dayOfMonth))."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueAt"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    );")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (result "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 没有任何签到结果")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long num "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (num "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," num "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 6.循环遍历")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    while"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 6.1.让这个数字与1做与运算，得到数字的最后一个bit位"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  // 判断这个bit位是否为0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((num "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果为0，说明未签到，结束")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            break"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果不为0，说明已签到，计数器+1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            count"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 把数字右移一位，抛弃最后一个bit位，继续下一个bit位")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        num "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">>>="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1156]||(s[1156]=i("h4",{id:"_11-4-额外加餐-关于使用-bitmap-来解决缓存穿透的方案",tabindex:"-1"},[l("11.4 额外加餐 - 关于使用 bitmap 来解决缓存穿透的方案 "),i("a",{class:"header-anchor",href:"#_11-4-额外加餐-关于使用-bitmap-来解决缓存穿透的方案","aria-label":'Permalink to "11.4 额外加餐 - 关于使用 bitmap 来解决缓存穿透的方案"'},"​")],-1)),s[1157]||(s[1157]=i("p",null,[l("回顾"),i("strong",null,"缓存穿透"),l("：")],-1)),s[1158]||(s[1158]=i("p",null,"发起了一个数据库不存在的，redis里边也不存在的数据，通常你可以把他看成一个攻击",-1)),s[1159]||(s[1159]=i("p",null,"解决方案：",-1)),s[1160]||(s[1160]=i("ul",null,[i("li",null,[i("p",null,[l("判断"),i("code",null,"id<0")])]),i("li",null,[i("p",null,"如果数据库是空，那么就可以直接往redis里边把这个空数据缓存起来")])],-1)),s[1161]||(s[1161]=i("p",null,"第一种解决方案：遇到的问题是如果用户访问的是id不存在的数据，则此时就无法生效",-1)),s[1162]||(s[1162]=i("p",null,"第二种解决方案：遇到的问题是：如果是不同的id那就可以防止下次过来直击数据",-1)),s[1163]||(s[1163]=i("p",null,"所以我们如何解决呢？",-1)),s[1164]||(s[1164]=i("p",null,"我们可以将数据库的数据，所对应的id写入到一个list集合中，当用户过来访问的时候，我们直接去判断list中是否包含当前的要查询的数据，如果说用户要查询的id数据并不在list集合中，则直接返回，如果list中包含对应查询的id数据，则说明不是一次缓存穿透数据，则直接放行。",-1)),s[1165]||(s[1165]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653836416586.png",alt:"1653836416586",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1166]||(s[1166]=i("p",null,"现在的问题是这个主键其实并没有那么短，而是很长的一个 主键",-1)),s[1167]||(s[1167]=i("p",null,"哪怕你单独去提取这个主键，但是在11年左右，淘宝的商品总量就已经超过10亿个",-1)),s[1168]||(s[1168]=i("p",null,"所以如果采用以上方案，这个list也会很大，所以我们可以使用bitmap来减少list的存储空间",-1)),s[1169]||(s[1169]=i("p",null,"我们可以把list数据抽象成一个非常大的bitmap，我们不再使用list，而是将db中的id数据利用哈希思想，比如：",-1)),s[1170]||(s[1170]=i("p",null,[i("code",null,"id % bitmap.size"),l(" = 算出当前这个id对应应该落在bitmap的哪个索引上，然后将这个值从0变成1，然后当用户来查询数据时，此时已经没有了list，让用户用他查询的id去用相同的哈希算法， 算出来当前这个id应当落在bitmap的哪一位，然后判断这一位是0，还是1，如果是0则表明这一位上的数据一定不存在， 采用这种方式来处理，需要重点考虑一个事情，就是误差率，所谓的误差率就是指当发生哈希冲突的时候，产生的误差。")],-1)),s[1171]||(s[1171]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653836578970.png",alt:"1653836578970",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1172]||(s[1172]=i("hr",null,null,-1)),s[1173]||(s[1173]=i("h3",{id:"_12-uv统计",tabindex:"-1"},[l("12. UV统计 "),i("a",{class:"header-anchor",href:"#_12-uv统计","aria-label":'Permalink to "12. UV统计"'},"​")],-1)),s[1174]||(s[1174]=i("h4",{id:"_12-1-uv-统计-hyperloglog",tabindex:"-1"},[l("12.1 UV 统计 - HyperLogLog "),i("a",{class:"header-anchor",href:"#_12-1-uv-统计-hyperloglog","aria-label":'Permalink to "12.1 UV 统计 - HyperLogLog"'},"​")],-1)),s[1175]||(s[1175]=i("p",null,"首先我们搞懂两个概念：",-1)),s[1176]||(s[1176]=i("ul",null,[i("li",null,"UV：全称Unique Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录1次。"),i("li",null,"PV：全称Page View，也叫页面访问量或点击量，用户每访问网站的一个页面，记录1次PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。"),i("li",null,"通常来说UV会比PV大很多，所以衡量同一个网站的访问量，我们需要综合考虑很多因素，所以我们只是单纯的把这两个值作为一个参考值"),i("li",null,"UV统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。但是如果每个访问的用户都保存到Redis中，数据量会非常恐怖，那怎么处理呢？"),i("li",null,[l("Hyperloglog(HLL)是从Loglog算法派生的概率算法，用于确定非常大的集合的基数，而不需要存储其所有值。相关算法原理大家可以参考："),i("a",{href:"https://juejin.cn/post/6844903785744056333#heading-0",target:"_blank",rel:"noreferrer"},"https://juejin.cn/post/6844903785744056333#heading-0")]),i("li",null,[l("Redis中的HLL是基于string结构实现的，单个HLL的内存"),i("strong",null,"永远小于16kb"),l("，"),i("strong",null,"内存占用低"),l("的令人发指！作为代价，其测量结果是概率性的，"),i("strong",null,"有小于0.81％的误差"),l("。不过对于UV统计来说，这完全可以忽略。")]),i("li",null,[l("常用的三个方法"),i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653837988985.png",alt:"1653837988985"})])],-1)),s[1177]||(s[1177]=i("h4",{id:"_12-2-uv-统计-测试百万数据的统计",tabindex:"-1"},[l("12.2 UV 统计 - 测试百万数据的统计 "),i("a",{class:"header-anchor",href:"#_12-2-uv-统计-测试百万数据的统计","aria-label":'Permalink to "12.2 UV 统计 - 测试百万数据的统计"'},"​")],-1)),s[1178]||(s[1178]=i("p",null,"测试思路：我们直接利用单元测试，向HyperLogLog中添加100万条数据，看看内存占用和统计效果如何",-1)),s[1179]||(s[1179]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653838053608.png",alt:"1653838053608",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1180]||(s[1180]=i("p",null,"经过测试：我们会发生他的误差是在允许范围内，并且内存占用极小",-1)),s[1181]||(s[1181]=i("hr",null,null,-1)),s[1182]||(s[1182]=i("h2",{id:"redis-原理篇",tabindex:"-1"},[l("Redis 原理篇 "),i("a",{class:"header-anchor",href:"#redis-原理篇","aria-label":'Permalink to "Redis 原理篇"'},"​")],-1)),s[1183]||(s[1183]=i("hr",null,null,-1)),s[1184]||(s[1184]=i("h3",{id:"_1-原理篇-redis-数据结构",tabindex:"-1"},[l("1. 原理篇 - Redis 数据结构 "),i("a",{class:"header-anchor",href:"#_1-原理篇-redis-数据结构","aria-label":'Permalink to "1. 原理篇 - Redis 数据结构"'},"​")],-1)),s[1185]||(s[1185]=i("h4",{id:"_1-1-redis-数据结构-动态字符串",tabindex:"-1"},[l("1.1 Redis 数据结构 - 动态字符串 "),i("a",{class:"header-anchor",href:"#_1-1-redis-数据结构-动态字符串","aria-label":'Permalink to "1.1 Redis 数据结构 - 动态字符串"'},"​")],-1)),s[1186]||(s[1186]=i("p",null,"我们都知道Redis中保存的Key是字符串，value往往是字符串或者字符串的集合。可见字符串是Redis中最常用的一种数据结构。",-1)),s[1187]||(s[1187]=i("p",null,"不过Redis没有直接使用C语言中的字符串，因为C语言字符串存在很多问题： 获取字符串长度的需要通过运算 非二进制安全 不可修改 Redis构建了一种新的字符串结构，称为简单动态字符串（Simple Dynamic String），简称SDS。 例如，我们执行命令：",-1)),s[1188]||(s[1188]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251205200607536.png",alt:"image-20251205200607536",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1189]||(s[1189]=i("p",null,"那么Redis将在底层创建两个SDS，其中一个是包含“name”的SDS，另一个是包含“虎哥”的SDS。",-1)),s[1190]||(s[1190]=i("p",null,"Redis是C语言实现的，其中SDS是一个结构体，源码如下：",-1)),s[1191]||(s[1191]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653984624671.png",alt:"1653984624671",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1192]||(s[1192]=i("p",null,"例如，一个包含字符串“name”的sds结构如下：",-1)),s[1193]||(s[1193]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653984648404.png",alt:"1653984648404",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1194]||(s[1194]=i("p",null,"SDS之所以叫做动态字符串，是因为它具备动态扩容的能力，例如一个内容为“hi”的SDS：",-1)),s[1195]||(s[1195]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653984787383.png",alt:"1653984787383",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1196]||(s[1196]=i("p",null,"假如我们要给SDS追加一段字符串“,Amy”，这里首先会申请新内存空间：",-1)),s[1197]||(s[1197]=i("p",null,"如果新字符串小于1M，则新空间为扩展后字符串长度的两倍+1；",-1)),s[1198]||(s[1198]=i("p",null,"如果新字符串大于1M，则新空间为扩展后字符串长度+1M+1。称为内存预分配。",-1)),s[1199]||(s[1199]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653984822363.png",alt:"1653984822363",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1200]||(s[1200]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653984838306.png",alt:"1653984838306",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1201]||(s[1201]=i("h4",{id:"_1-2-redis-数据结构-intset",tabindex:"-1"},[l("1.2 Redis 数据结构 - intset "),i("a",{class:"header-anchor",href:"#_1-2-redis-数据结构-intset","aria-label":'Permalink to "1.2 Redis 数据结构 - intset"'},"​")],-1)),s[1202]||(s[1202]=i("p",null,"IntSet是Redis中set集合的一种实现方式，基于整数数组来实现，并且具备长度可变、有序等特征。 结构如下：",-1)),s[1203]||(s[1203]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653984923322.png",alt:"1653984923322",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1204]||(s[1204]=i("p",null,"其中的encoding包含三种模式，表示存储的整数大小不同：",-1)),s[1205]||(s[1205]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653984942385.png",alt:"1653984942385",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1206]||(s[1206]=i("p",null,"为了方便查找，Redis会将intset中所有的整数按照升序依次保存在contents数组中，结构如图：",-1)),s[1207]||(s[1207]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985149557.png",alt:"1653985149557",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1208]||(s[1208]=i("p",null,"现在，数组中每个数字都在int16_t的范围内，因此采用的编码方式是INTSET_ENC_INT16，每部分占用的字节大小为： encoding：4字节 length：4字节 contents：2字节 * 3 = 6字节",-1)),s[1209]||(s[1209]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985197214.png",alt:"1653985197214",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1210]||(s[1210]=i("p",null,"我们向该其中添加一个数字：50000，这个数字超出了int16_t的范围，intset会自动升级编码方式到合适的大小。 以当前案例来说流程如下：",-1)),s[1211]||(s[1211]=i("ul",null,[i("li",null,"升级编码为INTSET_ENC_INT32, 每个整数占4字节，并按照新的编码方式及元素个数扩容数组"),i("li",null,"倒序依次将数组中的元素拷贝到扩容后的正确位置"),i("li",null,"将待添加的元素放入数组末尾"),i("li",null,"最后，将inset的encoding属性改为INTSET_ENC_INT32，将length属性改为4")],-1)),s[1212]||(s[1212]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985276621.png",alt:"1653985276621",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1213]||(s[1213]=i("p",null,"源码如下：",-1)),s[1214]||(s[1214]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985304075.png",alt:"1653985304075",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1215]||(s[1215]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985327653.png",alt:"1653985327653",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1216]||(s[1216]=i("p",null,"小总结：",-1)),s[1217]||(s[1217]=i("p",null,"Intset可以看做是特殊的整数数组，具备一些特点：",-1)),s[1218]||(s[1218]=i("ul",null,[i("li",null,"Redis会确保Intset中的元素唯一、有序"),i("li",null,"具备类型升级机制，可以节省内存空间"),i("li",null,"底层采用二分查找方式来查询")],-1)),s[1219]||(s[1219]=i("h4",{id:"_1-3-redis-数据结构-dict",tabindex:"-1"},[l("1.3 Redis 数据结构 - Dict "),i("a",{class:"header-anchor",href:"#_1-3-redis-数据结构-dict","aria-label":'Permalink to "1.3 Redis 数据结构 - Dict"'},"​")],-1)),s[1220]||(s[1220]=i("p",null,"我们知道Redis是一个键值型（Key-Value Pair）的数据库，我们可以根据键实现快速的增删改查。而键与值的映射关系正是通过Dict来实现的。 Dict由三部分组成，分别是：哈希表（DictHashTable）、哈希节点（DictEntry）、字典（Dict）",-1)),s[1221]||(s[1221]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985396560.png",alt:"1653985396560",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1222]||(s[1222]=i("p",null,"当我们向Dict添加键值对时，Redis首先根据key计算出hash值（h），然后利用 h & sizemask来计算元素应该存储到数组中的哪个索引位置。我们存储k1=v1，假设k1的哈希值h =1，则1&3 =1，因此k1=v1要存储到数组角标1位置。",-1)),s[1223]||(s[1223]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985497735.png",alt:"1653985497735",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1224]||(s[1224]=i("p",null,"Dict由三部分组成，分别是：哈希表（DictHashTable）、哈希节点（DictEntry）、字典（Dict）",-1)),s[1225]||(s[1225]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985570612.png",alt:"1653985570612",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1226]||(s[1226]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985586543.png",alt:"1653985586543",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1227]||(s[1227]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985640422.png",alt:"1653985640422",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1228]||(s[1228]=i("p",null,[i("strong",null,"Dict的扩容")],-1)),s[1229]||(s[1229]=i("p",null,[l("Dict中的HashTable就是数组结合单向链表的实现，当集合中元素较多时，必然导致哈希冲突增多，链表过长，则查询效率会大大降低。 Dict在每次新增键值对时都会检查负载因子（LoadFactor = used/size） ，满足以下两种情况时会触发哈希表扩容： 哈希表的 "),i("code",null,"LoadFactor >= 1"),l("，并且服务器没有执行 BGSAVE 或者 BGREWRITEAOF 等后台进程； 哈希表的 "),i("code",null,"LoadFactor > 5"),l(" ；")],-1)),s[1230]||(s[1230]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985716275.png",alt:"1653985716275",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1231]||(s[1231]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985743412.png",alt:"1653985743412",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1232]||(s[1232]=i("p",null,[i("strong",null,"Dict的rehash")],-1)),s[1233]||(s[1233]=i("p",null,"不管是扩容还是收缩，必定会创建新的哈希表，导致哈希表的size和sizemask变化，而key的查询与sizemask有关。因此必须对哈希表中的每一个key重新计算索引，插入新的哈希表，这个过程称为rehash。过程是这样的：",-1)),s[1234]||(s[1234]=i("ul",null,[i("li",null,[i("p",null,"计算新hash表的realeSize，值取决于当前要做的是扩容还是收缩："),i("ul",null,[i("li",null,"如果是扩容，则新size为第一个大于等于dict.ht[0].used + 1的2^n"),i("li",null,"如果是收缩，则新size为第一个大于等于dict.ht[0].used的2^n （不得小于4）")])]),i("li",null,[i("p",null,"按照新的realeSize申请内存空间，创建dictht，并赋值给dict.ht[1]")]),i("li",null,[i("p",null,"设置dict.rehashidx = 0，标示开始rehash")]),i("li",null,[i("p",null,"将dict.ht[0]中的每一个dictEntry都rehash到dict.ht[1]")]),i("li",null,[i("p",null,"将dict.ht[1]赋值给dict.ht[0]，给dict.ht[1]初始化为空哈希表，释放原来的dict.ht[0]的内存")]),i("li",null,[i("p",null,"将rehashidx赋值为-1，代表rehash结束")]),i("li",null,[i("p",null,"在rehash过程中，新增操作，则直接写入ht[1]，查询、修改和删除则会在dict.ht[0]和dict.ht[1]依次查找并执行。这样可以确保ht[0]的数据只减不增，随着rehash最终为空")])],-1)),s[1235]||(s[1235]=i("p",null,"整个过程可以描述成：",-1)),s[1236]||(s[1236]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985824540.png",alt:"1653985824540",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1237]||(s[1237]=i("p",null,"小总结：",-1)),s[1238]||(s[1238]=i("p",null,"Dict的结构：",-1)),s[1239]||(s[1239]=i("ul",null,[i("li",null,"类似java的HashTable，底层是数组加链表来解决哈希冲突"),i("li",null,"Dict包含两个哈希表，ht[0]平常用，ht[1]用来rehash")],-1)),s[1240]||(s[1240]=i("p",null,"Dict的伸缩：",-1)),s[1241]||(s[1241]=i("ul",null,[i("li",null,"当LoadFactor大于5或者LoadFactor大于1并且没有子进程任务时，Dict扩容"),i("li",null,"当LoadFactor小于0.1时，Dict收缩"),i("li",null,"扩容大小为第一个大于等于used + 1的2^n"),i("li",null,"收缩大小为第一个大于等于used 的2^n"),i("li",null,"Dict采用渐进式rehash，每次访问Dict时执行一次rehash"),i("li",null,"rehash时ht[0]只减不增，新增操作只在ht[1]执行，其它操作在两个哈希表")],-1)),s[1242]||(s[1242]=i("h4",{id:"_1-4-redis-数据结构-ziplist",tabindex:"-1"},[l("1.4 Redis 数据结构 - ZipList "),i("a",{class:"header-anchor",href:"#_1-4-redis-数据结构-ziplist","aria-label":'Permalink to "1.4 Redis 数据结构 - ZipList"'},"​")],-1)),s[1243]||(s[1243]=i("p",null,"ZipList 是一种特殊的“双端链表” ，由一系列特殊编码的连续内存块组成。可以在任意一端进行压入/弹出操作, 并且该操作的时间复杂度为 O(1)。",-1)),s[1244]||(s[1244]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653985987327.png",alt:"1653985987327",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1245]||(s[1245]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986020491.png",alt:"1653986020491",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1246]||(s[1246]=i("table",null,[i("thead",null,[i("tr",null,[i("th",null,[i("strong",null,"属性")]),i("th",null,[i("strong",null,"类型")]),i("th",null,[i("strong",null,"长度")]),i("th",null,[i("strong",null,"用途")])])]),i("tbody",null,[i("tr",null,[i("td",null,"zlbytes"),i("td",null,"uint32_t"),i("td",null,"4 字节"),i("td",null,"记录整个压缩列表占用的内存字节数")]),i("tr",null,[i("td",null,"zltail"),i("td",null,"uint32_t"),i("td",null,"4 字节"),i("td",null,"记录压缩列表表尾节点距离压缩列表的起始地址有多少字节，通过这个偏移量，可以确定表尾节点的地址。")]),i("tr",null,[i("td",null,"zllen"),i("td",null,"uint16_t"),i("td",null,"2 字节"),i("td",null,"记录了压缩列表包含的节点数量。 最大值为UINT16_MAX （65534），如果超过这个值，此处会记录为65535，但节点的真实数量需要遍历整个压缩列表才能计算得出。")]),i("tr",null,[i("td",null,"entry"),i("td",null,"列表节点"),i("td",null,"不定"),i("td",null,"压缩列表包含的各个节点，节点的长度由节点保存的内容决定。")]),i("tr",null,[i("td",null,"zlend"),i("td",null,"uint8_t"),i("td",null,"1 字节"),i("td",null,"特殊值 0xFF （十进制 255 ），用于标记压缩列表的末端。")])])],-1)),s[1247]||(s[1247]=i("p",null,[i("strong",null,"ZipListEntry")],-1)),s[1248]||(s[1248]=i("p",null,"ZipList 中的Entry并不像普通链表那样记录前后节点的指针，因为记录两个指针要占用16个字节，浪费内存。而是采用了下面的结构：",-1)),s[1249]||(s[1249]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986055253.png",alt:"1653986055253",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1250]||(s[1250]=i("ul",null,[i("li",null,[i("p",null,"previous_entry_length：前一节点的长度，占1个或5个字节。"),i("ul",null,[i("li",null,"如果前一节点的长度小于254字节，则采用1个字节来保存这个长度值"),i("li",null,"如果前一节点的长度大于254字节，则采用5个字节来保存这个长度值，第一个字节为0xfe，后四个字节才是真实长度数据")])]),i("li",null,[i("p",null,"encoding：编码属性，记录content的数据类型（字符串还是整数）以及长度，占用1个、2个或5个字节")]),i("li",null,[i("p",null,"contents：负责保存节点的数据，可以是字符串或整数")])],-1)),s[1251]||(s[1251]=i("p",null,"ZipList中所有存储长度的数值均采用小端字节序，即低位字节在前，高位字节在后。例如：数值0x1234，采用小端字节序后实际存储值为：0x3412",-1)),s[1252]||(s[1252]=i("p",null,[i("strong",null,"Encoding编码")],-1)),s[1253]||(s[1253]=i("p",null,"ZipListEntry中的encoding编码分为字符串和整数两种： 字符串：如果encoding是以“00”、“01”或者“10”开头，则证明content是字符串",-1)),s[1254]||(s[1254]=i("table",null,[i("thead",null,[i("tr",null,[i("th",null,[i("strong",null,"编码")]),i("th",null,[i("strong",null,"编码长度")]),i("th",null,[i("strong",null,"字符串大小")])])]),i("tbody",null,[i("tr",null,[i("td",null,"|00pppppp|"),i("td",null,"1 bytes"),i("td",null,[i("code",null,"<= 63 bytes")])]),i("tr",null,[i("td",null,"|01pppppp|qqqqqqqq|"),i("td",null,"2 bytes"),i("td",null,[i("code",null,"<= 16383 bytes")])]),i("tr",null,[i("td",null,"|10000000|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt|"),i("td",null,"5 bytes"),i("td",null,[i("code",null,"<= 4294967295 bytes")])])])],-1)),s[1255]||(s[1255]=i("p",null,"例如，我们要保存字符串：“ab”和 “bc”",-1)),s[1256]||(s[1256]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986172002.png",alt:"1653986172002",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1257]||(s[1257]=i("p",null,"ZipListEntry中的encoding编码分为字符串和整数两种：",-1)),s[1258]||(s[1258]=i("ul",null,[i("li",null,"整数：如果encoding是以“11”开始，则证明content是整数，且encoding固定只占用1个字节")],-1)),s[1259]||(s[1259]=i("table",null,[i("thead",null,[i("tr",null,[i("th",null,[i("strong",null,"编码")]),i("th",null,[i("strong",null,"编码长度")]),i("th",null,[i("strong",null,"整数类型")])])]),i("tbody",null,[i("tr",null,[i("td",null,"11000000"),i("td",null,"1"),i("td",null,"int16_t（2 bytes）")]),i("tr",null,[i("td",null,"11010000"),i("td",null,"1"),i("td",null,"int32_t（4 bytes）")]),i("tr",null,[i("td",null,"11100000"),i("td",null,"1"),i("td",null,"int64_t（8 bytes）")]),i("tr",null,[i("td",null,"11110000"),i("td",null,"1"),i("td",null,"24位有符整数(3 bytes)")]),i("tr",null,[i("td",null,"11111110"),i("td",null,"1"),i("td",null,"8位有符整数(1 bytes)")]),i("tr",null,[i("td",null,"1111xxxx"),i("td",null,"1"),i("td",null,"直接在xxxx位置保存数值，范围从0001~1101，减1后结果为实际值")])])],-1)),s[1260]||(s[1260]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986282879.png",alt:"1653986282879",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1261]||(s[1261]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986217182.png",alt:"1653986217182",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1262]||(s[1262]=i("h4",{id:"_1-5-redis-数据结构-ziplist-的连锁更新问题",tabindex:"-1"},[l("1.5 Redis 数据结构 - ZipList 的连锁更新问题 "),i("a",{class:"header-anchor",href:"#_1-5-redis-数据结构-ziplist-的连锁更新问题","aria-label":'Permalink to "1.5 Redis 数据结构 - ZipList 的连锁更新问题"'},"​")],-1)),s[1263]||(s[1263]=i("p",null,"ZipList的每个Entry都包含previous_entry_length来记录上一个节点的大小，长度是1个或5个字节： 如果前一节点的长度小于254字节，则采用1个字节来保存这个长度值 如果前一节点的长度大于等于254字节，则采用5个字节来保存这个长度值，第一个字节为0xfe，后四个字节才是真实长度数据 现在，假设我们有N个连续的、长度为250~253字节之间的entry，因此entry的previous_entry_length属性用1个字节即可表示，如图所示：",-1)),s[1264]||(s[1264]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986328124.png",alt:"1653986328124",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1265]||(s[1265]=i("p",null,"ZipList这种特殊情况下产生的连续多次空间扩展操作称之为连锁更新（Cascade Update）。新增、删除都可能导致连锁更新的发生。",-1)),s[1266]||(s[1266]=i("p",null,[i("strong",null,"小总结：")],-1)),s[1267]||(s[1267]=i("p",null,[i("strong",null,"ZipList特性：")],-1)),s[1268]||(s[1268]=i("ul",null,[i("li",null,'压缩列表的可以看做一种连续内存空间的"双向链表"'),i("li",null,"列表的节点之间不是通过指针连接，而是记录上一节点和本节点长度来寻址，内存占用较低"),i("li",null,"如果列表数据过多，导致链表过长，可能影响查询性能"),i("li",null,"增或删较大数据时有可能发生连续更新问题")],-1)),s[1269]||(s[1269]=i("h4",{id:"_1-6-redis-数据结构-quicklist",tabindex:"-1"},[l("1.6 Redis 数据结构 - QuickList "),i("a",{class:"header-anchor",href:"#_1-6-redis-数据结构-quicklist","aria-label":'Permalink to "1.6 Redis 数据结构 - QuickList"'},"​")],-1)),s[1270]||(s[1270]=i("p",null,"问题1：ZipList虽然节省内存，但申请内存必须是连续空间，如果内存占用较多，申请内存效率很低。怎么办？",-1)),s[1271]||(s[1271]=i("p",null,"​ 答：为了缓解这个问题，我们必须限制ZipList的长度和entry大小。",-1)),s[1272]||(s[1272]=i("p",null,"问题2：但是我们要存储大量数据，超出了ZipList最佳的上限该怎么办？",-1)),s[1273]||(s[1273]=i("p",null,"​ 答：我们可以创建多个ZipList来分片存储数据。",-1)),s[1274]||(s[1274]=i("p",null,"问题3：数据拆分后比较分散，不方便管理和查找，这多个ZipList如何建立联系？",-1)),s[1275]||(s[1275]=i("p",null,"​ 答：Redis在3.2版本引入了新的数据结构QuickList，它是一个双端链表，只不过链表中的每个节点都是一个ZipList。",-1)),s[1276]||(s[1276]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986474927.png",alt:"1653986474927",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1277]||(s[1277]=i("p",null,"为了避免QuickList中的每个ZipList中entry过多，Redis提供了一个配置项：list-max-ziplist-size来限制。 如果值为正，则代表ZipList的允许的entry个数的最大值 如果值为负，则代表ZipList的最大内存大小，分5种情况：",-1)),s[1278]||(s[1278]=i("ul",null,[i("li",null,"-1：每个ZipList的内存占用不能超过4kb"),i("li",null,"-2：每个ZipList的内存占用不能超过8kb"),i("li",null,"-3：每个ZipList的内存占用不能超过16kb"),i("li",null,"-4：每个ZipList的内存占用不能超过32kb"),i("li",null,"-5：每个ZipList的内存占用不能超过64kb")],-1)),s[1279]||(s[1279]=i("p",null,"其默认值为 -2：",-1)),s[1280]||(s[1280]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986642777.png",alt:"1653986642777",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1281]||(s[1281]=i("p",null,"以下是QuickList的和QuickListNode的结构源码：",-1)),s[1282]||(s[1282]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986667228.png",alt:"1653986667228",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1283]||(s[1283]=i("p",null,"我们接下来用一段流程图来描述当前的这个结构",-1)),s[1284]||(s[1284]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986718554.png",alt:"1653986718554",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1285]||(s[1285]=i("p",null,"总结：",-1)),s[1286]||(s[1286]=i("p",null,"QuickList的特点：",-1)),s[1287]||(s[1287]=i("ul",null,[i("li",null,"是一个节点为ZipList的双端链表"),i("li",null,"节点采用ZipList，解决了传统链表的内存占用问题"),i("li",null,"控制了ZipList大小，解决连续内存空间申请效率问题"),i("li",null,"中间节点可以压缩，进一步节省了内存")],-1)),s[1288]||(s[1288]=i("p",null,"1.7 Redis数据结构-SkipList",-1)),s[1289]||(s[1289]=i("p",null,"SkipList（跳表）首先是链表，但与传统链表相比有几点差异： 元素按照升序排列存储 节点可能包含多个指针，指针跨度不同。",-1)),s[1290]||(s[1290]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986771309.png",alt:"1653986771309",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1291]||(s[1291]=i("p",null,"SkipList（跳表）首先是链表，但与传统链表相比有几点差异： 元素按照升序排列存储 节点可能包含多个指针，指针跨度不同。",-1)),s[1292]||(s[1292]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986813240.png",alt:"1653986813240",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1293]||(s[1293]=i("p",null,"SkipList（跳表）首先是链表，但与传统链表相比有几点差异： 元素按照升序排列存储 节点可能包含多个指针，指针跨度不同。",-1)),s[1294]||(s[1294]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986877620.png",alt:"1653986877620",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1295]||(s[1295]=i("p",null,"小总结：",-1)),s[1296]||(s[1296]=i("p",null,"SkipList的特点：",-1)),s[1297]||(s[1297]=i("ul",null,[i("li",null,"跳跃表是一个双向链表，每个节点都包含score和ele值"),i("li",null,"节点按照score值排序，score值一样则按照ele字典排序"),i("li",null,"每个节点都可以包含多层指针，层数是1到32之间的随机数"),i("li",null,"不同层指针到下一个节点的跨度不同，层级越高，跨度越大"),i("li",null,"增删改查效率与红黑树基本一致，实现却更简单")],-1)),s[1298]||(s[1298]=i("h4",{id:"_1-7-redis-数据结构-redisobject",tabindex:"-1"},[l("1.7 Redis 数据结构 - RedisObject "),i("a",{class:"header-anchor",href:"#_1-7-redis-数据结构-redisobject","aria-label":'Permalink to "1.7 Redis 数据结构 - RedisObject"'},"​")],-1)),s[1299]||(s[1299]=i("p",null,"Redis中的任意数据类型的键和值都会被封装为一个RedisObject，也叫做Redis对象，源码如下：",-1)),s[1300]||(s[1300]=i("p",null,"1、什么是redisObject： 从Redis的使用者的角度来看，⼀个Redis节点包含多个database（非cluster模式下默认是16个，cluster模式下只能是1个），而一个database维护了从key space到object space的映射关系。这个映射关系的key是string类型，⽽value可以是多种数据类型，比如： string, list, hash、set、sorted set等。我们可以看到，key的类型固定是string，而value可能的类型是多个。 ⽽从Redis内部实现的⾓度来看，database内的这个映射关系是用⼀个dict来维护的。dict的key固定用⼀种数据结构来表达就够了，这就是动态字符串sds。而value则比较复杂，为了在同⼀个dict内能够存储不同类型的value，这就需要⼀个通⽤的数据结构，这个通用的数据结构就是robj，全名是redisObject。",-1)),s[1301]||(s[1301]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653986956618.png",alt:"1653986956618",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1302]||(s[1302]=i("p",null,"Redis的编码方式",-1)),s[1303]||(s[1303]=i("p",null,"Redis中会根据存储的数据类型不同，选择不同的编码方式，共包含11种不同类型：",-1)),s[1304]||(s[1304]=i("table",null,[i("thead",null,[i("tr",null,[i("th",null,[i("strong",null,"编号")]),i("th",null,[i("strong",null,"编码方式")]),i("th",null,[i("strong",null,"说明")])])]),i("tbody",null,[i("tr",null,[i("td",null,"0"),i("td",null,"OBJ_ENCODING_RAW"),i("td",null,"raw编码动态字符串")]),i("tr",null,[i("td",null,"1"),i("td",null,"OBJ_ENCODING_INT"),i("td",null,"long类型的整数的字符串")]),i("tr",null,[i("td",null,"2"),i("td",null,"OBJ_ENCODING_HT"),i("td",null,"hash表（字典dict）")]),i("tr",null,[i("td",null,"3"),i("td",null,"OBJ_ENCODING_ZIPMAP"),i("td",null,"已废弃")]),i("tr",null,[i("td",null,"4"),i("td",null,"OBJ_ENCODING_LINKEDLIST"),i("td",null,"双端链表")]),i("tr",null,[i("td",null,"5"),i("td",null,"OBJ_ENCODING_ZIPLIST"),i("td",null,"压缩列表")]),i("tr",null,[i("td",null,"6"),i("td",null,"OBJ_ENCODING_INTSET"),i("td",null,"整数集合")]),i("tr",null,[i("td",null,"7"),i("td",null,"OBJ_ENCODING_SKIPLIST"),i("td",null,"跳表")]),i("tr",null,[i("td",null,"8"),i("td",null,"OBJ_ENCODING_EMBSTR"),i("td",null,"embstr的动态字符串")]),i("tr",null,[i("td",null,"9"),i("td",null,"OBJ_ENCODING_QUICKLIST"),i("td",null,"快速列表")]),i("tr",null,[i("td",null,"10"),i("td",null,"OBJ_ENCODING_STREAM"),i("td",null,"Stream流")])])],-1)),s[1305]||(s[1305]=i("p",null,"五种数据结构",-1)),s[1306]||(s[1306]=i("p",null,"Redis中会根据存储的数据类型不同，选择不同的编码方式。每种数据类型的使用的编码方式如下：",-1)),s[1307]||(s[1307]=i("table",null,[i("thead",null,[i("tr",null,[i("th",null,[i("strong",null,"数据类型")]),i("th",null,[i("strong",null,"编码方式")])])]),i("tbody",null,[i("tr",null,[i("td",null,"OBJ_STRING"),i("td",null,"int、embstr、raw")]),i("tr",null,[i("td",null,"OBJ_LIST"),i("td",null,"LinkedList和ZipList(3.2以前)、QuickList（3.2以后）")]),i("tr",null,[i("td",null,"OBJ_SET"),i("td",null,"intset、HT")]),i("tr",null,[i("td",null,"OBJ_ZSET"),i("td",null,"ZipList、HT、SkipList")]),i("tr",null,[i("td",null,"OBJ_HASH"),i("td",null,"ZipList、HT")])])],-1)),s[1308]||(s[1308]=i("h4",{id:"_1-8-redis-数据结构-string",tabindex:"-1"},[l("1.8 Redis 数据结构 - String "),i("a",{class:"header-anchor",href:"#_1-8-redis-数据结构-string","aria-label":'Permalink to "1.8 Redis 数据结构 - String"'},"​")],-1)),s[1309]||(s[1309]=i("p",null,"String是Redis中最常见的数据存储类型：",-1)),s[1310]||(s[1310]=i("p",null,"其基本编码方式是RAW，基于简单动态字符串（SDS）实现，存储上限为512mb。",-1)),s[1311]||(s[1311]=i("p",null,"如果存储的SDS长度小于44字节，则会采用EMBSTR编码，此时object head与SDS是一段连续空间。申请内存时",-1)),s[1312]||(s[1312]=i("p",null,"只需要调用一次内存分配函数，效率更高。",-1)),s[1313]||(s[1313]=i("p",null,"（1）底层实现⽅式：动态字符串sds 或者 long String的内部存储结构⼀般是sds（Simple Dynamic String，可以动态扩展内存），但是如果⼀个String类型的value的值是数字，那么Redis内部会把它转成long类型来存储，从⽽减少内存的使用。",-1)),s[1314]||(s[1314]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653987103450.png",alt:"1653987103450",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1315]||(s[1315]=i("p",null,"如果存储的字符串是整数值，并且大小在LONG_MAX范围内，则会采用INT编码：直接将数据保存在RedisObject的ptr指针位置（刚好8字节），不再需要SDS了。",-1)),s[1316]||(s[1316]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653987159575.png",alt:"1653987159575",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1317]||(s[1317]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653987172764.png",alt:"1653987172764",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1318]||(s[1318]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653987202522.png",alt:"1653987202522",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1319]||(s[1319]=i("p",null,"确切地说，String在Redis中是⽤⼀个robj来表示的。",-1)),s[1320]||(s[1320]=i("p",null,"用来表示String的robj可能编码成3种内部表⽰：OBJ_ENCODING_RAW，OBJ_ENCODING_EMBSTR，OBJ_ENCODING_INT。 其中前两种编码使⽤的是sds来存储，最后⼀种OBJ_ENCODING_INT编码直接把string存成了long型。 在对string进行incr, decr等操作的时候，如果它内部是OBJ_ENCODING_INT编码，那么可以直接行加减操作；如果它内部是OBJ_ENCODING_RAW或OBJ_ENCODING_EMBSTR编码，那么Redis会先试图把sds存储的字符串转成long型，如果能转成功，再进行加减操作。对⼀个内部表示成long型的string执行append, setbit, getrange这些命令，针对的仍然是string的值（即⼗进制表示的字符串），而不是针对内部表⽰的long型进⾏操作。比如字符串”32”，如果按照字符数组来解释，它包含两个字符，它们的ASCII码分别是0x33和0x32。当我们执行命令setbit key 7 0的时候，相当于把字符0x33变成了0x32，这样字符串的值就变成了”22”。⽽如果将字符串”32”按照内部的64位long型来解释，那么它是0x0000000000000020，在这个基础上执⾏setbit位操作，结果就完全不对了。因此，在这些命令的实现中，会把long型先转成字符串再进行相应的操作。",-1)),s[1321]||(s[1321]=i("h4",{id:"_1-9-redis-数据结构-list",tabindex:"-1"},[l("1.9 Redis 数据结构 - List "),i("a",{class:"header-anchor",href:"#_1-9-redis-数据结构-list","aria-label":'Permalink to "1.9 Redis 数据结构 - List"'},"​")],-1)),s[1322]||(s[1322]=i("p",null,"Redis的List类型可以从首、尾操作列表中的元素：",-1)),s[1323]||(s[1323]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653987240622.png",alt:"1653987240622",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1324]||(s[1324]=i("p",null,"哪一个数据结构能满足上述特征？",-1)),s[1325]||(s[1325]=i("ul",null,[i("li",null,"LinkedList ：普通链表，可以从双端访问，内存占用较高，内存碎片较多"),i("li",null,"ZipList ：压缩列表，可以从双端访问，内存占用低，存储上限低"),i("li",null,"QuickList：LinkedList + ZipList，可以从双端访问，内存占用较低，包含多个ZipList，存储上限高")],-1)),s[1326]||(s[1326]=i("p",null,"Redis的List结构类似一个双端链表，可以从首、尾操作列表中的元素：",-1)),s[1327]||(s[1327]=i("p",null,"在3.2版本之前，Redis采用ZipList和LinkedList来实现List，当元素数量小于512并且元素大小小于64字节时采用ZipList编码，超过则采用LinkedList编码。",-1)),s[1328]||(s[1328]=i("p",null,"在3.2版本之后，Redis统一采用QuickList来实现List：",-1)),s[1329]||(s[1329]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653987313461.png",alt:"1653987313461",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1330]||(s[1330]=i("h4",{id:"_2-0-redis-数据结构-set-结构",tabindex:"-1"},[l("2.0 Redis 数据结构 - Set 结构 "),i("a",{class:"header-anchor",href:"#_2-0-redis-数据结构-set-结构","aria-label":'Permalink to "2.0 Redis 数据结构 - Set 结构"'},"​")],-1)),s[1331]||(s[1331]=i("p",null,"Set是Redis中的单列集合，满足下列特点：",-1)),s[1332]||(s[1332]=i("ul",null,[i("li",null,"不保证有序性"),i("li",null,"保证元素唯一"),i("li",null,"求交集、并集、差集")],-1)),s[1333]||(s[1333]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653987342550.png",alt:"1653987342550",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1334]||(s[1334]=i("p",null,"可以看出，Set对查询元素的效率要求非常高，思考一下，什么样的数据结构可以满足？ HashTable，也就是Redis中的Dict，不过Dict是双列集合（可以存键、值对）",-1)),s[1335]||(s[1335]=i("p",null,"Set是Redis中的集合，不一定确保元素有序，可以满足元素唯一、查询效率要求极高。 为了查询效率和唯一性，set采用HT编码（Dict）。Dict中的key用来存储元素，value统一为null。 当存储的所有数据都是整数，并且元素数量不超过set-max-intset-entries时，Set会采用IntSet编码，以节省内存",-1)),s[1336]||(s[1336]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653987388177.png",alt:"1653987388177",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1337]||(s[1337]=i("p",null,"结构如下：",-1)),s[1338]||(s[1338]=i("p",null,[l("​ "),i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653987454403.png",alt:"1653987454403"})],-1)),s[1339]||(s[1339]=i("h4",{id:"_2-1-redis-数据结构-zset",tabindex:"-1"},[l("2.1 Redis 数据结构 - ZSET "),i("a",{class:"header-anchor",href:"#_2-1-redis-数据结构-zset","aria-label":'Permalink to "2.1 Redis 数据结构 - ZSET"'},"​")],-1)),s[1340]||(s[1340]=i("p",null,"ZSet也就是SortedSet，其中每一个元素都需要指定一个score值和member值：",-1)),s[1341]||(s[1341]=i("ul",null,[i("li",null,"可以根据score值排序后"),i("li",null,"member必须唯一"),i("li",null,"可以根据member查询分数")],-1)),s[1342]||(s[1342]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653992091967.png",alt:"1653992091967",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1343]||(s[1343]=i("p",null,"因此，zset底层数据结构必须满足键值存储、键必须唯一、可排序这几个需求。之前学习的哪种编码结构可以满足？",-1)),s[1344]||(s[1344]=i("ul",null,[i("li",null,"SkipList：可以排序，并且可以同时存储score和ele值（member）"),i("li",null,"HT（Dict）：可以键值存储，并且可以根据key找value")],-1)),s[1345]||(s[1345]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653992121692.png",alt:"1653992121692",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1346]||(s[1346]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653992172526.png",alt:"1653992172526",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1347]||(s[1347]=i("p",null,"当元素数量不多时，HT和SkipList的优势不明显，而且更耗内存。因此zset还会采用ZipList结构来节省内存，不过需要同时满足两个条件：",-1)),s[1348]||(s[1348]=i("ul",null,[i("li",null,"元素数量小于zset_max_ziplist_entries，默认值128"),i("li",null,"每个元素都小于zset_max_ziplist_value字节，默认值64")],-1)),s[1349]||(s[1349]=i("p",null,"ziplist本身没有排序功能，而且没有键值对的概念，因此需要有zset通过编码实现：",-1)),s[1350]||(s[1350]=i("ul",null,[i("li",null,"ZipList是连续内存，因此score和element是紧挨在一起的两个entry， element在前，score在后"),i("li",null,"score越小越接近队首，score越大越接近队尾，按照score值升序排列")],-1)),s[1351]||(s[1351]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653992238097.png",alt:"1653992238097",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1352]||(s[1352]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653992299740.png",alt:"1653992299740",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1353]||(s[1353]=i("h4",{id:"_2-2-redis-数据结构-hash",tabindex:"-1"},[l("2.2 Redis 数据结构 - Hash "),i("a",{class:"header-anchor",href:"#_2-2-redis-数据结构-hash","aria-label":'Permalink to "2.2 Redis 数据结构 - Hash"'},"​")],-1)),s[1354]||(s[1354]=i("p",null,"Hash结构与Redis中的Zset非常类似：",-1)),s[1355]||(s[1355]=i("ul",null,[i("li",null,"都是键值存储"),i("li",null,"都需求根据键获取值"),i("li",null,"键必须唯一")],-1)),s[1356]||(s[1356]=i("p",null,"区别如下：",-1)),s[1357]||(s[1357]=i("ul",null,[i("li",null,"zset的键是member，值是score；hash的键和值都是任意值"),i("li",null,"zset要根据score排序；hash则无需排序")],-1)),s[1358]||(s[1358]=i("p",null,"（1）底层实现方式：压缩列表ziplist 或者 字典dict 当Hash中数据项比较少的情况下，Hash底层才⽤压缩列表ziplist进⾏存储数据，随着数据的增加，底层的ziplist就可能会转成dict，具体配置如下：",-1)),s[1359]||(s[1359]=i("p",null,"hash-max-ziplist-entries 512",-1)),s[1360]||(s[1360]=i("p",null,"hash-max-ziplist-value 64",-1)),s[1361]||(s[1361]=i("p",null,"当满足上面两个条件其中之⼀的时候，Redis就使⽤dict字典来实现hash。 Redis的hash之所以这样设计，是因为当ziplist变得很⼤的时候，它有如下几个缺点：",-1)),s[1362]||(s[1362]=i("ul",null,[i("li",null,"每次插⼊或修改引发的realloc操作会有更⼤的概率造成内存拷贝，从而降低性能。"),i("li",null,"⼀旦发生内存拷贝，内存拷贝的成本也相应增加，因为要拷贝更⼤的⼀块数据。"),i("li",null,"当ziplist数据项过多的时候，在它上⾯查找指定的数据项就会性能变得很低，因为ziplist上的查找需要进行遍历。")],-1)),s[1363]||(s[1363]=i("p",null,"总之，ziplist本来就设计为各个数据项挨在⼀起组成连续的内存空间，这种结构并不擅长做修改操作。⼀旦数据发⽣改动，就会引发内存realloc，可能导致内存拷贝。",-1)),s[1364]||(s[1364]=i("p",null,"hash结构如下：",-1)),s[1365]||(s[1365]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653992339937.png",alt:"1653992339937",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1366]||(s[1366]=i("p",null,"zset集合如下：",-1)),s[1367]||(s[1367]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653992360355.png",alt:"1653992360355",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1368]||(s[1368]=i("p",null,"因此，Hash底层采用的编码与Zset也基本一致，只需要把排序有关的SkipList去掉即可：",-1)),s[1369]||(s[1369]=i("p",null,"Hash结构默认采用ZipList编码，用以节省内存。 ZipList中相邻的两个entry 分别保存field和value",-1)),s[1370]||(s[1370]=i("p",null,"当数据量较大时，Hash结构会转为HT编码，也就是Dict，触发条件有两个：",-1)),s[1371]||(s[1371]=i("ul",null,[i("li",null,"ZipList中的元素数量超过了hash-max-ziplist-entries（默认512）"),i("li",null,"ZipList中的任意entry大小超过了hash-max-ziplist-value（默认64字节）")],-1)),s[1372]||(s[1372]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653992413406.png",alt:"1653992413406",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1373]||(s[1373]=i("hr",null,null,-1)),s[1374]||(s[1374]=i("h3",{id:"_2-原理篇-redis-网络模型",tabindex:"-1"},[l("2. 原理篇 - Redis 网络模型 "),i("a",{class:"header-anchor",href:"#_2-原理篇-redis-网络模型","aria-label":'Permalink to "2. 原理篇 - Redis 网络模型"'},"​")],-1)),s[1375]||(s[1375]=i("h4",{id:"_2-1-用户空间和内核态空间",tabindex:"-1"},[l("2.1 用户空间和内核态空间 "),i("a",{class:"header-anchor",href:"#_2-1-用户空间和内核态空间","aria-label":'Permalink to "2.1 用户空间和内核态空间"'},"​")],-1)),s[1376]||(s[1376]=i("p",null,"服务器大多都采用Linux系统，这里我们以Linux为例来讲解:",-1)),s[1377]||(s[1377]=i("p",null,"ubuntu和Centos 都是Linux的发行版，发行版可以看成对linux包了一层壳，任何Linux发行版，其系统内核都是Linux。我们的应用都需要通过Linux内核与硬件交互",-1)),s[1378]||(s[1378]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653844970346.png",alt:"1653844970346",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1379]||(s[1379]=i("p",null,"用户的应用，比如redis，mysql等其实是没有办法去执行访问我们操作系统的硬件的，所以我们可以通过发行版的这个壳子去访问内核，再通过内核去访问计算机硬件",-1)),s[1380]||(s[1380]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653845147190.png",alt:"1653845147190",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1381]||(s[1381]=i("p",null,"计算机硬件包括，如cpu，内存，网卡等等，内核（通过寻址空间）可以操作硬件的，但是内核需要不同设备的驱动，有了这些驱动之后，内核就可以去对计算机硬件去进行 内存管理，文件系统的管理，进程的管理等等",-1)),s[1382]||(s[1382]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653896065386.png",alt:"1653896065386",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1383]||(s[1383]=i("p",null,[l("我们想要用户的应用来访问，计算机就必须要通过对外暴露的一些接口，才能访问到，从而简介的实现对内核的操控，但是内核本身上来说也是一个应用，所以他本身也需要一些内存，cpu等设备资源，用户应用本身也在消耗这些资源，如果不加任何限制，用户去操作随意的去操作我们的资源，就有可能导致一些冲突，甚至有可能导致我们的系统出现无法运行的问题，因此我们需要把用户和"),i("strong",null,"内核隔离开")],-1)),s[1384]||(s[1384]=i("p",null,[l("进程的寻址空间划分成两部分："),i("strong",null,"内核空间、用户空间")],-1)),s[1385]||(s[1385]=i("p",null,"什么是寻址空间呢？我们的应用程序也好，还是内核空间也好，都是没有办法直接去物理内存的，而是通过分配一些虚拟内存映射到物理内存中，我们的内核和应用程序去访问虚拟内存的时候，就需要一个虚拟地址，这个地址是一个无符号的整数，比如一个32位的操作系统，他的带宽就是32，他的虚拟地址就是2的32次方，也就是说他寻址的范围就是0~2的32次方， 这片寻址空间对应的就是2的32个字节，就是4GB，这个4GB，会有3个GB分给用户空间，会有1GB给内核系统",-1)),s[1386]||(s[1386]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653896377259.png",alt:"1653896377259",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1387]||(s[1387]=i("p",null,"在linux中，他们权限分成两个等级，0和3，用户空间只能执行受限的命令（Ring3），而且不能直接调用系统资源，必须通过内核提供的接口来访问内核空间可以执行特权命令（Ring0），调用一切系统资源，所以一般情况下，用户的操作是运行在用户空间，而内核运行的数据是在内核空间的，而有的情况下，一个应用程序需要去调用一些特权资源，去调用一些内核空间的操作，所以此时他俩需要在用户态和内核态之间进行切换。",-1)),s[1388]||(s[1388]=i("p",null,"比如：",-1)),s[1389]||(s[1389]=i("p",null,"Linux系统为了提高IO效率，会在用户空间和内核空间都加入缓冲区：",-1)),s[1390]||(s[1390]=i("p",null,"写数据时，要把用户缓冲数据拷贝到内核缓冲区，然后写入设备",-1)),s[1391]||(s[1391]=i("p",null,"读数据时，要从设备读取数据到内核缓冲区，然后拷贝到用户缓冲区",-1)),s[1392]||(s[1392]=i("p",null,"针对这个操作：我们的用户在写读数据时，会去向内核态申请，想要读取内核的数据，而内核数据要去等待驱动程序从硬件上读取数据，当从磁盘上加载到数据之后，内核会将数据写入到内核的缓冲区中，然后再将数据拷贝到用户态的buffer中，然后再返回给应用程序，整体而言，速度慢，就是这个原因，为了加速，我们希望read也好，还是wait for data也最好都不要等待，或者时间尽量的短。",-1)),s[1393]||(s[1393]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653896687354.png",alt:"1653896687354",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1394]||(s[1394]=i("h4",{id:"_2-2-网络模型-阻塞-io",tabindex:"-1"},[l("2.2 网络模型 - 阻塞 IO "),i("a",{class:"header-anchor",href:"#_2-2-网络模型-阻塞-io","aria-label":'Permalink to "2.2 网络模型 - 阻塞 IO"'},"​")],-1)),s[1395]||(s[1395]=i("p",null,"在《UNIX网络编程》一书中，总结归纳了5种IO模型：",-1)),s[1396]||(s[1396]=i("ul",null,[i("li",null,"阻塞IO（Blocking IO）"),i("li",null,"非阻塞IO（Nonblocking IO）"),i("li",null,"IO多路复用（IO Multiplexing）"),i("li",null,"信号驱动IO（Signal Driven IO）"),i("li",null,"异步IO（Asynchronous IO）")],-1)),s[1397]||(s[1397]=i("p",null,"应用程序想要去读取数据，他是无法直接去读取磁盘数据的，他需要先到内核里边去等待内核操作硬件拿到数据，这个过程就是1，是需要等待的，等到内核从磁盘上把数据加载出来之后，再把这个数据写给用户的缓存区，这个过程是2，如果是阻塞IO，那么整个过程中，用户从发起读请求开始，一直到读取到数据，都是一个阻塞状态。",-1)),s[1398]||(s[1398]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653897115346.png",alt:"1653897115346",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1399]||(s[1399]=i("p",null,"具体流程如下图：",-1)),s[1400]||(s[1400]=i("p",null,"用户去读取数据时，会去先发起recvform一个命令，去尝试从内核上加载数据，如果内核没有数据，那么用户就会等待，此时内核会去从硬件上读取数据，内核读取数据之后，会把数据拷贝到用户态，并且返回ok，整个过程，都是阻塞等待的，这就是阻塞IO",-1)),s[1401]||(s[1401]=i("p",null,"总结如下：",-1)),s[1402]||(s[1402]=i("p",null,"顾名思义，阻塞IO就是两个阶段都必须阻塞等待：",-1)),s[1403]||(s[1403]=i("p",null,[i("strong",null,"阶段一：")],-1)),s[1404]||(s[1404]=i("ul",null,[i("li",null,"用户进程尝试读取数据（比如网卡数据）"),i("li",null,"此时数据尚未到达，内核需要等待数据"),i("li",null,"此时用户进程也处于阻塞状态")],-1)),s[1405]||(s[1405]=i("p",null,"阶段二：",-1)),s[1406]||(s[1406]=i("ul",null,[i("li",null,"数据到达并拷贝到内核缓冲区，代表已就绪"),i("li",null,"将内核数据拷贝到用户缓冲区"),i("li",null,"拷贝过程中，用户进程依然阻塞等待"),i("li",null,"拷贝完成，用户进程解除阻塞，处理数据")],-1)),s[1407]||(s[1407]=i("p",null,"可以看到，阻塞IO模型中，用户进程在两个阶段都是阻塞状态。",-1)),s[1408]||(s[1408]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653897270074.png",alt:"1653897270074",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1409]||(s[1409]=i("h4",{id:"_2-3-网络模型-非阻塞-io",tabindex:"-1"},[l("2.3 网络模型 - 非阻塞 IO "),i("a",{class:"header-anchor",href:"#_2-3-网络模型-非阻塞-io","aria-label":'Permalink to "2.3 网络模型 - 非阻塞 IO"'},"​")],-1)),s[1410]||(s[1410]=i("p",null,"顾名思义，非阻塞IO的recvfrom操作会立即返回结果而不是阻塞用户进程。",-1)),s[1411]||(s[1411]=i("p",null,"阶段一：",-1)),s[1412]||(s[1412]=i("ul",null,[i("li",null,"用户进程尝试读取数据（比如网卡数据）"),i("li",null,"此时数据尚未到达，内核需要等待数据"),i("li",null,"返回异常给用户进程"),i("li",null,"用户进程拿到error后，再次尝试读取"),i("li",null,"循环往复，直到数据就绪")],-1)),s[1413]||(s[1413]=i("p",null,"阶段二：",-1)),s[1414]||(s[1414]=i("ul",null,[i("li",null,"将内核数据拷贝到用户缓冲区"),i("li",null,"拷贝过程中，用户进程依然阻塞等待"),i("li",null,"拷贝完成，用户进程解除阻塞，处理数据"),i("li",null,"可以看到，非阻塞IO模型中，用户进程在第一个阶段是非阻塞，第二个阶段是阻塞状态。虽然是非阻塞，但性能并没有得到提高。而且忙等机制会导致CPU空转，CPU使用率暴增。")],-1)),s[1415]||(s[1415]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653897490116.png",alt:"1653897490116",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1416]||(s[1416]=i("h4",{id:"_2-4-网络模型-io多路复用",tabindex:"-1"},[l("2.4 网络模型 - IO多路复用 "),i("a",{class:"header-anchor",href:"#_2-4-网络模型-io多路复用","aria-label":'Permalink to "2.4 网络模型 - IO多路复用"'},"​")],-1)),s[1417]||(s[1417]=i("p",null,"无论是阻塞IO还是非阻塞IO，用户应用在一阶段都需要调用recvfrom来获取数据，差别在于无数据时的处理方案：",-1)),s[1418]||(s[1418]=i("p",null,"如果调用recvfrom时，恰好没有数据，阻塞IO会使CPU阻塞，非阻塞IO使CPU空转，都不能充分发挥CPU的作用。 如果调用recvfrom时，恰好有数据，则用户进程可以直接进入第二阶段，读取并处理数据",-1)),s[1419]||(s[1419]=i("p",null,"所以怎么看起来以上两种方式性能都不好",-1)),s[1420]||(s[1420]=i("p",null,"而在单线程情况下，只能依次处理IO事件，如果正在处理的IO事件恰好未就绪（数据不可读或不可写），线程就会被阻塞，所有IO事件都必须等待，性能自然会很差。",-1)),s[1421]||(s[1421]=i("p",null,[l("就比如服务员给顾客点餐，"),i("strong",null,"分两步"),l("：")],-1)),s[1422]||(s[1422]=i("ul",null,[i("li",null,"顾客思考要吃什么（等待数据就绪）"),i("li",null,"顾客想好了，开始点餐（读取数据）")],-1)),s[1423]||(s[1423]=i("p",null,"要提高效率有几种办法？",-1)),s[1424]||(s[1424]=i("p",null,"方案一：增加更多服务员（多线程） 方案二：不排队，谁想好了吃什么（数据就绪了），服务员就给谁点餐（用户应用就去读取数据）",-1)),s[1425]||(s[1425]=i("p",null,"那么问题来了：用户进程如何知道内核中数据是否就绪呢？",-1)),s[1426]||(s[1426]=i("p",null,"所以接下来就需要详细的来解决多路复用模型是如何知道到底怎么知道内核数据是否就绪的问题了",-1)),s[1427]||(s[1427]=i("p",null,"这个问题的解决依赖于提出的",-1)),s[1428]||(s[1428]=i("p",null,"文件描述符（File Descriptor）：简称FD，是一个从0 开始的无符号整数，用来关联Linux中的一个文件。在Linux中，一切皆文件，例如常规文件、视频、硬件设备等，当然也包括网络套接字（Socket）。",-1)),s[1429]||(s[1429]=i("p",null,"通过FD，我们的网络模型可以利用一个线程监听多个FD，并在某个FD可读、可写时得到通知，从而避免无效的等待，充分利用CPU资源。",-1)),s[1430]||(s[1430]=i("p",null,"阶段一：",-1)),s[1431]||(s[1431]=i("ul",null,[i("li",null,"用户进程调用select，指定要监听的FD集合"),i("li",null,"核监听FD对应的多个socket"),i("li",null,"任意一个或多个socket数据就绪则返回readable"),i("li",null,"此过程中用户进程阻塞")],-1)),s[1432]||(s[1432]=i("p",null,"阶段二：",-1)),s[1433]||(s[1433]=i("ul",null,[i("li",null,"用户进程找到就绪的socket"),i("li",null,"依次调用recvfrom读取数据"),i("li",null,"内核将数据拷贝到用户空间"),i("li",null,"用户进程处理数据")],-1)),s[1434]||(s[1434]=i("p",null,"当用户去读取数据的时候，不再去直接调用recvfrom了，而是调用select的函数，select函数会将需要监听的数据交给内核，由内核去检查这些数据是否就绪了，如果说这个数据就绪了，就会通知应用程序数据就绪，然后来读取数据，再从内核中把数据拷贝给用户态，完成数据处理，如果N多个FD一个都没处理完，此时就进行等待。",-1)),s[1435]||(s[1435]=i("p",null,"用IO复用模式，可以确保去读数据的时候，数据是一定存在的，他的效率比原来的阻塞IO和非阻塞IO性能都要高",-1)),s[1436]||(s[1436]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653898691736.png",alt:"1653898691736",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1437]||(s[1437]=i("p",null,"IO多路复用是利用单个线程来同时监听多个FD，并在某个FD可读、可写时得到通知，从而避免无效的等待，充分利用CPU资源。不过监听FD的方式、通知的方式又有多种实现，常见的有：",-1)),s[1438]||(s[1438]=i("ul",null,[i("li",null,"select"),i("li",null,"poll"),i("li",null,"epoll")],-1)),s[1439]||(s[1439]=i("p",null,"其中select和pool相当于是当被监听的数据准备好之后，他会把你监听的FD整个数据都发给你，你需要到整个FD中去找，哪些是处理好了的，需要通过遍历的方式，所以性能也并不是那么好",-1)),s[1440]||(s[1440]=i("p",null,"而epoll，则相当于内核准备好了之后，他会把准备好的数据，直接发给你，咱们就省去了遍历的动作。",-1)),s[1441]||(s[1441]=i("h4",{id:"_2-5-网络模型-io-多路复用-select-方式",tabindex:"-1"},[l("2.5 网络模型 - IO 多路复用 - select 方式 "),i("a",{class:"header-anchor",href:"#_2-5-网络模型-io-多路复用-select-方式","aria-label":'Permalink to "2.5 网络模型 - IO 多路复用 - select 方式"'},"​")],-1)),s[1442]||(s[1442]=i("p",null,"select是Linux最早是由的I/O多路复用技术：",-1)),s[1443]||(s[1443]=i("p",null,"简单说，就是我们把需要处理的数据封装成FD，然后在用户态时创建一个fd的集合（这个集合的大小是要监听的那个FD的最大值+1，但是大小整体是有限制的 ），这个集合的长度大小是有限制的，同时在这个集合中，标明出来我们要控制哪些数据，",-1)),s[1444]||(s[1444]=i("p",null,"比如要监听的数据，是1,2,5三个数据，此时会执行select函数，然后将整个fd发给内核态，内核态会去遍历用户态传递过来的数据，如果发现这里边都数据都没有就绪，就休眠，直到有数据准备好时，就会被唤醒，唤醒之后，再次遍历一遍，看看谁准备好了，然后再将处理掉没有准备好的数据，最后再将这个FD集合写回到用户态中去，此时用户态就知道了，奥，有人准备好了，但是对于用户态而言，并不知道谁处理好了，所以用户态也需要去进行遍历，然后找到对应准备好数据的节点，再去发起读请求，我们会发现，这种模式下他虽然比阻塞IO和非阻塞IO好，但是依然有些麻烦的事情， 比如说频繁的传递fd集合，频繁的去遍历FD等问题",-1)),s[1445]||(s[1445]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653900022580.png",alt:"1653900022580",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1446]||(s[1446]=i("h4",{id:"_2-6-网络模型-io-多路复用模型-poll-模式",tabindex:"-1"},[l("2.6 网络模型 - IO 多路复用模型 - poll 模式 "),i("a",{class:"header-anchor",href:"#_2-6-网络模型-io-多路复用模型-poll-模式","aria-label":'Permalink to "2.6 网络模型 - IO 多路复用模型 - poll 模式"'},"​")],-1)),s[1447]||(s[1447]=i("p",null,"poll模式对select模式做了简单改进，但性能提升不明显，部分关键代码如下：",-1)),s[1448]||(s[1448]=i("p",null,"IO流程：",-1)),s[1449]||(s[1449]=i("ul",null,[i("li",null,"创建pollfd数组，向其中添加关注的fd信息，数组大小自定义"),i("li",null,"调用poll函数，将pollfd数组拷贝到内核空间，转链表存储，无上限"),i("li",null,"内核遍历fd，判断是否就绪"),i("li",null,"数据就绪或超时后，拷贝pollfd数组到用户空间，返回就绪fd数量n"),i("li",null,"用户进程判断n是否大于0,大于0则遍历pollfd数组，找到就绪的fd")],-1)),s[1450]||(s[1450]=i("p",null,[i("strong",null,"与select对比：")],-1)),s[1451]||(s[1451]=i("ul",null,[i("li",null,"select模式中的fd_set大小固定为1024，而pollfd在内核中采用链表，理论上无上限"),i("li",null,"监听FD越多，每次遍历消耗时间也越久，性能反而会下降")],-1)),s[1452]||(s[1452]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653900721427.png",alt:"1653900721427",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1453]||(s[1453]=i("h4",{id:"_2-7-网络模型-io-多路复用模型-epoll-函数",tabindex:"-1"},[l("2.7 网络模型 - IO 多路复用模型 - epoll 函数 "),i("a",{class:"header-anchor",href:"#_2-7-网络模型-io-多路复用模型-epoll-函数","aria-label":'Permalink to "2.7 网络模型 - IO 多路复用模型 - epoll 函数"'},"​")],-1)),s[1454]||(s[1454]=i("p",null,"epoll模式是对select和poll的改进，它提供了三个函数：",-1)),s[1455]||(s[1455]=i("p",null,"第一个是：eventpoll的函数，他内部包含两个东西",-1)),s[1456]||(s[1456]=i("p",null,"一个是：",-1)),s[1457]||(s[1457]=i("p",null,[l("1、"),i("code",null,"红黑树-> 记录的事要监听的FD")],-1)),s[1458]||(s[1458]=i("p",null,[l("2、"),i("code",null,"一个是链表->一个链表，记录的是就绪的FD")],-1)),s[1459]||(s[1459]=i("p",null,"紧接着调用epoll_ctl操作，将要监听的数据添加到红黑树上去，并且给每个fd设置一个监听函数，这个函数会在fd数据就绪时触发，就是准备好了，现在就把fd把数据添加到list_head中去",-1)),s[1460]||(s[1460]=i("p",null,"3、调用epoll_wait函数",-1)),s[1461]||(s[1461]=i("p",null,"就去等待，在用户态创建一个空的events数组，当就绪之后，我们的回调函数会把数据添加到list_head中去，当调用这个函数的时候，会去检查list_head，当然这个过程需要参考配置的等待时间，可以等一定时间，也可以一直等， 如果在此过程中，检查到了list_head中有数据会将数据添加到链表中，此时将数据放入到events数组中，并且返回对应的操作的数量，用户态的此时收到响应后，从events中拿到对应准备好的数据的节点，再去调用方法去拿数据。",-1)),s[1462]||(s[1462]=i("p",null,"小总结：",-1)),s[1463]||(s[1463]=i("p",null,"select模式存在的三个问题：",-1)),s[1464]||(s[1464]=i("ul",null,[i("li",null,"能监听的FD最大不超过1024"),i("li",null,"每次select都需要把所有要监听的FD都拷贝到内核空间"),i("li",null,"每次都要遍历所有FD来判断就绪状态")],-1)),s[1465]||(s[1465]=i("p",null,"poll模式的问题：",-1)),s[1466]||(s[1466]=i("ul",null,[i("li",null,"poll利用链表解决了select中监听FD上限的问题，但依然要遍历所有FD，如果监听较多，性能会下降")],-1)),s[1467]||(s[1467]=i("p",null,"epoll模式中如何解决这些问题的？",-1)),s[1468]||(s[1468]=i("ul",null,[i("li",null,"基于epoll实例中的红黑树保存要监听的FD，理论上无上限，而且增删改查效率都非常高"),i("li",null,"每个FD只需要执行一次epoll_ctl添加到红黑树，以后每次epol_wait无需传递任何参数，无需重复拷贝FD到内核空间"),i("li",null,"利用ep_poll_callback机制来监听FD状态，无需遍历所有FD，因此性能不会随监听的FD数量增多而下降")],-1)),s[1469]||(s[1469]=i("h4",{id:"_2-8-网络模型-epoll-中的-et-和-lt",tabindex:"-1"},[l("2.8 网络模型 - epoll 中的 ET 和 LT "),i("a",{class:"header-anchor",href:"#_2-8-网络模型-epoll-中的-et-和-lt","aria-label":'Permalink to "2.8 网络模型 - epoll 中的 ET 和 LT"'},"​")],-1)),s[1470]||(s[1470]=i("p",null,"当FD有数据可读时，我们调用epoll_wait（或者select、poll）可以得到通知。但是事件通知的模式有两种：",-1)),s[1471]||(s[1471]=i("ul",null,[i("li",null,"LevelTriggered：简称LT，也叫做水平触发。只要某个FD中有数据可读，每次调用epoll_wait都会得到通知。"),i("li",null,"EdgeTriggered：简称ET，也叫做边沿触发。只有在某个FD有状态变化时，调用epoll_wait才会被通知。")],-1)),s[1472]||(s[1472]=i("p",null,"举个栗子：",-1)),s[1473]||(s[1473]=i("ul",null,[i("li",null,"假设一个客户端socket对应的FD已经注册到了epoll实例中"),i("li",null,"客户端socket发送了2kb的数据"),i("li",null,"服务端调用epoll_wait，得到通知说FD就绪"),i("li",null,"服务端从FD读取了1kb数据回到步骤3（再次调用epoll_wait，形成循环）")],-1)),s[1474]||(s[1474]=i("p",null,"结论",-1)),s[1475]||(s[1475]=i("p",null,"如果我们采用LT模式，因为FD中仍有1kb数据，则第⑤步依然会返回结果，并且得到通知 如果我们采用ET模式，因为第③步已经消费了FD可读事件，第⑤步FD状态没有变化，因此epoll_wait不会返回，数据无法读取，客户端响应超时。",-1)),s[1476]||(s[1476]=i("h4",{id:"_2-9-网络模型-基于-epoll-的服务器端流程",tabindex:"-1"},[l("2.9 网络模型 - 基于 epoll 的服务器端流程 "),i("a",{class:"header-anchor",href:"#_2-9-网络模型-基于-epoll-的服务器端流程","aria-label":'Permalink to "2.9 网络模型 - 基于 epoll 的服务器端流程"'},"​")],-1)),s[1477]||(s[1477]=i("p",null,"我们来梳理一下这张图",-1)),s[1478]||(s[1478]=i("p",null,"服务器启动以后，服务端会去调用epoll_create，创建一个epoll实例，epoll实例中包含两个数据",-1)),s[1479]||(s[1479]=i("p",null,"1、红黑树（为空）：rb_root 用来去记录需要被监听的FD",-1)),s[1480]||(s[1480]=i("p",null,"2、链表（为空）：list_head，用来存放已经就绪的FD",-1)),s[1481]||(s[1481]=i("p",null,"创建好了之后，会去调用epoll_ctl函数，此函数会会将需要监听的数据添加到rb_root中去，并且对当前这些存在于红黑树的节点设置回调函数，当这些被监听的数据一旦准备完成，就会被调用，而调用的结果就是将红黑树的fd添加到list_head中去(但是此时并没有完成)",-1)),s[1482]||(s[1482]=i("p",null,"3、当第二步完成后，就会调用epoll_wait函数，这个函数会去校验是否有数据准备完毕（因为数据一旦准备就绪，就会被回调函数添加到list_head中），在等待了一段时间后(可以进行配置)，如果等够了超时时间，则返回没有数据，如果有，则进一步判断当前是什么事件，如果是建立连接时间，则调用accept() 接受客户端socket，拿到建立连接的socket，然后建立起来连接，如果是其他事件，则把数据进行写出",-1)),s[1483]||(s[1483]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653902845082.png",alt:"1653902845082",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1484]||(s[1484]=i("h4",{id:"_3-0-网络模型-信号驱动",tabindex:"-1"},[l("3.0 网络模型 - 信号驱动 "),i("a",{class:"header-anchor",href:"#_3-0-网络模型-信号驱动","aria-label":'Permalink to "3.0 网络模型 - 信号驱动"'},"​")],-1)),s[1485]||(s[1485]=i("p",null,"信号驱动IO是与内核建立SIGIO的信号关联并设置回调，当内核有FD就绪时，会发出SIGIO信号通知用户，期间用户应用可以执行其它业务，无需阻塞等待。",-1)),s[1486]||(s[1486]=i("p",null,"阶段一：",-1)),s[1487]||(s[1487]=i("ul",null,[i("li",null,"用户进程调用sigaction，注册信号处理函数"),i("li",null,"内核返回成功，开始监听FD"),i("li",null,"用户进程不阻塞等待，可以执行其它业务"),i("li",null,"当内核数据就绪后，回调用户进程的SIGIO处理函数")],-1)),s[1488]||(s[1488]=i("p",null,"阶段二：",-1)),s[1489]||(s[1489]=i("ul",null,[i("li",null,"收到SIGIO回调信号"),i("li",null,"调用recvfrom，读取"),i("li",null,"内核将数据拷贝到用户空间"),i("li",null,"用户进程处理数据")],-1)),s[1490]||(s[1490]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653911776583.png",alt:"1653911776583",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1491]||(s[1491]=i("p",null,"当有大量IO操作时，信号较多，SIGIO处理函数不能及时处理可能导致信号队列溢出，而且内核空间与用户空间的频繁信号交互性能也较低。",-1)),s[1492]||(s[1492]=i("h5",{id:"_3-0-1-异步-io",tabindex:"-1"},[l("3.0.1 异步 IO "),i("a",{class:"header-anchor",href:"#_3-0-1-异步-io","aria-label":'Permalink to "3.0.1 异步 IO"'},"​")],-1)),s[1493]||(s[1493]=i("p",null,"这种方式，不仅仅是用户态在试图读取数据后，不阻塞，而且当内核的数据准备完成后，也不会阻塞",-1)),s[1494]||(s[1494]=i("p",null,"他会由内核将所有数据处理完成后，由内核将数据写入到用户态中，然后才算完成，所以性能极高，不会有任何阻塞，全部都由内核完成，可以看到，异步IO模型中，用户进程在两个阶段都是非阻塞状态。",-1)),s[1495]||(s[1495]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653911877542.png",alt:"1653911877542",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1496]||(s[1496]=i("h5",{id:"_3-0-2-对比",tabindex:"-1"},[l("3.0.2 对比 "),i("a",{class:"header-anchor",href:"#_3-0-2-对比","aria-label":'Permalink to "3.0.2 对比"'},"​")],-1)),s[1497]||(s[1497]=i("p",null,"最后用一幅图，来说明他们之间的区别",-1)),s[1498]||(s[1498]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653912219712.png",alt:"1653912219712",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1499]||(s[1499]=i("h4",{id:"_3-1-网络模型-redis-是单线程的吗-为什么使用单线程",tabindex:"-1"},[l("3.1 网络模型 - Redis 是单线程的吗？为什么使用单线程 "),i("a",{class:"header-anchor",href:"#_3-1-网络模型-redis-是单线程的吗-为什么使用单线程","aria-label":'Permalink to "3.1 网络模型 - Redis 是单线程的吗？为什么使用单线程"'},"​")],-1)),s[1500]||(s[1500]=i("p",null,[i("strong",null,"Redis到底是单线程还是多线程？")],-1)),s[1501]||(s[1501]=i("ul",null,[i("li",null,"如果仅仅聊Redis的核心业务部分（命令处理），答案是单线程"),i("li",null,"如果是聊整个Redis，那么答案就是多线程")],-1)),s[1502]||(s[1502]=i("p",null,"在Redis版本迭代过程中，在两个重要的时间节点上引入了多线程的支持：",-1)),s[1503]||(s[1503]=i("ul",null,[i("li",null,"Redis v4.0：引入多线程异步处理一些耗时较旧的任务，例如异步删除命令unlink"),i("li",null,"Redis v6.0：在核心网络模型中引入 多线程，进一步提高对于多核CPU的利用率")],-1)),s[1504]||(s[1504]=i("p",null,"因此，对于Redis的核心网络模型，在Redis 6.0之前确实都是单线程。是利用epoll（Linux系统）这样的IO多路复用技术在事件循环中不断处理客户端情况。",-1)),s[1505]||(s[1505]=i("p",null,[i("strong",null,"为什么Redis要选择单线程？")],-1)),s[1506]||(s[1506]=i("ul",null,[i("li",null,"抛开持久化不谈，Redis是纯 内存操作，执行速度非常快，它的性能瓶颈是网络延迟而不是执行速度，因此多线程并不会带来巨大的性能提升。"),i("li",null,"多线程会导致过多的上下文切换，带来不必要的开销"),i("li",null,"引入多线程会面临线程安全问题，必然要引入线程锁这样的安全手段，实现复杂度增高，而且性能也会大打折扣")],-1)),s[1507]||(s[1507]=i("h4",{id:"_3-2-redis-的单线程模型-redis-单线程和多线程网络模型变更",tabindex:"-1"},[l("3.2 Redis 的单线程模型 - Redis 单线程和多线程网络模型变更 "),i("a",{class:"header-anchor",href:"#_3-2-redis-的单线程模型-redis-单线程和多线程网络模型变更","aria-label":'Permalink to "3.2 Redis 的单线程模型 - Redis 单线程和多线程网络模型变更"'},"​")],-1)),s[1508]||(s[1508]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653982278727.png",alt:"1653982278727",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1509]||(s[1509]=i("p",null,"当我们的客户端想要去连接我们服务器，会去先到IO多路复用模型去进行排队，会有一个连接应答处理器，他会去接受读请求，然后又把读请求注册到具体模型中去，此时这些建立起来的连接，如果是客户端请求处理器去进行执行命令时，他会去把数据读取出来，然后把数据放入到client中， clinet去解析当前的命令转化为redis认识的命令，接下来就开始处理这些命令，从redis中的command中找到这些命令，然后就真正的去操作对应的数据了，当数据操作完成后，会去找到命令回复处理器，再由他将数据写出。",-1)),s[1510]||(s[1510]=i("hr",null,null,-1)),s[1511]||(s[1511]=i("h3",{id:"_3-redis-通信协议-resp-协议",tabindex:"-1"},[l("3. Redis 通信协议 - RESP 协议 "),i("a",{class:"header-anchor",href:"#_3-redis-通信协议-resp-协议","aria-label":'Permalink to "3. Redis 通信协议 - RESP 协议"'},"​")],-1)),s[1512]||(s[1512]=i("p",null,"Redis是一个CS架构的软件，通信一般分两步（不包括pipeline和PubSub）：",-1)),s[1513]||(s[1513]=i("p",null,"客户端（client）向服务端（server）发送一条命令",-1)),s[1514]||(s[1514]=i("p",null,"服务端解析并执行命令，返回响应结果给客户端",-1)),s[1515]||(s[1515]=i("p",null,"因此客户端发送命令的格式、服务端响应结果的格式必须有一个规范，这个规范就是通信协议。",-1)),s[1516]||(s[1516]=i("p",null,"而在Redis中采用的是RESP（Redis Serialization Protocol）协议：",-1)),s[1517]||(s[1517]=i("p",null,"Redis 1.2版本引入了RESP协议",-1)),s[1518]||(s[1518]=i("p",null,"Redis 2.0版本中成为与Redis服务端通信的标准，称为RESP2",-1)),s[1519]||(s[1519]=i("p",null,"Redis 6.0版本中，从RESP2升级到了RESP3协议，增加了更多数据类型并且支持6.0的新特性–客户端缓存",-1)),s[1520]||(s[1520]=i("p",null,"但目前，默认使用的依然是RESP2协议，也是我们要学习的协议版本（以下简称RESP）。",-1)),s[1521]||(s[1521]=i("p",null,"在RESP中，通过首字节的字符来区分不同数据类型，常用的数据类型包括5种：",-1)),s[1522]||(s[1522]=i("p",null,[l("单行字符串：首字节是 ‘+’ ，后面跟上单行字符串，以"),i("code",null,'CRLF（ "\\r\\n" ）'),l("结尾。例如返回"),i("code",null,'"OK"： "+OK\\r\\n"')],-1)),s[1523]||(s[1523]=i("p",null,[l("错误（Errors）：首字节是 ‘-’ ，与单行字符串格式一样，只是字符串是异常信息，例如："),i("code",null,'"-Error message\\r\\n"')],-1)),s[1524]||(s[1524]=i("p",null,[l("数值：首字节是 ‘:’ ，后面跟上数字格式的字符串，以CRLF结尾。例如："),i("code",null,'":10\\r\\n"')],-1)),s[1525]||(s[1525]=i("p",null,"多行字符串：首字节是 ‘$’ ，表示二进制安全的字符串，最大支持512MB：",-1)),s[1526]||(s[1526]=i("p",null,[l("如果大小为0，则代表空字符串："),i("code",null,'"$0\\r\\n\\r\\n"')],-1)),s[1527]||(s[1527]=i("p",null,[l("如果大小为-1，则代表不存在："),i("code",null,'"$-1\\r\\n"')],-1)),s[1528]||(s[1528]=i("p",null,"数组：首字节是 ‘*’，后面跟上数组元素个数，再跟上元素，元素数据类型不限:",-1)),s[1529]||(s[1529]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653982993020.png",alt:"1653982993020",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1530]||(s[1530]=i("h4",{id:"_3-1-redis-通信协议-基于-socket-自定义-redis-的客户端",tabindex:"-1"},[l("3.1 Redis 通信协议 - 基于 Socket 自定义 Redis 的客户端 "),i("a",{class:"header-anchor",href:"#_3-1-redis-通信协议-基于-socket-自定义-redis-的客户端","aria-label":'Permalink to "3.1 Redis 通信协议 - 基于 Socket 自定义 Redis 的客户端"'},"​")],-1)),s[1531]||(s[1531]=i("p",null,"Redis支持TCP通信，因此我们可以使用Socket来模拟客户端，与Redis服务端建立连接：",-1)),s[1532]||(s[1532]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Main"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    static"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Socket s;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    static"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," PrintWriter writer;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    static"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BufferedReader reader;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"args"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 1.建立连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String host "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "192.168.150.101"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," port "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 6379"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            s "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Socket"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(host, port);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.获取输出流、输入流")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            writer "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," PrintWriter"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," OutputStreamWriter"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(s."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOutputStream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), StandardCharsets.UTF_8));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            reader "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BufferedReader"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InputStreamReader"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(s."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInputStream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), StandardCharsets.UTF_8));")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.发出请求")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.1.获取授权 auth 123321")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            sendRequest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"auth"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Object obj "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleResponse"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"obj = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," obj);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.2.set name 虎哥")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            sendRequest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"set"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"虎哥"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.解析响应")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            obj "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleResponse"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"obj = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," obj);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.2.set name 虎哥")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            sendRequest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"get"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.解析响应")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            obj "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleResponse"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"obj = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," obj);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 3.2.set name 虎哥")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            sendRequest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"mget"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"num"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"msg"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 4.解析响应")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            obj "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleResponse"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"obj = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," obj);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (IOException "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            e."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"printStackTrace"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 5.释放连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (reader "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") reader."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (writer "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") writer."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (s "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") s."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (IOException "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                e."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"printStackTrace"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Object "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"handleResponse"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IOException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 读取首字节")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prefix "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," reader."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 判断数据类型标示")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        switch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (prefix) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            case"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '+'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," // 单行字符串，直接读一行")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," reader."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"readLine"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            case"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '-'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," // 异常，也读一行")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                throw"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(reader."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"readLine"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            case"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ':'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," // 数字")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Long."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseLong"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(reader."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"readLine"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            case"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '$'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," // 多行字符串")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 先读长度")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseInt"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(reader."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"readLine"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    return"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ""'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 再读数据,读len个字节。我们假设没有特殊字符，所以读一行（简化）")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," reader."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"readLine"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            case"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '*'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," readBulkString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            default:")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                throw"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"错误的数据格式！"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Object "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"readBulkString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IOException {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取数组大小")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseInt"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(reader."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"readLine"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 定义集合，接收多个元素")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> list "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>(len);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 遍历，依次读取每个元素")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len; i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"handleResponse"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // set name 虎哥")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," sendRequest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String ... "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"args"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        writer."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"*"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," args.length);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (String arg "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," args) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            writer."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"$"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," arg."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBytes"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StandardCharsets.UTF_8).length);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            writer."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arg);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        writer."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"flush"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1533]||(s[1533]=i("h4",{id:"_3-2-redis-内存回收-过期-key-处理",tabindex:"-1"},[l("3.2 Redis 内存回收 - 过期 key 处理 "),i("a",{class:"header-anchor",href:"#_3-2-redis-内存回收-过期-key-处理","aria-label":'Permalink to "3.2 Redis 内存回收 - 过期 key 处理"'},"​")],-1)),s[1534]||(s[1534]=i("p",null,"Redis之所以性能强，最主要的原因就是基于内存存储。然而单节点的Redis其内存大小不宜过大，会影响持久化或主从同步性能。 我们可以通过修改配置文件来设置Redis的最大内存：",-1)),s[1535]||(s[1535]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653983341150.png",alt:"1653983341150",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1536]||(s[1536]=i("p",null,"当内存使用达到上限时，就无法存储更多数据了。为了解决这个问题，Redis提供了一些策略实现内存回收：",-1)),s[1537]||(s[1537]=i("p",null,"内存过期策略",-1)),s[1538]||(s[1538]=i("p",null,"在学习Redis缓存的时候我们说过，可以通过expire命令给Redis的key设置TTL（存活时间）：",-1)),s[1539]||(s[1539]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653983366243.png",alt:"1653983366243",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1540]||(s[1540]=i("p",null,"可以发现，当key的TTL到期以后，再次访问name返回的是nil，说明这个key已经不存在了，对应的内存也得到释放。从而起到内存回收的目的。",-1)),s[1541]||(s[1541]=i("p",null,"Redis本身是一个典型的key-value内存存储数据库，因此所有的key、value都保存在之前学习过的Dict结构中。不过在其database结构体中，有两个Dict：一个用来记录key-value；另一个用来记录key-TTL。",-1)),s[1542]||(s[1542]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653983423128.png",alt:"1653983423128",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1543]||(s[1543]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653983606531.png",alt:"1653983606531",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1544]||(s[1544]=i("p",null,"这里有两个问题需要我们思考： Redis是如何知道一个key是否过期呢？",-1)),s[1545]||(s[1545]=i("p",null,"利用两个Dict分别记录key-value对及key-ttl对",-1)),s[1546]||(s[1546]=i("p",null,"是不是TTL到期就立即删除了呢？",-1)),s[1547]||(s[1547]=i("p",null,[i("strong",null,"惰性删除")],-1)),s[1548]||(s[1548]=i("p",null,"惰性删除：顾明思议并不是在TTL到期后就立刻删除，而是在访问一个key的时候，检查该key的存活时间，如果已经过期才执行删除。",-1)),s[1549]||(s[1549]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653983652865.png",alt:"1653983652865",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1550]||(s[1550]=i("p",null,[i("strong",null,"周期删除")],-1)),s[1551]||(s[1551]=i("p",null,"周期删除：顾明思议是通过一个定时任务，周期性的抽样部分过期的key，然后执行删除。执行周期有两种： Redis服务初始化函数initServer()中设置定时任务，按照server.hz的频率来执行过期key清理，模式为SLOW Redis的每个事件循环前会调用beforeSleep()函数，执行过期key清理，模式为FAST",-1)),s[1552]||(s[1552]=i("p",null,"周期删除：顾明思议是通过一个定时任务，周期性的抽样部分过期的key，然后执行删除。执行周期有两种： Redis服务初始化函数initServer()中设置定时任务，按照server.hz的频率来执行过期key清理，模式为SLOW Redis的每个事件循环前会调用beforeSleep()函数，执行过期key清理，模式为FAST",-1)),s[1553]||(s[1553]=i("p",null,"SLOW模式规则：",-1)),s[1554]||(s[1554]=i("ul",null,[i("li",null,"执行频率受server.hz影响，默认为10，即每秒执行10次，每个执行周期100ms。"),i("li",null,"执行清理耗时不超过一次执行周期的25%.默认slow模式耗时不超过25ms"),i("li",null,"逐个遍历db，逐个遍历db中的bucket，抽取20个key判断是否过期"),i("li",null,"如果没达到时间上限（25ms）并且过期key比例大于10%，再进行一次抽样，否则结束"),i("li",null,"FAST模式规则（过期key比例小于10%不执行 ）："),i("li",null,"执行频率受beforeSleep()调用频率影响，但两次FAST模式间隔不低于2ms"),i("li",null,"执行清理耗时不超过1ms"),i("li",null,"逐个遍历db，逐个遍历db中的bucket，抽取20个key判断是否过期 如果没达到时间上限（1ms）并且过期key比例大于10%，再进行一次抽样，否则结束")],-1)),s[1555]||(s[1555]=i("p",null,"小总结：",-1)),s[1556]||(s[1556]=i("p",null,"RedisKey的TTL记录方式：",-1)),s[1557]||(s[1557]=i("p",null,"在RedisDB中通过一个Dict记录每个Key的TTL时间",-1)),s[1558]||(s[1558]=i("p",null,"过期key的删除策略：",-1)),s[1559]||(s[1559]=i("p",null,"惰性清理：每次查找key时判断是否过期，如果过期则删除",-1)),s[1560]||(s[1560]=i("p",null,"定期清理：定期抽样部分key，判断是否过期，如果过期则删除。 定期清理的两种模式：",-1)),s[1561]||(s[1561]=i("p",null,"SLOW模式执行频率默认为10，每次不超过25ms",-1)),s[1562]||(s[1562]=i("p",null,"FAST模式执行频率不固定，但两次间隔不低于2ms，每次耗时不超过1ms",-1)),s[1563]||(s[1563]=i("h4",{id:"_3-3-redis-内存回收-内存淘汰策略",tabindex:"-1"},[l("3.3 Redis 内存回收 - 内存淘汰策略 "),i("a",{class:"header-anchor",href:"#_3-3-redis-内存回收-内存淘汰策略","aria-label":'Permalink to "3.3 Redis 内存回收 - 内存淘汰策略"'},"​")],-1)),s[1564]||(s[1564]=i("p",null,"内存淘汰：就是当Redis内存使用达到设置的上限时，主动挑选部分key删除以释放更多内存的流程。Redis会在处理客户端命令的方法processCommand()中尝试做内存淘汰：",-1)),s[1565]||(s[1565]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653983978671.png",alt:"1653983978671",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1566]||(s[1566]=i("p",null,"淘汰策略",-1)),s[1567]||(s[1567]=i("p",null,"Redis支持8种不同策略来选择要删除的key：",-1)),s[1568]||(s[1568]=i("ul",null,[i("li",null,"noeviction： 不淘汰任何key，但是内存满时不允许写入新数据，默认就是这种策略。"),i("li",null,"volatile-ttl： 对设置了TTL的key，比较key的剩余TTL值，TTL越小越先被淘汰"),i("li",null,[l("allkeys-random：对全体key ，随机进行淘汰。也就是直接从"),i("code",null,"db->dict"),l("中随机挑选")]),i("li",null,[l("volatile-random：对设置了TTL的key ，随机进行淘汰。也就是从"),i("code",null,"db->expires"),l("中随机挑选。")]),i("li",null,"allkeys-lru： 对全体key，基于LRU算法进行淘汰"),i("li",null,"volatile-lru： 对设置了TTL的key，基于LRU算法进行淘汰"),i("li",null,"allkeys-lfu： 对全体key，基于LFU算法进行淘汰"),i("li",null,[l("volatile-lfu： 对设置了TTL的key，基于LFI算法进行淘汰 比较容易混淆的有两个： "),i("ul",null,[i("li",null,"LRU（Least Recently Used），最少最近使用。用当前时间减去最后一次访问时间，这个值越大则淘汰优先级越高。"),i("li",null,"LFU（Least Frequently Used），最少频率使用。会统计每个key的访问频率，值越小淘汰优先级越高。")])])],-1)),s[1569]||(s[1569]=i("p",null,"Redis的数据都会被封装为RedisObject结构：",-1)),s[1570]||(s[1570]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653984029506.png",alt:"1653984029506",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1571]||(s[1571]=i("p",null,"LFU的访问次数之所以叫做逻辑访问次数，是因为并不是每次key被访问都计数，而是通过运算：",-1)),s[1572]||(s[1572]=i("ul",null,[i("li",null,"生成0~1之间的随机数R"),i("li",null,[l("计算 ("),i("code",null,"旧次数 * lfu_log_factor + 1"),l(")，记录为P")]),i("li",null,[l("如果 "),i("code",null,"R < P"),l(" ，则计数器 + 1，且最大不超过255")]),i("li",null,"访问次数会随时间衰减，距离上一次访问时间每隔 lfu_decay_time 分钟，计数器 -1")],-1)),s[1573]||(s[1573]=i("p",null,"最后用一副图来描述当前的这个流程吧",-1)),s[1574]||(s[1574]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653984085095.png",alt:"1653984085095",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1575]||(s[1575]=i("hr",null,null,-1)),s[1576]||(s[1576]=i("h2",{id:"redis-高级篇之最佳实践",tabindex:"-1"},[l("Redis 高级篇之最佳实践 "),i("a",{class:"header-anchor",href:"#redis-高级篇之最佳实践","aria-label":'Permalink to "Redis 高级篇之最佳实践"'},"​")],-1)),s[1577]||(s[1577]=i("hr",null,null,-1)),s[1578]||(s[1578]=i("h3",{id:"_1-redis-键值设计",tabindex:"-1"},[l("1. Redis 键值设计 "),i("a",{class:"header-anchor",href:"#_1-redis-键值设计","aria-label":'Permalink to "1. Redis 键值设计"'},"​")],-1)),s[1579]||(s[1579]=i("h4",{id:"_1-1-优雅的-key-结构",tabindex:"-1"},[l("1.1 优雅的 key 结构 "),i("a",{class:"header-anchor",href:"#_1-1-优雅的-key-结构","aria-label":'Permalink to "1.1 优雅的 key 结构"'},"​")],-1)),s[1580]||(s[1580]=i("p",null,"Redis的Key虽然可以自定义，但最好遵循下面的几个最佳实践约定：",-1)),s[1581]||(s[1581]=i("ul",null,[i("li",null,[l("遵循基本格式："),i("code",null,"[业务名称]:[数据名]:[id]")]),i("li",null,"长度不超过44字节"),i("li",null,"不包含特殊字符")],-1)),s[1582]||(s[1582]=i("p",null,"例如：我们的登录业务，保存用户信息，其key可以设计成如下格式：",-1)),s[1583]||(s[1583]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521120213631.png",alt:"image-20220521120213631",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1584]||(s[1584]=i("p",null,"这样设计的好处：",-1)),s[1585]||(s[1585]=i("ul",null,[i("li",null,"可读性强"),i("li",null,"避免key冲突"),i("li",null,"方便管理"),i("li",null,"更节省内存： key是string类型，底层编码包含int、embstr和raw三种。embstr在小于44字节使用，采用连续内存空间，内存占用更小。当字节数大于44字节时，会转为raw模式存储，在raw模式下，内存空间不是连续的，而是采用一个指针指向了另外一段内存空间，在这段空间里存储SDS内容，这样空间不连续，访问的时候性能也就会收到影响，还有可能产生内存碎片")],-1)),s[1586]||(s[1586]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521122320482.png",alt:"image-20220521122320482",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1587]||(s[1587]=i("h4",{id:"_1-2-拒绝-bigkey",tabindex:"-1"},[l("1.2 拒绝 BigKey "),i("a",{class:"header-anchor",href:"#_1-2-拒绝-bigkey","aria-label":'Permalink to "1.2 拒绝 BigKey"'},"​")],-1)),s[1588]||(s[1588]=i("p",null,"BigKey通常以Key的大小和Key中成员的数量来综合判定，例如：",-1)),s[1589]||(s[1589]=i("ul",null,[i("li",null,"Key本身的数据量过大：一个String类型的Key，它的值为5 MB"),i("li",null,"Key中的成员数过多：一个ZSET类型的Key，它的成员数量为10,000个"),i("li",null,"Key中成员的数据量过大：一个Hash类型的Key，它的成员数量虽然只有1,000个但这些成员的Value（值）总大小为100 MB")],-1)),s[1590]||(s[1590]=i("p",null,"那么如何判断元素的大小呢？redis也给我们提供了命令",-1)),s[1591]||(s[1591]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521124650117.png",alt:"image-20220521124650117",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1592]||(s[1592]=i("p",null,"推荐值：",-1)),s[1593]||(s[1593]=i("ul",null,[i("li",null,"单个key的value小于10KB"),i("li",null,"对于集合类型的key，建议元素数量小于1000")],-1)),s[1594]||(s[1594]=i("h5",{id:"_1-2-1-bigkey-的危害",tabindex:"-1"},[l("1.2.1 BigKey 的危害 "),i("a",{class:"header-anchor",href:"#_1-2-1-bigkey-的危害","aria-label":'Permalink to "1.2.1 BigKey 的危害"'},"​")],-1)),s[1595]||(s[1595]=i("ul",null,[i("li",null,[l("网络阻塞 "),i("ul",null,[i("li",null,"对BigKey执行读请求时，少量的QPS就可能导致带宽使用率被占满，导致Redis实例，乃至所在物理机变慢")])]),i("li",null,[l("数据倾斜 "),i("ul",null,[i("li",null,"BigKey所在的Redis实例内存使用率远超其他实例，无法使数据分片的内存资源达到均衡")])]),i("li",null,[l("Redis阻塞 "),i("ul",null,[i("li",null,"对元素较多的hash、list、zset等做运算会耗时较旧，使主线程被阻塞")])]),i("li",null,[l("CPU压力 "),i("ul",null,[i("li",null,"对BigKey的数据序列化和反序列化会导致CPU的使用率飙升，影响Redis实例和本机其它应用")])])],-1)),s[1596]||(s[1596]=i("h5",{id:"_1-2-2-如何发现-bigkey",tabindex:"-1"},[l("1.2.2 如何发现 BigKey "),i("a",{class:"header-anchor",href:"#_1-2-2-如何发现-bigkey","aria-label":'Permalink to "1.2.2 如何发现 BigKey"'},"​")],-1)),s[1597]||(s[1597]=i("h6",{id:"_1redis-cli-bigkeys",tabindex:"-1"},[l("①redis-cli --bigkeys "),i("a",{class:"header-anchor",href:"#_1redis-cli-bigkeys","aria-label":'Permalink to "①redis-cli --bigkeys"'},"​")],-1)),s[1598]||(s[1598]=i("p",null,"利用redis-cli提供的–bigkeys参数，可以遍历分析所有key，并返回Key的整体统计信息与每个数据的Top1的big key",-1)),s[1599]||(s[1599]=i("p",null,[l("命令："),i("code",null,"redis-cli -a 密码 --bigkeys")],-1)),s[1600]||(s[1600]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521133359507.png",alt:"image-20220521133359507",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1601]||(s[1601]=i("h6",{id:"_2scan扫描",tabindex:"-1"},[l("②scan扫描 "),i("a",{class:"header-anchor",href:"#_2scan扫描","aria-label":'Permalink to "②scan扫描"'},"​")],-1)),s[1602]||(s[1602]=i("p",null,"自己编程，利用scan扫描Redis中的所有key，利用strlen、hlen等命令判断key的长度（此处不建议使用MEMORY USAGE）",-1)),s[1603]||(s[1603]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521133703245.png",alt:"image-20220521133703245",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1604]||(s[1604]=i("p",null,"scan 命令调用完后每次会返回2个元素，第一个是下一次迭代的光标，第一次光标会设置为0，当最后一次scan 返回的光标等于0时，表示整个scan遍历结束了，第二个返回的是List，一个匹配的key的数组",-1)),s[1605]||(s[1605]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.jedis.util.JedisConnectionFactory;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.jupiter.api.AfterEach;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.jupiter.api.BeforeEach;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.jupiter.api.Test;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis.clients.jedis.Jedis;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis.clients.jedis.ScanResult;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.HashMap;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.List;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.Map;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JedisTest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Jedis jedis;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"BeforeEach")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setUp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.建立连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'        // jedis = new Jedis("192.168.150.101", 6379);')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JedisConnectionFactory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getJedis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.设置密码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"auth"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.选择库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"select"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," STR_MAX_LEN "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1024"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HASH_MAX_LEN "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 500"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testScan"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," maxLen "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String cursor "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "0"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        do"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 扫描并获取一部分key")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ScanResult<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> result "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scan"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cursor);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 记录cursor")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            cursor "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCursor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> list "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getResult"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (list "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                break"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 遍历")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (String key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 判断key的类型")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                String type "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"type"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                switch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (type) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    case"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "string"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"strlen"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        maxLen "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," STR_MAX_LEN;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        break"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    case"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hash"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hlen"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        maxLen "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HASH_MAX_LEN;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        break"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    case"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "list"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"llen"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        maxLen "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HASH_MAX_LEN;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        break"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    case"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "set"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scard"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        maxLen "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HASH_MAX_LEN;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        break"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    case"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "zset"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"zcard"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        maxLen "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HASH_MAX_LEN;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        break"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    default:")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        break"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (len "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," maxLen) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"printf"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Found big key : %s, type: %s, length or size: %d %n"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key, type, len);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"while"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cursor."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"0"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"AfterEach")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tearDown"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (jedis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1606]||(s[1606]=i("h6",{id:"_3第三方工具",tabindex:"-1"},[l("③第三方工具 "),i("a",{class:"header-anchor",href:"#_3第三方工具","aria-label":'Permalink to "③第三方工具"'},"​")],-1)),s[1607]||(s[1607]=i("ul",null,[i("li",null,"利用第三方工具，如 Redis-Rdb-Tools 分析RDB快照文件，全面分析内存使用情况"),i("li",null,[i("a",{href:"https://github.com/sripathikrishnan/redis-rdb-tools",target:"_blank",rel:"noreferrer"},"https://github.com/sripathikrishnan/redis-rdb-tools")])],-1)),s[1608]||(s[1608]=i("h6",{id:"_4网络监控",tabindex:"-1"},[l("④网络监控 "),i("a",{class:"header-anchor",href:"#_4网络监控","aria-label":'Permalink to "④网络监控"'},"​")],-1)),s[1609]||(s[1609]=i("ul",null,[i("li",null,"自定义工具，监控进出Redis的网络数据，超出预警值时主动告警"),i("li",null,"一般阿里云搭建的云服务器就有相关监控页面")],-1)),s[1610]||(s[1610]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521140415785.png",alt:"image-20220521140415785",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1611]||(s[1611]=i("h5",{id:"_1-2-3-如何删除-bigkey",tabindex:"-1"},[l("1.2.3 如何删除 BigKey "),i("a",{class:"header-anchor",href:"#_1-2-3-如何删除-bigkey","aria-label":'Permalink to "1.2.3 如何删除 BigKey"'},"​")],-1)),s[1612]||(s[1612]=i("p",null,"BigKey内存占用较多，即便时删除这样的key也需要耗费很长时间，导致Redis主线程阻塞，引发一系列问题。",-1)),s[1613]||(s[1613]=i("ul",null,[i("li",null,[l("redis 3.0 及以下版本 "),i("ul",null,[i("li",null,"如果是集合类型，则遍历BigKey的元素，先逐个删除子元素，最后删除BigKey")])])],-1)),s[1614]||(s[1614]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521140621204.png",alt:"image-20220521140621204",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1615]||(s[1615]=i("ul",null,[i("li",null,[l("Redis 4.0以后 "),i("ul",null,[i("li",null,"Redis在4.0后提供了异步删除的命令：unlink")])])],-1)),s[1616]||(s[1616]=i("h4",{id:"_1-3-恰当的数据类型",tabindex:"-1"},[l("1.3 恰当的数据类型 "),i("a",{class:"header-anchor",href:"#_1-3-恰当的数据类型","aria-label":'Permalink to "1.3 恰当的数据类型"'},"​")],-1)),s[1617]||(s[1617]=i("h5",{id:"例1-比如存储一个user对象-我们有三种存储方式",tabindex:"-1"},[l("例1：比如存储一个User对象，我们有三种存储方式： "),i("a",{class:"header-anchor",href:"#例1-比如存储一个user对象-我们有三种存储方式","aria-label":'Permalink to "例1：比如存储一个User对象，我们有三种存储方式："'},"​")],-1)),s[1618]||(s[1618]=i("p",null,[i("strong",null,"①方式一：json字符串")],-1)),s[1619]||(s[1619]=i("table",null,[i("thead",null,[i("tr",null,[i("th",{style:{"text-align":"center"}},"user:1"),i("th",{style:{"text-align":"center"}},[i("code",null,'{"name": "Jack", "age": 21}')])])])],-1)),s[1620]||(s[1620]=i("p",null,"优点：实现简单粗暴",-1)),s[1621]||(s[1621]=i("p",null,"缺点：数据耦合，不够灵活",-1)),s[1622]||(s[1622]=i("p",null,[i("strong",null,"②方式二：字段打散")],-1)),s[1623]||(s[1623]=i("table",null,[i("thead",null,[i("tr",null,[i("th",{style:{"text-align":"center"}},"user:1:name"),i("th",{style:{"text-align":"center"}},"Jack")])]),i("tbody",null,[i("tr",null,[i("td",{style:{"text-align":"center"}},"user:1:age"),i("td",{style:{"text-align":"center"}},"21")])])],-1)),s[1624]||(s[1624]=i("p",null,"优点：可以灵活访问对象任意字段",-1)),s[1625]||(s[1625]=i("p",null,"缺点：占用空间大、没办法做统一控制",-1)),s[1626]||(s[1626]=i("p",null,[i("strong",null,"③方式三：hash（推荐）")],-1)),s[1627]||(s[1627]=i("table",null,[i("tbody",null,[i("tr",null,[i("td",{rowspan:"2"},"user:1"),i("td",null,"name"),i("td",null,"jack")]),i("tr",null,[i("td",null,"age"),i("td",null,"21")])])],-1)),s[1628]||(s[1628]=i("p",null,"优点：底层使用ziplist，空间占用小，可以灵活访问对象的任意字段",-1)),s[1629]||(s[1629]=i("p",null,"缺点：代码相对复杂",-1)),s[1630]||(s[1630]=i("h5",{id:"例2-假如有hash类型的key-其中有100万对field和value-field是自增id-这个key存在什么问题-如何优化",tabindex:"-1"},[l("例2：假如有hash类型的key，其中有100万对field和value，field是自增id，这个key存在什么问题？如何优化？ "),i("a",{class:"header-anchor",href:"#例2-假如有hash类型的key-其中有100万对field和value-field是自增id-这个key存在什么问题-如何优化","aria-label":'Permalink to "例2：假如有hash类型的key，其中有100万对field和value，field是自增id，这个key存在什么问题？如何优化？"'},"​")],-1)),s[1631]||(s[1631]=i("table",null,[i("tbody",null,[i("tr",{style:{color:"red"}},[i("td",null,"key"),i("td",null,"field"),i("td",null,"value")]),i("tr",null,[i("td",{rowspan:"3"},"someKey"),i("td",null,"id:0"),i("td",null,"value0")]),i("tr",null,[i("td",null,"....."),i("td",null,".....")]),i("tr",null,[i("td",null,"id:999999"),i("td",null,"value999999")])])],-1)),s[1632]||(s[1632]=i("p",null,"存在的问题：",-1)),s[1633]||(s[1633]=i("ul",null,[i("li",null,[i("p",null,"hash的entry数量超过500时，会使用哈希表而不是ZipList，内存占用较多"),i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521142943350.png",alt:"image-20220521142943350",loading:"lazy",decoding:"async",class:"lazy"})])]),i("li",null,[i("p",null,"可以通过hash-max-ziplist-entries配置entry上限。但是如果entry过多就会导致BigKey问题")])],-1)),s[1634]||(s[1634]=i("h6",{id:"方案一",tabindex:"-1"},[l("方案一 "),i("a",{class:"header-anchor",href:"#方案一","aria-label":'Permalink to "方案一"'},"​")],-1)),s[1635]||(s[1635]=i("p",null,"拆分为string类型",-1)),s[1636]||(s[1636]=i("table",null,[i("tbody",null,[i("tr",{style:{color:"red"}},[i("td",null,"key"),i("td",null,"value")]),i("tr",null,[i("td",null,"id:0"),i("td",null,"value0")]),i("tr",null,[i("td",null,"....."),i("td",null,".....")]),i("tr",null,[i("td",null,"id:999999"),i("td",null,"value999999")])])],-1)),s[1637]||(s[1637]=i("p",null,"存在的问题：",-1)),s[1638]||(s[1638]=i("ul",null,[i("li",null,"string结构底层没有太多内存优化，内存占用较多")],-1)),s[1639]||(s[1639]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521143458010.png",alt:"image-20220521143458010",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1640]||(s[1640]=i("ul",null,[i("li",null,"想要批量获取这些数据比较麻烦")],-1)),s[1641]||(s[1641]=i("h6",{id:"方案二",tabindex:"-1"},[l("方案二 "),i("a",{class:"header-anchor",href:"#方案二","aria-label":'Permalink to "方案二"'},"​")],-1)),s[1642]||(s[1642]=i("p",null,[l("拆分为小的hash，将 "),i("code",null,"id / 100"),l(" 作为key， 将"),i("code",null,"id % 100"),l(" 作为field，这样每100个元素为一个Hash")],-1)),s[1643]||(s[1643]=i("table",null,[i("tbody",null,[i("tr",{style:{color:"red"}},[i("td",null,"key"),i("td",null,"field"),i("td",null,"value")]),i("tr",null,[i("td",{rowspan:"3"},"key:0"),i("td",null,"id:00"),i("td",null,"value0")]),i("tr",null,[i("td",null,"....."),i("td",null,".....")]),i("tr",null,[i("td",null,"id:99"),i("td",null,"value99")]),i("tr",null,[i("td",{rowspan:"3"},"key:1"),i("td",null,"id:00"),i("td",null,"value100")]),i("tr",null,[i("td",null,"....."),i("td",null,".....")]),i("tr",null,[i("td",null,"id:99"),i("td",null,"value199")]),i("tr",null,[i("td",{colspan:"3"},"....")]),i("tr",null,[i("td",{rowspan:"3"},"key:9999"),i("td",null,"id:00"),i("td",null,"value999900")]),i("tr",null,[i("td",null,"....."),i("td",null,".....")]),i("tr",null,[i("td",null,"id:99"),i("td",null,"value999999")])])],-1)),s[1644]||(s[1644]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521144339377.png",alt:"image-20220521144339377",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1645]||(s[1645]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.test;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.jedis.util.JedisConnectionFactory;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.jupiter.api.AfterEach;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.jupiter.api.BeforeEach;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.jupiter.api.Test;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis.clients.jedis.Jedis;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis.clients.jedis.Pipeline;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis.clients.jedis.ScanResult;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.HashMap;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.List;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.Map;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JedisTest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Jedis jedis;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"BeforeEach")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setUp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.建立连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'        // jedis = new Jedis("192.168.150.101", 6379);')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JedisConnectionFactory."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getJedis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.设置密码")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"auth"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.选择库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"select"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSetBigKey"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 650"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"hello_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"world!"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hmset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"m2"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", map);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testBigHash"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"key_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"value_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hmset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"test:big:hash"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", map);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testBigString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"test:str:key_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"value_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSmallHash"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hashSize "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(hashSize);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," k "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hashSize;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," v "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"%"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hashSize;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"key_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," v, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"value_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," v);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (v "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hmset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"test:small:hash_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," k, map);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"AfterEach")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tearDown"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (jedis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1646]||(s[1646]=i("h4",{id:"_1-4-总结",tabindex:"-1"},[l("1.4 总结 "),i("a",{class:"header-anchor",href:"#_1-4-总结","aria-label":'Permalink to "1.4 总结"'},"​")],-1)),s[1647]||(s[1647]=i("ul",null,[i("li",null,[l("Key的最佳实践 "),i("ul",null,[i("li",null,[l("固定格式："),i("code",null,"[业务名]:[数据名]:[id]")]),i("li",null,"足够简短：不超过44字节"),i("li",null,"不包含特殊字符")])]),i("li",null,[l("Value的最佳实践： "),i("ul",null,[i("li",null,"合理的拆分数据，拒绝BigKey"),i("li",null,"选择合适数据结构"),i("li",null,"Hash结构的entry数量不要超过1000"),i("li",null,"设置合理的超时时间")])])],-1)),s[1648]||(s[1648]=i("hr",null,null,-1)),s[1649]||(s[1649]=i("h3",{id:"_2-批处理优化",tabindex:"-1"},[l("2. 批处理优化 "),i("a",{class:"header-anchor",href:"#_2-批处理优化","aria-label":'Permalink to "2. 批处理优化"'},"​")],-1)),s[1650]||(s[1650]=i("h4",{id:"_2-1-pipeline",tabindex:"-1"},[l("2.1 Pipeline "),i("a",{class:"header-anchor",href:"#_2-1-pipeline","aria-label":'Permalink to "2.1 Pipeline"'},"​")],-1)),s[1651]||(s[1651]=i("h5",{id:"_2-1-1-我们的客户端与-redis-服务器是这样交互的",tabindex:"-1"},[l("2.1.1 我们的客户端与 redis 服务器是这样交互的 "),i("a",{class:"header-anchor",href:"#_2-1-1-我们的客户端与-redis-服务器是这样交互的","aria-label":'Permalink to "2.1.1 我们的客户端与 redis 服务器是这样交互的"'},"​")],-1)),s[1652]||(s[1652]=i("p",null,"单个命令的执行流程",-1)),s[1653]||(s[1653]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521151459880.png",alt:"image-20220521151459880",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1654]||(s[1654]=i("p",null,"N条命令的执行流程",-1)),s[1655]||(s[1655]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521151524621.png",alt:"image-20220521151524621",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1656]||(s[1656]=i("p",null,"redis处理指令是很快的，主要花费的时候在于网络传输。于是乎很容易想到将多条指令批量的传输给redis",-1)),s[1657]||(s[1657]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20220521151902080.png",alt:"image-20220521151902080",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1658]||(s[1658]=i("h5",{id:"_2-1-2-mset",tabindex:"-1"},[l("2.1.2 MSet "),i("a",{class:"header-anchor",href:"#_2-1-2-mset","aria-label":'Permalink to "2.1.2 MSet"'},"​")],-1)),s[1659]||(s[1659]=i("p",null,"Redis提供了很多Mxxx这样的命令，可以实现批量插入数据，例如：",-1)),s[1660]||(s[1660]=i("ul",null,[i("li",null,"mset"),i("li",null,"hmset")],-1)),s[1661]||(s[1661]=i("p",null,"利用mset批量插入10万条数据",-1)),s[1662]||(s[1662]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testMxx"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] arr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"];")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," j;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," b "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        j "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"%"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<<"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        arr[j] "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "test:key_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        arr[j "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"] "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "value_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (j "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"time: "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," b));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1663]||(s[1663]=i("h5",{id:"_2-1-3、pipeline",tabindex:"-1"},[l("2.1.3、Pipeline "),i("a",{class:"header-anchor",href:"#_2-1-3、pipeline","aria-label":'Permalink to "2.1.3、Pipeline"'},"​")],-1)),s[1664]||(s[1664]=i("p",null,"MSET虽然可以批处理，但是却只能操作部分数据类型，因此如果有对复杂数据类型的批处理需要，建议使用Pipeline",-1)),s[1665]||(s[1665]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testPipeline"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建管道")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Pipeline pipeline "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," jedis."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"pipelined"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," b "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入命令到管道")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        pipeline."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"test:key_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"value_"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"%"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1000"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," =="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 每放入1000条命令，批量执行")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            pipeline."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sync"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"time: "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," b));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1666]||(s[1666]=i("h4",{id:"_2-2-集群下的批处理",tabindex:"-1"},[l("2.2 集群下的批处理 "),i("a",{class:"header-anchor",href:"#_2-2-集群下的批处理","aria-label":'Permalink to "2.2 集群下的批处理"'},"​")],-1)),s[1667]||(s[1667]=i("p",null,"如MSET或Pipeline这样的批处理需要在一次请求中携带多条命令，而此时如果Redis是一个集群，那批处理命令的多个key必须落在一个插槽中，否则就会导致执行失败。大家可以想一想这样的要求其实很难实现，因为我们在批处理时，可能一次要插入很多条数据，这些数据很有可能不会都落在相同的节点上，这就会导致报错了",-1)),s[1668]||(s[1668]=i("p",null,"这个时候，我们可以找到4种解决方案",-1)),s[1669]||(s[1669]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653126446641.png",alt:"1653126446641",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1670]||(s[1670]=i("p",null,"第一种方案：串行执行，所以这种方式没有什么意义，当然，执行起来就很简单了，缺点就是耗时过久。",-1)),s[1671]||(s[1671]=i("p",null,"第二种方案：串行slot，简单来说，就是执行前，客户端先计算一下对应的key的slot，一样slot的key就放到一个组里边，不同的，就放到不同的组里边，然后对每个组执行pipeline的批处理，他就能串行执行各个组的命令，这种做法比第一种方法耗时要少，但是缺点呢，相对来说复杂一点，所以这种方案还需要优化一下",-1)),s[1672]||(s[1672]=i("p",null,"第三种方案：并行slot，相较于第二种方案，在分组完成后串行执行，第三种方案，就变成了并行执行各个命令，所以他的耗时就非常短，但是实现呢，也更加复杂。",-1)),s[1673]||(s[1673]=i("p",null,"第四种：hash_tag，redis计算key的slot的时候，其实是根据key的有效部分来计算的，通过这种方式就能一次处理所有的key，这种方式耗时最短，实现也简单，但是如果通过操作key的有效部分，那么就会导致所有的key都落在一个节点上，产生数据倾斜的问题，所以我们推荐使用第三种方式。",-1)),s[1674]||(s[1674]=i("h5",{id:"_2-2-1-串行化执行代码实践",tabindex:"-1"},[l("2.2.1 串行化执行代码实践 "),i("a",{class:"header-anchor",href:"#_2-2-1-串行化执行代码实践","aria-label":'Permalink to "2.2.1 串行化执行代码实践"'},"​")],-1)),s[1675]||(s[1675]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JedisClusterTest"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JedisCluster jedisCluster;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"BeforeEach")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setUp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 配置连接池")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        JedisPoolConfig poolConfig "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JedisPoolConfig"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMaxTotal"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMaxIdle"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMinIdle"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        poolConfig."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMaxWaitMillis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        HashSet<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"HostAndPort"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> nodes "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashSet<>();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        nodes."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HostAndPort"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"7001"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        nodes."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HostAndPort"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"7002"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        nodes."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HostAndPort"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"7003"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        nodes."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HostAndPort"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8001"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        nodes."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HostAndPort"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8002"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        nodes."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HostAndPort"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8003"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedisCluster "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," JedisCluster"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(nodes, poolConfig);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testMSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        jedisCluster."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Jack"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"age"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"21"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"sex"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"male"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testMSet2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Jack"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"age"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"21"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"sex"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Male"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //对Map数据进行分组。根据相同的slot放在一个分组")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //key就是slot，value就是一个组")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Integer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Map"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Entry"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">>> result "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entrySet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"groupingBy"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        entry "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ClusterSlotHashUtil."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"calculateSlot"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entry."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()))")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                );")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //串行的去执行mset的逻辑")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Map"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Entry"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> list "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"values"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] arr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"];")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," j "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(); i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                j "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<<"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Map.Entry<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> e "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                arr[j] "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                arr[j "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"] "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            jedisCluster."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"AfterEach")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tearDown"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (jedisCluster "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            jedisCluster."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1676]||(s[1676]=i("p",null,"2.2.2 Spring集群环境下批处理代码",-1)),s[1677]||(s[1677]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"   @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testMSetInCluster"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Rose"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"age"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"21"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"sex"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Female"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"multiSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> strings "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stringRedisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"multiGet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Arrays."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"asList"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"age"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"sex"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        strings."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"forEach"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(System.out"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"println);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1678]||(s[1678]=i("p",null,[i("strong",null,"原理分析")],-1)),s[1679]||(s[1679]=i("p",null,"在RedisAdvancedClusterAsyncCommandsImpl 类中",-1)),s[1680]||(s[1680]=i("p",null,"首先根据slotHash算出来一个partitioned的map，map中的key就是slot，而他的value就是对应的对应相同slot的key对应的数据",-1)),s[1681]||(s[1681]=i("p",null,[l("通过 "),i("code",null,"RedisFuture<String> mset = super.mset(op);"),l("进行异步的消息发送")],-1)),s[1682]||(s[1682]=i("div",{class:"language-Java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"Java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisFuture"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"String"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," mset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Map"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"K, V"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," map) {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Integer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"K"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> partitioned "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SlotHash."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"partition"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(codec, map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"keySet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (partitioned."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," super"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Integer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", RedisFuture<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> executions "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Map.Entry<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Integer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"K"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> entry "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," partitioned."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entrySet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"K"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"V"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> op "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        entry."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"forEach"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(k "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," op."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(k, map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(k)));")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RedisFuture<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> mset "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," super"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(op);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        executions."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entry."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), mset);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MultiNodeExecution."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"firstOfAsync"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(executions);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1683]||(s[1683]=i("hr",null,null,-1)),s[1684]||(s[1684]=i("h3",{id:"_3-服务器端优化-持久化配置",tabindex:"-1"},[l("3. 服务器端优化 - 持久化配置 "),i("a",{class:"header-anchor",href:"#_3-服务器端优化-持久化配置","aria-label":'Permalink to "3. 服务器端优化 - 持久化配置"'},"​")],-1)),s[1685]||(s[1685]=i("p",null,"Redis的持久化虽然可以保证数据安全，但也会带来很多额外的开销，因此持久化请遵循下列建议：",-1)),s[1686]||(s[1686]=i("ul",null,[i("li",null,"用来做缓存的Redis实例尽量不要开启持久化功能"),i("li",null,"建议关闭RDB持久化功能，使用AOF持久化"),i("li",null,"利用脚本定期在slave节点做RDB，实现数据备份"),i("li",null,"设置合理的rewrite阈值，避免频繁的bgrewrite"),i("li",null,[l("配置"),i("code",null,"no-appendfsync-on-rewrite = yes"),l("，禁止在rewrite期间做aof，避免因AOF引起的阻塞")]),i("li",null,[l("部署有关建议： "),i("ul",null,[i("li",null,"Redis实例的物理机要预留足够内存，应对fork和rewrite"),i("li",null,"单个Redis实例内存上限不要太大，例如4G或8G。可以加快fork的速度、减少主从同步、数据迁移压力"),i("li",null,"不要与CPU密集型应用部署在一起"),i("li",null,"不要与高硬盘负载应用一起部署。例如：数据库、消息队列")])])],-1)),s[1687]||(s[1687]=i("hr",null,null,-1)),s[1688]||(s[1688]=i("h3",{id:"_4-服务器端优化-慢查询优化",tabindex:"-1"},[l("4. 服务器端优化 - 慢查询优化 "),i("a",{class:"header-anchor",href:"#_4-服务器端优化-慢查询优化","aria-label":'Permalink to "4. 服务器端优化 - 慢查询优化"'},"​")],-1)),s[1689]||(s[1689]=i("h4",{id:"_4-1-什么是慢查询",tabindex:"-1"},[l("4.1 什么是慢查询 "),i("a",{class:"header-anchor",href:"#_4-1-什么是慢查询","aria-label":'Permalink to "4.1 什么是慢查询"'},"​")],-1)),s[1690]||(s[1690]=i("p",null,"并不是很慢的查询才是慢查询，而是：在Redis执行时耗时超过某个阈值的命令，称为慢查询。",-1)),s[1691]||(s[1691]=i("p",null,"慢查询的危害：由于Redis是单线程的，所以当客户端发出指令后，他们都会进入到redis底层的queue来执行，如果此时有一些慢查询的数据，就会导致大量请求阻塞，从而引起报错，所以我们需要解决慢查询问题。",-1)),s[1692]||(s[1692]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653129590210.png",alt:"1653129590210",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1693]||(s[1693]=i("p",null,"慢查询的阈值可以通过配置指定：",-1)),s[1694]||(s[1694]=i("p",null,[i("code",null,"slowlog-log-slower-than"),l("：慢查询阈值，单位是微秒。默认是10000，建议1000")],-1)),s[1695]||(s[1695]=i("p",null,"慢查询会被放入慢查询日志中，日志的长度有上限，可以通过配置指定：",-1)),s[1696]||(s[1696]=i("p",null,[i("code",null,"slowlog-max-len"),l("：慢查询日志（本质是一个队列）的长度。默认是128，建议1000")],-1)),s[1697]||(s[1697]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653130457771.png",alt:"1653130457771",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1698]||(s[1698]=i("p",null,"修改这两个配置可以使用：config set命令：",-1)),s[1699]||(s[1699]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653130475979.png",alt:"1653130475979",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1700]||(s[1700]=i("h4",{id:"_4-2-如何查看慢查询",tabindex:"-1"},[l("4.2 如何查看慢查询 "),i("a",{class:"header-anchor",href:"#_4-2-如何查看慢查询","aria-label":'Permalink to "4.2 如何查看慢查询"'},"​")],-1)),s[1701]||(s[1701]=i("p",null,"知道了以上内容之后，那么咱们如何去查看慢查询日志列表呢：",-1)),s[1702]||(s[1702]=i("ul",null,[i("li",null,"slowlog len：查询慢查询日志长度"),i("li",null,[i("code",null,"slowlog get [n]"),l("：读取n条慢查询日志")]),i("li",null,"slowlog reset：清空慢查询列表")],-1)),s[1703]||(s[1703]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653130858066.png",alt:"1653130858066",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1704]||(s[1704]=i("hr",null,null,-1)),s[1705]||(s[1705]=i("h3",{id:"_5-服务器端优化-命令及安全配置",tabindex:"-1"},[l("5. 服务器端优化 - 命令及安全配置 "),i("a",{class:"header-anchor",href:"#_5-服务器端优化-命令及安全配置","aria-label":'Permalink to "5. 服务器端优化 - 命令及安全配置"'},"​")],-1)),s[1706]||(s[1706]=i("p",null,"安全可以说是服务器端一个非常重要的话题，如果安全出现了问题，那么一旦这个漏洞被一些坏人知道了之后，并且进行攻击，那么这就会给咱们的系统带来很多的损失，所以我们这节课就来解决这个问题。",-1)),s[1707]||(s[1707]=i("p",null,[l("Redis会绑定在"),i("code",null,"0.0.0.0:6379"),l("，这样将会将Redis服务暴露到公网上，而Redis如果没有做身份认证，会出现严重的安全漏洞. 漏洞重现方式："),i("a",{href:"https://cloud.tencent.com/developer/article/1039000",target:"_blank",rel:"noreferrer"},"https://cloud.tencent.com/developer/article/1039000")],-1)),s[1708]||(s[1708]=i("p",null,"为什么会出现不需要密码也能够登录呢，主要是Redis考虑到每次登录都比较麻烦，所以Redis就有一种ssh免秘钥登录的方式，生成一对公钥和私钥，私钥放在本地，公钥放在redis端，当我们登录时服务器，再登录时候，他会去解析公钥和私钥，如果没有问题，则不需要利用redis的登录也能访问，这种做法本身也很常见，但是这里有一个前提，前提就是公钥必须保存在服务器上，才行，但是Redis的漏洞在于在不登录的情况下，也能把秘钥送到Linux服务器，从而产生漏洞",-1)),s[1709]||(s[1709]=i("p",null,"漏洞出现的核心的原因有以下几点：",-1)),s[1710]||(s[1710]=i("ul",null,[i("li",null,"Redis未设置密码"),i("li",null,"利用了Redis的config set命令动态修改Redis配置"),i("li",null,"使用了Root账号权限启动Redis")],-1)),s[1711]||(s[1711]=i("p",null,"所以：如何解决呢？我们可以采用如下几种方案",-1)),s[1712]||(s[1712]=i("p",null,"为了避免这样的漏洞，这里给出一些建议：",-1)),s[1713]||(s[1713]=i("ul",null,[i("li",null,"Redis一定要设置密码"),i("li",null,"禁止线上使用下面命令：keys、flushall、flushdb、config set等命令。可以利用rename-command禁用。"),i("li",null,"bind：限制网卡，禁止外网网卡访问"),i("li",null,"开启防火墙"),i("li",null,"不要使用Root账户启动Redis"),i("li",null,"尽量不是有默认的端口")],-1)),s[1714]||(s[1714]=i("hr",null,null,-1)),s[1715]||(s[1715]=i("h3",{id:"_6-服务器端优化-redis-内存划分和内存配置",tabindex:"-1"},[l("6. 服务器端优化 - Redis 内存划分和内存配置 "),i("a",{class:"header-anchor",href:"#_6-服务器端优化-redis-内存划分和内存配置","aria-label":'Permalink to "6. 服务器端优化 - Redis 内存划分和内存配置"'},"​")],-1)),s[1716]||(s[1716]=i("p",null,"当Redis内存不足时，可能导致Key频繁被删除、响应时间变长、QPS不稳定等问题。当内存使用率达到90%以上时就需要我们警惕，并快速定位到内存占用的原因。",-1)),s[1717]||(s[1717]=i("p",null,[i("strong",null,"有关碎片问题分析")],-1)),s[1718]||(s[1718]=i("p",null,"Redis底层分配并不是这个key有多大，他就会分配多大，而是有他自己的分配策略，比如8,16,20等等，假定当前key只需要10个字节，此时分配8肯定不够，那么他就会分配16个字节，多出来的6个字节就不能被使用，这就是我们常说的 碎片问题",-1)),s[1719]||(s[1719]=i("p",null,[i("strong",null,"进程内存问题分析：")],-1)),s[1720]||(s[1720]=i("p",null,"这片内存，通常我们都可以忽略不计",-1)),s[1721]||(s[1721]=i("p",null,[i("strong",null,"缓冲区内存问题分析：")],-1)),s[1722]||(s[1722]=i("p",null,"一般包括客户端缓冲区、AOF缓冲区、复制缓冲区等。客户端缓冲区又包括输入缓冲区和输出缓冲区两种。这部分内存占用波动较大，所以这片内存也是我们需要重点分析的内存问题。",-1)),s[1723]||(s[1723]=i("table",null,[i("thead",null,[i("tr",null,[i("th",null,[i("strong",null,"内存占用")]),i("th",null,[i("strong",null,"说明")])])]),i("tbody",null,[i("tr",null,[i("td",null,"数据内存"),i("td",null,"是Redis最主要的部分，存储Redis的键值信息。主要问题是BigKey问题、内存碎片问题")]),i("tr",null,[i("td",null,"进程内存"),i("td",null,"Redis主进程本身运⾏肯定需要占⽤内存，如代码、常量池等等；这部分内存⼤约⼏兆，在⼤多数⽣产环境中与Redis数据占⽤的内存相⽐可以忽略。")]),i("tr",null,[i("td",null,"缓冲区内存"),i("td",null,"一般包括客户端缓冲区、AOF缓冲区、复制缓冲区等。客户端缓冲区又包括输入缓冲区和输出缓冲区两种。这部分内存占用波动较大，不当使用BigKey，可能导致内存溢出。")])])],-1)),s[1724]||(s[1724]=i("p",null,"于是我们就需要通过一些命令，可以查看到Redis目前的内存分配状态：",-1)),s[1725]||(s[1725]=i("ul",null,[i("li",null,"info memory：查看内存分配的情况")],-1)),s[1726]||(s[1726]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653132073570.png",alt:"1653132073570",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1727]||(s[1727]=i("ul",null,[i("li",null,"memory xxx：查看key的主要占用情况")],-1)),s[1728]||(s[1728]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653132098823.png",alt:"1653132098823",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1729]||(s[1729]=i("p",null,"接下来我们看到了这些配置，最关键的缓存区内存如何定位和解决呢？",-1)),s[1730]||(s[1730]=i("p",null,"内存缓冲区常见的有三种：",-1)),s[1731]||(s[1731]=i("ul",null,[i("li",null,[l("复制缓冲区：主从复制的repl_backlog_buf，如果太小可能导致频繁的全量复制，影响性能。通过"),i("code",null,"replbacklog-size"),l("来设置，默认1mb")]),i("li",null,"AOF缓冲区：AOF刷盘之前的缓存区域，AOF执行rewrite的缓冲区。无法设置容量上限"),i("li",null,"客户端缓冲区：分为输入缓冲区和输出缓冲区，输入缓冲区最大1G且不能设置。输出缓冲区可以设置")],-1)),s[1732]||(s[1732]=i("p",null,"以上复制缓冲区和AOF缓冲区 不会有问题，最关键就是客户端缓冲区的问题",-1)),s[1733]||(s[1733]=i("p",null,"客户端缓冲区：指的就是我们发送命令时，客户端用来缓存命令的一个缓冲区，也就是我们向redis输入数据的输入端缓冲区和redis向客户端返回数据的响应缓存区，输入缓冲区最大1G且不能设置，所以这一块我们根本不用担心，如果超过了这个空间，redis会直接断开，因为本来此时此刻就代表着redis处理不过来了，我们需要担心的就是输出端缓冲区",-1)),s[1734]||(s[1734]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653132410073.png",alt:"1653132410073",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1735]||(s[1735]=i("p",null,"我们在使用redis过程中，处理大量的big value，那么会导致我们的输出结果过多，如果输出缓存区过大，会导致redis直接断开，而默认配置的情况下， 其实他是没有大小的，这就比较坑了，内存可能一下子被占满，会直接导致咱们的redis断开，所以解决方案有两个",-1)),s[1736]||(s[1736]=i("p",null,"1、设置一个大小",-1)),s[1737]||(s[1737]=i("p",null,"2、增加我们带宽的大小，避免我们出现大量数据从而直接超过了redis的承受能力",-1)),s[1738]||(s[1738]=i("hr",null,null,-1)),s[1739]||(s[1739]=i("h3",{id:"_7-服务器端集群优化-集群还是主从",tabindex:"-1"},[l("7. 服务器端集群优化-集群还是主从 "),i("a",{class:"header-anchor",href:"#_7-服务器端集群优化-集群还是主从","aria-label":'Permalink to "7. 服务器端集群优化-集群还是主从"'},"​")],-1)),s[1740]||(s[1740]=i("p",null,"集群虽然具备高可用特性，能实现自动故障恢复，但是如果使用不当，也会存在一些问题：",-1)),s[1741]||(s[1741]=i("ul",null,[i("li",null,"集群完整性问题"),i("li",null,"集群带宽问题"),i("li",null,"数据倾斜问题"),i("li",null,"客户端性能问题"),i("li",null,"命令的集群兼容性问题"),i("li",null,"lua和事务问题")],-1)),s[1742]||(s[1742]=i("p",null,[i("strong",null,"问题1、在Redis的默认配置中，如果发现任意一个插槽不可用，则整个集群都会停止对外服务：")],-1)),s[1743]||(s[1743]=i("p",null,"大家可以设想一下，如果有几个slot不能使用，那么此时整个集群都不能用了，我们在开发中，其实最重要的是可用性，所以需要把如下配置修改成no，即有slot不能使用时，我们的redis集群还是可以对外提供服务",-1)),s[1744]||(s[1744]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1653132740637.png",alt:"1653132740637",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1745]||(s[1745]=i("p",null,[i("strong",null,"问题2、集群带宽问题")],-1)),s[1746]||(s[1746]=i("p",null,"集群节点之间会不断的互相Ping来确定集群中其它节点的状态。每次Ping携带的信息至少包括：",-1)),s[1747]||(s[1747]=i("ul",null,[i("li",null,"插槽信息"),i("li",null,"集群状态信息")],-1)),s[1748]||(s[1748]=i("p",null,"集群中节点越多，集群状态信息数据量也越大，10个节点的相关信息可能达到1kb，此时每次集群互通需要的带宽会非常高，这样会导致集群中大量的带宽都会被ping信息所占用，这是一个非常可怕的问题，所以我们需要去解决这样的问题",-1)),s[1749]||(s[1749]=i("p",null,[i("strong",null,"解决途径：")],-1)),s[1750]||(s[1750]=i("ul",null,[i("li",null,"避免大集群，集群节点数不要太多，最好少于1000，如果业务庞大，则建立多个集群。"),i("li",null,"避免在单个物理机中运行太多Redis实例"),i("li",null,[l("配置合适的"),i("code",null,"cluster-node-timeout"),l("值")])],-1)),s[1751]||(s[1751]=i("p",null,[i("strong",null,"问题3、命令的集群兼容性问题")],-1)),s[1752]||(s[1752]=i("p",null,"有关这个问题咱们已经探讨过了，当我们使用批处理的命令时，redis要求我们的key必须落在相同的slot上，然后大量的key同时操作时，是无法完成的，所以客户端必须要对这样的数据进行处理，这些方案我们之前已经探讨过了，所以不再这个地方赘述了。",-1)),s[1753]||(s[1753]=i("p",null,[i("strong",null,"问题4、lua和事务的问题")],-1)),s[1754]||(s[1754]=i("p",null,"lua和事务都是要保证原子性问题，如果你的key不在一个节点，那么是无法保证lua的执行和事务的特性的，所以在集群模式是没有办法执行lua和事务的",-1)),s[1755]||(s[1755]=i("p",null,[i("strong",null,"那我们到底是集群还是主从")],-1)),s[1756]||(s[1756]=i("p",null,"单体Redis（主从Redis）已经能达到万级别的QPS，并且也具备很强的高可用特性。如果主从能满足业务需求的情况下，所以如果不是在万不得已的情况下，尽量不搭建Redis集群",-1)),s[1757]||(s[1757]=i("hr",null,null,-1)),s[1758]||(s[1758]=i("h2",{id:"分布式缓存",tabindex:"-1"},[l("分布式缓存 "),i("a",{class:"header-anchor",href:"#分布式缓存","aria-label":'Permalink to "分布式缓存"'},"​")],-1)),s[1759]||(s[1759]=i("ul",null,[i("li",null,"基于Redis集群解决单机Redis存在的问题"),i("li",null,"单机的Redis存在四大问题：")],-1)),s[1760]||(s[1760]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725144240631.png",alt:"image-20210725144240631",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1761]||(s[1761]=i("hr",null,null,-1)),s[1762]||(s[1762]=i("h3",{id:"_1-redis持久化",tabindex:"-1"},[l("1. Redis持久化 "),i("a",{class:"header-anchor",href:"#_1-redis持久化","aria-label":'Permalink to "1. Redis持久化"'},"​")],-1)),s[1763]||(s[1763]=i("p",null,"Redis有两种持久化方案：",-1)),s[1764]||(s[1764]=i("ul",null,[i("li",null,"RDB持久化"),i("li",null,"AOF持久化")],-1)),s[1765]||(s[1765]=i("h4",{id:"_1-1-rdb持久化",tabindex:"-1"},[l("1.1 RDB持久化 "),i("a",{class:"header-anchor",href:"#_1-1-rdb持久化","aria-label":'Permalink to "1.1 RDB持久化"'},"​")],-1)),s[1766]||(s[1766]=i("p",null,"RDB全称Redis Database Backup file（Redis数据备份文件），也被叫做Redis数据快照。简单来说就是把内存中的所有数据都记录到磁盘中。当Redis实例故障重启后，从磁盘读取快照文件，恢复数据。快照文件称为RDB文件，默认是保存在当前运行目录。",-1)),s[1767]||(s[1767]=i("h5",{id:"_1-1-1-执行时机",tabindex:"-1"},[l("1.1.1 执行时机 "),i("a",{class:"header-anchor",href:"#_1-1-1-执行时机","aria-label":'Permalink to "1.1.1 执行时机"'},"​")],-1)),s[1768]||(s[1768]=i("p",null,"RDB持久化在四种情况下会执行：",-1)),s[1769]||(s[1769]=i("ul",null,[i("li",null,"执行save命令"),i("li",null,"执行bgsave命令"),i("li",null,"Redis停机时"),i("li",null,"触发RDB条件时")],-1)),s[1770]||(s[1770]=i("p",null,[i("strong",null,"1）save命令")],-1)),s[1771]||(s[1771]=i("p",null,"执行下面的命令，可以立即执行一次RDB：",-1)),s[1772]||(s[1772]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725144536958.png",alt:"image-20210725144536958",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1773]||(s[1773]=i("p",null,"save命令会导致主进程执行RDB，这个过程中其它所有命令都会被阻塞。只有在数据迁移时可能用到。",-1)),s[1774]||(s[1774]=i("p",null,[i("strong",null,"2）bgsave命令")],-1)),s[1775]||(s[1775]=i("p",null,"下面的命令可以异步执行RDB：",-1)),s[1776]||(s[1776]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725144725943.png",alt:"image-20210725144725943",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1777]||(s[1777]=i("p",null,"这个命令执行后会开启独立进程完成RDB，主进程可以持续处理用户请求，不受影响。",-1)),s[1778]||(s[1778]=i("p",null,[i("strong",null,"3）停机时")],-1)),s[1779]||(s[1779]=i("p",null,"Redis停机时会执行一次save命令，实现RDB持久化。",-1)),s[1780]||(s[1780]=i("p",null,[i("strong",null,"4）触发RDB条件")],-1)),s[1781]||(s[1781]=i("p",null,"Redis内部有触发RDB的机制，可以在redis.conf文件中找到，格式如下：",-1)),s[1782]||(s[1782]=i("div",{class:"language-properties max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"properties"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'# 900秒内，如果至少有1个key被修改，则执行bgsave ， 如果是save "" 则表示禁用RDB')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"save 900 1  ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"save 300 10  ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"save 60 10000")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1783]||(s[1783]=i("p",null,"RDB的其它配置也可以在redis.conf文件中设置：",-1)),s[1784]||(s[1784]=i("div",{class:"language-properties max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"properties"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 是否压缩 ,建议不开启，压缩也会消耗cpu，磁盘的话不值钱")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rdbcompression yes")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# RDB文件名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dbfilename dump.rdb  ")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 文件保存的路径目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dir ./")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1785]||(s[1785]=i("h5",{id:"_1-1-2-rdb原理",tabindex:"-1"},[l("1.1.2 RDB原理 "),i("a",{class:"header-anchor",href:"#_1-1-2-rdb原理","aria-label":'Permalink to "1.1.2 RDB原理"'},"​")],-1)),s[1786]||(s[1786]=i("p",null,"bgsave开始时会fork主进程得到子进程，子进程共享主进程的内存数据。完成fork后读取内存数据并写入 RDB 文件。",-1)),s[1787]||(s[1787]=i("p",null,"fork采用的是copy-on-write技术：",-1)),s[1788]||(s[1788]=i("ul",null,[i("li",null,"当主进程执行读操作时，访问共享内存；"),i("li",null,"当主进程执行写操作时，则会拷贝一份数据，执行写操作。")],-1)),s[1789]||(s[1789]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725151319695.png",alt:"image-20210725151319695",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1790]||(s[1790]=i("h5",{id:"_1-1-3-小结",tabindex:"-1"},[l("1.1.3 小结 "),i("a",{class:"header-anchor",href:"#_1-1-3-小结","aria-label":'Permalink to "1.1.3 小结"'},"​")],-1)),s[1791]||(s[1791]=i("p",null,"RDB方式bgsave的基本流程？",-1)),s[1792]||(s[1792]=i("ul",null,[i("li",null,"fork主进程得到一个子进程，共享内存空间"),i("li",null,"子进程读取内存数据并写入新的RDB文件"),i("li",null,"用新RDB文件替换旧的RDB文件")],-1)),s[1793]||(s[1793]=i("p",null,"RDB会在什么时候执行？save 60 1000代表什么含义？",-1)),s[1794]||(s[1794]=i("ul",null,[i("li",null,"默认是服务停止时"),i("li",null,"代表60秒内至少执行1000次修改则触发RDB")],-1)),s[1795]||(s[1795]=i("p",null,"RDB的缺点？",-1)),s[1796]||(s[1796]=i("ul",null,[i("li",null,"RDB执行间隔时间长，两次RDB之间写入数据有丢失的风险"),i("li",null,"fork子进程、压缩、写出RDB文件都比较耗时")],-1)),s[1797]||(s[1797]=i("h4",{id:"_1-2-aof持久化",tabindex:"-1"},[l("1.2 AOF持久化 "),i("a",{class:"header-anchor",href:"#_1-2-aof持久化","aria-label":'Permalink to "1.2 AOF持久化"'},"​")],-1)),s[1798]||(s[1798]=i("h5",{id:"_1-2-1-aof原理",tabindex:"-1"},[l("1.2.1 AOF原理 "),i("a",{class:"header-anchor",href:"#_1-2-1-aof原理","aria-label":'Permalink to "1.2.1 AOF原理"'},"​")],-1)),s[1799]||(s[1799]=i("p",null,"AOF全称为Append Only File（追加文件）。Redis处理的每一个写命令都会记录在AOF文件，可以看做是命令日志文件。",-1)),s[1800]||(s[1800]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725151543640.png",alt:"image-20210725151543640",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1801]||(s[1801]=i("h5",{id:"_1-2-2-aof配置",tabindex:"-1"},[l("1.2.2 AOF配置 "),i("a",{class:"header-anchor",href:"#_1-2-2-aof配置","aria-label":'Permalink to "1.2.2 AOF配置"'},"​")],-1)),s[1802]||(s[1802]=i("p",null,"AOF默认是关闭的，需要修改redis.conf配置文件来开启AOF：",-1)),s[1803]||(s[1803]=i("div",{class:"language-properties max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"properties"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 是否开启AOF功能，默认是no")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"appendonly yes")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# AOF文件的名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"appendfilename "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"appendonly.aof"')])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1804]||(s[1804]=i("p",null,"AOF的命令记录的频率也可以通过redis.conf文件来配：",-1)),s[1805]||(s[1805]=i("div",{class:"language-properties max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"properties"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 表示每执行一次写命令，立即记录到AOF文件")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"appendfsync always ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 写命令执行完先放入AOF缓冲区，然后表示每隔1秒将缓冲区数据写到AOF文件，是默认方案")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"appendfsync everysec ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 写命令执行完先放入AOF缓冲区，由操作系统决定何时将缓冲区内容写回磁盘")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"appendfsync no")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1806]||(s[1806]=i("p",null,"三种策略对比：",-1)),s[1807]||(s[1807]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725151654046.png",alt:"image-20210725151654046",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1808]||(s[1808]=i("h5",{id:"_1-2-3-aof文件重写",tabindex:"-1"},[l("1.2.3 AOF文件重写 "),i("a",{class:"header-anchor",href:"#_1-2-3-aof文件重写","aria-label":'Permalink to "1.2.3 AOF文件重写"'},"​")],-1)),s[1809]||(s[1809]=i("p",null,"因为是记录命令，AOF文件会比RDB文件大的多。而且AOF会记录对同一个key的多次写操作，但只有最后一次写操作才有意义。通过执行bgrewriteaof命令，可以让AOF文件执行重写功能，用最少的命令达到相同效果。",-1)),s[1810]||(s[1810]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725151729118.png",alt:"image-20210725151729118",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1811]||(s[1811]=i("p",null,[l("如图，AOF原本有三个命令，但是"),i("code",null,"set num 123 和 set num 666"),l("都是对num的操作，第二次会覆盖第一次的值，因此第一个命令记录下来没有意义。")],-1)),s[1812]||(s[1812]=i("p",null,[l("所以重写命令后，AOF文件内容就是："),i("code",null,"mset name jack num 666")],-1)),s[1813]||(s[1813]=i("p",null,"Redis也会在触发阈值时自动去重写AOF文件。阈值也可以在redis.conf中配置：",-1)),s[1814]||(s[1814]=i("div",{class:"language-properties max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"properties"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# AOF文件比上次文件 增长超过多少百分比则触发重写")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"auto-aof-rewrite-percentage 100")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# AOF文件体积最小多大以上才触发重写 ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"auto-aof-rewrite-min-size 64mb")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1815]||(s[1815]=i("h4",{id:"_1-3-rdb与aof对比",tabindex:"-1"},[l("1.3 RDB与AOF对比 "),i("a",{class:"header-anchor",href:"#_1-3-rdb与aof对比","aria-label":'Permalink to "1.3 RDB与AOF对比"'},"​")],-1)),s[1816]||(s[1816]=i("p",null,[l("RDB和AOF各有自己的优缺点，如果对数据安全性要求较高，在实际开发中往往会"),i("strong",null,"结合"),l("两者来使用。")],-1)),s[1817]||(s[1817]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725151940515.png",alt:"image-20210725151940515",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1818]||(s[1818]=i("hr",null,null,-1)),s[1819]||(s[1819]=i("h3",{id:"_2-redis主从",tabindex:"-1"},[l("2. Redis主从 "),i("a",{class:"header-anchor",href:"#_2-redis主从","aria-label":'Permalink to "2. Redis主从"'},"​")],-1)),s[1820]||(s[1820]=i("h4",{id:"_2-1-搭建主从架构",tabindex:"-1"},[l("2.1 搭建主从架构 "),i("a",{class:"header-anchor",href:"#_2-1-搭建主从架构","aria-label":'Permalink to "2.1 搭建主从架构"'},"​")],-1)),s[1821]||(s[1821]=i("h5",{id:"_2-1-1-集群结构",tabindex:"-1"},[l("2.1.1 集群结构 "),i("a",{class:"header-anchor",href:"#_2-1-1-集群结构","aria-label":'Permalink to "2.1.1 集群结构"'},"​")],-1)),s[1822]||(s[1822]=i("p",null,"单节点Redis的并发能力是有上限的，要进一步提高Redis的并发能力，就需要搭建主从集群，实现读写分离。",-1)),s[1823]||(s[1823]=i("p",null,"我们搭建的主从集群结构如图：",-1)),s[1824]||(s[1824]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725152037611.png",alt:"image-20210725152037611",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1825]||(s[1825]=i("p",null,"共包含三个节点，一个主节点，两个从节点。",-1)),s[1826]||(s[1826]=i("p",null,"这里我们会在同一台虚拟机中开启3个redis实例，模拟主从集群，信息如下：",-1)),s[1827]||(s[1827]=i("table",null,[i("thead",null,[i("tr",null,[i("th",{style:{"text-align":"center"}},"IP"),i("th",{style:{"text-align":"center"}},"PORT"),i("th",{style:{"text-align":"center"}},"角色")])]),i("tbody",null,[i("tr",null,[i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"7001"),i("td",{style:{"text-align":"center"}},"master")]),i("tr",null,[i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"7002"),i("td",{style:{"text-align":"center"}},"slave")]),i("tr",null,[i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"7003"),i("td",{style:{"text-align":"center"}},"slave")])])],-1)),s[1828]||(s[1828]=i("h5",{id:"_2-1-2-准备实例和配置",tabindex:"-1"},[l("2.1.2 准备实例和配置 "),i("a",{class:"header-anchor",href:"#_2-1-2-准备实例和配置","aria-label":'Permalink to "2.1.2 准备实例和配置"'},"​")],-1)),s[1829]||(s[1829]=i("p",null,"要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。",-1)),s[1830]||(s[1830]=i("p",null,"1）创建目录",-1)),s[1831]||(s[1831]=i("p",null,"我们创建三个文件夹，名字分别叫7001、7002、7003：",-1)),s[1832]||(s[1832]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 进入/tmp目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mkdir"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1833]||(s[1833]=i("p",null,"如图：",-1)),s[1834]||(s[1834]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210630113929868.png",alt:"image-20210630113929868",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1835]||(s[1835]=i("p",null,"2）恢复原始配置",-1)),s[1836]||(s[1836]=i("p",null,"修改redis-6.2.4/redis.conf文件，将其中的持久化模式改为默认的RDB模式，AOF保持关闭状态。",-1)),s[1837]||(s[1837]=i("div",{class:"language-properties max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"properties"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 开启RDB")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'# save ""')]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"save 3600 1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"save 300 100")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"save 60 10000")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 关闭AOF")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"appendonly no")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1838]||(s[1838]=i("p",null,"3）拷贝配置文件到每个实例目录",-1)),s[1839]||(s[1839]=i("p",null,"然后将redis-6.2.4/redis.conf文件拷贝到三个目录中（在/tmp目录执行下列命令）：",-1)),s[1840]||(s[1840]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 方式一：逐个拷贝")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis-6.2.4/redis.conf"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis-6.2.4/redis.conf"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis-6.2.4/redis.conf"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 方式二：管道组合命令，一键拷贝")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"echo"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -n"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis-6.2.4/redis.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1841]||(s[1841]=i("p",null,"4）修改每个实例的端口、工作目录",-1)),s[1842]||(s[1842]=i("p",null,"修改每个文件夹内的配置文件，将端口分别修改为7001、7002、7003，将rdb文件保存位置都修改为自己所在目录（在/tmp目录执行下列命令）：",-1)),s[1843]||(s[1843]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sed"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 's/6379/7001/g'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 's/dir .\\//dir \\/tmp\\/7001\\//g'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 7001/redis.conf")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sed"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 's/6379/7002/g'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 's/dir .\\//dir \\/tmp\\/7002\\//g'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 7002/redis.conf")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sed"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 's/6379/7003/g'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 's/dir .\\//dir \\/tmp\\/7003\\//g'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 7003/redis.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1844]||(s[1844]=i("p",null,"5）修改每个实例的声明IP",-1)),s[1845]||(s[1845]=i("p",null,"虚拟机本身有多个IP，为了避免将来混乱，我们需要在redis.conf文件中指定每一个实例的绑定ip信息，格式如下：",-1)),s[1846]||(s[1846]=i("div",{class:"language-properties max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"properties"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# redis实例的声明 IP")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"replica-announce-ip 192.168.150.101")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1847]||(s[1847]=i("p",null,"每个目录都要改，我们一键完成修改（在/tmp目录执行下列命令）：",-1)),s[1848]||(s[1848]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 逐一执行")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sed"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '1a replica-announce-ip 192.168.150.101'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 7001/redis.conf")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sed"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '1a replica-announce-ip 192.168.150.101'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 7002/redis.conf")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sed"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '1a replica-announce-ip 192.168.150.101'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 7003/redis.conf")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 或者一键修改")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"printf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '%s\\n'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -I"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{} -t sed -i '1a replica-announce-ip 192.168.150.101' {}/redis.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1849]||(s[1849]=i("h5",{id:"_2-1-3-启动",tabindex:"-1"},[l("2.1.3 启动 "),i("a",{class:"header-anchor",href:"#_2-1-3-启动","aria-label":'Permalink to "2.1.3 启动"'},"​")],-1)),s[1850]||(s[1850]=i("p",null,"为了方便查看日志，我们打开3个ssh窗口，分别启动3个redis实例，启动命令：",-1)),s[1851]||(s[1851]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 第1个")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-server"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 7001/redis.conf")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 第2个")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-server"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 7002/redis.conf")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 第3个")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-server"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 7003/redis.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1852]||(s[1852]=i("p",null,"启动后：",-1)),s[1853]||(s[1853]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210630183914491.png",alt:"image-20210630183914491",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1854]||(s[1854]=i("p",null,"如果要一键停止，可以运行下面命令：",-1)),s[1855]||(s[1855]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"printf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '%s\\n'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -I"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{} -t redis-cli -p {} shutdown")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1856]||(s[1856]=i("h5",{id:"_2-1-4-开启主从关系",tabindex:"-1"},[l("2.1.4 开启主从关系 "),i("a",{class:"header-anchor",href:"#_2-1-4-开启主从关系","aria-label":'Permalink to "2.1.4 开启主从关系"'},"​")],-1)),s[1857]||(s[1857]=i("p",null,"现在三个实例还没有任何关系，要配置主从可以使用replicaof 或者slaveof（5.0以前）命令。",-1)),s[1858]||(s[1858]=i("p",null,"有临时和永久两种模式：",-1)),s[1859]||(s[1859]=i("ul",null,[i("li",null,[i("p",null,"修改配置文件（永久生效）"),i("ul",null,[i("li",null,[l("在redis.conf中添加一行配置："),i("code",null,"slaveof <masterip> <masterport>")])])]),i("li",null,[i("p",null,"使用redis-cli客户端连接到redis服务，执行slaveof命令（重启后失效）："),i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"slaveof"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," <"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"masteri"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"p"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," <"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"masterpor"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"t"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">")])])]),i("button",{class:"code-block-unfold-btn"})])])],-1)),i("p",null,[i("strong",null,[B(o,{color:"red"},{default:k(()=>[...s[0]||(s[0]=[l("注意",-1)])]),_:1})]),s[1]||(s[1]=l("：在5.0以后新增命令replicaof，与salveof效果一致。",-1))]),s[1860]||(s[1860]=i("p",null,"这里我们为了演示方便，使用方式二。",-1)),s[1861]||(s[1861]=i("p",null,"通过redis-cli命令连接7002，执行下面命令：",-1)),s[1862]||(s[1862]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 连接 7002")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 执行slaveof")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"slaveof"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 192.168.150.101"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1863]||(s[1863]=i("p",null,"通过redis-cli命令连接7003，执行下面命令：",-1)),s[1864]||(s[1864]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 连接 7003")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 执行slaveof")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"slaveof"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 192.168.150.101"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1865]||(s[1865]=i("p",null,"然后连接 7001节点，查看集群状态：",-1)),s[1866]||(s[1866]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 连接 7001")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 查看状态")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," replication")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1867]||(s[1867]=i("p",null,"结果：",-1)),s[1868]||(s[1868]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210630201258802.png",alt:"image-20210630201258802",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1869]||(s[1869]=i("h5",{id:"_2-1-5-测试",tabindex:"-1"},[l("2.1.5 测试 "),i("a",{class:"header-anchor",href:"#_2-1-5-测试","aria-label":'Permalink to "2.1.5 测试"'},"​")],-1)),s[1870]||(s[1870]=i("p",null,"执行下列操作以测试：",-1)),s[1871]||(s[1871]=i("ul",null,[i("li",null,[i("p",null,[l("利用redis-cli连接7001，执行"),i("code",null,"set num 123")])]),i("li",null,[i("p",null,[l("利用redis-cli连接7002，执行"),i("code",null,"get num"),l("，再执行"),i("code",null,"set num 666")])]),i("li",null,[i("p",null,[l("利用redis-cli连接7003，执行"),i("code",null,"get num"),l("，再执行"),i("code",null,"set num 888")])])],-1)),s[1872]||(s[1872]=i("p",null,"可以发现，只有在7001这个master节点上可以执行写操作，7002和7003这两个slave节点只能执行读操作。",-1)),s[1873]||(s[1873]=i("h4",{id:"_2-2-主从数据同步原理",tabindex:"-1"},[l("2.2 主从数据同步原理 "),i("a",{class:"header-anchor",href:"#_2-2-主从数据同步原理","aria-label":'Permalink to "2.2 主从数据同步原理"'},"​")],-1)),s[1874]||(s[1874]=i("h5",{id:"_2-2-1-全量同步",tabindex:"-1"},[l("2.2.1 全量同步 "),i("a",{class:"header-anchor",href:"#_2-2-1-全量同步","aria-label":'Permalink to "2.2.1 全量同步"'},"​")],-1)),s[1875]||(s[1875]=i("p",null,[l("主从第一次建立连接时，会执行"),i("strong",null,"全量同步"),l("，将master节点的所有数据都拷贝给slave节点，流程：")],-1)),s[1876]||(s[1876]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725152222497.png",alt:"image-20210725152222497",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1877]||(s[1877]=i("p",null,"这里有一个问题，master如何得知salve是第一次来连接呢？？",-1)),s[1878]||(s[1878]=i("p",null,"有几个概念，可以作为判断依据：",-1)),s[1879]||(s[1879]=i("ul",null,[i("li",null,[i("strong",null,"Replication Id"),l("：简称replid，是数据集的标记，id一致则说明是同一数据集。每一个master都有唯一的replid，slave则会继承master节点的replid")]),i("li",null,[i("strong",null,"offset"),l("：偏移量，随着记录在repl_baklog中的数据增多而逐渐增大。slave完成同步时也会记录当前同步的offset。如果slave的offset小于master的offset，说明slave数据落后于master，需要更新。")])],-1)),s[1880]||(s[1880]=i("p",null,"因此slave做数据同步，必须向master声明自己的replication id 和offset，master才可以判断到底需要同步哪些数据。",-1)),s[1881]||(s[1881]=i("p",null,"因为slave原本也是一个master，有自己的replid和offset，当第一次变成slave，与master建立连接时，发送的replid和offset是自己的replid和offset。",-1)),s[1882]||(s[1882]=i("p",null,"master判断发现slave发送来的replid与自己的不一致，说明这是一个全新的slave，就知道要做全量同步了。",-1)),s[1883]||(s[1883]=i("p",null,"master会将自己的replid和offset都发送给这个slave，slave保存这些信息。以后slave的replid就与master一致了。",-1)),s[1884]||(s[1884]=i("p",null,[l("因此，"),i("strong",null,"master判断一个节点是否是第一次同步的依据，就是看replid是否一致"),l("。")],-1)),s[1885]||(s[1885]=i("p",null,"如图：",-1)),s[1886]||(s[1886]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725152700914.png",alt:"image-20210725152700914",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1887]||(s[1887]=i("p",null,"完整流程描述：",-1)),s[1888]||(s[1888]=i("ul",null,[i("li",null,"slave节点请求增量同步"),i("li",null,"master节点判断replid，发现不一致，拒绝增量同步"),i("li",null,"master将完整内存数据生成RDB，发送RDB到slave"),i("li",null,"slave清空本地数据，加载master的RDB"),i("li",null,"master将RDB期间的命令记录在repl_baklog，并持续将log中的命令发送给slave"),i("li",null,"slave执行接收到的命令，保持与master之间的同步")],-1)),s[1889]||(s[1889]=i("h5",{id:"_2-2-2-增量同步",tabindex:"-1"},[l("2.2.2 增量同步 "),i("a",{class:"header-anchor",href:"#_2-2-2-增量同步","aria-label":'Permalink to "2.2.2 增量同步"'},"​")],-1)),s[1890]||(s[1890]=i("p",null,[l("全量同步需要先做RDB，然后将RDB文件通过网络传输个slave，成本太高了。因此除了第一次做全量同步，其它大多数时候slave与master都是做"),i("strong",null,"增量同步"),l("。")],-1)),s[1891]||(s[1891]=i("p",null,"什么是增量同步？就是只更新slave与master存在差异的部分数据。如图：",-1)),s[1892]||(s[1892]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725153201086.png",alt:"image-20210725153201086",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1893]||(s[1893]=i("p",null,"那么master怎么知道slave与自己的数据差异在哪里呢?",-1)),s[1894]||(s[1894]=i("h5",{id:"_2-2-3-repl-backlog原理",tabindex:"-1"},[l("2.2.3 repl_backlog原理 "),i("a",{class:"header-anchor",href:"#_2-2-3-repl-backlog原理","aria-label":'Permalink to "2.2.3 repl_backlog原理"'},"​")],-1)),s[1895]||(s[1895]=i("p",null,"master怎么知道slave与自己的数据差异在哪里呢?",-1)),s[1896]||(s[1896]=i("p",null,"这就要说到全量同步时的repl_baklog文件了。",-1)),s[1897]||(s[1897]=i("p",null,[l("这个文件是一个固定大小的数组，只不过数组是环形，也就是说"),i("strong",null,"角标到达数组末尾后，会再次从0开始读写"),l("，这样数组头部的数据就会被覆盖。")],-1)),s[1898]||(s[1898]=i("p",null,"repl_baklog中会记录Redis处理过的命令日志及offset，包括master当前的offset，和slave已经拷贝到的offset：",-1)),s[1899]||(s[1899]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725153359022.png",alt:"image-20210725153359022",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1900]||(s[1900]=i("p",null,"slave与master的offset之间的差异，就是salve需要增量拷贝的数据了。",-1)),s[1901]||(s[1901]=i("p",null,"随着不断有数据写入，master的offset逐渐变大，slave也不断的拷贝，追赶master的offset：",-1)),s[1902]||(s[1902]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725153524190.png",alt:"image-20210725153524190",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1903]||(s[1903]=i("p",null,"直到数组被填满：",-1)),s[1904]||(s[1904]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725153715910.png",alt:"image-20210725153715910",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1905]||(s[1905]=i("p",null,"此时，如果有新的数据写入，就会覆盖数组中的旧数据。不过，旧的数据只要是绿色的，说明是已经被同步到slave的数据，即便被覆盖了也没什么影响。因为未同步的仅仅是红色部分。",-1)),s[1906]||(s[1906]=i("p",null,"但是，如果slave出现网络阻塞，导致master的offset远远超过了slave的offset：",-1)),s[1907]||(s[1907]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725153937031.png",alt:"image-20210725153937031",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1908]||(s[1908]=i("p",null,"如果master继续写入新数据，其offset就会覆盖旧的数据，直到将slave现在的offset也覆盖：",-1)),s[1909]||(s[1909]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725154155984.png",alt:"image-20210725154155984",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1910]||(s[1910]=i("p",null,"棕色框中的红色部分，就是尚未同步，但是却已经被覆盖的数据。此时如果slave恢复，需要同步，却发现自己的offset都没有了，无法完成增量同步了。只能做全量同步。",-1)),s[1911]||(s[1911]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725154216392.png",alt:"image-20210725154216392",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1912]||(s[1912]=i("h4",{id:"_2-3-主从同步优化",tabindex:"-1"},[l("2.3 主从同步优化 "),i("a",{class:"header-anchor",href:"#_2-3-主从同步优化","aria-label":'Permalink to "2.3 主从同步优化"'},"​")],-1)),s[1913]||(s[1913]=i("p",null,"主从同步可以保证主从数据的一致性，非常重要。",-1)),s[1914]||(s[1914]=i("p",null,"可以从以下几个方面来优化Redis主从就集群：",-1)),s[1915]||(s[1915]=i("ul",null,[i("li",null,"在master中配置repl-diskless-sync yes启用无磁盘复制，避免全量同步时的磁盘IO。"),i("li",null,"Redis单节点上的内存占用不要太大，减少RDB导致的过多磁盘IO"),i("li",null,"适当提高repl_baklog的大小，发现slave宕机时尽快实现故障恢复，尽可能避免全量同步"),i("li",null,"限制一个master上的slave节点数量，如果实在是太多slave，则可以采用主-从-从链式结构，减少master压力")],-1)),s[1916]||(s[1916]=i("p",null,"主从从架构图：",-1)),s[1917]||(s[1917]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725154405899.png",alt:"image-20210725154405899",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1918]||(s[1918]=i("h4",{id:"_2-4-小结",tabindex:"-1"},[l("2.4 小结 "),i("a",{class:"header-anchor",href:"#_2-4-小结","aria-label":'Permalink to "2.4 小结"'},"​")],-1)),s[1919]||(s[1919]=i("p",null,"简述全量同步和增量同步区别？",-1)),s[1920]||(s[1920]=i("ul",null,[i("li",null,"全量同步：master将完整内存数据生成RDB，发送RDB到slave。后续命令则记录在repl_baklog，逐个发送给slave。"),i("li",null,"增量同步：slave提交自己的offset到master，master获取repl_baklog中从offset之后的命令给slave")],-1)),s[1921]||(s[1921]=i("p",null,"什么时候执行全量同步？",-1)),s[1922]||(s[1922]=i("ul",null,[i("li",null,"slave节点第一次连接master节点时"),i("li",null,"slave节点断开时间太久，repl_baklog中的offset已经被覆盖时")],-1)),s[1923]||(s[1923]=i("p",null,"什么时候执行增量同步？",-1)),s[1924]||(s[1924]=i("ul",null,[i("li",null,"slave节点断开又恢复，并且在repl_baklog中能找到offset时")],-1)),s[1925]||(s[1925]=i("hr",null,null,-1)),s[1926]||(s[1926]=i("h3",{id:"_3-redis哨兵",tabindex:"-1"},[l("3. Redis哨兵 "),i("a",{class:"header-anchor",href:"#_3-redis哨兵","aria-label":'Permalink to "3. Redis哨兵"'},"​")],-1)),s[1927]||(s[1927]=i("p",null,"Redis提供了哨兵（Sentinel）机制来实现主从集群的自动故障恢复。",-1)),s[1928]||(s[1928]=i("h4",{id:"_3-1-哨兵原理",tabindex:"-1"},[l("3.1 哨兵原理 "),i("a",{class:"header-anchor",href:"#_3-1-哨兵原理","aria-label":'Permalink to "3.1 哨兵原理"'},"​")],-1)),s[1929]||(s[1929]=i("h5",{id:"_3-1-1-集群作用",tabindex:"-1"},[l("3.1.1 集群作用 "),i("a",{class:"header-anchor",href:"#_3-1-1-集群作用","aria-label":'Permalink to "3.1.1 集群作用"'},"​")],-1)),s[1930]||(s[1930]=i("p",null,"哨兵的作用如下：",-1)),s[1931]||(s[1931]=i("ul",null,[i("li",null,[i("strong",null,"监控"),l("：Sentinel 会不断检查您的master和slave是否按预期工作")]),i("li",null,[i("strong",null,"自动故障恢复"),l("：如果master故障，Sentinel会将一个slave提升为master。当故障实例恢复后也以新的master为主")]),i("li",null,[i("strong",null,"通知"),l("：Sentinel充当Redis客户端的服务发现来源，当集群发生故障转移时，会将最新信息推送给Redis的客户端")])],-1)),s[1932]||(s[1932]=i("h5",{id:"_3-1-2-集群监控原理",tabindex:"-1"},[l("3.1.2 集群监控原理 "),i("a",{class:"header-anchor",href:"#_3-1-2-集群监控原理","aria-label":'Permalink to "3.1.2 集群监控原理"'},"​")],-1)),s[1933]||(s[1933]=i("p",null,"Sentinel基于心跳机制监测服务状态，每隔1秒向集群的每个实例发送ping命令：",-1)),s[1934]||(s[1934]=i("p",null,[l("•主观下线：如果某sentinel节点发现某实例未在规定时间响应，则认为该实例"),i("strong",null,"主观下线"),l("。")],-1)),s[1935]||(s[1935]=i("p",null,[l("•客观下线：若超过指定数量（quorum）的sentinel都认为该实例主观下线，则该实例"),i("strong",null,"客观下线"),l("。quorum值最好超过Sentinel实例数量的一半。")],-1)),s[1936]||(s[1936]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725154632354.png",alt:"image-20210725154632354",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1937]||(s[1937]=i("h5",{id:"_3-1-3-集群故障恢复原理",tabindex:"-1"},[l("3.1.3 集群故障恢复原理 "),i("a",{class:"header-anchor",href:"#_3-1-3-集群故障恢复原理","aria-label":'Permalink to "3.1.3 集群故障恢复原理"'},"​")],-1)),s[1938]||(s[1938]=i("p",null,"一旦发现master故障，sentinel需要在salve中选择一个作为新的master，选择依据是这样的：",-1)),s[1939]||(s[1939]=i("ul",null,[i("li",null,"首先会判断slave节点与master节点断开时间长短，如果超过指定值（down-after-milliseconds * 10）则会排除该slave节点"),i("li",null,"然后判断slave节点的slave-priority值，越小优先级越高，如果是0则永不参与选举"),i("li",null,"如果slave-prority一样，则判断slave节点的offset值，越大说明数据越新，优先级越高"),i("li",null,"最后是判断slave节点的运行id大小，越小优先级越高。")],-1)),s[1940]||(s[1940]=i("p",null,"当选出一个新的master后，该如何实现切换呢？",-1)),s[1941]||(s[1941]=i("p",null,"流程如下：",-1)),s[1942]||(s[1942]=i("ul",null,[i("li",null,"sentinel给备选的slave1节点发送slaveof no one命令，让该节点成为master"),i("li",null,"sentinel给所有其它slave发送slaveof 192.168.150.101 7002 命令，让这些slave成为新master的从节点，开始从新的master上同步数据。"),i("li",null,"最后，sentinel将故障节点标记为slave，当故障节点恢复后会自动成为新的master的slave节点")],-1)),s[1943]||(s[1943]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725154816841.png",alt:"image-20210725154816841",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1944]||(s[1944]=i("h5",{id:"_3-1-4-小结",tabindex:"-1"},[l("3.1.4 小结 "),i("a",{class:"header-anchor",href:"#_3-1-4-小结","aria-label":'Permalink to "3.1.4 小结"'},"​")],-1)),s[1945]||(s[1945]=i("p",null,"Sentinel的三个作用是什么？",-1)),s[1946]||(s[1946]=i("ul",null,[i("li",null,"监控"),i("li",null,"故障转移"),i("li",null,"通知")],-1)),s[1947]||(s[1947]=i("p",null,"Sentinel如何判断一个redis实例是否健康？",-1)),s[1948]||(s[1948]=i("ul",null,[i("li",null,"每隔1秒发送一次ping命令，如果超过一定时间没有相向则认为是主观下线"),i("li",null,"如果大多数sentinel都认为实例主观下线，则判定服务下线")],-1)),s[1949]||(s[1949]=i("p",null,"故障转移步骤有哪些？",-1)),s[1950]||(s[1950]=i("ul",null,[i("li",null,"首先选定一个slave作为新的master，执行slaveof no one"),i("li",null,"然后让所有节点都执行slaveof 新master"),i("li",null,"修改故障节点配置，添加slaveof 新master")],-1)),s[1951]||(s[1951]=i("h4",{id:"_3-2-搭建哨兵集群",tabindex:"-1"},[l("3.2 搭建哨兵集群 "),i("a",{class:"header-anchor",href:"#_3-2-搭建哨兵集群","aria-label":'Permalink to "3.2 搭建哨兵集群"'},"​")],-1)),s[1952]||(s[1952]=i("h5",{id:"_3-2-1-集群结构",tabindex:"-1"},[l("3.2.1 集群结构 "),i("a",{class:"header-anchor",href:"#_3-2-1-集群结构","aria-label":'Permalink to "3.2.1 集群结构"'},"​")],-1)),s[1953]||(s[1953]=i("p",null,"这里我们搭建一个三节点形成的Sentinel集群，来监管之前的Redis主从集群。如图：",-1)),s[1954]||(s[1954]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725154528072.png",alt:"image-20210725154528072",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1955]||(s[1955]=i("p",null,"三个sentinel实例信息如下：",-1)),s[1956]||(s[1956]=i("table",null,[i("thead",null,[i("tr",null,[i("th",null,"节点"),i("th",{style:{"text-align":"center"}},"IP"),i("th",{style:{"text-align":"center"}},"PORT")])]),i("tbody",null,[i("tr",null,[i("td",null,"s1"),i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"27001")]),i("tr",null,[i("td",null,"s2"),i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"27002")]),i("tr",null,[i("td",null,"s3"),i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"27003")])])],-1)),s[1957]||(s[1957]=i("h5",{id:"_3-2-2-准备实例和配置",tabindex:"-1"},[l("3.2.2 准备实例和配置 "),i("a",{class:"header-anchor",href:"#_3-2-2-准备实例和配置","aria-label":'Permalink to "3.2.2 准备实例和配置"'},"​")],-1)),s[1958]||(s[1958]=i("p",null,"要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。",-1)),s[1959]||(s[1959]=i("p",null,"我们创建三个文件夹，名字分别叫s1、s2、s3：",-1)),s[1960]||(s[1960]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 进入/tmp目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mkdir"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s1"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s2"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s3")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1961]||(s[1961]=i("p",null,"如图：",-1)),s[1962]||(s[1962]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210701215534714.png",alt:"image-20210701215534714",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1963]||(s[1963]=i("p",null,"然后我们在s1目录创建一个sentinel.conf文件，添加下面的内容：",-1)),s[1964]||(s[1964]=i("div",{class:"language-ini max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"ini"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"port 27001")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sentinel announce-ip 192.168.150.101")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sentinel monitor mymaster 192.168.150.101 7001 2")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sentinel down-after-milliseconds mymaster 5000")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sentinel failover-timeout mymaster 60000")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dir "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/tmp/s1"')])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1965]||(s[1965]=i("p",null,"解读：",-1)),s[1966]||(s[1966]=i("ul",null,[i("li",null,[i("code",null,"port 27001"),l("：是当前sentinel实例的端口")]),i("li",null,[i("code",null,"sentinel monitor mymaster 192.168.150.101 7001 2"),l("：指定主节点信息 "),i("ul",null,[i("li",null,[i("code",null,"mymaster"),l("：主节点名称，自定义，任意写")]),i("li",null,[i("code",null,"192.168.150.101 7001"),l("：主节点的ip和端口")]),i("li",null,[i("code",null,"2"),l("：选举master时的quorum值")])])])],-1)),s[1967]||(s[1967]=i("p",null,"然后将s1/sentinel.conf文件拷贝到s2、s3两个目录中（在/tmp目录执行下列命令）：",-1)),s[1968]||(s[1968]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 方式一：逐个拷贝")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s1/sentinel.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s2")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s1/sentinel.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s3")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 方式二：管道组合命令，一键拷贝")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"echo"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s2"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s3"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -n"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s1/sentinel.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1969]||(s[1969]=i("p",null,"修改s2、s3两个文件夹内的配置文件，将端口分别修改为27002、27003：",-1)),s[1970]||(s[1970]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sed"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 's/27001/27002/g'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 's/s1/s2/g'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s2/sentinel.conf")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sed"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 's/27001/27003/g'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 's/s1/s3/g'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s3/sentinel.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1971]||(s[1971]=i("h5",{id:"_3-2-3-启动",tabindex:"-1"},[l("3.2.3 启动 "),i("a",{class:"header-anchor",href:"#_3-2-3-启动","aria-label":'Permalink to "3.2.3 启动"'},"​")],-1)),s[1972]||(s[1972]=i("p",null,"为了方便查看日志，我们打开3个ssh窗口，分别启动3个redis实例，启动命令：",-1)),s[1973]||(s[1973]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 第1个")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-sentinel"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s1/sentinel.conf")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 第2个")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-sentinel"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s2/sentinel.conf")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 第3个")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-sentinel"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," s3/sentinel.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1974]||(s[1974]=i("p",null,"启动后：",-1)),s[1975]||(s[1975]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210701220714104.png",alt:"image-20210701220714104",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1976]||(s[1976]=i("h5",{id:"_3-2-4-测试",tabindex:"-1"},[l("3.2.4 测试 "),i("a",{class:"header-anchor",href:"#_3-2-4-测试","aria-label":'Permalink to "3.2.4 测试"'},"​")],-1)),s[1977]||(s[1977]=i("p",null,"尝试让master节点7001宕机，查看sentinel日志：",-1)),s[1978]||(s[1978]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210701222857997.png",alt:"image-20210701222857997",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1979]||(s[1979]=i("p",null,"查看7003的日志：",-1)),s[1980]||(s[1980]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210701223025709.png",alt:"image-20210701223025709",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1981]||(s[1981]=i("p",null,"查看7002的日志：",-1)),s[1982]||(s[1982]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210701223131264.png",alt:"image-20210701223131264",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1983]||(s[1983]=i("h4",{id:"_3-3-redistemplate",tabindex:"-1"},[l("3.3 RedisTemplate "),i("a",{class:"header-anchor",href:"#_3-3-redistemplate","aria-label":'Permalink to "3.3 RedisTemplate"'},"​")],-1)),s[1984]||(s[1984]=i("p",null,"在Sentinel集群监管下的Redis主从集群，其节点会因为自动故障转移而发生变化，Redis的客户端必须感知这种变化，及时更新连接信息。Spring的RedisTemplate底层利用lettuce实现了节点的感知和自动切换。",-1)),s[1985]||(s[1985]=i("p",null,"下面，我们通过一个测试来实现RedisTemplate集成哨兵机制。",-1)),s[1986]||(s[1986]=i("h5",{id:"_3-3-1-导入demo工程",tabindex:"-1"},[l("3.3.1 导入Demo工程 "),i("a",{class:"header-anchor",href:"#_3-3-1-导入demo工程","aria-label":'Permalink to "3.3.1 导入Demo工程"'},"​")],-1)),s[1987]||(s[1987]=i("p",null,"首先，我们引入课前资料提供的Demo工程：",-1)),s[1988]||(s[1988]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725155124958.png",alt:"image-20210725155124958",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[1989]||(s[1989]=i("h5",{id:"_3-3-2-引入依赖",tabindex:"-1"},[l("3.3.2 引入依赖 "),i("a",{class:"header-anchor",href:"#_3-3-2-引入依赖","aria-label":'Permalink to "3.3.2 引入依赖"'},"​")],-1)),s[1990]||(s[1990]=i("p",null,"在项目的pom文件中引入依赖：",-1)),s[1991]||(s[1991]=i("div",{class:"language-xml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"xml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-data-redis</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1992]||(s[1992]=i("h5",{id:"_3-3-3-配置redis地址",tabindex:"-1"},[l("3.3.3 配置Redis地址 "),i("a",{class:"header-anchor",href:"#_3-3-3-配置redis地址","aria-label":'Permalink to "3.3.3 配置Redis地址"'},"​")],-1)),s[1993]||(s[1993]=i("p",null,"然后在配置文件application.yml中指定redis的sentinel相关信息：",-1)),s[1994]||(s[1994]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"spring"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  redis"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    sentinel"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      master"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," mymaster")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      nodes"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        -"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 192.168"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"150"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"101"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"27001")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        -"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 192.168"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"150"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"101"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"27002")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        -"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 192.168"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"150"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#B31D28","--shiki-light-font-style":"italic","--shiki-dark":"#FDAEB7","--shiki-dark-font-style":"italic"}},"101"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"27003")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1995]||(s[1995]=i("h5",{id:"_3-3-4-配置读写分离",tabindex:"-1"},[l("3.3.4 配置读写分离 "),i("a",{class:"header-anchor",href:"#_3-3-4-配置读写分离","aria-label":'Permalink to "3.3.4 配置读写分离"'},"​")],-1)),s[1996]||(s[1996]=i("p",null,"在项目的启动类中，添加一个新的bean：",-1)),s[1997]||(s[1997]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LettuceClientConfigurationBuilderCustomizer "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"clientConfigurationBuilderCustomizer"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clientConfigurationBuilder "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clientConfigurationBuilder."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"readFrom"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ReadFrom.REPLICA_PREFERRED);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[1998]||(s[1998]=i("p",null,"这个bean中配置的就是读写策略，包括四种：",-1)),s[1999]||(s[1999]=i("ul",null,[i("li",null,"MASTER：从主节点读取"),i("li",null,"MASTER_PREFERRED：优先从master节点读取，master不可用才读取replica"),i("li",null,"REPLICA：从slave（replica）节点读取"),i("li",null,"REPLICA _PREFERRED：优先从slave（replica）节点读取，所有的slave都不可用才读取master")],-1)),s[2e3]||(s[2e3]=i("hr",null,null,-1)),s[2001]||(s[2001]=i("h3",{id:"_4-redis分片集群",tabindex:"-1"},[l("4. Redis分片集群 "),i("a",{class:"header-anchor",href:"#_4-redis分片集群","aria-label":'Permalink to "4. Redis分片集群"'},"​")],-1)),s[2002]||(s[2002]=i("h4",{id:"_4-1-搭建分片集群",tabindex:"-1"},[l("4.1 搭建分片集群 "),i("a",{class:"header-anchor",href:"#_4-1-搭建分片集群","aria-label":'Permalink to "4.1 搭建分片集群"'},"​")],-1)),s[2003]||(s[2003]=i("p",null,"主从和哨兵可以解决高可用、高并发读的问题。但是依然有两个问题没有解决：",-1)),s[2004]||(s[2004]=i("ul",null,[i("li",null,[i("p",null,"海量数据存储问题")]),i("li",null,[i("p",null,"高并发写的问题")])],-1)),s[2005]||(s[2005]=i("p",null,"使用分片集群可以解决上述问题，如图:",-1)),s[2006]||(s[2006]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725155747294.png",alt:"image-20210725155747294",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2007]||(s[2007]=i("p",null,"分片集群特征：",-1)),s[2008]||(s[2008]=i("ul",null,[i("li",null,[i("p",null,"集群中有多个master，每个master保存不同数据")]),i("li",null,[i("p",null,"每个master都可以有多个slave节点")]),i("li",null,[i("p",null,"master之间通过ping监测彼此健康状态")]),i("li",null,[i("p",null,"客户端请求可以访问集群任意节点，最终都会被转发到正确节点")])],-1)),s[2009]||(s[2009]=i("h5",{id:"_4-1-1-集群结构",tabindex:"-1"},[l("4.1.1 集群结构 "),i("a",{class:"header-anchor",href:"#_4-1-1-集群结构","aria-label":'Permalink to "4.1.1 集群结构"'},"​")],-1)),s[2010]||(s[2010]=i("p",null,"分片集群需要的节点数量较多，这里我们搭建一个最小的分片集群，包含3个master节点，每个master包含一个slave节点，结构如下：",-1)),s[2011]||(s[2011]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210702164116027.png",alt:"image-20210702164116027",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2012]||(s[2012]=i("p",null,"这里我们会在同一台虚拟机中开启6个redis实例，模拟分片集群，信息如下：",-1)),s[2013]||(s[2013]=i("table",null,[i("thead",null,[i("tr",null,[i("th",{style:{"text-align":"center"}},"IP"),i("th",{style:{"text-align":"center"}},"PORT"),i("th",{style:{"text-align":"center"}},"角色")])]),i("tbody",null,[i("tr",null,[i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"7001"),i("td",{style:{"text-align":"center"}},"master")]),i("tr",null,[i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"7002"),i("td",{style:{"text-align":"center"}},"master")]),i("tr",null,[i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"7003"),i("td",{style:{"text-align":"center"}},"master")]),i("tr",null,[i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"8001"),i("td",{style:{"text-align":"center"}},"slave")]),i("tr",null,[i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"8002"),i("td",{style:{"text-align":"center"}},"slave")]),i("tr",null,[i("td",{style:{"text-align":"center"}},"192.168.150.101"),i("td",{style:{"text-align":"center"}},"8003"),i("td",{style:{"text-align":"center"}},"slave")])])],-1)),s[2014]||(s[2014]=i("h5",{id:"_4-1-2-准备实例和配置",tabindex:"-1"},[l("4.1.2 准备实例和配置 "),i("a",{class:"header-anchor",href:"#_4-1-2-准备实例和配置","aria-label":'Permalink to "4.1.2 准备实例和配置"'},"​")],-1)),s[2015]||(s[2015]=i("p",null,"删除之前的7001、7002、7003这几个目录，重新创建出7001、7002、7003、8001、8002、8003目录：",-1)),s[2016]||(s[2016]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 进入/tmp目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 删除旧的，避免配置干扰")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rm"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -rf"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mkdir"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8003")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2017]||(s[2017]=i("p",null,"在/tmp下准备一个新的redis.conf文件，内容如下：",-1)),s[2018]||(s[2018]=i("div",{class:"language-ini max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"ini"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"port 6379")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 开启集群功能")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cluster-enabled yes")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 集群的配置文件名称，不需要我们创建，由redis自己维护")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cluster-config-file /tmp/6379/nodes.conf")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 节点心跳失败的超时时间")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cluster-node-timeout 5000")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 持久化文件存放目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dir /tmp/6379")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 绑定地址")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"bind 0.0.0.0")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 让redis后台运行")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"daemonize yes")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 注册的实例ip")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"replica-announce-ip 192.168.150.101")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 保护模式")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"protected-mode no")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 数据库数量")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"databases 1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 日志")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"logfile /tmp/6379/run.log")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2019]||(s[2019]=i("p",null,"将这个文件拷贝到每个目录下：",-1)),s[2020]||(s[2020]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 进入/tmp目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 执行拷贝")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"echo"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8003"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -n"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2021]||(s[2021]=i("p",null,"修改每个目录下的redis.conf，将其中的6379修改为与所在目录一致：",-1)),s[2022]||(s[2022]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 进入/tmp目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 修改配置文件")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"printf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '%s\\n'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8003"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -I"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{} -t sed -i 's/6379/{}/g' {}/redis.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2023]||(s[2023]=i("h5",{id:"_4-1-3-启动",tabindex:"-1"},[l("4.1.3 启动 "),i("a",{class:"header-anchor",href:"#_4-1-3-启动","aria-label":'Permalink to "4.1.3 启动"'},"​")],-1)),s[2024]||(s[2024]=i("p",null,"因为已经配置了后台启动模式，所以可以直接启动服务：",-1)),s[2025]||(s[2025]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 进入/tmp目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 一键启动所有服务")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"printf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '%s\\n'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8003"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -I"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{} -t redis-server {}/redis.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2026]||(s[2026]=i("p",null,"通过ps查看状态：",-1)),s[2027]||(s[2027]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ps"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ef"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," grep"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2028]||(s[2028]=i("p",null,"发现服务都已经正常启动：",-1)),s[2029]||(s[2029]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210702174255799.png",alt:"image-20210702174255799",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2030]||(s[2030]=i("p",null,"如果要关闭所有进程，可以执行命令：",-1)),s[2031]||(s[2031]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ps"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ef"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," grep"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," awk"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '{print $2}'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," kill")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2032]||(s[2032]=i("p",null,"或者（推荐这种方式）：",-1)),s[2033]||(s[2033]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"printf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '%s\\n'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7003"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8001"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8002"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8003"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," xargs"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -I"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{} -t redis-cli -p {} shutdown")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2034]||(s[2034]=i("h5",{id:"_4-1-4-创建集群",tabindex:"-1"},[l("4.1.4 创建集群 "),i("a",{class:"header-anchor",href:"#_4-1-4-创建集群","aria-label":'Permalink to "4.1.4 创建集群"'},"​")],-1)),s[2035]||(s[2035]=i("p",null,"虽然服务启动了，但是目前每个服务之间都是独立的，没有任何关联。",-1)),s[2036]||(s[2036]=i("p",null,"我们需要执行命令来创建集群，在Redis5.0之前创建集群比较麻烦，5.0之后集群管理命令都集成到了redis-cli中。",-1)),s[2037]||(s[2037]=i("p",null,"1）Redis5.0之前",-1)),s[2038]||(s[2038]=i("p",null,"Redis5.0之前集群命令都是用redis安装包下的src/redis-trib.rb来实现的。因为redis-trib.rb是有ruby语言编写的所以需要安装ruby环境。",-1)),s[2039]||(s[2039]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 安装依赖")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"yum"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -y"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," zlib"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ruby"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rubygems")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gem"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2040]||(s[2040]=i("p",null,"然后通过命令来管理集群：",-1)),s[2041]||(s[2041]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 进入redis的src目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp/redis-6.2.4/src")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建集群")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"./redis-trib.rb"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," create"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --replicas"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:7001"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:7002"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:7003"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:8001"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:8002"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:8003")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2042]||(s[2042]=i("p",null,"2）Redis5.0以后",-1)),s[2043]||(s[2043]=i("p",null,"我们使用的是Redis6.2.4版本，集群管理以及集成到了redis-cli中，格式如下：",-1)),s[2044]||(s[2044]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --cluster"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," create"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --cluster-replicas"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:7001"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:7002"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:7003"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:8001"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:8002"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:8003")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2045]||(s[2045]=i("p",null,"命令说明：",-1)),s[2046]||(s[2046]=i("ul",null,[i("li",null,[i("code",null,"redis-cli --cluster"),l("或者"),i("code",null,"./redis-trib.rb"),l("：代表集群操作命令")]),i("li",null,[i("code",null,"create"),l("：代表是创建集群")]),i("li",null,[i("code",null,"--replicas 1"),l("或者"),i("code",null,"--cluster-replicas 1"),l(" ：指定集群中每个master的副本个数为1，此时"),i("code",null,"节点总数 ÷ (replicas + 1)"),l(" 得到的就是master的数量。因此节点列表中的前n个就是master，其它节点都是slave节点，随机分配到不同master")])],-1)),s[2047]||(s[2047]=i("p",null,"运行后的样子：",-1)),s[2048]||(s[2048]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210702181101969.png",alt:"image-20210702181101969",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2049]||(s[2049]=i("p",null,"这里输入yes，则集群开始创建：",-1)),s[2050]||(s[2050]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210702181215705.png",alt:"image-20210702181215705",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2051]||(s[2051]=i("p",null,"通过命令可以查看集群状态：",-1)),s[2052]||(s[2052]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cluster"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," nodes")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2053]||(s[2053]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210702181922809.png",alt:"image-20210702181922809",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2054]||(s[2054]=i("h5",{id:"_4-1-5-测试",tabindex:"-1"},[l("4.1.5 测试 "),i("a",{class:"header-anchor",href:"#_4-1-5-测试","aria-label":'Permalink to "4.1.5 测试"'},"​")],-1)),s[2055]||(s[2055]=i("p",null,"尝试连接7001节点，存储一个数据：",-1)),s[2056]||(s[2056]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 存储数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," num"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 123")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 读取数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," num")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 再次存储")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," a"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2057]||(s[2057]=i("p",null,"结果悲剧了：",-1)),s[2058]||(s[2058]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210702182343979.png",alt:"image-20210702182343979",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2059]||(s[2059]=i("p",null,[l("集群操作时，需要给"),i("code",null,"redis-cli"),l("加上"),i("code",null,"-c"),l("参数才可以：")],-1)),s[2060]||(s[2060]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -c"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2061]||(s[2061]=i("p",null,"这次可以了：",-1)),s[2062]||(s[2062]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210702182602145.png",alt:"image-20210702182602145",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2063]||(s[2063]=i("h4",{id:"_4-2-散列插槽",tabindex:"-1"},[l("4.2 散列插槽 "),i("a",{class:"header-anchor",href:"#_4-2-散列插槽","aria-label":'Permalink to "4.2 散列插槽"'},"​")],-1)),s[2064]||(s[2064]=i("h5",{id:"_4-2-1-插槽原理",tabindex:"-1"},[l("4.2.1 插槽原理 "),i("a",{class:"header-anchor",href:"#_4-2-1-插槽原理","aria-label":'Permalink to "4.2.1 插槽原理"'},"​")],-1)),s[2065]||(s[2065]=i("p",null,"Redis会把每一个master节点映射到0~16383共16384个插槽（hash slot）上，查看集群信息时就能看到：",-1)),s[2066]||(s[2066]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725155820320.png",alt:"image-20210725155820320",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2067]||(s[2067]=i("p",null,"数据key不是与节点绑定，而是与插槽绑定。redis会根据key的有效部分计算插槽值，分两种情况：",-1)),s[2068]||(s[2068]=i("ul",null,[i("li",null,'key中包含"{}"，且“{}”中至少包含1个字符，“{}”中的部分是有效部分'),i("li",null,"key中不包含“{}”，整个key都是有效部分")],-1)),s[2069]||(s[2069]=i("p",null,[l("例如：key是num，那么就根据num计算，如果是"),i("code",null,"{itcast}num"),l("，则根据itcast计算。计算方式是利用CRC16算法得到一个hash值，然后对16384取余，得到的结果就是slot值。")],-1)),s[2070]||(s[2070]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725155850200.png",alt:"image-20210725155850200",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2071]||(s[2071]=i("p",null,"如图，在7001这个节点执行set a 1时，对a做hash运算，对16384取余，得到的结果是15495，因此要存储到103节点。",-1)),s[2072]||(s[2072]=i("p",null,[l("到了7003后，执行"),i("code",null,"get num"),l("时，对num做hash运算，对16384取余，得到的结果是2765，因此需要切换到7001节点")],-1)),s[2073]||(s[2073]=i("h5",{id:"_4-2-1-小结",tabindex:"-1"},[l("4.2.1 小结 "),i("a",{class:"header-anchor",href:"#_4-2-1-小结","aria-label":'Permalink to "4.2.1 小结"'},"​")],-1)),s[2074]||(s[2074]=i("p",null,"Redis如何判断某个key应该在哪个实例？",-1)),s[2075]||(s[2075]=i("ul",null,[i("li",null,"将16384个插槽分配到不同的实例"),i("li",null,"根据key的有效部分计算哈希值，对16384取余"),i("li",null,"余数作为插槽，寻找插槽所在实例即可")],-1)),s[2076]||(s[2076]=i("p",null,"如何将同一类数据固定的保存在同一个Redis实例？",-1)),s[2077]||(s[2077]=i("ul",null,[i("li",null,"这一类数据使用相同的有效部分，例如key都以{typeId}为前缀")],-1)),s[2078]||(s[2078]=i("h4",{id:"_4-3-集群伸缩",tabindex:"-1"},[l("4.3 集群伸缩 "),i("a",{class:"header-anchor",href:"#_4-3-集群伸缩","aria-label":'Permalink to "4.3 集群伸缩"'},"​")],-1)),s[2079]||(s[2079]=i("p",null,[i("code",null,"redis-cli --cluster"),l("提供了很多操作集群的命令，可以通过下面方式查看：")],-1)),s[2080]||(s[2080]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725160138290.png",alt:"image-20210725160138290",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2081]||(s[2081]=i("p",null,"比如，添加节点的命令：",-1)),s[2082]||(s[2082]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725160448139.png",alt:"image-20210725160448139",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2083]||(s[2083]=i("h5",{id:"_4-3-1-需求分析",tabindex:"-1"},[l("4.3.1 需求分析 "),i("a",{class:"header-anchor",href:"#_4-3-1-需求分析","aria-label":'Permalink to "4.3.1 需求分析"'},"​")],-1)),s[2084]||(s[2084]=i("p",null,"需求：向集群中添加一个新的master节点，并向其中存储 num = 10",-1)),s[2085]||(s[2085]=i("ul",null,[i("li",null,"启动一个新的redis实例，端口为7004"),i("li",null,"添加7004到之前的集群，并作为一个master节点"),i("li",null,"给7004节点分配插槽，使得num这个key可以存储到7004实例")],-1)),s[2086]||(s[2086]=i("p",null,"这里需要两个新的功能：",-1)),s[2087]||(s[2087]=i("ul",null,[i("li",null,"添加一个节点到集群中"),i("li",null,"将部分插槽分配到新插槽")],-1)),s[2088]||(s[2088]=i("h5",{id:"_4-3-2-创建新的redis实例",tabindex:"-1"},[l("4.3.2 创建新的redis实例 "),i("a",{class:"header-anchor",href:"#_4-3-2-创建新的redis实例","aria-label":'Permalink to "4.3.2 创建新的redis实例"'},"​")],-1)),s[2089]||(s[2089]=i("p",null,"创建一个文件夹：",-1)),s[2090]||(s[2090]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mkdir"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7004")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2091]||(s[2091]=i("p",null,"拷贝配置文件：",-1)),s[2092]||(s[2092]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis.conf"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /7004")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2093]||(s[2093]=i("p",null,"修改配置文件：",-1)),s[2094]||(s[2094]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sed"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /s/6379/7004/g"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 7004/redis.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2095]||(s[2095]=i("p",null,"启动",-1)),s[2096]||(s[2096]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-server"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 7004/redis.conf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2097]||(s[2097]=i("h5",{id:"_4-3-3-添加新节点到redis",tabindex:"-1"},[l("4.3.3 添加新节点到redis "),i("a",{class:"header-anchor",href:"#_4-3-3-添加新节点到redis","aria-label":'Permalink to "4.3.3 添加新节点到redis"'},"​")],-1)),s[2098]||(s[2098]=i("p",null,"添加节点的语法如下：",-1)),s[2099]||(s[2099]=i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251206004011162.png",alt:"image-20251206004011162",class:"scale-67"},null,-1)),s[2100]||(s[2100]=i("p",null,"执行命令：",-1)),s[2101]||(s[2101]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --cluster"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," add-node"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"  192.168.150.101:7004"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 192.168.150.101:7001")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2102]||(s[2102]=i("p",null,"通过命令查看集群状态：",-1)),s[2103]||(s[2103]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7001"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cluster"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," nodes")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2104]||(s[2104]=i("p",null,"如图，7004加入了集群，并且默认是一个master节点：",-1)),s[2105]||(s[2105]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725161007099.png",alt:"image-20210725161007099",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2106]||(s[2106]=i("p",null,"但是，可以看到7004节点的插槽数量为0，因此没有任何数据可以存储到7004上",-1)),s[2107]||(s[2107]=i("h5",{id:"_4-3-4-转移插槽",tabindex:"-1"},[l("4.3.4 转移插槽 "),i("a",{class:"header-anchor",href:"#_4-3-4-转移插槽","aria-label":'Permalink to "4.3.4 转移插槽"'},"​")],-1)),s[2108]||(s[2108]=i("p",null,"我们要将num存储到7004节点，因此需要先看看num的插槽是多少：",-1)),s[2109]||(s[2109]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725161241793.png",alt:"image-20210725161241793",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2110]||(s[2110]=i("p",null,"如上图所示，num的插槽为2765.",-1)),s[2111]||(s[2111]=i("p",null,"我们可以将0~3000的插槽从7001转移到7004，命令格式如下：",-1)),s[2112]||(s[2112]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725161401925.png",alt:"image-20210725161401925",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2113]||(s[2113]=i("p",null,"具体命令如下：",-1)),s[2114]||(s[2114]=i("p",null,"建立连接：",-1)),s[2115]||(s[2115]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725161506241.png",alt:"image-20210725161506241",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2116]||(s[2116]=i("p",null,"得到下面的反馈：",-1)),s[2117]||(s[2117]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725161540841.png",alt:"image-20210725161540841",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2118]||(s[2118]=i("p",null,"询问要移动多少个插槽，我们计划是3000个：",-1)),s[2119]||(s[2119]=i("p",null,"新的问题来了：",-1)),s[2120]||(s[2120]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725161637152.png",alt:"image-20210725161637152",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2121]||(s[2121]=i("p",null,"那个node来接收这些插槽？？",-1)),s[2122]||(s[2122]=i("p",null,"显然是7004，那么7004节点的id是多少呢？",-1)),s[2123]||(s[2123]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725161731738.png",alt:"image-20210725161731738",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2124]||(s[2124]=i("p",null,"复制这个id，然后拷贝到刚才的控制台后：",-1)),s[2125]||(s[2125]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725161817642.png",alt:"image-20210725161817642",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2126]||(s[2126]=i("p",null,"这里询问，你的插槽是从哪里移动过来的？",-1)),s[2127]||(s[2127]=i("ul",null,[i("li",null,"all：代表全部，也就是三个节点各转移一部分"),i("li",null,"具体的id：目标节点的id"),i("li",null,"done：没有了")],-1)),s[2128]||(s[2128]=i("p",null,"这里我们要从7001获取，因此填写7001的id：",-1)),s[2129]||(s[2129]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725162030478.png",alt:"image-20210725162030478",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2130]||(s[2130]=i("p",null,"填完后，点击done，这样插槽转移就准备好了：",-1)),s[2131]||(s[2131]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725162101228.png",alt:"image-20210725162101228",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2132]||(s[2132]=i("p",null,"确认要转移吗？输入yes：",-1)),s[2133]||(s[2133]=i("p",null,"然后，通过命令查看结果：",-1)),s[2134]||(s[2134]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725162145497.png",alt:"image-20210725162145497",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2135]||(s[2135]=i("p",null,"可以看到：",-1)),s[2136]||(s[2136]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725162224058.png",alt:"image-20210725162224058",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2137]||(s[2137]=i("p",null,"目的达成。",-1)),s[2138]||(s[2138]=i("h4",{id:"_4-4-故障转移",tabindex:"-1"},[l("4.4 故障转移 "),i("a",{class:"header-anchor",href:"#_4-4-故障转移","aria-label":'Permalink to "4.4 故障转移"'},"​")],-1)),s[2139]||(s[2139]=i("p",null,"集群初识状态是这样的：",-1)),s[2140]||(s[2140]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210727161152065.png",alt:"image-20210727161152065",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2141]||(s[2141]=i("p",null,"其中7001、7002、7003都是master，我们计划让7002宕机。",-1)),s[2142]||(s[2142]=i("h5",{id:"_4-4-1-自动故障转移",tabindex:"-1"},[l("4.4.1 自动故障转移 "),i("a",{class:"header-anchor",href:"#_4-4-1-自动故障转移","aria-label":'Permalink to "4.4.1 自动故障转移"'},"​")],-1)),s[2143]||(s[2143]=i("p",null,"当集群中有一个master宕机会发生什么呢？",-1)),s[2144]||(s[2144]=i("p",null,"直接停止一个redis实例，例如7002：",-1)),s[2145]||(s[2145]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"redis-cli"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 7002"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," shutdown")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[2146]||(s[2146]=i("p",null,"1）首先是该实例与其它实例失去连接",-1)),s[2147]||(s[2147]=i("p",null,"2）然后是疑似宕机：",-1)),s[2148]||(s[2148]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725162319490.png",alt:"image-20210725162319490",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2149]||(s[2149]=i("p",null,"3）最后是确定下线，自动提升一个slave为新的master：",-1)),s[2150]||(s[2150]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725162408979.png",alt:"image-20210725162408979",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2151]||(s[2151]=i("p",null,"4）当7002再次启动，就会变为一个slave节点了：",-1)),s[2152]||(s[2152]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210727160803386.png",alt:"image-20210727160803386",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2153]||(s[2153]=i("h5",{id:"_4-4-2-手动故障转移",tabindex:"-1"},[l("4.4.2 手动故障转移 "),i("a",{class:"header-anchor",href:"#_4-4-2-手动故障转移","aria-label":'Permalink to "4.4.2 手动故障转移"'},"​")],-1)),s[2154]||(s[2154]=i("p",null,"利用cluster failover命令可以手动让集群中的某个master宕机，切换到执行cluster failover命令的这个slave节点，实现无感知的数据迁移。其流程如下：",-1)),s[2155]||(s[2155]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210725162441407.png",alt:"image-20210725162441407",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2156]||(s[2156]=i("p",null,"这种failover命令可以指定三种模式：",-1)),s[2157]||(s[2157]=i("ul",null,[i("li",null,"缺省：默认的流程，如图1~6歩"),i("li",null,"force：省略了对offset的一致性校验"),i("li",null,"takeover：直接执行第5歩，忽略数据一致性、忽略master状态和其它master的意见")],-1)),s[2158]||(s[2158]=i("p",null,[i("strong",null,"案例需求"),l("：在7002这个slave节点执行手动故障转移，重新夺回master地位")],-1)),s[2159]||(s[2159]=i("p",null,"步骤如下：",-1)),s[2160]||(s[2160]=i("p",null,"1）利用redis-cli连接7002这个节点",-1)),s[2161]||(s[2161]=i("p",null,"2）执行cluster failover命令",-1)),s[2162]||(s[2162]=i("p",null,"如图：",-1)),s[2163]||(s[2163]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210727160037766.png",alt:"image-20210727160037766",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2164]||(s[2164]=i("p",null,"效果：",-1)),s[2165]||(s[2165]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251206004948517.png",alt:"image-20251206004948517",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[2166]||(s[2166]=i("h4",{id:"_4-5-redistemplate访问分片集群",tabindex:"-1"},[l("4.5 RedisTemplate访问分片集群 "),i("a",{class:"header-anchor",href:"#_4-5-redistemplate访问分片集群","aria-label":'Permalink to "4.5 RedisTemplate访问分片集群"'},"​")],-1)),s[2167]||(s[2167]=i("p",null,"RedisTemplate底层同样基于lettuce实现了分片集群的支持，而使用的步骤与哨兵模式基本一致：",-1)),s[2168]||(s[2168]=i("p",null,"1）引入redis的starter依赖",-1)),s[2169]||(s[2169]=i("p",null,"2）配置分片集群地址",-1)),s[2170]||(s[2170]=i("p",null,"3）配置读写分离",-1)),s[2171]||(s[2171]=i("p",null,"与哨兵模式相比，其中只有分片集群的配置方式略有差异，如下：",-1)),s[2172]||(s[2172]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    cluster"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      nodes"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        - "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.101:7001")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        - "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.101:7002")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        - "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.101:7003")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        - "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.101:8001")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        - "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.101:8002")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        - "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.101:8003")])])]),i("button",{class:"code-block-unfold-btn"})],-1))]),"main-header":k(()=>[t(a.$slots,"main-header")]),"main-header-after":k(()=>[t(a.$slots,"main-header-after")]),"main-nav":k(()=>[t(a.$slots,"main-nav")]),"main-content-before":k(()=>[t(a.$slots,"main-content-before")]),"main-content":k(()=>[t(a.$slots,"main-content")]),"main-content-after":k(()=>[t(a.$slots,"main-content-after")]),"main-nav-before":k(()=>[t(a.$slots,"main-nav-before")]),"main-nav-after":k(()=>[t(a.$slots,"main-nav-after")]),comment:k(()=>[t(a.$slots,"comment")]),footer:k(()=>[t(a.$slots,"footer")]),aside:k(()=>[t(a.$slots,"aside")]),"aside-custom":k(()=>[t(a.$slots,"aside-custom")]),default:k(()=>[t(a.$slots,"default")]),_:3},8,["frontmatter"])}}};export{H as default,x as usePageData};
