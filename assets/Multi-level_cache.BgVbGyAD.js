var y=(e,p,t)=>new Promise((d,E)=>{var r=a=>{try{h(t.next(a))}catch(s){E(s)}},g=a=>{try{h(t.throw(a))}catch(s){E(s)}},h=a=>a.done?d(a.value):Promise.resolve(a.value).then(r,g);h((t=t.apply(e,p)).next())});import{_ as F}from"./ValaxyMain.vue_vue_type_style_index_0_lang.CDNsmhz3.js";import"./chunks/@vueuse/motion.C0680yyY.js";import{d as u,a as m,u as A}from"./chunks/vue-router.BrUfGvTC.js";import{a1 as c,a3 as k,a4 as n,a5 as i,a6 as D,a7 as l,F as C,a2 as b,Z as B}from"./framework.CyQERZzy.js";import"./app.BPzKOdEP.js";import"./chunks/dayjs.BSMtxqtT.js";import"./chunks/vue-i18n.CvwbWgfE.js";import"./chunks/pinia.CyvRWuDa.js";import"./chunks/nprogress.c3ZdlDjC.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.BIbThCyp.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.Du2MZPyS.js";import"./post.BkCOJq1d.js";const f=u("/posts/Multi-level_cache",e=>y(null,null,function*(){return JSON.parse('{"title":"深入理解多级缓存","description":"","frontmatter":{"title":"深入理解多级缓存","author":"imklaus","tags":["Redis","Nginx"],"categories":["中间件"],"date":"2025/12/5 23:01:00","outline":"deep","postTitleClass":"text-#9b3841","excerpt_type":"html","end":false},"headers":[],"relativePath":"pages/posts/Multi-level_cache.md","lastUpdated":null}')}),{lazy:(e,p)=>e.name===p.name}),K={__name:"Multi-level_cache",setup(e,{expose:p}){var h;const{data:t}=f(),d=A(),E=m(),r=Object.assign(E.meta.frontmatter||{},((h=t.value)==null?void 0:h.frontmatter)||{});return d.currentRoute.value.data=t.value,B("valaxy:frontmatter",r),globalThis.$frontmatter=r,p({frontmatter:{title:"深入理解多级缓存",author:"imklaus",tags:["Redis","Nginx"],categories:["中间件"],date:"2025/12/5 23:01:00",outline:"deep",postTitleClass:"text-#9b3841",excerpt_type:"html",end:!1}}),(a,s)=>{const o=F;return b(),c(o,{frontmatter:C(r)},{"main-content-md":k(()=>[s[0]||(s[0]=i("p",null,[l("参考视频："),i("a",{href:"https://www.bilibili.com/video/BV1LQ4y127n4",target:"_blank",rel:"noreferrer"},"黑马SpringCloud微服务技术栈原理篇")],-1)),s[1]||(s[1]=i("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),s[2]||(s[2]=i("p",null,[i("strong",null,"目录指引"),l("：")],-1)),s[3]||(s[3]=i("nav",{class:"table-of-contents"},[i("ul",null,[i("li",null,[i("a",{href:"#_1-什么是多级缓存"},"1. 什么是多级缓存")]),i("li",null,[i("a",{href:"#_2-jvm进程缓存"},"2. JVM进程缓存"),i("ul",null,[i("li",null,[i("a",{href:"#_2-1-导入案例"},"2.1 导入案例"),i("ul",null,[i("li",null,[i("a",{href:"#_1-安装-mysql"},"1. 安装 MySQL")]),i("li",null,[i("a",{href:"#_2-导入sql"},"2. 导入SQL")]),i("li",null,[i("a",{href:"#_3-导入demo工程"},"3. 导入Demo工程")]),i("li",null,[i("a",{href:"#_4-导入商品查询页面"},"4. 导入商品查询页面")])])]),i("li",null,[i("a",{href:"#_2-2-初识caffeine"},"2.2 初识Caffeine")]),i("li",null,[i("a",{href:"#_2-3-实现jvm进程缓存"},"2.3 实现JVM进程缓存"),i("ul",null,[i("li",null,[i("a",{href:"#_2-3-1-需求"},"2.3.1 需求")]),i("li",null,[i("a",{href:"#_2-3-2-实现"},"2.3.2 实现")])])])])]),i("li",null,[i("a",{href:"#_3-lua语法入门"},"3. Lua语法入门"),i("ul",null,[i("li",null,[i("a",{href:"#_3-1-初识lua"},"3.1 初识Lua")]),i("li",null,[i("a",{href:"#_3-2-helloworld"},"3.2 HelloWorld")]),i("li",null,[i("a",{href:"#_3-3-变量和循环"},"3.3 变量和循环"),i("ul",null,[i("li",null,[i("a",{href:"#_3-3-1-lua的数据类型"},"3.3.1 Lua的数据类型")]),i("li",null,[i("a",{href:"#_3-3-2-声明变量"},"3.3.2 声明变量")]),i("li",null,[i("a",{href:"#_3-2-3-循环"},"3.2.3 循环")])])]),i("li",null,[i("a",{href:"#_3-4-条件控制、函数"},"3.4 条件控制、函数"),i("ul",null,[i("li",null,[i("a",{href:"#_3-4-1-函数"},"3.4.1 函数")]),i("li",null,[i("a",{href:"#_3-4-2-条件控制"},"3.4.2 条件控制")]),i("li",null,[i("a",{href:"#_3-4-3-案例"},"3.4.3 案例")])])])])]),i("li",null,[i("a",{href:"#_4-实现多级缓存"},"4. 实现多级缓存"),i("ul",null,[i("li",null,[i("a",{href:"#_4-1-安装openresty"},"4.1 安装OpenResty"),i("ul",null,[i("li",null,[i("a",{href:"#_1-安装"},"1. 安装")]),i("li",null,[i("a",{href:"#_2-启动和运行"},"2. 启动和运行")]),i("li",null,[i("a",{href:"#_3-备注"},"3. 备注")])])]),i("li",null,[i("a",{href:"#_4-2-openresty快速入门"},"4.2 OpenResty快速入门"),i("ul",null,[i("li",null,[i("a",{href:"#_4-2-1-反向代理流程"},"4.2.1 反向代理流程")]),i("li",null,[i("a",{href:"#_4-2-2-openresty监听请求"},"4.2.2 OpenResty监听请求")]),i("li",null,[i("a",{href:"#_4-2-3-编写item-lua"},"4.2.3 编写item.lua")])])]),i("li",null,[i("a",{href:"#_4-3-请求参数处理"},"4.3 请求参数处理"),i("ul",null,[i("li",null,[i("a",{href:"#_4-3-1-获取参数的api"},"4.3.1 获取参数的API")]),i("li",null,[i("a",{href:"#_4-3-2-获取参数并返回"},"4.3.2 获取参数并返回")])])]),i("li",null,[i("a",{href:"#_4-4-查询tomcat"},"4.4 查询Tomcat"),i("ul",null,[i("li",null,[i("a",{href:"#_4-4-1-发送http请求的api"},"4.4.1 发送http请求的API")]),i("li",null,[i("a",{href:"#_4-4-2-封装http工具"},"4.4.2 封装http工具")]),i("li",null,[i("a",{href:"#_4-4-3-cjson工具类"},"4.4.3 CJSON工具类")]),i("li",null,[i("a",{href:"#_4-4-4-实现tomcat查询"},"4.4.4 实现Tomcat查询")]),i("li",null,[i("a",{href:"#_4-4-5-基于id负载均衡"},"4.4.5 基于ID负载均衡")])])]),i("li",null,[i("a",{href:"#_4-5-redis缓存预热"},"4.5 Redis缓存预热")]),i("li",null,[i("a",{href:"#_4-6-查询redis缓存"},"4.6 查询Redis缓存"),i("ul",null,[i("li",null,[i("a",{href:"#_4-6-1-封装redis工具"},"4.6.1 封装Redis工具")]),i("li",null,[i("a",{href:"#_4-6-2-实现redis查询"},"4.6.2 实现Redis查询")])])]),i("li",null,[i("a",{href:"#_4-7-nginx本地缓存"},"4.7 Nginx本地缓存"),i("ul",null,[i("li",null,[i("a",{href:"#_4-7-1-本地缓存api"},"4.7.1 本地缓存API")]),i("li",null,[i("a",{href:"#_4-7-2-实现本地缓存查询"},"4.7.2 实现本地缓存查询")])])])])]),i("li",null,[i("a",{href:"#_5-缓存同步"},"5. 缓存同步"),i("ul",null,[i("li",null,[i("a",{href:"#_5-1-数据同步策略"},"5.1 数据同步策略"),i("ul",null,[i("li",null,[i("a",{href:"#_1-基于mq的异步通知"},"1）基于MQ的异步通知：")]),i("li",null,[i("a",{href:"#_2-基于canal的通知"},"2）基于Canal的通知")])])]),i("li",null,[i("a",{href:"#_5-2-安装canal"},"5.2 安装Canal"),i("ul",null,[i("li",null,[i("a",{href:"#_5-2-1-认识canal"},"5.2.1 认识Canal")]),i("li",null,[i("a",{href:"#_5-2-2-安装和配置canal"},"5.2.2 安装和配置Canal")])])]),i("li",null,[i("a",{href:"#_5-3-监听canal"},"5.3 监听Canal"),i("ul",null,[i("li",null,[i("a",{href:"#_5-3-1-引入依赖"},"5.3.1 引入依赖")]),i("li",null,[i("a",{href:"#_5-3-2-编写配置"},"5.3.2 编写配置")]),i("li",null,[i("a",{href:"#_5-3-3-修改item实体类"},"5.3.3 修改Item实体类")]),i("li",null,[i("a",{href:"#_5-3-4-编写监听器"},"5.3.4 编写监听器")])])])])])])],-1)),s[4]||(s[4]=i("h2",{id:"_1-什么是多级缓存",tabindex:"-1"},[l("1. 什么是多级缓存 "),i("a",{class:"header-anchor",href:"#_1-什么是多级缓存","aria-label":'Permalink to "1. 什么是多级缓存"'},"​")],-1)),s[5]||(s[5]=i("p",null,"传统的缓存策略一般是请求到达Tomcat后，先查询Redis，如果未命中则查询数据库，如图：",-1)),s[6]||(s[6]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821075259137.png",alt:"image-20210821075259137",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[7]||(s[7]=i("p",null,"存在下面的问题：",-1)),s[8]||(s[8]=i("ul",null,[i("li",null,[i("p",null,"请求要经过Tomcat处理，Tomcat的性能成为整个系统的瓶颈")]),i("li",null,[i("p",null,"Redis缓存失效时，会对数据库产生冲击")])],-1)),D(" more "),s[9]||(s[9]=i("p",null,"多级缓存就是充分利用请求处理的每个环节，分别添加缓存，减轻Tomcat压力，提升服务性能：",-1)),s[10]||(s[10]=i("ul",null,[i("li",null,"浏览器访问静态资源时，优先读取浏览器本地缓存"),i("li",null,"访问非静态资源（ajax查询数据）时，访问服务端"),i("li",null,"请求到达Nginx后，优先读取Nginx本地缓存"),i("li",null,"如果Nginx本地缓存未命中，则去直接查询Redis（不经过Tomcat）"),i("li",null,"如果Redis查询未命中，则查询Tomcat"),i("li",null,"请求进入Tomcat后，优先查询JVM进程缓存"),i("li",null,"如果JVM进程缓存未命中，则查询数据库")],-1)),s[11]||(s[11]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821075558137.png",alt:"image-20210821075558137",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[12]||(s[12]=i("p",null,[l("在多级缓存架构中，Nginx内部需要编写本地缓存查询、Redis查询、Tomcat查询的业务逻辑，因此这样的nginx服务不再是一个"),i("strong",null,"反向代理服务器"),l("，而是一个编写"),i("strong",null,"业务的Web服务器了"),l("。")],-1)),s[13]||(s[13]=i("p",null,"因此这样的业务Nginx服务也需要搭建集群来提高并发，再有专门的nginx服务来做反向代理，如图：",-1)),s[14]||(s[14]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821080511581.png",alt:"image-20210821080511581",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[15]||(s[15]=i("p",null,"另外，我们的Tomcat服务将来也会部署为集群模式：",-1)),s[16]||(s[16]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821080954947.png",alt:"image-20210821080954947",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[17]||(s[17]=i("p",null,"可见，多级缓存的关键有两个：",-1)),s[18]||(s[18]=i("ul",null,[i("li",null,[i("p",null,"一个是在nginx中编写业务，实现nginx本地缓存、Redis、Tomcat的查询")]),i("li",null,[i("p",null,"另一个就是在Tomcat中实现JVM进程缓存")])],-1)),s[19]||(s[19]=i("p",null,"其中Nginx编程则会用到OpenResty框架结合Lua这样的语言。",-1)),s[20]||(s[20]=i("hr",null,null,-1)),s[21]||(s[21]=i("h2",{id:"_2-jvm进程缓存",tabindex:"-1"},[l("2. JVM进程缓存 "),i("a",{class:"header-anchor",href:"#_2-jvm进程缓存","aria-label":'Permalink to "2. JVM进程缓存"'},"​")],-1)),s[22]||(s[22]=i("p",null,"为了演示多级缓存的案例，我们先准备一个商品查询的业务。",-1)),s[23]||(s[23]=i("h3",{id:"_2-1-导入案例",tabindex:"-1"},[l("2.1 导入案例 "),i("a",{class:"header-anchor",href:"#_2-1-导入案例","aria-label":'Permalink to "2.1 导入案例"'},"​")],-1)),s[24]||(s[24]=i("h4",{id:"_1-安装-mysql",tabindex:"-1"},[l("1. 安装 MySQL "),i("a",{class:"header-anchor",href:"#_1-安装-mysql","aria-label":'Permalink to "1. 安装 MySQL"'},"​")],-1)),s[25]||(s[25]=i("p",null,"后期做数据同步需要用到MySQL的主从功能，所以需要大家在虚拟机中，利用Docker来运行一个MySQL容器。",-1)),s[26]||(s[26]=i("h5",{id:"_1-1-准备目录",tabindex:"-1"},[l("1.1 准备目录 "),i("a",{class:"header-anchor",href:"#_1-1-准备目录","aria-label":'Permalink to "1.1 准备目录"'},"​")],-1)),s[27]||(s[27]=i("ul",null,[i("li",null,"为了方便后期配置MySQL，我们先准备两个目录，用于挂载容器的数据和配置文件目录：")],-1)),s[28]||(s[28]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 进入/tmp目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 创建文件夹")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," mkdir"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 进入mysql目录")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," cd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[29]||(s[29]=i("h5",{id:"_1-2-运行命令",tabindex:"-1"},[l("1.2 运行命令 "),i("a",{class:"header-anchor",href:"#_1-2-运行命令","aria-label":'Permalink to "1.2 运行命令"'},"​")],-1)),s[30]||(s[30]=i("ul",null,[i("li",null,"进入mysql目录后，执行下面的Docker命令：")],-1)),s[31]||(s[31]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 3306:3306"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  --name"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -v"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PWD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/conf:/etc/mysql/conf.d"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -v"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PWD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/logs:/logs"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -v"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PWD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/data:/var/lib/mysql"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -e"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," MYSQL_ROOT_PASSWORD="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  --privileged"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -d"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql:5.7.25")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[32]||(s[32]=i("h5",{id:"_1-3-修改配置",tabindex:"-1"},[l("1.3 修改配置 "),i("a",{class:"header-anchor",href:"#_1-3-修改配置","aria-label":'Permalink to "1.3 修改配置"'},"​")],-1)),s[33]||(s[33]=i("p",null,"在/tmp/mysql/conf目录添加一个my.cnf文件，作为mysql的配置文件：",-1)),s[34]||(s[34]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建文件")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"touch"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp/mysql/conf/my.cnf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[35]||(s[35]=i("p",null,"文件的内容如下：",-1)),s[36]||(s[36]=i("div",{class:"language-ini max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"ini"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"[mysqld]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"skip-name-resolve")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"character_set_server"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=utf8")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"datadir"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=/var/lib/mysql")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"server-id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=1000")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[37]||(s[37]=i("h5",{id:"_1-4-重启",tabindex:"-1"},[l("1.4.重启 "),i("a",{class:"header-anchor",href:"#_1-4-重启","aria-label":'Permalink to "1.4.重启"'},"​")],-1)),s[38]||(s[38]=i("p",null,"配置修改后，必须重启容器：",-1)),s[39]||(s[39]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," restart"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[40]||(s[40]=i("h4",{id:"_2-导入sql",tabindex:"-1"},[l("2. 导入SQL "),i("a",{class:"header-anchor",href:"#_2-导入sql","aria-label":'Permalink to "2. 导入SQL"'},"​")],-1)),s[41]||(s[41]=i("p",null,"接下来，利用Navicat客户端连接MySQL，然后导入课前资料提供的sql文件：",-1)),s[42]||(s[42]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809180936732.png",alt:"image-20210809180936732",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[43]||(s[43]=i("p",null,"其中包含两张表：",-1)),s[44]||(s[44]=i("ul",null,[i("li",null,"tb_item：商品表，包含商品的基本信息"),i("li",null,"tb_item_stock：商品库存表，包含商品的库存信息")],-1)),s[45]||(s[45]=i("p",null,"之所以将库存分离出来，是因为库存是更新比较频繁的信息，写操作较多。而其他信息修改的频率非常低。",-1)),s[46]||(s[46]=i("h4",{id:"_3-导入demo工程",tabindex:"-1"},[l("3. 导入Demo工程 "),i("a",{class:"header-anchor",href:"#_3-导入demo工程","aria-label":'Permalink to "3. 导入Demo工程"'},"​")],-1)),s[47]||(s[47]=i("p",null,"下面导入课前资料提供的工程：",-1)),s[48]||(s[48]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181147502.png",alt:"image-20210809181147502",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[49]||(s[49]=i("p",null,"项目结构如图所示：",-1)),s[50]||(s[50]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181346450.png",alt:"image-20210809181346450",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[51]||(s[51]=i("p",null,"其中的业务包括：",-1)),s[52]||(s[52]=i("ul",null,[i("li",null,"分页查询商品"),i("li",null,"新增商品"),i("li",null,"修改商品"),i("li",null,"修改库存"),i("li",null,"删除商品"),i("li",null,"根据id查询商品"),i("li",null,"根据id查询库存")],-1)),s[53]||(s[53]=i("p",null,"业务全部使用mybatis-plus来实现，如有需要请自行修改业务逻辑。",-1)),s[54]||(s[54]=i("h5",{id:"_3-1-分页查询商品",tabindex:"-1"},[l("3.1 分页查询商品 "),i("a",{class:"header-anchor",href:"#_3-1-分页查询商品","aria-label":'Permalink to "3.1 分页查询商品"'},"​")],-1)),s[55]||(s[55]=i("p",null,[l("在"),i("code",null,"com.heima.item.web"),l("包的"),i("code",null,"ItemController"),l("中可以看到接口定义：")],-1)),s[56]||(s[56]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181554563.png",alt:"image-20210809181554563",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[57]||(s[57]=i("h5",{id:"_3-2-新增商品",tabindex:"-1"},[l("3.2 新增商品 "),i("a",{class:"header-anchor",href:"#_3-2-新增商品","aria-label":'Permalink to "3.2 新增商品"'},"​")],-1)),s[58]||(s[58]=i("p",null,[l("在"),i("code",null,"com.heima.item.web"),l("包的"),i("code",null,"ItemController"),l("中可以看到接口定义：")],-1)),s[59]||(s[59]=i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251205215643102.png",alt:"image-20251205215643102",class:"scale-67"},null,-1)),s[60]||(s[60]=i("h5",{id:"_3-3-修改商品",tabindex:"-1"},[l("3.3 修改商品 "),i("a",{class:"header-anchor",href:"#_3-3-修改商品","aria-label":'Permalink to "3.3 修改商品"'},"​")],-1)),s[61]||(s[61]=i("p",null,[l("在"),i("code",null,"com.heima.item.web"),l("包的"),i("code",null,"ItemController"),l("中可以看到接口定义：")],-1)),s[62]||(s[62]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181714607.png",alt:"image-20210809181714607",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[63]||(s[63]=i("h5",{id:"_3-4-修改库存",tabindex:"-1"},[l("3.4 修改库存 "),i("a",{class:"header-anchor",href:"#_3-4-修改库存","aria-label":'Permalink to "3.4 修改库存"'},"​")],-1)),s[64]||(s[64]=i("p",null,[l("在"),i("code",null,"com.heima.item.web"),l("包的"),i("code",null,"ItemController"),l("中可以看到接口定义：")],-1)),s[65]||(s[65]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181744011.png",alt:"image-20210809181744011",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[66]||(s[66]=i("h5",{id:"_3-5-删除商品",tabindex:"-1"},[l("3.5 删除商品 "),i("a",{class:"header-anchor",href:"#_3-5-删除商品","aria-label":'Permalink to "3.5 删除商品"'},"​")],-1)),s[67]||(s[67]=i("p",null,[l("在"),i("code",null,"com.heima.item.web"),l("包的"),i("code",null,"ItemController"),l("中可以看到接口定义：")],-1)),s[68]||(s[68]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181821696.png",alt:"image-20210809181821696",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[69]||(s[69]=i("p",null,"这里是采用了逻辑删除，将商品状态修改为3",-1)),s[70]||(s[70]=i("h5",{id:"_3-6-根据id查询商品",tabindex:"-1"},[l("3.6 根据id查询商品 "),i("a",{class:"header-anchor",href:"#_3-6-根据id查询商品","aria-label":'Permalink to "3.6 根据id查询商品"'},"​")],-1)),s[71]||(s[71]=i("p",null,[l("在"),i("code",null,"com.heima.item.web"),l("包的"),i("code",null,"ItemController"),l("中可以看到接口定义：")],-1)),s[72]||(s[72]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181901823.png",alt:"image-20210809181901823",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[73]||(s[73]=i("p",null,"这里只返回了商品信息，不包含库存",-1)),s[74]||(s[74]=i("h5",{id:"_3-7-根据id查询库存",tabindex:"-1"},[l("3.7 根据id查询库存 "),i("a",{class:"header-anchor",href:"#_3-7-根据id查询库存","aria-label":'Permalink to "3.7 根据id查询库存"'},"​")],-1)),s[75]||(s[75]=i("p",null,[l("在"),i("code",null,"com.heima.item.web"),l("包的"),i("code",null,"ItemController"),l("中可以看到接口定义：")],-1)),s[76]||(s[76]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181932805.png",alt:"image-20210809181932805",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[77]||(s[77]=i("h5",{id:"_3-8-启动",tabindex:"-1"},[l("3.8 启动 "),i("a",{class:"header-anchor",href:"#_3-8-启动","aria-label":'Permalink to "3.8 启动"'},"​")],-1)),s[78]||(s[78]=i("p",null,"注意修改application.yml文件中配置的mysql地址信息：",-1)),s[79]||(s[79]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809182350132.png",alt:"image-20210809182350132",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[80]||(s[80]=i("p",null,"需要修改为自己的虚拟机地址信息、还有账号和密码。",-1)),s[81]||(s[81]=i("p",null,[l("修改后，启动服务，访问："),i("a",{href:"http://localhost:8081/item/10001%E5%8D%B3%E5%8F%AF%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE",target:"_blank",rel:"noreferrer"},"http://localhost:8081/item/10001即可查询数据")],-1)),s[82]||(s[82]=i("h4",{id:"_4-导入商品查询页面",tabindex:"-1"},[l("4. 导入商品查询页面 "),i("a",{class:"header-anchor",href:"#_4-导入商品查询页面","aria-label":'Permalink to "4. 导入商品查询页面"'},"​")],-1)),s[83]||(s[83]=i("p",null,"商品查询是购物页面，与商品管理的页面是分离的。",-1)),s[84]||(s[84]=i("p",null,"部署方式如图：",-1)),s[85]||(s[85]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816111210961.png",alt:"image-20210816111210961",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[86]||(s[86]=i("p",null,"我们需要准备一个反向代理的nginx服务器，如上图红框所示，将静态的商品页面放到nginx目录中。",-1)),s[87]||(s[87]=i("p",null,"页面需要的数据通过ajax向服务端（nginx业务集群）查询。",-1)),s[88]||(s[88]=i("h5",{id:"_4-1-运行nginx服务",tabindex:"-1"},[l("4.1 运行nginx服务 "),i("a",{class:"header-anchor",href:"#_4-1-运行nginx服务","aria-label":'Permalink to "4.1 运行nginx服务"'},"​")],-1)),s[89]||(s[89]=i("p",null,"这里我已经给大家准备好了nginx反向代理服务器和静态资源。",-1)),s[90]||(s[90]=i("p",null,"我们找到课前资料的nginx目录：",-1)),s[91]||(s[91]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816111348353.png",alt:"image-20210816111348353",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[92]||(s[92]=i("p",null,"将其拷贝到一个非中文目录下，运行这个nginx服务。",-1)),s[93]||(s[93]=i("p",null,"运行命令：",-1)),s[94]||(s[94]=i("div",{class:"language-powershell max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"start "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nginx.exe")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[95]||(s[95]=i("p",null,[l("然后访问 "),i("a",{href:"http://localhost/item.html?id=10001%E5%8D%B3%E5%8F%AF%EF%BC%9A",target:"_blank",rel:"noreferrer"},"http://localhost/item.html?id=10001即可：")],-1)),s[96]||(s[96]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816112323632.png",alt:"image-20210816112323632",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[97]||(s[97]=i("h5",{id:"_4-2-反向代理",tabindex:"-1"},[l("4.2 反向代理 "),i("a",{class:"header-anchor",href:"#_4-2-反向代理","aria-label":'Permalink to "4.2 反向代理"'},"​")],-1)),s[98]||(s[98]=i("p",null,"现在，页面是假数据展示的。我们需要向服务器发送ajax请求，查询商品数据。",-1)),s[99]||(s[99]=i("p",null,"打开控制台，可以看到页面有发起ajax查询数据：",-1)),s[100]||(s[100]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816113816958.png",alt:"image-20210816113816958",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[101]||(s[101]=i("p",null,"而这个请求地址同样是80端口，所以被当前的nginx反向代理了。",-1)),s[102]||(s[102]=i("p",null,"查看nginx的conf目录下的nginx.conf文件：",-1)),s[103]||(s[103]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816113917002.png",alt:"image-20210816113917002",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[104]||(s[104]=i("p",null,"其中的关键配置如下：",-1)),s[105]||(s[105]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816114416561.png",alt:"image-20210816114416561",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[106]||(s[106]=i("p",null,"其中的192.168.150.101是我的虚拟机IP，也就是我的Nginx业务集群要部署的地方：",-1)),s[107]||(s[107]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816114554645.png",alt:"image-20210816114554645",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[108]||(s[108]=i("p",null,"完整内容如下：",-1)),s[109]||(s[109]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#user  nobody;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"worker_processes "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"events"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    worker_connections "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1024"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    include "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      mime.types;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    default_type "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," application/octet-stream;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    sendfile "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"       on"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    #tcp_nopush     on;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    keepalive_timeout "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 65"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    upstream"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nginx-cluster"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        server"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 192.168.150.101:8081;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    server"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        listen "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"      80"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        server_name "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," localhost;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"	location"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," /api "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            proxy_pass "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"http://nginx-cluster;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        location"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," / "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            root "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  html;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            index "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," index.html index.htm;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        error_page "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  500"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 502"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 503"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 504"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  /50x.html;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        location"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#DBEDFF"}}," /50x.html "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            root "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  html;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[110]||(s[110]=i("h3",{id:"_2-2-初识caffeine",tabindex:"-1"},[l("2.2 初识Caffeine "),i("a",{class:"header-anchor",href:"#_2-2-初识caffeine","aria-label":'Permalink to "2.2 初识Caffeine"'},"​")],-1)),s[111]||(s[111]=i("p",null,"缓存在日常开发中启动至关重要的作用，由于是存储在内存中，数据的读取速度是非常快的，能大量减少对数据库的访问，减少数据库的压力。我们把缓存分为两类：",-1)),s[112]||(s[112]=i("ul",null,[i("li",null,[l("分布式缓存，例如Redis： "),i("ul",null,[i("li",null,"优点：存储容量更大、可靠性更好、可以在集群间共享"),i("li",null,"缺点：访问缓存有网络开销"),i("li",null,"场景：缓存数据量较大、可靠性要求较高、需要在集群间共享")])]),i("li",null,[l("进程本地缓存，例如HashMap、GuavaCache： "),i("ul",null,[i("li",null,"优点：读取本地内存，没有网络开销，速度更快"),i("li",null,"缺点：存储容量有限、可靠性较低、无法共享"),i("li",null,"场景：性能要求较高，缓存数据量较小")])])],-1)),s[113]||(s[113]=i("p",null,"我们今天会利用Caffeine框架来实现JVM进程缓存。",-1)),s[114]||(s[114]=i("p",null,[i("strong",null,"Caffeine"),l("是一个基于Java8开发的，提供了近乎最佳命中率的高性能的本地缓存库。目前Spring内部的缓存使用的就是Caffeine。GitHub地址："),i("a",{href:"https://github.com/ben-manes/caffeine",target:"_blank",rel:"noreferrer"},"https://github.com/ben-manes/caffeine")],-1)),s[115]||(s[115]=i("p",null,"Caffeine的性能非常好，下图是官方给出的性能对比：",-1)),s[116]||(s[116]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821081826399.png",alt:"image-20210821081826399",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[117]||(s[117]=i("p",null,"可以看到Caffeine的性能遥遥领先！",-1)),s[118]||(s[118]=i("p",null,"缓存使用的基本API：",-1)),s[119]||(s[119]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testBasicOps"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 构建cache对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Cache<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> cache "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Caffeine."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 存数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    cache."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"gf"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"迪丽热巴"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 取数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String gf "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cache."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIfPresent"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"gf"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"gf = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," gf);")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 取数据，包含两个参数：")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 参数一：缓存的key")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 参数二：Lambda表达式，表达式参数就是缓存的key，方法体是查询数据库的逻辑")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 优先根据key查询JVM缓存，如果未命中，则执行参数二的Lambda表达式")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String defaultGF "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cache."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"defaultGF"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 根据key去数据库查询数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "柳岩"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    });")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"defaultGF = "'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," defaultGF);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[120]||(s[120]=i("p",null,"Caffeine既然是缓存的一种，肯定需要有缓存的清除策略，不然的话内存总会有耗尽的时候。",-1)),s[121]||(s[121]=i("p",null,"Caffeine提供了三种缓存驱逐策略：",-1)),s[122]||(s[122]=i("ul",null,[i("li",null,[i("p",null,[i("strong",null,"基于容量"),l("：设置缓存的数量上限")]),i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 创建缓存对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Cache<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> cache "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Caffeine."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"maximumSize"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 设置缓存大小上限为 1")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")])])]),i("button",{class:"code-block-unfold-btn"})])]),i("li",null,[i("p",null,[i("strong",null,"基于时间"),l("：设置缓存的有效时间")]),i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 创建缓存对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Cache<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> cache "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Caffeine."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 设置缓存有效期为 10 秒，从最后一次写入开始计时 ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"expireAfterWrite"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Duration."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ofSeconds"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")) ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")])])]),i("button",{class:"code-block-unfold-btn"})])]),i("li",null,[i("p",null,[i("strong",null,"基于引用"),l("：设置缓存为软引用或弱引用，利用GC来回收缓存数据。性能较差，不建议使用。")])])],-1)),s[123]||(s[123]=i("blockquote",null,[i("p",null,[i("strong",null,"注意"),l("：在默认情况下，当一个缓存元素过期的时候，Caffeine不会自动立即将其清理和驱逐。而是在一次读或写操作后，或者在空闲时间完成对失效数据的驱逐。")])],-1)),s[124]||(s[124]=i("h3",{id:"_2-3-实现jvm进程缓存",tabindex:"-1"},[l("2.3 实现JVM进程缓存 "),i("a",{class:"header-anchor",href:"#_2-3-实现jvm进程缓存","aria-label":'Permalink to "2.3 实现JVM进程缓存"'},"​")],-1)),s[125]||(s[125]=i("h4",{id:"_2-3-1-需求",tabindex:"-1"},[l("2.3.1 需求 "),i("a",{class:"header-anchor",href:"#_2-3-1-需求","aria-label":'Permalink to "2.3.1 需求"'},"​")],-1)),s[126]||(s[126]=i("p",null,"利用Caffeine实现下列需求：",-1)),s[127]||(s[127]=i("ul",null,[i("li",null,"给根据id查询商品的业务添加缓存，缓存未命中时查询数据库"),i("li",null,"给根据id查询商品库存的业务添加缓存，缓存未命中时查询数据库"),i("li",null,"缓存初始大小为100"),i("li",null,"缓存上限为10000")],-1)),s[128]||(s[128]=i("h4",{id:"_2-3-2-实现",tabindex:"-1"},[l("2.3.2 实现 "),i("a",{class:"header-anchor",href:"#_2-3-2-实现","aria-label":'Permalink to "2.3.2 实现"'},"​")],-1)),s[129]||(s[129]=i("p",null,"首先，我们需要定义两个Caffeine的缓存对象，分别保存商品、库存的缓存数据。",-1)),s[130]||(s[130]=i("p",null,[l("在item-service的"),i("code",null,"com.heima.item.config"),l("包下定义"),i("code",null,"CaffeineConfig"),l("类：")],-1)),s[131]||(s[131]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.config;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.github.benmanes.caffeine.cache.Cache;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.github.benmanes.caffeine.cache.Caffeine;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.Item;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.ItemStock;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Bean;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Configuration;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CaffeineConfig"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"itemCache"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Caffeine."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"initialCapacity"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"100"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"maximumSize"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10_000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ItemStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stockCache"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Caffeine."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"initialCapacity"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"100"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"maximumSize"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10_000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[132]||(s[132]=i("p",null,[l("然后，修改item-service中的"),i("code",null,"com.heima.item.web"),l("包下的ItemController类，添加缓存逻辑：")],-1)),s[133]||(s[133]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RestController")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ItemController"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemService itemService;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemStockService stockService;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> itemCache;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ItemStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> stockCache;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // ...其它略")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/{id}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Item "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemCache."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id, key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ne"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"status"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"one"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        );")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/stock/{id}"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ItemStock "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findStockById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockCache."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id, key "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key));")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[134]||(s[134]=i("hr",null,null,-1)),s[135]||(s[135]=i("h2",{id:"_3-lua语法入门",tabindex:"-1"},[l("3. Lua语法入门 "),i("a",{class:"header-anchor",href:"#_3-lua语法入门","aria-label":'Permalink to "3. Lua语法入门"'},"​")],-1)),s[136]||(s[136]=i("p",null,"Nginx编程需要用到Lua语言，因此我们必须先入门Lua的基本语法。",-1)),s[137]||(s[137]=i("h3",{id:"_3-1-初识lua",tabindex:"-1"},[l("3.1 初识Lua "),i("a",{class:"header-anchor",href:"#_3-1-初识lua","aria-label":'Permalink to "3.1 初识Lua"'},"​")],-1)),s[138]||(s[138]=i("p",null,[l("Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。官网："),i("a",{href:"https://www.lua.org/",target:"_blank",rel:"noreferrer"},"https://www.lua.org/")],-1)),s[139]||(s[139]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821091437975.png",alt:"image-20210821091437975",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[140]||(s[140]=i("p",null,"Lua经常嵌入到C语言开发的程序中，例如游戏开发、游戏插件等。",-1)),s[141]||(s[141]=i("p",null,"Nginx本身也是C语言开发，因此也允许基于Lua做拓展。",-1)),s[142]||(s[142]=i("h3",{id:"_3-2-helloworld",tabindex:"-1"},[l("3.2 HelloWorld "),i("a",{class:"header-anchor",href:"#_3-2-helloworld","aria-label":'Permalink to "3.2 HelloWorld"'},"​")],-1)),s[143]||(s[143]=i("p",null,"CentOS7默认已经安装了Lua语言环境，所以可以直接运行Lua代码。",-1)),s[144]||(s[144]=i("p",null,"1）在Linux虚拟机的任意目录下，新建一个hello.lua文件",-1)),s[145]||(s[145]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821091621308.png",alt:"image-20210821091621308",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[146]||(s[146]=i("p",null,"2）添加下面的内容",-1)),s[147]||(s[147]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Hello World!"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[148]||(s[148]=i("p",null,"3）运行",-1)),s[149]||(s[149]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821091638140.png",alt:"image-20210821091638140",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[150]||(s[150]=i("h3",{id:"_3-3-变量和循环",tabindex:"-1"},[l("3.3 变量和循环 "),i("a",{class:"header-anchor",href:"#_3-3-变量和循环","aria-label":'Permalink to "3.3 变量和循环"'},"​")],-1)),s[151]||(s[151]=i("p",null,"学习任何语言必然离不开变量，而变量的声明必须先知道数据的类型。",-1)),s[152]||(s[152]=i("h4",{id:"_3-3-1-lua的数据类型",tabindex:"-1"},[l("3.3.1 Lua的数据类型 "),i("a",{class:"header-anchor",href:"#_3-3-1-lua的数据类型","aria-label":'Permalink to "3.3.1 Lua的数据类型"'},"​")],-1)),s[153]||(s[153]=i("p",null,"Lua中支持的常见数据类型包括：",-1)),s[154]||(s[154]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821091835406.png",alt:"image-20210821091835406",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[155]||(s[155]=i("p",null,"另外，Lua提供了type()函数来判断一个变量的数据类型：",-1)),s[156]||(s[156]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821091904332.png",alt:"image-20210821091904332",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[157]||(s[157]=i("h4",{id:"_3-3-2-声明变量",tabindex:"-1"},[l("3.3.2 声明变量 "),i("a",{class:"header-anchor",href:"#_3-3-2-声明变量","aria-label":'Permalink to "3.3.2 声明变量"'},"​")],-1)),s[158]||(s[158]=i("p",null,"Lua声明变量的时候无需指定数据类型，而是用local来声明变量为局部变量：",-1)),s[159]||(s[159]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明字符串，可以用单引号或双引号，")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," str "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'hello'")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 字符串拼接可以使用 ..")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," str2 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'hello' "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'world'")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明数字")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," num "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 21")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明布尔类型")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," flag "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[160]||(s[160]=i("p",null,"Lua中的table类型既可以作为数组，又可以作为Java中的map来使用。数组就是特殊的table，key是数组角标而已：",-1)),s[161]||(s[161]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明数组 ，key为角标的 table")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," arr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'java'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'python'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'lua'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明table，类似java的map")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," map "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  {name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'Jack'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", age"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"21"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[162]||(s[162]=i("p",null,"Lua中的数组角标是从1开始，访问的时候与Java中类似：",-1)),s[163]||(s[163]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 访问数组，lua数组的角标从1开始")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[164]||(s[164]=i("p",null,"Lua中的table可以用key来访问：",-1)),s[165]||(s[165]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 访问table")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'name'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"name"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[166]||(s[166]=i("h4",{id:"_3-2-3-循环",tabindex:"-1"},[l("3.2.3 循环 "),i("a",{class:"header-anchor",href:"#_3-2-3-循环","aria-label":'Permalink to "3.2.3 循环"'},"​")],-1)),s[167]||(s[167]=i("p",null,"对于table，我们可以利用for循环来遍历。不过数组和普通table遍历略有差异。",-1)),s[168]||(s[168]=i("p",null,"遍历数组：",-1)),s[169]||(s[169]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明数组 key为索引的 table")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," arr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'java'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'python'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'lua'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 遍历数组")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," index,value "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"in"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," ipairs"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"do")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(index, value) ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[170]||(s[170]=i("p",null,"遍历普通table",-1)),s[171]||(s[171]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明map，也就是table")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," map "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'Jack'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", age"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"21"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 遍历table")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key,value "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"in"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," pairs"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"do")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"   print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, value) ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[172]||(s[172]=i("h3",{id:"_3-4-条件控制、函数",tabindex:"-1"},[l("3.4 条件控制、函数 "),i("a",{class:"header-anchor",href:"#_3-4-条件控制、函数","aria-label":'Permalink to "3.4 条件控制、函数"'},"​")],-1)),s[173]||(s[173]=i("p",null,"Lua中的条件控制和函数声明与Java类似。",-1)),s[174]||(s[174]=i("h4",{id:"_3-4-1-函数",tabindex:"-1"},[l("3.4.1 函数 "),i("a",{class:"header-anchor",href:"#_3-4-1-函数","aria-label":'Permalink to "3.4.1 函数"'},"​")],-1)),s[175]||(s[175]=i("p",null,"定义函数的语法：",-1)),s[176]||(s[176]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 函数名( argument1, argument2..., "),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"argumentn"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 函数体")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 返回值")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[177]||(s[177]=i("p",null,"例如，定义一个函数，用来打印数组：",-1)),s[178]||(s[178]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," printArr"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," index, value "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"in"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," ipairs"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"do")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[179]||(s[179]=i("h4",{id:"_3-4-2-条件控制",tabindex:"-1"},[l("3.4.2 条件控制 "),i("a",{class:"header-anchor",href:"#_3-4-2-条件控制","aria-label":'Permalink to "3.4.2 条件控制"'},"​")],-1)),s[180]||(s[180]=i("p",null,"类似Java的条件控制，例如if、else语法：",-1)),s[181]||(s[181]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(布尔表达式)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   --[ 布尔表达式为 true 时执行该语句块 --]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   --[ 布尔表达式为 false 时执行该语句块 --]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[182]||(s[182]=i("p",null,"与java不同，布尔表达式中的逻辑运算是基于英文单词：",-1)),s[183]||(s[183]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821092657918.png",alt:"image-20210821092657918",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[184]||(s[184]=i("h4",{id:"_3-4-3-案例",tabindex:"-1"},[l("3.4.3 案例 "),i("a",{class:"header-anchor",href:"#_3-4-3-案例","aria-label":'Permalink to "3.4.3 案例"'},"​")],-1)),s[185]||(s[185]=i("p",null,"需求：自定义一个函数，可以打印table，当参数为nil时，打印错误信息",-1)),s[186]||(s[186]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," printArr"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," arr "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'数组不能为空！'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," index, value "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"in"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," ipairs"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"do")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[187]||(s[187]=i("hr",null,null,-1)),s[188]||(s[188]=i("h2",{id:"_4-实现多级缓存",tabindex:"-1"},[l("4. 实现多级缓存 "),i("a",{class:"header-anchor",href:"#_4-实现多级缓存","aria-label":'Permalink to "4. 实现多级缓存"'},"​")],-1)),s[189]||(s[189]=i("p",null,"多级缓存的实现离不开Nginx编程，而Nginx编程又离不开OpenResty。",-1)),s[190]||(s[190]=i("h3",{id:"_4-1-安装openresty",tabindex:"-1"},[l("4.1 安装OpenResty "),i("a",{class:"header-anchor",href:"#_4-1-安装openresty","aria-label":'Permalink to "4.1 安装OpenResty"'},"​")],-1)),s[191]||(s[191]=i("p",null,"OpenResty® 是一个基于 Nginx的高性能 Web 平台，用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。具备下列特点：",-1)),s[192]||(s[192]=i("ul",null,[i("li",null,"具备Nginx的完整功能"),i("li",null,"基于Lua语言进行扩展，集成了大量精良的 Lua 库、第三方模块"),i("li",null,[l("允许使用Lua"),i("strong",null,"自定义业务逻辑"),l("、"),i("strong",null,"自定义库")])],-1)),s[193]||(s[193]=i("p",null,[l("官方网站： "),i("a",{href:"https://openresty.org/cn/",target:"_blank",rel:"noreferrer"},"https://openresty.org/cn/")],-1)),s[194]||(s[194]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821092902946.png",alt:"image-20210821092902946",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[195]||(s[195]=i("h4",{id:"_1-安装",tabindex:"-1"},[l("1. 安装 "),i("a",{class:"header-anchor",href:"#_1-安装","aria-label":'Permalink to "1. 安装"'},"​")],-1)),s[196]||(s[196]=i("p",null,"首先你的Linux虚拟机必须联网",-1)),s[197]||(s[197]=i("h5",{id:"_1-安装开发库",tabindex:"-1"},[i("strong",null,"1）安装开发库"),l(),i("a",{class:"header-anchor",href:"#_1-安装开发库","aria-label":'Permalink to "**1）安装开发库**"'},"​")],-1)),s[198]||(s[198]=i("p",null,"首先要安装OpenResty的依赖开发库，执行命令：",-1)),s[199]||(s[199]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"yum"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -y"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," pcre-devel"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," openssl-devel"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," gcc"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --skip-broken")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[200]||(s[200]=i("h5",{id:"_2-安装openresty仓库",tabindex:"-1"},[i("strong",null,"2）安装OpenResty仓库"),l(),i("a",{class:"header-anchor",href:"#_2-安装openresty仓库","aria-label":'Permalink to "**2）安装OpenResty仓库**"'},"​")],-1)),s[201]||(s[201]=i("p",null,[l("你可以在你的 CentOS 系统中添加 "),i("code",null,"openresty"),l(" 仓库，这样就可以便于未来安装或更新我们的软件包（通过 "),i("code",null,"yum check-update"),l(" 命令）。运行下面的命令就可以添加我们的仓库：")],-1)),s[202]||(s[202]=i("div",{class:"language- max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"}),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",null,"yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[203]||(s[203]=i("p",null,"如果提示说命令不存在，则运行：",-1)),s[204]||(s[204]=i("div",{class:"language- max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"}),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",null,"yum install -y yum-utils")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[205]||(s[205]=i("p",null,"然后再重复上面的命令",-1)),s[206]||(s[206]=i("h5",{id:"_3-安装openresty",tabindex:"-1"},[i("strong",null,"3）安装OpenResty"),l(),i("a",{class:"header-anchor",href:"#_3-安装openresty","aria-label":'Permalink to "**3）安装OpenResty**"'},"​")],-1)),s[207]||(s[207]=i("p",null,[l("然后就可以像下面这样安装软件包，比如 "),i("code",null,"openresty"),l("：")],-1)),s[208]||(s[208]=i("div",{class:"language-bash max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"yum"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -y"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," openresty")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[209]||(s[209]=i("h5",{id:"_4-安装opm工具",tabindex:"-1"},[i("strong",null,"4）安装opm工具"),l(),i("a",{class:"header-anchor",href:"#_4-安装opm工具","aria-label":'Permalink to "**4）安装opm工具**"'},"​")],-1)),s[210]||(s[210]=i("p",null,"opm是OpenResty的一个管理工具，可以帮助我们安装一个第三方的Lua模块。",-1)),s[211]||(s[211]=i("p",null,[l("如果你想安装命令行工具 "),i("code",null,"opm"),l("，那么可以像下面这样安装 "),i("code",null,"openresty-opm"),l(" 包：")],-1)),s[212]||(s[212]=i("div",{class:"language-bash max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"yum"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -y"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," openresty-opm")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[213]||(s[213]=i("h5",{id:"_5-目录结构",tabindex:"-1"},[i("strong",null,"5）目录结构"),l(),i("a",{class:"header-anchor",href:"#_5-目录结构","aria-label":'Permalink to "**5）目录结构**"'},"​")],-1)),s[214]||(s[214]=i("p",null,"默认情况下，OpenResty安装的目录是：/usr/local/openresty",-1)),s[215]||(s[215]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20200310225539214.png",alt:"image-20200310225539214",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[216]||(s[216]=i("p",null,"看到里面的nginx目录了吗，OpenResty就是在Nginx基础上集成了一些Lua模块。",-1)),s[217]||(s[217]=i("h5",{id:"_6-配置nginx的环境变量",tabindex:"-1"},[i("strong",null,"6）配置nginx的环境变量"),l(),i("a",{class:"header-anchor",href:"#_6-配置nginx的环境变量","aria-label":'Permalink to "**6）配置nginx的环境变量**"'},"​")],-1)),s[218]||(s[218]=i("p",null,"打开配置文件：",-1)),s[219]||(s[219]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vi"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/profile")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[220]||(s[220]=i("p",null,"在最下面加入两行：",-1)),s[221]||(s[221]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"export"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NGINX_HOME"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"/usr/local/openresty/nginx")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"export"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," PATH"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"${NGINX_HOME}/sbin:$PATH")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[222]||(s[222]=i("p",null,"NGINX_HOME：后面是OpenResty安装目录下的nginx的目录",-1)),s[223]||(s[223]=i("p",null,"然后让配置生效：",-1)),s[224]||(s[224]=i("div",{class:"language- max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"}),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",null,"source /etc/profile")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[225]||(s[225]=i("h4",{id:"_2-启动和运行",tabindex:"-1"},[l("2. 启动和运行 "),i("a",{class:"header-anchor",href:"#_2-启动和运行","aria-label":'Permalink to "2. 启动和运行"'},"​")],-1)),s[226]||(s[226]=i("p",null,"OpenResty底层是基于Nginx的，查看OpenResty目录的nginx目录，结构与windows中安装的nginx基本一致：",-1)),s[227]||(s[227]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210811100653291.png",alt:"image-20210811100653291",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[228]||(s[228]=i("p",null,"所以运行方式与nginx基本一致：",-1)),s[229]||(s[229]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 启动nginx")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 重新加载配置")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," reload")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 停止")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[230]||(s[230]=i("p",null,"nginx的默认配置文件注释太多，影响后续我们的编辑，这里将nginx.conf中的注释部分删除，保留有效部分。",-1)),s[231]||(s[231]=i("p",null,[l("修改"),i("code",null,"/usr/local/openresty/nginx/conf/nginx.conf"),l("文件，内容如下：")],-1)),s[232]||(s[232]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#user  nobody;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"worker_processes "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"error_log "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," logs/error.log;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"events"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    worker_connections "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1024"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    include "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      mime.types;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    default_type "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," application/octet-stream;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    sendfile "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"       on"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    keepalive_timeout "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 65"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    server"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        listen "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"      8081"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        server_name "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," localhost;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        location"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," / "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            root "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  html;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            index "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," index.html index.htm;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        error_page "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  500"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 502"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 503"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 504"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  /50x.html;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        location"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#DBEDFF"}}," /50x.html "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            root "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  html;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[233]||(s[233]=i("p",null,"在Linux的控制台输入命令以启动nginx：",-1)),s[234]||(s[234]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[235]||(s[235]=i("p",null,[l("然后访问页面："),i("a",{href:"http://192.168.150.101:8081",target:"_blank",rel:"noreferrer"},"http://192.168.150.101:8081"),l("，注意ip地址替换为你自己的虚拟机IP：")],-1)),s[236]||(s[236]=i("h4",{id:"_3-备注",tabindex:"-1"},[l("3. 备注 "),i("a",{class:"header-anchor",href:"#_3-备注","aria-label":'Permalink to "3. 备注"'},"​")],-1)),s[237]||(s[237]=i("p",null,"加载OpenResty的lua模块：",-1)),s[238]||(s[238]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#lua 模块")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"lua_package_path"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/usr/local/openresty/lualib/?.lua;;"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#c模块     ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"lua_package_cpath"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/usr/local/openresty/lualib/?.so;;"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[239]||(s[239]=i("p",null,"common.lua",-1)),s[240]||(s[240]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装函数，发送http请求，并解析响应")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"location"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"capture"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path,{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        method "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"HTTP_GET"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        args "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," params,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    })")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 记录错误信息，返回404")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http not found, path: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", path , "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", args: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", args)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"404"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"body")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 将方法导出")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {  ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_http "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}  ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[241]||(s[241]=i("p",null,"释放Redis连接API：",-1)),s[242]||(s[242]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 关闭redis连接的工具方法，其实是放入连接池")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," close_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_max_idle_time "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10000"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," -- 连接的空闲时间，单位是毫秒")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_size "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," --连接池大小")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set_keepalive"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pool_max_idle_time, pool_size)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"放入redis连接池失败: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[243]||(s[243]=i("p",null,"读取Redis数据的API：",-1)),s[244]||(s[244]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询redis的方法 ip和port是redis地址，key是查询的key")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port, key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 获取一个连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"connect"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"连接redis失败 : "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp, err "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询失败处理")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis失败: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", key = " '),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    --得到的数据为空处理")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis数据为空, key = "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    close_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[245]||(s[245]=i("p",null,"开启共享词典：",-1)),s[246]||(s[246]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"lua_shared_dict"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item_cache "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"150m"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[247]||(s[247]=i("h3",{id:"_4-2-openresty快速入门",tabindex:"-1"},[l("4.2 OpenResty快速入门 "),i("a",{class:"header-anchor",href:"#_4-2-openresty快速入门","aria-label":'Permalink to "4.2 OpenResty快速入门"'},"​")],-1)),s[248]||(s[248]=i("p",null,"我们希望达到的多级缓存架构如图：",-1)),s[249]||(s[249]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/yeVDlwtfMx.png",alt:"yeVDlwtfMx",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[250]||(s[250]=i("p",null,"其中：",-1)),s[251]||(s[251]=i("ul",null,[i("li",null,[i("p",null,"windows上的nginx用来做反向代理服务，将前端的查询商品的ajax请求代理到OpenResty集群")]),i("li",null,[i("p",null,"OpenResty集群用来编写多级缓存业务")])],-1)),s[252]||(s[252]=i("h4",{id:"_4-2-1-反向代理流程",tabindex:"-1"},[l("4.2.1 反向代理流程 "),i("a",{class:"header-anchor",href:"#_4-2-1-反向代理流程","aria-label":'Permalink to "4.2.1 反向代理流程"'},"​")],-1)),s[253]||(s[253]=i("p",null,"现在，商品详情页使用的是假的商品数据。不过在浏览器中，可以看到页面有发起ajax请求查询真实商品数据。",-1)),s[254]||(s[254]=i("p",null,"这个请求如下：",-1)),s[255]||(s[255]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821093144700.png",alt:"image-20210821093144700",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[256]||(s[256]=i("p",null,"请求地址是localhost，端口是80，就被windows上安装的Nginx服务给接收到了。然后代理给了OpenResty集群：",-1)),s[257]||(s[257]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821094447709.png",alt:"image-20210821094447709",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[258]||(s[258]=i("p",null,"我们需要在OpenResty中编写业务，查询商品数据并返回到浏览器。",-1)),s[259]||(s[259]=i("p",null,"但是这次，我们先在OpenResty接收请求，返回假的商品数据。",-1)),s[260]||(s[260]=i("h4",{id:"_4-2-2-openresty监听请求",tabindex:"-1"},[l("4.2.2 OpenResty监听请求 "),i("a",{class:"header-anchor",href:"#_4-2-2-openresty监听请求","aria-label":'Permalink to "4.2.2 OpenResty监听请求"'},"​")],-1)),s[261]||(s[261]=i("p",null,"OpenResty的很多功能都依赖于其目录下的Lua库，需要在nginx.conf中指定依赖库的目录，并导入依赖：",-1)),s[262]||(s[262]=i("p",null,"1）添加对OpenResty的Lua模块的加载",-1)),s[263]||(s[263]=i("p",null,[l("修改"),i("code",null,"/usr/local/openresty/nginx/conf/nginx.conf"),l("文件，在其中的http下面，添加下面代码：")],-1)),s[264]||(s[264]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#lua 模块")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"lua_package_path"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/usr/local/openresty/lualib/?.lua;;"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#c模块     ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"lua_package_cpath"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/usr/local/openresty/lualib/?.so;;"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[265]||(s[265]=i("p",null,[l("2）监听"),i("code",null,"/api/item"),l("路径")],-1)),s[266]||(s[266]=i("p",null,[l("修改"),i("code",null,"/usr/local/openresty/nginx/conf/nginx.conf"),l("文件，在nginx.conf的server下面，添加对/api/item这个路径的监听：")],-1)),s[267]||(s[267]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"location"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  /api/item "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    # 默认的响应类型")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    default_type "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"application/json;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    # 响应结果由lua/item.lua文件来决定")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    content_by_lua_file"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lua/item.lua;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[268]||(s[268]=i("p",null,[l("这个监听，就类似于SpringMVC中的"),i("code",null,'@GetMapping("/api/item")'),l("做路径映射。")],-1)),s[269]||(s[269]=i("p",null,[l("而"),i("code",null,"content_by_lua_file lua/item.lua"),l("则相当于调用item.lua这个文件，执行其中的业务，把结果返回给用户。相当于java中调用service。")],-1)),s[270]||(s[270]=i("h4",{id:"_4-2-3-编写item-lua",tabindex:"-1"},[l("4.2.3 编写item.lua "),i("a",{class:"header-anchor",href:"#_4-2-3-编写item-lua","aria-label":'Permalink to "4.2.3 编写item.lua"'},"​")],-1)),s[271]||(s[271]=i("p",null,[l("1）在"),i("code",null,"/usr/loca/openresty/nginx"),l("目录创建文件夹：lua")],-1)),s[272]||(s[272]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821100755080.png",alt:"image-20210821100755080",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[273]||(s[273]=i("p",null,[l("2）在"),i("code",null,"/usr/loca/openresty/nginx/lua"),l("文件夹下，新建文件："),i("code",null,"item.lua")],-1)),s[274]||(s[274]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821100801756.png",alt:"image-20210821100801756",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[275]||(s[275]=i("p",null,"3）编写item.lua，返回假数据",-1)),s[276]||(s[276]=i("p",null,[i("code",null,"item.lua"),l("中，利用"),i("code",null,"ngx.say()"),l("函数返回数据到Response中")],-1)),s[277]||(s[277]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"say"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`'{"id":10001,"name":"SALSA AIR","title":"RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4","price":17900,"image":"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp","category":"拉杆箱","brand":"RIMOWA","spec":"","status":1,"createTime":"2019-04-30T16:00:00.000+00:00","updateTime":"2019-04-30T16:00:00.000+00:00","stock":2999,"sold":31290}'`),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[278]||(s[278]=i("p",null,"4）重新加载配置",-1)),s[279]||(s[279]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," reload")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[280]||(s[280]=i("p",null,[l("刷新商品页面："),i("a",{href:"http://localhost/item.html?id=1001%EF%BC%8C%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E6%95%88%E6%9E%9C%EF%BC%9A",target:"_blank",rel:"noreferrer"},"http://localhost/item.html?id=1001，即可看到效果：")],-1)),s[281]||(s[281]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821101217089.png",alt:"image-20210821101217089",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[282]||(s[282]=i("h3",{id:"_4-3-请求参数处理",tabindex:"-1"},[l("4.3 请求参数处理 "),i("a",{class:"header-anchor",href:"#_4-3-请求参数处理","aria-label":'Permalink to "4.3 请求参数处理"'},"​")],-1)),s[283]||(s[283]=i("p",null,"上一节中，我们在OpenResty接收前端请求，但是返回的是假数据。",-1)),s[284]||(s[284]=i("p",null,"要返回真实数据，必须根据前端传递来的商品id，查询商品信息才可以。",-1)),s[285]||(s[285]=i("p",null,"那么如何获取前端传递的商品参数呢？",-1)),s[286]||(s[286]=i("h4",{id:"_4-3-1-获取参数的api",tabindex:"-1"},[l("4.3.1 获取参数的API "),i("a",{class:"header-anchor",href:"#_4-3-1-获取参数的api","aria-label":'Permalink to "4.3.1 获取参数的API"'},"​")],-1)),s[287]||(s[287]=i("p",null,"OpenResty中提供了一些API用来获取不同类型的前端请求参数：",-1)),s[288]||(s[288]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821101433528.png",alt:"image-20210821101433528",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[289]||(s[289]=i("h4",{id:"_4-3-2-获取参数并返回",tabindex:"-1"},[l("4.3.2 获取参数并返回 "),i("a",{class:"header-anchor",href:"#_4-3-2-获取参数并返回","aria-label":'Permalink to "4.3.2 获取参数并返回"'},"​")],-1)),s[290]||(s[290]=i("p",null,"在前端发起的ajax请求如图：",-1)),s[291]||(s[291]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821101721649.png",alt:"image-20210821101721649",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[292]||(s[292]=i("p",null,"可以看到商品id是以路径占位符方式传递的，因此可以利用正则表达式匹配的方式来获取ID",-1)),s[293]||(s[293]=i("p",null,"1）获取商品id",-1)),s[294]||(s[294]=i("p",null,[l("修改"),i("code",null,"/usr/loca/openresty/nginx/nginx.conf"),l("文件中监听/api/item的代码，利用正则表达式获取ID：")],-1)),s[295]||(s[295]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"location"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ~"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#DBEDFF"}}," /api/item/(\\d+) "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    # 默认的响应类型")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    default_type "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"application/json;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    # 响应结果由lua/item.lua文件来决定")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    content_by_lua_file"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lua/item.lua;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[296]||(s[296]=i("p",null,"2）拼接ID并返回",-1)),s[297]||(s[297]=i("p",null,[l("修改"),i("code",null,"/usr/loca/openresty/nginx/lua/item.lua"),l("文件，获取id并拼接到结果中返回：")],-1)),s[298]||(s[298]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取商品id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"var"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 拼接并返回")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"say"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`'{"id":' `),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},` ',"name":"SALSA AIR","title":"RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4","price":17900,"image":"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp","category":"拉杆箱","brand":"RIMOWA","spec":"","status":1,"createTime":"2019-04-30T16:00:00.000+00:00","updateTime":"2019-04-30T16:00:00.000+00:00","stock":2999,"sold":31290}'`),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[299]||(s[299]=i("p",null,"3）重新加载并测试",-1)),s[300]||(s[300]=i("p",null,"运行命令以重新加载OpenResty配置：",-1)),s[301]||(s[301]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," reload")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[302]||(s[302]=i("p",null,"刷新页面可以看到结果中已经带上了ID：",-1)),s[303]||(s[303]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821102235467.png",alt:"image-20210821102235467",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[304]||(s[304]=i("h3",{id:"_4-4-查询tomcat",tabindex:"-1"},[l("4.4 查询Tomcat "),i("a",{class:"header-anchor",href:"#_4-4-查询tomcat","aria-label":'Permalink to "4.4 查询Tomcat"'},"​")],-1)),s[305]||(s[305]=i("p",null,"拿到商品ID后，本应去缓存中查询商品信息，不过目前我们还未建立nginx、redis缓存。因此，这里我们先根据商品id去tomcat查询商品信息。我们实现如图部分：",-1)),s[306]||(s[306]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821102610167.png",alt:"image-20210821102610167",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[307]||(s[307]=i("p",null,"需要注意的是，我们的OpenResty是在虚拟机，Tomcat是在Windows电脑上。两者IP一定不要搞错了。",-1)),s[308]||(s[308]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821102959829.png",alt:"image-20210821102959829",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[309]||(s[309]=i("h4",{id:"_4-4-1-发送http请求的api",tabindex:"-1"},[l("4.4.1 发送http请求的API "),i("a",{class:"header-anchor",href:"#_4-4-1-发送http请求的api","aria-label":'Permalink to "4.4.1 发送http请求的API"'},"​")],-1)),s[310]||(s[310]=i("p",null,"nginx提供了内部API用以发送http请求：",-1)),s[311]||(s[311]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"location"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"capture"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/path"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    method "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"HTTP_GET"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",   "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 请求方式")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    args "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {a"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",b"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"},  "),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- get方式传参数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"})")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[312]||(s[312]=i("p",null,"返回的响应内容包括：",-1)),s[313]||(s[313]=i("ul",null,[i("li",null,"resp.status：响应状态码"),i("li",null,"resp.header：响应头，是一个table"),i("li",null,"resp.body：响应体，就是响应数据")],-1)),s[314]||(s[314]=i("p",null,"注意：这里的path是路径，并不包含IP和端口。这个请求会被nginx内部的server监听并处理。",-1)),s[315]||(s[315]=i("p",null,"但是我们希望这个请求发送到Tomcat服务器，所以还需要编写一个server来对这个路径做反向代理：",-1)),s[316]||(s[316]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," location"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," /path "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     # 这里是windows电脑的ip和Java服务端口，需要确保windows防火墙处于关闭状态")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"     proxy_pass "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"http://192.168.150.1:8081; ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," }")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[317]||(s[317]=i("p",null,"原理如图：",-1)),s[318]||(s[318]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821104149061.png",alt:"image-20210821104149061",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[319]||(s[319]=i("h4",{id:"_4-4-2-封装http工具",tabindex:"-1"},[l("4.4.2 封装http工具 "),i("a",{class:"header-anchor",href:"#_4-4-2-封装http工具","aria-label":'Permalink to "4.4.2 封装http工具"'},"​")],-1)),s[320]||(s[320]=i("p",null,"下面，我们封装一个发送Http请求的工具，基于ngx.location.capture来实现查询tomcat。",-1)),s[321]||(s[321]=i("p",null,"1）添加反向代理，到windows的Java服务",-1)),s[322]||(s[322]=i("p",null,"因为item-service中的接口都是/item开头，所以我们监听/item路径，代理到windows上的tomcat服务。",-1)),s[323]||(s[323]=i("p",null,[l("修改 "),i("code",null,"/usr/local/openresty/nginx/conf/nginx.conf"),l("文件，添加一个location：")],-1)),s[324]||(s[324]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"location"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," /item "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    proxy_pass "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"http://192.168.150.1:8081;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[325]||(s[325]=i("p",null,[l("以后，只要我们调用"),i("code",null,'ngx.location.capture("/item")'),l("，就一定能发送请求到windows的tomcat服务。")],-1)),s[326]||(s[326]=i("p",null,"2）封装工具类",-1)),s[327]||(s[327]=i("p",null,"之前我们说过，OpenResty启动时会加载以下两个目录中的工具文件：",-1)),s[328]||(s[328]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821104857413.png",alt:"image-20210821104857413",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[329]||(s[329]=i("p",null,"所以，自定义的http工具也需要放到这个目录下。",-1)),s[330]||(s[330]=i("p",null,[l("在"),i("code",null,"/usr/local/openresty/lualib"),l("目录下，新建一个common.lua文件：")],-1)),s[331]||(s[331]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vi"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /usr/local/openresty/lualib/common.lua")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[332]||(s[332]=i("p",null,"内容如下:",-1)),s[333]||(s[333]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装函数，发送http请求，并解析响应")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"location"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"capture"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path,{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        method "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"HTTP_GET"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        args "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," params,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    })")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 记录错误信息，返回404")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http请求查询失败, path: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", path , "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", args: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", args)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"404"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"body")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 将方法导出")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {  ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_http "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}  ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[334]||(s[334]=i("p",null,"这个工具将read_http函数封装到_M这个table类型的变量中，并且返回，这类似于导出。",-1)),s[335]||(s[335]=i("p",null,[l("使用的时候，可以利用"),i("code",null,"require('common')"),l("来导入该函数库，这里的common是函数库的文件名。")],-1)),s[336]||(s[336]=i("p",null,"3）实现商品查询",-1)),s[337]||(s[337]=i("p",null,[l("最后，我们修改"),i("code",null,"/usr/local/openresty/lua/item.lua"),l("文件，利用刚刚封装的函数库实现对tomcat的查询：")],-1)),s[338]||(s[338]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 引入自定义common工具模块，返回值是common中返回的 _M")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"common"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 从 common中获取read_http这个函数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_http")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取路径参数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"var"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 根据id查询商品")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemJSON "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 根据id查询商品库存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemStockJSON "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/stock/"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[339]||(s[339]=i("p",null,"这里查询到的结果是json字符串，并且包含商品、库存两个json字符串，页面最终需要的是把两个json拼接为一个json：",-1)),s[340]||(s[340]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821110441222.png",alt:"image-20210821110441222",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[341]||(s[341]=i("p",null,"这就需要我们先把JSON变为lua的table，完成数据整合后，再转为JSON。",-1)),s[342]||(s[342]=i("h4",{id:"_4-4-3-cjson工具类",tabindex:"-1"},[l("4.4.3 CJSON工具类 "),i("a",{class:"header-anchor",href:"#_4-4-3-cjson工具类","aria-label":'Permalink to "4.4.3 CJSON工具类"'},"​")],-1)),s[343]||(s[343]=i("p",null,"OpenResty提供了一个cjson的模块用来处理JSON的序列化和反序列化。",-1)),s[344]||(s[344]=i("p",null,[l("官方地址： "),i("a",{href:"https://github.com/openresty/lua-cjson/",target:"_blank",rel:"noreferrer"},"https://github.com/openresty/lua-cjson/")],-1)),s[345]||(s[345]=i("p",null,"1）引入cjson模块：",-1)),s[346]||(s[346]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "cjson"')])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[347]||(s[347]=i("p",null,"2）序列化：",-1)),s[348]||(s[348]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," obj "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    name "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'jack'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    age "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 21")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 把 table 序列化为 json")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"encode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(obj)")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[349]||(s[349]=i("p",null,"3）反序列化：",-1)),s[350]||(s[350]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},` '{"name": "jack", "age": 21}'`)]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 反序列化 json为 table")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," obj "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(obj."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"name"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[351]||(s[351]=i("h4",{id:"_4-4-4-实现tomcat查询",tabindex:"-1"},[l("4.4.4 实现Tomcat查询 "),i("a",{class:"header-anchor",href:"#_4-4-4-实现tomcat查询","aria-label":'Permalink to "4.4.4 实现Tomcat查询"'},"​")],-1)),s[352]||(s[352]=i("p",null,"下面，我们修改之前的item.lua中的业务，添加json处理功能：",-1)),s[353]||(s[353]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入common函数库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'common'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_http")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入cjson库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'cjson'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取路径参数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"var"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 根据id查询商品")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemJSON "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 根据id查询商品库存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemStockJSON "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/stock/"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- JSON转化为lua的table")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(itemJSON)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stockJSON)")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 组合数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 把item序列化为json 返回结果")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"say"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cjson."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"encode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item))")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[354]||(s[354]=i("h4",{id:"_4-4-5-基于id负载均衡",tabindex:"-1"},[l("4.4.5 基于ID负载均衡 "),i("a",{class:"header-anchor",href:"#_4-4-5-基于id负载均衡","aria-label":'Permalink to "4.4.5 基于ID负载均衡"'},"​")],-1)),s[355]||(s[355]=i("p",null,"刚才的代码中，我们的tomcat是单机部署。而实际开发中，tomcat一定是集群模式：",-1)),s[356]||(s[356]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821111023255.png",alt:"image-20210821111023255",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[357]||(s[357]=i("p",null,"因此，OpenResty需要对tomcat集群做负载均衡。",-1)),s[358]||(s[358]=i("p",null,"而默认的负载均衡规则是轮询模式，当我们查询/item/10001时：",-1)),s[359]||(s[359]=i("ul",null,[i("li",null,"第一次会访问8081端口的tomcat服务，在该服务内部就形成了JVM进程缓存"),i("li",null,"第二次会访问8082端口的tomcat服务，该服务内部没有JVM缓存（因为JVM缓存无法共享），会查询数据库"),i("li",null,"…")],-1)),s[360]||(s[360]=i("p",null,"你看，因为轮询的原因，第一次查询8081形成的JVM缓存并未生效，直到下一次再次访问到8081时才可以生效，缓存命中率太低了。",-1)),s[361]||(s[361]=i("p",null,"怎么办？",-1)),s[362]||(s[362]=i("p",null,"如果能让同一个商品，每次查询时都访问同一个tomcat服务，那么JVM缓存就一定能生效了。",-1)),s[363]||(s[363]=i("p",null,"也就是说，我们需要根据商品id做负载均衡，而不是轮询。",-1)),s[364]||(s[364]=i("h5",{id:"_1-原理",tabindex:"-1"},[l("1）原理 "),i("a",{class:"header-anchor",href:"#_1-原理","aria-label":'Permalink to "1）原理"'},"​")],-1)),s[365]||(s[365]=i("p",null,"nginx提供了基于请求路径做负载均衡的算法：",-1)),s[366]||(s[366]=i("p",null,"nginx根据请求路径做hash运算，把得到的数值对tomcat服务的数量取余，余数是几，就访问第几个服务，实现负载均衡。",-1)),s[367]||(s[367]=i("p",null,"例如：",-1)),s[368]||(s[368]=i("ul",null,[i("li",null,"我们的请求路径是 /item/10001"),i("li",null,"tomcat总数为2台（8081、8082）"),i("li",null,"对请求路径/item/1001做hash运算求余的结果为1"),i("li",null,"则访问第一个tomcat服务，也就是8081")],-1)),s[369]||(s[369]=i("p",null,"只要id不变，每次hash运算结果也不会变，那就可以保证同一个商品，一直访问同一个tomcat服务，确保JVM缓存生效。",-1)),s[370]||(s[370]=i("h5",{id:"_2-实现",tabindex:"-1"},[l("2）实现 "),i("a",{class:"header-anchor",href:"#_2-实现","aria-label":'Permalink to "2）实现"'},"​")],-1)),s[371]||(s[371]=i("p",null,[l("修改"),i("code",null,"/usr/local/openresty/nginx/conf/nginx.conf"),l("文件，实现基于ID做负载均衡。")],-1)),s[372]||(s[372]=i("p",null,"首先，定义tomcat集群，并设置基于路径做负载均衡：",-1)),s[373]||(s[373]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"upstream"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tomcat-cluster "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    hash "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$request_uri;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    server"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 192.168.150.1:8081;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    server"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 192.168.150.1:8082;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[374]||(s[374]=i("p",null,"然后，修改对tomcat服务的反向代理，目标指向tomcat集群：",-1)),s[375]||(s[375]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"location"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," /item "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    proxy_pass "),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"http://tomcat-cluster;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[376]||(s[376]=i("p",null,"重新加载OpenResty",-1)),s[377]||(s[377]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," reload")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[378]||(s[378]=i("h5",{id:"_3-测试",tabindex:"-1"},[l("3）测试 "),i("a",{class:"header-anchor",href:"#_3-测试","aria-label":'Permalink to "3）测试"'},"​")],-1)),s[379]||(s[379]=i("p",null,"启动两台tomcat服务：",-1)),s[380]||(s[380]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821112420464.png",alt:"image-20210821112420464",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[381]||(s[381]=i("p",null,"同时启动：",-1)),s[382]||(s[382]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821112444482.png",alt:"image-20210821112444482",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[383]||(s[383]=i("p",null,"清空日志后，再次访问页面，可以看到不同id的商品，访问到了不同的tomcat服务：",-1)),s[384]||(s[384]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821112559965.png",alt:"image-20210821112559965",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[385]||(s[385]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821112637430.png",alt:"image-20210821112637430",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[386]||(s[386]=i("h3",{id:"_4-5-redis缓存预热",tabindex:"-1"},[l("4.5 Redis缓存预热 "),i("a",{class:"header-anchor",href:"#_4-5-redis缓存预热","aria-label":'Permalink to "4.5 Redis缓存预热"'},"​")],-1)),s[387]||(s[387]=i("p",null,"Redis缓存会面临冷启动问题：",-1)),s[388]||(s[388]=i("p",null,[i("strong",null,"冷启动"),l("：服务刚刚启动时，Redis中并没有缓存，如果所有商品数据都在第一次查询时添加缓存，可能会给数据库带来较大压力。")],-1)),s[389]||(s[389]=i("p",null,[i("strong",null,"缓存预热"),l("：在实际开发中，我们可以利用大数据统计用户访问的热点数据，在项目启动时将这些热点数据提前查询并保存到Redis中。")],-1)),s[390]||(s[390]=i("p",null,"我们数据量较少，并且没有数据统计相关功能，目前可以在启动时将所有数据都放入缓存中。",-1)),s[391]||(s[391]=i("p",null,"1）利用Docker安装Redis",-1)),s[392]||(s[392]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --name"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 6379:6379"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis-server"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --appendonly"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," yes")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[393]||(s[393]=i("p",null,"2）在item-service服务中引入Redis依赖",-1)),s[394]||(s[394]=i("div",{class:"language-xml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"xml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-data-redis</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[395]||(s[395]=i("p",null,"3）配置Redis地址",-1)),s[396]||(s[396]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    host"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"192.168.150.101")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[397]||(s[397]=i("p",null,"4）编写初始化类",-1)),s[398]||(s[398]=i("p",null,"缓存预热需要在项目启动时完成，并且必须是拿到RedisTemplate之后。",-1)),s[399]||(s[399]=i("p",null,"这里我们利用InitializingBean接口来实现，因为InitializingBean可以在对象被Spring创建并且成员变量全部注入后执行。",-1)),s[400]||(s[400]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.config;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.fasterxml.jackson.core.JsonProcessingException;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.fasterxml.jackson.databind.ObjectMapper;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.Item;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.ItemStock;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.service.IItemService;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.service.IItemStockService;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.InitializingBean;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.annotation.Autowired;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.data.redis.core.StringRedisTemplate;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.List;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisHandler"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InitializingBean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate redisTemplate;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemService itemService;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemStockService stockService;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectMapper MAPPER "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ObjectMapper"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," afterPropertiesSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 初始化缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.查询商品信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> itemList "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.放入缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Item item "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemList) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.1.item序列化为JSON")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAPPER."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.2.存入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), json);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.查询商品库存信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ItemStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> stockList "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.放入缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ItemStock stock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockList) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.1.item序列化为JSON")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAPPER."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stock);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.2.存入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:stock:id:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), json);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[401]||(s[401]=i("h3",{id:"_4-6-查询redis缓存",tabindex:"-1"},[l("4.6 查询Redis缓存 "),i("a",{class:"header-anchor",href:"#_4-6-查询redis缓存","aria-label":'Permalink to "4.6 查询Redis缓存"'},"​")],-1)),s[402]||(s[402]=i("p",null,"现在，Redis缓存已经准备就绪，我们可以再OpenResty中实现查询Redis的逻辑了。如下图红框所示：",-1)),s[403]||(s[403]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821113340111.png",alt:"image-20210821113340111",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[404]||(s[404]=i("p",null,"当请求进入OpenResty之后：",-1)),s[405]||(s[405]=i("ul",null,[i("li",null,"优先查询Redis缓存"),i("li",null,"如果Redis缓存未命中，再查询Tomcat")],-1)),s[406]||(s[406]=i("h4",{id:"_4-6-1-封装redis工具",tabindex:"-1"},[l("4.6.1 封装Redis工具 "),i("a",{class:"header-anchor",href:"#_4-6-1-封装redis工具","aria-label":'Permalink to "4.6.1 封装Redis工具"'},"​")],-1)),s[407]||(s[407]=i("p",null,"OpenResty提供了操作Redis的模块，我们只要引入该模块就能直接使用。但是为了方便，我们将Redis操作封装到之前的common.lua工具库中。",-1)),s[408]||(s[408]=i("p",null,[l("修改"),i("code",null,"/usr/local/openresty/lualib/common.lua"),l("文件：")],-1)),s[409]||(s[409]=i("p",null,"1）引入Redis模块，并初始化Redis对象",-1)),s[410]||(s[410]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'resty.redis'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 初始化redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," red "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"red"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set_timeouts"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[411]||(s[411]=i("p",null,"2）封装函数，用来释放Redis连接，其实是放入连接池",-1)),s[412]||(s[412]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 关闭redis连接的工具方法，其实是放入连接池")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," close_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_max_idle_time "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10000"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," -- 连接的空闲时间，单位是毫秒")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_size "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," --连接池大小")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set_keepalive"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pool_max_idle_time, pool_size)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"放入redis连接池失败: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[413]||(s[413]=i("p",null,"3）封装函数，根据key查询Redis数据",-1)),s[414]||(s[414]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询redis的方法 ip和port是redis地址，key是查询的key")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port, key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 获取一个连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"connect"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"连接redis失败 : "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp, err "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询失败处理")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis失败: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", key = " '),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    --得到的数据为空处理")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis数据为空, key = "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    close_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[415]||(s[415]=i("p",null,"4）导出",-1)),s[416]||(s[416]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 将方法导出")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {  ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_http "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_redis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}  ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[417]||(s[417]=i("p",null,"完整的common.lua：",-1)),s[418]||(s[418]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'resty.redis'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 初始化redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," red "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"new"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"red"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set_timeouts"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 关闭redis连接的工具方法，其实是放入连接池")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," close_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_max_idle_time "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10000"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," -- 连接的空闲时间，单位是毫秒")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_size "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," --连接池大小")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set_keepalive"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pool_max_idle_time, pool_size)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"放入redis连接池失败: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询redis的方法 ip和port是redis地址，key是查询的key")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port, key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 获取一个连接")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"connect"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"连接redis失败 : "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp, err "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询失败处理")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis失败: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", key = " '),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    --得到的数据为空处理")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis数据为空, key = "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    close_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装函数，发送http请求，并解析响应")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"location"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"capture"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path,{")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        method "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"HTTP_GET"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        args "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," params,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    })")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 记录错误信息，返回404")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http查询失败, path: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", path , "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", args: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", args)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exit"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"404"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"body")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 将方法导出")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {  ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_http "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http,")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_redis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}  ")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[419]||(s[419]=i("h4",{id:"_4-6-2-实现redis查询",tabindex:"-1"},[l("4.6.2 实现Redis查询 "),i("a",{class:"header-anchor",href:"#_4-6-2-实现redis查询","aria-label":'Permalink to "4.6.2 实现Redis查询"'},"​")],-1)),s[420]||(s[420]=i("p",null,"接下来，我们就可以去修改item.lua文件，实现对Redis的查询了。",-1)),s[421]||(s[421]=i("p",null,"查询逻辑是：",-1)),s[422]||(s[422]=i("ul",null,[i("li",null,"根据id查询Redis"),i("li",null,"如果查询失败则继续查询Tomcat"),i("li",null,"将查询结果返回")],-1)),s[423]||(s[423]=i("p",null,[l("1）修改"),i("code",null,"/usr/local/openresty/lua/item.lua"),l("文件，添加一个查询函数：")],-1)),s[424]||(s[424]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入common函数库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'common'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_http")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_redis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装查询函数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_data"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, path, params)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询本地缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"127.0.0.1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 判断查询结果")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis查询失败，尝试查询http， key: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- redis查询失败，去查询http")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 返回数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[425]||(s[425]=i("p",null,"2）而后修改商品查询、库存查询的业务：",-1)),s[426]||(s[426]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821114528954.png",alt:"image-20210821114528954",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[427]||(s[427]=i("p",null,"3）完整的item.lua代码：",-1)),s[428]||(s[428]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入common函数库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'common'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_http")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_redis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入cjson库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'cjson'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装查询函数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_data"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, path, params)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询本地缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"127.0.0.1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 判断查询结果")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis查询失败，尝试查询http， key: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- redis查询失败，去查询http")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 返回数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取路径参数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"var"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询商品信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemJSON "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_data"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:" '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id,  "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/" '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询库存信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockJSON "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_data"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:stock:id:" '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/stock/" '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- JSON转化为lua的table")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(itemJSON)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stockJSON)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 组合数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 把item序列化为json 返回结果")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"say"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cjson."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"encode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item))")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[429]||(s[429]=i("h3",{id:"_4-7-nginx本地缓存",tabindex:"-1"},[l("4.7 Nginx本地缓存 "),i("a",{class:"header-anchor",href:"#_4-7-nginx本地缓存","aria-label":'Permalink to "4.7 Nginx本地缓存"'},"​")],-1)),s[430]||(s[430]=i("p",null,"现在，整个多级缓存中只差最后一环，也就是nginx的本地缓存了。如图：",-1)),s[431]||(s[431]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821114742950.png",alt:"image-20210821114742950",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[432]||(s[432]=i("h4",{id:"_4-7-1-本地缓存api",tabindex:"-1"},[l("4.7.1 本地缓存API "),i("a",{class:"header-anchor",href:"#_4-7-1-本地缓存api","aria-label":'Permalink to "4.7.1 本地缓存API"'},"​")],-1)),s[433]||(s[433]=i("p",null,[l("OpenResty为Nginx提供了"),i("strong",null,"shard dict"),l("的功能，可以在nginx的多个worker之间共享数据，实现缓存功能。")],-1)),s[434]||(s[434]=i("p",null,"1）开启共享字典，在nginx.conf的http下添加配置：",-1)),s[435]||(s[435]=i("div",{class:"language-nginx max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"nginx"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," lua_shared_dict"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item_cache "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"150m"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[436]||(s[436]=i("p",null,"2）操作共享字典：",-1)),s[437]||(s[437]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取本地缓存对象")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item_cache "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"shared"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"item_cache")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 存储, 指定key、value、过期时间，单位s，默认为0代表永不过期")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"item_cache"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'key'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'value'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 读取")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," item_cache"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'key'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[438]||(s[438]=i("h4",{id:"_4-7-2-实现本地缓存查询",tabindex:"-1"},[l("4.7.2 实现本地缓存查询 "),i("a",{class:"header-anchor",href:"#_4-7-2-实现本地缓存查询","aria-label":'Permalink to "4.7.2 实现本地缓存查询"'},"​")],-1)),s[439]||(s[439]=i("p",null,[l("1）修改"),i("code",null,"/usr/local/openresty/lua/item.lua"),l("文件，修改read_data查询函数，添加本地缓存逻辑：")],-1)),s[440]||(s[440]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入共享词典，本地缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item_cache "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"shared"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"item_cache")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装查询函数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_data"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, expire, path, params)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询本地缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," item_cache"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"本地缓存查询失败，尝试查询Redis， key: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 查询redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"127.0.0.1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 判断查询结果")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis查询失败，尝试查询http， key: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            -- redis查询失败，去查询http")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询成功，把数据写入本地缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    item_cache"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, val, expire)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 返回数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[441]||(s[441]=i("p",null,"2）修改item.lua中查询商品和库存的业务，实现最新的read_data函数：",-1)),s[442]||(s[442]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821115108528.png",alt:"image-20210821115108528",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[443]||(s[443]=i("p",null,"其实就是多了缓存时间参数，过期后nginx缓存会自动删除，下次访问即可更新缓存。",-1)),s[444]||(s[444]=i("p",null,"这里给商品基本信息设置超时时间为30分钟，库存为1分钟。",-1)),s[445]||(s[445]=i("p",null,"因为库存更新频率较高，如果缓存时间过长，可能与数据库差异较大。",-1)),s[446]||(s[446]=i("p",null,"3）完整的item.lua文件：",-1)),s[447]||(s[447]=i("div",{class:"language-lua max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"lua"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入common函数库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'common'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_http")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_redis "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入cjson库")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'cjson'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入共享词典，本地缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item_cache "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"shared"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"item_cache")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装查询函数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_data"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, expire, path, params)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询本地缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," item_cache"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"本地缓存查询失败，尝试查询Redis， key: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 查询redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_redis"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"127.0.0.1"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 判断查询结果")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis查询失败，尝试查询http， key: "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            -- redis查询失败，去查询http")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            val "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询成功，把数据写入本地缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    item_cache"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, val, expire)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 返回数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取路径参数")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"var"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询商品信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemJSON "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_data"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:" '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1800"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",  "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/" '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询库存信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockJSON "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_data"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:stock:id:" '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"60"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/stock/" '),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- JSON转化为lua的table")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(itemJSON)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stockJSON)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 组合数据")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 把item序列化为json 返回结果")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ngx."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"say"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cjson."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"encode"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item))")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[448]||(s[448]=i("hr",null,null,-1)),s[449]||(s[449]=i("h2",{id:"_5-缓存同步",tabindex:"-1"},[l("5. 缓存同步 "),i("a",{class:"header-anchor",href:"#_5-缓存同步","aria-label":'Permalink to "5. 缓存同步"'},"​")],-1)),s[450]||(s[450]=i("p",null,"大多数情况下，浏览器查询到的都是缓存数据，如果缓存数据与数据库数据存在较大差异，可能会产生比较严重的后果。",-1)),s[451]||(s[451]=i("p",null,"所以我们必须保证数据库数据、缓存数据的一致性，这就是缓存与数据库的同步。",-1)),s[452]||(s[452]=i("h3",{id:"_5-1-数据同步策略",tabindex:"-1"},[l("5.1 数据同步策略 "),i("a",{class:"header-anchor",href:"#_5-1-数据同步策略","aria-label":'Permalink to "5.1 数据同步策略"'},"​")],-1)),s[453]||(s[453]=i("p",null,"缓存数据同步的常见方式有三种：",-1)),s[454]||(s[454]=i("p",null,[i("strong",null,"设置有效期"),l("：给缓存设置有效期，到期后自动删除。再次查询时更新")],-1)),s[455]||(s[455]=i("ul",null,[i("li",null,"优势：简单、方便"),i("li",null,"缺点：时效性差，缓存过期之前可能不一致"),i("li",null,"场景：更新频率较低，时效性要求低的业务")],-1)),s[456]||(s[456]=i("p",null,[i("strong",null,"同步双写"),l("：在修改数据库的同时，直接修改缓存")],-1)),s[457]||(s[457]=i("ul",null,[i("li",null,"优势：时效性强，缓存与数据库强一致"),i("li",null,"缺点：有代码侵入，耦合度高；"),i("li",null,"场景：对一致性、时效性要求较高的缓存数据")],-1)),s[458]||(s[458]=i("p",null,"**异步通知：**修改数据库时发送事件通知，相关服务监听到通知后修改缓存数据",-1)),s[459]||(s[459]=i("ul",null,[i("li",null,"优势：低耦合，可以同时通知多个缓存服务"),i("li",null,"缺点：时效性一般，可能存在中间不一致状态"),i("li",null,"场景：时效性要求一般，有多个服务需要同步")],-1)),s[460]||(s[460]=i("p",null,"而异步实现又可以基于MQ或者Canal来实现：",-1)),s[461]||(s[461]=i("h4",{id:"_1-基于mq的异步通知",tabindex:"-1"},[l("1）基于MQ的异步通知： "),i("a",{class:"header-anchor",href:"#_1-基于mq的异步通知","aria-label":'Permalink to "1）基于MQ的异步通知："'},"​")],-1)),s[462]||(s[462]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821115552327.png",alt:"image-20210821115552327",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[463]||(s[463]=i("p",null,"解读：",-1)),s[464]||(s[464]=i("ul",null,[i("li",null,"商品服务完成对数据的修改后，只需要发送一条消息到MQ中。"),i("li",null,"缓存服务监听MQ消息，然后完成对缓存的更新")],-1)),s[465]||(s[465]=i("p",null,"依然有少量的代码侵入。",-1)),s[466]||(s[466]=i("h4",{id:"_2-基于canal的通知",tabindex:"-1"},[l("2）基于Canal的通知 "),i("a",{class:"header-anchor",href:"#_2-基于canal的通知","aria-label":'Permalink to "2）基于Canal的通知"'},"​")],-1)),s[467]||(s[467]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821115719363.png",alt:"image-20210821115719363",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[468]||(s[468]=i("p",null,"解读：",-1)),s[469]||(s[469]=i("ul",null,[i("li",null,"商品服务完成商品修改后，业务直接结束，没有任何代码侵入"),i("li",null,"Canal监听MySQL变化，当发现变化后，立即通知缓存服务"),i("li",null,"缓存服务接收到canal通知，更新缓存")],-1)),s[470]||(s[470]=i("p",null,[i("strong",null,"代码零侵入")],-1)),s[471]||(s[471]=i("h3",{id:"_5-2-安装canal",tabindex:"-1"},[l("5.2 安装Canal "),i("a",{class:"header-anchor",href:"#_5-2-安装canal","aria-label":'Permalink to "5.2 安装Canal"'},"​")],-1)),s[472]||(s[472]=i("h4",{id:"_5-2-1-认识canal",tabindex:"-1"},[l("5.2.1 认识Canal "),i("a",{class:"header-anchor",href:"#_5-2-1-认识canal","aria-label":'Permalink to "5.2.1 认识Canal"'},"​")],-1)),s[473]||(s[473]=i("p",null,[i("strong",null,"Canal [kə’næl]"),l("，译意为水道/管道/沟渠，canal是阿里巴巴旗下的一款开源项目，基于Java开发。基于数据库增量日志解析，提供增量数据订阅&消费。GitHub的地址："),i("a",{href:"https://github.com/alibaba/canal",target:"_blank",rel:"noreferrer"},"https://github.com/alibaba/canal")],-1)),s[474]||(s[474]=i("p",null,"Canal是基于mysql的主从同步来实现的，MySQL主从同步的原理如下：",-1)),s[475]||(s[475]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821115914748.png",alt:"image-20210821115914748",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[476]||(s[476]=i("ul",null,[i("li",null,"1）MySQL master 将数据变更写入二进制日志( binary log），其中记录的数据叫做binary log events"),i("li",null,"2）MySQL slave 将 master 的 binary log events拷贝到它的中继日志(relay log)"),i("li",null,"3）MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据")],-1)),s[477]||(s[477]=i("p",null,"而Canal就是把自己伪装成MySQL的一个slave节点，从而监听master的binary log变化。再把得到的变化信息通知给Canal的客户端，进而完成对其它数据库的同步。",-1)),s[478]||(s[478]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821115948395.png",alt:"image-20210821115948395",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[479]||(s[479]=i("h4",{id:"_5-2-2-安装和配置canal",tabindex:"-1"},[l("5.2.2 安装和配置Canal "),i("a",{class:"header-anchor",href:"#_5-2-2-安装和配置canal","aria-label":'Permalink to "5.2.2 安装和配置Canal"'},"​")],-1)),s[480]||(s[480]=i("p",null,"下面我们就开启mysql的主从同步机制，让Canal来模拟salve",-1)),s[481]||(s[481]=i("h5",{id:"_1-开启mysql主从",tabindex:"-1"},[l("1. 开启MySQL主从 "),i("a",{class:"header-anchor",href:"#_1-开启mysql主从","aria-label":'Permalink to "1. 开启MySQL主从"'},"​")],-1)),s[482]||(s[482]=i("p",null,"Canal是基于MySQL的主从同步功能，因此必须先开启MySQL的主从功能才可以。",-1)),s[483]||(s[483]=i("p",null,"这里以之前用Docker运行的mysql为例：",-1)),s[484]||(s[484]=i("h6",{id:"_1-1-开启binlog",tabindex:"-1"},[l("1.1 开启binlog "),i("a",{class:"header-anchor",href:"#_1-1-开启binlog","aria-label":'Permalink to "1.1 开启binlog"'},"​")],-1)),s[485]||(s[485]=i("p",null,[l("打开mysql容器挂载的日志文件，我的在"),i("code",null,"/tmp/mysql/conf"),l("目录:")],-1)),s[486]||(s[486]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210813153241537.png",alt:"image-20210813153241537",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[487]||(s[487]=i("p",null,"修改文件：",-1)),s[488]||(s[488]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vi"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp/mysql/conf/my.cnf")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[489]||(s[489]=i("p",null,"添加内容：",-1)),s[490]||(s[490]=i("div",{class:"language-ini max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"ini"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"log-bin"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=/var/lib/mysql/mysql-bin")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"binlog-do-db"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=heima")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[491]||(s[491]=i("p",null,"配置解读：",-1)),s[492]||(s[492]=i("ul",null,[i("li",null,[i("code",null,"log-bin=/var/lib/mysql/mysql-bin"),l("：设置binary log文件的存放地址和文件名，叫做mysql-bin")]),i("li",null,[i("code",null,"binlog-do-db=heima"),l("：指定对哪个database记录binary log events，这里记录heima这个库")])],-1)),s[493]||(s[493]=i("p",null,"最终效果：",-1)),s[494]||(s[494]=i("div",{class:"language-ini max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"ini"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"[mysqld]")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"skip-name-resolve")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"character_set_server"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=utf8")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"datadir"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=/var/lib/mysql")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"server-id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=1000")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"log-bin"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=/var/lib/mysql/mysql-bin")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"binlog-do-db"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=heima")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[495]||(s[495]=i("h6",{id:"_1-2-设置用户权限",tabindex:"-1"},[l("1.2 设置用户权限 "),i("a",{class:"header-anchor",href:"#_1-2-设置用户权限","aria-label":'Permalink to "1.2 设置用户权限"'},"​")],-1)),s[496]||(s[496]=i("p",null,"接下来添加一个仅用于数据同步的账户，出于安全考虑，这里仅提供对heima这个库的操作权限。",-1)),s[497]||(s[497]=i("div",{class:"language-sql max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sql"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"create"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," user"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," canal"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'%'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IDENTIFIED "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"by"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'canal'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GRANT"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," SELECT"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", REPLICATION SLAVE, REPLICATION CLIENT,SUPER "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ON"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," TO"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'canal'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'%'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," identified "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"by"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'canal'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"FLUSH PRIVILEGES;")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[498]||(s[498]=i("p",null,"重启mysql容器即可",-1)),s[499]||(s[499]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," restart"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[500]||(s[500]=i("p",null,"测试设置是否成功：在mysql控制台，或者Navicat中，输入命令：",-1)),s[501]||(s[501]=i("div",{class:"language-sql max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sql"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"show "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"master"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," status"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[502]||(s[502]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20200327094735948.png",alt:"image-20200327094735948",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[503]||(s[503]=i("h5",{id:"_2-安装canal",tabindex:"-1"},[l("2. 安装Canal "),i("a",{class:"header-anchor",href:"#_2-安装canal","aria-label":'Permalink to "2. 安装Canal"'},"​")],-1)),s[504]||(s[504]=i("h6",{id:"_2-1-创建网络",tabindex:"-1"},[l("2.1 创建网络 "),i("a",{class:"header-anchor",href:"#_2-1-创建网络","aria-label":'Permalink to "2.1 创建网络"'},"​")],-1)),s[505]||(s[505]=i("p",null,"我们需要创建一个网络，将MySQL、Canal、MQ放到同一个Docker网络中：",-1)),s[506]||(s[506]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," network"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," create"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," heima")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[507]||(s[507]=i("p",null,"让mysql加入这个网络：",-1)),s[508]||(s[508]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," network"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," connect"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," heima"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[509]||(s[509]=i("h6",{id:"_2-2-安装",tabindex:"-1"},[l("2.2 安装 "),i("a",{class:"header-anchor",href:"#_2-2-安装","aria-label":'Permalink to "2.2 安装"'},"​")],-1)),s[510]||(s[510]=i("p",null,"课前资料中提供了canal的镜像压缩包:",-1)),s[511]||(s[511]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210813161804292.png",alt:"image-20210813161804292",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[512]||(s[512]=i("p",null,"大家可以上传到虚拟机，然后通过命令导入：",-1)),s[513]||(s[513]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," load"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," canal.tar")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[514]||(s[514]=i("p",null,"然后运行命令创建Canal容器：",-1)),s[515]||(s[515]=i("div",{class:"language-sh max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"sh"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 11111:11111"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --name"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," canal"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.destinations=heima"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.master.address=mysql:3306"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.dbUsername=canal"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.dbPassword=canal"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.connectionCharset=UTF-8"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.tsdb.enable="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.gtidon="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.filter.regex=heima"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\\\"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},".."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"*"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--network "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"heima"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-d "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal/canal-server:v1.1.5")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[516]||(s[516]=i("p",null,"说明:",-1)),s[517]||(s[517]=i("ul",null,[i("li",null,[i("code",null,"-p 11111:11111"),l("：这是canal的默认监听端口")]),i("li",null,[i("code",null,"-e canal.instance.master.address=mysql:3306"),l("：数据库地址和端口，如果不知道mysql容器地址，可以通过"),i("code",null,"docker inspect 容器id"),l("来查看")]),i("li",null,[i("code",null,"-e canal.instance.dbUsername=canal"),l("：数据库用户名")]),i("li",null,[i("code",null,"-e canal.instance.dbPassword=canal"),l(" ：数据库密码")]),i("li",null,[i("code",null,"-e canal.instance.filter.regex="),l("：要监听的表名称")])],-1)),s[518]||(s[518]=i("p",null,"表名称监听支持的语法：",-1)),s[519]||(s[519]=i("blockquote",null,[i("p",null,[l("mysql 数据解析关注的表，Perl正则表达式. 多个正则之间以逗号"),i("code",null,"(,)"),l("分隔，转义符需要双斜杠"),i("code",null,"(\\\\)"),l(" 常见例子：")]),i("ol",null,[i("li",null,[l("所有表："),i("code",null,".* or .*\\\\..*")]),i("li",null,[l("canal schema下所有表： "),i("code",null,"canal\\\\..*")]),i("li",null,[l("canal下的以canal打头的表："),i("code",null,"canal\\\\.canal.*")]),i("li",null,[l("canal schema下的一张表："),i("code",null,"canal.test1")]),i("li",null,[l("多个规则组合使用然后以逗号隔开："),i("code",null,"canal\\\\..*,mysql.test1,mysql.test2")])])],-1)),s[520]||(s[520]=i("h3",{id:"_5-3-监听canal",tabindex:"-1"},[l("5.3 监听Canal "),i("a",{class:"header-anchor",href:"#_5-3-监听canal","aria-label":'Permalink to "5.3 监听Canal"'},"​")],-1)),s[521]||(s[521]=i("p",null,"Canal提供了各种语言的客户端，当Canal监听到binlog变化时，会通知Canal的客户端。",-1)),s[522]||(s[522]=i("figure",null,[i("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821120049024.png",alt:"image-20210821120049024",loading:"lazy",decoding:"async",class:"lazy"})],-1)),s[523]||(s[523]=i("p",null,"我们可以利用Canal提供的Java客户端，监听Canal通知消息。当收到变化的消息时，完成对缓存的更新。",-1)),s[524]||(s[524]=i("p",null,[l("不过这里我们会使用GitHub上的第三方开源的canal-starter客户端。地址："),i("a",{href:"https://github.com/NormanGyllenhaal/canal-client",target:"_blank",rel:"noreferrer"},"https://github.com/NormanGyllenhaal/canal-client")],-1)),s[525]||(s[525]=i("p",null,"与SpringBoot完美整合，自动装配，比官方客户端要简单好用很多。",-1)),s[526]||(s[526]=i("h4",{id:"_5-3-1-引入依赖",tabindex:"-1"},[l("5.3.1 引入依赖 "),i("a",{class:"header-anchor",href:"#_5-3-1-引入依赖","aria-label":'Permalink to "5.3.1 引入依赖"'},"​")],-1)),s[527]||(s[527]=i("div",{class:"language-xml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"xml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">top.javatool</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">canal-spring-boot-starter</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">1.2.1-RELEASE</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[528]||(s[528]=i("h4",{id:"_5-3-2-编写配置",tabindex:"-1"},[l("5.3.2 编写配置 "),i("a",{class:"header-anchor",href:"#_5-3-2-编写配置","aria-label":'Permalink to "5.3.2 编写配置"'},"​")],-1)),s[529]||(s[529]=i("div",{class:"language-yaml max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"yaml"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"canal"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  destination"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"heima"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # canal的集群名字，要与安装canal时设置的名称一致")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  server"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.101:11111"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # canal服务地址")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[530]||(s[530]=i("h4",{id:"_5-3-3-修改item实体类",tabindex:"-1"},[l("5.3.3 修改Item实体类 "),i("a",{class:"header-anchor",href:"#_5-3-3-修改item实体类","aria-label":'Permalink to "5.3.3 修改Item实体类"'},"​")],-1)),s[531]||(s[531]=i("p",null,"通过@Id、@Column、等注解完成Item与数据库表字段的映射：",-1)),s[532]||(s[532]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.baomidou.mybatisplus.annotation.IdType;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.baomidou.mybatisplus.annotation.TableField;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.baomidou.mybatisplus.annotation.TableId;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.baomidou.mybatisplus.annotation.TableName;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lombok.Data;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.data.annotation.Id;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.data.annotation.Transient;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," javax.persistence.Column;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.Date;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Data")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TableName"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"tb_item"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TableId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"type"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IdType.AUTO)")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Long id;"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//商品id")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Column"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "name"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String name;"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//商品名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String title;"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//商品标题")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Long price;"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//价格（分）")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String image;"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//商品图片")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String category;"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//分类名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String brand;"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//品牌名称")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String spec;"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//规格")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer status;"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//商品状态 1-正常，2-下架")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Date createTime;"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//创建时间")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Date updateTime;"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//更新时间")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TableField"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exist"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transient")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer stock;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TableField"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exist"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transient")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer sold;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[533]||(s[533]=i("h4",{id:"_5-3-4-编写监听器",tabindex:"-1"},[l("5.3.4 编写监听器 "),i("a",{class:"header-anchor",href:"#_5-3-4-编写监听器","aria-label":'Permalink to "5.3.4 编写监听器"'},"​")],-1)),s[534]||(s[534]=i("p",null,[l("通过实现"),i("code",null,"EntryHandler<T>"),l("接口编写监听器，监听Canal消息。注意两点：")],-1)),s[535]||(s[535]=i("ul",null,[i("li",null,[l("实现类通过"),i("code",null,'@CanalTable("tb_item")'),l("指定监听的表信息")]),i("li",null,"EntryHandler的泛型是与表对应的实体类")],-1)),s[536]||(s[536]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.canal;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.github.benmanes.caffeine.cache.Cache;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.config.RedisHandler;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.Item;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.annotation.Autowired;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," top.javatool.canal.client.annotation.CanalTable;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," top.javatool.canal.client.handler.EntryHandler;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CanalTable"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"tb_item"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ItemHandler"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," EntryHandler"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisHandler redisHandler;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> itemCache;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," insert"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Item "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写数据到JVM进程缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        itemCache."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), item);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写数据到redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisHandler."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveItem"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," update"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Item "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"before"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Item "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"after"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写数据到JVM进程缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        itemCache."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(after."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), after);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写数据到redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisHandler."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveItem"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(after);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," delete"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Item "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 删除数据到JVM进程缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        itemCache."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"invalidate"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 删除数据到redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisHandler."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"deleteItemById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),s[537]||(s[537]=i("p",null,"在这里对Redis的操作都封装到了RedisHandler这个对象中，是我们之前做缓存预热时编写的一个类，内容如下：",-1)),s[538]||(s[538]=i("div",{class:"language-java max-h-300px"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"java"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.config;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.fasterxml.jackson.core.JsonProcessingException;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.fasterxml.jackson.databind.ObjectMapper;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.Item;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.ItemStock;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.service.IItemService;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.service.IItemStockService;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.InitializingBean;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.annotation.Autowired;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.data.redis.core.StringRedisTemplate;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.List;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisHandler"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InitializingBean"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate redisTemplate;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemService itemService;")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemStockService stockService;")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectMapper MAPPER "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ObjectMapper"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," afterPropertiesSet"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 初始化缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.查询商品信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> itemList "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.放入缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Item item "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemList) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.1.item序列化为JSON")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAPPER."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.2.存入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), json);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.查询商品库存信息")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ItemStock"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> stockList "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockService."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.放入缓存")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ItemStock stock "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockList) {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.1.item序列化为JSON")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAPPER."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stock);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.2.存入redis")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:stock:id:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), json);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," saveItem"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Item "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"item"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAPPER."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), json);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (JsonProcessingException "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"}),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," deleteItemById"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long "),i("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisTemplate."),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"delete"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id);")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),l(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1))]),"main-header":k(()=>[n(a.$slots,"main-header")]),"main-header-after":k(()=>[n(a.$slots,"main-header-after")]),"main-nav":k(()=>[n(a.$slots,"main-nav")]),"main-content-before":k(()=>[n(a.$slots,"main-content-before")]),"main-content":k(()=>[n(a.$slots,"main-content")]),"main-content-after":k(()=>[n(a.$slots,"main-content-after")]),"main-nav-before":k(()=>[n(a.$slots,"main-nav-before")]),"main-nav-after":k(()=>[n(a.$slots,"main-nav-after")]),comment:k(()=>[n(a.$slots,"comment")]),footer:k(()=>[n(a.$slots,"footer")]),aside:k(()=>[n(a.$slots,"aside")]),"aside-custom":k(()=>[n(a.$slots,"aside-custom")]),default:k(()=>[n(a.$slots,"default")]),_:3},8,["frontmatter"])}}};export{K as default,f as usePageData};
