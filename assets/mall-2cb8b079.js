import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang-33cdb3de.js";import{_ as y,c as D,w as o,o as F,a as l,b as s,d as e,r as a,e as A,p as C}from"./app-05062f04.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-0952838b.js";import"./YunCard.vue_vue_type_style_index_0_lang-111bd468.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-35d95ae8.js";const Ur=JSON.parse('{"title":"mall项目总结","description":"基于微服务架构的商品贸易平台","frontmatter":{"cover":"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wallhaven-8oev1j_1920x1080.png","title":"mall项目总结","description":"基于微服务架构的商品贸易平台","top":200,"author":"imklaus","tags":["Spring Boot","Spring Cloud","Spring Cloud Alibaba","MySQL","MyBatis-Plus","Redis","RabbitMQ"],"categories":"Java","date":"2023-04-12T00:45:36.000Z","updated":"2023-04-16T12:16:05.000Z","outline":"deep"},"headers":[{"level":2,"title":"项目名称","slug":"项目名称","link":"#项目名称","children":[]},{"level":2,"title":"项目简介","slug":"项目简介","link":"#项目简介","children":[]},{"level":2,"title":"系统架构","slug":"系统架构","link":"#系统架构","children":[]},{"level":2,"title":"我的职责","slug":"我的职责","link":"#我的职责","children":[]},{"level":2,"title":"项目概述","slug":"项目概述","link":"#项目概述","children":[{"level":3,"title":"核心业务一：购物车","slug":"核心业务一：购物车","link":"#核心业务一：购物车","children":[]},{"level":3,"title":"核心业务二：订单","slug":"核心业务二：订单","link":"#核心业务二：订单","children":[]},{"level":3,"title":"项目难点","slug":"项目难点","link":"#项目难点","children":[]},{"level":3,"title":"解决问题","slug":"解决问题","link":"#解决问题","children":[]},{"level":3,"title":"项目优化","slug":"项目优化","link":"#项目优化","children":[]}]},{"level":2,"title":"CompletableFuture异步编排","slug":"completablefuture异步编排","link":"#completablefuture异步编排","children":[{"level":3,"title":"概念","slug":"概念","link":"#概念","children":[]},{"level":3,"title":"业务场景","slug":"业务场景","link":"#业务场景","children":[]},{"level":3,"title":"项目代码","slug":"项目代码","link":"#项目代码","children":[]}]},{"level":2,"title":"RabbitMQ延时队列（实现定时任务）","slug":"rabbitmq延时队列（实现定时任务）","link":"#rabbitmq延时队列（实现定时任务）","children":[{"level":3,"title":"场景：","slug":"场景：","link":"#场景：","children":[]},{"level":3,"title":"消息的TTL（Time To Live）","slug":"消息的ttl（time-to-live）","link":"#消息的ttl（time-to-live）","children":[]},{"level":3,"title":"Dead Letter Exchanges（DLX）","slug":"dead-letter-exchanges（dlx）","link":"#dead-letter-exchanges（dlx）","children":[]},{"level":3,"title":"延时队列实现","slug":"延时队列实现","link":"#延时队列实现","children":[]},{"level":3,"title":"SpringBoot中使用延时队列","slug":"springboot中使用延时队列","link":"#springboot中使用延时队列","children":[]},{"level":3,"title":"消息队列流程","slug":"消息队列流程","link":"#消息队列流程","children":[]}]},{"level":2,"title":"Redis缓存中的数据结构","slug":"redis缓存中的数据结构","link":"#redis缓存中的数据结构","children":[{"level":3,"title":"分类菜单","slug":"分类菜单","link":"#分类菜单","children":[]},{"level":3,"title":"登陆信息-SpringSession","slug":"登陆信息-springsession","link":"#登陆信息-springsession","children":[]},{"level":3,"title":"购物车","slug":"购物车","link":"#购物车","children":[]},{"level":3,"title":"秒杀上架 (幂等性处理)","slug":"秒杀上架-幂等性处理","link":"#秒杀上架-幂等性处理","children":[]},{"level":3,"title":"幂等性保证","slug":"幂等性保证","link":"#幂等性保证","children":[]},{"level":3,"title":"Redission分布式锁","slug":"redission分布式锁","link":"#redission分布式锁","children":[]}]},{"level":2,"title":"分布式事务","slug":"分布式事务","link":"#分布式事务","children":[{"level":3,"title":"事务的坑","slug":"事务的坑","link":"#事务的坑","children":[]},{"level":3,"title":"CAP理论","slug":"cap理论","link":"#cap理论","children":[]},{"level":3,"title":"BASE 理论","slug":"base-理论","link":"#base-理论","children":[]},{"level":3,"title":"分布式事务几种方案","slug":"分布式事务几种方案","link":"#分布式事务几种方案","children":[]}]},{"level":2,"title":"Seata","slug":"seata","link":"#seata","children":[{"level":3,"title":"Seata的理解","slug":"seata的理解","link":"#seata的理解","children":[]},{"level":3,"title":"Seata项目整合","slug":"seata项目整合","link":"#seata项目整合","children":[]}]},{"level":2,"title":"Sentinel","slug":"sentinel","link":"#sentinel","children":[{"level":3,"title":"Sentinel理解","slug":"sentinel理解","link":"#sentinel理解","children":[]},{"level":3,"title":"熔断降级限流","slug":"熔断降级限流","link":"#熔断降级限流","children":[]},{"level":3,"title":"项目整合步骤","slug":"项目整合步骤","link":"#项目整合步骤","children":[]},{"level":3,"title":"整合 Feign+Sentinel 测试熔断降级","slug":"整合-feign-sentinel-测试熔断降级","link":"#整合-feign-sentinel-测试熔断降级","children":[]}]},{"level":2,"title":"Nacos","slug":"nacos","link":"#nacos","children":[{"level":3,"title":"项目整合","slug":"项目整合","link":"#项目整合","children":[]},{"level":3,"title":"Nacos作为注册中心：","slug":"nacos作为注册中心：","link":"#nacos作为注册中心：","children":[]},{"level":3,"title":"Nacos作为配置中心","slug":"nacos作为配置中心","link":"#nacos作为配置中心","children":[]},{"level":3,"title":"Nacos进阶","slug":"nacos进阶","link":"#nacos进阶","children":[]}]},{"level":2,"title":"Gateway","slug":"gateway","link":"#gateway","children":[]},{"level":2,"title":"Feign","slug":"feign","link":"#feign","children":[{"level":3,"title":"Feign远程调用丢失请求头问题","slug":"feign远程调用丢失请求头问题","link":"#feign远程调用丢失请求头问题","children":[]},{"level":3,"title":"Feign异步情况丢失上下文问题","slug":"feign异步情况丢失上下文问题","link":"#feign异步情况丢失上下文问题","children":[]}]},{"level":2,"title":"SpringCloud Alibaba 常用组件端口号总结","slug":"springcloud-alibaba-常用组件端口号总结","link":"#springcloud-alibaba-常用组件端口号总结","children":[]},{"level":2,"title":"支付","slug":"支付","link":"#支付","children":[{"level":3,"title":"加密-对称加密","slug":"加密-对称加密","link":"#加密-对称加密","children":[]},{"level":3,"title":"加密-非对称加密","slug":"加密-非对称加密","link":"#加密-非对称加密","children":[]},{"level":3,"title":"支付宝验签","slug":"支付宝验签","link":"#支付宝验签","children":[]},{"level":3,"title":"收单","slug":"收单","link":"#收单","children":[]}]},{"level":2,"title":"MD5&MD5盐值加密","slug":"md5-md5盐值加密","link":"#md5-md5盐值加密","children":[]},{"level":2,"title":"项目微服务","slug":"项目微服务","link":"#项目微服务","children":[]},{"level":2,"title":"Nginx+Windows搭建域名访问环境","slug":"nginx-windows搭建域名访问环境","link":"#nginx-windows搭建域名访问环境","children":[{"level":3,"title":"域名映射效果","slug":"域名映射效果","link":"#域名映射效果","children":[]},{"level":3,"title":"正向代理与反向代理","slug":"正向代理与反向代理","link":"#正向代理与反向代理","children":[]},{"level":3,"title":"Nginx配置文件","slug":"nginx配置文件","link":"#nginx配置文件","children":[]},{"level":3,"title":"Nginx动静分离","slug":"nginx动静分离","link":"#nginx动静分离","children":[]},{"level":3,"title":"Nginx转发效果","slug":"nginx转发效果","link":"#nginx转发效果","children":[]}]},{"level":2,"title":"内网穿透","slug":"内网穿透","link":"#内网穿透","children":[{"level":3,"title":"内网穿透联调","slug":"内网穿透联调","link":"#内网穿透联调","children":[]},{"level":3,"title":"配置","slug":"配置","link":"#配置","children":[]}]},{"level":2,"title":"缓存","slug":"缓存","link":"#缓存","children":[{"level":3,"title":"本地缓存","slug":"本地缓存","link":"#本地缓存","children":[]},{"level":3,"title":"分布式缓存-本地模式在分布式下的问题","slug":"分布式缓存-本地模式在分布式下的问题","link":"#分布式缓存-本地模式在分布式下的问题","children":[]},{"level":3,"title":"分布式缓存","slug":"分布式缓存","link":"#分布式缓存","children":[]},{"level":3,"title":"分布式下如何加锁？","slug":"分布式下如何加锁？","link":"#分布式下如何加锁？","children":[]},{"level":3,"title":"锁-时序问题","slug":"锁-时序问题","link":"#锁-时序问题","children":[]},{"level":3,"title":"分布式锁演进-基本原理","slug":"分布式锁演进-基本原理","link":"#分布式锁演进-基本原理","children":[]},{"level":3,"title":"缓存数据一致性-双写模式","slug":"缓存数据一致性-双写模式","link":"#缓存数据一致性-双写模式","children":[]},{"level":3,"title":"缓存数据一致性-失效模式","slug":"缓存数据一致性-失效模式","link":"#缓存数据一致性-失效模式","children":[]},{"level":3,"title":"缓存数据一致性-解决方案","slug":"缓存数据一致性-解决方案","link":"#缓存数据一致性-解决方案","children":[]},{"level":3,"title":"缓存数据一致性-解决-Canal","slug":"缓存数据一致性-解决-canal","link":"#缓存数据一致性-解决-canal","children":[]}]},{"level":2,"title":"Session共享问题","slug":"session共享问题","link":"#session共享问题","children":[{"level":3,"title":"session原理","slug":"session原理","link":"#session原理","children":[]},{"level":3,"title":"分布式下session共享问题","slug":"分布式下session共享问题","link":"#分布式下session共享问题","children":[]},{"level":3,"title":"解决-session复制","slug":"解决-session复制","link":"#解决-session复制","children":[]},{"level":3,"title":"解决-客户端存储","slug":"解决-客户端存储","link":"#解决-客户端存储","children":[]},{"level":3,"title":"解决-hash一致性","slug":"解决-hash一致性","link":"#解决-hash一致性","children":[]},{"level":3,"title":"解决-统一存储","slug":"解决-统一存储","link":"#解决-统一存储","children":[]},{"level":3,"title":"解决-不同服务，子域session共享","slug":"解决-不同服务，子域session共享","link":"#解决-不同服务，子域session共享","children":[]},{"level":3,"title":"SpringSession核心原理","slug":"springsession核心原理","link":"#springsession核心原理","children":[]}]},{"level":2,"title":"购物车","slug":"购物车-1","link":"#购物车-1","children":[{"level":3,"title":"购物车数据结构","slug":"购物车数据结构","link":"#购物车数据结构","children":[]}]},{"level":2,"title":"消息队列RabbitMQ","slug":"消息队列rabbitmq","link":"#消息队列rabbitmq","children":[{"level":3,"title":"RabbitMQ概念","slug":"rabbitmq概念","link":"#rabbitmq概念","children":[]},{"level":3,"title":"什么AMQP协议","slug":"什么amqp协议","link":"#什么amqp协议","children":[]},{"level":3,"title":"AMQP的核心概念","slug":"amqp的核心概念","link":"#amqp的核心概念","children":[]},{"level":3,"title":"RabbitMq的消息是如何流转的？","slug":"rabbitmq的消息是如何流转的？","link":"#rabbitmq的消息是如何流转的？","children":[]},{"level":3,"title":"RabbitMq 交换机详解","slug":"rabbitmq-交换机详解","link":"#rabbitmq-交换机详解","children":[]},{"level":3,"title":"队列、绑定主机、消息","slug":"队列、绑定主机、消息","link":"#队列、绑定主机、消息","children":[]}]}],"relativePath":"pages/posts/mall.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-blog\\\\imklaus.github.io-main\\\\pages\\\\posts\\\\mall.md","lastUpdated":null}'),c=JSON.parse('{"title":"mall项目总结","description":"基于微服务架构的商品贸易平台","frontmatter":{"cover":"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/wallhaven-8oev1j_1920x1080.png","title":"mall项目总结","description":"基于微服务架构的商品贸易平台","top":200,"author":"imklaus","tags":["Spring Boot","Spring Cloud","Spring Cloud Alibaba","MySQL","MyBatis-Plus","Redis","RabbitMQ"],"categories":"Java","date":"2023-04-12T00:45:36.000Z","updated":"2023-04-16T12:16:05.000Z","outline":"deep"},"headers":[{"level":2,"title":"项目名称","slug":"项目名称","link":"#项目名称","children":[]},{"level":2,"title":"项目简介","slug":"项目简介","link":"#项目简介","children":[]},{"level":2,"title":"系统架构","slug":"系统架构","link":"#系统架构","children":[]},{"level":2,"title":"我的职责","slug":"我的职责","link":"#我的职责","children":[]},{"level":2,"title":"项目概述","slug":"项目概述","link":"#项目概述","children":[{"level":3,"title":"核心业务一：购物车","slug":"核心业务一：购物车","link":"#核心业务一：购物车","children":[]},{"level":3,"title":"核心业务二：订单","slug":"核心业务二：订单","link":"#核心业务二：订单","children":[]},{"level":3,"title":"项目难点","slug":"项目难点","link":"#项目难点","children":[]},{"level":3,"title":"解决问题","slug":"解决问题","link":"#解决问题","children":[]},{"level":3,"title":"项目优化","slug":"项目优化","link":"#项目优化","children":[]}]},{"level":2,"title":"CompletableFuture异步编排","slug":"completablefuture异步编排","link":"#completablefuture异步编排","children":[{"level":3,"title":"概念","slug":"概念","link":"#概念","children":[]},{"level":3,"title":"业务场景","slug":"业务场景","link":"#业务场景","children":[]},{"level":3,"title":"项目代码","slug":"项目代码","link":"#项目代码","children":[]}]},{"level":2,"title":"RabbitMQ延时队列（实现定时任务）","slug":"rabbitmq延时队列（实现定时任务）","link":"#rabbitmq延时队列（实现定时任务）","children":[{"level":3,"title":"场景：","slug":"场景：","link":"#场景：","children":[]},{"level":3,"title":"消息的TTL（Time To Live）","slug":"消息的ttl（time-to-live）","link":"#消息的ttl（time-to-live）","children":[]},{"level":3,"title":"Dead Letter Exchanges（DLX）","slug":"dead-letter-exchanges（dlx）","link":"#dead-letter-exchanges（dlx）","children":[]},{"level":3,"title":"延时队列实现","slug":"延时队列实现","link":"#延时队列实现","children":[]},{"level":3,"title":"SpringBoot中使用延时队列","slug":"springboot中使用延时队列","link":"#springboot中使用延时队列","children":[]},{"level":3,"title":"消息队列流程","slug":"消息队列流程","link":"#消息队列流程","children":[]}]},{"level":2,"title":"Redis缓存中的数据结构","slug":"redis缓存中的数据结构","link":"#redis缓存中的数据结构","children":[{"level":3,"title":"分类菜单","slug":"分类菜单","link":"#分类菜单","children":[]},{"level":3,"title":"登陆信息-SpringSession","slug":"登陆信息-springsession","link":"#登陆信息-springsession","children":[]},{"level":3,"title":"购物车","slug":"购物车","link":"#购物车","children":[]},{"level":3,"title":"秒杀上架 (幂等性处理)","slug":"秒杀上架-幂等性处理","link":"#秒杀上架-幂等性处理","children":[]},{"level":3,"title":"幂等性保证","slug":"幂等性保证","link":"#幂等性保证","children":[]},{"level":3,"title":"Redission分布式锁","slug":"redission分布式锁","link":"#redission分布式锁","children":[]}]},{"level":2,"title":"分布式事务","slug":"分布式事务","link":"#分布式事务","children":[{"level":3,"title":"事务的坑","slug":"事务的坑","link":"#事务的坑","children":[]},{"level":3,"title":"CAP理论","slug":"cap理论","link":"#cap理论","children":[]},{"level":3,"title":"BASE 理论","slug":"base-理论","link":"#base-理论","children":[]},{"level":3,"title":"分布式事务几种方案","slug":"分布式事务几种方案","link":"#分布式事务几种方案","children":[]}]},{"level":2,"title":"Seata","slug":"seata","link":"#seata","children":[{"level":3,"title":"Seata的理解","slug":"seata的理解","link":"#seata的理解","children":[]},{"level":3,"title":"Seata项目整合","slug":"seata项目整合","link":"#seata项目整合","children":[]}]},{"level":2,"title":"Sentinel","slug":"sentinel","link":"#sentinel","children":[{"level":3,"title":"Sentinel理解","slug":"sentinel理解","link":"#sentinel理解","children":[]},{"level":3,"title":"熔断降级限流","slug":"熔断降级限流","link":"#熔断降级限流","children":[]},{"level":3,"title":"项目整合步骤","slug":"项目整合步骤","link":"#项目整合步骤","children":[]},{"level":3,"title":"整合 Feign+Sentinel 测试熔断降级","slug":"整合-feign-sentinel-测试熔断降级","link":"#整合-feign-sentinel-测试熔断降级","children":[]}]},{"level":2,"title":"Nacos","slug":"nacos","link":"#nacos","children":[{"level":3,"title":"项目整合","slug":"项目整合","link":"#项目整合","children":[]},{"level":3,"title":"Nacos作为注册中心：","slug":"nacos作为注册中心：","link":"#nacos作为注册中心：","children":[]},{"level":3,"title":"Nacos作为配置中心","slug":"nacos作为配置中心","link":"#nacos作为配置中心","children":[]},{"level":3,"title":"Nacos进阶","slug":"nacos进阶","link":"#nacos进阶","children":[]}]},{"level":2,"title":"Gateway","slug":"gateway","link":"#gateway","children":[]},{"level":2,"title":"Feign","slug":"feign","link":"#feign","children":[{"level":3,"title":"Feign远程调用丢失请求头问题","slug":"feign远程调用丢失请求头问题","link":"#feign远程调用丢失请求头问题","children":[]},{"level":3,"title":"Feign异步情况丢失上下文问题","slug":"feign异步情况丢失上下文问题","link":"#feign异步情况丢失上下文问题","children":[]}]},{"level":2,"title":"SpringCloud Alibaba 常用组件端口号总结","slug":"springcloud-alibaba-常用组件端口号总结","link":"#springcloud-alibaba-常用组件端口号总结","children":[]},{"level":2,"title":"支付","slug":"支付","link":"#支付","children":[{"level":3,"title":"加密-对称加密","slug":"加密-对称加密","link":"#加密-对称加密","children":[]},{"level":3,"title":"加密-非对称加密","slug":"加密-非对称加密","link":"#加密-非对称加密","children":[]},{"level":3,"title":"支付宝验签","slug":"支付宝验签","link":"#支付宝验签","children":[]},{"level":3,"title":"收单","slug":"收单","link":"#收单","children":[]}]},{"level":2,"title":"MD5&MD5盐值加密","slug":"md5-md5盐值加密","link":"#md5-md5盐值加密","children":[]},{"level":2,"title":"项目微服务","slug":"项目微服务","link":"#项目微服务","children":[]},{"level":2,"title":"Nginx+Windows搭建域名访问环境","slug":"nginx-windows搭建域名访问环境","link":"#nginx-windows搭建域名访问环境","children":[{"level":3,"title":"域名映射效果","slug":"域名映射效果","link":"#域名映射效果","children":[]},{"level":3,"title":"正向代理与反向代理","slug":"正向代理与反向代理","link":"#正向代理与反向代理","children":[]},{"level":3,"title":"Nginx配置文件","slug":"nginx配置文件","link":"#nginx配置文件","children":[]},{"level":3,"title":"Nginx动静分离","slug":"nginx动静分离","link":"#nginx动静分离","children":[]},{"level":3,"title":"Nginx转发效果","slug":"nginx转发效果","link":"#nginx转发效果","children":[]}]},{"level":2,"title":"内网穿透","slug":"内网穿透","link":"#内网穿透","children":[{"level":3,"title":"内网穿透联调","slug":"内网穿透联调","link":"#内网穿透联调","children":[]},{"level":3,"title":"配置","slug":"配置","link":"#配置","children":[]}]},{"level":2,"title":"缓存","slug":"缓存","link":"#缓存","children":[{"level":3,"title":"本地缓存","slug":"本地缓存","link":"#本地缓存","children":[]},{"level":3,"title":"分布式缓存-本地模式在分布式下的问题","slug":"分布式缓存-本地模式在分布式下的问题","link":"#分布式缓存-本地模式在分布式下的问题","children":[]},{"level":3,"title":"分布式缓存","slug":"分布式缓存","link":"#分布式缓存","children":[]},{"level":3,"title":"分布式下如何加锁？","slug":"分布式下如何加锁？","link":"#分布式下如何加锁？","children":[]},{"level":3,"title":"锁-时序问题","slug":"锁-时序问题","link":"#锁-时序问题","children":[]},{"level":3,"title":"分布式锁演进-基本原理","slug":"分布式锁演进-基本原理","link":"#分布式锁演进-基本原理","children":[]},{"level":3,"title":"缓存数据一致性-双写模式","slug":"缓存数据一致性-双写模式","link":"#缓存数据一致性-双写模式","children":[]},{"level":3,"title":"缓存数据一致性-失效模式","slug":"缓存数据一致性-失效模式","link":"#缓存数据一致性-失效模式","children":[]},{"level":3,"title":"缓存数据一致性-解决方案","slug":"缓存数据一致性-解决方案","link":"#缓存数据一致性-解决方案","children":[]},{"level":3,"title":"缓存数据一致性-解决-Canal","slug":"缓存数据一致性-解决-canal","link":"#缓存数据一致性-解决-canal","children":[]}]},{"level":2,"title":"Session共享问题","slug":"session共享问题","link":"#session共享问题","children":[{"level":3,"title":"session原理","slug":"session原理","link":"#session原理","children":[]},{"level":3,"title":"分布式下session共享问题","slug":"分布式下session共享问题","link":"#分布式下session共享问题","children":[]},{"level":3,"title":"解决-session复制","slug":"解决-session复制","link":"#解决-session复制","children":[]},{"level":3,"title":"解决-客户端存储","slug":"解决-客户端存储","link":"#解决-客户端存储","children":[]},{"level":3,"title":"解决-hash一致性","slug":"解决-hash一致性","link":"#解决-hash一致性","children":[]},{"level":3,"title":"解决-统一存储","slug":"解决-统一存储","link":"#解决-统一存储","children":[]},{"level":3,"title":"解决-不同服务，子域session共享","slug":"解决-不同服务，子域session共享","link":"#解决-不同服务，子域session共享","children":[]},{"level":3,"title":"SpringSession核心原理","slug":"springsession核心原理","link":"#springsession核心原理","children":[]}]},{"level":2,"title":"购物车","slug":"购物车-1","link":"#购物车-1","children":[{"level":3,"title":"购物车数据结构","slug":"购物车数据结构","link":"#购物车数据结构","children":[]}]},{"level":2,"title":"消息队列RabbitMQ","slug":"消息队列rabbitmq","link":"#消息队列rabbitmq","children":[{"level":3,"title":"RabbitMQ概念","slug":"rabbitmq概念","link":"#rabbitmq概念","children":[]},{"level":3,"title":"什么AMQP协议","slug":"什么amqp协议","link":"#什么amqp协议","children":[]},{"level":3,"title":"AMQP的核心概念","slug":"amqp的核心概念","link":"#amqp的核心概念","children":[]},{"level":3,"title":"RabbitMq的消息是如何流转的？","slug":"rabbitmq的消息是如何流转的？","link":"#rabbitmq的消息是如何流转的？","children":[]},{"level":3,"title":"RabbitMq 交换机详解","slug":"rabbitmq-交换机详解","link":"#rabbitmq-交换机详解","children":[]},{"level":3,"title":"队列、绑定主机、消息","slug":"队列、绑定主机、消息","link":"#队列、绑定主机、消息","children":[]}]}],"relativePath":"pages/posts/mall.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-blog\\\\imklaus.github.io-main\\\\pages\\\\posts\\\\mall.md","lastUpdated":null}'),u={name:"pages/posts/mall.md",data(){return{data:c,frontmatter:c.frontmatter}},setup(){C("pageData",c)}},d=l("p",null,"My name is klaus,I enjoy studying Java",-1),g={id:"项目总结",tabindex:"-1"},h=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230315150052611.png",alt:"mall"})],-1),m=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230315145952769.png",alt:"mall"})],-1),E={id:"项目名称",tabindex:"-1"},f=l("ul",null,[l("li",null,"书阁”图书商城管理系统、微盟电子商城网络交易系统、高校闲置资源交易系统"),l("li",null,"购物在“e”零售商城平台、惠农通—智慧农资商城 、农产品轻量级微商城系统"),l("li",null,"精美鞋业贸易系统")],-1),_={id:"项目简介",tabindex:"-1"},k=l("ul",null,[l("li",null,"本系统采用微服务架构设计，在分布式环境下利用Spring Cloud框架，通过业务划分，设计独立模块的微服务，拆分为订单服务、购物车服务、支付服务、用户管理服务、商品管理服务、文件上传服务等模块，结合了当前比较流行的互联网电商模式，为消费者提供商品贸易平台。")],-1),b={id:"系统架构",tabindex:"-1"},S=l("ul",null,[l("li",null,"该系用采用SpringCloud架构，利用SpringBoot构建应用，Nacos作为服务的注册、配置中心，OpenFeign实现与其他模块进行交互，Sentinel实现熔断降级和错误处理，Seata分布式事务解决方案，Gateway作为服务网关，Sleuth链路追踪，RabbitMQ实现延迟队列，Redis作为缓存解决读多写少的场景，MySQL进行持久化，MyBatisPlus作为持久化框架。")],-1),v={id:"我的职责",tabindex:"-1"},x=l("ul",null,[l("li",null,[s("完成平台"),l("strong",null,"商品、购物车、订单、库存、优惠券、支付、文件上传"),s("等服务模块的接口开发；")]),l("li",null,[s("使用"),l("strong",null,"RabbitMQ延时队列"),s("实现未付款订单，超过一定时间后，"),l("strong",null,"系统自动取消订单并解锁库存；")]),l("li",null,[s("使用"),l("strong",null,"redis+lua脚本"),s("防止重复提交攻击，"),l("strong",null,"解决了用户利用浏览器刷新和回退重复提交订单的问题；")]),l("li",null,[s("基于"),l("strong",null,"Redisson分布式限流：Semaphore信号量"),s("实现"),l("strong",null,"秒杀和一人一单功能"),s("，通过逐步"),l("strong",null,"改进分布式锁"),s("的方案，"),l("strong",null,"解决在多线程情况下用户重复提交订单的幂等性问题；")]),l("li",null,[s("基于 "),l("strong",null,"Token"),s(" 的认证授权机制："),l("strong",null,"JWT"),s("，通过对登录用户颁发登录凭证，"),l("strong",null,"实现登录模块认证授权功能；")]),l("li",null,[s("使用"),l("strong",null,"ElasticSearch分布式全文搜索引擎"),s("，对冷数据，商品信息数据"),l("strong",null,"建立索引"),s("，"),l("strong",null,"保证冷数据，商品数据的查询性能；")]),l("li",null,[s("利用"),l("strong",null,"Jmeter工具"),s("进行压测，找到在"),l("strong",null,"多线程"),s("情况下造成的"),l("strong",null,"内存泄漏，并发与同步"),s("等问题，"),l("strong",null,"保证了系统在线上的处理能力和稳定性维持在一个标准范围内；")]),l("li",null,[s("使用"),l("strong",null,"Redis"),s("进行"),l("strong",null,"热点信息缓存"),s("，比如附近购物车信息和登录信息,"),l("strong",null,"提高服务器的性能"),s("；")]),l("li",null,[s("使用"),l("strong",null,"Spring Schedule定时任务"),s("提前上架抢购商品信息到Redis缓存中实现"),l("strong",null,"库存预热功能")]),l("li",null,[s("使用"),l("strong",null,"Redisson分布式锁"),s("解决分布式系统下商品重复上架的"),l("strong",null,"幂等性问题"),s("；")]),l("li",null,[s("使用"),l("strong",null,"Spring Cache方法级别缓存技术"),s("，实现已经被调用过的指定的目标方法，直接从缓存中获取方法调用后的结果返回，"),l("strong",null,"提高系统的响应速度；")]),l("li",null,[s("使用"),l("strong",null,"CompletableFuture 异步编排"),s("解决查询商品详情⻚"),l("strong",null,"响应速度慢的问题"),s("；")]),l("li",null,[s("使用"),l("strong",null,"Nacos作为注册中心与配置中心"),s("，将服务名称及其对应地址进行存储，实现服务地址的"),l("strong",null,"注册与发现"),s("以及"),l("strong",null,"配置动态加载"),s("等功能")]),l("li",null,[s("使用"),l("strong",null,"Seata中的TCC事务模式"),s("，把一个完整的业务逻辑拆分成三个阶段,通过事务管理器进行管理，"),l("strong",null,"保证分布式系统数据一致性问题；")]),l("li",null,[s("整合"),l("strong",null,"第三方文件上传服务"),s("，如阿里云对象存储，基于服务端签名后直传，"),l("strong",null,"保证文件传输的安全性"),s("；")]),l("li",null,[s("整合"),l("strong",null,"OAuth2.0协议授权"),s("，使用AccessToken调用开发API获取用户信息，"),l("strong",null,"支持微信、QQ、微博、Gitee、Github等第三方登陆；")]),l("li",null,[s("使用"),l("strong",null,"RSA算法保证数据加密安全"),s("，成功对接第三方支付功能，订单付款支持"),l("strong",null,"支付宝、微信支付"),s("等第三方支付服务。")])],-1),I=l("p",null,"1、梳理自己项目的难点或亮点是什么？ 2、项目中，为什么用 xx 技术点，用 yy 的可以吗？或者为什么这么设计？",-1),T=l("p",null,"关于第一点，这个内容即使面试官没问，我们也可以在自我介绍时候表述出来。",-1),L=l("p",null,"如果你觉得自己的项目的确没什么厉害的东西，都是业务的 curd。那就挑一个值得说过的优化，或者设计方案也行。",-1),O=l("p",null,"毕竟高大上的东西的确只有少数人接触到，都是理解的。",-1),R=l("p",null,"接下来关于第二点，目的是考察你对自己项目的理解是不是真的知其所以然，还是说自己只是一个无情的 curd 机器。",-1),w=l("p",null,"项目切入点:分布式锁的实现、分布式Session、分布式缓存、缓存一致性、跨域、异步编排等，重点把握秒杀模块和 订单模块的设计及流程",-1),q={id:"项目概述",tabindex:"-1"},M=l("p",null,"​ 本系统是专门为精美鞋业有限公司制定的对外贸易系统，大部分商品出售给越南地区，供那边的厂商进行二次加工。 ​ 本系统采用微服务架构设计，在分布式环境下利用Spring Cloud框架，通过业务划分，设计独立模块的微服务，拆分为订单服务、购物车服务、支付服务、用户管理服务、商品管理服务、文件上传服务等模块，为客户提供半成品商品贸易平台。",-1),B={id:"核心业务一：购物车",tabindex:"-1"},V=l("ul",null,[l("li",null,[l("p",null,"购物车Redis数据结构选型："),l("ul",null,[l("li",null,[l("p",null,"双层 Map：Map<String,Map<String,String>>"),l("ul",null,[l("li",null,[l("p",null,"第一层 Map，Key 是用户 id")]),l("li",null,[l("p",null,"第二层 Map，Key 是购物车中商品 id，值是购物项数据")])])])])]),l("li",null,[l("p",null,"购物车两个核心功能：新增商品到购物车、查询购物车"),l("ul",null,[l("li",null,[l("p",null,"新增商品：判断是否登录"),l("ul",null,[l("li",null,"是：则添加商品到后台 Redis 中，把 user 的唯一标识符作为 key。"),l("li",null,"否：则添加商品到后台 Redis 中，使用随机生成的 user-key 作为 key。")])])])]),l("li",null,[l("p",null,"查询购物车列表：判断是否登录"),l("ul",null,[l("li",null,"否：直接根据 user-key 查询 Redis 中数据并展示"),l("li",null,"是：已登录，则需要先根据 user-key 查询 Redis 是否有数据。"),l("li",null,"有：需要提交到后台添加到 Redis ，合并数据，而后查询。"),l("li",null,"否：直接去后台查询 Redis ，而后返回")])])],-1),P={id:"核心业务二：订单",tabindex:"-1"},K={id:"订单中心",tabindex:"-1"},N=l("ul",null,[l("li",null,"电商系统涉及到 3 流，分别时信息流，资金流，物流，而订单系统作为中枢将三者有机的集 合起来。"),l("li",null,"订单模块是电商系统的枢纽，在订单这个环节上需求获取多个模块的数据和信息，同时对这 些信息进行加工处理后流向下个环节，这一系列就构成了订单的信息流通。")],-1),W={id:"订单构成",tabindex:"-1"},j=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410153419456.png",alt:"mall"})],-1),Q={id:"订单状态",tabindex:"-1"},H=l("ol",null,[l("li",null,[s("待付款 "),l("ul",null,[l("li",null,"用户提交订单后，订单进行预下单，目前主流电商网站都会唤起支付，便于用户快速完成支 付，需要注意的是待付款状态下可以对库存进行锁定，锁定库存需要配置支付超时时间，超 时后将自动取消订单，订单变更关闭状态。")])]),l("li",null,[s("已付款/ 待发货 "),l("ul",null,[l("li",null,"用户完成订单支付，订单系统需要记录支付时间，支付流水单号便于对账，订单下放到 WMS 系统，仓库进行调拨，配货，分拣，出库等操作。")])]),l("li",null,[s("待收货/ 已发货 "),l("ul",null,[l("li",null,"仓储将商品出库后，订单进入物流环节，订单系统需要同步物流信息，便于用户实时知悉物 品物流状态")])]),l("li",null,[s("已完成 "),l("ul",null,[l("li",null,"用户确认收货后，订单交易完成。后续支付侧进行结算，如果订单存在问题进入售后状态")])]),l("li",null,[s("已取消 "),l("ul",null,[l("li",null,"付款之前取消订单。包括超时未付款或用户商户取消订单都会产生这种订单状态。")])])],-1),U={id:"订单流程",tabindex:"-1"},G=l("ul",null,[l("li",null,"正常的网购步骤：订单生成–>支付订单–>卖家发货–>确认收货–>交易成功")],-1),z={id:"_1-订单创建与支付",tabindex:"-1"},$=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403130800413.png",alt:"mall"})],-1),J=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.web.OrderWebController#submitOrder")])],-1),X=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     /**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"vo"),l("span",{style:{color:"#676E95","font-style":"italic"}}," 上一个页面携带的数据")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"model")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"redirectAttributes")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"PostMapping"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/submitOrder"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"submitOrder"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"OrderSubmitVo"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Model"),l("span",{style:{color:"#A6ACCD"}}," model"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"RedirectAttributes"),l("span",{style:{color:"#A6ACCD"}}," redirectAttributes"),l("span",{style:{color:"#89DDFF"}},"){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//捕获异常")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"try"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"SubmitOrderResponseVo"),l("span",{style:{color:"#A6ACCD"}}," responseVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"submitOrder"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//下单：去创建订单，验令牌，验价格，锁库存....")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"订单提交的数据..."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"responseVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCode"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#89DDFF"}},"){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//下单成功来到支付选择页")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            model"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"addAttribute"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"submitOrderResponse"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," responseVo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"pay"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//下单失败重定向到订单确认页")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," msg "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"下单失败："),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"switch"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"responseVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCode"),l("span",{style:{color:"#89DDFF"}},"()){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"case"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},":"),l("span",{style:{color:"#A6ACCD"}}," msg"),l("span",{style:{color:"#89DDFF"}},"+="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"订单信息过期，请刷新再次提交"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"break"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"case"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"2"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},":"),l("span",{style:{color:"#A6ACCD"}}," msg"),l("span",{style:{color:"#89DDFF"}},"+="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"订单商品价格发生了变化，请刷新再次提交"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"break"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"case"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"3"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},":"),l("span",{style:{color:"#A6ACCD"}}," msg"),l("span",{style:{color:"#89DDFF"}},"+="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"库存锁定失败，商品库存不足"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"break"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            redirectAttributes"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"addFlashAttribute"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"msg"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," msg"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"redirect:http://order.gulimall.com/toTrade"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"catch"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Exception"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"e"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"e "),l("span",{style:{color:"#89DDFF"}},"instanceof"),l("span",{style:{color:"#A6ACCD"}}," NoStockException"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," message "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"(("),l("span",{style:{color:"#A6ACCD"}},"NoStockException"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," e"),l("span",{style:{color:"#89DDFF"}},")."),l("span",{style:{color:"#82AAFF"}},"getMessage"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},'//抛出无库存异常后页面显示此异常信息NO_STOCK_EXCEPTION(21000, "商品库存不足");')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            redirectAttributes"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"addFlashAttribute"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"msg"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," message"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//抛出任何异常后重定向会订单确认页")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"redirect:http://order.gulimall.com/toTrade"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"})])])],-1),Y=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#submitOrder")])],-1),Z=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," /**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 下单")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 加入统一事务")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"vo")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * @Transactional 本地事务，在分布式系统下，只能控制自己的回滚，控制不了其他服务的回滚")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * (isolation = Isolation.REPEATABLE_READ)默认隔离级别")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * ->分布式事务: 最大原因是网络问题+分布式机器")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//@GlobalTransactional 高并发 此注解会加很多全局锁，导致下单只能等别人先下完单才能下，高并发环境不可取")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Transactional")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"SubmitOrderResponseVo"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"submitOrder"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"OrderSubmitVo"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        submitVoThreadLocal"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"set"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"SubmitOrderResponseVo"),l("span",{style:{color:"#A6ACCD"}}," responseVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"SubmitOrderResponseVo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//从拦截器里获取用户信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"MemberRespVo"),l("span",{style:{color:"#A6ACCD"}}," memberRespVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," LoginUserInterceptor"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"loginUser"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"get"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        responseVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setCode"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、验证令牌【令牌的对比和删除必须保证原子性】")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//0令牌失败 - 1删除成功(校验成功)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," script "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," orderToken "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderToken"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//原子验证令牌和删除令牌")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," result "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," redisTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"execute"),l("span",{style:{color:"#89DDFF"}},"(")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//脚本返回类型->0,1")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"DefaultRedisScript"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#89DDFF"}},">("),l("span",{style:{color:"#A6ACCD"}},"script"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," Long"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"class"),l("span",{style:{color:"#89DDFF"}},"),")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//将缓存中将要比对的key转为集合")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                Arrays"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"asList"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"OrderConstant"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"USER_ORDER_TOKEN_PREFIX "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," memberRespVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"()),")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//传入要校验的值")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                orderToken"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"result "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"0L"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//验证失败，设置错误状态码为1，key过期等情况")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            responseVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setCode"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," responseVo"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//验证成功")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//下单：去创建订单，验令牌，验价格，锁库存....")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、创建订单，订单项等信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"OrderCreateTo"),l("span",{style:{color:"#A6ACCD"}}," order "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"createOrder"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// todo 观察者模式: 发布商品下单事件")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            ApplicationContextHolder"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getInstance"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"publishEvent"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"OrderCreateEvent"),l("span",{style:{color:"#89DDFF"}},"(this,"),l("span",{style:{color:"#A6ACCD"}}," order"),l("span",{style:{color:"#89DDFF"}},"));")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//2、验价，拿到应付金额与页面提交的金额进行校验")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"BigDecimal"),l("span",{style:{color:"#A6ACCD"}}," payAmount "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," order"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrder"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getPayAmount"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"BigDecimal"),l("span",{style:{color:"#A6ACCD"}}," payPrice "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getPayPrice"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//两者相减的绝对值小于0.01就算校验通过")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"Math"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"abs"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"payAmount"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"subtract"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"payPrice"),l("span",{style:{color:"#89DDFF"}},")."),l("span",{style:{color:"#82AAFF"}},"doubleValue"),l("span",{style:{color:"#89DDFF"}},"())"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"0.01"),l("span",{style:{color:"#89DDFF"}},"){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//校验通过")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//TODO 3、保存订单")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#82AAFF"}},"saveOrder"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"order"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//4、库存锁定，这样能避免库存不足等现象发生")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//只要有异常就回滚订单数据(订单号，所有订单项（skuId，skuName，num）)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#C792EA"}},"WareSkuLockVo"),l("span",{style:{color:"#A6ACCD"}}," lockVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"WareSkuLockVo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//设置指定库存的订单号")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                lockVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setOrderSn"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"order"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrder"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getOrderSn"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderItemVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," locks "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," order"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderItems"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"stream"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"map"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"item "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    "),l("span",{style:{color:"#C792EA"}},"OrderItemVo"),l("span",{style:{color:"#A6ACCD"}}," orderItemVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"OrderItemVo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//订单已经保存了，可以直接设置")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    orderItemVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setSkuId"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"item"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    orderItemVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setCount"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"item"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuQuantity"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    orderItemVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setTitle"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"item"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuName"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," orderItemVo"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},"})."),l("span",{style:{color:"#82AAFF"}},"collect"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"Collectors"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"toList"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//锁定订单项数据")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                lockVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setLocks"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"locks"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//todo 4、远程锁库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//库存锁定成功了，但是网络原因超时了，订单回滚，库存不回滚")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//为了保证高并发，库存服务自己回滚，可以发消息给库存服务")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//库存服务本身也可以使用自动解锁模式->消息队列")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," r "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wmsFeignService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"orderLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"lockVo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//判断远程调用是否成功")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"r"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCode"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#89DDFF"}},"){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//远程调用成功，锁成功了")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    responseVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setOrder"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"order"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrder"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}}," "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//todo 5、远程扣减积分  出异常 引入seata后业务标注@GlobalTransactional订单回滚，库存回滚")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"					"),l("span",{style:{color:"#676E95","font-style":"italic"}},"// int i = 10/0;//不标注@GlobalTransactional 订单回滚，库存不回滚")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//todo 订单创建成功发送消息给MQ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    rabbitTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"convertAndSend"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order.create.order"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," order"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrder"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," responseVo"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//远程调用失败，锁定失败")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//锁定失败")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," msg "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"String"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," r"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"get"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"msg"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//抛出异常就不能设置错误状态码了")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"NoStockException"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"msg"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//                    responseVo.setCode(3);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//                    return responseVo;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//校验失败")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                responseVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setCode"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#F78C6C"}},"2"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," responseVo"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),ll=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#createOrder")])],-1),sl=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 创建订单聚合方法，含构建订单和所有订单项")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"private"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"OrderCreateTo"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"createOrder"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//获取当前登录的用户信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"MemberRespVo"),l("span",{style:{color:"#A6ACCD"}}," memberRespVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," LoginUserInterceptor"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"loginUser"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"get"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"OrderCreateTo"),l("span",{style:{color:"#A6ACCD"}}," createTo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"OrderCreateTo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、todo 生成订单号(使用雪花算法根据用户id创建订单号)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//        String orderSn = IdWorker.getTimeId();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," orderSn "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," SnowflakeIdUtil"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"nextIdStrByService"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"memberRespVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"toString"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//创建订单")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#A6ACCD"}}," orderEntity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"buildOrder"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderSn"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//2、获取到所有的订单项")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderItemEntity"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," itemEntities "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"buildOrderItems"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderSn"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//3、验价，计算价格、积分等相关")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#82AAFF"}},"computePrice"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderEntity"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," itemEntities"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//        createTo.setOrderItems(itemEntities);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//        createTo.setOrder(orderEntity);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// 构建订单聚合根")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"OrderCreateTo"),l("span",{style:{color:"#A6ACCD"}}," order "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," createTo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"builder"),l("span",{style:{color:"#89DDFF"}},"()")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"order"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderEntity"),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"orderItems"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"itemEntities"),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"fare"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getFreightAmount"),l("span",{style:{color:"#89DDFF"}},"())")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"payPrice"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getPayAmount"),l("span",{style:{color:"#89DDFF"}},"())")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"build"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," order"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),ol=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403131446123.png",alt:"mall"})],-1),nl=l("li",null,[l("p",null,"支付服务，提供支付宝、微信、银行卡等支付方式，支持支付查询以及退款等功能。")],-1),el={id:"配置项修改",tabindex:"-1"},tl=l("strong",null,"配置项修改",-1),al=l("p",null,[s("详情见 "),l("strong",null,"支付宝沙箱对接"),s(" 中需要修改配置项。")],-1),cl={id:"核心流程",tabindex:"-1"},rl=l("strong",null,"核心流程",-1),pl=l("p",null,[l("strong",null,"核心流程(刚果商城项目参考)：")],-1),il=l("p",null,"1）通过策略模式封装支付渠道和支付场景，用户支付时动态选择对应的支付组件。",-1),yl=l("ul",null,[l("li",null,[s("代码地址："),l("code",null,"org.opengoofy.congomall.biz.pay.application.service.impl.PayServiceImpl#commonPay")])],-1),Dl=l("p",null,"2）通过策略模式封装支付回调场景，三方支付平台回调时动态选择对应的支付回调组件。",-1),Fl=l("ul",null,[l("li",null,[s("代码地址："),l("code",null,"org.opengoofy.congomall.biz.pay.application.service.impl.PayServiceImpl#callback")])],-1),Al={id:"支付宝沙箱对接",tabindex:"-1"},Cl=l("p",null,"项目中已对接支付宝沙箱环境，以下介绍如何对接支付宝沙箱。",-1),ul=l("ul",null,[l("li",null,[l("ol",null,[l("li",null,[l("strong",null,"注册账号")])])])],-1),dl=l("p",null,"注册支付宝开发者账户，进入开发者控制台。",-1),gl=l("p",null,"直接进入沙箱环境地址。",-1),hl=l("p",null,"沙箱应用页面如下：",-1),ml=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/1674111619522-82229cf7-482d-4a4e-81bd-637c55c3d6a9.png",alt:"mall"})],-1),El=l("ul",null,[l("li",null,[l("ol",{start:"2"},[l("li",null,[l("strong",null,"获取支付参数")])])])],-1),fl=l("p",null,[s("拿到 APPID 替换 "),l("code",null,"application.properties"),s(" 文件中 "),l("code",null,"alipay.app-id"),s("。")],-1),_l=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/1674111838001-9ff075ce-e324-43a6-a6b6-e3d860970e6a.png",alt:"mall"})],-1),kl=l("p",null,"为了图方便，这里直接使用支付宝自定义公钥和私钥。",-1),bl=l("p",null,"我这里是已经开启过的，所以启用按钮是置灰的。第一次使用应该是蓝色可点击的状态。",-1),Sl=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/1674112006561-4be2d9d4-ef90-4c49-aee6-1f6f6a988f2d.png",alt:"mall"})],-1),vl=l("p",null,[s("复制支付宝公钥替换 "),l("code",null,"application.properties"),s(" 文件中 "),l("code",null,"alipay.alipay_public_key"),s("。")],-1),xl=l("p",null,[s("复制应用私钥替换 "),l("code",null,"application.properties"),s(" 文件中 "),l("code",null,"alipay.private_key"),s("。")],-1),Il=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/1674112099708-2d1a70a2-6af5-4502-8192-f6bb587b302f.png",alt:"img"})],-1),Tl=l("p",null,"至此，就可以调用支付接口进行支付宝支付功能了。",-1),Ll=l("ul",null,[l("li",null,[l("ol",{start:"3"},[l("li",null,[l("strong",null,"调用支付宝接口")])])])],-1),Ol=l("p",null,"访问支付服务 API，调用支付宝支付接口。",-1),Rl=l("code",null,"pay.html",-1),wl=l("code",null,"pay.html",-1),ql=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#getOrderPay")])],-1),Ml=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 获取当前订单的支付信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"orderSn")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"PayVo"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"getOrderPay"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," orderSn"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"PayVo"),l("span",{style:{color:"#A6ACCD"}}," payVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"PayVo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#A6ACCD"}}," entity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"this."),l("span",{style:{color:"#82AAFF"}},"getOrderByOrderSn"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderSn"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//保留2位小数，有小数就想上取值")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"BigDecimal"),l("span",{style:{color:"#A6ACCD"}}," bigDecimal "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getTotalAmount"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"setScale"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#F78C6C"}},"2"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," BigDecimal"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"ROUND_UP"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    payVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setTotal_amount"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"bigDecimal"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"toString"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    payVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setOut_trade_no"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderSn"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderItemEntity"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," itemEntities "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderItemService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"list"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"QueryWrapper"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderItemEntity"),l("span",{style:{color:"#89DDFF"}},">()."),l("span",{style:{color:"#82AAFF"}},"eq"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order_sn"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," orderSn"),l("span",{style:{color:"#89DDFF"}},"));")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"OrderItemEntity"),l("span",{style:{color:"#A6ACCD"}}," item "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," itemEntities"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"get"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    payVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setSubject"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"item"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuName"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    payVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setBody"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"item"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuAttrsVals"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," payVo"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Bl=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.web.PayWebController#payOrder")])],-1),Vl=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," /**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 1、将支付页让浏览器展示")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 2、支付成功以后，我们要跳到用户的订单列表页")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"orderSn")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@throws"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#FFCB6B","font-style":"italic"}},"AlipayApiException")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"ResponseBody")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"GetMapping"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#FFCB6B"}},"value"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/payOrder"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"produces"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"text/html"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"payOrder"),l("span",{style:{color:"#89DDFF"}},"(@"),l("span",{style:{color:"#C792EA"}},"RequestParam"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"orderSn"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," orderSn"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," throws AlipayApiException "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"PayVo"),l("span",{style:{color:"#A6ACCD"}}," payVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderPay"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderSn"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//返回的是一个页面，将此页面直接交给浏览器就行")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," pay "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," alipayTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"pay"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"payVo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//        System.out.println(pay);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," pay"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Pl=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.config.AlipayTemplate#pay")])],-1),Kl=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"pay"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"PayVo"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," throws AlipayApiException "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},'//AlipayClient alipayClient = new DefaultAlipayClient(AlipayTemplate.gatewayUrl, AlipayTemplate.app_id, AlipayTemplate.merchant_private_key, "json", AlipayTemplate.charset, AlipayTemplate.alipay_public_key, AlipayTemplate.sign_type);')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、根据支付宝的配置生成一个支付客户端")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"AlipayClient"),l("span",{style:{color:"#A6ACCD"}}," alipayClient "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"DefaultAlipayClient"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"gatewayUrl"),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            app_id"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," merchant_private_key"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"json"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            charset"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," alipay_public_key"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," sign_type"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//2、创建一个支付请求 //设置请求参数")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"AlipayTradePagePayRequest"),l("span",{style:{color:"#A6ACCD"}}," alipayRequest "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"AlipayTradePagePayRequest"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    alipayRequest"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setReturnUrl"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"return_url"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    alipayRequest"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setNotifyUrl"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"notify_url"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//商户订单号，商户网站订单系统中唯一订单号，必填")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," out_trade_no "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOut_trade_no"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//付款金额，必填")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," total_amount "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getTotal_amount"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//订单名称，必填")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," subject "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSubject"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//商品描述，可空")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," body "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getBody"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    alipayRequest"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setBizContent"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"{"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},"out_trade_no"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},":"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," out_trade_no "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},","),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},"total_amount"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},":"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," total_amount "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},","),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},"subject"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},":"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," subject "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},","),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},"body"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},":"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," body "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},","),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},"timeout_express"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},":"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}},"timeout"),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},","),l("span",{style:{color:"#89DDFF"}},'"')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},"product_code"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},":"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},"FAST_INSTANT_TRADE_PAY"),l("span",{style:{color:"#A6ACCD"}},'\\"'),l("span",{style:{color:"#C3E88D"}},"}"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," result "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," alipayClient"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"pageExecute"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"alipayRequest"),l("span",{style:{color:"#89DDFF"}},")."),l("span",{style:{color:"#82AAFF"}},"getBody"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//会收到支付宝的响应，响应的是一个页面，只要浏览器显示这个页面，就会自动来到支付宝的收银台页面")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"支付宝的响应："),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}},"result"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," result"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Nl=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403152134343.png",alt:"image"})],-1),Wl=l("p",null,[s("通过谷歌浏览器打开 "),l("code",null,"pay.html"),s("即可，看到以下页面即为正常现象。")],-1),jl=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403131612455.png",alt:"image-20230403131612455"})],-1),Ql=l("p",null,"账户名和支付密码从沙箱账号处复制买方信息。如果买方账户余额为 0，可随意充值金额。",-1),Hl=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/1674195718913-2cf0d08a-1bc0-4303-aef5-df51a662fadf.png",alt:"img"})],-1),Ul=l("p",null,"使用账户余额支付即可。",-1),Gl=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403131639507.png",alt:"image-20230403131639507"})],-1),zl=l("p",null,"支付结果显示成功。",-1),$l=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403131649890.png",alt:"image-20230403131649890"})],-1),Jl=l("ul",null,[l("li",null,[l("ol",{start:"4"},[l("li",null,[l("strong",null,"支付结果回调")])])])],-1),Xl=l("p",null,"如果希望在沙箱环境中得知具体支付结果，我们需要通过 Natapp 开通内网穿透，开通教程详细查看下述官方文档：",-1),Yl=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403152749004.png",alt:"image-20230403152749004"})],-1),Zl=l("p",null,[s("将 Natapp 内网穿透地址替换 "),l("code",null,"application.properties"),s(" 文件下 "),l("code",null,"alipay.notify_url"),s(" 属性。")],-1),ls=l("p",null,"再重复调用下支付宝支付接口流程，即可看到回调效果。",-1),ss=l("ul",null,[l("li",null,"配置以上内网穿透配置才能完成订单支付，否则订单支付失败，订单自动取消，库存自动解锁")],-1),os=l("div",{class:"language-properties"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"#异步通知：支付宝会悄悄的给我们发送一个请求，告诉我们支付成功的信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"alipay.notify_url"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"http://mqbb4a.natappfree.cc/paid/notify")]),s(`
`),l("span",{class:"line"})])])],-1),ns=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403131656175.png",alt:"image-20230403131656175"})],-1),es=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#handlePayResult")])],-1),ts=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 处理支付宝的支付结果")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"vo")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"handlePayResult"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"PayAsyncVo"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、保存交易流水")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"PaymentInfoEntity"),l("span",{style:{color:"#A6ACCD"}}," infoEntity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"PaymentInfoEntity"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        infoEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setAlipayTradeNo"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getTrade_no"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        infoEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setOrderSn"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOut_trade_no"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        infoEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setPaymentStatus"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getTrade_status"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        infoEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setCallbackTime"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getNotify_time"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        paymentInfoService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"save"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"infoEntity"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//2、修改订单的状态信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getTrade_status"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"equals"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"TRADE_SUCCESS"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"||"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getTrade_status"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"equals"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"TRADE_FINISHED"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//支付成功状态")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," outTradeNo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOut_trade_no"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"this."),l("span",{style:{color:"#A6ACCD"}},"baseMapper"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"updateOrderStatus"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"outTradeNo"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," OrderStatusEnum"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"PAYED"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCode"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"success"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),as=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.listener.OrderPaidListener#handleAlipaid")])],-1),cs=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," /**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 支付成功异步通知")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"vo")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"request")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"PostMapping"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/paid/notify"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"handleAlipaid"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"PayAsyncVo"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"HttpServletRequest"),l("span",{style:{color:"#A6ACCD"}}," request"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," throws Exception "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//只要我们收到了支付宝给我们异步的通知，告诉我们订单支付成功，返回success，支付宝就再也不通知")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//        Map<String, String[]> map = request.getParameterMap();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//        for (String key : map.keySet()) {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//            String value = request.getParameter(key);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},'//            System.out.println("参数名："+key+"==>参数值："+ value);')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//        }")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},'//        System.out.println("支付宝通知到位了...数据："+map);')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//验签")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"Map"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," params "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"HashMap"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},">();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"Map"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},"[]>"),l("span",{style:{color:"#A6ACCD"}}," requestParams "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," request"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getParameterMap"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"for"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Iterator"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," iter "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," requestParams"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"keySet"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"iterator"),l("span",{style:{color:"#89DDFF"}},"();"),l("span",{style:{color:"#A6ACCD"}}," iter"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"hasNext"),l("span",{style:{color:"#89DDFF"}},"();)"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," name "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"String"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," iter"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"next"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},"[]"),l("span",{style:{color:"#A6ACCD"}}," values "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},"[])"),l("span",{style:{color:"#A6ACCD"}}," requestParams"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"get"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"name"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," valueStr "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'""'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"for"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"int"),l("span",{style:{color:"#A6ACCD"}}," i "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#89DDFF"}},";"),l("span",{style:{color:"#A6ACCD"}}," i "),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#A6ACCD"}}," values"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"length"),l("span",{style:{color:"#89DDFF"}},";"),l("span",{style:{color:"#A6ACCD"}}," i"),l("span",{style:{color:"#89DDFF"}},"++)"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                valueStr "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"i "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," values"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"length "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"?"),l("span",{style:{color:"#A6ACCD"}}," valueStr "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," values"),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"i"),l("span",{style:{color:"#89DDFF"}},"]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},":"),l("span",{style:{color:"#A6ACCD"}}," valueStr "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," values"),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#A6ACCD"}},"i"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},","),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//乱码解决，这段代码在出现乱码时使用")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},'//            valueStr = new String(valueStr.getBytes("ISO-8859-1"), "utf-8");')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            params"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"put"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"name"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," valueStr"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"boolean"),l("span",{style:{color:"#A6ACCD"}}," signVerified "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," AlipaySignature"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"rsaCheckV1"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"params"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," alipayTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getAlipay_public_key"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," alipayTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCharset"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," alipayTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSign_type"),l("span",{style:{color:"#89DDFF"}},"());"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"signVerified"),l("span",{style:{color:"#89DDFF"}},"){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//验签成功")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"签名验证成功....."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," result "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"handlePayResult"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," result"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"签名验证失败....."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"error"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),rs=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"private"),l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," return_url "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"http://member.gulimall.com/memberOrder.html"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"})])])],-1),ps=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.member.Web.MemberWebController#memberOrderPage")])],-1),is=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"GetMapping"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/memberOrder.html"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"memberOrderPage"),l("span",{style:{color:"#89DDFF"}},"(@"),l("span",{style:{color:"#C792EA"}},"RequestParam"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#FFCB6B"}},"value"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"pageNum"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"defaultValue"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"1"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Integer"),l("span",{style:{color:"#A6ACCD"}}," pageNum"),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                              "),l("span",{style:{color:"#C792EA"}},"Model"),l("span",{style:{color:"#A6ACCD"}}," model"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//查出当前登录的用户的所有订单列表数据")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"Map"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Object"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," page "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"HashMap"),l("span",{style:{color:"#89DDFF"}},"<>();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    page"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"put"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"page"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," pageNum"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"toString"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," r "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderFeignService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"listWithItem"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"page"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"JSON"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"toJSONString"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"r"),l("span",{style:{color:"#89DDFF"}},"));")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    model"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"addAttribute"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"orders"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," r"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"orderList"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),ys=l("ul",null,[l("li",null,"远程调用订单服务查出当前登录的用户的所有订单列表数据"),l("li",null,[l("code",null,"com.klaus.gulimall.order.controller.OrderController#listWithItem")])],-1),Ds=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * todo 远程调用都要全用@POSTMapping+@RequestBody(请求体只支持post)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 分页查询当前登录用户的所有订单")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"params")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"PostMapping"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/listWithItem"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},'//@RequiresPermissions("order:order:list")')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"listWithItem"),l("span",{style:{color:"#89DDFF"}},"(@"),l("span",{style:{color:"#C792EA"}},"RequestBody"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Map"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#A6ACCD"}},"String"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," Object"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," params"),l("span",{style:{color:"#89DDFF"}},"){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"PageUtils"),l("span",{style:{color:"#A6ACCD"}}," page "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"queryPageWithItem"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"params"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," R"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"ok"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"put"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"page"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," page"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Fs=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#queryPageWithItem")])],-1),As=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"PageUtils"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"queryPageWithItem"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Map"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#A6ACCD"}},"String"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," Object"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," params"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//获取当前登录的用户信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"MemberRespVo"),l("span",{style:{color:"#A6ACCD"}}," memberRespVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," LoginUserInterceptor"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"loginUser"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"get"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"IPage"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," page "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"this."),l("span",{style:{color:"#82AAFF"}},"page"),l("span",{style:{color:"#89DDFF"}},"(")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Query"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#89DDFF"}},">()."),l("span",{style:{color:"#82AAFF"}},"getPage"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"params"),l("span",{style:{color:"#89DDFF"}},"),"),l("span",{style:{color:"#A6ACCD"}},"                                            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//根据id降序")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"QueryWrapper"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#89DDFF"}},">()."),l("span",{style:{color:"#82AAFF"}},"eq"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"member_id"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," memberRespVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"())."),l("span",{style:{color:"#82AAFF"}},"orderByDesc"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"id"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," orderEntities "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," page"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getRecords"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"stream"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"map"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"order "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//封装订单项到订单")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderItemEntity"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," itemEntities "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderItemService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"list"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"QueryWrapper"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderItemEntity"),l("span",{style:{color:"#89DDFF"}},">()."),l("span",{style:{color:"#82AAFF"}},"eq"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order_sn"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," order"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderSn"),l("span",{style:{color:"#89DDFF"}},"()));")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        order"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setItemEntities"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"itemEntities"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," order"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"})."),l("span",{style:{color:"#82AAFF"}},"collect"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"Collectors"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"toList"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    page"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setRecords"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderEntities"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"PageUtils"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"page"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Cs=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403131702203.png",alt:"image-20230403131702203"})],-1),us={id:"_2-订单创建前需要预览订单，选择收货信息等",tabindex:"-1"},ds=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403130248691.png",alt:"image-20230403130248691"})],-1),gs=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.web.OrderWebController#toTrade")])],-1),hs=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * OrderConfirmVo = [List<MemberAddressVo> address, //收货地址， ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     *                  List<OrderItemVo> items,      //所有选中的购物项")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     *                 Integer integration,         //积分...")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     *                 Map<Long, Boolean> stocks, //库存信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     *                 String orderToken        //防重令牌]")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"*/")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"GetMapping"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/toTrade"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"toTrade"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Model"),l("span",{style:{color:"#A6ACCD"}}," model"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"HttpServletRequest"),l("span",{style:{color:"#A6ACCD"}}," request"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," throws ExecutionException"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," InterruptedException "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"OrderConfirmVo"),l("span",{style:{color:"#A6ACCD"}}," confirmVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"confirmOrder"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    model"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"addAttribute"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"orderConfirmData"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," confirmVo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//展示订单确认的数据(页面跳转)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"confirm"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),ms=l("ul",null,[l("li",null,[l("p",null,[l("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#confirmOrder")])]),l("li",null,[l("blockquote",null,[l("p",null,[l("strong",null,"注"),s("：使用异步编排时用到远程调用，如果不进行请求上下文共享将造成Feign异步情况丢失上下文问题")])])])],-1),Es=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 订单确认页返回需要用到的数据")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"OrderConfirmVo"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"confirmOrder"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," throws ExecutionException"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," InterruptedException "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"OrderConfirmVo"),l("span",{style:{color:"#A6ACCD"}}," confirmVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"OrderConfirmVo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//从拦截器里获取用户信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"MemberRespVo"),l("span",{style:{color:"#A6ACCD"}}," memberRespVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," LoginUserInterceptor"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"loginUser"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"get"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"主线程...."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," Thread"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"currentThread"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//获取原来请求上下文请求属性")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"RequestAttributes"),l("span",{style:{color:"#A6ACCD"}}," requestAttributes "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," RequestContextHolder"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getRequestAttributes"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//进行异步编排")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Void"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," getAddressFuture "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"runAsync"),l("span",{style:{color:"#89DDFF"}},"(()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、远程查询所有的收货地址列表")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"member线程...."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," Thread"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"currentThread"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//在Feign异步调用前将请求上下文进行共享操作(之前的请求数据都来共享每一个线程)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        RequestContextHolder"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setRequestAttributes"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"requestAttributes"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"MemberAddressVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," address "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," memberFeignService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getAddress"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"memberRespVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        confirmVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setAddress"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"address"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Void"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," cartFuture "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"runAsync"),l("span",{style:{color:"#89DDFF"}},"(()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//2、远程查询购物车所有选中的购物项")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"cart线程...."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," Thread"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"currentThread"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//在Feign异步调用前将请求上下文进行共享操作")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        RequestContextHolder"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setRequestAttributes"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"requestAttributes"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderItemVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," items "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," cartFeignService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"currentUserCartItems"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        confirmVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setItems"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"items"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//feign在远程调用之前要构造请求，调用很多的拦截器")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//for(RequestInterceptor interceptor:requestInterceptors)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},")."),l("span",{style:{color:"#82AAFF"}},"thenRunAsync"),l("span",{style:{color:"#89DDFF"}},"(()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderItemVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," items "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," confirmVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getItems"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," skuIds "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," items"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"stream"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"map"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"item "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," item"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},"())."),l("span",{style:{color:"#82AAFF"}},"collect"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"Collectors"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"toList"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//远程查询库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," r "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wmsFeignService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkusHasStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuIds"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SkuStockVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," data "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," r"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getData"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"TypeReference"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SkuStockVo"),l("span",{style:{color:"#89DDFF"}},">>()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"});")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"data "),l("span",{style:{color:"#89DDFF"}},"!="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null)"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// Map<SkuId, hasStock> map")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"Map"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Boolean"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," map "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," data"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"stream"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"collect"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"Collectors"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"toMap"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"SkuStockVo"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),l("span",{style:{color:"#A6ACCD"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," SkuStockVo"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),l("span",{style:{color:"#A6ACCD"}},"getHasStock"),l("span",{style:{color:"#89DDFF"}},"));")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// Map<Long, Boolean> stocks;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            confirmVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setStocks"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"map"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//3、查询用户积分")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"Integer"),l("span",{style:{color:"#A6ACCD"}}," integration "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," memberRespVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getIntegration"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    confirmVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setIntegration"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"integration"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//4、其他数据自动计算")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//todo 5、防重令牌")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," token "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," UUID"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"randomUUID"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"toString"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"replace"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"-"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'""'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//给服务器一个令牌")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    redisTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"opsForValue"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"set"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"OrderConstant"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"USER_ORDER_TOKEN_PREFIX "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," memberRespVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," token"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"30"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," TimeUnit"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"MINUTES"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//给页面一个令牌")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    confirmVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setOrderToken"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"token"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"allOf"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"getAddressFuture"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," cartFuture"),l("span",{style:{color:"#89DDFF"}},")."),l("span",{style:{color:"#82AAFF"}},"get"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," confirmVo"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),fs=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403130554589.png",alt:"image-20230403130554589"})],-1),_s=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230416234636426.png",alt:"image-20230416234636426"})],-1),ks={id:"_3-订单创建需要锁定库存，库存有才可创建，否则不能创建",tabindex:"-1"},bs=l("ul",null,[l("li",null,"查询sku是否有库存"),l("li",null,[l("code",null,"com.klaus.gulimall.ware.controller.WareSkuController#getSkusHasStock")])],-1),Ss=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//查询sku是否有库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"PostMapping"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/hasstock"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"getSkusHasStock"),l("span",{style:{color:"#89DDFF"}},"(@"),l("span",{style:{color:"#C792EA"}},"RequestBody"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#A6ACCD"}},"Long"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," skuIds"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//sku_id stock")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SkuHasStockVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," vos "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareSkuService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkusHasStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuIds"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," R"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"ok"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"setData"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vos"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),vs=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#getSkusHasStock")])],-1),xs=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#A6ACCD"}},"SkuHasStockVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"getSkusHasStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#A6ACCD"}},"Long"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," skuIds"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SkuHasStockVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," collect "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," skuIds"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"stream"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"map"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"SkuHasStockVo"),l("span",{style:{color:"#A6ACCD"}}," vo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"SkuHasStockVo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//查询当前sku的总库存量")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//SELECT SUM(stock-stock_locked) FROM `wms_ware_sku` WHERE sku_id=1")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//获取查询到的库存记录数")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," count "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," baseMapper"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setSkuId"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//记录数大于0表示有库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setHasStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"count "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"?"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},":"),l("span",{style:{color:"#A6ACCD"}}," count "),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"})."),l("span",{style:{color:"#82AAFF"}},"collect"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"Collectors"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"toList"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," collect"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Is=l("ul",null,[l("li",null,"SQL")],-1),Ts=l("div",{class:"language-xml"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#F07178"}},"select"),l("span",{style:{color:"#89DDFF"}}," "),l("span",{style:{color:"#C792EA"}},"id"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"getSkuStock"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}}," "),l("span",{style:{color:"#C792EA"}},"resultType"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"java.lang.Long"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    SELECT SUM(stock-stock_locked) FROM `wms_ware_sku` WHERE sku_id=#{skuId}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"</"),l("span",{style:{color:"#F07178"}},"select"),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"})])])],-1),Ls=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404010335539.png",alt:"image-20230404010335539"})],-1),Os=l("ul",null,[l("li",null,"创建订单进行库存锁定"),l("li",null,[l("code",null,"com.klaus.gulimall.ware.controller.WareSkuController#orderLockStock")])],-1),Rs=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"RequestMapping"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/lock/order"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"orderLockStock"),l("span",{style:{color:"#89DDFF"}},"(@"),l("span",{style:{color:"#C792EA"}},"RequestBody"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"WareSkuLockVo"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"Boolean"),l("span",{style:{color:"#A6ACCD"}}," lockStock "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"try"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        lockStock "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareSkuService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"orderLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," R"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"ok"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"catch"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"NoStockException"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"e"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//通过测试发现商品库存不足将会在页面显示以下错误信息(http://order.gulimall.com/toTrade)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," R"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"error"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"BizCodeEnum"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"NO_STOCK_EXCEPTION"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCode"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," BizCodeEnum"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"NO_STOCK_EXCEPTION"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getMsg"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),ws=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#orderLockStock")])],-1),qs=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 为某个订单锁定库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 加入统一事务")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * (rollbackFor = NoStockException.class )")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 默认只要是运行时异常都会回滚")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 库存解锁的场景")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 1）、下订单成功，订单过期没有支付被系统自动取消、被用户手动取消，都要解锁库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 2）、下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 之前锁定的库存就要自动解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"vo")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Transactional")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Boolean"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"orderLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"WareSkuLockVo"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 保存库存工作单的详情的两张表")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 追溯")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"WareOrderTaskEntity"),l("span",{style:{color:"#A6ACCD"}}," taskEntity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"WareOrderTaskEntity"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    taskEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setOrderSn"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderSn"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    wareOrderTaskService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"save"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"taskEntity"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//按照下单的收货地址，找到一个就近仓库，锁定库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、找到每个商品在哪个仓库都有库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderItemVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," locks "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getLocks"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SkuWareHasStock"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," collect "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," locks"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"stream"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"map"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"item "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"SkuWareHasStock"),l("span",{style:{color:"#A6ACCD"}}," stock "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"SkuWareHasStock"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," skuId "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," item"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        stock"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setSkuId"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        stock"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setNum"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"item"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCount"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//查询这个商品在哪里有库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," wareIds "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareSkuDao"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"listWareIdHasSkuStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        stock"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setWareIds"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"wareIds"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," stock"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"})."),l("span",{style:{color:"#82AAFF"}},"collect"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"Collectors"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"toList"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//2、锁定库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"for"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"SkuWareHasStock"),l("span",{style:{color:"#A6ACCD"}}," hasStock "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},":"),l("span",{style:{color:"#A6ACCD"}}," collect"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"Boolean"),l("span",{style:{color:"#A6ACCD"}}," skuStocked "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false;"),l("span",{style:{color:"#676E95","font-style":"italic"}},"//lock_status=0")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," skuId "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," hasStock"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," wareIds "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," hasStock"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getWareIds"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"wareIds "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"||"),l("span",{style:{color:"#A6ACCD"}}," wareIds"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"size"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//没有任何仓库有这个商品的库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"NoStockException"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、如果每一个商品都锁定成功，将当前商品锁定了几件的工作单记录发给MQ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//2、锁定失败。前面保存的工作单信息就回滚了，即使要解锁记录，由于去数据库查不到id，所以就不用解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//  log:skuId-num-ware: 1:1-2-1(v) 2:2-1-3(v) 3:3-1-1(x)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//  既然锁成功了就应该扣减，之后就应该解锁，因为3记录锁失败，1,2记录就回滚了，相当于工作单回滚了，库存没回滚库存扣减")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// 只传id工作单是不知道当时库存锁了多少个")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"for"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," wareId "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},":"),l("span",{style:{color:"#A6ACCD"}}," wareIds"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//成功就返回1，否则就是0")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," count "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareSkuDao"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"lockSkuStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," wareId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," hasStock"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getNum"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"count "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//锁成功了==>lock_status=1")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                skuStocked "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//退出当前循环")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//todo 告诉MQ库存锁定成功")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#C792EA"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#A6ACCD"}}," detailEntity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#89DDFF"}},"(null,"),l("span",{style:{color:"#A6ACCD"}}," skuId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'""'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," hasStock"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getNum"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," taskEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," wareId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//保存工作单详情")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                wareOrderTaskDetailService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"save"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"detailEntity"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#C792EA"}},"StockLockedTo"),l("span",{style:{color:"#A6ACCD"}}," lockedTo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"StockLockedTo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//属性拷贝到to")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#C792EA"}},"StockDetailTo"),l("span",{style:{color:"#A6ACCD"}}," stockDetailTo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"StockDetailTo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                BeanUtils"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"copyProperties"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"detailEntity"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," stockDetailTo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//只传工作单id还不够，防止回滚以后找不到数据")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                lockedTo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setId"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"taskEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                lockedTo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setDetailTo"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"stockDetailTo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//发送锁定库存消息；提交订单后，出现异常，订单回滚，库存不回滚，延时队列有2个任务等待死信时间结束后发送消息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                rabbitTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"convertAndSend"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock.locked"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," lockedTo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"break"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//当前仓库锁失败了，重试下一个仓库")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuStocked "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false)"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//当前商品所有仓库都没有锁住")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"NoStockException"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//3、肯定全部都是锁定成功过的")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Ms=l("ul",null,[l("li",null,[s("库存工作单表"),l("code",null,"wms_ware_order_task")])],-1),Bs=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404012221654.png",alt:"image-20230404012221654"})],-1),Vs=l("ul",null,[l("li",null,[s("库存工作单详情"),l("code",null,"wms_ware_order_task_detail")]),l("li",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404012535232.png",alt:"image-20230404012535232"})])],-1),Ps=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404012359140.png",alt:"image-20230404012359140"})],-1),Ks=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//查询这个商品在哪里有库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//com.klaus.gulimall.ware.dao.WareSkuDao#listWareIdHasSkuStock")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," wareIds "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareSkuDao"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"listWareIdHasSkuStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"})])])],-1),Ns=l("ul",null,[l("li",null,"SQL")],-1),Ws=l("div",{class:"language-xml"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#F07178"}},"select"),l("span",{style:{color:"#89DDFF"}}," "),l("span",{style:{color:"#C792EA"}},"id"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"listWareIdHasSkuStock"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}}," "),l("span",{style:{color:"#C792EA"}},"resultType"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"java.lang.Long"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    SELECT ware_id FROM `wms_ware_sku` WHERE sku_id=#{skuId} AND stock-stock_locked >0")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"</"),l("span",{style:{color:"#F07178"}},"select"),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"})])])],-1),js=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404013003956.png",alt:"image-20230404013003956"})],-1),Qs=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//库存锁定成功就返回1，否则就是0")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//com.klaus.gulimall.ware.dao.WareSkuDao#lockSkuStock")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," count "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareSkuDao"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"lockSkuStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," wareId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," hasStock"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getNum"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"})])])],-1),Hs=l("ul",null,[l("li",null,"SQL")],-1),Us=l("div",{class:"language-xml"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#F07178"}},"update"),l("span",{style:{color:"#89DDFF"}}," "),l("span",{style:{color:"#C792EA"}},"id"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"lockSkuStock"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    UPDATE `wms_ware_sku` SET stock_locked = stock_locked + #{num}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    WHERE sku_id =#{skuId} AND ware_id=#{wareId} AND stock-stock_locked>=#{num}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"</"),l("span",{style:{color:"#F07178"}},"update"),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"})])])],-1),Gs=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404014111150.png",alt:"image-20230404014111150"})],-1),zs={id:"_4-订单创建后超时未支付需要解锁库存",tabindex:"-1"},$s=l("ul",null,[l("li",null,[l("p",null,"库存解锁分两种情况，一种是订单正常支付超时库存自动解锁；一种是订单服务异常/宕机库存自动解锁")]),l("li",null,[l("p",null,[l("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.StockLockedTo)")])])],-1),Js=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 1、库存自动解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚。之前锁定的库存就要自动解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 2、下订单失败")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 锁库存失败")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 只要解锁库存的消息失败，一定要告诉服务器解锁失败")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"to")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"message")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"unlockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"StockLockedTo"),l("span",{style:{color:"#A6ACCD"}}," to"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"StockDetailTo"),l("span",{style:{color:"#A6ACCD"}}," detail "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," to"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getDetailTo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," detailId "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," detail"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、查询数据库关于这个订单的锁定库存信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// 有： 证明库存锁定成功了")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//     解锁：订单情况")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//          1、没有这个订单，必须解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//          2、有这个订单，就不是解锁库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//                  订单状态： 已取消：解锁库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//                           没取消：不能接受")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// 没有：库存锁定失败了，库存回滚了。这种情况无需解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#A6ACCD"}}," taskDetailEntity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareOrderTaskDetailService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getById"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"detailId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"taskDetailEntity "),l("span",{style:{color:"#89DDFF"}},"!="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null)"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//有工作详情单，但只能证明库存服务在锁库存的时候锁成功后返回出去的，")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// 要看整个订单有没有下单成功，如果订单远程调用的其他服务崩了导致订单回滚，这跟库存服务没有关系，直接解锁是有问题的，因为订单都没有")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," id "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," to"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"();"),l("span",{style:{color:"#676E95","font-style":"italic"}},"//库存工作单的id")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//获取订单状态")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"WareOrderTaskEntity"),l("span",{style:{color:"#A6ACCD"}}," taskEntity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareOrderTaskService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getById"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"id"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," orderSn "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," taskEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderSn"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//根据订单号查询订单的状态")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," r "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderFeignService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderStatus"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderSn"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"r"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCode"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//远程调用成功，订单数据返回成功")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"OrderVo"),l("span",{style:{color:"#A6ACCD"}}," data "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," r"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getData"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"TypeReference"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderVo"),l("span",{style:{color:"#89DDFF"}},">()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"});")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"data "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"||"),l("span",{style:{color:"#A6ACCD"}}," data"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getStatus"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"4"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//订单已经被取消或订单不存在，才能解锁库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//问题：订单服务由于网络等原因迟迟没有将订单解锁(data.getStatus()==0)导致库存永远释放不了锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"taskDetailEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getLockStatus"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF"}},"){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//当前库存工作单详情，状态为1 已锁定但是未解锁才可以解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    "),l("span",{style:{color:"#82AAFF"}},"unLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"detail"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," detail"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getWareId"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," detail"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuNum"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," detailId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//远程调用失败直接抛异常")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"RuntimeException"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"远程服务失败"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//无需解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Xs=l("ul",null,[l("li",null,[l("p",null,"远程调用订单服务获取订单状态")]),l("li",null,[l("p",null,[l("code",null,"com.klaus.gulimall.order.controller.OrderController#getOrderStatus")])])],-1),Ys=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"GetMapping"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/status/{orderSn}"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"getOrderStatus"),l("span",{style:{color:"#89DDFF"}},"(@"),l("span",{style:{color:"#C792EA"}},"PathVariable"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"orderSn"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," orderSn"),l("span",{style:{color:"#89DDFF"}},"){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#A6ACCD"}}," orderEntity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderByOrderSn"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderSn"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," R"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"ok"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"setData"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderEntity"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Zs=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"getOrderByOrderSn"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," orderSn"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#A6ACCD"}}," orderEntity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"this."),l("span",{style:{color:"#82AAFF"}},"getOne"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"QueryWrapper"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#89DDFF"}},">()."),l("span",{style:{color:"#82AAFF"}},"eq"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order_sn"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," orderSn"),l("span",{style:{color:"#89DDFF"}},"));")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," orderEntity"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),lo=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.OrderTo)")])],-1),so=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"* 防止订单服务卡顿，导致更改订单状态的操作无法完成以及更改的mq消息没有得到执行，解锁库存的消息优先到期，扫描订单状态是新建状态，就会什么都不做")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 导致卡顿的订单永远不能解锁库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"orderTo")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 加入统一事务")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Transactional")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"unlockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"OrderTo"),l("span",{style:{color:"#A6ACCD"}}," orderTo"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," orderSn "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderTo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderSn"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//查一下最新库存的状态，防止重复解锁库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"WareOrderTaskEntity"),l("span",{style:{color:"#A6ACCD"}}," task "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareOrderTaskService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderTaskByOrderSn"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderSn"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," id "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," task"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//按照工作单找到所有 没有解锁的库存，进行解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," detailEntities "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareOrderTaskDetailService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"list"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"QueryWrapper"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#89DDFF"}},">().")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#82AAFF"}},"eq"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"task_id"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," id"),l("span",{style:{color:"#89DDFF"}},").")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//新建的还没被解锁的库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#82AAFF"}},"eq"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"lock_status"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF"}},"));")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"for"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#A6ACCD"}}," entity "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},":"),l("span",{style:{color:"#A6ACCD"}}," detailEntities"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//此解锁方式可以解决高并发问题和整个系统的异构(两个服务开发语言不同。如java，php)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#82AAFF"}},"unLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getWareId"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuNum"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),oo=l("ul",null,[l("li",null,[s("库存解锁方法"),l("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unLockStock")])],-1),no=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"private"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"unLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," skuId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," wareId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Integer"),l("span",{style:{color:"#A6ACCD"}}," num"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," taskDetailId"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//库存解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    wareSkuDao"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"unLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," wareId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," num"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//更新库存工作单的状态")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#A6ACCD"}}," entity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setId"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"taskDetailId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setLockStatus"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#F78C6C"}},"2"),l("span",{style:{color:"#89DDFF"}},");"),l("span",{style:{color:"#676E95","font-style":"italic"}},"//变为已解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    wareOrderTaskDetailService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"updateById"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"entity"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),eo=l("ul",null,[l("li",null,"SQL")],-1),to=l("div",{class:"language-xml"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#F07178"}},"update"),l("span",{style:{color:"#89DDFF"}}," "),l("span",{style:{color:"#C792EA"}},"id"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"unLockStock"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    UPDATE `wms_ware_sku` SET stock_locked=stock_locked-#{num}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    WHERE sku_id=#{skuId} AND ware_id=#{wareId}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"</"),l("span",{style:{color:"#F07178"}},"update"),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"})])])],-1),ao=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404015601068.png",alt:"image-20230404015601068"})],-1),co={id:"_5-支付成功后，需要进行拆单，根据商品打包方式，所在仓库，物流等进行拆单-待开发",tabindex:"-1"},ro={id:"_6-支付的每笔流水都需要记录，以待查账",tabindex:"-1"},po=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230403161913669.png",alt:"image-20230403161913669"})],-1),io=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#handlePayResult")])],-1),yo=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 处理支付宝的支付结果")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"vo")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"handlePayResult"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"PayAsyncVo"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、保存交易流水")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"PaymentInfoEntity"),l("span",{style:{color:"#A6ACCD"}}," infoEntity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"PaymentInfoEntity"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    infoEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setAlipayTradeNo"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getTrade_no"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    infoEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setOrderSn"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOut_trade_no"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    infoEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setPaymentStatus"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getTrade_status"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    infoEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setCallbackTime"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getNotify_time"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    paymentInfoService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"save"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"infoEntity"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//2、修改订单的状态信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getTrade_status"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"equals"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"TRADE_SUCCESS"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"||"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getTrade_status"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"equals"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"TRADE_FINISHED"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//支付成功状态")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," outTradeNo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOut_trade_no"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"this."),l("span",{style:{color:"#A6ACCD"}},"baseMapper"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"updateOrderStatus"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"outTradeNo"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," OrderStatusEnum"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"PAYED"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCode"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"success"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Do={id:"_7-订单创建，支付成功-待开发-等状态都需要给-mq-发送消息，方便其他系统感知订阅",tabindex:"-1"},Fo=l("ul",null,[l("li",null,"添加依赖")],-1),Ao=l("div",{class:"language-xml"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#F07178"}},"dependency"),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#F07178"}},"groupId"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}},"org.springframework.boot"),l("span",{style:{color:"#89DDFF"}},"</"),l("span",{style:{color:"#F07178"}},"groupId"),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#F07178"}},"artifactId"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}},"spring-boot-starter-amqp"),l("span",{style:{color:"#89DDFF"}},"</"),l("span",{style:{color:"#F07178"}},"artifactId"),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"</"),l("span",{style:{color:"#F07178"}},"dependency"),l("span",{style:{color:"#89DDFF"}},">")]),s(`
`),l("span",{class:"line"})])])],-1),Co=l("ul",null,[l("li",null,[l("strong",null,"订单创建"),s("：(MQ)")]),l("li",null,"订单创建采用延迟队列"),l("li",null,[l("code",null,"com.klaus.gulimall.order.config.MyMQConfig")])],-1),uo=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Queue"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"orderDelayQueue"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"Map"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Object"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," arguments "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"HashMap"),l("span",{style:{color:"#89DDFF"}},"<>();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * x-dead-letter-exchange: order-event-exchange")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * x-dead-letter-routing-key: order.release.order")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * x-message-ttl: 60000")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    arguments"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"put"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"x-dead-letter-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    arguments"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"put"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"x-dead-letter-routing-key"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order.release.order"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    arguments"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"put"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"x-message-ttl"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"60000"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//String name, boolean durable, boolean exclusive, boolean autoDelete, Map<String, Object> arguments")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"Queue"),l("span",{style:{color:"#A6ACCD"}}," queue "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"Queue"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order.delay.queue"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false,"),l("span",{style:{color:"#A6ACCD"}}," arguments"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," queue"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Exchange"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"orderEventExchange"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//String name, boolean durable, boolean autoDelete, Map<String, Object> arguments")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"TopicExchange"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Binding"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"orderCreateOrderBinding"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"   "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//String destination, Binding.DestinationType destinationType, String exchange, String routingKey, Map<String, Object> arguments")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"   "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"Binding"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order.delay.queue"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                Binding"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"DestinationType"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"QUEUE"),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order.create.order"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),go=l("blockquote",null,[l("ul",null,[l("li",null,[s("创建订单 进入路由键-order.create.order- 进入交换机order-event-exchange， 根据路由键会转发到延时队列order.delay.queue 30min(60s)过期时间，过期时间到了之后，根据"),l("strong",null,"死信"),s("路由键-order.release.order-到达释放订单队列order.release.order.queue，监听这个队列的方法判断订单是不是已支付。")])])],-1),ho=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404121815115.png",alt:"image-20230404121815115"})],-1),mo=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#submitOrder")])],-1),Eo=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Transactional")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"SubmitOrderResponseVo"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"submitOrder"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"OrderSubmitVo"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"...")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//todo 订单创建成功发送消息给MQ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    rabbitTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"convertAndSend"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order.create.order"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," order"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrder"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"	"),l("span",{style:{color:"#89DDFF"}},"...")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),fo=l("p",null,[l("strong",null,"库存锁定"),s("：(MQ)")],-1),_o=l("ul",null,[l("li",null,[l("p",null,"库存锁定采用延迟队列")]),l("li",null,[l("p",null,[l("code",null,"com.klaus.gulimall.ware.config.MyRabbitConfig")])])],-1),ko=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Exchange"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"stockEventExchange"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"TopicExchange"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Queue"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"stockDelayQueue"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"Map"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Object"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," arguments "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"HashMap"),l("span",{style:{color:"#89DDFF"}},"<>();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    arguments"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"put"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"x-dead-letter-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    arguments"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"put"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"x-dead-letter-routing-key"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock.release"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    arguments"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"put"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"x-message-ttl"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"120000"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//String name, boolean durable, boolean exclusive, boolean autoDelete, Map<String, Object> arguments")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"Queue"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock.delay.queue"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false,"),l("span",{style:{color:"#A6ACCD"}}," arguments"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Binding"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"stockLockedBinding"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//String destination, Binding.DestinationType destinationType, String exchange, String routingKey, Map<String, Object> arguments")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"Binding"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock.delay.queue"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            Binding"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"DestinationType"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"QUEUE"),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock.locked"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),bo=l("blockquote",null,[l("ul",null,[l("li",null,[s("库存锁定成功 进入路由键-stock.locked- 进入交换机stock-event-exchange， 根据路由键会转发到延时队列stock.delay.queue 50min(120s)过期时间，延迟时间到，根据"),l("strong",null,"死信"),s("路由键-stock.release-到达释放订单队列stock.release.stock.queue，检查订单状态，确认是否需要解锁。")])])],-1),So=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404122316210.png",alt:"image-20230404122316210"})],-1),vo=l("ul",null,[l("li",null,[l("p",null,"订单创建成功后库存锁定也成功就发送消息给MQ")]),l("li",null,[l("p",null,[l("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#orderLockStock")])])],-1),xo=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Transactional")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Boolean"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"orderLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"WareSkuLockVo"),l("span",{style:{color:"#A6ACCD"}}," vo"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"...")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}}," "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//发送锁定库存消息；提交订单后，出现异常，订单回滚，库存不回滚，延时队列有2个任务等待死信时间结束后发送消息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  rabbitTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"convertAndSend"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock.locked"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," lockedTo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"...")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Io=l("p",null,[l("strong",null,"防止超卖"),s("：数据库 unsigned int 做最后的保证。 (范围0~65535)")],-1),To=l("ul",null,[l("li",null,"在mysql数据库中，unsigned表面含义是 '无符号'的意思，unsigned既为非负数，用此类型可以增加数据长度。")],-1),Lo=l("p",null,[l("strong",null,"自动关单"),s("：订单超时未支付，需要取消订单 (MQ)")],-1),Oo=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.config.MyMQConfig")])],-1),Ro=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"	"),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Queue"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"orderReleaseOrderQueue"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"Queue"),l("span",{style:{color:"#A6ACCD"}}," queue "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"Queue"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order.release.order.queue"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," queue"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}}," 	"),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Exchange"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"orderEventExchange"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//String name, boolean durable, boolean autoDelete, Map<String, Object> arguments")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"TopicExchange"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"	"),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Binding"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"orderReleaseOrderBinding"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"Binding"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order.release.order.queue"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                Binding"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"DestinationType"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"QUEUE"),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order.release.order"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),wo=l("blockquote",null,[l("ul",null,[l("li",null,[s("订单创建延迟时间到了之后，根据路由键-order.release.order-到达释放订单队列order.release.order.queue， 监听这个队列的方法 先是判断订单是不是已支付，如果不是就关闭订单，"),l("code",null,"关闭订单之后，根据路由键order.release.other 发送关闭的订单数据消息到交换机order-event-exchange，交换机再转发到order.release.coupon.queue优惠券队列，返回优惠券，与之通过 也是根据路由键order.release.other(待开发)")])])],-1),qo=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404124500812.png",alt:"image-20230404124500812"})],-1),Mo=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.listener.OrderCloseListener")]),l("li",null,[s("添加配置文件"),l("code",null,"application.properties"),s("中的RabbitMQ配置项")])],-1),Bo=l("div",{class:"language-properties"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"spring.rabbitmq.host"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"192.168.10.103")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"spring.rabbitmq.port"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"5672")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"spring.rabbitmq.virtual-host"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"/")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 开启发送端确认")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"spring.rabbitmq.publisher-confirms"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"true")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 开启发送端消息抵达队列的确认")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"spring.rabbitmq.publisher-returns"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"true")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 只要抵达队列，以异步发送优先回调我们这个returnConfirm")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"spring.rabbitmq.template.mandatory"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"true")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"# 手动ack消息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"spring.rabbitmq.listener.simple.acknowledge-mode"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"MANUAL")]),s(`
`),l("span",{class:"line"})])])],-1),Vo=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 订单释放(关单)监听器")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Service")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"RabbitListener"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#FFCB6B"}},"queues"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order.release.order.queue"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"class"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"OrderCloseListener"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Autowired")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"OrderService"),l("span",{style:{color:"#A6ACCD"}}," orderService"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"RabbitHandler")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"listener"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"entity"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Channel"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"channel"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Message"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"message"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"throws"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"IOException"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//等待死信时间到后收到订单消息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"收到过期的订单信息，准备关闭订单"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}},"entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderSn"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"try"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            orderService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"closeOrder"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"entity"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//手动调用支付宝收单")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//签收订单")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            channel"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"basicAck"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"message"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getMessageProperties"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getDeliveryTag"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"catch"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Exception"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"e"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            channel"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"basicReject"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"message"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getMessageProperties"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getDeliveryTag"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Po=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#closeOrder")])],-1),Ko=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"   * 关单方法，将订单新建(待付款)状态设置为已取消状态并发送消息给MQ确认关单完成")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"   * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"entity")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"*/")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"closeOrder"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#A6ACCD"}}," entity"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//查询当前这个订单的最新状态")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//将要发送的消息队列实体(释放订单服务前)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#A6ACCD"}}," orderEntity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"this."),l("span",{style:{color:"#82AAFF"}},"getById"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//status=0")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getStatus"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," OrderStatusEnum"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"CREATE_NEW"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCode"),l("span",{style:{color:"#89DDFF"}},"()){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//在待付款状态下才关单(消息队列的实体有可能过期了，所以创建新实体)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"OrderEntity"),l("span",{style:{color:"#A6ACCD"}}," update "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"OrderEntity"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        update"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setId"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// status=4")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        update"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setStatus"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"OrderStatusEnum"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"CANCLED"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCode"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"this."),l("span",{style:{color:"#82AAFF"}},"updateById"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"update"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"OrderTo"),l("span",{style:{color:"#A6ACCD"}}," orderTo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"OrderTo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        BeanUtils"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"copyProperties"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderEntity"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," orderTo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"try"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//todo 保证消息一定会发送出去，每一个消息都可以做好日志记录（给数据库保存每一个消息的详细信息）")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//todo 定期扫描数据库将失败的消息再发送一遍；")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//只要解锁成功了就【立即】发消息给MQ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            rabbitTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"convertAndSend"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"order.release.other"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," orderTo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"catch"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Exception"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"e"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//todo 将没发送成功的消息进行重试发送 （while）")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),No=l("p",null,[l("strong",null,"解锁库存"),s("： (MQ)")],-1),Wo=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.ware.config.MyRabbitConfig")])],-1),jo=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Exchange"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"stockEventExchange"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"TopicExchange"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Queue"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"stockReleaseStockQueue"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"Queue"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock.release.stock.queue"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false,"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Binding"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"stockReleaseBinding"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"Binding"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock.release.stock.queue"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                Binding"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"DestinationType"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"QUEUE"),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock-event-exchange"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},",")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock.release.#"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Qo=l("blockquote",null,[l("ul",null,[l("li",null,[l("code",null,"关闭订单之后，根据路由键order.release.other 发送关闭的订单数据到交换机order-event-exchange，交换机再转发到order.release.coupon.queue优惠券队列，返回优惠券，与之通过 也是根据路由键order.release.other，和数据一起转发到解锁库存队列stock.release.stock.queue 解锁库存(待开发)。")])])],-1),Ho=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404134206092.png",alt:"image-20230404134206092"})],-1),Uo=l("ul",null,[l("li",null,[l("p",null,"订单关闭，需要解锁已经占用的库存")]),l("li",null,[l("p",null,[l("code",null,"com.klaus.gulimall.ware.listener.StockReleaseListener")])])],-1),Go=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 监听库存解锁队列")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"RabbitListener"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#FFCB6B"}},"queues"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock.release.stock.queue"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Service")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"class"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"StockReleaseListener"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Autowired")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"WareSkuService"),l("span",{style:{color:"#A6ACCD"}}," wareSkuService"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"	/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 订单正常关闭(订单服务正常运行)，需要解锁已经占用的库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"to"),l("span",{style:{color:"#676E95","font-style":"italic"}}," 库存工作单(含工作单详情)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"RabbitHandler")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"handleStockLockedRelease"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"StockLockedTo"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"to"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Message"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"message"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Channel"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"channel"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"throws"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"IOException"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"收到解锁库存的消息..."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"try"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//当前消息是否被第二次及以后(重新)派发过来了")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//            Boolean redelivered = message.getMessageProperties().getRedelivered();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            wareSkuService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"unlockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"to"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//只要解锁成功了，就签收消息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            channel"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"basicAck"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"message"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getMessageProperties"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getDeliveryTag"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"catch"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Exception"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"e"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//有任何异常直接拒绝签收;消息拒绝以后重新放到队列里面，让别人继续消费解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            channel"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"basicReject"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"message"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getMessageProperties"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getDeliveryTag"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),zo=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.StockLockedTo)")])],-1),$o=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"unlockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"StockLockedTo"),l("span",{style:{color:"#A6ACCD"}}," to"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"...")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//问题：订单服务由于网络等原因迟迟没有将订单解锁(data.getStatus()==0)导致库存永远释放不了锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"taskDetailEntity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getLockStatus"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF"}},"){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//当前库存工作单详情，状态为1 已锁定但是未解锁才可以解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#82AAFF"}},"unLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"detail"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," detail"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getWareId"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," detail"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuNum"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," detailId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"	"),l("span",{style:{color:"#89DDFF"}},"...")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#A6ACCD"}},"    ")]),s(`
`),l("span",{class:"line"})])])],-1),Jo=l("ul",null,[l("li",null,"库存锁定成功，订单回滚，保证最终一致性，也需要库存自动解锁；库存锁定成功，订单服务全部炸了，订单都没有创建好，就必须有自动解锁功能"),l("li",null,[l("code",null,"com.klaus.gulimall.ware.listener.StockReleaseListener")])],-1),Xo=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 监听库存解锁队列")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"RabbitListener"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#FFCB6B"}},"queues"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"stock.release.stock.queue"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Service")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"class"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"StockReleaseListener"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Autowired")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"WareSkuService"),l("span",{style:{color:"#A6ACCD"}}," wareSkuService"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    /**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 订单异常关闭(订单服务发送运行时异常或宕机)，需要解锁已经占用的库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * 如果库存锁定成功，订单服务全部炸了，订单都没有创建好，就必须有自动解锁功能")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"orderTo"),l("span",{style:{color:"#676E95","font-style":"italic"}}," 完整订单信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"message")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"channel")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@throws"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#FFCB6B","font-style":"italic"}},"IOException")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"RabbitHandler")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"handleOrderCloseRelease"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"OrderTo"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"orderTo"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Message"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"message"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Channel"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"channel"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"throws"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"IOException"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"订单关闭准备解锁库存...."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"try"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            wareSkuService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"unlockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderTo"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//只要解锁成功了，就签收消息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            channel"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"basicAck"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"message"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getMessageProperties"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getDeliveryTag"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"false);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"catch"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Exception"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"e"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//有任何异常直接拒绝签收;消息拒绝以后重新放到队列里面，让别人继续消费解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            channel"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"basicReject"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"message"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getMessageProperties"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getDeliveryTag"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"true);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Yo=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.OrderTo)+#unLockStock")])],-1),Zo=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 防止订单服务卡顿，导致更改订单状态的操作无法完成以及更改的mq消息没有得到执行，解锁库存的消息优先到期，扫描订单状态是新建状态，就会什么都不做")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 导致卡顿的订单永远不能解锁库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"orderTo")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 加入统一事务")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Transactional")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"unlockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"OrderTo"),l("span",{style:{color:"#A6ACCD"}}," orderTo"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," orderSn "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," orderTo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderSn"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//查一下最新库存的状态，防止重复解锁库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"WareOrderTaskEntity"),l("span",{style:{color:"#A6ACCD"}}," task "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareOrderTaskService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getOrderTaskByOrderSn"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"orderSn"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," id "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," task"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//按照工作单找到所有 没有解锁的库存，进行解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," detailEntities "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wareOrderTaskDetailService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"list"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"QueryWrapper"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#89DDFF"}},">().")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#82AAFF"}},"eq"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"task_id"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," id"),l("span",{style:{color:"#89DDFF"}},").")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//新建的还没被解锁的库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#82AAFF"}},"eq"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"lock_status"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF"}},"));")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"for"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#A6ACCD"}}," entity "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},":"),l("span",{style:{color:"#A6ACCD"}}," detailEntities"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//此解锁方式可以解决高并发问题和整个系统的异构(两个服务开发语言不同。如java，php)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#82AAFF"}},"unLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getWareId"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuNum"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"private"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"unLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," skuId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," wareId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Integer"),l("span",{style:{color:"#A6ACCD"}}," num"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," taskDetailId"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//库存解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    wareSkuDao"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"unLockStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," wareId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," num"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//更新库存工作单的状态")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#A6ACCD"}}," entity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"WareOrderTaskDetailEntity"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setId"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"taskDetailId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    entity"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setLockStatus"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#F78C6C"}},"2"),l("span",{style:{color:"#89DDFF"}},");"),l("span",{style:{color:"#676E95","font-style":"italic"}},"//变为已解锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    wareOrderTaskDetailService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"updateById"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"entity"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),ln={id:"订单确认页流程",tabindex:"-1"},sn=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230322151416874.png",alt:"image-20230322151416874"})],-1),on={id:"电商订单流程图",tabindex:"-1"},nn=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230322151557139.png",alt:"image-20230322151557139"})],-1),en={id:"消息队列流程图",tabindex:"-1"},tn=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230416235749443.png",alt:"image-20230416235749443"})],-1),an={id:"支付宝支付流程图",tabindex:"-1"},cn=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230404162856264.png",alt:"image-20230404162856264"})],-1),rn={id:"项目难点",tabindex:"-1"},pn=l("ul",null,[l("li",null,[l("p",null,"订单服务与库存的联动(延时队列的使用)")]),l("li",null,[l("p",null,"订单释放&库存解锁"),l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230322190959538.png",alt:"image-20230322190959538"})])])],-1),yn={id:"解决问题",tabindex:"-1"},Dn=l("ul",null,[l("li",null,[l("p",null,[s("使用"),l("strong",null,"CompletableFuture 异步编排"),s("解决查询商品详情⻚"),l("strong",null,"响应速度慢的问题"),s("；")]),l("ul",null,[l("li",null,"假如商品详情页的每个查询，需要如下标注的时间才能完成 那么，用户需要 5.5s 后才能看到商品详情页的内容。很显然是不能接受的。 如果有多个线程同时完成这 6 步操作，也许只需要 1.5s 即可完成响应。")])]),l("li",null,[l("p",null,[s("使用"),l("strong",null,"Spring Cache方法级别缓存技术"),s("，实现已经被调用过的指定的目标方法，直接从缓存中获取方法调用后的结果返回，"),l("strong",null,"提高系统的响应速度；")])]),l("li",null,[l("p",null,"幂等解决方案"),l("ul",null,[l("li",null,[l("p",null,"token 机制"),l("ul",null,[l("li",null,[l("p",null,"1、服务端提供了发送 token 的接口。我们在分析业务的时候，哪些业务是存在幂等问题的，就必须在执行业务前，先去获取 token，服务器会把token 保存到 redis 中。")]),l("li",null,[l("p",null,"2、然后调用业务接口请求时，把 token 携带过去，一般放在请求头部。")]),l("li",null,[l("p",null,"3、服务器判断 token 是否存在 redis 中，存在表示第一次请求，然后删除 token,继续执行业务。")]),l("li",null,[l("p",null,"4、如果判断 token 不存在 redis 中，就表示是重复操作，直接返回重复标记给 client，这样就保证了业务代码，不被重复执行。")]),l("li",null,[l("p",null,"危险性："),l("ul",null,[l("li",null,[l("p",null,"1、先删除 token 还是后删除 token；")]),l("li",null,[l("p",null,"(1) 先删除可能导致，业务确实没有执行，重试还带上之前 token，由于防重设计导致，请求还是不能执行。")]),l("li",null,[l("p",null,"(2) 后删除可能导致，业务处理成功，但是服务闪断，出现超时，没有删除 token，别人继续重试，导致业务被执行两遍")]),l("li",null,[l("p",null,"(3) 我们最好设计为先删除 token，如果业务调用失败，就重新获取 token 再次请求。")]),l("li",null,[l("p",null,"2、Token 获取、比较和删除必须是原子性")]),l("li",null,[l("p",null,"(1) redis.get(token) 、token.equals、redis.del(token)如果这两个操作不是原子，可能导致，高并发下，都 get 到同样的数据，判断都成功，继续业务并发执行")]),l("li",null,[l("p",null,"(2) 可以在 redis 使用 lua 脚本完成这个操作")])])])])])]),l("div",{class:"language-shell"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," redis.call"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"get"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},", KEYS"),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF"}},"])"),l("span",{style:{color:"#A6ACCD"}}," == ARGV"),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF"}},"]"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"then"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," redis.call"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#C3E88D"}},"del"),l("span",{style:{color:"#89DDFF"}},"'"),l("span",{style:{color:"#A6ACCD"}},", KEYS"),l("span",{style:{color:"#89DDFF"}},"["),l("span",{style:{color:"#F78C6C"}},"1"),l("span",{style:{color:"#89DDFF"}},"])"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#A6ACCD"}}," end")]),s(`
`),l("span",{class:"line"})])])])]),l("li",null,[l("p",null,"Session共享问题解决-不同服务，子域session共享"),l("ul",null,[l("li",null,"jsessionid这个cookie默认是当前系统域名的。当我们分拆服务，不同域名部署的时候，我们可以使用如下解决方案；")]),l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230323001610876.png",alt:"image-20230323001610876"})]),l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Configuration")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"class"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"GulimallSessionConfig"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"CookieSerializer"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"cookieSerializer"),l("span",{style:{color:"#89DDFF"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"DefaultCookieSerializer"),l("span",{style:{color:"#A6ACCD"}}," cookieSerializer "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"DefaultCookieSerializer"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        cookieSerializer"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setDomainName"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"gulimall.com"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        cookieSerializer"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setCookieName"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"KLAUSSESSION"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," cookieSerializer"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"RedisSerializer"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Object"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"springSessionDefaultRedisSerializer"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"GenericJackson2JsonRedisSerializer"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])]),l("ul",null,[l("li",null,"SpringSession核心原理")]),l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 加入依赖")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *          <dependency>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *             <groupId>org.springframework.boot</groupId>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *             <artifactId>spring-boot-starter-data-redis</artifactId>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         </dependency>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         <!--整合Springsession完成session共享问题-->")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         <dependency>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *             <groupId>org.springframework.session</groupId>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *             <artifactId>spring-session-data-redis</artifactId>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         </dependency>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 核心原理")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 1、@EnableRedisHttpSession导入RedisHttpSessionConfiguration配置")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      1）、给容器中添加了一个组件")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *          传入SessionRepository==》【RedisOperationsSessionRepository】===》redis操作session，session的增删改查封装类")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      2）、SessionRepositoryFilter==》Filter(web)：session存储过滤器；每个请求过来都必须经过Filter")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         I）、创建的时候，就自动从容器中获取了SessionRepository")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         II）、原始的HttpServletRequest request, HttpServletResponse response都被分别包装成了SessionRepositoryRequestWrapper，SessionRepositoryResponseWrapper")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         III）、以后获取session-》request.getSession();（原始的）")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         //SessionRepositoryRequestWrapper重写getSession方法")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         IV）、wrapperRequest.getSession();==> SessionRepository中获取的到")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *  装饰者模式；")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *  自动延期；redis中的数据也是有过期时间的")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"EnableRedisHttpSession"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//整合redis作为session存储")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"SpringBootApplication")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"class"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"GulimallAuthServerApplication"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"static"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"main"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},"[]"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"args"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        SpringApplication"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"run"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"GulimallAuthServerApplication"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"class"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," args"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])]),l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230323001706985.png",alt:"image-20230323001706985"})])]),l("li",null,[l("p",null,"ThreadLocal-同一个线程共享数据")])],-1),Fn=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230323001857265.png",alt:"image-20230323001857265"})],-1),An=l("ul",null,[l("li",null,[l("p",null,"Feign远程调用丢失请求头问题"),l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230323001742038.png",alt:"image-20230323001742038"})]),l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.member.config")])])])],-1),Cn=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Configuration")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"class"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"GulimallFeignConfig"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Bean"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"requestInterceptor"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"RequestInterceptor"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"requestInterceptor"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//RequestContextHolder.setRequestAttributes(requestAttributes);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// 进行共享操作，拦截器才会有请求上下文的所有数据")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"RequestInterceptor"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"void"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"apply"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"RequestTemplate"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"template"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、RequestContextHolder拿到刚进来的这个请求")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#C792EA"}},"ServletRequestAttributes"),l("span",{style:{color:"#A6ACCD"}}," attributes "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"ServletRequestAttributes"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," RequestContextHolder"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getRequestAttributes"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"attributes "),l("span",{style:{color:"#89DDFF"}},"!="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"RequestInterceptor线程...."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}},"Thread"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"currentThread"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    "),l("span",{style:{color:"#C792EA"}},"HttpServletRequest"),l("span",{style:{color:"#A6ACCD"}}," request "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," attributes"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getRequest"),l("span",{style:{color:"#89DDFF"}},"();"),l("span",{style:{color:"#676E95","font-style":"italic"}},"//老请求")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"request "),l("span",{style:{color:"#89DDFF"}},"!="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//请求不为空")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//同步请求头数据，Cookie")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                        "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," cookie "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," request"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getHeader"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"Cookie"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},'//                System.out.println("feign远程之前先进行RequestInterceptor.apply");')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//给新请求同步了老请求的Cookie")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                        template"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"header"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"Cookie"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," cookie"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"};")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),un=l("ul",null,[l("li",null,[l("p",null,"Feign异步情况丢失上下文问题"),l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230323001802654.png",alt:"image-20230323001802654"})]),l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#confirmOrder")])])])],-1),dn=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//获取原来请求上下文请求属性")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"RequestAttributes"),l("span",{style:{color:"#A6ACCD"}}," requestAttributes "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," RequestContextHolder"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getRequestAttributes"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"//进行异步编排")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Void"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," getAddressFuture "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"runAsync"),l("span",{style:{color:"#89DDFF"}},"(()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1、远程查询所有的收货地址列表")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"member线程...."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," Thread"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"currentThread"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//在Feign异步调用前将请求上下文进行共享操作(之前的请求数据都来共享每一个线程)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    RequestContextHolder"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setRequestAttributes"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"requestAttributes"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"MemberAddressVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," address "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," memberFeignService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getAddress"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"memberRespVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    confirmVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setAddress"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"address"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Void"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," cartFuture "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"runAsync"),l("span",{style:{color:"#89DDFF"}},"(()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//2、远程查询购物车所有选中的购物项")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"out"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"println"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"cart线程...."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," Thread"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"currentThread"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"getId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//在Feign异步调用前将请求上下文进行共享操作")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    RequestContextHolder"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setRequestAttributes"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"requestAttributes"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderItemVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," items "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," cartFeignService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"currentUserCartItems"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    confirmVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setItems"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"items"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//feign在远程调用之前要构造请求，调用很多的拦截器")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//for(RequestInterceptor interceptor:requestInterceptors)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},")."),l("span",{style:{color:"#82AAFF"}},"thenRunAsync"),l("span",{style:{color:"#89DDFF"}},"(()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"OrderItemVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," items "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," confirmVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getItems"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," skuIds "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," items"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"stream"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"map"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"item "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," item"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},"())."),l("span",{style:{color:"#82AAFF"}},"collect"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"Collectors"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"toList"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//远程查询库存")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," r "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," wmsFeignService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkusHasStock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuIds"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SkuStockVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," data "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," r"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getData"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"TypeReference"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SkuStockVo"),l("span",{style:{color:"#89DDFF"}},">>()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"});")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"data "),l("span",{style:{color:"#89DDFF"}},"!="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null)"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// Map<SkuId, hasStock> map")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"Map"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Boolean"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," map "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," data"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"stream"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"collect"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"Collectors"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"toMap"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"SkuStockVo"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),l("span",{style:{color:"#A6ACCD"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," SkuStockVo"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"::"),l("span",{style:{color:"#A6ACCD"}},"getHasStock"),l("span",{style:{color:"#89DDFF"}},"));")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// Map<Long, Boolean> stocks;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        confirmVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setStocks"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"map"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"})])])],-1),gn={id:"项目优化",tabindex:"-1"},hn=l("ul",null,[l("li",null,"使用动态线程池管理和监控，定时获取线程池的运行数据")],-1),mn=l("p",null,"Hippo4j 提供了应用线程池运行时变更核心参数的功能。而且，如果应用是集群部署，可以选择修改线程池某一实例，或者修改集群全部实例，运行时生效，不需要再重启服务。",-1),En=l("p",null,"压测时可以使用 Hippo4j 动态调整线程池参数，判断线程池核心参数设置是否合理。对于开发测试来说，如果不满足可以随时调整。",-1),fn={id:"completablefuture异步编排",tabindex:"-1"},_n={id:"概念",tabindex:"-1"},kn=l("ul",null,[l("li",null,"CompletableFuture是JDK1.8里面引入的一个异步回调类，就是说当前使用异步线程去执行一个任务时候，我们希望在这个任务结束以后，触发一个后续的动作，而CompletableFuture就可以实现这样的功能。")],-1),bn={id:"业务场景",tabindex:"-1"},Sn=l("ul",null,[l("li",null,"查询商品详情页的逻辑比较复杂，有些数据还需要远程调用，必然需要花费更多的时间。")],-1),vn=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230322152108985.png",alt:"image-20230322152108985"})],-1),xn=l("ul",null,[l("li",null,"假如商品详情页的每个查询，需要如下标注的时间才能完成 那么，用户需要 5.5s 后才能看到商品详情页的内容。很显然是不能接受的。 如果有多个线程同时完成这 6 步操作，也许只需要 1.5s 即可完成响应。"),l("li",null,"在 Java 8 中, 新增加了一个包含 50 个方法左右的类: CompletableFuture，提供了非常强大的 Future 的扩展功能，可以帮助我们简化异步编程的复杂性，提供了函数式编程的能力，可以 通过回调的方式处理计算结果，并且提供了转换和组合 CompletableFuture 的方法。")],-1),In={id:"项目代码",tabindex:"-1"},Tn=l("ul",null,[l("li",null,[l("code",null,"com.klaus.gulimall.product.service.impl.SkuInfoServiceImpl#item")])],-1),Ln=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//四、线程串行化方法")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"/*")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    thenApply 方法：当一个线程依赖另一个线程时，获取上一个任务返回的结果，并返回当前")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    任务的返回值。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    thenAccept 方法：消费处理结果。接收任务的处理结果，并消费处理，无返回结果。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    thenRun 方法：只要上面的任务执行完成，就开始执行 thenRun，只是处理完任务后，执行")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    thenRun 的后续操作")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    带有 Async 默认是异步执行的。同之前。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    以上都要前置任务成功完成。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"	"),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"SkuItemVo"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"item"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," skuId"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," throws ExecutionException"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," InterruptedException "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"SkuItemVo"),l("span",{style:{color:"#A6ACCD"}}," skuItemVo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"SkuItemVo"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//一、创建异步对象")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"/*")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"         runAsync和supplyAsync  runXxxx 都是没有返回结果的，supplyXxx 都是可以获取返回结果的")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"         可以传入自定义的线程池，否则就用默认的线程池；")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"         */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SkuInfoEntity"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," infoFuture "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"supplyAsync"),l("span",{style:{color:"#89DDFF"}},"(()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//1.sku基本信息获取 pms_sku_info")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"SkuInfoEntity"),l("span",{style:{color:"#A6ACCD"}}," info "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"this."),l("span",{style:{color:"#82AAFF"}},"getById"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            skuItemVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setInfo"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"info"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," info"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Void"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," saleAttrFuture "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," infoFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"thenAcceptAsync"),l("span",{style:{color:"#89DDFF"}},"(("),l("span",{style:{color:"#A6ACCD"}},"res"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//3、 获取spu的销售属性组合")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SkuItemSaleAttrVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," saleAttrVos "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," skuSaleAttrValueService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSaleAttrBySpuId"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"res"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSpuId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        skuItemVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setSaleAttr"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"saleAttrVos"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Void"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," descFuture "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," infoFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"thenAcceptAsync"),l("span",{style:{color:"#89DDFF"}},"(("),l("span",{style:{color:"#A6ACCD"}},"res"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//4.获取spu的介绍 pms_spu_info_desc")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"SpuInfoDescEntity"),l("span",{style:{color:"#A6ACCD"}}," spuInfoDescEntity "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," spuInfoDescService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getById"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"res"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSpuId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        skuItemVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setDesc"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"spuInfoDescEntity"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Void"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," baseAttrFuture "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," infoFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"thenAcceptAsync"),l("span",{style:{color:"#89DDFF"}},"(("),l("span",{style:{color:"#A6ACCD"}},"res"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//5.获取spu的规格参数信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SpuItemAttrGroupVo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," attrGroupVos "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," attrGroupService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getAttrGroupWithAttrsBySpuId"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"res"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSpuId"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}}," res"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCatalogId"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        skuItemVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setGroupAttrs"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"attrGroupVos"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//一、创建异步对象")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"/*")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     runAsync和supplyAsync  runXxxx 都是没有返回结果的，supplyXxx 都是可以获取返回结果的")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     可以传入自定义的线程池，否则就用默认的线程池；")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//2.sku图片信息  pms_spu_images")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Void"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," imageFuture "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"runAsync"),l("span",{style:{color:"#89DDFF"}},"(()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SkuImagesEntity"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," imagesEntities "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," skuImagesService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getImagesBySkuId"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        skuItemVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setImages"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"imagesEntities"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//TODO //3、远程调用查询当前sku是否参与秒杀优惠活动")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"Void"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," seckillFuture "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"runAsync"),l("span",{style:{color:"#89DDFF"}},"(()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"->"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//3.远程调用查询当前sku是否参与秒杀优惠活动")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," skuSeckilInfo "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," seckillFeignService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuSeckilInfo"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuSeckilInfo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCode"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"=="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F78C6C"}},"0"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//查询成功")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#C792EA"}},"SeckillSkuVo"),l("span",{style:{color:"#A6ACCD"}}," skuSeckilInfoData "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," skuSeckilInfo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getData"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"data"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"new"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"TypeReference"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"SeckillSkuVo"),l("span",{style:{color:"#89DDFF"}},">()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"});")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            skuItemVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setSeckillSkuVo"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuSeckilInfoData"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"skuSeckilInfoData "),l("span",{style:{color:"#89DDFF"}},"!="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"null)"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#C792EA"}},"long"),l("span",{style:{color:"#A6ACCD"}}," currentTime "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," System"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"currentTimeMillis"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"currentTime "),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," skuSeckilInfoData"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getEndTime"),l("span",{style:{color:"#89DDFF"}},"())"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                    skuItemVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"setSeckillSkuVo"),l("span",{style:{color:"#89DDFF"}},"(null);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF"}},"},"),l("span",{style:{color:"#A6ACCD"}}," executor"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//七、多任务组合")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"/*")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    allOf：等待所有任务完成")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    anyOf：只要有一个任务完成")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//等到所有任务完成  //TODO 秒杀优惠活动Future")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    CompletableFuture"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"allOf"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"saleAttrFuture"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}},"descFuture"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}},"baseAttrFuture"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}},"imageFuture"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}},"seckillFuture"),l("span",{style:{color:"#89DDFF"}},")."),l("span",{style:{color:"#82AAFF"}},"get"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," skuItemVo"),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),On={id:"rabbitmq延时队列（实现定时任务）",tabindex:"-1"},Rn={id:"场景：",tabindex:"-1"},wn=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230322165119843.png",alt:"image-20230322165119843"})],-1),qn=l("ul",null,[l("li",null,[l("p",null,"比如未付款订单，超过一定时间后，系统自动取消订单并释放占有物品。")]),l("li",null,[l("p",null,"常用解决方案：spring的 schedule 定时任务轮询数据库"),l("ul",null,[l("li",null,[l("p",null,"缺点：消耗系统内存、增加了数据库的压力、存在较大的时间误差")]),l("li",null,[l("p",null,"定时任务的时效性问题"),l("p",null,"定时任务开启的第一次扫描，订单未创建，1min后创建完成，30min第二次扫描订单未过期，无事发生，31min订单过期，直到60min第三次扫描才扫到过期订单"),l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230322165931065.png",alt:"image-20230322165931065"})])])])]),l("li",null,[l("p",null,"解决：rabbitmq的消息TTL和死信Exchange结合")]),l("li",null,[l("p",null,"订单释放&库存解锁")])],-1),Mn=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410190115962.png",alt:"image-20230410190115962"})],-1),Bn={id:"消息的ttl（time-to-live）",tabindex:"-1"},Vn=l("ul",null,[l("li",null,"消息的TTL就是消息的存活时间。"),l("li",null,"RabbitMQ可以对队列和消息分别设置TTL。"),l("li",null,[s("对队列设置就是队列没有消费者连着的保留时间，"),l("strong",null,"也可以对每一个单独的消息做单独的"),l("strong",null,"设置。超过了这个时间，我们认为这个消息就死了，称之为死信"),s("。")]),l("li",null,[s("如果队列设置了，消息也设置了，那么会"),l("strong",null,"取小的"),s("。所以一个消息如果被路由到不同的队 列中，这个消息死亡的时间有可能不一样（不同的队列设置）。这里单讲单个消息的 TTL，因为它才是实现延迟任务的关键。可以通过"),l("strong",null,"设置消息的expiration字段或者x-"),l("strong",null,"message-ttl属性来设置时间"),s("，两者是一样的效果。")])],-1),Pn={id:"dead-letter-exchanges（dlx）",tabindex:"-1"},Kn=l("ul",null,[l("li",null,[l("p",null,"一个消息在满足如下条件下，会进"),l("p",null,"死信路由"),l("p",null,"，记住这里是路由而不是队列，"),l("p",null,"一个路由可以对应很多队列。（什么是死信）"),l("ul",null,[l("li",null,"一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不 会被再次放在队列里，被其他消费者使用。 （ basic.reject/ basic.nack ） requeue=false"),l("li",null,"上面的消息的TTL到了，消息过期了。"),l("li",null,"队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上")])]),l("li",null,[l("p",null,"Dead Letter Exchange其实就是一种普通的exchange，和创建其他 exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有 消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。")]),l("li",null,[l("p",null,"我们既可以控制消息在一段时间后变成死信，又可以控制变成死信的消息 被路由到某一个指定的交换机，结合二者，其实就可以实现一个延时队列")]),l("li",null,[l("p",null,"手动ack&异常消息统一放在一个队列处理建议的两种方式")]),l("li",null,[l("p",null,"catch异常后，手动发送到指定队列，然后使用channel给rabbitmq确认消息已消费")]),l("li",null,[l("p",null,"给Queue绑定死信队列，使用nack（requque为false）确认消息消费失败")])],-1),Nn={id:"延时队列实现",tabindex:"-1"},Wn=l("ul",null,[l("li",null,"给队列设置过期时间")],-1),jn=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230322152334742.png",alt:"image-20230322152334742"})],-1),Qn=l("ul",null,[l("li",null,"给消息设置过期时间")],-1),Hn=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230322152358754.png",alt:"image-20230322152358754"})],-1),Un=l("ul",null,[l("li",null,"推荐：给队列设置过期时间，因为给消息设置过期时间的话，RabbitMQ采用的是惰性检查机制，假设队列里面的消息过期时间不同，后面的消息必须等前面的消息过期，最终导致消息不能按照规定的过期时间过期。")],-1),Gn={id:"springboot中使用延时队列",tabindex:"-1"},zn=l("ul",null,[l("li",null,"1、Queue、Exchange、Binding可以@Bean进去"),l("li",null,[s("2、监听消息的方法可以有三种参数（不分数量，顺序） "),l("ul",null,[l("li",null,"Object content, Message message, Channel channel")])]),l("li",null,"3、channel可以用来拒绝消息，否则自动ack；")],-1),$n={id:"消息队列流程",tabindex:"-1"},Jn=l("ul",null,[l("li",null,"使用RabbitMQ延时队列实现未付款订单，超过一定时间后，系统自动取消订单并解锁库存。"),l("li",null,"PS:创建订单 进入路由键-order.create.order- 进入交换机order-event-exchange， 根据路由键会转发到延时队列order.delay.queue 1min过期时间，过期时间到了之后，根据路由键order.release.order-到达释放订单队列order.release.order.queue， 监听这个队列的方法 先是判断订单是不是已支付，如果不是 就关闭订单，关闭订单之后，根据路由键order.release.other 发送关闭的订单数据到交换机order-event-exchange，交换机再转发到order.release.coupon.queue优惠券队列，返回优惠券，与之通过 也是根据路由键order.release.other，和数据一起转发到解锁库存队列stock.release.stock.queue 解锁库存。")],-1),Xn=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230416235749443.png",alt:"image-20230416235749443"})],-1),Yn={id:"redis缓存中的数据结构",tabindex:"-1"},Zn={id:"分类菜单",tabindex:"-1"},le=l("ul",null,[l("li",null,"类型：String"),l("li",null,"value: 菜单信息")],-1),se={id:"登陆信息-springsession",tabindex:"-1"},oe={id:"购物车",tabindex:"-1"},ne=l("ul",null,[l("li",null,"类型：Hash"),l("li",null,"key: gulimall:cart:2 // 2为用户ID"),l("li",null,"field: 商品 id"),l("li",null,"value: 购物项数据"),l("li",null,[s("综上所述，我们的购物车结构是一个双层 Map：Map<String,Map<String,String>> "),l("ul",null,[l("li",null,"第一层 Map，Key 是用户 id"),l("li",null,"第二层 Map，Key 是购物车中商品 id，值是购物项数据")])])],-1),ee={id:"秒杀上架-幂等性处理",tabindex:"-1"},te=l("ul",null,[l("li",null,[s("缓存秒杀活动信息 (seckill:session:) "),l("ul",null,[l("li",null,"类型: List"),l("li",null,"key: seckill:session:start_endtime // 开始时间的时间戳_结束时间的时间戳"),l("li",null,"value: 场次ID_商品ID")])]),l("li",null,[s("缓存秒杀活动所关联的商品信息 (seckill:skus) "),l("ul",null,[l("li",null,"类型：Hash"),l("li",null,"key: seckill:skus"),l("li",null,"field: 场次ID_商品ID"),l("li",null,"value: 秒杀商品信息")])]),l("li",null,[s("秒杀库存信号量 "),l("ul",null,[l("li",null,"类型： String"),l("li",null,"key: seckIll:stock:UUID"),l("li",null,"value: 库存数量")])])],-1),ae={id:"幂等性保证",tabindex:"-1"},ce=l("ul",null,[l("li",null,"缓存商品信息前，先判断有没有这个key")],-1),re=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," redisKey "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," seckillSkuVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getPromotionSessionId"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"toString"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"-"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," seckillSkuVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSkuId"),l("span",{style:{color:"#89DDFF"}},"()."),l("span",{style:{color:"#82AAFF"}},"toString"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"(!"),l("span",{style:{color:"#A6ACCD"}},"operations"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"hasKey"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"redisKey"),l("span",{style:{color:"#89DDFF"}},"))"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"              "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//判断Redis中是否有该信息，如果没有才进行添加")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#C792EA"}},"Boolean"),l("span",{style:{color:"#A6ACCD"}}," hasKey "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," redisTemplate"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"hasKey"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"key"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//缓存活动信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"(!"),l("span",{style:{color:"#A6ACCD"}},"hasKey"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"})])])],-1),pe={id:"redission分布式锁",tabindex:"-1"},ie=l("ul",null,[l("li",null,"设置分布式锁以及信号量-关键代码")],-1),ye=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"    "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//秒杀商品上架功能的锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    "),l("span",{style:{color:"#C792EA"}},"private"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"final"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#A6ACCD"}}," upload_lock "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"seckill:upload:lock"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"    ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//分布式锁 .可重入锁（Reentrant Lock）")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#C792EA"}},"RLock"),l("span",{style:{color:"#A6ACCD"}}," lock "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," redissonClient"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getLock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"upload_lock"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"try"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"            "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//加锁")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            lock"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"lock"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#F78C6C"}},"10"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," TimeUnit"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"SECONDS"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            seckillService"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"uploadSeckillSkuLatest3Days"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"catch"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Exception"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"e"),l("span",{style:{color:"#89DDFF"}},"){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            e"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"printStackTrace"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}"),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"finally"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            lock"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"unlock"),l("span",{style:{color:"#89DDFF"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"          "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//如果当前这个场次的商品库存信息已经上架就不需要上架")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"//5、使用库存作为分布式Redisson信号量（限流）")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// 使用库存作为分布式信号量")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                        "),l("span",{style:{color:"#C792EA"}},"RSemaphore"),l("span",{style:{color:"#A6ACCD"}}," semaphore "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," redissonClient"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSemaphore"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"SKU_STOCK_SEMAPHORE "),l("span",{style:{color:"#89DDFF"}},"+"),l("span",{style:{color:"#A6ACCD"}}," token"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"                        "),l("span",{style:{color:"#676E95","font-style":"italic"}},"// 商品可以秒杀的数量作为信号量")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"                        semaphore"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"trySetPermits"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"seckillSkuVo"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getSeckillCount"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"})])])],-1),De={id:"分布式事务",tabindex:"-1"},Fe=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230322165148070.png",alt:"image-20230322165148070"})],-1),Ae=l("ul",null,[l("li",null,[l("strong",null,"事务保证：")])],-1),Ce=l("ol",null,[l("li",null,"订单服务异常，库存锁定不运行，全部回滚，撤销操作"),l("li",null,"库存服务事务自治，锁定失败全部回滚，订单感受到，继续回滚"),l("li",null,"库存服务锁定成功了，但是网络原因返回数据途中问题？"),l("li",null,"库存服务锁定成功了，库存服务下面的逻辑发生故障，订单回滚了，怎么处理？")],-1),ue=l("ul",null,[l("li",null,[l("strong",null,"利用消息队列实现最终一致")])],-1),de=l("p",null,"库存服务锁定成功后发给消息队列消息（当前库存工作单），过段时间自动解锁，解锁时先查询订单的支付状态。解锁成功修改库存工作单详情项状态为已解锁",-1),ge=l("ul",null,[l("li",null,[s("1、远程服务假失败： "),l("ul",null,[l("li",null,"远程服务其实成功了，由于网络故障等没有返回"),l("li",null,"导致：订单回滚，库存却扣减")])]),l("li",null,[s("2、远程服务执行完成，下面的其他方法出现问题 "),l("ul",null,[l("li",null,"导致：已执行的远程请求，肯定不能回滚")])])],-1),he={id:"事务的坑",tabindex:"-1"},me=l("ul",null,[l("li",null,"在同一个类里面，编写两个方法，内部调用的时候，会导致事务设置失效。原因是没有用到代理对象的缘故。"),l("li",null,[s("解决： "),l("ul",null,[l("li",null,"0）、导入 spring-boot-starter-aop"),l("li",null,"1）、@EnableTransactionManagement(proxyTargetClass = true)"),l("li",null,"2）、@EnableAspectJAutoProxy(exposeProxy=true)"),l("li",null,"3）、AopContext.currentProxy() 调用方法")])])],-1),Ee={id:"cap理论",tabindex:"-1"},fe=l("ul",null,[l("li",null,[s("C是"),l("strong",null,"一致性"),s("，分布式系统的"),l("strong",null,"数据要保持一致")]),l("li",null,[s("A是"),l("strong",null,"可用性"),s("，分布式系统能进行"),l("strong",null,"故障转移")]),l("li",null,[s("P是"),l("strong",null,"分区容错性"),s("，分布式系统"),l("strong",null,"出现网络问题能正常运行")]),l("li",null,"CAP理论是指分布式系统中不能保证三者同时存在，只能两两组合")],-1),_e={id:"base-理论",tabindex:"-1"},ke=l("ul",null,[l("li",null,[s("是对 CAP 理论的延伸，思想是即使无法做到强一致性（CAP 的一致性就是强一致性），但可 以采用适当的采取弱一致性，即"),l("strong",null,"最终一致性。")])],-1),be={id:"分布式事务几种方案",tabindex:"-1"},Se=l("ul",null,[l("li",null,[s("2PC 模式 "),l("ul",null,[l("li",null,[s("数据库支持的 2PC【2 phase commit 二阶提交】，又叫做 XA Transactions。 "),l("ul",null,[l("li",null,"第一阶段：事务协调器要求每个涉及到事务的数据库预提交(precommit)此操作，并反映是 否可以提交."),l("li",null,"第二阶段：事务协调器要求每个数据库提交数据。")])]),l("li",null,[l("strong",null,"性能不理想")])])]),l("li",null,[s("柔性事务-TCC 事务补偿型方案 "),l("ul",null,[l("li",null,"一阶段 prepare 行为：调用 自定义 的 prepare 逻辑。"),l("li",null,"二阶段 commit 行为：调用 自定义 的 commit 逻辑。"),l("li",null,"二阶段 rollback 行为：调用 自定义 的 rollback 逻辑。"),l("li",null,"所谓 TCC 模式，是指支持把 自定义 的分支事务纳入到全局事务的管理中")])]),l("li",null,[s("柔性事务-最大努力通知型方案 "),l("ul",null,[l("li",null,[s("按规律进行通知，"),l("strong",null,"不保证数据一定能通知成功，但会提供可查询操作接口进行核对"),s("。")]),l("li",null,"这种 方案主要用在与第三方系统通讯时，比如：调用微信或支付宝支付后的支付结果通知。"),l("li",null,"这种 方案也是结合 MQ 进行实现，例如：通过 MQ 发送 http 请求，设置最大通知次数。达到通知次数后即不再通知。")])]),l("li",null,[s("柔性事务-"),l("strong",null,"可靠消息"),s("+最终一致性方案（异步确保型） "),l("ul",null,[l("li",null,"实现：业务处理服务在业务事务提交之前，向实时消息服务请求发送消息，实时消息服务只 记录消息数据，而不是真正的发送。业务处理服务在业务事务提交之后，向实时消息服务确 认发送。只有在得到确认发送指令后，实时消息服务才会真正发送。"),l("li",null,[s("防止消息丢失： "),l("ul",null,[l("li",null,"1、做好消息确认机制（pulisher，consumer【手动 ack】）"),l("li",null,"2、每一个发送的消息都在数据库做好记录。定期将失败的消息再次发送一 遍")])])])])],-1),ve=l("blockquote",null,[l("p",null,"刚性事务：遵循 ACID 原则，强一致性。"),l("p",null,"柔性事务：遵循 BASE 理论，最终一致性；"),l("p",null,"与刚性事务不同，柔性事务允许一定时间内，不同节点的数据不一致，但要求最终一致。")],-1),xe={id:"seata",tabindex:"-1"},Ie={id:"seata的理解",tabindex:"-1"},Te=l("ul",null,[l("li",null,[s("Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。 "),l("ul",null,[l("li",null,[s("AT模式。是一种基于"),l("strong",null,"本地事务+二阶段协议"),s("来实现的"),l("strong",null,"最终数据一致性方案"),s("，也是Seata默认的解决方案。")]),l("li",null,[s("TCC模式，TCC事务是Try,Confirm,Cancel 三个词语的缩写，简单理解就是把"),l("strong",null,"一个完整的业务逻辑拆分成三个阶段"),s("，然后通过事务管理器在业务逻辑层面，根据每个分支事务的执行情况分别调用该业务的Confirm 或者Cacel方法。")]),l("li",null,[s("Saga模式，Saga模式是SEATA提供"),l("strong",null,"长事务解决方案"),s("，在Saga模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者。")]),l("li",null,[s("XA模式，XA可以认为是一种"),l("strong",null,"强一致性的事务解决方法"),s("，它利用事务资源（数据库，消息服务等）对XA协议的支持，以XA协议的机制来管理分支事务的一种事务模式。")])])])],-1),Le={id:"tc-transaction-coordinator-事务协调者",tabindex:"-1"},Oe=l("ul",null,[l("li",null,"维护全局和分支事务的状态，驱动全局事务提交或回滚。")],-1),Re={id:"tm-transaction-manager-事务管理器",tabindex:"-1"},we=l("ul",null,[l("li",null,"定义全局事务的范围：开始全局事务、提交或回滚全局事务。")],-1),qe={id:"rm-resource-manager-资源管理器",tabindex:"-1"},Me=l("ul",null,[l("li",null,"管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。")],-1),Be=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230322152804762.png",alt:"image-20230322152804762"})],-1),Ve={id:"seata项目整合",tabindex:"-1"},Pe=l("li",null,"Seata控制分布式事务",-1),Ke=l("li",null,"1）、每一个微服务先必须创建 undo_log；",-1),Ne=l("li",null,"1、导入依赖 spring-cloud-starter-alibaba-seata seata-all-0.7.1",-1),We=l("li",null,[s("2、解压并启动seata-server； "),l("ul",null,[l("li",null,"registry.conf: 注册中心配置； 修改registry type=nacos"),l("li",null,"file.conf：")])],-1),je=l("li",null,"3、所有想要用到分布式事务的微服务使用seata DataSourceProxy代理自己的数据源",-1),Qe=l("li",null,"registry.conf",-1),He=l("li",null,"5、启动测试分布式事务",-1),Ue=l("li",null,"6、给分布式大事务的入口标注@GlobalTransactional",-1),Ge=l("li",null,"7、每一个远程的小事务用 @Transactional",-1),ze=l("p",null,"应用场景：",-1),$e=l("ul",null,[l("li",null,[s("订单服务提交订单，库存服务扣减库存 "),l("ul",null,[l("li",null,"seta-提交订单接口 OrderServiceImpl 类submitOrder（）方法 加 @GlobalTransactional"),l("li",null,"（下单是高并发场景，不推荐seata分布式事务。推荐用消息队列 最终一致性）")])]),l("li",null,"商品服务保持商品信息，远程调用优惠服务保持商品优惠券信息"),l("li",null,[l("ul",null,[l("li",null,"开启seta全局事务-SpuInfoServiceImpl类saveSpuInfo()方法 （推荐）")])])],-1),Je={id:"sentinel",tabindex:"-1"},Xe={id:"sentinel理解",tabindex:"-1"},Ye=l("ul",null,[l("li",null,[s("随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从"),l("strong",null,"流量控制、熔断降级"),s("、系统负载保护等多个维度保护服务的稳定性。")]),l("li",null,[s("我们说的资源，可以是任何东西，服务，服务里的方法，甚至是一段代码。使用 Sentinel 来进行资源保护，主要分为几个步骤: "),l("ol",null,[l("li",null,"定义资源"),l("li",null,"定义规则"),l("li",null,"检验规则是否生效")])]),l("li",null,[s("Sentinel 分为两个部分: "),l("ul",null,[l("li",null,"核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时 对 Dubbo / Spring Cloud 等框架也有较好的支持。"),l("li",null,"控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器")])])],-1),Ze={id:"熔断降级限流",tabindex:"-1"},lt=l("ul",null,[l("li",null,[s("熔断 "),l("ul",null,[l("li",null,"A 服务调用 B 服务的某个功能，B服务卡死，功能时间超长，我们就将B断路，返回降级数据。")])]),l("li",null,[s("降级 "),l("ul",null,[l("li",null,"流量高峰期，服务器压力剧增，对一些页面和服务做策略的降级（停止服务，调用直接返回降级数据）")])]),l("li",null,[s("熔断、降级区别 "),l("ul",null,[l("li",null,[s("相同点 "),l("ul",null,[l("li",null,"保证服务的可用性")])]),l("li",null,[s("不同点 "),l("ul",null,[l("li",null,"1、熔断是被调用方故障，触发的系统主动规则"),l("li",null,"2、降级是基于全局考虑，停止一些正常服务，释放资源")])])])]),l("li",null,[s("限流 "),l("ul",null,[l("li",null,"对打入服务的请求流量进行控制，使服务能够承担不超过自己能力的流量压力")])])],-1),st={id:"项目整合步骤",tabindex:"-1"},ot=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 1、整合Sentinel")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 1）、导入依赖 spring-cloud-starter-alibaba-sentinel")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 2）、下载sentinel的控制台")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 3）、配置sentinel控制台地址信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 4) 、在控制台调整参数。【默认所有的流控设置保存在内存中，重启失效】")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"      *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"       *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 2、每一个微服务都导入 actuator ()；并配合management.endpoints.web.exposure.include=*")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 3、自定义sentinel流控返回数据")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"   *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 4、使用Sentinel来保护feign远程调用：熔断；")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 1）、调用方的熔断保护：feign.sentinel.enabled=true")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 2）、调用方手动指定远程服务的降级策略。远程服务被降级处理。触发我们的熔断回调方法")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 3）、超大浏览的时候，必须牺牲一些远程服务。在服务的提供方（远程服务）指定降级策略；")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 提供方是在运行。但是不运行自己的业务逻辑，返回的是默认的降级数据（限流的数据），")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 5、自定义受保护的资源")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 1）、代码")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},' * try(Entry entry = SphU.entry("seckillSkus")){')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * //业务逻辑")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * }")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * catch(Execption e){}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 2）、基于注解。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},' * @SentinelResource(value = "getCurrentSeckillSkusResource",blockHandler = "blockHandler")')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 无论是1,2方式一定要配置被限流以后的默认返回.")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * url请求可以设置统一返回:WebCallbackManager")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    */")]),s(`
`),l("span",{class:"line"})])])],-1),nt={id:"整合-feign-sentinel-测试熔断降级",tabindex:"-1"},et=l("li",null,[l("p",null,"引入依赖：>spring-cloud-starter-openfeign、spring-cloud-starter-alibaba-sentinel<")],-1),tt=l("li",null,[l("p",null,"2、使用 Nacos 注册中心 spring-cloud-starter-alibaba-nacos-discovery")],-1),at=l("li",null,[l("p",null,"定义 fallbackfactory 并放在容器中"),l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"   /**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"   ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    * @Author zly")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"   ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"    * @Date 2022/7/26 16:22")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"      */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Slf4j")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Component")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"class"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"SeckillFeignServiceFallBack"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"implements"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"SeckillFeignService"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"   ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"getSkuSeckilInfo"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"skuId"),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"          log"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"info"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"熔断方法调用.."),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),l("span",{style:{color:"#A6ACCD"}}," R"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"error"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#A6ACCD"}},"BizCodeEnum"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"TO_MANY_REQUEST"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getCode"),l("span",{style:{color:"#89DDFF"}},"(),"),l("span",{style:{color:"#A6ACCD"}},"BizCodeEnum"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"TO_MANY_REQUEST"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#82AAFF"}},"getMessage"),l("span",{style:{color:"#89DDFF"}},"());")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])])],-1),ct=l("li",null,[l("p",null,"远程接口配置 feign 客户端容错"),l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"  /**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"   * @Author zly")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"   * @Date 2022/7/26 16:21")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"   */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"FeignClient"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#FFCB6B"}},"value"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"gulimall-seckill"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#FFCB6B"}},"fallback"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," SeckillFeignServiceFallBack"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"class"),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"interface"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"SeckillFeignService"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"      /**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"       * 根据skuId查询商品是否参加秒杀活动")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"       * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"skuId")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"       * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"       */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"GetMapping"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#FFCB6B"}},"value"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/sku/seckill/{skuId}"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"      "),l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"getSkuSeckilInfo"),l("span",{style:{color:"#89DDFF"}},"(@"),l("span",{style:{color:"#C792EA"}},"PathVariable"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"skuId"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Long"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"skuId"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])])],-1),rt=l("p",null,"开启 sentinel 代理 feign 功能；在 application.properties 中配置",-1),pt=l("ul",null,[l("li",null,"feign.sentinel.enabled=true")],-1),it=l("p",null,"1、使用@SentinelResource，并定义 fallback",-1),yt=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"com"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"atguigu"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"gulimall"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"seckill"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"service"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"impl"),l("span",{style:{color:"#89DDFF"}},"."),l("span",{style:{color:"#A6ACCD"}},"SeckillServiceImpl")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"SentinelResource"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#FFCB6B"}},"value"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"getCurrentSeckillSkusResource"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#FFCB6B"}},"blockHandler"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"blockHandler"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"List"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#A6ACCD"}},"SeckillSkuRedisTo"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"getCurrentSeckillSkus"),l("span",{style:{color:"#89DDFF"}},"()"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])],-1),Dt={id:"nacos",tabindex:"-1"},Ft={id:"项目整合",tabindex:"-1"},At=l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 1、如何使用Nacos作为配置中心统一管理配置")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 1）、引入依赖，")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         <dependency>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *             <groupId>com.alibaba.cloud</groupId>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *             <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         </dependency>")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 2）、创建一个bootstrap.properties。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      spring.application.name=gulimall-coupon")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      spring.cloud.nacos.config.server-addr=127.0.0.1:8848")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 3）、需要给配置中心默认添加一个叫 数据集（Data Id）gulimall-coupon.properties。默认规则，应用名.properties")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 4）、给 应用名.properties 添加任何配置")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 5）、动态获取配置。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      @RefreshScope：动态获取并刷新配置")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},' *      @Value("${配置项的名}")：获取到配置。')]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      如果配置中心和当前应用的配置文件中都配置了相同的项，优先使用配置中心的配置。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 2、细节")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *  1）、命名空间：配置隔离；")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      默认：public(保留空间)；默认新增的所有配置都在public空间。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      1、开发，测试，生产：利用命名空间来做环境隔离。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         注意：在bootstrap.properties；配置上，需要使用哪个命名空间下的配置，")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *         spring.cloud.nacos.config.namespace=9de62e44-cd2a-4a82-bf5c-95878bd5e871")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      2、每一个微服务之间互相隔离配置，每一个微服务都创建自己的命名空间，只加载自己命名空间下的所有配置")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *  2）、配置集：所有的配置的集合")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *  3）、配置集ID：类似文件名。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      Data ID：类似文件名")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *  4）、配置分组：")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      默认所有的配置集都属于：DEFAULT_GROUP；")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *      1111，618，1212")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 项目中的使用：每个微服务创建自己的命名空间，使用配置分组区分环境，dev，test，prod")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 3、同时加载多个配置集")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 1)、微服务任何配置信息，任何配置文件都可以放在配置中心中")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 2）、只需要在bootstrap.properties说明加载配置中心中哪些配置文件即可")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 3）、@Value，@ConfigurationProperties。。。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 以前SpringBoot任何方法从配置文件中获取值，都能使用。")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 配置中心有的优先使用配置中心中的，")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," /**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 1、开启服务注册发现")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," *  (配置nacos的注册中心地址)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 2、编写网关配置文件")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"})])])],-1),Ct={id:"nacos作为注册中心：",tabindex:"-1"},ut=l("ul",null,[l("li",null,[l("p",null,"将微服务注册到 nacos 中")]),l("li",null,[l("p",null,"1、首先，修改 pom.xml 文件，引入 Nacos Discovery Starter。")]),l("li",null,[l("p",null,"2、在应用的 /src/main/resources/application.properties 配置文 件中配置 Nacos Server 地址"),l("div",{class:"language-properties"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"spring.cloud.nacos.discovery.server-addr"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"127.0.0.1:8848")]),s(`
`),l("span",{class:"line"})])])])]),l("li",null,[l("p",null,"3、使用@EnableDiscoveryClient 开启服务注册发现功能")]),l("li",null,[l("p",null,"4、启动应用，观察 nacos 服务列表是否已经注册上服务"),l("ul",null,[l("li",null,[l("blockquote",null,[l("p",null,"注意：每一个应用都应该有名字，这样才能注册上去。修改 application.properties 文件"),l("p",null,"spring.application.name=service-provider"),l("p",null,"server.port=8000")])])])]),l("li",null,[l("p",null,"5、注册更多的服务上去，测试使用 feign 远程调用"),l("ul",null,[l("li",null,[l("blockquote",null,[l("p",null,"Nacos 使用三步"),l("p",null,"1、导包 nacos-discovery"),l("p",null,"2、写配置，指定 nacos 地址，指定应用的名字"),l("p",null,"3、开启服务注册发现功能@EnableDiscoveryClient"),l("p",null,"Feign 使用三步"),l("p",null,"1、导包 openfeign"),l("p",null,"2、开启@EnableFeignClients 功能"),l("p",null,"3、编写接口，进行远程调用")])])])])],-1),dt={id:"nacos作为配置中心",tabindex:"-1"},gt=l("li",null,[l("p",null,"1、pom.xml 引入 Nacos Config Starter。")],-1),ht=l("li",null,[l("p",null,"2、在应用的 /src/main/resources/bootstrap.properties 配 置文件中配置 Nacos Config 元数据"),l("div",{class:"language-properties"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"spring.application.name"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"nacos-config-example")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"spring.cloud.nacos.config.server-addr"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"127.0.0.1:8848")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#指定命名空间")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"spring.cloud.nacos.config.namespace"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"af7b6638-68dd-43a0-8bef-19dbaf2ae5c3 ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#指定分组  默认DEFAULT_GROUP")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"  "),l("span",{style:{color:"#F07178"}},"spring.cloud.nacos.config.group"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"dev")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"  "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#主要配置应用名和配置中心地址")]),s(`
`),l("span",{class:"line"})])])])],-1),mt=l("p",null,"3、在 nacos 中添加配置",-1),Et=l("li",null,[l("p",null,[s("在 nacos 中创建一个 "),l("strong",null,"应用名.properties"),s(" 配置文件并编写配置")])],-1),ft=l("p",null,[l("strong",null,"Nacos Config"),s(),l("strong",null,"数据结构")],-1),_t=l("p",null,"Nacos Config 主要通过 dataId 和 group 来唯一确定一条配置。",-1),kt=l("p",null,"Nacos Client 从 Nacos Server 端获取数据时，调用的是此接口 ConfigService.getConfig(String dataId, String group, long timeoutMs)。",-1),bt=l("p",null,[l("strong",null,"Spring Cloud"),s(),l("strong",null,"应用获取数据")],-1),St=l("p",null,[l("strong",null,"dataID"),s(":")],-1),vt=l("p",null,"在 Nacos Config Starter 中，dataId 的拼接格式如下",-1),xt=l("li",null,"spring.profiles.active 即为当前环境对应的 profile",-1),It=l("p",{"file-extension":""},[s("注意，当 activeprofile 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 prefix . {prefix}."),l("em",null,[s("p"),l("strong",null,"re"),s("f"),l("strong",null,"i"),s("x")]),s(".")],-1),Tt=l("p",null,"file-extension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置。 目前只支持 properties 类型。",-1),Lt=l("p",null,[l("strong",null,"Group"),s("：")],-1),Ot=l("p",null,"Group 默认为 DEFAULT_GROUP，可以通过 spring.cloud.nacos.config.group 配置。",-1),Rt=l("p",null,"4、在应用中使用@Value 和@RefreshScope",-1),wt=l("p",null,"完成上述两步后，应用会从 Nacos Config 中获取相应的配置，并添加在 Spring Environment",-1),qt=l("p",null,"的 PropertySources 中 。 这 里 我 们 使 用 @Value 注 解 来 将 对 应 的 配 置 注 入 到",-1),Mt=l("p",null,"SampleController 的 userName 和 age 字段，并添加 @RefreshScope 打开动态刷新功能",-1),Bt=l("p",null,[l("strong",null,"@RefreshScope")],-1),Vt=l("p",null,"class SampleController {",-1),Pt=l("p",null,"String userName;",-1),Kt=l("p",null,[l("strong",null,"@Value(“${user.age}”)")],-1),Nt=l("p",null,"int age;",-1),Wt=l("p",null,"}",-1),jt={id:"nacos进阶",tabindex:"-1"},Qt=l("ul",null,[l("li",null,[l("p",null,[l("strong",null,"核心概念")]),l("ul",null,[l("li",null,[l("p",null,[l("strong",null,"命名空间：配置隔离")]),l("ul",null,[l("li",null,[l("p",null,[s("用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 "),l("strong",null,"Group"),s(" 或 "),l("strong",null,"Data ID"),s(" 的")]),l("p",null,[s("配置。"),l("strong",null,"Namespace"),s(" 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生")]),l("p",null,"产环境的资源（如配置、服务）隔离等")])])]),l("li",null,[l("p",null,[l("strong",null,"配置集：所有配置的集合")]),l("ul",null,[l("li",null,[l("p",null,"一组相关或者不相关的配置项的集合称为配置集。在系统中，一个配置文件通常就是一个配"),l("p",null,"置集，包含了系统各个方面的配置。例如，一个配置集可能包含了数据源、线程池、日志级"),l("p",null,"别等配置项。")])])]),l("li",null,[l("p",null,[l("strong",null,"配置集ID：类似文件名。")]),l("ul",null,[l("li",null,[l("p",null,[s("Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。"),l("strong",null,"Data ID"),s(" 通常用于组")]),l("p",null,"织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有"),l("p",null,"意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名"),l("p",null,"规则保证全局唯一性。此命名规则非强制。")])])]),l("li",null,[l("p",null,[l("strong",null,"配置分组：默认所有的配置集都属于：DEFAULT_GROUP；")]),l("ul",null,[l("li",null,[l("p",null,"Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或"),l("p",null,"Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个"),l("p",null,"配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置"),l("p",null,"分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和"),l("p",null,"MQ_topic 配置。")])])])])]),l("li",null,[l("p",null,[l("strong",null,"原理")]),l("ul",null,[l("li",null,[s("自动注入： "),l("ul",null,[l("li",null,"NacosConfigStarter 实现了 org.springframework.cloud.bootstrap.config.PropertySourceLocator 接口，并将优先级设置成了最高。 在 Spring Cloud 应用启动阶段，会主动从 Nacos Server 端获取对应的数据，并将获取到的 数据转换成 PropertySource 且注入到 Environment 的 PropertySources 属性中，所以使用 @Value 注解也能直接获取 Nacos Server 端配置的内容。")])]),l("li",null,[s("动态刷新： "),l("ul",null,[l("li",null,"Nacos Config Starter 默认为所有获取数据成功的 Nacos 的配置项添加了监听功能，在监听 到服务端配置发生变化时会实时触发 org.springframework.cloud.context.refresh.ContextRefresher 的 refresh 方法 。"),l("li",null,[s("如果需要对 Bean 进行动态刷新，请参照 Spring 和 Spring Cloud 规范。推荐给类添加**@RefreshScope** "),l("strong",null,"或"),s(),l("strong",null,"@ConfigurationProperties"),s(" 注解，")])])])])]),l("li",null,[l("p",null,[l("strong",null,"3、加载多配置文件")]),l("div",{class:"language-properties"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"spring.cloud.nacos.config.server-addr"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"127.0.0.1:8848")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"spring.cloud.nacos.config.namespace"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"31098de9-fa28-41c9-b0bd-c754ce319ed4 ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}}," spring.cloud.nacos.config.ext-config[0]."),l("span",{style:{color:"#F07178"}},"data-id"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"gulimall-datasource.yml ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}}," "),l("span",{style:{color:"#676E95","font-style":"italic"}},"#动态刷新")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}}," spring.cloud.nacos.config.ext-config[0]."),l("span",{style:{color:"#F07178"}},"refresh"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"false")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}}," spring.cloud.nacos.config.ext-config[0]."),l("span",{style:{color:"#F07178"}},"group"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"dev")]),s(`
`),l("span",{class:"line"})])])])]),l("li",null,[l("p",null,[l("strong",null,"4、namespace 与 group 最佳实践")]),l("ul",null,[l("li",null,"每个微服务创建自己的 namespace 进行隔离，group 来区分 dev，beta，prod 等环境")])])],-1),Ht={id:"gateway",tabindex:"-1"},Ut=l("ul",null,[l("li",null,[s("简介 "),l("ul",null,[l("li",null,"网关作为流量的入口，常用功能包括路由转发、权限校验、限流控制等。")])]),l("li",null,[s("特点 "),l("ul",null,[l("li",null,"基于 Spring5，支持响应式编程和 SpringBoot2.0"),l("li",null,"支持使用任何请求属性进行路由匹配"),l("li",null,"特定于路由的断言和过滤器"),l("li",null,"集成 Hystrix 进行断路保护"),l("li",null,"集成服务发现功能"),l("li",null,"易于编写 Predicates 和 Filters"),l("li",null,"支持请求速率限制"),l("li",null,"支持路径重写")])]),l("li",null,[s("API网关优点 "),l("ul",null,[l("li",null,"易于监控。可以在网关收集监控数据并将其推送到外部系统进行分析。"),l("li",null,"易于认证。可以在网关上进行认证，然后再将请求转发到后端的微服务，而无须在 每个微服务中进行认证。"),l("li",null,"减少了客户端与各个微服务之间的交互次数。")])]),l("li",null,[s("核心概率 "),l("ul",null,[l("li",null,[s("路由 "),l("ul",null,[l("li",null,"路由是网关最基础的部分，路由信息有一个 ID、一个目的 URL、一组断言和一组 Filter 组成。如果断言路由为真，则说明请求的 URL 和配置匹配")])]),l("li",null,[s("断言 "),l("ul",null,[l("li",null,"Java8 中的断言函数。Spring Cloud Gateway 中的断言函数输入类型是 Spring5.0 框 架中的 ServerWebExchange。Spring Cloud Gateway 中的断言函数允许开发者去定义匹配 来自于 http request 中的任何信息，比如请求头和参数等。")])]),l("li",null,[s("过滤器 "),l("ul",null,[l("li",null,"一个标准的 Spring webFilter。Spring cloud gateway 中的 filter 分为两种类型的 Filter，分别是 Gateway Filter 和 Global Filter。过滤器 Filter 将会对请求和响应进行修改 处理")])]),l("li",null,[l("strong",null,"满足某些断言（predicates）就路由到指定的地址（uri），使用指定的过滤器（filter）")])])])],-1),Gt=l("blockquote",null,[l("div",{class:"language-yaml"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"spring"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"cloud"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"gateway"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"   "),l("span",{style:{color:"#F07178"}},"routes"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"        "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"id"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"test_route")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#F07178"}},"uri"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"https://www.baidu.com")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#F07178"}},"predicates"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"Query=url,baidu")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"       "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"id"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"product_route")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#F07178"}},"uri"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"lb://gulimall-product")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#F07178"}},"predicates"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"Path=/api/product/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#F07178"}},"filters"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"RewritePath=/api/?(?<segment>.*),/$\\{segment}")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"       "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#F07178"}},"id"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"gulimall_host_route")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#F07178"}},"uri"),l("span",{style:{color:"#89DDFF"}},":"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"lb://gulimall-product")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"          "),l("span",{style:{color:"#F07178"}},"predicates"),l("span",{style:{color:"#89DDFF"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#A6ACCD"}},"            "),l("span",{style:{color:"#89DDFF"}},"-"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C3E88D"}},"Host=gulimall.com,item.gulimall.com")]),s(`
`),l("span",{class:"line"})])])])],-1),zt={id:"feign",tabindex:"-1"},$t=l("p",null,[l("strong",null,"Feign"),s(),l("strong",null,"声明式远程调用")],-1),Jt=l("ul",null,[l("li",null,[l("p",null,"简介"),l("ul",null,[l("li",null,"Feign 是一个声明式的 HTTP 客户端，它的目的就是让远程调用更加简单。"),l("li",null,[s("Feign 整合了 "),l("strong",null,"Ribbon（负载均衡）和 Hystrix(服务熔断)，")])])]),l("li",null,[l("p",null,[l("strong",null,"使用")]),l("ul",null,[l("li",null,[l("p",null,"1、引入依赖 spring-cloud-starter-openfeign")]),l("li",null,[l("p",null,"2、开启 feign 功能 @EnableFeignClients(basePackages = “com.atguigu.gulimall.member.feign”)")]),l("li",null,[l("p",null,"3、声明远程接口"),l("div",{class:"language-java"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"* @Author zly")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"* @Date 2022/7/25 12:04")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"*/")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"FeignClient"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"gulimall-order"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"public"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"interface"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#FFCB6B"}},"OrderFeignService"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"/**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * 分页查询当前登录用户的所有订单信息")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@param"),l("span",{style:{color:"#676E95","font-style":"italic"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"params")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," * "),l("span",{style:{color:"#F78C6C","font-style":"italic"}},"@return")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}}," */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"@"),l("span",{style:{color:"#C792EA"}},"PostMapping"),l("span",{style:{color:"#89DDFF"}},"("),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#C3E88D"}},"/order/order/listWithItem"),l("span",{style:{color:"#89DDFF"}},'"'),l("span",{style:{color:"#89DDFF"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#C792EA"}},"R"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#82AAFF"}},"listWithItem"),l("span",{style:{color:"#89DDFF"}},"(@"),l("span",{style:{color:"#C792EA"}},"RequestBody"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Map"),l("span",{style:{color:"#89DDFF"}},"<"),l("span",{style:{color:"#C792EA"}},"String"),l("span",{style:{color:"#89DDFF"}},","),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#C792EA"}},"Object"),l("span",{style:{color:"#89DDFF"}},">"),l("span",{style:{color:"#A6ACCD"}}," "),l("span",{style:{color:"#A6ACCD","font-style":"italic"}},"params"),l("span",{style:{color:"#89DDFF"}},");")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),l("span",{class:"line"})])])])])])])],-1),Xt={id:"feign远程调用丢失请求头问题",tabindex:"-1"},Yt=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410205425533.png",alt:"image-20230410205425533"})],-1),Zt={id:"feign异步情况丢失上下文问题",tabindex:"-1"},la=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410205453081.png",alt:"image-20230410205453081"})],-1),sa={id:"springcloud-alibaba-常用组件端口号总结",tabindex:"-1"},oa=l("ul",null,[l("li",null,[l("p",null,"Nacos 默认端口号：8848"),l("div",{class:"language-properties"},[l("span",{class:"copy"}),l("pre",{class:"shiki material-theme-palenight",tabindex:"0"},[l("code",null,[l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"#*************** Spring Boot Related Configurations ***************#")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"### Default web context path:")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"server.servlet.contextPath"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"/nacos")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#676E95","font-style":"italic"}},"### Default web server port:")]),s(`
`),l("span",{class:"line"},[l("span",{style:{color:"#F07178"}},"server.port"),l("span",{style:{color:"#89DDFF"}},"="),l("span",{style:{color:"#A6ACCD"}},"8848")]),s(`
`),l("span",{class:"line"})])])])]),l("li",null,[l("p",null,"Seata默认端口号：8091")]),l("li",null,[l("p",null,"Sentinel控制台默认运行在8080端口上")])],-1),na=l("blockquote",null,[l("p",null,"Elasticsearch 默认端口 9200 搜索引擎 不属于SpringCloud Alibaba")],-1),ea={id:"支付",tabindex:"-1"},ta={id:"加密-对称加密",tabindex:"-1"},aa=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410190257408.png",alt:"image-20230410190257408"})],-1),ca={id:"加密-非对称加密",tabindex:"-1"},ra=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410190307734.png",alt:"image-20230410190307734"})],-1),pa={id:"支付宝验签",tabindex:"-1"},ia=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410201313818.png",alt:"image-20230410201313818"})],-1),ya={id:"收单",tabindex:"-1"},Da=l("ul",null,[l("li",null,[s("1、订单在支付页，不支付，一直刷新，订单过期了才支付，订单状态改为已支付了，但是库存解锁了。 "),l("ul",null,[l("li",null,"使用支付宝自动收单功能解决。只要一段时间不支付，就不能支付了。")])]),l("li",null,[s("2、由于时延等问题。订单解锁完成，正在解锁库存的时候，异步通知才到 "),l("ul",null,[l("li",null,"订单解锁，手动调用收单")])]),l("li",null,[s("3、网络阻塞问题，订单支付成功的异步通知一直不到达 "),l("ul",null,[l("li",null,"查询订单列表时，ajax获取当前未支付的订单状态，查询订单状态时，再获取一下支付宝此订单的状态")])]),l("li",null,[s("4、其他各种问题 "),l("ul",null,[l("li",null,"每天晚上闲时下载支付宝对账单，一一进行对账")])])],-1),Fa={id:"md5-md5盐值加密",tabindex:"-1"},Aa=l("ul",null,[l("li",null,[s("MD5 "),l("ul",null,[l("li",null,[s("Message Digest algorithm 5，信息摘要算法 "),l("ul",null,[l("li",null,"压缩性：任意长度的数据，算出的MD5值长度都是固定的。"),l("li",null,"容易计算：从原数据计算出MD5值很容易。"),l("li",null,"抗修改性：对原数据进行任何改动，哪怕只修改1个字节，所得到的MD5值都有很大区别。"),l("li",null,"强抗碰撞：想找到两个不同的数据，使它们具有相同的MD5值，是非常困难的。"),l("li",null,"不可逆")])])])]),l("li",null,[s("加盐： "),l("ul",null,[l("li",null,"通过生成随机数与MD5生成字符串进行组合"),l("li",null,"数据库同时存储MD5值与salt值。验证正确性时使用salt进行MD5即可")])])],-1),Ca={id:"项目微服务",tabindex:"-1"},ua=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410191352836.png",alt:"image-20230410191352836"})],-1),da={id:"nginx-windows搭建域名访问环境",tabindex:"-1"},ga=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410191454442.png",alt:"image-20230410191454442"})],-1),ha={id:"域名映射效果",tabindex:"-1"},ma=l("li",null,"nginx直接代理给网关，网关判断",-1),Ea=l("li",null,"如果/api/****，转交给对应的服务器",-1),fa=l("li",null,"如果是 满足域名，转交给对应的服务",-1),_a={id:"正向代理与反向代理",tabindex:"-1"},ka=l("ul",null,[l("li",null,"正向代理：如科学上网，隐藏客户端信息")],-1),ba=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410191634342.png",alt:"image-20230410191634342"})],-1),Sa=l("ul",null,[l("li",null,"反向代理：屏蔽内网服务器信息，负载均衡访问")],-1),va=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410191643706.png",alt:"image-20230410191643706"})],-1),xa={id:"nginx配置文件",tabindex:"-1"},Ia=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410191710095.png",alt:"image-20230410191710095"})],-1),Ta={id:"nginx动静分离",tabindex:"-1"},La=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410191732131.png",alt:"image-20230410191732131"})],-1),Oa={id:"nginx转发效果",tabindex:"-1"},Ra=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410191756149.png",alt:"image-20230410191756149"})],-1),wa={id:"内网穿透",tabindex:"-1"},qa=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410190339367.png",alt:"image-20230410190339367"})],-1),Ma=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410190351905.png",alt:"image-20230410190351905"})],-1),Ba={id:"内网穿透联调",tabindex:"-1"},Va=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410190422986.png",alt:"image-20230410190422986"})],-1),Pa={id:"配置",tabindex:"-1"},Ka=l("ul",null,[l("li",null,"Nginx配置")],-1),Na=l("p",null,"...",-1),Wa=l("p",null,"...",-1),ja={id:"缓存",tabindex:"-1"},Qa={id:"本地缓存",tabindex:"-1"},Ha=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410191857648.png",alt:"image-20230410191857648"})],-1),Ua={id:"分布式缓存-本地模式在分布式下的问题",tabindex:"-1"},Ga=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410191940056.png",alt:"image-20230410191940056"})],-1),za={id:"分布式缓存",tabindex:"-1"},$a=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410192021777.png",alt:"image-20230410192021777"})],-1),Ja={id:"高并发下缓存失效问题-缓存穿透",tabindex:"-1"},Xa=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410192133778.png",alt:"image-20230410192133778"})],-1),Ya=l("ul",null,[l("li",null,[l("strong",null,"缓存穿透"),s("： "),l("ul",null,[l("li",null,"指查询一个一定不存在的数据，由于缓存是不命中，将去查询数据库，但是数据库也无此记录，我们没有将这次查询的null写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义")])]),l("li",null,[l("strong",null,"风险"),s("： "),l("ul",null,[l("li",null,"利用不存在的数据进行攻击，数据库瞬时压力增大，最终导致崩溃")])]),l("li",null,[l("strong",null,"解决"),s("： "),l("ul",null,[l("li",null,"null结果缓存，并加入短暂过期时间")])])],-1),Za={id:"高并发下缓存失效问题-缓存雪崩",tabindex:"-1"},lc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410192133778.png",alt:"image-20230410192133778"})],-1),sc=l("ul",null,[l("li",null,[l("p",null,[l("strong",null,"缓存雪崩"),s("：")]),l("ul",null,[l("li",null,"缓存雪崩是指在我们设置缓存时key采用了相同的过期时间，导致缓存在某一时刻同时失效，请求全部转发到DB，DB瞬时压力过重雪崩。")])]),l("li",null,[l("p",null,[l("strong",null,"解决"),s("：")]),l("ul",null,[l("li",null,"原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。")])])],-1),oc={id:"高并发下缓存失效问题-缓存击穿",tabindex:"-1"},nc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410192628947.png",alt:"image-20230410192628947"})],-1),ec=l("ul",null,[l("li",null,[l("p",null,[l("strong",null,"缓存穿透"),s("：")]),l("ul",null,[l("li",null,[s('对于一些设置了过期时间的key，如果这些key可能会在某些时间点被超高并发地访问，是一种非常"'),l("strong",null,"热点"),s('"的数据。如果这个key在大量请求同时进来前正好失效，那么所有对这个key的数据查询都落到db，我们称为缓存击穿。')])])]),l("li",null,[l("p",null,[l("strong",null,"解决"),s("：")]),l("ul",null,[l("li",null,[s("加锁 "),l("ul",null,[l("li",null,"大量并发只让一个去查，其他人等待，查到以后释放锁，其他人获取到锁，先查缓存，就会有数据，不用去db")])])])])],-1),tc={id:"分布式下如何加锁？",tabindex:"-1"},ac=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410192940277.png",alt:"image-20230410192940277"})],-1),cc=l("ul",null,[l("li",null,"本地锁，只能锁住当前进程，所以我们需要分布式锁")],-1),rc={id:"锁-时序问题",tabindex:"-1"},pc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410193041285.png",alt:"image-20230410193041285"})],-1),ic={id:"分布式锁演进-基本原理",tabindex:"-1"},yc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410193221079.png",alt:"image-20230410193221079"})],-1),Dc=l("blockquote",null,[l("p",null,"我们可以同时去一个地方“占坑”，如果占到，就执行逻辑。否则就必须等待，直到释放锁。 “占坑”可以去redis，可以去数据库，可以去任何大家都能访问的地方。 等待可以自旋的方式。")],-1),Fc={id:"分布式锁演进-阶段一",tabindex:"-1"},Ac=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410193430589.png",alt:"image-20230410193430589"})],-1),Cc={id:"分布式锁演进-阶段二",tabindex:"-1"},uc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410193552631.png",alt:"image-20230410193552631"})],-1),dc={id:"分布式锁演进-阶段三",tabindex:"-1"},gc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410193625611.png",alt:"image-20230410193625611"})],-1),hc={id:"分布式锁演进-阶段四",tabindex:"-1"},mc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410193648301.png",alt:"image-20230410193648301"})],-1),Ec={id:"分布式锁演进-阶段五-最终形态",tabindex:"-1"},fc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410193719776.png",alt:"image-20230410193719776"})],-1),_c={id:"缓存数据一致性-双写模式",tabindex:"-1"},kc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410193831064.png",alt:"image-20230410193831064"})],-1),bc={id:"缓存数据一致性-失效模式",tabindex:"-1"},Sc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410193909090.png",alt:"image-20230410193909090"})],-1),vc={id:"缓存数据一致性-解决方案",tabindex:"-1"},xc=l("ul",null,[l("li",null,[s("无论是双写模式还是失效模式，都会导致缓存的不一致问题。即多个实例同时更新会出事。怎么办？ "),l("ul",null,[l("li",null,"1、如果是用户纬度数据（订单数据、用户数据），这种并发几率非常小，不用考虑这个问题，缓存数据加上过期时间，每隔一段时间触发读的主动更新即可"),l("li",null,"2、如果是菜单，商品介绍等基础数据，也可以去使用canal订阅binlog的方式。"),l("li",null,"3、缓存数据+过期时间也足够解决大部分业务对于缓存的要求。"),l("li",null,"4、通过加锁保证并发读写，写写的时候按顺序排好队。读读无所谓。所以适合使用读写锁。（业务不关心脏数据，允许临时脏数据可忽略）；")])]),l("li",null,[s("总结： "),l("ul",null,[l("li",null,"我们能放入缓存的数据本就不应该是实时性、一致性要求超高的。所以缓存数据的时候加上过期时间，保证每天拿到当前最新数据即可。"),l("li",null,"我们不应该过度设计，增加系统的复杂性"),l("li",null,"遇到实时性、一致性要求高的数据，就应该查数据库，即使慢点。")])])],-1),Ic={id:"缓存数据一致性-解决-canal",tabindex:"-1"},Tc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410194458435.png",alt:"image-20230410194458435"})],-1),Lc={id:"session共享问题",tabindex:"-1"},Oc={id:"session原理",tabindex:"-1"},Rc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410195022298.png",alt:"image-20230410195022298"})],-1),wc={id:"分布式下session共享问题",tabindex:"-1"},qc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410195051946.png",alt:"image-20230410195051946"})],-1),Mc={id:"解决-session复制",tabindex:"-1"},Bc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410195126743.png",alt:"image-20230410195126743"})],-1),Vc=l("ul",null,[l("li",null,[s("优点 "),l("ul",null,[l("li",null,"web-server（Tomcat）原生支持，只需要修改配置文件")])]),l("li",null,[s("缺点 "),l("ul",null,[l("li",null,"session同步需要数据传输，占用大量网络带宽，降低了服务器群的业务处理能力"),l("li",null,"任意一台web-server保存的数据都是所有web-server的session总和，受到内存限制无法水平扩展更多的web-server"),l("li",null,"大型分布式集群情况下，由于所有web-server都全量保存数据，所以此方案不可取。")])])],-1),Pc={id:"解决-客户端存储",tabindex:"-1"},Kc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410195314820.png",alt:"image-20230410195314820"})],-1),Nc=l("ul",null,[l("li",null,[l("p",null,"优点"),l("ul",null,[l("li",null,"服务器不需存储session，用户保存自己的session信息到cookie中。节省服务端资源")])]),l("li",null,[l("p",null,"缺点"),l("ul",null,[l("li",null,"都是缺点，这只是一种思路。"),l("li",null,[s("具体如下： "),l("ul",null,[l("li",null,"每次http请求，携带用户在cookie中的完整信息，浪费网络带宽"),l("li",null,"session数据放在cookie中，cookie有长度限制4K，不能保存大量信息"),l("li",null,"session数据放在cookie中，存在泄漏、篡改、窃取等安全隐患")])])])]),l("li",null,[l("p",null,"这种方式不会使用。")])],-1),Wc={id:"解决-hash一致性",tabindex:"-1"},jc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410195638892.png",alt:"image-20230410195638892"})],-1),Qc=l("ul",null,[l("li",null,[s("优点： "),l("ul",null,[l("li",null,"只需要改nginx配置，不需要修改应用代码"),l("li",null,"负载均衡，只要hash属性的值分布是均匀的，多台web-server的负载是均衡的"),l("li",null,"可以支持web-server水平扩展（session同步法是不行的，受内存限制）")])]),l("li",null,[s("缺点 "),l("ul",null,[l("li",null,"session还是存在web-server中的，所以web-server重启可能导致部分session丢失，影响业务，如部分用户需要重新登录"),l("li",null,"如果web-server水平扩展，rehash后session重新分布，也会有一部分用户路由不到正确的session")])]),l("li",null,"但是以上缺点问题也不是很大，因为session本来都是有有效期的。所以这两种反向代理的方式可以使用")],-1),Hc={id:"解决-统一存储",tabindex:"-1"},Uc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410195856602.png",alt:"image-20230410195856602"})],-1),Gc=l("ul",null,[l("li",null,[s("优点： "),l("ul",null,[l("li",null,"没有安全隐患"),l("li",null,"可以水平扩展，数据库/缓存水平切分即可"),l("li",null,"web-server重启或者扩容都不会有session丢失")])]),l("li",null,[s("不足 "),l("ul",null,[l("li",null,"增加了一次网络调用，并且需要修改应用代码；如将所有的getSession方法替换为从Redis查数据的方式。redis获取数据比内存慢很多"),l("li",null,"上面缺点可以用SpringSession完美解决")])])],-1),zc={id:"解决-不同服务，子域session共享",tabindex:"-1"},$c=l("blockquote",null,[l("p",null,"jsessionid这个cookie默认是当前系统域名的。当我们分拆服务，不同域名部署的时候，我们可以使用 如下解决方案；")],-1),Jc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410200123345.png",alt:"image-20230410200123345"})],-1),Xc={id:"springsession核心原理",tabindex:"-1"},Yc=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410200156413.png",alt:"image-20230410200156413"})],-1),Zc={id:"购物车-1",tabindex:"-1"},lr={id:"购物车数据结构",tabindex:"-1"},sr=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410200320343.png",alt:"image-20230410200320343"})],-1),or=l("blockquote",null,[l("ul",null,[l("li",null,"Map<String k1,Map<String k2,CartItemInfo>> 在redis中"),l("li",null,"k1：标识每一个用户的购物车 key:用户标识"),l("li",null,"k2：购物项的商品id value:Hash（k：商品id，v：购物项详情）")])],-1),nr={id:"消息队列rabbitmq",tabindex:"-1"},er={id:"rabbitmq概念",tabindex:"-1"},tr=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230410200724866.png",alt:"image-20230410200724866"})],-1),ar=l("blockquote",null,[l("p",null,"rabbitmq 是一个开源的消息代理和队列服务器，通过普通的协议（Amqp 协议）来完成不同应用之间的数据共享，rabbitMq 是通过 erlang 语言来开发的基于 amqp 协议。")],-1),cr={id:"什么amqp协议",tabindex:"-1"},rr=l("ol",null,[l("li",null,"是一个二进制协议"),l("li",null,"amqp 是一个应用层协议的规范（定义了很多规范），可以有很多不同的消息中间件产品（需要遵循该规范）")],-1),pr=l("ul",null,[l("li",null,[l("p",null,"server： 是消息队列节点")]),l("li",null,[l("p",null,"virtual host： 虚拟主机")]),l("li",null,[l("p",null,"exchange： 交换机（消息投递到交换机上）")]),l("li",null,[l("p",null,"message queue： 被消费者监听消息"),l("p",null,[l("code",null,"交换机和队列是有一个绑定的关系")])])],-1),ir=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230310210242731.png",alt:"image-20230310210242731"})],-1),yr={id:"amqp的核心概念",tabindex:"-1"},Dr=l("ol",null,[l("li",null,"server ： 又称为broker，接受客户端连接，实现amqp实体服务"),l("li",null,"connection： 连接，应用程序与broker建立网络连接"),l("li",null,"channel： 网络通道，几乎所有的操作都是在 channel 中进行的，是进行消息对象的通道，客户端可以建立多个通道，每一个 channnel 表示一个会话任务。"),l("li",null,"Message： 服务器和应用程序之间传递数据的载体，有 properties（消息属性，用来修饰消息，比如消息的优先级，延时投递）和 Body （消息体）"),l("li",null,"virtual host（虚拟主机）：是一个逻辑概念，最上层的消息路由，一个虚拟主机中可以包含多个 exchange 和 queue 但是一个虚拟主机中不能有名称相同的 exchange 和 queue"),l("li",null,"exchange （交换机）： 消息直接投递到交换机上，然后交换机根据消息的路由 key 来路由到对应绑定的队列上。"),l("li",null,"binding （绑定）： 绑定 exchange 与 queue 的虚拟连接， binding 中可以包含route_key"),l("li",null,"route_key（路由key）：它的作用是在交换机上通过 route_key 来把消息路由到那个队列上。"),l("li",null,"queue 队列（队列）： 用来保存消息的载体，有消费者监听，然后消费消息。")],-1),Fr={id:"rabbitmq的消息是如何流转的？",tabindex:"-1"},Ar=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230310210409545.png",alt:"image-20230310210409545"})],-1),Cr={id:"rabbitmq-交换机详解",tabindex:"-1"},ur={id:"作用：",tabindex:"-1"},dr=l("strong",null,"作用",-1),gr=l("ul",null,[l("li",null,"接受生产者的消息，然后根据路由键把消息投递到跟交换机绑定的对应的队列上。")],-1),hr=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230310210717895.png",alt:"image-20230310210717895"})],-1),mr={id:"交换机属性",tabindex:"-1"},Er=l("strong",null,"交换机属性",-1),fr=l("ul",null,[l("li",null,"Name： 交换机名称"),l("li",null,"Type： 交换机类型，Direct、topic、fanout、headers"),l("li",null,"Durablity：是否需要持久化"),l("li",null,"autodelete： 假如没有队列绑定到该交换机，那么交换机会自动删除。"),l("li",null,"internal： 当前交换机交换机是否用户 RabbitMq 内部使用不常用，默认为false"),l("li",null,"Argurements： 扩展参数，用户扩展AMQP定制化协议。")],-1),_r={id:"交换机类型",tabindex:"-1"},kr=l("ul",null,[l("li",null,[l("strong",null,"直连交换机（Direct exchange）")])],-1),br=l("blockquote",null,[l("p",null,"所有发送的 Direct exchange 的消息都会被投递到与 Routekey名称（与队列名称）相同的queue上"),l("p",null,"direct 模式下，可以使用 RabbitMq 自定exchange ---> default exchange 所以不需要交换机和任何队列绑定，消息将会投递到route_key名称和队列名称相同的队列上。")],-1),Sr=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230310211903967.png",alt:"image-20230310211903967"})],-1),vr=l("ul",null,[l("li",null,[l("strong",null,"主题交换机 TopicExchange")])],-1),xr=l("blockquote",null,[l("p",null,"就是在队列上绑到 top 交换机上的路由key 可以是通过通配符来匹配的通配符的规则是"),l("p",null,"比如：log.#: 可以是匹配一个单词 也可以匹配多个单词 比如 log.# 可以匹配log.a log.a.b log.* ： 可以匹配一个单词，比如log.* ，可以匹配log.a 但是不可以匹配log.a.b。")],-1),Ir=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230310211944528.png",alt:"image-20230310211944528"})],-1),Tr=l("ul",null,[l("li",null,[l("strong",null,"扇形交换机（fanout exchange）")])],-1),Lr=l("blockquote",null,[l("p",null,"就是消息通过丛交换机到队列上不会通过路由key 所以该模式的速度是最快的 只要和交换机绑定的那么消息就会被分发到与之绑定的队列上。")],-1),Or=l("p",null,[l("img",{src:"https://cdn.staticaly.com/gh/imLKlauS/blog-picture@main/blogs/image-20230310212034909.png",alt:"mall"})],-1),Rr={id:"队列、绑定主机、消息",tabindex:"-1"},wr=l("strong",null,"队列、绑定主机、消息",-1),qr=l("ul",null,[l("li",null,[l("p",null,"绑定： exchange 与 之间的连接关系（通过路由规则）")]),l("li",null,[l("p",null,"队列： 用来存储消息的实体")]),l("li",null,[l("p",null,"队列的属性： durablility 是否被持久化")]),l("li",null,[l("p",null,"AutoDelete： 表示最后一个监听被移除那么该队列就会删除。")]),l("li",null,[l("p",null,"消息： 用来生产者 和 消费者之间传递数据的")]),l("li",null,[l("p",null,"消息属性： 包括 消息体Body 和 属性 properties")]),l("li",null,[l("p",null,"常用属性： delivery mode,headers,content_type(消息类型) content_encoding（消息编码），priporty（消息优先级） correntlation_id( 最终消息唯一的ID)、reply_to(消息失败重回队列)，expiretion(消息的过期时 间),message_id(消息id);timestamp,type,user_id ，app_id,cluster_id等")])],-1);function Mr(t,Br,Vr,Pr,r,Kr){const n=A,p=i;return F(),D(p,{frontmatter:r.frontmatter,data:r.data},{"main-content-md":o(()=>[d,l("h1",g,[s("项目总结 "),e(n,{class:"header-anchor",href:"#项目总结","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),h,m,l("h2",E,[s("项目名称 "),e(n,{class:"header-anchor",href:"#项目名称","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),f,l("h2",_,[s("项目简介 "),e(n,{class:"header-anchor",href:"#项目简介","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),k,l("h2",b,[s("系统架构 "),e(n,{class:"header-anchor",href:"#系统架构","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),S,l("h2",v,[s("我的职责 "),e(n,{class:"header-anchor",href:"#我的职责","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),x,I,T,L,O,R,w,l("h2",q,[s("项目概述 "),e(n,{class:"header-anchor",href:"#项目概述","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),M,l("h3",B,[s("核心业务一：购物车 "),e(n,{class:"header-anchor",href:"#核心业务一：购物车","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),V,l("h3",P,[s("核心业务二：订单 "),e(n,{class:"header-anchor",href:"#核心业务二：订单","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h4",K,[s("订单中心 "),e(n,{class:"header-anchor",href:"#订单中心","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),N,l("h4",W,[s("订单构成 "),e(n,{class:"header-anchor",href:"#订单构成","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),j,l("h4",Q,[s("订单状态 "),e(n,{class:"header-anchor",href:"#订单状态","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),H,l("h4",U,[s("订单流程 "),e(n,{class:"header-anchor",href:"#订单流程","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),G,l("h5",z,[s("1.订单创建与支付 "),e(n,{class:"header-anchor",href:"#_1-订单创建与支付","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("p",null,[e(n,{href:"http://order.gulimall.com/toTrade",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("http://order.gulimall.com/toTrade")]),_:1})]),$,l("p",null,[e(n,{href:"http://order.gulimall.com/submitOrder",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("http://order.gulimall.com/submitOrder")]),_:1})]),J,X,Y,Z,ll,sl,ol,l("ul",null,[nl,l("li",null,[l("h6",el,[tl,s(),e(n,{class:"header-anchor",href:"#配置项修改","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})])])]),al,l("blockquote",null,[l("ul",null,[l("li",null,[l("h6",cl,[rl,s(),e(n,{class:"header-anchor",href:"#核心流程","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})])])]),pl,il,yl,Dl,Fl]),l("ul",null,[l("li",null,[l("h6",Al,[s("支付宝沙箱对接 "),e(n,{class:"header-anchor",href:"#支付宝沙箱对接","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})])])]),Cl,ul,dl,l("p",null,[e(n,{href:"https://openhome.alipay.com/platform/developerIndex.htm",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("https://openhome.alipay.com/platform/developerIndex.htmopen in new window")]),_:1})]),gl,l("p",null,[e(n,{href:"https://open.alipay.com/develop/sandbox/app",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("https://open.alipay.com/develop/sandbox/appopen in new window")]),_:1})]),hl,ml,El,fl,_l,kl,bl,Sl,vl,xl,Il,Tl,Ll,Ol,l("p",null,[s("调用支付接口"),e(n,{href:"http://order.gulimall.com/payOrder?orderSn=202304031500558581642784227126714369%E5%90%8E%EF%BC%8C%E6%96%B0%E5%88%9B%E5%BB%BA",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("http://order.gulimall.com/payOrder?orderSn=202304031500558581642784227126714369后，新创建")]),_:1}),s(),Rl,s(" 空文件，复制控制台日志中前端文件代码到 "),wl,s("。")]),ql,Ml,Bl,Vl,Pl,Kl,Nl,Wl,jl,Ql,Hl,Ul,Gl,zl,$l,Jl,Xl,l("p",null,[e(n,{href:"https://natapp.cn/article/natapp_newbie",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("https://natapp.cn/article/natapp_newbieopen in new window")]),_:1})]),l("p",null,[s("开通后，将内网穿透端口为 80，本地地址改为虚拟机映射本地host的地址(192.168.10.103=>"),e(n,{href:"http://order.gulimall.com",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("order.gulimall.com")]),_:1}),s(")即支付服务项目端口。")]),Yl,Zl,ls,ss,os,ns,es,ts,as,cs,l("p",null,[s("页面跳转同步通知页面路径 需"),e(n,{href:"http://xn--79sp5fckt6rwxd161acp1b",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("http://格式的完整路径")]),_:1}),s("，不能加?id=123这类自定义参数，必须外网可以正常访问；订单支付完成成功返回以下页面(同步通知，支付成功，一般跳转到成功页)：")]),rs,ps,is,ys,Ds,Fs,As,Cs,l("h5",us,[s("2.订单创建前需要预览订单，选择收货信息等 "),e(n,{class:"header-anchor",href:"#_2-订单创建前需要预览订单，选择收货信息等","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("p",null,[e(n,{href:"http://cart.gulimall.com/cart.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("http://cart.gulimall.com/cart.html")]),_:1})]),ds,l("p",null,[e(n,{href:"http://order.gulimall.com/toTrade",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("http://order.gulimall.com/toTrade")]),_:1})]),gs,hs,ms,Es,fs,_s,l("h5",ks,[s("3.订单创建需要锁定库存，库存有才可创建，否则不能创建 "),e(n,{class:"header-anchor",href:"#_3-订单创建需要锁定库存，库存有才可创建，否则不能创建","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),bs,Ss,vs,xs,Is,Ts,Ls,Os,Rs,ws,qs,Ms,Bs,Vs,Ps,Ks,Ns,Ws,js,Qs,Hs,Us,Gs,l("h5",zs,[s("4.订单创建后超时未支付需要解锁库存 "),e(n,{class:"header-anchor",href:"#_4-订单创建后超时未支付需要解锁库存","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),$s,Js,Xs,Ys,Zs,lo,so,oo,no,eo,to,ao,l("h5",co,[s("5.支付成功后，需要进行拆单，根据商品打包方式，所在仓库，物流等进行拆单(待开发) "),e(n,{class:"header-anchor",href:"#_5-支付成功后，需要进行拆单，根据商品打包方式，所在仓库，物流等进行拆单-待开发","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h5",ro,[s("6.支付的每笔流水都需要记录，以待查账 "),e(n,{class:"header-anchor",href:"#_6-支付的每笔流水都需要记录，以待查账","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),po,io,yo,l("h5",Do,[s("7.订单创建，支付成功(待开发)等状态都需要给 MQ 发送消息，方便其他系统感知订阅 "),e(n,{class:"header-anchor",href:"#_7-订单创建，支付成功-待开发-等状态都需要给-mq-发送消息，方便其他系统感知订阅","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Fo,Ao,Co,uo,go,ho,mo,Eo,fo,_o,ko,bo,So,vo,xo,Io,To,Lo,Oo,Ro,wo,qo,Mo,Bo,Vo,Po,Ko,No,Wo,jo,Qo,Ho,Uo,Go,zo,$o,Jo,Xo,Yo,Zo,l("h5",ln,[s("订单确认页流程 "),e(n,{class:"header-anchor",href:"#订单确认页流程","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),sn,l("h5",on,[s("电商订单流程图 "),e(n,{class:"header-anchor",href:"#电商订单流程图","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),nn,l("h5",en,[s("消息队列流程图 "),e(n,{class:"header-anchor",href:"#消息队列流程图","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),tn,l("h5",an,[s("支付宝支付流程图 "),e(n,{class:"header-anchor",href:"#支付宝支付流程图","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),cn,l("h3",rn,[s("项目难点 "),e(n,{class:"header-anchor",href:"#项目难点","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),pn,l("h3",yn,[s("解决问题 "),e(n,{class:"header-anchor",href:"#解决问题","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Dn,Fn,An,Cn,un,dn,l("h3",gn,[s("项目优化 "),e(n,{class:"header-anchor",href:"#项目优化","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),hn,mn,En,l("h2",fn,[s("CompletableFuture异步编排 "),e(n,{class:"header-anchor",href:"#completablefuture异步编排","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h3",_n,[s("概念 "),e(n,{class:"header-anchor",href:"#概念","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),kn,l("h3",bn,[s("业务场景 "),e(n,{class:"header-anchor",href:"#业务场景","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Sn,vn,xn,l("h3",In,[s("项目代码 "),e(n,{class:"header-anchor",href:"#项目代码","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Tn,Ln,l("h2",On,[s("RabbitMQ延时队列（实现定时任务） "),e(n,{class:"header-anchor",href:"#rabbitmq延时队列（实现定时任务）","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h3",Rn,[s("场景： "),e(n,{class:"header-anchor",href:"#场景：","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),wn,qn,Mn,l("h3",Bn,[s("消息的TTL（Time To Live） "),e(n,{class:"header-anchor",href:"#消息的ttl（time-to-live）","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Vn,l("h3",Pn,[s("Dead Letter Exchanges（DLX） "),e(n,{class:"header-anchor",href:"#dead-letter-exchanges（dlx）","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Kn,l("h3",Nn,[s("延时队列实现 "),e(n,{class:"header-anchor",href:"#延时队列实现","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Wn,jn,Qn,Hn,Un,l("h3",Gn,[s("SpringBoot中使用延时队列 "),e(n,{class:"header-anchor",href:"#springboot中使用延时队列","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),zn,l("h3",$n,[s("消息队列流程 "),e(n,{class:"header-anchor",href:"#消息队列流程","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Jn,Xn,l("h2",Yn,[s("Redis缓存中的数据结构 "),e(n,{class:"header-anchor",href:"#redis缓存中的数据结构","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h3",Zn,[s("分类菜单 "),e(n,{class:"header-anchor",href:"#分类菜单","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),le,l("h3",se,[s("登陆信息-SpringSession "),e(n,{class:"header-anchor",href:"#登陆信息-springsession","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h3",oe,[s("购物车 "),e(n,{class:"header-anchor",href:"#购物车","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ne,l("h3",ee,[s("秒杀上架 (幂等性处理) "),e(n,{class:"header-anchor",href:"#秒杀上架-幂等性处理","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),te,l("h3",ae,[s("幂等性保证 "),e(n,{class:"header-anchor",href:"#幂等性保证","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ce,re,l("h3",pe,[s("Redission分布式锁 "),e(n,{class:"header-anchor",href:"#redission分布式锁","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ie,ye,l("h2",De,[s("分布式事务 "),e(n,{class:"header-anchor",href:"#分布式事务","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Fe,Ae,Ce,ue,de,ge,l("h3",he,[s("事务的坑 "),e(n,{class:"header-anchor",href:"#事务的坑","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),me,l("h3",Ee,[s("CAP理论 "),e(n,{class:"header-anchor",href:"#cap理论","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),fe,l("h3",_e,[s("BASE 理论 "),e(n,{class:"header-anchor",href:"#base-理论","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ke,l("h3",be,[s("分布式事务几种方案 "),e(n,{class:"header-anchor",href:"#分布式事务几种方案","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Se,ve,l("h2",xe,[s("Seata "),e(n,{class:"header-anchor",href:"#seata","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("p",null,[e(n,{href:"https://seata.io/zh-cn/docs/overview/what-is-seata.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("Seata 是什么")]),_:1})]),l("h3",Ie,[s("Seata的理解 "),e(n,{class:"header-anchor",href:"#seata的理解","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Te,l("blockquote",null,[l("p",null,[e(n,{href:"https://seata.io/zh-cn/docs/overview/what-is-seata.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("Seata 是什么")]),_:1})]),l("ul",null,[l("li",null,[l("h4",Le,[s("TC (Transaction Coordinator) - 事务协调者 "),e(n,{class:"header-anchor",href:"#tc-transaction-coordinator-事务协调者","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Oe]),l("li",null,[l("h4",Re,[s("TM (Transaction Manager) - 事务管理器 "),e(n,{class:"header-anchor",href:"#tm-transaction-manager-事务管理器","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),we]),l("li",null,[l("h4",qe,[s("RM (Resource Manager) - 资源管理器 "),e(n,{class:"header-anchor",href:"#rm-resource-manager-资源管理器","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Me])]),Be]),l("h3",Ve,[s("Seata项目整合 "),e(n,{class:"header-anchor",href:"#seata项目整合","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("ul",null,[Pe,Ke,l("li",null,[s("2）、安装事务协调器；seata-server： "),e(n,{href:"https://github.com/seata/seata/releases",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("https://github.com/seata/seata/releases")]),_:1})]),l("li",null,[s("3）、整合 "),l("ul",null,[Ne,We,je,l("li",null,[s("4、每个微服务，都必须导入 "),l("ul",null,[Qe,l("li",null,[s("file.conf vgroup_mapping.{"),e(n,{href:"http://application.name",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("application.name")]),_:1}),s("}-fescar-service-group = “default”")])])]),He,Ue,Ge])])]),ze,$e,l("h2",Je,[s("Sentinel "),e(n,{class:"header-anchor",href:"#sentinel","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("p",null,[e(n,{href:"https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("介绍 · alibaba/Sentinel Wiki · GitHub")]),_:1})]),l("h3",Xe,[s("Sentinel理解 "),e(n,{class:"header-anchor",href:"#sentinel理解","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Ye,l("h3",Ze,[s("熔断降级限流 "),e(n,{class:"header-anchor",href:"#熔断降级限流","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),lt,l("h3",st,[s("项目整合步骤 "),e(n,{class:"header-anchor",href:"#项目整合步骤","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ot,l("h3",nt,[s("整合 Feign+Sentinel 测试熔断降级 "),e(n,{class:"header-anchor",href:"#整合-feign-sentinel-测试熔断降级","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("ul",null,[et,tt,at,ct,l("li",null,[rt,pt,l("blockquote",null,[l("p",null,[e(n,{href:"https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("注解支持 · alibaba/Sentinel Wiki · GitHub")]),_:1})]),it,yt])])]),l("h2",Dt,[s("Nacos "),e(n,{class:"header-anchor",href:"#nacos","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("blockquote",null,[l("p",null,[e(n,{href:"https://nacos.io/zh-cn/docs/use-nacos-with-springcloud.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("Nacos Spring Cloud")]),_:1})])]),l("h3",Ft,[s("项目整合 "),e(n,{class:"header-anchor",href:"#项目整合","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),At,l("h3",Ct,[s("Nacos作为注册中心： "),e(n,{class:"header-anchor",href:"#nacos作为注册中心：","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ut,l("h3",dt,[s("Nacos作为配置中心 "),e(n,{class:"header-anchor",href:"#nacos作为配置中心","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("ul",null,[gt,ht,l("li",null,[mt,l("ul",null,[Et,l("li",null,[l("blockquote",null,[ft,_t,kt,bt,St,vt,l("ul",null,[l("li",null,[s("${prefix} - ${spring.profiles.active} . ${file-extension} prefix 默认为 "),e(n,{href:"http://spring.application.name",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("spring.application.name")]),_:1}),s(" 的值，也可以通过配置项 spring.cloud.nacos.config.prefix 来配置。")]),xt]),It,Tt,Lt,Ot])])])]),l("li",null,[Rt,l("ul",null,[l("li",null,[l("blockquote",null,[wt,qt,Mt,Bt,Vt,l("p",null,[l("strong",null,[s("@Value(“${"),e(n,{href:"http://user.name",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("user.name")]),_:1}),s("}”)")])]),Pt,Kt,Nt,Wt])])])])]),l("h3",jt,[s("Nacos进阶 "),e(n,{class:"header-anchor",href:"#nacos进阶","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Qt,l("h2",Ht,[s("Gateway "),e(n,{class:"header-anchor",href:"#gateway","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("blockquote",null,[l("p",null,[e(n,{href:"https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.3.RELEASE/single/spring-cloud-gateway.html",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("Spring Cloud Gateway")]),_:1})])]),Ut,Gt,l("h2",zt,[s("Feign "),e(n,{class:"header-anchor",href:"#feign","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),$t,Jt,l("h3",Xt,[s("Feign远程调用丢失请求头问题 "),e(n,{class:"header-anchor",href:"#feign远程调用丢失请求头问题","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Yt,l("h3",Zt,[s("Feign异步情况丢失上下文问题 "),e(n,{class:"header-anchor",href:"#feign异步情况丢失上下文问题","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),la,l("h2",sa,[s("SpringCloud Alibaba 常用组件端口号总结 "),e(n,{class:"header-anchor",href:"#springcloud-alibaba-常用组件端口号总结","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),oa,na,l("h2",ea,[s("支付 "),e(n,{class:"header-anchor",href:"#支付","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h3",ta,[s("加密-对称加密 "),e(n,{class:"header-anchor",href:"#加密-对称加密","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),aa,l("h3",ca,[s("加密-非对称加密 "),e(n,{class:"header-anchor",href:"#加密-非对称加密","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ra,l("h3",pa,[s("支付宝验签 "),e(n,{class:"header-anchor",href:"#支付宝验签","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ia,l("h3",ya,[s("收单 "),e(n,{class:"header-anchor",href:"#收单","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Da,l("h2",Fa,[s("MD5&MD5盐值加密 "),e(n,{class:"header-anchor",href:"#md5-md5盐值加密","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Aa,l("h2",Ca,[s("项目微服务 "),e(n,{class:"header-anchor",href:"#项目微服务","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ua,l("h2",da,[s("Nginx+Windows搭建域名访问环境 "),e(n,{class:"header-anchor",href:"#nginx-windows搭建域名访问环境","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ga,l("h3",ha,[s("域名映射效果 "),e(n,{class:"header-anchor",href:"#域名映射效果","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("ul",null,[l("li",null,[s("请求接口 "),e(n,{href:"http://gulimall.com",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("gulimall.com")]),_:1})]),l("li",null,[s("请求页面 "),e(n,{href:"http://gulimall.com",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("gulimall.com")]),_:1})]),ma,Ea,fa]),l("h3",_a,[s("正向代理与反向代理 "),e(n,{class:"header-anchor",href:"#正向代理与反向代理","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ka,ba,Sa,va,l("h3",xa,[s("Nginx配置文件 "),e(n,{class:"header-anchor",href:"#nginx配置文件","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Ia,l("h3",Ta,[s("Nginx动静分离 "),e(n,{class:"header-anchor",href:"#nginx动静分离","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),La,l("h3",Oa,[s("Nginx转发效果 "),e(n,{class:"header-anchor",href:"#nginx转发效果","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Ra,l("h2",wa,[s("内网穿透 "),e(n,{class:"header-anchor",href:"#内网穿透","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),qa,Ma,l("h3",Ba,[s("内网穿透联调 "),e(n,{class:"header-anchor",href:"#内网穿透联调","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Va,l("h3",Pa,[s("配置 "),e(n,{class:"header-anchor",href:"#配置","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Ka,Na,l("p",null,[s("listen 80; server_name "),e(n,{href:"http://gulimall.com",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("gulimall.com")]),_:1}),s(" *.gulimall.com "),e(n,{href:"http://497n86m7k7.52http.net",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("497n86m7k7.52http.net")]),_:1}),s("; #charset koi8-r; #access_log /var/log/nginx/log/host.access.log main; location /static/ { root /usr/share/nginx/html; } location /payed/ { proxy_set_header Host "),e(n,{href:"http://order.gulimall.com",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("order.gulimall.com")]),_:1}),s("; proxy_pass "),e(n,{href:"http://gulimall",target:"_blank",rel:"noreferrer"},{default:o(()=>[s("http://gulimall")]),_:1}),s("; }")]),Wa,l("h2",ja,[s("缓存 "),e(n,{class:"header-anchor",href:"#缓存","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h3",Qa,[s("本地缓存 "),e(n,{class:"header-anchor",href:"#本地缓存","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Ha,l("h3",Ua,[s("分布式缓存-本地模式在分布式下的问题 "),e(n,{class:"header-anchor",href:"#分布式缓存-本地模式在分布式下的问题","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Ga,l("h3",za,[s("分布式缓存 "),e(n,{class:"header-anchor",href:"#分布式缓存","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),$a,l("h4",Ja,[s("高并发下缓存失效问题-缓存穿透 "),e(n,{class:"header-anchor",href:"#高并发下缓存失效问题-缓存穿透","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Xa,Ya,l("h4",Za,[s("高并发下缓存失效问题-缓存雪崩 "),e(n,{class:"header-anchor",href:"#高并发下缓存失效问题-缓存雪崩","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),lc,sc,l("h4",oc,[s("高并发下缓存失效问题-缓存击穿 "),e(n,{class:"header-anchor",href:"#高并发下缓存失效问题-缓存击穿","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),nc,ec,l("h3",tc,[s("分布式下如何加锁？ "),e(n,{class:"header-anchor",href:"#分布式下如何加锁？","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),ac,cc,l("h3",rc,[s("锁-时序问题 "),e(n,{class:"header-anchor",href:"#锁-时序问题","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),pc,l("h3",ic,[s("分布式锁演进-基本原理 "),e(n,{class:"header-anchor",href:"#分布式锁演进-基本原理","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),yc,Dc,l("h4",Fc,[s("分布式锁演进-阶段一 "),e(n,{class:"header-anchor",href:"#分布式锁演进-阶段一","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Ac,l("h4",Cc,[s("分布式锁演进-阶段二 "),e(n,{class:"header-anchor",href:"#分布式锁演进-阶段二","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),uc,l("h4",dc,[s("分布式锁演进-阶段三 "),e(n,{class:"header-anchor",href:"#分布式锁演进-阶段三","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),gc,l("h4",hc,[s("分布式锁演进-阶段四 "),e(n,{class:"header-anchor",href:"#分布式锁演进-阶段四","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),mc,l("h4",Ec,[s("分布式锁演进-阶段五-最终形态 "),e(n,{class:"header-anchor",href:"#分布式锁演进-阶段五-最终形态","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),fc,l("h3",_c,[s("缓存数据一致性-双写模式 "),e(n,{class:"header-anchor",href:"#缓存数据一致性-双写模式","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),kc,l("h3",bc,[s("缓存数据一致性-失效模式 "),e(n,{class:"header-anchor",href:"#缓存数据一致性-失效模式","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Sc,l("h3",vc,[s("缓存数据一致性-解决方案 "),e(n,{class:"header-anchor",href:"#缓存数据一致性-解决方案","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),xc,l("h3",Ic,[s("缓存数据一致性-解决-Canal "),e(n,{class:"header-anchor",href:"#缓存数据一致性-解决-canal","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Tc,l("h2",Lc,[s("Session共享问题 "),e(n,{class:"header-anchor",href:"#session共享问题","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h3",Oc,[s("session原理 "),e(n,{class:"header-anchor",href:"#session原理","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Rc,l("h3",wc,[s("分布式下session共享问题 "),e(n,{class:"header-anchor",href:"#分布式下session共享问题","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),qc,l("h3",Mc,[s("解决-session复制 "),e(n,{class:"header-anchor",href:"#解决-session复制","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Bc,Vc,l("h3",Pc,[s("解决-客户端存储 "),e(n,{class:"header-anchor",href:"#解决-客户端存储","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Kc,Nc,l("h3",Wc,[s("解决-hash一致性 "),e(n,{class:"header-anchor",href:"#解决-hash一致性","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),jc,Qc,l("h3",Hc,[s("解决-统一存储 "),e(n,{class:"header-anchor",href:"#解决-统一存储","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Uc,Gc,l("h3",zc,[s("解决-不同服务，子域session共享 "),e(n,{class:"header-anchor",href:"#解决-不同服务，子域session共享","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),$c,Jc,l("h3",Xc,[s("SpringSession核心原理 "),e(n,{class:"header-anchor",href:"#springsession核心原理","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Yc,l("h2",Zc,[s("购物车 "),e(n,{class:"header-anchor",href:"#购物车-1","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h3",lr,[s("购物车数据结构 "),e(n,{class:"header-anchor",href:"#购物车数据结构","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),sr,or,l("h2",nr,[s("消息队列RabbitMQ "),e(n,{class:"header-anchor",href:"#消息队列rabbitmq","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h3",er,[s("RabbitMQ概念 "),e(n,{class:"header-anchor",href:"#rabbitmq概念","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),tr,ar,l("h3",cr,[s("什么AMQP协议 "),e(n,{class:"header-anchor",href:"#什么amqp协议","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),rr,pr,ir,l("h3",yr,[s("AMQP的核心概念 "),e(n,{class:"header-anchor",href:"#amqp的核心概念","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Dr,l("h3",Fr,[s("RabbitMq的消息是如何流转的？ "),e(n,{class:"header-anchor",href:"#rabbitmq的消息是如何流转的？","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),Ar,l("h3",Cr,[s("RabbitMq 交换机详解 "),e(n,{class:"header-anchor",href:"#rabbitmq-交换机详解","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),l("h4",ur,[dr,s("： "),e(n,{class:"header-anchor",href:"#作用：","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),gr,hr,l("h4",mr,[Er,s(),e(n,{class:"header-anchor",href:"#交换机属性","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),fr,l("h4",_r,[s("交换机类型 "),e(n,{class:"header-anchor",href:"#交换机类型","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),kr,br,Sr,vr,xr,Ir,Tr,Lr,Or,l("h3",Rr,[wr,s(),e(n,{class:"header-anchor",href:"#队列、绑定主机、消息","aria-hidden":"true"},{default:o(()=>[s("#")]),_:1})]),qr]),"main-header":o(()=>[a(t.$slots,"main-header")]),"main-header-after":o(()=>[a(t.$slots,"main-header-after")]),"main-nav":o(()=>[a(t.$slots,"main-nav")]),"main-content":o(()=>[a(t.$slots,"main-content")]),"main-content-after":o(()=>[a(t.$slots,"main-content-after")]),"main-nav-before":o(()=>[a(t.$slots,"main-nav-before")]),"main-nav-after":o(()=>[a(t.$slots,"main-nav-after")]),comment:o(()=>[a(t.$slots,"comment")]),footer:o(()=>[a(t.$slots,"footer")]),aside:o(()=>[a(t.$slots,"aside")]),"aside-custom":o(()=>[a(t.$slots,"aside-custom")]),default:o(()=>[a(t.$slots,"default")]),_:3},8,["frontmatter","data"])}const Gr=y(u,[["render",Mr]]);export{Ur as __pageData,Gr as default};
