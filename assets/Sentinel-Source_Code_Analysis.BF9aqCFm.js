import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang.BOb0xH-1.js";import"./chunks/@vueuse/motion.BrTBiDBP.js";import{d as s,a as l,u as a}from"./chunks/vue-router.iuc03XPI.js";import{a1 as h,a3 as t,a4 as k,a5 as n,a6 as e,a7 as r,F as E,a2 as p,Z as d}from"./framework.CSpzLJwA.js";import"./app.DxsXqPDj.js";import"./chunks/dayjs.Dto65haK.js";import"./chunks/vue-i18n.C5QQbedb.js";import"./chunks/pinia.CKttsWmm.js";import"./chunks/nprogress.BEPa78Un.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.IawhXP3l.js";import"./index.TQnGKZgq.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.DIveis5r.js";import"./post.BWOv1eSm.js";const g=s("/posts/Sentinel-Source_Code_Analysis",async i=>JSON.parse('{"title":"Sentinel源码分析","description":"","frontmatter":{"title":"Sentinel源码分析","author":"imklaus","tags":["Sentinel"],"categories":["Java","微服务"],"date":"2025-12-8 3:27:10","outline":"deep","excerpt_type":"html","end":true},"headers":[],"relativePath":"pages/posts/Sentinel-Source_Code_Analysis.md","lastUpdated":null}'),{lazy:(i,s)=>i.name===s.name}),y={__name:"Sentinel-Source_Code_Analysis",setup(s,{expose:y}){const{data:c}=g(),o=a(),F=l(),u=Object.assign(F.meta.frontmatter||{},c.value?.frontmatter||{});o.currentRoute.value.data=c.value,d("valaxy:frontmatter",u),globalThis.$frontmatter=u;return y({frontmatter:{title:"Sentinel源码分析",author:"imklaus",tags:["Sentinel"],categories:["Java","微服务"],date:"2025-12-8 3:27:10",outline:"deep",excerpt_type:"html",end:!0}}),(s,l)=>{const a=i;return p(),h(a,{frontmatter:E(u)},{"main-content-md":t(()=>[l[0]||(l[0]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208033330494.png",alt:"image-20251208033330494",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1]||(l[1]=n("p",null,[r("参考视频："),n("a",{href:"https://www.bilibili.com/video/BV1LQ4y127n4",target:"_blank",rel:"noreferrer"},"黑马SpringCloud微服务技术栈原理篇")],-1)),l[2]||(l[2]=n("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),l[3]||(l[3]=n("p",null,[n("strong",null,"目录指引"),r("：")],-1)),l[4]||(l[4]=n("nav",{class:"table-of-contents"},[n("ul",null,[n("li",null,[n("a",{href:"#_1-sentinel的基本概念"},"1. Sentinel的基本概念"),n("ul",null,[n("li",null,[n("a",{href:"#_1-1-processorslotchain"},"1.1 ProcessorSlotChain")]),n("li",null,[n("a",{href:"#_1-2-node"},"1.2 Node")]),n("li",null,[n("a",{href:"#_1-3-entry"},"1.3 Entry")]),n("li",null,[n("a",{href:"#_1-4-context"},"1.4 Context")])])]),n("li",null,[n("a",{href:"#_2-processorslotchain执行流程"},"2. ProcessorSlotChain执行流程"),n("ul",null,[n("li",null,[n("a",{href:"#_2-1-入口"},"2.1 入口")]),n("li",null,[n("a",{href:"#_2-2-defaultprocessorslotchain"},"2.2 DefaultProcessorSlotChain")]),n("li",null,[n("a",{href:"#_2-3-nodeselectorslot"},"2.3 NodeSelectorSlot")]),n("li",null,[n("a",{href:"#_2-4-clusterbuilderslot"},"2.4 ClusterBuilderSlot")]),n("li",null,[n("a",{href:"#_2-5-statisticslot"},"2.5 StatisticSlot")]),n("li",null,[n("a",{href:"#_2-6-authorityslot"},"2.6 AuthoritySlot")]),n("li",null,[n("a",{href:"#_2-7-systemslot"},"2.7 SystemSlot")]),n("li",null,[n("a",{href:"#_2-8-paramflowslot"},"2.8 ParamFlowSlot")]),n("li",null,[n("a",{href:"#_2-9-flowslot"},"2.9 FlowSlot")]),n("li",null,[n("a",{href:"#_2-10-degradeslot"},"2.10 DegradeSlot")])])])])],-1)),l[5]||(l[5]=n("h2",{id:"_1-sentinel的基本概念",tabindex:"-1"},[r("1. Sentinel的基本概念 "),n("a",{class:"header-anchor",href:"#_1-sentinel的基本概念","aria-label":'Permalink to "1. Sentinel的基本概念"'},"​")],-1)),l[6]||(l[6]=n("p",null,"Sentinel实现限流、隔离、降级、熔断等功能，本质要做的就是两件事情：",-1)),l[7]||(l[7]=n("ul",null,[n("li",null,"统计数据：统计某个资源的访问数据（QPS、RT等信息）"),n("li",null,"规则判断：判断限流规则、隔离规则、降级规则、熔断规则是否满足")],-1)),l[8]||(l[8]=n("p",null,[r("这里的"),n("strong",null,"资源"),r("就是希望被Sentinel保护的业务，例如项目中定义的controller方法就是默认被Sentinel保护的资源。")],-1)),e(" more "),l[9]||(l[9]=n("h3",{id:"_1-1-processorslotchain",tabindex:"-1"},[r("1.1 ProcessorSlotChain "),n("a",{class:"header-anchor",href:"#_1-1-processorslotchain","aria-label":'Permalink to "1.1 ProcessorSlotChain"'},"​")],-1)),l[10]||(l[10]=n("p",null,"实现上述功能的核心骨架是一个叫做ProcessorSlotChain的类。这个类基于责任链模式来设计，将不同的功能（限流、降级、系统保护）封装为一个个的Slot，请求进入后逐个执行即可。",-1)),l[11]||(l[11]=n("p",null,"其工作流如图：",-1)),l[12]||(l[12]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925092845529.png",alt:"image-20210925092845529",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[13]||(l[13]=n("p",null,"责任链中的Slot也分为两大类：",-1)),l[14]||(l[14]=n("ul",null,[n("li",null,[r("统计数据构建部分（statistic） "),n("ul",null,[n("li",null,"NodeSelectorSlot：负责构建簇点链路中的节点（DefaultNode），将这些节点形成链路树"),n("li",null,"ClusterBuilderSlot：负责构建某个资源的ClusterNode，ClusterNode可以保存资源的运行信息（响应时间、QPS、block 数目、线程数、异常数等）以及来源信息（origin名称）"),n("li",null,"StatisticSlot：负责统计实时调用数据，包括运行信息、来源信息等")])]),n("li",null,[r("规则判断部分（rule checking） "),n("ul",null,[n("li",null,"AuthoritySlot：负责授权规则（来源控制）"),n("li",null,"SystemSlot：负责系统保护规则"),n("li",null,"ParamFlowSlot：负责热点参数限流规则"),n("li",null,"FlowSlot：负责限流规则"),n("li",null,"DegradeSlot：负责降级规则")])])],-1)),l[15]||(l[15]=n("h3",{id:"_1-2-node",tabindex:"-1"},[r("1.2 Node "),n("a",{class:"header-anchor",href:"#_1-2-node","aria-label":'Permalink to "1.2 Node"'},"​")],-1)),l[16]||(l[16]=n("p",null,"Sentinel中的簇点链路是由一个个的Node组成的，Node是一个接口，包括下面的实现：",-1)),l[17]||(l[17]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925103029924.png",alt:"image-20210925103029924",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[18]||(l[18]=n("p",null,"所有的节点都可以记录对资源的访问统计数据，所以都是StatisticNode的子类。",-1)),l[19]||(l[19]=n("p",null,"按照作用分为两类Node：",-1)),l[20]||(l[20]=n("ul",null,[n("li",null,"DefaultNode：代表链路树中的每一个资源，一个资源出现在不同链路中时，会创建不同的DefaultNode节点。而树的入口节点叫EntranceNode，是一种特殊的DefaultNode"),n("li",null,"ClusterNode：代表资源，一个资源不管出现在多少链路中，只会有一个ClusterNode。记录的是当前资源被访问的所有统计数据之和。")],-1)),l[21]||(l[21]=n("p",null,"DefaultNode记录的是资源在当前链路中的访问数据，用来实现基于链路模式的限流规则。ClusterNode记录的是资源在所有链路中的访问数据，实现默认模式、关联模式的限流规则。",-1)),l[22]||(l[22]=n("p",null,"例如：我们在一个SpringMVC项目中，有两个业务：",-1)),l[23]||(l[23]=n("ul",null,[n("li",null,[r("业务1：controller中的资源"),n("code",null,"/order/query"),r("访问了service中的资源"),n("code",null,"/goods")]),n("li",null,[r("业务2：controller中的资源"),n("code",null,"/order/save"),r("访问了service中的资源"),n("code",null,"/goods")])],-1)),l[24]||(l[24]=n("p",null,"创建的链路图如下：",-1)),l[25]||(l[25]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925104726158.png",alt:"image-20210925104726158",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[26]||(l[26]=n("h3",{id:"_1-3-entry",tabindex:"-1"},[r("1.3 Entry "),n("a",{class:"header-anchor",href:"#_1-3-entry","aria-label":'Permalink to "1.3 Entry"'},"​")],-1)),l[27]||(l[27]=n("p",null,"默认情况下，Sentinel会将controller中的方法作为被保护资源，那么问题来了，我们该如何将自己的一段代码标记为一个Sentinel的资源呢？",-1)),l[28]||(l[28]=n("p",null,"Sentinel中的资源用Entry来表示。声明Entry的API示例：",-1)),l[29]||(l[29]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 资源名可使用任意有业务语义的字符串，比如方法名、接口名或其它可唯一标识的字符串。")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Entry entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SphU."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"resourceName"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  // 被保护的业务逻辑")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  // do something here...")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (BlockException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"ex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  // 资源访问阻止，被限流或被降级")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  // 在此处进行相应的处理操作")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[30]||(l[30]=n("h4",{id:"_1-3-1-自定义资源",tabindex:"-1"},[r("1.3.1 自定义资源 "),n("a",{class:"header-anchor",href:"#_1-3-1-自定义资源","aria-label":'Permalink to "1.3.1 自定义资源"'},"​")],-1)),l[31]||(l[31]=n("p",null,[r("例如，我们在order-service服务中，将"),n("code",null,"OrderService"),r("的"),n("code",null,"queryOrderById()"),r("方法标记为一个资源。")],-1)),l[32]||(l[32]=n("p",null,"1）首先在order-service中引入sentinel依赖",-1)),l[33]||(l[33]=n("div",{class:"language-xml max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"xml"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\x3c!--sentinel--\x3e")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.alibaba.cloud</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-cloud-starter-alibaba-sentinel</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[34]||(l[34]=n("p",null,"2）然后配置Sentinel地址",-1)),l[35]||(l[35]=n("div",{class:"language-yaml max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"yaml"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    sentinel"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      transport"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        dashboard"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"localhost:8089"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 这里我的sentinel用了8089的端口")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[36]||(l[36]=n("p",null,"3）修改OrderService类的queryOrderById方法",-1)),l[37]||(l[37]=n("p",null,"代码这样来实现：",-1)),l[38]||(l[38]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Order "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryOrderById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long orderId) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建Entry，标记资源，资源名为resource1")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Entry entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SphU."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"resource1"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.查询订单，这里是假数据")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Order order "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Order."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"101L"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"4999L"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"小米 MIX4"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1L"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.查询用户，基于Feign的远程调用")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        User user "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," userClient."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findById"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(order."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUserId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.设置")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        order."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUser"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(user);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.返回")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," order;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (BlockException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"被限流或降级"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[39]||(l[39]=n("p",null,"4）访问",-1)),l[40]||(l[40]=n("p",null,[r("打开浏览器，访问order服务："),n("a",{href:"http://localhost:8080/order/101",target:"_blank",rel:"noreferrer"},"http://localhost:8080/order/101")],-1)),l[41]||(l[41]=n("p",null,"然后打开sentinel控制台，查看簇点链路：",-1)),l[42]||(l[42]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925113122759.png",alt:"image-20210925113122759",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[43]||(l[43]=n("h4",{id:"_1-3-2-基于注解标记资源",tabindex:"-1"},[r("1.3.2 基于注解标记资源 "),n("a",{class:"header-anchor",href:"#_1-3-2-基于注解标记资源","aria-label":'Permalink to "1.3.2 基于注解标记资源"'},"​")],-1)),l[44]||(l[44]=n("p",null,"在之前学习Sentinel的时候，我们知道可以通过给方法添加@SentinelResource注解的形式来标记资源。",-1)),l[45]||(l[45]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925141507603.png",alt:"image-20210925141507603",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[46]||(l[46]=n("p",null,"这个是怎么实现的呢？",-1)),l[47]||(l[47]=n("p",null,"来看下我们引入的Sentinel依赖包：",-1)),l[48]||(l[48]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925115601560.png",alt:"image-20210925115601560",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[49]||(l[49]=n("p",null,"其中的spring.factories声明需要就是自动装配的配置类，内容如下：",-1)),l[50]||(l[50]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925115740281.png",alt:"image-20210925115740281",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[51]||(l[51]=n("p",null,[r("我们来看下"),n("code",null,"SentinelAutoConfiguration"),r("这个类：")],-1)),l[52]||(l[52]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925141553785.png",alt:"image-20210925141553785",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[53]||(l[53]=n("p",null,[r("可以看到，在这里声明了一个Bean，"),n("code",null,"SentinelResourceAspect"),r("：")],-1)),l[54]||(l[54]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * Aspect for methods with {@link SentinelResource} annotation.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@author"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," Eric Zhao")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Aspect")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SentinelResourceAspect"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," extends"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AbstractSentinelAspectSupport"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 切点是添加了 @SentinelResource注解的类")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Pointcut"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"@annotation(com.alibaba.csp.sentinel.annotation.SentinelResource)"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," sentinelResourceAnnotationPointcut"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 环绕增强")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Around"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"sentinelResourceAnnotationPointcut()"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Object "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"invokeResourceWithSentinel"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ProceedingJoinPoint "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"pjp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Throwable {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取受保护的方法")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Method originMethod "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," resolveMethod"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pjp);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 获取 @SentinelResource注解")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SentinelResource annotation "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," originMethod."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAnnotation"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SentinelResource.class);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (annotation "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // Should not go through here.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," IllegalStateException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Wrong state for SentinelResource annotation"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取注解上的资源名称")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String resourceName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getResourceName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(annotation."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"value"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), originMethod);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        EntryType entryType "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," annotation."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entryType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resourceType "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," annotation."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"resourceType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Entry entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 创建资源 Entry")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SphU."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceName, resourceType, entryType, pjp."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getArgs"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 执行受保护的方法")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Object result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pjp."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"proceed"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (BlockException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"ex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleBlockException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pjp, annotation, ex);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"ex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Class<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," extends"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," Throwable"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">[] exceptionsToIgnore "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," annotation."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"exceptionsToIgnore"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // The ignore list will be checked first.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (exceptionsToIgnore.length "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," exceptionBelongsTo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ex, exceptionsToIgnore)) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                throw"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ex;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"exceptionBelongsTo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ex, annotation."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"exceptionsToTrace"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                traceException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ex);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleFallback"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pjp, annotation, ex);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // No fallback function can handle the exception, so throw it out.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ex;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"exit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", pjp."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getArgs"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[55]||(l[55]=n("p",null,[r("简单来说，@SentinelResource注解就是一个标记，而Sentinel基于AOP思想，对被标记的方法做环绕增强，完成资源（"),n("code",null,"Entry"),r("）的创建。")],-1)),l[56]||(l[56]=n("h3",{id:"_1-4-context",tabindex:"-1"},[r("1.4 Context "),n("a",{class:"header-anchor",href:"#_1-4-context","aria-label":'Permalink to "1.4 Context"'},"​")],-1)),l[57]||(l[57]=n("p",null,"上一节，我们发现簇点链路中除了controller方法、service方法两个资源外，还多了一个默认的入口节点：",-1)),l[58]||(l[58]=n("p",null,"sentinel_spring_web_context，是一个EntranceNode类型的节点",-1)),l[59]||(l[59]=n("p",null,"这个节点是在初始化Context的时候由Sentinel帮我们创建的。",-1)),l[60]||(l[60]=n("h4",{id:"_1-4-1-什么是context",tabindex:"-1"},[r("1.4.1 什么是Context "),n("a",{class:"header-anchor",href:"#_1-4-1-什么是context","aria-label":'Permalink to "1.4.1 什么是Context"'},"​")],-1)),l[61]||(l[61]=n("p",null,"那么，什么是Context呢？",-1)),l[62]||(l[62]=n("ul",null,[n("li",null,[r("Context 代表调用链路上下文，贯穿一次调用链路中的所有资源（ "),n("code",null,"Entry"),r("），基于ThreadLocal。")]),n("li",null,[r("Context 维持着入口节点（"),n("code",null,"entranceNode"),r("）、本次调用链路的 curNode（当前资源节点）、调用来源（"),n("code",null,"origin"),r("）等信息。")]),n("li",null,"后续的Slot都可以通过Context拿到DefaultNode或者ClusterNode，从而获取统计数据，完成规则判断"),n("li",null,"Context初始化的过程中，会创建EntranceNode，contextName就是EntranceNode的名称")],-1)),l[63]||(l[63]=n("p",null,"对应的API如下：",-1)),l[64]||(l[64]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 创建context，包含两个参数：context名称、 来源名称")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ContextUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"enter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"contextName"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"originName"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[65]||(l[65]=n("h4",{id:"_1-4-2-context的初始化",tabindex:"-1"},[r("1.4.2 Context的初始化 "),n("a",{class:"header-anchor",href:"#_1-4-2-context的初始化","aria-label":'Permalink to "1.4.2 Context的初始化"'},"​")],-1)),l[66]||(l[66]=n("p",null,"那么这个Context又是在何时完成初始化的呢？",-1)),l[67]||(l[67]=n("h5",{id:"_1-4-2-1-自动装配",tabindex:"-1"},[r("1.4.2.1 自动装配 "),n("a",{class:"header-anchor",href:"#_1-4-2-1-自动装配","aria-label":'Permalink to "1.4.2.1 自动装配"'},"​")],-1)),l[68]||(l[68]=n("p",null,"来看下我们引入的Sentinel依赖包：",-1)),l[69]||(l[69]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925115601560.png",alt:"image-20210925115601560",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[70]||(l[70]=n("p",null,"其中的spring.factories声明需要就是自动装配的配置类，内容如下：",-1)),l[71]||(l[71]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925115740281.png",alt:"image-20210925115740281",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[72]||(l[72]=n("p",null,"我们先看SentinelWebAutoConfiguration这个类：",-1)),l[73]||(l[73]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925115824345.png",alt:"image-20210925115824345",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[74]||(l[74]=n("p",null,"这个类实现了WebMvcConfigurer，我们知道这个是SpringMVC自定义配置用到的类，可以配置HandlerInterceptor：",-1)),l[75]||(l[75]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925115946064.png",alt:"image-20210925115946064",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[76]||(l[76]=n("p",null,[r("可以看到这里配置了一个"),n("code",null,"SentinelWebInterceptor"),r("的拦截器。")],-1)),l[77]||(l[77]=n("p",null,[n("code",null,"SentinelWebInterceptor"),r("的声明如下：")],-1)),l[78]||(l[78]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925120119030.png",alt:"image-20210925120119030",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[79]||(l[79]=n("p",null,[r("发现它继承了"),n("code",null,"AbstractSentinelInterceptor"),r("这个类。")],-1)),l[80]||(l[80]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925120221883.png",alt:"image-20210925120221883",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[81]||(l[81]=n("p",null,[n("code",null,"HandlerInterceptor"),r("拦截器会拦截一切进入controller的方法，执行"),n("code",null,"preHandle"),r("前置拦截方法，而Context的初始化就是在这里完成的。")],-1)),l[82]||(l[82]=n("h5",{id:"_1-4-2-2-abstractsentinelinterceptor",tabindex:"-1"},[r("1.4.2.2 AbstractSentinelInterceptor "),n("a",{class:"header-anchor",href:"#_1-4-2-2-abstractsentinelinterceptor","aria-label":'Permalink to "1.4.2.2 AbstractSentinelInterceptor"'},"​")],-1)),l[83]||(l[83]=n("p",null,[n("code",null,"HandlerInterceptor"),r("拦截器会拦截一切进入controller的方法，执行"),n("code",null,"preHandle"),r("前置拦截方法，而Context的初始化就是在这里完成的。")],-1)),l[84]||(l[84]=n("p",null,[r("我们来看看这个类的"),n("code",null,"preHandle"),r("实现：")],-1)),l[85]||(l[85]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," preHandle"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest request, HttpServletResponse response, Object handler)")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws Exception {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取资源名称，一般是controller方法的@RequestMapping路径，例如/order/{orderId}")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String resourceName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getResourceName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceName)) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 从request中获取请求来源，将来做 授权规则 判断时会用")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String origin "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," parseOrigin"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取 contextName，默认是sentinel_spring_web_context")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String contextName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getContextName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建 Context")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ContextUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"enter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(contextName, origin);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建资源，名称就是当前请求的controller方法的映射路径")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Entry entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SphU."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceName, ResourceTypeConstants.COMMON_WEB, EntryType.IN);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        request."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAttribute"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(baseWebMvcConfig."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRequestAttributeName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), entry);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (BlockException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            handleBlockException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, response, e);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ContextUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"exit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[86]||(l[86]=n("h5",{id:"_1-4-2-3-contextutil",tabindex:"-1"},[r("1.4.2.3 ContextUtil "),n("a",{class:"header-anchor",href:"#_1-4-2-3-contextutil","aria-label":'Permalink to "1.4.2.3 ContextUtil"'},"​")],-1)),l[87]||(l[87]=n("p",null,[r("创建Context的方法就是"),n("code",null," ContextUtil.enter(contextName, origin);")],-1)),l[88]||(l[88]=n("p",null,"我们进入该方法：",-1)),l[89]||(l[89]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Context "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"enter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String name, String origin) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Constants.CONTEXT_DEFAULT_NAME."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(name)) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ContextNameDefineException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'            "The "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Constants.CONTEXT_DEFAULT_NAME "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' " can\'t be permit to defined!"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," trueEnter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(name, origin);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[90]||(l[90]=n("p",null,[r("进入"),n("code",null,"trueEnter"),r("方法：")],-1)),l[91]||(l[91]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"protected"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Context "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"trueEnter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String name, String origin) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 尝试获取context")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Context context "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," contextHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判空")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (context "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果为空，开始初始化")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DefaultNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> localCacheNameMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," contextNameNodeMap;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 尝试获取入口节点")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        DefaultNode node "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," localCacheNameMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(name);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (node "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            LOCK."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                node "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," contextNameNodeMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(name);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (node "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 入口节点为空，初始化入口节点 EntranceNode")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    node "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," EntranceNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," StringResourceWrapper"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(name, EntryType.IN), "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 添加入口节点到 ROOT")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Constants.ROOT."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addChild"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(node);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 将入口节点放入缓存")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DefaultNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> newMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(contextNameNodeMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    newMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"putAll"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(contextNameNodeMap);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    newMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(name, node);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    contextNameNodeMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," newMap;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                LOCK."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建Context，参数为：入口节点 和 contextName")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        context "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Context"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(node, name);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置请求来源 origin")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setOrigin"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(origin);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入ThreadLocal")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        contextHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 返回")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," context;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[92]||(l[92]=n("h2",{id:"_2-processorslotchain执行流程",tabindex:"-1"},[r("2. ProcessorSlotChain执行流程 "),n("a",{class:"header-anchor",href:"#_2-processorslotchain执行流程","aria-label":'Permalink to "2. ProcessorSlotChain执行流程"'},"​")],-1)),l[93]||(l[93]=n("p",null,"接下来我们跟踪源码，验证下ProcessorSlotChain的执行流程。",-1)),l[94]||(l[94]=n("h3",{id:"_2-1-入口",tabindex:"-1"},[r("2.1 入口 "),n("a",{class:"header-anchor",href:"#_2-1-入口","aria-label":'Permalink to "2.1 入口"'},"​")],-1)),l[95]||(l[95]=n("p",null,[r("首先，回到一切的入口，"),n("code",null,"AbstractSentinelInterceptor"),r("类的"),n("code",null,"preHandle"),r("方法：")],-1)),l[96]||(l[96]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925142313050.png",alt:"image-20210925142313050",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[97]||(l[97]=n("p",null,[r("还有，"),n("code",null,"SentinelResourceAspect"),r("的环绕增强方法：")],-1)),l[98]||(l[98]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925142438552.png",alt:"image-20210925142438552",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[99]||(l[99]=n("p",null,[r("可以看到，任何一个资源必定要执行"),n("code",null,"SphU.entry()"),r("这个方法:")],-1)),l[100]||(l[100]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Entry "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String name, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resourceType, EntryType trafficType, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] args)")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws BlockException {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Env.sph."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entryWithType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(name, resourceType, trafficType, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[101]||(l[101]=n("p",null,[r("继续进入"),n("code",null,"Env.sph.entryWithType(name, resourceType, trafficType, 1, args);"),r("：")],-1)),l[102]||(l[102]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Entry "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entryWithType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String name, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resourceType, EntryType entryType, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized,")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                           Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] args) throws BlockException {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 将 资源名称等基本信息 封装为一个 StringResourceWrapper对象")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    StringResourceWrapper resource "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," StringResourceWrapper"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(name, entryType, resourceType);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 继续")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," entryWithPriority"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resource, count, prioritized, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[103]||(l[103]=n("p",null,[r("进入"),n("code",null,"entryWithPriority"),r("方法：")],-1)),l[104]||(l[104]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Entry "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entryWithPriority"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ResourceWrapper resourceWrapper, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized, Object... args)")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws BlockException {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取 Context")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Context context "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ContextUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getContext"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (context "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // Using default context.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        context "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," InternalContextUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"internalEnter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Constants.CONTEXT_DEFAULT_NAME);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"、\t"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 获取 Slot执行链，同一个资源，会创建一个执行链，放入缓存")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ProcessorSlot<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> chain "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," lookProcessChain"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper);")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 创建 Entry，并将 resource、chain、context 记录在 Entry中")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Entry e "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CtEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper, chain, context);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 执行 slotChain")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        chain."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", count, prioritized, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (BlockException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"exit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e1;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // This should not happen, unless there are errors existing in Sentinel internal.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RecordLog."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Sentinel unexpected exception"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e1);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[105]||(l[105]=n("p",null,[r("在这段代码中，会获取"),n("code",null,"ProcessorSlotChain"),r("对象，然后基于chain.entry()开始执行slotChain中的每一个Slot. 而这里创建的是其实现类：DefaultProcessorSlotChain.")],-1)),l[106]||(l[106]=n("p",null,"获取ProcessorSlotChain以后会保存到一个Map中，key是ResourceWrapper，值是ProcessorSlotChain.",-1)),l[107]||(l[107]=n("p",null,[r("所以，"),n("strong",null,"一个资源只会有一个ProcessorSlotChain"),r(".")],-1)),l[108]||(l[108]=n("h3",{id:"_2-2-defaultprocessorslotchain",tabindex:"-1"},[r("2.2 DefaultProcessorSlotChain "),n("a",{class:"header-anchor",href:"#_2-2-defaultprocessorslotchain","aria-label":'Permalink to "2.2 DefaultProcessorSlotChain"'},"​")],-1)),l[109]||(l[109]=n("p",null,"我们进入DefaultProcessorSlotChain的entry方法：",-1)),l[110]||(l[110]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context, ResourceWrapper resourceWrapper, Object t, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized, Object... args)")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws Throwable {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // first，就是责任链中的第一个 slot")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    first."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"transformEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, t, count, prioritized, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[111]||(l[111]=n("p",null,"这里的first，类型是AbstractLinkedProcessorSlot：",-1)),l[112]||(l[112]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925144355865.png",alt:"image-20210925144355865",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[113]||(l[113]=n("p",null,"看下继承关系：",-1)),l[114]||(l[114]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925144010507.png",alt:"image-20210925144010507",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[115]||(l[115]=n("p",null,[r("因此，first一定是这些实现类中的一个，按照最早讲的责任链顺序，first应该就是 "),n("code",null,"NodeSelectorSlot"),r("。")],-1)),l[116]||(l[116]=n("p",null,"不过，既然是基于责任链模式，所以这里只要记住下一个slot就可以了，也就是next：",-1)),l[117]||(l[117]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925144233302.png",alt:"image-20210925144233302",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[118]||(l[118]=n("p",null,"next确实是NodeSelectSlot类型。",-1)),l[119]||(l[119]=n("p",null,"而NodeSelectSlot的next一定是ClusterBuilderSlot，依次类推：",-1)),l[120]||(l[120]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925101327080.png",alt:"image-20210925101327080",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[121]||(l[121]=n("p",null,"责任链就建立起来了。",-1)),l[122]||(l[122]=n("h3",{id:"_2-3-nodeselectorslot",tabindex:"-1"},[r("2.3 NodeSelectorSlot "),n("a",{class:"header-anchor",href:"#_2-3-nodeselectorslot","aria-label":'Permalink to "2.3 NodeSelectorSlot"'},"​")],-1)),l[123]||(l[123]=n("p",null,"NodeSelectorSlot负责构建簇点链路中的节点（DefaultNode），将这些节点形成链路树。",-1)),l[124]||(l[124]=n("p",null,"核心代码：",-1)),l[125]||(l[125]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context, ResourceWrapper resourceWrapper, Object obj, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized, Object... args)")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws Throwable {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  \t// 尝试获取 当前资源的 DefaultNode")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    DefaultNode node "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," map."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (node "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        synchronized"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            node "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," map."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (node "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 如果为空，为当前资源创建一个新的 DefaultNode")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                node "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DefaultNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                HashMap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DefaultNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> cacheMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DefaultNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">(map."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                cacheMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"putAll"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 放入缓存中，注意这里的 key是contextName，")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 这样不同链路进入相同资源，就会创建多个 DefaultNode")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                cacheMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), node);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                map "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cacheMap;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 当前节点加入上一节点的 child中，这样就构成了调用链路树")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ((DefaultNode) context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addChild"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(node);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// context中的curNode（当前节点）设置为新的 node")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCurNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(node);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 执行下一个 slot")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    fireEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, node, count, prioritized, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[126]||(l[126]=n("p",null,"这个Slot完成了这么几件事情：",-1)),l[127]||(l[127]=n("ul",null,[n("li",null,"为当前资源创建 DefaultNode"),n("li",null,"将DefaultNode放入缓存中，key是contextName，这样不同链路入口的请求，将会创建多个DefaultNode，相同链路则只有一个DefaultNode"),n("li",null,"将当前资源的DefaultNode设置为上一个资源的childNode"),n("li",null,"将当前资源的DefaultNode设置为Context中的curNode（当前节点）")],-1)),l[128]||(l[128]=n("p",null,"下一个slot，就是ClusterBuilderSlot",-1)),l[129]||(l[129]=n("h3",{id:"_2-4-clusterbuilderslot",tabindex:"-1"},[r("2.4 ClusterBuilderSlot "),n("a",{class:"header-anchor",href:"#_2-4-clusterbuilderslot","aria-label":'Permalink to "2.4 ClusterBuilderSlot"'},"​")],-1)),l[130]||(l[130]=n("p",null,"ClusterBuilderSlot负责构建某个资源的ClusterNode，核心代码：",-1)),l[131]||(l[131]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context, ResourceWrapper resourceWrapper, DefaultNode node,")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                  int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized, Object... args)")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws Throwable {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判空，注意ClusterNode是共享的成员变量，也就是说一个资源只有一个ClusterNode，与链路无关")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clusterNode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        synchronized"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (lock) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clusterNode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 创建 cluster node.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                clusterNode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ClusterNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), resourceWrapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getResourceType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                HashMap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ResourceWrapper"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ClusterNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> newMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(Math."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"max"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterNodeMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"16"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                newMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"putAll"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterNodeMap);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 放入缓存，可以是nodeId，也就是resource名称")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                newMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(node."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), clusterNode);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                clusterNodeMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," newMap;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 将资源的 DefaultNode与 ClusterNode关联")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    node."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setClusterNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterNode);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 记录请求来源 origin 将 origin放入 entry")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrigin"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Node originNode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," node."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrCreateOriginNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrigin"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCurEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setOriginNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(originNode);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 继续下一个slot")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    fireEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, node, count, prioritized, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[132]||(l[132]=n("h3",{id:"_2-5-statisticslot",tabindex:"-1"},[r("2.5 StatisticSlot "),n("a",{class:"header-anchor",href:"#_2-5-statisticslot","aria-label":'Permalink to "2.5 StatisticSlot"'},"​")],-1)),l[133]||(l[133]=n("p",null,"StatisticSlot负责统计实时调用数据，包括运行信息（访问次数、线程数）、来源信息等。",-1)),l[134]||(l[134]=n("p",null,[r("StatisticSlot是实现限流的关键，其中基于"),n("strong",null,"滑动时间窗口算法"),r("维护了计数器，统计进入某个资源的请求次数。")],-1)),l[135]||(l[135]=n("p",null,"核心代码：",-1)),l[136]||(l[136]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context, ResourceWrapper resourceWrapper, DefaultNode node, ")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                  int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized, Object... args) throws Throwable {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放行到下一个 slot，做限流、降级等判断")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        fireEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, node, count, prioritized, args);")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 请求通过了, 线程计数器 +1 ，用作线程隔离")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        node."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"increaseThreadNum"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 请求计数器 +1 用作限流")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        node."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addPassRequest"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count);")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCurEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOriginNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果有 origin，来源计数器也都要 +1")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCurEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOriginNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"increaseThreadNum"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCurEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOriginNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addPassRequest"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (resourceWrapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEntryType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," EntryType.IN) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果是入口资源，还要给全局计数器 +1.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Constants.ENTRY_NODE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"increaseThreadNum"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Constants.ENTRY_NODE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addPassRequest"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 请求通过后的回调.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ProcessorSlotEntryCallback<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DefaultNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> handler "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StatisticSlotCallbackRegistry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEntryCallbacks"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            handler."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"onPass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, node, count, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 各种异常处理就省略了。。。")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCurEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setError"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[137]||(l[137]=n("p",null,[r("另外，需要注意的是，所有的计数+1动作都包括两部分，以"),n("code",null," node.addPassRequest(count);"),r("为例：")],-1)),l[138]||(l[138]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addPassRequest"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // DefaultNode的计数器，代表当前链路的 计数器")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    super"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addPassRequest"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // ClusterNode计数器，代表当前资源的 总计数器")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".clusterNode."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addPassRequest"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[139]||(l[139]=n("p",null,"具体计数方式，我们后续再看。",-1)),l[140]||(l[140]=n("p",null,"接下来，进入规则校验的相关slot了，依次是：",-1)),l[141]||(l[141]=n("ul",null,[n("li",null,"AuthoritySlot：负责授权规则（来源控制）"),n("li",null,"SystemSlot：负责系统保护规则"),n("li",null,"ParamFlowSlot：负责热点参数限流规则"),n("li",null,"FlowSlot：负责限流规则"),n("li",null,"DegradeSlot：负责降级规则")],-1)),l[142]||(l[142]=n("h3",{id:"_2-6-authorityslot",tabindex:"-1"},[r("2.6 AuthoritySlot "),n("a",{class:"header-anchor",href:"#_2-6-authorityslot","aria-label":'Permalink to "2.6 AuthoritySlot"'},"​")],-1)),l[143]||(l[143]=n("p",null,"负责请求来源origin的授权规则判断，如图：",-1)),l[144]||(l[144]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925152626648.png",alt:"image-20210925152626648",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[145]||(l[145]=n("p",null,"核心API：",-1)),l[146]||(l[146]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context, ResourceWrapper resourceWrapper, DefaultNode node, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized, Object... args)")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws Throwable {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 校验黑白名单")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    checkBlackWhiteAuthority"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper, context);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 进入下一个 slot")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    fireEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, node, count, prioritized, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[147]||(l[147]=n("p",null,"黑白名单校验的逻辑：",-1)),l[148]||(l[148]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," checkBlackWhiteAuthority"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ResourceWrapper resource, Context context) throws AuthorityException {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取授权规则")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Set<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"AuthorityRule"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> authorityRules "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AuthorityRuleManager."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAuthorityRules"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (authorityRules "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Set<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"AuthorityRule"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> rules "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," authorityRules."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resource."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (rules "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 遍历规则并判断")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (AuthorityRule rule "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rules) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"AuthorityRuleChecker."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"passCheck"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rule, context)) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 规则不通过，直接抛出异常")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AuthorityException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrigin"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), rule);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[149]||(l[149]=n("p",null,[r("再看下"),n("code",null,"AuthorityRuleChecker.passCheck(rule, context)"),r("方法：")],-1)),l[150]||(l[150]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," passCheck"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(AuthorityRule rule, Context context) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 得到请求来源 origin")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String requester "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrigin"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 来源为空，或者规则为空，都直接放行")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(requester) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rule."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLimitApp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // rule.getLimitApp()得到的就是 白名单 或 黑名单 的字符串，这里先用 indexOf方法判断")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pos "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rule."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLimitApp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"indexOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(requester);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," contain "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pos "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (contain) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'        // 如果包含 origin，还要进一步做精确判断，把名单列表以","分割，逐个判断')]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," exactlyMatch "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] appArray "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rule."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLimitApp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"split"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (String app "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," appArray) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (requester."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(app)) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                exactlyMatch "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                break"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        contain "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," exactlyMatch;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 如果是黑名单，并且包含origin，则返回false")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," strategy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rule."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStrategy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (strategy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RuleConstant.AUTHORITY_BLACK "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," contain) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 如果是白名单，并且不包含origin，则返回false")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (strategy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RuleConstant.AUTHORITY_WHITE "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," !"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"contain) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 其它情况返回true")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[151]||(l[151]=n("h3",{id:"_2-7-systemslot",tabindex:"-1"},[r("2.7 SystemSlot "),n("a",{class:"header-anchor",href:"#_2-7-systemslot","aria-label":'Permalink to "2.7 SystemSlot"'},"​")],-1)),l[152]||(l[152]=n("p",null,"SystemSlot是对系统保护的规则校验：",-1)),l[153]||(l[153]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925153228036.png",alt:"image-20210925153228036",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[154]||(l[154]=n("p",null,"核心API：",-1)),l[155]||(l[155]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context, ResourceWrapper resourceWrapper, DefaultNode node, ")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                  int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count,"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized, Object... args) throws Throwable {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 系统规则校验")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SystemRuleManager."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkSystem"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 进入下一个 slot")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    fireEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, node, count, prioritized, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[156]||(l[156]=n("p",null,[r("来看下"),n("code",null,"SystemRuleManager.checkSystem(resourceWrapper);"),r("的代码：")],-1)),l[157]||(l[157]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," checkSystem"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ResourceWrapper resourceWrapper) throws BlockException {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (resourceWrapper "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // Ensure the checking switch is on.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"checkSystemStatus."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 只针对入口资源做校验，其它直接返回")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (resourceWrapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEntryType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," EntryType.IN) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 全局 QPS校验")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    double"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," currentQps "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Constants.ENTRY_NODE "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ?"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0.0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," :"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Constants.ENTRY_NODE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"successQps"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (currentQps "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," qps) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SystemBlockException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"qps"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 全局 线程数 校验")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," currentThread "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Constants.ENTRY_NODE "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ?"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," :"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Constants.ENTRY_NODE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"curThreadNum"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (currentThread "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," maxThread) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SystemBlockException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"thread"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 全局平均 RT校验")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    double"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rt "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Constants.ENTRY_NODE "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ?"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," :"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Constants.ENTRY_NODE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"avgRt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (rt "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," maxRt) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SystemBlockException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"rt"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 全局 系统负载 校验")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (highestSystemLoadIsSet "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getCurrentSystemAvgLoad"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," highestSystemLoad) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkBbr"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(currentThread)) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SystemBlockException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"load"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 全局 CPU使用率 校验")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (highestCpuUsageIsSet "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getCurrentCpuUsage"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," highestCpuUsage) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SystemBlockException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cpu"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[158]||(l[158]=n("h3",{id:"_2-8-paramflowslot",tabindex:"-1"},[r("2.8 ParamFlowSlot "),n("a",{class:"header-anchor",href:"#_2-8-paramflowslot","aria-label":'Permalink to "2.8 ParamFlowSlot"'},"​")],-1)),l[159]||(l[159]=n("p",null,"ParamFlowSlot就是热点参数限流，如图：",-1)),l[160]||(l[160]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925153719891.png",alt:"image-20210925153719891",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[161]||(l[161]=n("p",null,"是针对进入资源的请求，针对不同的请求参数值分别统计QPS的限流方式。",-1)),l[162]||(l[162]=n("ul",null,[n("li",null,[n("p",null,"这里的单机阈值，就是最大令牌数量：maxCount")]),n("li",null,[n("p",null,"这里的统计窗口时长，就是统计时长：duration")])],-1)),l[163]||(l[163]=n("p",null,"含义是每隔duration时间长度内，最多生产maxCount个令牌，上图配置的含义是每1秒钟生产2个令牌。",-1)),l[164]||(l[164]=n("p",null,"核心API：",-1)),l[165]||(l[165]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context, ResourceWrapper resourceWrapper, DefaultNode node,")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                  int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized, Object... args) throws Throwable {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果没有设置热点规则，直接放行")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ParamFlowRuleManager."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hasRules"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        fireEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, node, count, prioritized, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 热点规则判断")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    checkFlow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper, count, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 进入下一个 slot")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    fireEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, node, count, prioritized, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[166]||(l[166]=n("h4",{id:"_2-8-1-令牌桶",tabindex:"-1"},[r("2.8.1 令牌桶 "),n("a",{class:"header-anchor",href:"#_2-8-1-令牌桶","aria-label":'Permalink to "2.8.1 令牌桶"'},"​")],-1)),l[167]||(l[167]=n("p",null,"热点规则判断采用了令牌桶算法来实现参数限流，为每一个不同参数值设置令牌桶，Sentinel的令牌桶有两部分组成：",-1)),l[168]||(l[168]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925163744108.png",alt:"image-20210925163744108",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[169]||(l[169]=n("p",null,"这两个Map的key都是请求的参数值，value却不同，其中：",-1)),l[170]||(l[170]=n("ul",null,[n("li",null,"tokenCounters：用来记录剩余令牌数量"),n("li",null,"timeCounters：用来记录上一个请求的时间")],-1)),l[171]||(l[171]=n("p",null,"当一个携带参数的请求到来后，基本判断流程是这样的：",-1)),l[172]||(l[172]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/sentinel.jpg",alt:"sentinel",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[173]||(l[173]=n("h3",{id:"_2-9-flowslot",tabindex:"-1"},[r("2.9 FlowSlot "),n("a",{class:"header-anchor",href:"#_2-9-flowslot","aria-label":'Permalink to "2.9 FlowSlot"'},"​")],-1)),l[174]||(l[174]=n("p",null,"FlowSlot是负责限流规则的判断，如图：",-1)),l[175]||(l[175]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925172542274.png",alt:"image-20210925172542274",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[176]||(l[176]=n("p",null,"包括：",-1)),l[177]||(l[177]=n("ul",null,[n("li",null,"三种流控模式：直接模式、关联模式、链路模式"),n("li",null,"三种流控效果：快速失败、warm up、排队等待")],-1)),l[178]||(l[178]=n("p",null,[r("三种流控模式，从底层"),n("strong",null,"数据统计"),r("角度，分为两类：")],-1)),l[179]||(l[179]=n("ul",null,[n("li",null,"对进入资源的所有请求（ClusterNode）做限流统计：直接模式、关联模式"),n("li",null,"对进入资源的部分链路（DefaultNode）做限流统计：链路模式")],-1)),l[180]||(l[180]=n("p",null,[r("三种流控效果，从"),n("strong",null,"限流算法"),r("来看，分为两类：")],-1)),l[181]||(l[181]=n("ul",null,[n("li",null,"滑动时间窗口算法：快速失败、warm up"),n("li",null,"漏桶算法：排队等待效果")],-1)),l[182]||(l[182]=n("h4",{id:"_2-9-1-核心流程",tabindex:"-1"},[r("2.9.1 核心流程 "),n("a",{class:"header-anchor",href:"#_2-9-1-核心流程","aria-label":'Permalink to "2.9.1 核心流程"'},"​")],-1)),l[183]||(l[183]=n("p",null,"核心API如下：",-1)),l[184]||(l[184]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context, ResourceWrapper resourceWrapper, DefaultNode node, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count,")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                  boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized, Object... args) throws Throwable {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 限流规则检测")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    checkFlow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resourceWrapper, context, node, count, prioritized);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 放行")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    fireEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, node, count, prioritized, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[185]||(l[185]=n("p",null,"checkFlow方法：",-1)),l[186]||(l[186]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," checkFlow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ResourceWrapper resource, Context context, DefaultNode node, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized)")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws BlockException {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // checker是 FlowRuleChecker 类的一个对象")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    checker."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkFlow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ruleProvider, resource, context, node, count, prioritized);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[187]||(l[187]=n("p",null,"跟入FlowRuleChecker：",-1)),l[188]||(l[188]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," checkFlow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Function"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"String, Collection"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"FlowRule"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">>"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ruleProvider, ")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                      ResourceWrapper resource,Context context, DefaultNode node,")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                      int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized) throws BlockException {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ruleProvider "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resource "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取当前资源的所有限流规则")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Collection<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"FlowRule"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> rules "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ruleProvider."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"apply"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(resource."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (rules "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (FlowRule rule "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rules) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 遍历，逐个规则做校验")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"canPassCheck"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rule, context, node, count, prioritized)) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," FlowException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rule."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLimitApp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), rule);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[189]||(l[189]=n("p",null,"这里的FlowRule就是限流规则接口，其中的几个成员变量，刚好对应表单参数：",-1)),l[190]||(l[190]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," FlowRule"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," extends"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AbstractRule"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 阈值类型 (0: 线程, 1: QPS).")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," grade "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RuleConstant.FLOW_GRADE_QPS;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 阈值.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," double"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 三种限流模式.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * {@link RuleConstant#STRATEGY_DIRECT} 直连模式;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * {@link RuleConstant#STRATEGY_RELATE} 关联模式;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * {@link RuleConstant#STRATEGY_CHAIN} 链路模式.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," strategy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RuleConstant.STRATEGY_DIRECT;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 关联模式关联的资源名称.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String refResource;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 3种流控效果.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 0. 快速失败, 1. warm up, 2. 排队等待, 3. warm up + 排队等待")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," controlBehavior "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RuleConstant.CONTROL_BEHAVIOR_DEFAULT;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 预热时长")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," warmUpPeriodSec "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 队列最大等待时间.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," maxQueueingTimeMs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 500"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 。。。 略")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[191]||(l[191]=n("p",null,[r("校验的逻辑定义在"),n("code",null,"FlowRuleChecker"),r("的"),n("code",null,"canPassCheck"),r("方法中：")],-1)),l[192]||(l[192]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," canPassCheck"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/*@NonNull*/"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," FlowRule rule, Context context, DefaultNode node, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," acquireCount,")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                            boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取限流资源名称")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String limitApp "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rule."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLimitApp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (limitApp "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 校验规则")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," passLocalCheck"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rule, context, node, acquireCount, prioritized);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[193]||(l[193]=n("p",null,[r("进入"),n("code",null,"passLocalCheck()"),r("：")],-1)),l[194]||(l[194]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," passLocalCheck"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(FlowRule rule, Context context, DefaultNode node,")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                                      int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," acquireCount,  "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 基于限流模式判断要统计的节点， ")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果是直连模式，关联模式，对ClusterNode统计，如果是链路模式，则对DefaultNode统计")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Node selectedNode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," selectNodeByRequesterAndStrategy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rule, context, node);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (selectedNode "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 判断规则")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rule."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRater"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"canPass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(selectedNode, acquireCount, prioritized);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[195]||(l[195]=n("p",null,[r("这里对规则的判断先要通过"),n("code",null,"FlowRule#getRater()"),r("获取流量控制器"),n("code",null,"TrafficShapingController"),r("，然后再做限流。")],-1)),l[196]||(l[196]=n("p",null,[r("而"),n("code",null,"TrafficShapingController"),r("有3种实现：")],-1)),l[197]||(l[197]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925175221211.png",alt:"image-20210925175221211",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[198]||(l[198]=n("ul",null,[n("li",null,"DefaultController：快速失败，默认的方式，基于滑动时间窗口算法"),n("li",null,"WarmUpController：预热模式，基于滑动时间窗口算法，只不过阈值是动态的"),n("li",null,"RateLimiterController：排队等待模式，基于漏桶算法")],-1)),l[199]||(l[199]=n("p",null,"最终的限流判断都在TrafficShapingController的canPass方法中。",-1)),l[200]||(l[200]=n("h4",{id:"_2-9-2-滑动时间窗口",tabindex:"-1"},[r("2.9.2 滑动时间窗口 "),n("a",{class:"header-anchor",href:"#_2-9-2-滑动时间窗口","aria-label":'Permalink to "2.9.2 滑动时间窗口"'},"​")],-1)),l[201]||(l[201]=n("p",null,"滑动时间窗口的功能分两部分来看：",-1)),l[202]||(l[202]=n("ul",null,[n("li",null,"一是时间区间窗口的QPS计数功能，这个是在StatisticSlot中调用的"),n("li",null,"二是对滑动窗口内的时间区间窗口QPS累加，这个是在FlowRule中调用的")],-1)),l[203]||(l[203]=n("p",null,"先来看时间区间窗口的QPS计数功能。",-1)),l[204]||(l[204]=n("h5",{id:"_2-9-2-1-时间窗口请求量统计",tabindex:"-1"},[r("2.9.2.1 时间窗口请求量统计 "),n("a",{class:"header-anchor",href:"#_2-9-2-1-时间窗口请求量统计","aria-label":'Permalink to "2.9.2.1 时间窗口请求量统计"'},"​")],-1)),l[205]||(l[205]=n("p",null,"回顾2.5章节中的StatisticSlot部分，有这样一段代码：",-1)),l[206]||(l[206]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925180522926.png",alt:"image-20210925180522926",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[207]||(l[207]=n("p",null,"就是在统计通过该节点的QPS，我们跟入看看，这里进入了DefaultNode内部：",-1)),l[208]||(l[208]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925180619492.png",alt:"image-20210925180619492",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[209]||(l[209]=n("p",null,[r("发现同时对"),n("code",null,"DefaultNode"),r("和"),n("code",null,"ClusterNode"),r("在做QPS统计，我们知道"),n("code",null,"DefaultNode"),r("和"),n("code",null,"ClusterNode"),r("都是"),n("code",null,"StatisticNode"),r("的子类，这里调用"),n("code",null,"addPassRequest()"),r("方法，最终都会进入"),n("code",null,"StatisticNode"),r("中。")],-1)),l[210]||(l[210]=n("p",null,"随便跟入一个：",-1)),l[211]||(l[211]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925180810181.png",alt:"image-20210925180810181",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[212]||(l[212]=n("p",null,"这里有秒、分两种纬度的统计，对应两个计数器。找到对应的成员变量，可以看到：",-1)),l[213]||(l[213]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925180954856.png",alt:"image-20210925180954856",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[214]||(l[214]=n("p",null,"两个计数器都是ArrayMetric类型，并且传入了两个参数：",-1)),l[215]||(l[215]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// intervalInMs：是滑动窗口的时间间隔，默认为 1 秒")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// sampleCount: 时间窗口的分隔数量，默认为 2，就是把 1秒分为 2个小时间窗")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ArrayMetric"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sampleCount, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," intervalInMs) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".data "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," OccupiableBucketLeapArray"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(sampleCount, intervalInMs);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[216]||(l[216]=n("p",null,"如图：",-1)),l[217]||(l[217]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925181359203.png",alt:"image-20210925181359203",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[218]||(l[218]=n("p",null,[r("接下来，我们进入"),n("code",null,"ArrayMetric"),r("类的"),n("code",null,"addPass"),r("方法：")],-1)),l[219]||(l[219]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addPass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取当前时间所在的时间窗")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    WindowWrap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"MetricBucket"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> wrap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," data."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentWindow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 计数器 +1")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    wrap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"value"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addPass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[220]||(l[220]=n("p",null,"那么，计数器如何知道当前所在的窗口是哪个呢？",-1)),l[221]||(l[221]=n("p",null,"这里的data是一个LeapArray：",-1)),l[222]||(l[222]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925181714605.png",alt:"image-20210925181714605",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[223]||(l[223]=n("p",null,"LeapArray的四个属性：",-1)),l[224]||(l[224]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," abstract"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," LeapArray"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"T"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 小窗口的时间长度，默认是500ms ，值 = intervalInMs / sampleCount")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    protected"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," windowLengthInMs;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 滑动窗口内的 小窗口 数量，默认为 2")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    protected"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sampleCount;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 滑动窗口的时间间隔，默认为 1000ms")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    protected"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," intervalInMs;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 滑动窗口的时间间隔，单位为秒，默认为 1")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," double"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," intervalInSecond;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[225]||(l[225]=n("p",null,"LeapArray是一个环形数组，因为时间是无限的，数组长度不可能无限，因此数组中每一个格子放入一个时间窗（window），当数组放满后，角标归0，覆盖最初的window。",-1)),l[226]||(l[226]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925182127206.png",alt:"image-20210925182127206",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[227]||(l[227]=n("p",null,"因为滑动窗口最多分成sampleCount数量的小窗口，因此数组长度只要大于sampleCount，那么最近的一个滑动窗口内的2个小窗口就永远不会被覆盖，就不用担心旧数据被覆盖的问题了。",-1)),l[228]||(l[228]=n("p",null,[r("我们跟入"),n("code",null," data.currentWindow();"),r("方法：")],-1)),l[229]||(l[229]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WindowWrap"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"T"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," currentWindow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," timeMillis) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (timeMillis "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 计算当前时间对应的数组角标")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," idx "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," calculateTimeIdx"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(timeMillis);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 计算当前时间所在窗口的开始时间.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," windowStart "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," calculateWindowStart"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(timeMillis);")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /*")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         * 先根据角标获取数组中保存的 oldWindow 对象，可能是旧数据，需要判断.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         *")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         * (1) oldWindow 不存在, 说明是第一次，创建新 window并存入，然后返回即可")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         * (2) oldWindow的 starTime = 本次请求的 windowStar, 说明正是要找的窗口，直接返回.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         * (3) oldWindow的 starTime < 本次请求的 windowStar, 说明是旧数据，需要被覆盖，创建 ")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         *     新窗口，覆盖旧窗口")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         */")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        WindowWrap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"T"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> old "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," array."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(idx);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (old "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 创建新 window")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            WindowWrap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"T"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> window "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WindowWrap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"T"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">(windowLengthInMs, windowStart, "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newEmptyBucket"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(timeMillis));")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 基于CAS写入数组，避免线程安全问题")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (array."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(idx, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", window)) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 写入成功，返回新的 window")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," window;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 写入失败，说明有并发更新，等待其它人更新完成即可")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"yield"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (windowStart "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," old."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"windowStart"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," old;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (windowStart "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," old."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"windowStart"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (updateLock."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tryLock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 获取并发锁，覆盖旧窗口并返回")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," resetWindowTo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(old, windowStart);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    updateLock."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlock"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 获取锁失败，等待其它线程处理就可以了")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"yield"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (windowStart "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," old."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"windowStart"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 这种情况不应该存在，写这里只是以防万一。")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WindowWrap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"T"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">(windowLengthInMs, windowStart, "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newEmptyBucket"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(timeMillis));")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[230]||(l[230]=n("p",null,"找到当前时间所在窗口（WindowWrap）后，只要调用WindowWrap对象中的add方法，计数器+1即可。",-1)),l[231]||(l[231]=n("p",null,"这里只负责统计每个窗口的请求量，不负责拦截。限流拦截要看FlowSlot中的逻辑。",-1)),l[232]||(l[232]=n("h5",{id:"_2-9-2-2-滑动窗口qps计算",tabindex:"-1"},[r("2.9.2.2 滑动窗口QPS计算 "),n("a",{class:"header-anchor",href:"#_2-9-2-2-滑动窗口qps计算","aria-label":'Permalink to "2.9.2.2 滑动窗口QPS计算"'},"​")],-1)),l[233]||(l[233]=n("p",null,[r("在2.9.1小节我们讲过，FlowSlot的限流判断最终都由"),n("code",null,"TrafficShapingController"),r("接口中的"),n("code",null,"canPass"),r("方法来实现。该接口有三个实现类：")],-1)),l[234]||(l[234]=n("ul",null,[n("li",null,"DefaultController：快速失败，默认的方式，基于滑动时间窗口算法"),n("li",null,"WarmUpController：预热模式，基于滑动时间窗口算法，只不过阈值是动态的"),n("li",null,"RateLimiterController：排队等待模式，基于漏桶算法")],-1)),l[235]||(l[235]=n("p",null,"因此，我们跟入默认的DefaultController中的canPass方法来分析：",-1)),l[236]||(l[236]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," canPass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Node node, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," acquireCount, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 计算目前为止滑动窗口内已经存在的请求量")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," curCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," avgUsedTokens"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(node);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断：已使用请求量 + 需要的请求量（1） 是否大于 窗口的请求阈值")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (curCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," acquireCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 大于，说明超出阈值，返回false")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (prioritized "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," grade "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RuleConstant.FLOW_GRADE_QPS) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," currentTime;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," waitInMs;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            currentTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TimeUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            waitInMs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," node."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tryOccupyNext"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(currentTime, acquireCount, count);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (waitInMs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," OccupyTimeoutProperty."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOccupyTimeout"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                node."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addWaitingRequest"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(currentTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," waitInMs, acquireCount);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                node."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addOccupiedPass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(acquireCount);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                sleep"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(waitInMs);")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // PriorityWaitException indicates that the request will pass after waiting for {@link @waitInMs}.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," PriorityWaitException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(waitInMs);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 小于等于，说明在阈值范围内，返回true")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[237]||(l[237]=n("p",null,[r("因此，判断的关键就是"),n("code",null,"int curCount = avgUsedTokens(node);")],-1)),l[238]||(l[238]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," int"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," avgUsedTokens"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Node node) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (node "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DEFAULT_AVG_USED_TOKENS;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," grade "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RuleConstant.FLOW_GRADE_THREAD "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," node."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"curThreadNum"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")(node."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"passQps"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[239]||(l[239]=n("p",null,[r("因为我们采用的是限流，走"),n("code",null,"node.passQps()"),r("逻辑：")],-1)),l[240]||(l[240]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 这里又进入了 StatisticNode类")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," double"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," passQps"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 请求量 ÷ 滑动窗口时间间隔 ，得到的就是QPS")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rollingCounterInSecond."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"pass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rollingCounterInSecond."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWindowIntervalInSec"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[241]||(l[241]=n("p",null,[r("那么"),n("code",null,"rollingCounterInSecond.pass()"),r("是如何得到请求量的呢？")],-1)),l[242]||(l[242]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// rollingCounterInSecond 本质是ArrayMetric，之前说过")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," long"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," pass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取当前窗口")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    data."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentWindow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pass "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取 当前时间的 滑动窗口范围内 的所有小窗口")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"MetricBucket"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> list "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," data."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"values"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 遍历")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (MetricBucket window "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 累加求和")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        pass "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," window."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"pass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 返回")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pass;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[243]||(l[243]=n("p",null,[r("来看看"),n("code",null,"data.values()"),r("如何获取 滑动窗口范围内 的所有小窗口：")],-1)),l[244]||(l[244]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 此处进入LeapArray类中：")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"T"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," values"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," timeMillis) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (timeMillis "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"T"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建空集合，大小等于 LeapArray长度")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," size "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," array."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"length"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"T"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"T"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">(size);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 遍历 LeapArray")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," size; i"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取每一个小窗口")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        WindowWrap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"T"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> windowWrap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," array."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(i);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 判断这个小窗口是否在 滑动窗口时间范围内（1秒内）")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (windowWrap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," isWindowDeprecated"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(timeMillis, windowWrap)) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 不在范围内，则跳过")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            continue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 在范围内，则添加到集合中")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(windowWrap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"value"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 返回集合")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[245]||(l[245]=n("p",null,[r("那么，"),n("code",null,"isWindowDeprecated(timeMillis, windowWrap)"),r("又是如何判断窗口是否符合要求呢？")],-1)),l[246]||(l[246]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," isWindowDeprecated"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," time, WindowWrap"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"T"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," windowWrap) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 当前时间 - 窗口开始时间  是否大于 滑动窗口的最大间隔（1秒）")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 也就是说，我们要统计的时 距离当前时间1秒内的 小窗口的 count之和")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," time "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," windowWrap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"windowStart"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," intervalInMs;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[247]||(l[247]=n("h4",{id:"_2-9-3-漏桶",tabindex:"-1"},[r("2.9.3 漏桶 "),n("a",{class:"header-anchor",href:"#_2-9-3-漏桶","aria-label":'Permalink to "2.9.3 漏桶"'},"​")],-1)),l[248]||(l[248]=n("p",null,[r("上一节我们讲过，FlowSlot的限流判断最终都由"),n("code",null,"TrafficShapingController"),r("接口中的"),n("code",null,"canPass"),r("方法来实现。该接口有三个实现类：")],-1)),l[249]||(l[249]=n("ul",null,[n("li",null,"DefaultController：快速失败，默认的方式，基于滑动时间窗口算法"),n("li",null,"WarmUpController：预热模式，基于滑动时间窗口算法，只不过阈值是动态的"),n("li",null,"RateLimiterController：排队等待模式，基于漏桶算法")],-1)),l[250]||(l[250]=n("p",null,"因此，我们跟入默认的RateLimiterController中的canPass方法来分析：",-1)),l[251]||(l[251]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," canPass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Node node, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," acquireCount, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // Pass when acquire count is less or equal than 0.")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (acquireCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 阈值小于等于 0 ，阻止请求")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 获取当前时间")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," currentTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TimeUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 计算两次请求之间允许的最小时间间隔")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," costTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Math."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"round"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1.0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (acquireCount) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1000"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"}),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 计算本次请求 允许执行的时间点 = 最近一次请求的可执行时间 + 两次请求的最小间隔")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," expectedTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," costTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," latestPassedTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 如果允许执行的时间点小于当前时间，说明可以立即执行")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (expectedTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," currentTime) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 更新上一次的请求的执行时间")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        latestPassedTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(currentTime);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 不能立即执行，需要计算 预期等待时长")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 预期等待时长 = 两次请求的最小间隔 +最近一次请求的可执行时间 - 当前时间")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," waitTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," costTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," latestPassedTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TimeUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果预期等待时间超出阈值，则拒绝请求")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (waitTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," maxQueueingTimeMs) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 预期等待时间小于阈值，更新最近一次请求的可执行时间，加上costTime")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," oldTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," latestPassedTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addAndGet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(costTime);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 保险起见，再判断一次预期等待时间，是否超过阈值")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                waitTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," oldTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TimeUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (waitTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," maxQueueingTimeMs) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 如果超过，则把刚才 加 的时间再 减回来")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    latestPassedTime."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addAndGet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"costTime);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 拒绝")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // in race condition waitTime may <= 0")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (waitTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 预期等待时间在阈值范围内，休眠要等待的时间，醒来后继续执行")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(waitTime);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (InterruptedException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[252]||(l[252]=n("p",null,"与我们之前分析的漏桶算法基本一致：",-1)),l[253]||(l[253]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925210716675.png",alt:"image-20210925210716675",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[254]||(l[254]=n("h3",{id:"_2-10-degradeslot",tabindex:"-1"},[r("2.10 DegradeSlot "),n("a",{class:"header-anchor",href:"#_2-10-degradeslot","aria-label":'Permalink to "2.10 DegradeSlot"'},"​")],-1)),l[255]||(l[255]=n("p",null,"最后一关，就是降级规则判断了。",-1)),l[256]||(l[256]=n("p",null,"Sentinel的降级是基于状态机来实现的：",-1)),l[257]||(l[257]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925211020881.png",alt:"image-20210925211020881",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[258]||(l[258]=n("p",null,"对应的实现在DegradeSlot类中，核心API：",-1)),l[259]||(l[259]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context, ResourceWrapper resourceWrapper, DefaultNode node, ")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                  int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," prioritized, Object... args) throws Throwable {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 熔断降级规则判断")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    performChecking"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 继续下一个slot")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    fireEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context, resourceWrapper, node, count, prioritized, args);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[260]||(l[260]=n("p",null,[r("继续进入"),n("code",null,"performChecking"),r("方法：")],-1)),l[261]||(l[261]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," performChecking"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context, ResourceWrapper r) throws BlockException {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取当前资源上的所有的断路器 CircuitBreaker")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CircuitBreaker"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> circuitBreakers "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DegradeRuleManager."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCircuitBreakers"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(r."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (circuitBreakers "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," circuitBreakers."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (CircuitBreaker cb "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," circuitBreakers) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 遍历断路器，逐个判断")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cb."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tryPass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context)) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DegradeException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cb."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRule"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLimitApp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), cb."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRule"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[262]||(l[262]=n("h4",{id:"_2-10-1-circuitbreaker",tabindex:"-1"},[r("2.10.1 CircuitBreaker "),n("a",{class:"header-anchor",href:"#_2-10-1-circuitbreaker","aria-label":'Permalink to "2.10.1 CircuitBreaker"'},"​")],-1)),l[263]||(l[263]=n("p",null,"我们进入CircuitBreaker的tryPass方法中：",-1)),l[264]||(l[264]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tryPass"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断状态机状态")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (currentState."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," State.CLOSED) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果是closed状态，直接放行")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (currentState."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," State.OPEN) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果是OPEN状态，断路器打开")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 继续判断OPEN时间窗是否结束，如果是则把状态从OPEN切换到 HALF_OPEN，返回true")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," retryTimeoutArrived"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," fromOpenToHalfOpen"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(context);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // OPEN状态，并且时间窗未到，返回false")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[265]||(l[265]=n("p",null,[r("有关时间窗的判断在"),n("code",null,"retryTimeoutArrived()"),r("方法：")],-1)),l[266]||(l[266]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"protected"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," retryTimeoutArrived"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 当前时间 大于 下一次 HalfOpen的重试时间")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TimeUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," nextRetryTimestamp;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[267]||(l[267]=n("p",null,[r("OPEN到HALF_OPEN切换在"),n("code",null,"fromOpenToHalfOpen(context)"),r("方法：")],-1)),l[268]||(l[268]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"protected"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," boolean"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," fromOpenToHalfOpen"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 基于CAS修改状态，从 OPEN到 HALF_OPEN")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (currentState."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(State.OPEN, State.HALF_OPEN)) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 状态变更的事件通知")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        notifyObservers"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(State.OPEN, State.HALF_OPEN, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 得到当前资源")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Entry entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCurEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 给资源设置监听器，在资源Entry销毁时（资源业务执行完毕时）触发")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"whenTerminate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BiConsumer<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Context"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">() {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," accept"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"context"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Entry "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"entry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 判断 资源业务是否异常")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBlockError"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 如果异常，则再次进入OPEN状态")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    currentState."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(State.HALF_OPEN, State.OPEN);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                    notifyObservers"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(State.HALF_OPEN, State.OPEN, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1.0d"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[269]||(l[269]=n("p",null,"这里出现了从OPEN到HALF_OPEN、从HALF_OPEN到OPEN的变化，但是还有几个没有：",-1)),l[270]||(l[270]=n("ul",null,[n("li",null,"从CLOSED到OPEN"),n("li",null,"从HALF_OPEN到CLOSED")],-1)),l[271]||(l[271]=n("h4",{id:"_2-10-2-触发断路器",tabindex:"-1"},[r("2.10.2.触发断路器 "),n("a",{class:"header-anchor",href:"#_2-10-2-触发断路器","aria-label":'Permalink to "2.10.2.触发断路器"'},"​")],-1)),l[272]||(l[272]=n("p",null,"请求经过所有插槽 后，一定会执行exit方法，而在DegradeSlot的exit方法中：",-1)),l[273]||(l[273]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925213440686.png",alt:"image-20210925213440686",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[274]||(l[274]=n("p",null,"会调用CircuitBreaker的onRequestComplete方法。而CircuitBreaker有两个实现：",-1)),l[275]||(l[275]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210925213939035.png",alt:"image-20210925213939035",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[276]||(l[276]=n("p",null,[r("我们这里以异常比例熔断为例来看，进入"),n("code",null,"ExceptionCircuitBreaker"),r("的"),n("code",null,"onRequestComplete"),r("方法：")],-1)),l[277]||(l[277]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," onRequestComplete"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Context context) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取资源 Entry")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Entry entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCurEntry"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 尝试获取 资源中的 异常")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Throwable error "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getError"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取计数器，同样采用了滑动窗口来计数")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SimpleErrorCounter counter "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentWindow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"value"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (error "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果出现异常，则 error计数器 +1")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        counter."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getErrorCount"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 不管是否出现异常，total计数器 +1")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    counter."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTotalCount"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 判断异常比例是否超出阈值")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    handleStateChangeWhenThresholdExceeded"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(error);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[278]||(l[278]=n("p",null,"来看阈值判断的方法：",-1)),l[279]||(l[279]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleStateChangeWhenThresholdExceeded"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Throwable error) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果当前已经是OPEN状态，不做处理")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (currentState."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," State.OPEN) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 如果已经是 HALF_OPEN 状态，判断是否需求切换状态")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (currentState."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," State.HALF_OPEN) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (error "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 没有异常，则从 HALF_OPEN 到 CLOSED")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            fromHalfOpenToClose"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 有一次，再次进入OPEN")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            fromHalfOpenToOpen"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1.0d"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 说明当前是CLOSE状态，需要判断是否触发阈值")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SimpleErrorCounter"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> counters "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"values"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," errCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," totalCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 累加计算 异常请求数量、总请求数量")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (SimpleErrorCounter counter "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," counters) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        errCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," counter.errorCount."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sum"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        totalCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," counter.totalCount."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sum"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果总请求数量未达到阈值，什么都不做")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (totalCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," minRequestAmount) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    double"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," curCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," errCount;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (strategy "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DEGRADE_GRADE_EXCEPTION_RATIO) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 计算请求的异常比例")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        curCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," errCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1.0d"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," totalCount;")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果比例超过阈值，切换到 OPEN")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (curCount "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," threshold) {")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        transformToOpen"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(curCount);")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1))]),"main-header":t(()=>[k(s.$slots,"main-header")]),"main-header-after":t(()=>[k(s.$slots,"main-header-after")]),"main-nav":t(()=>[k(s.$slots,"main-nav")]),"main-content-before":t(()=>[k(s.$slots,"main-content-before")]),"main-content":t(()=>[k(s.$slots,"main-content")]),"main-content-after":t(()=>[k(s.$slots,"main-content-after")]),"main-nav-before":t(()=>[k(s.$slots,"main-nav-before")]),"main-nav-after":t(()=>[k(s.$slots,"main-nav-after")]),comment:t(()=>[k(s.$slots,"comment")]),footer:t(()=>[k(s.$slots,"footer")]),aside:t(()=>[k(s.$slots,"aside")]),"aside-custom":t(()=>[k(s.$slots,"aside-custom")]),default:t(()=>[k(s.$slots,"default")]),_:3},8,["frontmatter"])}}};export{y as default,g as usePageData};
