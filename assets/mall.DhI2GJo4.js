import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang.X1w6bGlf.js";import"./chunks/@vueuse/motion.Bi21X01W.js";import{d as s,a as l,u as a}from"./chunks/vue-router.CjTZ8HDQ.js";import{X as h,b_ as k,be as n,_ as t,Y as e,a5 as r,bB as E,b3 as p,b5 as g}from"./framework.qkCuDjfX.js";import"./app.DHTWllri.js";import"./chunks/dayjs.C7ooQVqs.js";import"./chunks/vue-i18n.DjzvFo6n.js";import"./chunks/pinia.g94V4AzZ.js";import"./chunks/nprogress.D1cScqWe.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.BqN9mRWQ.js";import"./index.TQnGKZgq.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.B96Jt3V3.js";import"./post.DrlDwT-H.js";const d=s("/posts/mall",async i=>JSON.parse('{"title":"mall项目总结","description":"基于微服务架构的商品贸易平台","frontmatter":{"title":"mall项目总结","description":"基于微服务架构的商品贸易平台","author":"imklaus","tags":["Spring Boot","Spring Cloud","Spring Cloud Alibaba","MySQL","MyBatis-Plus","Redis","RabbitMQ"],"categories":["Java","项目"],"date":"2023-04-12 00:45:36","outline":"deep","excerpt_type":"html","end":true},"headers":[],"relativePath":"pages/posts/mall.md","lastUpdated":null}'),{lazy:(i,s)=>i.name===s.name}),y={__name:"mall",setup(s,{expose:y}){const{data:c}=d(),o=a(),u=l(),F=Object.assign(u.meta.frontmatter||{},c.value?.frontmatter||{});o.currentRoute.value.data=c.value,g("valaxy:frontmatter",F),globalThis.$frontmatter=F;return y({frontmatter:{title:"mall项目总结",description:"基于微服务架构的商品贸易平台",author:"imklaus",tags:["Spring Boot","Spring Cloud","Spring Cloud Alibaba","MySQL","MyBatis-Plus","Redis","RabbitMQ"],categories:["Java","项目"],date:"2023-04-12 00:45:36",outline:"deep",excerpt_type:"html",end:!0}}),(s,l)=>{const a=i;return p(),h(a,{frontmatter:E(F)},{"main-content-md":k(()=>[l[0]||(l[0]=t("p",null,[r("参考视频："),t("a",{href:"https://www.bilibili.com/video/BV1np4y1C7Yf/",target:"_blank",rel:"noreferrer"},"雷神谷粒商城项目")],-1)),l[1]||(l[1]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230315150052611.png",alt:"mall",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[2]||(l[2]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230315145952769.png",alt:"mall",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[3]||(l[3]=t("h2",{id:"项目名称",tabindex:"-1"},[r("项目名称 "),t("a",{class:"header-anchor",href:"#项目名称","aria-label":'Permalink to "项目名称"'},"​")],-1)),l[4]||(l[4]=t("ul",null,[t("li",null,"书阁”图书商城管理系统、微盟电子商城网络交易系统、高校闲置资源交易系统"),t("li",null,"购物在“e”零售商城平台、惠农通—智慧农资商城 、农产品轻量级微商城系统"),t("li",null,"精美鞋业贸易系统")],-1)),l[5]||(l[5]=t("h2",{id:"项目简介",tabindex:"-1"},[r("项目简介 "),t("a",{class:"header-anchor",href:"#项目简介","aria-label":'Permalink to "项目简介"'},"​")],-1)),l[6]||(l[6]=t("ul",null,[t("li",null,"本系统采用微服务架构设计，在分布式环境下利用Spring Cloud框架，通过业务划分，设计独立模块的微服务，拆分为订单服务、购物车服务、支付服务、用户管理服务、商品管理服务、文件上传服务等模块，结合了当前比较流行的互联网电商模式，为消费者提供商品贸易平台。")],-1)),e(" more "),l[7]||(l[7]=t("h2",{id:"系统架构",tabindex:"-1"},[r("系统架构 "),t("a",{class:"header-anchor",href:"#系统架构","aria-label":'Permalink to "系统架构"'},"​")],-1)),l[8]||(l[8]=t("ul",null,[t("li",null,"该系用采用SpringCloud架构，利用SpringBoot构建应用，Nacos作为服务的注册、配置中心，OpenFeign实现与其他模块进行交互，Sentinel实现熔断降级和错误处理，Seata分布式事务解决方案，Gateway作为服务网关，Sleuth链路追踪，RabbitMQ实现延迟队列，Redis作为缓存解决读多写少的场景，MySQL进行持久化，MyBatisPlus作为持久化框架。")],-1)),l[9]||(l[9]=t("h2",{id:"我的职责",tabindex:"-1"},[r("我的职责 "),t("a",{class:"header-anchor",href:"#我的职责","aria-label":'Permalink to "我的职责"'},"​")],-1)),l[10]||(l[10]=t("ul",null,[t("li",null,[r("完成平台"),t("strong",null,"商品、购物车、订单、库存、优惠券、支付、文件上传"),r("等服务模块的接口开发；")]),t("li",null,[r("使用"),t("strong",null,"RabbitMQ延时队列"),r("实现未付款订单，超过一定时间后，"),t("strong",null,"系统自动取消订单并解锁库存；")]),t("li",null,[r("使用"),t("strong",null,"redis+lua脚本"),r("防止重复提交攻击，"),t("strong",null,"解决了用户利用浏览器刷新和回退重复提交订单的问题；")]),t("li",null,[r("基于"),t("strong",null,"Redisson分布式限流：Semaphore信号量"),r("实现"),t("strong",null,"秒杀和一人一单功能"),r("，通过逐步"),t("strong",null,"改进分布式锁"),r("的方案，"),t("strong",null,"解决在多线程情况下用户重复提交订单的幂等性问题；")]),t("li",null,[r("基于 "),t("strong",null,"Token"),r(" 的认证授权机制："),t("strong",null,"JWT"),r("，通过对登录用户颁发登录凭证，"),t("strong",null,"实现登录模块认证授权功能；")]),t("li",null,[r("使用"),t("strong",null,"ElasticSearch分布式全文搜索引擎"),r("，对冷数据，商品信息数据"),t("strong",null,"建立索引"),r("，"),t("strong",null,"保证冷数据，商品数据的查询性能；")]),t("li",null,[r("利用"),t("strong",null,"Jmeter工具"),r("进行压测，找到在"),t("strong",null,"多线程"),r("情况下造成的"),t("strong",null,"内存泄漏，并发与同步"),r("等问题，"),t("strong",null,"保证了系统在线上的处理能力和稳定性维持在一个标准范围内；")]),t("li",null,[r("使用"),t("strong",null,"Redis"),r("进行"),t("strong",null,"热点信息缓存"),r("，比如附近购物车信息和登录信息,"),t("strong",null,"提高服务器的性能"),r("；")]),t("li",null,[r("使用"),t("strong",null,"Spring Schedule定时任务"),r("提前上架抢购商品信息到Redis缓存中实现"),t("strong",null,"库存预热功能")]),t("li",null,[r("使用"),t("strong",null,"Redisson分布式锁"),r("解决分布式系统下商品重复上架的"),t("strong",null,"幂等性问题"),r("；")]),t("li",null,[r("使用"),t("strong",null,"Spring Cache方法级别缓存技术"),r("，实现已经被调用过的指定的目标方法，直接从缓存中获取方法调用后的结果返回，"),t("strong",null,"提高系统的响应速度；")]),t("li",null,[r("使用"),t("strong",null,"CompletableFuture 异步编排"),r("解决查询商品详情⻚"),t("strong",null,"响应速度慢的问题"),r("；")]),t("li",null,[r("使用"),t("strong",null,"Nacos作为注册中心与配置中心"),r("，将服务名称及其对应地址进行存储，实现服务地址的"),t("strong",null,"注册与发现"),r("以及"),t("strong",null,"配置动态加载"),r("等功能")]),t("li",null,[r("使用"),t("strong",null,"Seata中的TCC事务模式"),r("，把一个完整的业务逻辑拆分成三个阶段,通过事务管理器进行管理，"),t("strong",null,"保证分布式系统数据一致性问题；")]),t("li",null,[r("整合"),t("strong",null,"第三方文件上传服务"),r("，如阿里云对象存储，基于服务端签名后直传，"),t("strong",null,"保证文件传输的安全性"),r("；")]),t("li",null,[r("整合"),t("strong",null,"OAuth2.0协议授权"),r("，使用AccessToken调用开发API获取用户信息，"),t("strong",null,"支持微信、QQ、微博、Gitee、Github等第三方登陆；")]),t("li",null,[r("使用"),t("strong",null,"RSA算法保证数据加密安全"),r("，成功对接第三方支付功能，订单付款支持"),t("strong",null,"支付宝、微信支付"),r("等第三方支付服务。")])],-1)),l[11]||(l[11]=t("p",null,"1、梳理自己项目的难点或亮点是什么？ 2、项目中，为什么用 xx 技术点，用 yy 的可以吗？或者为什么这么设计？",-1)),l[12]||(l[12]=t("p",null,"关于第一点，这个内容即使面试官没问，我们也可以在自我介绍时候表述出来。",-1)),l[13]||(l[13]=t("p",null,"如果你觉得自己的项目的确没什么厉害的东西，都是业务的 curd。那就挑一个值得说过的优化，或者设计方案也行。",-1)),l[14]||(l[14]=t("p",null,"毕竟高大上的东西的确只有少数人接触到，都是理解的。",-1)),l[15]||(l[15]=t("p",null,"接下来关于第二点，目的是考察你对自己项目的理解是不是真的知其所以然，还是说自己只是一个无情的 curd 机器。",-1)),l[16]||(l[16]=t("p",null,"项目切入点:分布式锁的实现、分布式Session、分布式缓存、缓存一致性、跨域、异步编排等，重点把握秒杀模块和 订单模块的设计及流程",-1)),l[17]||(l[17]=t("h2",{id:"项目概述",tabindex:"-1"},[r("项目概述 "),t("a",{class:"header-anchor",href:"#项目概述","aria-label":'Permalink to "项目概述"'},"​")],-1)),l[18]||(l[18]=t("p",null,"​ 本系统是专门为精美鞋业有限公司制定的对外贸易系统，大部分商品出售给越南地区，供那边的厂商进行二次加工。 ​ 本系统采用微服务架构设计，在分布式环境下利用Spring Cloud框架，通过业务划分，设计独立模块的微服务，拆分为订单服务、购物车服务、支付服务、用户管理服务、商品管理服务、文件上传服务等模块，为客户提供半成品商品贸易平台。",-1)),l[19]||(l[19]=t("h3",{id:"核心业务一-购物车",tabindex:"-1"},[r("核心业务一：购物车 "),t("a",{class:"header-anchor",href:"#核心业务一-购物车","aria-label":'Permalink to "核心业务一：购物车"'},"​")],-1)),l[20]||(l[20]=t("ul",null,[t("li",null,[t("p",null,"购物车Redis数据结构选型："),t("ul",null,[t("li",null,[t("p",null,"双层 Map：Map<String,Map<String,String>>"),t("ul",null,[t("li",null,[t("p",null,"第一层 Map，Key 是用户 id")]),t("li",null,[t("p",null,"第二层 Map，Key 是购物车中商品 id，值是购物项数据")])])])])]),t("li",null,[t("p",null,"购物车两个核心功能：新增商品到购物车、查询购物车"),t("ul",null,[t("li",null,[t("p",null,"新增商品：判断是否登录"),t("ul",null,[t("li",null,"是：则添加商品到后台 Redis 中，把 user 的唯一标识符作为 key。"),t("li",null,"否：则添加商品到后台 Redis 中，使用随机生成的 user-key 作为 key。")])])])]),t("li",null,[t("p",null,"查询购物车列表：判断是否登录"),t("ul",null,[t("li",null,"否：直接根据 user-key 查询 Redis 中数据并展示"),t("li",null,"是：已登录，则需要先根据 user-key 查询 Redis 是否有数据。"),t("li",null,"有：需要提交到后台添加到 Redis ，合并数据，而后查询。"),t("li",null,"否：直接去后台查询 Redis ，而后返回")])])],-1)),l[21]||(l[21]=t("h3",{id:"核心业务二-订单",tabindex:"-1"},[r("核心业务二：订单 "),t("a",{class:"header-anchor",href:"#核心业务二-订单","aria-label":'Permalink to "核心业务二：订单"'},"​")],-1)),l[22]||(l[22]=t("h4",{id:"订单中心",tabindex:"-1"},[r("订单中心 "),t("a",{class:"header-anchor",href:"#订单中心","aria-label":'Permalink to "订单中心"'},"​")],-1)),l[23]||(l[23]=t("ul",null,[t("li",null,"电商系统涉及到 3 流，分别时信息流，资金流，物流，而订单系统作为中枢将三者有机的集 合起来。"),t("li",null,"订单模块是电商系统的枢纽，在订单这个环节上需求获取多个模块的数据和信息，同时对这 些信息进行加工处理后流向下个环节，这一系列就构成了订单的信息流通。")],-1)),l[24]||(l[24]=t("h4",{id:"订单构成",tabindex:"-1"},[r("订单构成 "),t("a",{class:"header-anchor",href:"#订单构成","aria-label":'Permalink to "订单构成"'},"​")],-1)),l[25]||(l[25]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410153419456.png",alt:"mall",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[26]||(l[26]=t("h4",{id:"订单状态",tabindex:"-1"},[r("订单状态 "),t("a",{class:"header-anchor",href:"#订单状态","aria-label":'Permalink to "订单状态"'},"​")],-1)),l[27]||(l[27]=t("ol",null,[t("li",null,[r("待付款 "),t("ul",null,[t("li",null,"用户提交订单后，订单进行预下单，目前主流电商网站都会唤起支付，便于用户快速完成支 付，需要注意的是待付款状态下可以对库存进行锁定，锁定库存需要配置支付超时时间，超 时后将自动取消订单，订单变更关闭状态。")])]),t("li",null,[r("已付款/ 待发货 "),t("ul",null,[t("li",null,"用户完成订单支付，订单系统需要记录支付时间，支付流水单号便于对账，订单下放到 WMS 系统，仓库进行调拨，配货，分拣，出库等操作。")])]),t("li",null,[r("待收货/ 已发货 "),t("ul",null,[t("li",null,"仓储将商品出库后，订单进入物流环节，订单系统需要同步物流信息，便于用户实时知悉物 品物流状态")])]),t("li",null,[r("已完成 "),t("ul",null,[t("li",null,"用户确认收货后，订单交易完成。后续支付侧进行结算，如果订单存在问题进入售后状态")])]),t("li",null,[r("已取消 "),t("ul",null,[t("li",null,"付款之前取消订单。包括超时未付款或用户商户取消订单都会产生这种订单状态。")])])],-1)),l[28]||(l[28]=t("h4",{id:"订单流程",tabindex:"-1"},[r("订单流程 "),t("a",{class:"header-anchor",href:"#订单流程","aria-label":'Permalink to "订单流程"'},"​")],-1)),l[29]||(l[29]=t("ul",null,[t("li",null,"正常的网购步骤：订单生成–>支付订单–>卖家发货–>确认收货–>交易成功")],-1)),l[30]||(l[30]=t("h5",{id:"_1-订单创建与支付",tabindex:"-1"},[r("1.订单创建与支付 "),t("a",{class:"header-anchor",href:"#_1-订单创建与支付","aria-label":'Permalink to "1.订单创建与支付"'},"​")],-1)),l[31]||(l[31]=t("p",null,[t("code",null,"http://order.gulimall.com/toTrade")],-1)),l[32]||(l[32]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403130800413.png",alt:"mall",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[33]||(l[33]=t("p",null,[t("code",null,"http://order.gulimall.com/submitOrder")],-1)),l[34]||(l[34]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.web.OrderWebController#submitOrder")])],-1)),l[35]||(l[35]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     /**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," vo"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," 上一个页面携带的数据")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," model")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," redirectAttributes")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/submitOrder"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submitOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(OrderSubmitVo vo, Model model, RedirectAttributes redirectAttributes){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //捕获异常")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SubmitOrderResponseVo responseVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submitOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //下单：去创建订单，验令牌，验价格，锁库存....")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"订单提交的数据..."'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (responseVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //下单成功来到支付选择页")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            model."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addAttribute"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"submitOrderResponse"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", responseVo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "pay"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //下单失败重定向到订单确认页")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String msg "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "下单失败："'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            switch"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (responseVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                case"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "订单信息过期，请刷新再次提交"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"break"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                case"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "订单商品价格发生了变化，请刷新再次提交"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"break"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                case"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 3"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "库存锁定失败，商品库存不足"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"break"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redirectAttributes."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addFlashAttribute"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"msg"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", msg);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "redirect:http://order.gulimall.com/toTrade"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"instanceof"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NoStockException) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String message "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((NoStockException) e)."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessage"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'            //抛出无库存异常后页面显示此异常信息NO_STOCK_EXCEPTION(21000, "商品库存不足");')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redirectAttributes."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addFlashAttribute"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"msg"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //抛出任何异常后重定向会订单确认页")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "redirect:http://order.gulimall.com/toTrade"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[36]||(l[36]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#submitOrder")])],-1)),l[37]||(l[37]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," /**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 下单")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 加入统一事务")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," vo")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * @Transactional 本地事务，在分布式系统下，只能控制自己的回滚，控制不了其他服务的回滚")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * (isolation = Isolation.REPEATABLE_READ)默认隔离级别")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * ->分布式事务: 最大原因是网络问题+分布式机器")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//@GlobalTransactional 高并发 此注解会加很多全局锁，导致下单只能等别人先下完单才能下，高并发环境不可取")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SubmitOrderResponseVo "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submitOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(OrderSubmitVo vo) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        submitVoThreadLocal."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SubmitOrderResponseVo responseVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SubmitOrderResponseVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //从拦截器里获取用户信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        MemberRespVo memberRespVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LoginUserInterceptor.loginUser."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        responseVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //1、验证令牌【令牌的对比和删除必须保证原子性】")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //0令牌失败 - 1删除成功(校验成功)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String script "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," \"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\""),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String orderToken "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderToken"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //原子验证令牌和删除令牌")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long result "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"execute"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //脚本返回类型->0,1")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DefaultRedisScript<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">(script, Long.class),")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //将缓存中将要比对的key转为集合")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Arrays."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"asList"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(OrderConstant.USER_ORDER_TOKEN_PREFIX "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," memberRespVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()),")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //传入要校验的值")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                orderToken);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (result "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0L"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //验证失败，设置错误状态码为1，key过期等情况")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            responseVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," responseVo;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //验证成功")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //下单：去创建订单，验令牌，验价格，锁库存....")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //1、创建订单，订单项等信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            OrderCreateTo order "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // todo 观察者模式: 发布商品下单事件")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ApplicationContextHolder."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstance"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"publishEvent"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," OrderCreateEvent"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", order));")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //2、验价，拿到应付金额与页面提交的金额进行校验")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            BigDecimal payAmount "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," order."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPayAmount"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            BigDecimal payPrice "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPayPrice"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //两者相减的绝对值小于0.01就算校验通过")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Math."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"abs"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(payAmount."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"subtract"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(payPrice)."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"doubleValue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0.01"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //校验通过")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //TODO 3、保存订单")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                saveOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(order);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //4、库存锁定，这样能避免库存不足等现象发生")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //只要有异常就回滚订单数据(订单号，所有订单项（skuId，skuName，num）)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                WareSkuLockVo lockVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," WareSkuLockVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //设置指定库存的订单号")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                lockVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(order."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderItemVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> locks "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," order."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderItems"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    OrderItemVo orderItemVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," OrderItemVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    //订单已经保存了，可以直接设置")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    orderItemVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    orderItemVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCount"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuQuantity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    orderItemVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setTitle"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuName"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderItemVo;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                })."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //锁定订单项数据")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                lockVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setLocks"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(locks);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //todo 4、远程锁库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //库存锁定成功了，但是网络原因超时了，订单回滚，库存不回滚")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //为了保证高并发，库存服务自己回滚，可以发消息给库存服务")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //库存服务本身也可以使用自动解锁模式->消息队列")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                R r "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wmsFeignService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(lockVo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //判断远程调用是否成功")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (r."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    //远程调用成功，锁成功了")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    responseVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(order."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," //todo 5、远程扣减积分  出异常 引入seata后业务标注@GlobalTransactional订单回滚，库存回滚")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t\t\t// int i = 10/0;//不标注@GlobalTransactional 订单回滚，库存不回滚")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    //todo 订单创建成功发送消息给MQ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    rabbitTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order.create.order"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", order."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," responseVo;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    //远程调用失败，锁定失败")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    //锁定失败")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    String msg "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (String) r."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"msg"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    //抛出异常就不能设置错误状态码了")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    throw"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," NoStockException"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(msg);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//                    responseVo.setCode(3);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//                    return responseVo;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //校验失败")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                responseVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," responseVo;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[38]||(l[38]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#createOrder")])],-1)),l[39]||(l[39]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 创建订单聚合方法，含构建订单和所有订单项")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," OrderCreateTo "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //获取当前登录的用户信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        MemberRespVo memberRespVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LoginUserInterceptor.loginUser."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        OrderCreateTo createTo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," OrderCreateTo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //1、todo 生成订单号(使用雪花算法根据用户id创建订单号)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//        String orderSn = IdWorker.getTimeId();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String orderSn "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SnowflakeIdUtil."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nextIdStrByService"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(memberRespVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //创建订单")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        OrderEntity orderEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," buildOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderSn);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //2、获取到所有的订单项")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderItemEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> itemEntities "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," buildOrderItems"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderSn);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //3、验价，计算价格、积分等相关")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        computePrice"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderEntity, itemEntities);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//        createTo.setOrderItems(itemEntities);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//        createTo.setOrder(orderEntity);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 构建订单聚合根")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        OrderCreateTo order "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," createTo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"builder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"order"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderEntity)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderItems"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(itemEntities)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fare"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getFreightAmount"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"payPrice"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPayAmount"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," order;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[40]||(l[40]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131446123.png",alt:"mall",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[41]||(l[41]=t("ul",null,[t("li",null,[t("p",null,"支付服务，提供支付宝、微信、银行卡等支付方式，支持支付查询以及退款等功能。")]),t("li",null,[t("h6",{id:"配置项修改",tabindex:"-1"},[t("strong",null,"配置项修改"),r(),t("a",{class:"header-anchor",href:"#配置项修改","aria-label":'Permalink to "**配置项修改**"'},"​")])])],-1)),l[42]||(l[42]=t("p",null,[r("详情见 "),t("strong",null,"支付宝沙箱对接"),r(" 中需要修改配置项。")],-1)),l[43]||(l[43]=t("blockquote",null,[t("ul",null,[t("li",null,[t("h6",{id:"核心流程",tabindex:"-1"},[t("strong",null,"核心流程"),r(),t("a",{class:"header-anchor",href:"#核心流程","aria-label":'Permalink to "**核心流程**"'},"​")])])]),t("p",null,[t("strong",null,"核心流程(刚果商城项目参考)：")]),t("p",null,"1）通过策略模式封装支付渠道和支付场景，用户支付时动态选择对应的支付组件。"),t("ul",null,[t("li",null,[r("代码地址："),t("code",null,"org.opengoofy.congomall.biz.pay.application.service.impl.PayServiceImpl#commonPay")])]),t("p",null,"2）通过策略模式封装支付回调场景，三方支付平台回调时动态选择对应的支付回调组件。"),t("ul",null,[t("li",null,[r("代码地址："),t("code",null,"org.opengoofy.congomall.biz.pay.application.service.impl.PayServiceImpl#callback")])])],-1)),l[44]||(l[44]=t("ul",null,[t("li",null,[t("h6",{id:"支付宝沙箱对接",tabindex:"-1"},[r("支付宝沙箱对接 "),t("a",{class:"header-anchor",href:"#支付宝沙箱对接","aria-label":'Permalink to "支付宝沙箱对接"'},"​")])])],-1)),l[45]||(l[45]=t("p",null,"项目中已对接支付宝沙箱环境，以下介绍如何对接支付宝沙箱。",-1)),l[46]||(l[46]=t("ul",null,[t("li",null,[t("ol",null,[t("li",null,[t("strong",null,"注册账号")])])])],-1)),l[47]||(l[47]=t("p",null,"注册支付宝开发者账户，进入开发者控制台。",-1)),l[48]||(l[48]=t("p",null,[t("a",{href:"https://openhome.alipay.com/platform/developerIndex.htm",target:"_blank",rel:"noreferrer"},"https://openhome.alipay.com/platform/developerIndex.htmopen in new window")],-1)),l[49]||(l[49]=t("p",null,"直接进入沙箱环境地址。",-1)),l[50]||(l[50]=t("p",null,[t("a",{href:"https://open.alipay.com/develop/sandbox/app",target:"_blank",rel:"noreferrer"},"https://open.alipay.com/develop/sandbox/appopen in new window")],-1)),l[51]||(l[51]=t("p",null,"沙箱应用页面如下：",-1)),l[52]||(l[52]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1674111619522-82229cf7-482d-4a4e-81bd-637c55c3d6a9.png",alt:"mall",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[53]||(l[53]=t("ul",null,[t("li",null,[t("ol",{start:"2"},[t("li",null,[t("strong",null,"获取支付参数")])])])],-1)),l[54]||(l[54]=t("p",null,[r("拿到 APPID 替换 "),t("code",null,"application.properties"),r(" 文件中 "),t("code",null,"alipay.app-id"),r("。")],-1)),l[55]||(l[55]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1674111838001-9ff075ce-e324-43a6-a6b6-e3d860970e6a.png",alt:"mall",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[56]||(l[56]=t("p",null,"为了图方便，这里直接使用支付宝自定义公钥和私钥。",-1)),l[57]||(l[57]=t("p",null,"我这里是已经开启过的，所以启用按钮是置灰的。第一次使用应该是蓝色可点击的状态。",-1)),l[58]||(l[58]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1674112006561-4be2d9d4-ef90-4c49-aee6-1f6f6a988f2d.png",alt:"mall",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[59]||(l[59]=t("p",null,[r("复制支付宝公钥替换 "),t("code",null,"application.properties"),r(" 文件中 "),t("code",null,"alipay.alipay_public_key"),r("。")],-1)),l[60]||(l[60]=t("p",null,[r("复制应用私钥替换 "),t("code",null,"application.properties"),r(" 文件中 "),t("code",null,"alipay.private_key"),r("。")],-1)),l[61]||(l[61]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1674112099708-2d1a70a2-6af5-4502-8192-f6bb587b302f.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[62]||(l[62]=t("p",null,"至此，就可以调用支付接口进行支付宝支付功能了。",-1)),l[63]||(l[63]=t("ul",null,[t("li",null,[t("ol",{start:"3"},[t("li",null,[t("strong",null,"调用支付宝接口")])])])],-1)),l[64]||(l[64]=t("p",null,"访问支付服务 API，调用支付宝支付接口。",-1)),l[65]||(l[65]=t("p",null,[r("调用支付接口"),t("code",null,"http://order.gulimall.com/payOrder?orderSn=202304031500558581642784227126714369"),r("后，新创建 "),t("code",null,"pay.html"),r(" 空文件，复制控制台日志中前端文件代码到 "),t("code",null,"pay.html"),r("。")],-1)),l[66]||(l[66]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#getOrderPay")])],-1)),l[67]||(l[67]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 获取当前订单的支付信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," orderSn")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," PayVo "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderPay"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String orderSn) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    PayVo payVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," PayVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    OrderEntity entity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderByOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderSn);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //保留2位小数，有小数就想上取值")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    BigDecimal bigDecimal "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTotalAmount"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setScale"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", BigDecimal.ROUND_UP);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    payVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setTotal_amount"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(bigDecimal."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    payVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setOut_trade_no"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderItemEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> itemEntities "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderItemService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueryWrapper<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderItemEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order_sn"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", orderSn));")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    OrderItemEntity item "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemEntities."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    payVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSubject"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuName"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    payVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setBody"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuAttrsVals"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," payVo;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[68]||(l[68]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.web.PayWebController#payOrder")])],-1)),l[69]||(l[69]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," /**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 1、将支付页让浏览器展示")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 2、支付成功以后，我们要跳到用户的订单列表页")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," orderSn")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@throws"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AlipayApiException")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ResponseBody")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/payOrder"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"produces"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "text/html"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"payOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"orderSn"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") String orderSn) throws AlipayApiException {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        PayVo payVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderPay"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderSn);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //返回的是一个页面，将此页面直接交给浏览器就行")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String pay "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," alipayTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"pay"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(payVo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//        System.out.println(pay);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pay;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[70]||(l[70]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.config.AlipayTemplate#pay")])],-1)),l[71]||(l[71]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  String "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"pay"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(PayVo vo) throws AlipayApiException {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'    //AlipayClient alipayClient = new DefaultAlipayClient(AlipayTemplate.gatewayUrl, AlipayTemplate.app_id, AlipayTemplate.merchant_private_key, "json", AlipayTemplate.charset, AlipayTemplate.alipay_public_key, AlipayTemplate.sign_type);')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //1、根据支付宝的配置生成一个支付客户端")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    AlipayClient alipayClient "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DefaultAlipayClient"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(gatewayUrl,")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            app_id, merchant_private_key, "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"json"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            charset, alipay_public_key, sign_type);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //2、创建一个支付请求"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," //设置请求参数")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    AlipayTradePagePayRequest alipayRequest "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," AlipayTradePagePayRequest"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    alipayRequest."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setReturnUrl"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(return_url);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    alipayRequest."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setNotifyUrl"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(notify_url);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //商户订单号，商户网站订单系统中唯一订单号，必填")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String out_trade_no "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOut_trade_no"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //付款金额，必填")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String total_amount "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTotal_amount"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //订单名称，必填")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String subject "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSubject"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //商品描述，可空")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String body "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBody"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    alipayRequest."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setBizContent"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"{'),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"out_trade_no"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," out_trade_no "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},',"')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            +"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"total_amount"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," total_amount "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},',"')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            +"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"subject"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," subject "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},',"')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            +"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"body"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," body "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},',"')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            +"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"timeout_express"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"timeout"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},',"')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            +"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"product_code"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"FAST_INSTANT_TRADE_PAY"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'}"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String result "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," alipayClient."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"pageExecute"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(alipayRequest)."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBody"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //会收到支付宝的响应，响应的是一个页面，只要浏览器显示这个页面，就会自动来到支付宝的收银台页面")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"支付宝的响应："'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"result);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[72]||(l[72]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403152134343.png",alt:"image",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[73]||(l[73]=t("p",null,[r("通过谷歌浏览器打开 "),t("code",null,"pay.html"),r("即可，看到以下页面即为正常现象。")],-1)),l[74]||(l[74]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131612455.png",alt:"image-20230403131612455",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[75]||(l[75]=t("p",null,"账户名和支付密码从沙箱账号处复制买方信息。如果买方账户余额为 0，可随意充值金额。",-1)),l[76]||(l[76]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1674195718913-2cf0d08a-1bc0-4303-aef5-df51a662fadf.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[77]||(l[77]=t("p",null,"使用账户余额支付即可。",-1)),l[78]||(l[78]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131639507.png",alt:"image-20230403131639507",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[79]||(l[79]=t("p",null,"支付结果显示成功。",-1)),l[80]||(l[80]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131649890.png",alt:"image-20230403131649890",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[81]||(l[81]=t("ul",null,[t("li",null,[t("ol",{start:"4"},[t("li",null,[t("strong",null,"支付结果回调")])])])],-1)),l[82]||(l[82]=t("p",null,"如果希望在沙箱环境中得知具体支付结果，我们需要通过 Natapp 开通内网穿透，开通教程详细查看下述官方文档：",-1)),l[83]||(l[83]=t("p",null,[t("a",{href:"https://natapp.cn/article/natapp_newbie",target:"_blank",rel:"noreferrer"},"https://natapp.cn/article/natapp_newbieopen in new window")],-1)),l[84]||(l[84]=t("p",null,"开通后，将内网穿透端口为 80，本地地址改为虚拟机映射本地host的地址(192.168.10.103=>order.gulimall.com)即支付服务项目端口。",-1)),l[85]||(l[85]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403152749004.png",alt:"image-20230403152749004",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[86]||(l[86]=t("p",null,[r("将 Natapp 内网穿透地址替换 "),t("code",null,"application.properties"),r(" 文件下 "),t("code",null,"alipay.notify_url"),r(" 属性。")],-1)),l[87]||(l[87]=t("p",null,"再重复调用下支付宝支付接口流程，即可看到回调效果。",-1)),l[88]||(l[88]=t("ul",null,[t("li",null,"配置以上内网穿透配置才能完成订单支付，否则订单支付失败，订单自动取消，库存自动解锁")],-1)),l[89]||(l[89]=t("div",{class:"language-properties max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"properties"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#异步通知：支付宝会悄悄的给我们发送一个请求，告诉我们支付成功的信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"alipay.notify_url"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=http://mqbb4a.natappfree.cc/paid/notify")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[90]||(l[90]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131656175.png",alt:"image-20230403131656175",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[91]||(l[91]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#handlePayResult")])],-1)),l[92]||(l[92]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 处理支付宝的支付结果")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," vo")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"handlePayResult"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(PayAsyncVo vo) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //1、保存交易流水")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        PaymentInfoEntity infoEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," PaymentInfoEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        infoEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAlipayTradeNo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTrade_no"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        infoEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOut_trade_no"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        infoEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPaymentStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTrade_status"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        infoEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCallbackTime"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNotify_time"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        paymentInfoService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"save"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(infoEntity);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //2、修改订单的状态信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTrade_status"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"TRADE_SUCCESS"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"||"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTrade_status"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"TRADE_FINISHED"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //支付成功状态")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String outTradeNo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOut_trade_no"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"            this"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".baseMapper."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"updateOrderStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(outTradeNo, OrderStatusEnum.PAYED."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "success"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[93]||(l[93]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.listener.OrderPaidListener#handleAlipaid")])],-1)),l[94]||(l[94]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," /**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 支付成功异步通知")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," vo")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," request")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/paid/notify"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"handleAlipaid"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(PayAsyncVo vo, HttpServletRequest request) throws Exception {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //只要我们收到了支付宝给我们异步的通知，告诉我们订单支付成功，返回success，支付宝就再也不通知")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//        Map<String, String[]> map = request.getParameterMap();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//        for (String key : map.keySet()) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//            String value = request.getParameter(key);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'//            System.out.println("参数名："+key+"==>参数值："+ value);')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'//        System.out.println("支付宝通知到位了...数据："+map);')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //验签")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> params "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[]> requestParams "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getParameterMap"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Iterator<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> iter "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," requestParams."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"keySet"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"iterator"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(); iter."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hasNext"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String name "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (String) iter."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"next"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] values "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[]) requestParams."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(name);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String valueStr "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ""'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," values.length; i"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                valueStr "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (i "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," values.length "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," valueStr "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," values[i]")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                        :"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," valueStr "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," values[i] "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ","'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //乱码解决，这段代码在出现乱码时使用")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'//            valueStr = new String(valueStr.getBytes("ISO-8859-1"), "utf-8");')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            params."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(name, valueStr);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," signVerified "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AlipaySignature."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rsaCheckV1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(params, alipayTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAlipay_public_key"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), alipayTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCharset"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), alipayTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSign_type"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()); "),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (signVerified){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //验签成功")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"签名验证成功....."'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String result "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"handlePayResult"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"签名验证失败....."'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "error"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[95]||(l[95]=t("p",null,[r("页面跳转同步通知页面路径 需"),t("code",null,"http://"),r("格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问；订单支付完成成功返回以下页面(同步通知，支付成功，一般跳转到成功页)：")],-1)),l[96]||(l[96]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  String return_url "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "http://member.gulimall.com/memberOrder.html"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[97]||(l[97]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.member.Web.MemberWebController#memberOrderPage")])],-1)),l[98]||(l[98]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/memberOrder.html"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"memberOrderPage"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestParam"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "pageNum"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"defaultValue"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "1"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Integer pageNum,")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                              Model model) {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //查出当前登录的用户的所有订单列表数据")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> page "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    page."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"page"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", pageNum."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    R r "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderFeignService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"listWithItem"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(page);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(JSON."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJSONString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(r));")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    model."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addAttribute"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"orders"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", r);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "orderList"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[99]||(l[99]=t("ul",null,[t("li",null,"远程调用订单服务查出当前登录的用户的所有订单列表数据"),t("li",null,[t("code",null,"com.klaus.gulimall.order.controller.OrderController#listWithItem")])],-1)),l[100]||(l[100]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * todo 远程调用都要全用@POSTMapping+@RequestBody(请求体只支持post)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 分页查询当前登录用户的所有订单")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," params")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/listWithItem"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'//@RequiresPermissions("order:order:list")')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," R "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"listWithItem"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestBody"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Map"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"String, Object"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," params){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    PageUtils page "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryPageWithItem"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(params);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," R."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"page"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", page);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[101]||(l[101]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#queryPageWithItem")])],-1)),l[102]||(l[102]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," PageUtils "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryPageWithItem"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Map"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"String, Object"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," params) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //获取当前登录的用户信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    MemberRespVo memberRespVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LoginUserInterceptor.loginUser."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    IPage<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> page "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"page"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Query<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPage"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(params),                                            "),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//根据id降序")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueryWrapper<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"member_id"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", memberRespVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderByDesc"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    );")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> orderEntities "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," page."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRecords"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(order "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //封装订单项到订单")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderItemEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> itemEntities "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderItemService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueryWrapper<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderItemEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order_sn"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", order."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        order."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setItemEntities"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(itemEntities);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," order;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    })."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    page."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setRecords"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderEntities);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," PageUtils"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(page);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[103]||(l[103]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403131702203.png",alt:"image-20230403131702203",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[104]||(l[104]=t("h5",{id:"_2-订单创建前需要预览订单-选择收货信息等",tabindex:"-1"},[r("2.订单创建前需要预览订单，选择收货信息等 "),t("a",{class:"header-anchor",href:"#_2-订单创建前需要预览订单-选择收货信息等","aria-label":'Permalink to "2.订单创建前需要预览订单，选择收货信息等"'},"​")],-1)),l[105]||(l[105]=t("p",null,[t("code",null,"http://cart.gulimall.com/cart.html")],-1)),l[106]||(l[106]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403130248691.png",alt:"image-20230403130248691",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[107]||(l[107]=t("p",null,[t("code",null,"http://order.gulimall.com/toTrade")],-1)),l[108]||(l[108]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.web.OrderWebController#toTrade")])],-1)),l[109]||(l[109]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * OrderConfirmVo = [List<MemberAddressVo> address,"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," //收货地址， ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *                  List<OrderItemVo> items,"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"      //所有选中的购物项")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *                 Integer integration,"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         //积分...")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *                 Map<Long, Boolean> stocks,"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," //库存信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *                 String orderToken"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //防重令牌]")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"*/")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/toTrade"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toTrade"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Model model, HttpServletRequest request) throws ExecutionException, InterruptedException {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    OrderConfirmVo confirmVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"confirmOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    model."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addAttribute"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"orderConfirmData"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", confirmVo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //展示订单确认的数据(页面跳转)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "confirm"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[110]||(l[110]=t("ul",null,[t("li",null,[t("p",null,[t("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#confirmOrder")])]),t("li",null,[t("blockquote",null,[t("p",null,[t("strong",null,"注"),r("：使用异步编排时用到远程调用，如果不进行请求上下文共享将造成Feign异步情况丢失上下文问题")])])])],-1)),l[111]||(l[111]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 订单确认页返回需要用到的数据")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," OrderConfirmVo "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"confirmOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws ExecutionException, InterruptedException {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    OrderConfirmVo confirmVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," OrderConfirmVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //从拦截器里获取用户信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    MemberRespVo memberRespVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LoginUserInterceptor.loginUser."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"主线程...."'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //获取原来请求上下文请求属性")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    RequestAttributes requestAttributes "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RequestContextHolder."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRequestAttributes"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //进行异步编排")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CompletableFuture<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Void"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> getAddressFuture "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CompletableFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"runAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //1、远程查询所有的收货地址列表")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"member线程...."'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //在Feign异步调用前将请求上下文进行共享操作(之前的请求数据都来共享每一个线程)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RequestContextHolder."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setRequestAttributes"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(requestAttributes);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"MemberAddressVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> address "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," memberFeignService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAddress"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(memberRespVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        confirmVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAddress"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(address);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }, executor);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CompletableFuture<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Void"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> cartFuture "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CompletableFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"runAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //2、远程查询购物车所有选中的购物项")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cart线程...."'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //在Feign异步调用前将请求上下文进行共享操作")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RequestContextHolder."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setRequestAttributes"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(requestAttributes);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderItemVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> items "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cartFeignService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentUserCartItems"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        confirmVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setItems"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(items);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //feign在远程调用之前要构造请求，调用很多的拦截器")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //for(RequestInterceptor interceptor:requestInterceptors)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }, executor)."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"thenRunAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderItemVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> items "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," confirmVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getItems"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> skuIds "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," items."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //远程查询库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        R r "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wmsFeignService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkusHasStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuIds);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SkuStockVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> data "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getData"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TypeReference<List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SkuStockVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">>() {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (data "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // Map<SkuId, hasStock> map")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Map<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Boolean"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," data."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toMap"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SkuStockVo"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getSkuId, SkuStockVo"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getHasStock));")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // Map<Long, Boolean> stocks;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            confirmVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStocks"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }, executor);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //3、查询用户积分")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Integer integration "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," memberRespVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIntegration"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    confirmVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIntegration"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(integration);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //4、其他数据自动计算")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //todo 5、防重令牌")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String token "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UUID."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomUUID"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"replace"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"-"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //给服务器一个令牌")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    redisTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(OrderConstant.USER_ORDER_TOKEN_PREFIX "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," memberRespVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), token, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"30"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit.MINUTES);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //给页面一个令牌")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    confirmVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setOrderToken"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(token);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CompletableFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allOf"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(getAddressFuture, cartFuture)."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," confirmVo;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[112]||(l[112]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403130554589.png",alt:"image-20230403130554589",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[113]||(l[113]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230416234636426.png",alt:"image-20230416234636426",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[114]||(l[114]=t("h5",{id:"_3-订单创建需要锁定库存-库存有才可创建-否则不能创建",tabindex:"-1"},[r("3.订单创建需要锁定库存，库存有才可创建，否则不能创建 "),t("a",{class:"header-anchor",href:"#_3-订单创建需要锁定库存-库存有才可创建-否则不能创建","aria-label":'Permalink to "3.订单创建需要锁定库存，库存有才可创建，否则不能创建"'},"​")],-1)),l[115]||(l[115]=t("ul",null,[t("li",null,"查询sku是否有库存"),t("li",null,[t("code",null,"com.klaus.gulimall.ware.controller.WareSkuController#getSkusHasStock")])],-1)),l[116]||(l[116]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//查询sku是否有库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/hasstock"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," R "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkusHasStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestBody"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Long"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," skuIds) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //sku_id stock")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SkuHasStockVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> vos "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareSkuService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkusHasStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuIds);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," R."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setData"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vos);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[117]||(l[117]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#getSkusHasStock")])],-1)),l[118]||(l[118]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SkuHasStockVo"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getSkusHasStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(List"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Long"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," skuIds) {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SkuHasStockVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> collect "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," skuIds."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SkuHasStockVo vo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SkuHasStockVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //查询当前sku的总库存量")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //SELECT SUM(stock-stock_locked) FROM `wms_ware_sku` WHERE sku_id=1")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //获取查询到的库存记录数")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long count "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," baseMapper."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //记录数大于0表示有库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHasStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(count "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ?"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," :"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    })."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," collect;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[119]||(l[119]=t("ul",null,[t("li",null,"SQL")],-1)),l[120]||(l[120]=t("div",{class:"language-xml max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"xml"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"select"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"getSkuStock"'),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," resultType"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"java.lang.Long"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SELECT SUM(stock-stock_locked) FROM `wms_ware_sku` WHERE sku_id=#{skuId}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"select"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[121]||(l[121]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404010335539.png",alt:"image-20230404010335539",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[122]||(l[122]=t("ul",null,[t("li",null,"创建订单进行库存锁定"),t("li",null,[t("code",null,"com.klaus.gulimall.ware.controller.WareSkuController#orderLockStock")])],-1)),l[123]||(l[123]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/lock/order"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," R "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestBody"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WareSkuLockVo vo){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Boolean lockStock "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        lockStock "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareSkuService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," R."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (NoStockException "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //通过测试发现商品库存不足将会在页面显示以下错误信息(http://order.gulimall.com/toTrade)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," R."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(BizCodeEnum.NO_STOCK_EXCEPTION."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), BizCodeEnum.NO_STOCK_EXCEPTION."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMsg"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[124]||(l[124]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#orderLockStock")])],-1)),l[125]||(l[125]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 为某个订单锁定库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 加入统一事务")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * (rollbackFor = NoStockException.class )")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 默认只要是运行时异常都会回滚")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 库存解锁的场景")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 1）、下订单成功，订单过期没有支付被系统自动取消、被用户手动取消，都要解锁库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 2）、下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 之前锁定的库存就要自动解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," vo")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WareSkuLockVo vo) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 保存库存工作单的详情的两张表")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 追溯")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    WareOrderTaskEntity taskEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," WareOrderTaskEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    taskEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    wareOrderTaskService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"save"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskEntity);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //按照下单的收货地址，找到一个就近仓库，锁定库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //1、找到每个商品在哪个仓库都有库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderItemVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> locks "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLocks"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SkuWareHasStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> collect "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," locks."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SkuWareHasStock stock "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SkuWareHasStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long skuId "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setNum"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCount"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //查询这个商品在哪里有库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> wareIds "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareSkuDao."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"listWareIdHasSkuStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setWareIds"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(wareIds);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    })."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //2、锁定库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (SkuWareHasStock hasStock "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," collect) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Boolean skuStocked "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//lock_status=0")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long skuId "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hasStock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> wareIds "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hasStock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWareIds"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (wareIds "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareIds."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //没有任何仓库有这个商品的库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," NoStockException"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //1、如果每一个商品都锁定成功，将当前商品锁定了几件的工作单记录发给MQ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //2、锁定失败。前面保存的工作单信息就回滚了，即使要解锁记录，由于去数据库查不到id，所以就不用解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //  log:skuId-num-ware: 1:1-2-1(v) 2:2-1-3(v) 3:3-1-1(x)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //  既然锁成功了就应该扣减，之后就应该解锁，因为3记录锁失败，1,2记录就回滚了，相当于工作单回滚了，库存没回滚库存扣减")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 只传id工作单是不知道当时库存锁了多少个")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Long wareId "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareIds) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //成功就返回1，否则就是0")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Long count "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareSkuDao."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lockSkuStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId, wareId, hasStock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNum"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (count "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //锁成功了==>lock_status=1")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                skuStocked "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //退出当前循环")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //todo 告诉MQ库存锁定成功")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                WareOrderTaskDetailEntity detailEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," WareOrderTaskDetailEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", skuId, "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", hasStock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNum"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), taskEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), wareId, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //保存工作单详情")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                wareOrderTaskDetailService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"save"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(detailEntity);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                StockLockedTo lockedTo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," StockLockedTo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //属性拷贝到to")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                StockDetailTo stockDetailTo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," StockDetailTo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                BeanUtils."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(detailEntity, stockDetailTo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //只传工作单id还不够，防止回滚以后找不到数据")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                lockedTo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                lockedTo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setDetailTo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stockDetailTo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //发送锁定库存消息；提交订单后，出现异常，订单回滚，库存不回滚，延时队列有2个任务等待死信时间结束后发送消息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                rabbitTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock.locked"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", lockedTo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                break"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //当前仓库锁失败了，重试下一个仓库")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (skuStocked "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //当前商品所有仓库都没有锁住")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," NoStockException"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //3、肯定全部都是锁定成功过的")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[126]||(l[126]=t("ul",null,[t("li",null,[r("库存工作单表"),t("code",null,"wms_ware_order_task")])],-1)),l[127]||(l[127]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404012221654.png",alt:"image-20230404012221654",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[128]||(l[128]=t("ul",null,[t("li",null,[r("库存工作单详情"),t("code",null,"wms_ware_order_task_detail")]),t("li",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404012535232.png",alt:"image-20230404012535232",loading:"lazy",decoding:"async",class:"lazy"})])],-1)),l[129]||(l[129]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404012359140.png",alt:"image-20230404012359140",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[130]||(l[130]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//查询这个商品在哪里有库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//com.klaus.gulimall.ware.dao.WareSkuDao#listWareIdHasSkuStock")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> wareIds "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareSkuDao."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"listWareIdHasSkuStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId);")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[131]||(l[131]=t("ul",null,[t("li",null,"SQL")],-1)),l[132]||(l[132]=t("div",{class:"language-xml max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"xml"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"select"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"listWareIdHasSkuStock"'),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," resultType"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"java.lang.Long"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SELECT ware_id FROM `wms_ware_sku` WHERE sku_id=#{skuId} AND stock-stock_locked >0")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"select"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[133]||(l[133]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404013003956.png",alt:"image-20230404013003956",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[134]||(l[134]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//库存锁定成功就返回1，否则就是0")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//com.klaus.gulimall.ware.dao.WareSkuDao#lockSkuStock")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Long count "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareSkuDao."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lockSkuStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId, wareId, hasStock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNum"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[135]||(l[135]=t("ul",null,[t("li",null,"SQL")],-1)),l[136]||(l[136]=t("div",{class:"language-xml max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"xml"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"update"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lockSkuStock"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    UPDATE `wms_ware_sku` SET stock_locked = stock_locked + #{num}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    WHERE sku_id =#{skuId} AND ware_id=#{wareId} AND stock-stock_locked>=#{num}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"update"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[137]||(l[137]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404014111150.png",alt:"image-20230404014111150",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[138]||(l[138]=t("h5",{id:"_4-订单创建后超时未支付需要解锁库存",tabindex:"-1"},[r("4.订单创建后超时未支付需要解锁库存 "),t("a",{class:"header-anchor",href:"#_4-订单创建后超时未支付需要解锁库存","aria-label":'Permalink to "4.订单创建后超时未支付需要解锁库存"'},"​")],-1)),l[139]||(l[139]=t("ul",null,[t("li",null,[t("p",null,"库存解锁分两种情况，一种是订单正常支付超时库存自动解锁；一种是订单服务异常/宕机库存自动解锁")]),t("li",null,[t("p",null,[t("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.StockLockedTo)")])])],-1)),l[140]||(l[140]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 1、库存自动解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚。之前锁定的库存就要自动解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 2、下订单失败")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 锁库存失败")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 只要解锁库存的消息失败，一定要告诉服务器解锁失败")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," to")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," message")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StockLockedTo to) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    StockDetailTo detail "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," to."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDetailTo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long detailId "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," detail."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //1、查询数据库关于这个订单的锁定库存信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 有： 证明库存锁定成功了")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //     解锁：订单情况")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //          1、没有这个订单，必须解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //          2、有这个订单，就不是解锁库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //                  订单状态： 已取消：解锁库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //                           没取消：不能接受")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 没有：库存锁定失败了，库存回滚了。这种情况无需解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    WareOrderTaskDetailEntity taskDetailEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareOrderTaskDetailService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(detailId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (taskDetailEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //有工作详情单，但只能证明库存服务在锁库存的时候锁成功后返回出去的，")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 要看整个订单有没有下单成功，如果订单远程调用的其他服务崩了导致订单回滚，这跟库存服务没有关系，直接解锁是有问题的，因为订单都没有")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Long id "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," to."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//库存工作单的id")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //获取订单状态")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        WareOrderTaskEntity taskEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareOrderTaskService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String orderSn "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," taskEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //根据订单号查询订单的状态")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        R r "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderFeignService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderSn);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (r."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //远程调用成功，订单数据返回成功")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            OrderVo data "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getData"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TypeReference<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">() {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            });")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (data "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," data."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 4"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //订单已经被取消或订单不存在，才能解锁库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //问题：订单服务由于网络等原因迟迟没有将订单解锁(data.getStatus()==0)导致库存永远释放不了锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (taskDetailEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLockStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    //当前库存工作单详情，状态为1 已锁定但是未解锁才可以解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                    unLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(detail."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), detail."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWareId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), detail."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuNum"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), detailId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //远程调用失败直接抛异常")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"远程服务失败"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //无需解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[141]||(l[141]=t("ul",null,[t("li",null,[t("p",null,"远程调用订单服务获取订单状态")]),t("li",null,[t("p",null,[t("code",null,"com.klaus.gulimall.order.controller.OrderController#getOrderStatus")])])],-1)),l[142]||(l[142]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/status/{orderSn}"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," R "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"orderSn"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") String orderSn){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    OrderEntity orderEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderByOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderSn);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," R."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ok"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setData"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderEntity);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[143]||(l[143]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," OrderEntity "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderByOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String orderSn) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    OrderEntity orderEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOne"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueryWrapper<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order_sn"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", orderSn));")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderEntity;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[144]||(l[144]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.OrderTo)")])],-1)),l[145]||(l[145]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"* 防止订单服务卡顿，导致更改订单状态的操作无法完成以及更改的mq消息没有得到执行，解锁库存的消息优先到期，扫描订单状态是新建状态，就会什么都不做")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 导致卡顿的订单永远不能解锁库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," orderTo")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 加入统一事务")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(OrderTo orderTo) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String orderSn "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderTo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //查一下最新库存的状态，防止重复解锁库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    WareOrderTaskEntity task "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareOrderTaskService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderTaskByOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderSn);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long id "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," task."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //按照工作单找到所有 没有解锁的库存，进行解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WareOrderTaskDetailEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> detailEntities "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareOrderTaskDetailService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueryWrapper<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WareOrderTaskDetailEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">().")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            eq"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"task_id"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id).")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //新建的还没被解锁的库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            eq"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lock_status"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (WareOrderTaskDetailEntity entity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," detailEntities) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //此解锁方式可以解决高并发问题和整个系统的异构(两个服务开发语言不同。如java，php)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        unLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWareId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuNum"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[146]||(l[146]=t("ul",null,[t("li",null,[r("库存解锁方法"),t("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unLockStock")])],-1)),l[147]||(l[147]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long skuId, Long wareId, Integer num, Long taskDetailId) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //库存解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    wareSkuDao."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId, wareId, num);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //更新库存工作单的状态")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    WareOrderTaskDetailEntity entity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," WareOrderTaskDetailEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskDetailId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setLockStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//变为已解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    wareOrderTaskDetailService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"updateById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entity);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[148]||(l[148]=t("ul",null,[t("li",null,"SQL")],-1)),l[149]||(l[149]=t("div",{class:"language-xml max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"xml"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"update"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"unLockStock"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    UPDATE `wms_ware_sku` SET stock_locked=stock_locked-#{num}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    WHERE sku_id=#{skuId} AND ware_id=#{wareId}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"update"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[150]||(l[150]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404015601068.png",alt:"image-20230404015601068",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[151]||(l[151]=t("h5",{id:"_5-支付成功后-需要进行拆单-根据商品打包方式-所在仓库-物流等进行拆单-待开发",tabindex:"-1"},[r("5.支付成功后，需要进行拆单，根据商品打包方式，所在仓库，物流等进行拆单(待开发) "),t("a",{class:"header-anchor",href:"#_5-支付成功后-需要进行拆单-根据商品打包方式-所在仓库-物流等进行拆单-待开发","aria-label":'Permalink to "5.支付成功后，需要进行拆单，根据商品打包方式，所在仓库，物流等进行拆单(待开发)"'},"​")],-1)),l[152]||(l[152]=t("h5",{id:"_6-支付的每笔流水都需要记录-以待查账",tabindex:"-1"},[r("6.支付的每笔流水都需要记录，以待查账 "),t("a",{class:"header-anchor",href:"#_6-支付的每笔流水都需要记录-以待查账","aria-label":'Permalink to "6.支付的每笔流水都需要记录，以待查账"'},"​")],-1)),l[153]||(l[153]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230403161913669.png",alt:"image-20230403161913669",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[154]||(l[154]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#handlePayResult")])],-1)),l[155]||(l[155]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 处理支付宝的支付结果")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," vo")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"handlePayResult"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(PayAsyncVo vo) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //1、保存交易流水")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    PaymentInfoEntity infoEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," PaymentInfoEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    infoEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAlipayTradeNo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTrade_no"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    infoEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOut_trade_no"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    infoEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPaymentStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTrade_status"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    infoEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCallbackTime"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNotify_time"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    paymentInfoService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"save"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(infoEntity);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //2、修改订单的状态信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTrade_status"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"TRADE_SUCCESS"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"||"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTrade_status"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"TRADE_FINISHED"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //支付成功状态")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String outTradeNo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," vo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOut_trade_no"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".baseMapper."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"updateOrderStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(outTradeNo, OrderStatusEnum.PAYED."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "success"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[156]||(l[156]=t("h5",{id:"_7-订单创建-支付成功-待开发-等状态都需要给-mq-发送消息-方便其他系统感知订阅",tabindex:"-1"},[r("7.订单创建，支付成功(待开发)等状态都需要给 MQ 发送消息，方便其他系统感知订阅 "),t("a",{class:"header-anchor",href:"#_7-订单创建-支付成功-待开发-等状态都需要给-mq-发送消息-方便其他系统感知订阅","aria-label":'Permalink to "7.订单创建，支付成功(待开发)等状态都需要给 MQ 发送消息，方便其他系统感知订阅"'},"​")],-1)),l[157]||(l[157]=t("ul",null,[t("li",null,"添加依赖")],-1)),l[158]||(l[158]=t("div",{class:"language-xml max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"xml"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-amqp</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[159]||(l[159]=t("ul",null,[t("li",null,[t("strong",null,"订单创建"),r("：(MQ)")]),t("li",null,"订单创建采用延迟队列"),t("li",null,[t("code",null,"com.klaus.gulimall.order.config.MyMQConfig")])],-1)),l[160]||(l[160]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderDelayQueue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> arguments "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * x-dead-letter-exchange: order-event-exchange")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * x-dead-letter-routing-key: order.release.order")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * x-message-ttl: 60000")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    arguments."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"x-dead-letter-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    arguments."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"x-dead-letter-routing-key"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order.release.order"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    arguments."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"x-message-ttl"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"60000"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //String name, boolean durable, boolean exclusive, boolean autoDelete, Map<String, Object> arguments")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Queue queue "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order.delay.queue"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", arguments);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," queue;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exchange "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderEventExchange"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //String name, boolean durable, boolean autoDelete, Map<String, Object> arguments")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," TopicExchange"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderCreateOrderBinding"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   //String destination, Binding.DestinationType destinationType, String exchange, String routingKey, Map<String, Object> arguments")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"   return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Binding"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order.delay.queue"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Binding.DestinationType.QUEUE,")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                "order-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                "order.create.order"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[161]||(l[161]=t("blockquote",null,[t("ul",null,[t("li",null,[r("创建订单 进入路由键-order.create.order- 进入交换机order-event-exchange， 根据路由键会转发到延时队列order.delay.queue 30min(60s)过期时间，过期时间到了之后，根据"),t("strong",null,"死信"),r("路由键-order.release.order-到达释放订单队列order.release.order.queue，监听这个队列的方法判断订单是不是已支付。")])])],-1)),l[162]||(l[162]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404121815115.png",alt:"image-20230404121815115",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[163]||(l[163]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#submitOrder")])],-1)),l[164]||(l[164]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SubmitOrderResponseVo "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"submitOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(OrderSubmitVo vo) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ...")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //todo 订单创建成功发送消息给MQ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order.create.order"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", order."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t...")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[165]||(l[165]=t("p",null,[t("strong",null,"库存锁定"),r("：(MQ)")],-1)),l[166]||(l[166]=t("ul",null,[t("li",null,[t("p",null,"库存锁定采用延迟队列")]),t("li",null,[t("p",null,[t("code",null,"com.klaus.gulimall.ware.config.MyRabbitConfig")])])],-1)),l[167]||(l[167]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exchange "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stockEventExchange"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," TopicExchange"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stockDelayQueue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> arguments "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    arguments."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"x-dead-letter-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    arguments."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"x-dead-letter-routing-key"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock.release"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    arguments."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"x-message-ttl"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"120000"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //String name, boolean durable, boolean exclusive, boolean autoDelete, Map<String, Object> arguments")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock.delay.queue"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", arguments);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stockLockedBinding"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //String destination, Binding.DestinationType destinationType, String exchange, String routingKey, Map<String, Object> arguments")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Binding"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock.delay.queue"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Binding.DestinationType.QUEUE,")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'            "stock-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'            "stock.locked"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[168]||(l[168]=t("blockquote",null,[t("ul",null,[t("li",null,[r("库存锁定成功 进入路由键-stock.locked- 进入交换机stock-event-exchange， 根据路由键会转发到延时队列stock.delay.queue 50min(120s)过期时间，延迟时间到，根据"),t("strong",null,"死信"),r("路由键-stock.release-到达释放订单队列stock.release.stock.queue，检查订单状态，确认是否需要解锁。")])])],-1)),l[169]||(l[169]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404122316210.png",alt:"image-20230404122316210",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[170]||(l[170]=t("ul",null,[t("li",null,[t("p",null,"订单创建成功后库存锁定也成功就发送消息给MQ")]),t("li",null,[t("p",null,[t("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#orderLockStock")])])],-1)),l[171]||(l[171]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WareSkuLockVo vo) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ...")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," //发送锁定库存消息；提交订单后，出现异常，订单回滚，库存不回滚，延时队列有2个任务等待死信时间结束后发送消息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  rabbitTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock.locked"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", lockedTo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  ...")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[172]||(l[172]=t("p",null,[t("strong",null,"防止超卖"),r("：数据库 unsigned int 做最后的保证。 (范围0~65535)")],-1)),l[173]||(l[173]=t("ul",null,[t("li",null,"在mysql数据库中，unsigned表面含义是 '无符号’的意思，unsigned既为非负数，用此类型可以增加数据长度。")],-1)),l[174]||(l[174]=t("p",null,[t("strong",null,"自动关单"),r("：订单超时未支付，需要取消订单 (MQ)")],-1)),l[175]||(l[175]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.config.MyMQConfig")])],-1)),l[176]||(l[176]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderReleaseOrderQueue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Queue queue "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order.release.order.queue"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," queue;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," \t@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exchange "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderEventExchange"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //String name, boolean durable, boolean autoDelete, Map<String, Object> arguments")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," TopicExchange"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"orderReleaseOrderBinding"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Binding"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order.release.order.queue"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Binding.DestinationType.QUEUE,")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                "order-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                "order.release.order"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[177]||(l[177]=t("blockquote",null,[t("ul",null,[t("li",null,[r("订单创建延迟时间到了之后，根据路由键-order.release.order-到达释放订单队列order.release.order.queue， 监听这个队列的方法 先是判断订单是不是已支付，如果不是就关闭订单，"),t("code",null,"关闭订单之后，根据路由键order.release.other 发送关闭的订单数据消息到交换机order-event-exchange，交换机再转发到order.release.coupon.queue优惠券队列，返回优惠券，与之通过 也是根据路由键order.release.other(待开发)")])])],-1)),l[178]||(l[178]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404124500812.png",alt:"image-20230404124500812",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[179]||(l[179]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.listener.OrderCloseListener")]),t("li",null,[r("添加配置文件"),t("code",null,"application.properties"),r("中的RabbitMQ配置项")])],-1)),l[180]||(l[180]=t("div",{class:"language-properties max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"properties"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"spring.rabbitmq.host"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=192.168.10.103")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"spring.rabbitmq.port"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=5672")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"spring.rabbitmq.virtual-host"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=/")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 开启发送端确认")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"spring.rabbitmq.publisher-confirms"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=true")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 开启发送端消息抵达队列的确认")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"spring.rabbitmq.publisher-returns"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=true")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 只要抵达队列，以异步发送优先回调我们这个returnConfirm")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"spring.rabbitmq.template.mandatory"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=true")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 手动ack消息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"spring.rabbitmq.listener.simple.acknowledge-mode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=MANUAL")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[181]||(l[181]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 订单释放(关单)监听器")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Service")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "order.release.order.queue"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," OrderCloseListener"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    OrderService orderService;")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitHandler")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listener"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(OrderEntity "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"entity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Channel "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"channel"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Message "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"message"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IOException {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //等待死信时间到后收到订单消息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"收到过期的订单信息，准备关闭订单"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            orderService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"closeOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entity);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //手动调用支付宝收单")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //签收订单")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            channel."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"basicAck"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(message."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessageProperties"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeliveryTag"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            channel."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"basicReject"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(message."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessageProperties"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeliveryTag"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[182]||(l[182]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#closeOrder")])],-1)),l[183]||(l[183]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   * 关单方法，将订单新建(待付款)状态设置为已取消状态并发送消息给MQ确认关单完成")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," entity")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"*/")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," closeOrder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(OrderEntity entity) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //查询当前这个订单的最新状态")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //将要发送的消息队列实体(释放订单服务前)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    OrderEntity orderEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //status=0")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (orderEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," OrderStatusEnum.CREATE_NEW."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //在待付款状态下才关单(消息队列的实体有可能过期了，所以创建新实体)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        OrderEntity update "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," OrderEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        update."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // status=4")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        update."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(OrderStatusEnum.CANCLED."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"updateById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(update);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        OrderTo orderTo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," OrderTo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        BeanUtils."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"copyProperties"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderEntity, orderTo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //todo 保证消息一定会发送出去，每一个消息都可以做好日志记录（给数据库保存每一个消息的详细信息）")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //todo 定期扫描数据库将失败的消息再发送一遍；")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //只要解锁成功了就【立即】发消息给MQ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            rabbitTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"order.release.other"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", orderTo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //todo 将没发送成功的消息进行重试发送 （while）")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[184]||(l[184]=t("p",null,[t("strong",null,"解锁库存"),r("： (MQ)")],-1)),l[185]||(l[185]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.ware.config.MyRabbitConfig")])],-1)),l[186]||(l[186]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exchange "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stockEventExchange"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," TopicExchange"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stockReleaseStockQueue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock.release.stock.queue"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stockReleaseBinding"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Binding"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"stock.release.stock.queue"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Binding.DestinationType.QUEUE,")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                "stock-event-exchange"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                "stock.release.#"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[187]||(l[187]=t("blockquote",null,[t("ul",null,[t("li",null,[t("code",null,"关闭订单之后，根据路由键order.release.other 发送关闭的订单数据到交换机order-event-exchange，交换机再转发到order.release.coupon.queue优惠券队列，返回优惠券，与之通过 也是根据路由键order.release.other，和数据一起转发到解锁库存队列stock.release.stock.queue 解锁库存(待开发)。")])])],-1)),l[188]||(l[188]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404134206092.png",alt:"image-20230404134206092",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[189]||(l[189]=t("ul",null,[t("li",null,[t("p",null,"订单关闭，需要解锁已经占用的库存")]),t("li",null,[t("p",null,[t("code",null,"com.klaus.gulimall.ware.listener.StockReleaseListener")])])],-1)),l[190]||(l[190]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 监听库存解锁队列")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "stock.release.stock.queue"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Service")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," StockReleaseListener"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    WareSkuService wareSkuService;")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 订单正常关闭(订单服务正常运行)，需要解锁已经占用的库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," to"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," 库存工作单(含工作单详情)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitHandler")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleStockLockedRelease"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StockLockedTo "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"to"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Message "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"message"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Channel "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"channel"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IOException {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"收到解锁库存的消息..."'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //当前消息是否被第二次及以后(重新)派发过来了")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//            Boolean redelivered = message.getMessageProperties().getRedelivered();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            wareSkuService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(to);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //只要解锁成功了，就签收消息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            channel."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"basicAck"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(message."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessageProperties"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeliveryTag"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //有任何异常直接拒绝签收;消息拒绝以后重新放到队列里面，让别人继续消费解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            channel."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"basicReject"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(message."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessageProperties"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeliveryTag"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[191]||(l[191]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.StockLockedTo)")])],-1)),l[192]||(l[192]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StockLockedTo to) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ...")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //问题：订单服务由于网络等原因迟迟没有将订单解锁(data.getStatus()==0)导致库存永远释放不了锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (taskDetailEntity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLockStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //当前库存工作单详情，状态为1 已锁定但是未解锁才可以解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    unLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(detail."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), detail."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWareId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), detail."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuNum"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), detailId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t...")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[193]||(l[193]=t("ul",null,[t("li",null,"库存锁定成功，订单回滚，保证最终一致性，也需要库存自动解锁；库存锁定成功，订单服务全部炸了，订单都没有创建好，就必须有自动解锁功能"),t("li",null,[t("code",null,"com.klaus.gulimall.ware.listener.StockReleaseListener")])],-1)),l[194]||(l[194]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 监听库存解锁队列")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "stock.release.stock.queue"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Service")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," StockReleaseListener"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    WareSkuService wareSkuService;")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 订单异常关闭(订单服务发送运行时异常或宕机)，需要解锁已经占用的库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 如果库存锁定成功，订单服务全部炸了，订单都没有创建好，就必须有自动解锁功能")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," orderTo"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," 完整订单信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," message")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," channel")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@throws"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," IOException")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitHandler")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleOrderCloseRelease"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(OrderTo "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"orderTo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Message "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"message"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Channel "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"channel"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IOException {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"订单关闭准备解锁库存...."'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            wareSkuService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderTo);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //只要解锁成功了，就签收消息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            channel."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"basicAck"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(message."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessageProperties"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeliveryTag"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //有任何异常直接拒绝签收;消息拒绝以后重新放到队列里面，让别人继续消费解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            channel."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"basicReject"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(message."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessageProperties"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDeliveryTag"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[195]||(l[195]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.OrderTo)+#unLockStock")])],-1)),l[196]||(l[196]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 防止订单服务卡顿，导致更改订单状态的操作无法完成以及更改的mq消息没有得到执行，解锁库存的消息优先到期，扫描订单状态是新建状态，就会什么都不做")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 导致卡顿的订单永远不能解锁库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," orderTo")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 加入统一事务")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transactional")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unlockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(OrderTo orderTo) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String orderSn "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," orderTo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //查一下最新库存的状态，防止重复解锁库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    WareOrderTaskEntity task "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareOrderTaskService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getOrderTaskByOrderSn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(orderSn);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Long id "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," task."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //按照工作单找到所有 没有解锁的库存，进行解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WareOrderTaskDetailEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> detailEntities "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wareOrderTaskDetailService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueryWrapper<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WareOrderTaskDetailEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">().")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            eq"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"task_id"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", id).")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //新建的还没被解锁的库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            eq"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lock_status"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (WareOrderTaskDetailEntity entity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," detailEntities) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //此解锁方式可以解决高并发问题和整个系统的异构(两个服务开发语言不同。如java，php)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        unLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWareId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuNum"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," unLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long skuId, Long wareId, Integer num, Long taskDetailId) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //库存解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    wareSkuDao."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unLockStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId, wareId, num);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //更新库存工作单的状态")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    WareOrderTaskDetailEntity entity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," WareOrderTaskDetailEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskDetailId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    entity."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setLockStatus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//变为已解锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    wareOrderTaskDetailService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"updateById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entity);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[197]||(l[197]=t("h5",{id:"订单确认页流程",tabindex:"-1"},[r("订单确认页流程 "),t("a",{class:"header-anchor",href:"#订单确认页流程","aria-label":'Permalink to "订单确认页流程"'},"​")],-1)),l[198]||(l[198]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322151416874.png",alt:"image-20230322151416874",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[199]||(l[199]=t("h5",{id:"电商订单流程图",tabindex:"-1"},[r("电商订单流程图 "),t("a",{class:"header-anchor",href:"#电商订单流程图","aria-label":'Permalink to "电商订单流程图"'},"​")],-1)),l[200]||(l[200]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322151557139.png",alt:"image-20230322151557139",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[201]||(l[201]=t("h5",{id:"消息队列流程图",tabindex:"-1"},[r("消息队列流程图 "),t("a",{class:"header-anchor",href:"#消息队列流程图","aria-label":'Permalink to "消息队列流程图"'},"​")],-1)),l[202]||(l[202]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230416235749443.png",alt:"image-20230416235749443",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[203]||(l[203]=t("h5",{id:"支付宝支付流程图",tabindex:"-1"},[r("支付宝支付流程图 "),t("a",{class:"header-anchor",href:"#支付宝支付流程图","aria-label":'Permalink to "支付宝支付流程图"'},"​")],-1)),l[204]||(l[204]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230404162856264.png",alt:"image-20230404162856264",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[205]||(l[205]=t("h3",{id:"项目难点",tabindex:"-1"},[r("项目难点 "),t("a",{class:"header-anchor",href:"#项目难点","aria-label":'Permalink to "项目难点"'},"​")],-1)),l[206]||(l[206]=t("ul",null,[t("li",null,[t("p",null,"订单服务与库存的联动(延时队列的使用)")]),t("li",null,[t("p",null,"订单释放&库存解锁"),t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322190959538.png",alt:"image-20230322190959538",loading:"lazy",decoding:"async",class:"lazy"})])])],-1)),l[207]||(l[207]=t("h3",{id:"解决问题",tabindex:"-1"},[r("解决问题 "),t("a",{class:"header-anchor",href:"#解决问题","aria-label":'Permalink to "解决问题"'},"​")],-1)),l[208]||(l[208]=t("ul",null,[t("li",null,[t("p",null,[r("使用"),t("strong",null,"CompletableFuture 异步编排"),r("解决查询商品详情⻚"),t("strong",null,"响应速度慢的问题"),r("；")]),t("ul",null,[t("li",null,"假如商品详情页的每个查询，需要如下标注的时间才能完成 那么，用户需要 5.5s 后才能看到商品详情页的内容。很显然是不能接受的。 如果有多个线程同时完成这 6 步操作，也许只需要 1.5s 即可完成响应。")])]),t("li",null,[t("p",null,[r("使用"),t("strong",null,"Spring Cache方法级别缓存技术"),r("，实现已经被调用过的指定的目标方法，直接从缓存中获取方法调用后的结果返回，"),t("strong",null,"提高系统的响应速度；")])]),t("li",null,[t("p",null,"幂等解决方案"),t("ul",null,[t("li",null,[t("p",null,"token 机制"),t("ul",null,[t("li",null,[t("p",null,"1、服务端提供了发送 token 的接口。我们在分析业务的时候，哪些业务是存在幂等问题的，就必须在执行业务前，先去获取 token，服务器会把token 保存到 redis 中。")]),t("li",null,[t("p",null,"2、然后调用业务接口请求时，把 token 携带过去，一般放在请求头部。")]),t("li",null,[t("p",null,"3、服务器判断 token 是否存在 redis 中，存在表示第一次请求，然后删除 token,继续执行业务。")]),t("li",null,[t("p",null,"4、如果判断 token 不存在 redis 中，就表示是重复操作，直接返回重复标记给 client，这样就保证了业务代码，不被重复执行。")]),t("li",null,[t("p",null,"危险性："),t("ul",null,[t("li",null,[t("p",null,"1、先删除 token 还是后删除 token；")]),t("li",null,[t("p",null,"(1) 先删除可能导致，业务确实没有执行，重试还带上之前 token，由于防重设计导致，请求还是不能执行。")]),t("li",null,[t("p",null,"(2) 后删除可能导致，业务处理成功，但是服务闪断，出现超时，没有删除 token，别人继续重试，导致业务被执行两遍")]),t("li",null,[t("p",null,"(3) 我们最好设计为先删除 token，如果业务调用失败，就重新获取 token 再次请求。")]),t("li",null,[t("p",null,"2、Token 获取、比较和删除必须是原子性")]),t("li",null,[t("p",null,"(1) redis.get(token) 、token.equals、redis.del(token)如果这两个操作不是原子，可能导致，高并发下，都 get 到同样的数据，判断都成功，继续业务并发执行")]),t("li",null,[t("p",null,"(2) 可以在 redis 使用 lua 脚本完成这个操作")])])])])])]),t("div",{class:"language-shell max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"shell"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," redis.call("),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"'get'"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},","),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," KEYS[1]"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") == ARGV[1] "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," return"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis.call"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"'del'"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},","),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," KEYS[1]"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"else"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," return"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," end")])])]),t("button",{class:"code-block-unfold-btn"})])]),t("li",null,[t("p",null,"Session共享问题解决-不同服务，子域session共享"),t("ul",null,[t("li",null,"jsessionid这个cookie默认是当前系统域名的。当我们分拆服务，不同域名部署的时候，我们可以使用如下解决方案；")]),t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230323001610876.png",alt:"image-20230323001610876",loading:"lazy",decoding:"async",class:"lazy"})]),t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," GulimallSessionConfig"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CookieSerializer "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cookieSerializer"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        DefaultCookieSerializer cookieSerializer "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DefaultCookieSerializer"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        cookieSerializer."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setDomainName"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"gulimall.com"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        cookieSerializer."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCookieName"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"KLAUSSESSION"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cookieSerializer;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisSerializer<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"springSessionDefaultRedisSerializer"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," GenericJackson2JsonRedisSerializer"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})]),t("ul",null,[t("li",null,"SpringSession核心原理")]),t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 加入依赖")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *          <dependency>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *             <groupId>org.springframework.boot</groupId>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *             <artifactId>spring-boot-starter-data-redis</artifactId>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         </dependency>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         \x3c!--整合Springsession完成session共享问题--\x3e")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         <dependency>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *             <groupId>org.springframework.session</groupId>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *             <artifactId>spring-session-data-redis</artifactId>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         </dependency>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 核心原理")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 1、@EnableRedisHttpSession导入RedisHttpSessionConfiguration配置")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      1）、给容器中添加了一个组件")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *          传入SessionRepository==》【RedisOperationsSessionRepository】===》redis操作session，session的增删改查封装类")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      2）、SessionRepositoryFilter==》Filter(web)：session存储过滤器；每个请求过来都必须经过Filter")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         I）、创建的时候，就自动从容器中获取了SessionRepository")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         II）、原始的HttpServletRequest request, HttpServletResponse response都被分别包装成了SessionRepositoryRequestWrapper，SessionRepositoryResponseWrapper")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         III）、以后获取session-》request.getSession();（原始的）")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         //SessionRepositoryRequestWrapper重写getSession方法")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         IV）、wrapperRequest.getSession();==> SessionRepository中获取的到")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *  装饰者模式；")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *  自动延期；redis中的数据也是有过期时间的")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"EnableRedisHttpSession"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," //整合redis作为session存储")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SpringBootApplication")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," GulimallAuthServerApplication"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"args"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SpringApplication."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"run"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(GulimallAuthServerApplication.class, args);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})]),t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230323001706985.png",alt:"image-20230323001706985",loading:"lazy",decoding:"async",class:"lazy"})])]),t("li",null,[t("p",null,"ThreadLocal-同一个线程共享数据")])],-1)),l[209]||(l[209]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230323001857265.png",alt:"image-20230323001857265",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[210]||(l[210]=t("ul",null,[t("li",null,[t("p",null,"Feign远程调用丢失请求头问题"),t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230323001742038.png",alt:"image-20230323001742038",loading:"lazy",decoding:"async",class:"lazy"})]),t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.member.config")])])])],-1)),l[211]||(l[211]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," GulimallFeignConfig"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"requestInterceptor"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RequestInterceptor "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"requestInterceptor"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //RequestContextHolder.setRequestAttributes(requestAttributes);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 进行共享操作，拦截器才会有请求上下文的所有数据")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RequestInterceptor"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," apply"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RequestTemplate "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"template"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //1、RequestContextHolder拿到刚进来的这个请求")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ServletRequestAttributes attributes "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ServletRequestAttributes) RequestContextHolder."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRequestAttributes"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (attributes "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"RequestInterceptor线程...."'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Thread."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    HttpServletRequest request "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," attributes."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRequest"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//老请求")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (request "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        //请求不为空")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        //同步请求头数据，Cookie")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        String cookie "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getHeader"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Cookie"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'//                System.out.println("feign远程之前先进行RequestInterceptor.apply");')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        //给新请求同步了老请求的Cookie")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        template."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"header"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Cookie"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", cookie);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        };")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[212]||(l[212]=t("ul",null,[t("li",null,[t("p",null,"Feign异步情况丢失上下文问题"),t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230323001802654.png",alt:"image-20230323001802654",loading:"lazy",decoding:"async",class:"lazy"})]),t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#confirmOrder")])])])],-1)),l[213]||(l[213]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//获取原来请求上下文请求属性")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"RequestAttributes requestAttributes "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RequestContextHolder."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRequestAttributes"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//进行异步编排")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CompletableFuture<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Void"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> getAddressFuture "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CompletableFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"runAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //1、远程查询所有的收货地址列表")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"member线程...."'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //在Feign异步调用前将请求上下文进行共享操作(之前的请求数据都来共享每一个线程)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    RequestContextHolder."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setRequestAttributes"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(requestAttributes);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"MemberAddressVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> address "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," memberFeignService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAddress"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(memberRespVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    confirmVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setAddress"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(address);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}, executor);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CompletableFuture<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Void"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> cartFuture "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CompletableFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"runAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //2、远程查询购物车所有选中的购物项")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cart线程...."'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentThread"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //在Feign异步调用前将请求上下文进行共享操作")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    RequestContextHolder."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setRequestAttributes"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(requestAttributes);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderItemVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> items "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cartFeignService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentUserCartItems"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    confirmVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setItems"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(items);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //feign在远程调用之前要构造请求，调用很多的拦截器")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //for(RequestInterceptor interceptor:requestInterceptors)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}, executor)."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"thenRunAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OrderItemVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> items "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," confirmVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getItems"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> skuIds "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," items."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"map"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toList"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //远程查询库存")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    R r "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," wmsFeignService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkusHasStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuIds);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SkuStockVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> data "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," r."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getData"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TypeReference<List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SkuStockVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">>() {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    });")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (data "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // Map<SkuId, hasStock> map")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Map<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Boolean"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> map "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," data."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stream"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"collect"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collectors."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toMap"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SkuStockVo"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getSkuId, SkuStockVo"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getHasStock));")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // Map<Long, Boolean> stocks;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        confirmVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStocks"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}, executor);")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[214]||(l[214]=t("h3",{id:"项目优化",tabindex:"-1"},[r("项目优化 "),t("a",{class:"header-anchor",href:"#项目优化","aria-label":'Permalink to "项目优化"'},"​")],-1)),l[215]||(l[215]=t("ul",null,[t("li",null,"使用动态线程池管理和监控，定时获取线程池的运行数据")],-1)),l[216]||(l[216]=t("p",null,"Hippo4j 提供了应用线程池运行时变更核心参数的功能。而且，如果应用是集群部署，可以选择修改线程池某一实例，或者修改集群全部实例，运行时生效，不需要再重启服务。",-1)),l[217]||(l[217]=t("p",null,"压测时可以使用 Hippo4j 动态调整线程池参数，判断线程池核心参数设置是否合理。对于开发测试来说，如果不满足可以随时调整。",-1)),l[218]||(l[218]=t("h2",{id:"completablefuture异步编排",tabindex:"-1"},[r("CompletableFuture异步编排 "),t("a",{class:"header-anchor",href:"#completablefuture异步编排","aria-label":'Permalink to "CompletableFuture异步编排"'},"​")],-1)),l[219]||(l[219]=t("h3",{id:"概念",tabindex:"-1"},[r("概念 "),t("a",{class:"header-anchor",href:"#概念","aria-label":'Permalink to "概念"'},"​")],-1)),l[220]||(l[220]=t("ul",null,[t("li",null,"CompletableFuture是JDK1.8里面引入的一个异步回调类，就是说当前使用异步线程去执行一个任务时候，我们希望在这个任务结束以后，触发一个后续的动作，而CompletableFuture就可以实现这样的功能。")],-1)),l[221]||(l[221]=t("h3",{id:"业务场景",tabindex:"-1"},[r("业务场景 "),t("a",{class:"header-anchor",href:"#业务场景","aria-label":'Permalink to "业务场景"'},"​")],-1)),l[222]||(l[222]=t("ul",null,[t("li",null,"查询商品详情页的逻辑比较复杂，有些数据还需要远程调用，必然需要花费更多的时间。")],-1)),l[223]||(l[223]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322152108985.png",alt:"image-20230322152108985",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[224]||(l[224]=t("ul",null,[t("li",null,"假如商品详情页的每个查询，需要如下标注的时间才能完成 那么，用户需要 5.5s 后才能看到商品详情页的内容。很显然是不能接受的。 如果有多个线程同时完成这 6 步操作，也许只需要 1.5s 即可完成响应。"),t("li",null,"在 Java 8 中, 新增加了一个包含 50 个方法左右的类: CompletableFuture，提供了非常强大的 Future 的扩展功能，可以帮助我们简化异步编程的复杂性，提供了函数式编程的能力，可以 通过回调的方式处理计算结果，并且提供了转换和组合 CompletableFuture 的方法。")],-1)),l[225]||(l[225]=t("h3",{id:"项目代码",tabindex:"-1"},[r("项目代码 "),t("a",{class:"header-anchor",href:"#项目代码","aria-label":'Permalink to "项目代码"'},"​")],-1)),l[226]||(l[226]=t("ul",null,[t("li",null,[t("code",null,"com.klaus.gulimall.product.service.impl.SkuInfoServiceImpl#item")])],-1)),l[227]||(l[227]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //四、线程串行化方法")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /*")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    thenApply 方法：当一个线程依赖另一个线程时，获取上一个任务返回的结果，并返回当前")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    任务的返回值。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    thenAccept 方法：消费处理结果。接收任务的处理结果，并消费处理，无返回结果。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    thenRun 方法：只要上面的任务执行完成，就开始执行 thenRun，只是处理完任务后，执行")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    thenRun 的后续操作")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    带有 Async 默认是异步执行的。同之前。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    以上都要前置任务成功完成。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SkuItemVo "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"item"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long skuId) throws ExecutionException, InterruptedException {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SkuItemVo skuItemVo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SkuItemVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //一、创建异步对象")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        /*")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         runAsync和supplyAsync  runXxxx 都是没有返回结果的，supplyXxx 都是可以获取返回结果的")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         可以传入自定义的线程池，否则就用默认的线程池；")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        CompletableFuture<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SkuInfoEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> infoFuture "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CompletableFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"supplyAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //1.sku基本信息获取 pms_sku_info")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            SkuInfoEntity info "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            skuItemVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInfo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(info);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," info;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }, executor);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CompletableFuture<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Void"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> saleAttrFuture "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," infoFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"thenAcceptAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((res) "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //3、 获取spu的销售属性组合")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SkuItemSaleAttrVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> saleAttrVos "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," skuSaleAttrValueService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSaleAttrBySpuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(res."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSpuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        skuItemVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSaleAttr"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(saleAttrVos);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }, executor);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CompletableFuture<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Void"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> descFuture "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," infoFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"thenAcceptAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((res) "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //4.获取spu的介绍 pms_spu_info_desc")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SpuInfoDescEntity spuInfoDescEntity "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," spuInfoDescService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(res."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSpuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        skuItemVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setDesc"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(spuInfoDescEntity);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }, executor);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CompletableFuture<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Void"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> baseAttrFuture "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," infoFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"thenAcceptAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((res) "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //5.获取spu的规格参数信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SpuItemAttrGroupVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> attrGroupVos "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," attrGroupService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAttrGroupWithAttrsBySpuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(res."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSpuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), res."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCatalogId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        skuItemVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setGroupAttrs"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(attrGroupVos);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }, executor);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //一、创建异步对象")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /*")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     runAsync和supplyAsync  runXxxx 都是没有返回结果的，supplyXxx 都是可以获取返回结果的")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     可以传入自定义的线程池，否则就用默认的线程池；")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //2.sku图片信息  pms_spu_images")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CompletableFuture<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Void"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> imageFuture "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CompletableFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"runAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SkuImagesEntity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> imagesEntities "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," skuImagesService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getImagesBySkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        skuItemVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setImages"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(imagesEntities);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }, executor);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //TODO"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," //3、远程调用查询当前sku是否参与秒杀优惠活动")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CompletableFuture<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Void"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> seckillFuture "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CompletableFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"runAsync"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //3.远程调用查询当前sku是否参与秒杀优惠活动")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        R skuSeckilInfo "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillFeignService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuSeckilInfo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuId);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (skuSeckilInfo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //查询成功")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            SeckillSkuVo skuSeckilInfoData "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," skuSeckilInfo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getData"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"data"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TypeReference<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SeckillSkuVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">() {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            });")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            skuItemVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSeckillSkuVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(skuSeckilInfoData);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (skuSeckilInfoData "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," currentTime "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (currentTime "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," skuSeckilInfoData."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getEndTime"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    skuItemVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSeckillSkuVo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }, executor);")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //七、多任务组合")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /*")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    allOf：等待所有任务完成")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    anyOf：只要有一个任务完成")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //等到所有任务完成"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  //TODO 秒杀优惠活动Future")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CompletableFuture."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allOf"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(saleAttrFuture,descFuture,baseAttrFuture,imageFuture,seckillFuture)."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," skuItemVo;")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[228]||(l[228]=t("h2",{id:"rabbitmq延时队列-实现定时任务",tabindex:"-1"},[r("RabbitMQ延时队列（实现定时任务） "),t("a",{class:"header-anchor",href:"#rabbitmq延时队列-实现定时任务","aria-label":'Permalink to "RabbitMQ延时队列（实现定时任务）"'},"​")],-1)),l[229]||(l[229]=t("h3",{id:"场景",tabindex:"-1"},[r("场景： "),t("a",{class:"header-anchor",href:"#场景","aria-label":'Permalink to "场景："'},"​")],-1)),l[230]||(l[230]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322165119843.png",alt:"image-20230322165119843",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[231]||(l[231]=t("ul",null,[t("li",null,[t("p",null,"比如未付款订单，超过一定时间后，系统自动取消订单并释放占有物品。")]),t("li",null,[t("p",null,"常用解决方案：spring的 schedule 定时任务轮询数据库"),t("ul",null,[t("li",null,[t("p",null,"缺点：消耗系统内存、增加了数据库的压力、存在较大的时间误差")]),t("li",null,[t("p",null,"定时任务的时效性问题"),t("p",null,"定时任务开启的第一次扫描，订单未创建，1min后创建完成，30min第二次扫描订单未过期，无事发生，31min订单过期，直到60min第三次扫描才扫到过期订单"),t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322165931065.png",alt:"image-20230322165931065",loading:"lazy",decoding:"async",class:"lazy"})])])])]),t("li",null,[t("p",null,"解决：rabbitmq的消息TTL和死信Exchange结合")]),t("li",null,[t("p",null,"订单释放&库存解锁")])],-1)),l[232]||(l[232]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190115962.png",alt:"image-20230410190115962",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[233]||(l[233]=t("h3",{id:"消息的ttl-time-to-live",tabindex:"-1"},[r("消息的TTL（Time To Live） "),t("a",{class:"header-anchor",href:"#消息的ttl-time-to-live","aria-label":'Permalink to "消息的TTL（Time To Live）"'},"​")],-1)),l[234]||(l[234]=t("ul",null,[t("li",null,"消息的TTL就是消息的存活时间。"),t("li",null,"RabbitMQ可以对队列和消息分别设置TTL。"),t("li",null,[r("对队列设置就是队列没有消费者连着的保留时间，"),t("strong",null,"也可以对每一个单独的消息做单独的"),t("strong",null,"设置。超过了这个时间，我们认为这个消息就死了，称之为死信"),r("。")]),t("li",null,[r("如果队列设置了，消息也设置了，那么会"),t("strong",null,"取小的"),r("。所以一个消息如果被路由到不同的队 列中，这个消息死亡的时间有可能不一样（不同的队列设置）。这里单讲单个消息的 TTL，因为它才是实现延迟任务的关键。可以通过"),t("strong",null,"设置消息的expiration字段或者x-"),t("strong",null,"message-ttl属性来设置时间"),r("，两者是一样的效果。")])],-1)),l[235]||(l[235]=t("h3",{id:"dead-letter-exchanges-dlx",tabindex:"-1"},[r("Dead Letter Exchanges（DLX） "),t("a",{class:"header-anchor",href:"#dead-letter-exchanges-dlx","aria-label":'Permalink to "Dead Letter Exchanges（DLX）"'},"​")],-1)),l[236]||(l[236]=t("ul",null,[t("li",null,[t("p",null,"一个消息在满足如下条件下，会进"),t("p",null,"死信路由"),t("p",null,"，记住这里是路由而不是队列，"),t("p",null,"一个路由可以对应很多队列。（什么是死信）"),t("ul",null,[t("li",null,"一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不 会被再次放在队列里，被其他消费者使用。 （ basic.reject/ basic.nack ） requeue=false"),t("li",null,"上面的消息的TTL到了，消息过期了。"),t("li",null,"队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上")])]),t("li",null,[t("p",null,"Dead Letter Exchange其实就是一种普通的exchange，和创建其他 exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有 消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。")]),t("li",null,[t("p",null,"我们既可以控制消息在一段时间后变成死信，又可以控制变成死信的消息 被路由到某一个指定的交换机，结合二者，其实就可以实现一个延时队列")]),t("li",null,[t("p",null,"手动ack&异常消息统一放在一个队列处理建议的两种方式")]),t("li",null,[t("p",null,"catch异常后，手动发送到指定队列，然后使用channel给rabbitmq确认消息已消费")]),t("li",null,[t("p",null,"给Queue绑定死信队列，使用nack（requque为false）确认消息消费失败")])],-1)),l[237]||(l[237]=t("h3",{id:"延时队列实现",tabindex:"-1"},[r("延时队列实现 "),t("a",{class:"header-anchor",href:"#延时队列实现","aria-label":'Permalink to "延时队列实现"'},"​")],-1)),l[238]||(l[238]=t("ul",null,[t("li",null,"给队列设置过期时间")],-1)),l[239]||(l[239]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322152334742.png",alt:"image-20230322152334742",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[240]||(l[240]=t("ul",null,[t("li",null,"给消息设置过期时间")],-1)),l[241]||(l[241]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322152358754.png",alt:"image-20230322152358754",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[242]||(l[242]=t("ul",null,[t("li",null,"推荐：给队列设置过期时间，因为给消息设置过期时间的话，RabbitMQ采用的是惰性检查机制，假设队列里面的消息过期时间不同，后面的消息必须等前面的消息过期，最终导致消息不能按照规定的过期时间过期。")],-1)),l[243]||(l[243]=t("h3",{id:"springboot中使用延时队列",tabindex:"-1"},[r("SpringBoot中使用延时队列 "),t("a",{class:"header-anchor",href:"#springboot中使用延时队列","aria-label":'Permalink to "SpringBoot中使用延时队列"'},"​")],-1)),l[244]||(l[244]=t("ul",null,[t("li",null,"1、Queue、Exchange、Binding可以@Bean进去"),t("li",null,[r("2、监听消息的方法可以有三种参数（不分数量，顺序） "),t("ul",null,[t("li",null,"Object content, Message message, Channel channel")])]),t("li",null,"3、channel可以用来拒绝消息，否则自动ack；")],-1)),l[245]||(l[245]=t("h3",{id:"消息队列流程",tabindex:"-1"},[r("消息队列流程 "),t("a",{class:"header-anchor",href:"#消息队列流程","aria-label":'Permalink to "消息队列流程"'},"​")],-1)),l[246]||(l[246]=t("ul",null,[t("li",null,"使用RabbitMQ延时队列实现未付款订单，超过一定时间后，系统自动取消订单并解锁库存。"),t("li",null,"PS:创建订单 进入路由键-order.create.order- 进入交换机order-event-exchange， 根据路由键会转发到延时队列order.delay.queue 1min过期时间，过期时间到了之后，根据路由键order.release.order-到达释放订单队列order.release.order.queue， 监听这个队列的方法 先是判断订单是不是已支付，如果不是 就关闭订单，关闭订单之后，根据路由键order.release.other 发送关闭的订单数据到交换机order-event-exchange，交换机再转发到order.release.coupon.queue优惠券队列，返回优惠券，与之通过 也是根据路由键order.release.other，和数据一起转发到解锁库存队列stock.release.stock.queue 解锁库存。")],-1)),l[247]||(l[247]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230416235749443.png",alt:"image-20230416235749443",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[248]||(l[248]=t("h2",{id:"redis缓存中的数据结构",tabindex:"-1"},[r("Redis缓存中的数据结构 "),t("a",{class:"header-anchor",href:"#redis缓存中的数据结构","aria-label":'Permalink to "Redis缓存中的数据结构"'},"​")],-1)),l[249]||(l[249]=t("h3",{id:"分类菜单",tabindex:"-1"},[r("分类菜单 "),t("a",{class:"header-anchor",href:"#分类菜单","aria-label":'Permalink to "分类菜单"'},"​")],-1)),l[250]||(l[250]=t("ul",null,[t("li",null,"类型：String"),t("li",null,"value: 菜单信息")],-1)),l[251]||(l[251]=t("h3",{id:"登陆信息-springsession",tabindex:"-1"},[r("登陆信息-SpringSession "),t("a",{class:"header-anchor",href:"#登陆信息-springsession","aria-label":'Permalink to "登陆信息-SpringSession"'},"​")],-1)),l[252]||(l[252]=t("h3",{id:"购物车",tabindex:"-1"},[r("购物车 "),t("a",{class:"header-anchor",href:"#购物车","aria-label":'Permalink to "购物车"'},"​")],-1)),l[253]||(l[253]=t("ul",null,[t("li",null,"类型：Hash"),t("li",null,"key: gulimall:cart:2 // 2为用户ID"),t("li",null,"field: 商品 id"),t("li",null,"value: 购物项数据"),t("li",null,[r("综上所述，我们的购物车结构是一个双层 Map：Map<String,Map<String,String>> "),t("ul",null,[t("li",null,"第一层 Map，Key 是用户 id"),t("li",null,"第二层 Map，Key 是购物车中商品 id，值是购物项数据")])])],-1)),l[254]||(l[254]=t("h3",{id:"秒杀上架-幂等性处理",tabindex:"-1"},[r("秒杀上架 (幂等性处理) "),t("a",{class:"header-anchor",href:"#秒杀上架-幂等性处理","aria-label":'Permalink to "秒杀上架 (幂等性处理)"'},"​")],-1)),l[255]||(l[255]=t("ul",null,[t("li",null,[r("缓存秒杀活动信息 (seckill:session:) "),t("ul",null,[t("li",null,"类型: List"),t("li",null,"key: seckill:session:start_endtime // 开始时间的时间戳_结束时间的时间戳"),t("li",null,"value: 场次ID_商品ID")])]),t("li",null,[r("缓存秒杀活动所关联的商品信息 (seckill:skus) "),t("ul",null,[t("li",null,"类型：Hash"),t("li",null,"key: seckill:skus"),t("li",null,"field: 场次ID_商品ID"),t("li",null,"value: 秒杀商品信息")])]),t("li",null,[r("秒杀库存信号量 "),t("ul",null,[t("li",null,"类型： String"),t("li",null,"key: seckIll:stock:UUID"),t("li",null,"value: 库存数量")])])],-1)),l[256]||(l[256]=t("h3",{id:"幂等性保证",tabindex:"-1"},[r("幂等性保证 "),t("a",{class:"header-anchor",href:"#幂等性保证","aria-label":'Permalink to "幂等性保证"'},"​")],-1)),l[257]||(l[257]=t("ul",null,[t("li",null,"缓存商品信息前，先判断有没有这个key")],-1)),l[258]||(l[258]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String redisKey "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillSkuVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPromotionSessionId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "-"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," seckillSkuVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"operations."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hasKey"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(redisKey)) {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"              //判断Redis中是否有该信息，如果没有才进行添加")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Boolean hasKey "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redisTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"hasKey"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                //缓存活动信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"hasKey) {")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[259]||(l[259]=t("h3",{id:"redission分布式锁",tabindex:"-1"},[r("Redission分布式锁 "),t("a",{class:"header-anchor",href:"#redission分布式锁","aria-label":'Permalink to "Redission分布式锁"'},"​")],-1)),l[260]||(l[260]=t("ul",null,[t("li",null,"设置分布式锁以及信号量-关键代码")],-1)),l[261]||(l[261]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //秒杀商品上架功能的锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String upload_lock "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "seckill:upload:lock"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  //分布式锁 .可重入锁（Reentrant Lock）")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RLock lock "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redissonClient."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(upload_lock);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            //加锁")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            lock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit.SECONDS);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            seckillService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"uploadSeckillSkuLatest3Days"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            e."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"printStackTrace"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            lock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"unlock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"          //如果当前这个场次的商品库存信息已经上架就不需要上架")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        //5、使用库存作为分布式Redisson信号量（限流）")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        // 使用库存作为分布式信号量")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        RSemaphore semaphore "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redissonClient."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSemaphore"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SKU_STOCK_SEMAPHORE "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," token);")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        // 商品可以秒杀的数量作为信号量")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        semaphore."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"trySetPermits"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(seckillSkuVo."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSeckillCount"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[262]||(l[262]=t("h2",{id:"分布式事务",tabindex:"-1"},[r("分布式事务 "),t("a",{class:"header-anchor",href:"#分布式事务","aria-label":'Permalink to "分布式事务"'},"​")],-1)),l[263]||(l[263]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322165148070.png",alt:"image-20230322165148070",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[264]||(l[264]=t("ul",null,[t("li",null,[t("strong",null,"事务保证：")])],-1)),l[265]||(l[265]=t("ol",null,[t("li",null,"订单服务异常，库存锁定不运行，全部回滚，撤销操作"),t("li",null,"库存服务事务自治，锁定失败全部回滚，订单感受到，继续回滚"),t("li",null,"库存服务锁定成功了，但是网络原因返回数据途中问题？"),t("li",null,"库存服务锁定成功了，库存服务下面的逻辑发生故障，订单回滚了，怎么处理？")],-1)),l[266]||(l[266]=t("ul",null,[t("li",null,[t("strong",null,"利用消息队列实现最终一致")])],-1)),l[267]||(l[267]=t("p",null,"库存服务锁定成功后发给消息队列消息（当前库存工作单），过段时间自动解锁，解锁时先查询订单的支付状态。解锁成功修改库存工作单详情项状态为已解锁",-1)),l[268]||(l[268]=t("ul",null,[t("li",null,[r("1、远程服务假失败： "),t("ul",null,[t("li",null,"远程服务其实成功了，由于网络故障等没有返回"),t("li",null,"导致：订单回滚，库存却扣减")])]),t("li",null,[r("2、远程服务执行完成，下面的其他方法出现问题 "),t("ul",null,[t("li",null,"导致：已执行的远程请求，肯定不能回滚")])])],-1)),l[269]||(l[269]=t("h3",{id:"事务的坑",tabindex:"-1"},[r("事务的坑 "),t("a",{class:"header-anchor",href:"#事务的坑","aria-label":'Permalink to "事务的坑"'},"​")],-1)),l[270]||(l[270]=t("ul",null,[t("li",null,"在同一个类里面，编写两个方法，内部调用的时候，会导致事务设置失效。原因是没有用到代理对象的缘故。"),t("li",null,[r("解决： "),t("ul",null,[t("li",null,"0）、导入 spring-boot-starter-aop"),t("li",null,"1）、@EnableTransactionManagement(proxyTargetClass = true)"),t("li",null,"2）、@EnableAspectJAutoProxy(exposeProxy=true)"),t("li",null,"3）、AopContext.currentProxy() 调用方法")])])],-1)),l[271]||(l[271]=t("h3",{id:"cap理论",tabindex:"-1"},[r("CAP理论 "),t("a",{class:"header-anchor",href:"#cap理论","aria-label":'Permalink to "CAP理论"'},"​")],-1)),l[272]||(l[272]=t("ul",null,[t("li",null,[r("C是"),t("strong",null,"一致性"),r("，分布式系统的"),t("strong",null,"数据要保持一致")]),t("li",null,[r("A是"),t("strong",null,"可用性"),r("，分布式系统能进行"),t("strong",null,"故障转移")]),t("li",null,[r("P是"),t("strong",null,"分区容错性"),r("，分布式系统"),t("strong",null,"出现网络问题能正常运行")]),t("li",null,"CAP理论是指分布式系统中不能保证三者同时存在，只能两两组合")],-1)),l[273]||(l[273]=t("h3",{id:"base-理论",tabindex:"-1"},[r("BASE 理论 "),t("a",{class:"header-anchor",href:"#base-理论","aria-label":'Permalink to "BASE 理论"'},"​")],-1)),l[274]||(l[274]=t("ul",null,[t("li",null,[r("是对 CAP 理论的延伸，思想是即使无法做到强一致性（CAP 的一致性就是强一致性），但可 以采用适当的采取弱一致性，即"),t("strong",null,"最终一致性。")])],-1)),l[275]||(l[275]=t("h3",{id:"分布式事务几种方案",tabindex:"-1"},[r("分布式事务几种方案 "),t("a",{class:"header-anchor",href:"#分布式事务几种方案","aria-label":'Permalink to "分布式事务几种方案"'},"​")],-1)),l[276]||(l[276]=t("ul",null,[t("li",null,[r("2PC 模式 "),t("ul",null,[t("li",null,[r("数据库支持的 2PC【2 phase commit 二阶提交】，又叫做 XA Transactions。 "),t("ul",null,[t("li",null,"第一阶段：事务协调器要求每个涉及到事务的数据库预提交(precommit)此操作，并反映是 否可以提交."),t("li",null,"第二阶段：事务协调器要求每个数据库提交数据。")])]),t("li",null,[t("strong",null,"性能不理想")])])]),t("li",null,[r("柔性事务-TCC 事务补偿型方案 "),t("ul",null,[t("li",null,"一阶段 prepare 行为：调用 自定义 的 prepare 逻辑。"),t("li",null,"二阶段 commit 行为：调用 自定义 的 commit 逻辑。"),t("li",null,"二阶段 rollback 行为：调用 自定义 的 rollback 逻辑。"),t("li",null,"所谓 TCC 模式，是指支持把 自定义 的分支事务纳入到全局事务的管理中")])]),t("li",null,[r("柔性事务-最大努力通知型方案 "),t("ul",null,[t("li",null,[r("按规律进行通知，"),t("strong",null,"不保证数据一定能通知成功，但会提供可查询操作接口进行核对"),r("。")]),t("li",null,"这种 方案主要用在与第三方系统通讯时，比如：调用微信或支付宝支付后的支付结果通知。"),t("li",null,"这种 方案也是结合 MQ 进行实现，例如：通过 MQ 发送 http 请求，设置最大通知次数。达到通知次数后即不再通知。")])]),t("li",null,[r("柔性事务-"),t("strong",null,"可靠消息"),r("+最终一致性方案（异步确保型） "),t("ul",null,[t("li",null,"实现：业务处理服务在业务事务提交之前，向实时消息服务请求发送消息，实时消息服务只 记录消息数据，而不是真正的发送。业务处理服务在业务事务提交之后，向实时消息服务确 认发送。只有在得到确认发送指令后，实时消息服务才会真正发送。"),t("li",null,[r("防止消息丢失： "),t("ul",null,[t("li",null,"1、做好消息确认机制（pulisher，consumer【手动 ack】）"),t("li",null,"2、每一个发送的消息都在数据库做好记录。定期将失败的消息再次发送一 遍")])])])])],-1)),l[277]||(l[277]=t("blockquote",null,[t("p",null,"刚性事务：遵循 ACID 原则，强一致性。"),t("p",null,"柔性事务：遵循 BASE 理论，最终一致性；"),t("p",null,"与刚性事务不同，柔性事务允许一定时间内，不同节点的数据不一致，但要求最终一致。")],-1)),l[278]||(l[278]=t("h2",{id:"seata",tabindex:"-1"},[r("Seata "),t("a",{class:"header-anchor",href:"#seata","aria-label":'Permalink to "Seata"'},"​")],-1)),l[279]||(l[279]=t("p",null,[t("a",{href:"https://seata.io/zh-cn/docs/overview/what-is-seata.html",target:"_blank",rel:"noreferrer"},"Seata 是什么")],-1)),l[280]||(l[280]=t("h3",{id:"seata的理解",tabindex:"-1"},[r("Seata的理解 "),t("a",{class:"header-anchor",href:"#seata的理解","aria-label":'Permalink to "Seata的理解"'},"​")],-1)),l[281]||(l[281]=t("ul",null,[t("li",null,[r("Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。 "),t("ul",null,[t("li",null,[r("AT模式。是一种基于"),t("strong",null,"本地事务+二阶段协议"),r("来实现的"),t("strong",null,"最终数据一致性方案"),r("，也是Seata默认的解决方案。")]),t("li",null,[r("TCC模式，TCC事务是Try,Confirm,Cancel 三个词语的缩写，简单理解就是把"),t("strong",null,"一个完整的业务逻辑拆分成三个阶段"),r("，然后通过事务管理器在业务逻辑层面，根据每个分支事务的执行情况分别调用该业务的Confirm 或者Cacel方法。")]),t("li",null,[r("Saga模式，Saga模式是SEATA提供"),t("strong",null,"长事务解决方案"),r("，在Saga模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者。")]),t("li",null,[r("XA模式，XA可以认为是一种"),t("strong",null,"强一致性的事务解决方法"),r("，它利用事务资源（数据库，消息服务等）对XA协议的支持，以XA协议的机制来管理分支事务的一种事务模式。")])])])],-1)),l[282]||(l[282]=t("blockquote",null,[t("p",null,[t("a",{href:"https://seata.io/zh-cn/docs/overview/what-is-seata.html",target:"_blank",rel:"noreferrer"},"Seata 是什么")]),t("ul",null,[t("li",null,[t("h4",{id:"tc-transaction-coordinator-事务协调者",tabindex:"-1"},[r("TC (Transaction Coordinator) - 事务协调者 "),t("a",{class:"header-anchor",href:"#tc-transaction-coordinator-事务协调者","aria-label":'Permalink to "TC (Transaction Coordinator) - 事务协调者"'},"​")]),t("ul",null,[t("li",null,"维护全局和分支事务的状态，驱动全局事务提交或回滚。")])]),t("li",null,[t("h4",{id:"tm-transaction-manager-事务管理器",tabindex:"-1"},[r("TM (Transaction Manager) - 事务管理器 "),t("a",{class:"header-anchor",href:"#tm-transaction-manager-事务管理器","aria-label":'Permalink to "TM (Transaction Manager) - 事务管理器"'},"​")]),t("ul",null,[t("li",null,"定义全局事务的范围：开始全局事务、提交或回滚全局事务。")])]),t("li",null,[t("h4",{id:"rm-resource-manager-资源管理器",tabindex:"-1"},[r("RM (Resource Manager) - 资源管理器 "),t("a",{class:"header-anchor",href:"#rm-resource-manager-资源管理器","aria-label":'Permalink to "RM (Resource Manager) - 资源管理器"'},"​")]),t("ul",null,[t("li",null,"管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。")])])]),t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230322152804762.png",alt:"image-20230322152804762",loading:"lazy",decoding:"async",class:"lazy"})])],-1)),l[283]||(l[283]=t("h3",{id:"seata项目整合",tabindex:"-1"},[r("Seata项目整合 "),t("a",{class:"header-anchor",href:"#seata项目整合","aria-label":'Permalink to "Seata项目整合"'},"​")],-1)),l[284]||(l[284]=t("ul",null,[t("li",null,"Seata控制分布式事务"),t("li",null,"1）、每一个微服务先必须创建 undo_log；"),t("li",null,[r("2）、安装事务协调器；seata-server： "),t("a",{href:"https://github.com/seata/seata/releases",target:"_blank",rel:"noreferrer"},"https://github.com/seata/seata/releases")]),t("li",null,[r("3）、整合 "),t("ul",null,[t("li",null,"1、导入依赖 spring-cloud-starter-alibaba-seata seata-all-0.7.1"),t("li",null,[r("2、解压并启动seata-server； "),t("ul",null,[t("li",null,"registry.conf: 注册中心配置； 修改registry type=nacos"),t("li",null,"file.conf：")])]),t("li",null,"3、所有想要用到分布式事务的微服务使用seata DataSourceProxy代理自己的数据源"),t("li",null,[r("4、每个微服务，都必须导入 "),t("ul",null,[t("li",null,"registry.conf"),t("li",null,"file.conf vgroup_mapping.{application.name}-fescar-service-group = “default”")])]),t("li",null,"5、启动测试分布式事务"),t("li",null,"6、给分布式大事务的入口标注@GlobalTransactional"),t("li",null,"7、每一个远程的小事务用 @Transactional")])])],-1)),l[285]||(l[285]=t("p",null,"应用场景：",-1)),l[286]||(l[286]=t("ul",null,[t("li",null,[r("订单服务提交订单，库存服务扣减库存 "),t("ul",null,[t("li",null,"seta-提交订单接口 OrderServiceImpl 类submitOrder（）方法 加 @GlobalTransactional"),t("li",null,"（下单是高并发场景，不推荐seata分布式事务。推荐用消息队列 最终一致性）")])]),t("li",null,"商品服务保持商品信息，远程调用优惠服务保持商品优惠券信息"),t("li",null,[t("ul",null,[t("li",null,"开启seta全局事务-SpuInfoServiceImpl类saveSpuInfo()方法 （推荐）")])])],-1)),l[287]||(l[287]=t("h2",{id:"sentinel",tabindex:"-1"},[r("Sentinel "),t("a",{class:"header-anchor",href:"#sentinel","aria-label":'Permalink to "Sentinel"'},"​")],-1)),l[288]||(l[288]=t("p",null,[t("a",{href:"https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D",target:"_blank",rel:"noreferrer"},"介绍 · alibaba/Sentinel Wiki · GitHub")],-1)),l[289]||(l[289]=t("h3",{id:"sentinel理解",tabindex:"-1"},[r("Sentinel理解 "),t("a",{class:"header-anchor",href:"#sentinel理解","aria-label":'Permalink to "Sentinel理解"'},"​")],-1)),l[290]||(l[290]=t("ul",null,[t("li",null,[r("随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从"),t("strong",null,"流量控制、熔断降级"),r("、系统负载保护等多个维度保护服务的稳定性。")]),t("li",null,[r("我们说的资源，可以是任何东西，服务，服务里的方法，甚至是一段代码。使用 Sentinel 来进行资源保护，主要分为几个步骤: "),t("ol",null,[t("li",null,"定义资源"),t("li",null,"定义规则"),t("li",null,"检验规则是否生效")])]),t("li",null,[r("Sentinel 分为两个部分: "),t("ul",null,[t("li",null,"核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时 对 Dubbo / Spring Cloud 等框架也有较好的支持。"),t("li",null,"控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器")])])],-1)),l[291]||(l[291]=t("h3",{id:"熔断降级限流",tabindex:"-1"},[r("熔断降级限流 "),t("a",{class:"header-anchor",href:"#熔断降级限流","aria-label":'Permalink to "熔断降级限流"'},"​")],-1)),l[292]||(l[292]=t("ul",null,[t("li",null,[r("熔断 "),t("ul",null,[t("li",null,"A 服务调用 B 服务的某个功能，B服务卡死，功能时间超长，我们就将B断路，返回降级数据。")])]),t("li",null,[r("降级 "),t("ul",null,[t("li",null,"流量高峰期，服务器压力剧增，对一些页面和服务做策略的降级（停止服务，调用直接返回降级数据）")])]),t("li",null,[r("熔断、降级区别 "),t("ul",null,[t("li",null,[r("相同点 "),t("ul",null,[t("li",null,"保证服务的可用性")])]),t("li",null,[r("不同点 "),t("ul",null,[t("li",null,"1、熔断是被调用方故障，触发的系统主动规则"),t("li",null,"2、降级是基于全局考虑，停止一些正常服务，释放资源")])])])]),t("li",null,[r("限流 "),t("ul",null,[t("li",null,"对打入服务的请求流量进行控制，使服务能够承担不超过自己能力的流量压力")])])],-1)),l[293]||(l[293]=t("h3",{id:"项目整合步骤",tabindex:"-1"},[r("项目整合步骤 "),t("a",{class:"header-anchor",href:"#项目整合步骤","aria-label":'Permalink to "项目整合步骤"'},"​")],-1)),l[294]||(l[294]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 1、整合Sentinel")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 1）、导入依赖 spring-cloud-starter-alibaba-sentinel")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 2）、下载sentinel的控制台")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 3）、配置sentinel控制台地址信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 4) 、在控制台调整参数。【默认所有的流控设置保存在内存中，重启失效】")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"      *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"       *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 2、每一个微服务都导入 actuator ()；并配合management.endpoints.web.exposure.include=*")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 3、自定义sentinel流控返回数据")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 4、使用Sentinel来保护feign远程调用：熔断；")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 1）、调用方的熔断保护：feign.sentinel.enabled=true")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 2）、调用方手动指定远程服务的降级策略。远程服务被降级处理。触发我们的熔断回调方法")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 3）、超大浏览的时候，必须牺牲一些远程服务。在服务的提供方（远程服务）指定降级策略；")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 提供方是在运行。但是不运行自己的业务逻辑，返回的是默认的降级数据（限流的数据），")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 5、自定义受保护的资源")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 1）、代码")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},' * try(Entry entry = SphU.entry("seckillSkus")){')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," //业务逻辑")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * catch(Execption e){}")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 2）、基于注解。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},' * @SentinelResource(value = "getCurrentSeckillSkusResource",blockHandler = "blockHandler")')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 无论是1,2方式一定要配置被限流以后的默认返回.")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * url请求可以设置统一返回:WebCallbackManager")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    */")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[295]||(l[295]=t("h3",{id:"整合-feign-sentinel-测试熔断降级",tabindex:"-1"},[r("整合 Feign+Sentinel 测试熔断降级 "),t("a",{class:"header-anchor",href:"#整合-feign-sentinel-测试熔断降级","aria-label":'Permalink to "整合 Feign+Sentinel 测试熔断降级"'},"​")],-1)),l[296]||(l[296]=t("ul",null,[t("li",null,[t("p",null,"引入依赖：>spring-cloud-starter-openfeign、spring-cloud-starter-alibaba-sentinel<")]),t("li",null,[t("p",null,"2、使用 Nacos 注册中心 spring-cloud-starter-alibaba-nacos-discovery")]),t("li",null,[t("p",null,"定义 fallbackfactory 并放在容器中"),t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   /**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    * @Author zly")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    * @Date 2022/7/26 16:22")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"      */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Slf4j")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"      public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SeckillFeignServiceFallBack"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SeckillFeignService"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"   ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"      public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," R "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuSeckilInfo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"skuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"          log."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"熔断方法调用.."'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"          return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," R."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(BizCodeEnum.TO_MANY_REQUEST."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),BizCodeEnum.TO_MANY_REQUEST."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessage"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      }")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  }")])])]),t("button",{class:"code-block-unfold-btn"})])]),t("li",null,[t("p",null,"远程接口配置 feign 客户端容错"),t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  /**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   * @Author zly")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   * @Date 2022/7/26 16:21")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"FeignClient"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "gulimall-seckill"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"fallback"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SeckillFeignServiceFallBack.class)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," interface"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SeckillFeignService"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"      /**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"       * 根据skuId查询商品是否参加秒杀活动")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"       * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," skuId")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"       * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"       */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/sku/seckill/{skuId}"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      R "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getSkuSeckilInfo"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"skuId"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"skuId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  }")])])]),t("button",{class:"code-block-unfold-btn"})])]),t("li",null,[t("p",null,"开启 sentinel 代理 feign 功能；在 application.properties 中配置"),t("ul",null,[t("li",null,"feign.sentinel.enabled=true")]),t("blockquote",null,[t("p",null,[t("a",{href:"https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81",target:"_blank",rel:"noreferrer"},"注解支持 · alibaba/Sentinel Wiki · GitHub")]),t("p",null,"1、使用@SentinelResource，并定义 fallback"),t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SentinelResource"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "getCurrentSeckillSkusResource"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"blockHandler"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "blockHandler"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SeckillSkuRedisTo"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getCurrentSeckillSkus"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})])])])],-1)),l[297]||(l[297]=t("h2",{id:"nacos",tabindex:"-1"},[r("Nacos "),t("a",{class:"header-anchor",href:"#nacos","aria-label":'Permalink to "Nacos"'},"​")],-1)),l[298]||(l[298]=t("blockquote",null,[t("p",null,[t("a",{href:"https://nacos.io/zh-cn/docs/use-nacos-with-springcloud.html",target:"_blank",rel:"noreferrer"},"Nacos Spring Cloud")])],-1)),l[299]||(l[299]=t("h3",{id:"项目整合",tabindex:"-1"},[r("项目整合 "),t("a",{class:"header-anchor",href:"#项目整合","aria-label":'Permalink to "项目整合"'},"​")],-1)),l[300]||(l[300]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 1、如何使用Nacos作为配置中心统一管理配置")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 1）、引入依赖，")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         <dependency>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *             <groupId>com.alibaba.cloud</groupId>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *             <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         </dependency>")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 2）、创建一个bootstrap.properties。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      spring.application.name=gulimall-coupon")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      spring.cloud.nacos.config.server-addr=127.0.0.1:8848")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 3）、需要给配置中心默认添加一个叫 数据集（Data Id）gulimall-coupon.properties。默认规则，应用名.properties")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 4）、给 应用名.properties 添加任何配置")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 5）、动态获取配置。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      @RefreshScope：动态获取并刷新配置")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},' *      @Value("${配置项的名}")：获取到配置。')]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      如果配置中心和当前应用的配置文件中都配置了相同的项，优先使用配置中心的配置。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 2、细节")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *  1）、命名空间：配置隔离；")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      默认：public(保留空间)；默认新增的所有配置都在public空间。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      1、开发，测试，生产：利用命名空间来做环境隔离。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         注意：在bootstrap.properties；配置上，需要使用哪个命名空间下的配置，")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *         spring.cloud.nacos.config.namespace=9de62e44-cd2a-4a82-bf5c-95878bd5e871")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      2、每一个微服务之间互相隔离配置，每一个微服务都创建自己的命名空间，只加载自己命名空间下的所有配置")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *  2）、配置集：所有的配置的集合")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *  3）、配置集ID：类似文件名。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      Data ID：类似文件名")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *  4）、配置分组：")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      默认所有的配置集都属于：DEFAULT_GROUP；")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *      1111，618，1212")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 项目中的使用：每个微服务创建自己的命名空间，使用配置分组区分环境，dev，test，prod")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 3、同时加载多个配置集")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 1)、微服务任何配置信息，任何配置文件都可以放在配置中心中")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 2）、只需要在bootstrap.properties说明加载配置中心中哪些配置文件即可")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 3）、@Value，@ConfigurationProperties。。。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 以前SpringBoot任何方法从配置文件中获取值，都能使用。")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 配置中心有的优先使用配置中心中的，")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," /**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 1、开启服务注册发现")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," *  (配置nacos的注册中心地址)")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 2、编写网关配置文件")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[301]||(l[301]=t("h3",{id:"nacos作为注册中心",tabindex:"-1"},[r("Nacos作为注册中心： "),t("a",{class:"header-anchor",href:"#nacos作为注册中心","aria-label":'Permalink to "Nacos作为注册中心："'},"​")],-1)),l[302]||(l[302]=t("ul",null,[t("li",null,[t("p",null,"将微服务注册到 nacos 中")]),t("li",null,[t("p",null,"1、首先，修改 pom.xml 文件，引入 Nacos Discovery Starter。")]),t("li",null,[t("p",null,"2、在应用的 /src/main/resources/application.properties 配置文 件中配置 Nacos Server 地址"),t("div",{class:"language-properties max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"properties"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," spring.cloud.nacos.discovery.server-addr"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=127.0.0.1:8848")])])]),t("button",{class:"code-block-unfold-btn"})])]),t("li",null,[t("p",null,"3、使用@EnableDiscoveryClient 开启服务注册发现功能")]),t("li",null,[t("p",null,"4、启动应用，观察 nacos 服务列表是否已经注册上服务"),t("ul",null,[t("li",null,[t("blockquote",null,[t("p",null,"注意：每一个应用都应该有名字，这样才能注册上去。修改 application.properties 文件"),t("p",null,"spring.application.name=service-provider"),t("p",null,"server.port=8000")])])])]),t("li",null,[t("p",null,"5、注册更多的服务上去，测试使用 feign 远程调用"),t("ul",null,[t("li",null,[t("blockquote",null,[t("p",null,"Nacos 使用三步"),t("p",null,"1、导包 nacos-discovery"),t("p",null,"2、写配置，指定 nacos 地址，指定应用的名字"),t("p",null,"3、开启服务注册发现功能@EnableDiscoveryClient"),t("p",null,"Feign 使用三步"),t("p",null,"1、导包 openfeign"),t("p",null,"2、开启@EnableFeignClients 功能"),t("p",null,"3、编写接口，进行远程调用")])])])])],-1)),l[303]||(l[303]=t("h3",{id:"nacos作为配置中心",tabindex:"-1"},[r("Nacos作为配置中心 "),t("a",{class:"header-anchor",href:"#nacos作为配置中心","aria-label":'Permalink to "Nacos作为配置中心"'},"​")],-1)),l[304]||(l[304]=t("ul",null,[t("li",null,[t("p",null,"1、pom.xml 引入 Nacos Config Starter。")]),t("li",null,[t("p",null,"2、在应用的 /src/main/resources/bootstrap.properties 配 置文件中配置 Nacos Config 元数据"),t("div",{class:"language-properties max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"properties"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  spring.application.name"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=nacos-config-example")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  spring.cloud.nacos.config.server-addr"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=127.0.0.1:8848")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  #指定命名空间")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  spring.cloud.nacos.config.namespace"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=af7b6638-68dd-43a0-8bef-19dbaf2ae5c3 ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  #指定分组  默认DEFAULT_GROUP")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  spring.cloud.nacos.config.group"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=dev")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"  #主要配置应用名和配置中心地址")])])]),t("button",{class:"code-block-unfold-btn"})])]),t("li",null,[t("p",null,"3、在 nacos 中添加配置"),t("ul",null,[t("li",null,[t("p",null,[r("在 nacos 中创建一个 "),t("strong",null,"应用名.properties"),r(" 配置文件并编写配置")])]),t("li",null,[t("blockquote",null,[t("p",null,[t("strong",null,"Nacos Config"),r(),t("strong",null,"数据结构")]),t("p",null,"Nacos Config 主要通过 dataId 和 group 来唯一确定一条配置。"),t("p",null,"Nacos Client 从 Nacos Server 端获取数据时，调用的是此接口 ConfigService.getConfig(String dataId, String group, long timeoutMs)。"),t("p",null,[t("strong",null,"Spring Cloud"),r(),t("strong",null,"应用获取数据")]),t("p",null,[t("strong",null,"dataID"),r(":")]),t("p",null,"在 Nacos Config Starter 中，dataId 的拼接格式如下"),t("ul",null,[t("li",null,"${prefix} - ${spring.profiles.active} . ${file-extension} prefix 默认为 spring.application.name 的值，也可以通过配置项 spring.cloud.nacos.config.prefix 来配置。"),t("li",null,"spring.profiles.active 即为当前环境对应的 profile")]),t("p",{"file-extension":""},[r("注意，当 activeprofile 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 prefix . {prefix}."),t("em",null,[r("p"),t("strong",null,"re"),r("f"),t("strong",null,"i"),r("x")]),r(".")]),t("p",null,"file-extension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置。 目前只支持 properties 类型。"),t("p",null,[t("strong",null,"Group"),r("：")]),t("p",null,"Group 默认为 DEFAULT_GROUP，可以通过 spring.cloud.nacos.config.group 配置。")])])])]),t("li",null,[t("p",null,"4、在应用中使用@Value 和@RefreshScope"),t("ul",null,[t("li",null,[t("blockquote",null,[t("p",null,"完成上述两步后，应用会从 Nacos Config 中获取相应的配置，并添加在 Spring Environment"),t("p",null,"的 PropertySources 中 。 这 里 我 们 使 用 @Value 注 解 来 将 对 应 的 配 置 注 入 到"),t("p",null,"SampleController 的 userName 和 age 字段，并添加 @RefreshScope 打开动态刷新功能"),t("p",null,[t("strong",null,"@RefreshScope")]),t("p",null,"class SampleController {"),t("p",null,[t("strong",null,"@Value(“${user.name}”)")]),t("p",null,"String userName;"),t("p",null,[t("strong",null,"@Value(“${user.age}”)")]),t("p",null,"int age;"),t("p",null,"}")])])])])],-1)),l[305]||(l[305]=t("h3",{id:"nacos进阶",tabindex:"-1"},[r("Nacos进阶 "),t("a",{class:"header-anchor",href:"#nacos进阶","aria-label":'Permalink to "Nacos进阶"'},"​")],-1)),l[306]||(l[306]=t("ul",null,[t("li",null,[t("p",null,[t("strong",null,"核心概念")]),t("ul",null,[t("li",null,[t("p",null,[t("strong",null,"命名空间：配置隔离")]),t("ul",null,[t("li",null,[t("p",null,[r("用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 "),t("strong",null,"Group"),r(" 或 "),t("strong",null,"Data ID"),r(" 的")]),t("p",null,[r("配置。"),t("strong",null,"Namespace"),r(" 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生")]),t("p",null,"产环境的资源（如配置、服务）隔离等")])])]),t("li",null,[t("p",null,[t("strong",null,"配置集：所有配置的集合")]),t("ul",null,[t("li",null,[t("p",null,"一组相关或者不相关的配置项的集合称为配置集。在系统中，一个配置文件通常就是一个配"),t("p",null,"置集，包含了系统各个方面的配置。例如，一个配置集可能包含了数据源、线程池、日志级"),t("p",null,"别等配置项。")])])]),t("li",null,[t("p",null,[t("strong",null,"配置集ID：类似文件名。")]),t("ul",null,[t("li",null,[t("p",null,[r("Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。"),t("strong",null,"Data ID"),r(" 通常用于组")]),t("p",null,"织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有"),t("p",null,"意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名"),t("p",null,"规则保证全局唯一性。此命名规则非强制。")])])]),t("li",null,[t("p",null,[t("strong",null,"配置分组：默认所有的配置集都属于：DEFAULT_GROUP；")]),t("ul",null,[t("li",null,[t("p",null,"Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或"),t("p",null,"Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个"),t("p",null,"配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置"),t("p",null,"分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和"),t("p",null,"MQ_topic 配置。")])])])])]),t("li",null,[t("p",null,[t("strong",null,"原理")]),t("ul",null,[t("li",null,[r("自动注入： "),t("ul",null,[t("li",null,"NacosConfigStarter 实现了 org.springframework.cloud.bootstrap.config.PropertySourceLocator 接口，并将优先级设置成了最高。 在 Spring Cloud 应用启动阶段，会主动从 Nacos Server 端获取对应的数据，并将获取到的 数据转换成 PropertySource 且注入到 Environment 的 PropertySources 属性中，所以使用 @Value 注解也能直接获取 Nacos Server 端配置的内容。")])]),t("li",null,[r("动态刷新： "),t("ul",null,[t("li",null,"Nacos Config Starter 默认为所有获取数据成功的 Nacos 的配置项添加了监听功能，在监听 到服务端配置发生变化时会实时触发 org.springframework.cloud.context.refresh.ContextRefresher 的 refresh 方法 。"),t("li",null,[r("如果需要对 Bean 进行动态刷新，请参照 Spring 和 Spring Cloud 规范。推荐给类添加**@RefreshScope** "),t("strong",null,"或"),r(),t("strong",null,"@ConfigurationProperties"),r(" 注解，")])])])])]),t("li",null,[t("p",null,[t("strong",null,"3、加载多配置文件")]),t("div",{class:"language-properties max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"properties"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," spring.cloud.nacos.config.server-addr"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=127.0.0.1:8848")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," spring.cloud.nacos.config.namespace"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=31098de9-fa28-41c9-b0bd-c754ce319ed4 ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," spring.cloud.nacos.config.ext-config[0]."),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"data-id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=gulimall-datasource.yml ")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," #动态刷新")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," spring.cloud.nacos.config.ext-config[0]."),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"refresh"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=false")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," spring.cloud.nacos.config.ext-config[0]."),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"group"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=dev")])])]),t("button",{class:"code-block-unfold-btn"})])]),t("li",null,[t("p",null,[t("strong",null,"4、namespace 与 group 最佳实践")]),t("ul",null,[t("li",null,"每个微服务创建自己的 namespace 进行隔离，group 来区分 dev，beta，prod 等环境")])])],-1)),l[307]||(l[307]=t("h2",{id:"gateway",tabindex:"-1"},[r("Gateway "),t("a",{class:"header-anchor",href:"#gateway","aria-label":'Permalink to "Gateway"'},"​")],-1)),l[308]||(l[308]=t("blockquote",null,[t("p",null,[t("a",{href:"https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.3.RELEASE/single/spring-cloud-gateway.html",target:"_blank",rel:"noreferrer"},"Spring Cloud Gateway")])],-1)),l[309]||(l[309]=t("ul",null,[t("li",null,[r("简介 "),t("ul",null,[t("li",null,"网关作为流量的入口，常用功能包括路由转发、权限校验、限流控制等。")])]),t("li",null,[r("特点 "),t("ul",null,[t("li",null,"基于 Spring5，支持响应式编程和 SpringBoot2.0"),t("li",null,"支持使用任何请求属性进行路由匹配"),t("li",null,"特定于路由的断言和过滤器"),t("li",null,"集成 Hystrix 进行断路保护"),t("li",null,"集成服务发现功能"),t("li",null,"易于编写 Predicates 和 Filters"),t("li",null,"支持请求速率限制"),t("li",null,"支持路径重写")])]),t("li",null,[r("API网关优点 "),t("ul",null,[t("li",null,"易于监控。可以在网关收集监控数据并将其推送到外部系统进行分析。"),t("li",null,"易于认证。可以在网关上进行认证，然后再将请求转发到后端的微服务，而无须在 每个微服务中进行认证。"),t("li",null,"减少了客户端与各个微服务之间的交互次数。")])]),t("li",null,[r("核心概率 "),t("ul",null,[t("li",null,[r("路由 "),t("ul",null,[t("li",null,"路由是网关最基础的部分，路由信息有一个 ID、一个目的 URL、一组断言和一组 Filter 组成。如果断言路由为真，则说明请求的 URL 和配置匹配")])]),t("li",null,[r("断言 "),t("ul",null,[t("li",null,"Java8 中的断言函数。Spring Cloud Gateway 中的断言函数输入类型是 Spring5.0 框 架中的 ServerWebExchange。Spring Cloud Gateway 中的断言函数允许开发者去定义匹配 来自于 http request 中的任何信息，比如请求头和参数等。")])]),t("li",null,[r("过滤器 "),t("ul",null,[t("li",null,"一个标准的 Spring webFilter。Spring cloud gateway 中的 filter 分为两种类型的 Filter，分别是 Gateway Filter 和 Global Filter。过滤器 Filter 将会对请求和响应进行修改 处理")])]),t("li",null,[t("strong",null,"满足某些断言（predicates）就路由到指定的地址（uri），使用指定的过滤器（filter）")])])])],-1)),l[310]||(l[310]=t("blockquote",null,[t("div",{class:"language-yaml max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"yaml"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"cloud"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}}," gateway"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"   routes"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        - "),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"test_route")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          uri"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"https://www.baidu.com")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          predicates"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            - "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"Query=url,baidu")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"       - "),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"product_route")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          uri"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"lb://gulimall-product")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          predicates"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            - "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"Path=/api/product/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          filters"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            - "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RewritePath=/api/?(?<segment>.*),/$\\{segment}")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"       - "),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"gulimall_host_route")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          uri"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"lb://gulimall-product")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          predicates"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            - "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"Host=gulimall.com,item.gulimall.com")])])]),t("button",{class:"code-block-unfold-btn"})])],-1)),l[311]||(l[311]=t("h2",{id:"feign",tabindex:"-1"},[r("Feign "),t("a",{class:"header-anchor",href:"#feign","aria-label":'Permalink to "Feign"'},"​")],-1)),l[312]||(l[312]=t("p",null,[t("strong",null,"Feign"),r(),t("strong",null,"声明式远程调用")],-1)),l[313]||(l[313]=t("ul",null,[t("li",null,[t("p",null,"简介"),t("ul",null,[t("li",null,"Feign 是一个声明式的 HTTP 客户端，它的目的就是让远程调用更加简单。"),t("li",null,[r("Feign 整合了 "),t("strong",null,"Ribbon（负载均衡）和 Hystrix(服务熔断)，")])])]),t("li",null,[t("p",null,[t("strong",null,"使用")]),t("ul",null,[t("li",null,[t("p",null,"1、引入依赖 spring-cloud-starter-openfeign")]),t("li",null,[t("p",null,"2、开启 feign 功能 @EnableFeignClients(basePackages = “com.atguigu.gulimall.member.feign”)")]),t("li",null,[t("p",null,"3、声明远程接口"),t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"* @Author zly")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"* @Date 2022/7/25 12:04")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"*/")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"FeignClient"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"gulimall-order"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," interface"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," OrderFeignService"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * 分页查询当前登录用户的所有订单信息")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," params")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," * "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," */")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/order/order/listWithItem"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"R "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"listWithItem"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestBody"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Map<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"params"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),t("span",{class:"line"}),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})])])])])],-1)),l[314]||(l[314]=t("h3",{id:"feign远程调用丢失请求头问题",tabindex:"-1"},[r("Feign远程调用丢失请求头问题 "),t("a",{class:"header-anchor",href:"#feign远程调用丢失请求头问题","aria-label":'Permalink to "Feign远程调用丢失请求头问题"'},"​")],-1)),l[315]||(l[315]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410205425533.png",alt:"image-20230410205425533",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[316]||(l[316]=t("h3",{id:"feign异步情况丢失上下文问题",tabindex:"-1"},[r("Feign异步情况丢失上下文问题 "),t("a",{class:"header-anchor",href:"#feign异步情况丢失上下文问题","aria-label":'Permalink to "Feign异步情况丢失上下文问题"'},"​")],-1)),l[317]||(l[317]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410205453081.png",alt:"image-20230410205453081",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[318]||(l[318]=t("h2",{id:"springcloud-alibaba-常用组件端口号总结",tabindex:"-1"},[r("SpringCloud Alibaba 常用组件端口号总结 "),t("a",{class:"header-anchor",href:"#springcloud-alibaba-常用组件端口号总结","aria-label":'Permalink to "SpringCloud Alibaba 常用组件端口号总结"'},"​")],-1)),l[319]||(l[319]=t("ul",null,[t("li",null,[t("p",null,"Nacos 默认端口号：8848"),t("div",{class:"language-properties max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"properties"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#*************** Spring Boot Related Configurations ***************#")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"### Default web context path:")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"server.servlet.contextPath"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=/nacos")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"### Default web server port:")]),r("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"server.port"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=8848")])])]),t("button",{class:"code-block-unfold-btn"})])]),t("li",null,[t("p",null,"Seata默认端口号：8091")]),t("li",null,[t("p",null,"Sentinel控制台默认运行在8080端口上")])],-1)),l[320]||(l[320]=t("blockquote",null,[t("p",null,"Elasticsearch 默认端口 9200 搜索引擎 不属于SpringCloud Alibaba")],-1)),l[321]||(l[321]=t("h2",{id:"支付",tabindex:"-1"},[r("支付 "),t("a",{class:"header-anchor",href:"#支付","aria-label":'Permalink to "支付"'},"​")],-1)),l[322]||(l[322]=t("h3",{id:"加密-对称加密",tabindex:"-1"},[r("加密-对称加密 "),t("a",{class:"header-anchor",href:"#加密-对称加密","aria-label":'Permalink to "加密-对称加密"'},"​")],-1)),l[323]||(l[323]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190257408.png",alt:"image-20230410190257408",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[324]||(l[324]=t("h3",{id:"加密-非对称加密",tabindex:"-1"},[r("加密-非对称加密 "),t("a",{class:"header-anchor",href:"#加密-非对称加密","aria-label":'Permalink to "加密-非对称加密"'},"​")],-1)),l[325]||(l[325]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190307734.png",alt:"image-20230410190307734",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[326]||(l[326]=t("h3",{id:"支付宝验签",tabindex:"-1"},[r("支付宝验签 "),t("a",{class:"header-anchor",href:"#支付宝验签","aria-label":'Permalink to "支付宝验签"'},"​")],-1)),l[327]||(l[327]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410201313818.png",alt:"image-20230410201313818",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[328]||(l[328]=t("h3",{id:"收单",tabindex:"-1"},[r("收单 "),t("a",{class:"header-anchor",href:"#收单","aria-label":'Permalink to "收单"'},"​")],-1)),l[329]||(l[329]=t("ul",null,[t("li",null,[r("1、订单在支付页，不支付，一直刷新，订单过期了才支付，订单状态改为已支付了，但是库存解锁了。 "),t("ul",null,[t("li",null,"使用支付宝自动收单功能解决。只要一段时间不支付，就不能支付了。")])]),t("li",null,[r("2、由于时延等问题。订单解锁完成，正在解锁库存的时候，异步通知才到 "),t("ul",null,[t("li",null,"订单解锁，手动调用收单")])]),t("li",null,[r("3、网络阻塞问题，订单支付成功的异步通知一直不到达 "),t("ul",null,[t("li",null,"查询订单列表时，ajax获取当前未支付的订单状态，查询订单状态时，再获取一下支付宝此订单的状态")])]),t("li",null,[r("4、其他各种问题 "),t("ul",null,[t("li",null,"每天晚上闲时下载支付宝对账单，一一进行对账")])])],-1)),l[330]||(l[330]=t("h2",{id:"md5-md5盐值加密",tabindex:"-1"},[r("MD5&MD5盐值加密 "),t("a",{class:"header-anchor",href:"#md5-md5盐值加密","aria-label":'Permalink to "MD5&MD5盐值加密"'},"​")],-1)),l[331]||(l[331]=t("ul",null,[t("li",null,[r("MD5 "),t("ul",null,[t("li",null,[r("Message Digest algorithm 5，信息摘要算法 "),t("ul",null,[t("li",null,"压缩性：任意长度的数据，算出的MD5值长度都是固定的。"),t("li",null,"容易计算：从原数据计算出MD5值很容易。"),t("li",null,"抗修改性：对原数据进行任何改动，哪怕只修改1个字节，所得到的MD5值都有很大区别。"),t("li",null,"强抗碰撞：想找到两个不同的数据，使它们具有相同的MD5值，是非常困难的。"),t("li",null,"不可逆")])])])]),t("li",null,[r("加盐： "),t("ul",null,[t("li",null,"通过生成随机数与MD5生成字符串进行组合"),t("li",null,"数据库同时存储MD5值与salt值。验证正确性时使用salt进行MD5即可")])])],-1)),l[332]||(l[332]=t("h2",{id:"项目微服务",tabindex:"-1"},[r("项目微服务 "),t("a",{class:"header-anchor",href:"#项目微服务","aria-label":'Permalink to "项目微服务"'},"​")],-1)),l[333]||(l[333]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191352836.png",alt:"image-20230410191352836",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[334]||(l[334]=t("h2",{id:"nginx-windows搭建域名访问环境",tabindex:"-1"},[r("Nginx+Windows搭建域名访问环境 "),t("a",{class:"header-anchor",href:"#nginx-windows搭建域名访问环境","aria-label":'Permalink to "Nginx+Windows搭建域名访问环境"'},"​")],-1)),l[335]||(l[335]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191454442.png",alt:"image-20230410191454442",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[336]||(l[336]=t("h3",{id:"域名映射效果",tabindex:"-1"},[r("域名映射效果 "),t("a",{class:"header-anchor",href:"#域名映射效果","aria-label":'Permalink to "域名映射效果"'},"​")],-1)),l[337]||(l[337]=t("ul",null,[t("li",null,"请求接口 gulimall.com"),t("li",null,"请求页面 gulimall.com"),t("li",null,"nginx直接代理给网关，网关判断"),t("li",null,"如果/api/****，转交给对应的服务器"),t("li",null,"如果是 满足域名，转交给对应的服务")],-1)),l[338]||(l[338]=t("h3",{id:"正向代理与反向代理",tabindex:"-1"},[r("正向代理与反向代理 "),t("a",{class:"header-anchor",href:"#正向代理与反向代理","aria-label":'Permalink to "正向代理与反向代理"'},"​")],-1)),l[339]||(l[339]=t("ul",null,[t("li",null,"正向代理：如科学上网，隐藏客户端信息")],-1)),l[340]||(l[340]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191634342.png",alt:"image-20230410191634342",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[341]||(l[341]=t("ul",null,[t("li",null,"反向代理：屏蔽内网服务器信息，负载均衡访问")],-1)),l[342]||(l[342]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191643706.png",alt:"image-20230410191643706",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[343]||(l[343]=t("h3",{id:"nginx配置文件",tabindex:"-1"},[r("Nginx配置文件 "),t("a",{class:"header-anchor",href:"#nginx配置文件","aria-label":'Permalink to "Nginx配置文件"'},"​")],-1)),l[344]||(l[344]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191710095.png",alt:"image-20230410191710095",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[345]||(l[345]=t("h3",{id:"nginx动静分离",tabindex:"-1"},[r("Nginx动静分离 "),t("a",{class:"header-anchor",href:"#nginx动静分离","aria-label":'Permalink to "Nginx动静分离"'},"​")],-1)),l[346]||(l[346]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191732131.png",alt:"image-20230410191732131",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[347]||(l[347]=t("h3",{id:"nginx转发效果",tabindex:"-1"},[r("Nginx转发效果 "),t("a",{class:"header-anchor",href:"#nginx转发效果","aria-label":'Permalink to "Nginx转发效果"'},"​")],-1)),l[348]||(l[348]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191756149.png",alt:"image-20230410191756149",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[349]||(l[349]=t("h2",{id:"内网穿透",tabindex:"-1"},[r("内网穿透 "),t("a",{class:"header-anchor",href:"#内网穿透","aria-label":'Permalink to "内网穿透"'},"​")],-1)),l[350]||(l[350]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190339367.png",alt:"image-20230410190339367",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[351]||(l[351]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190351905.png",alt:"image-20230410190351905",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[352]||(l[352]=t("h3",{id:"内网穿透联调",tabindex:"-1"},[r("内网穿透联调 "),t("a",{class:"header-anchor",href:"#内网穿透联调","aria-label":'Permalink to "内网穿透联调"'},"​")],-1)),l[353]||(l[353]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410190422986.png",alt:"image-20230410190422986",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[354]||(l[354]=t("h3",{id:"配置",tabindex:"-1"},[r("配置 "),t("a",{class:"header-anchor",href:"#配置","aria-label":'Permalink to "配置"'},"​")],-1)),l[355]||(l[355]=t("ul",null,[t("li",null,"Nginx配置")],-1)),l[356]||(l[356]=t("p",null,"…",-1)),l[357]||(l[357]=t("p",null,[r("listen 80; server_name gulimall.com *.gulimall.com 497n86m7k7.52http.net; #charset koi8-r; #access_log /var/log/nginx/log/host.access.log main; location /static/ { root /usr/share/nginx/html; } location /payed/ { proxy_set_header Host order.gulimall.com; proxy_pass "),t("a",{href:"http://gulimall",target:"_blank",rel:"noreferrer"},"http://gulimall"),r("; }")],-1)),l[358]||(l[358]=t("p",null,"…",-1)),l[359]||(l[359]=t("h2",{id:"缓存",tabindex:"-1"},[r("缓存 "),t("a",{class:"header-anchor",href:"#缓存","aria-label":'Permalink to "缓存"'},"​")],-1)),l[360]||(l[360]=t("h3",{id:"本地缓存",tabindex:"-1"},[r("本地缓存 "),t("a",{class:"header-anchor",href:"#本地缓存","aria-label":'Permalink to "本地缓存"'},"​")],-1)),l[361]||(l[361]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191857648.png",alt:"image-20230410191857648",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[362]||(l[362]=t("h3",{id:"分布式缓存-本地模式在分布式下的问题",tabindex:"-1"},[r("分布式缓存-本地模式在分布式下的问题 "),t("a",{class:"header-anchor",href:"#分布式缓存-本地模式在分布式下的问题","aria-label":'Permalink to "分布式缓存-本地模式在分布式下的问题"'},"​")],-1)),l[363]||(l[363]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410191940056.png",alt:"image-20230410191940056",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[364]||(l[364]=t("h3",{id:"分布式缓存",tabindex:"-1"},[r("分布式缓存 "),t("a",{class:"header-anchor",href:"#分布式缓存","aria-label":'Permalink to "分布式缓存"'},"​")],-1)),l[365]||(l[365]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192021777.png",alt:"image-20230410192021777",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[366]||(l[366]=t("h4",{id:"高并发下缓存失效问题-缓存穿透",tabindex:"-1"},[r("高并发下缓存失效问题-缓存穿透 "),t("a",{class:"header-anchor",href:"#高并发下缓存失效问题-缓存穿透","aria-label":'Permalink to "高并发下缓存失效问题-缓存穿透"'},"​")],-1)),l[367]||(l[367]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192133778.png",alt:"image-20230410192133778",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[368]||(l[368]=t("ul",null,[t("li",null,[t("strong",null,"缓存穿透"),r("： "),t("ul",null,[t("li",null,"指查询一个一定不存在的数据，由于缓存是不命中，将去查询数据库，但是数据库也无此记录，我们没有将这次查询的null写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义")])]),t("li",null,[t("strong",null,"风险"),r("： "),t("ul",null,[t("li",null,"利用不存在的数据进行攻击，数据库瞬时压力增大，最终导致崩溃")])]),t("li",null,[t("strong",null,"解决"),r("： "),t("ul",null,[t("li",null,"null结果缓存，并加入短暂过期时间")])])],-1)),l[369]||(l[369]=t("h4",{id:"高并发下缓存失效问题-缓存雪崩",tabindex:"-1"},[r("高并发下缓存失效问题-缓存雪崩 "),t("a",{class:"header-anchor",href:"#高并发下缓存失效问题-缓存雪崩","aria-label":'Permalink to "高并发下缓存失效问题-缓存雪崩"'},"​")],-1)),l[370]||(l[370]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192133778.png",alt:"image-20230410192133778",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[371]||(l[371]=t("ul",null,[t("li",null,[t("p",null,[t("strong",null,"缓存雪崩"),r("：")]),t("ul",null,[t("li",null,"缓存雪崩是指在我们设置缓存时key采用了相同的过期时间，导致缓存在某一时刻同时失效，请求全部转发到DB，DB瞬时压力过重雪崩。")])]),t("li",null,[t("p",null,[t("strong",null,"解决"),r("：")]),t("ul",null,[t("li",null,"原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。")])])],-1)),l[372]||(l[372]=t("h4",{id:"高并发下缓存失效问题-缓存击穿",tabindex:"-1"},[r("高并发下缓存失效问题-缓存击穿 "),t("a",{class:"header-anchor",href:"#高并发下缓存失效问题-缓存击穿","aria-label":'Permalink to "高并发下缓存失效问题-缓存击穿"'},"​")],-1)),l[373]||(l[373]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192628947.png",alt:"image-20230410192628947",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[374]||(l[374]=t("ul",null,[t("li",null,[t("p",null,[t("strong",null,"缓存穿透"),r("：")]),t("ul",null,[t("li",null,[r('对于一些设置了过期时间的key，如果这些key可能会在某些时间点被超高并发地访问，是一种非常"'),t("strong",null,"热点"),r('"的数据。如果这个key在大量请求同时进来前正好失效，那么所有对这个key的数据查询都落到db，我们称为缓存击穿。')])])]),t("li",null,[t("p",null,[t("strong",null,"解决"),r("：")]),t("ul",null,[t("li",null,[r("加锁 "),t("ul",null,[t("li",null,"大量并发只让一个去查，其他人等待，查到以后释放锁，其他人获取到锁，先查缓存，就会有数据，不用去db")])])])])],-1)),l[375]||(l[375]=t("h3",{id:"分布式下如何加锁",tabindex:"-1"},[r("分布式下如何加锁？ "),t("a",{class:"header-anchor",href:"#分布式下如何加锁","aria-label":'Permalink to "分布式下如何加锁？"'},"​")],-1)),l[376]||(l[376]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410192940277.png",alt:"image-20230410192940277",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[377]||(l[377]=t("ul",null,[t("li",null,"本地锁，只能锁住当前进程，所以我们需要分布式锁")],-1)),l[378]||(l[378]=t("h3",{id:"锁-时序问题",tabindex:"-1"},[r("锁-时序问题 "),t("a",{class:"header-anchor",href:"#锁-时序问题","aria-label":'Permalink to "锁-时序问题"'},"​")],-1)),l[379]||(l[379]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193041285.png",alt:"image-20230410193041285",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[380]||(l[380]=t("h3",{id:"分布式锁演进-基本原理",tabindex:"-1"},[r("分布式锁演进-基本原理 "),t("a",{class:"header-anchor",href:"#分布式锁演进-基本原理","aria-label":'Permalink to "分布式锁演进-基本原理"'},"​")],-1)),l[381]||(l[381]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193221079.png",alt:"image-20230410193221079",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[382]||(l[382]=t("blockquote",null,[t("p",null,"我们可以同时去一个地方“占坑”，如果占到，就执行逻辑。否则就必须等待，直到释放锁。 “占坑”可以去redis，可以去数据库，可以去任何大家都能访问的地方。 等待可以自旋的方式。")],-1)),l[383]||(l[383]=t("h4",{id:"分布式锁演进-阶段一",tabindex:"-1"},[r("分布式锁演进-阶段一 "),t("a",{class:"header-anchor",href:"#分布式锁演进-阶段一","aria-label":'Permalink to "分布式锁演进-阶段一"'},"​")],-1)),l[384]||(l[384]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193430589.png",alt:"image-20230410193430589",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[385]||(l[385]=t("h4",{id:"分布式锁演进-阶段二",tabindex:"-1"},[r("分布式锁演进-阶段二 "),t("a",{class:"header-anchor",href:"#分布式锁演进-阶段二","aria-label":'Permalink to "分布式锁演进-阶段二"'},"​")],-1)),l[386]||(l[386]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193552631.png",alt:"image-20230410193552631",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[387]||(l[387]=t("h4",{id:"分布式锁演进-阶段三",tabindex:"-1"},[r("分布式锁演进-阶段三 "),t("a",{class:"header-anchor",href:"#分布式锁演进-阶段三","aria-label":'Permalink to "分布式锁演进-阶段三"'},"​")],-1)),l[388]||(l[388]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193625611.png",alt:"image-20230410193625611",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[389]||(l[389]=t("h4",{id:"分布式锁演进-阶段四",tabindex:"-1"},[r("分布式锁演进-阶段四 "),t("a",{class:"header-anchor",href:"#分布式锁演进-阶段四","aria-label":'Permalink to "分布式锁演进-阶段四"'},"​")],-1)),l[390]||(l[390]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193648301.png",alt:"image-20230410193648301",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[391]||(l[391]=t("h4",{id:"分布式锁演进-阶段五-最终形态",tabindex:"-1"},[r("分布式锁演进-阶段五-最终形态 "),t("a",{class:"header-anchor",href:"#分布式锁演进-阶段五-最终形态","aria-label":'Permalink to "分布式锁演进-阶段五-最终形态"'},"​")],-1)),l[392]||(l[392]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193719776.png",alt:"image-20230410193719776",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[393]||(l[393]=t("h3",{id:"缓存数据一致性-双写模式",tabindex:"-1"},[r("缓存数据一致性-双写模式 "),t("a",{class:"header-anchor",href:"#缓存数据一致性-双写模式","aria-label":'Permalink to "缓存数据一致性-双写模式"'},"​")],-1)),l[394]||(l[394]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193831064.png",alt:"image-20230410193831064",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[395]||(l[395]=t("h3",{id:"缓存数据一致性-失效模式",tabindex:"-1"},[r("缓存数据一致性-失效模式 "),t("a",{class:"header-anchor",href:"#缓存数据一致性-失效模式","aria-label":'Permalink to "缓存数据一致性-失效模式"'},"​")],-1)),l[396]||(l[396]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410193909090.png",alt:"image-20230410193909090",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[397]||(l[397]=t("h3",{id:"缓存数据一致性-解决方案",tabindex:"-1"},[r("缓存数据一致性-解决方案 "),t("a",{class:"header-anchor",href:"#缓存数据一致性-解决方案","aria-label":'Permalink to "缓存数据一致性-解决方案"'},"​")],-1)),l[398]||(l[398]=t("ul",null,[t("li",null,[r("无论是双写模式还是失效模式，都会导致缓存的不一致问题。即多个实例同时更新会出事。怎么办？ "),t("ul",null,[t("li",null,"1、如果是用户纬度数据（订单数据、用户数据），这种并发几率非常小，不用考虑这个问题，缓存数据加上过期时间，每隔一段时间触发读的主动更新即可"),t("li",null,"2、如果是菜单，商品介绍等基础数据，也可以去使用canal订阅binlog的方式。"),t("li",null,"3、缓存数据+过期时间也足够解决大部分业务对于缓存的要求。"),t("li",null,"4、通过加锁保证并发读写，写写的时候按顺序排好队。读读无所谓。所以适合使用读写锁。（业务不关心脏数据，允许临时脏数据可忽略）；")])]),t("li",null,[r("总结： "),t("ul",null,[t("li",null,"我们能放入缓存的数据本就不应该是实时性、一致性要求超高的。所以缓存数据的时候加上过期时间，保证每天拿到当前最新数据即可。"),t("li",null,"我们不应该过度设计，增加系统的复杂性"),t("li",null,"遇到实时性、一致性要求高的数据，就应该查数据库，即使慢点。")])])],-1)),l[399]||(l[399]=t("h3",{id:"缓存数据一致性-解决-canal",tabindex:"-1"},[r("缓存数据一致性-解决-Canal "),t("a",{class:"header-anchor",href:"#缓存数据一致性-解决-canal","aria-label":'Permalink to "缓存数据一致性-解决-Canal"'},"​")],-1)),l[400]||(l[400]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410194458435.png",alt:"image-20230410194458435",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[401]||(l[401]=t("h2",{id:"session共享问题",tabindex:"-1"},[r("Session共享问题 "),t("a",{class:"header-anchor",href:"#session共享问题","aria-label":'Permalink to "Session共享问题"'},"​")],-1)),l[402]||(l[402]=t("h3",{id:"session原理",tabindex:"-1"},[r("session原理 "),t("a",{class:"header-anchor",href:"#session原理","aria-label":'Permalink to "session原理"'},"​")],-1)),l[403]||(l[403]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195022298.png",alt:"image-20230410195022298",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[404]||(l[404]=t("h3",{id:"分布式下session共享问题",tabindex:"-1"},[r("分布式下session共享问题 "),t("a",{class:"header-anchor",href:"#分布式下session共享问题","aria-label":'Permalink to "分布式下session共享问题"'},"​")],-1)),l[405]||(l[405]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195051946.png",alt:"image-20230410195051946",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[406]||(l[406]=t("h3",{id:"解决-session复制",tabindex:"-1"},[r("解决-session复制 "),t("a",{class:"header-anchor",href:"#解决-session复制","aria-label":'Permalink to "解决-session复制"'},"​")],-1)),l[407]||(l[407]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195126743.png",alt:"image-20230410195126743",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[408]||(l[408]=t("ul",null,[t("li",null,[r("优点 "),t("ul",null,[t("li",null,"web-server（Tomcat）原生支持，只需要修改配置文件")])]),t("li",null,[r("缺点 "),t("ul",null,[t("li",null,"session同步需要数据传输，占用大量网络带宽，降低了服务器群的业务处理能力"),t("li",null,"任意一台web-server保存的数据都是所有web-server的session总和，受到内存限制无法水平扩展更多的web-server"),t("li",null,"大型分布式集群情况下，由于所有web-server都全量保存数据，所以此方案不可取。")])])],-1)),l[409]||(l[409]=t("h3",{id:"解决-客户端存储",tabindex:"-1"},[r("解决-客户端存储 "),t("a",{class:"header-anchor",href:"#解决-客户端存储","aria-label":'Permalink to "解决-客户端存储"'},"​")],-1)),l[410]||(l[410]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195314820.png",alt:"image-20230410195314820",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[411]||(l[411]=t("ul",null,[t("li",null,[t("p",null,"优点"),t("ul",null,[t("li",null,"服务器不需存储session，用户保存自己的session信息到cookie中。节省服务端资源")])]),t("li",null,[t("p",null,"缺点"),t("ul",null,[t("li",null,"都是缺点，这只是一种思路。"),t("li",null,[r("具体如下： "),t("ul",null,[t("li",null,"每次http请求，携带用户在cookie中的完整信息，浪费网络带宽"),t("li",null,"session数据放在cookie中，cookie有长度限制4K，不能保存大量信息"),t("li",null,"session数据放在cookie中，存在泄漏、篡改、窃取等安全隐患")])])])]),t("li",null,[t("p",null,"这种方式不会使用。")])],-1)),l[412]||(l[412]=t("h3",{id:"解决-hash一致性",tabindex:"-1"},[r("解决-hash一致性 "),t("a",{class:"header-anchor",href:"#解决-hash一致性","aria-label":'Permalink to "解决-hash一致性"'},"​")],-1)),l[413]||(l[413]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195638892.png",alt:"image-20230410195638892",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[414]||(l[414]=t("ul",null,[t("li",null,[r("优点： "),t("ul",null,[t("li",null,"只需要改nginx配置，不需要修改应用代码"),t("li",null,"负载均衡，只要hash属性的值分布是均匀的，多台web-server的负载是均衡的"),t("li",null,"可以支持web-server水平扩展（session同步法是不行的，受内存限制）")])]),t("li",null,[r("缺点 "),t("ul",null,[t("li",null,"session还是存在web-server中的，所以web-server重启可能导致部分session丢失，影响业务，如部分用户需要重新登录"),t("li",null,"如果web-server水平扩展，rehash后session重新分布，也会有一部分用户路由不到正确的session")])]),t("li",null,"但是以上缺点问题也不是很大，因为session本来都是有有效期的。所以这两种反向代理的方式可以使用")],-1)),l[415]||(l[415]=t("h3",{id:"解决-统一存储",tabindex:"-1"},[r("解决-统一存储 "),t("a",{class:"header-anchor",href:"#解决-统一存储","aria-label":'Permalink to "解决-统一存储"'},"​")],-1)),l[416]||(l[416]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410195856602.png",alt:"image-20230410195856602",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[417]||(l[417]=t("ul",null,[t("li",null,[r("优点： "),t("ul",null,[t("li",null,"没有安全隐患"),t("li",null,"可以水平扩展，数据库/缓存水平切分即可"),t("li",null,"web-server重启或者扩容都不会有session丢失")])]),t("li",null,[r("不足 "),t("ul",null,[t("li",null,"增加了一次网络调用，并且需要修改应用代码；如将所有的getSession方法替换为从Redis查数据的方式。redis获取数据比内存慢很多"),t("li",null,"上面缺点可以用SpringSession完美解决")])])],-1)),l[418]||(l[418]=t("h3",{id:"解决-不同服务-子域session共享",tabindex:"-1"},[r("解决-不同服务，子域session共享 "),t("a",{class:"header-anchor",href:"#解决-不同服务-子域session共享","aria-label":'Permalink to "解决-不同服务，子域session共享"'},"​")],-1)),l[419]||(l[419]=t("blockquote",null,[t("p",null,"jsessionid这个cookie默认是当前系统域名的。当我们分拆服务，不同域名部署的时候，我们可以使用 如下解决方案；")],-1)),l[420]||(l[420]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410200123345.png",alt:"image-20230410200123345",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[421]||(l[421]=t("h3",{id:"springsession核心原理",tabindex:"-1"},[r("SpringSession核心原理 "),t("a",{class:"header-anchor",href:"#springsession核心原理","aria-label":'Permalink to "SpringSession核心原理"'},"​")],-1)),l[422]||(l[422]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410200156413.png",alt:"image-20230410200156413",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[423]||(l[423]=t("h2",{id:"购物车-1",tabindex:"-1"},[r("购物车 "),t("a",{class:"header-anchor",href:"#购物车-1","aria-label":'Permalink to "购物车"'},"​")],-1)),l[424]||(l[424]=t("h3",{id:"购物车数据结构",tabindex:"-1"},[r("购物车数据结构 "),t("a",{class:"header-anchor",href:"#购物车数据结构","aria-label":'Permalink to "购物车数据结构"'},"​")],-1)),l[425]||(l[425]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410200320343.png",alt:"image-20230410200320343",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[426]||(l[426]=t("blockquote",null,[t("ul",null,[t("li",null,"Map<String k1,Map<String k2,CartItemInfo>> 在redis中"),t("li",null,"k1：标识每一个用户的购物车 key:用户标识"),t("li",null,"k2：购物项的商品id value:Hash（k：商品id，v：购物项详情）")])],-1)),l[427]||(l[427]=t("h2",{id:"消息队列rabbitmq",tabindex:"-1"},[r("消息队列RabbitMQ "),t("a",{class:"header-anchor",href:"#消息队列rabbitmq","aria-label":'Permalink to "消息队列RabbitMQ"'},"​")],-1)),l[428]||(l[428]=t("h3",{id:"rabbitmq概念",tabindex:"-1"},[r("RabbitMQ概念 "),t("a",{class:"header-anchor",href:"#rabbitmq概念","aria-label":'Permalink to "RabbitMQ概念"'},"​")],-1)),l[429]||(l[429]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230410200724866.png",alt:"image-20230410200724866",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[430]||(l[430]=t("blockquote",null,[t("p",null,"rabbitmq 是一个开源的消息代理和队列服务器，通过普通的协议（Amqp 协议）来完成不同应用之间的数据共享，rabbitMq 是通过 erlang 语言来开发的基于 amqp 协议。")],-1)),l[431]||(l[431]=t("h3",{id:"什么amqp协议",tabindex:"-1"},[r("什么AMQP协议 "),t("a",{class:"header-anchor",href:"#什么amqp协议","aria-label":'Permalink to "什么AMQP协议"'},"​")],-1)),l[432]||(l[432]=t("ol",null,[t("li",null,"是一个二进制协议"),t("li",null,"amqp 是一个应用层协议的规范（定义了很多规范），可以有很多不同的消息中间件产品（需要遵循该规范）")],-1)),l[433]||(l[433]=t("ul",null,[t("li",null,[t("p",null,"server： 是消息队列节点")]),t("li",null,[t("p",null,"virtual host： 虚拟主机")]),t("li",null,[t("p",null,"exchange： 交换机（消息投递到交换机上）")]),t("li",null,[t("p",null,"message queue： 被消费者监听消息"),t("p",null,[t("code",null,"交换机和队列是有一个绑定的关系")])])],-1)),l[434]||(l[434]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310210242731.png",alt:"image-20230310210242731",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[435]||(l[435]=t("h3",{id:"amqp的核心概念",tabindex:"-1"},[r("AMQP的核心概念 "),t("a",{class:"header-anchor",href:"#amqp的核心概念","aria-label":'Permalink to "AMQP的核心概念"'},"​")],-1)),l[436]||(l[436]=t("ol",null,[t("li",null,"server ： 又称为broker，接受客户端连接，实现amqp实体服务"),t("li",null,"connection： 连接，应用程序与broker建立网络连接"),t("li",null,"channel： 网络通道，几乎所有的操作都是在 channel 中进行的，是进行消息对象的通道，客户端可以建立多个通道，每一个 channnel 表示一个会话任务。"),t("li",null,"Message： 服务器和应用程序之间传递数据的载体，有 properties（消息属性，用来修饰消息，比如消息的优先级，延时投递）和 Body （消息体）"),t("li",null,"virtual host（虚拟主机）：是一个逻辑概念，最上层的消息路由，一个虚拟主机中可以包含多个 exchange 和 queue 但是一个虚拟主机中不能有名称相同的 exchange 和 queue"),t("li",null,"exchange （交换机）： 消息直接投递到交换机上，然后交换机根据消息的路由 key 来路由到对应绑定的队列上。"),t("li",null,"binding （绑定）： 绑定 exchange 与 queue 的虚拟连接， binding 中可以包含route_key"),t("li",null,"route_key（路由key）：它的作用是在交换机上通过 route_key 来把消息路由到那个队列上。"),t("li",null,"queue 队列（队列）： 用来保存消息的载体，有消费者监听，然后消费消息。")],-1)),l[437]||(l[437]=t("h3",{id:"rabbitmq的消息是如何流转的",tabindex:"-1"},[r("RabbitMq的消息是如何流转的？ "),t("a",{class:"header-anchor",href:"#rabbitmq的消息是如何流转的","aria-label":'Permalink to "RabbitMq的消息是如何流转的？"'},"​")],-1)),l[438]||(l[438]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310210409545.png",alt:"image-20230310210409545",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[439]||(l[439]=t("h3",{id:"rabbitmq-交换机详解",tabindex:"-1"},[r("RabbitMq 交换机详解 "),t("a",{class:"header-anchor",href:"#rabbitmq-交换机详解","aria-label":'Permalink to "RabbitMq 交换机详解"'},"​")],-1)),l[440]||(l[440]=t("h4",{id:"作用",tabindex:"-1"},[t("strong",null,"作用"),r("： "),t("a",{class:"header-anchor",href:"#作用","aria-label":'Permalink to "**作用**："'},"​")],-1)),l[441]||(l[441]=t("ul",null,[t("li",null,"接受生产者的消息，然后根据路由键把消息投递到跟交换机绑定的对应的队列上。")],-1)),l[442]||(l[442]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310210717895.png",alt:"image-20230310210717895",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[443]||(l[443]=t("h4",{id:"交换机属性",tabindex:"-1"},[t("strong",null,"交换机属性"),r(),t("a",{class:"header-anchor",href:"#交换机属性","aria-label":'Permalink to "**交换机属性**"'},"​")],-1)),l[444]||(l[444]=t("ul",null,[t("li",null,"Name： 交换机名称"),t("li",null,"Type： 交换机类型，Direct、topic、fanout、headers"),t("li",null,"Durablity：是否需要持久化"),t("li",null,"autodelete： 假如没有队列绑定到该交换机，那么交换机会自动删除。"),t("li",null,"internal： 当前交换机交换机是否用户 RabbitMq 内部使用不常用，默认为false"),t("li",null,"Argurements： 扩展参数，用户扩展AMQP定制化协议。")],-1)),l[445]||(l[445]=t("h4",{id:"交换机类型",tabindex:"-1"},[r("交换机类型 "),t("a",{class:"header-anchor",href:"#交换机类型","aria-label":'Permalink to "交换机类型"'},"​")],-1)),l[446]||(l[446]=t("ul",null,[t("li",null,[t("strong",null,"直连交换机（Direct exchange）")])],-1)),l[447]||(l[447]=t("blockquote",null,[t("p",null,"所有发送的 Direct exchange 的消息都会被投递到与 Routekey名称（与队列名称）相同的queue上"),t("p",null,"direct 模式下，可以使用 RabbitMq 自定exchange —> default exchange 所以不需要交换机和任何队列绑定，消息将会投递到route_key名称和队列名称相同的队列上。")],-1)),l[448]||(l[448]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310211903967.png",alt:"image-20230310211903967",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[449]||(l[449]=t("ul",null,[t("li",null,[t("strong",null,"主题交换机 TopicExchange")])],-1)),l[450]||(l[450]=t("blockquote",null,[t("p",null,"就是在队列上绑到 top 交换机上的路由key 可以是通过通配符来匹配的通配符的规则是"),t("p",null,"比如：log.#: 可以是匹配一个单词 也可以匹配多个单词 比如 log.# 可以匹配log.a log.a.b log.* ： 可以匹配一个单词，比如log.* ，可以匹配log.a 但是不可以匹配log.a.b。")],-1)),l[451]||(l[451]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310211944528.png",alt:"image-20230310211944528",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[452]||(l[452]=t("ul",null,[t("li",null,[t("strong",null,"扇形交换机（fanout exchange）")])],-1)),l[453]||(l[453]=t("blockquote",null,[t("p",null,"就是消息通过丛交换机到队列上不会通过路由key 所以该模式的速度是最快的 只要和交换机绑定的那么消息就会被分发到与之绑定的队列上。")],-1)),l[454]||(l[454]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20230310212034909.png",alt:"mall",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[455]||(l[455]=t("h3",{id:"队列、绑定主机、消息",tabindex:"-1"},[t("strong",null,"队列、绑定主机、消息"),r(),t("a",{class:"header-anchor",href:"#队列、绑定主机、消息","aria-label":'Permalink to "**队列、绑定主机、消息**"'},"​")],-1)),l[456]||(l[456]=t("ul",null,[t("li",null,[t("p",null,"绑定： exchange 与 之间的连接关系（通过路由规则）")]),t("li",null,[t("p",null,"队列： 用来存储消息的实体")]),t("li",null,[t("p",null,"队列的属性： durablility 是否被持久化")]),t("li",null,[t("p",null,"AutoDelete： 表示最后一个监听被移除那么该队列就会删除。")]),t("li",null,[t("p",null,"消息： 用来生产者 和 消费者之间传递数据的")]),t("li",null,[t("p",null,"消息属性： 包括 消息体Body 和 属性 properties")]),t("li",null,[t("p",null,"常用属性： delivery mode,headers,content_type(消息类型) content_encoding（消息编码），priporty（消息优先级） correntlation_id( 最终消息唯一的ID)、reply_to(消息失败重回队列)，expiretion(消息的过期时 间),message_id(消息id);timestamp,type,user_id ，app_id,cluster_id等")])],-1))]),"main-header":k(()=>[n(s.$slots,"main-header")]),"main-header-after":k(()=>[n(s.$slots,"main-header-after")]),"main-nav":k(()=>[n(s.$slots,"main-nav")]),"main-content-before":k(()=>[n(s.$slots,"main-content-before")]),"main-content":k(()=>[n(s.$slots,"main-content")]),"main-content-after":k(()=>[n(s.$slots,"main-content-after")]),"main-nav-before":k(()=>[n(s.$slots,"main-nav-before")]),"main-nav-after":k(()=>[n(s.$slots,"main-nav-after")]),comment:k(()=>[n(s.$slots,"comment")]),footer:k(()=>[n(s.$slots,"footer")]),aside:k(()=>[n(s.$slots,"aside")]),"aside-custom":k(()=>[n(s.$slots,"aside-custom")]),default:k(()=>[n(s.$slots,"default")]),_:3},8,["frontmatter"])}}};export{y as default,d as usePageData};
