import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang.BOb0xH-1.js";import"./chunks/@vueuse/motion.BrTBiDBP.js";import{d as s,a as l,u as a}from"./chunks/vue-router.iuc03XPI.js";import{a1 as h,a3 as n,a4 as t,a5 as e,a6 as k,a7 as r,F as p,a2 as g,Z as E}from"./framework.CSpzLJwA.js";import"./app.DxsXqPDj.js";import"./chunks/dayjs.Dto65haK.js";import"./chunks/vue-i18n.C5QQbedb.js";import"./chunks/pinia.CKttsWmm.js";import"./chunks/nprogress.BEPa78Un.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.IawhXP3l.js";import"./index.TQnGKZgq.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.DIveis5r.js";import"./post.BWOv1eSm.js";const d=s("/posts/RabbitMQ",async i=>JSON.parse('{"title":"RabbitMQ 从入门到实战","description":"","frontmatter":{"title":"RabbitMQ 从入门到实战","top":99,"author":"imklaus","tags":["RabbitMQ"],"categories":["中间件"],"date":"2025-12-5 15:00:10","outline":"deep","excerpt_type":"html","postTitleClass":"text-#f49a31","end":false},"headers":[],"relativePath":"pages/posts/RabbitMQ.md","lastUpdated":null}'),{lazy:(i,s)=>i.name===s.name}),c={__name:"RabbitMQ",setup(s,{expose:c}){const{data:y}=d(),u=a(),o=l(),F=Object.assign(o.meta.frontmatter||{},y.value?.frontmatter||{});u.currentRoute.value.data=y.value,E("valaxy:frontmatter",F),globalThis.$frontmatter=F;return c({frontmatter:{title:"RabbitMQ 从入门到实战",top:99,author:"imklaus",tags:["RabbitMQ"],categories:["中间件"],date:"2025-12-5 15:00:10",outline:"deep",excerpt_type:"html",postTitleClass:"text-#f49a31",end:!1}}),(s,l)=>{const a=i;return g(),h(a,{frontmatter:p(F)},{"main-content-md":n(()=>[l[0]||(l[0]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/rabbitmq-beginners-updated.png",alt:"",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1]||(l[1]=e("p",null,[r("参考视频："),e("a",{href:"https://www.bilibili.com/video/BV1mN4y1Z7t9",target:"_blank",rel:"noreferrer"},"黑马RabbitMQ深入学习")],-1)),l[2]||(l[2]=e("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),l[3]||(l[3]=e("p",null,[e("strong",null,"目录指引"),r("：")],-1)),l[4]||(l[4]=e("nav",{class:"table-of-contents"},[e("ul",null,[e("li",null,[e("a",{href:"#服务异步通信-实用篇"},"服务异步通信-实用篇"),e("ul",null,[e("li",null,[e("a",{href:"#_1-初识mq"},"1. 初识MQ")]),e("li",null,[e("a",{href:"#_2-快速入门"},"2. 快速入门")]),e("li",null,[e("a",{href:"#_3-springamqp"},"3. SpringAMQP")])])]),e("li",null,[e("a",{href:"#rabbitmq部署指南"},"RabbitMQ部署指南"),e("ul",null,[e("li",null,[e("a",{href:"#_1-单机部署"},"1. 单机部署")]),e("li",null,[e("a",{href:"#_2-安装delayexchange插件"},"2. 安装DelayExchange插件")]),e("li",null,[e("a",{href:"#_3-集群部署"},"3. 集群部署")]),e("li",null,[e("a",{href:"#_4-镜像模式"},"4. 镜像模式")]),e("li",null,[e("a",{href:"#_5-仲裁队列"},"5. 仲裁队列")])])]),e("li",null,[e("a",{href:"#服务异步通信-高级篇"},"服务异步通信-高级篇"),e("ul",null,[e("li",null,[e("a",{href:"#_1-消息可靠性"},"1. 消息可靠性")]),e("li",null,[e("a",{href:"#_2-死信交换机"},"2. 死信交换机")]),e("li",null,[e("a",{href:"#_3-惰性队列"},"3. 惰性队列")]),e("li",null,[e("a",{href:"#_4-mq集群"},"4. MQ集群")])])])])],-1)),l[5]||(l[5]=e("h2",{id:"服务异步通信-实用篇",tabindex:"-1"},[r("服务异步通信-实用篇 "),e("a",{class:"header-anchor",href:"#服务异步通信-实用篇","aria-label":'Permalink to "服务异步通信-实用篇"'},"​")],-1)),l[6]||(l[6]=e("hr",null,null,-1)),l[7]||(l[7]=e("h3",{id:"_1-初识mq",tabindex:"-1"},[r("1. 初识MQ "),e("a",{class:"header-anchor",href:"#_1-初识mq","aria-label":'Permalink to "1. 初识MQ"'},"​")],-1)),l[8]||(l[8]=e("h4",{id:"_1-1-同步和异步通讯",tabindex:"-1"},[r("1.1 同步和异步通讯 "),e("a",{class:"header-anchor",href:"#_1-1-同步和异步通讯","aria-label":'Permalink to "1.1 同步和异步通讯"'},"​")],-1)),l[9]||(l[9]=e("p",null,"微服务间通讯有同步和异步两种方式：",-1)),l[10]||(l[10]=e("p",null,"同步通讯：就像打电话，需要实时响应。",-1)),l[11]||(l[11]=e("p",null,"异步通讯：就像发邮件，不需要马上回复。",-1)),k(" more "),l[12]||(l[12]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717161939695.png",alt:"image-20210717161939695",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[13]||(l[13]=e("p",null,"两种方式各有优劣，打电话可以立即得到响应，但是你却不能跟多个人同时通话。发送邮件可以同时与多个人收发邮件，但是往往响应会有延迟。",-1)),l[14]||(l[14]=e("h5",{id:"_1-1-1-同步通讯",tabindex:"-1"},[r("1.1.1 同步通讯 "),e("a",{class:"header-anchor",href:"#_1-1-1-同步通讯","aria-label":'Permalink to "1.1.1 同步通讯"'},"​")],-1)),l[15]||(l[15]=e("p",null,"我们之前学习的Feign调用就属于同步方式，虽然调用可以实时得到结果，但存在下面的问题：",-1)),l[16]||(l[16]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717162004285.png",alt:"image-20210717162004285",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[17]||(l[17]=e("p",null,"总结：",-1)),l[18]||(l[18]=e("p",null,"同步调用的优点：",-1)),l[19]||(l[19]=e("ul",null,[e("li",null,"时效性较强，可以立即得到结果")],-1)),l[20]||(l[20]=e("p",null,"同步调用的问题：",-1)),l[21]||(l[21]=e("ul",null,[e("li",null,"耦合度高"),e("li",null,"性能和吞吐能力下降"),e("li",null,"有额外的资源消耗"),e("li",null,"有级联失败问题")],-1)),l[22]||(l[22]=e("h5",{id:"_1-1-2-异步通讯",tabindex:"-1"},[r("1.1.2 异步通讯 "),e("a",{class:"header-anchor",href:"#_1-1-2-异步通讯","aria-label":'Permalink to "1.1.2 异步通讯"'},"​")],-1)),l[23]||(l[23]=e("p",null,"异步调用则可以避免上述问题：",-1)),l[24]||(l[24]=e("p",null,"我们以购买商品为例，用户支付后需要调用订单服务完成订单状态修改，调用物流服务，从仓库分配响应的库存并准备发货。",-1)),l[25]||(l[25]=e("p",null,"在事件模式中，支付服务是事件发布者（publisher），在支付完成后只需要发布一个支付成功的事件（event），事件中带上订单id。",-1)),l[26]||(l[26]=e("p",null,"订单服务和物流服务是事件订阅者（Consumer），订阅支付成功的事件，监听到事件后完成自己业务即可。",-1)),l[27]||(l[27]=e("p",null,"为了解除事件发布者与订阅者之间的耦合，两者并不是直接通信，而是有一个中间人（Broker）。发布者发布事件到Broker，不关心谁来订阅事件。订阅者从Broker订阅事件，不关心谁发来的消息。",-1)),l[28]||(l[28]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210422095356088.png",alt:"image-20210422095356088",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[29]||(l[29]=e("p",null,"Broker 是一个像数据总线一样的东西，所有的服务要接收数据和发送数据都发到这个总线上，这个总线就像协议一样，让服务间的通讯变得标准和可控。",-1)),l[30]||(l[30]=e("p",null,"好处：",-1)),l[31]||(l[31]=e("ul",null,[e("li",null,[e("p",null,"吞吐量提升：无需等待订阅者处理完成，响应更快速")]),e("li",null,[e("p",null,"故障隔离：服务没有直接调用，不存在级联失败问题")]),e("li",null,[e("p",null,"调用间没有阻塞，不会造成无效的资源占用")]),e("li",null,[e("p",null,"耦合度极低，每个服务都可以灵活插拔，可替换")]),e("li",null,[e("p",null,"流量削峰：不管发布事件的流量波动多大，都由Broker接收，订阅者可以按照自己的速度去处理事件")])],-1)),l[32]||(l[32]=e("p",null,"缺点：",-1)),l[33]||(l[33]=e("ul",null,[e("li",null,"架构复杂了，业务没有明显的流程线，不好管理"),e("li",null,"需要依赖于Broker的可靠、安全、性能")],-1)),l[34]||(l[34]=e("p",null,"好在现在开源软件或云平台上 Broker 的软件是非常成熟的，比较常见的一种就是我们今天要学习的MQ技术。",-1)),l[35]||(l[35]=e("h4",{id:"_1-2-技术对比",tabindex:"-1"},[r("1.2 技术对比： "),e("a",{class:"header-anchor",href:"#_1-2-技术对比","aria-label":'Permalink to "1.2 技术对比："'},"​")],-1)),l[36]||(l[36]=e("p",null,"MQ，中文是消息队列（MessageQueue），字面来看就是存放消息的队列。也就是事件驱动架构中的Broker。",-1)),l[37]||(l[37]=e("p",null,"比较常见的MQ实现：",-1)),l[38]||(l[38]=e("ul",null,[e("li",null,"ActiveMQ"),e("li",null,"RabbitMQ"),e("li",null,"RocketMQ"),e("li",null,"Kafka")],-1)),l[39]||(l[39]=e("p",null,"几种常见MQ的对比：",-1)),l[40]||(l[40]=e("table",null,[e("thead",null,[e("tr",null,[e("th"),e("th",null,[e("strong",null,"RabbitMQ")]),e("th",null,[e("strong",null,"ActiveMQ")]),e("th",null,[e("strong",null,"RocketMQ")]),e("th",null,[e("strong",null,"Kafka")])])]),e("tbody",null,[e("tr",null,[e("td",null,"公司/社区"),e("td",null,"Rabbit"),e("td",null,"Apache"),e("td",null,"阿里"),e("td",null,"Apache")]),e("tr",null,[e("td",null,"开发语言"),e("td",null,"Erlang"),e("td",null,"Java"),e("td",null,"Java"),e("td",null,"Scala&Java")]),e("tr",null,[e("td",null,"协议支持"),e("td",null,"AMQP，XMPP，SMTP，STOMP"),e("td",null,"OpenWire,STOMP，REST,XMPP,AMQP"),e("td",null,"自定义协议"),e("td",null,"自定义协议")]),e("tr",null,[e("td",null,"可用性"),e("td",null,"高"),e("td",null,"一般"),e("td",null,"高"),e("td",null,"高")]),e("tr",null,[e("td",null,"单机吞吐量"),e("td",null,"一般"),e("td",null,"差"),e("td",null,"高"),e("td",null,"非常高")]),e("tr",null,[e("td",null,"消息延迟"),e("td",null,"微秒级"),e("td",null,"毫秒级"),e("td",null,"毫秒级"),e("td",null,"毫秒以内")]),e("tr",null,[e("td",null,"消息可靠性"),e("td",null,"高"),e("td",null,"一般"),e("td",null,"高"),e("td",null,"一般")])])],-1)),l[41]||(l[41]=e("p",null,"追求可用性：Kafka、 RocketMQ 、RabbitMQ",-1)),l[42]||(l[42]=e("p",null,"追求可靠性：RabbitMQ、RocketMQ",-1)),l[43]||(l[43]=e("p",null,"追求吞吐能力：RocketMQ、Kafka",-1)),l[44]||(l[44]=e("p",null,"追求消息低延迟：RabbitMQ、Kafka",-1)),l[45]||(l[45]=e("hr",null,null,-1)),l[46]||(l[46]=e("h3",{id:"_2-快速入门",tabindex:"-1"},[r("2. 快速入门 "),e("a",{class:"header-anchor",href:"#_2-快速入门","aria-label":'Permalink to "2. 快速入门"'},"​")],-1)),l[47]||(l[47]=e("h4",{id:"_2-1-安装rabbitmq",tabindex:"-1"},[r("2.1 安装RabbitMQ "),e("a",{class:"header-anchor",href:"#_2-1-安装rabbitmq","aria-label":'Permalink to "2.1 安装RabbitMQ"'},"​")],-1)),l[48]||(l[48]=e("p",null,"安装RabbitMQ，参考课前资料：",-1)),l[49]||(l[49]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717162628635.png",alt:"image-20210717162628635",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[50]||(l[50]=e("p",null,"MQ的基本结构：",-1)),l[51]||(l[51]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717162752376.png",alt:"image-20210717162752376",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[52]||(l[52]=e("p",null,"RabbitMQ中的一些角色：",-1)),l[53]||(l[53]=e("ul",null,[e("li",null,"publisher：生产者"),e("li",null,"consumer：消费者"),e("li",null,"exchange个：交换机，负责消息路由"),e("li",null,"queue：队列，存储消息"),e("li",null,"virtualHost：虚拟主机，隔离不同租户的exchange、queue、消息的隔离")],-1)),l[54]||(l[54]=e("h4",{id:"_2-2-rabbitmq消息模型",tabindex:"-1"},[r("2.2 RabbitMQ消息模型 "),e("a",{class:"header-anchor",href:"#_2-2-rabbitmq消息模型","aria-label":'Permalink to "2.2 RabbitMQ消息模型"'},"​")],-1)),l[55]||(l[55]=e("p",null,"RabbitMQ官方提供了5个不同的Demo示例，对应了不同的消息模型：",-1)),l[56]||(l[56]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717163332646.png",alt:"image-20210717163332646",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[57]||(l[57]=e("h4",{id:"_2-3-导入demo工程",tabindex:"-1"},[r("2.3 导入Demo工程 "),e("a",{class:"header-anchor",href:"#_2-3-导入demo工程","aria-label":'Permalink to "2.3 导入Demo工程"'},"​")],-1)),l[58]||(l[58]=e("p",null,"课前资料提供了一个Demo工程，mq-demo:",-1)),l[59]||(l[59]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717163253264.png",alt:"image-20210717163253264",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[60]||(l[60]=e("p",null,"导入后可以看到结构如下：",-1)),l[61]||(l[61]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717163604330.png",alt:"image-20210717163604330",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[62]||(l[62]=e("p",null,"包括三部分：",-1)),l[63]||(l[63]=e("ul",null,[e("li",null,"mq-demo：父工程，管理项目依赖"),e("li",null,"publisher：消息的发送者"),e("li",null,"consumer：消息的消费者")],-1)),l[64]||(l[64]=e("h4",{id:"_2-4-入门案例",tabindex:"-1"},[r("2.4 入门案例 "),e("a",{class:"header-anchor",href:"#_2-4-入门案例","aria-label":'Permalink to "2.4 入门案例"'},"​")],-1)),l[65]||(l[65]=e("p",null,"简单队列模式的模型图：",-1)),l[66]||(l[66]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717163434647.png",alt:"image-20210717163434647",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[67]||(l[67]=e("p",null,"官方的HelloWorld是基于最基础的消息队列模型来实现的，只包括三个角色：",-1)),l[68]||(l[68]=e("ul",null,[e("li",null,"publisher：消息发布者，将消息发送到队列queue"),e("li",null,"queue：消息队列，负责接受并缓存消息"),e("li",null,"consumer：订阅队列，处理队列中的消息")],-1)),l[69]||(l[69]=e("h5",{id:"_2-4-1-publisher实现",tabindex:"-1"},[r("2.4.1 publisher实现 "),e("a",{class:"header-anchor",href:"#_2-4-1-publisher实现","aria-label":'Permalink to "2.4.1 publisher实现"'},"​")],-1)),l[70]||(l[70]=e("p",null,"思路：",-1)),l[71]||(l[71]=e("ul",null,[e("li",null,"建立连接"),e("li",null,"创建Channel"),e("li",null,"声明队列"),e("li",null,"发送消息"),e("li",null,"关闭连接和channel")],-1)),l[72]||(l[72]=e("p",null,"代码实现：",-1)),l[73]||(l[73]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.helloworld;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.rabbitmq.client.Channel;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.rabbitmq.client.Connection;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.rabbitmq.client.ConnectionFactory;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.Test;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.io.IOException;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.concurrent.TimeoutException;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," PublisherTest"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSendMessage"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IOException, TimeoutException {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.建立连接")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ConnectionFactory factory "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ConnectionFactory"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHost"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5672"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVirtualHost"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUsername"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"itcast"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPassword"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.2.建立连接")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Connection connection "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newConnection"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.创建通道Channel")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Channel channel "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," connection."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createChannel"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.创建队列")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String queueName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queueDeclare"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(queueName, "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.发送消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, rabbitmq!"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"basicPublish"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", queueName, "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBytes"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"发送消息成功：【"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 5.关闭通道和连接")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        connection."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[74]||(l[74]=e("h5",{id:"_2-4-2-consumer实现",tabindex:"-1"},[r("2.4.2 consumer实现 "),e("a",{class:"header-anchor",href:"#_2-4-2-consumer实现","aria-label":'Permalink to "2.4.2 consumer实现"'},"​")],-1)),l[75]||(l[75]=e("p",null,"代码思路：",-1)),l[76]||(l[76]=e("ul",null,[e("li",null,"建立连接"),e("li",null,"创建Channel"),e("li",null,"声明队列"),e("li",null,"订阅消息")],-1)),l[77]||(l[77]=e("p",null,"代码实现：",-1)),l[78]||(l[78]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.helloworld;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.rabbitmq.client."),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"*"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.io.IOException;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.concurrent.TimeoutException;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ConsumerTest"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," main"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"args"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IOException, TimeoutException {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.建立连接")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ConnectionFactory factory "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ConnectionFactory"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHost"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"192.168.150.101"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPort"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5672"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setVirtualHost"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setUsername"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"itcast"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPassword"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"123321"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.2.建立连接")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Connection connection "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," factory."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newConnection"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.创建通道Channel")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Channel channel "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," connection."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createChannel"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.创建队列")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String queueName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queueDeclare"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(queueName, "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.订阅消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"basicConsume"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(queueName, "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DefaultConsumer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(channel){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handleDelivery"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"consumerTag"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Envelope "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"envelope"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                       AMQP.BasicProperties "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"properties"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"byte"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"body"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IOException {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 5.处理消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                String message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(body);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"接收到消息：【"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"等待接收消息。。。。"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[79]||(l[79]=e("h4",{id:"_2-5-总结",tabindex:"-1"},[r("2.5 总结 "),e("a",{class:"header-anchor",href:"#_2-5-总结","aria-label":'Permalink to "2.5 总结"'},"​")],-1)),l[80]||(l[80]=e("p",null,"基本消息队列的消息发送流程：",-1)),l[81]||(l[81]=e("ol",null,[e("li",null,[e("p",null,"建立connection")]),e("li",null,[e("p",null,"创建channel")]),e("li",null,[e("p",null,"利用channel声明队列")]),e("li",null,[e("p",null,"利用channel向队列发送消息")])],-1)),l[82]||(l[82]=e("p",null,"基本消息队列的消息接收流程：",-1)),l[83]||(l[83]=e("ol",null,[e("li",null,[e("p",null,"建立connection")]),e("li",null,[e("p",null,"创建channel")]),e("li",null,[e("p",null,"利用channel声明队列")]),e("li",null,[e("p",null,"定义consumer的消费行为handleDelivery()")]),e("li",null,[e("p",null,"利用channel将消费者与队列绑定")])],-1)),l[84]||(l[84]=e("hr",null,null,-1)),l[85]||(l[85]=e("h3",{id:"_3-springamqp",tabindex:"-1"},[r("3. SpringAMQP "),e("a",{class:"header-anchor",href:"#_3-springamqp","aria-label":'Permalink to "3. SpringAMQP"'},"​")],-1)),l[86]||(l[86]=e("p",null,"SpringAMQP是基于RabbitMQ封装的一套模板，并且还利用SpringBoot对其实现了自动装配，使用起来非常方便。",-1)),l[87]||(l[87]=e("p",null,[r("SpringAmqp的官方地址："),e("a",{href:"https://spring.io/projects/spring-amqp",target:"_blank",rel:"noreferrer"},"https://spring.io/projects/spring-amqp")],-1)),l[88]||(l[88]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717164024967.png",alt:"image-20210717164024967",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[89]||(l[89]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717164038678.png",alt:"image-20210717164038678",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[90]||(l[90]=e("p",null,"SpringAMQP提供了三个功能：",-1)),l[91]||(l[91]=e("ul",null,[e("li",null,"自动声明队列、交换机及其绑定关系"),e("li",null,"基于注解的监听器模式，异步接收消息"),e("li",null,"封装了RabbitTemplate工具，用于发送消息")],-1)),l[92]||(l[92]=e("h4",{id:"_3-1-basic-queue-简单队列模型",tabindex:"-1"},[r("3.1 Basic Queue 简单队列模型 "),e("a",{class:"header-anchor",href:"#_3-1-basic-queue-简单队列模型","aria-label":'Permalink to "3.1 Basic Queue 简单队列模型"'},"​")],-1)),l[93]||(l[93]=e("p",null,"在父工程mq-demo中引入依赖",-1)),l[94]||(l[94]=e("div",{class:"language-xml max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"xml"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\x3c!--AMQP依赖，包含RabbitMQ--\x3e")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-amqp</"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[95]||(l[95]=e("h5",{id:"_3-1-1-消息发送",tabindex:"-1"},[r("3.1.1 消息发送 "),e("a",{class:"header-anchor",href:"#_3-1-1-消息发送","aria-label":'Permalink to "3.1.1 消息发送"'},"​")],-1)),l[96]||(l[96]=e("p",null,"首先配置MQ地址，在publisher服务的application.yml中添加配置：",-1)),l[97]||(l[97]=e("div",{class:"language-yaml max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"yaml"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    host"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"192.168.150.101"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 主机名")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    port"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5672"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 端口")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    virtual-host"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 虚拟主机")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    username"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"itcast"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 用户名")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    password"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 密码")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[98]||(l[98]=e("p",null,"然后在publisher服务中编写测试类SpringAmqpTest，并利用RabbitTemplate实现消息发送：",-1)),l[99]||(l[99]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.spring;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.Test;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.junit.runner.RunWith;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.core.RabbitTemplate;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.annotation.Autowired;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.boot.test.context.SpringBootTest;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.test.context.junit4.SpringRunner;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RunWith"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SpringRunner.class)")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SpringBootTest")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SpringAmqpTest"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RabbitTemplate rabbitTemplate;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSimpleQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 队列名称")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String queueName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, spring amqp!"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 发送消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        rabbitTemplate."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(queueName, message);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[100]||(l[100]=e("h5",{id:"_3-1-2-消息接收",tabindex:"-1"},[r("3.1.2 消息接收 "),e("a",{class:"header-anchor",href:"#_3-1-2-消息接收","aria-label":'Permalink to "3.1.2 消息接收"'},"​")],-1)),l[101]||(l[101]=e("p",null,"首先配置MQ地址，在consumer服务的application.yml中添加配置：",-1)),l[102]||(l[102]=e("div",{class:"language-yaml max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"yaml"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    host"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"192.168.150.101"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 主机名")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    port"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"5672"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 端口")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    virtual-host"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 虚拟主机")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    username"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"itcast"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 用户名")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    password"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 密码")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[103]||(l[103]=e("p",null,[r("然后在consumer服务的"),e("code",null,"cn.itcast.mq.listener"),r("包中新建一个类SpringRabbitListener，代码如下：")],-1)),l[104]||(l[104]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.listener;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.annotation.RabbitListener;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SpringRabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenSimpleQueueMessage"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"msg"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," InterruptedException {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"spring 消费者接收到消息：【"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[105]||(l[105]=e("h5",{id:"_3-1-3-测试",tabindex:"-1"},[r("3.1.3 测试 "),e("a",{class:"header-anchor",href:"#_3-1-3-测试","aria-label":'Permalink to "3.1.3 测试"'},"​")],-1)),l[106]||(l[106]=e("p",null,"启动consumer服务，然后在publisher服务中运行测试代码，发送MQ消息",-1)),l[107]||(l[107]=e("h4",{id:"_3-2-workqueue",tabindex:"-1"},[r("3.2 WorkQueue "),e("a",{class:"header-anchor",href:"#_3-2-workqueue","aria-label":'Permalink to "3.2 WorkQueue"'},"​")],-1)),l[108]||(l[108]=e("p",null,[r("Work queues，也被称为（Task queues），任务模型。简单来说就是"),e("strong",null,"让多个消费者绑定到一个队列，共同消费队列中的消息"),r("。")],-1)),l[109]||(l[109]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717164238910.png",alt:"image-20210717164238910",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[110]||(l[110]=e("p",null,"当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。",-1)),l[111]||(l[111]=e("p",null,"此时就可以使用work 模型，多个消费者共同处理消息处理，速度就能大大提高了。",-1)),l[112]||(l[112]=e("h5",{id:"_3-2-1-消息发送",tabindex:"-1"},[r("3.2.1 消息发送 "),e("a",{class:"header-anchor",href:"#_3-2-1-消息发送","aria-label":'Permalink to "3.2.1 消息发送"'},"​")],-1)),l[113]||(l[113]=e("p",null,"这次我们循环发送，模拟大量消息堆积现象。",-1)),l[114]||(l[114]=e("p",null,"在publisher服务中的SpringAmqpTest类中添加一个测试方法：",-1)),l[115]||(l[115]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * workQueue")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 向队列中不停发送消息，模拟消息堆积。")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testWorkQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws InterruptedException {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 队列名称")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String queueName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, message_"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 50"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"; i"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 发送消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        rabbitTemplate."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(queueName, message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," i);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Thread."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[116]||(l[116]=e("h5",{id:"_3-2-2-消息接收",tabindex:"-1"},[r("3.2.2 消息接收 "),e("a",{class:"header-anchor",href:"#_3-2-2-消息接收","aria-label":'Permalink to "3.2.2 消息接收"'},"​")],-1)),l[117]||(l[117]=e("p",null,"要模拟多个消费者绑定同一个队列，我们在consumer服务的SpringRabbitListener中添加2个新的方法：",-1)),l[118]||(l[118]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenWorkQueue1"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg) throws InterruptedException {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者1接收到消息：【"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalTime."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Thread."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenWorkQueue2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg) throws InterruptedException {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.err."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者2........接收到消息：【"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LocalTime."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"now"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Thread."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"200"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[119]||(l[119]=e("p",null,"注意到这个消费者sleep了1000秒，模拟任务耗时。",-1)),l[120]||(l[120]=e("h5",{id:"_3-2-3-测试",tabindex:"-1"},[r("3.2.3 测试 "),e("a",{class:"header-anchor",href:"#_3-2-3-测试","aria-label":'Permalink to "3.2.3 测试"'},"​")],-1)),l[121]||(l[121]=e("p",null,"启动ConsumerApplication后，在执行publisher服务中刚刚编写的发送测试方法testWorkQueue。",-1)),l[122]||(l[122]=e("p",null,"可以看到消费者1很快完成了自己的25条消息。消费者2却在缓慢的处理自己的25条消息。",-1)),l[123]||(l[123]=e("p",null,"也就是说消息是平均分配给每个消费者，并没有考虑到消费者的处理能力。这样显然是有问题的。",-1)),l[124]||(l[124]=e("h5",{id:"_3-2-4-能者多劳",tabindex:"-1"},[r("3.2.4 能者多劳 "),e("a",{class:"header-anchor",href:"#_3-2-4-能者多劳","aria-label":'Permalink to "3.2.4 能者多劳"'},"​")],-1)),l[125]||(l[125]=e("p",null,"在spring中有一个简单的配置，可以解决这个问题。我们修改consumer服务的application.yml文件，添加配置：",-1)),l[126]||(l[126]=e("div",{class:"language-yaml max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"yaml"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    listener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      simple"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        prefetch"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 每次只能获取一条消息，处理完成才能获取下一个消息")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[127]||(l[127]=e("h5",{id:"_3-2-5-总结",tabindex:"-1"},[r("3.2.5 总结 "),e("a",{class:"header-anchor",href:"#_3-2-5-总结","aria-label":'Permalink to "3.2.5 总结"'},"​")],-1)),l[128]||(l[128]=e("p",null,"Work模型的使用：",-1)),l[129]||(l[129]=e("ul",null,[e("li",null,"多个消费者绑定到一个队列，同一条消息只会被一个消费者处理"),e("li",null,"通过设置prefetch来控制消费者预取的消息数量")],-1)),l[130]||(l[130]=e("h4",{id:"_3-3-发布-订阅",tabindex:"-1"},[r("3.3 发布/订阅 "),e("a",{class:"header-anchor",href:"#_3-3-发布-订阅","aria-label":'Permalink to "3.3 发布/订阅"'},"​")],-1)),l[131]||(l[131]=e("p",null,"发布订阅的模型如图：",-1)),l[132]||(l[132]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717165309625.png",alt:"image-20210717165309625",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[133]||(l[133]=e("p",null,"可以看到，在订阅模型中，多了一个exchange角色，而且过程略有变化：",-1)),l[134]||(l[134]=e("ul",null,[e("li",null,"Publisher：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）"),e("li",null,[r("Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有以下3种类型： "),e("ul",null,[e("li",null,"Fanout：广播，将消息交给所有绑定到交换机的队列"),e("li",null,"Direct：定向，把消息交给符合指定routing key 的队列"),e("li",null,"Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列")])]),e("li",null,"Consumer：消费者，与以前一样，订阅队列，没有变化"),e("li",null,"Queue：消息队列也与以前一样，接收消息、缓存消息。")],-1)),l[135]||(l[135]=e("p",null,[e("strong",null,"Exchange（交换机）只负责转发消息，不具备存储消息的能力"),r("，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！")],-1)),l[136]||(l[136]=e("h4",{id:"_3-4-fanout",tabindex:"-1"},[r("3.4 Fanout "),e("a",{class:"header-anchor",href:"#_3-4-fanout","aria-label":'Permalink to "3.4 Fanout"'},"​")],-1)),l[137]||(l[137]=e("p",null,"Fanout，英文翻译是扇出，我觉得在MQ中叫广播更合适。",-1)),l[138]||(l[138]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717165438225.png",alt:"image-20210717165438225",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[139]||(l[139]=e("p",null,"在广播模式下，消息发送流程是这样的：",-1)),l[140]||(l[140]=e("ul",null,[e("li",null,"1） 可以有多个队列"),e("li",null,"2） 每个队列都要绑定到Exchange（交换机）"),e("li",null,"3） 生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定"),e("li",null,"4） 交换机把消息发送给绑定过的所有队列"),e("li",null,"5） 订阅队列的消费者都能拿到消息")],-1)),l[141]||(l[141]=e("p",null,"我们的计划是这样的：",-1)),l[142]||(l[142]=e("ul",null,[e("li",null,"创建一个交换机 itcast.fanout，类型是Fanout"),e("li",null,"创建两个队列fanout.queue1和fanout.queue2，绑定到交换机itcast.fanout")],-1)),l[143]||(l[143]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717165509466.png",alt:"image-20210717165509466",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[144]||(l[144]=e("h5",{id:"_3-4-1-声明队列和交换机",tabindex:"-1"},[r("3.4.1 声明队列和交换机 "),e("a",{class:"header-anchor",href:"#_3-4-1-声明队列和交换机","aria-label":'Permalink to "3.4.1 声明队列和交换机"'},"​")],-1)),l[145]||(l[145]=e("p",null,"Spring提供了一个接口Exchange，来表示所有不同类型的交换机：",-1)),l[146]||(l[146]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717165552676.png",alt:"image-20210717165552676",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[147]||(l[147]=e("p",null,"在consumer中创建一个类，声明队列和交换机：",-1)),l[148]||(l[148]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.config;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.Binding;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.BindingBuilder;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.FanoutExchange;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.Queue;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Bean;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Configuration;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," FanoutConfig"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 声明交换机")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," Fanout类型交换机")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," FanoutExchange "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fanoutExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," FanoutExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"itcast.fanout"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 第1个队列")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fanoutQueue1"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"fanout.queue1"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 绑定队列和交换机")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bindingQueue1"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Queue "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"fanoutQueue1"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", FanoutExchange "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"fanoutExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(fanoutQueue1)."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(fanoutExchange);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 第2个队列")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"fanoutQueue2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"fanout.queue2"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 绑定队列和交换机")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bindingQueue2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Queue "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"fanoutQueue2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", FanoutExchange "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"fanoutExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(fanoutQueue2)."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(fanoutExchange);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[149]||(l[149]=e("h5",{id:"_3-4-2-消息发送",tabindex:"-1"},[r("3.4.2.消息发送 "),e("a",{class:"header-anchor",href:"#_3-4-2-消息发送","aria-label":'Permalink to "3.4.2.消息发送"'},"​")],-1)),l[150]||(l[150]=e("p",null,"在publisher服务的SpringAmqpTest类中添加测试方法：",-1)),l[151]||(l[151]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testFanoutExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 队列名称")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String exchangeName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.fanout"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, everyone!"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(exchangeName, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[152]||(l[152]=e("h5",{id:"_3-4-3-消息接收",tabindex:"-1"},[r("3.4.3 消息接收 "),e("a",{class:"header-anchor",href:"#_3-4-3-消息接收","aria-label":'Permalink to "3.4.3 消息接收"'},"​")],-1)),l[153]||(l[153]=e("p",null,"在consumer服务的SpringRabbitListener中添加两个方法，作为消费者：",-1)),l[154]||(l[154]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "fanout.queue1"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenFanoutQueue1"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg) {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者1接收到Fanout消息：【"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "fanout.queue2"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenFanoutQueue2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg) {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者2接收到Fanout消息：【"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[155]||(l[155]=e("h5",{id:"_3-4-4-总结",tabindex:"-1"},[r("3.4.4 总结 "),e("a",{class:"header-anchor",href:"#_3-4-4-总结","aria-label":'Permalink to "3.4.4 总结"'},"​")],-1)),l[156]||(l[156]=e("p",null,"交换机的作用是什么？",-1)),l[157]||(l[157]=e("ul",null,[e("li",null,"接收publisher发送的消息"),e("li",null,"将消息按照规则路由到与之绑定的队列"),e("li",null,"不能缓存消息，路由失败，消息丢失"),e("li",null,"FanoutExchange的会将消息路由到每个绑定的队列")],-1)),l[158]||(l[158]=e("p",null,"声明队列、交换机、绑定关系的Bean是什么？",-1)),l[159]||(l[159]=e("ul",null,[e("li",null,"Queue"),e("li",null,"FanoutExchange"),e("li",null,"Binding")],-1)),l[160]||(l[160]=e("h4",{id:"_3-5-direct",tabindex:"-1"},[r("3.5 Direct "),e("a",{class:"header-anchor",href:"#_3-5-direct","aria-label":'Permalink to "3.5 Direct"'},"​")],-1)),l[161]||(l[161]=e("p",null,"在Fanout模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到Direct类型的Exchange。",-1)),l[162]||(l[162]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717170041447.png",alt:"image-20210717170041447",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[163]||(l[163]=e("p",null,"在Direct模型下：",-1)),l[164]||(l[164]=e("ul",null,[e("li",null,[r("队列与交换机的绑定，不能是任意绑定了，而是要指定一个"),e("code",null,"RoutingKey"),r("（路由key）")]),e("li",null,[r("消息的发送方在 向 Exchange发送消息时，也必须指定消息的 "),e("code",null,"RoutingKey"),r("。")]),e("li",null,[r("Exchange不再把消息交给每一个绑定的队列，而是根据消息的"),e("code",null,"Routing Key"),r("进行判断，只有队列的"),e("code",null,"Routingkey"),r("与消息的 "),e("code",null,"Routing key"),r("完全一致，才会接收到消息")])],-1)),l[165]||(l[165]=e("p",null,[e("strong",null,"案例需求如下"),r("：")],-1)),l[166]||(l[166]=e("ol",null,[e("li",null,[e("p",null,"利用@RabbitListener声明Exchange、Queue、RoutingKey")]),e("li",null,[e("p",null,"在consumer服务中，编写两个消费者方法，分别监听direct.queue1和direct.queue2")]),e("li",null,[e("p",null,"在publisher中编写测试方法，向itcast. direct发送消息")])],-1)),l[167]||(l[167]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717170223317.png",alt:"image-20210717170223317",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[168]||(l[168]=e("h5",{id:"_3-5-1-基于注解声明队列和交换机",tabindex:"-1"},[r("3.5.1 基于注解声明队列和交换机 "),e("a",{class:"header-anchor",href:"#_3-5-1-基于注解声明队列和交换机","aria-label":'Permalink to "3.5.1 基于注解声明队列和交换机"'},"​")],-1)),l[169]||(l[169]=e("p",null,"基于@Bean的方式声明队列和交换机比较麻烦，Spring还提供了基于注解方式来声明。",-1)),l[170]||(l[170]=e("p",null,"在consumer的SpringRabbitListener中添加两个消费者，同时基于注解来声明队列和交换机：",-1)),l[171]||(l[171]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"bindings"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"QueueBinding"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    value"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Queue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "direct.queue1"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    exchange"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Exchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"type"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExchangeTypes.DIRECT),")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    key"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"red"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"blue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenDirectQueue1"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者接收到direct.queue1的消息：【"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"bindings"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"QueueBinding"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    value"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Queue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "direct.queue2"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    exchange"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Exchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"type"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExchangeTypes.DIRECT),")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    key"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"red"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"yellow"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenDirectQueue2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者接收到direct.queue2的消息：【"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[172]||(l[172]=e("h5",{id:"_3-5-2-消息发送",tabindex:"-1"},[r("3.5.2 消息发送 "),e("a",{class:"header-anchor",href:"#_3-5-2-消息发送","aria-label":'Permalink to "3.5.2 消息发送"'},"​")],-1)),l[173]||(l[173]=e("p",null,"在publisher服务的SpringAmqpTest类中添加测试方法：",-1)),l[174]||(l[174]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSendDirectExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 交换机名称")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String exchangeName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "红色警报！日本乱排核废水，导致海洋生物变异，惊现哥斯拉！"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(exchangeName, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"red"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[175]||(l[175]=e("h5",{id:"_3-5-3-总结",tabindex:"-1"},[r("3.5.3 总结 "),e("a",{class:"header-anchor",href:"#_3-5-3-总结","aria-label":'Permalink to "3.5.3 总结"'},"​")],-1)),l[176]||(l[176]=e("p",null,"描述下Direct交换机与Fanout交换机的差异？",-1)),l[177]||(l[177]=e("ul",null,[e("li",null,"Fanout交换机将消息路由给每一个与之绑定的队列"),e("li",null,"Direct交换机根据RoutingKey判断路由给哪个队列"),e("li",null,"如果多个队列具有相同的RoutingKey，则与Fanout功能类似")],-1)),l[178]||(l[178]=e("p",null,"基于@RabbitListener注解声明队列和交换机有哪些常见注解？",-1)),l[179]||(l[179]=e("ul",null,[e("li",null,"@Queue"),e("li",null,"@Exchange")],-1)),l[180]||(l[180]=e("h4",{id:"_3-6-topic",tabindex:"-1"},[r("3.6 Topic "),e("a",{class:"header-anchor",href:"#_3-6-topic","aria-label":'Permalink to "3.6 Topic"'},"​")],-1)),l[181]||(l[181]=e("h5",{id:"_3-6-1-说明",tabindex:"-1"},[r("3.6.1 说明 "),e("a",{class:"header-anchor",href:"#_3-6-1-说明","aria-label":'Permalink to "3.6.1 说明"'},"​")],-1)),l[182]||(l[182]=e("p",null,[e("code",null,"Topic"),r("类型的"),e("code",null,"Exchange"),r("与"),e("code",null,"Direct"),r("相比，都是可以根据"),e("code",null,"RoutingKey"),r("把消息路由到不同的队列。只不过"),e("code",null,"Topic"),r("类型"),e("code",null,"Exchange"),r("可以让队列在绑定"),e("code",null,"Routing key"),r(" 的时候使用通配符！")],-1)),l[183]||(l[183]=e("p",null,[e("code",null,"Routingkey"),r(" 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： "),e("code",null,"item.insert")],-1)),l[184]||(l[184]=e("p",null,"通配符规则：",-1)),l[185]||(l[185]=e("p",null,[e("code",null,"#"),r("：匹配一个或多个词")],-1)),l[186]||(l[186]=e("p",null,[e("code",null,"*"),r("：匹配不多不少恰好1个词")],-1)),l[187]||(l[187]=e("p",null,"举例：",-1)),l[188]||(l[188]=e("p",null,[e("code",null,"item.#"),r("：能够匹配"),e("code",null,"item.spu.insert"),r(" 或者 "),e("code",null,"item.spu")],-1)),l[189]||(l[189]=e("p",null,[e("code",null,"item.*"),r("：只能匹配"),e("code",null,"item.spu")],-1)),l[190]||(l[190]=e("p",null,"​",-1)),l[191]||(l[191]=e("p",null,"图示：",-1)),l[192]||(l[192]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717170705380.png",alt:"image-20210717170705380",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[193]||(l[193]=e("p",null,"解释：",-1)),l[194]||(l[194]=e("ul",null,[e("li",null,[r("Queue1：绑定的是"),e("code",null,"china.#"),r(" ，因此凡是以 "),e("code",null,"china."),r("开头的"),e("code",null,"routing key"),r(" 都会被匹配到。包括china.news和china.weather")]),e("li",null,[r("Queue2：绑定的是"),e("code",null,"#.news"),r(" ，因此凡是以 "),e("code",null,".news"),r("结尾的 "),e("code",null,"routing key"),r(" 都会被匹配。包括china.news和japan.news")])],-1)),l[195]||(l[195]=e("p",null,"案例需求：",-1)),l[196]||(l[196]=e("p",null,"实现思路如下：",-1)),l[197]||(l[197]=e("ol",null,[e("li",null,[e("p",null,"并利用@RabbitListener声明Exchange、Queue、RoutingKey")]),e("li",null,[e("p",null,"在consumer服务中，编写两个消费者方法，分别监听topic.queue1和topic.queue2")]),e("li",null,[e("p",null,"在publisher中编写测试方法，向itcast. topic发送消息")])],-1)),l[198]||(l[198]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717170829229.png",alt:"image-20210717170829229",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[199]||(l[199]=e("h5",{id:"_3-6-2-消息发送",tabindex:"-1"},[r("3.6.2 消息发送 "),e("a",{class:"header-anchor",href:"#_3-6-2-消息发送","aria-label":'Permalink to "3.6.2 消息发送"'},"​")],-1)),l[200]||(l[200]=e("p",null,"在publisher服务的SpringAmqpTest类中添加测试方法：",-1)),l[201]||(l[201]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * topicExchange")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSendTopicExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 交换机名称")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String exchangeName "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.topic"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "喜报！孙悟空大战哥斯拉，胜!"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(exchangeName, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"china.news"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[202]||(l[202]=e("h5",{id:"_3-6-3-消息接收",tabindex:"-1"},[r("3.6.3 消息接收 "),e("a",{class:"header-anchor",href:"#_3-6-3-消息接收","aria-label":'Permalink to "3.6.3 消息接收"'},"​")],-1)),l[203]||(l[203]=e("p",null,"在consumer服务的SpringRabbitListener中添加方法：",-1)),l[204]||(l[204]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"bindings"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"QueueBinding"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    value"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Queue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "topic.queue1"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    exchange"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Exchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.topic"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"type"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExchangeTypes.TOPIC),")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    key"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "china.#"')]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenTopicQueue1"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者接收到topic.queue1的消息：【"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"bindings"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"QueueBinding"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    value"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Queue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "topic.queue2"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    exchange"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Exchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "itcast.topic"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"type"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ExchangeTypes.TOPIC),")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    key"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "#.news"')]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenTopicQueue2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者接收到topic.queue2的消息：【"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "】"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[205]||(l[205]=e("h5",{id:"_3-6-4-总结",tabindex:"-1"},[r("3.6.4 总结 "),e("a",{class:"header-anchor",href:"#_3-6-4-总结","aria-label":'Permalink to "3.6.4 总结"'},"​")],-1)),l[206]||(l[206]=e("p",null,"描述下Direct交换机与Topic交换机的差异？",-1)),l[207]||(l[207]=e("ul",null,[e("li",null,[r("Topic交换机接收的消息RoutingKey必须是多个单词，以 "),e("code",null,"**.**"),r(" 分割")]),e("li",null,"Topic交换机与队列绑定时的bindingKey可以指定通配符"),e("li",null,[e("code",null,"#"),r("：代表0个或多个词")]),e("li",null,[e("code",null,"*"),r("：代表1个词")])],-1)),l[208]||(l[208]=e("h4",{id:"_3-7-消息转换器",tabindex:"-1"},[r("3.7 消息转换器 "),e("a",{class:"header-anchor",href:"#_3-7-消息转换器","aria-label":'Permalink to "3.7 消息转换器"'},"​")],-1)),l[209]||(l[209]=e("p",null,"之前说过，Spring会把你发送的消息序列化为字节发送给MQ，接收消息的时候，还会把字节反序列化为Java对象。",-1)),l[210]||(l[210]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20200525170410401.png",alt:"image-20200525170410401",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[211]||(l[211]=e("p",null,"只不过，默认情况下Spring采用的序列化方式是JDK序列化。众所周知，JDK序列化存在下列问题：",-1)),l[212]||(l[212]=e("ul",null,[e("li",null,"数据体积过大"),e("li",null,"有安全漏洞"),e("li",null,"可读性差")],-1)),l[213]||(l[213]=e("p",null,"我们来测试一下。",-1)),l[214]||(l[214]=e("h5",{id:"_3-7-1-测试默认转换器",tabindex:"-1"},[r("3.7.1 测试默认转换器 "),e("a",{class:"header-anchor",href:"#_3-7-1-测试默认转换器","aria-label":'Permalink to "3.7.1 测试默认转换器"'},"​")],-1)),l[215]||(l[215]=e("p",null,"我们修改消息发送的代码，发送一个Map对象：",-1)),l[216]||(l[216]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSendMap"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws InterruptedException {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 准备消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> msg "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>();")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    msg."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Jack"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    msg."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"age"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"21"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"simple.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", msg);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[217]||(l[217]=e("p",null,"停止consumer服务",-1)),l[218]||(l[218]=e("p",null,"发送消息后查看控制台：",-1)),l[219]||(l[219]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210422232835363.png",alt:"image-20210422232835363",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[220]||(l[220]=e("h5",{id:"_3-7-2-配置json转换器",tabindex:"-1"},[r("3.7.2 配置JSON转换器 "),e("a",{class:"header-anchor",href:"#_3-7-2-配置json转换器","aria-label":'Permalink to "3.7.2 配置JSON转换器"'},"​")],-1)),l[221]||(l[221]=e("p",null,"显然，JDK序列化方式并不合适。我们希望消息体的体积更小、可读性更高，因此可以使用JSON方式来做序列化和反序列化。",-1)),l[222]||(l[222]=e("p",null,"在publisher和consumer两个服务中都引入依赖：",-1)),l[223]||(l[223]=e("div",{class:"language-xml max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"xml"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.fasterxml.jackson.dataformat</"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">jackson-dataformat-xml</"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">2.9.10</"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[224]||(l[224]=e("p",null,"配置消息转换器。",-1)),l[225]||(l[225]=e("p",null,"在启动类中添加一个Bean即可：",-1)),l[226]||(l[226]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MessageConverter "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"jsonMessageConverter"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Jackson2JsonMessageConverter"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[227]||(l[227]=e("hr",null,null,-1)),l[228]||(l[228]=e("div",{id:"section1"},null,-1)),l[229]||(l[229]=e("h2",{id:"rabbitmq部署指南",tabindex:"-1"},[r("RabbitMQ部署指南 "),e("a",{class:"header-anchor",href:"#rabbitmq部署指南","aria-label":'Permalink to "RabbitMQ部署指南"'},"​")],-1)),l[230]||(l[230]=e("hr",null,null,-1)),l[231]||(l[231]=e("h3",{id:"_1-单机部署",tabindex:"-1"},[r("1. 单机部署 "),e("a",{class:"header-anchor",href:"#_1-单机部署","aria-label":'Permalink to "1. 单机部署"'},"​")],-1)),l[232]||(l[232]=e("p",null,"我们在Centos7虚拟机中使用Docker来安装。",-1)),l[233]||(l[233]=e("h4",{id:"_1-1-下载镜像",tabindex:"-1"},[r("1.1 下载镜像 "),e("a",{class:"header-anchor",href:"#_1-1-下载镜像","aria-label":'Permalink to "1.1 下载镜像"'},"​")],-1)),l[234]||(l[234]=e("p",null,"方式一：在线拉取",-1)),l[235]||(l[235]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," pull"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq:3.8-management")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[236]||(l[236]=e("p",null,"方式二：从本地加载",-1)),l[237]||(l[237]=e("p",null,"在课前资料已经提供了镜像包：",-1)),l[238]||(l[238]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210423191210349.png",alt:"image-20210423191210349",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[239]||(l[239]=e("p",null,"上传到虚拟机中后，使用命令加载镜像即可：",-1)),l[240]||(l[240]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," load"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq.tar")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[241]||(l[241]=e("h4",{id:"_1-2-安装mq",tabindex:"-1"},[r("1.2 安装MQ "),e("a",{class:"header-anchor",href:"#_1-2-安装mq","aria-label":'Permalink to "1.2 安装MQ"'},"​")],-1)),l[242]||(l[242]=e("p",null,"执行下面的命令来运行MQ容器：",-1)),l[243]||(l[243]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," RABBITMQ_DEFAULT_USER=itcast"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -e"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," RABBITMQ_DEFAULT_PASS="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -v"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-plugins:/plugins"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --name"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --hostname"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 15672:15672"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 5672:5672"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq:3.8-management")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[244]||(l[244]=e("hr",null,null,-1)),l[245]||(l[245]=e("h3",{id:"_2-安装delayexchange插件",tabindex:"-1"},[r("2. 安装DelayExchange插件 "),e("a",{class:"header-anchor",href:"#_2-安装delayexchange插件","aria-label":'Permalink to "2. 安装DelayExchange插件"'},"​")],-1)),l[246]||(l[246]=e("p",null,[r("官方的安装指南地址为："),e("a",{href:"https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq",target:"_blank",rel:"noreferrer"},"https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq")],-1)),l[247]||(l[247]=e("p",null,"上述文档是基于linux原生安装RabbitMQ，然后安装插件。",-1)),l[248]||(l[248]=e("p",null,"因为我们之前是基于Docker安装RabbitMQ，所以下面我们会讲解基于Docker来安装RabbitMQ插件。",-1)),l[249]||(l[249]=e("h4",{id:"_2-1-下载插件",tabindex:"-1"},[r("2.1 下载插件 "),e("a",{class:"header-anchor",href:"#_2-1-下载插件","aria-label":'Permalink to "2.1 下载插件"'},"​")],-1)),l[250]||(l[250]=e("p",null,[r("RabbitMQ有一个官方的插件社区，地址为："),e("a",{href:"https://www.rabbitmq.com/community-plugins.html",target:"_blank",rel:"noreferrer"},"https://www.rabbitmq.com/community-plugins.html")],-1)),l[251]||(l[251]=e("p",null,"其中包含各种各样的插件，包括我们要使用的DelayExchange插件：",-1)),l[252]||(l[252]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210713104511055.png",alt:"image-20210713104511055",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[253]||(l[253]=e("p",null,[r("大家可以去对应的GitHub页面下载3.8.9版本的插件，地址为"),e("a",{href:"https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/tag/3.8.9%E8%BF%99%E4%B8%AA%E5%AF%B9%E5%BA%94RabbitMQ%E7%9A%843.8.5%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E3%80%82",target:"_blank",rel:"noreferrer"},"https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/tag/3.8.9这个对应RabbitMQ的3.8.5以上版本。")],-1)),l[254]||(l[254]=e("p",null,"课前资料也提供了下载好的插件：",-1)),l[255]||(l[255]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210713104808909.png",alt:"image-20210713104808909",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[256]||(l[256]=e("h4",{id:"_2-2-上传插件",tabindex:"-1"},[r("2.2 上传插件 "),e("a",{class:"header-anchor",href:"#_2-2-上传插件","aria-label":'Permalink to "2.2 上传插件"'},"​")],-1)),l[257]||(l[257]=e("p",null,"因为我们是基于Docker安装，所以需要先查看RabbitMQ的插件目录对应的数据卷。如果不是基于Docker的同学，请参考第一章部分，重新创建Docker容器。",-1)),l[258]||(l[258]=e("p",null,[r("我们之前设定的RabbitMQ的数据卷名称为"),e("code",null,"mq-plugins"),r("，所以我们使用下面命令查看数据卷：")],-1)),l[259]||(l[259]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," volume"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," inspect"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-plugins")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[260]||(l[260]=e("p",null,"可以得到下面结果：",-1)),l[261]||(l[261]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210713105135701.png",alt:"image-20210713105135701",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[262]||(l[262]=e("p",null,"接下来，将插件上传到这个目录即可：",-1)),l[263]||(l[263]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210713105339785.png",alt:"image-20210713105339785",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[264]||(l[264]=e("h4",{id:"_2-3-安装插件",tabindex:"-1"},[r("2.3 安装插件 "),e("a",{class:"header-anchor",href:"#_2-3-安装插件","aria-label":'Permalink to "2.3 安装插件"'},"​")],-1)),l[265]||(l[265]=e("p",null,[r("最后就是安装了，需要进入MQ容器内部来执行安装。我的容器名为"),e("code",null,"mq"),r("，所以执行下面命令：")],-1)),l[266]||(l[266]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," exec"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -it"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," bash")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[267]||(l[267]=e("p",null,[r("执行时，请将其中的 "),e("code",null,"-it"),r(" 后面的"),e("code",null,"mq"),r("替换为你自己的容器名.")],-1)),l[268]||(l[268]=e("p",null,"进入容器内部后，执行下面命令开启插件：",-1)),l[269]||(l[269]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmq-plugins"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," enable"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq_delayed_message_exchange")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[270]||(l[270]=e("p",null,"结果如下：",-1)),l[271]||(l[271]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210713105829435.png",alt:"image-20210713105829435",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[272]||(l[272]=e("hr",null,null,-1)),l[273]||(l[273]=e("h3",{id:"_3-集群部署",tabindex:"-1"},[r("3. 集群部署 "),e("a",{class:"header-anchor",href:"#_3-集群部署","aria-label":'Permalink to "3. 集群部署"'},"​")],-1)),l[274]||(l[274]=e("p",null,"接下来，我们看看如何安装RabbitMQ的集群。",-1)),l[275]||(l[275]=e("h4",{id:"_3-1-集群分类",tabindex:"-1"},[r("3.1 集群分类 "),e("a",{class:"header-anchor",href:"#_3-1-集群分类","aria-label":'Permalink to "3.1 集群分类"'},"​")],-1)),l[276]||(l[276]=e("p",null,"在RabbitMQ的官方文档中，讲述了两种集群的配置方式：",-1)),l[277]||(l[277]=e("ul",null,[e("li",null,"普通模式：普通模式集群不进行数据同步，每个MQ都有自己的队列、数据信息（其它元数据信息如交换机等会同步）。例如我们有2个MQ：mq1，和mq2，如果你的消息在mq1，而你连接到了mq2，那么mq2会去mq1拉取消息，然后返回给你。如果mq1宕机，消息就会丢失。"),e("li",null,"镜像模式：与普通模式不同，队列会在各个mq的镜像节点之间同步，因此你连接到任何一个镜像节点，均可获取到消息。而且如果一个节点宕机，并不会导致数据丢失。不过，这种方式增加了数据同步的带宽消耗。")],-1)),l[278]||(l[278]=e("p",null,"我们先来看普通模式集群，我们的计划部署3节点的mq集群：",-1)),l[279]||(l[279]=e("table",null,[e("thead",null,[e("tr",null,[e("th",null,"主机名"),e("th",null,"控制台端口"),e("th",null,"amqp通信端口")])]),e("tbody",null,[e("tr",null,[e("td",null,"mq1"),e("td",null,[e("code",null,"8081 ---\x3e 15672")]),e("td",null,[e("code",null,"8071 ---\x3e 5672")])]),e("tr",null,[e("td",null,"mq2"),e("td",null,[e("code",null,"8082 ---\x3e 15672")]),e("td",null,[e("code",null,"8072 ---\x3e 5672")])]),e("tr",null,[e("td",null,"mq3"),e("td",null,[e("code",null,"8083 ---\x3e 15672")]),e("td",null,[e("code",null,"8073 ---\x3e 5672")])])])],-1)),l[280]||(l[280]=e("p",null,[r("集群中的节点标示默认都是："),e("code",null,"rabbit@[hostname]"),r("，因此以上三个节点的名称分别为：")],-1)),l[281]||(l[281]=e("ul",null,[e("li",null,"rabbit@mq1"),e("li",null,"rabbit@mq2"),e("li",null,"rabbit@mq3")],-1)),l[282]||(l[282]=e("h4",{id:"_3-2-获取cookie",tabindex:"-1"},[r("3.2 获取cookie "),e("a",{class:"header-anchor",href:"#_3-2-获取cookie","aria-label":'Permalink to "3.2 获取cookie"'},"​")],-1)),l[283]||(l[283]=e("p",null,"RabbitMQ底层依赖于Erlang，而Erlang虚拟机就是一个面向分布式的语言，默认就支持集群模式。集群模式中的每个RabbitMQ 节点使用 cookie 来确定它们是否被允许相互通信。",-1)),l[284]||(l[284]=e("p",null,[r("要使两个节点能够通信，它们必须具有相同的共享秘密，称为"),e("strong",null,"Erlang cookie"),r("。cookie 只是一串最多 255 个字符的字母数字字符。")],-1)),l[285]||(l[285]=e("p",null,[r("每个集群节点必须具有"),e("strong",null,"相同的 cookie"),r("。实例之间也需要它来相互通信。")],-1)),l[286]||(l[286]=e("p",null,"我们先在之前启动的mq容器中获取一个cookie值，作为集群的cookie。执行下面的命令：",-1)),l[287]||(l[287]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," exec"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -it"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cat"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /var/lib/rabbitmq/.erlang.cookie")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[288]||(l[288]=e("p",null,"可以看到cookie值如下：",-1)),l[289]||(l[289]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"FXZMCVGLBIXZCDEMMVZQ")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[290]||(l[290]=e("p",null,"接下来，停止并删除当前的mq容器，我们重新搭建集群。",-1)),l[291]||(l[291]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rm"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -f"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[292]||(l[292]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717212345165.png",alt:"image-20210717212345165",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[293]||(l[293]=e("h4",{id:"_3-3-准备集群配置",tabindex:"-1"},[r("3.3 准备集群配置 "),e("a",{class:"header-anchor",href:"#_3-3-准备集群配置","aria-label":'Permalink to "3.3 准备集群配置"'},"​")],-1)),l[294]||(l[294]=e("p",null,"在/tmp目录新建一个配置文件 rabbitmq.conf：",-1)),l[295]||(l[295]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建文件")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"touch"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq.conf")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[296]||(l[296]=e("p",null,"文件内容如下：",-1)),l[297]||(l[297]=e("div",{class:"language-nginx max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"nginx"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"loopback_users."),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"guest"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = false")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"listeners.tcp."),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"default"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = 5672")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cluster_formation."),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"peer_discovery_backend"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = rabbit_peer_discovery_classic_config")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cluster_formation.classic_config.nodes."),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"1"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = rabbit@mq1")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cluster_formation.classic_config.nodes."),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = rabbit@mq2")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cluster_formation.classic_config.nodes."),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"3"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," = rabbit@mq3")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[298]||(l[298]=e("p",null,"再创建一个文件，记录cookie",-1)),l[299]||(l[299]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建cookie文件")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"touch"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 写入cookie")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"echo"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "FXZMCVGLBIXZCDEMMVZQ"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," >"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 修改cookie文件的权限")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"chmod"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 600"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[300]||(l[300]=e("p",null,"准备三个目录,mq1、mq2、mq3：",-1)),l[301]||(l[301]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建目录")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mkdir"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq2"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq3")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[302]||(l[302]=e("p",null,"然后拷贝rabbitmq.conf、cookie文件到mq1、mq2、mq3：",-1)),l[303]||(l[303]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 进入/tmp")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 拷贝")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq.conf"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq.conf"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq2")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmq.conf"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq3")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq2")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cp"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," .erlang.cookie"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq3")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[304]||(l[304]=e("h4",{id:"_3-4-启动集群",tabindex:"-1"},[r("3.4 启动集群 "),e("a",{class:"header-anchor",href:"#_3-4-启动集群","aria-label":'Permalink to "3.4 启动集群"'},"​")],-1)),l[305]||(l[305]=e("p",null,"创建一个网络：",-1)),l[306]||(l[306]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," network"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," create"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-net")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[307]||(l[307]=e("p",null,"docker volume create",-1)),l[308]||(l[308]=e("p",null,"运行命令",-1)),l[309]||(l[309]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --net"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-net"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/mq1/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_USER=itcast"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_PASS="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--name "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq1"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--hostname "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq1"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8071:5672"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8081:15672"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rabbitmq:3.8-management")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[310]||(l[310]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --net"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-net"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/mq2/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_USER=itcast"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_PASS="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--name "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq2"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--hostname "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq2"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8072:5672"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8082:15672"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rabbitmq:3.8-management")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[311]||(l[311]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --net"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-net"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/mq3/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_USER=itcast"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_PASS="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--name "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq3"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--hostname "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq3"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8073:5672"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8083:15672"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rabbitmq:3.8-management")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[312]||(l[312]=e("h4",{id:"_3-5-测试",tabindex:"-1"},[r("3.5 测试 "),e("a",{class:"header-anchor",href:"#_3-5-测试","aria-label":'Permalink to "3.5 测试"'},"​")],-1)),l[313]||(l[313]=e("p",null,"在mq1这个节点上添加一个队列：",-1)),l[314]||(l[314]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717222833196.png",alt:"image-20210717222833196",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[315]||(l[315]=e("p",null,"如图，在mq2和mq3两个控制台也都能看到：",-1)),l[316]||(l[316]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717223057902.png",alt:"image-20210717223057902",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[317]||(l[317]=e("h5",{id:"_3-5-1-数据共享测试",tabindex:"-1"},[r("3.5.1 数据共享测试 "),e("a",{class:"header-anchor",href:"#_3-5-1-数据共享测试","aria-label":'Permalink to "3.5.1 数据共享测试"'},"​")],-1)),l[318]||(l[318]=e("p",null,"点击这个队列，进入管理页面：",-1)),l[319]||(l[319]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717223421750.png",alt:"image-20210717223421750",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[320]||(l[320]=e("p",null,"然后利用控制台发送一条消息到这个队列：",-1)),l[321]||(l[321]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717223320238.png",alt:"image-20210717223320238",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[322]||(l[322]=e("p",null,"结果在mq2、mq3上都能看到这条消息：",-1)),l[323]||(l[323]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717223603628.png",alt:"image-20210717223603628",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[324]||(l[324]=e("h5",{id:"_3-5-2-可用性测试",tabindex:"-1"},[r("3.5.2 可用性测试 "),e("a",{class:"header-anchor",href:"#_3-5-2-可用性测试","aria-label":'Permalink to "3.5.2 可用性测试"'},"​")],-1)),l[325]||(l[325]=e("p",null,"我们让其中一台节点mq1宕机：",-1)),l[326]||(l[326]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[327]||(l[327]=e("p",null,"然后登录mq2或mq3的控制台，发现simple.queue也不可用了：",-1)),l[328]||(l[328]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717223800203.png",alt:"image-20210717223800203",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[329]||(l[329]=e("p",null,"说明数据并没有拷贝到mq2和mq3。",-1)),l[330]||(l[330]=e("hr",null,null,-1)),l[331]||(l[331]=e("h3",{id:"_4-镜像模式",tabindex:"-1"},[r("4. 镜像模式 "),e("a",{class:"header-anchor",href:"#_4-镜像模式","aria-label":'Permalink to "4. 镜像模式"'},"​")],-1)),l[332]||(l[332]=e("p",null,"在刚刚的案例中，一旦创建队列的主机宕机，队列就会不可用。不具备高可用能力。如果要解决这个问题，必须使用官方提供的镜像集群方案。",-1)),l[333]||(l[333]=e("p",null,[r("官方文档地址："),e("a",{href:"https://www.rabbitmq.com/ha.html",target:"_blank",rel:"noreferrer"},"https://www.rabbitmq.com/ha.html")],-1)),l[334]||(l[334]=e("h4",{id:"_4-1-镜像模式的特征",tabindex:"-1"},[r("4.1 镜像模式的特征 "),e("a",{class:"header-anchor",href:"#_4-1-镜像模式的特征","aria-label":'Permalink to "4.1 镜像模式的特征"'},"​")],-1)),l[335]||(l[335]=e("p",null,[r("默认情况下，队列只保存在创建该队列的节点上。而镜像模式下，创建队列的节点被称为该队列的"),e("strong",null,"主节点"),r("，队列还会拷贝到集群中的其它节点，也叫做该队列的"),e("strong",null,"镜像"),r("节点。")],-1)),l[336]||(l[336]=e("p",null,[r("但是，不同队列可以在集群中的任意节点上创建，因此不同队列的主节点可以不同。甚至，"),e("strong",null,"一个队列的主节点可能是另一个队列的镜像节点"),r("。")],-1)),l[337]||(l[337]=e("p",null,[r("用户发送给队列的一切请求，例如发送消息、消息回执默认都会在主节点完成，如果是从节点接收到请求，也会路由到主节点去完成。"),e("strong",null,"镜像节点仅仅起到备份数据作用"),r("。")],-1)),l[338]||(l[338]=e("p",null,"当主节点接收到消费者的ACK时，所有镜像都会删除节点中的数据。",-1)),l[339]||(l[339]=e("p",null,"总结如下：",-1)),l[340]||(l[340]=e("ul",null,[e("li",null,"镜像队列结构是一主多从（从就是镜像）"),e("li",null,"所有操作都是主节点完成，然后同步给镜像节点"),e("li",null,"主宕机后，镜像节点会替代成新的主（如果在主从同步完成前，主就已经宕机，可能出现数据丢失）"),e("li",null,"不具备负载均衡功能，因为所有操作都会有主节点完成（但是不同队列，其主节点可以不同，可以利用这个提高吞吐量）")],-1)),l[341]||(l[341]=e("h4",{id:"_4-2-镜像模式的配置",tabindex:"-1"},[r("4.2 镜像模式的配置 "),e("a",{class:"header-anchor",href:"#_4-2-镜像模式的配置","aria-label":'Permalink to "4.2 镜像模式的配置"'},"​")],-1)),l[342]||(l[342]=e("p",null,"镜像模式的配置有3种模式：",-1)),l[343]||(l[343]=e("table",null,[e("thead",null,[e("tr",null,[e("th",{style:{"text-align":"left"}},"ha-mode"),e("th",{style:{"text-align":"left"}},"ha-params"),e("th",{style:{"text-align":"left"}},"效果")])]),e("tbody",null,[e("tr",null,[e("td",{style:{"text-align":"left"}},"准确模式exactly"),e("td",{style:{"text-align":"left"}},"队列的副本量count"),e("td",{style:{"text-align":"left"}},"集群中队列副本（主服务器和镜像服务器之和）的数量。count如果为1意味着单个副本：即队列主节点。count值为2表示2个副本：1个队列主和1个队列镜像。换句话说：count = 镜像数量 + 1。如果群集中的节点数少于count，则该队列将镜像到所有节点。如果有集群总数大于count+1，并且包含镜像的节点出现故障，则将在另一个节点上创建一个新的镜像。")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"all"),e("td",{style:{"text-align":"left"}},"(none)"),e("td",{style:{"text-align":"left"}},"队列在群集中的所有节点之间进行镜像。队列将镜像到任何新加入的节点。镜像到所有节点将对所有群集节点施加额外的压力，包括网络I / O，磁盘I / O和磁盘空间使用情况。推荐使用exactly，设置副本数为（N / 2 +1）。")]),e("tr",null,[e("td",{style:{"text-align":"left"}},"nodes"),e("td",{style:{"text-align":"left"}},[e("em",null,"node names")]),e("td",{style:{"text-align":"left"}},"指定队列创建到哪些节点，如果指定的节点全部不存在，则会出现异常。如果指定的节点在集群中存在，但是暂时不可用，会创建节点到当前客户端连接到的节点。")])])],-1)),l[344]||(l[344]=e("p",null,"这里我们以rabbitmqctl命令作为案例来讲解配置语法。",-1)),l[345]||(l[345]=e("p",null,"语法示例：",-1)),l[346]||(l[346]=e("h5",{id:"_4-2-1-exactly模式",tabindex:"-1"},[r("4.2.1 exactly模式 "),e("a",{class:"header-anchor",href:"#_4-2-1-exactly模式","aria-label":'Permalink to "4.2.1 exactly模式"'},"​")],-1)),l[347]||(l[347]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," set_policy"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ha-two"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "^two\\."'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' \'{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}\'')])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[348]||(l[348]=e("ul",null,[e("li",null,[e("code",null,"rabbitmqctl set_policy"),r("：固定写法")]),e("li",null,[e("code",null,"ha-two"),r("：策略名称，自定义")]),e("li",null,[e("code",null,'"^two\\."'),r("：匹配队列的正则表达式，符合命名规则的队列才生效，这里是任何以"),e("code",null,"two."),r("开头的队列名称")]),e("li",null,[e("code",null,'\'{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}\''),r(": 策略内容 "),e("ul",null,[e("li",null,[e("code",null,'"ha-mode":"exactly"'),r("：策略模式，此处是exactly模式，指定副本数量")]),e("li",null,[e("code",null,'"ha-params":2'),r("：策略参数，这里是2，就是副本数量为2，1主1镜像")]),e("li",null,[e("code",null,'"ha-sync-mode":"automatic"'),r("：同步策略，默认是manual，即新加入的镜像节点不会同步旧的消息。如果设置为automatic，则新加入的镜像节点会把主节点中所有消息都同步，会带来额外的网络开销")])])])],-1)),l[349]||(l[349]=e("h5",{id:"_4-2-2-all模式",tabindex:"-1"},[r("4.2.2 all模式 "),e("a",{class:"header-anchor",href:"#_4-2-2-all模式","aria-label":'Permalink to "4.2.2 all模式"'},"​")],-1)),l[350]||(l[350]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," set_policy"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ha-all"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "^all\\."'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' \'{"ha-mode":"all"}\'')])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[351]||(l[351]=e("ul",null,[e("li",null,[e("code",null,"ha-all"),r("：策略名称，自定义")]),e("li",null,[e("code",null,'"^all\\."'),r("：匹配所有以"),e("code",null,"all."),r("开头的队列名")]),e("li",null,[e("code",null,'\'{"ha-mode":"all"}\''),r("：策略内容 "),e("ul",null,[e("li",null,[e("code",null,'"ha-mode":"all"'),r("：策略模式，此处是all模式，即所有节点都会称为镜像节点")])])])],-1)),l[352]||(l[352]=e("h5",{id:"_4-2-3-nodes模式",tabindex:"-1"},[r("4.2.3 nodes模式 "),e("a",{class:"header-anchor",href:"#_4-2-3-nodes模式","aria-label":'Permalink to "4.2.3 nodes模式"'},"​")],-1)),l[353]||(l[353]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," set_policy"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ha-nodes"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "^nodes\\."'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' \'{"ha-mode":"nodes","ha-params":["rabbit@nodeA", "rabbit@nodeB"]}\'')])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[354]||(l[354]=e("ul",null,[e("li",null,[e("code",null,"rabbitmqctl set_policy"),r("：固定写法")]),e("li",null,[e("code",null,"ha-nodes"),r("：策略名称，自定义")]),e("li",null,[e("code",null,'"^nodes\\."'),r("：匹配队列的正则表达式，符合命名规则的队列才生效，这里是任何以"),e("code",null,"nodes."),r("开头的队列名称")]),e("li",null,[e("code",null,'\'{"ha-mode":"nodes","ha-params":["rabbit@nodeA", "rabbit@nodeB"]}\''),r(": 策略内容 "),e("ul",null,[e("li",null,[e("code",null,'"ha-mode":"nodes"'),r("：策略模式，此处是nodes模式")]),e("li",null,[e("code",null,'"ha-params":["rabbit@mq1", "rabbit@mq2"]'),r("：策略参数，这里指定副本所在节点名称")])])])],-1)),l[355]||(l[355]=e("h4",{id:"_4-3-测试",tabindex:"-1"},[r("4.3 测试 "),e("a",{class:"header-anchor",href:"#_4-3-测试","aria-label":'Permalink to "4.3 测试"'},"​")],-1)),l[356]||(l[356]=e("p",null,"我们使用exactly模式的镜像，因为集群节点数量为3，因此镜像数量就设置为2.",-1)),l[357]||(l[357]=e("p",null,"运行下面的命令：",-1)),l[358]||(l[358]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," exec"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -it"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbitmqctl"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," set_policy"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ha-two"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "^two\\."'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' \'{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}\'')])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[359]||(l[359]=e("p",null,"下面，我们创建一个新的队列：",-1)),l[360]||(l[360]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717231751411.png",alt:"image-20210717231751411",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[361]||(l[361]=e("p",null,"在任意一个mq控制台查看队列：",-1)),l[362]||(l[362]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717231829505.png",alt:"image-20210717231829505",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[363]||(l[363]=e("h5",{id:"_4-3-1-测试数据共享",tabindex:"-1"},[r("4.3.1 测试数据共享 "),e("a",{class:"header-anchor",href:"#_4-3-1-测试数据共享","aria-label":'Permalink to "4.3.1 测试数据共享"'},"​")],-1)),l[364]||(l[364]=e("p",null,"给two.queue发送一条消息：",-1)),l[365]||(l[365]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717231958996.png",alt:"image-20210717231958996",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[366]||(l[366]=e("p",null,"然后在mq1、mq2、mq3的任意控制台查看消息：",-1)),l[367]||(l[367]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717232108584.png",alt:"image-20210717232108584",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[368]||(l[368]=e("h5",{id:"_4-3-2-测试高可用",tabindex:"-1"},[r("4.3.2 测试高可用 "),e("a",{class:"header-anchor",href:"#_4-3-2-测试高可用","aria-label":'Permalink to "4.3.2 测试高可用"'},"​")],-1)),l[369]||(l[369]=e("p",null,"现在，我们让two.queue的主节点mq1宕机：",-1)),l[370]||(l[370]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[371]||(l[371]=e("p",null,"查看集群状态：",-1)),l[372]||(l[372]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717232257420.png",alt:"image-20210717232257420",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[373]||(l[373]=e("p",null,"查看队列状态：",-1)),l[374]||(l[374]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717232322646.png",alt:"image-20210717232322646",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[375]||(l[375]=e("p",null,"发现依然是健康的！并且其主节点切换到了rabbit@mq2上",-1)),l[376]||(l[376]=e("hr",null,null,-1)),l[377]||(l[377]=e("h3",{id:"_5-仲裁队列",tabindex:"-1"},[r("5. 仲裁队列 "),e("a",{class:"header-anchor",href:"#_5-仲裁队列","aria-label":'Permalink to "5. 仲裁队列"'},"​")],-1)),l[378]||(l[378]=e("p",null,"从RabbitMQ 3.8版本开始，引入了新的仲裁队列，他具备与镜像队里类似的功能，但使用更加方便。",-1)),l[379]||(l[379]=e("h4",{id:"_5-1-添加仲裁队列",tabindex:"-1"},[r("5.1 添加仲裁队列 "),e("a",{class:"header-anchor",href:"#_5-1-添加仲裁队列","aria-label":'Permalink to "5.1 添加仲裁队列"'},"​")],-1)),l[380]||(l[380]=e("p",null,"在任意控制台添加一个队列，一定要选择队列类型为Quorum类型。",-1)),l[381]||(l[381]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717234329640.png",alt:"image-20210717234329640",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[382]||(l[382]=e("p",null,"在任意控制台查看队列：",-1)),l[383]||(l[383]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210717234426209.png",alt:"image-20210717234426209",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[384]||(l[384]=e("p",null,"可以看到，仲裁队列的 + 2字样。代表这个队列有2个镜像节点。",-1)),l[385]||(l[385]=e("p",null,"因为仲裁队列默认的镜像数为5。如果你的集群有7个节点，那么镜像数肯定是5；而我们集群只有3个节点，因此镜像数量就是3.",-1)),l[386]||(l[386]=e("h4",{id:"_5-2-测试",tabindex:"-1"},[r("5.2 测试 "),e("a",{class:"header-anchor",href:"#_5-2-测试","aria-label":'Permalink to "5.2 测试"'},"​")],-1)),l[387]||(l[387]=e("p",null,"可以参考对镜像集群的测试，效果是一样的。",-1)),l[388]||(l[388]=e("h4",{id:"_5-3-集群扩容",tabindex:"-1"},[r("5.3 集群扩容 "),e("a",{class:"header-anchor",href:"#_5-3-集群扩容","aria-label":'Permalink to "5.3 集群扩容"'},"​")],-1)),l[389]||(l[389]=e("h5",{id:"_5-3-1-加入集群",tabindex:"-1"},[r("5.3.1 加入集群 "),e("a",{class:"header-anchor",href:"#_5-3-1-加入集群","aria-label":'Permalink to "5.3.1 加入集群"'},"​")],-1)),l[390]||(l[390]=e("p",null,"1）启动一个新的MQ容器：",-1)),l[391]||(l[391]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --net"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq-net"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-v ${PWD}"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_USER=itcast"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"RABBITMQ_DEFAULT_PASS="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--name "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq4"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--hostname "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mq5"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8074:15672"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-p "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"8084:15672"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rabbitmq:3.8-management")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[392]||(l[392]=e("p",null,"2）进入容器控制台：",-1)),l[393]||(l[393]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," exec"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -it"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq4"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," bash")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[394]||(l[394]=e("p",null,"3）停止mq进程",-1)),l[395]||(l[395]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop_app")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[396]||(l[396]=e("p",null,"4）重置RabbitMQ中的数据：",-1)),l[397]||(l[397]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," reset")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[398]||(l[398]=e("p",null,"5）加入mq1：",-1)),l[399]||(l[399]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," join_cluster"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," rabbit@mq1")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[400]||(l[400]=e("p",null,"6）再次启动mq进程",-1)),l[401]||(l[401]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," start_app")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[402]||(l[402]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718001909492.png",alt:"image-20210718001909492",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[403]||(l[403]=e("h5",{id:"_5-3-2-增加仲裁队列副本",tabindex:"-1"},[r("5.3.2 增加仲裁队列副本 "),e("a",{class:"header-anchor",href:"#_5-3-2-增加仲裁队列副本","aria-label":'Permalink to "5.3.2 增加仲裁队列副本"'},"​")],-1)),l[404]||(l[404]=e("p",null,"我们先查看下quorum.queue这个队列目前的副本情况，进入mq1容器：",-1)),l[405]||(l[405]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," exec"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -it"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mq1"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," bash")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[406]||(l[406]=e("p",null,"执行命令：",-1)),l[407]||(l[407]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmq-queues"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," quorum_status"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "quorum.queue"')])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[408]||(l[408]=e("p",null,"结果：",-1)),l[409]||(l[409]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718002118357.png",alt:"image-20210718002118357",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[410]||(l[410]=e("p",null,"现在，我们让mq4也加入进来：",-1)),l[411]||(l[411]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmq-queues"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," add_member"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "quorum.queue"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "rabbit@mq4"')])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[412]||(l[412]=e("p",null,"结果：",-1)),l[413]||(l[413]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718002253226.png",alt:"image-20210718002253226",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[414]||(l[414]=e("p",null,"再次查看：",-1)),l[415]||(l[415]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmq-queues"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," quorum_status"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "quorum.queue"')])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[416]||(l[416]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718002342603.png",alt:"image-20210718002342603",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[417]||(l[417]=e("p",null,"查看控制台，发现quorum.queue的镜像数量也从原来的 +2 变成了 +3：",-1)),l[418]||(l[418]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718002422365.png",alt:"image-20210718002422365",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[419]||(l[419]=e("hr",null,null,-1)),l[420]||(l[420]=e("h2",{id:"服务异步通信-高级篇",tabindex:"-1"},[r("服务异步通信-高级篇 "),e("a",{class:"header-anchor",href:"#服务异步通信-高级篇","aria-label":'Permalink to "服务异步通信-高级篇"'},"​")],-1)),l[421]||(l[421]=e("p",null,"消息队列在使用过程中，面临着很多实际问题需要思考：",-1)),l[422]||(l[422]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718155003157.png",alt:"image-20210718155003157",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[423]||(l[423]=e("hr",null,null,-1)),l[424]||(l[424]=e("h3",{id:"_1-消息可靠性",tabindex:"-1"},[r("1. 消息可靠性 "),e("a",{class:"header-anchor",href:"#_1-消息可靠性","aria-label":'Permalink to "1. 消息可靠性"'},"​")],-1)),l[425]||(l[425]=e("p",null,"消息从发送，到消费者接收，会经理多个过程：",-1)),l[426]||(l[426]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718155059371.png",alt:"image-20210718155059371",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[427]||(l[427]=e("p",null,"其中的每一步都可能导致消息丢失，常见的丢失原因包括：",-1)),l[428]||(l[428]=e("ul",null,[e("li",null,[r("发送时丢失： "),e("ul",null,[e("li",null,"生产者发送的消息未送达exchange"),e("li",null,"消息到达exchange后未到达queue")])]),e("li",null,"MQ宕机，queue将消息丢失"),e("li",null,"consumer接收到消息后未消费就宕机")],-1)),l[429]||(l[429]=e("p",null,"针对这些问题，RabbitMQ分别给出了解决方案：",-1)),l[430]||(l[430]=e("ul",null,[e("li",null,"生产者确认机制"),e("li",null,"mq持久化"),e("li",null,"消费者确认机制"),e("li",null,"失败重试机制")],-1)),l[431]||(l[431]=e("p",null,"下面我们就通过案例来演示每一个步骤。",-1)),l[432]||(l[432]=e("p",null,"首先，导入课前资料提供的demo工程：",-1)),l[433]||(l[433]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718155328927.png",alt:"image-20210718155328927",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[434]||(l[434]=e("p",null,"项目结构如下：",-1)),l[435]||(l[435]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718155448734.png",alt:"image-20210718155448734",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[436]||(l[436]=e("h4",{id:"_1-1-生产者消息确认",tabindex:"-1"},[r("1.1 生产者消息确认 "),e("a",{class:"header-anchor",href:"#_1-1-生产者消息确认","aria-label":'Permalink to "1.1 生产者消息确认"'},"​")],-1)),l[437]||(l[437]=e("p",null,"RabbitMQ提供了publisher confirm机制来避免消息发送到MQ过程中丢失。这种机制必须给每个消息指定一个唯一ID。消息发送到MQ以后，会返回一个结果给发送者，表示消息是否处理成功。",-1)),l[438]||(l[438]=e("p",null,"返回结果有两种方式：",-1)),l[439]||(l[439]=e("ul",null,[e("li",null,[r("publisher-confirm，发送者确认 "),e("ul",null,[e("li",null,"消息成功投递到交换机，返回ack"),e("li",null,"消息未投递到交换机，返回nack")])]),e("li",null,[r("publisher-return，发送者回执 "),e("ul",null,[e("li",null,"消息投递到交换机了，但是没有路由到队列。返回ACK，及路由失败原因。")])])],-1)),l[440]||(l[440]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718160907166.png",alt:"image-20210718160907166",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[441]||(l[441]=e("p",null,"注意：",-1)),l[442]||(l[442]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718161707992.png",alt:"image-20210718161707992",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[443]||(l[443]=e("h5",{id:"_1-1-1-修改配置",tabindex:"-1"},[r("1.1.1 修改配置 "),e("a",{class:"header-anchor",href:"#_1-1-1-修改配置","aria-label":'Permalink to "1.1.1 修改配置"'},"​")],-1)),l[444]||(l[444]=e("p",null,"首先，修改publisher服务中的application.yml文件，添加下面的内容：",-1)),l[445]||(l[445]=e("div",{class:"language-yaml max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"yaml"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    publisher-confirm-type"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"correlated")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    publisher-returns"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    template"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      mandatory"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[446]||(l[446]=e("p",null,"说明：",-1)),l[447]||(l[447]=e("ul",null,[e("li",null,[e("code",null,"publish-confirm-type"),r("：开启publisher-confirm，这里支持两种类型： "),e("ul",null,[e("li",null,[e("code",null,"simple"),r("：同步等待confirm结果，直到超时")]),e("li",null,[e("code",null,"correlated"),r("：异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback")])])]),e("li",null,[e("code",null,"publish-returns"),r("：开启publish-return功能，同样是基于callback机制，不过是定义ReturnCallback")]),e("li",null,[e("code",null,"template.mandatory"),r("：定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息")])],-1)),l[448]||(l[448]=e("h5",{id:"_1-1-2-定义return回调",tabindex:"-1"},[r("1.1.2 定义Return回调 "),e("a",{class:"header-anchor",href:"#_1-1-2-定义return回调","aria-label":'Permalink to "1.1.2 定义Return回调"'},"​")],-1)),l[449]||(l[449]=e("p",null,"每个RabbitTemplate只能配置一个ReturnCallback，因此需要在项目加载时配置：",-1)),l[450]||(l[450]=e("p",null,"修改publisher服务，添加一个：",-1)),l[451]||(l[451]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.config;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lombok.extern.slf4j.Slf4j;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.core.RabbitTemplate;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.BeansException;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.ApplicationContext;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.ApplicationContextAware;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Configuration;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Slf4j")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CommonConfig"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ApplicationContextAware"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setApplicationContext"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ApplicationContext "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"applicationContext"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BeansException {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取RabbitTemplate")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        RabbitTemplate rabbitTemplate "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," applicationContext."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBean"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RabbitTemplate.class);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 设置ReturnCallback")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        rabbitTemplate."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setReturnCallback"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"((message, replyCode, replyText, exchange, routingKey) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 投递失败，记录日志")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消息发送失败，应答码{}，原因{}，交换机{}，路由键{},消息{}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                     replyCode, replyText, exchange, routingKey, message."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果有业务需要，可以重发消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[452]||(l[452]=e("h5",{id:"_1-1-3-定义confirmcallback",tabindex:"-1"},[r("1.1.3 定义ConfirmCallback "),e("a",{class:"header-anchor",href:"#_1-1-3-定义confirmcallback","aria-label":'Permalink to "1.1.3 定义ConfirmCallback"'},"​")],-1)),l[453]||(l[453]=e("p",null,"ConfirmCallback可以在发送消息时指定，因为每个业务处理confirm成功或失败的逻辑不一定相同。",-1)),l[454]||(l[454]=e("p",null,"在publisher服务的cn.itcast.mq.spring.SpringAmqpTest类中，定义一个单元测试方法：",-1)),l[455]||(l[455]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testSendMessage2SimpleQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws InterruptedException {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.消息体")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, spring amqp!"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.全局唯一的消息ID，需要封装到CorrelationData中")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CorrelationData correlationData "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CorrelationData"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UUID."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomUUID"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 3.添加callback")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    correlationData."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getFuture"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addCallback"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isAck"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 3.1.ack，消息成功")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消息发送成功, ID:{}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", correlationData."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 3.2.nack，消息失败")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消息发送失败, ID:{}, 原因{}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",correlationData."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), result."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getReason"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        },")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ex "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消息发送异常, ID:{}, 原因{}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",correlationData."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),ex."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessage"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    );")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 4.发送消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"task.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"task"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message, correlationData);")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 休眠一会儿，等待ack回执")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Thread."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sleep"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2000"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[456]||(l[456]=e("h4",{id:"_1-2-消息持久化",tabindex:"-1"},[r("1.2 消息持久化 "),e("a",{class:"header-anchor",href:"#_1-2-消息持久化","aria-label":'Permalink to "1.2 消息持久化"'},"​")],-1)),l[457]||(l[457]=e("p",null,"生产者确认可以确保消息投递到RabbitMQ的队列中，但是消息发送到RabbitMQ以后，如果突然宕机，也可能导致消息丢失。",-1)),l[458]||(l[458]=e("p",null,"要想确保消息在RabbitMQ中安全保存，必须开启消息持久化机制。",-1)),l[459]||(l[459]=e("ul",null,[e("li",null,"交换机持久化"),e("li",null,"队列持久化"),e("li",null,"消息持久化")],-1)),l[460]||(l[460]=e("h5",{id:"_1-2-1-交换机持久化",tabindex:"-1"},[r("1.2.1 交换机持久化 "),e("a",{class:"header-anchor",href:"#_1-2-1-交换机持久化","aria-label":'Permalink to "1.2.1 交换机持久化"'},"​")],-1)),l[461]||(l[461]=e("p",null,"RabbitMQ中交换机默认是非持久化的，mq重启后就丢失。",-1)),l[462]||(l[462]=e("p",null,"SpringAMQP中可以通过代码指定交换机持久化：",-1)),l[463]||(l[463]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DirectExchange "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"simpleExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DirectExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"simple.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[464]||(l[464]=e("p",null,"事实上，默认情况下，由SpringAMQP声明的交换机都是持久化的。",-1)),l[465]||(l[465]=e("p",null,[r("可以在RabbitMQ控制台看到持久化的交换机都会带上"),e("code",null,"D"),r("的标示：")],-1)),l[466]||(l[466]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718164412450.png",alt:"image-20210718164412450",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[467]||(l[467]=e("h5",{id:"_1-2-2-队列持久化",tabindex:"-1"},[r("1.2.2 队列持久化 "),e("a",{class:"header-anchor",href:"#_1-2-2-队列持久化","aria-label":'Permalink to "1.2.2 队列持久化"'},"​")],-1)),l[468]||(l[468]=e("p",null,"RabbitMQ中队列默认是非持久化的，mq重启后就丢失。",-1)),l[469]||(l[469]=e("p",null,"SpringAMQP中可以通过代码指定交换机持久化：",-1)),l[470]||(l[470]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"simpleQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 使用QueueBuilder构建队列，durable就是持久化的")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueueBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"durable"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"simple.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[471]||(l[471]=e("p",null,"事实上，默认情况下，由SpringAMQP声明的队列都是持久化的。",-1)),l[472]||(l[472]=e("p",null,[r("可以在RabbitMQ控制台看到持久化的队列都会带上"),e("code",null,"D"),r("的标示：")],-1)),l[473]||(l[473]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718164729543.png",alt:"image-20210718164729543",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[474]||(l[474]=e("h5",{id:"_1-2-3-消息持久化",tabindex:"-1"},[r("1.2.3 消息持久化 "),e("a",{class:"header-anchor",href:"#_1-2-3-消息持久化","aria-label":'Permalink to "1.2.3 消息持久化"'},"​")],-1)),l[475]||(l[475]=e("p",null,"利用SpringAMQP发送消息时，可以设置消息的属性（MessageProperties），指定delivery-mode：",-1)),l[476]||(l[476]=e("ul",null,[e("li",null,"1：非持久化"),e("li",null,"2：持久化")],-1)),l[477]||(l[477]=e("p",null,"用java代码指定：",-1)),l[478]||(l[478]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718165100016.png",alt:"image-20210718165100016",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[479]||(l[479]=e("p",null,"默认情况下，SpringAMQP发出的任何消息都是持久化的，不用特意指定。",-1)),l[480]||(l[480]=e("h4",{id:"_1-3-消费者消息确认",tabindex:"-1"},[r("1.3 消费者消息确认 "),e("a",{class:"header-anchor",href:"#_1-3-消费者消息确认","aria-label":'Permalink to "1.3 消费者消息确认"'},"​")],-1)),l[481]||(l[481]=e("p",null,[r("RabbitMQ是"),e("strong",null,"阅后即焚"),r("机制，RabbitMQ确认消息被消费者消费后会立刻删除。")],-1)),l[482]||(l[482]=e("p",null,"而RabbitMQ是通过消费者回执来确认消费者是否成功处理消息的：消费者获取消息后，应该向RabbitMQ发送ACK回执，表明自己已经处理消息。",-1)),l[483]||(l[483]=e("p",null,"设想这样的场景：",-1)),l[484]||(l[484]=e("ol",null,[e("li",null,"RabbitMQ投递消息给消费者"),e("li",null,"消费者获取消息后，返回ACK给RabbitMQ"),e("li",null,"RabbitMQ删除消息"),e("li",null,"消费者宕机，消息尚未处理")],-1)),l[485]||(l[485]=e("p",null,"这样，消息就丢失了。因此消费者返回ACK的时机非常重要。",-1)),l[486]||(l[486]=e("p",null,"而SpringAMQP则允许配置三种确认模式：",-1)),l[487]||(l[487]=e("ul",null,[e("li",null,[e("p",null,"manual：手动ack，需要在业务代码结束后，调用api发送ack。")]),e("li",null,[e("p",null,"auto：自动ack，由spring监测listener代码是否出现异常，没有异常则返回ack；抛出异常则返回nack")]),e("li",null,[e("p",null,"none：关闭ack，MQ假定消费者获取消息后会成功处理，因此消息投递后立即被删除")])],-1)),l[488]||(l[488]=e("p",null,"由此可知：",-1)),l[489]||(l[489]=e("ul",null,[e("li",null,"none模式下，消息投递是不可靠的，可能丢失"),e("li",null,"auto模式类似事务机制，出现异常时返回nack，消息回滚到mq；没有异常，返回ack"),e("li",null,"manual：自己根据业务情况，判断什么时候该ack")],-1)),l[490]||(l[490]=e("p",null,"一般，我们都是使用默认的auto即可。",-1)),l[491]||(l[491]=e("h5",{id:"_1-3-1-演示none模式",tabindex:"-1"},[r("1.3.1 演示none模式 "),e("a",{class:"header-anchor",href:"#_1-3-1-演示none模式","aria-label":'Permalink to "1.3.1 演示none模式"'},"​")],-1)),l[492]||(l[492]=e("p",null,"修改consumer服务的application.yml文件，添加下面内容：",-1)),l[493]||(l[493]=e("div",{class:"language-yaml max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"yaml"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    listener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      simple"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        acknowledge-mode"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"none"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 关闭ack")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[494]||(l[494]=e("p",null,"修改consumer服务的SpringRabbitListener类中的方法，模拟一个消息处理异常：",-1)),l[495]||(l[495]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"queues"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "simple.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenSimpleQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg) {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消费者接收到simple.queue的消息：【{}】"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", msg);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 模拟异常")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"消息处理完成！"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[496]||(l[496]=e("p",null,"测试可以发现，当消息处理抛异常时，消息依然被RabbitMQ删除了。",-1)),l[497]||(l[497]=e("h5",{id:"_1-3-2-演示auto模式",tabindex:"-1"},[r("1.3.2 演示auto模式 "),e("a",{class:"header-anchor",href:"#_1-3-2-演示auto模式","aria-label":'Permalink to "1.3.2 演示auto模式"'},"​")],-1)),l[498]||(l[498]=e("p",null,"再次把确认机制修改为auto:",-1)),l[499]||(l[499]=e("div",{class:"language-yaml max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"yaml"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    listener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      simple"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        acknowledge-mode"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"auto"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 关闭ack")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[500]||(l[500]=e("p",null,"在异常位置打断点，再次发送消息，程序卡在断点时，可以发现此时消息状态为unack（未确定状态）：",-1)),l[501]||(l[501]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718171705383.png",alt:"image-20210718171705383",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[502]||(l[502]=e("p",null,"抛出异常后，因为Spring会自动返回nack，所以消息恢复至Ready状态，并且没有被RabbitMQ删除：",-1)),l[503]||(l[503]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718171759179.png",alt:"image-20210718171759179",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[504]||(l[504]=e("h4",{id:"_1-4-消费失败重试机制",tabindex:"-1"},[r("1.4 消费失败重试机制 "),e("a",{class:"header-anchor",href:"#_1-4-消费失败重试机制","aria-label":'Permalink to "1.4 消费失败重试机制"'},"​")],-1)),l[505]||(l[505]=e("p",null,"当消费者出现异常后，消息会不断requeue（重入队）到队列，再重新发送给消费者，然后再次异常，再次requeue，无限循环，导致mq的消息处理飙升，带来不必要的压力：",-1)),l[506]||(l[506]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718172746378.png",alt:"image-20210718172746378",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[507]||(l[507]=e("p",null,"怎么办呢？",-1)),l[508]||(l[508]=e("h5",{id:"_1-4-1-本地重试",tabindex:"-1"},[r("1.4.1 本地重试 "),e("a",{class:"header-anchor",href:"#_1-4-1-本地重试","aria-label":'Permalink to "1.4.1 本地重试"'},"​")],-1)),l[509]||(l[509]=e("p",null,"我们可以利用Spring的retry机制，在消费者出现异常时利用本地重试，而不是无限制的requeue到mq队列。",-1)),l[510]||(l[510]=e("p",null,"修改consumer服务的application.yml文件，添加内容：",-1)),l[511]||(l[511]=e("div",{class:"language-yaml max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"yaml"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    listener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      simple"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        retry"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          enabled"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 开启消费者失败重试")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          initial-interval"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 初识的失败等待时长为1秒")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          multiplier"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 失败的等待时长倍数，下次等待时长 = multiplier * last-interval")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          max-attempts"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 最大重试次数")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          stateless"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # true无状态；false有状态。如果业务中包含事务，这里改为false")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[512]||(l[512]=e("p",null,"重启consumer服务，重复之前的测试。可以发现：",-1)),l[513]||(l[513]=e("ul",null,[e("li",null,"在重试3次后，SpringAMQP会抛出异常AmqpRejectAndDontRequeueException，说明本地重试触发了"),e("li",null,"查看RabbitMQ控制台，发现消息被删除了，说明最后SpringAMQP返回的是ack，mq删除消息了")],-1)),l[514]||(l[514]=e("p",null,"结论：",-1)),l[515]||(l[515]=e("ul",null,[e("li",null,"开启本地重试时，消息处理过程中抛出异常，不会requeue到队列，而是在消费者本地重试"),e("li",null,"重试达到最大次数后，Spring会返回ack，消息会被丢弃")],-1)),l[516]||(l[516]=e("h5",{id:"_1-4-2-失败策略",tabindex:"-1"},[r("1.4.2 失败策略 "),e("a",{class:"header-anchor",href:"#_1-4-2-失败策略","aria-label":'Permalink to "1.4.2 失败策略"'},"​")],-1)),l[517]||(l[517]=e("p",null,"在之前的测试中，达到最大重试次数后，消息会被丢弃，这是由Spring内部机制决定的。",-1)),l[518]||(l[518]=e("p",null,"在开启重试模式后，重试次数耗尽，如果消息依然失败，则需要有MessageRecovery接口来处理，它包含三种不同的实现：",-1)),l[519]||(l[519]=e("ul",null,[e("li",null,[e("p",null,"RejectAndDontRequeueRecoverer：重试耗尽后，直接reject，丢弃消息。默认就是这种方式")]),e("li",null,[e("p",null,"ImmediateRequeueMessageRecoverer：重试耗尽后，返回nack，消息重新入队")]),e("li",null,[e("p",null,"RepublishMessageRecoverer：重试耗尽后，将失败消息投递到指定的交换机")])],-1)),l[520]||(l[520]=e("p",null,"比较优雅的一种处理方案是RepublishMessageRecoverer，失败后将消息投递到一个指定的，专门存放异常消息的队列，后续由人工集中处理。",-1)),l[521]||(l[521]=e("p",null,"1）在consumer服务中定义处理失败消息的交换机和队列",-1)),l[522]||(l[522]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DirectExchange "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorMessageExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DirectExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorBinding"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Queue errorQueue, DirectExchange errorMessageExchange){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(errorQueue)."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(errorMessageExchange)."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"with"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[523]||(l[523]=e("p",null,"2）定义一个RepublishMessageRecoverer，关联队列和交换机",-1)),l[524]||(l[524]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MessageRecoverer "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"republishMessageRecoverer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RabbitTemplate rabbitTemplate){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RepublishMessageRecoverer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rabbitTemplate, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[525]||(l[525]=e("p",null,"完整代码：",-1)),l[526]||(l[526]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.mq.config;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.Binding;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.BindingBuilder;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.DirectExchange;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.core.Queue;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.core.RabbitTemplate;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.retry.MessageRecoverer;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.amqp.rabbit.retry.RepublishMessageRecoverer;")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Bean;")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ErrorMessageConfig"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DirectExchange "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorMessageExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DirectExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"errorBinding"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Queue "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"errorQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", DirectExchange "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"errorMessageExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(errorQueue)."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(errorMessageExchange)."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"with"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"}),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MessageRecoverer "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"republishMessageRecoverer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(RabbitTemplate "),e("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"rabbitTemplate"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RepublishMessageRecoverer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rabbitTemplate, "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"error"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[527]||(l[527]=e("h4",{id:"_1-5-总结",tabindex:"-1"},[r("1.5 总结 "),e("a",{class:"header-anchor",href:"#_1-5-总结","aria-label":'Permalink to "1.5 总结"'},"​")],-1)),l[528]||(l[528]=e("p",null,"如何确保RabbitMQ消息的可靠性？",-1)),l[529]||(l[529]=e("ul",null,[e("li",null,"开启生产者确认机制，确保生产者的消息能到达队列"),e("li",null,"开启持久化功能，确保消息未消费前在队列中不会丢失"),e("li",null,"开启消费者确认机制为auto，由spring确认消息处理成功后完成ack"),e("li",null,"开启消费者失败重试机制，并设置MessageRecoverer，多次重试失败后将消息投递到异常交换机，交由人工处理")],-1)),l[530]||(l[530]=e("hr",null,null,-1)),l[531]||(l[531]=e("h3",{id:"_2-死信交换机",tabindex:"-1"},[r("2. 死信交换机 "),e("a",{class:"header-anchor",href:"#_2-死信交换机","aria-label":'Permalink to "2. 死信交换机"'},"​")],-1)),l[532]||(l[532]=e("h4",{id:"_2-1-初识死信交换机",tabindex:"-1"},[r("2.1 初识死信交换机 "),e("a",{class:"header-anchor",href:"#_2-1-初识死信交换机","aria-label":'Permalink to "2.1 初识死信交换机"'},"​")],-1)),l[533]||(l[533]=e("h5",{id:"_2-1-1-什么是死信交换机",tabindex:"-1"},[r("2.1.1 什么是死信交换机 "),e("a",{class:"header-anchor",href:"#_2-1-1-什么是死信交换机","aria-label":'Permalink to "2.1.1 什么是死信交换机"'},"​")],-1)),l[534]||(l[534]=e("p",null,"什么是死信？",-1)),l[535]||(l[535]=e("p",null,"当一个队列中的消息满足下列情况之一时，可以成为死信（dead letter）：",-1)),l[536]||(l[536]=e("ul",null,[e("li",null,"消费者使用basic.reject或 basic.nack声明消费失败，并且消息的requeue参数设置为false"),e("li",null,"消息是一个过期消息，超时无人消费"),e("li",null,"要投递的队列消息满了，无法投递")],-1)),l[537]||(l[537]=e("p",null,[r("如果这个包含死信的队列配置了"),e("code",null,"dead-letter-exchange"),r("属性，指定了一个交换机，那么队列中的死信就会投递到这个交换机中，而这个交换机称为"),e("strong",null,"死信交换机"),r("（Dead Letter Exchange，检查DLX）。")],-1)),l[538]||(l[538]=e("p",null,"如图，一个消息被消费者拒绝了，变成了死信：",-1)),l[539]||(l[539]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718174328383.png",alt:"image-20210718174328383",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[540]||(l[540]=e("p",null,"因为simple.queue绑定了死信交换机 dl.direct，因此死信会投递给这个交换机：",-1)),l[541]||(l[541]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718174416160.png",alt:"image-20210718174416160",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[542]||(l[542]=e("p",null,"如果这个死信交换机也绑定了一个队列，则消息最终会进入这个存放死信的队列：",-1)),l[543]||(l[543]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718174506856.png",alt:"image-20210718174506856",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[544]||(l[544]=e("p",null,"另外，队列将死信投递给死信交换机时，必须知道两个信息：",-1)),l[545]||(l[545]=e("ul",null,[e("li",null,"死信交换机名称"),e("li",null,"死信交换机与死信队列绑定的RoutingKey")],-1)),l[546]||(l[546]=e("p",null,"这样才能确保投递的消息能到达死信交换机，并且正确的路由到死信队列。",-1)),l[547]||(l[547]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821073801398.png",alt:"image-20210821073801398",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[548]||(l[548]=e("h5",{id:"_2-1-2-利用死信交换机接收死信-拓展",tabindex:"-1"},[r("2.1.2.利用死信交换机接收死信（拓展） "),e("a",{class:"header-anchor",href:"#_2-1-2-利用死信交换机接收死信-拓展","aria-label":'Permalink to "2.1.2.利用死信交换机接收死信（拓展）"'},"​")],-1)),l[549]||(l[549]=e("p",null,"在失败重试策略中，默认的RejectAndDontRequeueRecoverer会在本地重试次数耗尽后，发送reject给RabbitMQ，消息变成死信，被丢弃。",-1)),l[550]||(l[550]=e("p",null,"我们可以给simple.queue添加一个死信交换机，给死信交换机绑定一个队列。这样消息变成死信后也不会丢弃，而是最终投递到死信交换机，路由到与死信交换机绑定的队列。",-1)),l[551]||(l[551]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251205151738043.png",alt:"image-20251205151738043",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[552]||(l[552]=e("p",null,"我们在consumer服务中，定义一组死信交换机、死信队列：",-1)),l[553]||(l[553]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 声明普通的 simple.queue队列，并且为其指定死信交换机：dl.direct")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"simpleQueue2"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueueBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"durable"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"simple.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 指定队列名称，并持久化")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"deadLetterExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dl.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 指定死信交换机")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 声明死信交换机 dl.direct")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DirectExchange "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dlExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DirectExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dl.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 声明存储死信的队列 dl.queue")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dlQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Queue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dl.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 将死信队列 与 死信交换机绑定")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dlBinding"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dlQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dlExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"with"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"simple"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[554]||(l[554]=e("h5",{id:"_2-1-3-总结",tabindex:"-1"},[r("2.1.3.总结 "),e("a",{class:"header-anchor",href:"#_2-1-3-总结","aria-label":'Permalink to "2.1.3.总结"'},"​")],-1)),l[555]||(l[555]=e("p",null,"什么样的消息会成为死信？",-1)),l[556]||(l[556]=e("ul",null,[e("li",null,"消息被消费者reject或者返回nack"),e("li",null,"消息超时未消费"),e("li",null,"队列满了")],-1)),l[557]||(l[557]=e("p",null,"死信交换机的使用场景是什么？",-1)),l[558]||(l[558]=e("ul",null,[e("li",null,"如果队列绑定了死信交换机，死信会投递到死信交换机；"),e("li",null,"可以利用死信交换机收集所有消费者处理失败的消息（死信），交由人工处理，进一步提高消息队列的可靠性。")],-1)),l[559]||(l[559]=e("h4",{id:"_2-2-ttl",tabindex:"-1"},[r("2.2 TTL "),e("a",{class:"header-anchor",href:"#_2-2-ttl","aria-label":'Permalink to "2.2 TTL"'},"​")],-1)),l[560]||(l[560]=e("p",null,"一个队列中的消息如果超时未消费，则会变为死信，超时分为两种情况：",-1)),l[561]||(l[561]=e("ul",null,[e("li",null,"消息所在的队列设置了超时时间"),e("li",null,"消息本身设置了超时时间")],-1)),l[562]||(l[562]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718182643311.png",alt:"image-20210718182643311",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[563]||(l[563]=e("h5",{id:"_2-2-1-接收超时死信的死信交换机",tabindex:"-1"},[r("2.2.1 接收超时死信的死信交换机 "),e("a",{class:"header-anchor",href:"#_2-2-1-接收超时死信的死信交换机","aria-label":'Permalink to "2.2.1 接收超时死信的死信交换机"'},"​")],-1)),l[564]||(l[564]=e("p",null,"在consumer服务的SpringRabbitListener中，定义一个新的消费者，并且声明 死信交换机、死信队列：",-1)),l[565]||(l[565]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RabbitListener"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"bindings"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"QueueBinding"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    value"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Queue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "dl.ttl.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"durable"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "true"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    exchange"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," @"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Exchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "dl.ttl.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    key"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "ttl"')]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"))")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," listenDlQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String msg){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"接收到 dl.ttl.queue的延迟消息：{}"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", msg);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[566]||(l[566]=e("h5",{id:"_2-2-2-声明一个队列-并且指定ttl",tabindex:"-1"},[r("2.2.2 声明一个队列，并且指定TTL "),e("a",{class:"header-anchor",href:"#_2-2-2-声明一个队列-并且指定ttl","aria-label":'Permalink to "2.2.2 声明一个队列，并且指定TTL"'},"​")],-1)),l[567]||(l[567]=e("p",null,"要给队列设置超时时间，需要在声明队列时配置x-message-ttl属性：",-1)),l[568]||(l[568]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttlQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueueBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"durable"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 指定队列名称，并持久化")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttl"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10000"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 设置队列的超时时间，10秒")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"deadLetterExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dl.ttl.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 指定死信交换机")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[569]||(l[569]=e("p",null,[r("注意，这个队列设定了死信交换机为"),e("code",null,"dl.ttl.direct")],-1)),l[570]||(l[570]=e("p",null,"声明交换机，将ttl与交换机绑定：",-1)),l[571]||(l[571]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DirectExchange "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttlExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DirectExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Binding "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttlBinding"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," BindingBuilder."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bind"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttlQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"to"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ttlExchange"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"with"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[572]||(l[572]=e("p",null,"发送消息，但是不要指定TTL：",-1)),l[573]||(l[573]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testTTLQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "hello, ttl queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息ID，需要封装到CorrelationData中")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CorrelationData correlationData "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CorrelationData"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UUID."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomUUID"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message, correlationData);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 记录日志")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"发送消息成功"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[574]||(l[574]=e("p",null,"发送消息的日志：",-1)),l[575]||(l[575]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718191657478.png",alt:"image-20210718191657478",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[576]||(l[576]=e("p",null,"查看下接收消息的日志：",-1)),l[577]||(l[577]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718191738706.png",alt:"image-20210718191738706",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[578]||(l[578]=e("p",null,"因为队列的TTL值是10000ms，也就是10秒。可以看到消息发送与接收之间的时差刚好是10秒。",-1)),l[579]||(l[579]=e("h5",{id:"_2-2-3-发送消息时-设定ttl",tabindex:"-1"},[r("2.2.3 发送消息时，设定TTL "),e("a",{class:"header-anchor",href:"#_2-2-3-发送消息时-设定ttl","aria-label":'Permalink to "2.2.3 发送消息时，设定TTL"'},"​")],-1)),l[580]||(l[580]=e("p",null,"在发送消息时，也可以指定TTL：",-1)),l[581]||(l[581]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testTTLMsg"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Message message "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MessageBuilder")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"withBody"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"hello, ttl message"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getBytes"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(StandardCharsets.UTF_8))")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setExpiration"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"5000"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 消息ID，需要封装到CorrelationData中")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    CorrelationData correlationData "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CorrelationData"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UUID."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"randomUUID"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送消息")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    rabbitTemplate."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"convertAndSend"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl.direct"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ttl"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", message, correlationData);")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    log."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"发送消息成功"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[582]||(l[582]=e("p",null,"查看发送消息日志：",-1)),l[583]||(l[583]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718191939140.png",alt:"image-20210718191939140",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[584]||(l[584]=e("p",null,"接收消息日志：",-1)),l[585]||(l[585]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718192004662.png",alt:"image-20210718192004662",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[586]||(l[586]=e("p",null,"这次，发送与接收的延迟只有5秒。说明当队列、消息都设置了TTL时，任意一个到期就会成为死信。",-1)),l[587]||(l[587]=e("h5",{id:"_2-2-4-总结",tabindex:"-1"},[r("2.2.4 总结 "),e("a",{class:"header-anchor",href:"#_2-2-4-总结","aria-label":'Permalink to "2.2.4 总结"'},"​")],-1)),l[588]||(l[588]=e("p",null,"消息超时的两种方式是？",-1)),l[589]||(l[589]=e("ul",null,[e("li",null,"给队列设置ttl属性，进入队列后超过ttl时间的消息变为死信"),e("li",null,"给消息设置ttl属性，队列接收到消息超过ttl时间后变为死信")],-1)),l[590]||(l[590]=e("p",null,"如何实现发送一个消息20秒后消费者才收到消息？",-1)),l[591]||(l[591]=e("ul",null,[e("li",null,"给消息的目标队列指定死信交换机"),e("li",null,"将消费者监听的队列绑定到死信交换机"),e("li",null,"发送消息时给消息设置超时时间为20秒")],-1)),l[592]||(l[592]=e("h4",{id:"_2-3-延迟队列",tabindex:"-1"},[r("2.3 延迟队列 "),e("a",{class:"header-anchor",href:"#_2-3-延迟队列","aria-label":'Permalink to "2.3 延迟队列"'},"​")],-1)),l[593]||(l[593]=e("p",null,"利用TTL结合死信交换机，我们实现了消息发出后，消费者延迟收到消息的效果。这种消息模式就称为延迟队列（Delay Queue）模式。",-1)),l[594]||(l[594]=e("p",null,"延迟队列的使用场景包括：",-1)),l[595]||(l[595]=e("ul",null,[e("li",null,"延迟发送短信"),e("li",null,"用户下单，如果用户在15 分钟内未支付，则自动取消"),e("li",null,"预约工作会议，20分钟后自动通知所有参会人员")],-1)),l[596]||(l[596]=e("p",null,"因为延迟队列的需求非常多，所以RabbitMQ的官方也推出了一个插件，原生支持延迟队列效果。",-1)),l[597]||(l[597]=e("p",null,[r("这个插件就是DelayExchange插件。参考RabbitMQ的插件列表页面："),e("a",{href:"https://www.rabbitmq.com/community-plugins.html",target:"_blank",rel:"noreferrer"},"https://www.rabbitmq.com/community-plugins.html")],-1)),l[598]||(l[598]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718192529342.png",alt:"image-20210718192529342",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[599]||(l[599]=e("p",null,[r("使用方式可以参考官网地址："),e("a",{href:"https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq",target:"_blank",rel:"noreferrer"},"https://blog.rabbitmq.com/posts/2015/04/scheduling-messages-with-rabbitmq")],-1)),l[600]||(l[600]=e("h5",{id:"_2-3-1-安装delayexchange插件",tabindex:"-1"},[r("2.3.1 安装DelayExchange插件 "),e("a",{class:"header-anchor",href:"#_2-3-1-安装delayexchange插件","aria-label":'Permalink to "2.3.1 安装DelayExchange插件"'},"​")],-1)),l[601]||(l[601]=e("p",null,"参考课前资料：",-1)),l[602]||(l[602]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718193409812.png",alt:"image-20210718193409812",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[603]||(l[603]=e("h5",{id:"_2-3-2-delayexchange原理",tabindex:"-1"},[r("2.3.2 DelayExchange原理 "),e("a",{class:"header-anchor",href:"#_2-3-2-delayexchange原理","aria-label":'Permalink to "2.3.2 DelayExchange原理"'},"​")],-1)),l[604]||(l[604]=e("p",null,"DelayExchange需要将一个交换机声明为delayed类型。当我们发送消息到delayExchange时，流程如下：",-1)),l[605]||(l[605]=e("ul",null,[e("li",null,"接收消息"),e("li",null,"判断消息是否具备x-delay属性"),e("li",null,"如果有x-delay属性，说明是延迟消息，持久化到硬盘，读取x-delay值，作为延迟时间"),e("li",null,"返回routing not found结果给消息发送者"),e("li",null,"x-delay时间到期后，重新投递消息到指定队列")],-1)),l[606]||(l[606]=e("h5",{id:"_2-3-3-使用delayexchange",tabindex:"-1"},[r("2.3.3 使用DelayExchange "),e("a",{class:"header-anchor",href:"#_2-3-3-使用delayexchange","aria-label":'Permalink to "2.3.3 使用DelayExchange"'},"​")],-1)),l[607]||(l[607]=e("p",null,"插件的使用也非常简单：声明一个交换机，交换机的类型可以是任意类型，只需要设定delayed属性为true即可，然后声明队列与其绑定即可。",-1)),l[608]||(l[608]=e("h6",{id:"_1-声明delayexchange交换机",tabindex:"-1"},[r("1）声明DelayExchange交换机 "),e("a",{class:"header-anchor",href:"#_1-声明delayexchange交换机","aria-label":'Permalink to "1）声明DelayExchange交换机"'},"​")],-1)),l[609]||(l[609]=e("p",null,"基于注解方式（推荐）：",-1)),l[610]||(l[610]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718193747649.png",alt:"image-20210718193747649",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[611]||(l[611]=e("p",null,"也可以基于@Bean的方式：",-1)),l[612]||(l[612]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718193831076.png",alt:"image-20210718193831076",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[613]||(l[613]=e("h6",{id:"_2-发送消息",tabindex:"-1"},[r("2）发送消息 "),e("a",{class:"header-anchor",href:"#_2-发送消息","aria-label":'Permalink to "2）发送消息"'},"​")],-1)),l[614]||(l[614]=e("p",null,"发送消息时，一定要携带x-delay属性，指定延迟的时间：",-1)),l[615]||(l[615]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718193917009.png",alt:"image-20210718193917009",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[616]||(l[616]=e("h5",{id:"_2-3-4-总结",tabindex:"-1"},[r("2.3.4 总结 "),e("a",{class:"header-anchor",href:"#_2-3-4-总结","aria-label":'Permalink to "2.3.4 总结"'},"​")],-1)),l[617]||(l[617]=e("p",null,"延迟队列插件的使用步骤包括哪些？",-1)),l[618]||(l[618]=e("p",null,"•声明一个交换机，添加delayed属性为true",-1)),l[619]||(l[619]=e("p",null,"•发送消息时，添加x-delay头，值为超时时间",-1)),l[620]||(l[620]=e("hr",null,null,-1)),l[621]||(l[621]=e("h3",{id:"_3-惰性队列",tabindex:"-1"},[r("3. 惰性队列 "),e("a",{class:"header-anchor",href:"#_3-惰性队列","aria-label":'Permalink to "3. 惰性队列"'},"​")],-1)),l[622]||(l[622]=e("h4",{id:"_3-1-消息堆积问题",tabindex:"-1"},[r("3.1 消息堆积问题 "),e("a",{class:"header-anchor",href:"#_3-1-消息堆积问题","aria-label":'Permalink to "3.1 消息堆积问题"'},"​")],-1)),l[623]||(l[623]=e("p",null,"当生产者发送消息的速度超过了消费者处理消息的速度，就会导致队列中的消息堆积，直到队列存储消息达到上限。之后发送的消息就会成为死信，可能会被丢弃，这就是消息堆积问题。",-1)),l[624]||(l[624]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718194040498.png",alt:"image-20210718194040498",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[625]||(l[625]=e("p",null,"解决消息堆积有两种思路：",-1)),l[626]||(l[626]=e("ul",null,[e("li",null,"增加更多消费者，提高消费速度。也就是我们之前说的work queue模式"),e("li",null,"扩大队列容积，提高堆积上限")],-1)),l[627]||(l[627]=e("p",null,"要提升队列容积，把消息保存在内存中显然是不行的。",-1)),l[628]||(l[628]=e("h4",{id:"_3-2-惰性队列",tabindex:"-1"},[r("3.2 惰性队列 "),e("a",{class:"header-anchor",href:"#_3-2-惰性队列","aria-label":'Permalink to "3.2 惰性队列"'},"​")],-1)),l[629]||(l[629]=e("p",null,"从RabbitMQ的3.6.0版本开始，就增加了Lazy Queues的概念，也就是惰性队列。惰性队列的特征如下：",-1)),l[630]||(l[630]=e("ul",null,[e("li",null,"接收到消息后直接存入磁盘而非内存"),e("li",null,"消费者要消费消息时才会从磁盘中读取并加载到内存"),e("li",null,"支持数百万条的消息存储")],-1)),l[631]||(l[631]=e("h5",{id:"_3-2-1-基于命令行设置lazy-queue",tabindex:"-1"},[r("3.2.1 基于命令行设置lazy-queue "),e("a",{class:"header-anchor",href:"#_3-2-1-基于命令行设置lazy-queue","aria-label":'Permalink to "3.2.1 基于命令行设置lazy-queue"'},"​")],-1)),l[632]||(l[632]=e("p",null,"而要设置一个队列为惰性队列，只需要在声明队列时，指定x-queue-mode属性为lazy即可。可以通过命令行将一个运行中的队列修改为惰性队列：",-1)),l[633]||(l[633]=e("div",{class:"language-sh max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rabbitmqctl"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," set_policy"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Lazy"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "^lazy-queue$"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' \'{"queue-mode":"lazy"}\''),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --apply-to"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," queues")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[634]||(l[634]=e("p",null,"命令解读：",-1)),l[635]||(l[635]=e("ul",null,[e("li",null,[e("code",null,"rabbitmqctl"),r(" ：RabbitMQ的命令行工具")]),e("li",null,[e("code",null,"set_policy"),r(" ：添加一个策略")]),e("li",null,[e("code",null,"Lazy"),r(" ：策略名称，可以自定义")]),e("li",null,[e("code",null,'"^lazy-queue$"'),r(" ：用正则表达式匹配队列的名字")]),e("li",null,[e("code",null,'\'{"queue-mode":"lazy"}\''),r(" ：设置队列模式为lazy模式")]),e("li",null,[e("code",null,"--apply-to queues "),r("：策略的作用对象，是所有的队列")])],-1)),l[636]||(l[636]=e("h5",{id:"_3-2-2-基于-bean声明lazy-queue",tabindex:"-1"},[r("3.2.2 基于@Bean声明lazy-queue "),e("a",{class:"header-anchor",href:"#_3-2-2-基于-bean声明lazy-queue","aria-label":'Permalink to "3.2.2 基于@Bean声明lazy-queue"'},"​")],-1)),l[637]||(l[637]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718194522223.png",alt:"image-20210718194522223",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[638]||(l[638]=e("h5",{id:"_3-2-3-基于-rabbitlistener声明lazyqueue",tabindex:"-1"},[r("3.2.3 基于@RabbitListener声明LazyQueue "),e("a",{class:"header-anchor",href:"#_3-2-3-基于-rabbitlistener声明lazyqueue","aria-label":'Permalink to "3.2.3 基于@RabbitListener声明LazyQueue"'},"​")],-1)),l[639]||(l[639]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718194539054.png",alt:"image-20210718194539054",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[640]||(l[640]=e("h4",{id:"_3-3-总结",tabindex:"-1"},[r("3.3 总结 "),e("a",{class:"header-anchor",href:"#_3-3-总结","aria-label":'Permalink to "3.3 总结"'},"​")],-1)),l[641]||(l[641]=e("p",null,"消息堆积问题的解决方案？",-1)),l[642]||(l[642]=e("ul",null,[e("li",null,"队列上绑定多个消费者，提高消费速度"),e("li",null,"使用惰性队列，可以再mq中保存更多消息")],-1)),l[643]||(l[643]=e("p",null,"惰性队列的优点有哪些？",-1)),l[644]||(l[644]=e("ul",null,[e("li",null,"基于磁盘存储，消息上限高"),e("li",null,"没有间歇性的page-out，性能比较稳定")],-1)),l[645]||(l[645]=e("p",null,"惰性队列的缺点有哪些？",-1)),l[646]||(l[646]=e("ul",null,[e("li",null,"基于磁盘存储，消息时效性会降低"),e("li",null,"性能受限于磁盘的IO")],-1)),l[647]||(l[647]=e("hr",null,null,-1)),l[648]||(l[648]=e("h3",{id:"_4-mq集群",tabindex:"-1"},[r("4. MQ集群 "),e("a",{class:"header-anchor",href:"#_4-mq集群","aria-label":'Permalink to "4. MQ集群"'},"​")],-1)),l[649]||(l[649]=e("h4",{id:"_4-1-集群分类",tabindex:"-1"},[r("4.1 集群分类 "),e("a",{class:"header-anchor",href:"#_4-1-集群分类","aria-label":'Permalink to "4.1 集群分类"'},"​")],-1)),l[650]||(l[650]=e("p",null,"RabbitMQ的是基于Erlang语言编写，而Erlang又是一个面向并发的语言，天然支持集群模式。RabbitMQ的集群有两种模式：",-1)),l[651]||(l[651]=e("p",null,[r("•"),e("strong",null,"普通集群"),r("：是一种分布式集群，将队列分散到集群的各个节点，从而提高整个集群的并发能力。")],-1)),l[652]||(l[652]=e("p",null,[r("•"),e("strong",null,"镜像集群"),r("：是一种主从集群，普通集群的基础上，添加了主从备份功能，提高集群的数据可用性。")],-1)),l[653]||(l[653]=e("p",null,[r("镜像集群虽然支持主从，但主从同步并不是强一致的，某些情况下可能有数据丢失的风险。因此在RabbitMQ的3.8版本以后，推出了新的功能："),e("strong",null,"仲裁队列"),r("来代替镜像集群，底层采用Raft协议确保主从的数据一致性。")],-1)),l[654]||(l[654]=e("h4",{id:"_4-2-普通集群",tabindex:"-1"},[r("4.2 普通集群 "),e("a",{class:"header-anchor",href:"#_4-2-普通集群","aria-label":'Permalink to "4.2 普通集群"'},"​")],-1)),l[655]||(l[655]=e("h5",{id:"_4-2-1-集群结构和特征",tabindex:"-1"},[r("4.2.1 集群结构和特征 "),e("a",{class:"header-anchor",href:"#_4-2-1-集群结构和特征","aria-label":'Permalink to "4.2.1 集群结构和特征"'},"​")],-1)),l[656]||(l[656]=e("p",null,"普通集群，或者叫标准集群（classic cluster），具备下列特征：",-1)),l[657]||(l[657]=e("ul",null,[e("li",null,"会在集群的各个节点间共享部分数据，包括：交换机、队列元信息。不包含队列中的消息。"),e("li",null,"当访问集群某节点时，如果队列不在该节点，会从数据所在节点传递到当前节点并返回"),e("li",null,"队列所在节点宕机，队列中的消息就会丢失")],-1)),l[658]||(l[658]=e("p",null,"结构如图：",-1)),l[659]||(l[659]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718220843323.png",alt:"image-20210718220843323",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[660]||(l[660]=e("h5",{id:"_4-2-2-部署",tabindex:"-1"},[r("4.2.2 部署 "),e("a",{class:"header-anchor",href:"#_4-2-2-部署","aria-label":'Permalink to "4.2.2 部署"'},"​")],-1)),l[661]||(l[661]=e("blockquote",null,[e("p",null,[r("参考："),e("a",{href:"#section1"},"RabbitMQ部署指南")])],-1)),l[662]||(l[662]=e("h4",{id:"_4-3-镜像集群",tabindex:"-1"},[r("4.3 镜像集群 "),e("a",{class:"header-anchor",href:"#_4-3-镜像集群","aria-label":'Permalink to "4.3 镜像集群"'},"​")],-1)),l[663]||(l[663]=e("h5",{id:"_4-3-1-集群结构和特征",tabindex:"-1"},[r("4.3.1 集群结构和特征 "),e("a",{class:"header-anchor",href:"#_4-3-1-集群结构和特征","aria-label":'Permalink to "4.3.1 集群结构和特征"'},"​")],-1)),l[664]||(l[664]=e("p",null,"镜像集群：本质是主从模式，具备下面的特征：",-1)),l[665]||(l[665]=e("ul",null,[e("li",null,"交换机、队列、队列中的消息会在各个mq的镜像节点之间同步备份。"),e("li",null,[r("创建队列的节点被称为该队列的"),e("strong",null,[r("主节点，"),e("strong",null,"备份到的其它节点叫做该队列的"),r("镜像")]),r("节点。")]),e("li",null,"一个队列的主节点可能是另一个队列的镜像节点"),e("li",null,"所有操作都是主节点完成，然后同步给镜像节点"),e("li",null,"主宕机后，镜像节点会替代成新的主")],-1)),l[666]||(l[666]=e("p",null,"结构如图：",-1)),l[667]||(l[667]=e("figure",null,[e("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210718221039542.png",alt:"image-20210718221039542",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[668]||(l[668]=e("h5",{id:"_4-3-2-部署",tabindex:"-1"},[r("4.3.2 部署 "),e("a",{class:"header-anchor",href:"#_4-3-2-部署","aria-label":'Permalink to "4.3.2 部署"'},"​")],-1)),l[669]||(l[669]=e("blockquote",null,[e("p",null,[r("参考："),e("a",{href:"#section1"},"RabbitMQ部署指南")])],-1)),l[670]||(l[670]=e("h4",{id:"_4-4-仲裁队列",tabindex:"-1"},[r("4.4 仲裁队列 "),e("a",{class:"header-anchor",href:"#_4-4-仲裁队列","aria-label":'Permalink to "4.4 仲裁队列"'},"​")],-1)),l[671]||(l[671]=e("h5",{id:"_4-4-1-集群特征",tabindex:"-1"},[r("4.4.1 集群特征 "),e("a",{class:"header-anchor",href:"#_4-4-1-集群特征","aria-label":'Permalink to "4.4.1 集群特征"'},"​")],-1)),l[672]||(l[672]=e("p",null,"仲裁队列：仲裁队列是3.8版本以后才有的新功能，用来替代镜像队列，具备下列特征：",-1)),l[673]||(l[673]=e("ul",null,[e("li",null,"与镜像队列一样，都是主从模式，支持主从数据同步"),e("li",null,"使用非常简单，没有复杂的配置"),e("li",null,"主从同步基于Raft协议，强一致")],-1)),l[674]||(l[674]=e("h5",{id:"_4-4-2-部署",tabindex:"-1"},[r("4.4.2 部署 "),e("a",{class:"header-anchor",href:"#_4-4-2-部署","aria-label":'Permalink to "4.4.2 部署"'},"​")],-1)),l[675]||(l[675]=e("blockquote",null,[e("p",null,[r("参考："),e("a",{href:"#section1"},"RabbitMQ部署指南")])],-1)),l[676]||(l[676]=e("h5",{id:"_4-4-3-java代码创建仲裁队列",tabindex:"-1"},[r("4.4.3 Java代码创建仲裁队列 "),e("a",{class:"header-anchor",href:"#_4-4-3-java代码创建仲裁队列","aria-label":'Permalink to "4.4.3 Java代码创建仲裁队列"'},"​")],-1)),l[677]||(l[677]=e("div",{class:"language-java max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"java"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Queue "),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"quorumQueue"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," QueueBuilder")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"durable"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"quorum.queue"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 持久化")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"quorum"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 仲裁队列")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),e("button",{class:"code-block-unfold-btn"})],-1)),l[678]||(l[678]=e("h5",{id:"_4-4-4-springamqp连接mq集群",tabindex:"-1"},[r("4.4.4 SpringAMQP连接MQ集群 "),e("a",{class:"header-anchor",href:"#_4-4-4-springamqp连接mq集群","aria-label":'Permalink to "4.4.4 SpringAMQP连接MQ集群"'},"​")],-1)),l[679]||(l[679]=e("p",null,"注意，这里用address来代替host、port方式",-1)),l[680]||(l[680]=e("div",{class:"language-yaml max-h-300px"},[e("button",{title:"Copy code",class:"copy"}),e("span",{class:"lang"},"yaml"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[e("code",{"v-pre":""},[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  rabbitmq"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    addresses"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.105:8071, 192.168.150.105:8072, 192.168.150.105:8073")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    username"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"itcast")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    password"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123321")]),r("\n"),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    virtual-host"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/")])])]),e("button",{class:"code-block-unfold-btn"})],-1))]),"main-header":n(()=>[t(s.$slots,"main-header")]),"main-header-after":n(()=>[t(s.$slots,"main-header-after")]),"main-nav":n(()=>[t(s.$slots,"main-nav")]),"main-content-before":n(()=>[t(s.$slots,"main-content-before")]),"main-content":n(()=>[t(s.$slots,"main-content")]),"main-content-after":n(()=>[t(s.$slots,"main-content-after")]),"main-nav-before":n(()=>[t(s.$slots,"main-nav-before")]),"main-nav-after":n(()=>[t(s.$slots,"main-nav-after")]),comment:n(()=>[t(s.$slots,"comment")]),footer:n(()=>[t(s.$slots,"footer")]),aside:n(()=>[t(s.$slots,"aside")]),"aside-custom":n(()=>[t(s.$slots,"aside-custom")]),default:n(()=>[t(s.$slots,"default")]),_:3},8,["frontmatter"])}}};export{c as default,d as usePageData};
