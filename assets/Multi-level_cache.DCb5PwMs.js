import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang.DPCcKRY2.js";import"./chunks/@vueuse/motion.D4J2SB46.js";import{d as s,a as l,u as a}from"./chunks/vue-router.BStRmF00.js";import{a1 as h,a3 as k,a4 as n,a5 as t,a7 as e,a6 as p,F as r,a2 as E,Z as d}from"./framework.GzYmdVjK.js";import"./app.7W1e0fx-.js";import"./chunks/dayjs.Dto65haK.js";import"./chunks/vue-i18n.BvWwj3SI.js";import"./chunks/pinia.BcfqlbOB.js";import"./chunks/nprogress.W5IEJXTh.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.Dn-H7UEj.js";import"./index.TQnGKZgq.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.KHJRstPN.js";import"./post.LnvKN5PZ.js";const g=s("/posts/Multi-level_cache",async i=>JSON.parse('{"title":"深入理解多级缓存","description":"","frontmatter":{"title":"深入理解多级缓存","author":"imklaus","tags":["Redis","Nginx"],"categories":["中间件"],"date":"2025/12/5 23:01:00","outline":"deep","postTitleClass":"text-#ffa500","excerpt_type":"html","end":false},"headers":[],"relativePath":"pages/posts/Multi-level_cache.md","lastUpdated":null}'),{lazy:(i,s)=>i.name===s.name}),c={__name:"Multi-level_cache",setup(s,{expose:c}){const{data:y}=g(),o=a(),F=l(),u=Object.assign(F.meta.frontmatter||{},y.value?.frontmatter||{});o.currentRoute.value.data=y.value,d("valaxy:frontmatter",u),globalThis.$frontmatter=u;return c({frontmatter:{title:"深入理解多级缓存",author:"imklaus",tags:["Redis","Nginx"],categories:["中间件"],date:"2025/12/5 23:01:00",outline:"deep",postTitleClass:"text-#ffa500",excerpt_type:"html",end:!1}}),(s,l)=>{const a=i;return E(),h(a,{frontmatter:r(u)},{"main-content-md":k(()=>[l[0]||(l[0]=t("p",null,[p("参考视频："),t("a",{href:"https://www.bilibili.com/video/BV1LQ4y127n4",target:"_blank",rel:"noreferrer"},"黑马SpringCloud微服务技术栈原理篇")],-1)),l[1]||(l[1]=t("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),l[2]||(l[2]=t("p",null,[t("strong",null,"目录指引"),p("：")],-1)),l[3]||(l[3]=t("nav",{class:"table-of-contents"},[t("ul",null,[t("li",null,[t("a",{href:"#_1-什么是多级缓存"},"1. 什么是多级缓存")]),t("li",null,[t("a",{href:"#_2-jvm进程缓存"},"2. JVM进程缓存"),t("ul",null,[t("li",null,[t("a",{href:"#_2-1-导入案例"},"2.1 导入案例")]),t("li",null,[t("a",{href:"#_2-2-初识caffeine"},"2.2 初识Caffeine")]),t("li",null,[t("a",{href:"#_2-3-实现jvm进程缓存"},"2.3.实现JVM进程缓存")])])]),t("li",null,[t("a",{href:"#_3-lua语法入门"},"3. Lua语法入门"),t("ul",null,[t("li",null,[t("a",{href:"#_3-1-初识lua"},"3.1 初识Lua")]),t("li",null,[t("a",{href:"#_3-2-helloworld"},"3.2 HelloWorld")]),t("li",null,[t("a",{href:"#_3-3-变量和循环"},"3.3 变量和循环")]),t("li",null,[t("a",{href:"#_3-4-条件控制、函数"},"3.4 条件控制、函数")])])]),t("li",null,[t("a",{href:"#_4-实现多级缓存"},"4. 实现多级缓存"),t("ul",null,[t("li",null,[t("a",{href:"#_4-1-安装openresty"},"4.1 安装OpenResty")]),t("li",null,[t("a",{href:"#_4-2-openresty快速入门"},"4.2 OpenResty快速入门")]),t("li",null,[t("a",{href:"#_4-3-请求参数处理"},"4.3 请求参数处理")]),t("li",null,[t("a",{href:"#_4-4-查询tomcat"},"4.4 查询Tomcat")]),t("li",null,[t("a",{href:"#_4-5-redis缓存预热"},"4.5 Redis缓存预热")]),t("li",null,[t("a",{href:"#_4-6-查询redis缓存"},"4.6 查询Redis缓存")]),t("li",null,[t("a",{href:"#_4-7-nginx本地缓存"},"4.7 Nginx本地缓存")])])]),t("li",null,[t("a",{href:"#_5-缓存同步"},"5. 缓存同步"),t("ul",null,[t("li",null,[t("a",{href:"#_5-1-数据同步策略"},"5.1 数据同步策略")]),t("li",null,[t("a",{href:"#_5-2-安装canal"},"5.2 安装Canal")]),t("li",null,[t("a",{href:"#_5-3-监听canal"},"5.3 监听Canal")])])])])],-1)),l[4]||(l[4]=t("h2",{id:"_1-什么是多级缓存",tabindex:"-1"},[p("1. 什么是多级缓存 "),t("a",{class:"header-anchor",href:"#_1-什么是多级缓存","aria-label":'Permalink to "1. 什么是多级缓存"'},"​")],-1)),l[5]||(l[5]=t("p",null,"传统的缓存策略一般是请求到达Tomcat后，先查询Redis，如果未命中则查询数据库，如图：",-1)),l[6]||(l[6]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821075259137.png",alt:"image-20210821075259137",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[7]||(l[7]=t("p",null,"存在下面的问题：",-1)),l[8]||(l[8]=t("ul",null,[t("li",null,[t("p",null,"请求要经过Tomcat处理，Tomcat的性能成为整个系统的瓶颈")]),t("li",null,[t("p",null,"Redis缓存失效时，会对数据库产生冲击")])],-1)),l[9]||(l[9]=t("p",null,"多级缓存就是充分利用请求处理的每个环节，分别添加缓存，减轻Tomcat压力，提升服务性能：",-1)),l[10]||(l[10]=t("ul",null,[t("li",null,"浏览器访问静态资源时，优先读取浏览器本地缓存"),t("li",null,"访问非静态资源（ajax查询数据）时，访问服务端"),t("li",null,"请求到达Nginx后，优先读取Nginx本地缓存"),t("li",null,"如果Nginx本地缓存未命中，则去直接查询Redis（不经过Tomcat）"),t("li",null,"如果Redis查询未命中，则查询Tomcat"),t("li",null,"请求进入Tomcat后，优先查询JVM进程缓存"),t("li",null,"如果JVM进程缓存未命中，则查询数据库")],-1)),l[11]||(l[11]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821075558137.png",alt:"image-20210821075558137",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[12]||(l[12]=t("p",null,[p("在多级缓存架构中，Nginx内部需要编写本地缓存查询、Redis查询、Tomcat查询的业务逻辑，因此这样的nginx服务不再是一个"),t("strong",null,"反向代理服务器"),p("，而是一个编写"),t("strong",null,"业务的Web服务器了"),p("。")],-1)),l[13]||(l[13]=t("p",null,"因此这样的业务Nginx服务也需要搭建集群来提高并发，再有专门的nginx服务来做反向代理，如图：",-1)),l[14]||(l[14]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821080511581.png",alt:"image-20210821080511581",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[15]||(l[15]=t("p",null,"另外，我们的Tomcat服务将来也会部署为集群模式：",-1)),l[16]||(l[16]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821080954947.png",alt:"image-20210821080954947",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[17]||(l[17]=t("p",null,"可见，多级缓存的关键有两个：",-1)),l[18]||(l[18]=t("ul",null,[t("li",null,[t("p",null,"一个是在nginx中编写业务，实现nginx本地缓存、Redis、Tomcat的查询")]),t("li",null,[t("p",null,"另一个就是在Tomcat中实现JVM进程缓存")])],-1)),l[19]||(l[19]=t("p",null,"其中Nginx编程则会用到OpenResty框架结合Lua这样的语言。",-1)),e(" more "),l[20]||(l[20]=t("hr",null,null,-1)),l[21]||(l[21]=t("h2",{id:"_2-jvm进程缓存",tabindex:"-1"},[p("2. JVM进程缓存 "),t("a",{class:"header-anchor",href:"#_2-jvm进程缓存","aria-label":'Permalink to "2. JVM进程缓存"'},"​")],-1)),l[22]||(l[22]=t("p",null,"为了演示多级缓存的案例，我们先准备一个商品查询的业务。",-1)),l[23]||(l[23]=t("h3",{id:"_2-1-导入案例",tabindex:"-1"},[p("2.1 导入案例 "),t("a",{class:"header-anchor",href:"#_2-1-导入案例","aria-label":'Permalink to "2.1 导入案例"'},"​")],-1)),l[24]||(l[24]=t("h4",{id:"_1-安装-mysql",tabindex:"-1"},[p("1. 安装 MySQL "),t("a",{class:"header-anchor",href:"#_1-安装-mysql","aria-label":'Permalink to "1. 安装 MySQL"'},"​")],-1)),l[25]||(l[25]=t("p",null,"后期做数据同步需要用到MySQL的主从功能，所以需要大家在虚拟机中，利用Docker来运行一个MySQL容器。",-1)),l[26]||(l[26]=t("h5",{id:"_1-1-准备目录",tabindex:"-1"},[p("1.1 准备目录 "),t("a",{class:"header-anchor",href:"#_1-1-准备目录","aria-label":'Permalink to "1.1 准备目录"'},"​")],-1)),l[27]||(l[27]=t("ul",null,[t("li",null,"为了方便后期配置MySQL，我们先准备两个目录，用于挂载容器的数据和配置文件目录：")],-1)),l[28]||(l[28]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 进入/tmp目录")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," cd"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 创建文件夹")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," mkdir"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 进入mysql目录")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," cd"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[29]||(l[29]=t("h5",{id:"_1-2-运行命令",tabindex:"-1"},[p("1.2 运行命令 "),t("a",{class:"header-anchor",href:"#_1-2-运行命令","aria-label":'Permalink to "1.2 运行命令"'},"​")],-1)),l[30]||(l[30]=t("ul",null,[t("li",null,"进入mysql目录后，执行下面的Docker命令：")],-1)),l[31]||(l[31]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," docker"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -p"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 3306:3306"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  --name"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -v"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PWD"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/conf:/etc/mysql/conf.d"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -v"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PWD"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/logs:/logs"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -v"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PWD"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/data:/var/lib/mysql"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -e"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," MYSQL_ROOT_PASSWORD="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"123"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  --privileged"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  -d"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql:5.7.25")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[32]||(l[32]=t("h5",{id:"_1-3-修改配置",tabindex:"-1"},[p("1.3 修改配置 "),t("a",{class:"header-anchor",href:"#_1-3-修改配置","aria-label":'Permalink to "1.3 修改配置"'},"​")],-1)),l[33]||(l[33]=t("p",null,"在/tmp/mysql/conf目录添加一个my.cnf文件，作为mysql的配置文件：",-1)),l[34]||(l[34]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 创建文件")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"touch"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp/mysql/conf/my.cnf")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[35]||(l[35]=t("p",null,"文件的内容如下：",-1)),l[36]||(l[36]=t("div",{class:"language-ini max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"ini"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"[mysqld]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"skip-name-resolve")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"character_set_server"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=utf8")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"datadir"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=/var/lib/mysql")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"server-id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=1000")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[37]||(l[37]=t("h5",{id:"_1-4-重启",tabindex:"-1"},[p("1.4.重启 "),t("a",{class:"header-anchor",href:"#_1-4-重启","aria-label":'Permalink to "1.4.重启"'},"​")],-1)),l[38]||(l[38]=t("p",null,"配置修改后，必须重启容器：",-1)),l[39]||(l[39]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," restart"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[40]||(l[40]=t("h4",{id:"_2-导入sql",tabindex:"-1"},[p("2. 导入SQL "),t("a",{class:"header-anchor",href:"#_2-导入sql","aria-label":'Permalink to "2. 导入SQL"'},"​")],-1)),l[41]||(l[41]=t("p",null,"接下来，利用Navicat客户端连接MySQL，然后导入课前资料提供的sql文件：",-1)),l[42]||(l[42]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809180936732.png",alt:"image-20210809180936732",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[43]||(l[43]=t("p",null,"其中包含两张表：",-1)),l[44]||(l[44]=t("ul",null,[t("li",null,"tb_item：商品表，包含商品的基本信息"),t("li",null,"tb_item_stock：商品库存表，包含商品的库存信息")],-1)),l[45]||(l[45]=t("p",null,"之所以将库存分离出来，是因为库存是更新比较频繁的信息，写操作较多。而其他信息修改的频率非常低。",-1)),l[46]||(l[46]=t("h4",{id:"_3-导入demo工程",tabindex:"-1"},[p("3. 导入Demo工程 "),t("a",{class:"header-anchor",href:"#_3-导入demo工程","aria-label":'Permalink to "3. 导入Demo工程"'},"​")],-1)),l[47]||(l[47]=t("p",null,"下面导入课前资料提供的工程：",-1)),l[48]||(l[48]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181147502.png",alt:"image-20210809181147502",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[49]||(l[49]=t("p",null,"项目结构如图所示：",-1)),l[50]||(l[50]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181346450.png",alt:"image-20210809181346450",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[51]||(l[51]=t("p",null,"其中的业务包括：",-1)),l[52]||(l[52]=t("ul",null,[t("li",null,"分页查询商品"),t("li",null,"新增商品"),t("li",null,"修改商品"),t("li",null,"修改库存"),t("li",null,"删除商品"),t("li",null,"根据id查询商品"),t("li",null,"根据id查询库存")],-1)),l[53]||(l[53]=t("p",null,"业务全部使用mybatis-plus来实现，如有需要请自行修改业务逻辑。",-1)),l[54]||(l[54]=t("h5",{id:"_3-1-分页查询商品",tabindex:"-1"},[p("3.1 分页查询商品 "),t("a",{class:"header-anchor",href:"#_3-1-分页查询商品","aria-label":'Permalink to "3.1 分页查询商品"'},"​")],-1)),l[55]||(l[55]=t("p",null,[p("在"),t("code",null,"com.heima.item.web"),p("包的"),t("code",null,"ItemController"),p("中可以看到接口定义：")],-1)),l[56]||(l[56]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181554563.png",alt:"image-20210809181554563",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[57]||(l[57]=t("h5",{id:"_3-2-新增商品",tabindex:"-1"},[p("3.2 新增商品 "),t("a",{class:"header-anchor",href:"#_3-2-新增商品","aria-label":'Permalink to "3.2 新增商品"'},"​")],-1)),l[58]||(l[58]=t("p",null,[p("在"),t("code",null,"com.heima.item.web"),p("包的"),t("code",null,"ItemController"),p("中可以看到接口定义：")],-1)),l[59]||(l[59]=t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251205215643102.png",alt:"image-20251205215643102",class:"scale-67"},null,-1)),l[60]||(l[60]=t("h5",{id:"_3-3-修改商品",tabindex:"-1"},[p("3.3 修改商品 "),t("a",{class:"header-anchor",href:"#_3-3-修改商品","aria-label":'Permalink to "3.3 修改商品"'},"​")],-1)),l[61]||(l[61]=t("p",null,[p("在"),t("code",null,"com.heima.item.web"),p("包的"),t("code",null,"ItemController"),p("中可以看到接口定义：")],-1)),l[62]||(l[62]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181714607.png",alt:"image-20210809181714607",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[63]||(l[63]=t("h5",{id:"_3-4-修改库存",tabindex:"-1"},[p("3.4 修改库存 "),t("a",{class:"header-anchor",href:"#_3-4-修改库存","aria-label":'Permalink to "3.4 修改库存"'},"​")],-1)),l[64]||(l[64]=t("p",null,[p("在"),t("code",null,"com.heima.item.web"),p("包的"),t("code",null,"ItemController"),p("中可以看到接口定义：")],-1)),l[65]||(l[65]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181744011.png",alt:"image-20210809181744011",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[66]||(l[66]=t("h5",{id:"_3-5-删除商品",tabindex:"-1"},[p("3.5 删除商品 "),t("a",{class:"header-anchor",href:"#_3-5-删除商品","aria-label":'Permalink to "3.5 删除商品"'},"​")],-1)),l[67]||(l[67]=t("p",null,[p("在"),t("code",null,"com.heima.item.web"),p("包的"),t("code",null,"ItemController"),p("中可以看到接口定义：")],-1)),l[68]||(l[68]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181821696.png",alt:"image-20210809181821696",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[69]||(l[69]=t("p",null,"这里是采用了逻辑删除，将商品状态修改为3",-1)),l[70]||(l[70]=t("h5",{id:"_3-6-根据id查询商品",tabindex:"-1"},[p("3.6 根据id查询商品 "),t("a",{class:"header-anchor",href:"#_3-6-根据id查询商品","aria-label":'Permalink to "3.6 根据id查询商品"'},"​")],-1)),l[71]||(l[71]=t("p",null,[p("在"),t("code",null,"com.heima.item.web"),p("包的"),t("code",null,"ItemController"),p("中可以看到接口定义：")],-1)),l[72]||(l[72]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181901823.png",alt:"image-20210809181901823",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[73]||(l[73]=t("p",null,"这里只返回了商品信息，不包含库存",-1)),l[74]||(l[74]=t("h5",{id:"_3-7-根据id查询库存",tabindex:"-1"},[p("3.7 根据id查询库存 "),t("a",{class:"header-anchor",href:"#_3-7-根据id查询库存","aria-label":'Permalink to "3.7 根据id查询库存"'},"​")],-1)),l[75]||(l[75]=t("p",null,[p("在"),t("code",null,"com.heima.item.web"),p("包的"),t("code",null,"ItemController"),p("中可以看到接口定义：")],-1)),l[76]||(l[76]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809181932805.png",alt:"image-20210809181932805",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[77]||(l[77]=t("h5",{id:"_3-8-启动",tabindex:"-1"},[p("3.8 启动 "),t("a",{class:"header-anchor",href:"#_3-8-启动","aria-label":'Permalink to "3.8 启动"'},"​")],-1)),l[78]||(l[78]=t("p",null,"注意修改application.yml文件中配置的mysql地址信息：",-1)),l[79]||(l[79]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210809182350132.png",alt:"image-20210809182350132",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[80]||(l[80]=t("p",null,"需要修改为自己的虚拟机地址信息、还有账号和密码。",-1)),l[81]||(l[81]=t("p",null,[p("修改后，启动服务，访问："),t("a",{href:"http://localhost:8081/item/10001%E5%8D%B3%E5%8F%AF%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE",target:"_blank",rel:"noreferrer"},"http://localhost:8081/item/10001即可查询数据")],-1)),l[82]||(l[82]=t("h4",{id:"_4-导入商品查询页面",tabindex:"-1"},[p("4. 导入商品查询页面 "),t("a",{class:"header-anchor",href:"#_4-导入商品查询页面","aria-label":'Permalink to "4. 导入商品查询页面"'},"​")],-1)),l[83]||(l[83]=t("p",null,"商品查询是购物页面，与商品管理的页面是分离的。",-1)),l[84]||(l[84]=t("p",null,"部署方式如图：",-1)),l[85]||(l[85]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816111210961.png",alt:"image-20210816111210961",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[86]||(l[86]=t("p",null,"我们需要准备一个反向代理的nginx服务器，如上图红框所示，将静态的商品页面放到nginx目录中。",-1)),l[87]||(l[87]=t("p",null,"页面需要的数据通过ajax向服务端（nginx业务集群）查询。",-1)),l[88]||(l[88]=t("h5",{id:"_4-1-运行nginx服务",tabindex:"-1"},[p("4.1 运行nginx服务 "),t("a",{class:"header-anchor",href:"#_4-1-运行nginx服务","aria-label":'Permalink to "4.1 运行nginx服务"'},"​")],-1)),l[89]||(l[89]=t("p",null,"这里我已经给大家准备好了nginx反向代理服务器和静态资源。",-1)),l[90]||(l[90]=t("p",null,"我们找到课前资料的nginx目录：",-1)),l[91]||(l[91]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816111348353.png",alt:"image-20210816111348353",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[92]||(l[92]=t("p",null,"将其拷贝到一个非中文目录下，运行这个nginx服务。",-1)),l[93]||(l[93]=t("p",null,"运行命令：",-1)),l[94]||(l[94]=t("div",{class:"language-powershell max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"powershell"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"start "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nginx.exe")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[95]||(l[95]=t("p",null,[p("然后访问 "),t("a",{href:"http://localhost/item.html?id=10001%E5%8D%B3%E5%8F%AF%EF%BC%9A",target:"_blank",rel:"noreferrer"},"http://localhost/item.html?id=10001即可：")],-1)),l[96]||(l[96]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816112323632.png",alt:"image-20210816112323632",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[97]||(l[97]=t("h5",{id:"_4-2-反向代理",tabindex:"-1"},[p("4.2 反向代理 "),t("a",{class:"header-anchor",href:"#_4-2-反向代理","aria-label":'Permalink to "4.2 反向代理"'},"​")],-1)),l[98]||(l[98]=t("p",null,"现在，页面是假数据展示的。我们需要向服务器发送ajax请求，查询商品数据。",-1)),l[99]||(l[99]=t("p",null,"打开控制台，可以看到页面有发起ajax查询数据：",-1)),l[100]||(l[100]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816113816958.png",alt:"image-20210816113816958",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[101]||(l[101]=t("p",null,"而这个请求地址同样是80端口，所以被当前的nginx反向代理了。",-1)),l[102]||(l[102]=t("p",null,"查看nginx的conf目录下的nginx.conf文件：",-1)),l[103]||(l[103]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816113917002.png",alt:"image-20210816113917002",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[104]||(l[104]=t("p",null,"其中的关键配置如下：",-1)),l[105]||(l[105]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816114416561.png",alt:"image-20210816114416561",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[106]||(l[106]=t("p",null,"其中的192.168.150.101是我的虚拟机IP，也就是我的Nginx业务集群要部署的地方：",-1)),l[107]||(l[107]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210816114554645.png",alt:"image-20210816114554645",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[108]||(l[108]=t("p",null,"完整内容如下：",-1)),l[109]||(l[109]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#user  nobody;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"worker_processes "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"events"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    worker_connections "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1024"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    include "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      mime.types;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    default_type "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," application/octet-stream;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    sendfile "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"       on"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    #tcp_nopush     on;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    keepalive_timeout "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 65"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    upstream"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," nginx-cluster"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        server"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 192.168.150.101:8081;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    server"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        listen "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"      80"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        server_name "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," localhost;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tlocation"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," /api "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            proxy_pass "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"http://nginx-cluster;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        location"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," / "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            root "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  html;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            index "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," index.html index.htm;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        error_page "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  500"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 502"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 503"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 504"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  /50x.html;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        location"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#DBEDFF"}}," /50x.html "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            root "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  html;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[110]||(l[110]=t("h3",{id:"_2-2-初识caffeine",tabindex:"-1"},[p("2.2 初识Caffeine "),t("a",{class:"header-anchor",href:"#_2-2-初识caffeine","aria-label":'Permalink to "2.2 初识Caffeine"'},"​")],-1)),l[111]||(l[111]=t("p",null,"缓存在日常开发中启动至关重要的作用，由于是存储在内存中，数据的读取速度是非常快的，能大量减少对数据库的访问，减少数据库的压力。我们把缓存分为两类：",-1)),l[112]||(l[112]=t("ul",null,[t("li",null,[p("分布式缓存，例如Redis： "),t("ul",null,[t("li",null,"优点：存储容量更大、可靠性更好、可以在集群间共享"),t("li",null,"缺点：访问缓存有网络开销"),t("li",null,"场景：缓存数据量较大、可靠性要求较高、需要在集群间共享")])]),t("li",null,[p("进程本地缓存，例如HashMap、GuavaCache： "),t("ul",null,[t("li",null,"优点：读取本地内存，没有网络开销，速度更快"),t("li",null,"缺点：存储容量有限、可靠性较低、无法共享"),t("li",null,"场景：性能要求较高，缓存数据量较小")])])],-1)),l[113]||(l[113]=t("p",null,"我们今天会利用Caffeine框架来实现JVM进程缓存。",-1)),l[114]||(l[114]=t("p",null,[t("strong",null,"Caffeine"),p("是一个基于Java8开发的，提供了近乎最佳命中率的高性能的本地缓存库。目前Spring内部的缓存使用的就是Caffeine。GitHub地址："),t("a",{href:"https://github.com/ben-manes/caffeine",target:"_blank",rel:"noreferrer"},"https://github.com/ben-manes/caffeine")],-1)),l[115]||(l[115]=t("p",null,"Caffeine的性能非常好，下图是官方给出的性能对比：",-1)),l[116]||(l[116]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821081826399.png",alt:"image-20210821081826399",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[117]||(l[117]=t("p",null,"可以看到Caffeine的性能遥遥领先！",-1)),l[118]||(l[118]=t("p",null,"缓存使用的基本API：",-1)),l[119]||(l[119]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Test")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," testBasicOps"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 构建cache对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Cache<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> cache "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Caffeine."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 存数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    cache."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"gf"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"迪丽热巴"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 取数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String gf "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cache."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIfPresent"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"gf"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"gf = "'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," gf);")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 取数据，包含两个参数：")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 参数一：缓存的key")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 参数二：Lambda表达式，表达式参数就是缓存的key，方法体是查询数据库的逻辑")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 优先根据key查询JVM缓存，如果未命中，则执行参数二的Lambda表达式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String defaultGF "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cache."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"defaultGF"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 根据key去数据库查询数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "柳岩"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    });")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"defaultGF = "'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," defaultGF);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[120]||(l[120]=t("p",null,"Caffeine既然是缓存的一种，肯定需要有缓存的清除策略，不然的话内存总会有耗尽的时候。",-1)),l[121]||(l[121]=t("p",null,"Caffeine提供了三种缓存驱逐策略：",-1)),l[122]||(l[122]=t("ul",null,[t("li",null,[t("p",null,[t("strong",null,"基于容量"),p("：设置缓存的数量上限")]),t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 创建缓存对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Cache<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> cache "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Caffeine."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"maximumSize"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 设置缓存大小上限为 1")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")])])]),t("button",{class:"code-block-unfold-btn"})])]),t("li",null,[t("p",null,[t("strong",null,"基于时间"),p("：设置缓存的有效时间")]),t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// 创建缓存对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Cache<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> cache "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Caffeine."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 设置缓存有效期为 10 秒，从最后一次写入开始计时 ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"expireAfterWrite"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Duration."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ofSeconds"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")) ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")])])]),t("button",{class:"code-block-unfold-btn"})])]),t("li",null,[t("p",null,[t("strong",null,"基于引用"),p("：设置缓存为软引用或弱引用，利用GC来回收缓存数据。性能较差，不建议使用。")])])],-1)),l[123]||(l[123]=t("blockquote",null,[t("p",null,[t("strong",null,"注意"),p("：在默认情况下，当一个缓存元素过期的时候，Caffeine不会自动立即将其清理和驱逐。而是在一次读或写操作后，或者在空闲时间完成对失效数据的驱逐。")])],-1)),l[124]||(l[124]=t("h3",{id:"_2-3-实现jvm进程缓存",tabindex:"-1"},[p("2.3.实现JVM进程缓存 "),t("a",{class:"header-anchor",href:"#_2-3-实现jvm进程缓存","aria-label":'Permalink to "2.3.实现JVM进程缓存"'},"​")],-1)),l[125]||(l[125]=t("h4",{id:"_2-3-1-需求",tabindex:"-1"},[p("2.3.1 需求 "),t("a",{class:"header-anchor",href:"#_2-3-1-需求","aria-label":'Permalink to "2.3.1 需求"'},"​")],-1)),l[126]||(l[126]=t("p",null,"利用Caffeine实现下列需求：",-1)),l[127]||(l[127]=t("ul",null,[t("li",null,"给根据id查询商品的业务添加缓存，缓存未命中时查询数据库"),t("li",null,"给根据id查询商品库存的业务添加缓存，缓存未命中时查询数据库"),t("li",null,"缓存初始大小为100"),t("li",null,"缓存上限为10000")],-1)),l[128]||(l[128]=t("h4",{id:"_2-3-2-实现",tabindex:"-1"},[p("2.3.2 实现 "),t("a",{class:"header-anchor",href:"#_2-3-2-实现","aria-label":'Permalink to "2.3.2 实现"'},"​")],-1)),l[129]||(l[129]=t("p",null,"首先，我们需要定义两个Caffeine的缓存对象，分别保存商品、库存的缓存数据。",-1)),l[130]||(l[130]=t("p",null,[p("在item-service的"),t("code",null,"com.heima.item.config"),p("包下定义"),t("code",null,"CaffeineConfig"),p("类：")],-1)),l[131]||(l[131]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.config;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.github.benmanes.caffeine.cache.Cache;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.github.benmanes.caffeine.cache.Caffeine;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.Item;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.ItemStock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Bean;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.context.annotation.Configuration;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Configuration")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," CaffeineConfig"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"itemCache"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Caffeine."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"initialCapacity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"100"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"maximumSize"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10_000"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ItemStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stockCache"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Caffeine."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newBuilder"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"initialCapacity"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"100"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"maximumSize"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10_000"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"build"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[132]||(l[132]=t("p",null,[p("然后，修改item-service中的"),t("code",null,"com.heima.item.web"),p("包下的ItemController类，添加缓存逻辑：")],-1)),l[133]||(l[133]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RestController")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RequestMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ItemController"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemService itemService;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemStockService stockService;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> itemCache;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ItemStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> stockCache;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // ...其它略")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/{id}"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Item "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemCache."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id, key "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"query"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ne"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"status"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"eq"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"one"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        );")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/stock/{id}"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ItemStock "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findStockById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockCache."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(id, key "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key));")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[134]||(l[134]=t("hr",null,null,-1)),l[135]||(l[135]=t("h2",{id:"_3-lua语法入门",tabindex:"-1"},[p("3. Lua语法入门 "),t("a",{class:"header-anchor",href:"#_3-lua语法入门","aria-label":'Permalink to "3. Lua语法入门"'},"​")],-1)),l[136]||(l[136]=t("p",null,"Nginx编程需要用到Lua语言，因此我们必须先入门Lua的基本语法。",-1)),l[137]||(l[137]=t("h3",{id:"_3-1-初识lua",tabindex:"-1"},[p("3.1 初识Lua "),t("a",{class:"header-anchor",href:"#_3-1-初识lua","aria-label":'Permalink to "3.1 初识Lua"'},"​")],-1)),l[138]||(l[138]=t("p",null,[p("Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。官网："),t("a",{href:"https://www.lua.org/",target:"_blank",rel:"noreferrer"},"https://www.lua.org/")],-1)),l[139]||(l[139]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821091437975.png",alt:"image-20210821091437975",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[140]||(l[140]=t("p",null,"Lua经常嵌入到C语言开发的程序中，例如游戏开发、游戏插件等。",-1)),l[141]||(l[141]=t("p",null,"Nginx本身也是C语言开发，因此也允许基于Lua做拓展。",-1)),l[142]||(l[142]=t("h3",{id:"_3-2-helloworld",tabindex:"-1"},[p("3.2 HelloWorld "),t("a",{class:"header-anchor",href:"#_3-2-helloworld","aria-label":'Permalink to "3.2 HelloWorld"'},"​")],-1)),l[143]||(l[143]=t("p",null,"CentOS7默认已经安装了Lua语言环境，所以可以直接运行Lua代码。",-1)),l[144]||(l[144]=t("p",null,"1）在Linux虚拟机的任意目录下，新建一个hello.lua文件",-1)),l[145]||(l[145]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821091621308.png",alt:"image-20210821091621308",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[146]||(l[146]=t("p",null,"2）添加下面的内容",-1)),l[147]||(l[147]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Hello World!"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[148]||(l[148]=t("p",null,"3）运行",-1)),l[149]||(l[149]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821091638140.png",alt:"image-20210821091638140",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[150]||(l[150]=t("h3",{id:"_3-3-变量和循环",tabindex:"-1"},[p("3.3 变量和循环 "),t("a",{class:"header-anchor",href:"#_3-3-变量和循环","aria-label":'Permalink to "3.3 变量和循环"'},"​")],-1)),l[151]||(l[151]=t("p",null,"学习任何语言必然离不开变量，而变量的声明必须先知道数据的类型。",-1)),l[152]||(l[152]=t("h4",{id:"_3-3-1-lua的数据类型",tabindex:"-1"},[p("3.3.1 Lua的数据类型 "),t("a",{class:"header-anchor",href:"#_3-3-1-lua的数据类型","aria-label":'Permalink to "3.3.1 Lua的数据类型"'},"​")],-1)),l[153]||(l[153]=t("p",null,"Lua中支持的常见数据类型包括：",-1)),l[154]||(l[154]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821091835406.png",alt:"image-20210821091835406",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[155]||(l[155]=t("p",null,"另外，Lua提供了type()函数来判断一个变量的数据类型：",-1)),l[156]||(l[156]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821091904332.png",alt:"image-20210821091904332",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[157]||(l[157]=t("h4",{id:"_3-3-2-声明变量",tabindex:"-1"},[p("3.3.2 声明变量 "),t("a",{class:"header-anchor",href:"#_3-3-2-声明变量","aria-label":'Permalink to "3.3.2 声明变量"'},"​")],-1)),l[158]||(l[158]=t("p",null,"Lua声明变量的时候无需指定数据类型，而是用local来声明变量为局部变量：",-1)),l[159]||(l[159]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明字符串，可以用单引号或双引号，")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," str "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'hello'")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 字符串拼接可以使用 ..")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," str2 "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'hello' "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'world'")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明数字")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," num "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 21")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明布尔类型")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," flag "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[160]||(l[160]=t("p",null,"Lua中的table类型既可以作为数组，又可以作为Java中的map来使用。数组就是特殊的table，key是数组角标而已：",-1)),l[161]||(l[161]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明数组 ，key为角标的 table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," arr "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'java'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'python'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'lua'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明table，类似java的map")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," map "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  {name"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'Jack'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", age"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"21"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[162]||(l[162]=t("p",null,"Lua中的数组角标是从1开始，访问的时候与Java中类似：",-1)),l[163]||(l[163]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 访问数组，lua数组的角标从1开始")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr["),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[164]||(l[164]=t("p",null,"Lua中的table可以用key来访问：",-1)),l[165]||(l[165]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 访问table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map["),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'name'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"name"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[166]||(l[166]=t("h4",{id:"_3-2-3-循环",tabindex:"-1"},[p("3.2.3 循环 "),t("a",{class:"header-anchor",href:"#_3-2-3-循环","aria-label":'Permalink to "3.2.3 循环"'},"​")],-1)),l[167]||(l[167]=t("p",null,"对于table，我们可以利用for循环来遍历。不过数组和普通table遍历略有差异。",-1)),l[168]||(l[168]=t("p",null,"遍历数组：",-1)),l[169]||(l[169]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明数组 key为索引的 table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," arr "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'java'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'python'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'lua'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 遍历数组")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," index,value "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"in"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," ipairs"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr) "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"do")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    print"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(index, value) ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[170]||(l[170]=t("p",null,"遍历普通table",-1)),l[171]||(l[171]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 声明map，也就是table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," map "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {name"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'Jack'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", age"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"21"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 遍历table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key,value "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"in"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," pairs"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(map) "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"do")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"   print"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, value) ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[172]||(l[172]=t("h3",{id:"_3-4-条件控制、函数",tabindex:"-1"},[p("3.4 条件控制、函数 "),t("a",{class:"header-anchor",href:"#_3-4-条件控制、函数","aria-label":'Permalink to "3.4 条件控制、函数"'},"​")],-1)),l[173]||(l[173]=t("p",null,"Lua中的条件控制和函数声明与Java类似。",-1)),l[174]||(l[174]=t("h4",{id:"_3-4-1-函数",tabindex:"-1"},[p("3.4.1 函数 "),t("a",{class:"header-anchor",href:"#_3-4-1-函数","aria-label":'Permalink to "3.4.1 函数"'},"​")],-1)),l[175]||(l[175]=t("p",null,"定义函数的语法：",-1)),l[176]||(l[176]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 函数名( argument1, argument2..., "),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"argumentn"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 函数体")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 返回值")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[177]||(l[177]=t("p",null,"例如，定义一个函数，用来打印数组：",-1)),l[178]||(l[178]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," printArr"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," index, value "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"in"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," ipairs"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr) "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"do")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        print"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[179]||(l[179]=t("h4",{id:"_3-4-2-条件控制",tabindex:"-1"},[p("3.4.2 条件控制 "),t("a",{class:"header-anchor",href:"#_3-4-2-条件控制","aria-label":'Permalink to "3.4.2 条件控制"'},"​")],-1)),l[180]||(l[180]=t("p",null,"类似Java的条件控制，例如if、else语法：",-1)),l[181]||(l[181]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(布尔表达式)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   --[ 布尔表达式为 true 时执行该语句块 --]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   --[ 布尔表达式为 false 时执行该语句块 --]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[182]||(l[182]=t("p",null,"与java不同，布尔表达式中的逻辑运算是基于英文单词：",-1)),l[183]||(l[183]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821092657918.png",alt:"image-20210821092657918",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[184]||(l[184]=t("h4",{id:"_3-4-3-案例",tabindex:"-1"},[p("3.4.3 案例 "),t("a",{class:"header-anchor",href:"#_3-4-3-案例","aria-label":'Permalink to "3.4.3 案例"'},"​")],-1)),l[185]||(l[185]=t("p",null,"需求：自定义一个函数，可以打印table，当参数为nil时，打印错误信息",-1)),l[186]||(l[186]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," printArr"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," arr "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        print"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'数组不能为空！'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," index, value "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"in"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," ipairs"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(arr) "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"do")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        print"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[187]||(l[187]=t("hr",null,null,-1)),l[188]||(l[188]=t("h2",{id:"_4-实现多级缓存",tabindex:"-1"},[p("4. 实现多级缓存 "),t("a",{class:"header-anchor",href:"#_4-实现多级缓存","aria-label":'Permalink to "4. 实现多级缓存"'},"​")],-1)),l[189]||(l[189]=t("p",null,"多级缓存的实现离不开Nginx编程，而Nginx编程又离不开OpenResty。",-1)),l[190]||(l[190]=t("h3",{id:"_4-1-安装openresty",tabindex:"-1"},[p("4.1 安装OpenResty "),t("a",{class:"header-anchor",href:"#_4-1-安装openresty","aria-label":'Permalink to "4.1 安装OpenResty"'},"​")],-1)),l[191]||(l[191]=t("p",null,"OpenResty® 是一个基于 Nginx的高性能 Web 平台，用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。具备下列特点：",-1)),l[192]||(l[192]=t("ul",null,[t("li",null,"具备Nginx的完整功能"),t("li",null,"基于Lua语言进行扩展，集成了大量精良的 Lua 库、第三方模块"),t("li",null,[p("允许使用Lua"),t("strong",null,"自定义业务逻辑"),p("、"),t("strong",null,"自定义库")])],-1)),l[193]||(l[193]=t("p",null,[p("官方网站： "),t("a",{href:"https://openresty.org/cn/",target:"_blank",rel:"noreferrer"},"https://openresty.org/cn/")],-1)),l[194]||(l[194]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821092902946.png",alt:"image-20210821092902946",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[195]||(l[195]=t("h4",{id:"_1-安装",tabindex:"-1"},[p("1. 安装 "),t("a",{class:"header-anchor",href:"#_1-安装","aria-label":'Permalink to "1. 安装"'},"​")],-1)),l[196]||(l[196]=t("p",null,"首先你的Linux虚拟机必须联网",-1)),l[197]||(l[197]=t("h5",{id:"_1-安装开发库",tabindex:"-1"},[t("strong",null,"1）安装开发库"),p(),t("a",{class:"header-anchor",href:"#_1-安装开发库","aria-label":'Permalink to "**1）安装开发库**"'},"​")],-1)),l[198]||(l[198]=t("p",null,"首先要安装OpenResty的依赖开发库，执行命令：",-1)),l[199]||(l[199]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"yum"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -y"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," pcre-devel"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," openssl-devel"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," gcc"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --skip-broken")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[200]||(l[200]=t("h5",{id:"_2-安装openresty仓库",tabindex:"-1"},[t("strong",null,"2）安装OpenResty仓库"),p(),t("a",{class:"header-anchor",href:"#_2-安装openresty仓库","aria-label":'Permalink to "**2）安装OpenResty仓库**"'},"​")],-1)),l[201]||(l[201]=t("p",null,[p("你可以在你的 CentOS 系统中添加 "),t("code",null,"openresty"),p(" 仓库，这样就可以便于未来安装或更新我们的软件包（通过 "),t("code",null,"yum check-update"),p(" 命令）。运行下面的命令就可以添加我们的仓库：")],-1)),l[202]||(l[202]=t("div",{class:"language- max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"}),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",null,"yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[203]||(l[203]=t("p",null,"如果提示说命令不存在，则运行：",-1)),l[204]||(l[204]=t("div",{class:"language- max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"}),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",null,"yum install -y yum-utils")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[205]||(l[205]=t("p",null,"然后再重复上面的命令",-1)),l[206]||(l[206]=t("h5",{id:"_3-安装openresty",tabindex:"-1"},[t("strong",null,"3）安装OpenResty"),p(),t("a",{class:"header-anchor",href:"#_3-安装openresty","aria-label":'Permalink to "**3）安装OpenResty**"'},"​")],-1)),l[207]||(l[207]=t("p",null,[p("然后就可以像下面这样安装软件包，比如 "),t("code",null,"openresty"),p("：")],-1)),l[208]||(l[208]=t("div",{class:"language-bash max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"bash"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"yum"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -y"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," openresty")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[209]||(l[209]=t("h5",{id:"_4-安装opm工具",tabindex:"-1"},[t("strong",null,"4）安装opm工具"),p(),t("a",{class:"header-anchor",href:"#_4-安装opm工具","aria-label":'Permalink to "**4）安装opm工具**"'},"​")],-1)),l[210]||(l[210]=t("p",null,"opm是OpenResty的一个管理工具，可以帮助我们安装一个第三方的Lua模块。",-1)),l[211]||(l[211]=t("p",null,[p("如果你想安装命令行工具 "),t("code",null,"opm"),p("，那么可以像下面这样安装 "),t("code",null,"openresty-opm"),p(" 包：")],-1)),l[212]||(l[212]=t("div",{class:"language-bash max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"bash"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"yum"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -y"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," openresty-opm")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[213]||(l[213]=t("h5",{id:"_5-目录结构",tabindex:"-1"},[t("strong",null,"5）目录结构"),p(),t("a",{class:"header-anchor",href:"#_5-目录结构","aria-label":'Permalink to "**5）目录结构**"'},"​")],-1)),l[214]||(l[214]=t("p",null,"默认情况下，OpenResty安装的目录是：/usr/local/openresty",-1)),l[215]||(l[215]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20200310225539214.png",alt:"image-20200310225539214",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[216]||(l[216]=t("p",null,"看到里面的nginx目录了吗，OpenResty就是在Nginx基础上集成了一些Lua模块。",-1)),l[217]||(l[217]=t("h5",{id:"_6-配置nginx的环境变量",tabindex:"-1"},[t("strong",null,"6）配置nginx的环境变量"),p(),t("a",{class:"header-anchor",href:"#_6-配置nginx的环境变量","aria-label":'Permalink to "**6）配置nginx的环境变量**"'},"​")],-1)),l[218]||(l[218]=t("p",null,"打开配置文件：",-1)),l[219]||(l[219]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vi"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/profile")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[220]||(l[220]=t("p",null,"在最下面加入两行：",-1)),l[221]||(l[221]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"export"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NGINX_HOME"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"/usr/local/openresty/nginx")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"export"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," PATH"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"${NGINX_HOME}/sbin:$PATH")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[222]||(l[222]=t("p",null,"NGINX_HOME：后面是OpenResty安装目录下的nginx的目录",-1)),l[223]||(l[223]=t("p",null,"然后让配置生效：",-1)),l[224]||(l[224]=t("div",{class:"language- max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"}),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",null,"source /etc/profile")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[225]||(l[225]=t("h4",{id:"_2-启动和运行",tabindex:"-1"},[p("2. 启动和运行 "),t("a",{class:"header-anchor",href:"#_2-启动和运行","aria-label":'Permalink to "2. 启动和运行"'},"​")],-1)),l[226]||(l[226]=t("p",null,"OpenResty底层是基于Nginx的，查看OpenResty目录的nginx目录，结构与windows中安装的nginx基本一致：",-1)),l[227]||(l[227]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210811100653291.png",alt:"image-20210811100653291",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[228]||(l[228]=t("p",null,"所以运行方式与nginx基本一致：",-1)),l[229]||(l[229]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 启动nginx")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 重新加载配置")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," reload")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 停止")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stop")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[230]||(l[230]=t("p",null,"nginx的默认配置文件注释太多，影响后续我们的编辑，这里将nginx.conf中的注释部分删除，保留有效部分。",-1)),l[231]||(l[231]=t("p",null,[p("修改"),t("code",null,"/usr/local/openresty/nginx/conf/nginx.conf"),p("文件，内容如下：")],-1)),l[232]||(l[232]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#user  nobody;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"worker_processes "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"error_log "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," logs/error.log;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"events"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    worker_connections "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1024"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    include "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      mime.types;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    default_type "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," application/octet-stream;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    sendfile "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"       on"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    keepalive_timeout "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 65"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    server"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        listen "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"      8081"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        server_name "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," localhost;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        location"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," / "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            root "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  html;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            index "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," index.html index.htm;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        error_page "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  500"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 502"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 503"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 504"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  /50x.html;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        location"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#DBEDFF"}}," /50x.html "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            root "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  html;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[233]||(l[233]=t("p",null,"在Linux的控制台输入命令以启动nginx：",-1)),l[234]||(l[234]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[235]||(l[235]=t("p",null,[p("然后访问页面："),t("a",{href:"http://192.168.150.101:8081",target:"_blank",rel:"noreferrer"},"http://192.168.150.101:8081"),p("，注意ip地址替换为你自己的虚拟机IP：")],-1)),l[236]||(l[236]=t("h4",{id:"_3-备注",tabindex:"-1"},[p("3. 备注 "),t("a",{class:"header-anchor",href:"#_3-备注","aria-label":'Permalink to "3. 备注"'},"​")],-1)),l[237]||(l[237]=t("p",null,"加载OpenResty的lua模块：",-1)),l[238]||(l[238]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#lua 模块")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"lua_package_path"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/usr/local/openresty/lualib/?.lua;;"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#c模块     ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"lua_package_cpath"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/usr/local/openresty/lualib/?.so;;"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[239]||(l[239]=t("p",null,"common.lua",-1)),l[240]||(l[240]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装函数，发送http请求，并解析响应")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"location"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"capture"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path,{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        method "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"HTTP_GET"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        args "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," params,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    })")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 记录错误信息，返回404")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http not found, path: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", path , "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", args: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", args)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exit"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"404"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"body")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 将方法导出")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_http "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[241]||(l[241]=t("p",null,"释放Redis连接API：",-1)),l[242]||(l[242]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 关闭redis连接的工具方法，其实是放入连接池")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," close_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_max_idle_time "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10000"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," -- 连接的空闲时间，单位是毫秒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_size "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," --连接池大小")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set_keepalive"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pool_max_idle_time, pool_size)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"放入redis连接池失败: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[243]||(l[243]=t("p",null,"读取Redis数据的API：",-1)),l[244]||(l[244]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询redis的方法 ip和port是redis地址，key是查询的key")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port, key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 获取一个连接")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"connect"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"连接redis失败 : "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp, err "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询失败处理")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis失败: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err, "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", key = " '),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    --得到的数据为空处理")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"null"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis数据为空, key = "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    close_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[245]||(l[245]=t("p",null,"开启共享词典：",-1)),l[246]||(l[246]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"lua_shared_dict"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item_cache "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"150m"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[247]||(l[247]=t("h3",{id:"_4-2-openresty快速入门",tabindex:"-1"},[p("4.2 OpenResty快速入门 "),t("a",{class:"header-anchor",href:"#_4-2-openresty快速入门","aria-label":'Permalink to "4.2 OpenResty快速入门"'},"​")],-1)),l[248]||(l[248]=t("p",null,"我们希望达到的多级缓存架构如图：",-1)),l[249]||(l[249]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/yeVDlwtfMx.png",alt:"yeVDlwtfMx",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[250]||(l[250]=t("p",null,"其中：",-1)),l[251]||(l[251]=t("ul",null,[t("li",null,[t("p",null,"windows上的nginx用来做反向代理服务，将前端的查询商品的ajax请求代理到OpenResty集群")]),t("li",null,[t("p",null,"OpenResty集群用来编写多级缓存业务")])],-1)),l[252]||(l[252]=t("h4",{id:"_4-2-1-反向代理流程",tabindex:"-1"},[p("4.2.1 反向代理流程 "),t("a",{class:"header-anchor",href:"#_4-2-1-反向代理流程","aria-label":'Permalink to "4.2.1 反向代理流程"'},"​")],-1)),l[253]||(l[253]=t("p",null,"现在，商品详情页使用的是假的商品数据。不过在浏览器中，可以看到页面有发起ajax请求查询真实商品数据。",-1)),l[254]||(l[254]=t("p",null,"这个请求如下：",-1)),l[255]||(l[255]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821093144700.png",alt:"image-20210821093144700",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[256]||(l[256]=t("p",null,"请求地址是localhost，端口是80，就被windows上安装的Nginx服务给接收到了。然后代理给了OpenResty集群：",-1)),l[257]||(l[257]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821094447709.png",alt:"image-20210821094447709",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[258]||(l[258]=t("p",null,"我们需要在OpenResty中编写业务，查询商品数据并返回到浏览器。",-1)),l[259]||(l[259]=t("p",null,"但是这次，我们先在OpenResty接收请求，返回假的商品数据。",-1)),l[260]||(l[260]=t("h4",{id:"_4-2-2-openresty监听请求",tabindex:"-1"},[p("4.2.2 OpenResty监听请求 "),t("a",{class:"header-anchor",href:"#_4-2-2-openresty监听请求","aria-label":'Permalink to "4.2.2 OpenResty监听请求"'},"​")],-1)),l[261]||(l[261]=t("p",null,"OpenResty的很多功能都依赖于其目录下的Lua库，需要在nginx.conf中指定依赖库的目录，并导入依赖：",-1)),l[262]||(l[262]=t("p",null,"1）添加对OpenResty的Lua模块的加载",-1)),l[263]||(l[263]=t("p",null,[p("修改"),t("code",null,"/usr/local/openresty/nginx/conf/nginx.conf"),p("文件，在其中的http下面，添加下面代码：")],-1)),l[264]||(l[264]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#lua 模块")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"lua_package_path"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/usr/local/openresty/lualib/?.lua;;"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#c模块     ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"lua_package_cpath"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/usr/local/openresty/lualib/?.so;;"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[265]||(l[265]=t("p",null,[p("2）监听"),t("code",null,"/api/item"),p("路径")],-1)),l[266]||(l[266]=t("p",null,[p("修改"),t("code",null,"/usr/local/openresty/nginx/conf/nginx.conf"),p("文件，在nginx.conf的server下面，添加对/api/item这个路径的监听：")],-1)),l[267]||(l[267]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"location"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  /api/item "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    # 默认的响应类型")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    default_type "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"application/json;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    # 响应结果由lua/item.lua文件来决定")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    content_by_lua_file"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lua/item.lua;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[268]||(l[268]=t("p",null,[p("这个监听，就类似于SpringMVC中的"),t("code",null,'@GetMapping("/api/item")'),p("做路径映射。")],-1)),l[269]||(l[269]=t("p",null,[p("而"),t("code",null,"content_by_lua_file lua/item.lua"),p("则相当于调用item.lua这个文件，执行其中的业务，把结果返回给用户。相当于java中调用service。")],-1)),l[270]||(l[270]=t("h4",{id:"_4-2-3-编写item-lua",tabindex:"-1"},[p("4.2.3 编写item.lua "),t("a",{class:"header-anchor",href:"#_4-2-3-编写item-lua","aria-label":'Permalink to "4.2.3 编写item.lua"'},"​")],-1)),l[271]||(l[271]=t("p",null,[p("1）在"),t("code",null,"/usr/loca/openresty/nginx"),p("目录创建文件夹：lua")],-1)),l[272]||(l[272]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821100755080.png",alt:"image-20210821100755080",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[273]||(l[273]=t("p",null,[p("2）在"),t("code",null,"/usr/loca/openresty/nginx/lua"),p("文件夹下，新建文件："),t("code",null,"item.lua")],-1)),l[274]||(l[274]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821100801756.png",alt:"image-20210821100801756",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[275]||(l[275]=t("p",null,"3）编写item.lua，返回假数据",-1)),l[276]||(l[276]=t("p",null,[t("code",null,"item.lua"),p("中，利用"),t("code",null,"ngx.say()"),p("函数返回数据到Response中")],-1)),l[277]||(l[277]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"say"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'\'{"id":10001,"name":"SALSA AIR","title":"RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4","price":17900,"image":"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp","category":"拉杆箱","brand":"RIMOWA","spec":"","status":1,"createTime":"2019-04-30T16:00:00.000+00:00","updateTime":"2019-04-30T16:00:00.000+00:00","stock":2999,"sold":31290}\''),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[278]||(l[278]=t("p",null,"4）重新加载配置",-1)),l[279]||(l[279]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," reload")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[280]||(l[280]=t("p",null,[p("刷新商品页面："),t("a",{href:"http://localhost/item.html?id=1001%EF%BC%8C%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E6%95%88%E6%9E%9C%EF%BC%9A",target:"_blank",rel:"noreferrer"},"http://localhost/item.html?id=1001，即可看到效果：")],-1)),l[281]||(l[281]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821101217089.png",alt:"image-20210821101217089",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[282]||(l[282]=t("h3",{id:"_4-3-请求参数处理",tabindex:"-1"},[p("4.3 请求参数处理 "),t("a",{class:"header-anchor",href:"#_4-3-请求参数处理","aria-label":'Permalink to "4.3 请求参数处理"'},"​")],-1)),l[283]||(l[283]=t("p",null,"上一节中，我们在OpenResty接收前端请求，但是返回的是假数据。",-1)),l[284]||(l[284]=t("p",null,"要返回真实数据，必须根据前端传递来的商品id，查询商品信息才可以。",-1)),l[285]||(l[285]=t("p",null,"那么如何获取前端传递的商品参数呢？",-1)),l[286]||(l[286]=t("h4",{id:"_4-3-1-获取参数的api",tabindex:"-1"},[p("4.3.1 获取参数的API "),t("a",{class:"header-anchor",href:"#_4-3-1-获取参数的api","aria-label":'Permalink to "4.3.1 获取参数的API"'},"​")],-1)),l[287]||(l[287]=t("p",null,"OpenResty中提供了一些API用来获取不同类型的前端请求参数：",-1)),l[288]||(l[288]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821101433528.png",alt:"image-20210821101433528",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[289]||(l[289]=t("h4",{id:"_4-3-2-获取参数并返回",tabindex:"-1"},[p("4.3.2 获取参数并返回 "),t("a",{class:"header-anchor",href:"#_4-3-2-获取参数并返回","aria-label":'Permalink to "4.3.2 获取参数并返回"'},"​")],-1)),l[290]||(l[290]=t("p",null,"在前端发起的ajax请求如图：",-1)),l[291]||(l[291]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821101721649.png",alt:"image-20210821101721649",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[292]||(l[292]=t("p",null,"可以看到商品id是以路径占位符方式传递的，因此可以利用正则表达式匹配的方式来获取ID",-1)),l[293]||(l[293]=t("p",null,"1）获取商品id",-1)),l[294]||(l[294]=t("p",null,[p("修改"),t("code",null,"/usr/loca/openresty/nginx/nginx.conf"),p("文件中监听/api/item的代码，利用正则表达式获取ID：")],-1)),l[295]||(l[295]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"location"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ~"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#DBEDFF"}}," /api/item/(\\d+) "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    # 默认的响应类型")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    default_type "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"application/json;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    # 响应结果由lua/item.lua文件来决定")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    content_by_lua_file"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lua/item.lua;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[296]||(l[296]=t("p",null,"2）拼接ID并返回",-1)),l[297]||(l[297]=t("p",null,[p("修改"),t("code",null,"/usr/loca/openresty/nginx/lua/item.lua"),p("文件，获取id并拼接到结果中返回：")],-1)),l[298]||(l[298]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取商品id")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"var"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 拼接并返回")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"say"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'{\"id\":' "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' \',"name":"SALSA AIR","title":"RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4","price":17900,"image":"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp","category":"拉杆箱","brand":"RIMOWA","spec":"","status":1,"createTime":"2019-04-30T16:00:00.000+00:00","updateTime":"2019-04-30T16:00:00.000+00:00","stock":2999,"sold":31290}\''),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[299]||(l[299]=t("p",null,"3）重新加载并测试",-1)),l[300]||(l[300]=t("p",null,"运行命令以重新加载OpenResty配置：",-1)),l[301]||(l[301]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," reload")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[302]||(l[302]=t("p",null,"刷新页面可以看到结果中已经带上了ID：",-1)),l[303]||(l[303]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821102235467.png",alt:"image-20210821102235467",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[304]||(l[304]=t("h3",{id:"_4-4-查询tomcat",tabindex:"-1"},[p("4.4 查询Tomcat "),t("a",{class:"header-anchor",href:"#_4-4-查询tomcat","aria-label":'Permalink to "4.4 查询Tomcat"'},"​")],-1)),l[305]||(l[305]=t("p",null,"拿到商品ID后，本应去缓存中查询商品信息，不过目前我们还未建立nginx、redis缓存。因此，这里我们先根据商品id去tomcat查询商品信息。我们实现如图部分：",-1)),l[306]||(l[306]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821102610167.png",alt:"image-20210821102610167",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[307]||(l[307]=t("p",null,"需要注意的是，我们的OpenResty是在虚拟机，Tomcat是在Windows电脑上。两者IP一定不要搞错了。",-1)),l[308]||(l[308]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821102959829.png",alt:"image-20210821102959829",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[309]||(l[309]=t("h4",{id:"_4-4-1-发送http请求的api",tabindex:"-1"},[p("4.4.1 发送http请求的API "),t("a",{class:"header-anchor",href:"#_4-4-1-发送http请求的api","aria-label":'Permalink to "4.4.1 发送http请求的API"'},"​")],-1)),l[310]||(l[310]=t("p",null,"nginx提供了内部API用以发送http请求：",-1)),l[311]||(l[311]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"location"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"capture"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/path"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    method "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"HTTP_GET"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",   "),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 请求方式")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    args "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {a"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",b"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"},  "),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- get方式传参数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"})")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[312]||(l[312]=t("p",null,"返回的响应内容包括：",-1)),l[313]||(l[313]=t("ul",null,[t("li",null,"resp.status：响应状态码"),t("li",null,"resp.header：响应头，是一个table"),t("li",null,"resp.body：响应体，就是响应数据")],-1)),l[314]||(l[314]=t("p",null,"注意：这里的path是路径，并不包含IP和端口。这个请求会被nginx内部的server监听并处理。",-1)),l[315]||(l[315]=t("p",null,"但是我们希望这个请求发送到Tomcat服务器，所以还需要编写一个server来对这个路径做反向代理：",-1)),l[316]||(l[316]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," location"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," /path "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     # 这里是windows电脑的ip和Java服务端口，需要确保windows防火墙处于关闭状态")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"     proxy_pass "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"http://192.168.150.1:8081; ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," }")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[317]||(l[317]=t("p",null,"原理如图：",-1)),l[318]||(l[318]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821104149061.png",alt:"image-20210821104149061",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[319]||(l[319]=t("h4",{id:"_4-4-2-封装http工具",tabindex:"-1"},[p("4.4.2 封装http工具 "),t("a",{class:"header-anchor",href:"#_4-4-2-封装http工具","aria-label":'Permalink to "4.4.2 封装http工具"'},"​")],-1)),l[320]||(l[320]=t("p",null,"下面，我们封装一个发送Http请求的工具，基于ngx.location.capture来实现查询tomcat。",-1)),l[321]||(l[321]=t("p",null,"1）添加反向代理，到windows的Java服务",-1)),l[322]||(l[322]=t("p",null,"因为item-service中的接口都是/item开头，所以我们监听/item路径，代理到windows上的tomcat服务。",-1)),l[323]||(l[323]=t("p",null,[p("修改 "),t("code",null,"/usr/local/openresty/nginx/conf/nginx.conf"),p("文件，添加一个location：")],-1)),l[324]||(l[324]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"location"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," /item "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    proxy_pass "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"http://192.168.150.1:8081;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[325]||(l[325]=t("p",null,[p("以后，只要我们调用"),t("code",null,'ngx.location.capture("/item")'),p("，就一定能发送请求到windows的tomcat服务。")],-1)),l[326]||(l[326]=t("p",null,"2）封装工具类",-1)),l[327]||(l[327]=t("p",null,"之前我们说过，OpenResty启动时会加载以下两个目录中的工具文件：",-1)),l[328]||(l[328]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821104857413.png",alt:"image-20210821104857413",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[329]||(l[329]=t("p",null,"所以，自定义的http工具也需要放到这个目录下。",-1)),l[330]||(l[330]=t("p",null,[p("在"),t("code",null,"/usr/local/openresty/lualib"),p("目录下，新建一个common.lua文件：")],-1)),l[331]||(l[331]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vi"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /usr/local/openresty/lualib/common.lua")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[332]||(l[332]=t("p",null,"内容如下:",-1)),l[333]||(l[333]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装函数，发送http请求，并解析响应")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"location"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"capture"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path,{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        method "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"HTTP_GET"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        args "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," params,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    })")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 记录错误信息，返回404")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http请求查询失败, path: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", path , "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", args: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", args)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exit"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"404"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"body")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 将方法导出")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_http "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[334]||(l[334]=t("p",null,"这个工具将read_http函数封装到_M这个table类型的变量中，并且返回，这类似于导出。",-1)),l[335]||(l[335]=t("p",null,[p("使用的时候，可以利用"),t("code",null,"require('common')"),p("来导入该函数库，这里的common是函数库的文件名。")],-1)),l[336]||(l[336]=t("p",null,"3）实现商品查询",-1)),l[337]||(l[337]=t("p",null,[p("最后，我们修改"),t("code",null,"/usr/local/openresty/lua/item.lua"),p("文件，利用刚刚封装的函数库实现对tomcat的查询：")],-1)),l[338]||(l[338]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 引入自定义common工具模块，返回值是common中返回的 _M")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"common"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 从 common中获取read_http这个函数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_http")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取路径参数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"var"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 根据id查询商品")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemJSON "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 根据id查询商品库存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemStockJSON "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/stock/"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[339]||(l[339]=t("p",null,"这里查询到的结果是json字符串，并且包含商品、库存两个json字符串，页面最终需要的是把两个json拼接为一个json：",-1)),l[340]||(l[340]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821110441222.png",alt:"image-20210821110441222",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[341]||(l[341]=t("p",null,"这就需要我们先把JSON变为lua的table，完成数据整合后，再转为JSON。",-1)),l[342]||(l[342]=t("h4",{id:"_4-4-3-cjson工具类",tabindex:"-1"},[p("4.4.3 CJSON工具类 "),t("a",{class:"header-anchor",href:"#_4-4-3-cjson工具类","aria-label":'Permalink to "4.4.3 CJSON工具类"'},"​")],-1)),l[343]||(l[343]=t("p",null,"OpenResty提供了一个cjson的模块用来处理JSON的序列化和反序列化。",-1)),l[344]||(l[344]=t("p",null,[p("官方地址： "),t("a",{href:"https://github.com/openresty/lua-cjson/",target:"_blank",rel:"noreferrer"},"https://github.com/openresty/lua-cjson/")],-1)),l[345]||(l[345]=t("p",null,"1）引入cjson模块：",-1)),l[346]||(l[346]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "cjson"')])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[347]||(l[347]=t("p",null,"2）序列化：",-1)),l[348]||(l[348]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," obj "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    name "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'jack'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    age "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 21")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 把 table 序列化为 json")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," json "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"encode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(obj)")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[349]||(l[349]=t("p",null,"3）反序列化：",-1)),l[350]||(l[350]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," json "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' \'{"name": "jack", "age": 21}\'')]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 反序列化 json为 table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," obj "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(obj."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"name"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[351]||(l[351]=t("h4",{id:"_4-4-4-实现tomcat查询",tabindex:"-1"},[p("4.4.4 实现Tomcat查询 "),t("a",{class:"header-anchor",href:"#_4-4-4-实现tomcat查询","aria-label":'Permalink to "4.4.4 实现Tomcat查询"'},"​")],-1)),l[352]||(l[352]=t("p",null,"下面，我们修改之前的item.lua中的业务，添加json处理功能：",-1)),l[353]||(l[353]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入common函数库")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'common'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_http")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入cjson库")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'cjson'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取路径参数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"var"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 根据id查询商品")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemJSON "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 根据id查询商品库存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemStockJSON "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/stock/"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- JSON转化为lua的table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(itemJSON)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stockJSON)")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 组合数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 把item序列化为json 返回结果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"say"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cjson."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"encode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item))")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[354]||(l[354]=t("h4",{id:"_4-4-5-基于id负载均衡",tabindex:"-1"},[p("4.4.5 基于ID负载均衡 "),t("a",{class:"header-anchor",href:"#_4-4-5-基于id负载均衡","aria-label":'Permalink to "4.4.5 基于ID负载均衡"'},"​")],-1)),l[355]||(l[355]=t("p",null,"刚才的代码中，我们的tomcat是单机部署。而实际开发中，tomcat一定是集群模式：",-1)),l[356]||(l[356]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821111023255.png",alt:"image-20210821111023255",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[357]||(l[357]=t("p",null,"因此，OpenResty需要对tomcat集群做负载均衡。",-1)),l[358]||(l[358]=t("p",null,"而默认的负载均衡规则是轮询模式，当我们查询/item/10001时：",-1)),l[359]||(l[359]=t("ul",null,[t("li",null,"第一次会访问8081端口的tomcat服务，在该服务内部就形成了JVM进程缓存"),t("li",null,"第二次会访问8082端口的tomcat服务，该服务内部没有JVM缓存（因为JVM缓存无法共享），会查询数据库"),t("li",null,"…")],-1)),l[360]||(l[360]=t("p",null,"你看，因为轮询的原因，第一次查询8081形成的JVM缓存并未生效，直到下一次再次访问到8081时才可以生效，缓存命中率太低了。",-1)),l[361]||(l[361]=t("p",null,"怎么办？",-1)),l[362]||(l[362]=t("p",null,"如果能让同一个商品，每次查询时都访问同一个tomcat服务，那么JVM缓存就一定能生效了。",-1)),l[363]||(l[363]=t("p",null,"也就是说，我们需要根据商品id做负载均衡，而不是轮询。",-1)),l[364]||(l[364]=t("h5",{id:"_1-原理",tabindex:"-1"},[p("1）原理 "),t("a",{class:"header-anchor",href:"#_1-原理","aria-label":'Permalink to "1）原理"'},"​")],-1)),l[365]||(l[365]=t("p",null,"nginx提供了基于请求路径做负载均衡的算法：",-1)),l[366]||(l[366]=t("p",null,"nginx根据请求路径做hash运算，把得到的数值对tomcat服务的数量取余，余数是几，就访问第几个服务，实现负载均衡。",-1)),l[367]||(l[367]=t("p",null,"例如：",-1)),l[368]||(l[368]=t("ul",null,[t("li",null,"我们的请求路径是 /item/10001"),t("li",null,"tomcat总数为2台（8081、8082）"),t("li",null,"对请求路径/item/1001做hash运算求余的结果为1"),t("li",null,"则访问第一个tomcat服务，也就是8081")],-1)),l[369]||(l[369]=t("p",null,"只要id不变，每次hash运算结果也不会变，那就可以保证同一个商品，一直访问同一个tomcat服务，确保JVM缓存生效。",-1)),l[370]||(l[370]=t("h5",{id:"_2-实现",tabindex:"-1"},[p("2）实现 "),t("a",{class:"header-anchor",href:"#_2-实现","aria-label":'Permalink to "2）实现"'},"​")],-1)),l[371]||(l[371]=t("p",null,[p("修改"),t("code",null,"/usr/local/openresty/nginx/conf/nginx.conf"),p("文件，实现基于ID做负载均衡。")],-1)),l[372]||(l[372]=t("p",null,"首先，定义tomcat集群，并设置基于路径做负载均衡：",-1)),l[373]||(l[373]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"upstream"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," tomcat-cluster "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    hash "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$request_uri;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    server"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 192.168.150.1:8081;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    server"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," 192.168.150.1:8082;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[374]||(l[374]=t("p",null,"然后，修改对tomcat服务的反向代理，目标指向tomcat集群：",-1)),l[375]||(l[375]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"location"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," /item "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    proxy_pass "),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"http://tomcat-cluster;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[376]||(l[376]=t("p",null,"重新加载OpenResty",-1)),l[377]||(l[377]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nginx"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," reload")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[378]||(l[378]=t("h5",{id:"_3-测试",tabindex:"-1"},[p("3）测试 "),t("a",{class:"header-anchor",href:"#_3-测试","aria-label":'Permalink to "3）测试"'},"​")],-1)),l[379]||(l[379]=t("p",null,"启动两台tomcat服务：",-1)),l[380]||(l[380]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821112420464.png",alt:"image-20210821112420464",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[381]||(l[381]=t("p",null,"同时启动：",-1)),l[382]||(l[382]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821112444482.png",alt:"image-20210821112444482",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[383]||(l[383]=t("p",null,"清空日志后，再次访问页面，可以看到不同id的商品，访问到了不同的tomcat服务：",-1)),l[384]||(l[384]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821112559965.png",alt:"image-20210821112559965",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[385]||(l[385]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821112637430.png",alt:"image-20210821112637430",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[386]||(l[386]=t("h3",{id:"_4-5-redis缓存预热",tabindex:"-1"},[p("4.5 Redis缓存预热 "),t("a",{class:"header-anchor",href:"#_4-5-redis缓存预热","aria-label":'Permalink to "4.5 Redis缓存预热"'},"​")],-1)),l[387]||(l[387]=t("p",null,"Redis缓存会面临冷启动问题：",-1)),l[388]||(l[388]=t("p",null,[t("strong",null,"冷启动"),p("：服务刚刚启动时，Redis中并没有缓存，如果所有商品数据都在第一次查询时添加缓存，可能会给数据库带来较大压力。")],-1)),l[389]||(l[389]=t("p",null,[t("strong",null,"缓存预热"),p("：在实际开发中，我们可以利用大数据统计用户访问的热点数据，在项目启动时将这些热点数据提前查询并保存到Redis中。")],-1)),l[390]||(l[390]=t("p",null,"我们数据量较少，并且没有数据统计相关功能，目前可以在启动时将所有数据都放入缓存中。",-1)),l[391]||(l[391]=t("p",null,"1）利用Docker安装Redis",-1)),l[392]||(l[392]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --name"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 6379:6379"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," redis-server"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --appendonly"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," yes")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[393]||(l[393]=t("p",null,"2）在item-service服务中引入Redis依赖",-1)),l[394]||(l[394]=t("div",{class:"language-xml max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"xml"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">org.springframework.boot</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-boot-starter-data-redis</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[395]||(l[395]=t("p",null,"3）配置Redis地址",-1)),l[396]||(l[396]=t("div",{class:"language-yaml max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"yaml"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    host"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"192.168.150.101")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[397]||(l[397]=t("p",null,"4）编写初始化类",-1)),l[398]||(l[398]=t("p",null,"缓存预热需要在项目启动时完成，并且必须是拿到RedisTemplate之后。",-1)),l[399]||(l[399]=t("p",null,"这里我们利用InitializingBean接口来实现，因为InitializingBean可以在对象被Spring创建并且成员变量全部注入后执行。",-1)),l[400]||(l[400]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.config;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.fasterxml.jackson.core.JsonProcessingException;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.fasterxml.jackson.databind.ObjectMapper;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.Item;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.ItemStock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.service.IItemService;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.service.IItemStockService;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.InitializingBean;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.annotation.Autowired;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.data.redis.core.StringRedisTemplate;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.List;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisHandler"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InitializingBean"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate redisTemplate;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemService itemService;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemStockService stockService;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectMapper MAPPER "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ObjectMapper"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," afterPropertiesSet"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 初始化缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.查询商品信息")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> itemList "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.放入缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Item item "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemList) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.1.item序列化为JSON")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAPPER."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.2.存入redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redisTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), json);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.查询商品库存信息")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ItemStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> stockList "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.放入缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ItemStock stock "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockList) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.1.item序列化为JSON")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAPPER."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stock);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.2.存入redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redisTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:stock:id:"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), json);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[401]||(l[401]=t("h3",{id:"_4-6-查询redis缓存",tabindex:"-1"},[p("4.6 查询Redis缓存 "),t("a",{class:"header-anchor",href:"#_4-6-查询redis缓存","aria-label":'Permalink to "4.6 查询Redis缓存"'},"​")],-1)),l[402]||(l[402]=t("p",null,"现在，Redis缓存已经准备就绪，我们可以再OpenResty中实现查询Redis的逻辑了。如下图红框所示：",-1)),l[403]||(l[403]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821113340111.png",alt:"image-20210821113340111",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[404]||(l[404]=t("p",null,"当请求进入OpenResty之后：",-1)),l[405]||(l[405]=t("ul",null,[t("li",null,"优先查询Redis缓存"),t("li",null,"如果Redis缓存未命中，再查询Tomcat")],-1)),l[406]||(l[406]=t("h4",{id:"_4-6-1-封装redis工具",tabindex:"-1"},[p("4.6.1 封装Redis工具 "),t("a",{class:"header-anchor",href:"#_4-6-1-封装redis工具","aria-label":'Permalink to "4.6.1 封装Redis工具"'},"​")],-1)),l[407]||(l[407]=t("p",null,"OpenResty提供了操作Redis的模块，我们只要引入该模块就能直接使用。但是为了方便，我们将Redis操作封装到之前的common.lua工具库中。",-1)),l[408]||(l[408]=t("p",null,[p("修改"),t("code",null,"/usr/local/openresty/lualib/common.lua"),p("文件：")],-1)),l[409]||(l[409]=t("p",null,"1）引入Redis模块，并初始化Redis对象",-1)),l[410]||(l[410]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'resty.redis'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 初始化redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," red "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"red"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set_timeouts"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[411]||(l[411]=t("p",null,"2）封装函数，用来释放Redis连接，其实是放入连接池",-1)),l[412]||(l[412]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 关闭redis连接的工具方法，其实是放入连接池")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," close_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_max_idle_time "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10000"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," -- 连接的空闲时间，单位是毫秒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_size "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," --连接池大小")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set_keepalive"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pool_max_idle_time, pool_size)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"放入redis连接池失败: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[413]||(l[413]=t("p",null,"3）封装函数，根据key查询Redis数据",-1)),l[414]||(l[414]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询redis的方法 ip和port是redis地址，key是查询的key")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port, key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 获取一个连接")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"connect"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"连接redis失败 : "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp, err "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询失败处理")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis失败: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err, "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", key = " '),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    --得到的数据为空处理")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"null"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis数据为空, key = "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    close_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[415]||(l[415]=t("p",null,"4）导出",-1)),l[416]||(l[416]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 将方法导出")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_http "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_redis "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[417]||(l[417]=t("p",null,"完整的common.lua：",-1)),l[418]||(l[418]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," redis "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'resty.redis'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 初始化redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," red "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"new"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"red"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set_timeouts"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 关闭redis连接的工具方法，其实是放入连接池")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," close_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_max_idle_time "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10000"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," -- 连接的空闲时间，单位是毫秒")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pool_size "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," --连接池大小")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set_keepalive"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pool_max_idle_time, pool_size)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"放入redis连接池失败: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询redis的方法 ip和port是redis地址，key是查询的key")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port, key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 获取一个连接")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok, err "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"connect"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, port)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ok "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"连接redis失败 : "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp, err "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," red"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询失败处理")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis失败: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", err, "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", key = " '),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    --得到的数据为空处理")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"null"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," nil")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询Redis数据为空, key = "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    close_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(red)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装函数，发送http请求，并解析响应")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"location"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"capture"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path,{")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        method "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"HTTP_GET"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        args "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," params,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    })")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 记录错误信息，返回404")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"http查询失败, path: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", path , "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'", args: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", args)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exit"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"404"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," resp."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"body")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 将方法导出")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_http "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http,")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    read_redis "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}  ")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," _M")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[419]||(l[419]=t("h4",{id:"_4-6-2-实现redis查询",tabindex:"-1"},[p("4.6.2 实现Redis查询 "),t("a",{class:"header-anchor",href:"#_4-6-2-实现redis查询","aria-label":'Permalink to "4.6.2 实现Redis查询"'},"​")],-1)),l[420]||(l[420]=t("p",null,"接下来，我们就可以去修改item.lua文件，实现对Redis的查询了。",-1)),l[421]||(l[421]=t("p",null,"查询逻辑是：",-1)),l[422]||(l[422]=t("ul",null,[t("li",null,"根据id查询Redis"),t("li",null,"如果查询失败则继续查询Tomcat"),t("li",null,"将查询结果返回")],-1)),l[423]||(l[423]=t("p",null,[p("1）修改"),t("code",null,"/usr/local/openresty/lua/item.lua"),p("文件，添加一个查询函数：")],-1)),l[424]||(l[424]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入common函数库")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'common'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_http")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_redis "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装查询函数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_data"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, path, params)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询本地缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"127.0.0.1"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 判断查询结果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis查询失败，尝试查询http， key: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- redis查询失败，去查询http")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 返回数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[425]||(l[425]=t("p",null,"2）而后修改商品查询、库存查询的业务：",-1)),l[426]||(l[426]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821114528954.png",alt:"image-20210821114528954",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[427]||(l[427]=t("p",null,"3）完整的item.lua代码：",-1)),l[428]||(l[428]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入common函数库")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'common'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_http")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_redis "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入cjson库")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'cjson'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装查询函数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_data"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, path, params)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询本地缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"127.0.0.1"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 判断查询结果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis查询失败，尝试查询http， key: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- redis查询失败，去查询http")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 返回数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取路径参数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"var"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询商品信息")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemJSON "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_data"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:" '),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id,  "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/" '),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询库存信息")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockJSON "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_data"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:stock:id:" '),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/stock/" '),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- JSON转化为lua的table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(itemJSON)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stockJSON)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 组合数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 把item序列化为json 返回结果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"say"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cjson."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"encode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item))")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[429]||(l[429]=t("h3",{id:"_4-7-nginx本地缓存",tabindex:"-1"},[p("4.7 Nginx本地缓存 "),t("a",{class:"header-anchor",href:"#_4-7-nginx本地缓存","aria-label":'Permalink to "4.7 Nginx本地缓存"'},"​")],-1)),l[430]||(l[430]=t("p",null,"现在，整个多级缓存中只差最后一环，也就是nginx的本地缓存了。如图：",-1)),l[431]||(l[431]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821114742950.png",alt:"image-20210821114742950",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[432]||(l[432]=t("h4",{id:"_4-7-1-本地缓存api",tabindex:"-1"},[p("4.7.1 本地缓存API "),t("a",{class:"header-anchor",href:"#_4-7-1-本地缓存api","aria-label":'Permalink to "4.7.1 本地缓存API"'},"​")],-1)),l[433]||(l[433]=t("p",null,[p("OpenResty为Nginx提供了"),t("strong",null,"shard dict"),p("的功能，可以在nginx的多个worker之间共享数据，实现缓存功能。")],-1)),l[434]||(l[434]=t("p",null,"1）开启共享字典，在nginx.conf的http下添加配置：",-1)),l[435]||(l[435]=t("div",{class:"language-nginx max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"nginx"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," lua_shared_dict"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item_cache "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"150m"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[436]||(l[436]=t("p",null,"2）操作共享字典：",-1)),l[437]||(l[437]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取本地缓存对象")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item_cache "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"shared"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"item_cache")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 存储, 指定key、value、过期时间，单位s，默认为0代表永不过期")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"item_cache"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'key'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'value'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1000"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 读取")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," item_cache"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'key'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[438]||(l[438]=t("h4",{id:"_4-7-2-实现本地缓存查询",tabindex:"-1"},[p("4.7.2 实现本地缓存查询 "),t("a",{class:"header-anchor",href:"#_4-7-2-实现本地缓存查询","aria-label":'Permalink to "4.7.2 实现本地缓存查询"'},"​")],-1)),l[439]||(l[439]=t("p",null,[p("1）修改"),t("code",null,"/usr/local/openresty/lua/item.lua"),p("文件，修改read_data查询函数，添加本地缓存逻辑：")],-1)),l[440]||(l[440]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入共享词典，本地缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item_cache "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"shared"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"item_cache")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装查询函数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_data"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, expire, path, params)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询本地缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," item_cache"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"本地缓存查询失败，尝试查询Redis， key: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 查询redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"127.0.0.1"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 判断查询结果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis查询失败，尝试查询http， key: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            -- redis查询失败，去查询http")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询成功，把数据写入本地缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    item_cache"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, val, expire)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 返回数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[441]||(l[441]=t("p",null,"2）修改item.lua中查询商品和库存的业务，实现最新的read_data函数：",-1)),l[442]||(l[442]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821115108528.png",alt:"image-20210821115108528",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[443]||(l[443]=t("p",null,"其实就是多了缓存时间参数，过期后nginx缓存会自动删除，下次访问即可更新缓存。",-1)),l[444]||(l[444]=t("p",null,"这里给商品基本信息设置超时时间为30分钟，库存为1分钟。",-1)),l[445]||(l[445]=t("p",null,"因为库存更新频率较高，如果缓存时间过长，可能与数据库差异较大。",-1)),l[446]||(l[446]=t("p",null,"3）完整的item.lua文件：",-1)),l[447]||(l[447]=t("div",{class:"language-lua max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"lua"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入common函数库")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'common'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_http "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_http")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," read_redis "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," common."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"read_redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入cjson库")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," require"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'cjson'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 导入共享词典，本地缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item_cache "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"shared"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"item_cache")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 封装查询函数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"function"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," read_data"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, expire, path, params)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询本地缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," item_cache"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"get"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"本地缓存查询失败，尝试查询Redis， key: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 查询redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_redis"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"127.0.0.1"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"6379"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        -- 判断查询结果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"then")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"log"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ERR"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"redis查询失败，尝试查询http， key: "'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            -- redis查询失败，去查询http")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            val "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_http"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(path, params)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    end")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 查询成功，把数据写入本地缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    item_cache"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"set"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, val, expire)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    -- 返回数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," val")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"end")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 获取路径参数")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ngx."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"var"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询商品信息")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemJSON "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_data"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:" '),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1800"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",  "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/" '),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 查询库存信息")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockJSON "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," read_data"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:stock:id:" '),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"60"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/item/stock/" '),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},".."),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id, "),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"nil"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- JSON转化为lua的table")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(itemJSON)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"local"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cjson."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"decode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stockJSON)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 组合数据")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stock")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sold")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 把item序列化为json 返回结果")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ngx."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"say"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cjson."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"encode"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item))")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[448]||(l[448]=t("hr",null,null,-1)),l[449]||(l[449]=t("h2",{id:"_5-缓存同步",tabindex:"-1"},[p("5. 缓存同步 "),t("a",{class:"header-anchor",href:"#_5-缓存同步","aria-label":'Permalink to "5. 缓存同步"'},"​")],-1)),l[450]||(l[450]=t("p",null,"大多数情况下，浏览器查询到的都是缓存数据，如果缓存数据与数据库数据存在较大差异，可能会产生比较严重的后果。",-1)),l[451]||(l[451]=t("p",null,"所以我们必须保证数据库数据、缓存数据的一致性，这就是缓存与数据库的同步。",-1)),l[452]||(l[452]=t("h3",{id:"_5-1-数据同步策略",tabindex:"-1"},[p("5.1 数据同步策略 "),t("a",{class:"header-anchor",href:"#_5-1-数据同步策略","aria-label":'Permalink to "5.1 数据同步策略"'},"​")],-1)),l[453]||(l[453]=t("p",null,"缓存数据同步的常见方式有三种：",-1)),l[454]||(l[454]=t("p",null,[t("strong",null,"设置有效期"),p("：给缓存设置有效期，到期后自动删除。再次查询时更新")],-1)),l[455]||(l[455]=t("ul",null,[t("li",null,"优势：简单、方便"),t("li",null,"缺点：时效性差，缓存过期之前可能不一致"),t("li",null,"场景：更新频率较低，时效性要求低的业务")],-1)),l[456]||(l[456]=t("p",null,[t("strong",null,"同步双写"),p("：在修改数据库的同时，直接修改缓存")],-1)),l[457]||(l[457]=t("ul",null,[t("li",null,"优势：时效性强，缓存与数据库强一致"),t("li",null,"缺点：有代码侵入，耦合度高；"),t("li",null,"场景：对一致性、时效性要求较高的缓存数据")],-1)),l[458]||(l[458]=t("p",null,"**异步通知：**修改数据库时发送事件通知，相关服务监听到通知后修改缓存数据",-1)),l[459]||(l[459]=t("ul",null,[t("li",null,"优势：低耦合，可以同时通知多个缓存服务"),t("li",null,"缺点：时效性一般，可能存在中间不一致状态"),t("li",null,"场景：时效性要求一般，有多个服务需要同步")],-1)),l[460]||(l[460]=t("p",null,"而异步实现又可以基于MQ或者Canal来实现：",-1)),l[461]||(l[461]=t("h4",{id:"_1-基于mq的异步通知",tabindex:"-1"},[p("1）基于MQ的异步通知： "),t("a",{class:"header-anchor",href:"#_1-基于mq的异步通知","aria-label":'Permalink to "1）基于MQ的异步通知："'},"​")],-1)),l[462]||(l[462]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821115552327.png",alt:"image-20210821115552327",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[463]||(l[463]=t("p",null,"解读：",-1)),l[464]||(l[464]=t("ul",null,[t("li",null,"商品服务完成对数据的修改后，只需要发送一条消息到MQ中。"),t("li",null,"缓存服务监听MQ消息，然后完成对缓存的更新")],-1)),l[465]||(l[465]=t("p",null,"依然有少量的代码侵入。",-1)),l[466]||(l[466]=t("h4",{id:"_2-基于canal的通知",tabindex:"-1"},[p("2）基于Canal的通知 "),t("a",{class:"header-anchor",href:"#_2-基于canal的通知","aria-label":'Permalink to "2）基于Canal的通知"'},"​")],-1)),l[467]||(l[467]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821115719363.png",alt:"image-20210821115719363",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[468]||(l[468]=t("p",null,"解读：",-1)),l[469]||(l[469]=t("ul",null,[t("li",null,"商品服务完成商品修改后，业务直接结束，没有任何代码侵入"),t("li",null,"Canal监听MySQL变化，当发现变化后，立即通知缓存服务"),t("li",null,"缓存服务接收到canal通知，更新缓存")],-1)),l[470]||(l[470]=t("p",null,[t("strong",null,"代码零侵入")],-1)),l[471]||(l[471]=t("h3",{id:"_5-2-安装canal",tabindex:"-1"},[p("5.2 安装Canal "),t("a",{class:"header-anchor",href:"#_5-2-安装canal","aria-label":'Permalink to "5.2 安装Canal"'},"​")],-1)),l[472]||(l[472]=t("h4",{id:"_5-2-1-认识canal",tabindex:"-1"},[p("5.2.1 认识Canal "),t("a",{class:"header-anchor",href:"#_5-2-1-认识canal","aria-label":'Permalink to "5.2.1 认识Canal"'},"​")],-1)),l[473]||(l[473]=t("p",null,[t("strong",null,"Canal [kə’næl]"),p("，译意为水道/管道/沟渠，canal是阿里巴巴旗下的一款开源项目，基于Java开发。基于数据库增量日志解析，提供增量数据订阅&消费。GitHub的地址："),t("a",{href:"https://github.com/alibaba/canal",target:"_blank",rel:"noreferrer"},"https://github.com/alibaba/canal")],-1)),l[474]||(l[474]=t("p",null,"Canal是基于mysql的主从同步来实现的，MySQL主从同步的原理如下：",-1)),l[475]||(l[475]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821115914748.png",alt:"image-20210821115914748",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[476]||(l[476]=t("ul",null,[t("li",null,"1）MySQL master 将数据变更写入二进制日志( binary log），其中记录的数据叫做binary log events"),t("li",null,"2）MySQL slave 将 master 的 binary log events拷贝到它的中继日志(relay log)"),t("li",null,"3）MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据")],-1)),l[477]||(l[477]=t("p",null,"而Canal就是把自己伪装成MySQL的一个slave节点，从而监听master的binary log变化。再把得到的变化信息通知给Canal的客户端，进而完成对其它数据库的同步。",-1)),l[478]||(l[478]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821115948395.png",alt:"image-20210821115948395",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[479]||(l[479]=t("h4",{id:"_5-2-2-安装和配置canal",tabindex:"-1"},[p("5.2.2 安装和配置Canal "),t("a",{class:"header-anchor",href:"#_5-2-2-安装和配置canal","aria-label":'Permalink to "5.2.2 安装和配置Canal"'},"​")],-1)),l[480]||(l[480]=t("p",null,"下面我们就开启mysql的主从同步机制，让Canal来模拟salve",-1)),l[481]||(l[481]=t("h5",{id:"_1-开启mysql主从",tabindex:"-1"},[p("1. 开启MySQL主从 "),t("a",{class:"header-anchor",href:"#_1-开启mysql主从","aria-label":'Permalink to "1. 开启MySQL主从"'},"​")],-1)),l[482]||(l[482]=t("p",null,"Canal是基于MySQL的主从同步功能，因此必须先开启MySQL的主从功能才可以。",-1)),l[483]||(l[483]=t("p",null,"这里以之前用Docker运行的mysql为例：",-1)),l[484]||(l[484]=t("h6",{id:"_1-1-开启binlog",tabindex:"-1"},[p("1.1 开启binlog "),t("a",{class:"header-anchor",href:"#_1-1-开启binlog","aria-label":'Permalink to "1.1 开启binlog"'},"​")],-1)),l[485]||(l[485]=t("p",null,[p("打开mysql容器挂载的日志文件，我的在"),t("code",null,"/tmp/mysql/conf"),p("目录:")],-1)),l[486]||(l[486]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210813153241537.png",alt:"image-20210813153241537",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[487]||(l[487]=t("p",null,"修改文件：",-1)),l[488]||(l[488]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vi"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp/mysql/conf/my.cnf")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[489]||(l[489]=t("p",null,"添加内容：",-1)),l[490]||(l[490]=t("div",{class:"language-ini max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"ini"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"log-bin"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=/var/lib/mysql/mysql-bin")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"binlog-do-db"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=heima")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[491]||(l[491]=t("p",null,"配置解读：",-1)),l[492]||(l[492]=t("ul",null,[t("li",null,[t("code",null,"log-bin=/var/lib/mysql/mysql-bin"),p("：设置binary log文件的存放地址和文件名，叫做mysql-bin")]),t("li",null,[t("code",null,"binlog-do-db=heima"),p("：指定对哪个database记录binary log events，这里记录heima这个库")])],-1)),l[493]||(l[493]=t("p",null,"最终效果：",-1)),l[494]||(l[494]=t("div",{class:"language-ini max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"ini"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"[mysqld]")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"skip-name-resolve")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"character_set_server"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=utf8")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"datadir"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=/var/lib/mysql")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"server-id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=1000")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"log-bin"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=/var/lib/mysql/mysql-bin")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"binlog-do-db"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=heima")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[495]||(l[495]=t("h6",{id:"_1-2-设置用户权限",tabindex:"-1"},[p("1.2 设置用户权限 "),t("a",{class:"header-anchor",href:"#_1-2-设置用户权限","aria-label":'Permalink to "1.2 设置用户权限"'},"​")],-1)),l[496]||(l[496]=t("p",null,"接下来添加一个仅用于数据同步的账户，出于安全考虑，这里仅提供对heima这个库的操作权限。",-1)),l[497]||(l[497]=t("div",{class:"language-sql max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sql"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"create"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," user"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," canal"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'%'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IDENTIFIED "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"by"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'canal'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GRANT"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," SELECT"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", REPLICATION SLAVE, REPLICATION CLIENT,SUPER "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ON"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," TO"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'canal'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'%'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," identified "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"by"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'canal'"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"FLUSH PRIVILEGES;")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[498]||(l[498]=t("p",null,"重启mysql容器即可",-1)),l[499]||(l[499]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," restart"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[500]||(l[500]=t("p",null,"测试设置是否成功：在mysql控制台，或者Navicat中，输入命令：",-1)),l[501]||(l[501]=t("div",{class:"language-sql max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sql"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"show "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"master"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," status"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[502]||(l[502]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20200327094735948.png",alt:"image-20200327094735948",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[503]||(l[503]=t("h5",{id:"_2-安装canal",tabindex:"-1"},[p("2. 安装Canal "),t("a",{class:"header-anchor",href:"#_2-安装canal","aria-label":'Permalink to "2. 安装Canal"'},"​")],-1)),l[504]||(l[504]=t("h6",{id:"_2-1-创建网络",tabindex:"-1"},[p("2.1 创建网络 "),t("a",{class:"header-anchor",href:"#_2-1-创建网络","aria-label":'Permalink to "2.1 创建网络"'},"​")],-1)),l[505]||(l[505]=t("p",null,"我们需要创建一个网络，将MySQL、Canal、MQ放到同一个Docker网络中：",-1)),l[506]||(l[506]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," network"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," create"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," heima")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[507]||(l[507]=t("p",null,"让mysql加入这个网络：",-1)),l[508]||(l[508]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," network"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," connect"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," heima"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[509]||(l[509]=t("h6",{id:"_2-2-安装",tabindex:"-1"},[p("2.2 安装 "),t("a",{class:"header-anchor",href:"#_2-2-安装","aria-label":'Permalink to "2.2 安装"'},"​")],-1)),l[510]||(l[510]=t("p",null,"课前资料中提供了canal的镜像压缩包:",-1)),l[511]||(l[511]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210813161804292.png",alt:"image-20210813161804292",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[512]||(l[512]=t("p",null,"大家可以上传到虚拟机，然后通过命令导入：",-1)),l[513]||(l[513]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," load"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," canal.tar")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[514]||(l[514]=t("p",null,"然后运行命令创建Canal容器：",-1)),l[515]||(l[515]=t("div",{class:"language-sh max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"sh"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"docker"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," run"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 11111:11111"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --name"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," canal"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.destinations=heima"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.master.address=mysql:3306"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.dbUsername=canal"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.dbPassword=canal"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.connectionCharset=UTF-8"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.tsdb.enable="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.gtidon="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-e "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal.instance.filter.regex=heima"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\\\"),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},".."),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"*"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--network "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"heima"),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-d "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"canal/canal-server:v1.1.5")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[516]||(l[516]=t("p",null,"说明:",-1)),l[517]||(l[517]=t("ul",null,[t("li",null,[t("code",null,"-p 11111:11111"),p("：这是canal的默认监听端口")]),t("li",null,[t("code",null,"-e canal.instance.master.address=mysql:3306"),p("：数据库地址和端口，如果不知道mysql容器地址，可以通过"),t("code",null,"docker inspect 容器id"),p("来查看")]),t("li",null,[t("code",null,"-e canal.instance.dbUsername=canal"),p("：数据库用户名")]),t("li",null,[t("code",null,"-e canal.instance.dbPassword=canal"),p(" ：数据库密码")]),t("li",null,[t("code",null,"-e canal.instance.filter.regex="),p("：要监听的表名称")])],-1)),l[518]||(l[518]=t("p",null,"表名称监听支持的语法：",-1)),l[519]||(l[519]=t("blockquote",null,[t("p",null,[p("mysql 数据解析关注的表，Perl正则表达式. 多个正则之间以逗号"),t("code",null,"(,)"),p("分隔，转义符需要双斜杠"),t("code",null,"(\\\\)"),p(" 常见例子：")]),t("ol",null,[t("li",null,[p("所有表："),t("code",null,".* or .*\\\\..*")]),t("li",null,[p("canal schema下所有表： "),t("code",null,"canal\\\\..*")]),t("li",null,[p("canal下的以canal打头的表："),t("code",null,"canal\\\\.canal.*")]),t("li",null,[p("canal schema下的一张表："),t("code",null,"canal.test1")]),t("li",null,[p("多个规则组合使用然后以逗号隔开："),t("code",null,"canal\\\\..*,mysql.test1,mysql.test2")])])],-1)),l[520]||(l[520]=t("h3",{id:"_5-3-监听canal",tabindex:"-1"},[p("5.3 监听Canal "),t("a",{class:"header-anchor",href:"#_5-3-监听canal","aria-label":'Permalink to "5.3 监听Canal"'},"​")],-1)),l[521]||(l[521]=t("p",null,"Canal提供了各种语言的客户端，当Canal监听到binlog变化时，会通知Canal的客户端。",-1)),l[522]||(l[522]=t("figure",null,[t("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210821120049024.png",alt:"image-20210821120049024",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[523]||(l[523]=t("p",null,"我们可以利用Canal提供的Java客户端，监听Canal通知消息。当收到变化的消息时，完成对缓存的更新。",-1)),l[524]||(l[524]=t("p",null,[p("不过这里我们会使用GitHub上的第三方开源的canal-starter客户端。地址："),t("a",{href:"https://github.com/NormanGyllenhaal/canal-client",target:"_blank",rel:"noreferrer"},"https://github.com/NormanGyllenhaal/canal-client")],-1)),l[525]||(l[525]=t("p",null,"与SpringBoot完美整合，自动装配，比官方客户端要简单好用很多。",-1)),l[526]||(l[526]=t("h4",{id:"_5-3-1-引入依赖",tabindex:"-1"},[p("5.3.1 引入依赖 "),t("a",{class:"header-anchor",href:"#_5-3-1-引入依赖","aria-label":'Permalink to "5.3.1 引入依赖"'},"​")],-1)),l[527]||(l[527]=t("div",{class:"language-xml max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"xml"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">top.javatool</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">canal-spring-boot-starter</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">1.2.1-RELEASE</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"version"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[528]||(l[528]=t("h4",{id:"_5-3-2-编写配置",tabindex:"-1"},[p("5.3.2 编写配置 "),t("a",{class:"header-anchor",href:"#_5-3-2-编写配置","aria-label":'Permalink to "5.3.2 编写配置"'},"​")],-1)),l[529]||(l[529]=t("div",{class:"language-yaml max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"yaml"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"canal"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  destination"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"heima"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # canal的集群名字，要与安装canal时设置的名称一致")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  server"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.101:11111"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # canal服务地址")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[530]||(l[530]=t("h4",{id:"_5-3-3-修改item实体类",tabindex:"-1"},[p("5.3.3 修改Item实体类 "),t("a",{class:"header-anchor",href:"#_5-3-3-修改item实体类","aria-label":'Permalink to "5.3.3 修改Item实体类"'},"​")],-1)),l[531]||(l[531]=t("p",null,"通过@Id、@Column、等注解完成Item与数据库表字段的映射：",-1)),l[532]||(l[532]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.baomidou.mybatisplus.annotation.IdType;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.baomidou.mybatisplus.annotation.TableField;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.baomidou.mybatisplus.annotation.TableId;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.baomidou.mybatisplus.annotation.TableName;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lombok.Data;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.data.annotation.Id;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.data.annotation.Transient;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," javax.persistence.Column;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.Date;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Data")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TableName"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"tb_item"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Item"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TableId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"type"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IdType.AUTO)")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Id")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Long id;"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//商品id")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Column"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"name"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "name"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String name;"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//商品名称")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String title;"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//商品标题")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Long price;"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//价格（分）")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String image;"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//商品图片")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String category;"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//分类名称")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String brand;"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//品牌名称")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String spec;"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//规格")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer status;"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//商品状态 1-正常，2-下架")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Date createTime;"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//创建时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Date updateTime;"),t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//更新时间")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TableField"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exist"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transient")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer stock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TableField"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"exist"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),t("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Transient")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer sold;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[533]||(l[533]=t("h4",{id:"_5-3-4-编写监听器",tabindex:"-1"},[p("5.3.4 编写监听器 "),t("a",{class:"header-anchor",href:"#_5-3-4-编写监听器","aria-label":'Permalink to "5.3.4 编写监听器"'},"​")],-1)),l[534]||(l[534]=t("p",null,[p("通过实现"),t("code",null,"EntryHandler<T>"),p("接口编写监听器，监听Canal消息。注意两点：")],-1)),l[535]||(l[535]=t("ul",null,[t("li",null,[p("实现类通过"),t("code",null,'@CanalTable("tb_item")'),p("指定监听的表信息")]),t("li",null,"EntryHandler的泛型是与表对应的实体类")],-1)),l[536]||(l[536]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.canal;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.github.benmanes.caffeine.cache.Cache;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.config.RedisHandler;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.Item;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.annotation.Autowired;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," top.javatool.canal.client.annotation.CanalTable;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," top.javatool.canal.client.handler.EntryHandler;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CanalTable"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"tb_item"'),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ItemHandler"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," EntryHandler"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RedisHandler redisHandler;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Cache<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Long"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> itemCache;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," insert"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Item "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"item"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写数据到JVM进程缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        itemCache."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), item);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写数据到redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisHandler."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveItem"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," update"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Item "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"before"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", Item "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"after"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写数据到JVM进程缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        itemCache."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(after."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), after);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 写数据到redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisHandler."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveItem"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(after);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," delete"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Item "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"item"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 删除数据到JVM进程缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        itemCache."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"invalidate"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 删除数据到redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisHandler."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"deleteItemById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1)),l[537]||(l[537]=t("p",null,"在这里对Redis的操作都封装到了RedisHandler这个对象中，是我们之前做缓存预热时编写的一个类，内容如下：",-1)),l[538]||(l[538]=t("div",{class:"language-java max-h-300px"},[t("button",{title:"Copy code",class:"copy"}),t("span",{class:"lang"},"java"),t("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[t("code",{"v-pre":""},[t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.config;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.fasterxml.jackson.core.JsonProcessingException;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.fasterxml.jackson.databind.ObjectMapper;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.Item;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.pojo.ItemStock;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.service.IItemService;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.heima.item.service.IItemStockService;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.InitializingBean;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.beans.factory.annotation.Autowired;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.data.redis.core.StringRedisTemplate;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," java.util.List;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RedisHandler"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InitializingBean"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," StringRedisTemplate redisTemplate;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemService itemService;")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Autowired")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," IItemStockService stockService;")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    private"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," static"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," final"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectMapper MAPPER "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ObjectMapper"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," afterPropertiesSet"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 初始化缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.查询商品信息")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Item"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> itemList "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.放入缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Item item "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," itemList) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.1.item序列化为JSON")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAPPER."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.2.存入redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redisTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), json);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 3.查询商品库存信息")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ItemStock"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> stockList "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockService."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 4.放入缓存")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ItemStock stock "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stockList) {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.1.item序列化为JSON")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAPPER."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(stock);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 2.2.存入redis")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redisTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:stock:id:"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," stock."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), json);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," saveItem"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Item "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"item"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAPPER."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"writeValueAsString"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(item);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            redisTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"opsForValue"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," item."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getId"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), json);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (JsonProcessingException "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            throw"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RuntimeException"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"}),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," deleteItemById"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long "),t("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        redisTemplate."),t("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"delete"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),t("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"item:id:"'),t("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id);")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),p("\n"),t("span",{class:"line"},[t("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),t("button",{class:"code-block-unfold-btn"})],-1))]),"main-header":k(()=>[n(s.$slots,"main-header")]),"main-header-after":k(()=>[n(s.$slots,"main-header-after")]),"main-nav":k(()=>[n(s.$slots,"main-nav")]),"main-content-before":k(()=>[n(s.$slots,"main-content-before")]),"main-content":k(()=>[n(s.$slots,"main-content")]),"main-content-after":k(()=>[n(s.$slots,"main-content-after")]),"main-nav-before":k(()=>[n(s.$slots,"main-nav-before")]),"main-nav-after":k(()=>[n(s.$slots,"main-nav-after")]),comment:k(()=>[n(s.$slots,"comment")]),footer:k(()=>[n(s.$slots,"footer")]),aside:k(()=>[n(s.$slots,"aside")]),"aside-custom":k(()=>[n(s.$slots,"aside-custom")]),default:k(()=>[n(s.$slots,"default")]),_:3},8,["frontmatter"])}}};export{c as default,g as usePageData};
