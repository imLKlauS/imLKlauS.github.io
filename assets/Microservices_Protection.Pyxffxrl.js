var h=(g,p,e)=>new Promise((o,k)=>{var d=n=>{try{r(e.next(n))}catch(i){k(i)}},u=n=>{try{r(e.throw(n))}catch(i){k(i)}},r=n=>n.done?o(n.value):Promise.resolve(n.value).then(d,u);r((e=e.apply(g,p)).next())});import{_ as y}from"./ValaxyMain.vue_vue_type_style_index_0_lang.39opEnV_.js";import"./chunks/@vueuse/motion.C0680yyY.js";import{d as m,a as b,u as F}from"./chunks/vue-router.BaQM4Kc2.js";import{a1 as f,a3 as a,a4 as t,a5 as l,a6 as v,a7 as s,F as S,a2 as z,Z as D}from"./framework.CyQERZzy.js";import"./app.yrEQeKqa.js";import"./chunks/dayjs.BSMtxqtT.js";import"./chunks/vue-i18n.CvwbWgfE.js";import"./chunks/pinia.CyvRWuDa.js";import"./chunks/nprogress.c3ZdlDjC.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.XbFefrGO.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.Du2MZPyS.js";import"./post.C7a2r-qQ.js";const A=m("/posts/Microservices_Protection",g=>h(null,null,function*(){return JSON.parse('{"title":"微服务保护","description":"","frontmatter":{"title":"微服务保护","author":"imklaus","tags":["Spring Cloud","Sentinel"],"categories":["Java","微服务"],"date":"2025/12/8 1:29:00","outline":"deep","postTitleClass":"text-#62afe9","excerpt_type":"html","end":false},"headers":[],"relativePath":"pages/posts/Microservices_Protection.md","lastUpdated":null}')}),{lazy:(g,p)=>g.name===p.name}),H={__name:"Microservices_Protection",setup(g,{expose:p}){var r;const{data:e}=A(),o=F(),k=b(),d=Object.assign(k.meta.frontmatter||{},((r=e.value)==null?void 0:r.frontmatter)||{});return o.currentRoute.value.data=e.value,D("valaxy:frontmatter",d),globalThis.$frontmatter=d,p({frontmatter:{title:"微服务保护",author:"imklaus",tags:["Spring Cloud","Sentinel"],categories:["Java","微服务"],date:"2025/12/8 1:29:00",outline:"deep",postTitleClass:"text-#62afe9",excerpt_type:"html",end:!1}}),(n,i)=>{const E=y;return z(),f(E,{frontmatter:S(d)},{"main-content-md":a(()=>[i[0]||(i[0]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208014226027.png",alt:"image-20251208014226027",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[1]||(i[1]=l("p",null,[s("参考视频："),l("a",{href:"https://www.bilibili.com/video/BV1LQ4y127n4",target:"_blank",rel:"noreferrer"},"黑马SpringCloud微服务技术栈高级篇")],-1)),i[2]||(i[2]=l("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),i[3]||(i[3]=l("p",null,[l("strong",null,"目录指引"),s("：")],-1)),i[4]||(i[4]=l("nav",{class:"table-of-contents"},[l("ul",null,[l("li",null,[l("a",{href:"#_1-初识sentinel"},"1. 初识Sentinel"),l("ul",null,[l("li",null,[l("a",{href:"#_1-1-雪崩问题及解决方案"},"1.1 雪崩问题及解决方案"),l("ul",null,[l("li",null,[l("a",{href:"#_1-1-1-雪崩问题"},"1.1.1 雪崩问题")]),l("li",null,[l("a",{href:"#_1-1-2-超时处理"},"1.1.2 超时处理")]),l("li",null,[l("a",{href:"#_1-1-3-仓壁模式"},"1.1.3 仓壁模式")]),l("li",null,[l("a",{href:"#_1-1-4-断路器"},"1.1.4 断路器")]),l("li",null,[l("a",{href:"#_1-1-5-限流"},"1.1.5 限流")]),l("li",null,[l("a",{href:"#_1-1-6-总结"},"1.1.6 总结")])])]),l("li",null,[l("a",{href:"#_1-2-服务保护技术对比"},"1.2 服务保护技术对比")]),l("li",null,[l("a",{href:"#_1-3-sentinel介绍和安装"},"1.3 Sentinel介绍和安装"),l("ul",null,[l("li",null,[l("a",{href:"#_1-3-1-初识sentinel"},"1.3.1 初识Sentinel")]),l("li",null,[l("a",{href:"#_1-3-2-安装sentinel"},"1.3.2 安装Sentinel")])])]),l("li",null,[l("a",{href:"#_1-4-微服务整合sentinel"},"1.4 微服务整合Sentinel")])])]),l("li",null,[l("a",{href:"#_2-流量控制"},"2. 流量控制"),l("ul",null,[l("li",null,[l("a",{href:"#_2-1-簇点链路"},"2.1 簇点链路")]),l("li",null,[l("a",{href:"#_2-2-快速入门"},"2.2 快速入门"),l("ul",null,[l("li",null,[l("a",{href:"#_2-2-1-示例"},"2.2.1 示例")]),l("li",null,[l("a",{href:"#_2-2-2-练习"},"2.2.2 练习")])])]),l("li",null,[l("a",{href:"#_2-3-流控模式"},"2.3 流控模式"),l("ul",null,[l("li",null,[l("a",{href:"#_2-3-1-关联模式"},"2.3.1 关联模式")]),l("li",null,[l("a",{href:"#_2-3-2-链路模式"},"2.3.2 链路模式")]),l("li",null,[l("a",{href:"#_2-3-3-总结"},"2.3.3 总结")])])]),l("li",null,[l("a",{href:"#_2-4-流控效果"},"2.4 流控效果"),l("ul",null,[l("li",null,[l("a",{href:"#_2-4-1-warm-up"},"2.4.1 warm up")]),l("li",null,[l("a",{href:"#_2-4-2-排队等待"},"2.4.2 排队等待")]),l("li",null,[l("a",{href:"#_2-4-3-总结"},"2.4.3 总结")])])]),l("li",null,[l("a",{href:"#_2-5-热点参数限流"},"2.5 热点参数限流"),l("ul",null,[l("li",null,[l("a",{href:"#_2-5-1-全局参数限流"},"2.5.1 全局参数限流")]),l("li",null,[l("a",{href:"#_2-5-2-热点参数限流"},"2.5.2 热点参数限流")]),l("li",null,[l("a",{href:"#_2-5-3-案例"},"2.5.3 案例")])])])])]),l("li",null,[l("a",{href:"#_3-隔离和降级"},"3. 隔离和降级"),l("ul",null,[l("li",null,[l("a",{href:"#_3-1-feignclient整合sentinel"},"3.1 FeignClient整合Sentinel"),l("ul",null,[l("li",null,[l("a",{href:"#_3-1-1-修改配置-开启sentinel功能"},"3.1.1 修改配置，开启sentinel功能")]),l("li",null,[l("a",{href:"#_3-1-2-编写失败降级逻辑"},"3.1.2 编写失败降级逻辑")]),l("li",null,[l("a",{href:"#_3-1-3-总结"},"3.1.3 总结")])])]),l("li",null,[l("a",{href:"#_3-2-线程隔离-舱壁模式"},"3.2 线程隔离（舱壁模式）"),l("ul",null,[l("li",null,[l("a",{href:"#_3-2-1-线程隔离的实现方式"},"3.2.1 线程隔离的实现方式")]),l("li",null,[l("a",{href:"#_3-2-2-sentinel的线程隔离"},"3.2.2 sentinel的线程隔离")]),l("li",null,[l("a",{href:"#_3-2-3-总结"},"3.2.3 总结")])])]),l("li",null,[l("a",{href:"#_3-3-熔断降级"},"3.3 熔断降级"),l("ul",null,[l("li",null,[l("a",{href:"#_3-3-1-慢调用"},"3.3.1 慢调用")]),l("li",null,[l("a",{href:"#_3-3-2-异常比例、异常数"},"3.3.2 异常比例、异常数")])])])])]),l("li",null,[l("a",{href:"#_4-授权规则"},"4. 授权规则"),l("ul",null,[l("li",null,[l("a",{href:"#_4-1-授权规则"},"4.1 授权规则"),l("ul",null,[l("li",null,[l("a",{href:"#_4-1-1-基本规则"},"4.1.1 基本规则")]),l("li",null,[l("a",{href:"#_4-1-2-如何获取origin"},"4.1.2 如何获取origin")]),l("li",null,[l("a",{href:"#_4-1-3-给网关添加请求头"},"4.1.3 给网关添加请求头")]),l("li",null,[l("a",{href:"#_4-1-4-配置授权规则"},"4.1.4 配置授权规则")])])]),l("li",null,[l("a",{href:"#_4-2-自定义异常结果"},"4.2 自定义异常结果"),l("ul",null,[l("li",null,[l("a",{href:"#_4-2-1-异常类型"},"4.2.1 异常类型")]),l("li",null,[l("a",{href:"#_4-2-2-自定义异常处理"},"4.2.2 自定义异常处理")])])])])]),l("li",null,[l("a",{href:"#_5-规则持久化"},"5. 规则持久化"),l("ul",null,[l("li",null,[l("a",{href:"#_5-1-规则管理模式"},"5.1 规则管理模式"),l("ul",null,[l("li",null,[l("a",{href:"#_5-1-1-pull模式"},"5.1.1 pull模式")]),l("li",null,[l("a",{href:"#_5-1-2-push模式"},"5.1.2 push模式")])])]),l("li",null,[l("a",{href:"#_5-2-实现push模式"},"5.2 实现push模式"),l("ul",null,[l("li",null,[l("a",{href:"#一、修改order-service服务"},"一、修改order-service服务")]),l("li",null,[l("a",{href:"#二、修改sentinel-dashboard源码"},"二、修改sentinel-dashboard源码")])])])])])])],-1)),i[5]||(i[5]=l("h2",{id:"_1-初识sentinel",tabindex:"-1"},[s("1. 初识Sentinel "),l("a",{class:"header-anchor",href:"#_1-初识sentinel","aria-label":'Permalink to "1. 初识Sentinel"'},"​")],-1)),i[6]||(i[6]=l("h3",{id:"_1-1-雪崩问题及解决方案",tabindex:"-1"},[s("1.1 雪崩问题及解决方案 "),l("a",{class:"header-anchor",href:"#_1-1-雪崩问题及解决方案","aria-label":'Permalink to "1.1 雪崩问题及解决方案"'},"​")],-1)),i[7]||(i[7]=l("h4",{id:"_1-1-1-雪崩问题",tabindex:"-1"},[s("1.1.1 雪崩问题 "),l("a",{class:"header-anchor",href:"#_1-1-1-雪崩问题","aria-label":'Permalink to "1.1.1 雪崩问题"'},"​")],-1)),i[8]||(i[8]=l("p",null,"微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。",-1)),v(" more "),i[9]||(i[9]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1533829099748.png",alt:"1533829099748",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[10]||(i[10]=l("p",null,"如图，如果服务提供者I发生了故障，当前的应用的部分业务因为依赖于服务I，因此也会被阻塞。此时，其它不依赖于服务I的业务似乎不受影响。",-1)),i[11]||(i[11]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1533829198240.png",alt:"1533829198240",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[12]||(i[12]=l("p",null,"但是，依赖服务I的业务请求被阻塞，用户不会得到响应，则tomcat的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞：",-1)),i[13]||(i[13]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/1533829307389.png",alt:"1533829307389",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[14]||(i[14]=l("p",null,"服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，那么当前服务也就不可用了。",-1)),i[15]||(i[15]=l("p",null,"那么，依赖于当前服务的其它服务随着时间的推移，最终也都会变的不可用，形成级联失败，雪崩就发生了：",-1)),i[16]||(i[16]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715172710340.png",alt:"image-20210715172710340",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[17]||(i[17]=l("h4",{id:"_1-1-2-超时处理",tabindex:"-1"},[s("1.1.2 超时处理 "),l("a",{class:"header-anchor",href:"#_1-1-2-超时处理","aria-label":'Permalink to "1.1.2 超时处理"'},"​")],-1)),i[18]||(i[18]=l("p",null,"解决雪崩问题的常见方式有四种：",-1)),i[19]||(i[19]=l("ul",null,[l("li",null,"超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待")],-1)),i[20]||(i[20]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715172820438.png",alt:"image-20210715172820438",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[21]||(i[21]=l("h4",{id:"_1-1-3-仓壁模式",tabindex:"-1"},[s("1.1.3 仓壁模式 "),l("a",{class:"header-anchor",href:"#_1-1-3-仓壁模式","aria-label":'Permalink to "1.1.3 仓壁模式"'},"​")],-1)),i[22]||(i[22]=l("p",null,"方案2：仓壁模式",-1)),i[23]||(i[23]=l("p",null,"仓壁模式来源于船舱的设计：",-1)),i[24]||(i[24]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715172946352.png",alt:"image-20210715172946352",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[25]||(i[25]=l("p",null,"船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。",-1)),i[26]||(i[26]=l("p",null,"于此类似，我们可以限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，因此也叫线程隔离。",-1)),i[27]||(i[27]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173215243.png",alt:"image-20210715173215243",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[28]||(i[28]=l("h4",{id:"_1-1-4-断路器",tabindex:"-1"},[s("1.1.4 断路器 "),l("a",{class:"header-anchor",href:"#_1-1-4-断路器","aria-label":'Permalink to "1.1.4 断路器"'},"​")],-1)),i[29]||(i[29]=l("p",null,[s("断路器模式：由"),l("strong",null,"断路器"),s("统计业务执行的异常比例，如果超出阈值则会"),l("strong",null,"熔断"),s("该业务，拦截访问该业务的一切请求。")],-1)),i[30]||(i[30]=l("p",null,"断路器会统计访问某个服务的请求数量，异常比例：",-1)),i[31]||(i[31]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173327075.png",alt:"image-20210715173327075",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[32]||(i[32]=l("p",null,"当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：",-1)),i[33]||(i[33]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173428073.png",alt:"image-20210715173428073",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[34]||(i[34]=l("h4",{id:"_1-1-5-限流",tabindex:"-1"},[s("1.1.5 限流 "),l("a",{class:"header-anchor",href:"#_1-1-5-限流","aria-label":'Permalink to "1.1.5 限流"'},"​")],-1)),i[35]||(i[35]=l("p",null,[l("strong",null,"流量控制"),s("：限制业务访问的QPS，避免服务因流量的突增而故障。")],-1)),i[36]||(i[36]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173555158.png",alt:"image-20210715173555158",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[37]||(i[37]=l("h4",{id:"_1-1-6-总结",tabindex:"-1"},[s("1.1.6 总结 "),l("a",{class:"header-anchor",href:"#_1-1-6-总结","aria-label":'Permalink to "1.1.6 总结"'},"​")],-1)),i[38]||(i[38]=l("p",null,"什么是雪崩问题？",-1)),i[39]||(i[39]=l("ul",null,[l("li",null,"微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。")],-1)),i[40]||(i[40]=l("p",null,"可以认为：",-1)),i[41]||(i[41]=l("p",null,[l("strong",null,"限流"),s("是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种"),l("strong",null,"预防"),s("措施。")],-1)),i[42]||(i[42]=l("p",null,[l("strong",null,"超时处理、线程隔离、降级熔断"),s("是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种"),l("strong",null,"补救"),s("措施。")],-1)),i[43]||(i[43]=l("h3",{id:"_1-2-服务保护技术对比",tabindex:"-1"},[s("1.2 服务保护技术对比 "),l("a",{class:"header-anchor",href:"#_1-2-服务保护技术对比","aria-label":'Permalink to "1.2 服务保护技术对比"'},"​")],-1)),i[44]||(i[44]=l("p",null,"在SpringCloud当中支持多种服务保护技术：",-1)),i[45]||(i[45]=l("ul",null,[l("li",null,[l("a",{href:"https://github.com/Netflix/Hystrix",target:"_blank",rel:"noreferrer"},"Netfix Hystrix")]),l("li",null,[l("a",{href:"https://github.com/alibaba/Sentinel",target:"_blank",rel:"noreferrer"},"Sentinel")]),l("li",null,[l("a",{href:"https://github.com/resilience4j/resilience4j",target:"_blank",rel:"noreferrer"},"Resilience4J")])],-1)),i[46]||(i[46]=l("p",null,"早期比较流行的是Hystrix框架，但目前国内实用最广泛的还是阿里巴巴的Sentinel框架，这里我们做下对比：",-1)),i[47]||(i[47]=l("table",null,[l("thead",null,[l("tr",null,[l("th"),l("th",null,[l("strong",null,"Sentinel")]),l("th",null,[l("strong",null,"Hystrix")])])]),l("tbody",null,[l("tr",null,[l("td",null,"隔离策略"),l("td",null,"信号量隔离"),l("td",null,"线程池隔离/信号量隔离")]),l("tr",null,[l("td",null,"熔断降级策略"),l("td",null,"基于慢调用比例或异常比例"),l("td",null,"基于失败比率")]),l("tr",null,[l("td",null,"实时指标实现"),l("td",null,"滑动窗口"),l("td",null,"滑动窗口（基于 RxJava）")]),l("tr",null,[l("td",null,"规则配置"),l("td",null,"支持多种数据源"),l("td",null,"支持多种数据源")]),l("tr",null,[l("td",null,"扩展性"),l("td",null,"多个扩展点"),l("td",null,"插件的形式")]),l("tr",null,[l("td",null,"基于注解的支持"),l("td",null,"支持"),l("td",null,"支持")]),l("tr",null,[l("td",null,"限流"),l("td",null,"基于 QPS，支持基于调用关系的限流"),l("td",null,"有限的支持")]),l("tr",null,[l("td",null,"流量整形"),l("td",null,"支持慢启动、匀速排队模式"),l("td",null,"不支持")]),l("tr",null,[l("td",null,"系统自适应保护"),l("td",null,"支持"),l("td",null,"不支持")]),l("tr",null,[l("td",null,"控制台"),l("td",null,"开箱即用，可配置规则、查看秒级监控、机器发现等"),l("td",null,"不完善")]),l("tr",null,[l("td",null,"常见框架的适配"),l("td",null,"Servlet、Spring Cloud、Dubbo、gRPC 等"),l("td",null,"Servlet、Spring Cloud Netflix")])])],-1)),i[48]||(i[48]=l("h3",{id:"_1-3-sentinel介绍和安装",tabindex:"-1"},[s("1.3 Sentinel介绍和安装 "),l("a",{class:"header-anchor",href:"#_1-3-sentinel介绍和安装","aria-label":'Permalink to "1.3 Sentinel介绍和安装"'},"​")],-1)),i[49]||(i[49]=l("h4",{id:"_1-3-1-初识sentinel",tabindex:"-1"},[s("1.3.1 初识Sentinel "),l("a",{class:"header-anchor",href:"#_1-3-1-初识sentinel","aria-label":'Permalink to "1.3.1 初识Sentinel"'},"​")],-1)),i[50]||(i[50]=l("p",null,[s("Sentinel是阿里巴巴开源的一款微服务流量控制组件。官网地址："),l("a",{href:"https://sentinelguard.io/zh-cn/index.html",target:"_blank",rel:"noreferrer"},"https://sentinelguard.io/zh-cn/index.html")],-1)),i[51]||(i[51]=l("p",null,"Sentinel 具有以下特征:",-1)),i[52]||(i[52]=l("ul",null,[l("li",null,[l("p",null,[l("strong",null,"丰富的应用场景"),s("：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。")])]),l("li",null,[l("p",null,[l("strong",null,"完备的实时监控"),s("：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。")])]),l("li",null,[l("p",null,[l("strong",null,"广泛的开源生态"),s("：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。")])]),l("li",null,[l("p",null,[l("strong",null,"完善的"),s(),l("strong",null,"SPI"),s(),l("strong",null,"扩展点"),s("：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。")])])],-1)),i[53]||(i[53]=l("h4",{id:"_1-3-2-安装sentinel",tabindex:"-1"},[s("1.3.2 安装Sentinel "),l("a",{class:"header-anchor",href:"#_1-3-2-安装sentinel","aria-label":'Permalink to "1.3.2 安装Sentinel"'},"​")],-1)),i[54]||(i[54]=l("p",null,"1）下载",-1)),i[55]||(i[55]=l("p",null,[s("sentinel官方提供了UI控制台，方便我们对系统做限流设置。大家可以在"),l("a",{href:"https://github.com/alibaba/Sentinel/releases",target:"_blank",rel:"noreferrer"},"GitHub"),s("下载。")],-1)),i[56]||(i[56]=l("p",null,"课前资料也提供了下载好的jar包：",-1)),i[57]||(i[57]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715174252531.png",alt:"image-20210715174252531",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[58]||(i[58]=l("p",null,"2）运行",-1)),i[59]||(i[59]=l("p",null,"将jar包放到任意非中文目录，执行命令：",-1)),i[60]||(i[60]=l("div",{class:"language-sh max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"sh"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"java"),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -jar"),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," sentinel-dashboard-1.8.1.jar")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[61]||(i[61]=l("p",null,"如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：",-1)),i[62]||(i[62]=l("table",null,[l("thead",null,[l("tr",null,[l("th",null,[l("strong",null,"配置项")]),l("th",null,[l("strong",null,"默认值")]),l("th",null,[l("strong",null,"说明")])])]),l("tbody",null,[l("tr",null,[l("td",null,"server.port"),l("td",null,"8080"),l("td",null,"服务端口")]),l("tr",null,[l("td",null,"sentinel.dashboard.auth.username"),l("td",null,"sentinel"),l("td",null,"默认用户名")]),l("tr",null,[l("td",null,"sentinel.dashboard.auth.password"),l("td",null,"sentinel"),l("td",null,"默认密码")])])],-1)),i[63]||(i[63]=l("p",null,"例如，修改端口：",-1)),i[64]||(i[64]=l("div",{class:"language-sh max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"sh"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"java"),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Dserver.port=8090"),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -jar"),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," sentinel-dashboard-1.8.1.jar")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[65]||(i[65]=l("p",null,"3）访问",-1)),i[66]||(i[66]=l("p",null,[s("访问"),l("code",null,"http://localhost:8080"),s("页面，就可以看到sentinel的控制台了：")],-1)),i[67]||(i[67]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715190827846.png",alt:"image-20210715190827846",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[68]||(i[68]=l("p",null,"需要输入账号和密码，默认都是：sentinel",-1)),i[69]||(i[69]=l("p",null,"登录后，发现一片空白，什么都没有：",-1)),i[70]||(i[70]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715191134448.png",alt:"image-20210715191134448",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[71]||(i[71]=l("p",null,"这是因为我们还没有与微服务整合。",-1)),i[72]||(i[72]=l("h3",{id:"_1-4-微服务整合sentinel",tabindex:"-1"},[s("1.4 微服务整合Sentinel "),l("a",{class:"header-anchor",href:"#_1-4-微服务整合sentinel","aria-label":'Permalink to "1.4 微服务整合Sentinel"'},"​")],-1)),i[73]||(i[73]=l("p",null,"我们在order-service中整合sentinel，并连接sentinel的控制台，步骤如下：",-1)),i[74]||(i[74]=l("p",null,"1）引入sentinel依赖",-1)),i[75]||(i[75]=l("div",{class:"language-xml max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"xml"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"<!--sentinel-->")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.alibaba.cloud</"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">spring-cloud-starter-alibaba-sentinel</"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[76]||(i[76]=l("p",null,"2）配置控制台",-1)),i[77]||(i[77]=l("p",null,"修改application.yaml文件，添加下面内容：",-1)),i[78]||(i[78]=l("div",{class:"language-yaml max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"yaml"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"server"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  port"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8088")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": ")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    sentinel"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      transport"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        dashboard"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"localhost:8080")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[79]||(i[79]=l("p",null,"3）访问order-service的任意端点",-1)),i[80]||(i[80]=l("p",null,[s("打开浏览器，访问"),l("code",null,"http://localhost:8088/order/101"),s("，这样才能触发sentinel的监控。")],-1)),i[81]||(i[81]=l("p",null,"然后再访问sentinel的控制台，查看效果：",-1)),i[82]||(i[82]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715191241799.png",alt:"image-20210715191241799",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[83]||(i[83]=l("h2",{id:"_2-流量控制",tabindex:"-1"},[s("2. 流量控制 "),l("a",{class:"header-anchor",href:"#_2-流量控制","aria-label":'Permalink to "2. 流量控制"'},"​")],-1)),i[84]||(i[84]=l("p",null,"雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。",-1)),i[85]||(i[85]=l("h3",{id:"_2-1-簇点链路",tabindex:"-1"},[s("2.1 簇点链路 "),l("a",{class:"header-anchor",href:"#_2-1-簇点链路","aria-label":'Permalink to "2.1 簇点链路"'},"​")],-1)),i[86]||(i[86]=l("p",null,[s("当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做"),l("strong",null,"簇点链路"),s("。簇点链路中被监控的每一个接口就是一个"),l("strong",null,"资源"),s("。")],-1)),i[87]||(i[87]=l("p",null,"默认情况下sentinel会监控SpringMVC的每一个端点（Endpoint，也就是controller中的方法），因此SpringMVC的每一个端点（Endpoint）就是调用链路中的一个资源。",-1)),i[88]||(i[88]=l("p",{orderId:""},"例如，我们刚才访问的order-service中的OrderController中的端点：/order/",-1)),i[89]||(i[89]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715191757319.png",alt:"image-20210715191757319",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[90]||(i[90]=l("p",null,"流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：",-1)),i[91]||(i[91]=l("ul",null,[l("li",null,"流控：流量控制"),l("li",null,"降级：降级熔断"),l("li",null,"热点：热点参数限流，是限流的一种"),l("li",null,"授权：请求的权限控制")],-1)),i[92]||(i[92]=l("h3",{id:"_2-2-快速入门",tabindex:"-1"},[s("2.2 快速入门 "),l("a",{class:"header-anchor",href:"#_2-2-快速入门","aria-label":'Permalink to "2.2 快速入门"'},"​")],-1)),i[93]||(i[93]=l("h4",{id:"_2-2-1-示例",tabindex:"-1"},[s("2.2.1 示例 "),l("a",{class:"header-anchor",href:"#_2-2-1-示例","aria-label":'Permalink to "2.2.1 示例"'},"​")],-1)),i[94]||(i[94]=l("p",null,"点击资源/order/{orderId}后面的流控按钮，就可以弹出表单。",-1)),i[95]||(i[95]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715191757319.png",alt:"image-20210715191757319",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[96]||(i[96]=l("p",null,"表单中可以填写限流规则，如下：",-1)),i[97]||(i[97]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715192010657.png",alt:"image-20210715192010657",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[98]||(i[98]=l("p",null,"其含义是限制 /order/{orderId}这个资源的单机QPS为1，即每秒只允许1次请求，超出的请求会被拦截并报错。",-1)),i[99]||(i[99]=l("h4",{id:"_2-2-2-练习",tabindex:"-1"},[s("2.2.2 练习 "),l("a",{class:"header-anchor",href:"#_2-2-2-练习","aria-label":'Permalink to "2.2.2 练习"'},"​")],-1)),i[100]||(i[100]=l("p",null,"需求：给 /order/{orderId}这个资源设置流控规则，QPS不能超过 5，然后测试。",-1)),i[101]||(i[101]=l("p",null,"1）首先在sentinel控制台添加限流规则",-1)),i[102]||(i[102]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715192455429.png",alt:"image-20210715192455429",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[103]||(i[103]=l("p",null,"2）利用jmeter测试",-1)),i[104]||(i[104]=l("h5",{id:"_1-安装jmeter",tabindex:"-1"},[s("1. 安装Jmeter "),l("a",{class:"header-anchor",href:"#_1-安装jmeter","aria-label":'Permalink to "1. 安装Jmeter"'},"​")],-1)),i[105]||(i[105]=l("p",null,"Jmeter依赖于JDK，所以必须确保当前计算机上已经安装了JDK，并且配置了环境变量。",-1)),i[106]||(i[106]=l("h6",{id:"_1-1-下载",tabindex:"-1"},[s("1.1 下载 "),l("a",{class:"header-anchor",href:"#_1-1-下载","aria-label":'Permalink to "1.1 下载"'},"​")],-1)),i[107]||(i[107]=l("p",null,[s("可以Apache Jmeter官网下载，地址："),l("a",{href:"http://jmeter.apache.org/download_jmeter.cgi",target:"_blank",rel:"noreferrer"},"http://jmeter.apache.org/download_jmeter.cgi")],-1)),i[108]||(i[108]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193149837.png",alt:"image-20210715193149837",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[109]||(i[109]=l("p",null,"当然，我们课前资料也提供了下载好的安装包：",-1)),i[110]||(i[110]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193224094.png",alt:"image-20210715193224094",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[111]||(i[111]=l("h6",{id:"_1-2-解压",tabindex:"-1"},[s("1.2 解压 "),l("a",{class:"header-anchor",href:"#_1-2-解压","aria-label":'Permalink to "1.2 解压"'},"​")],-1)),i[112]||(i[112]=l("p",null,"因为下载的是zip包，解压缩即可使用，目录结构如下：",-1)),i[113]||(i[113]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193334367.png",alt:"image-20210715193334367",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[114]||(i[114]=l("p",null,"其中的bin目录就是执行的脚本，其中包含启动脚本：",-1)),i[115]||(i[115]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193414601.png",alt:"image-20210715193414601",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[116]||(i[116]=l("h6",{id:"_1-3-运行",tabindex:"-1"},[s("1.3 运行 "),l("a",{class:"header-anchor",href:"#_1-3-运行","aria-label":'Permalink to "1.3 运行"'},"​")],-1)),i[117]||(i[117]=l("p",null,"双击即可运行，但是有两点注意：",-1)),i[118]||(i[118]=l("ul",null,[l("li",null,"启动速度比较慢，要耐心等待"),l("li",null,"启动后黑窗口不能关闭，否则Jmeter也跟着关闭了")],-1)),i[119]||(i[119]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193730096.png",alt:"image-20210715193730096",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[120]||(i[120]=l("h5",{id:"_2-快速入门",tabindex:"-1"},[s("2. 快速入门 "),l("a",{class:"header-anchor",href:"#_2-快速入门","aria-label":'Permalink to "2. 快速入门"'},"​")],-1)),i[121]||(i[121]=l("h6",{id:"_2-1-设置中文语言",tabindex:"-1"},[s("2.1 设置中文语言 "),l("a",{class:"header-anchor",href:"#_2-1-设置中文语言","aria-label":'Permalink to "2.1 设置中文语言"'},"​")],-1)),i[122]||(i[122]=l("p",null,"默认Jmeter的语言是英文，需要设置：",-1)),i[123]||(i[123]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193838719.png",alt:"image-20210715193838719",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[124]||(i[124]=l("p",null,"效果：",-1)),i[125]||(i[125]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715193914039.png",alt:"image-20210715193914039",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[126]||(i[126]=l("blockquote",null,[l("p",null,[l("strong",null,"注意"),s("：上面的配置只能保证本次运行是中文，如果要永久中文，需要修改Jmeter的配置文件")])],-1)),i[127]||(i[127]=l("p",null,[s("打开jmeter文件夹，在bin目录中找到 "),l("strong",null,"jmeter.properties"),s("，添加下面配置：")],-1)),i[128]||(i[128]=l("div",{class:"language-properties max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"properties"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"language"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=zh_CN")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[129]||(i[129]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715194137982.png",alt:"image-20210715194137982",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[130]||(i[130]=l("blockquote",null,[l("p",null,"注意：前面不要出现#，#代表注释，另外这里是下划线，不是中划线")],-1)),i[131]||(i[131]=l("h6",{id:"_2-2-基本用法",tabindex:"-1"},[s("2.2 基本用法 "),l("a",{class:"header-anchor",href:"#_2-2-基本用法","aria-label":'Permalink to "2.2 基本用法"'},"​")],-1)),i[132]||(i[132]=l("p",null,"在测试计划上点鼠标右键，选择添加 > 线程（用户） > 线程组：",-1)),i[133]||(i[133]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715194413178.png",alt:"image-20210715194413178",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[134]||(i[134]=l("p",null,"在新增的线程组中，填写线程信息：",-1)),i[135]||(i[135]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715195053807.png",alt:"image-20210715195053807",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[136]||(i[136]=l("p",null,"给线程组点鼠标右键，添加http取样器：",-1)),i[137]||(i[137]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715195144130.png",alt:"image-20210715195144130",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[138]||(i[138]=l("p",null,"编写取样器内容：",-1)),i[139]||(i[139]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715195410764.png",alt:"image-20210715195410764",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[140]||(i[140]=l("p",null,"添加监听报告：",-1)),i[141]||(i[141]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715195844978.png",alt:"image-20210715195844978",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[142]||(i[142]=l("p",null,"添加监听结果树：",-1)),i[143]||(i[143]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200155537.png",alt:"image-20210715200155537",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[144]||(i[144]=l("p",null,"汇总报告结果：",-1)),i[145]||(i[145]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200243194.png",alt:"image-20210715200243194",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[146]||(i[146]=l("p",null,"结果树：",-1)),i[147]||(i[147]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200336526.png",alt:"image-20210715200336526",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[148]||(i[148]=l("p",null,"课前资料提供了编写好的Jmeter测试样例：",-1)),i[149]||(i[149]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200431615.png",alt:"image-20210715200431615",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[150]||(i[150]=l("p",null,"打开jmeter，导入课前资料提供的测试样例：",-1)),i[151]||(i[151]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200537171.png",alt:"image-20210715200537171",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[152]||(i[152]=l("p",null,"选择：",-1)),i[153]||(i[153]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200635414.png",alt:"image-20210715200635414",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[154]||(i[154]=l("p",null,"20个用户，2秒内运行完，QPS是10，超过了5.",-1)),i[155]||(i[155]=l("p",null,[s("选中"),l("code",null,"流控入门，QPS<5"),s("右键运行：")],-1)),i[156]||(i[156]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200804594.png",alt:"image-20210715200804594",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[157]||(i[157]=l("blockquote",null,[l("p",null,"注意，不要点击菜单中的执行按钮来运行。")],-1)),i[158]||(i[158]=l("p",null,"结果：",-1)),i[159]||(i[159]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715200853671.png",alt:"image-20210715200853671",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[160]||(i[160]=l("p",null,"可以看到，成功的请求每次只有5个",-1)),i[161]||(i[161]=l("h3",{id:"_2-3-流控模式",tabindex:"-1"},[s("2.3 流控模式 "),l("a",{class:"header-anchor",href:"#_2-3-流控模式","aria-label":'Permalink to "2.3 流控模式"'},"​")],-1)),i[162]||(i[162]=l("p",null,[s("在添加限流规则时，点击高级选项，可以选择三种"),l("strong",null,"流控模式"),s("：")],-1)),i[163]||(i[163]=l("ul",null,[l("li",null,"直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式"),l("li",null,"关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流"),l("li",null,"链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流")],-1)),i[164]||(i[164]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715201827886.png",alt:"image-20210715201827886",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[165]||(i[165]=l("p",null,"快速入门测试的就是直接模式。",-1)),i[166]||(i[166]=l("h4",{id:"_2-3-1-关联模式",tabindex:"-1"},[s("2.3.1 关联模式 "),l("a",{class:"header-anchor",href:"#_2-3-1-关联模式","aria-label":'Permalink to "2.3.1 关联模式"'},"​")],-1)),i[167]||(i[167]=l("p",null,[l("strong",null,"关联模式"),s("：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流")],-1)),i[168]||(i[168]=l("p",null,[l("strong",null,"配置规则"),s("：")],-1)),i[169]||(i[169]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715202540786.png",alt:"image-20210715202540786",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[170]||(i[170]=l("p",null,[l("strong",null,"语法说明"),s("：当/write资源访问量触发阈值时，就会对/read资源限流，避免影响/write资源。")],-1)),i[171]||(i[171]=l("p",null,[l("strong",null,"使用场景"),s("：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。")],-1)),i[172]||(i[172]=l("p",null,[l("strong",null,"需求说明"),s("：")],-1)),i[173]||(i[173]=l("ul",null,[l("li",null,[l("p",null,"在OrderController新建两个端点：/order/query和/order/update，无需实现业务")]),l("li",null,[l("p",null,"配置流控规则，当/order/ update资源被访问的QPS超过5时，对/order/query请求限流")])],-1)),i[174]||(i[174]=l("p",null,"1）定义/order/query端点，模拟订单查询",-1)),i[175]||(i[175]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/query"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryOrder"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "查询订单成功"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[176]||(i[176]=l("p",null,"2）定义/order/update端点，模拟订单更新",-1)),i[177]||(i[177]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/update"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"updateOrder"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "更新订单成功"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[178]||(i[178]=l("p",null,"重启服务，查看sentinel控制台的簇点链路：",-1)),i[179]||(i[179]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716101805951.png",alt:"image-20210716101805951",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[180]||(i[180]=l("p",null,"3）配置流控规则",-1)),i[181]||(i[181]=l("p",null,"对哪个端点限流，就点击哪个端点后面的按钮。我们是对订单查询/order/query限流，因此点击它后面的按钮：",-1)),i[182]||(i[182]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716101934499.png",alt:"image-20210716101934499",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[183]||(i[183]=l("p",null,"在表单中填写流控规则：",-1)),i[184]||(i[184]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716102103814.png",alt:"image-20210716102103814",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[185]||(i[185]=l("p",null,"4）在Jmeter测试",-1)),i[186]||(i[186]=l("p",null,"选择《流控模式-关联》：",-1)),i[187]||(i[187]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716102416266.png",alt:"image-20210716102416266",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[188]||(i[188]=l("p",null,"可以看到1000个用户，100秒，因此QPS为10，超过了我们设定的阈值：5",-1)),i[189]||(i[189]=l("p",null,"查看http请求：",-1)),i[190]||(i[190]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716102532554.png",alt:"image-20210716102532554",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[191]||(i[191]=l("p",null,"请求的目标是/order/update，这样这个断点就会触发阈值。",-1)),i[192]||(i[192]=l("p",null,"但限流的目标是/order/query，我们在浏览器访问，可以发现：",-1)),i[193]||(i[193]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716102636030.png",alt:"image-20210716102636030",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[194]||(i[194]=l("p",null,"确实被限流了。",-1)),i[195]||(i[195]=l("p",null,"5）总结",-1)),i[196]||(i[196]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716103143002.png",alt:"image-20210716103143002",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[197]||(i[197]=l("h4",{id:"_2-3-2-链路模式",tabindex:"-1"},[s("2.3.2 链路模式 "),l("a",{class:"header-anchor",href:"#_2-3-2-链路模式","aria-label":'Permalink to "2.3.2 链路模式"'},"​")],-1)),i[198]||(i[198]=l("p",null,[l("strong",null,"链路模式"),s("：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。")],-1)),i[199]||(i[199]=l("p",null,[l("strong",null,"配置示例"),s("：")],-1)),i[200]||(i[200]=l("p",null,"例如有两条请求链路：",-1)),i[201]||(i[201]=l("ul",null,[l("li",null,[l("p",null,"/test1 --> /common")]),l("li",null,[l("p",null,"/test2 --> /common")])],-1)),i[202]||(i[202]=l("p",null,"如果只希望统计从/test2进入到/common的请求，则可以这样配置：",-1)),i[203]||(i[203]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716103536346.png",alt:"image-20210716103536346",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[204]||(i[204]=l("p",null,[l("strong",null,"实战案例")],-1)),i[205]||(i[205]=l("p",null,"需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。",-1)),i[206]||(i[206]=l("p",null,"步骤：",-1)),i[207]||(i[207]=l("ol",null,[l("li",null,[l("p",null,"在OrderService中添加一个queryGoods方法，不用实现业务")]),l("li",null,[l("p",null,"在OrderController中，改造/order/query端点，调用OrderService中的queryGoods方法")]),l("li",null,[l("p",null,"在OrderController中添加一个/order/save的端点，调用OrderService的queryGoods方法")]),l("li",null,[l("p",null,"给queryGoods设置限流规则，从/order/query进入queryGoods的方法限制QPS必须小于2")])],-1)),i[208]||(i[208]=l("p",null,"实现：",-1)),i[209]||(i[209]=l("h5",{id:"_1-添加查询商品方法",tabindex:"-1"},[s("1）添加查询商品方法 "),l("a",{class:"header-anchor",href:"#_1-添加查询商品方法","aria-label":'Permalink to "1）添加查询商品方法"'},"​")],-1)),i[210]||(i[210]=l("p",null,"在order-service服务中，给OrderService类添加一个queryGoods方法：",-1)),i[211]||(i[211]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," queryGoods"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.err."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询商品"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[212]||(i[212]=l("h5",{id:"_2-查询订单时-查询商品",tabindex:"-1"},[s("2）查询订单时，查询商品 "),l("a",{class:"header-anchor",href:"#_2-查询订单时-查询商品","aria-label":'Permalink to "2）查询订单时，查询商品"'},"​")],-1)),i[213]||(i[213]=l("p",null,"在order-service的OrderController中，修改/order/query端点的业务逻辑：",-1)),i[214]||(i[214]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/query"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryOrder"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 查询商品")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    orderService."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryGoods"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 查询订单")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.out."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询订单"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "查询订单成功"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[215]||(i[215]=l("h5",{id:"_3-新增订单-查询商品",tabindex:"-1"},[s("3）新增订单，查询商品 "),l("a",{class:"header-anchor",href:"#_3-新增订单-查询商品","aria-label":'Permalink to "3）新增订单，查询商品"'},"​")],-1)),i[216]||(i[216]=l("p",null,"在order-service的OrderController中，修改/order/save端点，模拟新增订单：",-1)),i[217]||(i[217]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/save"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"saveOrder"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 查询商品")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    orderService."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryGoods"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 查询订单")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.err."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"新增订单"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "新增订单成功"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[218]||(i[218]=l("h5",{id:"_4-给查询商品添加资源标记",tabindex:"-1"},[s("4）给查询商品添加资源标记 "),l("a",{class:"header-anchor",href:"#_4-给查询商品添加资源标记","aria-label":'Permalink to "4）给查询商品添加资源标记"'},"​")],-1)),i[219]||(i[219]=l("p",null,"默认情况下，OrderService中的方法是不被Sentinel监控的，需要我们自己通过注解来标记要监控的方法。",-1)),i[220]||(i[220]=l("p",null,"给OrderService的queryGoods方法添加@SentinelResource注解：",-1)),i[221]||(i[221]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SentinelResource"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"goods"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," queryGoods"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    System.err."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询商品"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[222]||(i[222]=l("p",null,"链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。",-1)),i[223]||(i[223]=l("p",null,"我们需要关闭这种对SpringMVC的资源聚合，修改order-service服务的application.yml文件：",-1)),i[224]||(i[224]=l("div",{class:"language-yaml max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"yaml"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    sentinel"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      web-context-unify"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 关闭context整合")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[225]||(i[225]=l("p",null,"重启服务，访问/order/query和/order/save，可以查看到sentinel的簇点链路规则中，出现了新的资源：",-1)),i[226]||(i[226]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105227163.png",alt:"image-20210716105227163",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[227]||(i[227]=l("h5",{id:"_5-添加流控规则",tabindex:"-1"},[s("5）添加流控规则 "),l("a",{class:"header-anchor",href:"#_5-添加流控规则","aria-label":'Permalink to "5）添加流控规则"'},"​")],-1)),i[228]||(i[228]=l("p",null,"点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：",-1)),i[229]||(i[229]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105408723.png",alt:"image-20210716105408723",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[230]||(i[230]=l("p",null,"只统计从/order/query进入/goods的资源，QPS阈值为2，超出则被限流。",-1)),i[231]||(i[231]=l("h5",{id:"_6-jmeter测试",tabindex:"-1"},[s("6）Jmeter测试 "),l("a",{class:"header-anchor",href:"#_6-jmeter测试","aria-label":'Permalink to "6）Jmeter测试"'},"​")],-1)),i[232]||(i[232]=l("p",null,"选择《流控模式-链路》：",-1)),i[233]||(i[233]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105612312.png",alt:"image-20210716105612312",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[234]||(i[234]=l("p",null,"可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2",-1)),i[235]||(i[235]=l("p",null,"一个http请求是访问/order/save：",-1)),i[236]||(i[236]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105812789.png",alt:"image-20210716105812789",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[237]||(i[237]=l("p",null,"运行的结果：",-1)),i[238]||(i[238]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716110027064.png",alt:"image-20210716110027064",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[239]||(i[239]=l("p",null,"完全不受影响。",-1)),i[240]||(i[240]=l("p",null,"另一个是访问/order/query：",-1)),i[241]||(i[241]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105855951.png",alt:"image-20210716105855951",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[242]||(i[242]=l("p",null,"运行结果：",-1)),i[243]||(i[243]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716105956401.png",alt:"image-20210716105956401",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[244]||(i[244]=l("p",null,"每次只有2个通过。",-1)),i[245]||(i[245]=l("h4",{id:"_2-3-3-总结",tabindex:"-1"},[s("2.3.3 总结 "),l("a",{class:"header-anchor",href:"#_2-3-3-总结","aria-label":'Permalink to "2.3.3 总结"'},"​")],-1)),i[246]||(i[246]=l("blockquote",null,[l("ul",null,[l("li",null,[l("p",null,"流控模式有哪些？"),l("ul",null,[l("li",null,[l("p",null,"直接：对当前资源限流")]),l("li",null,[l("p",null,"关联：高优先级资源触发阈值，对低优先级资源限流。")]),l("li",null,[l("p",null,"链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流")])])])])],-1)),i[247]||(i[247]=l("h3",{id:"_2-4-流控效果",tabindex:"-1"},[s("2.4 流控效果 "),l("a",{class:"header-anchor",href:"#_2-4-流控效果","aria-label":'Permalink to "2.4 流控效果"'},"​")],-1)),i[248]||(i[248]=l("p",null,"在流控的高级选项中，还有一个流控效果选项：",-1)),i[249]||(i[249]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716110225104.png",alt:"image-20210716110225104",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[250]||(i[250]=l("p",null,"流控效果是指请求达到流控阈值时应该采取的措施，包括三种：",-1)),i[251]||(i[251]=l("ul",null,[l("li",null,[l("p",null,"快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。")]),l("li",null,[l("p",null,"warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。")]),l("li",null,[l("p",null,"排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长")])],-1)),i[252]||(i[252]=l("h4",{id:"_2-4-1-warm-up",tabindex:"-1"},[s("2.4.1 warm up "),l("a",{class:"header-anchor",href:"#_2-4-1-warm-up","aria-label":'Permalink to "2.4.1 warm up"'},"​")],-1)),i[253]||(i[253]=l("p",null,[s("阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（"),l("strong",null,"冷启动"),s("），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。")],-1)),i[254]||(i[254]=l("p",null,[s("warm up也叫"),l("strong",null,"预热模式"),s("，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。而coldFactor的默认值是3.")],-1)),i[255]||(i[255]=l("p",null,"例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，然后在5秒后逐渐增长到10.",-1)),i[256]||(i[256]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716110629796.png",alt:"image-20210716110629796",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[257]||(i[257]=l("p",null,[l("strong",null,"案例")],-1)),i[258]||(i[258]=l("p",null,"需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒",-1)),i[259]||(i[259]=l("h5",{id:"_1-配置流控规则",tabindex:"-1"},[s("1）配置流控规则： "),l("a",{class:"header-anchor",href:"#_1-配置流控规则","aria-label":'Permalink to "1）配置流控规则："'},"​")],-1)),i[260]||(i[260]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111012387.png",alt:"image-20210716111012387",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[261]||(i[261]=l("h5",{id:"_2-jmeter测试",tabindex:"-1"},[s("2）Jmeter测试 "),l("a",{class:"header-anchor",href:"#_2-jmeter测试","aria-label":'Permalink to "2）Jmeter测试"'},"​")],-1)),i[262]||(i[262]=l("p",null,"选择《流控效果，warm up》：",-1)),i[263]||(i[263]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111136699.png",alt:"image-20210716111136699",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[264]||(i[264]=l("p",null,"QPS为10.",-1)),i[265]||(i[265]=l("p",null,"刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：",-1)),i[266]||(i[266]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111303701.png",alt:"image-20210716111303701",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[267]||(i[267]=l("p",null,"随着时间推移，成功比例越来越高：",-1)),i[268]||(i[268]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111404717.png",alt:"image-20210716111404717",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[269]||(i[269]=l("p",null,"到Sentinel控制台查看实时监控：",-1)),i[270]||(i[270]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111526480.png",alt:"image-20210716111526480",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[271]||(i[271]=l("p",null,"一段时间后：",-1)),i[272]||(i[272]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716111658541.png",alt:"image-20210716111658541",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[273]||(i[273]=l("h4",{id:"_2-4-2-排队等待",tabindex:"-1"},[s("2.4.2 排队等待 "),l("a",{class:"header-anchor",href:"#_2-4-2-排队等待","aria-label":'Permalink to "2.4.2 排队等待"'},"​")],-1)),i[274]||(i[274]=l("p",null,"当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。",-1)),i[275]||(i[275]=l("p",null,"而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。",-1)),i[276]||(i[276]=l("p",null,"工作原理",-1)),i[277]||(i[277]=l("p",null,[s("例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着"),l("strong",null,"预期等待时长"),s("超过2000ms的请求会被拒绝并抛出异常。")],-1)),i[278]||(i[278]=l("p",null,"那什么叫做预期等待时长呢？",-1)),i[279]||(i[279]=l("p",null,"比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：",-1)),i[280]||(i[280]=l("ul",null,[l("li",null,[s("第6个请求的"),l("strong",null,"预期等待时长"),s(" = 200 * （6 - 1） = 1000ms")]),l("li",null,"第12个请求的预期等待时长 = 200 * （12-1） = 2200ms")],-1)),i[281]||(i[281]=l("p",null,"现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：",-1)),i[282]||(i[282]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716113147176.png",alt:"image-20210716113147176",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[283]||(i[283]=l("p",null,"如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：",-1)),i[284]||(i[284]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716113426524.png",alt:"image-20210716113426524",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[285]||(i[285]=l("p",null,"平滑的QPS曲线，对于服务器来说是更友好的。",-1)),i[286]||(i[286]=l("p",null,[l("strong",null,"案例")],-1)),i[287]||(i[287]=l("p",null,"需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s",-1)),i[288]||(i[288]=l("h5",{id:"_1-添加流控规则",tabindex:"-1"},[s("1）添加流控规则 "),l("a",{class:"header-anchor",href:"#_1-添加流控规则","aria-label":'Permalink to "1）添加流控规则"'},"​")],-1)),i[289]||(i[289]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716114048918.png",alt:"image-20210716114048918",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[290]||(i[290]=l("h5",{id:"_2-jmeter测试-1",tabindex:"-1"},[s("2）Jmeter测试 "),l("a",{class:"header-anchor",href:"#_2-jmeter测试-1","aria-label":'Permalink to "2）Jmeter测试"'},"​")],-1)),i[291]||(i[291]=l("p",null,"选择《流控效果，队列》：",-1)),i[292]||(i[292]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716114243558.png",alt:"image-20210716114243558",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[293]||(i[293]=l("p",null,"QPS为15，已经超过了我们设定的10。",-1)),i[294]||(i[294]=l("p",null,"如果是之前的 快速失败、warmup模式，超出的请求应该会直接报错。",-1)),i[295]||(i[295]=l("p",null,"但是我们看看队列模式的运行结果：",-1)),i[296]||(i[296]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716114429361.png",alt:"image-20210716114429361",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[297]||(i[297]=l("p",null,"全部都通过了。",-1)),i[298]||(i[298]=l("p",null,"再去sentinel查看实时监控的QPS曲线：",-1)),i[299]||(i[299]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716114522935.png",alt:"image-20210716114522935",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[300]||(i[300]=l("p",null,[s("QPS非常平滑，一致保持在10，但是超出的请求没有被拒绝，而是放入队列。因此"),l("strong",null,"响应时间"),s("（等待时间）会越来越长。")],-1)),i[301]||(i[301]=l("p",null,"当队列满了以后，才会有部分请求失败：",-1)),i[302]||(i[302]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716114651137.png",alt:"image-20210716114651137",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[303]||(i[303]=l("h4",{id:"_2-4-3-总结",tabindex:"-1"},[s("2.4.3 总结 "),l("a",{class:"header-anchor",href:"#_2-4-3-总结","aria-label":'Permalink to "2.4.3 总结"'},"​")],-1)),i[304]||(i[304]=l("blockquote",null,[l("ul",null,[l("li",null,[l("p",null,"流控效果有哪些？"),l("ul",null,[l("li",null,[l("p",null,"快速失败：QPS超过阈值时，拒绝新的请求")]),l("li",null,[l("p",null,"warm up： QPS超过阈值时，拒绝新的请求；QPS阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。")]),l("li",null,[l("p",null,"排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝")])])])])],-1)),i[305]||(i[305]=l("h3",{id:"_2-5-热点参数限流",tabindex:"-1"},[s("2.5 热点参数限流 "),l("a",{class:"header-anchor",href:"#_2-5-热点参数限流","aria-label":'Permalink to "2.5 热点参数限流"'},"​")],-1)),i[306]||(i[306]=l("p",null,[s("之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是"),l("strong",null,"分别统计参数值相同的请求"),s("，判断是否超过QPS阈值。")],-1)),i[307]||(i[307]=l("h4",{id:"_2-5-1-全局参数限流",tabindex:"-1"},[s("2.5.1 全局参数限流 "),l("a",{class:"header-anchor",href:"#_2-5-1-全局参数限流","aria-label":'Permalink to "2.5.1 全局参数限流"'},"​")],-1)),i[308]||(i[308]=l("p",null,"例如，一个根据id查询商品的接口：",-1)),i[309]||(i[309]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716115014663.png",alt:"image-20210716115014663",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[310]||(i[310]=l("p",null,"访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：",-1)),i[311]||(i[311]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716115131463.png",alt:"image-20210716115131463",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[312]||(i[312]=l("p",null,"当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。",-1)),i[313]||(i[313]=l("p",null,"配置示例：",-1)),i[314]||(i[314]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716115232426.png",alt:"image-20210716115232426",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[315]||(i[315]=l("p",null,[s("代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒"),l("strong",null,"相同参数值"),s("的请求数不能超过5")],-1)),i[316]||(i[316]=l("h4",{id:"_2-5-2-热点参数限流",tabindex:"-1"},[s("2.5.2 热点参数限流 "),l("a",{class:"header-anchor",href:"#_2-5-2-热点参数限流","aria-label":'Permalink to "2.5.2 热点参数限流"'},"​")],-1)),i[317]||(i[317]=l("p",null,"刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.",-1)),i[318]||(i[318]=l("p",null,"而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：",-1)),i[319]||(i[319]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716115717523.png",alt:"image-20210716115717523",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[320]||(i[320]=l("p",null,"结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：",-1)),i[321]||(i[321]=l("ul",null,[l("li",null,[l("p",null,"如果参数值是100，则每1秒允许的QPS为10")]),l("li",null,[l("p",null,"如果参数值是101，则每1秒允许的QPS为15")])],-1)),i[322]||(i[322]=l("h4",{id:"_2-5-3-案例",tabindex:"-1"},[s("2.5.3 案例 "),l("a",{class:"header-anchor",href:"#_2-5-3-案例","aria-label":'Permalink to "2.5.3 案例"'},"​")],-1)),i[323]||(i[323]=l("p",null,[l("strong",null,"案例需求"),s("：给/order/{orderId}这个资源添加热点参数限流，规则如下：")],-1)),i[324]||(i[324]=l("ul",null,[l("li",null,"默认的热点参数规则是每1秒请求量不超过2"),l("li",null,"给102这个参数设置例外：每1秒请求量不超过4"),l("li",null,"给103这个参数设置例外：每1秒请求量不超过10")],-1)),i[325]||(i[325]=l("p",null,[l("strong",null,"注意事项"),s("：热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源")],-1)),i[326]||(i[326]=l("h5",{id:"_1-标记资源",tabindex:"-1"},[s("1）标记资源 "),l("a",{class:"header-anchor",href:"#_1-标记资源","aria-label":'Permalink to "1）标记资源"'},"​")],-1)),i[327]||(i[327]=l("p",null,"给order-service中的OrderController中的/order/{orderId}资源添加注解：",-1)),i[328]||(i[328]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120033572.png",alt:"image-20210716120033572",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[329]||(i[329]=l("h5",{id:"_2-热点参数限流规则",tabindex:"-1"},[s("2）热点参数限流规则 "),l("a",{class:"header-anchor",href:"#_2-热点参数限流规则","aria-label":'Permalink to "2）热点参数限流规则"'},"​")],-1)),i[330]||(i[330]=l("p",null,"访问该接口，可以看到我们标记的hot资源出现了：",-1)),i[331]||(i[331]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120208509.png",alt:"image-20210716120208509",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[332]||(i[332]=l("p",null,"这里不要点击hot后面的按钮，页面有BUG",-1)),i[333]||(i[333]=l("p",null,[s("点击左侧菜单中"),l("strong",null,"热点规则"),s("菜单：")],-1)),i[334]||(i[334]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120319009.png",alt:"image-20210716120319009",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[335]||(i[335]=l("p",null,"点击新增，填写表单：",-1)),i[336]||(i[336]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120536714.png",alt:"image-20210716120536714",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[337]||(i[337]=l("h5",{id:"_3-jmeter测试",tabindex:"-1"},[s("3）Jmeter测试 "),l("a",{class:"header-anchor",href:"#_3-jmeter测试","aria-label":'Permalink to "3）Jmeter测试"'},"​")],-1)),i[338]||(i[338]=l("p",null,"选择《热点参数限流 QPS1》：",-1)),i[339]||(i[339]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120754527.png",alt:"image-20210716120754527",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[340]||(i[340]=l("p",null,"这里发起请求的QPS为5.",-1)),i[341]||(i[341]=l("p",null,"包含3个http请求：",-1)),i[342]||(i[342]=l("p",null,"普通参数，QPS阈值为2",-1)),i[343]||(i[343]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120840501.png",alt:"image-20210716120840501",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[344]||(i[344]=l("p",null,"运行结果：",-1)),i[345]||(i[345]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716121105567.png",alt:"image-20210716121105567",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[346]||(i[346]=l("p",null,"例外项，QPS阈值为4",-1)),i[347]||(i[347]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120900365.png",alt:"image-20210716120900365",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[348]||(i[348]=l("p",null,"运行结果：",-1)),i[349]||(i[349]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716121201630.png",alt:"image-20210716121201630",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[350]||(i[350]=l("p",null,"例外项，QPS阈值为10",-1)),i[351]||(i[351]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716120919131.png",alt:"image-20210716120919131",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[352]||(i[352]=l("p",null,"运行结果：",-1)),i[353]||(i[353]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210716121220305.png",alt:"image-20210716121220305",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[354]||(i[354]=l("hr",null,null,-1)),i[355]||(i[355]=l("h2",{id:"_3-隔离和降级",tabindex:"-1"},[s("3. 隔离和降级 "),l("a",{class:"header-anchor",href:"#_3-隔离和降级","aria-label":'Permalink to "3. 隔离和降级"'},"​")],-1)),i[356]||(i[356]=l("p",null,"限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。",-1)),i[357]||(i[357]=l("p",null,[s("而要将这些故障控制在一定范围，避免雪崩，就要靠"),l("strong",null,"线程隔离"),s("（舱壁模式）和"),l("strong",null,"熔断降级"),s("手段了。")],-1)),i[358]||(i[358]=l("p",null,[l("strong",null,"线程隔离"),s("之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。")],-1)),i[359]||(i[359]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173215243.png",alt:"image-20210715173215243",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[360]||(i[360]=l("p",null,[l("strong",null,"熔断降级"),s("：是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。")],-1)),i[361]||(i[361]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210715173428073.png",alt:"image-20210715173428073",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[362]||(i[362]=l("p",null,[s("可以看到，不管是线程隔离还是熔断降级，都是对"),l("strong",null,"客户端"),s("（调用方）的保护。需要在"),l("strong",null,"调用方"),s(" 发起远程调用时做线程隔离、或者服务熔断。")],-1)),i[363]||(i[363]=l("p",null,"而我们的微服务远程调用都是基于Feign来完成的，因此我们需要将Feign与Sentinel整合，在Feign里面实现线程隔离和服务熔断。",-1)),i[364]||(i[364]=l("h3",{id:"_3-1-feignclient整合sentinel",tabindex:"-1"},[s("3.1 FeignClient整合Sentinel "),l("a",{class:"header-anchor",href:"#_3-1-feignclient整合sentinel","aria-label":'Permalink to "3.1 FeignClient整合Sentinel"'},"​")],-1)),i[365]||(i[365]=l("p",null,"SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。",-1)),i[366]||(i[366]=l("h4",{id:"_3-1-1-修改配置-开启sentinel功能",tabindex:"-1"},[s("3.1.1 修改配置，开启sentinel功能 "),l("a",{class:"header-anchor",href:"#_3-1-1-修改配置-开启sentinel功能","aria-label":'Permalink to "3.1.1 修改配置，开启sentinel功能"'},"​")],-1)),i[367]||(i[367]=l("p",null,"修改OrderService的application.yml文件，开启Feign的Sentinel功能：",-1)),i[368]||(i[368]=l("div",{class:"language-yaml max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"yaml"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"feign"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  sentinel"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    enabled"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 开启feign对sentinel的支持")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[369]||(i[369]=l("h4",{id:"_3-1-2-编写失败降级逻辑",tabindex:"-1"},[s("3.1.2 编写失败降级逻辑 "),l("a",{class:"header-anchor",href:"#_3-1-2-编写失败降级逻辑","aria-label":'Permalink to "3.1.2 编写失败降级逻辑"'},"​")],-1)),i[370]||(i[370]=l("p",null,"业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。",-1)),i[371]||(i[371]=l("p",null,"给FeignClient编写失败后的降级逻辑",-1)),i[372]||(i[372]=l("p",null,"①方式一：FallbackClass，无法对远程调用的异常做处理",-1)),i[373]||(i[373]=l("p",null,"②方式二：FallbackFactory，可以对远程调用的异常做处理，我们选择这种",-1)),i[374]||(i[374]=l("p",null,"这里我们演示方式二的失败降级处理。",-1)),i[375]||(i[375]=l("p",null,[l("strong",null,"步骤一"),s("：在feing-api项目中定义类，实现FallbackFactory：")],-1)),i[376]||(i[376]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208023848898.png",alt:"image-20251208023848898",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[377]||(i[377]=l("p",null,"代码：",-1)),i[378]||(i[378]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.feign.clients.fallback;")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.feign.clients.UserClient;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.feign.pojo.User;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," feign.hystrix.FallbackFactory;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lombok.extern.slf4j.Slf4j;")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Slf4j")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserClientFallbackFactory"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," FallbackFactory"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UserClient"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserClient "),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"create"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Throwable "),l("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"throwable"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserClient"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            @"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            public"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," User "),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findById"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Long "),l("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                log."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"查询用户异常"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", throwable);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," User"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        };")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[379]||(i[379]=l("p",null,[l("strong",null,"步骤二"),s("：在feing-api项目中的DefaultFeignConfiguration类中将UserClientFallbackFactory注册为一个Bean：")],-1)),i[380]||(i[380]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Bean")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserClientFallbackFactory "),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"userClientFallbackFactory"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(){")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserClientFallbackFactory"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[381]||(i[381]=l("p",null,[l("strong",null,"步骤三"),s("：在feing-api项目中的UserClient接口中使用UserClientFallbackFactory：")],-1)),i[382]||(i[382]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.feign.clients.fallback.UserClientFallbackFactory;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.feign.pojo.User;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.cloud.openfeign.FeignClient;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.web.bind.annotation.GetMapping;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.web.bind.annotation.PathVariable;")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"FeignClient"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"value"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "userservice"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"fallbackFactory"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UserClientFallbackFactory.class)")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," interface"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," UserClient"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/user/{id}"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    User "),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findById"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(@"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PathVariable"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"id"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") Long "),l("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"id"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[383]||(i[383]=l("p",null,"重启后，访问一次订单查询业务，然后查看sentinel控制台，可以看到新的簇点链路：",-1)),i[384]||(i[384]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208023921576.png",alt:"image-20251208023921576",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[385]||(i[385]=l("h4",{id:"_3-1-3-总结",tabindex:"-1"},[s("3.1.3 总结 "),l("a",{class:"header-anchor",href:"#_3-1-3-总结","aria-label":'Permalink to "3.1.3 总结"'},"​")],-1)),i[386]||(i[386]=l("p",null,"Sentinel支持的雪崩解决方案：",-1)),i[387]||(i[387]=l("ul",null,[l("li",null,"线程隔离（仓壁模式）"),l("li",null,"降级熔断")],-1)),i[388]||(i[388]=l("p",null,"Feign整合Sentinel的步骤：",-1)),i[389]||(i[389]=l("ul",null,[l("li",null,"在application.yml中配置：feign.sentienl.enable=true"),l("li",null,"给FeignClient编写FallbackFactory并注册为Bean"),l("li",null,"将FallbackFactory配置到FeignClient")],-1)),i[390]||(i[390]=l("h3",{id:"_3-2-线程隔离-舱壁模式",tabindex:"-1"},[s("3.2 线程隔离（舱壁模式） "),l("a",{class:"header-anchor",href:"#_3-2-线程隔离-舱壁模式","aria-label":'Permalink to "3.2 线程隔离（舱壁模式）"'},"​")],-1)),i[391]||(i[391]=l("h4",{id:"_3-2-1-线程隔离的实现方式",tabindex:"-1"},[s("3.2.1 线程隔离的实现方式 "),l("a",{class:"header-anchor",href:"#_3-2-1-线程隔离的实现方式","aria-label":'Permalink to "3.2.1 线程隔离的实现方式"'},"​")],-1)),i[392]||(i[392]=l("p",null,"线程隔离有两种方式实现：",-1)),i[393]||(i[393]=l("ul",null,[l("li",null,[l("p",null,"线程池隔离")]),l("li",null,[l("p",null,"信号量隔离（Sentinel默认采用）")])],-1)),i[394]||(i[394]=l("p",null,"如图：",-1)),i[395]||(i[395]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208023947160.png",alt:"image-20251208023947160",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[396]||(i[396]=l("p",null,[l("strong",null,"线程池隔离"),s("：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果")],-1)),i[397]||(i[397]=l("p",null,[l("strong",null,"信号量隔离"),s("：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。")],-1)),i[398]||(i[398]=l("p",null,"两者的优缺点：",-1)),i[399]||(i[399]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024008412.png",alt:"image-20251208024008412",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[400]||(i[400]=l("h4",{id:"_3-2-2-sentinel的线程隔离",tabindex:"-1"},[s("3.2.2 sentinel的线程隔离 "),l("a",{class:"header-anchor",href:"#_3-2-2-sentinel的线程隔离","aria-label":'Permalink to "3.2.2 sentinel的线程隔离"'},"​")],-1)),i[401]||(i[401]=l("p",null,[l("strong",null,"用法说明"),s("：")],-1)),i[402]||(i[402]=l("p",null,"在添加限流规则时，可以选择两种阈值类型：",-1)),i[403]||(i[403]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024048368.png",alt:"image-20251208024048368",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[404]||(i[404]=l("ul",null,[l("li",null,[l("p",null,"QPS：就是每秒的请求数，在快速入门中已经演示过")]),l("li",null,[l("p",null,[s("线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现"),l("strong",null,"线程隔离"),s("（舱壁模式）。")])])],-1)),i[405]||(i[405]=l("p",null,[l("strong",null,"案例需求"),s("：给 order-service服务中的UserClient的查询用户接口设置流控规则，线程数不能超过 2。然后利用jemeter测试。")],-1)),i[406]||(i[406]=l("h5",{id:"_1-配置隔离规则",tabindex:"-1"},[s("1）配置隔离规则 "),l("a",{class:"header-anchor",href:"#_1-配置隔离规则","aria-label":'Permalink to "1）配置隔离规则"'},"​")],-1)),i[407]||(i[407]=l("p",null,"选择feign接口后面的流控按钮：",-1)),i[408]||(i[408]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024124810.png",alt:"image-20210716123831992",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[409]||(i[409]=l("p",null,"填写表单：",-1)),i[410]||(i[410]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024154711.png",alt:"image-20251208024154711",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[411]||(i[411]=l("h5",{id:"_2-jmeter测试-2",tabindex:"-1"},[s("2）Jmeter测试 "),l("a",{class:"header-anchor",href:"#_2-jmeter测试-2","aria-label":'Permalink to "2）Jmeter测试"'},"​")],-1)),i[412]||(i[412]=l("p",null,"选择《阈值类型-线程数<2》：",-1)),i[413]||(i[413]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024219794.png",alt:"image-20251208024219794",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[414]||(i[414]=l("p",null,"一次发生10个请求，有较大概率并发线程数超过2，而超出的请求会走之前定义的失败降级逻辑。",-1)),i[415]||(i[415]=l("p",null,"查看运行结果：",-1)),i[416]||(i[416]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024238141.png",alt:"image-20251208024238141",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[417]||(i[417]=l("p",null,"发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的null信息。",-1)),i[418]||(i[418]=l("h4",{id:"_3-2-3-总结",tabindex:"-1"},[s("3.2.3 总结 "),l("a",{class:"header-anchor",href:"#_3-2-3-总结","aria-label":'Permalink to "3.2.3 总结"'},"​")],-1)),i[419]||(i[419]=l("blockquote",null,[l("p",null,"线程隔离的两种手段是？"),l("ul",null,[l("li",null,[l("p",null,"信号量隔离")]),l("li",null,[l("p",null,"线程池隔离")])]),l("p",null,"信号量隔离的特点是？"),l("ul",null,[l("li",null,"基于计数器模式，简单，开销小")]),l("p",null,"线程池隔离的特点是？"),l("ul",null,[l("li",null,"基于线程池模式，有额外开销，但隔离控制更强")])],-1)),i[420]||(i[420]=l("h3",{id:"_3-3-熔断降级",tabindex:"-1"},[s("3.3 熔断降级 "),l("a",{class:"header-anchor",href:"#_3-3-熔断降级","aria-label":'Permalink to "3.3 熔断降级"'},"​")],-1)),i[421]||(i[421]=l("p",null,[s("熔断降级是解决雪崩问题的重要手段。其思路是由"),l("strong",null,"断路器"),s("统计服务调用的异常比例、慢请求比例，如果超出阈值则会"),l("strong",null,"熔断"),s("该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。")],-1)),i[422]||(i[422]=l("p",null,"断路器控制熔断和放行是通过状态机来完成的：",-1)),i[423]||(i[423]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024309805.png",alt:"image-20251208024309805",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[424]||(i[424]=l("p",null,"状态机包括三个状态：",-1)),i[425]||(i[425]=l("ul",null,[l("li",null,"closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态"),l("li",null,[s("open：打开状态，服务调用被"),l("strong",null,"熔断"),s("，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态")]),l("li",null,[s("half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。 "),l("ul",null,[l("li",null,"请求成功：则切换到closed状态"),l("li",null,"请求失败：则切换到open状态")])])],-1)),i[426]||(i[426]=l("p",null,"断路器熔断策略有三种：慢调用、异常比例、异常数",-1)),i[427]||(i[427]=l("h4",{id:"_3-3-1-慢调用",tabindex:"-1"},[s("3.3.1 慢调用 "),l("a",{class:"header-anchor",href:"#_3-3-1-慢调用","aria-label":'Permalink to "3.3.1 慢调用"'},"​")],-1)),i[428]||(i[428]=l("p",null,[l("strong",null,"慢调用"),s("：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。")],-1)),i[429]||(i[429]=l("p",null,"例如：",-1)),i[430]||(i[430]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024331643.png",alt:"image-20251208024331643",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[431]||(i[431]=l("p",null,"解读：RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。",-1)),i[432]||(i[432]=l("p",null,[l("strong",null,"案例")],-1)),i[433]||(i[433]=l("p",null,"需求：给 UserClient的查询用户接口设置降级规则，慢调用的RT阈值为50ms，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5",-1)),i[434]||(i[434]=l("h5",{id:"_1-设置慢调用",tabindex:"-1"},[s("1）设置慢调用 "),l("a",{class:"header-anchor",href:"#_1-设置慢调用","aria-label":'Permalink to "1）设置慢调用"'},"​")],-1)),i[435]||(i[435]=l("p",null,"修改user-service中的/user/{id}这个接口的业务。通过休眠模拟一个延迟时间：",-1)),i[436]||(i[436]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024357370.png",alt:"image-20251208024357370",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[437]||(i[437]=l("p",null,"此时，orderId=101的订单，关联的是id为1的用户，调用时长为60ms：",-1)),i[438]||(i[438]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024425430.png",alt:"image-20251208024425430",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[439]||(i[439]=l("p",null,"orderId=102的订单，关联的是id为2的用户，调用时长为非常短；",-1)),i[440]||(i[440]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024453874.png",alt:"image-20251208024453874",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[441]||(i[441]=l("h5",{id:"_2-设置熔断规则",tabindex:"-1"},[s("2）设置熔断规则 "),l("a",{class:"header-anchor",href:"#_2-设置熔断规则","aria-label":'Permalink to "2）设置熔断规则"'},"​")],-1)),i[442]||(i[442]=l("p",null,"下面，给feign接口设置降级规则：",-1)),i[443]||(i[443]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024521003.png",alt:"image-20251208024521003",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[444]||(i[444]=l("p",null,"规则：",-1)),i[445]||(i[445]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024542743.png",alt:"image-20251208024542743",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[446]||(i[446]=l("p",null,"超过50ms的请求都会被认为是慢请求",-1)),i[447]||(i[447]=l("h5",{id:"_3-测试",tabindex:"-1"},[s("3）测试 "),l("a",{class:"header-anchor",href:"#_3-测试","aria-label":'Permalink to "3）测试"'},"​")],-1)),i[448]||(i[448]=l("p",null,[s("在浏览器访问："),l("code",null,"http://localhost:8088/order/101"),s("，快速刷新5次，可以发现：")],-1)),i[449]||(i[449]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024648700.png",alt:"image-20251208024648700",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[450]||(i[450]=l("p",null,"触发了熔断，请求时长缩短至5ms，快速失败了，并且走降级逻辑，返回的null",-1)),i[451]||(i[451]=l("p",null,[s("在浏览器访问："),l("code",null,"http://localhost:8088/order/102"),s("，竟然也被熔断了：")],-1)),i[452]||(i[452]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024706349.png",alt:"image-20251208024706349",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[453]||(i[453]=l("h4",{id:"_3-3-2-异常比例、异常数",tabindex:"-1"},[s("3.3.2 异常比例、异常数 "),l("a",{class:"header-anchor",href:"#_3-3-2-异常比例、异常数","aria-label":'Permalink to "3.3.2 异常比例、异常数"'},"​")],-1)),i[454]||(i[454]=l("p",null,[l("strong",null,"异常比例或异常数"),s("：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。")],-1)),i[455]||(i[455]=l("p",null,"例如，一个异常比例设置：",-1)),i[456]||(i[456]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024729436.png",alt:"image-20251208024729436",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[457]||(i[457]=l("p",null,"解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。",-1)),i[458]||(i[458]=l("p",null,"一个异常数设置：",-1)),i[459]||(i[459]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024744780.png",alt:"image-20251208024744780",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[460]||(i[460]=l("p",null,"解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常数不低于2次，则触发熔断。",-1)),i[461]||(i[461]=l("p",null,[l("strong",null,"案例")],-1)),i[462]||(i[462]=l("p",null,"需求：给 UserClient的查询用户接口设置降级规则，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5s",-1)),i[463]||(i[463]=l("h5",{id:"_1-设置异常请求",tabindex:"-1"},[s("1）设置异常请求 "),l("a",{class:"header-anchor",href:"#_1-设置异常请求","aria-label":'Permalink to "1）设置异常请求"'},"​")],-1)),i[464]||(i[464]=l("p",null,"首先，修改user-service中的/user/{id}这个接口的业务。手动抛出异常，以触发异常比例的熔断：",-1)),i[465]||(i[465]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024804980.png",alt:"image-20251208024804980",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[466]||(i[466]=l("p",null,"也就是说，id 为 2时，就会触发异常",-1)),i[467]||(i[467]=l("h5",{id:"_2-设置熔断规则-1",tabindex:"-1"},[s("2）设置熔断规则 "),l("a",{class:"header-anchor",href:"#_2-设置熔断规则-1","aria-label":'Permalink to "2）设置熔断规则"'},"​")],-1)),i[468]||(i[468]=l("p",null,"下面，给feign接口设置降级规则：",-1)),i[469]||(i[469]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024914262.png",alt:"image-20251208024914262",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[470]||(i[470]=l("p",null,"规则：",-1)),i[471]||(i[471]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024928605.png",alt:"image-20251208024928605",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[472]||(i[472]=l("p",null,"在5次请求中，只要异常比例超过0.4，也就是有2次以上的异常，就会触发熔断。",-1)),i[473]||(i[473]=l("h5",{id:"_3-测试-1",tabindex:"-1"},[s("3）测试 "),l("a",{class:"header-anchor",href:"#_3-测试-1","aria-label":'Permalink to "3）测试"'},"​")],-1)),i[474]||(i[474]=l("p",null,[s("在浏览器快速访问："),l("code",null,"http://localhost:8088/order/102"),s("，快速刷新5次，触发熔断：")],-1)),i[475]||(i[475]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208024949579.png",alt:"image-20251208024949579",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[476]||(i[476]=l("p",null,"此时，我们去访问本来应该正常的103：",-1)),i[477]||(i[477]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025012356.png",alt:"image-20251208025012356",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[478]||(i[478]=l("hr",null,null,-1)),i[479]||(i[479]=l("h2",{id:"_4-授权规则",tabindex:"-1"},[s("4. 授权规则 "),l("a",{class:"header-anchor",href:"#_4-授权规则","aria-label":'Permalink to "4. 授权规则"'},"​")],-1)),i[480]||(i[480]=l("p",null,"授权规则可以对请求方来源做判断和控制。",-1)),i[481]||(i[481]=l("h3",{id:"_4-1-授权规则",tabindex:"-1"},[s("4.1 授权规则 "),l("a",{class:"header-anchor",href:"#_4-1-授权规则","aria-label":'Permalink to "4.1 授权规则"'},"​")],-1)),i[482]||(i[482]=l("h4",{id:"_4-1-1-基本规则",tabindex:"-1"},[s("4.1.1 基本规则 "),l("a",{class:"header-anchor",href:"#_4-1-1-基本规则","aria-label":'Permalink to "4.1.1 基本规则"'},"​")],-1)),i[483]||(i[483]=l("p",null,"授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。",-1)),i[484]||(i[484]=l("ul",null,[l("li",null,[l("p",null,"白名单：来源（origin）在白名单内的调用者允许访问")]),l("li",null,[l("p",null,"黑名单：来源（origin）在黑名单内的调用者不允许访问")])],-1)),i[485]||(i[485]=l("p",null,"点击左侧菜单的授权，可以看到授权规则：",-1)),i[486]||(i[486]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025038299.png",alt:"image-20251208025038299",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[487]||(i[487]=l("ul",null,[l("li",{orderId:""},[l("p",null,"资源名：就是受保护的资源，例如/order/")]),l("li",null,[l("p",null,"流控应用：是来源者的名单，"),l("ul",null,[l("li",null,"如果是勾选白名单，则名单中的来源被许可访问。"),l("li",null,"如果是勾选黑名单，则名单中的来源被禁止访问。")])])],-1)),i[488]||(i[488]=l("p",null,"比如：",-1)),i[489]||(i[489]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025051405.png",alt:"image-20251208025051405",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[490]||(i[490]=l("p",null,[s("我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写"),l("strong",null,"网关的来源名称（origin）"),s("。")],-1)),i[491]||(i[491]=l("h4",{id:"_4-1-2-如何获取origin",tabindex:"-1"},[s("4.1.2 如何获取origin "),l("a",{class:"header-anchor",href:"#_4-1-2-如何获取origin","aria-label":'Permalink to "4.1.2 如何获取origin"'},"​")],-1)),i[492]||(i[492]=l("p",null,"Sentinel是通过RequestOriginParser这个接口的parseOrigin来获取请求的来源的。",-1)),i[493]||(i[493]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," interface"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RequestOriginParser"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 从请求request对象中获取origin，获取方式自定义")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String "),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseOrigin"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),l("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[494]||(i[494]=l("p",null,"这个方法的作用就是从request对象中，获取请求者的origin值并返回。",-1)),i[495]||(i[495]=l("p",null,"默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。",-1)),i[496]||(i[496]=l("p",null,[s("因此，我们需要自定义这个接口的实现，让"),l("strong",null,"不同的请求，返回不同的origin"),s("。")],-1)),i[497]||(i[497]=l("p",null,"例如order-service服务中，我们定义一个RequestOriginParser的实现类：",-1)),i[498]||(i[498]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.order.sentinel;")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.util.StringUtils;")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," javax.servlet.http.HttpServletRequest;")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HeaderOriginParser"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RequestOriginParser"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseOrigin"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),l("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.获取请求头")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String origin "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getHeader"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"origin"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 2.非空判断")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(origin)) {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            origin "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "blank"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," origin;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[499]||(i[499]=l("p",null,"我们会尝试从request-header中获取origin值。",-1)),i[500]||(i[500]=l("h4",{id:"_4-1-3-给网关添加请求头",tabindex:"-1"},[s("4.1.3 给网关添加请求头 "),l("a",{class:"header-anchor",href:"#_4-1-3-给网关添加请求头","aria-label":'Permalink to "4.1.3 给网关添加请求头"'},"​")],-1)),i[501]||(i[501]=l("p",null,[s("既然获取请求origin的方式是从reques-header中获取origin值，我们必须让"),l("strong",null,"所有从gateway路由到微服务的请求都带上origin头"),s("。")],-1)),i[502]||(i[502]=l("p",null,"这个需要利用之前学习的一个GatewayFilter来实现，AddRequestHeaderGatewayFilter。",-1)),i[503]||(i[503]=l("p",null,"修改gateway服务中的application.yml，添加一个defaultFilter：",-1)),i[504]||(i[504]=l("div",{class:"language-yaml max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"yaml"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    gateway"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      default-filters"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        - "),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"AddRequestHeader=origin,gateway")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      routes"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"       # ...略")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[505]||(i[505]=l("p",null,"这样，从gateway路由的所有请求都会带上origin头，值为gateway。而从其它地方到达微服务的请求则没有这个头。",-1)),i[506]||(i[506]=l("h4",{id:"_4-1-4-配置授权规则",tabindex:"-1"},[s("4.1.4 配置授权规则 "),l("a",{class:"header-anchor",href:"#_4-1-4-配置授权规则","aria-label":'Permalink to "4.1.4 配置授权规则"'},"​")],-1)),i[507]||(i[507]=l("p",null,"接下来，我们添加一个授权规则，放行origin值为gateway的请求。",-1)),i[508]||(i[508]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025119977.png",alt:"image-20251208025119977",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[509]||(i[509]=l("p",null,"配置如下：",-1)),i[510]||(i[510]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025323560.png",alt:"image-20251208025323560",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[511]||(i[511]=l("p",null,"现在，我们直接跳过网关，访问order-service服务：",-1)),i[512]||(i[512]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025347127.png",alt:"image-20251208025347127",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[513]||(i[513]=l("p",null,"通过网关访问：",-1)),i[514]||(i[514]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025356719.png",alt:"image-20251208025356719",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[515]||(i[515]=l("h3",{id:"_4-2-自定义异常结果",tabindex:"-1"},[s("4.2 自定义异常结果 "),l("a",{class:"header-anchor",href:"#_4-2-自定义异常结果","aria-label":'Permalink to "4.2 自定义异常结果"'},"​")],-1)),i[516]||(i[516]=l("p",null,"默认情况下，发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是flow limmiting（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。",-1)),i[517]||(i[517]=l("h4",{id:"_4-2-1-异常类型",tabindex:"-1"},[s("4.2.1 异常类型 "),l("a",{class:"header-anchor",href:"#_4-2-1-异常类型","aria-label":'Permalink to "4.2.1 异常类型"'},"​")],-1)),i[518]||(i[518]=l("p",null,"而如果要自定义异常时的返回结果，需要实现BlockExceptionHandler接口：",-1)),i[519]||(i[519]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," interface"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BlockExceptionHandler"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    /**")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    void"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handle"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),l("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),l("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", BlockException "),l("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[520]||(i[520]=l("p",null,"这个方法有三个参数：",-1)),i[521]||(i[521]=l("ul",null,[l("li",null,"HttpServletRequest request：request对象"),l("li",null,"HttpServletResponse response：response对象"),l("li",null,"BlockException e：被sentinel拦截时抛出的异常")],-1)),i[522]||(i[522]=l("p",null,"这里的BlockException包含多个不同的子类：",-1)),i[523]||(i[523]=l("table",null,[l("thead",null,[l("tr",null,[l("th",null,[l("strong",null,"异常")]),l("th",null,[l("strong",null,"说明")])])]),l("tbody",null,[l("tr",null,[l("td",null,"FlowException"),l("td",null,"限流异常")]),l("tr",null,[l("td",null,"ParamFlowException"),l("td",null,"热点参数限流的异常")]),l("tr",null,[l("td",null,"DegradeException"),l("td",null,"降级异常")]),l("tr",null,[l("td",null,"AuthorityException"),l("td",null,"授权规则异常")]),l("tr",null,[l("td",null,"SystemBlockException"),l("td",null,"系统规则异常")])])],-1)),i[524]||(i[524]=l("h4",{id:"_4-2-2-自定义异常处理",tabindex:"-1"},[s("4.2.2 自定义异常处理 "),l("a",{class:"header-anchor",href:"#_4-2-2-自定义异常处理","aria-label":'Permalink to "4.2.2 自定义异常处理"'},"​")],-1)),i[525]||(i[525]=l("p",null,"下面，我们就在order-service定义一个自定义异常处理类：",-1)),i[526]||(i[526]=l("div",{class:"language-java max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"java"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"package"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cn.itcast.order.sentinel;")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.slots.block.BlockException;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.slots.block.authority.AuthorityException;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.slots.block.degrade.DegradeException;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.slots.block.flow.FlowException;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," org.springframework.stereotype.Component;")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," javax.servlet.http.HttpServletRequest;")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," javax.servlet.http.HttpServletResponse;")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Component")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," class"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," SentinelExceptionHandler"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," implements"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BlockExceptionHandler"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    @"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    public"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handle"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest "),l("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"request"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", HttpServletResponse "),l("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"response"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", BlockException "),l("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"throws"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Exception {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String msg "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "未知异常"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," status "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 429"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"instanceof"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," FlowException) {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            msg "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "请求被限流了"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"instanceof"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ParamFlowException) {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            msg "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "请求被热点参数限流"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"instanceof"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DegradeException) {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            msg "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "请求被降级了"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (e "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"instanceof"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AuthorityException) {")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            msg "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "没有权限访问"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            status "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 401"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),s(`
`),l("span",{class:"line"}),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        response."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setContentType"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"application/json;charset=utf-8"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        response."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStatus"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(status);")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        response."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWriter"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"println"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"{'),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"msg"),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},': "'),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," msg "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ", '),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"status"),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},': "'),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," status "),l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "}"'),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[527]||(i[527]=l("p",null,"重启测试，在不同场景下，会返回不同的异常消息.",-1)),i[528]||(i[528]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025422264.png",alt:"image-20251208025422264",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[529]||(i[529]=l("hr",null,null,-1)),i[530]||(i[530]=l("h2",{id:"_5-规则持久化",tabindex:"-1"},[s("5. 规则持久化 "),l("a",{class:"header-anchor",href:"#_5-规则持久化","aria-label":'Permalink to "5. 规则持久化"'},"​")],-1)),i[531]||(i[531]=l("p",null,"现在，sentinel的所有规则都是内存存储，重启后所有规则都会丢失。在生产环境下，我们必须确保这些规则的持久化，避免丢失。",-1)),i[532]||(i[532]=l("h3",{id:"_5-1-规则管理模式",tabindex:"-1"},[s("5.1 规则管理模式 "),l("a",{class:"header-anchor",href:"#_5-1-规则管理模式","aria-label":'Permalink to "5.1 规则管理模式"'},"​")],-1)),i[533]||(i[533]=l("p",null,"规则是否能持久化，取决于规则管理模式，sentinel支持三种规则管理模式：",-1)),i[534]||(i[534]=l("ul",null,[l("li",null,"原始模式：Sentinel的默认模式，将规则保存在内存，重启服务会丢失。"),l("li",null,"pull模式"),l("li",null,"push模式")],-1)),i[535]||(i[535]=l("h4",{id:"_5-1-1-pull模式",tabindex:"-1"},[s("5.1.1 pull模式 "),l("a",{class:"header-anchor",href:"#_5-1-1-pull模式","aria-label":'Permalink to "5.1.1 pull模式"'},"​")],-1)),i[536]||(i[536]=l("p",null,"pull模式：控制台将配置的规则推送到Sentinel客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。",-1)),i[537]||(i[537]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025448053.png",alt:"image-20251208025448053",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[538]||(i[538]=l("h4",{id:"_5-1-2-push模式",tabindex:"-1"},[s("5.1.2 push模式 "),l("a",{class:"header-anchor",href:"#_5-1-2-push模式","aria-label":'Permalink to "5.1.2 push模式"'},"​")],-1)),i[539]||(i[539]=l("p",null,"push模式：控制台将配置规则推送到远程配置中心，例如Nacos。Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置更新。",-1)),i[540]||(i[540]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251208025458264.png",alt:"image-20251208025458264",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[541]||(i[541]=l("h3",{id:"_5-2-实现push模式",tabindex:"-1"},[s("5.2 实现push模式 "),l("a",{class:"header-anchor",href:"#_5-2-实现push模式","aria-label":'Permalink to "5.2 实现push模式"'},"​")],-1)),i[542]||(i[542]=l("h4",{id:"一、修改order-service服务",tabindex:"-1"},[s("一、修改order-service服务 "),l("a",{class:"header-anchor",href:"#一、修改order-service服务","aria-label":'Permalink to "一、修改order-service服务"'},"​")],-1)),i[543]||(i[543]=l("p",null,"修改OrderService，让其监听Nacos中的sentinel规则配置。",-1)),i[544]||(i[544]=l("p",null,"具体步骤如下：",-1)),i[545]||(i[545]=l("h5",{id:"_1-引入依赖",tabindex:"-1"},[s("1. 引入依赖 "),l("a",{class:"header-anchor",href:"#_1-引入依赖","aria-label":'Permalink to "1. 引入依赖"'},"​")],-1)),i[546]||(i[546]=l("p",null,"在order-service中引入sentinel监听nacos的依赖：",-1)),i[547]||(i[547]=l("div",{class:"language-xml max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"xml"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.alibaba.csp</"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">sentinel-datasource-nacos</"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[548]||(i[548]=l("h5",{id:"_2-配置nacos地址",tabindex:"-1"},[s("2. 配置nacos地址 "),l("a",{class:"header-anchor",href:"#_2-配置nacos地址","aria-label":'Permalink to "2. 配置nacos地址"'},"​")],-1)),i[549]||(i[549]=l("p",null,"在order-service中的application.yml文件配置nacos地址及监听的配置信息：",-1)),i[550]||(i[550]=l("div",{class:"language-yaml max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"yaml"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    sentinel"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      datasource"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        flow"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          nacos"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"            server-addr"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"localhost:8848"),l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # nacos地址")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"            dataId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"orderservice-flow-rules")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"            groupId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"SENTINEL_GROUP")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"            rule-type"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"flow"),l("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 还可以是：degrade、authority、param-flow")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[551]||(i[551]=l("h4",{id:"二、修改sentinel-dashboard源码",tabindex:"-1"},[s("二、修改sentinel-dashboard源码 "),l("a",{class:"header-anchor",href:"#二、修改sentinel-dashboard源码","aria-label":'Permalink to "二、修改sentinel-dashboard源码"'},"​")],-1)),i[552]||(i[552]=l("p",null,"SentinelDashboard默认不支持nacos的持久化，需要修改源码。",-1)),i[553]||(i[553]=l("h5",{id:"_1-解压",tabindex:"-1"},[s("1. 解压 "),l("a",{class:"header-anchor",href:"#_1-解压","aria-label":'Permalink to "1. 解压"'},"​")],-1)),i[554]||(i[554]=l("p",null,"解压课前资料中的sentinel源码包：",-1)),i[555]||(i[555]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618201340086.png",alt:"image-20210618201340086",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[556]||(i[556]=l("p",null,"然后并用IDEA打开这个项目，结构如下：",-1)),i[557]||(i[557]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618201412878.png",alt:"image-20210618201412878",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[558]||(i[558]=l("h5",{id:"_2-修改nacos依赖",tabindex:"-1"},[s("2. 修改nacos依赖 "),l("a",{class:"header-anchor",href:"#_2-修改nacos依赖","aria-label":'Permalink to "2. 修改nacos依赖"'},"​")],-1)),i[559]||(i[559]=l("p",null,"在sentinel-dashboard源码的pom文件中，nacos的依赖默认的scope是test，只能在测试时使用，这里要去除：",-1)),i[560]||(i[560]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618201607831.png",alt:"image-20210618201607831",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[561]||(i[561]=l("p",null,"将sentinel-datasource-nacos依赖的scope去掉：",-1)),i[562]||(i[562]=l("div",{class:"language-xml max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"xml"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"<"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">com.alibaba.csp</"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groupId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    <"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">sentinel-datasource-nacos</"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"artifactId"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")]),s(`
`),l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"</"),l("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"dependency"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[563]||(i[563]=l("h5",{id:"_3-添加nacos支持",tabindex:"-1"},[s("3. 添加nacos支持 "),l("a",{class:"header-anchor",href:"#_3-添加nacos支持","aria-label":'Permalink to "3. 添加nacos支持"'},"​")],-1)),i[564]||(i[564]=l("p",null,"在sentinel-dashboard的test包下，已经编写了对nacos的支持，我们需要将其拷贝到main下。",-1)),i[565]||(i[565]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618201726280.png",alt:"image-20210618201726280",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[566]||(i[566]=l("h5",{id:"_4-修改nacos地址",tabindex:"-1"},[s("4. 修改nacos地址 "),l("a",{class:"header-anchor",href:"#_4-修改nacos地址","aria-label":'Permalink to "4. 修改nacos地址"'},"​")],-1)),i[567]||(i[567]=l("p",null,"然后，还需要修改测试代码中的NacosConfig类：",-1)),i[568]||(i[568]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618201912078.png",alt:"image-20210618201912078",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[569]||(i[569]=l("p",null,"修改其中的nacos地址，让其读取application.properties中的配置：",-1)),i[570]||(i[570]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202047575.png",alt:"image-20210618202047575",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[571]||(i[571]=l("p",null,"在sentinel-dashboard的application.properties中添加nacos地址配置：",-1)),i[572]||(i[572]=l("div",{class:"language-properties max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"properties"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"nacos.addr"),l("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"=localhost:8848")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[573]||(i[573]=l("h5",{id:"_5-配置nacos数据源",tabindex:"-1"},[s("5. 配置nacos数据源 "),l("a",{class:"header-anchor",href:"#_5-配置nacos数据源","aria-label":'Permalink to "5. 配置nacos数据源"'},"​")],-1)),i[574]||(i[574]=l("p",null,"另外，还需要修改com.alibaba.csp.sentinel.dashboard.controller.v2包下的FlowControllerV2类：",-1)),i[575]||(i[575]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202322301.png",alt:"image-20210618202322301",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[576]||(i[576]=l("p",null,"让我们添加的Nacos数据源生效：",-1)),i[577]||(i[577]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202334536.png",alt:"image-20210618202334536",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[578]||(i[578]=l("h5",{id:"_6-修改前端页面",tabindex:"-1"},[s("6. 修改前端页面 "),l("a",{class:"header-anchor",href:"#_6-修改前端页面","aria-label":'Permalink to "6. 修改前端页面"'},"​")],-1)),i[579]||(i[579]=l("p",null,"接下来，还要修改前端页面，添加一个支持nacos的菜单。",-1)),i[580]||(i[580]=l("p",null,"修改src/main/webapp/resources/app/scripts/directives/sidebar/目录下的sidebar.html文件：",-1)),i[581]||(i[581]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202433356.png",alt:"image-20210618202433356",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[582]||(i[582]=l("p",null,"将其中的这部分注释打开：",-1)),i[583]||(i[583]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202449881.png",alt:"image-20210618202449881",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[584]||(i[584]=l("p",null,"修改其中的文本：",-1)),i[585]||(i[585]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202501928.png",alt:"image-20210618202501928",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[586]||(i[586]=l("h5",{id:"_7-重新编译、打包项目",tabindex:"-1"},[s("7. 重新编译、打包项目 "),l("a",{class:"header-anchor",href:"#_7-重新编译、打包项目","aria-label":'Permalink to "7. 重新编译、打包项目"'},"​")],-1)),i[587]||(i[587]=l("p",null,"运行IDEA中的maven插件，编译和打包修改好的Sentinel-Dashboard：",-1)),i[588]||(i[588]=l("figure",null,[l("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210618202701492.png",alt:"image-20210618202701492",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[589]||(i[589]=l("h5",{id:"_8-启动",tabindex:"-1"},[s("8. 启动 "),l("a",{class:"header-anchor",href:"#_8-启动","aria-label":'Permalink to "8. 启动"'},"​")],-1)),i[590]||(i[590]=l("p",null,"启动方式跟官方一样：",-1)),i[591]||(i[591]=l("div",{class:"language-sh max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"sh"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"java"),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -jar"),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," sentinel-dashboard.jar")])])]),l("button",{class:"code-block-unfold-btn"})],-1)),i[592]||(i[592]=l("p",null,"如果要修改nacos地址，需要添加参数：",-1)),i[593]||(i[593]=l("div",{class:"language-sh max-h-300px"},[l("button",{title:"Copy code",class:"copy"}),l("span",{class:"lang"},"sh"),l("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[l("code",{"v-pre":""},[l("span",{class:"line"},[l("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"java"),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -jar"),l("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Dnacos.addr=localhost:8848"),l("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," sentinel-dashboard.jar")])])]),l("button",{class:"code-block-unfold-btn"})],-1))]),"main-header":a(()=>[t(n.$slots,"main-header")]),"main-header-after":a(()=>[t(n.$slots,"main-header-after")]),"main-nav":a(()=>[t(n.$slots,"main-nav")]),"main-content-before":a(()=>[t(n.$slots,"main-content-before")]),"main-content":a(()=>[t(n.$slots,"main-content")]),"main-content-after":a(()=>[t(n.$slots,"main-content-after")]),"main-nav-before":a(()=>[t(n.$slots,"main-nav-before")]),"main-nav-after":a(()=>[t(n.$slots,"main-nav-after")]),comment:a(()=>[t(n.$slots,"comment")]),footer:a(()=>[t(n.$slots,"footer")]),aside:a(()=>[t(n.$slots,"aside")]),"aside-custom":a(()=>[t(n.$slots,"aside-custom")]),default:a(()=>[t(n.$slots,"default")]),_:3},8,["frontmatter"])}}};export{H as default,A as usePageData};
