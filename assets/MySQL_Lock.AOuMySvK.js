import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang.iBzVOYWa.js";import"./chunks/@vueuse/motion.D4J2SB46.js";import{d as s,a as l,u as a}from"./chunks/vue-router.DwHde2Fu.js";import{a1 as h,a3 as t,a4 as n,a5 as k,a7 as e,a6 as p,F as d,a2 as r,Z as g}from"./framework.GzYmdVjK.js";import"./app.C9UN2hmH.js";import"./chunks/dayjs.Dto65haK.js";import"./chunks/vue-i18n.BvWwj3SI.js";import"./chunks/pinia.BcfqlbOB.js";import"./chunks/nprogress.W5IEJXTh.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.DOZWVDPv.js";import"./index.TQnGKZgq.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.KHJRstPN.js";import"./post.Bz9it_DP.js";const E=s("/posts/MySQL_Lock",async i=>JSON.parse('{"title":"MySQL - 锁","description":"","frontmatter":{"title":"MySQL - 锁","author":"imklaus","tags":["SQL"],"categories":["MySQL","锁篇"],"date":"2025-3-19 00:54:45","outline":"deep","excerpt_type":"html","end":true},"headers":[],"relativePath":"pages/posts/MySQL_Lock.md","lastUpdated":null}'),{lazy:(i,s)=>i.name===s.name}),o={__name:"MySQL_Lock",setup(s,{expose:o}){const{data:u}=E(),c=a(),y=l(),F=Object.assign(y.meta.frontmatter||{},u.value?.frontmatter||{});c.currentRoute.value.data=u.value,g("valaxy:frontmatter",F),globalThis.$frontmatter=F;return o({frontmatter:{title:"MySQL - 锁",author:"imklaus",tags:["SQL"],categories:["MySQL","锁篇"],date:"2025-3-19 00:54:45",outline:"deep",excerpt_type:"html",end:!0}}),(s,l)=>{const a=i;return r(),h(a,{frontmatter:d(F)},{"main-content-md":t(()=>[l[0]||(l[0]=k("h3",{id:"基本介绍",tabindex:"-1"},[p("基本介绍 "),k("a",{class:"header-anchor",href:"#基本介绍","aria-label":'Permalink to "基本介绍"'},"​")],-1)),l[1]||(l[1]=k("p",null,"锁机制：数据库为了保证数据的一致性，在共享的资源被并发访问时变得安全有序所设计的一种规则",-1)),l[2]||(l[2]=k("p",null,[p("利用 MVCC 性质进行读取的操作叫"),k("strong",null,"一致性读"),p("，读取数据前加锁的操作叫"),k("strong",null,"锁定读")],-1)),l[3]||(l[3]=k("p",null,"锁的分类：",-1)),l[4]||(l[4]=k("ul",null,[k("li",null,[p("按操作分类： "),k("ul",null,[k("li",null,"共享锁：也叫读锁。对同一份数据，多个事务读操作可以同时加锁而不互相影响 ，但不能修改数据"),k("li",null,"排他锁：也叫写锁。当前的操作没有完成前，会阻断其他操作的读取和写入")])]),k("li",null,[p("按粒度分类： "),k("ul",null,[k("li",null,"表级锁：会锁定整个表，开销小，加锁快；不会出现死锁；锁定力度大，发生锁冲突概率高，并发度最低，偏向 MyISAM"),k("li",null,"行级锁：会锁定当前操作行，开销大，加锁慢；会出现死锁；锁定力度小，发生锁冲突概率低，并发度高，偏向 InnoDB"),k("li",null,"页级锁：锁的力度、发生冲突的概率和加锁开销介于表锁和行锁之间，会出现死锁，并发性能一般")])]),k("li",null,[p("按使用方式分类： "),k("ul",null,[k("li",null,"悲观锁：每次查询数据时都认为别人会修改，很悲观，所以查询时加锁"),k("li",null,"乐观锁：每次查询数据时都认为别人不会修改，很乐观，但是更新时会判断一下在此期间别人有没有去更新这个数据")])])],-1)),l[5]||(l[5]=k("ul",null,[k("li",null,[k("p",null,"不同存储引擎支持的锁"),k("table",null,[k("thead",null,[k("tr",null,[k("th",null,"存储引擎"),k("th",null,"表级锁"),k("th",null,"行级锁"),k("th",null,"页级锁")])]),k("tbody",null,[k("tr",null,[k("td",null,"MyISAM"),k("td",null,"支持"),k("td",null,"不支持"),k("td",null,"不支持")]),k("tr",null,[k("td",null,"InnoDB"),k("td",null,[k("strong",null,"支持")]),k("td",null,[k("strong",null,"支持")]),k("td",null,"不支持")]),k("tr",null,[k("td",null,"MEMORY"),k("td",null,"支持"),k("td",null,"不支持"),k("td",null,"不支持")]),k("tr",null,[k("td",null,"BDB"),k("td",null,"支持"),k("td",null,"不支持"),k("td",null,"支持")])])])])],-1)),l[6]||(l[6]=k("p",null,"从锁的角度来说：表级锁更适合于以查询为主，只有少量按索引条件更新数据的应用，如 Web 应用；而行级锁则更适合于有大量按索引条件并发更新少量不同数据，同时又有并查询的应用，如一些在线事务处理系统",-1)),e(" more "),l[7]||(l[7]=k("hr",null,null,-1)),l[8]||(l[8]=k("h3",{id:"内存结构",tabindex:"-1"},[p("内存结构 "),k("a",{class:"header-anchor",href:"#内存结构","aria-label":'Permalink to "内存结构"'},"​")],-1)),l[9]||(l[9]=k("p",null,[p("对一条记录加锁的本质就是"),k("strong",null,"在内存中"),p("创建一个锁结构与之关联，结构包括")],-1)),l[10]||(l[10]=k("ul",null,[k("li",null,"事务信息：锁对应的事务信息，一个锁属于一个事务"),k("li",null,"索引信息：对于行级锁，需要记录加锁的记录属于哪个索引"),k("li",null,"表锁和行锁信息：表锁记录着锁定的表，行锁记录了 Space ID 所在表空间、Page Number 所在的页号、n_bits 使用了多少比特"),k("li",null,[p("type_mode：一个 32 比特的数，被分成 lock_mode、lock_type、rec_lock_type 三个部分 "),k("ul",null,[k("li",null,"lock_mode：锁模式，记录是共享锁、排他锁、意向锁之类"),k("li",null,"lock_type：代表表级锁还是行级锁"),k("li",null,"rec_lock_type：代表行锁的具体类型和 is_waiting 属性，is_waiting = true 时表示当前事务尚未获取到锁，处于等待状态。事务获取锁后的锁结构是 is_waiting 为 false，释放锁时会检查是否与当前记录关联的锁结构，如果有就唤醒对应事务的线程")])])],-1)),l[11]||(l[11]=k("p",null,"一个事务可能操作多条记录，为了节省内存，满足下面条件的锁使用同一个锁结构：",-1)),l[12]||(l[12]=k("ul",null,[k("li",null,"在同一个事务中的加锁操作"),k("li",null,"被加锁的记录在同一个页面中"),k("li",null,"加锁的类型是一样的"),k("li",null,"加锁的状态是一样的")],-1)),l[13]||(l[13]=k("hr",null,null,-1)),l[14]||(l[14]=k("h3",{id:"server",tabindex:"-1"},[p("Server "),k("a",{class:"header-anchor",href:"#server","aria-label":'Permalink to "Server"'},"​")],-1)),l[15]||(l[15]=k("p",null,"MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL)",-1)),l[16]||(l[16]=k("p",null,[p("MDL 叫元数据锁，主要用来保护 MySQL 内部对象的元数据，保证数据读写的正确性，"),k("strong",null,"当对一个表做增删改查的时候，加 MDL 读锁；当要对表做结构变更操作 DDL 的时候，加 MDL 写锁"),p("，两种锁不相互兼容，所以可以保证 DDL、DML、DQL 操作的安全")],-1)),l[17]||(l[17]=k("p",null,"说明：DDL 操作执行前会隐式提交当前会话的事务，因为 DDL 一般会在若干个特殊事务中完成，开启特殊事务前需要提交到其他事务",-1)),l[18]||(l[18]=k("p",null,"MDL 锁的特性：",-1)),l[19]||(l[19]=k("ul",null,[k("li",null,[k("p",null,"MDL 锁不需要显式使用，在访问一个表的时候会被自动加上，在事务开始时申请，整个事务提交后释放（执行完单条语句不释放）")]),k("li",null,[k("p",null,"MDL 锁是在 Server 中实现，不是 InnoDB 存储引擎层能直接实现的锁")]),k("li",null,[k("p",null,"MDL 锁还能实现其他粒度级别的锁，比如全局锁、库级别的锁、表空间级别的锁")])],-1)),l[20]||(l[20]=k("p",null,"FLUSH TABLES WITH READ LOCK 简称（FTWRL），全局读锁，让整个库处于只读状态，DDL DML 都被阻塞，工作流程：",-1)),l[21]||(l[21]=k("ol",null,[k("li",null,"上全局读锁（lock_global_read_lock）"),k("li",null,"清理表缓存（close_cached_tables）"),k("li",null,"上全局 COMMIT 锁（make_global_read_lock_block_commit）")],-1)),l[22]||(l[22]=k("p",null,[p("该命令主要用于备份工具做"),k("strong",null,"一致性备份"),p("，由于 FTWRL 需要持有两把全局的 MDL 锁，并且还要关闭所有表对象，因此杀伤性很大")],-1)),l[23]||(l[23]=k("hr",null,null,-1)),l[24]||(l[24]=k("h3",{id:"myisam",tabindex:"-1"},[p("MyISAM "),k("a",{class:"header-anchor",href:"#myisam","aria-label":'Permalink to "MyISAM"'},"​")],-1)),l[25]||(l[25]=k("h4",{id:"表级锁",tabindex:"-1"},[p("表级锁 "),k("a",{class:"header-anchor",href:"#表级锁","aria-label":'Permalink to "表级锁"'},"​")],-1)),l[26]||(l[26]=k("p",null,"MyISAM 存储引擎只支持表锁，这也是 MySQL 开始几个版本中唯一支持的锁类型",-1)),l[27]||(l[27]=k("p",null,[p("MyISAM 引擎在执行查询语句之前，会"),k("strong",null,"自动"),p("给涉及到的所有表加读锁，在执行增删改之前，会"),k("strong",null,"自动"),p("给涉及的表加写锁，这个过程并不需要用户干预，所以用户一般不需要直接用 LOCK TABLE 命令给 MyISAM 表显式加锁")],-1)),l[28]||(l[28]=k("ul",null,[k("li",null,[k("p",null,"加锁命令：（对 InnoDB 存储引擎也适用）"),k("p",null,"读锁：所有连接只能读取数据，不能修改"),k("p",null,"写锁：其他连接不能查询和修改数据"),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 读锁")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"LOCK "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TABLE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table_name "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"READ"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),k("span",{class:"line"}),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 写锁")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"LOCK "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TABLE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table_name WRITE;")])])]),k("button",{class:"code-block-unfold-btn"})])]),k("li",null,[k("p",null,"解锁命令："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 将当前会话所有的表进行解锁")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UNLOCK"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TABLES;")])])]),k("button",{class:"code-block-unfold-btn"})])])],-1)),l[29]||(l[29]=k("p",null,"锁的兼容性：",-1)),l[30]||(l[30]=k("ul",null,[k("li",null,"对 MyISAM 表的读操作，不会阻塞其他用户对同一表的读请求，但会阻塞对同一表的写请求"),k("li",null,"对 MyISAM 表的写操作，则会阻塞其他用户对同一表的读和写操作")],-1)),l[31]||(l[31]=k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320011957733.png",alt:"image-20250320011957733",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[32]||(l[32]=k("p",null,[p("锁调度："),k("strong",null,"MyISAM 的读写锁调度是写优先"),p("，因为写锁后其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永远阻塞，所以 MyISAM 不适合做写为主的表的存储引擎")],-1)),l[33]||(l[33]=k("hr",null,null,-1)),l[34]||(l[34]=k("h4",{id:"锁操作",tabindex:"-1"},[p("锁操作 "),k("a",{class:"header-anchor",href:"#锁操作","aria-label":'Permalink to "锁操作"'},"​")],-1)),l[35]||(l[35]=k("h5",{id:"读锁",tabindex:"-1"},[p("读锁 "),k("a",{class:"header-anchor",href:"#读锁","aria-label":'Permalink to "读锁"'},"​")],-1)),l[36]||(l[36]=k("p",null,"两个客户端操作 Client 1和 Client 2，简化为 C1、C2",-1)),l[37]||(l[37]=k("ul",null,[k("li",null,[k("p",null,"数据准备："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CREATE"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," TABLE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," `"),k("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tb_book"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"` (")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"  `id`"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," INT"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"11"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") AUTO_INCREMENT,")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"  `name`"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," VARCHAR"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"50"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DEFAULT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," NULL"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"  `publish_time`"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," DATE"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," DEFAULT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," NULL"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"  `status`"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," CHAR"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DEFAULT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," NULL"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"  PRIMARY KEY"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"`id`"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") ENGINE"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"MYISAM "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DEFAULT"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CHARSET"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"utf8 ;")]),p("\n"),k("span",{class:"line"}),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"INSERT INTO"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book (id, "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"NAME"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", publish_time, "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"STATUS"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VALUES"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"NULL"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'java编程思想'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'2088-08-01'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'1'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"INSERT INTO"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book (id, "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"NAME"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", publish_time, "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"STATUS"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VALUES"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"NULL"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'mysql编程思想'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'2088-08-08'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'0'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")])])]),k("button",{class:"code-block-unfold-btn"})])]),k("li",null,[k("p",null,"C1、C2 加读锁，同时查询可以正常查询出数据"),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"LOCK "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TABLE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"READ"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1、C2")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book;\t\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1、C2")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012120176.png",alt:"image-20250320012120176",loading:"lazy",decoding:"async",class:"lazy"})])]),k("li",null,[k("p",null,"C1 加读锁，C1、C2 查询未锁定的表，C1 报错，C2 正常查询"),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"LOCK "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TABLE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"READ"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_user;\t\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1、C2")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012150524.png",alt:"image-20250320012150524",loading:"lazy",decoding:"async",class:"lazy"})]),k("p",null,"C1、C2 执行插入操作，C1 报错，C2 等待获取"),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"INSERT INTO"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VALUES"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"NULL"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'Spring高级'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'2088-01-01'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'1'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1、C2")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012210171.png",alt:"image-20250320012210171",loading:"lazy",decoding:"async",class:"lazy"})]),k("p",null,"当在 C1 中释放锁指令 UNLOCK TABLES，C2 中的 INSERT 语句立即执行")])],-1)),l[38]||(l[38]=k("hr",null,null,-1)),l[39]||(l[39]=k("h5",{id:"写锁",tabindex:"-1"},[p("写锁 "),k("a",{class:"header-anchor",href:"#写锁","aria-label":'Permalink to "写锁"'},"​")],-1)),l[40]||(l[40]=k("p",null,"两个客户端操作 Client 1和 Client 2，简化为 C1、C2",-1)),l[41]||(l[41]=k("ul",null,[k("li",null,[k("p",null,"C1 加写锁，C1、C2查询表，C1 正常查询，C2 需要等待"),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"LOCK "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TABLE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book WRITE;\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book;\t\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1、C2")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012225386.png",alt:"image-20250320012225386",loading:"lazy",decoding:"async",class:"lazy"})]),k("p",null,"当在 C1 中释放锁指令 UNLOCK TABLES，C2 中的 SELECT 语句立即执行")]),k("li",null,[k("p",null,"C1、C2 同时加写锁"),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"LOCK "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TABLE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book WRITE;")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012244418.png",alt:"image-20250320012244418",loading:"lazy",decoding:"async",class:"lazy"})])]),k("li",null,[k("p",null,"C1 加写锁，C1、C2查询未锁定的表，C1 报错，C2 正常查询")])],-1)),l[42]||(l[42]=k("hr",null,null,-1)),l[43]||(l[43]=k("h4",{id:"锁状态",tabindex:"-1"},[p("锁状态 "),k("a",{class:"header-anchor",href:"#锁状态","aria-label":'Permalink to "锁状态"'},"​")],-1)),l[44]||(l[44]=k("ul",null,[k("li",null,[k("p",null,"查看锁竞争："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SHOW "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"OPEN"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TABLES;")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012302380.png",alt:"image-20250320012302380",loading:"lazy",decoding:"async",class:"lazy"})]),k("p",null,"In_user：表当前被查询使用的次数，如果该数为零，则表是打开的，但是当前没有被使用"),k("p",null,"Name_locked：表名称是否被锁定，名称锁定用于取消表或对表进行重命名等操作"),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"LOCK "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"TABLE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"READ"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 执行命令")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012311528.png",alt:"image-20250320012311528",loading:"lazy",decoding:"async",class:"lazy"})])]),k("li",null,[k("p",null,"查看锁状态："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SHOW "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"STATUS"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," LIKE"),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'Table_locks%'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012325225.png",alt:"image-20250320012325225",loading:"lazy",decoding:"async",class:"lazy"})]),k("p",null,"Table_locks_immediate：指的是能立即获得表级锁的次数，每立即获取锁，值加 1"),k("p",null,"Table_locks_waited：指的是不能立即获取表级锁而需要等待的次数，每等待一次，该值加 1，此值高说明存在着较为严重的表级锁争用情况")])],-1)),l[45]||(l[45]=k("hr",null,null,-1)),l[46]||(l[46]=k("h3",{id:"innodb",tabindex:"-1"},[p("InnoDB "),k("a",{class:"header-anchor",href:"#innodb","aria-label":'Permalink to "InnoDB"'},"​")],-1)),l[47]||(l[47]=k("h4",{id:"行级锁",tabindex:"-1"},[p("行级锁 "),k("a",{class:"header-anchor",href:"#行级锁","aria-label":'Permalink to "行级锁"'},"​")],-1)),l[48]||(l[48]=k("h5",{id:"记录锁",tabindex:"-1"},[p("记录锁 "),k("a",{class:"header-anchor",href:"#记录锁","aria-label":'Permalink to "记录锁"'},"​")],-1)),l[49]||(l[49]=k("p",null,[p("InnoDB 与 MyISAM 的最大不同有两点：一是支持事务；二是采用了行级锁，"),k("strong",null,"InnoDB 同时支持表锁和行锁")],-1)),l[50]||(l[50]=k("p",null,"行级锁，也称为记录锁（Record Lock），InnoDB 实现了以下两种类型的行锁：",-1)),l[51]||(l[51]=k("ul",null,[k("li",null,"共享锁 (S)：又称为读锁，简称 S 锁，多个事务对于同一数据可以共享一把锁，都能访问到数据，但是只能读不能修改"),k("li",null,"排他锁 (X)：又称为写锁，简称 X 锁，不能与其他锁并存，获取排他锁的事务是可以对数据读取和修改")],-1)),l[52]||(l[52]=k("p",null,[p("RR 隔离界别下，对于 UPDATE、DELETE 和 INSERT 语句，InnoDB 会"),k("strong",null,"自动给涉及数据集加排他锁"),p("（行锁），在 commit 时自动释放；对于普通 SELECT 语句，不会加任何锁（只是针对 InnoDB 层来说的，因为在 Server 层会"),k("strong",null,"加 MDL 读锁"),p("），通过 MVCC 防止并发冲突")],-1)),l[53]||(l[53]=k("p",null,[p("在事务中加的锁，并不是不需要了就释放，而是在事务中止或提交时自动释放，这个就是"),k("strong",null,"两阶段锁协议"),p("。所以一般将更新共享资源（并发高）的 SQL 放到事务的最后执行，可以让其他线程尽量的减少等待时间")],-1)),l[54]||(l[54]=k("p",null,"锁的兼容性：",-1)),l[55]||(l[55]=k("ul",null,[k("li",null,"共享锁和共享锁 兼容"),k("li",null,"共享锁和排他锁 冲突"),k("li",null,"排他锁和排他锁 冲突"),k("li",null,"排他锁和共享锁 冲突")],-1)),l[56]||(l[56]=k("p",null,[p("显式给数据集加共享锁或排他锁："),k("strong",null,"加锁读就是当前读，读取的是最新数据")],-1)),l[57]||(l[57]=k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table_name "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WHERE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ... LOCK "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"IN"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SHARE MODE\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 共享锁")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," table_name "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WHERE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ... "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"FOR"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," UPDATE"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t-- 排他锁")])])]),k("button",{class:"code-block-unfold-btn"})],-1)),l[58]||(l[58]=k("p",null,[p("注意："),k("strong",null,"锁默认会锁聚簇索引（锁就是加在索引上）"),p("，但是当使用覆盖索引时，加共享锁只锁二级索引，不锁聚簇索引")],-1)),l[59]||(l[59]=k("hr",null,null,-1)),l[60]||(l[60]=k("h5",{id:"锁操作-1",tabindex:"-1"},[p("锁操作 "),k("a",{class:"header-anchor",href:"#锁操作-1","aria-label":'Permalink to "锁操作"'},"​")],-1)),l[61]||(l[61]=k("p",null,"两个客户端操作 Client 1和 Client 2，简化为 C1、C2",-1)),l[62]||(l[62]=k("ul",null,[k("li",null,[k("p",null,"环境准备"),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CREATE"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," TABLE"),k("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," test_innodb_lock"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\tid "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"INT"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"11"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tname"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," VARCHAR"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"16"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\tsex "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VARCHAR"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")ENGINE "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," INNODB "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DEFAULT"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CHARSET"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"utf8;")]),p("\n"),k("span",{class:"line"}),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"INSERT INTO"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VALUES"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'100'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'1'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- ..........")]),p("\n"),k("span",{class:"line"}),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CREATE"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," INDEX"),k("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," idx_test_innodb_lock_id"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ON"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock(id);")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CREATE"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," INDEX"),k("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," idx_test_innodb_lock_name"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ON"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock("),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"name"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")])])]),k("button",{class:"code-block-unfold-btn"})])]),k("li",null,[k("p",null,"关闭自动提交功能："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AUTOCOMMIT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1、C2")])])]),k("button",{class:"code-block-unfold-btn"})]),k("p",null,"正常查询数据："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock;\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1、C2")])])]),k("button",{class:"code-block-unfold-btn"})])]),k("li",null,[k("p",null,"查询 id 为 3 的数据，正常查询："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WHERE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1、C2")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012357505.png",alt:"image-20250320012357505",loading:"lazy",decoding:"async",class:"lazy"})])]),k("li",null,[k("p",null,"C1 更新 id 为 3 的数据，但不提交："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UPDATE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," name="),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'300'"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," WHERE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012418342.png",alt:"image-20250320012418342",loading:"lazy",decoding:"async",class:"lazy"})]),k("p",null,"C2 查询不到 C1 修改的数据，因为隔离界别为 REPEATABLE READ，C1 提交事务，C2 查询："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"COMMIT"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012433081.png",alt:"image-20250320012433081",loading:"lazy",decoding:"async",class:"lazy"})]),k("p",null,"提交后仍然查询不到 C1 修改的数据，因为隔离级别可以防止脏读、不可重复读，所以 C2 需要提交才可以查询到其他事务对数据的修改："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"COMMIT"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C2")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WHERE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C2")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012447025.png",alt:"image-20250320012447025",loading:"lazy",decoding:"async",class:"lazy"})])]),k("li",null,[k("p",null,"C1 更新 id 为 3 的数据，但不提交，C2 也更新 id 为 3 的数据："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UPDATE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," name="),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'3'"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," WHERE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UPDATE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," name="),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'30'"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," WHERE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C2")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012503376.png",alt:"image-20250320012503376",loading:"lazy",decoding:"async",class:"lazy"})]),k("p",null,"当 C1 提交，C2 直接解除阻塞，直接更新")]),k("li",null,[k("p",null,"操作不同行的数据："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UPDATE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," name="),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'10'"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," WHERE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UPDATE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," name="),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'30'"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," WHERE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C2")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012519822.png",alt:"image-20250320012519822",loading:"lazy",decoding:"async",class:"lazy"})]),k("p",null,"由于 C1、C2 操作的不同行，获取不同的行锁，所以都可以正常获取行锁")])],-1)),l[63]||(l[63]=k("hr",null,null,-1)),l[64]||(l[64]=k("h4",{id:"锁分类",tabindex:"-1"},[p("锁分类 "),k("a",{class:"header-anchor",href:"#锁分类","aria-label":'Permalink to "锁分类"'},"​")],-1)),l[65]||(l[65]=k("h5",{id:"间隙锁",tabindex:"-1"},[p("间隙锁 "),k("a",{class:"header-anchor",href:"#间隙锁","aria-label":'Permalink to "间隙锁"'},"​")],-1)),l[66]||(l[66]=k("p",null,[p("InnoDB 会对间隙（GAP）进行加锁，就是间隙锁 （RR 隔离级别下才有该锁）。间隙锁之间不存在冲突关系，"),k("strong",null,"多个事务可以同时对一个间隙加锁"),p("，但是间隙锁会阻止往这个间隙中插入一个记录的操作")],-1)),l[67]||(l[67]=k("p",null,"InnoDB 加锁的基本单位是 next-key lock，该锁是行锁和 gap lock 的组合（X or S 锁），但是加锁过程是分为间隙锁和行锁两段执行",-1)),l[68]||(l[68]=k("ul",null,[k("li",null,[p("可以"),k("strong",null,"保护当前记录和前面的间隙"),p("，遵循左开右闭原则，单纯的间隙锁是左开右开")]),k("li",null,"假设有 10、11、13，那么可能的间隙锁包括：(负无穷,10]、(10,11]、(11,13]、(13,正无穷)")],-1)),l[69]||(l[69]=k("p",null,"几种索引的加锁情况：",-1)),l[70]||(l[70]=k("ul",null,[k("li",null,"唯一索引加锁在值存在时是行锁，next-key lock 会退化为行锁，值不存在会变成间隙锁"),k("li",null,"普通索引加锁会继续向右遍历到不满足条件的值为止，next-key lock 退化为间隙锁"),k("li",null,"范围查询无论是否是唯一索引，都需要访问到不满足条件的第一个值为止"),k("li",null,"对于联合索引且是唯一索引，如果 where 条件只包括联合索引的一部分，那么会加间隙锁")],-1)),l[71]||(l[71]=k("p",null,[p("间隙锁优点：RR 级别下间隙锁可以"),k("strong",null,"解决事务的一部分的幻读问题"),p("，通过对间隙加锁，可以防止读取过程中数据条目发生变化。一部分的意思是不会对全部间隙加锁，只能加锁一部分的间隙")],-1)),l[72]||(l[72]=k("p",null,"间隙锁危害：",-1)),l[73]||(l[73]=k("ul",null,[k("li",null,"当锁定一个范围的键值后，即使某些不存在的键值也会被无辜的锁定，造成在锁定的时候无法插入锁定键值范围内的任何数据，在某些场景下这可能会对性能造成很大的危害，影响并发度"),k("li",null,[p("事务 A B 同时锁住一个间隙后，A 往当前间隙插入数据时会被 B 的间隙锁阻塞，B 也执行插入间隙数据的操作时就会"),k("strong",null,"产生死锁")])],-1)),l[74]||(l[74]=k("p",null,"现场演示：",-1)),l[75]||(l[75]=k("ul",null,[k("li",null,[k("p",null,"关闭自动提交功能："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AUTOCOMMIT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1、C2")])])]),k("button",{class:"code-block-unfold-btn"})])]),k("li",null,[k("p",null,"查询数据表："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock;")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012534405.png",alt:"image-20250320012534405",loading:"lazy",decoding:"async",class:"lazy"})])]),k("li",null,[k("p",null,"C1 根据 id 范围更新数据，C2 插入数据："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UPDATE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," name="),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'8888'"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," WHERE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 4"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"INSERT INTO"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VALUES"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'200'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'2'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");\t\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C2")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012549974.png",alt:"image-20250320012549974",loading:"lazy",decoding:"async",class:"lazy"})]),k("p",null,"出现间隙锁，C2 被阻塞，等待 C1 提交事务后才能更新")])],-1)),l[76]||(l[76]=k("hr",null,null,-1)),l[77]||(l[77]=k("h5",{id:"意向锁",tabindex:"-1"},[p("意向锁 "),k("a",{class:"header-anchor",href:"#意向锁","aria-label":'Permalink to "意向锁"'},"​")],-1)),l[78]||(l[78]=k("p",null,"InnoDB 为了支持多粒度的加锁，允许行锁和表锁同时存在，支持在不同粒度上的加锁操作，InnoDB 增加了意向锁（Intention Lock）",-1)),l[79]||(l[79]=k("p",null,"意向锁是将锁定的对象分为多个层次，意向锁意味着事务希望在更细粒度上进行加锁，意向锁分为两种：",-1)),l[80]||(l[80]=k("ul",null,[k("li",null,"意向共享锁（IS）：事务有意向对表加共享锁"),k("li",null,"意向排他锁（IX）：事务有意向对表加排他锁")],-1)),l[81]||(l[81]=k("p",null,[k("strong",null,"IX，IS 是表级锁"),p("，不会和行级的 X，S 锁发生冲突，意向锁是在加表级锁之前添加，为了在加表级锁时可以快速判断表中是否有记录被上锁，比如向一个表添加表级 X 锁的时：")],-1)),l[82]||(l[82]=k("ul",null,[k("li",null,"没有意向锁，则需要遍历整个表判断是否有锁定的记录"),k("li",null,"有了意向锁，首先判断是否存在意向锁，然后判断该意向锁与即将添加的表级锁是否兼容即可，因为意向锁的存在代表有表级锁的存在或者即将有表级锁的存在")],-1)),l[83]||(l[83]=k("p",null,"兼容性如下所示：",-1)),l[84]||(l[84]=k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012619005.png",alt:"image-20250320012619005",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[85]||(l[85]=k("p",null,[k("strong",null,"插入意向锁"),p(" Insert Intention Lock 是在插入一行记录操作之前设置的一种间隙锁，是行级锁")],-1)),l[86]||(l[86]=k("p",null,"插入意向锁释放了一种插入信号，即多个事务在相同的索引间隙插入时如果不是插入相同的间隙位置就不需要互相等待。假设某列有索引，只要两个事务插入位置不同，如事务 A 插入 3，事务 B 插入 4，那么就可以同时插入",-1)),l[87]||(l[87]=k("hr",null,null,-1)),l[88]||(l[88]=k("h5",{id:"自增锁",tabindex:"-1"},[p("自增锁 "),k("a",{class:"header-anchor",href:"#自增锁","aria-label":'Permalink to "自增锁"'},"​")],-1)),l[89]||(l[89]=k("p",null,"系统会自动给 AUTO_INCREMENT 修饰的列进行递增赋值，实现方式：",-1)),l[90]||(l[90]=k("ul",null,[k("li",null,"AUTO_INC 锁：表级锁，执行插入语句时会自动添加，在该语句执行完成后释放，并不是事务结束"),k("li",null,"轻量级锁：为插入语句生成 AUTO_INCREMENT 修饰的列时获取该锁，生成以后释放掉，不需要等到插入语句执行完后释放")],-1)),l[91]||(l[91]=k("p",null,[p("系统变量 "),k("code",null,"innodb_autoinc_lock_mode"),p(" 控制采取哪种方式：")],-1)),l[92]||(l[92]=k("ul",null,[k("li",null,"0：全部采用 AUTO_INC 锁"),k("li",null,"1：全部采用轻量级锁"),k("li",null,"2：混合使用，在插入记录的数量确定时采用轻量级锁，不确定时采用 AUTO_INC 锁")],-1)),l[93]||(l[93]=k("hr",null,null,-1)),l[94]||(l[94]=k("h5",{id:"隐式锁",tabindex:"-1"},[p("隐式锁 "),k("a",{class:"header-anchor",href:"#隐式锁","aria-label":'Permalink to "隐式锁"'},"​")],-1)),l[95]||(l[95]=k("p",null,"一般情况下 INSERT 语句是不需要在内存中生成锁结构的，会进行隐式的加锁，保护的是插入后的安全",-1)),l[96]||(l[96]=k("p",null,"注意：如果插入的间隙被其他事务加了间隙锁，此次插入会被阻塞，并在该间隙插入一个插入意向锁",-1)),l[97]||(l[97]=k("ul",null,[k("li",null,"聚簇索引：索引记录有 trx_id 隐藏列，表示最后改动该记录的事务 id，插入数据后事务 id 就是当前事务。其他事务想获取该记录的锁时会判断当前记录的事务 id 是否是活跃的，如果不是就可以正常加锁；如果是就创建一个 X 的锁结构，该锁的 is_waiting 是 false，为自己的事务创建一个锁结构，is_waiting 是 true（类似 Java 中的锁升级）"),k("li",null,"二级索引：获取数据页 Page Header 中的 PAGE_MAX_TRX_ID 属性，代表修改当前页面的最大的事务 ID，如果小于当前活跃的最小事务 id，就证明插入该数据的事务已经提交，否则就需要获取到主键值进行回表操作")],-1)),l[98]||(l[98]=k("p",null,"隐式锁起到了延迟生成锁的效果，如果其他事务与隐式锁没有冲突，就可以避免锁结构的生成，节省了内存资源",-1)),l[99]||(l[99]=k("p",null,"INSERT 在两种情况下会生成锁结构：",-1)),l[100]||(l[100]=k("ul",null,[k("li",null,[k("p",null,"重复键：在插入主键或唯一二级索引时遇到重复的键值会报错，在报错前需要对对应的聚簇索引进行加锁"),k("ul",null,[k("li",null,"隔离级别 <= Read Uncommitted，加 S 型 Record Lock"),k("li",null,"隔离级别 >= Repeatable Read，加 S 型 next_key 锁")])]),k("li",null,[k("p",null,"外键检查：如果待插入的记录在父表中可以找到，会对父表的记录加 S 型 Record Lock。如果待插入的记录在父表中找不到"),k("ul",null,[k("li",null,"隔离级别 <= Read Committed，不加锁"),k("li",null,"隔离级别 >= Repeatable Read，加间隙锁")])])],-1)),l[101]||(l[101]=k("hr",null,null,-1)),l[102]||(l[102]=k("h4",{id:"锁优化",tabindex:"-1"},[p("锁优化 "),k("a",{class:"header-anchor",href:"#锁优化","aria-label":'Permalink to "锁优化"'},"​")],-1)),l[103]||(l[103]=k("h5",{id:"优化锁",tabindex:"-1"},[p("优化锁 "),k("a",{class:"header-anchor",href:"#优化锁","aria-label":'Permalink to "优化锁"'},"​")],-1)),l[104]||(l[104]=k("p",null,"InnoDB 存储引擎实现了行级锁定，虽然在锁定机制的实现方面带来了性能损耗可能比表锁会更高，但是在整体并发处理能力方面要远远优于 MyISAM 的表锁，当系统并发量较高的时候，InnoDB 的整体性能远远好于 MyISAM",-1)),l[105]||(l[105]=k("p",null,"但是使用不当可能会让 InnoDB 的整体性能表现不仅不能比 MyISAM 高，甚至可能会更差",-1)),l[106]||(l[106]=k("p",null,"优化建议：",-1)),l[107]||(l[107]=k("ul",null,[k("li",null,"尽可能让所有数据检索都能通过索引来完成，避免无索引行锁升级为表锁"),k("li",null,"合理设计索引，尽量缩小锁的范围"),k("li",null,"尽可能减少索引条件及索引范围，避免间隙锁"),k("li",null,"尽量控制事务大小，减少锁定资源量和时间长度"),k("li",null,"尽可使用低级别事务隔离（需要业务层面满足需求）")],-1)),l[108]||(l[108]=k("hr",null,null,-1)),l[109]||(l[109]=k("h5",{id:"锁升级",tabindex:"-1"},[p("锁升级 "),k("a",{class:"header-anchor",href:"#锁升级","aria-label":'Permalink to "锁升级"'},"​")],-1)),l[110]||(l[110]=k("p",null,[p("索引失效造成"),k("strong",null,"行锁升级为表锁"),p("，不通过索引检索数据，全局扫描的过程中 InnoDB 会将对表中的所有记录加锁，实际效果和"),k("strong",null,"表锁"),p("一样，实际开发过程应避免出现索引失效的状况")],-1)),l[111]||(l[111]=k("ul",null,[k("li",null,[k("p",null,"查看当前表的索引："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SHOW "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"INDEX"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock;")])])]),k("button",{class:"code-block-unfold-btn"})])]),k("li",null,[k("p",null,"关闭自动提交功能："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AUTOCOMMIT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1、C2")])])]),k("button",{class:"code-block-unfold-btn"})])]),k("li",null,[k("p",null,"执行更新语句："),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UPDATE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sex"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'2'"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," WHERE"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," name="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"10"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C1")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UPDATE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," test_innodb_lock "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sex"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'2'"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," WHERE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"3"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t\t"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- C2")])])]),k("button",{class:"code-block-unfold-btn"})]),k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012637282.png",alt:"image-20250320012637282",loading:"lazy",decoding:"async",class:"lazy"})]),k("p",null,"索引失效：执行更新时 name 字段为 varchar 类型，造成索引失效，最终行锁变为表锁")])],-1)),l[112]||(l[112]=k("hr",null,null,-1)),l[113]||(l[113]=k("h5",{id:"死锁",tabindex:"-1"},[p("死锁 "),k("a",{class:"header-anchor",href:"#死锁","aria-label":'Permalink to "死锁"'},"​")],-1)),l[114]||(l[114]=k("p",null,"不同事务由于互相持有对方需要的锁而导致事务都无法继续执行的情况称为死锁",-1)),l[115]||(l[115]=k("p",null,"死锁情况：线程 A 修改了 id = 1 的数据，请求修改 id = 2 的数据，线程 B 修改了 id = 2 的数据，请求修改 id = 1 的数据，产生死锁",-1)),l[116]||(l[116]=k("p",null,"解决策略：",-1)),l[117]||(l[117]=k("ul",null,[k("li",null,[k("p",null,"直接进入等待直到超时，超时时间可以通过参数 innodb_lock_wait_timeout 来设置，默认 50 秒，但是时间的设置不好控制，超时可能不是因为死锁，而是因为事务处理比较慢，所以一般不采取该方式")]),k("li",null,[k("p",null,[p("主动死锁检测，发现死锁后"),k("strong",null,"主动回滚死锁链条中较小的一个事务"),p("，让其他事务得以继续执行，将参数 "),k("code",null,"innodb_deadlock_detect"),p(" 设置为 on，表示开启该功能（事务较小的意思就是事务执行过程中插入、删除、更新的记录条数）")]),k("p",null,"死锁检测并不是每个语句都要检测，只有在加锁访问的行上已经有锁时，当前事务被阻塞了才会检测，也是从当前事务开始进行检测")])],-1)),l[118]||(l[118]=k("p",null,[p("通过执行 "),k("code",null,"SHOW ENGINE INNODB STATUS"),p(" 可以查看最近发生的一次死循环，全局系统变量 "),k("code",null,"innodb_print_all_deadlocks"),p(" 设置为 on，就可以将每个死锁信息都记录在 MySQL 错误日志中")],-1)),l[119]||(l[119]=k("p",null,[p("死锁一般是行级锁，当表锁发生死锁时，会在事务中访问其他表时"),k("strong",null,"直接报错"),p("，破坏了持有并等待的死锁条件")],-1)),l[120]||(l[120]=k("hr",null,null,-1)),l[121]||(l[121]=k("h4",{id:"锁状态-1",tabindex:"-1"},[p("锁状态 "),k("a",{class:"header-anchor",href:"#锁状态-1","aria-label":'Permalink to "锁状态"'},"​")],-1)),l[122]||(l[122]=k("p",null,"查看锁信息",-1)),l[123]||(l[123]=k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SHOW "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"STATUS"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," LIKE"),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'innodb_row_lock%'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),k("button",{class:"code-block-unfold-btn"})],-1)),l[124]||(l[124]=k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012702739.png",alt:"image-20250320012702739",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[125]||(l[125]=k("p",null,"参数说明：",-1)),l[126]||(l[126]=k("ul",null,[k("li",null,[k("p",null,"Innodb_row_lock_current_waits：当前正在等待锁定的数量")]),k("li",null,[k("p",null,"Innodb_row_lock_time：从系统启动到现在锁定总时间长度")]),k("li",null,[k("p",null,"Innodb_row_lock_time_avg：每次等待所花平均时长")]),k("li",null,[k("p",null,"Innodb_row_lock_time_max：从系统启动到现在等待最长的一次所花的时间")]),k("li",null,[k("p",null,"Innodb_row_lock_waits：系统启动后到现在总共等待的次数")])],-1)),l[127]||(l[127]=k("p",null,"当等待的次数很高，而且每次等待的时长也不短的时候，就需要分析系统中为什么会有如此多的等待，然后根据分析结果制定优化计划",-1)),l[128]||(l[128]=k("p",null,"查看锁状态：",-1)),l[129]||(l[129]=k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," information_schema"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"innodb_locks"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";\t#锁的概况")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SHOW ENGINE INNODB "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"STATUS"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\\G; #InnoDB整体状态，其中包括锁的情况")])])]),k("button",{class:"code-block-unfold-btn"})],-1)),l[130]||(l[130]=k("figure",null,[k("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320012717199.png",alt:"image-20250320012717199",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[131]||(l[131]=k("p",null,"lock_id 是锁 id；lock_trx_id 为事务 id；lock_mode 为 X 代表排它锁（写锁）；lock_type 为 RECORD 代表锁为行锁（记录锁）",-1)),l[132]||(l[132]=k("hr",null,null,-1)),l[133]||(l[133]=k("h3",{id:"乐观锁",tabindex:"-1"},[p("乐观锁 "),k("a",{class:"header-anchor",href:"#乐观锁","aria-label":'Permalink to "乐观锁"'},"​")],-1)),l[134]||(l[134]=k("p",null,"悲观锁：在整个数据处理过程中，将数据处于锁定状态，为了保证事务的隔离性，就需要一致性锁定读。读取数据时给加锁，其它事务无法修改这些数据，修改删除数据时也加锁，其它事务同样无法读取这些数据",-1)),l[135]||(l[135]=k("p",null,"悲观锁和乐观锁使用前提：",-1)),l[136]||(l[136]=k("ul",null,[k("li",null,"对于读的操作远多于写的操作的时候，一个更新操作加锁会阻塞所有的读取操作，降低了吞吐量，最后需要释放锁，锁是需要一些开销的，这时候可以选择乐观锁"),k("li",null,"如果是读写比例差距不是非常大或者系统没有响应不及时，吞吐量瓶颈的问题，那就不要去使用乐观锁，它增加了复杂度，也带来了业务额外的风险，这时候可以选择悲观锁")],-1)),l[137]||(l[137]=k("p",null,"乐观锁的实现方式：就是 CAS，比较并交换",-1)),l[138]||(l[138]=k("ul",null,[k("li",null,[k("p",null,"版本号"),k("ol",null,[k("li",null,[k("p",null,"给数据表中添加一个 version 列，每次更新后都将这个列的值加 1")]),k("li",null,[k("p",null,"读取数据时，将版本号读取出来，在执行更新的时候，比较版本号")]),k("li",null,[k("p",null,"如果相同则执行更新，如果不相同，说明此条数据已经发生了变化")]),k("li",null,[k("p",null,"用户自行根据这个通知来决定怎么处理，比如重新开始一遍，或者放弃本次更新"),k("div",{class:"language-sql max-h-300px"},[k("button",{title:"Copy code",class:"copy"}),k("span",{class:"lang"},"sql"),k("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[k("code",{"v-pre":""},[k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 创建city表")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CREATE"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," TABLE"),k("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," city"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\tid "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"INT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," PRIMARY KEY"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," AUTO_INCREMENT,  "),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 城市id")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tNAME"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," VARCHAR"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"20"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),                   "),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 城市名称")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\tVERSION"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," INT"),k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                         -- 版本号")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),p("\n"),k("span",{class:"line"}),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 添加数据")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"INSERT INTO"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," city "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VALUES"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"NULL"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'北京'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),("),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"NULL"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'上海'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),("),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"NULL"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'广州'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"),("),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"NULL"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'深圳'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),p("\n"),k("span",{class:"line"}),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 修改北京为北京市")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 1.查询北京的version")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," VERSION"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," city "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WHERE"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," NAME="),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'北京'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"-- 2.修改北京为北京市，版本号+1。并对比版本号")]),p("\n"),k("span",{class:"line"},[k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UPDATE"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," city "),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," NAME="),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'北京市'"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VERSION=VERSION+"),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," WHERE"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," NAME="),k("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'北京'"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," AND"),k("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," VERSION="),k("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),k("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),k("button",{class:"code-block-unfold-btn"})])])])]),k("li",null,[k("p",null,"时间戳"),k("ul",null,[k("li",null,[p("和版本号方式基本一样，给数据表中添加一个列，名称无所谓，数据类型需要是 "),k("strong",null,"timestamp")]),k("li",null,"每次更新后都将最新时间插入到此列"),k("li",null,"读取数据时，将时间读取出来，在执行更新的时候，比较时间"),k("li",null,"如果相同则执行更新，如果不相同，说明此条数据已经发生了变化")])])],-1)),l[139]||(l[139]=k("p",null,[p("乐观锁的异常情况：如果 version 被其他事务抢先更新，则在当前事务中更新失败，trx_id 没有变成当前事务的 ID，当前事务再次查询还是旧值，就会出现"),k("strong",null,"值没变但是更新不了"),p("的现象（anomaly）")],-1)),l[140]||(l[140]=k("p",null,"解决方案：每次 CAS 更新不管成功失败，就结束当前事务；如果失败则重新起一个事务进行查询更新",-1))]),"main-header":t(()=>[n(s.$slots,"main-header")]),"main-header-after":t(()=>[n(s.$slots,"main-header-after")]),"main-nav":t(()=>[n(s.$slots,"main-nav")]),"main-content-before":t(()=>[n(s.$slots,"main-content-before")]),"main-content":t(()=>[n(s.$slots,"main-content")]),"main-content-after":t(()=>[n(s.$slots,"main-content-after")]),"main-nav-before":t(()=>[n(s.$slots,"main-nav-before")]),"main-nav-after":t(()=>[n(s.$slots,"main-nav-after")]),comment:t(()=>[n(s.$slots,"comment")]),footer:t(()=>[n(s.$slots,"footer")]),aside:t(()=>[n(s.$slots,"aside")]),"aside-custom":t(()=>[n(s.$slots,"aside-custom")]),default:t(()=>[n(s.$slots,"default")]),_:3},8,["frontmatter"])}}};export{o as default,E as usePageData};
