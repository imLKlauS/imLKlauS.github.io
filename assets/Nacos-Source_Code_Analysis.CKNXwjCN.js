import{_ as i}from"./ValaxyMain.vue_vue_type_style_index_0_lang.BOb0xH-1.js";import"./chunks/@vueuse/motion.BrTBiDBP.js";import{d as s,a as l,u as a}from"./chunks/vue-router.iuc03XPI.js";import{a1 as h,a3 as t,a4 as k,a5 as n,a6 as e,a7 as E,F as r,a2 as p,Z as g}from"./framework.CSpzLJwA.js";import"./app.DxsXqPDj.js";import"./chunks/dayjs.Dto65haK.js";import"./chunks/vue-i18n.C5QQbedb.js";import"./chunks/pinia.CKttsWmm.js";import"./chunks/nprogress.BEPa78Un.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.IawhXP3l.js";import"./index.TQnGKZgq.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.DIveis5r.js";import"./post.BWOv1eSm.js";const d=s("/posts/Nacos-Source_Code_Analysis",async i=>JSON.parse('{"title":"Nacos源码分析","description":"","frontmatter":{"title":"Nacos源码分析","author":"imklaus","tags":["Nacos"],"categories":["Java","微服务"],"date":"2025/12/8 3:44:00","outline":"deep","postTitleClass":"text-#62afe9","excerpt_type":"html","end":false},"headers":[],"relativePath":"pages/posts/Nacos-Source_Code_Analysis.md","lastUpdated":null}'),{lazy:(i,s)=>i.name===s.name}),y={__name:"Nacos-Source_Code_Analysis",setup(s,{expose:y}){const{data:c}=d(),o=a(),F=l(),u=Object.assign(F.meta.frontmatter||{},c.value?.frontmatter||{});o.currentRoute.value.data=c.value,g("valaxy:frontmatter",u),globalThis.$frontmatter=u;return y({frontmatter:{title:"Nacos源码分析",author:"imklaus",tags:["Nacos"],categories:["Java","微服务"],date:"2025/12/8 3:44:00",outline:"deep",postTitleClass:"text-#62afe9",excerpt_type:"html",end:!1}}),(s,l)=>{const a=i;return p(),h(a,{frontmatter:r(u)},{"main-content-md":t(()=>[l[0]||(l[0]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20251214040428114.png",alt:"image-20251214040428114",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[1]||(l[1]=n("p",null,[E("参考视频："),n("a",{href:"https://www.bilibili.com/video/BV1LQ4y127n4",target:"_blank",rel:"noreferrer"},"黑马SpringCloud微服务技术栈原理篇")],-1)),l[2]||(l[2]=n("p",null,"笔记的整体结构依据视频编写，并随着学习的深入补充了很多知识",-1)),l[3]||(l[3]=n("p",null,[n("strong",null,"目录指引"),E("：")],-1)),l[4]||(l[4]=n("nav",{class:"table-of-contents"},[n("ul",null,[n("li",null,[n("a",{href:"#_1-下载nacos源码并运行"},"1. 下载Nacos源码并运行"),n("ul",null,[n("li",null,[n("a",{href:"#_1-1-下载nacos源码"},"1.1 下载Nacos源码")]),n("li",null,[n("a",{href:"#_1-2-导入demo工程"},"1.2 导入Demo工程")]),n("li",null,[n("a",{href:"#_1-3-导入nacos源码"},"1.3 导入Nacos源码")]),n("li",null,[n("a",{href:"#_1-4-proto编译"},"1.4 proto编译")]),n("li",null,[n("a",{href:"#_1-5-运行"},"1.5 运行")])])]),n("li",null,[n("a",{href:"#_2-服务注册"},"2. 服务注册"),n("ul",null,[n("li",null,[n("a",{href:"#_2-1-服务注册接口"},"2.1 服务注册接口")]),n("li",null,[n("a",{href:"#_2-2-客户端"},"2.2 客户端")]),n("li",null,[n("a",{href:"#_2-3-服务端"},"2.3 服务端")]),n("li",null,[n("a",{href:"#_2-4-总结"},"2.4 总结")])])]),n("li",null,[n("a",{href:"#_3-服务心跳"},"3. 服务心跳"),n("ul",null,[n("li",null,[n("a",{href:"#_3-1-客户端"},"3.1 客户端")]),n("li",null,[n("a",{href:"#_3-2-服务端"},"3.2 服务端")]),n("li",null,[n("a",{href:"#_3-3-总结"},"3.3 总结")])])]),n("li",null,[n("a",{href:"#_4-服务发现"},"4. 服务发现"),n("ul",null,[n("li",null,[n("a",{href:"#_4-1-客户端"},"4.1 客户端")]),n("li",null,[n("a",{href:"#_4-2-服务端"},"4.2 服务端")]),n("li",null,[n("a",{href:"#_4-3-总结"},"4.3 总结")])])]),n("li",null,[n("a",{href:"#_5-原理"},"5 原理"),n("ul",null,[n("li",null,[n("a",{href:"#临时实例和永久实例"},"临时实例和永久实例")]),n("li",null,[n("a",{href:"#服务注册"},"服务注册")]),n("li",null,[n("a",{href:"#心跳机制"},"心跳机制")]),n("li",null,[n("a",{href:"#健康检查"},"健康检查")]),n("li",null,[n("a",{href:"#服务发现"},"服务发现")]),n("li",null,[n("a",{href:"#数据一致性"},"数据一致性")]),n("li",null,[n("a",{href:"#数据模型"},"数据模型")])])])])],-1)),l[5]||(l[5]=n("h2",{id:"_1-下载nacos源码并运行",tabindex:"-1"},[E("1. 下载Nacos源码并运行 "),n("a",{class:"header-anchor",href:"#_1-下载nacos源码并运行","aria-label":'Permalink to "1. 下载Nacos源码并运行"'},"​")],-1)),l[6]||(l[6]=n("p",null,"要研究Nacos源码自然不能用打包好的Nacos服务端jar包来运行，需要下载源码自己编译来运行。",-1)),l[7]||(l[7]=n("h3",{id:"_1-1-下载nacos源码",tabindex:"-1"},[E("1.1 下载Nacos源码 "),n("a",{class:"header-anchor",href:"#_1-1-下载nacos源码","aria-label":'Permalink to "1.1 下载Nacos源码"'},"​")],-1)),l[8]||(l[8]=n("p",null,[E("Nacos的GitHub地址："),n("a",{href:"https://github.com/alibaba/nacos",target:"_blank",rel:"noreferrer"},"https://github.com/alibaba/nacos")],-1)),e(" more "),l[9]||(l[9]=n("p",null,"课前资料中已经提供了下载好的1.4.2版本的Nacos源码：",-1)),l[10]||(l[10]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906105652113.png",alt:"image-20210906105652113",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[11]||(l[11]=n("p",null,"如果需要研究其他版本的同学，也可以自行下载：",-1)),l[12]||(l[12]=n("p",null,[E("大家找到其release页面："),n("a",{href:"https://github.com/alibaba/nacos/tags%EF%BC%8C%E6%89%BE%E5%88%B0%E5%85%B6%E4%B8%AD%E7%9A%841.4.2.%E7%89%88%E6%9C%AC%EF%BC%9A",target:"_blank",rel:"noreferrer"},"https://github.com/alibaba/nacos/tags，找到其中的1.4.2.版本：")],-1)),l[13]||(l[13]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906105157409.png",alt:"image-20210906105157409",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[14]||(l[14]=n("p",null,"点击进入后，下载Source code(zip)：",-1)),l[15]||(l[15]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906105102668.png",alt:"image-20210906105102668",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[16]||(l[16]=n("h3",{id:"_1-2-导入demo工程",tabindex:"-1"},[E("1.2 导入Demo工程 "),n("a",{class:"header-anchor",href:"#_1-2-导入demo工程","aria-label":'Permalink to "1.2 导入Demo工程"'},"​")],-1)),l[17]||(l[17]=n("p",null,"我们的课前资料提供了一个微服务Demo，包含了服务注册、发现等业务。",-1)),l[18]||(l[18]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906105858000.png",alt:"image-20210906105858000",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[19]||(l[19]=n("p",null,"导入该项目后，查看其项目结构：",-1)),l[20]||(l[20]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906110014198.png",alt:"image-20210906110014198",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[21]||(l[21]=n("p",null,"结构说明：",-1)),l[22]||(l[22]=n("ul",null,[n("li",null,[E("cloud-source-demo：项目父目录 "),n("ul",null,[n("li",null,[E("cloud-demo：微服务的父工程，管理微服务依赖 "),n("ul",null,[n("li",null,"order-service：订单微服务，业务中需要访问user-service，是一个服务消费者"),n("li",null,"user-service：用户微服务，对外暴露根据id查询用户的接口，是一个服务提供者")])])])])],-1)),l[23]||(l[23]=n("h3",{id:"_1-3-导入nacos源码",tabindex:"-1"},[E("1.3 导入Nacos源码 "),n("a",{class:"header-anchor",href:"#_1-3-导入nacos源码","aria-label":'Permalink to "1.3 导入Nacos源码"'},"​")],-1)),l[24]||(l[24]=n("p",null,"将之前下载好的Nacos源码解压到cloud-source-demo项目目录中：",-1)),l[25]||(l[25]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111053263.png",alt:"image-20210906111053263",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[26]||(l[26]=n("p",null,"然后，使用IDEA将其作为一个module来导入：",-1)),l[27]||(l[27]=n("p",null,"1）选择项目结构选项：",-1)),l[28]||(l[28]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111152447.png",alt:"image-20210906111152447",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[29]||(l[29]=n("p",null,"然后点击导入module：",-1)),l[30]||(l[30]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111259352.png",alt:"image-20210906111259352",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[31]||(l[31]=n("p",null,"在弹出窗口中，选择nacos源码目录：",-1)),l[32]||(l[32]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111422406.png",alt:"image-20210906111422406",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[33]||(l[33]=n("p",null,"然后选择maven模块，finish：",-1)),l[34]||(l[34]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111519198.png",alt:"image-20210906111519198",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[35]||(l[35]=n("p",null,"最后，点击OK即可：",-1)),l[36]||(l[36]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111543747.png",alt:"image-20210906111543747",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[37]||(l[37]=n("p",null,"导入后的项目结构：",-1)),l[38]||(l[38]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111632336.png",alt:"image-20210906111632336",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[39]||(l[39]=n("h3",{id:"_1-4-proto编译",tabindex:"-1"},[E("1.4 proto编译 "),n("a",{class:"header-anchor",href:"#_1-4-proto编译","aria-label":'Permalink to "1.4 proto编译"'},"​")],-1)),l[40]||(l[40]=n("p",null,"Nacos底层的数据通信会基于protobuf对数据做序列化和反序列化。并将对应的proto文件定义在了consistency这个子模块中：",-1)),l[41]||(l[41]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906111941399.png",alt:"image-20210906111941399",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[42]||(l[42]=n("p",null,"我们需要先将proto文件编译为对应的Java代码。",-1)),l[43]||(l[43]=n("h4",{id:"_1-4-1-什么是protobuf",tabindex:"-1"},[E("1.4.1 什么是protobuf "),n("a",{class:"header-anchor",href:"#_1-4-1-什么是protobuf","aria-label":'Permalink to "1.4.1 什么是protobuf"'},"​")],-1)),l[44]||(l[44]=n("p",null,"protobuf的全称是Protocol Buffer，是Google提供的一种数据序列化协议，这是Google官方的定义：",-1)),l[45]||(l[45]=n("blockquote",null,[n("p",null,"Protocol Buffers 是一种轻便高效的结构化数据存储格式，可以用于结构化数据序列化，很适合做数据存储或 RPC 数据交换格式。它可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。")],-1)),l[46]||(l[46]=n("p",null,"可以简单理解为，是一种跨语言、跨平台的数据传输格式。与json的功能类似，但是无论是性能，还是数据大小都比json要好很多。",-1)),l[47]||(l[47]=n("p",null,[E("protobuf的之所以可以跨语言，就是因为数据定义的格式为"),n("code",null,".proto"),E("格式，需要基于protoc编译为对应的语言。")],-1)),l[48]||(l[48]=n("h4",{id:"_1-4-2-安装protoc",tabindex:"-1"},[E("1.4.2 安装protoc "),n("a",{class:"header-anchor",href:"#_1-4-2-安装protoc","aria-label":'Permalink to "1.4.2 安装protoc"'},"​")],-1)),l[49]||(l[49]=n("p",null,[E("Protobuf的GitHub地址："),n("a",{href:"https://github.com/protocolbuffers/protobuf/releases",target:"_blank",rel:"noreferrer"},"https://github.com/protocolbuffers/protobuf/releases")],-1)),l[50]||(l[50]=n("p",null,"我们可以下载windows版本的来使用：",-1)),l[51]||(l[51]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906112814549.png",alt:"image-20210906112814549",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[52]||(l[52]=n("p",null,"另外，课前资料也提供了下载好的安装包：",-1)),l[53]||(l[53]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906112920575.png",alt:"image-20210906112920575",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[54]||(l[54]=n("p",null,"解压到任意非中文目录下，其中的bin目录中的protoc.exe可以帮助我们编译：",-1)),l[55]||(l[55]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906113011871.png",alt:"image-20210906113011871",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[56]||(l[56]=n("p",null,"然后将这个bin目录配置到你的环境变量path中，可以参考JDK的配置方式：",-1)),l[57]||(l[57]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906113552081.png",alt:"image-20210906113552081",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[58]||(l[58]=n("h4",{id:"_1-4-3-编译proto",tabindex:"-1"},[E("1.4.3 编译proto "),n("a",{class:"header-anchor",href:"#_1-4-3-编译proto","aria-label":'Permalink to "1.4.3 编译proto"'},"​")],-1)),l[59]||(l[59]=n("p",null,"进入nacos-1.4.2的consistency模块下的src/main目录下：",-1)),l[60]||(l[60]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906113655302.png",alt:"image-20210906113655302",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[61]||(l[61]=n("p",null,"然后打开cmd窗口，运行下面的两个命令：",-1)),l[62]||(l[62]=n("div",{class:"language-powershell max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"powershell"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"protoc "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"--"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"java_out"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"java ."),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"proto"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"consistency.proto")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"protoc "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"--"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"java_out"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"java ."),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"proto"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/Data"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".proto")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[63]||(l[63]=n("p",null,"如图：",-1)),l[64]||(l[64]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906113829647.png",alt:"image-20210906113829647",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[65]||(l[65]=n("p",null,"会在nacos的consistency模块中编译出这些java代码：",-1)),l[66]||(l[66]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906113923430.png",alt:"image-20210906113923430",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[67]||(l[67]=n("h3",{id:"_1-5-运行",tabindex:"-1"},[E("1.5 运行 "),n("a",{class:"header-anchor",href:"#_1-5-运行","aria-label":'Permalink to "1.5 运行"'},"​")],-1)),l[68]||(l[68]=n("p",null,"nacos服务端的入口是在console模块中的Nacos类：",-1)),l[69]||(l[69]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906114035628.png",alt:"image-20210906114035628",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[70]||(l[70]=n("p",null,"我们需要让它单机启动：",-1)),l[71]||(l[71]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906114143669.png",alt:"image-20210906114143669",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[72]||(l[72]=n("p",null,"然后新建一个SpringBootApplication：",-1)),l[73]||(l[73]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906114220412.png",alt:"image-20210906114220412",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[74]||(l[74]=n("p",null,"然后填写应用信息：",-1)),l[75]||(l[75]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906114519073.png",alt:"image-20210906114519073",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[76]||(l[76]=n("p",null,"然后运行Nacos这个main函数：",-1)),l[77]||(l[77]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906114705910.png",alt:"image-20210906114705910",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[78]||(l[78]=n("p",null,"将order-service和user-service服务启动后，可以查看nacos控制台：",-1)),l[79]||(l[79]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210906151358154.png",alt:"image-20210906151358154",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[80]||(l[80]=n("hr",null,null,-1)),l[81]||(l[81]=n("h2",{id:"_2-服务注册",tabindex:"-1"},[E("2. 服务注册 "),n("a",{class:"header-anchor",href:"#_2-服务注册","aria-label":'Permalink to "2. 服务注册"'},"​")],-1)),l[82]||(l[82]=n("p",null,"服务注册到Nacos以后，会保存在一个本地注册表中，其结构如下：",-1)),l[83]||(l[83]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922111651314.png",alt:"image-20210922111651314",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[84]||(l[84]=n("p",null,[E("首先最外层是一个Map，结构为："),n("code",null,"Map<String, Map<String, Service>>"),E("：")],-1)),l[85]||(l[85]=n("ul",null,[n("li",null,"key：是namespace_id，起到环境隔离的作用。namespace下可以有多个group"),n("li",null,[E("value：又是一个"),n("code",null,"Map<String, Service>"),E("，代表分组及组内的服务。一个组内可以有多个服务 "),n("ul",null,[n("li",null,"key：代表group分组，不过作为key时格式是group_name:service_name"),n("li",null,[E("value：分组下的某一个服务，例如userservice，用户服务。类型为"),n("code",null,"Service"),E("，内部也包含一个"),n("code",null,"Map<String,Cluster>"),E("，一个服务下可以有多个集群 "),n("ul",null,[n("li",null,"key：集群名称"),n("li",null,[E("value："),n("code",null,"Cluster"),E("类型，包含集群的具体信息。一个集群中可能包含多个实例，也就是具体的节点信息，其中包含一个"),n("code",null,"Set<Instance>"),E("，就是该集群下的实例的集合 "),n("ul",null,[n("li",null,"Instance：实例信息，包含实例的IP、Port、健康状态、权重等等信息")])])])])])])],-1)),l[86]||(l[86]=n("p",null,"每一个服务去注册到Nacos时，就会把信息组织并存入这个Map中。",-1)),l[87]||(l[87]=n("h3",{id:"_2-1-服务注册接口",tabindex:"-1"},[E("2.1 服务注册接口 "),n("a",{class:"header-anchor",href:"#_2-1-服务注册接口","aria-label":'Permalink to "2.1 服务注册接口"'},"​")],-1)),l[88]||(l[88]=n("p",null,"Nacos提供了服务注册的API接口，客户端只需要向该接口发送请求，即可实现服务注册。",-1)),l[89]||(l[89]=n("p",null,"**接口说明：**注册一个实例到Nacos服务。",-1)),l[90]||(l[90]=n("p",null,[n("strong",null,"请求类型"),E("："),n("code",null,"POST")],-1)),l[91]||(l[91]=n("p",null,[n("strong",null,"请求路径"),E("："),n("code",null,"/nacos/v1/ns/instance")],-1)),l[92]||(l[92]=n("p",null,[n("strong",null,"请求参数"),E("：")],-1)),l[93]||(l[93]=n("table",null,[n("thead",null,[n("tr",null,[n("th",{style:{"text-align":"left"}},"名称"),n("th",{style:{"text-align":"left"}},"类型"),n("th",{style:{"text-align":"left"}},"是否必选"),n("th",null,"描述")])]),n("tbody",null,[n("tr",null,[n("td",{style:{"text-align":"left"}},"ip"),n("td",{style:{"text-align":"left"}},"字符串"),n("td",{style:{"text-align":"left"}},"是"),n("td",null,"服务实例IP")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"port"),n("td",{style:{"text-align":"left"}},"int"),n("td",{style:{"text-align":"left"}},"是"),n("td",null,"服务实例port")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"namespaceId"),n("td",{style:{"text-align":"left"}},"字符串"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"命名空间ID")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"weight"),n("td",{style:{"text-align":"left"}},"double"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"权重")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"enabled"),n("td",{style:{"text-align":"left"}},"boolean"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"是否上线")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"healthy"),n("td",{style:{"text-align":"left"}},"boolean"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"是否健康")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"metadata"),n("td",{style:{"text-align":"left"}},"字符串"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"扩展信息")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"clusterName"),n("td",{style:{"text-align":"left"}},"字符串"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"集群名")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"serviceName"),n("td",{style:{"text-align":"left"}},"字符串"),n("td",{style:{"text-align":"left"}},"是"),n("td",null,"服务名")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"groupName"),n("td",{style:{"text-align":"left"}},"字符串"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"分组名")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"ephemeral"),n("td",{style:{"text-align":"left"}},"boolean"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"是否临时实例")])])],-1)),l[94]||(l[94]=n("p",null,[n("strong",null,"错误编码"),E("：")],-1)),l[95]||(l[95]=n("table",null,[n("thead",null,[n("tr",null,[n("th",{style:{"text-align":"left"}},"错误代码"),n("th",{style:{"text-align":"left"}},"描述"),n("th",{style:{"text-align":"left"}},"语义")])]),n("tbody",null,[n("tr",null,[n("td",{style:{"text-align":"left"}},"400"),n("td",{style:{"text-align":"left"}},"Bad Request"),n("td",{style:{"text-align":"left"}},"客户端请求中的语法错误")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"403"),n("td",{style:{"text-align":"left"}},"Forbidden"),n("td",{style:{"text-align":"left"}},"没有权限")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"404"),n("td",{style:{"text-align":"left"}},"Not Found"),n("td",{style:{"text-align":"left"}},"无法找到资源")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"500"),n("td",{style:{"text-align":"left"}},"Internal Server Error"),n("td",{style:{"text-align":"left"}},"服务器内部错误")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"200"),n("td",{style:{"text-align":"left"}},"OK"),n("td",{style:{"text-align":"left"}},"正常")])])],-1)),l[96]||(l[96]=n("h3",{id:"_2-2-客户端",tabindex:"-1"},[E("2.2 客户端 "),n("a",{class:"header-anchor",href:"#_2-2-客户端","aria-label":'Permalink to "2.2 客户端"'},"​")],-1)),l[97]||(l[97]=n("p",null,"首先，我们需要找到服务注册的入口。",-1)),l[98]||(l[98]=n("h4",{id:"_2-2-1-nacosserviceregistryautoconfiguration",tabindex:"-1"},[E("2.2.1 NacosServiceRegistryAutoConfiguration "),n("a",{class:"header-anchor",href:"#_2-2-1-nacosserviceregistryautoconfiguration","aria-label":'Permalink to "2.2.1 NacosServiceRegistryAutoConfiguration"'},"​")],-1)),l[99]||(l[99]=n("p",null,"因为Nacos的客户端是基于SpringBoot的自动装配实现的，我们可以在nacos-discovery依赖：",-1)),l[100]||(l[100]=n("p",null,[n("code",null,"spring-cloud-starter-alibaba-nacos-discovery-2.2.6.RELEASE.jar")],-1)),l[101]||(l[101]=n("p",null,"这个包中找到Nacos自动装配信息：",-1)),l[102]||(l[102]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907201333049.png",alt:"image-20210907201333049",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[103]||(l[103]=n("p",null,"可以看到，有很多个自动配置类被加载了，其中跟服务注册有关的就是NacosServiceRegistryAutoConfiguration这个类，我们跟入其中。",-1)),l[104]||(l[104]=n("p",null,"可以看到，在NacosServiceRegistryAutoConfiguration这个类中，包含一个跟自动注册有关的Bean：",-1)),l[105]||(l[105]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907201612322.png",alt:"image-20210907201612322",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[106]||(l[106]=n("h4",{id:"_2-2-2-nacosautoserviceregistration",tabindex:"-1"},[E("2.2.2 NacosAutoServiceRegistration "),n("a",{class:"header-anchor",href:"#_2-2-2-nacosautoserviceregistration","aria-label":'Permalink to "2.2.2 NacosAutoServiceRegistration"'},"​")],-1)),l[107]||(l[107]=n("p",null,[n("code",null,"NacosAutoServiceRegistration"),E("源码如图：")],-1)),l[108]||(l[108]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907213647145.png",alt:"image-20210907213647145",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[109]||(l[109]=n("p",null,[E("可以看到在初始化时，其父类"),n("code",null,"AbstractAutoServiceRegistration"),E("也被初始化了。")],-1)),l[110]||(l[110]=n("p",null,[n("code",null,"AbstractAutoServiceRegistration"),E("如图：")],-1)),l[111]||(l[111]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907214111801.png",alt:"image-20210907214111801",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[112]||(l[112]=n("p",null,[E("可以看到它实现了"),n("code",null,"ApplicationListener"),E("接口，监听Spring容器启动过程中的事件。")],-1)),l[113]||(l[113]=n("p",null,[E("在监听到"),n("code",null,"WebServerInitializedEvent"),E("（web服务初始化完成）的事件后，执行了"),n("code",null,"bind"),E(" 方法。")],-1)),l[114]||(l[114]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907214411267.png",alt:"image-20210907214411267",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[115]||(l[115]=n("p",null,"其中的bind方法如下：",-1)),l[116]||(l[116]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," bind"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WebServerInitializedEvent event) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取 ApplicationContext")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ApplicationContext context "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," event."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getApplicationContext"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断服务的 namespace,一般都是null")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (context "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"instanceof"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ConfigurableWebServerApplicationContext) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"management"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(((ConfigurableWebServerApplicationContext) context)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServerNamespace"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 记录当前 web 服务的端口")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".port."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", event."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWebServer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 启动当前服务注册流程")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"start"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[117]||(l[117]=n("p",null,"其中的start方法流程：",-1)),l[118]||(l[118]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," start"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\tif"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEnabled"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\tif"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (logger."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t\tlogger."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Discovery Lifecycle disabled. Not starting"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\treturn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 当前服务处于未运行状态时，才进行初始化")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\tif"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".running."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 发布服务开始注册的事件")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\t\t\tthis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"publishEvent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\t\t\tnew"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InstancePreRegisteredEvent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRegistration"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // ☆☆☆☆开始注册☆☆☆☆")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"\t\t\tregister"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\tif"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"shouldRegisterManagement"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"\t\t\t\tregisterManagement"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t\t}")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 发布注册完成事件")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\t\t\tthis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".context."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"publishEvent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"\t\t\t\t\tnew"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," InstanceRegisteredEvent<>("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getConfiguration"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 服务状态设置为运行状态，基于AtomicBoolean")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\t\t\tthis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".running."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareAndSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t}")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[119]||(l[119]=n("p",null,"其中最关键的register()方法就是完成服务注册的关键，代码如下：",-1)),l[120]||(l[120]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"protected"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," register"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".serviceRegistry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"register"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getRegistration"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[121]||(l[121]=n("p",null,"此处的this.serviceRegistry就是NacosServiceRegistry：",-1)),l[122]||(l[122]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210907215903335.png",alt:"image-20210907215903335",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[123]||(l[123]=n("h4",{id:"_2-2-3-nacosserviceregistry",tabindex:"-1"},[E("2.2.3 NacosServiceRegistry "),n("a",{class:"header-anchor",href:"#_2-2-3-nacosserviceregistry","aria-label":'Permalink to "2.2.3 NacosServiceRegistry"'},"​")],-1)),l[124]||(l[124]=n("p",null,[n("code",null,"NacosServiceRegistry"),E("是Spring的"),n("code",null,"ServiceRegistry"),E("接口的实现类，而ServiceRegistry接口是服务注册、发现的规约接口，定义了register、deregister等方法的声明。")],-1)),l[125]||(l[125]=n("p",null,[E("而"),n("code",null,"NacosServiceRegistry"),E("对"),n("code",null,"register"),E("的实现如下：")],-1)),l[126]||(l[126]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," register"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Registration registration) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 判断serviceId是否为空，也就是spring.application.name不能为空")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(registration."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"No service to register for nacos client..."'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取Nacos的命名服务，其实就是注册中心服务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingService namingService "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," namingService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取 serviceId 和 Group")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String serviceId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," registration."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String group "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," nacosDiscoveryProperties."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroup"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 封装服务实例的基本信息，如 cluster-name、是否为临时实例、权重、IP、端口等")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getNacosInstanceFromRegistration"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(registration);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 开始注册服务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        namingService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerInstance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceId, group, instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"nacos registry, {} {} {}:{} register finished"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", group, serviceId,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                 instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (nacosDiscoveryProperties."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFailFast"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"nacos registry, {} register failed...{},"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceId,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                      registration."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            rethrowRuntimeException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            log."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Failfast is false. {} register failed...{},"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceId,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                     registration."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[127]||(l[127]=n("p",null,"可以看到方法中最终是调用NamingService的registerInstance方法实现注册的。",-1)),l[128]||(l[128]=n("p",null,"而NamingService接口的默认实现就是NacosNamingService。",-1)),l[129]||(l[129]=n("h4",{id:"_2-2-4-nacosnamingservice",tabindex:"-1"},[E("2.2.4 NacosNamingService "),n("a",{class:"header-anchor",href:"#_2-2-4-nacosnamingservice","aria-label":'Permalink to "2.2.4 NacosNamingService"'},"​")],-1)),l[130]||(l[130]=n("p",null,"NacosNamingService提供了服务注册、订阅等功能。",-1)),l[131]||(l[131]=n("p",null,"其中registerInstance就是注册服务实例，源码如下：",-1)),l[132]||(l[132]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," registerInstance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String groupName, Instance instance) throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 检查超时参数是否异常。心跳超时时间(默认15秒)必须大于心跳周期(默认5秒)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkInstanceIsLegal"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 拼接得到新的服务名，格式为：groupName@@serviceId")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String groupedServiceName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupedName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, groupName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断是否为临时实例，默认为 true。")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果是临时实例，需要定时向 Nacos 服务发送心跳")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        BeatInfo beatInfo "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beatReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildBeatInfo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        beatReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addBeatInfo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, beatInfo);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送注册服务实例的请求")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    serverProxy."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, groupName, instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[133]||(l[133]=n("p",null,"最终，由NacosProxy的registerService方法，完成服务注册。",-1)),l[134]||(l[134]=n("p",null,"代码如下：",-1)),l[135]||(l[135]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," registerService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String groupName, Instance instance) throws NacosException {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NAMING_LOGGER."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[REGISTER-SERVICE] {} registering service {} with instance: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", namespaceId, serviceName,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                       instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 组织请求参数")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> params "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"16"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.NAMESPACE_ID, namespaceId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.SERVICE_NAME, serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.GROUP_NAME, groupName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CLUSTER_NAME, instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ip"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"port"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"weight"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWeight"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"enable"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEnabled"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"healthy"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isHealthy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ephemeral"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"metadata"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMetadata"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 通过POST请求将上述参数，发送到 /nacos/v1/ns/instance")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    reqApi"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UtilAndComs.nacosUrlInstance, params, HttpMethod.POST);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[136]||(l[136]=n("p",null,"这里提交的信息就是Nacos服务注册接口需要的完整参数，核心参数有：",-1)),l[137]||(l[137]=n("ul",null,[n("li",null,"namespace_id：环境"),n("li",null,"service_name：服务名称"),n("li",null,"group_name：组名称"),n("li",null,"cluster_name：集群名称"),n("li",null,"ip: 当前实例的ip地址"),n("li",null,"port: 当前实例的端口")],-1)),l[138]||(l[138]=n("p",null,"而在NacosNamingService的registerInstance方法中，有一段是与服务心跳有关的代码，我们在后续会继续学习。",-1)),l[139]||(l[139]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210908141019175.png",alt:"image-20210908141019175",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[140]||(l[140]=n("h4",{id:"_2-2-5-客户端注册的流程图",tabindex:"-1"},[E("2.2.5 客户端注册的流程图 "),n("a",{class:"header-anchor",href:"#_2-2-5-客户端注册的流程图","aria-label":'Permalink to "2.2.5 客户端注册的流程图"'},"​")],-1)),l[141]||(l[141]=n("p",null,"如图：",-1)),l[142]||(l[142]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923185331470.png",alt:"image-20210923185331470",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[143]||(l[143]=n("h3",{id:"_2-3-服务端",tabindex:"-1"},[E("2.3 服务端 "),n("a",{class:"header-anchor",href:"#_2-3-服务端","aria-label":'Permalink to "2.3 服务端"'},"​")],-1)),l[144]||(l[144]=n("p",null,"在nacos-console的模块中，会引入nacos-naming这个模块：",-1)),l[145]||(l[145]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922112801808.png",alt:"image-20210922112801808",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[146]||(l[146]=n("p",null,"模块结构如下：",-1)),l[147]||(l[147]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922112954630.png",alt:"image-20210922112954630",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[148]||(l[148]=n("p",null,[E("其中的com.alibaba.nacos.naming.controllers包下就有服务注册、发现等相关的各种接口，其中的服务注册是在"),n("code",null,"InstanceController"),E("类中：")],-1)),l[149]||(l[149]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922113158618.png",alt:"image-20210922113158618",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[150]||(l[150]=n("h4",{id:"_2-3-1-instancecontroller",tabindex:"-1"},[E("2.3.1 InstanceController "),n("a",{class:"header-anchor",href:"#_2-3-1-instancecontroller","aria-label":'Permalink to "2.3.1 InstanceController"'},"​")],-1)),l[151]||(l[151]=n("p",null,"进入InstanceController类，可以看到一个register方法，就是服务注册的方法了：",-1)),l[152]||(l[152]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CanDistro")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PostMapping")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Secured"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"parser"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingResourceParser.class, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"action"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ActionTypes.WRITE)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"register"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest request) throws Exception {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 尝试获取namespaceId")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String namespaceId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 尝试获取serviceName，其格式为 group_name@@service_name")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String serviceName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"required"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.SERVICE_NAME);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkServiceNameFormat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 解析出实例信息，封装为Instance对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," parseInstance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 注册实例")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    serviceManager."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerInstance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "ok"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[153]||(l[153]=n("p",null,"这里，进入到了serviceManager.registerInstance()方法中。",-1)),l[154]||(l[154]=n("h4",{id:"_2-3-2-servicemanager",tabindex:"-1"},[E("2.3.2 ServiceManager "),n("a",{class:"header-anchor",href:"#_2-3-2-servicemanager","aria-label":'Permalink to "2.3.2 ServiceManager"'},"​")],-1)),l[155]||(l[155]=n("p",null,"ServiceManager就是Nacos中管理服务、实例信息的核心API，其中就包含Nacos的服务注册表：",-1)),l[156]||(l[156]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922141703128.png",alt:"image-20210922141703128",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[157]||(l[157]=n("p",null,"而其中的registerInstance方法就是注册服务实例的方法：",-1)),l[158]||(l[158]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * Register an instance to a service in AP mode.")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * <p>This method creates service or cluster silently if they don't exist.")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," namespaceId"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," id of namespace")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," serviceName"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," service name")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," instance"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    instance to register")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@throws"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Exception"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," any error occurred in the process")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," registerInstance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String namespaceId, String serviceName, Instance instance) throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 创建一个空的service（如果是第一次来注册实例，要先创建一个空service出来，放入注册表）")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 此时不包含实例信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    createEmptyService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 拿到创建好的service")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 拿不到则抛异常")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," NacosException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(NacosException.INVALID_PARAM,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                                 "service not found, namespace: "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," namespaceId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ", service: "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 添加要注册的实例到service中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    addInstance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[159]||(l[159]=n("p",null,"创建好了服务，接下来就要添加实例到服务中：",-1)),l[160]||(l[160]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * Add instance to service.")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," namespaceId"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," namespace")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," serviceName"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," service name")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," ephemeral"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   whether instance is ephemeral")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," ips"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"         instances")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@throws"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," NacosException"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," nacos exception")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addInstance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String namespaceId, String serviceName, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral, Instance... ips)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 监听服务列表用到的key，服务唯一标识，例如：com.alibaba.nacos.naming.iplist.ephemeral.public##DEFAULT_GROUP@@order-service")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," KeyBuilder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildInstanceListKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, ephemeral);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取服务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 同步锁，避免并发修改的安全问题")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    synchronized"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (service) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1）获取要更新的实例列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> instanceList "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addIpAddresses"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service, ephemeral, ips);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 2）封装实例列表到Instances对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Instances instances "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Instances"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instances."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInstanceList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instanceList);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 3）完成 注册表更新 以及 Nacos集群的数据同步")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        consistencyService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, instances);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[161]||(l[161]=n("p",null,"该方法中对修改服务列表的动作加锁处理，确保线程安全。而在同步代码块中，包含下面几步：",-1)),l[162]||(l[162]=n("ul",null,[n("li",null,[E("1）先获取要更新的实例列表，"),n("code",null,"addIpAddresses(service, ephemeral, ips);")]),n("li",null,[E("2）然后将更新后的数据封装到"),n("code",null,"Instances"),E("对象中，后面更新注册表时使用")]),n("li",null,[E("3）最后，调用"),n("code",null,"consistencyService.put()"),E("方法完成Nacos集群的数据同步，保证集群一致性。")])],-1)),l[163]||(l[163]=n("blockquote",null,[n("p",null,"注意：在第1步的addIPAddress中，会拷贝旧的实例列表，添加新实例到列表中。在第3步中，完成对实例状态更新后，则会用新列表直接覆盖旧实例列表。而在更新过程中，旧实例列表不受影响，用户依然可以读取。"),n("p",null,"这样在更新列表状态过程中，无需阻塞用户的读操作，也不会导致用户读取到脏数据，性能比较好。这种方案称为CopyOnWrite方案。")],-1)),l[164]||(l[164]=n("h5",{id:"_1-更服务列表",tabindex:"-1"},[E("1）更服务列表 "),n("a",{class:"header-anchor",href:"#_1-更服务列表","aria-label":'Permalink to "1）更服务列表"'},"​")],-1)),l[165]||(l[165]=n("p",null,[E("我们来看看实例列表的更新，对应的方法是"),n("code",null,"addIpAddresses(service, ephemeral, ips);"),E("：")],-1)),l[166]||(l[166]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Instance"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addIpAddresses"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Service service, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral, Instance... ips) throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," updateIpAddresses"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service, UtilsAndCommons.UPDATE_INSTANCE_ACTION_ADD, ephemeral, ips);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[167]||(l[167]=n("p",null,[E("继续进入"),n("code",null,"updateIpAddresses"),E("方法：")],-1)),l[168]||(l[168]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Instance"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," updateIpAddresses"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Service service, String action, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral, Instance... ips)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 根据namespaceId、serviceName获取当前服务的实例列表，返回值是Datum")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 第一次来，肯定是null")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Datum datum "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," consistencyService")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KeyBuilder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildInstanceListKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNamespaceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), ephemeral));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 得到服务中现有的实例列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> currentIPs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allIPs"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ephemeral);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建map，保存实例列表，key为ip地址，value是Instance对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> currentInstances "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(currentIPs."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建Set集合，保存实例的instanceId")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Set<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> currentInstanceIds "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Sets."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newHashSet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 遍历要现有的实例列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," currentIPs) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 添加到map中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        currentInstances."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toIpAddr"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 添加instanceId到set中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        currentInstanceIds."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建map，用来保存更新后的实例列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> instanceMap;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (datum "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," !="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," datum.value) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果服务中已经有旧的数据，则先保存旧的实例列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instanceMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," setValid"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(((Instances) datum.value)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), currentInstances);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果没有旧数据，则直接创建新的map")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instanceMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(ips.length);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 遍历实例列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ips) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 判断服务中是否包含要注册的实例的cluster信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果不包含，创建新的cluster")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Cluster cluster "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Cluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), service);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            cluster."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"init"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 将集群放入service的注册表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), cluster);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.SRV_LOG")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cluster: {} not found, ip: {}, will create new cluster with default configuration."'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                      instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 删除实例 or 新增实例 ？")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(action)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instanceMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDatumKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 新增实例，instance生成全新的instanceId")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Instance oldInstance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instanceMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDatumKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (oldInstance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInstanceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(oldInstance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInstanceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"generateInstanceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(currentInstanceIds));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 放入instance列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instanceMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDatumKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instanceMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," UtilsAndCommons.UPDATE_INSTANCE_ACTION_ADD."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(action)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," IllegalArgumentException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'            "ip list can not be empty, service: "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ", ip list: "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instanceMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"values"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 将instanceMap中的所有实例转为List返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>(instanceMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"values"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[169]||(l[169]=n("p",null,"简单来讲，就是先获取旧的实例列表，然后把新的实例信息与旧的做对比，新的实例就添加，老的实例同步ID。然后返回最新的实例列表。",-1)),l[170]||(l[170]=n("h5",{id:"_2-nacos集群一致性",tabindex:"-1"},[E("2）Nacos集群一致性 "),n("a",{class:"header-anchor",href:"#_2-nacos集群一致性","aria-label":'Permalink to "2）Nacos集群一致性"'},"​")],-1)),l[171]||(l[171]=n("p",null,"在完成本地服务列表更新后，Nacos又实现了集群一致性更新，调用的是:",-1)),l[172]||(l[172]=n("p",null,[n("code",null,"consistencyService.put(key, instances);")],-1)),l[173]||(l[173]=n("p",null,"这里的ConsistencyService接口，代表集群一致性的接口，有很多中不同实现：",-1)),l[174]||(l[174]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922161705573.png",alt:"image-20210922161705573",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[175]||(l[175]=n("p",null,"我们进入DelegateConsistencyServiceImpl来看：",-1)),l[176]||(l[176]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key, Record value) throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 根据实例是否是临时实例，判断委托对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    mapConsistencyService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, value);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[177]||(l[177]=n("p",null,[E("其中的"),n("code",null,"mapConsistencyService(key)"),E("方法就是选择委托方式的：")],-1)),l[178]||(l[178]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ConsistencyService "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mapConsistencyService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断是否是临时实例：")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 是，选择 ephemeralConsistencyService，也就是 DistroConsistencyServiceImpl类")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 否，选择 persistentConsistencyService，也就是PersistentConsistencyServiceDelegateImpl")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," KeyBuilder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"matchEphemeralKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeralConsistencyService "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," persistentConsistencyService;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[179]||(l[179]=n("p",null,"默认情况下，所有实例都是临时实例，我们关注DistroConsistencyServiceImpl即可。",-1)),l[180]||(l[180]=n("h4",{id:"_2-3-4-distroconsistencyserviceimpl",tabindex:"-1"},[E("2.3.4 DistroConsistencyServiceImpl "),n("a",{class:"header-anchor",href:"#_2-3-4-distroconsistencyserviceimpl","aria-label":'Permalink to "2.3.4 DistroConsistencyServiceImpl"'},"​")],-1)),l[181]||(l[181]=n("p",null,"我们来看临时实例的一致性实现：DistroConsistencyServiceImpl类的put方法：",-1)),l[182]||(l[182]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key, Record value) throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 先将要更新的实例信息写入本地实例列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    onPut"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, value);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 开始集群同步")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    distroProtocol."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sync"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DistroKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, KeyBuilder.INSTANCE_LIST_KEY_PREFIX), DataOperation.CHANGE,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        globalConfig."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTaskDispatchPeriod"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[183]||(l[183]=n("p",null,"这里方法只有两行：",-1)),l[184]||(l[184]=n("ul",null,[n("li",null,[n("code",null,"onPut(key, value)"),E("：其中value就是Instances，要更新的服务信息。这行主要是基于线程池方式，异步的将Service信息写入注册表中(就是那个多重Map)")]),n("li",null,[n("code",null,"distroProtocol.sync()"),E("：就是通过Distro协议将数据同步给集群中的其它Nacos节点")])],-1)),l[185]||(l[185]=n("p",null,"我们先看onPut方法",-1)),l[186]||(l[186]=n("h5",{id:"_2-3-4-1-更新本地实例列表",tabindex:"-1"},[E("2.3.4.1 更新本地实例列表 "),n("a",{class:"header-anchor",href:"#_2-3-4-1-更新本地实例列表","aria-label":'Permalink to "2.3.4.1 更新本地实例列表"'},"​")],-1)),l[187]||(l[187]=n("h6",{id:"_1-放入阻塞队列",tabindex:"-1"},[E("1）放入阻塞队列 "),n("a",{class:"header-anchor",href:"#_1-放入阻塞队列","aria-label":'Permalink to "1）放入阻塞队列"'},"​")],-1)),l[188]||(l[188]=n("p",null,"onPut方法如下：",-1)),l[189]||(l[189]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," onPut"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key, Record value) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 判断是否是临时实例")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (KeyBuilder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"matchEphemeralInstanceListKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 封装 Instances 信息到 数据集：Datum")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Datum<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instances"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> datum "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Datum<>();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        datum.value "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instances) value;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        datum.key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," key;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        datum.timestamp."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"incrementAndGet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入DataStore")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        dataStore."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, datum);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"listeners."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 放入阻塞队列，这里的 notifier维护了一个阻塞队列，并且基于线程池异步执行队列中的任务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    notifier."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, DataOperation.CHANGE);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[190]||(l[190]=n("p",null,[E("notifier的类型就是"),n("code",null,"DistroConsistencyServiceImpl.Notifier"),E("，内部维护了一个阻塞队列，存放服务列表变更的事件：")],-1)),l[191]||(l[191]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922180246555.png",alt:"image-20210922180246555",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[192]||(l[192]=n("p",null,"addTask时，将任务加入该阻塞队列：",-1)),l[193]||(l[193]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// DistroConsistencyServiceImpl.Notifier类的 addTask 方法：")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String datumKey, DataOperation action) {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (services."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," action "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DataOperation.CHANGE) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (action "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DataOperation.CHANGE) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        services."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey, StringUtils.EMPTY);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 任务放入阻塞队列")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    tasks."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"offer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Pair."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"with"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey, action));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[194]||(l[194]=n("h6",{id:"_2-notifier异步更新",tabindex:"-1"},[E("2）Notifier异步更新 "),n("a",{class:"header-anchor",href:"#_2-notifier异步更新","aria-label":'Permalink to "2）Notifier异步更新"'},"​")],-1)),l[195]||(l[195]=n("p",null,"同时，notifier还是一个Runnable，通过一个单线程的线程池来不断从阻塞队列中获取任务，执行服务列表的更新。来看下其中的run方法：",-1)),l[196]||(l[196]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// DistroConsistencyServiceImpl.Notifier类的run方法：")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Loggers.DISTRO."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"distro notifier started"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 死循环，不断执行任务。因为是阻塞队列，不会导致CPU负载过高")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (; ; ) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 从阻塞队列中获取任务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Pair<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"DataOperation"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> pair "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tasks."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"take"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 处理任务，更新服务列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            handle"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pair);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.DISTRO."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DISTRO] Error while handling notifying task"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[197]||(l[197]=n("p",null,"来看看handle方法：",-1)),l[198]||(l[198]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// DistroConsistencyServiceImpl.Notifier类的 handle 方法：")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," handle"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Pair"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"String, DataOperation"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pair) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String datumKey "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pair."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        DataOperation action "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pair."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        services."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," count "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"listeners."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 遍历，找到变化的service，这里的 RecordListener就是 Service")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (RecordListener listener "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," listeners."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey)) {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            count"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"++"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 服务的实例列表CHANGE事件")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (action "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DataOperation.CHANGE) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                    // 更新服务列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    listener."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"onChange"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey, dataStore."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey).value);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    continue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t\t// 服务的实例列表 DELETE 事件")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (action "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," DataOperation.DELETE) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    listener."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"onDelete"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(datumKey);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    continue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Loggers.DISTRO."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DISTRO] error while notifying listener of key: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", datumKey, e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Loggers.DISTRO."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.DISTRO")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DISTRO] datum change notified, key: {}, listener count: {}, action: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                       datumKey, count, action."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"name"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.DISTRO."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DISTRO] Error while handling notifying task"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[199]||(l[199]=n("h6",{id:"_3-覆盖实例列表",tabindex:"-1"},[E("3）覆盖实例列表 "),n("a",{class:"header-anchor",href:"#_3-覆盖实例列表","aria-label":'Permalink to "3）覆盖实例列表"'},"​")],-1)),l[200]||(l[200]=n("p",null,"而在Service的onChange方法中，就可以看到更新实例列表的逻辑了：",-1)),l[201]||(l[201]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," onChange"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String key, Instances value) throws Exception {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-RAFT] datum is changed, key: {}, value: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", key, value);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 更新实例列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    updateIPs"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(value."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), KeyBuilder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"matchEphemeralInstanceListKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key));")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    recalculateChecksum"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[202]||(l[202]=n("p",null,"updateIPs方法：",-1)),l[203]||(l[203]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," updateIPs"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Collection"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Instance"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instances, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 准备一个Map，key是cluster，值是集群下的Instance集合")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> ipMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(clusterMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取服务的所有cluster名称")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (String clusterName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clusterMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"keySet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ipMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterName, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<>());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 遍历要更新的实例")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instances) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DOM] received malformed ip: null"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                continue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 判断实例是否包含clusterName，没有的话用默认cluster")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UtilsAndCommons.DEFAULT_CLUSTER_NAME);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 判断cluster是否存在，不存在则创建新的cluster")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"clusterMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Loggers.SRV_LOG")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cluster: {} not found, ip: {}, will create new cluster with default configuration."'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                          instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Cluster cluster "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Cluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                cluster."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"init"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                getClusterMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), cluster);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 获取当前cluster实例的集合，不存在则创建新的")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> clusterIPs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ipMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clusterIPs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                clusterIPs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LinkedList<>();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ipMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), clusterIPs);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 添加新的实例到 Instance 集合")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            clusterIPs."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-DOM] failed to process ip: "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance, e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Map.Entry<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ipMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entrySet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        //make every ip mine")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> entryIPs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 将实例集合更新到 clusterMap（注册表）")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clusterMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"updateIps"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(entryIPs, ephemeral);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    setLastModifiedMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发布服务变更的通知消息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    getPushService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"serviceChanged"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    StringBuilder stringBuilder "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," StringBuilder"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," allIPs"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        stringBuilder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"append"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toIpAddr"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"append"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"_"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"append"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isHealthy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"append"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Loggers.EVT_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[IP-UPDATED] namespace: {}, service: {}, ips: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNamespaceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                         stringBuilder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[204]||(l[204]=n("p",null,[E("在第45行的代码中："),n("code",null,"clusterMap.get(entry.getKey()).updateIps(entryIPs, ephemeral);")],-1)),l[205]||(l[205]=n("p",null,"就是在更新注册表：",-1)),l[206]||(l[206]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," updateIps"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(List"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Instance"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ips, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取旧实例列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Set<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> toUpdateInstances "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeral "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ephemeralInstances "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," persistentInstances;")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    HashMap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> oldIpMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<>(toUpdateInstances."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance ip "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," toUpdateInstances) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        oldIpMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDatumKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), ip);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 检查新加入实例的状态")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> newIPs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," subtract"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ips, oldIpMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"values"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (newIPs."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.EVT_LOG")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"{} {SYNC} {IP-NEW} cluster: {}, new ips size: {}, content: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                  getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), newIPs."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), newIPs."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance ip "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," newIPs) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            HealthCheckStatus."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"reset"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 移除要删除的实例")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> deadIPs "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," subtract"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(oldIpMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"values"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), ips);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (deadIPs."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.EVT_LOG")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"{} {SYNC} {IP-DEAD} cluster: {}, dead ips size: {}, content: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                  getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), deadIPs."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), deadIPs."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance ip "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," deadIPs) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            HealthCheckStatus."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remv"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    toUpdateInstances "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashSet<>(ips);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 直接覆盖旧实例列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (ephemeral) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ephemeralInstances "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," toUpdateInstances;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        persistentInstances "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," toUpdateInstances;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[207]||(l[207]=n("h5",{id:"_2-3-4-2-集群数据同步",tabindex:"-1"},[E("2.3.4.2 集群数据同步 "),n("a",{class:"header-anchor",href:"#_2-3-4-2-集群数据同步","aria-label":'Permalink to "2.3.4.2 集群数据同步"'},"​")],-1)),l[208]||(l[208]=n("p",null,"在DistroConsistencyServiceImpl的put方法中分为两步：",-1)),l[209]||(l[209]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922195603450.png",alt:"image-20210922195603450",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[210]||(l[210]=n("p",null,"其中的onPut方法已经分析过了。",-1)),l[211]||(l[211]=n("p",null,"下面的distroProtocol.sync()就是集群同步的逻辑了。",-1)),l[212]||(l[212]=n("p",null,"DistroProtocol类的sync方法如下：",-1)),l[213]||(l[213]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," sync"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(DistroKey distroKey, DataOperation action, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," delay) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 遍历 Nacos 集群中除自己以外的其它节点")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Member each "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," memberManager."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allMembersWithoutSelf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        DistroKey distroKeyWithTarget "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DistroKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(distroKey."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getResourceKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), distroKey."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getResourceType"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                                      each."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAddress"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 定义一个Distro的同步任务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        DistroDelayTask distroDelayTask "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DistroDelayTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(distroKeyWithTarget, action, delay);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 交给线程池去执行")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        distroTaskEngineHolder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDelayTaskExecuteEngine"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(distroKeyWithTarget, distroDelayTask);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Loggers.DISTRO."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.DISTRO."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[DISTRO-SCHEDULE] {} to {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", distroKey, each."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAddress"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[214]||(l[214]=n("p",null,[E("其中同步的任务封装为一个"),n("code",null,"DistroDelayTask"),E("对象。")],-1)),l[215]||(l[215]=n("p",null,[E("交给了"),n("code",null,"distroTaskEngineHolder.getDelayTaskExecuteEngine()"),E("执行，这行代码的返回值是：")],-1)),l[216]||(l[216]=n("p",null,[n("code",null,"NacosDelayTaskExecuteEngine"),E("，这个类维护了一个线程池，并且接收任务，执行任务。")],-1)),l[217]||(l[217]=n("p",null,"执行任务的方法为processTasks()方法：",-1)),l[218]||(l[218]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"protected"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," processTasks"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Collection<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> keys "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getAllTaskKeys"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Object taskKey "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," keys) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        AbstractDelayTask task "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," removeTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskKey);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," =="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," task) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            continue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NacosTaskProcessor processor "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getProcessor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskKey);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," =="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," processor) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            getEngineLog"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"processor not found for task, so discarded. "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," task);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            continue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 尝试执行同步任务，如果失败会重试")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"processor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"process"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(task)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                retryFailedTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskKey, task);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            getEngineLog"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Nacos task execute error : "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            retryFailedTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(taskKey, task);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[219]||(l[219]=n("p",null,"可以看出来基于Distro模式的同步是异步进行的，并且失败时会将任务重新入队并充实，因此不保证同步结果的强一致性，属于AP模式的一致性策略。",-1)),l[220]||(l[220]=n("h4",{id:"_2-3-5-服务端流程图",tabindex:"-1"},[E("2.3.5 服务端流程图 "),n("a",{class:"header-anchor",href:"#_2-3-5-服务端流程图","aria-label":'Permalink to "2.3.5 服务端流程图"'},"​")],-1)),l[221]||(l[221]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923214042926.png",alt:"image-20210923214042926",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[222]||(l[222]=n("h3",{id:"_2-4-总结",tabindex:"-1"},[E("2.4 总结 "),n("a",{class:"header-anchor",href:"#_2-4-总结","aria-label":'Permalink to "2.4 总结"'},"​")],-1)),l[223]||(l[223]=n("blockquote",null,[n("ul",null,[n("li",null,[n("p",null,"Nacos的注册表结构是什么样的？"),n("ul",null,[n("li",null,[n("p",null,"答：Nacos是多级存储模型，最外层通过namespace来实现环境隔离，然后是group分组，分组下就是服务，一个服务有可以分为不同的集群，集群中包含多个实例。因此其注册表结构为一个Map，类型是："),n("p",null,[n("code",null,"Map<String, Map<String, Service>>"),E("，")]),n("p",null,[E("外层key是"),n("code",null,"namespace_id"),E("，内层key是"),n("code",null,"group+serviceName"),E(".")]),n("p",null,[E("Service内部维护一个Map，结构是："),n("code",null,"Map<String,Cluster>"),E("，key是clusterName，值是集群信息")]),n("p",null,"Cluster内部维护一个Set集合，元素是Instance类型，代表集群中的多个实例。")])])]),n("li",null,[n("p",null,"Nacos如何保证并发写的安全性？"),n("ul",null,[n("li",null,"答：首先，在注册实例时，会对service加锁，不同service之间本身就不存在并发写问题，互不影响。相同service时通过锁来互斥。并且，在更新实例列表时，是基于异步的线程池来完成，而线程池的线程数量为1.")])]),n("li",null,[n("p",null,"Nacos如何避免并发读写的冲突？"),n("ul",null,[n("li",null,"答：Nacos在更新实例列表时，会采用CopyOnWrite技术，首先将Old实例列表拷贝一份，然后更新拷贝的实例列表，再用更新后的实例列表来覆盖旧的实例列表。")])]),n("li",null,[n("p",null,"Nacos如何应对阿里内部数十万服务的并发写请求？"),n("ul",null,[n("li",null,"答：Nacos内部会将服务注册的任务放入阻塞队列，采用线程池异步来完成实例更新，从而提高并发写能力。")])])])],-1)),l[224]||(l[224]=n("hr",null,null,-1)),l[225]||(l[225]=n("h2",{id:"_3-服务心跳",tabindex:"-1"},[E("3. 服务心跳 "),n("a",{class:"header-anchor",href:"#_3-服务心跳","aria-label":'Permalink to "3. 服务心跳"'},"​")],-1)),l[226]||(l[226]=n("p",null,"Nacos的实例分为临时实例和永久实例两种，可以通过在yaml 文件配置：",-1)),l[227]||(l[227]=n("div",{class:"language-yaml max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"yaml"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"spring"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  application"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    name"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"order-service")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    nacos"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      discovery"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        ephemeral"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # 设置实例为永久实例。true：临时; false：永久")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      server-addr"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"192.168.150.1:8845")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[228]||(l[228]=n("p",null,"临时实例基于心跳方式做健康检测，而永久实例则是由Nacos主动探测实例状态。",-1)),l[229]||(l[229]=n("p",null,"其中Nacos提供的心跳的API接口为：",-1)),l[230]||(l[230]=n("p",null,[n("strong",null,"接口描述"),E("：发送某个实例的心跳")],-1)),l[231]||(l[231]=n("p",null,[n("strong",null,"请求类型"),E("：PUT")],-1)),l[232]||(l[232]=n("p",null,[n("strong",null,"请求路径"),E("：")],-1)),l[233]||(l[233]=n("div",{class:"language-plain max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"plain"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"/nacos/v1/ns/instance/beat")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[234]||(l[234]=n("p",null,[n("strong",null,"请求参数"),E("：")],-1)),l[235]||(l[235]=n("table",null,[n("thead",null,[n("tr",null,[n("th",{style:{"text-align":"left"}},"名称"),n("th",{style:{"text-align":"left"}},"类型"),n("th",{style:{"text-align":"left"}},"是否必选"),n("th",null,"描述")])]),n("tbody",null,[n("tr",null,[n("td",{style:{"text-align":"left"}},"serviceName"),n("td",{style:{"text-align":"left"}},"字符串"),n("td",{style:{"text-align":"left"}},"是"),n("td",null,"服务名")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"groupName"),n("td",{style:{"text-align":"left"}},"字符串"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"分组名")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"ephemeral"),n("td",{style:{"text-align":"left"}},"boolean"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"是否临时实例")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"beat"),n("td",{style:{"text-align":"left"}},"JSON格式字符串"),n("td",{style:{"text-align":"left"}},"是"),n("td",null,"实例心跳内容")])])],-1)),l[236]||(l[236]=n("p",null,[n("strong",null,"错误编码"),E("：")],-1)),l[237]||(l[237]=n("table",null,[n("thead",null,[n("tr",null,[n("th",{style:{"text-align":"left"}},"错误代码"),n("th",{style:{"text-align":"left"}},"描述"),n("th",{style:{"text-align":"left"}},"语义")])]),n("tbody",null,[n("tr",null,[n("td",{style:{"text-align":"left"}},"400"),n("td",{style:{"text-align":"left"}},"Bad Request"),n("td",{style:{"text-align":"left"}},"客户端请求中的语法错误")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"403"),n("td",{style:{"text-align":"left"}},"Forbidden"),n("td",{style:{"text-align":"left"}},"没有权限")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"404"),n("td",{style:{"text-align":"left"}},"Not Found"),n("td",{style:{"text-align":"left"}},"无法找到资源")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"500"),n("td",{style:{"text-align":"left"}},"Internal Server Error"),n("td",{style:{"text-align":"left"}},"服务器内部错误")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"200"),n("td",{style:{"text-align":"left"}},"OK"),n("td",{style:{"text-align":"left"}},"正常")])])],-1)),l[238]||(l[238]=n("h3",{id:"_3-1-客户端",tabindex:"-1"},[E("3.1 客户端 "),n("a",{class:"header-anchor",href:"#_3-1-客户端","aria-label":'Permalink to "3.1 客户端"'},"​")],-1)),l[239]||(l[239]=n("p",null,"在2.2.4.服务注册这一节中，我们说过NacosNamingService这个类实现了服务的注册，同时也实现了服务心跳：",-1)),l[240]||(l[240]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," registerInstance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String groupName, Instance instance) throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkInstanceIsLegal"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String groupedServiceName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupedName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, groupName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断是否是临时实例。")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果是临时实例，则构建心跳信息BeatInfo")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        BeatInfo beatInfo "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beatReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildBeatInfo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 添加心跳任务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        beatReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addBeatInfo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, beatInfo);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    serverProxy."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(groupedServiceName, groupName, instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[241]||(l[241]=n("h4",{id:"_3-1-1-beatinfo",tabindex:"-1"},[E("3.1.1 BeatInfo "),n("a",{class:"header-anchor",href:"#_3-1-1-beatinfo","aria-label":'Permalink to "3.1.1 BeatInfo"'},"​")],-1)),l[242]||(l[242]=n("p",null,"这里的BeanInfo就包含心跳需要的各种信息：",-1)),l[243]||(l[243]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922213313677.png",alt:"image-20210922213313677",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[244]||(l[244]=n("h4",{id:"_3-1-2-beatreactor",tabindex:"-1"},[E("3.1.2 BeatReactor "),n("a",{class:"header-anchor",href:"#_3-1-2-beatreactor","aria-label":'Permalink to "3.1.2 BeatReactor"'},"​")],-1)),l[245]||(l[245]=n("p",null,[E("而"),n("code",null,"BeatReactor"),E("这个类则维护了一个线程池：")],-1)),l[246]||(l[246]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922213455549.png",alt:"image-20210922213455549",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[247]||(l[247]=n("p",null,[E("当调用"),n("code",null,"BeatReactor"),E("的"),n("code",null,".addBeatInfo(groupedServiceName, beatInfo)"),E("方法时，就会执行心跳：")],-1)),l[248]||(l[248]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," addBeatInfo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, BeatInfo beatInfo) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NAMING_LOGGER."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[BEAT] adding beat: {} to beat map."'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", beatInfo);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," buildKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    BeatInfo existBeat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    //fix #1733")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ((existBeat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," dom2Beat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key)) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        existBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStopped"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    dom2Beat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key, beatInfo);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 利用线程池，定期执行心跳任务，周期为 beatInfo.getPeriod()")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    executorService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"schedule"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BeatTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo), beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPeriod"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), TimeUnit.MILLISECONDS);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    MetricsMonitor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDom2BeatSizeMonitor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"set"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(dom2Beat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[249]||(l[249]=n("p",null,[E("心跳周期的默认值在"),n("code",null,"com.alibaba.nacos.api.common.Constants"),E("类中：")],-1)),l[250]||(l[250]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922213829632.png",alt:"image-20210922213829632",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[251]||(l[251]=n("p",null,"可以看到是5秒，默认5秒一次心跳。",-1)),l[252]||(l[252]=n("h4",{id:"_3-1-3-beattask",tabindex:"-1"},[E("3.1.3 BeatTask "),n("a",{class:"header-anchor",href:"#_3-1-3-beattask","aria-label":'Permalink to "3.1.3 BeatTask"'},"​")],-1)),l[253]||(l[253]=n("p",null,[E("心跳的任务封装在"),n("code",null,"BeatTask"),E("这个类中，是一个Runnable，其run方法如下：")],-1)),l[254]||(l[254]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isStopped"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取心跳周期")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," nextTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPeriod"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 发送心跳")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        JsonNode result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serverProxy."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sendBeat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo, BeatReactor.this.lightBeatEnabled);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," interval "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clientBeatInterval"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"asLong"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lightBeatEnabled "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"has"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.LIGHT_BEAT_ENABLED)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            lightBeatEnabled "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.LIGHT_BEAT_ENABLED)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"asBoolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        BeatReactor.this.lightBeatEnabled "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lightBeatEnabled;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (interval "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            nextTime "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," interval;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 判断心跳结果")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," code "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingResponseCode.OK;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"has"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CODE)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            code "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CODE)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"asInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (code "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingResponseCode.RESOURCE_NOT_FOUND) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 如果失败，则需要 重新注册实例")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setWeight"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWeight"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMetadata"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMetadata"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setServiceName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInstanceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setEphemeral"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                serverProxy."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                            NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()), instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"ignore"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (NacosException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"ex"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NAMING_LOGGER."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] failed to send beat: {}, code: {}, msg: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo), ex."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getErrCode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), ex."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getErrMsg"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"unknownEx"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NAMING_LOGGER."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] failed to send beat: {}, unknown exception msg: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo), unknownEx."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessage"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), unknownEx);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        executorService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"schedule"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BeatTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo), nextTime, TimeUnit.MILLISECONDS);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[255]||(l[255]=n("h4",{id:"_3-1-4-发送心跳",tabindex:"-1"},[E("3.1.4 发送心跳 "),n("a",{class:"header-anchor",href:"#_3-1-4-发送心跳","aria-label":'Permalink to "3.1.4 发送心跳"'},"​")],-1)),l[256]||(l[256]=n("p",null,[E("最终心跳的发送还是通过"),n("code",null,"NamingProxy"),E("的"),n("code",null,"sendBeat"),E("方法来实现：")],-1)),l[257]||(l[257]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JsonNode "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sendBeat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(BeatInfo beatInfo, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," lightBeatEnabled) throws NacosException {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (NAMING_LOGGER."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NAMING_LOGGER."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[BEAT] {} sending beat to server: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", namespaceId, beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 组织请求参数")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> params "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> bodyMap "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"lightBeatEnabled) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        bodyMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"beat"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.NAMESPACE_ID, namespaceId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.SERVICE_NAME, beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CLUSTER_NAME, beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ip"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"port"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beatInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 发送请求，这个地址就是：/v1/ns/instance/beat")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," reqApi"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UtilAndComs.nacosUrlBase "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/instance/beat"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", params, bodyMap, HttpMethod.PUT);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toObj"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(result);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[258]||(l[258]=n("h3",{id:"_3-2-服务端",tabindex:"-1"},[E("3.2 服务端 "),n("a",{class:"header-anchor",href:"#_3-2-服务端","aria-label":'Permalink to "3.2 服务端"'},"​")],-1)),l[259]||(l[259]=n("p",null,"对于临时实例，服务端代码分两部分：",-1)),l[260]||(l[260]=n("ul",null,[n("li",null,"1）InstanceController提供了一个接口，处理客户端的心跳请求"),n("li",null,"2）定时检测实例心跳是否按期执行")],-1)),l[261]||(l[261]=n("h4",{id:"_3-2-1-instancecontroller",tabindex:"-1"},[E("3.2.1 InstanceController "),n("a",{class:"header-anchor",href:"#_3-2-1-instancecontroller","aria-label":'Permalink to "3.2.1 InstanceController"'},"​")],-1)),l[262]||(l[262]=n("p",null,"与服务注册时一样，在nacos-naming模块中的InstanceController类中，定义了一个方法用来处理心跳请求：",-1)),l[263]||(l[263]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"CanDistro")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"PutMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/beat"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Secured"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"parser"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingResourceParser.class, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"action"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ActionTypes.WRITE)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectNode "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"beat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest request) throws Exception {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 解析心跳的请求参数")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ObjectNode result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createEmptyJsonNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SwitchEntry.CLIENT_BEAT_INTERVAL, switchDomain."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClientBeatInterval"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String beat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"beat"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    RsInfo clientBeat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotBlank"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clientBeat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toObj"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat, RsInfo.class);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String clusterName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.CLUSTER_NAME, UtilsAndCommons.DEFAULT_CLUSTER_NAME);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String ip "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ip"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," port "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"port"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"0"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clientBeat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotBlank"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            clusterName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // fix #2533")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ip "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        port "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String namespaceId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String serviceName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"required"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.SERVICE_NAME);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkServiceNameFormat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] full arguments: beat: {}, serviceName: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clientBeat, serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 尝试根据参数中的namespaceId、serviceName、clusterName、ip、port等信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 从Nacos的注册表中 获取实例")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceManager."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, clusterName, ip, port);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 如果获取失败，说明心跳失败，实例尚未注册")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clientBeat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CODE, NamingResponseCode.RESOURCE_NOT_FOUND);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] The instance has been removed for health mechanism, "')]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                             +"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "perform data compensation operations, beat: {}, serviceName: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clientBeat, serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 这里重新注册一个实例")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setWeight"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getWeight"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setMetadata"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMetadata"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setClusterName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setServiceName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setInstanceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setEphemeral"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEphemeral"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceManager."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"registerInstance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 尝试基于namespaceId和serviceName从 注册表中获取Service服务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceManager."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 如果不存在，说明服务不存在，返回404")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        throw"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," NacosException"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(NacosException.SERVER_ERROR,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                                 "service not found: "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "@"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," namespaceId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clientBeat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clientBeat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," RsInfo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(port);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        clientBeat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setCluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果心跳没问题，开始处理心跳结果")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"processClientBeat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeat);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.CODE, NamingResponseCode.OK);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsMetadata"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(PreservedMetadataKeys.HEART_BEAT_INTERVAL)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SwitchEntry.CLIENT_BEAT_INTERVAL, instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceHeartBeatInterval"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(SwitchEntry.LIGHT_BEAT_ENABLED, switchDomain."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isLightBeatEnabled"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[264]||(l[264]=n("p",null,"最终，在确认心跳请求对应的服务、实例都在的情况下，开始交给Service类处理这次心跳请求。调用了Service的processClientBeat方法",-1)),l[265]||(l[265]=n("h4",{id:"_3-2-2-处理心跳请求",tabindex:"-1"},[E("3.2.2 处理心跳请求 "),n("a",{class:"header-anchor",href:"#_3-2-2-处理心跳请求","aria-label":'Permalink to "3.2.2 处理心跳请求"'},"​")],-1)),l[266]||(l[266]=n("p",null,[E("查看"),n("code",null,"Service"),E("的"),n("code",null,"service.processClientBeat(clientBeat);"),E("方法：")],-1)),l[267]||(l[267]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," processClientBeat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," RsInfo rsInfo) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ClientBeatProcessor clientBeatProcessor "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ClientBeatProcessor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    clientBeatProcessor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    clientBeatProcessor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setRsInfo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(rsInfo);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    HealthCheckReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleNow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeatProcessor);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[268]||(l[268]=n("p",null,"可以看到心跳信息被封装到了 ClientBeatProcessor类中，交给了HealthCheckReactor处理，HealthCheckReactor就是对线程池的封装，不用过多查看。",-1)),l[269]||(l[269]=n("p",null,"关键的业务逻辑都在ClientBeatProcessor这个类中，它是一个Runnable，其中的run方法如下：",-1)),l[270]||(l[270]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".service;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Loggers.EVT_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.EVT_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] processing beat: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", rsInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String ip "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rsInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String clusterName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rsInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," port "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," rsInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取集群信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Cluster cluster "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusterName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取集群中的所有实例信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> instances "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cluster."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allIPs"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instances) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 找到心跳的这个实例")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," port) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Loggers.EVT_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Loggers.EVT_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[CLIENT-BEAT] refresh beat: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", rsInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 更新实例的最后一次心跳时间 lastBeat")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setLastBeat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isMarked"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isHealthy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHealthy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    Loggers.EVT_LOG")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"service: {} {POS} {IP-ENABLED} valid: {}:{}@{}, region: {}, msg: client beat ok"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                              cluster."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), ip, port, cluster."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                              UtilsAndCommons.LOCALHOST_SITE);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                    getPushService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"serviceChanged"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[271]||(l[271]=n("p",null,"处理心跳请求的核心就是更新心跳实例的最后一次心跳时间，lastBeat，这个会成为判断实例心跳是否过期的关键指标！",-1)),l[272]||(l[272]=n("h4",{id:"_3-3-3-心跳异常检测",tabindex:"-1"},[E("3.3.3 心跳异常检测 "),n("a",{class:"header-anchor",href:"#_3-3-3-心跳异常检测","aria-label":'Permalink to "3.3.3 心跳异常检测"'},"​")],-1)),l[273]||(l[273]=n("p",null,[E("在服务注册时，一定会创建一个"),n("code",null,"Service"),E("对象，而"),n("code",null,"Service"),E("中有一个"),n("code",null,"init"),E("方法，会在注册时被调用：")],-1)),l[274]||(l[274]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," init"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 开启心跳检测的任务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    HealthCheckReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleCheck"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeatCheckTask);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Map.Entry<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Cluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clusterMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entrySet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"init"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[275]||(l[275]=n("p",null,"其中HealthCheckReactor.scheduleCheck就是执行心跳检测的定时任务：",-1)),l[276]||(l[276]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922221022107.png",alt:"image-20210922221022107",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[277]||(l[277]=n("p",null,"可以看到，该任务是5000ms执行一次，也就是5秒对实例的心跳状态做一次检测。",-1)),l[278]||(l[278]=n("p",null,"此处的ClientBeatCheckTask同样是一个Runnable，其中的run方法为：",-1)),l[279]||(l[279]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 找到所有临时实例的列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> instances "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allIPs"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // first set health status of instances:")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instances) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 判断 心跳间隔（当前时间 - 最后一次心跳时间） 是否大于 心跳超时时间，默认15秒")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastBeat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getInstanceHeartBeatTimeOut"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isMarked"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isHealthy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        // 如果超时，标记实例为不健康 healthy = false")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setHealthy"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                        // 发布实例状态变更的事件")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                        getPushService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"serviceChanged"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        ApplicationUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"publishEvent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InstanceHeartbeatTimeoutEvent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", instance));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGlobalConfig"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isExpireInstance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // then remove obsolete instances:")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instances) {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isMarked"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                continue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"           // 判断心跳间隔（当前时间 - 最后一次心跳时间）是否大于 实例被删除的最长超时时间，默认30秒")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastBeat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIpDeleteTimeout"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 如果是超过了30秒，则删除实例")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[AUTO-DELETE-IP] service: {}, ip: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                     JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"                deleteIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Exception while processing client beat time out."'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[280]||(l[280]=n("p",null,[E("其中的超时时间同样是在"),n("code",null,"com.alibaba.nacos.api.common.Constants"),E("这个类中：")],-1)),l[281]||(l[281]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210922221344417.png",alt:"image-20210922221344417",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[282]||(l[282]=n("h4",{id:"_3-3-4-主动健康检测",tabindex:"-1"},[E("3.3.4 主动健康检测 "),n("a",{class:"header-anchor",href:"#_3-3-4-主动健康检测","aria-label":'Permalink to "3.3.4 主动健康检测"'},"​")],-1)),l[283]||(l[283]=n("p",null,"对于非临时实例（ephemeral=false)，Nacos会采用主动的健康检测，定时向实例发送请求，根据响应来判断实例健康状态。",-1)),l[284]||(l[284]=n("p",null,[E("入口在2.3.2小节的"),n("code",null,"ServiceManager"),E("类中的registerInstance方法：")],-1)),l[285]||(l[285]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923100740065.png",alt:"image-20210923100740065",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[286]||(l[286]=n("p",null,"创建空服务时：",-1)),l[287]||(l[287]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createEmptyService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String namespaceId, String serviceName, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," local) throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果服务不存在，创建新的服务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    createServiceIfAbsent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, local, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[288]||(l[288]=n("p",null,"创建服务流程：",-1)),l[289]||(l[289]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," createServiceIfAbsent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String namespaceId, String serviceName, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," local, Cluster cluster)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 尝试获取服务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 发现服务不存在，开始创建新服务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"creating empty service {}:{}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", namespaceId, serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Service"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setNamespaceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setGroupName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // now validate the service. if failed, exception will be thrown")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setLastModifiedMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"recalculateChecksum"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (cluster "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            cluster."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusterMap"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cluster."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), cluster);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"validate"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// ** 写入注册表并初始化 **")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        putServiceAndInit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"local) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            addOrReplaceService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[290]||(l[290]=n("p",null,[E("关键在"),n("code",null,"putServiceAndInit(service)"),E("方法中：")],-1)),l[291]||(l[291]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," putServiceAndInit"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Service service) throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 将服务写入注册表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    putService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNamespaceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 完成服务的初始化")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"init"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    consistencyService")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"listen"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KeyBuilder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildInstanceListKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNamespaceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"), service);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    consistencyService")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"listen"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(KeyBuilder."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"buildInstanceListKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getNamespaceId"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"), service);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NEW-SERVICE] {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[292]||(l[292]=n("p",null,[E("进入初始化逻辑："),n("code",null,"service.init()"),E("，这个会进入Service类中：")],-1)),l[293]||(l[293]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * Init service.")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," init"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 开启临时实例的心跳监测任务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    HealthCheckReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleCheck"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientBeatCheckTask);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 遍历注册表中的集群")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Map.Entry<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Cluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> entry "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clusterMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"entrySet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 完成集群初识化")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        entry."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getValue"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"init"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[294]||(l[294]=n("p",null,[E("这里集群的初始化"),n("code",null," entry.getValue().init();"),E("会进入"),n("code",null,"Cluster"),E("类型的"),n("code",null,"init()"),E("方法：")],-1)),l[295]||(l[295]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * Init cluster.")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," init"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (inited) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 创建健康检测的任务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    checkTask "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," HealthCheckTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 这里会开启对 非临时实例的 定时健康检测")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    HealthCheckReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleCheck"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(checkTask);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    inited "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[296]||(l[296]=n("p",null,[E("这里的"),n("code",null,"HealthCheckReactor.scheduleCheck(checkTask);"),E("会开启定时任务，对非临时实例做健康检测。检测逻辑定义在"),n("code",null,"HealthCheckTask"),E("这个类中，是一个Runnable，其中的run方法：")],-1)),l[297]||(l[297]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (distroMapper."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"responsible"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cluster."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"&&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," switchDomain")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isHealthCheckEnabled"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(cluster."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 开始健康检测")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            healthCheckProcessor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"process"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 记录日志 。。。")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"       // 记录日志 。。。")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cancelled) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 结束后，再次进行任务调度，一定延迟后执行")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            HealthCheckReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleCheck"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 。。。")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[298]||(l[298]=n("p",null,[E("健康检测逻辑定义在"),n("code",null,"healthCheckProcessor.process(this);"),E("方法中，在HealthCheckProcessor接口中，这个接口也有很多实现，默认是"),n("code",null,"TcpSuperSenseProcessor"),E("：")],-1)),l[299]||(l[299]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923102824451.png",alt:"image-20210923102824451",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[300]||(l[300]=n("p",null,[E("进入"),n("code",null,"TcpSuperSenseProcessor"),E("的process方法：")],-1)),l[301]||(l[301]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," process"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HealthCheckTask task) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取所有 非临时实例的 集合")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> ips "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," task."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allIPs"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (CollectionUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ips)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Instance ip "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ips) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 封装健康检测信息到 Beat")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Beat beat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Beat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(ip, task);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入一个阻塞队列中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        taskQueue."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        MetricsMonitor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTcpHealthCheckMonitor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"incrementAndGet"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[302]||(l[302]=n("p",null,"可以看到，所有的健康检测任务都被放入一个阻塞队列，而不是立即执行了。这里又采用了异步执行的策略，可以看到Nacos中大量这样的设计。",-1)),l[303]||(l[303]=n("p",null,[E("而"),n("code",null,"TcpSuperSenseProcessor"),E("本身就是一个Runnable，在它的构造函数中会把自己放入线程池中去执行，其run方法如下：")],-1)),l[304]||(l[304]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 处理任务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            processTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // ...")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Throwable "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[HEALTH-CHECK] error while processing NIO task"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[305]||(l[305]=n("p",null,"通过processTask来处理健康检测的任务：",-1)),l[306]||(l[306]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"private"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," processTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() throws Exception {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 将任务封装为一个 TaskProcessor，并放入集合")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Collection<Callable<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Void"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">> tasks "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," LinkedList<>();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    do"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Beat beat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," taskQueue."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"poll"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CONNECT_TIMEOUT_MS "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", TimeUnit.MILLISECONDS);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (beat "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        tasks."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"add"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," TaskProcessor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (taskQueue."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tasks."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NIO_THREAD_COUNT "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 64"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 批量处理集合中的任务")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    for"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Future<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> f "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," GlobalExecutor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"invokeAllTcpSuperSenseTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(tasks)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        f."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[307]||(l[307]=n("p",null,"任务被封装到了TaskProcessor中去执行了，TaskProcessor是一个Callable，其中的call方法：",-1)),l[308]||(l[308]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Void "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"call"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取检测任务已经等待的时长")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," waited "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getStartTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (waited "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," MAX_WAIT_TIME_MILLISECONDS) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"beat task waited too long: "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," waited "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "ms"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    SocketChannel channel "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 获取实例信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Instance instance "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 通过NIO建立TCP连接")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SocketChannel."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"open"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"configureBlocking"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // only by setting this can we make the socket close event asynchronous")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"socket"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setSoLinger"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"socket"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setReuseAddress"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"socket"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setKeepAlive"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"socket"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setTcpNoDelay"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Cluster cluster "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," beat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getCluster"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," port "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cluster."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isUseIPPort4Check"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cluster."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDefCkport"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        channel."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"connect"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InetSocketAddress"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(instance."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getIp"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), port));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 注册连接、读取事件")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        SelectionKey key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," channel."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"register"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(selector, SelectionKey.OP_CONNECT "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"|"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SelectionKey.OP_READ);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        key."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"attach"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        keyMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(beat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," BeatKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key));")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        beat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setStartTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        GlobalExecutor")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scheduleTcpSuperSenseTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," TimeOutTask"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key), CONNECT_TIMEOUT_MS, TimeUnit.MILLISECONDS);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        beat."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"finishCheck"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", switchDomain."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTcpHealthParams"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMax"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'                         "tcp:error:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," e."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMessage"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (channel "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                channel."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"close"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"ignore"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[309]||(l[309]=n("h3",{id:"_3-3-总结",tabindex:"-1"},[E("3.3 总结 "),n("a",{class:"header-anchor",href:"#_3-3-总结","aria-label":'Permalink to "3.3 总结"'},"​")],-1)),l[310]||(l[310]=n("blockquote",null,[n("p",null,"Nacos的健康检测有两种模式："),n("ul",null,[n("li",null,[E("临时实例： "),n("ul",null,[n("li",null,"采用客户端心跳检测模式，心跳周期5秒"),n("li",null,"心跳间隔超过15秒则标记为不健康"),n("li",null,"心跳间隔超过30秒则从服务列表删除")])]),n("li",null,[E("永久实例： "),n("ul",null,[n("li",null,"采用服务端主动健康检测方式"),n("li",null,"周期为2000 + 5000毫秒内的随机数"),n("li",null,"检测异常只会标记为不健康，不会删除")])])]),n("p",null,"那么为什么Nacos有临时和永久两种实例呢？"),n("p",null,[E("以淘宝为例，双十一大促期间，流量会比平常高出很多，此时服务肯定需要增加更多实例来应对高并发，而这些实例在双十一之后就无需继续使用了，采用"),n("strong",null,"临时实例"),E("比较合适。而对于服务的一些常备实例，则使用"),n("strong",null,"永久实例"),E("更合适。")]),n("p",null,"与eureka相比，Nacos与Eureka在临时实例上都是基于心跳模式实现，差别不大，主要是心跳周期不同，eureka是30秒，Nacos是5秒。"),n("p",null,"另外，Nacos支持永久实例，而Eureka不支持，Eureka只提供了心跳模式的健康监测，而没有主动检测功能。")],-1)),l[311]||(l[311]=n("hr",null,null,-1)),l[312]||(l[312]=n("h2",{id:"_4-服务发现",tabindex:"-1"},[E("4. 服务发现 "),n("a",{class:"header-anchor",href:"#_4-服务发现","aria-label":'Permalink to "4. 服务发现"'},"​")],-1)),l[313]||(l[313]=n("p",null,"Nacos提供了一个根据serviceId查询实例列表的接口：",-1)),l[314]||(l[314]=n("p",null,[n("strong",null,"接口描述"),E("：查询服务下的实例列表")],-1)),l[315]||(l[315]=n("p",null,[n("strong",null,"请求类型"),E("：GET")],-1)),l[316]||(l[316]=n("p",null,[n("strong",null,"请求路径"),E("：")],-1)),l[317]||(l[317]=n("div",{class:"language-plain max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"plain"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",null,"/nacos/v1/ns/instance/list")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[318]||(l[318]=n("p",null,[n("strong",null,"请求参数"),E("：")],-1)),l[319]||(l[319]=n("table",null,[n("thead",null,[n("tr",null,[n("th",{style:{"text-align":"left"}},"名称"),n("th",{style:{"text-align":"left"}},"类型"),n("th",{style:{"text-align":"left"}},"是否必选"),n("th",null,"描述")])]),n("tbody",null,[n("tr",null,[n("td",{style:{"text-align":"left"}},"serviceName"),n("td",{style:{"text-align":"left"}},"字符串"),n("td",{style:{"text-align":"left"}},"是"),n("td",null,"服务名")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"groupName"),n("td",{style:{"text-align":"left"}},"字符串"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"分组名")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"namespaceId"),n("td",{style:{"text-align":"left"}},"字符串"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"命名空间ID")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"clusters"),n("td",{style:{"text-align":"left"}},"字符串，多个集群用逗号分隔"),n("td",{style:{"text-align":"left"}},"否"),n("td",null,"集群名称")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"healthyOnly"),n("td",{style:{"text-align":"left"}},"boolean"),n("td",{style:{"text-align":"left"}},"否，默认为false"),n("td",null,"是否只返回健康实例")])])],-1)),l[320]||(l[320]=n("p",null,[n("strong",null,"错误编码"),E("：")],-1)),l[321]||(l[321]=n("table",null,[n("thead",null,[n("tr",null,[n("th",{style:{"text-align":"left"}},"错误代码"),n("th",{style:{"text-align":"left"}},"描述"),n("th",{style:{"text-align":"left"}},"语义")])]),n("tbody",null,[n("tr",null,[n("td",{style:{"text-align":"left"}},"400"),n("td",{style:{"text-align":"left"}},"Bad Request"),n("td",{style:{"text-align":"left"}},"客户端请求中的语法错误")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"403"),n("td",{style:{"text-align":"left"}},"Forbidden"),n("td",{style:{"text-align":"left"}},"没有权限")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"404"),n("td",{style:{"text-align":"left"}},"Not Found"),n("td",{style:{"text-align":"left"}},"无法找到资源")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"500"),n("td",{style:{"text-align":"left"}},"Internal Server Error"),n("td",{style:{"text-align":"left"}},"服务器内部错误")]),n("tr",null,[n("td",{style:{"text-align":"left"}},"200"),n("td",{style:{"text-align":"left"}},"OK"),n("td",{style:{"text-align":"left"}},"正常")])])],-1)),l[322]||(l[322]=n("h3",{id:"_4-1-客户端",tabindex:"-1"},[E("4.1 客户端 "),n("a",{class:"header-anchor",href:"#_4-1-客户端","aria-label":'Permalink to "4.1 客户端"'},"​")],-1)),l[323]||(l[323]=n("h4",{id:"_4-1-1-定时更新服务列表",tabindex:"-1"},[E("4.1.1 定时更新服务列表 "),n("a",{class:"header-anchor",href:"#_4-1-1-定时更新服务列表","aria-label":'Permalink to "4.1.1 定时更新服务列表"'},"​")],-1)),l[324]||(l[324]=n("h5",{id:"_4-1-1-1-nacosnamingservice",tabindex:"-1"},[E("4.1.1.1 NacosNamingService "),n("a",{class:"header-anchor",href:"#_4-1-1-1-nacosnamingservice","aria-label":'Permalink to "4.1.1.1 NacosNamingService"'},"​")],-1)),l[325]||(l[325]=n("p",null,[E("在2.2.4小节中，我们讲到一个类"),n("code",null,"NacosNamingService"),E("，这个类不仅仅提供了服务注册功能，同样提供了服务发现的功能。")],-1)),l[326]||(l[326]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923153419392.png",alt:"image-20210923153419392",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[327]||(l[327]=n("p",null,"多个重载的方法最终都会进入一个方法：",-1)),l[328]||(l[328]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," List"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Instance"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getAllInstances"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String groupName, List"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"String"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clusters,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                                      boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," subscribe) throws NacosException {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ServiceInfo serviceInfo;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 1.判断是否需要订阅服务信息（默认为 true）")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (subscribe) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.1.订阅服务信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfo "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hostReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceInfo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupedName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, groupName),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                                 StringUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"join"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusters, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 1.2.直接去nacos拉取服务信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfo "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hostReactor")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceInfoDirectlyFromServer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupedName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, groupName),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                                              StringUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"join"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clusters, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'","'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 2.从服务信息中获取实例列表并返回")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    List<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> list;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (serviceInfo "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," CollectionUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(list "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getHosts"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"())) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ArrayList<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Instance"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," list;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[329]||(l[329]=n("h5",{id:"_4-1-1-2-hostreactor",tabindex:"-1"},[E("4.1.1.2 HostReactor "),n("a",{class:"header-anchor",href:"#_4-1-1-2-hostreactor","aria-label":'Permalink to "4.1.1.2 HostReactor"'},"​")],-1)),l[330]||(l[330]=n("p",null,[E("进入1.1.订阅服务消息，这里是由"),n("code",null,"HostReactor"),E("类的"),n("code",null,"getServiceInfo()"),E("方法来实现的：")],-1)),l[331]||(l[331]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ServiceInfo "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceInfo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String serviceName, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String clusters) {")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NAMING_LOGGER."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"failover-mode: "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," failoverReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFailoverSwitch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 由 服务名@@集群名拼接 key")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String key "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ServiceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (failoverReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isFailoverSwitch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," failoverReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(key);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 读取本地服务列表的缓存，缓存是一个Map，格式：Map<String, ServiceInfo>")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ServiceInfo serviceObj "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getServiceInfo0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 判断缓存是否存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"null"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," =="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceObj) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 不存在，创建空ServiceInfo")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceObj "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ServiceInfo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入缓存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfoMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceObj."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceObj);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入待更新的服务列表（updatingMap）中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        updatingMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Object"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 立即更新服务列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"        updateServiceNow"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 从待更新列表中移除")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        updatingMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"remove"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (updatingMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"containsKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 缓存中有，但是需要更新")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (UPDATE_HOLD_INTERVAL "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // hold a moment waiting for update finish 等待5秒中，待更新完成")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            synchronized"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (serviceObj) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    serviceObj."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"wait"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UPDATE_HOLD_INTERVAL);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (InterruptedException "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                    NAMING_LOGGER")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                        ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[getServiceInfo] serviceName:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ", clusters:"'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clusters, e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 开启定时更新服务列表的功能")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    scheduleUpdateIfAbsent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 返回缓存中的服务信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfoMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceObj."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[332]||(l[332]=n("p",null,"基本逻辑就是先从本地缓存读，根据结果来选择：",-1)),l[333]||(l[333]=n("ul",null,[n("li",null,[n("p",null,[E("如果本地缓存没有，立即去nacos读取，"),n("code",null,"updateServiceNow(serviceName, clusters)")]),n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923161528710.png",alt:"image-20210923161528710",loading:"lazy",decoding:"async",class:"lazy"})])]),n("li",null,[n("p",null,"如果本地缓存有，则开启定时更新功能，并返回缓存结果："),n("ul",null,[n("li",null,[n("code",null,"scheduleUpdateIfAbsent(serviceName, clusters)")])]),n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923161630575.png",alt:"image-20210923161630575",loading:"lazy",decoding:"async",class:"lazy"})]),n("p",null,"在UpdateTask中，最终还是调用updateService方法："),n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923161752521.png",alt:"image-20210923161752521",loading:"lazy",decoding:"async",class:"lazy"})])])],-1)),l[334]||(l[334]=n("p",null,"不管是立即更新服务列表，还是定时更新服务列表，最终都会执行HostReactor中的updateService()方法：",-1)),l[335]||(l[335]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," updateService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String clusters) throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ServiceInfo oldService "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getServiceInfo0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 基于ServerProxy发起远程调用，查询服务列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serverProxy."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName, clusters, pushReceiver."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUdpPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isNotEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(result)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 处理查询结果")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"            processServiceJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(result);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"finally"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (oldService "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            synchronized"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (oldService) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                oldService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"notifyAll"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[336]||(l[336]=n("h5",{id:"_4-1-1-3-serverproxy",tabindex:"-1"},[E("4.1.1.3 ServerProxy "),n("a",{class:"header-anchor",href:"#_4-1-1-3-serverproxy","aria-label":'Permalink to "4.1.1.3 ServerProxy"'},"​")],-1)),l[337]||(l[337]=n("p",null,"而ServerProxy的queryList方法如下：",-1)),l[338]||(l[338]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," String "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"queryList"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String serviceName, String clusters, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," udpPort, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," healthyOnly)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    throws NacosException {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 准备请求参数")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    final"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Map<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"> params "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," HashMap<"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},">("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"8"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.NAMESPACE_ID, namespaceId);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(CommonParams.SERVICE_NAME, serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clusters"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clusters);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"udpPort"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(udpPort));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clientIP"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", NetUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"localIP"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    params."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"healthyOnly"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", String."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"valueOf"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(healthyOnly));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 发起请求，地址与API接口一致")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," reqApi"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(UtilAndComs.nacosUrlBase "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/instance/list"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", params, HttpMethod.GET);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[339]||(l[339]=n("h4",{id:"_4-1-2-处理服务变更通知",tabindex:"-1"},[E("4.1.2 处理服务变更通知 "),n("a",{class:"header-anchor",href:"#_4-1-2-处理服务变更通知","aria-label":'Permalink to "4.1.2 处理服务变更通知"'},"​")],-1)),l[340]||(l[340]=n("p",null,"除了定时更新服务列表的功能外，Nacos还支持服务列表变更时的主动推送功能。",-1)),l[341]||(l[341]=n("p",null,"在HostReactor类的构造函数中，有非常重要的几个步骤：",-1)),l[342]||(l[342]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923164145915.png",alt:"image-20210923164145915",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[343]||(l[343]=n("p",null,"基本思路是：",-1)),l[344]||(l[344]=n("ul",null,[n("li",null,"通过PushReceiver监听服务端推送的变更数据"),n("li",null,"解析数据后，通过NotifyCenter发布服务变更的事件"),n("li",null,"InstanceChangeNotifier监听变更事件，完成对服务列表的更新")],-1)),l[345]||(l[345]=n("h5",{id:"_4-1-2-1-pushreceiver",tabindex:"-1"},[E("4.1.2.1 PushReceiver "),n("a",{class:"header-anchor",href:"#_4-1-2-1-pushreceiver","aria-label":'Permalink to "4.1.2.1 PushReceiver"'},"​")],-1)),l[346]||(l[346]=n("p",null,"我们先看PushReceiver，这个类会以UDP方式接收Nacos服务端推送的服务变更数据。",-1)),l[347]||(l[347]=n("p",null,"先看构造函数：",-1)),l[348]||(l[348]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," PushReceiver"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HostReactor hostReactor) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".hostReactor "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hostReactor;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 创建 UDP客户端")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        String udpPort "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getPushReceiverUdpPort"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (StringUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isEmpty"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(udpPort)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"            this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".udpSocket "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DatagramSocket"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"            this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".udpSocket "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DatagramSocket"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InetSocketAddress"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Integer."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(udpPort)));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 准备线程池")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".executorService "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ScheduledThreadPoolExecutor"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ThreadFactory"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            @"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Thread "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"newThread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(Runnable "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"r"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                Thread thread "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Thread"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(r);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setDaemon"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                thread."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"com.alibaba.nacos.naming.push.receiver"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," thread;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        });")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 开启线程任务，准备接收变更数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"        this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".executorService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"execute"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"this"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NAMING_LOGGER."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NA] init udp socket failed"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[349]||(l[349]=n("p",null,"PushReceiver构造函数中基于线程池来运行任务。这是因为PushReceiver本身也是一个Runnable，其中的run方法业务逻辑如下：",-1)),l[350]||(l[350]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Override")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," void"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," run"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    while"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"closed) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // byte[] is initialized with 0 full filled by default")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            byte"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[] buffer "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," byte"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"[UDP_MSS];")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            DatagramPacket packet "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," DatagramPacket"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(buffer, buffer.length);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 接收推送数据")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            udpSocket."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"receive"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(packet);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 解析为json字符串")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String json "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," String"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(IoUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tryDecompress"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(packet."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getData"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()), UTF_8)."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"trim"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            NAMING_LOGGER."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"info"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"received push data: "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," json "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' " from "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," packet."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getAddress"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toString"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 反序列化为对象")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            PushPacket pushPacket "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toObj"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json, PushPacket.class);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            String ack;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dom"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pushPacket.type) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"||"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "service"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"equals"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pushPacket.type)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // 交给 HostReactor去处理")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                hostReactor."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"processServiceJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(pushPacket.data);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"                // send ack to server 发送ACK回执，略。。")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"            if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (closed) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            NAMING_LOGGER."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NA] error while receiving push data"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[351]||(l[351]=n("h5",{id:"_4-1-2-2-hostreactor",tabindex:"-1"},[E("4.1.2.2 HostReactor "),n("a",{class:"header-anchor",href:"#_4-1-2-2-hostreactor","aria-label":'Permalink to "4.1.2.2 HostReactor"'},"​")],-1)),l[352]||(l[352]=n("p",null,[E("通知数据的处理由交给了"),n("code",null,"HostReactor"),E("的"),n("code",null,"processServiceJson"),E("方法：")],-1)),l[353]||(l[353]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ServiceInfo "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"processServiceJson"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String json) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 解析出ServiceInfo信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ServiceInfo serviceInfo "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"toObj"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json, ServiceInfo.class);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String serviceKey "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (serviceKey "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 查询缓存中的 ServiceInfo")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ServiceInfo oldService "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfoMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"get"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceKey);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 如果缓存存在，则需要校验哪些数据要更新")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," changed "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (oldService "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t// 拉取的数据是否已经过期")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (oldService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastRefTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastRefTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            NAMING_LOGGER."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"warn"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"out of date data received, old-t: "'),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," oldService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastRefTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ", new-t: "')]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                               +"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getLastRefTime"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入缓存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfoMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\t\t")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 中间是缓存与新数据的对比，得到newHosts：新增的实例；remvHosts：待移除的实例;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // modHosts：需要修改的实例")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (newHosts."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," remvHosts."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ||"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," modHosts."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"size"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"() "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"            // 发布实例变更的事件")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            NotifyCenter."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"publishEvent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InstancesChangeEvent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusters"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getHosts"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            DiskCache."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"write"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceInfo, cacheDir);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 本地缓存不存在")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        changed "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," true"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 放入缓存")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfoMap."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getKey"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 直接发布实例变更的事件")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        NotifyCenter."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"publishEvent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InstancesChangeEvent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getGroupName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getClusters"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(), serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getHosts"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        serviceInfo."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"setJsonFromServer"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(json);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        DiskCache."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"write"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceInfo, cacheDir);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 。。。")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceInfo;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[354]||(l[354]=n("h3",{id:"_4-2-服务端",tabindex:"-1"},[E("4.2 服务端 "),n("a",{class:"header-anchor",href:"#_4-2-服务端","aria-label":'Permalink to "4.2 服务端"'},"​")],-1)),l[355]||(l[355]=n("h4",{id:"_4-2-1-拉取服务列表接口",tabindex:"-1"},[E("4.2.1 拉取服务列表接口 "),n("a",{class:"header-anchor",href:"#_4-2-1-拉取服务列表接口","aria-label":'Permalink to "4.2.1 拉取服务列表接口"'},"​")],-1)),l[356]||(l[356]=n("p",null,"在2.3.1小节介绍的InstanceController中，提供了拉取服务列表的接口：",-1)),l[357]||(l[357]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"/**")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * Get all instance of input service.")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     *")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@param"),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}}," request"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," http request")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@return"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," list of instance")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     * "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@throws"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Exception"),n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," any error during list")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"     */")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"GetMapping"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/list"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"@"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Secured"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"parser"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NamingResourceParser.class, "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"action"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ActionTypes.READ)")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectNode "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"list"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(HttpServletRequest request) throws Exception {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 从request中获取namespaceId和serviceName")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String namespaceId "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String serviceName "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"required"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, CommonParams.SERVICE_NAME);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"checkServiceNameFormat"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String agent "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getUserAgent"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String clusters "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clusters"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String clientIP "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clientIP"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取客户端的 UDP端口")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," udpPort "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Integer."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseInt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"udpPort"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"0"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String env "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"env"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isCheck "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseBoolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"isCheck"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"false"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String app "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"app"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    String tenant "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"tid"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", StringUtils.EMPTY);")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," healthyOnly "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Boolean."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseBoolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(WebUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"optional"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(request, "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"healthyOnly"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"false"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"));")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取服务列表")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," doSrvIpxt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, agent, clusters, clientIP, udpPort, env, isCheck, app, tenant,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                     healthyOnly);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[358]||(l[358]=n("p",null,[E("进入"),n("code",null,"doSrvIpxt()"),E("方法来获取服务列表：")],-1)),l[359]||(l[359]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ObjectNode "),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"doSrvIpxt"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(String namespaceId, String serviceName, String agent,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            String clusters, String clientIP,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                            int"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," udpPort, String env, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," isCheck,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                            String app, String tid, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"boolean"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," healthyOnly) throws Exception {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ClientInfo clientInfo "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ClientInfo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(agent);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    ObjectNode result "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createEmptyJsonNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 获取服务列表信息")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    Service service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," serviceManager."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getService"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    long"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cacheMillis "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," switchDomain."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDefaultCacheMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // now try to enable the push")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    try"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (udpPort "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," &&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," pushService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"canEnablePush"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(agent)) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t\t\t// 添加当前客户端 IP、UDP端口到 PushService 中")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            pushService")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addClient"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, clusters, agent, "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InetSocketAddress"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientIP, udpPort),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                           pushDataSource, tid, app);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            cacheMillis "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," switchDomain."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getPushCacheMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"catch"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Exception "),n("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"e"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        Loggers.SRV_LOG")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            ."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"error"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"[NACOS-API] failed to added push client {}, {}:{}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clientInfo, clientIP, udpPort, e);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        cacheMillis "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," switchDomain."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getDefaultCacheMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (service "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," null"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        // 如果没找到，返回空")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"isDebugEnabled"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()) {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"            Loggers.SRV_LOG."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"debug"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"no instance to serve for service: {}"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clusters"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clusters);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cacheMillis"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", cacheMillis);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"replace"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"hosts"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"createEmptyArrayNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"\t// 结果的检测，异常实例的剔除等逻辑省略")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 最终封装结果并返回 。。。")]),E("\n"),n("span",{class:"line"}),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"replace"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"hosts"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", hosts);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (clientInfo.type "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ClientInfo.ClientType.JAVA")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"        &&"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," clientInfo.version."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"compareTo"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(VersionUtil."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"parseVersion"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"1.0.0"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")) "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">="),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dom"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dom"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", NamingUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getServiceName"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(serviceName));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"name"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", serviceName);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cacheMillis"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", cacheMillis);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lastRefTime"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", System."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"currentTimeMillis"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"checksum"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getChecksum"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"());")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"useSpecifiedURL"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"clusters"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", clusters);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"put"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"env"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", env);")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    result."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"replace"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"metadata"'),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", JacksonUtils."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"transferToJsonNode"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(service."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getMetadata"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()));")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," result;")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[360]||(l[360]=n("h4",{id:"_4-2-2-发布服务变更的udp通知",tabindex:"-1"},[E("4.2.2 发布服务变更的UDP通知 "),n("a",{class:"header-anchor",href:"#_4-2-2-发布服务变更的udp通知","aria-label":'Permalink to "4.2.2 发布服务变更的UDP通知"'},"​")],-1)),l[361]||(l[361]=n("p",null,[E("在上一节中，"),n("code",null,"InstanceController"),E("中的"),n("code",null,"doSrvIpxt()"),E("方法中，有这样一行代码：")],-1)),l[362]||(l[362]=n("div",{class:"language-java max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"java"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"pushService."),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addClient"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(namespaceId, serviceName, clusters, agent,")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"                      new"),n("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," InetSocketAddress"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(clientIP, udpPort),")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"                           pushDataSource, tid, app);")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[363]||(l[363]=n("p",null,"其实是把消费者的UDP端口、IP等信息封装为一个PushClient对象，存储PushService中。方便以后服务变更后推送消息。",-1)),l[364]||(l[364]=n("p",null,[E("PushService类本身实现了"),n("code",null,"ApplicationListener"),E("接口：")],-1)),l[365]||(l[365]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923182429636.png",alt:"image-20210923182429636",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[366]||(l[366]=n("p",null,"这个是事件监听器接口，监听的是ServiceChangeEvent（服务变更事件）。",-1)),l[367]||(l[367]=n("p",null,"当服务列表变化时，就会通知我们：",-1)),l[368]||(l[368]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20210923183017424.png",alt:"image-20210923183017424",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[369]||(l[369]=n("h3",{id:"_4-3-总结",tabindex:"-1"},[E("4.3 总结 "),n("a",{class:"header-anchor",href:"#_4-3-总结","aria-label":'Permalink to "4.3 总结"'},"​")],-1)),l[370]||(l[370]=n("blockquote",null,[n("p",null,"Nacos的服务发现分为两种模式："),n("ul",null,[n("li",null,"模式一：主动拉取模式，消费者定期主动从Nacos拉取服务列表并缓存起来，再服务调用时优先读取本地缓存中的服务列表。"),n("li",null,"模式二：订阅模式，消费者订阅Nacos中的服务列表，并基于UDP协议来接收服务变更通知。当Nacos中的服务列表更新时，会发送UDP广播给所有订阅者。")]),n("p",null,"与Eureka相比，Nacos的订阅模式服务状态更新更及时，消费者更容易及时发现服务列表的变化，剔除故障服务。")],-1)),l[371]||(l[371]=n("h2",{id:"_5-原理",tabindex:"-1"},[E("5 原理 "),n("a",{class:"header-anchor",href:"#_5-原理","aria-label":'Permalink to "5 原理"'},"​")],-1)),l[372]||(l[372]=n("p",null,"不知你是否跟我一样，在使用Nacos时有以下几点疑问：",-1)),l[373]||(l[373]=n("ul",null,[n("li",null,"临时实例和永久实例是什么？有什么区别？"),n("li",null,"服务实例是如何注册到服务端的？"),n("li",null,"服务实例和服务端之间是如何保活的？"),n("li",null,"服务订阅是如何实现的？"),n("li",null,"集群间数据是如何同步的？CP还是AP？"),n("li",null,"Nacos的数据模型是什么样的？"),n("li",null,"…")],-1)),l[374]||(l[374]=n("p",null,"本文就通过探讨上述问题来探秘Nacos服务注册中心核心的底层实现原理。",-1)),l[375]||(l[375]=n("blockquote",null,[n("p",null,"虽然Nacos最新版本已经到了2.x版本，但是为了照顾那些还在用1.x版本的同学，所以本文我会同时去讲1.x版本和2.x版本的实现")],-1)),l[376]||(l[376]=n("h3",{id:"临时实例和永久实例",tabindex:"-1"},[n("strong",null,"临时实例和永久实例"),E(),n("a",{class:"header-anchor",href:"#临时实例和永久实例","aria-label":'Permalink to "**临时实例和永久实例**"'},"​")],-1)),l[377]||(l[377]=n("ul",null,[n("li",null,[E("临时实例和永久实例在Nacos中是一个"),n("strong",null,"非常非常重要"),E("的概念 "),n("ul",null,[n("li",null,"之所以说它重要，主要是因为我在读源码的时候发现，临时实例和永久实例在底层的许多实现机制是完全不同的")])])],-1)),l[378]||(l[378]=n("p",null,[n("strong",null,"临时实例")],-1)),l[379]||(l[379]=n("ol",null,[n("li",null,"临时实例在注册到注册中心之后仅仅只保存在服务端内部一个缓存中，不会持久化到磁盘"),n("li",null,[E("这个服务端内部的缓存在注册中心届一般被称为"),n("strong",null,"服务注册表")]),n("li",null,"当服务实例出现异常或者下线之后，就会把这个服务实例从服务注册表中剔除")],-1)),l[380]||(l[380]=n("p",null,[n("strong",null,"永久实例")],-1)),l[381]||(l[381]=n("ol",null,[n("li",null,"永久服务实例不仅仅会存在服务注册表中，同时也会被持久化到磁盘文件中"),n("li",null,"当服务实例出现异常或者下线，Nacos只会将服务实例的健康状态设置为不健康，并不会对将其从服务注册表中剔除")],-1)),l[382]||(l[382]=n("p",null,"所以这个服务实例的信息你还是可以从注册中心看到，只不过处于不健康状态",-1)),l[383]||(l[383]=n("p",null,"这是就是两者最最最基本的区别",-1)),l[384]||(l[384]=n("blockquote",null,[n("p",null,"当然除了上述最基本的区别之外，两者还有很多其它的区别，接下来本文还会提到")],-1)),l[385]||(l[385]=n("p",null,"这里你可能会有一个疑问",-1)),l[386]||(l[386]=n("blockquote",null,[n("p",null,"为什么Nacos要将服务实例分为临时实例和永久实例?")],-1)),l[387]||(l[387]=n("p",null,"主要还是因为应用场景不同",-1)),l[388]||(l[388]=n("p",null,[n("strong",null,"临时实例"),E("就比较适合于业务服务，服务下线之后可以不需要在注册中心中查看到")],-1)),l[389]||(l[389]=n("p",null,[n("strong",null,"永久实例"),E("就比较适合需要运维的服务，这种服务几乎是永久存在的，比如说MySQL、Redis等等")],-1)),l[390]||(l[390]=n("blockquote",null,[n("p",null,"MySQL、Redis等服务实例可以通过SDK手动注册")],-1)),l[391]||(l[391]=n("p",null,"对于这些服务，我们需要一直看到服务实例的状态，即使出现异常，也需要能够查看时实的状态",-1)),l[392]||(l[392]=n("blockquote",null,[n("p",null,"所以从这可以看出Nacos跟你印象中的注册中心不太一样，他不仅仅可以注册平时业务中的实例，还可以注册像MySQL、Redis这个服务实例的信息到注册中心")],-1)),l[393]||(l[393]=n("p",null,"在SpringCloud环境底下，一般其实都是业务服务，所以默认注册服务实例都是临时实例",-1)),l[394]||(l[394]=n("p",null,"当然如果你想改成永久实例，可以通过下面这个配置项来完成",-1)),l[395]||(l[395]=n("div",{class:"language-yaml max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"yaml"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"spring")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    nacos"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      discovery"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"        #ephemeral单词是临时的意思，设置成false，就是永久实例了")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        ephemeral"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[396]||(l[396]=n("p",null,"这里还有一个小细节",-1)),l[397]||(l[397]=n("p",null,"在1.x版本中，一个服务中可以既有临时实例也有永久实例，服务实例是永久还是临时是由服务实例本身决定的",-1)),l[398]||(l[398]=n("p",null,"但是2.x版本中，一个服务中的所有实例要么都是临时的要么都是永久的，是由服务决定的，而不是具体的服务实例",-1)),l[399]||(l[399]=n("p",null,[E("所以在2.x可以说是"),n("strong",null,"临时服务"),E("和"),n("strong",null,"永久服务")],-1)),l[400]||(l[400]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528837-905586867.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[401]||(l[401]=n("blockquote",null,[n("p",null,"为什么2.x把临时还是永久的属性由实例本身决定改成了由服务决定?")],-1)),l[402]||(l[402]=n("p",null,"其实很简单，你想想，假设对一个MySQL服务来说，它的每个服务实例肯定都是永久的，不会出现一些是永久的，一些是临时的情况吧",-1)),l[403]||(l[403]=n("p",null,"所以临时还是永久的属性由服务本身决定其实就更加合理了",-1)),l[404]||(l[404]=n("h3",{id:"服务注册",tabindex:"-1"},[n("strong",null,"服务注册"),E(),n("a",{class:"header-anchor",href:"#服务注册","aria-label":'Permalink to "**服务注册**"'},"​")],-1)),l[405]||(l[405]=n("p",null,"作为一个服务注册中心，服务注册肯定是一个非常重要的功能",-1)),l[406]||(l[406]=n("p",null,"所谓的服务注册，就是通过注册中心提供的客户端SDK（或者是控制台）将服务本身的一些元信息，比如ip、端口等信息发送到注册中心服务端",-1)),l[407]||(l[407]=n("p",null,"服务端在接收到服务之后，会将服务的信息保存到前面提到的服务注册表中",-1)),l[408]||(l[408]=n("h4",{id:"_1-1-x版本的实现",tabindex:"-1"},[E("1）1.x版本的实现 "),n("a",{class:"header-anchor",href:"#_1-1-x版本的实现","aria-label":'Permalink to "1）1.x版本的实现"'},"​")],-1)),l[409]||(l[409]=n("p",null,"在Nacos在1.x版本的时候，服务注册是通过Http接口实现的",-1)),l[410]||(l[410]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528474-1639067358.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[411]||(l[411]=n("p",null,"代码如下",-1)),l[412]||(l[412]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528350-2093109640.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[413]||(l[413]=n("p",null,"整个逻辑比较简单，因为Nacos服务端本身就是用SpringBoot写的",-1)),l[414]||(l[414]=n("p",null,"但是在2.x版本的实现就比较复杂了",-1)),l[415]||(l[415]=n("h4",{id:"_2-2-x版本的实现",tabindex:"-1"},[E("2）2.x版本的实现 "),n("a",{class:"header-anchor",href:"#_2-2-x版本的实现","aria-label":'Permalink to "2）2.x版本的实现"'},"​")],-1)),l[416]||(l[416]=n("h5",{id:"_1-通信协议的改变",tabindex:"-1"},[E("① 通信协议的改变 "),n("a",{class:"header-anchor",href:"#_1-通信协议的改变","aria-label":'Permalink to "① 通信协议的改变"'},"​")],-1)),l[417]||(l[417]=n("p",null,"2.x版本相比于1.x版本最主要的升级就是客户端和服务端通信协议的改变，由1.x版本的Http改成了2.x版本gRPC",-1)),l[418]||(l[418]=n("blockquote",null,[n("p",null,"gRPC是谷歌公司开发的一个高性能、开源和通用的RPC框架，Java版本的实现底层也是基于Netty来的")],-1)),l[419]||(l[419]=n("p",null,"之所以改成了gRPC，主要是因为Http请求会频繁创建和销毁连接，白白浪费资源",-1)),l[420]||(l[420]=n("p",null,"所以在2.x版本之后，为了提升性能，就将通信协议改成了gRPC",-1)),l[421]||(l[421]=n("p",null,"根据官网显示，整体的效果还是很明显，相比于1.x版本，注册性能总体提升至少2倍",-1)),l[422]||(l[422]=n("blockquote",null,[n("p",null,"虽然通信方式改成了gRPC，但是2.x版本服务端依然保留了Http注册的接口，所以用1.x的Nacos SDK依然可以注册到2.x版本的服务端")],-1)),l[423]||(l[423]=n("h5",{id:"_2-具体的实现",tabindex:"-1"},[E("② 具体的实现 "),n("a",{class:"header-anchor",href:"#_2-具体的实现","aria-label":'Permalink to "② 具体的实现"'},"​")],-1)),l[424]||(l[424]=n("ol",null,[n("li",null,"Nacos客户端在启动的时候，会通过gRPC跟服务端建立长连接")],-1)),l[425]||(l[425]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528444-2112750076.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[426]||(l[426]=n("ol",{start:"2"},[n("li",null,"这个连接会一直存在，之后客户端与服务端所有的通信都是基于这个长连接来的"),n("li",null,"当客户端发起注册的时候，就会通过这个长连接，将服务实例的信息发送给服务端"),n("li",null,"服务端拿到服务实例，跟1.x一样，也会存到服务注册表"),n("li",null,[E("除了注册之外，"),n("strong",null,"当注册的是临时实例时"),E("，2.x还会将服务实例信息存储到客户端中的一个缓存中，供Redo操作")]),n("li",null,"所谓的Redo操作，其实就是一个补偿机制，本质是个定时任务，默认每3s执行一次"),n("li",null,"这个定时任务作用是，当客户端与服务端重新建立连接时（因为一些异常原因导致连接断开）"),n("li",null,"那么之前注册的服务实例肯定还要继续注册服务端（断开连接服务实例就会被剔除服务注册表）")],-1)),l[427]||(l[427]=n("ul",null,[n("li",null,"所以这个Redo操作一个很重要的作用就是重连之后的重新注册的作用")],-1)),l[428]||(l[428]=n("blockquote",null,[n("p",null,"除了注册之外，比如服务订阅之类的操作也需要Redo操作，当连接重新建立，之前客户端的操作都需要Redo一下")],-1)),l[429]||(l[429]=n("h4",{id:"小总结",tabindex:"-1"},[E("小总结 "),n("a",{class:"header-anchor",href:"#小总结","aria-label":'Permalink to "小总结"'},"​")],-1)),l[430]||(l[430]=n("p",null,"1.x版本是通过Http协议来进行服务注册的",-1)),l[431]||(l[431]=n("p",null,"2.x由于客户端与服务端的通信改成了gRPC长连接，所以改成通过gRPC长连接来注册",-1)),l[432]||(l[432]=n("p",null,"2.x比1.x多个Redo操作，当注册的服务实例是临时实例是，出现网络异常，连接重新建立之后，客户端需要将服务注册、服务订阅之类的操作进行重做",-1)),l[433]||(l[433]=n("p",null,"这里你可能会有个疑问",-1)),l[434]||(l[434]=n("blockquote",null,[n("p",null,"既然2.x有Redo机制保证客户端与服务端通信正常之后重新注册，那么1.x有类似的这种Redo机制么？")],-1)),l[435]||(l[435]=n("p",null,"当然也会有，接下往下看。",-1)),l[436]||(l[436]=n("h3",{id:"心跳机制",tabindex:"-1"},[n("strong",null,"心跳机制"),E(),n("a",{class:"header-anchor",href:"#心跳机制","aria-label":'Permalink to "**心跳机制**"'},"​")],-1)),l[437]||(l[437]=n("p",null,[E("心跳机制，也可以被称为"),n("strong",null,"保活机制"),E("，它的作用就是服务实例告诉注册中心我这个服务实例还活着")],-1)),l[438]||(l[438]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528259-913481484.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[439]||(l[439]=n("ol",null,[n("li",null,"在正常情况下，服务关闭了，那么服务会主动向Nacos服务端发送一个服务下线的请求"),n("li",null,"Nacos服务端在接收到请求之后，会将这个服务实例从服务注册表中剔除"),n("li",null,"但是对于异常情况下，比如出现网络问题，可能导致这个注册的服务实例无法提供服务，处于不可用状态，也就是不健康"),n("li",null,"而此时在没有任何机制的情况下，服务端是无法知道这个服务处于不可用状态")],-1)),l[440]||(l[440]=n("ul",null,[n("li",null,"所以为了避免这种情况，一些注册中心，就比如Nacos、Eureka，就会用心跳机制来判断这个服务实例是否能正常")],-1)),l[441]||(l[441]=n("p",null,[n("strong",null,"在Nacos中，心跳机制仅仅是针对临时实例来说的，临时实例需要靠心跳机制来保活")],-1)),l[442]||(l[442]=n("p",null,"心跳机制在1.x和2.x版本的实现也是不一样的",-1)),l[443]||(l[443]=n("h4",{id:"_1-x心跳实现",tabindex:"-1"},[E("1.x心跳实现 "),n("a",{class:"header-anchor",href:"#_1-x心跳实现","aria-label":'Permalink to "1.x心跳实现"'},"​")],-1)),l[444]||(l[444]=n("p",null,"在1.x中，心跳机制实现是通过客户端和服务端各存在的一个定时任务来完成的",-1)),l[445]||(l[445]=n("p",null,"在服务注册时，发现是临时实例，客户端会开启一个5s执行一次的定时任务",-1)),l[446]||(l[446]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528523-924065766.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[447]||(l[447]=n("p",null,"这个定时任务会构建一个Http请求，携带这个服务实例的信息，然后发送到服务端",-1)),l[448]||(l[448]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528492-911230470.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[449]||(l[449]=n("p",null,"在Nacos服务端也会开启一个定时任务，默认也是5s执行一次，去检查这些服务实例最后一次心跳的时间，也就是客户端最后一次发送Http请求的时间",-1)),l[450]||(l[450]=n("ul",null,[n("li",null,"当最后一次心跳时间超过15s，但没有超过30s，会把这服务实例标记成不健康"),n("li",null,"当最后一次心跳超过30s，直接把服务从服务注册表中剔除")],-1)),l[451]||(l[451]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528559-913709010.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[452]||(l[452]=n("p",null,"这就是1.x版本的心跳机制，本质就是两个定时任务",-1)),l[453]||(l[453]=n("p",null,"其实1.x的这个心跳还有一个作用，就是跟上一节说的gRPC时Redo操作的作用是一样的",-1)),l[454]||(l[454]=n("p",null,"服务在处理心跳的时候，发现心跳携带这个服务实例的信息在注册表中没有，此时就会添加到服务注册表",-1)),l[455]||(l[455]=n("p",null,"所以心跳也有Redo的类似效果",-1)),l[456]||(l[456]=n("h4",{id:"_2-x心跳实现",tabindex:"-1"},[E("2.x心跳实现 "),n("a",{class:"header-anchor",href:"#_2-x心跳实现","aria-label":'Permalink to "2.x心跳实现"'},"​")],-1)),l[457]||(l[457]=n("p",null,"在2.x版本之后，由于通信协议改成了gRPC，客户端与服务端保持长连接，所以2.x版本之后它是利用这个gRPC长连接本身的心跳来保活",-1)),l[458]||(l[458]=n("p",null,"一旦这个连接断开，服务端就会认为这个连接注册的服务实例不可用，之后就会将这个服务实例从服务注册表中提出剔除",-1)),l[459]||(l[459]=n("p",null,"除了连接本身的心跳之外，Nacos还有服务端的一个主动检测机制",-1)),l[460]||(l[460]=n("p",null,"Nacos服务端也会启动一个定时任务，默认每隔3s执行一次",-1)),l[461]||(l[461]=n("p",null,"这个任务会去检查超过20s没有发送请求数据的连接",-1)),l[462]||(l[462]=n("p",null,"一旦发现有连接已经超过20s没发送请求，那么就会向这个连接对应的客户端发送一个请求",-1)),l[463]||(l[463]=n("p",null,"如果请求不通或者响应失败，此时服务端也会认为与客户端的这个连接异常，从而将这个客户端注册的服务实例从服务注册表中剔除",-1)),l[464]||(l[464]=n("p",null,"所以对于2.x版本，主要是两种机制来进行保活：",-1)),l[465]||(l[465]=n("ul",null,[n("li",null,"连接本身的心跳机制，断开就直接剔除服务实例"),n("li",null,"Nacos主动检查机制，服务端会对20s没有发送数据的连接进行检查，出现异常时也会主动断开连接，剔除服务实例")],-1)),l[466]||(l[466]=n("h4",{id:"小总结-1",tabindex:"-1"},[E("小总结 "),n("a",{class:"header-anchor",href:"#小总结-1","aria-label":'Permalink to "小总结"'},"​")],-1)),l[467]||(l[467]=n("p",null,"心跳机制仅仅针对临时实例而言",-1)),l[468]||(l[468]=n("p",null,"1.x心跳机制是通过客户端和服务端两个定时任务来完成的，客户端定时上报心跳信息，服务端定时检查心跳时间，超过15s标记不健康，超过30s直接剔除",-1)),l[469]||(l[469]=n("p",null,"1.x心跳机制还有类似2.x的Redo作用，服务端发现心跳的服务信息不存在会，会将服务信息添加到注册表，相当于重新注册了",-1)),l[470]||(l[470]=n("p",null,"2.x是基于gRPC长连接本身的心跳机制和服务端的定时检查机制来的，出现异常直接剔除",-1)),l[471]||(l[471]=n("h3",{id:"健康检查",tabindex:"-1"},[n("strong",null,"健康检查"),E(),n("a",{class:"header-anchor",href:"#健康检查","aria-label":'Permalink to "**健康检查**"'},"​")],-1)),l[472]||(l[472]=n("p",null,"前面说了，心跳机制仅仅是临时实例用来保护的机制",-1)),l[473]||(l[473]=n("p",null,"而对于永久实例来说，一般来说无法主动上报心跳",-1)),l[474]||(l[474]=n("p",null,"就比如说MySQL实例，肯定是不会主动上报心跳到Nacos的，所以这就导致无法通过心跳机制来保活",-1)),l[475]||(l[475]=n("p",null,[E("所以针对永久实例的情况，Nacos通过一种叫"),n("strong",null,"健康检查"),E("的机制去判断服务实例是否活着")],-1)),l[476]||(l[476]=n("p",null,"健康检查跟心跳机制刚好相反，心跳机制是服务实例向服务端发送请求",-1)),l[477]||(l[477]=n("p",null,[E("而所谓的健康检查就是服务端"),n("strong",null,"主动"),E("向服务实例发送请求，去探测服务实例是否活着")],-1)),l[478]||(l[478]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528418-1061489088.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[479]||(l[479]=n("p",null,"健康检查机制在1.x和2.x的实现机制是一样的",-1)),l[480]||(l[480]=n("p",null,"Nacos服务端在会去创建一个健康检查任务，这个任务每次执行时间间隔会在2000~7000毫秒之间",-1)),l[481]||(l[481]=n("p",null,"当任务触发的时候，会根据设置的健康检查的方式执行不同的逻辑，目前主要有以下三种方式：",-1)),l[482]||(l[482]=n("ul",null,[n("li",null,"TCP"),n("li",null,"HTTP"),n("li",null,"MySQL")],-1)),l[483]||(l[483]=n("p",null,[n("strong",null,"TCP"),E("的方式就是根据服务实例的ip和端口去判断是否能连接成功，如果连接成功，就认为健康，反之就任务不健康")],-1)),l[484]||(l[484]=n("p",null,[n("strong",null,"HTTP"),E("的方式就是向服务实例的ip和端口发送一个Http请求，请求路径是需要设置的，如果能正常请求，说明实例健康，反之就不健康")],-1)),l[485]||(l[485]=n("p",null,[n("strong",null,"MySQL"),E("的方式是一种特殊的检查方式，他可以执行下面这条Sql来判断数据库是不是主库")],-1)),l[486]||(l[486]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528508-97791902.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[487]||(l[487]=n("p",null,"默认情况下，都是通过TCP的方式来探测服务实例是否还活着",-1)),l[488]||(l[488]=n("h3",{id:"服务发现",tabindex:"-1"},[n("strong",null,"服务发现"),E(),n("a",{class:"header-anchor",href:"#服务发现","aria-label":'Permalink to "**服务发现**"'},"​")],-1)),l[489]||(l[489]=n("p",null,"所谓的服务发现就是指当有服务实例注册成功之后，其它服务可以发现这些服务实例",-1)),l[490]||(l[490]=n("p",null,"Nacos提供了两种发现方式：",-1)),l[491]||(l[491]=n("ul",null,[n("li",null,"主动查询"),n("li",null,"服务订阅")],-1)),l[492]||(l[492]=n("p",null,[n("strong",null,"主动查询"),E("就是指客户端主动向服务端查询需要关注的服务实例，也就是拉（pull）的模式")],-1)),l[493]||(l[493]=n("p",null,[n("strong",null,"服务订阅"),E("就是指客户端向服务端发送一个订阅服务的请求，当被订阅的服务有信息变动就会主动将服务实例的信息推送给订阅的客户端，本质就是推（push）模式")],-1)),l[494]||(l[494]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528523-237159426.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[495]||(l[495]=n("p",null,"在我们平时使用时，一般来说都是选择使用订阅的方式，这样一旦有服务实例数据的变动，客户端能够第一时间感知",-1)),l[496]||(l[496]=n("p",null,"并且Nacos在整合SpringCloud的时候，默认就是使用订阅的方式",-1)),l[497]||(l[497]=n("p",null,"对于这两种服务发现方式，1.x和2.x版本实现也是不一样",-1)),l[498]||(l[498]=n("p",null,"服务查询其实两者实现都很简单",-1)),l[499]||(l[499]=n("p",null,"1.x整体就是发送Http请求去查询服务实例，2.x只不过是将Http请求换成了gRPC的请求",-1)),l[500]||(l[500]=n("p",null,"服务端对于查询的处理过程都是一样的，从服务注册表中查出符合查询条件的服务实例进行返回",-1)),l[501]||(l[501]=n("p",null,"不过对于服务订阅，两者的机制就稍微复杂一点",-1)),l[502]||(l[502]=n("p",null,[E("在Nacos客户端，不论是1.x还是2.x都是通过SDK中的"),n("code",null,"NamingService#subscribe"),E("方法来发起订阅的")],-1)),l[503]||(l[503]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528469-1834676389.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[504]||(l[504]=n("p",null,[E("当有服务实例数据变动的时，客户端就会回调"),n("code",null,"EventListener"),E("，就可以拿到最新的服务实例数据了")],-1)),l[505]||(l[505]=n("p",null,"虽然1.x还是2.x都是同样的方法，但是具体的实现逻辑是不一样的",-1)),l[506]||(l[506]=n("h4",{id:"_1-x服务订阅实现",tabindex:"-1"},[E("1.x服务订阅实现 "),n("a",{class:"header-anchor",href:"#_1-x服务订阅实现","aria-label":'Permalink to "1.x服务订阅实现"'},"​")],-1)),l[507]||(l[507]=n("p",null,"在1.x版本的时候，服务订阅的处理逻辑大致会有以下三步：",-1)),l[508]||(l[508]=n("p",null,"第一步，客户端在启动的时候，会去构建一个叫PushReceiver的类",-1)),l[509]||(l[509]=n("p",null,"这个类会去创建一个UDP Socket，端口是随机的",-1)),l[510]||(l[510]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528594-1434590411.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[511]||(l[511]=n("p",null,"其实通过名字就可以知道这个类的作用，就是通过UDP的方式接收服务端推送的数据的",-1)),l[512]||(l[512]=n("p",null,[E("第二步，调用"),n("code",null,"NamingService#subscribe"),E("来发起订阅时，会先去服务端查询需要订阅服务的所有实例信息")],-1)),l[513]||(l[513]=n("p",null,[E("之后会将所有服务实例数据存到客户端的一个"),n("strong",null,"内部缓存中")],-1)),l[514]||(l[514]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528601-739889877.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[515]||(l[515]=n("p",null,"并且在查询的时候，会将这个UDP Socket的端口作为一个参数传到服务端",-1)),l[516]||(l[516]=n("p",null,"服务端接收到这个UDP端口后，后续就通过这个端口给客户端推送服务实例数据",-1)),l[517]||(l[517]=n("p",null,"第三步，会为这次订阅开启一个不定时执行的任务",-1)),l[518]||(l[518]=n("blockquote",null,[n("p",null,"之所以不定时，是因为这个当执行异常的时候，下次执行的时间间隔就会变长，但是最多不超过60s，正常是10s，这个10s是查询服务实例是服务端返回的")],-1)),l[519]||(l[519]=n("p",null,"这个任务会去从服务端查询订阅的服务实例信息，然后更新内部缓存",-1)),l[520]||(l[520]=n("p",null,"这里你可能会有个疑问",-1)),l[521]||(l[521]=n("blockquote",null,[n("p",null,"既然有了服务变动推送的功能，为什么还要定时去查询更新服务实例信息呢?")],-1)),l[522]||(l[522]=n("p",null,"其实很简单，那就是因为UDP通信不稳定导致的",-1)),l[523]||(l[523]=n("p",null,"虽然有Push，但是由于UDP通信自身的不确定性，有可能会导致客户端接收变动信息失败",-1)),l[524]||(l[524]=n("p",null,"所以这里就加了一个定时任务，弥补这种可能性，属于一个兜底的方案。",-1)),l[525]||(l[525]=n("p",null,"这就是1.x版本的服务订阅的实现",-1)),l[526]||(l[526]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528519-1002970787.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[527]||(l[527]=n("h4",{id:"_2-x服务订阅的实现",tabindex:"-1"},[E("2.x服务订阅的实现 "),n("a",{class:"header-anchor",href:"#_2-x服务订阅的实现","aria-label":'Permalink to "2.x服务订阅的实现"'},"​")],-1)),l[528]||(l[528]=n("p",null,"讲完1.x的版本实现，接下来就讲一讲2.x版本的实现",-1)),l[529]||(l[529]=n("p",null,"由于2.x版本换成了gRPC长连接的方式，所以2.x版本服务数据变更推送已经完全抛弃了1.x的UDP做法",-1)),l[530]||(l[530]=n("p",null,"当有服务实例变动的时候，服务端直接通过这个长连接将服务信息发送给客户端",-1)),l[531]||(l[531]=n("p",null,"客户端拿到最新服务实例数据之后的处理方式就跟1.x是一样了",-1)),l[532]||(l[532]=n("p",null,"除了处理方式一样，2.x也继承了1.x的其他的东西",-1)),l[533]||(l[533]=n("p",null,"比如客户端依然会有服务实例的缓存",-1)),l[534]||(l[534]=n("p",null,"定时对比机制也保留了，只不过这个定时对比的机制默认是关闭状态",-1)),l[535]||(l[535]=n("p",null,"之所以默认关闭，主要还是因为长连接还是比较稳定的原因",-1)),l[536]||(l[536]=n("p",null,"当客户端出现异常，接收不到请求，那么服务端会直接跟客户端断开连接",-1)),l[537]||(l[537]=n("p",null,"当恢复正常，由于有Redo操作，所以还是能拿到最新的实例信息的",-1)),l[538]||(l[538]=n("p",null,"所以2.x版本的服务订阅功能的实现大致如下图所示",-1)),l[539]||(l[539]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528417-556658569.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[540]||(l[540]=n("p",null,"这里还有个细节需要注意",-1)),l[541]||(l[541]=n("p",null,"在1.x版本的时候，任何服务都是可以被订阅的",-1)),l[542]||(l[542]=n("p",null,"但是在2.x版本中，只支持订阅临时服务，对于永久服务，已经不支持订阅了",-1)),l[543]||(l[543]=n("h4",{id:"小总结-2",tabindex:"-1"},[E("小总结 "),n("a",{class:"header-anchor",href:"#小总结-2","aria-label":'Permalink to "小总结"'},"​")],-1)),l[544]||(l[544]=n("p",null,"服务查询1.x是通过Http请求；2.x通过gRPC请求",-1)),l[545]||(l[545]=n("p",null,"服务订阅1.x是通过UDP来推送的；2.x就基于gRPC长连接来实现的",-1)),l[546]||(l[546]=n("p",null,"1.x和2.x客户端都有服务实例的缓存，也有定时对比机制，只不过1.x会自动开启；2.x提供了一个开个，可以手动选择是否开启，默认不开启",-1)),l[547]||(l[547]=n("h3",{id:"数据一致性",tabindex:"-1"},[n("strong",null,"数据一致性"),E(),n("a",{class:"header-anchor",href:"#数据一致性","aria-label":'Permalink to "**数据一致性**"'},"​")],-1)),l[548]||(l[548]=n("p",null,"由于Nacos是支持集群模式的，所以一定会涉及到分布式系统中不可避免的数据一致性问题",-1)),l[549]||(l[549]=n("h4",{id:"_1-服务实例的责任机制",tabindex:"-1"},[E("1. 服务实例的责任机制 "),n("a",{class:"header-anchor",href:"#_1-服务实例的责任机制","aria-label":'Permalink to "1. 服务实例的责任机制"'},"​")],-1)),l[550]||(l[550]=n("p",null,"再说数据一致性问题之前，先来讨论一下服务实例的责任机制",-1)),l[551]||(l[551]=n("p",null,"什么是服务实例的责任机制？",-1)),l[552]||(l[552]=n("p",null,"比如上面提到的服务注册、心跳管理、监控检查机制，当只有一个Nacos服务时，那么自然而言这个服务会去检查所有的服务实例的心跳时间，执行所有服务实例的健康检查任务",-1)),l[553]||(l[553]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528262-92834099.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[554]||(l[554]=n("p",null,"但是当出现Nacos服务出现集群时，为了平衡各Nacos服务的压力，Nacos会根据一定的规则让每个Nacos服务只管理一部分服务实例的",-1)),l[555]||(l[555]=n("blockquote",null,[n("p",null,"当然每个Nacos服务的注册表还是全部的服务实例数据")],-1)),l[556]||(l[556]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528630-1621864730.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[557]||(l[557]=n("p",null,[E("这个管理机制我给他起了一个名字，就叫做责任机制，因为我在1.x和2.x都提到了"),n("code",null,"responsible"),E("这个单词")],-1)),l[558]||(l[558]=n("p",null,"本质就是Nacos服务对哪些服务实例负有心跳监测，健康检查的责任。",-1)),l[559]||(l[559]=n("h4",{id:"_2-cap定理和base理论",tabindex:"-1"},[E("2. CAP定理和BASE理论 "),n("a",{class:"header-anchor",href:"#_2-cap定理和base理论","aria-label":'Permalink to "2. CAP定理和BASE理论"'},"​")],-1)),l[560]||(l[560]=n("p",null,"谈到数据一致性问题，一定离不开两个著名分布式理论",-1)),l[561]||(l[561]=n("ul",null,[n("li",null,"CAP定理"),n("li",null,"BASE理论")],-1)),l[562]||(l[562]=n("p",null,"CAP定理中，三个字母分别代表这些含义：",-1)),l[563]||(l[563]=n("ul",null,[n("li",null,"C，Consistency单词的缩写，代表一致性，指分布式系统中各个节点的数据保持强一致，也就是每个时刻都必须一样，不一样整个系统就不能对外提供服务"),n("li",null,"A，Availability单词的缩写，代表可用性，指整个分布式系统保持对外可用，即使从每个节点获取的数据可能都不一样，只要能获取到就行"),n("li",null,"P，Partition tolerance单词的缩写，代表分区容错性。")],-1)),l[564]||(l[564]=n("p",null,"所谓的CAP定理，就是指在一个分布式系统中，CAP这三个指标，最多同时只能满足其中的两个，不可能三个都同时满足",-1)),l[565]||(l[565]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528273-225636223.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[566]||(l[566]=n("p",null,"为什么三者不能同时满足？",-1)),l[567]||(l[567]=n("p",null,"对于一个分布式系统，网络分区是一定需要满足的",-1)),l[568]||(l[568]=n("p",null,"而所谓分区指的是系统中的服务部署在不同的网络区域中",-1)),l[569]||(l[569]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528352-1526114972.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[570]||(l[570]=n("p",null,"比如，同一套系统可能同时在北京和上海都有部署，那么他们就处于不同的网络分区，就可能出现无法互相访问的情况",-1)),l[571]||(l[571]=n("p",null,"当然，你也可以把所有的服务都放在一个网络分区，但是当网络出现故障时，整个系统都无法对外提供服务，那这还有什么意义呢？",-1)),l[572]||(l[572]=n("p",null,"所以分布式系统一定需要满足分区容错性，把系统部署在不同的区域网络中",-1)),l[573]||(l[573]=n("p",null,"此时只剩下了一致性和可用性，它们为什么不能同时满足？",-1)),l[574]||(l[574]=n("p",null,"其实答案很简单，就因为可能出现网络分区导致的通信失败。",-1)),l[575]||(l[575]=n("p",null,"比如说，现在出现了网络分区的问题，上图中的A网络区域和B网络区域无法相互访问",-1)),l[576]||(l[576]=n("p",null,"此时假设往上图中的A网络区域发送请求，将服务中的一个值 i 属性设置成 1",-1)),l[577]||(l[577]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528544-588182152.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[578]||(l[578]=n("p",null,[n("strong",null,"如果保证可用性"),E("，此时由于A和B网络不通，此时只有A中的服务修改成功，B无法修改成功，此时数据AB区域数据就不一致性，也就没有保证数据一致性")],-1)),l[579]||(l[579]=n("p",null,[n("strong",null,"如果保证一致性"),E("，此时由于A和B网络不通，所以此时A也不能修改成功，必须修改失败，否则就会导致AB数据不一致")],-1)),l[580]||(l[580]=n("p",null,"虽然A没修改成功，保证了数据一致性，AB还是之前相同的数据，但是此时整个系统已经没有写可用性了，无法成功写数据了。",-1)),l[581]||(l[581]=n("p",null,[n("strong",null,"所以从上面分析可以看出，在有分区容错性的前提下，可用性和一致性是无法同时保证的。")],-1)),l[582]||(l[582]=n("p",null,"虽然无法同时一致性和可用性，但是能不能换种思路来思考一下这个问题",-1)),l[583]||(l[583]=n("p",null,"首先我们可以先保证系统的可用性，也就是先让系统能够写数据，将A区域服务中的i修改成1",-1)),l[584]||(l[584]=n("p",null,"之后当AB区域之间网络恢复之后，将A区域的i值复制给B区域，这样就能够保证AB区域间的数据最终是一致的了",-1)),l[585]||(l[585]=n("p",null,"这不就皆大欢喜了么",-1)),l[586]||(l[586]=n("p",null,"这种思路其实就是BASE理论的核心要点，优先保证可用性，数据最终达成一致性。",-1)),l[587]||(l[587]=n("p",null,"BASE理论主要是包括以下三点：",-1)),l[588]||(l[588]=n("ul",null,[n("li",null,"基本可用（Basically Available）：系统出现故障还是能够对外提供服务，不至于直接无法用了"),n("li",null,"软状态（Soft State）：允许各个节点的数据不一致"),n("li",null,"最终一致性，（Eventually Consistent）：虽然允许各个节点的数据不一致，但是在一定时间之后，各个节点的数据最终需要一致的")],-1)),l[589]||(l[589]=n("p",null,"BASE理论其实就是妥协之后的产物。",-1)),l[590]||(l[590]=n("h4",{id:"_3-nacos的ap和cp",tabindex:"-1"},[E("3. Nacos的AP和CP "),n("a",{class:"header-anchor",href:"#_3-nacos的ap和cp","aria-label":'Permalink to "3. Nacos的AP和CP"'},"​")],-1)),l[591]||(l[591]=n("p",null,"Nacos其实目前是同时支持AP和CP的",-1)),l[592]||(l[592]=n("p",null,"具体使用AP还是CP得取决于Nacos内部的具体功能，并不是有的文章说的可以通过一个配置自由切换。",-1)),l[593]||(l[593]=n("p",null,"就以服务注册举例来说，对于临时实例来说，Nacos会优先保证可用性，也就是AP",-1)),l[594]||(l[594]=n("p",null,"对于永久实例，Nacos会优先保证数据的一致性，也就是CP",-1)),l[595]||(l[595]=n("p",null,"接下来我们就来讲一讲Nacos的CP和AP的实现原理",-1)),l[596]||(l[596]=n("h5",{id:"_3-1-nacos的ap实现",tabindex:"-1"},[E("3.1. Nacos的AP实现 "),n("a",{class:"header-anchor",href:"#_3-1-nacos的ap实现","aria-label":'Permalink to "3.1. Nacos的AP实现"'},"​")],-1)),l[597]||(l[597]=n("p",null,"对于AP来说，Nacos使用的是阿里自研的Distro协议",-1)),l[598]||(l[598]=n("p",null,"在这个协议中，每个服务端节点是一个平等的状态，每个服务端节点正常情况下数据是一样的，每个服务端节点都可以接收来自客户端的读写请求",-1)),l[599]||(l[599]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528584-2019455475.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[600]||(l[600]=n("p",null,"当某个节点刚启动时，他会向集群中的某个节点发送请求，拉取所有的服务实例数据到自己的服务注册表中",-1)),l[601]||(l[601]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528600-2085582310.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[602]||(l[602]=n("p",null,"这样其它客户端就可以从这个服务节点中获取到服务实例数据了",-1)),l[603]||(l[603]=n("p",null,[E("当某个服务端节点接收到注册"),n("strong",null,"临时服务实例"),E("的请求，不仅仅会将这个服务实例存到自身的服务注册表，同时也会向其它所有服务节点发送请求，将这个服务数据同步到其它所有节点")],-1)),l[604]||(l[604]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528587-300147597.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[605]||(l[605]=n("p",null,"所以此时从任意一个节点都是可以获取到所有的服务实例数据的。",-1)),l[606]||(l[606]=n("p",null,"即使数据同步的过程发生异常，服务实例也成功注册到一个Nacos服务中，对外部而言，整个Nacos集群是可用的，也就达到了AP的效果",-1)),l[607]||(l[607]=n("p",null,"同时为了满足BASE理论，Nacos也有下面两种机制保证最终节点间数据最终是一致的：",-1)),l[608]||(l[608]=n("ul",null,[n("li",null,"失败重试机制"),n("li",null,"定时对比机制")],-1)),l[609]||(l[609]=n("p",null,[n("strong",null,"失败重试机制"),E("是指当数据同步给其它节点失败时，会每隔3s重试一次，直到成功")],-1)),l[610]||(l[610]=n("p",null,[n("strong",null,"定时对比机制"),E("就是指，每个Nacos服务节点会定时向所有的其它服务节点发送一些认证的请求")],-1)),l[611]||(l[611]=n("p",null,[E("这个请求会告诉每个服务节点"),n("strong",null,"自己负责的服务实例"),E("的对应的版本号，这个版本号随着服务实例的变动就会变动")],-1)),l[612]||(l[612]=n("p",null,"如果其它服务节点的数据的版本号跟自己的对不上，那就说明其它服务节点的数据不是最新的",-1)),l[613]||(l[613]=n("p",null,"此时这个Nacos服务节点就会将自己负责的服务实例数据发给不是最新数据的节点，这样就保证了每个节点的数据是一样的了。",-1)),l[614]||(l[614]=n("h5",{id:"_3-2-nacos的cp实现",tabindex:"-1"},[E("3.2. Nacos的CP实现 "),n("a",{class:"header-anchor",href:"#_3-2-nacos的cp实现","aria-label":'Permalink to "3.2. Nacos的CP实现"'},"​")],-1)),l[615]||(l[615]=n("p",null,"Nacos的CP实现是基于Raft算法来实现的",-1)),l[616]||(l[616]=n("p",null,"在1.x版本早期，Nacos是自己手动实现Raft算法",-1)),l[617]||(l[617]=n("p",null,"在2.x版本，Nacos移除了手动实现Raft算法，转而拥抱基于蚂蚁开源的JRaft框架",-1)),l[618]||(l[618]=n("p",null,"在Raft算法，每个节点主要有三个状态",-1)),l[619]||(l[619]=n("ul",null,[n("li",null,"Leader，负责所有的读写请求，一个集群只有一个"),n("li",null,"Follower，从节点，主要是负责复制Leader的数据，保证数据的一致性"),n("li",null,"Candidate，候选节点，最终会变成Leader或者Follower")],-1)),l[620]||(l[620]=n("p",null,"集群启动时都是节点Follower，经过一段时间会转换成Candidate状态，再经过一系列复杂的选择算法，选出一个Leader",-1)),l[621]||(l[621]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528632-1668395587.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[622]||(l[622]=n("blockquote",null,[n("p",null,"这个选举算法比较复杂，完全值得另写一篇文章，这里就不细说了。不过立个flag，如果本篇文章点赞量超过28个，我连夜爆肝，再来一篇。")],-1)),l[623]||(l[623]=n("p",null,"当有写请求时，如果请求的节点不是Leader节点时，会将请求转给Leader节点，由Leader节点处理写请求",-1)),l[624]||(l[624]=n("p",null,[E("比如，有个客户端连到的上图中的"),n("code",null,"Nacos服务2"),E("节点，之后向"),n("code",null,"Nacos服务2"),E("注册服务")],-1)),l[625]||(l[625]=n("p",null,[n("code",null,"Nacos服务2"),E("接收到请求之后，会判断自己是不是Leader节点，发现自己不是")],-1)),l[626]||(l[626]=n("p",null,[E("此时"),n("code",null,"Nacos服务2"),E("就会向Leader节点发送请求，Leader节点接收到请求之后，会处理服务注册的过程")],-1)),l[627]||(l[627]=n("p",null,"为什么说Raft是保证CP的呢？",-1)),l[628]||(l[628]=n("p",null,"主要是因为Raft在处理写的时候有一个判断过程",-1)),l[629]||(l[629]=n("ul",null,[n("li",null,"首先，Leader在处理写请求时，不会直接数据应用到自己的系统，而是先向所有的Follower发送请求，让他们先处理这个请求"),n("li",null,"当超过半数的Follower成功处理了这个写请求之后，Leader才会写数据，并返回给客户端请求处理成功"),n("li",null,"如果超过一定时间未收到超过半数处理成功Follower的信号，此时Leader认为这次写数据是失败的，就不会处理写请求，直接返回给客户端请求失败")],-1)),l[630]||(l[630]=n("p",null,"所以，一旦发生故障，导致接收不到半数的Follower写成功的响应，整个集群就直接写失败，这就很符合CP的概念了。",-1)),l[631]||(l[631]=n("p",null,"不过这里还有一个小细节需要注意",-1)),l[632]||(l[632]=n("p",null,"Nacos在处理查询服务实例的请求直接时，并不会将请求转发给Leader节点处理，而是直接查当前Nacos服务实例的注册表",-1)),l[633]||(l[633]=n("p",null,"这其实就会引发一个问题",-1)),l[634]||(l[634]=n("p",null,"如果客户端查询的Follower节点没有及时处理Leader同步过来的写请求（过半响应的节点中不包括这个节点），此时在这个Follower其实是查不到最新的数据的，这就会导致数据的不一致",-1)),l[635]||(l[635]=n("p",null,"所以说，虽然Raft协议规定要求从Leader节点查最新的数据，但是Nacos至少在读服务实例数据时并没有遵守这个协议",-1)),l[636]||(l[636]=n("p",null,"当然对于其它的一些数据的读写请求有的还是遵守了这个协议。",-1)),l[637]||(l[637]=n("blockquote",null,[n("p",null,"JRaft对于读请求其实是做了很多优化的，其实从Follower节点通过一定的机制也是能够保证读到最新的数据")],-1)),l[638]||(l[638]=n("h3",{id:"数据模型",tabindex:"-1"},[n("strong",null,"数据模型"),E(),n("a",{class:"header-anchor",href:"#数据模型","aria-label":'Permalink to "**数据模型**"'},"​")],-1)),l[639]||(l[639]=n("p",null,"在Nacos中，一个服务的确定是由三部分信息确定",-1)),l[640]||(l[640]=n("ul",null,[n("li",null,[E("命名空间（Namespace）：多租户隔离用的，默认是"),n("code",null,"public")]),n("li",null,[E("分组（Group）：这个其实可以用来做环境隔离，服务注册时可以指定服务的分组，比如是测试环境或者是开发环境，默认是"),n("code",null,"DEFAULT_GROUP")]),n("li",null,"服务名（ServiceName）：这个就不用多说了")],-1)),l[641]||(l[641]=n("p",null,"通过上面三者就可以确定同一个服务了",-1)),l[642]||(l[642]=n("p",null,"在服务注册和订阅的时候，必须要指定上述三部分信息，如果不指定，Nacos就会提供默认的信息",-1)),l[643]||(l[643]=n("p",null,"不过，在Nacos中，在服务里面其实还是有一个集群的概念",-1)),l[644]||(l[644]=n("figure",null,[n("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/2880613-20240312164528669-334439921.png",alt:"img",loading:"lazy",decoding:"async",class:"lazy"})],-1)),l[645]||(l[645]=n("p",null,[E("在服务注册的时候，可以指定这个服务实例在哪个集体的集群中，默认是在"),n("code",null,"DEFAULT"),E("集群下")],-1)),l[646]||(l[646]=n("p",null,"在SpringCloud环境底下可以通过如下配置去设置",-1)),l[647]||(l[647]=n("div",{class:"language-yaml max-h-300px"},[n("button",{title:"Copy code",class:"copy"}),n("span",{class:"lang"},"yaml"),n("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[n("code",{"v-pre":""},[n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"spring")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  cloud"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    nacos"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"      discovery"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),E("\n"),n("span",{class:"line"},[n("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        cluster-name"),n("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),n("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"sanyoujavaCluster")])])]),n("button",{class:"code-block-unfold-btn"})],-1)),l[648]||(l[648]=n("p",null,"在服务订阅的时候，可以指定订阅哪些集群下的服务实例",-1)),l[649]||(l[649]=n("p",null,"当然，也可以不指定，如果不指定话，默认就是订阅这个服务下的所有集群的服务实例",-1)),l[650]||(l[650]=n("p",null,"我们日常使用中可以将部署在相同区域的服务划分为同一个集群，比如杭州属于一个集群，上海属于一个集群",-1)),l[651]||(l[651]=n("p",null,"这样服务调用的时候，就可以优先使用同一个地区的服务了，比跨区域调用速度更快。",-1))]),"main-header":t(()=>[k(s.$slots,"main-header")]),"main-header-after":t(()=>[k(s.$slots,"main-header-after")]),"main-nav":t(()=>[k(s.$slots,"main-nav")]),"main-content-before":t(()=>[k(s.$slots,"main-content-before")]),"main-content":t(()=>[k(s.$slots,"main-content")]),"main-content-after":t(()=>[k(s.$slots,"main-content-after")]),"main-nav-before":t(()=>[k(s.$slots,"main-nav-before")]),"main-nav-after":t(()=>[k(s.$slots,"main-nav-after")]),comment:t(()=>[k(s.$slots,"comment")]),footer:t(()=>[k(s.$slots,"footer")]),aside:t(()=>[k(s.$slots,"aside")]),"aside-custom":t(()=>[k(s.$slots,"aside-custom")]),default:t(()=>[k(s.$slots,"default")]),_:3},8,["frontmatter"])}}};export{y as default,d as usePageData};
