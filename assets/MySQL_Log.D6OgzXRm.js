var u=(k,o,e)=>new Promise((g,p)=>{var r=a=>{try{h(e.next(a))}catch(i){p(i)}},d=a=>{try{h(e.throw(a))}catch(i){p(i)}},h=a=>a.done?g(a.value):Promise.resolve(a.value).then(r,d);h((e=e.apply(k,o)).next())});import{_ as E}from"./ValaxyMain.vue_vue_type_style_index_0_lang.CDNsmhz3.js";import"./chunks/@vueuse/motion.C0680yyY.js";import{d as b,a as m,u as F}from"./chunks/vue-router.BrUfGvTC.js";import{a1 as C,a3 as t,a4 as n,a5 as s,a6 as c,a7 as l,F as f,a2 as v,Z as D}from"./framework.CyQERZzy.js";import"./app.BPzKOdEP.js";import"./chunks/dayjs.BSMtxqtT.js";import"./chunks/vue-i18n.CvwbWgfE.js";import"./chunks/pinia.CyvRWuDa.js";import"./chunks/nprogress.c3ZdlDjC.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.BIbThCyp.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.Du2MZPyS.js";import"./post.BkCOJq1d.js";const A=b("/posts/MySQL_Log",k=>u(null,null,function*(){return JSON.parse('{"title":"MySQL - 日志","description":"","frontmatter":{"title":"MySQL - 日志","author":"imklaus","tags":["SQL"],"categories":["MySQL","日志篇"],"date":"2025-3-19 01:00:07","outline":"deep","excerpt_type":"html","end":true},"headers":[],"relativePath":"pages/posts/MySQL_Log.md","lastUpdated":null}')}),{lazy:(k,o)=>k.name===o.name}),W={__name:"MySQL_Log",setup(k,{expose:o}){var h;const{data:e}=A(),g=F(),p=m(),r=Object.assign(p.meta.frontmatter||{},((h=e.value)==null?void 0:h.frontmatter)||{});return g.currentRoute.value.data=e.value,D("valaxy:frontmatter",r),globalThis.$frontmatter=r,o({frontmatter:{title:"MySQL - 日志",author:"imklaus",tags:["SQL"],categories:["MySQL","日志篇"],date:"2025-3-19 01:00:07",outline:"deep",excerpt_type:"html",end:!0}}),(a,i)=>{const y=E;return v(),C(y,{frontmatter:f(r)},{"main-content-md":t(()=>[i[0]||(i[0]=s("h3",{id:"日志分类",tabindex:"-1"},[l("日志分类 "),s("a",{class:"header-anchor",href:"#日志分类","aria-label":'Permalink to "日志分类"'},"​")],-1)),i[1]||(i[1]=s("p",null,"在任何一种数据库中，都会有各种各样的日志，记录着数据库工作的过程，可以帮助数据库管理员追踪数据库曾经发生过的各种事件",-1)),i[2]||(i[2]=s("p",null,"MySQL日志主要包括六种：",-1)),i[3]||(i[3]=s("ol",null,[s("li",null,"重做日志（redo log）"),s("li",null,"回滚日志（undo log）"),s("li",null,"归档日志（binlog）（二进制日志）"),s("li",null,"错误日志（errorlog）"),s("li",null,"慢查询日志（slow query log）"),s("li",null,"一般查询日志（general log）"),s("li",null,"中继日志（relay log）")],-1)),c(" more "),i[4]||(i[4]=s("hr",null,null,-1)),i[5]||(i[5]=s("h3",{id:"错误日志",tabindex:"-1"},[l("错误日志 "),s("a",{class:"header-anchor",href:"#错误日志","aria-label":'Permalink to "错误日志"'},"​")],-1)),i[6]||(i[6]=s("p",null,"错误日志是 MySQL 中最重要的日志之一，记录了当 mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，可以首先查看此日志",-1)),i[7]||(i[7]=s("p",null,[l("该日志是默认开启的，默认位置是："),s("code",null,"/var/log/mysql/error.log")],-1)),i[8]||(i[8]=s("p",null,"查看指令：",-1)),i[9]||(i[9]=s("div",{class:"language-sql max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sql"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SHOW VARIABLES "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"LIKE"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'log_error%'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),i[10]||(i[10]=s("p",null,"查看日志内容：",-1)),i[11]||(i[11]=s("div",{class:"language-sh max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sh"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tail"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -f"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /var/log/mysql/error.log")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),i[12]||(i[12]=s("hr",null,null,-1)),i[13]||(i[13]=s("h3",{id:"归档日志",tabindex:"-1"},[l("归档日志 "),s("a",{class:"header-anchor",href:"#归档日志","aria-label":'Permalink to "归档日志"'},"​")],-1)),i[14]||(i[14]=s("h4",{id:"基本介绍",tabindex:"-1"},[l("基本介绍 "),s("a",{class:"header-anchor",href:"#基本介绍","aria-label":'Permalink to "基本介绍"'},"​")],-1)),i[15]||(i[15]=s("p",null,[l("归档日志（BINLOG）也叫二进制日志，是因为采用二进制进行存储，记录了所有的 DDL（数据定义语言）语句和 DML（数据操作语言）语句，但"),s("strong",null,"不包括数据查询语句，在事务提交前的最后阶段写入")],-1)),i[16]||(i[16]=s("p",null,[l("作用："),s("strong",null,"灾难时的数据恢复和 MySQL 的主从复制")],-1)),i[17]||(i[17]=s("p",null,"归档日志默认情况下是没有开启的，需要在 MySQL 配置文件中开启，并配置 MySQL 日志的格式：",-1)),i[18]||(i[18]=s("div",{class:"language-sh max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sh"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"cd"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /etc/mysql")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"vim"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," my.cnf")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 配置开启binlog日志， 日志的文件前缀为 mysqlbin -----> 生成的文件名如: mysqlbin.000001")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"log_bin"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mysqlbin")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 配置二进制日志的格式")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"binlog_format"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"STATEMENT")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),i[19]||(i[19]=s("p",null,"日志存放位置：配置时给定了文件名但是没有指定路径，日志默认写入MySQL 的数据目录",-1)),i[20]||(i[20]=s("p",null,"日志格式：",-1)),i[21]||(i[21]=s("ul",null,[s("li",null,[s("p",null,[l("STATEMENT：该日志格式在日志文件中记录的都是 "),s("strong",null,"SQL 语句"),l("，每一条对数据进行修改的 SQL 都会记录在日志文件中，通过 mysqlbinlog 工具，可以查看到每条语句的文本。主从复制时，从库会将日志解析为原语句，并在从库重新执行一遍")]),s("p",null,"缺点：可能会导致主备不一致，因为记录的 SQL 在不同的环境中可能选择的索引不同，导致结果不同")]),s("li",null,[s("p",null,[l("ROW：该日志格式在日志文件中记录的是每一行的"),s("strong",null,"数据变更"),l("，而不是记录 SQL 语句。比如执行 SQL 语句 "),s("code",null,"update tb_book set status='1'"),l("，如果是 STATEMENT，在日志中会记录一行 SQL 语句； 如果是 ROW，由于是对全表进行更新，就是每一行记录都会发生变更，ROW 格式的日志中会记录每一行的数据变更")]),s("p",null,"缺点：记录的数据比较多，占用很多的存储空间")]),s("li",null,[s("p",null,"MIXED：这是 MySQL 默认的日志格式，混合了STATEMENT 和 ROW 两种格式，MIXED 格式能尽量利用两种模式的优点，而避开它们的缺点")])],-1)),i[22]||(i[22]=s("hr",null,null,-1)),i[23]||(i[23]=s("h4",{id:"日志刷盘",tabindex:"-1"},[l("日志刷盘 "),s("a",{class:"header-anchor",href:"#日志刷盘","aria-label":'Permalink to "日志刷盘"'},"​")],-1)),i[24]||(i[24]=s("p",null,"事务执行过程中，先将日志写（write）到 binlog cache，事务提交时再把 binlog cache 写（fsync）到 binlog 文件中，一个事务的 binlog 是不能被拆开的，所以不论这个事务多大也要确保一次性写入",-1)),i[25]||(i[25]=s("p",null,"事务提交时执行器把 binlog cache 里的完整事务写入到 binlog 中，并清空 binlog cache",-1)),i[26]||(i[26]=s("p",null,"write 和 fsync 的时机由参数 sync_binlog 控制的：",-1)),i[27]||(i[27]=s("ul",null,[s("li",null,"sync_binlog=0：表示每次提交事务都只 write，不 fsync"),s("li",null,"sync_binlog=1：表示每次提交事务都会执行 fsync"),s("li",null,"sync_binlog=N(N>1)：表示每次提交事务都 write，但累积 N 个事务后才 fsync，但是如果主机发生异常重启，会丢失最近 N 个事务的 binlog 日志")],-1)),i[28]||(i[28]=s("hr",null,null,-1)),i[29]||(i[29]=s("h4",{id:"日志读取",tabindex:"-1"},[l("日志读取 "),s("a",{class:"header-anchor",href:"#日志读取","aria-label":'Permalink to "日志读取"'},"​")],-1)),i[30]||(i[30]=s("p",null,"日志文件存储位置：/var/lib/mysql",-1)),i[31]||(i[31]=s("p",null,"由于日志以二进制方式存储，不能直接读取，需要用 mysqlbinlog 工具来查看，语法如下：",-1)),i[32]||(i[32]=s("div",{class:"language-sh max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sh"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mysqlbinlog"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," log-file"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),i[33]||(i[33]=s("p",null,"查看 STATEMENT 格式日志：",-1)),i[34]||(i[34]=s("ul",null,[s("li",null,[s("p",null,"执行插入语句："),s("div",{class:"language-sql max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sql"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"INSERT INTO"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VALUES"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"NULL"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'Lucene'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'2088-05-01'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'0'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")])])]),s("button",{class:"code-block-unfold-btn"})])]),s("li",null,[s("p",null,[s("code",null,"cd /var/lib/mysql"),l("：")]),s("div",{class:"language-sh max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sh"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"-rw-r-----"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  1"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"      177"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 5月"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  23"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 21:08"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysqlbin.000001")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"-rw-r-----"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  1"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysql"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"       18"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 5月"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"  23"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 21:04"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysqlbin.index")])])]),s("button",{class:"code-block-unfold-btn"})]),s("p",null,"mysqlbin.index：该文件是日志索引文件 ， 记录日志的文件名；"),s("p",null,"mysqlbing.000001：日志文件")]),s("li",null,[s("p",null,"查看日志内容："),s("div",{class:"language-sh max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sh"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mysqlbinlog"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mysqlbing.000001"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),s("button",{class:"code-block-unfold-btn"})]),s("figure",null,[s("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013217813.png",alt:"image-20250320013217813",loading:"lazy",decoding:"async",class:"lazy"})]),s("p",null,"日志结尾有 COMMIT")])],-1)),i[35]||(i[35]=s("p",null,"查看 ROW 格式日志：",-1)),i[36]||(i[36]=s("ul",null,[s("li",null,[s("p",null,"修改配置："),s("div",{class:"language-sh max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sh"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 配置二进制日志的格式")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"binlog_format"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"ROW")])])]),s("button",{class:"code-block-unfold-btn"})])]),s("li",null,[s("p",null,"插入数据："),s("div",{class:"language-sql max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sql"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"INSERT INTO"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"VALUES"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"NULL"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'SpringCloud实战'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'2088-05-05'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'0'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")])])]),s("button",{class:"code-block-unfold-btn"})])]),s("li",null,[s("p",null,"查看日志内容：日志格式 ROW，直接查看数据是乱码，可以在 mysqlbinlog 后面加上参数 -vv"),s("div",{class:"language-sql max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sql"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"mysqlbinlog "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"vv "),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"mysqlbin"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"000002")])])]),s("button",{class:"code-block-unfold-btn"})]),s("figure",null,[s("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013258023.png",alt:"image-20250320013258023",loading:"lazy",decoding:"async",class:"lazy"})])])],-1)),i[37]||(i[37]=s("hr",null,null,-1)),i[38]||(i[38]=s("h4",{id:"日志删除",tabindex:"-1"},[l("日志删除 "),s("a",{class:"header-anchor",href:"#日志删除","aria-label":'Permalink to "日志删除"'},"​")],-1)),i[39]||(i[39]=s("p",null,"对于比较繁忙的系统，生成日志量大，这些日志如果长时间不清除，将会占用大量的磁盘空间，需要删除日志",-1)),i[40]||(i[40]=s("ul",null,[s("li",null,[s("p",null,"Reset Master 指令删除全部 binlog 日志，删除之后，日志编号将从 xxxx.000001重新开始"),s("div",{class:"language-sql max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sql"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Reset"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," Master"),s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"	-- MySQL指令")])])]),s("button",{class:"code-block-unfold-btn"})])]),s("li",null,[s("p",null,[l("执行指令 "),s("code",null,"PURGE MASTER LOGS TO 'mysqlbin.***"),l("，该命令将删除 "),s("code",null," ***"),l(" 编号之前的所有日志")])]),s("li",null,[s("p",null,[l("执行指令 "),s("code",null,"PURGE MASTER LOGS BEFORE 'yyyy-mm-dd hh:mm:ss'"),l(" ，该命令将删除日志为 "),s("code",null,"yyyy-mm-dd hh:mm:ss"),l(" 之前产生的日志")])]),s("li",null,[s("p",null,[l("设置参数 "),s("code",null,"--expire_logs_days=#"),l("，此参数的含义是设置日志的过期天数，过了指定的天数后日志将会被自动删除，这样做有利于减少管理日志的工作量，配置 my.cnf 文件：")]),s("div",{class:"language-sh max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sh"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"log_bin"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mysqlbin")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"binlog_format"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"ROW")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"--expire_logs_days"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"3")])])]),s("button",{class:"code-block-unfold-btn"})])])],-1)),i[41]||(i[41]=s("hr",null,null,-1)),i[42]||(i[42]=s("h4",{id:"数据恢复",tabindex:"-1"},[l("数据恢复 "),s("a",{class:"header-anchor",href:"#数据恢复","aria-label":'Permalink to "数据恢复"'},"​")],-1)),i[43]||(i[43]=s("p",null,"误删库或者表时，需要根据 binlog 进行数据恢复",-1)),i[44]||(i[44]=s("p",null,"一般情况下数据库有定时的全量备份，假如每天 0 点定时备份，12 点误删了库，恢复流程：",-1)),i[45]||(i[45]=s("ul",null,[s("li",null,"取最近一次全量备份，用备份恢复出一个临时库"),s("li",null,"从日志文件中取出凌晨 0 点之后的日志"),s("li",null,"把除了误删除数据的语句外日志，全部应用到临时库")],-1)),i[46]||(i[46]=s("p",null,"跳过误删除语句日志的方法：",-1)),i[47]||(i[47]=s("ul",null,[s("li",null,"如果原实例没有使用 GTID 模式，只能在应用到包含 12 点的 binlog 文件的时候，先用 –stop-position 参数执行到误操作之前的日志，然后再用 –start-position 从误操作之后的日志继续执行"),s("li",null,"如果实例使用了 GTID 模式，假设误操作命令的 GTID 是 gtid1，那么只需要提交一个空事务先将这个 GTID 加到临时实例的 GTID 集合，之后按顺序执行 binlog 的时就会自动跳过误操作的语句")],-1)),i[48]||(i[48]=s("hr",null,null,-1)),i[49]||(i[49]=s("h3",{id:"查询日志",tabindex:"-1"},[l("查询日志 "),s("a",{class:"header-anchor",href:"#查询日志","aria-label":'Permalink to "查询日志"'},"​")],-1)),i[50]||(i[50]=s("p",null,"查询日志中记录了客户端的所有操作语句，而二进制日志不包含查询数据的 SQL 语句",-1)),i[51]||(i[51]=s("p",null,"默认情况下，查询日志是未开启的。如果需要开启查询日志，配置 my.cnf：",-1)),i[52]||(i[52]=s("div",{class:"language-sh max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sh"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 该选项用来开启查询日志，可选值0或者1，0代表关闭，1代表开启 ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"general_log"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"1")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 设置日志的文件名，如果没有指定，默认的文件名为host_name.log，存放在/var/lib/mysql")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"general_log_file"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mysql_query.log")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),i[53]||(i[53]=s("p",null,"配置完毕之后，在数据库执行以下操作：",-1)),i[54]||(i[54]=s("div",{class:"language-sql max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sql"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WHERE"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"UPDATE"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SET"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," name"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'lucene入门指南'"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," WHERE"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 5"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"SELECT"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," FROM"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tb_book "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WHERE"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," id "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 8")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),i[55]||(i[55]=s("p",null,"执行完毕之后， 再次来查询日志文件：",-1)),i[56]||(i[56]=s("figure",null,[s("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013318003.png",alt:"image-20250320013318003",loading:"lazy",decoding:"async",class:"lazy"})],-1)),i[57]||(i[57]=s("hr",null,null,-1)),i[58]||(i[58]=s("h3",{id:"慢日志",tabindex:"-1"},[l("慢日志 "),s("a",{class:"header-anchor",href:"#慢日志","aria-label":'Permalink to "慢日志"'},"​")],-1)),i[59]||(i[59]=s("p",null,"慢查询日志记录所有执行时间超过 long_query_time 并且扫描记录数不小于 min_examined_row_limit 的所有的 SQL 语句的日志long_query_time 默认为 10 秒，最小为 0， 精度到微秒",-1)),i[60]||(i[60]=s("p",null,[l("慢查询日志默认是关闭的，可以通过两个参数来控制慢查询日志，配置文件 "),s("code",null,"/etc/mysql/my.cnf"),l("：")],-1)),i[61]||(i[61]=s("div",{class:"language-sh max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sh"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 该参数用来控制慢查询日志是否开启，可选值0或者1，0代表关闭，1代表开启 ")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"slow_query_log"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"1"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 该参数用来指定慢查询日志的文件名，存放在 /var/lib/mysql")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"slow_query_log_file"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"slow_query.log")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 该选项用来配置查询的时间限制，超过这个时间将认为值慢查询，将需要进行日志记录，默认10s")]),l(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"long_query_time"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"10")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),i[62]||(i[62]=s("p",null,"日志读取：",-1)),i[63]||(i[63]=s("ul",null,[s("li",null,[s("p",null,"直接通过 cat 指令查询该日志文件："),s("div",{class:"language-sh max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sh"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cat"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," slow_query.log")])])]),s("button",{class:"code-block-unfold-btn"})]),s("figure",null,[s("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013338559.png",alt:"image-20250320013338559",loading:"lazy",decoding:"async",class:"lazy"})])]),s("li",null,[s("p",null,"如果慢查询日志内容很多，直接查看文件比较繁琐，可以借助 mysql 自带的 mysqldumpslow 工具对慢查询日志进行分类汇总："),s("div",{class:"language-sh max-h-300px"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"sh"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"mysqldumpslow"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," slow_query.log")])])]),s("button",{class:"code-block-unfold-btn"})]),s("figure",null,[s("img",{src:"https://gcore.jsdelivr.net/gh/imLKlauS/blog-picture@main/blogs/image-20250320013349361.png",alt:"image-20250320013349361",loading:"lazy",decoding:"async",class:"lazy"})])])],-1))]),"main-header":t(()=>[n(a.$slots,"main-header")]),"main-header-after":t(()=>[n(a.$slots,"main-header-after")]),"main-nav":t(()=>[n(a.$slots,"main-nav")]),"main-content-before":t(()=>[n(a.$slots,"main-content-before")]),"main-content":t(()=>[n(a.$slots,"main-content")]),"main-content-after":t(()=>[n(a.$slots,"main-content-after")]),"main-nav-before":t(()=>[n(a.$slots,"main-nav-before")]),"main-nav-after":t(()=>[n(a.$slots,"main-nav-after")]),comment:t(()=>[n(a.$slots,"comment")]),footer:t(()=>[n(a.$slots,"footer")]),aside:t(()=>[n(a.$slots,"aside")]),"aside-custom":t(()=>[n(a.$slots,"aside-custom")]),default:t(()=>[n(a.$slots,"default")]),_:3},8,["frontmatter"])}}};export{W as default,A as usePageData};
