import{_ as l,u as s,p as o,c as n,w as e,a,o as t,b as r,d as c,e as p,r as y,f as E}from"../../assets/app-c31cbd14.js";const i=JSON.parse('{"title":"mall项目总结","description":"基于微服务架构的商品贸易平台","frontmatter":{"cover":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-8oev1j_1920x1080.png","title":"mall项目总结","description":"基于微服务架构的商品贸易平台","top":200,"author":"imklaus","tags":["Spring Boot","Spring Cloud","Spring Cloud Alibaba","MySQL","MyBatis-Plus","Redis","RabbitMQ"],"categories":"Java","date":"2023-04-12T00:45:36.000Z","outline":"deep"},"headers":[{"level":2,"title":"项目名称","slug":"项目名称","link":"#项目名称","children":[]},{"level":2,"title":"项目简介","slug":"项目简介","link":"#项目简介","children":[]},{"level":2,"title":"系统架构","slug":"系统架构","link":"#系统架构","children":[]},{"level":2,"title":"我的职责","slug":"我的职责","link":"#我的职责","children":[]},{"level":2,"title":"项目概述","slug":"项目概述","link":"#项目概述","children":[{"level":3,"title":"核心业务一：购物车","slug":"核心业务一-购物车","link":"#核心业务一-购物车","children":[]},{"level":3,"title":"核心业务二：订单","slug":"核心业务二-订单","link":"#核心业务二-订单","children":[]},{"level":3,"title":"项目难点","slug":"项目难点","link":"#项目难点","children":[]},{"level":3,"title":"解决问题","slug":"解决问题","link":"#解决问题","children":[]},{"level":3,"title":"项目优化","slug":"项目优化","link":"#项目优化","children":[]}]},{"level":2,"title":"CompletableFuture异步编排","slug":"completablefuture异步编排","link":"#completablefuture异步编排","children":[{"level":3,"title":"概念","slug":"概念","link":"#概念","children":[]},{"level":3,"title":"业务场景","slug":"业务场景","link":"#业务场景","children":[]},{"level":3,"title":"项目代码","slug":"项目代码","link":"#项目代码","children":[]}]},{"level":2,"title":"RabbitMQ延时队列（实现定时任务）","slug":"rabbitmq延时队列-实现定时任务","link":"#rabbitmq延时队列-实现定时任务","children":[{"level":3,"title":"场景：","slug":"场景","link":"#场景","children":[]},{"level":3,"title":"消息的TTL（Time To Live）","slug":"消息的ttl-time-to-live","link":"#消息的ttl-time-to-live","children":[]},{"level":3,"title":"Dead Letter Exchanges（DLX）","slug":"dead-letter-exchanges-dlx","link":"#dead-letter-exchanges-dlx","children":[]},{"level":3,"title":"延时队列实现","slug":"延时队列实现","link":"#延时队列实现","children":[]},{"level":3,"title":"SpringBoot中使用延时队列","slug":"springboot中使用延时队列","link":"#springboot中使用延时队列","children":[]},{"level":3,"title":"消息队列流程","slug":"消息队列流程","link":"#消息队列流程","children":[]}]},{"level":2,"title":"Redis缓存中的数据结构","slug":"redis缓存中的数据结构","link":"#redis缓存中的数据结构","children":[{"level":3,"title":"分类菜单","slug":"分类菜单","link":"#分类菜单","children":[]},{"level":3,"title":"登陆信息-SpringSession","slug":"登陆信息-springsession","link":"#登陆信息-springsession","children":[]},{"level":3,"title":"购物车","slug":"购物车","link":"#购物车","children":[]},{"level":3,"title":"秒杀上架 (幂等性处理)","slug":"秒杀上架-幂等性处理","link":"#秒杀上架-幂等性处理","children":[]},{"level":3,"title":"幂等性保证","slug":"幂等性保证","link":"#幂等性保证","children":[]},{"level":3,"title":"Redission分布式锁","slug":"redission分布式锁","link":"#redission分布式锁","children":[]}]},{"level":2,"title":"分布式事务","slug":"分布式事务","link":"#分布式事务","children":[{"level":3,"title":"事务的坑","slug":"事务的坑","link":"#事务的坑","children":[]},{"level":3,"title":"CAP理论","slug":"cap理论","link":"#cap理论","children":[]},{"level":3,"title":"BASE 理论","slug":"base-理论","link":"#base-理论","children":[]},{"level":3,"title":"分布式事务几种方案","slug":"分布式事务几种方案","link":"#分布式事务几种方案","children":[]}]},{"level":2,"title":"Seata","slug":"seata","link":"#seata","children":[{"level":3,"title":"Seata的理解","slug":"seata的理解","link":"#seata的理解","children":[]},{"level":3,"title":"Seata项目整合","slug":"seata项目整合","link":"#seata项目整合","children":[]}]},{"level":2,"title":"Sentinel","slug":"sentinel","link":"#sentinel","children":[{"level":3,"title":"Sentinel理解","slug":"sentinel理解","link":"#sentinel理解","children":[]},{"level":3,"title":"熔断降级限流","slug":"熔断降级限流","link":"#熔断降级限流","children":[]},{"level":3,"title":"项目整合步骤","slug":"项目整合步骤","link":"#项目整合步骤","children":[]},{"level":3,"title":"整合 Feign+Sentinel 测试熔断降级","slug":"整合-feign-sentinel-测试熔断降级","link":"#整合-feign-sentinel-测试熔断降级","children":[]}]},{"level":2,"title":"Nacos","slug":"nacos","link":"#nacos","children":[{"level":3,"title":"项目整合","slug":"项目整合","link":"#项目整合","children":[]},{"level":3,"title":"Nacos作为注册中心：","slug":"nacos作为注册中心","link":"#nacos作为注册中心","children":[]},{"level":3,"title":"Nacos作为配置中心","slug":"nacos作为配置中心","link":"#nacos作为配置中心","children":[]},{"level":3,"title":"Nacos进阶","slug":"nacos进阶","link":"#nacos进阶","children":[]}]},{"level":2,"title":"Gateway","slug":"gateway","link":"#gateway","children":[]},{"level":2,"title":"Feign","slug":"feign","link":"#feign","children":[{"level":3,"title":"Feign远程调用丢失请求头问题","slug":"feign远程调用丢失请求头问题","link":"#feign远程调用丢失请求头问题","children":[]},{"level":3,"title":"Feign异步情况丢失上下文问题","slug":"feign异步情况丢失上下文问题","link":"#feign异步情况丢失上下文问题","children":[]}]},{"level":2,"title":"SpringCloud Alibaba 常用组件端口号总结","slug":"springcloud-alibaba-常用组件端口号总结","link":"#springcloud-alibaba-常用组件端口号总结","children":[]},{"level":2,"title":"支付","slug":"支付","link":"#支付","children":[{"level":3,"title":"加密-对称加密","slug":"加密-对称加密","link":"#加密-对称加密","children":[]},{"level":3,"title":"加密-非对称加密","slug":"加密-非对称加密","link":"#加密-非对称加密","children":[]},{"level":3,"title":"支付宝验签","slug":"支付宝验签","link":"#支付宝验签","children":[]},{"level":3,"title":"收单","slug":"收单","link":"#收单","children":[]}]},{"level":2,"title":"MD5&MD5盐值加密","slug":"md5-md5盐值加密","link":"#md5-md5盐值加密","children":[]},{"level":2,"title":"项目微服务","slug":"项目微服务","link":"#项目微服务","children":[]},{"level":2,"title":"Nginx+Windows搭建域名访问环境","slug":"nginx-windows搭建域名访问环境","link":"#nginx-windows搭建域名访问环境","children":[{"level":3,"title":"域名映射效果","slug":"域名映射效果","link":"#域名映射效果","children":[]},{"level":3,"title":"正向代理与反向代理","slug":"正向代理与反向代理","link":"#正向代理与反向代理","children":[]},{"level":3,"title":"Nginx配置文件","slug":"nginx配置文件","link":"#nginx配置文件","children":[]},{"level":3,"title":"Nginx动静分离","slug":"nginx动静分离","link":"#nginx动静分离","children":[]},{"level":3,"title":"Nginx转发效果","slug":"nginx转发效果","link":"#nginx转发效果","children":[]}]},{"level":2,"title":"内网穿透","slug":"内网穿透","link":"#内网穿透","children":[{"level":3,"title":"内网穿透联调","slug":"内网穿透联调","link":"#内网穿透联调","children":[]},{"level":3,"title":"配置","slug":"配置","link":"#配置","children":[]}]},{"level":2,"title":"缓存","slug":"缓存","link":"#缓存","children":[{"level":3,"title":"本地缓存","slug":"本地缓存","link":"#本地缓存","children":[]},{"level":3,"title":"分布式缓存-本地模式在分布式下的问题","slug":"分布式缓存-本地模式在分布式下的问题","link":"#分布式缓存-本地模式在分布式下的问题","children":[]},{"level":3,"title":"分布式缓存","slug":"分布式缓存","link":"#分布式缓存","children":[]},{"level":3,"title":"分布式下如何加锁？","slug":"分布式下如何加锁","link":"#分布式下如何加锁","children":[]},{"level":3,"title":"锁-时序问题","slug":"锁-时序问题","link":"#锁-时序问题","children":[]},{"level":3,"title":"分布式锁演进-基本原理","slug":"分布式锁演进-基本原理","link":"#分布式锁演进-基本原理","children":[]},{"level":3,"title":"缓存数据一致性-双写模式","slug":"缓存数据一致性-双写模式","link":"#缓存数据一致性-双写模式","children":[]},{"level":3,"title":"缓存数据一致性-失效模式","slug":"缓存数据一致性-失效模式","link":"#缓存数据一致性-失效模式","children":[]},{"level":3,"title":"缓存数据一致性-解决方案","slug":"缓存数据一致性-解决方案","link":"#缓存数据一致性-解决方案","children":[]},{"level":3,"title":"缓存数据一致性-解决-Canal","slug":"缓存数据一致性-解决-canal","link":"#缓存数据一致性-解决-canal","children":[]}]},{"level":2,"title":"Session共享问题","slug":"session共享问题","link":"#session共享问题","children":[{"level":3,"title":"session原理","slug":"session原理","link":"#session原理","children":[]},{"level":3,"title":"分布式下session共享问题","slug":"分布式下session共享问题","link":"#分布式下session共享问题","children":[]},{"level":3,"title":"解决-session复制","slug":"解决-session复制","link":"#解决-session复制","children":[]},{"level":3,"title":"解决-客户端存储","slug":"解决-客户端存储","link":"#解决-客户端存储","children":[]},{"level":3,"title":"解决-hash一致性","slug":"解决-hash一致性","link":"#解决-hash一致性","children":[]},{"level":3,"title":"解决-统一存储","slug":"解决-统一存储","link":"#解决-统一存储","children":[]},{"level":3,"title":"解决-不同服务，子域session共享","slug":"解决-不同服务-子域session共享","link":"#解决-不同服务-子域session共享","children":[]},{"level":3,"title":"SpringSession核心原理","slug":"springsession核心原理","link":"#springsession核心原理","children":[]}]},{"level":2,"title":"购物车","slug":"购物车-1","link":"#购物车-1","children":[{"level":3,"title":"购物车数据结构","slug":"购物车数据结构","link":"#购物车数据结构","children":[]}]},{"level":2,"title":"消息队列RabbitMQ","slug":"消息队列rabbitmq","link":"#消息队列rabbitmq","children":[{"level":3,"title":"RabbitMQ概念","slug":"rabbitmq概念","link":"#rabbitmq概念","children":[]},{"level":3,"title":"什么AMQP协议","slug":"什么amqp协议","link":"#什么amqp协议","children":[]},{"level":3,"title":"AMQP的核心概念","slug":"amqp的核心概念","link":"#amqp的核心概念","children":[]},{"level":3,"title":"RabbitMq的消息是如何流转的？","slug":"rabbitmq的消息是如何流转的","link":"#rabbitmq的消息是如何流转的","children":[]},{"level":3,"title":"RabbitMq 交换机详解","slug":"rabbitmq-交换机详解","link":"#rabbitmq-交换机详解","children":[]},{"level":3,"title":"队列、绑定主机、消息","slug":"队列、绑定主机、消息","link":"#队列、绑定主机、消息","children":[]}]}],"relativePath":"pages/posts/mall.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-lastest\\\\imklaus-valaxy-blog\\\\pages\\\\posts\\\\mall.md","lastUpdated":null}'),u=JSON.parse('{"title":"mall项目总结","description":"基于微服务架构的商品贸易平台","frontmatter":{"cover":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/wallhaven-8oev1j_1920x1080.png","title":"mall项目总结","description":"基于微服务架构的商品贸易平台","top":200,"author":"imklaus","tags":["Spring Boot","Spring Cloud","Spring Cloud Alibaba","MySQL","MyBatis-Plus","Redis","RabbitMQ"],"categories":"Java","date":"2023-04-12T00:45:36.000Z","outline":"deep"},"headers":[{"level":2,"title":"项目名称","slug":"项目名称","link":"#项目名称","children":[]},{"level":2,"title":"项目简介","slug":"项目简介","link":"#项目简介","children":[]},{"level":2,"title":"系统架构","slug":"系统架构","link":"#系统架构","children":[]},{"level":2,"title":"我的职责","slug":"我的职责","link":"#我的职责","children":[]},{"level":2,"title":"项目概述","slug":"项目概述","link":"#项目概述","children":[{"level":3,"title":"核心业务一：购物车","slug":"核心业务一-购物车","link":"#核心业务一-购物车","children":[]},{"level":3,"title":"核心业务二：订单","slug":"核心业务二-订单","link":"#核心业务二-订单","children":[]},{"level":3,"title":"项目难点","slug":"项目难点","link":"#项目难点","children":[]},{"level":3,"title":"解决问题","slug":"解决问题","link":"#解决问题","children":[]},{"level":3,"title":"项目优化","slug":"项目优化","link":"#项目优化","children":[]}]},{"level":2,"title":"CompletableFuture异步编排","slug":"completablefuture异步编排","link":"#completablefuture异步编排","children":[{"level":3,"title":"概念","slug":"概念","link":"#概念","children":[]},{"level":3,"title":"业务场景","slug":"业务场景","link":"#业务场景","children":[]},{"level":3,"title":"项目代码","slug":"项目代码","link":"#项目代码","children":[]}]},{"level":2,"title":"RabbitMQ延时队列（实现定时任务）","slug":"rabbitmq延时队列-实现定时任务","link":"#rabbitmq延时队列-实现定时任务","children":[{"level":3,"title":"场景：","slug":"场景","link":"#场景","children":[]},{"level":3,"title":"消息的TTL（Time To Live）","slug":"消息的ttl-time-to-live","link":"#消息的ttl-time-to-live","children":[]},{"level":3,"title":"Dead Letter Exchanges（DLX）","slug":"dead-letter-exchanges-dlx","link":"#dead-letter-exchanges-dlx","children":[]},{"level":3,"title":"延时队列实现","slug":"延时队列实现","link":"#延时队列实现","children":[]},{"level":3,"title":"SpringBoot中使用延时队列","slug":"springboot中使用延时队列","link":"#springboot中使用延时队列","children":[]},{"level":3,"title":"消息队列流程","slug":"消息队列流程","link":"#消息队列流程","children":[]}]},{"level":2,"title":"Redis缓存中的数据结构","slug":"redis缓存中的数据结构","link":"#redis缓存中的数据结构","children":[{"level":3,"title":"分类菜单","slug":"分类菜单","link":"#分类菜单","children":[]},{"level":3,"title":"登陆信息-SpringSession","slug":"登陆信息-springsession","link":"#登陆信息-springsession","children":[]},{"level":3,"title":"购物车","slug":"购物车","link":"#购物车","children":[]},{"level":3,"title":"秒杀上架 (幂等性处理)","slug":"秒杀上架-幂等性处理","link":"#秒杀上架-幂等性处理","children":[]},{"level":3,"title":"幂等性保证","slug":"幂等性保证","link":"#幂等性保证","children":[]},{"level":3,"title":"Redission分布式锁","slug":"redission分布式锁","link":"#redission分布式锁","children":[]}]},{"level":2,"title":"分布式事务","slug":"分布式事务","link":"#分布式事务","children":[{"level":3,"title":"事务的坑","slug":"事务的坑","link":"#事务的坑","children":[]},{"level":3,"title":"CAP理论","slug":"cap理论","link":"#cap理论","children":[]},{"level":3,"title":"BASE 理论","slug":"base-理论","link":"#base-理论","children":[]},{"level":3,"title":"分布式事务几种方案","slug":"分布式事务几种方案","link":"#分布式事务几种方案","children":[]}]},{"level":2,"title":"Seata","slug":"seata","link":"#seata","children":[{"level":3,"title":"Seata的理解","slug":"seata的理解","link":"#seata的理解","children":[]},{"level":3,"title":"Seata项目整合","slug":"seata项目整合","link":"#seata项目整合","children":[]}]},{"level":2,"title":"Sentinel","slug":"sentinel","link":"#sentinel","children":[{"level":3,"title":"Sentinel理解","slug":"sentinel理解","link":"#sentinel理解","children":[]},{"level":3,"title":"熔断降级限流","slug":"熔断降级限流","link":"#熔断降级限流","children":[]},{"level":3,"title":"项目整合步骤","slug":"项目整合步骤","link":"#项目整合步骤","children":[]},{"level":3,"title":"整合 Feign+Sentinel 测试熔断降级","slug":"整合-feign-sentinel-测试熔断降级","link":"#整合-feign-sentinel-测试熔断降级","children":[]}]},{"level":2,"title":"Nacos","slug":"nacos","link":"#nacos","children":[{"level":3,"title":"项目整合","slug":"项目整合","link":"#项目整合","children":[]},{"level":3,"title":"Nacos作为注册中心：","slug":"nacos作为注册中心","link":"#nacos作为注册中心","children":[]},{"level":3,"title":"Nacos作为配置中心","slug":"nacos作为配置中心","link":"#nacos作为配置中心","children":[]},{"level":3,"title":"Nacos进阶","slug":"nacos进阶","link":"#nacos进阶","children":[]}]},{"level":2,"title":"Gateway","slug":"gateway","link":"#gateway","children":[]},{"level":2,"title":"Feign","slug":"feign","link":"#feign","children":[{"level":3,"title":"Feign远程调用丢失请求头问题","slug":"feign远程调用丢失请求头问题","link":"#feign远程调用丢失请求头问题","children":[]},{"level":3,"title":"Feign异步情况丢失上下文问题","slug":"feign异步情况丢失上下文问题","link":"#feign异步情况丢失上下文问题","children":[]}]},{"level":2,"title":"SpringCloud Alibaba 常用组件端口号总结","slug":"springcloud-alibaba-常用组件端口号总结","link":"#springcloud-alibaba-常用组件端口号总结","children":[]},{"level":2,"title":"支付","slug":"支付","link":"#支付","children":[{"level":3,"title":"加密-对称加密","slug":"加密-对称加密","link":"#加密-对称加密","children":[]},{"level":3,"title":"加密-非对称加密","slug":"加密-非对称加密","link":"#加密-非对称加密","children":[]},{"level":3,"title":"支付宝验签","slug":"支付宝验签","link":"#支付宝验签","children":[]},{"level":3,"title":"收单","slug":"收单","link":"#收单","children":[]}]},{"level":2,"title":"MD5&MD5盐值加密","slug":"md5-md5盐值加密","link":"#md5-md5盐值加密","children":[]},{"level":2,"title":"项目微服务","slug":"项目微服务","link":"#项目微服务","children":[]},{"level":2,"title":"Nginx+Windows搭建域名访问环境","slug":"nginx-windows搭建域名访问环境","link":"#nginx-windows搭建域名访问环境","children":[{"level":3,"title":"域名映射效果","slug":"域名映射效果","link":"#域名映射效果","children":[]},{"level":3,"title":"正向代理与反向代理","slug":"正向代理与反向代理","link":"#正向代理与反向代理","children":[]},{"level":3,"title":"Nginx配置文件","slug":"nginx配置文件","link":"#nginx配置文件","children":[]},{"level":3,"title":"Nginx动静分离","slug":"nginx动静分离","link":"#nginx动静分离","children":[]},{"level":3,"title":"Nginx转发效果","slug":"nginx转发效果","link":"#nginx转发效果","children":[]}]},{"level":2,"title":"内网穿透","slug":"内网穿透","link":"#内网穿透","children":[{"level":3,"title":"内网穿透联调","slug":"内网穿透联调","link":"#内网穿透联调","children":[]},{"level":3,"title":"配置","slug":"配置","link":"#配置","children":[]}]},{"level":2,"title":"缓存","slug":"缓存","link":"#缓存","children":[{"level":3,"title":"本地缓存","slug":"本地缓存","link":"#本地缓存","children":[]},{"level":3,"title":"分布式缓存-本地模式在分布式下的问题","slug":"分布式缓存-本地模式在分布式下的问题","link":"#分布式缓存-本地模式在分布式下的问题","children":[]},{"level":3,"title":"分布式缓存","slug":"分布式缓存","link":"#分布式缓存","children":[]},{"level":3,"title":"分布式下如何加锁？","slug":"分布式下如何加锁","link":"#分布式下如何加锁","children":[]},{"level":3,"title":"锁-时序问题","slug":"锁-时序问题","link":"#锁-时序问题","children":[]},{"level":3,"title":"分布式锁演进-基本原理","slug":"分布式锁演进-基本原理","link":"#分布式锁演进-基本原理","children":[]},{"level":3,"title":"缓存数据一致性-双写模式","slug":"缓存数据一致性-双写模式","link":"#缓存数据一致性-双写模式","children":[]},{"level":3,"title":"缓存数据一致性-失效模式","slug":"缓存数据一致性-失效模式","link":"#缓存数据一致性-失效模式","children":[]},{"level":3,"title":"缓存数据一致性-解决方案","slug":"缓存数据一致性-解决方案","link":"#缓存数据一致性-解决方案","children":[]},{"level":3,"title":"缓存数据一致性-解决-Canal","slug":"缓存数据一致性-解决-canal","link":"#缓存数据一致性-解决-canal","children":[]}]},{"level":2,"title":"Session共享问题","slug":"session共享问题","link":"#session共享问题","children":[{"level":3,"title":"session原理","slug":"session原理","link":"#session原理","children":[]},{"level":3,"title":"分布式下session共享问题","slug":"分布式下session共享问题","link":"#分布式下session共享问题","children":[]},{"level":3,"title":"解决-session复制","slug":"解决-session复制","link":"#解决-session复制","children":[]},{"level":3,"title":"解决-客户端存储","slug":"解决-客户端存储","link":"#解决-客户端存储","children":[]},{"level":3,"title":"解决-hash一致性","slug":"解决-hash一致性","link":"#解决-hash一致性","children":[]},{"level":3,"title":"解决-统一存储","slug":"解决-统一存储","link":"#解决-统一存储","children":[]},{"level":3,"title":"解决-不同服务，子域session共享","slug":"解决-不同服务-子域session共享","link":"#解决-不同服务-子域session共享","children":[]},{"level":3,"title":"SpringSession核心原理","slug":"springsession核心原理","link":"#springsession核心原理","children":[]}]},{"level":2,"title":"购物车","slug":"购物车-1","link":"#购物车-1","children":[{"level":3,"title":"购物车数据结构","slug":"购物车数据结构","link":"#购物车数据结构","children":[]}]},{"level":2,"title":"消息队列RabbitMQ","slug":"消息队列rabbitmq","link":"#消息队列rabbitmq","children":[{"level":3,"title":"RabbitMQ概念","slug":"rabbitmq概念","link":"#rabbitmq概念","children":[]},{"level":3,"title":"什么AMQP协议","slug":"什么amqp协议","link":"#什么amqp协议","children":[]},{"level":3,"title":"AMQP的核心概念","slug":"amqp的核心概念","link":"#amqp的核心概念","children":[]},{"level":3,"title":"RabbitMq的消息是如何流转的？","slug":"rabbitmq的消息是如何流转的","link":"#rabbitmq的消息是如何流转的","children":[]},{"level":3,"title":"RabbitMq 交换机详解","slug":"rabbitmq-交换机详解","link":"#rabbitmq-交换机详解","children":[]},{"level":3,"title":"队列、绑定主机、消息","slug":"队列、绑定主机、消息","link":"#队列、绑定主机、消息","children":[]}]}],"relativePath":"pages/posts/mall.md","path":"D:\\\\Learning\\\\myblog\\\\valaxy-lastest\\\\imklaus-valaxy-blog\\\\pages\\\\posts\\\\mall.md","lastUpdated":null}'),d={name:"pages/posts/mall.md",data:()=>({data:u,frontmatter:u.frontmatter,$frontmatter:u.frontmatter}),setup(){const l=s();l.meta.frontmatter=Object.assign(l.meta.frontmatter,u.frontmatter),o("pageData",u)}},g=r("p",null,"My name is klaus,I enjoy studying Java",-1),F={id:"项目总结",tabindex:"-1"},A=r("figure",null,[r("img",{alt:"mall",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230315150052611.png"})],-1),m=r("figure",null,[r("img",{alt:"mall",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230315145952769.png"})],-1),D={id:"项目名称",tabindex:"-1"},h=r("ul",null,[r("li",null,"书阁”图书商城管理系统、微盟电子商城网络交易系统、高校闲置资源交易系统"),r("li",null,"购物在“e”零售商城平台、惠农通—智慧农资商城 、农产品轻量级微商城系统"),r("li",null,"精美鞋业贸易系统")],-1),k={id:"项目简介",tabindex:"-1"},b=r("ul",null,[r("li",null,"本系统采用微服务架构设计，在分布式环境下利用Spring Cloud框架，通过业务划分，设计独立模块的微服务，拆分为订单服务、购物车服务、支付服务、用户管理服务、商品管理服务、文件上传服务等模块，结合了当前比较流行的互联网电商模式，为消费者提供商品贸易平台。")],-1),C={id:"系统架构",tabindex:"-1"},S=r("ul",null,[r("li",null,"该系用采用SpringCloud架构，利用SpringBoot构建应用，Nacos作为服务的注册、配置中心，OpenFeign实现与其他模块进行交互，Sentinel实现熔断降级和错误处理，Seata分布式事务解决方案，Gateway作为服务网关，Sleuth链路追踪，RabbitMQ实现延迟队列，Redis作为缓存解决读多写少的场景，MySQL进行持久化，MyBatisPlus作为持久化框架。")],-1),B={id:"我的职责",tabindex:"-1"},f=r("ul",null,[r("li",null,[c("完成平台"),r("strong",null,"商品、购物车、订单、库存、优惠券、支付、文件上传"),c("等服务模块的接口开发；")]),r("li",null,[c("使用"),r("strong",null,"RabbitMQ延时队列"),c("实现未付款订单，超过一定时间后，"),r("strong",null,"系统自动取消订单并解锁库存；")]),r("li",null,[c("使用"),r("strong",null,"redis+lua脚本"),c("防止重复提交攻击，"),r("strong",null,"解决了用户利用浏览器刷新和回退重复提交订单的问题；")]),r("li",null,[c("基于"),r("strong",null,"Redisson分布式限流：Semaphore信号量"),c("实现"),r("strong",null,"秒杀和一人一单功能"),c("，通过逐步"),r("strong",null,"改进分布式锁"),c("的方案，"),r("strong",null,"解决在多线程情况下用户重复提交订单的幂等性问题；")]),r("li",null,[c("基于 "),r("strong",null,"Token"),c(" 的认证授权机制："),r("strong",null,"JWT"),c("，通过对登录用户颁发登录凭证，"),r("strong",null,"实现登录模块认证授权功能；")]),r("li",null,[c("使用"),r("strong",null,"ElasticSearch分布式全文搜索引擎"),c("，对冷数据，商品信息数据"),r("strong",null,"建立索引"),c("，"),r("strong",null,"保证冷数据，商品数据的查询性能；")]),r("li",null,[c("利用"),r("strong",null,"Jmeter工具"),c("进行压测，找到在"),r("strong",null,"多线程"),c("情况下造成的"),r("strong",null,"内存泄漏，并发与同步"),c("等问题，"),r("strong",null,"保证了系统在线上的处理能力和稳定性维持在一个标准范围内；")]),r("li",null,[c("使用"),r("strong",null,"Redis"),c("进行"),r("strong",null,"热点信息缓存"),c("，比如附近购物车信息和登录信息,"),r("strong",null,"提高服务器的性能"),c("；")]),r("li",null,[c("使用"),r("strong",null,"Spring Schedule定时任务"),c("提前上架抢购商品信息到Redis缓存中实现"),r("strong",null,"库存预热功能")]),r("li",null,[c("使用"),r("strong",null,"Redisson分布式锁"),c("解决分布式系统下商品重复上架的"),r("strong",null,"幂等性问题"),c("；")]),r("li",null,[c("使用"),r("strong",null,"Spring Cache方法级别缓存技术"),c("，实现已经被调用过的指定的目标方法，直接从缓存中获取方法调用后的结果返回，"),r("strong",null,"提高系统的响应速度；")]),r("li",null,[c("使用"),r("strong",null,"CompletableFuture 异步编排"),c("解决查询商品详情⻚"),r("strong",null,"响应速度慢的问题"),c("；")]),r("li",null,[c("使用"),r("strong",null,"Nacos作为注册中心与配置中心"),c("，将服务名称及其对应地址进行存储，实现服务地址的"),r("strong",null,"注册与发现"),c("以及"),r("strong",null,"配置动态加载"),c("等功能")]),r("li",null,[c("使用"),r("strong",null,"Seata中的TCC事务模式"),c("，把一个完整的业务逻辑拆分成三个阶段,通过事务管理器进行管理，"),r("strong",null,"保证分布式系统数据一致性问题；")]),r("li",null,[c("整合"),r("strong",null,"第三方文件上传服务"),c("，如阿里云对象存储，基于服务端签名后直传，"),r("strong",null,"保证文件传输的安全性"),c("；")]),r("li",null,[c("整合"),r("strong",null,"OAuth2.0协议授权"),c("，使用AccessToken调用开发API获取用户信息，"),r("strong",null,"支持微信、QQ、微博、Gitee、Github等第三方登陆；")]),r("li",null,[c("使用"),r("strong",null,"RSA算法保证数据加密安全"),c("，成功对接第三方支付功能，订单付款支持"),r("strong",null,"支付宝、微信支付"),c("等第三方支付服务。")])],-1),v=r("p",null,"1、梳理自己项目的难点或亮点是什么？ 2、项目中，为什么用 xx 技术点，用 yy 的可以吗？或者为什么这么设计？",-1),x=r("p",null,"关于第一点，这个内容即使面试官没问，我们也可以在自我介绍时候表述出来。",-1),I=r("p",null,"如果你觉得自己的项目的确没什么厉害的东西，都是业务的 curd。那就挑一个值得说过的优化，或者设计方案也行。",-1),O=r("p",null,"毕竟高大上的东西的确只有少数人接触到，都是理解的。",-1),T=r("p",null,"接下来关于第二点，目的是考察你对自己项目的理解是不是真的知其所以然，还是说自己只是一个无情的 curd 机器。",-1),_=r("p",null,"项目切入点:分布式锁的实现、分布式Session、分布式缓存、缓存一致性、跨域、异步编排等，重点把握秒杀模块和 订单模块的设计及流程",-1),R={id:"项目概述",tabindex:"-1"},L=r("p",null,"​ 本系统是专门为精美鞋业有限公司制定的对外贸易系统，大部分商品出售给越南地区，供那边的厂商进行二次加工。 ​ 本系统采用微服务架构设计，在分布式环境下利用Spring Cloud框架，通过业务划分，设计独立模块的微服务，拆分为订单服务、购物车服务、支付服务、用户管理服务、商品管理服务、文件上传服务等模块，为客户提供半成品商品贸易平台。",-1),w={id:"核心业务一-购物车",tabindex:"-1"},q=r("ul",null,[r("li",null,[r("p",null,"购物车Redis数据结构选型："),r("ul",null,[r("li",null,[r("p",null,"双层 Map：Map<String,Map<String,String>>"),r("ul",null,[r("li",null,[r("p",null,"第一层 Map，Key 是用户 id")]),r("li",null,[r("p",null,"第二层 Map，Key 是购物车中商品 id，值是购物项数据")])])])])]),r("li",null,[r("p",null,"购物车两个核心功能：新增商品到购物车、查询购物车"),r("ul",null,[r("li",null,[r("p",null,"新增商品：判断是否登录"),r("ul",null,[r("li",null,"是：则添加商品到后台 Redis 中，把 user 的唯一标识符作为 key。"),r("li",null,"否：则添加商品到后台 Redis 中，使用随机生成的 user-key 作为 key。")])])])]),r("li",null,[r("p",null,"查询购物车列表：判断是否登录"),r("ul",null,[r("li",null,"否：直接根据 user-key 查询 Redis 中数据并展示"),r("li",null,"是：已登录，则需要先根据 user-key 查询 Redis 是否有数据。"),r("li",null,"有：需要提交到后台添加到 Redis ，合并数据，而后查询。"),r("li",null,"否：直接去后台查询 Redis ，而后返回")])])],-1),P={id:"核心业务二-订单",tabindex:"-1"},V={id:"订单中心",tabindex:"-1"},M=r("ul",null,[r("li",null,"电商系统涉及到 3 流，分别时信息流，资金流，物流，而订单系统作为中枢将三者有机的集 合起来。"),r("li",null,"订单模块是电商系统的枢纽，在订单这个环节上需求获取多个模块的数据和信息，同时对这 些信息进行加工处理后流向下个环节，这一系列就构成了订单的信息流通。")],-1),j={id:"订单构成",tabindex:"-1"},N=r("figure",null,[r("img",{alt:"mall",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410153419456.png"})],-1),W={id:"订单状态",tabindex:"-1"},K=r("ol",null,[r("li",null,[c("待付款 "),r("ul",null,[r("li",null,"用户提交订单后，订单进行预下单，目前主流电商网站都会唤起支付，便于用户快速完成支 付，需要注意的是待付款状态下可以对库存进行锁定，锁定库存需要配置支付超时时间，超 时后将自动取消订单，订单变更关闭状态。")])]),r("li",null,[c("已付款/ 待发货 "),r("ul",null,[r("li",null,"用户完成订单支付，订单系统需要记录支付时间，支付流水单号便于对账，订单下放到 WMS 系统，仓库进行调拨，配货，分拣，出库等操作。")])]),r("li",null,[c("待收货/ 已发货 "),r("ul",null,[r("li",null,"仓储将商品出库后，订单进入物流环节，订单系统需要同步物流信息，便于用户实时知悉物 品物流状态")])]),r("li",null,[c("已完成 "),r("ul",null,[r("li",null,"用户确认收货后，订单交易完成。后续支付侧进行结算，如果订单存在问题进入售后状态")])]),r("li",null,[c("已取消 "),r("ul",null,[r("li",null,"付款之前取消订单。包括超时未付款或用户商户取消订单都会产生这种订单状态。")])])],-1),z={id:"订单流程",tabindex:"-1"},H=r("ul",null,[r("li",null,"正常的网购步骤：订单生成–>支付订单–>卖家发货–>确认收货–>交易成功")],-1),Q={id:"_1-订单创建与支付",tabindex:"-1"},U=r("figure",null,[r("img",{alt:"mall",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403130800413.png"})],-1),G=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.web.OrderWebController#submitOrder")])],-1),X=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"vo"),r("span",{style:{color:"#6A737D"}}," 上一个页面携带的数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"model")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"redirectAttributes")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"PostMapping"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"/submitOrder"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," String "),r("span",{style:{color:"#B392F0"}},"submitOrder"),r("span",{style:{color:"#E1E4E8"}},"(OrderSubmitVo vo, Model model, RedirectAttributes redirectAttributes){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//捕获异常")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"try"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        SubmitOrderResponseVo responseVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderService."),r("span",{style:{color:"#B392F0"}},"submitOrder"),r("span",{style:{color:"#E1E4E8"}},"(vo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//下单：去创建订单，验令牌，验价格，锁库存....")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"订单提交的数据..."'),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," vo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (responseVo."),r("span",{style:{color:"#B392F0"}},"getCode"),r("span",{style:{color:"#E1E4E8"}},"() "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"0"),r("span",{style:{color:"#E1E4E8"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//下单成功来到支付选择页")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            model."),r("span",{style:{color:"#B392F0"}},"addAttribute"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"submitOrderResponse"'),r("span",{style:{color:"#E1E4E8"}},", responseVo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"pay"'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }"),r("span",{style:{color:"#F97583"}},"else"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//下单失败重定向到订单确认页")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            String msg "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"下单失败："'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"switch"),r("span",{style:{color:"#E1E4E8"}}," (responseVo."),r("span",{style:{color:"#B392F0"}},"getCode"),r("span",{style:{color:"#E1E4E8"}},"()){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"case"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#F97583"}},":"),r("span",{style:{color:"#E1E4E8"}}," msg"),r("span",{style:{color:"#F97583"}},"+="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"订单信息过期，请刷新再次提交"'),r("span",{style:{color:"#E1E4E8"}},"; "),r("span",{style:{color:"#F97583"}},"break"),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"case"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"2"),r("span",{style:{color:"#F97583"}},":"),r("span",{style:{color:"#E1E4E8"}}," msg"),r("span",{style:{color:"#F97583"}},"+="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"订单商品价格发生了变化，请刷新再次提交"'),r("span",{style:{color:"#E1E4E8"}},"; "),r("span",{style:{color:"#F97583"}},"break"),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"case"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"3"),r("span",{style:{color:"#F97583"}},":"),r("span",{style:{color:"#E1E4E8"}}," msg"),r("span",{style:{color:"#F97583"}},"+="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"库存锁定失败，商品库存不足"'),r("span",{style:{color:"#E1E4E8"}},"; "),r("span",{style:{color:"#F97583"}},"break"),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            redirectAttributes."),r("span",{style:{color:"#B392F0"}},"addFlashAttribute"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"msg"'),r("span",{style:{color:"#E1E4E8"}},", msg);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"redirect:http://order.gulimall.com/toTrade"'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }"),r("span",{style:{color:"#F97583"}},"catch"),r("span",{style:{color:"#E1E4E8"}}," (Exception "),r("span",{style:{color:"#FFAB70"}},"e"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (e "),r("span",{style:{color:"#F97583"}},"instanceof"),r("span",{style:{color:"#E1E4E8"}}," NoStockException) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            String message "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," ((NoStockException) e)."),r("span",{style:{color:"#B392F0"}},"getMessage"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},'//抛出无库存异常后页面显示此异常信息NO_STOCK_EXCEPTION(21000, "商品库存不足");')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            redirectAttributes."),r("span",{style:{color:"#B392F0"}},"addFlashAttribute"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"msg"'),r("span",{style:{color:"#E1E4E8"}},", message);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//抛出任何异常后重定向会订单确认页")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"redirect:http://order.gulimall.com/toTrade"'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"vo"),r("span",{style:{color:"#6A737D"}}," 上一个页面携带的数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"model")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"redirectAttributes")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"PostMapping"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"/submitOrder"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," String "),r("span",{style:{color:"#6F42C1"}},"submitOrder"),r("span",{style:{color:"#24292E"}},"(OrderSubmitVo vo, Model model, RedirectAttributes redirectAttributes){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//捕获异常")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"try"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        SubmitOrderResponseVo responseVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderService."),r("span",{style:{color:"#6F42C1"}},"submitOrder"),r("span",{style:{color:"#24292E"}},"(vo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//下单：去创建订单，验令牌，验价格，锁库存....")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"订单提交的数据..."'),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," vo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (responseVo."),r("span",{style:{color:"#6F42C1"}},"getCode"),r("span",{style:{color:"#24292E"}},"() "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"0"),r("span",{style:{color:"#24292E"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//下单成功来到支付选择页")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            model."),r("span",{style:{color:"#6F42C1"}},"addAttribute"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"submitOrderResponse"'),r("span",{style:{color:"#24292E"}},", responseVo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"pay"'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }"),r("span",{style:{color:"#D73A49"}},"else"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//下单失败重定向到订单确认页")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            String msg "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"下单失败："'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"switch"),r("span",{style:{color:"#24292E"}}," (responseVo."),r("span",{style:{color:"#6F42C1"}},"getCode"),r("span",{style:{color:"#24292E"}},"()){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"case"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#D73A49"}},":"),r("span",{style:{color:"#24292E"}}," msg"),r("span",{style:{color:"#D73A49"}},"+="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"订单信息过期，请刷新再次提交"'),r("span",{style:{color:"#24292E"}},"; "),r("span",{style:{color:"#D73A49"}},"break"),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"case"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"2"),r("span",{style:{color:"#D73A49"}},":"),r("span",{style:{color:"#24292E"}}," msg"),r("span",{style:{color:"#D73A49"}},"+="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"订单商品价格发生了变化，请刷新再次提交"'),r("span",{style:{color:"#24292E"}},"; "),r("span",{style:{color:"#D73A49"}},"break"),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"case"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"3"),r("span",{style:{color:"#D73A49"}},":"),r("span",{style:{color:"#24292E"}}," msg"),r("span",{style:{color:"#D73A49"}},"+="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"库存锁定失败，商品库存不足"'),r("span",{style:{color:"#24292E"}},"; "),r("span",{style:{color:"#D73A49"}},"break"),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            redirectAttributes."),r("span",{style:{color:"#6F42C1"}},"addFlashAttribute"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"msg"'),r("span",{style:{color:"#24292E"}},", msg);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"redirect:http://order.gulimall.com/toTrade"'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }"),r("span",{style:{color:"#D73A49"}},"catch"),r("span",{style:{color:"#24292E"}}," (Exception "),r("span",{style:{color:"#E36209"}},"e"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (e "),r("span",{style:{color:"#D73A49"}},"instanceof"),r("span",{style:{color:"#24292E"}}," NoStockException) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            String message "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," ((NoStockException) e)."),r("span",{style:{color:"#6F42C1"}},"getMessage"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},'//抛出无库存异常后页面显示此异常信息NO_STOCK_EXCEPTION(21000, "商品库存不足");')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            redirectAttributes."),r("span",{style:{color:"#6F42C1"}},"addFlashAttribute"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"msg"'),r("span",{style:{color:"#24292E"}},", message);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//抛出任何异常后重定向会订单确认页")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"redirect:http://order.gulimall.com/toTrade"'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),J=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#submitOrder")])],-1),$=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 下单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 加入统一事务")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"vo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * @Transactional 本地事务，在分布式系统下，只能控制自己的回滚，控制不了其他服务的回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * (isolation = Isolation.REPEATABLE_READ)默认隔离级别")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * ->分布式事务: 最大原因是网络问题+分布式机器")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//@GlobalTransactional 高并发 此注解会加很多全局锁，导致下单只能等别人先下完单才能下，高并发环境不可取")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," SubmitOrderResponseVo "),r("span",{style:{color:"#B392F0"}},"submitOrder"),r("span",{style:{color:"#E1E4E8"}},"(OrderSubmitVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        submitVoThreadLocal."),r("span",{style:{color:"#B392F0"}},"set"),r("span",{style:{color:"#E1E4E8"}},"(vo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        SubmitOrderResponseVo responseVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"SubmitOrderResponseVo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//从拦截器里获取用户信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        MemberRespVo memberRespVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," LoginUserInterceptor.loginUser."),r("span",{style:{color:"#B392F0"}},"get"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        responseVo."),r("span",{style:{color:"#B392F0"}},"setCode"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"0"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//1、验证令牌【令牌的对比和删除必须保证原子性】")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//0令牌失败 - 1删除成功(校验成功)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        String script "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},"\"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\""),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        String orderToken "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," vo."),r("span",{style:{color:"#B392F0"}},"getOrderToken"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//原子验证令牌和删除令牌")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        Long result "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," redisTemplate."),r("span",{style:{color:"#B392F0"}},"execute"),r("span",{style:{color:"#E1E4E8"}},"(")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//脚本返回类型->0,1")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," DefaultRedisScript<"),r("span",{style:{color:"#F97583"}},"Long"),r("span",{style:{color:"#E1E4E8"}},">(script, Long.class),")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//将缓存中将要比对的key转为集合")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                Arrays."),r("span",{style:{color:"#B392F0"}},"asList"),r("span",{style:{color:"#E1E4E8"}},"(OrderConstant.USER_ORDER_TOKEN_PREFIX "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," memberRespVo."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"()),")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//传入要校验的值")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                orderToken);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (result "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"0L"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//验证失败，设置错误状态码为1，key过期等情况")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            responseVo."),r("span",{style:{color:"#B392F0"}},"setCode"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," responseVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        } "),r("span",{style:{color:"#F97583"}},"else"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//验证成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//下单：去创建订单，验令牌，验价格，锁库存....")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//1、创建订单，订单项等信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            OrderCreateTo order "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"createOrder"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"// todo 观察者模式: 发布商品下单事件")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            ApplicationContextHolder."),r("span",{style:{color:"#B392F0"}},"getInstance"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"publishEvent"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"OrderCreateEvent"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"this"),r("span",{style:{color:"#E1E4E8"}},", order));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//2、验价，拿到应付金额与页面提交的金额进行校验")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            BigDecimal payAmount "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," order."),r("span",{style:{color:"#B392F0"}},"getOrder"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getPayAmount"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            BigDecimal payPrice "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," vo."),r("span",{style:{color:"#B392F0"}},"getPayPrice"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//两者相减的绝对值小于0.01就算校验通过")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (Math."),r("span",{style:{color:"#B392F0"}},"abs"),r("span",{style:{color:"#E1E4E8"}},"(payAmount."),r("span",{style:{color:"#B392F0"}},"subtract"),r("span",{style:{color:"#E1E4E8"}},"(payPrice)."),r("span",{style:{color:"#B392F0"}},"doubleValue"),r("span",{style:{color:"#E1E4E8"}},"()) "),r("span",{style:{color:"#F97583"}},"<"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"0.01"),r("span",{style:{color:"#E1E4E8"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//校验通过")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//TODO 3、保存订单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#B392F0"}},"saveOrder"),r("span",{style:{color:"#E1E4E8"}},"(order);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//4、库存锁定，这样能避免库存不足等现象发生")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//只要有异常就回滚订单数据(订单号，所有订单项（skuId，skuName，num）)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                WareSkuLockVo lockVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"WareSkuLockVo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//设置指定库存的订单号")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                lockVo."),r("span",{style:{color:"#B392F0"}},"setOrderSn"),r("span",{style:{color:"#E1E4E8"}},"(order."),r("span",{style:{color:"#B392F0"}},"getOrder"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getOrderSn"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                List<"),r("span",{style:{color:"#F97583"}},"OrderItemVo"),r("span",{style:{color:"#E1E4E8"}},"> locks "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," order."),r("span",{style:{color:"#B392F0"}},"getOrderItems"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"stream"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"map"),r("span",{style:{color:"#E1E4E8"}},"(item "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    OrderItemVo orderItemVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"OrderItemVo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#6A737D"}},"//订单已经保存了，可以直接设置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    orderItemVo."),r("span",{style:{color:"#B392F0"}},"setSkuId"),r("span",{style:{color:"#E1E4E8"}},"(item."),r("span",{style:{color:"#B392F0"}},"getSkuId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    orderItemVo."),r("span",{style:{color:"#B392F0"}},"setCount"),r("span",{style:{color:"#E1E4E8"}},"(item."),r("span",{style:{color:"#B392F0"}},"getSkuQuantity"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    orderItemVo."),r("span",{style:{color:"#B392F0"}},"setTitle"),r("span",{style:{color:"#E1E4E8"}},"(item."),r("span",{style:{color:"#B392F0"}},"getSkuName"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," orderItemVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                })."),r("span",{style:{color:"#B392F0"}},"collect"),r("span",{style:{color:"#E1E4E8"}},"(Collectors."),r("span",{style:{color:"#B392F0"}},"toList"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//锁定订单项数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                lockVo."),r("span",{style:{color:"#B392F0"}},"setLocks"),r("span",{style:{color:"#E1E4E8"}},"(locks);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//todo 4、远程锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//库存锁定成功了，但是网络原因超时了，订单回滚，库存不回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//为了保证高并发，库存服务自己回滚，可以发消息给库存服务")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//库存服务本身也可以使用自动解锁模式->消息队列")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                R r "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wmsFeignService."),r("span",{style:{color:"#B392F0"}},"orderLockStock"),r("span",{style:{color:"#E1E4E8"}},"(lockVo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//判断远程调用是否成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (r."),r("span",{style:{color:"#B392F0"}},"getCode"),r("span",{style:{color:"#E1E4E8"}},"() "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"0"),r("span",{style:{color:"#E1E4E8"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#6A737D"}},"//远程调用成功，锁成功了")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    responseVo."),r("span",{style:{color:"#B392F0"}},"setOrder"),r("span",{style:{color:"#E1E4E8"}},"(order."),r("span",{style:{color:"#B392F0"}},"getOrder"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#6A737D"}},"//todo 5、远程扣减积分  出异常 引入seata后业务标注@GlobalTransactional订单回滚，库存回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"\t\t\t\t\t"),r("span",{style:{color:"#6A737D"}},"// int i = 10/0;//不标注@GlobalTransactional 订单回滚，库存不回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#6A737D"}},"//todo 订单创建成功发送消息给MQ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    rabbitTemplate."),r("span",{style:{color:"#B392F0"}},"convertAndSend"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#9ECBFF"}},'"order.create.order"'),r("span",{style:{color:"#E1E4E8"}},", order."),r("span",{style:{color:"#B392F0"}},"getOrder"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," responseVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                }"),r("span",{style:{color:"#F97583"}},"else"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#6A737D"}},"//远程调用失败，锁定失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#6A737D"}},"//锁定失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    String msg "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," (String) r."),r("span",{style:{color:"#B392F0"}},"get"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"msg"'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#6A737D"}},"//抛出异常就不能设置错误状态码了")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#F97583"}},"throw"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"NoStockException"),r("span",{style:{color:"#E1E4E8"}},"(msg);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//                    responseVo.setCode(3);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//                    return responseVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            }"),r("span",{style:{color:"#F97583"}},"else"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//校验失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                responseVo."),r("span",{style:{color:"#B392F0"}},"setCode"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"2"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," responseVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 下单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 加入统一事务")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"vo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * @Transactional 本地事务，在分布式系统下，只能控制自己的回滚，控制不了其他服务的回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * (isolation = Isolation.REPEATABLE_READ)默认隔离级别")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * ->分布式事务: 最大原因是网络问题+分布式机器")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//@GlobalTransactional 高并发 此注解会加很多全局锁，导致下单只能等别人先下完单才能下，高并发环境不可取")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," SubmitOrderResponseVo "),r("span",{style:{color:"#6F42C1"}},"submitOrder"),r("span",{style:{color:"#24292E"}},"(OrderSubmitVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        submitVoThreadLocal."),r("span",{style:{color:"#6F42C1"}},"set"),r("span",{style:{color:"#24292E"}},"(vo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        SubmitOrderResponseVo responseVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"SubmitOrderResponseVo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//从拦截器里获取用户信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        MemberRespVo memberRespVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," LoginUserInterceptor.loginUser."),r("span",{style:{color:"#6F42C1"}},"get"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        responseVo."),r("span",{style:{color:"#6F42C1"}},"setCode"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"0"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//1、验证令牌【令牌的对比和删除必须保证原子性】")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//0令牌失败 - 1删除成功(校验成功)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        String script "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},"\"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\""),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        String orderToken "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," vo."),r("span",{style:{color:"#6F42C1"}},"getOrderToken"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//原子验证令牌和删除令牌")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        Long result "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," redisTemplate."),r("span",{style:{color:"#6F42C1"}},"execute"),r("span",{style:{color:"#24292E"}},"(")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//脚本返回类型->0,1")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," DefaultRedisScript<"),r("span",{style:{color:"#D73A49"}},"Long"),r("span",{style:{color:"#24292E"}},">(script, Long.class),")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//将缓存中将要比对的key转为集合")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                Arrays."),r("span",{style:{color:"#6F42C1"}},"asList"),r("span",{style:{color:"#24292E"}},"(OrderConstant.USER_ORDER_TOKEN_PREFIX "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," memberRespVo."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"()),")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//传入要校验的值")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                orderToken);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (result "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"0L"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//验证失败，设置错误状态码为1，key过期等情况")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            responseVo."),r("span",{style:{color:"#6F42C1"}},"setCode"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," responseVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        } "),r("span",{style:{color:"#D73A49"}},"else"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//验证成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//下单：去创建订单，验令牌，验价格，锁库存....")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//1、创建订单，订单项等信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            OrderCreateTo order "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"createOrder"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"// todo 观察者模式: 发布商品下单事件")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            ApplicationContextHolder."),r("span",{style:{color:"#6F42C1"}},"getInstance"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"publishEvent"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"OrderCreateEvent"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"this"),r("span",{style:{color:"#24292E"}},", order));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//2、验价，拿到应付金额与页面提交的金额进行校验")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            BigDecimal payAmount "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," order."),r("span",{style:{color:"#6F42C1"}},"getOrder"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getPayAmount"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            BigDecimal payPrice "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," vo."),r("span",{style:{color:"#6F42C1"}},"getPayPrice"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//两者相减的绝对值小于0.01就算校验通过")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (Math."),r("span",{style:{color:"#6F42C1"}},"abs"),r("span",{style:{color:"#24292E"}},"(payAmount."),r("span",{style:{color:"#6F42C1"}},"subtract"),r("span",{style:{color:"#24292E"}},"(payPrice)."),r("span",{style:{color:"#6F42C1"}},"doubleValue"),r("span",{style:{color:"#24292E"}},"()) "),r("span",{style:{color:"#D73A49"}},"<"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"0.01"),r("span",{style:{color:"#24292E"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//校验通过")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//TODO 3、保存订单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6F42C1"}},"saveOrder"),r("span",{style:{color:"#24292E"}},"(order);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//4、库存锁定，这样能避免库存不足等现象发生")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//只要有异常就回滚订单数据(订单号，所有订单项（skuId，skuName，num）)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                WareSkuLockVo lockVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"WareSkuLockVo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//设置指定库存的订单号")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                lockVo."),r("span",{style:{color:"#6F42C1"}},"setOrderSn"),r("span",{style:{color:"#24292E"}},"(order."),r("span",{style:{color:"#6F42C1"}},"getOrder"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getOrderSn"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                List<"),r("span",{style:{color:"#D73A49"}},"OrderItemVo"),r("span",{style:{color:"#24292E"}},"> locks "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," order."),r("span",{style:{color:"#6F42C1"}},"getOrderItems"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"stream"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"map"),r("span",{style:{color:"#24292E"}},"(item "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    OrderItemVo orderItemVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"OrderItemVo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#6A737D"}},"//订单已经保存了，可以直接设置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    orderItemVo."),r("span",{style:{color:"#6F42C1"}},"setSkuId"),r("span",{style:{color:"#24292E"}},"(item."),r("span",{style:{color:"#6F42C1"}},"getSkuId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    orderItemVo."),r("span",{style:{color:"#6F42C1"}},"setCount"),r("span",{style:{color:"#24292E"}},"(item."),r("span",{style:{color:"#6F42C1"}},"getSkuQuantity"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    orderItemVo."),r("span",{style:{color:"#6F42C1"}},"setTitle"),r("span",{style:{color:"#24292E"}},"(item."),r("span",{style:{color:"#6F42C1"}},"getSkuName"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," orderItemVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                })."),r("span",{style:{color:"#6F42C1"}},"collect"),r("span",{style:{color:"#24292E"}},"(Collectors."),r("span",{style:{color:"#6F42C1"}},"toList"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//锁定订单项数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                lockVo."),r("span",{style:{color:"#6F42C1"}},"setLocks"),r("span",{style:{color:"#24292E"}},"(locks);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//todo 4、远程锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//库存锁定成功了，但是网络原因超时了，订单回滚，库存不回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//为了保证高并发，库存服务自己回滚，可以发消息给库存服务")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//库存服务本身也可以使用自动解锁模式->消息队列")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                R r "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wmsFeignService."),r("span",{style:{color:"#6F42C1"}},"orderLockStock"),r("span",{style:{color:"#24292E"}},"(lockVo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//判断远程调用是否成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (r."),r("span",{style:{color:"#6F42C1"}},"getCode"),r("span",{style:{color:"#24292E"}},"() "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"0"),r("span",{style:{color:"#24292E"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#6A737D"}},"//远程调用成功，锁成功了")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    responseVo."),r("span",{style:{color:"#6F42C1"}},"setOrder"),r("span",{style:{color:"#24292E"}},"(order."),r("span",{style:{color:"#6F42C1"}},"getOrder"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6A737D"}},"//todo 5、远程扣减积分  出异常 引入seata后业务标注@GlobalTransactional订单回滚，库存回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"\t\t\t\t\t"),r("span",{style:{color:"#6A737D"}},"// int i = 10/0;//不标注@GlobalTransactional 订单回滚，库存不回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#6A737D"}},"//todo 订单创建成功发送消息给MQ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    rabbitTemplate."),r("span",{style:{color:"#6F42C1"}},"convertAndSend"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order-event-exchange"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#032F62"}},'"order.create.order"'),r("span",{style:{color:"#24292E"}},", order."),r("span",{style:{color:"#6F42C1"}},"getOrder"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," responseVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                }"),r("span",{style:{color:"#D73A49"}},"else"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#6A737D"}},"//远程调用失败，锁定失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#6A737D"}},"//锁定失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    String msg "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," (String) r."),r("span",{style:{color:"#6F42C1"}},"get"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"msg"'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#6A737D"}},"//抛出异常就不能设置错误状态码了")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#D73A49"}},"throw"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"NoStockException"),r("span",{style:{color:"#24292E"}},"(msg);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//                    responseVo.setCode(3);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//                    return responseVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            }"),r("span",{style:{color:"#D73A49"}},"else"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//校验失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                responseVo."),r("span",{style:{color:"#6F42C1"}},"setCode"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"2"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," responseVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")])])]),r("button",{class:"collapse"})],-1),Y=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#createOrder")])],-1),Z=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 创建订单聚合方法，含构建订单和所有订单项")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"private"),r("span",{style:{color:"#E1E4E8"}}," OrderCreateTo "),r("span",{style:{color:"#B392F0"}},"createOrder"),r("span",{style:{color:"#E1E4E8"}},"() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//获取当前登录的用户信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        MemberRespVo memberRespVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," LoginUserInterceptor.loginUser."),r("span",{style:{color:"#B392F0"}},"get"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        OrderCreateTo createTo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"OrderCreateTo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//1、todo 生成订单号(使用雪花算法根据用户id创建订单号)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        String orderSn = IdWorker.getTimeId();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        String orderSn "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," SnowflakeIdUtil."),r("span",{style:{color:"#B392F0"}},"nextIdStrByService"),r("span",{style:{color:"#E1E4E8"}},"(memberRespVo."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"toString"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//创建订单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        OrderEntity orderEntity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"buildOrder"),r("span",{style:{color:"#E1E4E8"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//2、获取到所有的订单项")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"OrderItemEntity"),r("span",{style:{color:"#E1E4E8"}},"> itemEntities "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"buildOrderItems"),r("span",{style:{color:"#E1E4E8"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//3、验价，计算价格、积分等相关")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#B392F0"}},"computePrice"),r("span",{style:{color:"#E1E4E8"}},"(orderEntity, itemEntities);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        createTo.setOrderItems(itemEntities);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        createTo.setOrder(orderEntity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"// 构建订单聚合根")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        OrderCreateTo order "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," createTo."),r("span",{style:{color:"#B392F0"}},"builder"),r("span",{style:{color:"#E1E4E8"}},"()")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                ."),r("span",{style:{color:"#B392F0"}},"order"),r("span",{style:{color:"#E1E4E8"}},"(orderEntity)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                ."),r("span",{style:{color:"#B392F0"}},"orderItems"),r("span",{style:{color:"#E1E4E8"}},"(itemEntities)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                ."),r("span",{style:{color:"#B392F0"}},"fare"),r("span",{style:{color:"#E1E4E8"}},"(orderEntity."),r("span",{style:{color:"#B392F0"}},"getFreightAmount"),r("span",{style:{color:"#E1E4E8"}},"())")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                ."),r("span",{style:{color:"#B392F0"}},"payPrice"),r("span",{style:{color:"#E1E4E8"}},"(orderEntity."),r("span",{style:{color:"#B392F0"}},"getPayAmount"),r("span",{style:{color:"#E1E4E8"}},"())")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                ."),r("span",{style:{color:"#B392F0"}},"build"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," order;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 创建订单聚合方法，含构建订单和所有订单项")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"private"),r("span",{style:{color:"#24292E"}}," OrderCreateTo "),r("span",{style:{color:"#6F42C1"}},"createOrder"),r("span",{style:{color:"#24292E"}},"() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//获取当前登录的用户信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        MemberRespVo memberRespVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," LoginUserInterceptor.loginUser."),r("span",{style:{color:"#6F42C1"}},"get"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        OrderCreateTo createTo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"OrderCreateTo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//1、todo 生成订单号(使用雪花算法根据用户id创建订单号)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        String orderSn = IdWorker.getTimeId();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        String orderSn "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," SnowflakeIdUtil."),r("span",{style:{color:"#6F42C1"}},"nextIdStrByService"),r("span",{style:{color:"#24292E"}},"(memberRespVo."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"toString"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//创建订单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        OrderEntity orderEntity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"buildOrder"),r("span",{style:{color:"#24292E"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//2、获取到所有的订单项")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"OrderItemEntity"),r("span",{style:{color:"#24292E"}},"> itemEntities "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"buildOrderItems"),r("span",{style:{color:"#24292E"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//3、验价，计算价格、积分等相关")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6F42C1"}},"computePrice"),r("span",{style:{color:"#24292E"}},"(orderEntity, itemEntities);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        createTo.setOrderItems(itemEntities);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        createTo.setOrder(orderEntity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"// 构建订单聚合根")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        OrderCreateTo order "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," createTo."),r("span",{style:{color:"#6F42C1"}},"builder"),r("span",{style:{color:"#24292E"}},"()")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                ."),r("span",{style:{color:"#6F42C1"}},"order"),r("span",{style:{color:"#24292E"}},"(orderEntity)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                ."),r("span",{style:{color:"#6F42C1"}},"orderItems"),r("span",{style:{color:"#24292E"}},"(itemEntities)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                ."),r("span",{style:{color:"#6F42C1"}},"fare"),r("span",{style:{color:"#24292E"}},"(orderEntity."),r("span",{style:{color:"#6F42C1"}},"getFreightAmount"),r("span",{style:{color:"#24292E"}},"())")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                ."),r("span",{style:{color:"#6F42C1"}},"payPrice"),r("span",{style:{color:"#24292E"}},"(orderEntity."),r("span",{style:{color:"#6F42C1"}},"getPayAmount"),r("span",{style:{color:"#24292E"}},"())")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                ."),r("span",{style:{color:"#6F42C1"}},"build"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," order;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")])])]),r("button",{class:"collapse"})],-1),ll=r("figure",null,[r("img",{alt:"mall",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403131446123.png"})],-1),sl=r("li",null,[r("p",null,"支付服务，提供支付宝、微信、银行卡等支付方式，支持支付查询以及退款等功能。")],-1),ol={id:"配置项修改",tabindex:"-1"},nl=r("strong",null,"配置项修改",-1),el=r("p",null,[c("详情见 "),r("strong",null,"支付宝沙箱对接"),c(" 中需要修改配置项。")],-1),al={id:"核心流程",tabindex:"-1"},tl=r("strong",null,"核心流程",-1),rl=r("p",null,[r("strong",null,"核心流程(刚果商城项目参考)：")],-1),cl=r("p",null,"1）通过策略模式封装支付渠道和支付场景，用户支付时动态选择对应的支付组件。",-1),pl=r("ul",null,[r("li",null,[c("代码地址："),r("code",null,"org.opengoofy.congomall.biz.pay.application.service.impl.PayServiceImpl#commonPay")])],-1),yl=r("p",null,"2）通过策略模式封装支付回调场景，三方支付平台回调时动态选择对应的支付回调组件。",-1),El=r("ul",null,[r("li",null,[c("代码地址："),r("code",null,"org.opengoofy.congomall.biz.pay.application.service.impl.PayServiceImpl#callback")])],-1),il={id:"支付宝沙箱对接",tabindex:"-1"},ul=r("p",null,"项目中已对接支付宝沙箱环境，以下介绍如何对接支付宝沙箱。",-1),dl=r("ul",null,[r("li",null,[r("ol",null,[r("li",null,[r("strong",null,"注册账号")])])])],-1),gl=r("p",null,"注册支付宝开发者账户，进入开发者控制台。",-1),Fl=r("p",null,"直接进入沙箱环境地址。",-1),Al=r("p",null,"沙箱应用页面如下：",-1),ml=r("figure",null,[r("img",{alt:"mall",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/1674111619522-82229cf7-482d-4a4e-81bd-637c55c3d6a9.png"})],-1),Dl=r("ul",null,[r("li",null,[r("ol",{start:"2"},[r("li",null,[r("strong",null,"获取支付参数")])])])],-1),hl=r("p",null,[c("拿到 APPID 替换 "),r("code",null,"application.properties"),c(" 文件中 "),r("code",null,"alipay.app-id"),c("。")],-1),kl=r("figure",null,[r("img",{alt:"mall",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/1674111838001-9ff075ce-e324-43a6-a6b6-e3d860970e6a.png"})],-1),bl=r("p",null,"为了图方便，这里直接使用支付宝自定义公钥和私钥。",-1),Cl=r("p",null,"我这里是已经开启过的，所以启用按钮是置灰的。第一次使用应该是蓝色可点击的状态。",-1),Sl=r("figure",null,[r("img",{alt:"mall",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/1674112006561-4be2d9d4-ef90-4c49-aee6-1f6f6a988f2d.png"})],-1),Bl=r("p",null,[c("复制支付宝公钥替换 "),r("code",null,"application.properties"),c(" 文件中 "),r("code",null,"alipay.alipay_public_key"),c("。")],-1),fl=r("p",null,[c("复制应用私钥替换 "),r("code",null,"application.properties"),c(" 文件中 "),r("code",null,"alipay.private_key"),c("。")],-1),vl=r("figure",null,[r("img",{alt:"img",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/1674112099708-2d1a70a2-6af5-4502-8192-f6bb587b302f.png"})],-1),xl=r("p",null,"至此，就可以调用支付接口进行支付宝支付功能了。",-1),Il=r("ul",null,[r("li",null,[r("ol",{start:"3"},[r("li",null,[r("strong",null,"调用支付宝接口")])])])],-1),Ol=r("p",null,"访问支付服务 API，调用支付宝支付接口。",-1),Tl=r("code",null,"pay.html",-1),_l=r("code",null,"pay.html",-1),Rl=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#getOrderPay")])],-1),Ll=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 获取当前订单的支付信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"orderSn")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," PayVo "),r("span",{style:{color:"#B392F0"}},"getOrderPay"),r("span",{style:{color:"#E1E4E8"}},"(String orderSn) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    PayVo payVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"PayVo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    OrderEntity entity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"this"),r("span",{style:{color:"#E1E4E8"}},"."),r("span",{style:{color:"#B392F0"}},"getOrderByOrderSn"),r("span",{style:{color:"#E1E4E8"}},"(orderSn);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//保留2位小数，有小数就想上取值")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    BigDecimal bigDecimal "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," entity."),r("span",{style:{color:"#B392F0"}},"getTotalAmount"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"setScale"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"2"),r("span",{style:{color:"#E1E4E8"}},", BigDecimal.ROUND_UP);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    payVo."),r("span",{style:{color:"#B392F0"}},"setTotal_amount"),r("span",{style:{color:"#E1E4E8"}},"(bigDecimal."),r("span",{style:{color:"#B392F0"}},"toString"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    payVo."),r("span",{style:{color:"#B392F0"}},"setOut_trade_no"),r("span",{style:{color:"#E1E4E8"}},"(entity."),r("span",{style:{color:"#B392F0"}},"getOrderSn"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"OrderItemEntity"),r("span",{style:{color:"#E1E4E8"}},"> itemEntities "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderItemService."),r("span",{style:{color:"#B392F0"}},"list"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," QueryWrapper<"),r("span",{style:{color:"#F97583"}},"OrderItemEntity"),r("span",{style:{color:"#E1E4E8"}},">()."),r("span",{style:{color:"#B392F0"}},"eq"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order_sn"'),r("span",{style:{color:"#E1E4E8"}},", orderSn));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    OrderItemEntity item "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," itemEntities."),r("span",{style:{color:"#B392F0"}},"get"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"0"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    payVo."),r("span",{style:{color:"#B392F0"}},"setSubject"),r("span",{style:{color:"#E1E4E8"}},"(item."),r("span",{style:{color:"#B392F0"}},"getSkuName"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    payVo."),r("span",{style:{color:"#B392F0"}},"setBody"),r("span",{style:{color:"#E1E4E8"}},"(item."),r("span",{style:{color:"#B392F0"}},"getSkuAttrsVals"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," payVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 获取当前订单的支付信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"orderSn")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," PayVo "),r("span",{style:{color:"#6F42C1"}},"getOrderPay"),r("span",{style:{color:"#24292E"}},"(String orderSn) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    PayVo payVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"PayVo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    OrderEntity entity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"this"),r("span",{style:{color:"#24292E"}},"."),r("span",{style:{color:"#6F42C1"}},"getOrderByOrderSn"),r("span",{style:{color:"#24292E"}},"(orderSn);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//保留2位小数，有小数就想上取值")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    BigDecimal bigDecimal "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," entity."),r("span",{style:{color:"#6F42C1"}},"getTotalAmount"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"setScale"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"2"),r("span",{style:{color:"#24292E"}},", BigDecimal.ROUND_UP);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    payVo."),r("span",{style:{color:"#6F42C1"}},"setTotal_amount"),r("span",{style:{color:"#24292E"}},"(bigDecimal."),r("span",{style:{color:"#6F42C1"}},"toString"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    payVo."),r("span",{style:{color:"#6F42C1"}},"setOut_trade_no"),r("span",{style:{color:"#24292E"}},"(entity."),r("span",{style:{color:"#6F42C1"}},"getOrderSn"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"OrderItemEntity"),r("span",{style:{color:"#24292E"}},"> itemEntities "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderItemService."),r("span",{style:{color:"#6F42C1"}},"list"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," QueryWrapper<"),r("span",{style:{color:"#D73A49"}},"OrderItemEntity"),r("span",{style:{color:"#24292E"}},">()."),r("span",{style:{color:"#6F42C1"}},"eq"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order_sn"'),r("span",{style:{color:"#24292E"}},", orderSn));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    OrderItemEntity item "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," itemEntities."),r("span",{style:{color:"#6F42C1"}},"get"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"0"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    payVo."),r("span",{style:{color:"#6F42C1"}},"setSubject"),r("span",{style:{color:"#24292E"}},"(item."),r("span",{style:{color:"#6F42C1"}},"getSkuName"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    payVo."),r("span",{style:{color:"#6F42C1"}},"setBody"),r("span",{style:{color:"#24292E"}},"(item."),r("span",{style:{color:"#6F42C1"}},"getSkuAttrsVals"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," payVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),wl=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.web.PayWebController#payOrder")])],-1),ql=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 1、将支付页让浏览器展示")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 2、支付成功以后，我们要跳到用户的订单列表页")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"orderSn")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@throws"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#B392F0"}},"AlipayApiException")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"ResponseBody")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"GetMapping"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"value"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"/payOrder"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"produces"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"text/html"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," String "),r("span",{style:{color:"#B392F0"}},"payOrder"),r("span",{style:{color:"#E1E4E8"}},"(@"),r("span",{style:{color:"#F97583"}},"RequestParam"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"orderSn"'),r("span",{style:{color:"#E1E4E8"}},") String orderSn) throws AlipayApiException {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        PayVo payVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderService."),r("span",{style:{color:"#B392F0"}},"getOrderPay"),r("span",{style:{color:"#E1E4E8"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//返回的是一个页面，将此页面直接交给浏览器就行")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        String pay "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," alipayTemplate."),r("span",{style:{color:"#B392F0"}},"pay"),r("span",{style:{color:"#E1E4E8"}},"(payVo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        System.out.println(pay);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," pay;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 1、将支付页让浏览器展示")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 2、支付成功以后，我们要跳到用户的订单列表页")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"orderSn")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@throws"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#6F42C1"}},"AlipayApiException")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"ResponseBody")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"GetMapping"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"value"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"/payOrder"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"produces"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"text/html"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," String "),r("span",{style:{color:"#6F42C1"}},"payOrder"),r("span",{style:{color:"#24292E"}},"(@"),r("span",{style:{color:"#D73A49"}},"RequestParam"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"orderSn"'),r("span",{style:{color:"#24292E"}},") String orderSn) throws AlipayApiException {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        PayVo payVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderService."),r("span",{style:{color:"#6F42C1"}},"getOrderPay"),r("span",{style:{color:"#24292E"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//返回的是一个页面，将此页面直接交给浏览器就行")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        String pay "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," alipayTemplate."),r("span",{style:{color:"#6F42C1"}},"pay"),r("span",{style:{color:"#24292E"}},"(payVo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        System.out.println(pay);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," pay;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")])])]),r("button",{class:"collapse"})],-1),Pl=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.config.AlipayTemplate#pay")])],-1),Vl=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}},"  String "),r("span",{style:{color:"#B392F0"}},"pay"),r("span",{style:{color:"#E1E4E8"}},"(PayVo vo) throws AlipayApiException {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},'//AlipayClient alipayClient = new DefaultAlipayClient(AlipayTemplate.gatewayUrl, AlipayTemplate.app_id, AlipayTemplate.merchant_private_key, "json", AlipayTemplate.charset, AlipayTemplate.alipay_public_key, AlipayTemplate.sign_type);')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//1、根据支付宝的配置生成一个支付客户端")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    AlipayClient alipayClient "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"DefaultAlipayClient"),r("span",{style:{color:"#E1E4E8"}},"(gatewayUrl,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            app_id, merchant_private_key, "),r("span",{style:{color:"#9ECBFF"}},'"json"'),r("span",{style:{color:"#E1E4E8"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            charset, alipay_public_key, sign_type);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//2、创建一个支付请求 //设置请求参数")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    AlipayTradePagePayRequest alipayRequest "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"AlipayTradePagePayRequest"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    alipayRequest."),r("span",{style:{color:"#B392F0"}},"setReturnUrl"),r("span",{style:{color:"#E1E4E8"}},"(return_url);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    alipayRequest."),r("span",{style:{color:"#B392F0"}},"setNotifyUrl"),r("span",{style:{color:"#E1E4E8"}},"(notify_url);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//商户订单号，商户网站订单系统中唯一订单号，必填")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    String out_trade_no "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," vo."),r("span",{style:{color:"#B392F0"}},"getOut_trade_no"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//付款金额，必填")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    String total_amount "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," vo."),r("span",{style:{color:"#B392F0"}},"getTotal_amount"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//订单名称，必填")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    String subject "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," vo."),r("span",{style:{color:"#B392F0"}},"getSubject"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//商品描述，可空")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    String body "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," vo."),r("span",{style:{color:"#B392F0"}},"getBody"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    alipayRequest."),r("span",{style:{color:"#B392F0"}},"setBizContent"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"{'),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},"out_trade_no"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},":"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," out_trade_no "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},',"')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},"total_amount"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},":"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," total_amount "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},',"')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},"subject"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},":"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," subject "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},',"')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},"body"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},":"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," body "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},',"')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},"timeout_express"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},":"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}},"timeout"),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},',"')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"'),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},"product_code"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},":"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},"FAST_INSTANT_TRADE_PAY"),r("span",{style:{color:"#79B8FF"}},'\\"'),r("span",{style:{color:"#9ECBFF"}},'}"'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    String result "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," alipayClient."),r("span",{style:{color:"#B392F0"}},"pageExecute"),r("span",{style:{color:"#E1E4E8"}},"(alipayRequest)."),r("span",{style:{color:"#B392F0"}},"getBody"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//会收到支付宝的响应，响应的是一个页面，只要浏览器显示这个页面，就会自动来到支付宝的收银台页面")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"支付宝的响应："'),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}},"result);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," result;")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}},"  String "),r("span",{style:{color:"#6F42C1"}},"pay"),r("span",{style:{color:"#24292E"}},"(PayVo vo) throws AlipayApiException {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},'//AlipayClient alipayClient = new DefaultAlipayClient(AlipayTemplate.gatewayUrl, AlipayTemplate.app_id, AlipayTemplate.merchant_private_key, "json", AlipayTemplate.charset, AlipayTemplate.alipay_public_key, AlipayTemplate.sign_type);')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//1、根据支付宝的配置生成一个支付客户端")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    AlipayClient alipayClient "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"DefaultAlipayClient"),r("span",{style:{color:"#24292E"}},"(gatewayUrl,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            app_id, merchant_private_key, "),r("span",{style:{color:"#032F62"}},'"json"'),r("span",{style:{color:"#24292E"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            charset, alipay_public_key, sign_type);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//2、创建一个支付请求 //设置请求参数")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    AlipayTradePagePayRequest alipayRequest "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"AlipayTradePagePayRequest"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    alipayRequest."),r("span",{style:{color:"#6F42C1"}},"setReturnUrl"),r("span",{style:{color:"#24292E"}},"(return_url);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    alipayRequest."),r("span",{style:{color:"#6F42C1"}},"setNotifyUrl"),r("span",{style:{color:"#24292E"}},"(notify_url);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//商户订单号，商户网站订单系统中唯一订单号，必填")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    String out_trade_no "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," vo."),r("span",{style:{color:"#6F42C1"}},"getOut_trade_no"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//付款金额，必填")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    String total_amount "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," vo."),r("span",{style:{color:"#6F42C1"}},"getTotal_amount"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//订单名称，必填")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    String subject "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," vo."),r("span",{style:{color:"#6F42C1"}},"getSubject"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//商品描述，可空")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    String body "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," vo."),r("span",{style:{color:"#6F42C1"}},"getBody"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    alipayRequest."),r("span",{style:{color:"#6F42C1"}},"setBizContent"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"{'),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},"out_trade_no"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},":"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," out_trade_no "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},',"')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},"total_amount"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},":"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," total_amount "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},',"')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},"subject"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},":"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," subject "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},',"')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},"body"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},":"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," body "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},',"')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},"timeout_express"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},":"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}},"timeout"),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},',"')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"'),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},"product_code"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},":"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},"FAST_INSTANT_TRADE_PAY"),r("span",{style:{color:"#005CC5"}},'\\"'),r("span",{style:{color:"#032F62"}},'}"'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    String result "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," alipayClient."),r("span",{style:{color:"#6F42C1"}},"pageExecute"),r("span",{style:{color:"#24292E"}},"(alipayRequest)."),r("span",{style:{color:"#6F42C1"}},"getBody"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//会收到支付宝的响应，响应的是一个页面，只要浏览器显示这个页面，就会自动来到支付宝的收银台页面")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"支付宝的响应："'),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}},"result);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," result;")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Ml=r("figure",null,[r("img",{alt:"image",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403152134343.png"})],-1),jl=r("p",null,[c("通过谷歌浏览器打开 "),r("code",null,"pay.html"),c("即可，看到以下页面即为正常现象。")],-1),Nl=r("figure",null,[r("img",{alt:"image-20230403131612455",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403131612455.png"})],-1),Wl=r("p",null,"账户名和支付密码从沙箱账号处复制买方信息。如果买方账户余额为 0，可随意充值金额。",-1),Kl=r("figure",null,[r("img",{alt:"img",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/1674195718913-2cf0d08a-1bc0-4303-aef5-df51a662fadf.png"})],-1),zl=r("p",null,"使用账户余额支付即可。",-1),Hl=r("figure",null,[r("img",{alt:"image-20230403131639507",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403131639507.png"})],-1),Ql=r("p",null,"支付结果显示成功。",-1),Ul=r("figure",null,[r("img",{alt:"image-20230403131649890",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403131649890.png"})],-1),Gl=r("ul",null,[r("li",null,[r("ol",{start:"4"},[r("li",null,[r("strong",null,"支付结果回调")])])])],-1),Xl=r("p",null,"如果希望在沙箱环境中得知具体支付结果，我们需要通过 Natapp 开通内网穿透，开通教程详细查看下述官方文档：",-1),Jl=r("figure",null,[r("img",{alt:"image-20230403152749004",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403152749004.png"})],-1),$l=r("p",null,[c("将 Natapp 内网穿透地址替换 "),r("code",null,"application.properties"),c(" 文件下 "),r("code",null,"alipay.notify_url"),c(" 属性。")],-1),Yl=r("p",null,"再重复调用下支付宝支付接口流程，即可看到回调效果。",-1),Zl=r("ul",null,[r("li",null,"配置以上内网穿透配置才能完成订单支付，否则订单支付失败，订单自动取消，库存自动解锁")],-1),ls=r("div",{style:{"max-height":"300px"},class:"language-properties"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"properties"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"#异步通知：支付宝会悄悄的给我们发送一个请求，告诉我们支付成功的信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"alipay.notify_url"),r("span",{style:{color:"#E1E4E8"}},"=http://mqbb4a.natappfree.cc/paid/notify")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"#异步通知：支付宝会悄悄的给我们发送一个请求，告诉我们支付成功的信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"alipay.notify_url"),r("span",{style:{color:"#24292E"}},"=http://mqbb4a.natappfree.cc/paid/notify")])])]),r("button",{class:"collapse"})],-1),ss=r("figure",null,[r("img",{alt:"image-20230403131656175",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403131656175.png"})],-1),os=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#handlePayResult")])],-1),ns=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 处理支付宝的支付结果")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"vo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," String "),r("span",{style:{color:"#B392F0"}},"handlePayResult"),r("span",{style:{color:"#E1E4E8"}},"(PayAsyncVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//1、保存交易流水")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        PaymentInfoEntity infoEntity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"PaymentInfoEntity"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        infoEntity."),r("span",{style:{color:"#B392F0"}},"setAlipayTradeNo"),r("span",{style:{color:"#E1E4E8"}},"(vo."),r("span",{style:{color:"#B392F0"}},"getTrade_no"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        infoEntity."),r("span",{style:{color:"#B392F0"}},"setOrderSn"),r("span",{style:{color:"#E1E4E8"}},"(vo."),r("span",{style:{color:"#B392F0"}},"getOut_trade_no"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        infoEntity."),r("span",{style:{color:"#B392F0"}},"setPaymentStatus"),r("span",{style:{color:"#E1E4E8"}},"(vo."),r("span",{style:{color:"#B392F0"}},"getTrade_status"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        infoEntity."),r("span",{style:{color:"#B392F0"}},"setCallbackTime"),r("span",{style:{color:"#E1E4E8"}},"(vo."),r("span",{style:{color:"#B392F0"}},"getNotify_time"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        paymentInfoService."),r("span",{style:{color:"#B392F0"}},"save"),r("span",{style:{color:"#E1E4E8"}},"(infoEntity);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//2、修改订单的状态信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (vo."),r("span",{style:{color:"#B392F0"}},"getTrade_status"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"equals"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"TRADE_SUCCESS"'),r("span",{style:{color:"#E1E4E8"}},") "),r("span",{style:{color:"#F97583"}},"||"),r("span",{style:{color:"#E1E4E8"}}," vo."),r("span",{style:{color:"#B392F0"}},"getTrade_status"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"equals"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"TRADE_FINISHED"'),r("span",{style:{color:"#E1E4E8"}},")){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//支付成功状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            String outTradeNo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," vo."),r("span",{style:{color:"#B392F0"}},"getOut_trade_no"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#79B8FF"}},"this"),r("span",{style:{color:"#E1E4E8"}},".baseMapper."),r("span",{style:{color:"#B392F0"}},"updateOrderStatus"),r("span",{style:{color:"#E1E4E8"}},"(outTradeNo, OrderStatusEnum.PAYED."),r("span",{style:{color:"#B392F0"}},"getCode"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"success"'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 处理支付宝的支付结果")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"vo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," String "),r("span",{style:{color:"#6F42C1"}},"handlePayResult"),r("span",{style:{color:"#24292E"}},"(PayAsyncVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//1、保存交易流水")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        PaymentInfoEntity infoEntity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"PaymentInfoEntity"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        infoEntity."),r("span",{style:{color:"#6F42C1"}},"setAlipayTradeNo"),r("span",{style:{color:"#24292E"}},"(vo."),r("span",{style:{color:"#6F42C1"}},"getTrade_no"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        infoEntity."),r("span",{style:{color:"#6F42C1"}},"setOrderSn"),r("span",{style:{color:"#24292E"}},"(vo."),r("span",{style:{color:"#6F42C1"}},"getOut_trade_no"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        infoEntity."),r("span",{style:{color:"#6F42C1"}},"setPaymentStatus"),r("span",{style:{color:"#24292E"}},"(vo."),r("span",{style:{color:"#6F42C1"}},"getTrade_status"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        infoEntity."),r("span",{style:{color:"#6F42C1"}},"setCallbackTime"),r("span",{style:{color:"#24292E"}},"(vo."),r("span",{style:{color:"#6F42C1"}},"getNotify_time"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        paymentInfoService."),r("span",{style:{color:"#6F42C1"}},"save"),r("span",{style:{color:"#24292E"}},"(infoEntity);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//2、修改订单的状态信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (vo."),r("span",{style:{color:"#6F42C1"}},"getTrade_status"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"equals"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"TRADE_SUCCESS"'),r("span",{style:{color:"#24292E"}},") "),r("span",{style:{color:"#D73A49"}},"||"),r("span",{style:{color:"#24292E"}}," vo."),r("span",{style:{color:"#6F42C1"}},"getTrade_status"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"equals"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"TRADE_FINISHED"'),r("span",{style:{color:"#24292E"}},")){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//支付成功状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            String outTradeNo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," vo."),r("span",{style:{color:"#6F42C1"}},"getOut_trade_no"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#005CC5"}},"this"),r("span",{style:{color:"#24292E"}},".baseMapper."),r("span",{style:{color:"#6F42C1"}},"updateOrderStatus"),r("span",{style:{color:"#24292E"}},"(outTradeNo, OrderStatusEnum.PAYED."),r("span",{style:{color:"#6F42C1"}},"getCode"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"success"'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")])])]),r("button",{class:"collapse"})],-1),es=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.listener.OrderPaidListener#handleAlipaid")])],-1),as=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 支付成功异步通知")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"vo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"request")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"PostMapping"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"/paid/notify"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," String "),r("span",{style:{color:"#B392F0"}},"handleAlipaid"),r("span",{style:{color:"#E1E4E8"}},"(PayAsyncVo vo, HttpServletRequest request) throws Exception {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//只要我们收到了支付宝给我们异步的通知，告诉我们订单支付成功，返回success，支付宝就再也不通知")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        Map<String, String[]> map = request.getParameterMap();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        for (String key : map.keySet()) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//            String value = request.getParameter(key);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},'//            System.out.println("参数名："+key+"==>参数值："+ value);')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},'//        System.out.println("支付宝通知到位了...数据："+map);')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//验签")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        Map<"),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},","),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},"> params "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," HashMap<"),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},","),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},">();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        Map<"),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},","),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},"[]> requestParams "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," request."),r("span",{style:{color:"#B392F0"}},"getParameterMap"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"for"),r("span",{style:{color:"#E1E4E8"}}," (Iterator<"),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},"> iter "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," requestParams."),r("span",{style:{color:"#B392F0"}},"keySet"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"iterator"),r("span",{style:{color:"#E1E4E8"}},"(); iter."),r("span",{style:{color:"#B392F0"}},"hasNext"),r("span",{style:{color:"#E1E4E8"}},"();) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            String name "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," (String) iter."),r("span",{style:{color:"#B392F0"}},"next"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},"[] values "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," ("),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},"[]) requestParams."),r("span",{style:{color:"#B392F0"}},"get"),r("span",{style:{color:"#E1E4E8"}},"(name);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            String valueStr "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'""'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"for"),r("span",{style:{color:"#E1E4E8"}}," ("),r("span",{style:{color:"#F97583"}},"int"),r("span",{style:{color:"#E1E4E8"}}," i "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"0"),r("span",{style:{color:"#E1E4E8"}},"; i "),r("span",{style:{color:"#F97583"}},"<"),r("span",{style:{color:"#E1E4E8"}}," values.length; i"),r("span",{style:{color:"#F97583"}},"++"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                valueStr "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," (i "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," values.length "),r("span",{style:{color:"#F97583"}},"-"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#E1E4E8"}},") "),r("span",{style:{color:"#F97583"}},"?"),r("span",{style:{color:"#E1E4E8"}}," valueStr "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," values[i]")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                        "),r("span",{style:{color:"#F97583"}},":"),r("span",{style:{color:"#E1E4E8"}}," valueStr "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," values[i] "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'","'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//乱码解决，这段代码在出现乱码时使用")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},'//            valueStr = new String(valueStr.getBytes("ISO-8859-1"), "utf-8");')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            params."),r("span",{style:{color:"#B392F0"}},"put"),r("span",{style:{color:"#E1E4E8"}},"(name, valueStr);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"boolean"),r("span",{style:{color:"#E1E4E8"}}," signVerified "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," AlipaySignature."),r("span",{style:{color:"#B392F0"}},"rsaCheckV1"),r("span",{style:{color:"#E1E4E8"}},"(params, alipayTemplate."),r("span",{style:{color:"#B392F0"}},"getAlipay_public_key"),r("span",{style:{color:"#E1E4E8"}},"(), alipayTemplate."),r("span",{style:{color:"#B392F0"}},"getCharset"),r("span",{style:{color:"#E1E4E8"}},"(), alipayTemplate."),r("span",{style:{color:"#B392F0"}},"getSign_type"),r("span",{style:{color:"#E1E4E8"}},"()); "),r("span",{style:{color:"#6A737D"}},"//")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (signVerified){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//验签成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"签名验证成功....."'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            String result "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderService."),r("span",{style:{color:"#B392F0"}},"handlePayResult"),r("span",{style:{color:"#E1E4E8"}},"(vo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," result;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }"),r("span",{style:{color:"#F97583"}},"else"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"签名验证失败....."'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"error"'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 支付成功异步通知")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"vo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"request")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"PostMapping"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"/paid/notify"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," String "),r("span",{style:{color:"#6F42C1"}},"handleAlipaid"),r("span",{style:{color:"#24292E"}},"(PayAsyncVo vo, HttpServletRequest request) throws Exception {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//只要我们收到了支付宝给我们异步的通知，告诉我们订单支付成功，返回success，支付宝就再也不通知")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        Map<String, String[]> map = request.getParameterMap();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        for (String key : map.keySet()) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//            String value = request.getParameter(key);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},'//            System.out.println("参数名："+key+"==>参数值："+ value);')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},'//        System.out.println("支付宝通知到位了...数据："+map);')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//验签")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        Map<"),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},","),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},"> params "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," HashMap<"),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},","),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},">();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        Map<"),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},","),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},"[]> requestParams "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," request."),r("span",{style:{color:"#6F42C1"}},"getParameterMap"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"for"),r("span",{style:{color:"#24292E"}}," (Iterator<"),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},"> iter "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," requestParams."),r("span",{style:{color:"#6F42C1"}},"keySet"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"iterator"),r("span",{style:{color:"#24292E"}},"(); iter."),r("span",{style:{color:"#6F42C1"}},"hasNext"),r("span",{style:{color:"#24292E"}},"();) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            String name "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," (String) iter."),r("span",{style:{color:"#6F42C1"}},"next"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},"[] values "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," ("),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},"[]) requestParams."),r("span",{style:{color:"#6F42C1"}},"get"),r("span",{style:{color:"#24292E"}},"(name);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            String valueStr "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'""'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"for"),r("span",{style:{color:"#24292E"}}," ("),r("span",{style:{color:"#D73A49"}},"int"),r("span",{style:{color:"#24292E"}}," i "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"0"),r("span",{style:{color:"#24292E"}},"; i "),r("span",{style:{color:"#D73A49"}},"<"),r("span",{style:{color:"#24292E"}}," values.length; i"),r("span",{style:{color:"#D73A49"}},"++"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                valueStr "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," (i "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," values.length "),r("span",{style:{color:"#D73A49"}},"-"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#24292E"}},") "),r("span",{style:{color:"#D73A49"}},"?"),r("span",{style:{color:"#24292E"}}," valueStr "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," values[i]")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                        "),r("span",{style:{color:"#D73A49"}},":"),r("span",{style:{color:"#24292E"}}," valueStr "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," values[i] "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'","'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//乱码解决，这段代码在出现乱码时使用")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},'//            valueStr = new String(valueStr.getBytes("ISO-8859-1"), "utf-8");')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            params."),r("span",{style:{color:"#6F42C1"}},"put"),r("span",{style:{color:"#24292E"}},"(name, valueStr);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"boolean"),r("span",{style:{color:"#24292E"}}," signVerified "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," AlipaySignature."),r("span",{style:{color:"#6F42C1"}},"rsaCheckV1"),r("span",{style:{color:"#24292E"}},"(params, alipayTemplate."),r("span",{style:{color:"#6F42C1"}},"getAlipay_public_key"),r("span",{style:{color:"#24292E"}},"(), alipayTemplate."),r("span",{style:{color:"#6F42C1"}},"getCharset"),r("span",{style:{color:"#24292E"}},"(), alipayTemplate."),r("span",{style:{color:"#6F42C1"}},"getSign_type"),r("span",{style:{color:"#24292E"}},"()); "),r("span",{style:{color:"#6A737D"}},"//")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (signVerified){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//验签成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"签名验证成功....."'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            String result "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderService."),r("span",{style:{color:"#6F42C1"}},"handlePayResult"),r("span",{style:{color:"#24292E"}},"(vo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," result;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }"),r("span",{style:{color:"#D73A49"}},"else"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"签名验证失败....."'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"error"'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")])])]),r("button",{class:"collapse"})],-1),ts=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"private"),r("span",{style:{color:"#E1E4E8"}},"  String return_url "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"http://member.gulimall.com/memberOrder.html"'),r("span",{style:{color:"#E1E4E8"}},";")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"private"),r("span",{style:{color:"#24292E"}},"  String return_url "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"http://member.gulimall.com/memberOrder.html"'),r("span",{style:{color:"#24292E"}},";")])])]),r("button",{class:"collapse"})],-1),rs=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.member.Web.MemberWebController#memberOrderPage")])],-1),cs=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"GetMapping"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"/memberOrder.html"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," String "),r("span",{style:{color:"#B392F0"}},"memberOrderPage"),r("span",{style:{color:"#E1E4E8"}},"(@"),r("span",{style:{color:"#F97583"}},"RequestParam"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"value"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"pageNum"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"defaultValue"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"1"'),r("span",{style:{color:"#E1E4E8"}},") Integer pageNum,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                              Model model) {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//查出当前登录的用户的所有订单列表数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    Map<"),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#F97583"}},"Object"),r("span",{style:{color:"#E1E4E8"}},"> page "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," HashMap<>();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    page."),r("span",{style:{color:"#B392F0"}},"put"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"page"'),r("span",{style:{color:"#E1E4E8"}},", pageNum."),r("span",{style:{color:"#B392F0"}},"toString"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    R r "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderFeignService."),r("span",{style:{color:"#B392F0"}},"listWithItem"),r("span",{style:{color:"#E1E4E8"}},"(page);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"(JSON."),r("span",{style:{color:"#B392F0"}},"toJSONString"),r("span",{style:{color:"#E1E4E8"}},"(r));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    model."),r("span",{style:{color:"#B392F0"}},"addAttribute"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"orders"'),r("span",{style:{color:"#E1E4E8"}},", r);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"orderList"'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"GetMapping"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"/memberOrder.html"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," String "),r("span",{style:{color:"#6F42C1"}},"memberOrderPage"),r("span",{style:{color:"#24292E"}},"(@"),r("span",{style:{color:"#D73A49"}},"RequestParam"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"value"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"pageNum"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"defaultValue"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"1"'),r("span",{style:{color:"#24292E"}},") Integer pageNum,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                              Model model) {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//查出当前登录的用户的所有订单列表数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    Map<"),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#D73A49"}},"Object"),r("span",{style:{color:"#24292E"}},"> page "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," HashMap<>();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    page."),r("span",{style:{color:"#6F42C1"}},"put"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"page"'),r("span",{style:{color:"#24292E"}},", pageNum."),r("span",{style:{color:"#6F42C1"}},"toString"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    R r "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderFeignService."),r("span",{style:{color:"#6F42C1"}},"listWithItem"),r("span",{style:{color:"#24292E"}},"(page);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"(JSON."),r("span",{style:{color:"#6F42C1"}},"toJSONString"),r("span",{style:{color:"#24292E"}},"(r));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    model."),r("span",{style:{color:"#6F42C1"}},"addAttribute"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"orders"'),r("span",{style:{color:"#24292E"}},", r);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"orderList"'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),ps=r("ul",null,[r("li",null,"远程调用订单服务查出当前登录的用户的所有订单列表数据"),r("li",null,[r("code",null,"com.klaus.gulimall.order.controller.OrderController#listWithItem")])],-1),ys=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * todo 远程调用都要全用@POSTMapping+@RequestBody(请求体只支持post)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 分页查询当前登录用户的所有订单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"params")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"PostMapping"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"/listWithItem"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},'//@RequiresPermissions("order:order:list")')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," R "),r("span",{style:{color:"#B392F0"}},"listWithItem"),r("span",{style:{color:"#E1E4E8"}},"(@"),r("span",{style:{color:"#F97583"}},"RequestBody"),r("span",{style:{color:"#E1E4E8"}}," Map"),r("span",{style:{color:"#F97583"}},"<"),r("span",{style:{color:"#E1E4E8"}},"String, Object"),r("span",{style:{color:"#F97583"}},">"),r("span",{style:{color:"#E1E4E8"}}," params){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    PageUtils page "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderService."),r("span",{style:{color:"#B392F0"}},"queryPageWithItem"),r("span",{style:{color:"#E1E4E8"}},"(params);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," R."),r("span",{style:{color:"#B392F0"}},"ok"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"put"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"page"'),r("span",{style:{color:"#E1E4E8"}},", page);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * todo 远程调用都要全用@POSTMapping+@RequestBody(请求体只支持post)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 分页查询当前登录用户的所有订单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"params")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"PostMapping"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"/listWithItem"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},'//@RequiresPermissions("order:order:list")')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," R "),r("span",{style:{color:"#6F42C1"}},"listWithItem"),r("span",{style:{color:"#24292E"}},"(@"),r("span",{style:{color:"#D73A49"}},"RequestBody"),r("span",{style:{color:"#24292E"}}," Map"),r("span",{style:{color:"#D73A49"}},"<"),r("span",{style:{color:"#24292E"}},"String, Object"),r("span",{style:{color:"#D73A49"}},">"),r("span",{style:{color:"#24292E"}}," params){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    PageUtils page "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderService."),r("span",{style:{color:"#6F42C1"}},"queryPageWithItem"),r("span",{style:{color:"#24292E"}},"(params);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," R."),r("span",{style:{color:"#6F42C1"}},"ok"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"put"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"page"'),r("span",{style:{color:"#24292E"}},", page);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Es=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#queryPageWithItem")])],-1),is=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," PageUtils "),r("span",{style:{color:"#B392F0"}},"queryPageWithItem"),r("span",{style:{color:"#E1E4E8"}},"(Map"),r("span",{style:{color:"#F97583"}},"<"),r("span",{style:{color:"#E1E4E8"}},"String, Object"),r("span",{style:{color:"#F97583"}},">"),r("span",{style:{color:"#E1E4E8"}}," params) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//获取当前登录的用户信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    MemberRespVo memberRespVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," LoginUserInterceptor.loginUser."),r("span",{style:{color:"#B392F0"}},"get"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    IPage<"),r("span",{style:{color:"#F97583"}},"OrderEntity"),r("span",{style:{color:"#E1E4E8"}},"> page "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"this"),r("span",{style:{color:"#E1E4E8"}},"."),r("span",{style:{color:"#B392F0"}},"page"),r("span",{style:{color:"#E1E4E8"}},"(")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," Query<"),r("span",{style:{color:"#F97583"}},"OrderEntity"),r("span",{style:{color:"#E1E4E8"}},">()."),r("span",{style:{color:"#B392F0"}},"getPage"),r("span",{style:{color:"#E1E4E8"}},"(params),                                            "),r("span",{style:{color:"#6A737D"}},"//根据id降序")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," QueryWrapper<"),r("span",{style:{color:"#F97583"}},"OrderEntity"),r("span",{style:{color:"#E1E4E8"}},">()."),r("span",{style:{color:"#B392F0"}},"eq"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"member_id"'),r("span",{style:{color:"#E1E4E8"}},", memberRespVo."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"())."),r("span",{style:{color:"#B392F0"}},"orderByDesc"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"id"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    );")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"OrderEntity"),r("span",{style:{color:"#E1E4E8"}},"> orderEntities "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," page."),r("span",{style:{color:"#B392F0"}},"getRecords"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"stream"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"map"),r("span",{style:{color:"#E1E4E8"}},"(order "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//封装订单项到订单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"OrderItemEntity"),r("span",{style:{color:"#E1E4E8"}},"> itemEntities "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderItemService."),r("span",{style:{color:"#B392F0"}},"list"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," QueryWrapper<"),r("span",{style:{color:"#F97583"}},"OrderItemEntity"),r("span",{style:{color:"#E1E4E8"}},">()."),r("span",{style:{color:"#B392F0"}},"eq"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order_sn"'),r("span",{style:{color:"#E1E4E8"}},", order."),r("span",{style:{color:"#B392F0"}},"getOrderSn"),r("span",{style:{color:"#E1E4E8"}},"()));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        order."),r("span",{style:{color:"#B392F0"}},"setItemEntities"),r("span",{style:{color:"#E1E4E8"}},"(itemEntities);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," order;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    })."),r("span",{style:{color:"#B392F0"}},"collect"),r("span",{style:{color:"#E1E4E8"}},"(Collectors."),r("span",{style:{color:"#B392F0"}},"toList"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    page."),r("span",{style:{color:"#B392F0"}},"setRecords"),r("span",{style:{color:"#E1E4E8"}},"(orderEntities);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"PageUtils"),r("span",{style:{color:"#E1E4E8"}},"(page);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," PageUtils "),r("span",{style:{color:"#6F42C1"}},"queryPageWithItem"),r("span",{style:{color:"#24292E"}},"(Map"),r("span",{style:{color:"#D73A49"}},"<"),r("span",{style:{color:"#24292E"}},"String, Object"),r("span",{style:{color:"#D73A49"}},">"),r("span",{style:{color:"#24292E"}}," params) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//获取当前登录的用户信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    MemberRespVo memberRespVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," LoginUserInterceptor.loginUser."),r("span",{style:{color:"#6F42C1"}},"get"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    IPage<"),r("span",{style:{color:"#D73A49"}},"OrderEntity"),r("span",{style:{color:"#24292E"}},"> page "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"this"),r("span",{style:{color:"#24292E"}},"."),r("span",{style:{color:"#6F42C1"}},"page"),r("span",{style:{color:"#24292E"}},"(")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," Query<"),r("span",{style:{color:"#D73A49"}},"OrderEntity"),r("span",{style:{color:"#24292E"}},">()."),r("span",{style:{color:"#6F42C1"}},"getPage"),r("span",{style:{color:"#24292E"}},"(params),                                            "),r("span",{style:{color:"#6A737D"}},"//根据id降序")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," QueryWrapper<"),r("span",{style:{color:"#D73A49"}},"OrderEntity"),r("span",{style:{color:"#24292E"}},">()."),r("span",{style:{color:"#6F42C1"}},"eq"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"member_id"'),r("span",{style:{color:"#24292E"}},", memberRespVo."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"())."),r("span",{style:{color:"#6F42C1"}},"orderByDesc"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"id"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    );")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"OrderEntity"),r("span",{style:{color:"#24292E"}},"> orderEntities "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," page."),r("span",{style:{color:"#6F42C1"}},"getRecords"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"stream"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"map"),r("span",{style:{color:"#24292E"}},"(order "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//封装订单项到订单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"OrderItemEntity"),r("span",{style:{color:"#24292E"}},"> itemEntities "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderItemService."),r("span",{style:{color:"#6F42C1"}},"list"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," QueryWrapper<"),r("span",{style:{color:"#D73A49"}},"OrderItemEntity"),r("span",{style:{color:"#24292E"}},">()."),r("span",{style:{color:"#6F42C1"}},"eq"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order_sn"'),r("span",{style:{color:"#24292E"}},", order."),r("span",{style:{color:"#6F42C1"}},"getOrderSn"),r("span",{style:{color:"#24292E"}},"()));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        order."),r("span",{style:{color:"#6F42C1"}},"setItemEntities"),r("span",{style:{color:"#24292E"}},"(itemEntities);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," order;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    })."),r("span",{style:{color:"#6F42C1"}},"collect"),r("span",{style:{color:"#24292E"}},"(Collectors."),r("span",{style:{color:"#6F42C1"}},"toList"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    page."),r("span",{style:{color:"#6F42C1"}},"setRecords"),r("span",{style:{color:"#24292E"}},"(orderEntities);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"PageUtils"),r("span",{style:{color:"#24292E"}},"(page);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),us=r("figure",null,[r("img",{alt:"image-20230403131702203",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403131702203.png"})],-1),ds={id:"_2-订单创建前需要预览订单-选择收货信息等",tabindex:"-1"},gs=r("figure",null,[r("img",{alt:"image-20230403130248691",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403130248691.png"})],-1),Fs=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.web.OrderWebController#toTrade")])],-1),As=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * OrderConfirmVo = [List<MemberAddressVo> address, //收货地址， ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     *                  List<OrderItemVo> items,      //所有选中的购物项")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     *                 Integer integration,         //积分...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     *                 Map<Long, Boolean> stocks, //库存信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     *                 String orderToken        //防重令牌]")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"*/")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"GetMapping"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"/toTrade"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," String "),r("span",{style:{color:"#B392F0"}},"toTrade"),r("span",{style:{color:"#E1E4E8"}},"(Model model, HttpServletRequest request) throws ExecutionException, InterruptedException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    OrderConfirmVo confirmVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderService."),r("span",{style:{color:"#B392F0"}},"confirmOrder"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    model."),r("span",{style:{color:"#B392F0"}},"addAttribute"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"orderConfirmData"'),r("span",{style:{color:"#E1E4E8"}},", confirmVo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//展示订单确认的数据(页面跳转)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"confirm"'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * OrderConfirmVo = [List<MemberAddressVo> address, //收货地址， ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     *                  List<OrderItemVo> items,      //所有选中的购物项")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     *                 Integer integration,         //积分...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     *                 Map<Long, Boolean> stocks, //库存信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     *                 String orderToken        //防重令牌]")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"*/")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"GetMapping"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"/toTrade"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," String "),r("span",{style:{color:"#6F42C1"}},"toTrade"),r("span",{style:{color:"#24292E"}},"(Model model, HttpServletRequest request) throws ExecutionException, InterruptedException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    OrderConfirmVo confirmVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderService."),r("span",{style:{color:"#6F42C1"}},"confirmOrder"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    model."),r("span",{style:{color:"#6F42C1"}},"addAttribute"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"orderConfirmData"'),r("span",{style:{color:"#24292E"}},", confirmVo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//展示订单确认的数据(页面跳转)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"confirm"'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),ms=r("ul",null,[r("li",null,[r("p",null,[r("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#confirmOrder")])]),r("li",null,[r("blockquote",null,[r("p",null,[r("strong",null,"注"),c("：使用异步编排时用到远程调用，如果不进行请求上下文共享将造成Feign异步情况丢失上下文问题")])])])],-1),Ds=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 订单确认页返回需要用到的数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," OrderConfirmVo "),r("span",{style:{color:"#B392F0"}},"confirmOrder"),r("span",{style:{color:"#E1E4E8"}},"() throws ExecutionException, InterruptedException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    OrderConfirmVo confirmVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"OrderConfirmVo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//从拦截器里获取用户信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    MemberRespVo memberRespVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," LoginUserInterceptor.loginUser."),r("span",{style:{color:"#B392F0"}},"get"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"主线程...."'),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," Thread."),r("span",{style:{color:"#B392F0"}},"currentThread"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//获取原来请求上下文请求属性")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    RequestAttributes requestAttributes "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," RequestContextHolder."),r("span",{style:{color:"#B392F0"}},"getRequestAttributes"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//进行异步编排")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    CompletableFuture<"),r("span",{style:{color:"#F97583"}},"Void"),r("span",{style:{color:"#E1E4E8"}},"> getAddressFuture "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," CompletableFuture."),r("span",{style:{color:"#B392F0"}},"runAsync"),r("span",{style:{color:"#E1E4E8"}},"(() "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//1、远程查询所有的收货地址列表")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"member线程...."'),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," Thread."),r("span",{style:{color:"#B392F0"}},"currentThread"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//在Feign异步调用前将请求上下文进行共享操作(之前的请求数据都来共享每一个线程)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        RequestContextHolder."),r("span",{style:{color:"#B392F0"}},"setRequestAttributes"),r("span",{style:{color:"#E1E4E8"}},"(requestAttributes);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"MemberAddressVo"),r("span",{style:{color:"#E1E4E8"}},"> address "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," memberFeignService."),r("span",{style:{color:"#B392F0"}},"getAddress"),r("span",{style:{color:"#E1E4E8"}},"(memberRespVo."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        confirmVo."),r("span",{style:{color:"#B392F0"}},"setAddress"),r("span",{style:{color:"#E1E4E8"}},"(address);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    CompletableFuture<"),r("span",{style:{color:"#F97583"}},"Void"),r("span",{style:{color:"#E1E4E8"}},"> cartFuture "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," CompletableFuture."),r("span",{style:{color:"#B392F0"}},"runAsync"),r("span",{style:{color:"#E1E4E8"}},"(() "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//2、远程查询购物车所有选中的购物项")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"cart线程...."'),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," Thread."),r("span",{style:{color:"#B392F0"}},"currentThread"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//在Feign异步调用前将请求上下文进行共享操作")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        RequestContextHolder."),r("span",{style:{color:"#B392F0"}},"setRequestAttributes"),r("span",{style:{color:"#E1E4E8"}},"(requestAttributes);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"OrderItemVo"),r("span",{style:{color:"#E1E4E8"}},"> items "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," cartFeignService."),r("span",{style:{color:"#B392F0"}},"currentUserCartItems"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        confirmVo."),r("span",{style:{color:"#B392F0"}},"setItems"),r("span",{style:{color:"#E1E4E8"}},"(items);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//feign在远程调用之前要构造请求，调用很多的拦截器")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//for(RequestInterceptor interceptor:requestInterceptors)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }, executor)."),r("span",{style:{color:"#B392F0"}},"thenRunAsync"),r("span",{style:{color:"#E1E4E8"}},"(() "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"OrderItemVo"),r("span",{style:{color:"#E1E4E8"}},"> items "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," confirmVo."),r("span",{style:{color:"#B392F0"}},"getItems"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"Long"),r("span",{style:{color:"#E1E4E8"}},"> skuIds "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," items."),r("span",{style:{color:"#B392F0"}},"stream"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"map"),r("span",{style:{color:"#E1E4E8"}},"(item "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," item."),r("span",{style:{color:"#B392F0"}},"getSkuId"),r("span",{style:{color:"#E1E4E8"}},"())."),r("span",{style:{color:"#B392F0"}},"collect"),r("span",{style:{color:"#E1E4E8"}},"(Collectors."),r("span",{style:{color:"#B392F0"}},"toList"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//远程查询库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        R r "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wmsFeignService."),r("span",{style:{color:"#B392F0"}},"getSkusHasStock"),r("span",{style:{color:"#E1E4E8"}},"(skuIds);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"SkuStockVo"),r("span",{style:{color:"#E1E4E8"}},"> data "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," r."),r("span",{style:{color:"#B392F0"}},"getData"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," TypeReference<List<"),r("span",{style:{color:"#F97583"}},"SkuStockVo"),r("span",{style:{color:"#E1E4E8"}},">>() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        });")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (data "),r("span",{style:{color:"#F97583"}},"!="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"// Map<SkuId, hasStock> map")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            Map<"),r("span",{style:{color:"#F97583"}},"Long"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#F97583"}},"Boolean"),r("span",{style:{color:"#E1E4E8"}},"> map "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," data."),r("span",{style:{color:"#B392F0"}},"stream"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"collect"),r("span",{style:{color:"#E1E4E8"}},"(Collectors."),r("span",{style:{color:"#B392F0"}},"toMap"),r("span",{style:{color:"#E1E4E8"}},"(SkuStockVo"),r("span",{style:{color:"#F97583"}},"::"),r("span",{style:{color:"#E1E4E8"}},"getSkuId, SkuStockVo"),r("span",{style:{color:"#F97583"}},"::"),r("span",{style:{color:"#E1E4E8"}},"getHasStock));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"// Map<Long, Boolean> stocks;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            confirmVo."),r("span",{style:{color:"#B392F0"}},"setStocks"),r("span",{style:{color:"#E1E4E8"}},"(map);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//3、查询用户积分")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    Integer integration "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," memberRespVo."),r("span",{style:{color:"#B392F0"}},"getIntegration"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    confirmVo."),r("span",{style:{color:"#B392F0"}},"setIntegration"),r("span",{style:{color:"#E1E4E8"}},"(integration);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//4、其他数据自动计算")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//todo 5、防重令牌")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    String token "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," UUID."),r("span",{style:{color:"#B392F0"}},"randomUUID"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"toString"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"replace"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"-"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#9ECBFF"}},'""'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//给服务器一个令牌")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    redisTemplate."),r("span",{style:{color:"#B392F0"}},"opsForValue"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"set"),r("span",{style:{color:"#E1E4E8"}},"(OrderConstant.USER_ORDER_TOKEN_PREFIX "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," memberRespVo."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"(), token, "),r("span",{style:{color:"#79B8FF"}},"30"),r("span",{style:{color:"#E1E4E8"}},", TimeUnit.MINUTES);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//给页面一个令牌")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    confirmVo."),r("span",{style:{color:"#B392F0"}},"setOrderToken"),r("span",{style:{color:"#E1E4E8"}},"(token);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    CompletableFuture."),r("span",{style:{color:"#B392F0"}},"allOf"),r("span",{style:{color:"#E1E4E8"}},"(getAddressFuture, cartFuture)."),r("span",{style:{color:"#B392F0"}},"get"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," confirmVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 订单确认页返回需要用到的数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," OrderConfirmVo "),r("span",{style:{color:"#6F42C1"}},"confirmOrder"),r("span",{style:{color:"#24292E"}},"() throws ExecutionException, InterruptedException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    OrderConfirmVo confirmVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"OrderConfirmVo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//从拦截器里获取用户信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    MemberRespVo memberRespVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," LoginUserInterceptor.loginUser."),r("span",{style:{color:"#6F42C1"}},"get"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"主线程...."'),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," Thread."),r("span",{style:{color:"#6F42C1"}},"currentThread"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//获取原来请求上下文请求属性")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    RequestAttributes requestAttributes "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," RequestContextHolder."),r("span",{style:{color:"#6F42C1"}},"getRequestAttributes"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//进行异步编排")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    CompletableFuture<"),r("span",{style:{color:"#D73A49"}},"Void"),r("span",{style:{color:"#24292E"}},"> getAddressFuture "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," CompletableFuture."),r("span",{style:{color:"#6F42C1"}},"runAsync"),r("span",{style:{color:"#24292E"}},"(() "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//1、远程查询所有的收货地址列表")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"member线程...."'),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," Thread."),r("span",{style:{color:"#6F42C1"}},"currentThread"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//在Feign异步调用前将请求上下文进行共享操作(之前的请求数据都来共享每一个线程)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        RequestContextHolder."),r("span",{style:{color:"#6F42C1"}},"setRequestAttributes"),r("span",{style:{color:"#24292E"}},"(requestAttributes);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"MemberAddressVo"),r("span",{style:{color:"#24292E"}},"> address "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," memberFeignService."),r("span",{style:{color:"#6F42C1"}},"getAddress"),r("span",{style:{color:"#24292E"}},"(memberRespVo."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        confirmVo."),r("span",{style:{color:"#6F42C1"}},"setAddress"),r("span",{style:{color:"#24292E"}},"(address);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    CompletableFuture<"),r("span",{style:{color:"#D73A49"}},"Void"),r("span",{style:{color:"#24292E"}},"> cartFuture "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," CompletableFuture."),r("span",{style:{color:"#6F42C1"}},"runAsync"),r("span",{style:{color:"#24292E"}},"(() "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//2、远程查询购物车所有选中的购物项")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"cart线程...."'),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," Thread."),r("span",{style:{color:"#6F42C1"}},"currentThread"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//在Feign异步调用前将请求上下文进行共享操作")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        RequestContextHolder."),r("span",{style:{color:"#6F42C1"}},"setRequestAttributes"),r("span",{style:{color:"#24292E"}},"(requestAttributes);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"OrderItemVo"),r("span",{style:{color:"#24292E"}},"> items "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," cartFeignService."),r("span",{style:{color:"#6F42C1"}},"currentUserCartItems"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        confirmVo."),r("span",{style:{color:"#6F42C1"}},"setItems"),r("span",{style:{color:"#24292E"}},"(items);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//feign在远程调用之前要构造请求，调用很多的拦截器")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//for(RequestInterceptor interceptor:requestInterceptors)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }, executor)."),r("span",{style:{color:"#6F42C1"}},"thenRunAsync"),r("span",{style:{color:"#24292E"}},"(() "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"OrderItemVo"),r("span",{style:{color:"#24292E"}},"> items "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," confirmVo."),r("span",{style:{color:"#6F42C1"}},"getItems"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"Long"),r("span",{style:{color:"#24292E"}},"> skuIds "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," items."),r("span",{style:{color:"#6F42C1"}},"stream"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"map"),r("span",{style:{color:"#24292E"}},"(item "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," item."),r("span",{style:{color:"#6F42C1"}},"getSkuId"),r("span",{style:{color:"#24292E"}},"())."),r("span",{style:{color:"#6F42C1"}},"collect"),r("span",{style:{color:"#24292E"}},"(Collectors."),r("span",{style:{color:"#6F42C1"}},"toList"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//远程查询库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        R r "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wmsFeignService."),r("span",{style:{color:"#6F42C1"}},"getSkusHasStock"),r("span",{style:{color:"#24292E"}},"(skuIds);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"SkuStockVo"),r("span",{style:{color:"#24292E"}},"> data "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," r."),r("span",{style:{color:"#6F42C1"}},"getData"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," TypeReference<List<"),r("span",{style:{color:"#D73A49"}},"SkuStockVo"),r("span",{style:{color:"#24292E"}},">>() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        });")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (data "),r("span",{style:{color:"#D73A49"}},"!="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"// Map<SkuId, hasStock> map")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            Map<"),r("span",{style:{color:"#D73A49"}},"Long"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#D73A49"}},"Boolean"),r("span",{style:{color:"#24292E"}},"> map "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," data."),r("span",{style:{color:"#6F42C1"}},"stream"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"collect"),r("span",{style:{color:"#24292E"}},"(Collectors."),r("span",{style:{color:"#6F42C1"}},"toMap"),r("span",{style:{color:"#24292E"}},"(SkuStockVo"),r("span",{style:{color:"#D73A49"}},"::"),r("span",{style:{color:"#24292E"}},"getSkuId, SkuStockVo"),r("span",{style:{color:"#D73A49"}},"::"),r("span",{style:{color:"#24292E"}},"getHasStock));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"// Map<Long, Boolean> stocks;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            confirmVo."),r("span",{style:{color:"#6F42C1"}},"setStocks"),r("span",{style:{color:"#24292E"}},"(map);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//3、查询用户积分")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    Integer integration "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," memberRespVo."),r("span",{style:{color:"#6F42C1"}},"getIntegration"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    confirmVo."),r("span",{style:{color:"#6F42C1"}},"setIntegration"),r("span",{style:{color:"#24292E"}},"(integration);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//4、其他数据自动计算")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//todo 5、防重令牌")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    String token "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," UUID."),r("span",{style:{color:"#6F42C1"}},"randomUUID"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"toString"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"replace"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"-"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#032F62"}},'""'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//给服务器一个令牌")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    redisTemplate."),r("span",{style:{color:"#6F42C1"}},"opsForValue"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"set"),r("span",{style:{color:"#24292E"}},"(OrderConstant.USER_ORDER_TOKEN_PREFIX "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," memberRespVo."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"(), token, "),r("span",{style:{color:"#005CC5"}},"30"),r("span",{style:{color:"#24292E"}},", TimeUnit.MINUTES);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//给页面一个令牌")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    confirmVo."),r("span",{style:{color:"#6F42C1"}},"setOrderToken"),r("span",{style:{color:"#24292E"}},"(token);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    CompletableFuture."),r("span",{style:{color:"#6F42C1"}},"allOf"),r("span",{style:{color:"#24292E"}},"(getAddressFuture, cartFuture)."),r("span",{style:{color:"#6F42C1"}},"get"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," confirmVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),hs=r("figure",null,[r("img",{alt:"image-20230403130554589",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403130554589.png"})],-1),ks=r("figure",null,[r("img",{alt:"image-20230416234636426",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230416234636426.png"})],-1),bs={id:"_3-订单创建需要锁定库存-库存有才可创建-否则不能创建",tabindex:"-1"},Cs=r("ul",null,[r("li",null,"查询sku是否有库存"),r("li",null,[r("code",null,"com.klaus.gulimall.ware.controller.WareSkuController#getSkusHasStock")])],-1),Ss=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//查询sku是否有库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"PostMapping"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"/hasstock"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," R "),r("span",{style:{color:"#B392F0"}},"getSkusHasStock"),r("span",{style:{color:"#E1E4E8"}},"(@"),r("span",{style:{color:"#F97583"}},"RequestBody"),r("span",{style:{color:"#E1E4E8"}}," List"),r("span",{style:{color:"#F97583"}},"<"),r("span",{style:{color:"#E1E4E8"}},"Long"),r("span",{style:{color:"#F97583"}},">"),r("span",{style:{color:"#E1E4E8"}}," skuIds) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//sku_id stock")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"SkuHasStockVo"),r("span",{style:{color:"#E1E4E8"}},"> vos "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareSkuService."),r("span",{style:{color:"#B392F0"}},"getSkusHasStock"),r("span",{style:{color:"#E1E4E8"}},"(skuIds);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," R."),r("span",{style:{color:"#B392F0"}},"ok"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"setData"),r("span",{style:{color:"#E1E4E8"}},"(vos);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//查询sku是否有库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"PostMapping"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"/hasstock"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," R "),r("span",{style:{color:"#6F42C1"}},"getSkusHasStock"),r("span",{style:{color:"#24292E"}},"(@"),r("span",{style:{color:"#D73A49"}},"RequestBody"),r("span",{style:{color:"#24292E"}}," List"),r("span",{style:{color:"#D73A49"}},"<"),r("span",{style:{color:"#24292E"}},"Long"),r("span",{style:{color:"#D73A49"}},">"),r("span",{style:{color:"#24292E"}}," skuIds) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//sku_id stock")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"SkuHasStockVo"),r("span",{style:{color:"#24292E"}},"> vos "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareSkuService."),r("span",{style:{color:"#6F42C1"}},"getSkusHasStock"),r("span",{style:{color:"#24292E"}},"(skuIds);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," R."),r("span",{style:{color:"#6F42C1"}},"ok"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"setData"),r("span",{style:{color:"#24292E"}},"(vos);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")])])]),r("button",{class:"collapse"})],-1),Bs=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#getSkusHasStock")])],-1),fs=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," List"),r("span",{style:{color:"#F97583"}},"<"),r("span",{style:{color:"#E1E4E8"}},"SkuHasStockVo"),r("span",{style:{color:"#F97583"}},">"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"getSkusHasStock"),r("span",{style:{color:"#E1E4E8"}},"(List"),r("span",{style:{color:"#F97583"}},"<"),r("span",{style:{color:"#E1E4E8"}},"Long"),r("span",{style:{color:"#F97583"}},">"),r("span",{style:{color:"#E1E4E8"}}," skuIds) {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"SkuHasStockVo"),r("span",{style:{color:"#E1E4E8"}},"> collect "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," skuIds."),r("span",{style:{color:"#B392F0"}},"stream"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"map"),r("span",{style:{color:"#E1E4E8"}},"(skuId "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        SkuHasStockVo vo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"SkuHasStockVo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//查询当前sku的总库存量")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//SELECT SUM(stock-stock_locked) FROM `wms_ware_sku` WHERE sku_id=1")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//获取查询到的库存记录数")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        Long count "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," baseMapper."),r("span",{style:{color:"#B392F0"}},"getSkuStock"),r("span",{style:{color:"#E1E4E8"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        vo."),r("span",{style:{color:"#B392F0"}},"setSkuId"),r("span",{style:{color:"#E1E4E8"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//记录数大于0表示有库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        vo."),r("span",{style:{color:"#B392F0"}},"setHasStock"),r("span",{style:{color:"#E1E4E8"}},"(count "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"?"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},":"),r("span",{style:{color:"#E1E4E8"}}," count "),r("span",{style:{color:"#F97583"}},">"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"0"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," vo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    })."),r("span",{style:{color:"#B392F0"}},"collect"),r("span",{style:{color:"#E1E4E8"}},"(Collectors."),r("span",{style:{color:"#B392F0"}},"toList"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," collect;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," List"),r("span",{style:{color:"#D73A49"}},"<"),r("span",{style:{color:"#24292E"}},"SkuHasStockVo"),r("span",{style:{color:"#D73A49"}},">"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"getSkusHasStock"),r("span",{style:{color:"#24292E"}},"(List"),r("span",{style:{color:"#D73A49"}},"<"),r("span",{style:{color:"#24292E"}},"Long"),r("span",{style:{color:"#D73A49"}},">"),r("span",{style:{color:"#24292E"}}," skuIds) {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"SkuHasStockVo"),r("span",{style:{color:"#24292E"}},"> collect "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," skuIds."),r("span",{style:{color:"#6F42C1"}},"stream"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"map"),r("span",{style:{color:"#24292E"}},"(skuId "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        SkuHasStockVo vo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"SkuHasStockVo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//查询当前sku的总库存量")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//SELECT SUM(stock-stock_locked) FROM `wms_ware_sku` WHERE sku_id=1")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//获取查询到的库存记录数")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        Long count "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," baseMapper."),r("span",{style:{color:"#6F42C1"}},"getSkuStock"),r("span",{style:{color:"#24292E"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        vo."),r("span",{style:{color:"#6F42C1"}},"setSkuId"),r("span",{style:{color:"#24292E"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//记录数大于0表示有库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        vo."),r("span",{style:{color:"#6F42C1"}},"setHasStock"),r("span",{style:{color:"#24292E"}},"(count "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"?"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},":"),r("span",{style:{color:"#24292E"}}," count "),r("span",{style:{color:"#D73A49"}},">"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"0"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," vo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    })."),r("span",{style:{color:"#6F42C1"}},"collect"),r("span",{style:{color:"#24292E"}},"(Collectors."),r("span",{style:{color:"#6F42C1"}},"toList"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," collect;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),vs=r("ul",null,[r("li",null,"SQL")],-1),xs=r("div",{style:{"max-height":"300px"},class:"language-xml"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"xml"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"<"),r("span",{style:{color:"#85E89D"}},"select"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"id"),r("span",{style:{color:"#E1E4E8"}},"="),r("span",{style:{color:"#9ECBFF"}},'"getSkuStock"'),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"resultType"),r("span",{style:{color:"#E1E4E8"}},"="),r("span",{style:{color:"#9ECBFF"}},'"java.lang.Long"'),r("span",{style:{color:"#E1E4E8"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    SELECT SUM(stock-stock_locked) FROM `wms_ware_sku` WHERE sku_id=#{skuId}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"</"),r("span",{style:{color:"#85E89D"}},"select"),r("span",{style:{color:"#E1E4E8"}},">")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"<"),r("span",{style:{color:"#22863A"}},"select"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"id"),r("span",{style:{color:"#24292E"}},"="),r("span",{style:{color:"#032F62"}},'"getSkuStock"'),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"resultType"),r("span",{style:{color:"#24292E"}},"="),r("span",{style:{color:"#032F62"}},'"java.lang.Long"'),r("span",{style:{color:"#24292E"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    SELECT SUM(stock-stock_locked) FROM `wms_ware_sku` WHERE sku_id=#{skuId}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"</"),r("span",{style:{color:"#22863A"}},"select"),r("span",{style:{color:"#24292E"}},">")])])]),r("button",{class:"collapse"})],-1),Is=r("figure",null,[r("img",{alt:"image-20230404010335539",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404010335539.png"})],-1),Os=r("ul",null,[r("li",null,"创建订单进行库存锁定"),r("li",null,[r("code",null,"com.klaus.gulimall.ware.controller.WareSkuController#orderLockStock")])],-1),Ts=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"RequestMapping"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"/lock/order"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," R "),r("span",{style:{color:"#B392F0"}},"orderLockStock"),r("span",{style:{color:"#E1E4E8"}},"(@"),r("span",{style:{color:"#F97583"}},"RequestBody"),r("span",{style:{color:"#E1E4E8"}}," WareSkuLockVo vo){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    Boolean lockStock "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"try"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        lockStock "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareSkuService."),r("span",{style:{color:"#B392F0"}},"orderLockStock"),r("span",{style:{color:"#E1E4E8"}},"(vo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," R."),r("span",{style:{color:"#B392F0"}},"ok"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    } "),r("span",{style:{color:"#F97583"}},"catch"),r("span",{style:{color:"#E1E4E8"}}," (NoStockException "),r("span",{style:{color:"#FFAB70"}},"e"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//通过测试发现商品库存不足将会在页面显示以下错误信息(http://order.gulimall.com/toTrade)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," R."),r("span",{style:{color:"#B392F0"}},"error"),r("span",{style:{color:"#E1E4E8"}},"(BizCodeEnum.NO_STOCK_EXCEPTION."),r("span",{style:{color:"#B392F0"}},"getCode"),r("span",{style:{color:"#E1E4E8"}},"(), BizCodeEnum.NO_STOCK_EXCEPTION."),r("span",{style:{color:"#B392F0"}},"getMsg"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"RequestMapping"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"/lock/order"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," R "),r("span",{style:{color:"#6F42C1"}},"orderLockStock"),r("span",{style:{color:"#24292E"}},"(@"),r("span",{style:{color:"#D73A49"}},"RequestBody"),r("span",{style:{color:"#24292E"}}," WareSkuLockVo vo){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    Boolean lockStock "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"try"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        lockStock "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareSkuService."),r("span",{style:{color:"#6F42C1"}},"orderLockStock"),r("span",{style:{color:"#24292E"}},"(vo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," R."),r("span",{style:{color:"#6F42C1"}},"ok"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    } "),r("span",{style:{color:"#D73A49"}},"catch"),r("span",{style:{color:"#24292E"}}," (NoStockException "),r("span",{style:{color:"#E36209"}},"e"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//通过测试发现商品库存不足将会在页面显示以下错误信息(http://order.gulimall.com/toTrade)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," R."),r("span",{style:{color:"#6F42C1"}},"error"),r("span",{style:{color:"#24292E"}},"(BizCodeEnum.NO_STOCK_EXCEPTION."),r("span",{style:{color:"#6F42C1"}},"getCode"),r("span",{style:{color:"#24292E"}},"(), BizCodeEnum.NO_STOCK_EXCEPTION."),r("span",{style:{color:"#6F42C1"}},"getMsg"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),_s=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#orderLockStock")])],-1),Rs=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 为某个订单锁定库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 加入统一事务")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * (rollbackFor = NoStockException.class )")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 默认只要是运行时异常都会回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 库存解锁的场景")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1）、下订单成功，订单过期没有支付被系统自动取消、被用户手动取消，都要解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 之前锁定的库存就要自动解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"vo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Boolean "),r("span",{style:{color:"#B392F0"}},"orderLockStock"),r("span",{style:{color:"#E1E4E8"}},"(WareSkuLockVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 保存库存工作单的详情的两张表")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 追溯")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    WareOrderTaskEntity taskEntity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"WareOrderTaskEntity"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    taskEntity."),r("span",{style:{color:"#B392F0"}},"setOrderSn"),r("span",{style:{color:"#E1E4E8"}},"(vo."),r("span",{style:{color:"#B392F0"}},"getOrderSn"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    wareOrderTaskService."),r("span",{style:{color:"#B392F0"}},"save"),r("span",{style:{color:"#E1E4E8"}},"(taskEntity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//按照下单的收货地址，找到一个就近仓库，锁定库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//1、找到每个商品在哪个仓库都有库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"OrderItemVo"),r("span",{style:{color:"#E1E4E8"}},"> locks "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," vo."),r("span",{style:{color:"#B392F0"}},"getLocks"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"SkuWareHasStock"),r("span",{style:{color:"#E1E4E8"}},"> collect "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," locks."),r("span",{style:{color:"#B392F0"}},"stream"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"map"),r("span",{style:{color:"#E1E4E8"}},"(item "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        SkuWareHasStock stock "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"SkuWareHasStock"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        Long skuId "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," item."),r("span",{style:{color:"#B392F0"}},"getSkuId"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        stock."),r("span",{style:{color:"#B392F0"}},"setSkuId"),r("span",{style:{color:"#E1E4E8"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        stock."),r("span",{style:{color:"#B392F0"}},"setNum"),r("span",{style:{color:"#E1E4E8"}},"(item."),r("span",{style:{color:"#B392F0"}},"getCount"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//查询这个商品在哪里有库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"Long"),r("span",{style:{color:"#E1E4E8"}},"> wareIds "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareSkuDao."),r("span",{style:{color:"#B392F0"}},"listWareIdHasSkuStock"),r("span",{style:{color:"#E1E4E8"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        stock."),r("span",{style:{color:"#B392F0"}},"setWareIds"),r("span",{style:{color:"#E1E4E8"}},"(wareIds);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," stock;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    })."),r("span",{style:{color:"#B392F0"}},"collect"),r("span",{style:{color:"#E1E4E8"}},"(Collectors."),r("span",{style:{color:"#B392F0"}},"toList"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//2、锁定库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"for"),r("span",{style:{color:"#E1E4E8"}}," (SkuWareHasStock hasStock "),r("span",{style:{color:"#F97583"}},":"),r("span",{style:{color:"#E1E4E8"}}," collect) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        Boolean skuStocked "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},";"),r("span",{style:{color:"#6A737D"}},"//lock_status=0")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        Long skuId "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," hasStock."),r("span",{style:{color:"#B392F0"}},"getSkuId"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"Long"),r("span",{style:{color:"#E1E4E8"}},"> wareIds "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," hasStock."),r("span",{style:{color:"#B392F0"}},"getWareIds"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (wareIds "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"||"),r("span",{style:{color:"#E1E4E8"}}," wareIds."),r("span",{style:{color:"#B392F0"}},"size"),r("span",{style:{color:"#E1E4E8"}},"() "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"0"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//没有任何仓库有这个商品的库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"throw"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"NoStockException"),r("span",{style:{color:"#E1E4E8"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//1、如果每一个商品都锁定成功，将当前商品锁定了几件的工作单记录发给MQ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//2、锁定失败。前面保存的工作单信息就回滚了，即使要解锁记录，由于去数据库查不到id，所以就不用解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//  log:skuId-num-ware: 1:1-2-1(v) 2:2-1-3(v) 3:3-1-1(x)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//  既然锁成功了就应该扣减，之后就应该解锁，因为3记录锁失败，1,2记录就回滚了，相当于工作单回滚了，库存没回滚库存扣减")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"// 只传id工作单是不知道当时库存锁了多少个")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"for"),r("span",{style:{color:"#E1E4E8"}}," (Long wareId "),r("span",{style:{color:"#F97583"}},":"),r("span",{style:{color:"#E1E4E8"}}," wareIds) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//成功就返回1，否则就是0")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            Long count "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareSkuDao."),r("span",{style:{color:"#B392F0"}},"lockSkuStock"),r("span",{style:{color:"#E1E4E8"}},"(skuId, wareId, hasStock."),r("span",{style:{color:"#B392F0"}},"getNum"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (count "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//锁成功了==>lock_status=1")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                skuStocked "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//退出当前循环")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//todo 告诉MQ库存锁定成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                WareOrderTaskDetailEntity detailEntity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},", skuId, "),r("span",{style:{color:"#9ECBFF"}},'""'),r("span",{style:{color:"#E1E4E8"}},", hasStock."),r("span",{style:{color:"#B392F0"}},"getNum"),r("span",{style:{color:"#E1E4E8"}},"(), taskEntity."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"(), wareId, "),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//保存工作单详情")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                wareOrderTaskDetailService."),r("span",{style:{color:"#B392F0"}},"save"),r("span",{style:{color:"#E1E4E8"}},"(detailEntity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                StockLockedTo lockedTo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"StockLockedTo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//属性拷贝到to")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                StockDetailTo stockDetailTo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"StockDetailTo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                BeanUtils."),r("span",{style:{color:"#B392F0"}},"copyProperties"),r("span",{style:{color:"#E1E4E8"}},"(detailEntity, stockDetailTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//只传工作单id还不够，防止回滚以后找不到数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                lockedTo."),r("span",{style:{color:"#B392F0"}},"setId"),r("span",{style:{color:"#E1E4E8"}},"(taskEntity."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                lockedTo."),r("span",{style:{color:"#B392F0"}},"setDetailTo"),r("span",{style:{color:"#E1E4E8"}},"(stockDetailTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//发送锁定库存消息；提交订单后，出现异常，订单回滚，库存不回滚，延时队列有2个任务等待死信时间结束后发送消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                rabbitTemplate."),r("span",{style:{color:"#B392F0"}},"convertAndSend"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"stock-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#9ECBFF"}},'"stock.locked"'),r("span",{style:{color:"#E1E4E8"}},", lockedTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"break"),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            } "),r("span",{style:{color:"#F97583"}},"else"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//当前仓库锁失败了，重试下一个仓库")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (skuStocked "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//当前商品所有仓库都没有锁住")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"throw"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"NoStockException"),r("span",{style:{color:"#E1E4E8"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//3、肯定全部都是锁定成功过的")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 为某个订单锁定库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 加入统一事务")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * (rollbackFor = NoStockException.class )")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 默认只要是运行时异常都会回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 库存解锁的场景")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1）、下订单成功，订单过期没有支付被系统自动取消、被用户手动取消，都要解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 之前锁定的库存就要自动解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"vo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Boolean "),r("span",{style:{color:"#6F42C1"}},"orderLockStock"),r("span",{style:{color:"#24292E"}},"(WareSkuLockVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 保存库存工作单的详情的两张表")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 追溯")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    WareOrderTaskEntity taskEntity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"WareOrderTaskEntity"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    taskEntity."),r("span",{style:{color:"#6F42C1"}},"setOrderSn"),r("span",{style:{color:"#24292E"}},"(vo."),r("span",{style:{color:"#6F42C1"}},"getOrderSn"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    wareOrderTaskService."),r("span",{style:{color:"#6F42C1"}},"save"),r("span",{style:{color:"#24292E"}},"(taskEntity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//按照下单的收货地址，找到一个就近仓库，锁定库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//1、找到每个商品在哪个仓库都有库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"OrderItemVo"),r("span",{style:{color:"#24292E"}},"> locks "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," vo."),r("span",{style:{color:"#6F42C1"}},"getLocks"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"SkuWareHasStock"),r("span",{style:{color:"#24292E"}},"> collect "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," locks."),r("span",{style:{color:"#6F42C1"}},"stream"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"map"),r("span",{style:{color:"#24292E"}},"(item "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        SkuWareHasStock stock "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"SkuWareHasStock"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        Long skuId "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," item."),r("span",{style:{color:"#6F42C1"}},"getSkuId"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        stock."),r("span",{style:{color:"#6F42C1"}},"setSkuId"),r("span",{style:{color:"#24292E"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        stock."),r("span",{style:{color:"#6F42C1"}},"setNum"),r("span",{style:{color:"#24292E"}},"(item."),r("span",{style:{color:"#6F42C1"}},"getCount"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//查询这个商品在哪里有库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"Long"),r("span",{style:{color:"#24292E"}},"> wareIds "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareSkuDao."),r("span",{style:{color:"#6F42C1"}},"listWareIdHasSkuStock"),r("span",{style:{color:"#24292E"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        stock."),r("span",{style:{color:"#6F42C1"}},"setWareIds"),r("span",{style:{color:"#24292E"}},"(wareIds);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," stock;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    })."),r("span",{style:{color:"#6F42C1"}},"collect"),r("span",{style:{color:"#24292E"}},"(Collectors."),r("span",{style:{color:"#6F42C1"}},"toList"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//2、锁定库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"for"),r("span",{style:{color:"#24292E"}}," (SkuWareHasStock hasStock "),r("span",{style:{color:"#D73A49"}},":"),r("span",{style:{color:"#24292E"}}," collect) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        Boolean skuStocked "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},";"),r("span",{style:{color:"#6A737D"}},"//lock_status=0")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        Long skuId "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," hasStock."),r("span",{style:{color:"#6F42C1"}},"getSkuId"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"Long"),r("span",{style:{color:"#24292E"}},"> wareIds "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," hasStock."),r("span",{style:{color:"#6F42C1"}},"getWareIds"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (wareIds "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"||"),r("span",{style:{color:"#24292E"}}," wareIds."),r("span",{style:{color:"#6F42C1"}},"size"),r("span",{style:{color:"#24292E"}},"() "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"0"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//没有任何仓库有这个商品的库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"throw"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"NoStockException"),r("span",{style:{color:"#24292E"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//1、如果每一个商品都锁定成功，将当前商品锁定了几件的工作单记录发给MQ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//2、锁定失败。前面保存的工作单信息就回滚了，即使要解锁记录，由于去数据库查不到id，所以就不用解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//  log:skuId-num-ware: 1:1-2-1(v) 2:2-1-3(v) 3:3-1-1(x)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//  既然锁成功了就应该扣减，之后就应该解锁，因为3记录锁失败，1,2记录就回滚了，相当于工作单回滚了，库存没回滚库存扣减")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"// 只传id工作单是不知道当时库存锁了多少个")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"for"),r("span",{style:{color:"#24292E"}}," (Long wareId "),r("span",{style:{color:"#D73A49"}},":"),r("span",{style:{color:"#24292E"}}," wareIds) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//成功就返回1，否则就是0")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            Long count "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareSkuDao."),r("span",{style:{color:"#6F42C1"}},"lockSkuStock"),r("span",{style:{color:"#24292E"}},"(skuId, wareId, hasStock."),r("span",{style:{color:"#6F42C1"}},"getNum"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (count "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//锁成功了==>lock_status=1")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                skuStocked "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//退出当前循环")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//todo 告诉MQ库存锁定成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                WareOrderTaskDetailEntity detailEntity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},", skuId, "),r("span",{style:{color:"#032F62"}},'""'),r("span",{style:{color:"#24292E"}},", hasStock."),r("span",{style:{color:"#6F42C1"}},"getNum"),r("span",{style:{color:"#24292E"}},"(), taskEntity."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"(), wareId, "),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//保存工作单详情")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                wareOrderTaskDetailService."),r("span",{style:{color:"#6F42C1"}},"save"),r("span",{style:{color:"#24292E"}},"(detailEntity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                StockLockedTo lockedTo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"StockLockedTo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//属性拷贝到to")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                StockDetailTo stockDetailTo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"StockDetailTo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                BeanUtils."),r("span",{style:{color:"#6F42C1"}},"copyProperties"),r("span",{style:{color:"#24292E"}},"(detailEntity, stockDetailTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//只传工作单id还不够，防止回滚以后找不到数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                lockedTo."),r("span",{style:{color:"#6F42C1"}},"setId"),r("span",{style:{color:"#24292E"}},"(taskEntity."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                lockedTo."),r("span",{style:{color:"#6F42C1"}},"setDetailTo"),r("span",{style:{color:"#24292E"}},"(stockDetailTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//发送锁定库存消息；提交订单后，出现异常，订单回滚，库存不回滚，延时队列有2个任务等待死信时间结束后发送消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                rabbitTemplate."),r("span",{style:{color:"#6F42C1"}},"convertAndSend"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"stock-event-exchange"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#032F62"}},'"stock.locked"'),r("span",{style:{color:"#24292E"}},", lockedTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"break"),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            } "),r("span",{style:{color:"#D73A49"}},"else"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//当前仓库锁失败了，重试下一个仓库")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (skuStocked "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//当前商品所有仓库都没有锁住")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"throw"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"NoStockException"),r("span",{style:{color:"#24292E"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//3、肯定全部都是锁定成功过的")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Ls=r("ul",null,[r("li",null,[c("库存工作单表"),r("code",null,"wms_ware_order_task")])],-1),ws=r("figure",null,[r("img",{alt:"image-20230404012221654",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404012221654.png"})],-1),qs=r("ul",null,[r("li",null,[c("库存工作单详情"),r("code",null,"wms_ware_order_task_detail")]),r("li",null,[r("img",{alt:"image-20230404012535232",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404012535232.png"})])],-1),Ps=r("figure",null,[r("img",{alt:"image-20230404012359140",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404012359140.png"})],-1),Vs=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//查询这个商品在哪里有库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//com.klaus.gulimall.ware.dao.WareSkuDao#listWareIdHasSkuStock")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"List<"),r("span",{style:{color:"#F97583"}},"Long"),r("span",{style:{color:"#E1E4E8"}},"> wareIds "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareSkuDao."),r("span",{style:{color:"#B392F0"}},"listWareIdHasSkuStock"),r("span",{style:{color:"#E1E4E8"}},"(skuId);")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//查询这个商品在哪里有库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//com.klaus.gulimall.ware.dao.WareSkuDao#listWareIdHasSkuStock")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"List<"),r("span",{style:{color:"#D73A49"}},"Long"),r("span",{style:{color:"#24292E"}},"> wareIds "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareSkuDao."),r("span",{style:{color:"#6F42C1"}},"listWareIdHasSkuStock"),r("span",{style:{color:"#24292E"}},"(skuId);")])])]),r("button",{class:"collapse"})],-1),Ms=r("ul",null,[r("li",null,"SQL")],-1),js=r("div",{style:{"max-height":"300px"},class:"language-xml"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"xml"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"<"),r("span",{style:{color:"#85E89D"}},"select"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"id"),r("span",{style:{color:"#E1E4E8"}},"="),r("span",{style:{color:"#9ECBFF"}},'"listWareIdHasSkuStock"'),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"resultType"),r("span",{style:{color:"#E1E4E8"}},"="),r("span",{style:{color:"#9ECBFF"}},'"java.lang.Long"'),r("span",{style:{color:"#E1E4E8"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    SELECT ware_id FROM `wms_ware_sku` WHERE sku_id=#{skuId} AND stock-stock_locked >0")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"</"),r("span",{style:{color:"#85E89D"}},"select"),r("span",{style:{color:"#E1E4E8"}},">")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"<"),r("span",{style:{color:"#22863A"}},"select"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"id"),r("span",{style:{color:"#24292E"}},"="),r("span",{style:{color:"#032F62"}},'"listWareIdHasSkuStock"'),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"resultType"),r("span",{style:{color:"#24292E"}},"="),r("span",{style:{color:"#032F62"}},'"java.lang.Long"'),r("span",{style:{color:"#24292E"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    SELECT ware_id FROM `wms_ware_sku` WHERE sku_id=#{skuId} AND stock-stock_locked >0")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"</"),r("span",{style:{color:"#22863A"}},"select"),r("span",{style:{color:"#24292E"}},">")])])]),r("button",{class:"collapse"})],-1),Ns=r("figure",null,[r("img",{alt:"image-20230404013003956",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404013003956.png"})],-1),Ws=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//库存锁定成功就返回1，否则就是0")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//com.klaus.gulimall.ware.dao.WareSkuDao#lockSkuStock")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"Long count "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareSkuDao."),r("span",{style:{color:"#B392F0"}},"lockSkuStock"),r("span",{style:{color:"#E1E4E8"}},"(skuId, wareId, hasStock."),r("span",{style:{color:"#B392F0"}},"getNum"),r("span",{style:{color:"#E1E4E8"}},"());")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//库存锁定成功就返回1，否则就是0")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//com.klaus.gulimall.ware.dao.WareSkuDao#lockSkuStock")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"Long count "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareSkuDao."),r("span",{style:{color:"#6F42C1"}},"lockSkuStock"),r("span",{style:{color:"#24292E"}},"(skuId, wareId, hasStock."),r("span",{style:{color:"#6F42C1"}},"getNum"),r("span",{style:{color:"#24292E"}},"());")])])]),r("button",{class:"collapse"})],-1),Ks=r("ul",null,[r("li",null,"SQL")],-1),zs=r("div",{style:{"max-height":"300px"},class:"language-xml"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"xml"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"<"),r("span",{style:{color:"#85E89D"}},"update"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"id"),r("span",{style:{color:"#E1E4E8"}},"="),r("span",{style:{color:"#9ECBFF"}},'"lockSkuStock"'),r("span",{style:{color:"#E1E4E8"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    UPDATE `wms_ware_sku` SET stock_locked = stock_locked + #{num}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    WHERE sku_id =#{skuId} AND ware_id=#{wareId} AND stock-stock_locked>=#{num}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"</"),r("span",{style:{color:"#85E89D"}},"update"),r("span",{style:{color:"#E1E4E8"}},">")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"<"),r("span",{style:{color:"#22863A"}},"update"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"id"),r("span",{style:{color:"#24292E"}},"="),r("span",{style:{color:"#032F62"}},'"lockSkuStock"'),r("span",{style:{color:"#24292E"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    UPDATE `wms_ware_sku` SET stock_locked = stock_locked + #{num}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    WHERE sku_id =#{skuId} AND ware_id=#{wareId} AND stock-stock_locked>=#{num}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"</"),r("span",{style:{color:"#22863A"}},"update"),r("span",{style:{color:"#24292E"}},">")])])]),r("button",{class:"collapse"})],-1),Hs=r("figure",null,[r("img",{alt:"image-20230404014111150",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404014111150.png"})],-1),Qs={id:"_4-订单创建后超时未支付需要解锁库存",tabindex:"-1"},Us=r("ul",null,[r("li",null,[r("p",null,"库存解锁分两种情况，一种是订单正常支付超时库存自动解锁；一种是订单服务异常/宕机库存自动解锁")]),r("li",null,[r("p",null,[r("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.StockLockedTo)")])])],-1),Gs=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1、库存自动解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚。之前锁定的库存就要自动解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2、下订单失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 锁库存失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 只要解锁库存的消息失败，一定要告诉服务器解锁失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"to")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"message")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"unlockStock"),r("span",{style:{color:"#E1E4E8"}},"(StockLockedTo to) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    StockDetailTo detail "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," to."),r("span",{style:{color:"#B392F0"}},"getDetailTo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    Long detailId "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," detail."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//1、查询数据库关于这个订单的锁定库存信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"// 有： 证明库存锁定成功了")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//     解锁：订单情况")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//          1、没有这个订单，必须解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//          2、有这个订单，就不是解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//                  订单状态： 已取消：解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//                           没取消：不能接受")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"// 没有：库存锁定失败了，库存回滚了。这种情况无需解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    WareOrderTaskDetailEntity taskDetailEntity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareOrderTaskDetailService."),r("span",{style:{color:"#B392F0"}},"getById"),r("span",{style:{color:"#E1E4E8"}},"(detailId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (taskDetailEntity "),r("span",{style:{color:"#F97583"}},"!="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//有工作详情单，但只能证明库存服务在锁库存的时候锁成功后返回出去的，")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"// 要看整个订单有没有下单成功，如果订单远程调用的其他服务崩了导致订单回滚，这跟库存服务没有关系，直接解锁是有问题的，因为订单都没有")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        Long id "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," to."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"();"),r("span",{style:{color:"#6A737D"}},"//库存工作单的id")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//获取订单状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        WareOrderTaskEntity taskEntity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareOrderTaskService."),r("span",{style:{color:"#B392F0"}},"getById"),r("span",{style:{color:"#E1E4E8"}},"(id);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        String orderSn "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," taskEntity."),r("span",{style:{color:"#B392F0"}},"getOrderSn"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//根据订单号查询订单的状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        R r "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderFeignService."),r("span",{style:{color:"#B392F0"}},"getOrderStatus"),r("span",{style:{color:"#E1E4E8"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (r."),r("span",{style:{color:"#B392F0"}},"getCode"),r("span",{style:{color:"#E1E4E8"}},"() "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"0"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//远程调用成功，订单数据返回成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            OrderVo data "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," r."),r("span",{style:{color:"#B392F0"}},"getData"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," TypeReference<"),r("span",{style:{color:"#F97583"}},"OrderVo"),r("span",{style:{color:"#E1E4E8"}},">() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            });")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (data "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"||"),r("span",{style:{color:"#E1E4E8"}}," data."),r("span",{style:{color:"#B392F0"}},"getStatus"),r("span",{style:{color:"#E1E4E8"}},"() "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"4"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//订单已经被取消或订单不存在，才能解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//问题：订单服务由于网络等原因迟迟没有将订单解锁(data.getStatus()==0)导致库存永远释放不了锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (taskDetailEntity."),r("span",{style:{color:"#B392F0"}},"getLockStatus"),r("span",{style:{color:"#E1E4E8"}},"() "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#E1E4E8"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#6A737D"}},"//当前库存工作单详情，状态为1 已锁定但是未解锁才可以解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#B392F0"}},"unLockStock"),r("span",{style:{color:"#E1E4E8"}},"(detail."),r("span",{style:{color:"#B392F0"}},"getSkuId"),r("span",{style:{color:"#E1E4E8"}},"(), detail."),r("span",{style:{color:"#B392F0"}},"getWareId"),r("span",{style:{color:"#E1E4E8"}},"(), detail."),r("span",{style:{color:"#B392F0"}},"getSkuNum"),r("span",{style:{color:"#E1E4E8"}},"(), detailId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        } "),r("span",{style:{color:"#F97583"}},"else"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//远程调用失败直接抛异常")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"throw"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"RuntimeException"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"远程服务失败"'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    } "),r("span",{style:{color:"#F97583"}},"else"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//无需解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1、库存自动解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚。之前锁定的库存就要自动解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2、下订单失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 锁库存失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 只要解锁库存的消息失败，一定要告诉服务器解锁失败")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"to")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"message")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"unlockStock"),r("span",{style:{color:"#24292E"}},"(StockLockedTo to) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    StockDetailTo detail "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," to."),r("span",{style:{color:"#6F42C1"}},"getDetailTo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    Long detailId "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," detail."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//1、查询数据库关于这个订单的锁定库存信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"// 有： 证明库存锁定成功了")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//     解锁：订单情况")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//          1、没有这个订单，必须解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//          2、有这个订单，就不是解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//                  订单状态： 已取消：解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//                           没取消：不能接受")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"// 没有：库存锁定失败了，库存回滚了。这种情况无需解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    WareOrderTaskDetailEntity taskDetailEntity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareOrderTaskDetailService."),r("span",{style:{color:"#6F42C1"}},"getById"),r("span",{style:{color:"#24292E"}},"(detailId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (taskDetailEntity "),r("span",{style:{color:"#D73A49"}},"!="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//有工作详情单，但只能证明库存服务在锁库存的时候锁成功后返回出去的，")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"// 要看整个订单有没有下单成功，如果订单远程调用的其他服务崩了导致订单回滚，这跟库存服务没有关系，直接解锁是有问题的，因为订单都没有")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        Long id "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," to."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"();"),r("span",{style:{color:"#6A737D"}},"//库存工作单的id")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//获取订单状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        WareOrderTaskEntity taskEntity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareOrderTaskService."),r("span",{style:{color:"#6F42C1"}},"getById"),r("span",{style:{color:"#24292E"}},"(id);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        String orderSn "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," taskEntity."),r("span",{style:{color:"#6F42C1"}},"getOrderSn"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//根据订单号查询订单的状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        R r "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderFeignService."),r("span",{style:{color:"#6F42C1"}},"getOrderStatus"),r("span",{style:{color:"#24292E"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (r."),r("span",{style:{color:"#6F42C1"}},"getCode"),r("span",{style:{color:"#24292E"}},"() "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"0"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//远程调用成功，订单数据返回成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            OrderVo data "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," r."),r("span",{style:{color:"#6F42C1"}},"getData"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," TypeReference<"),r("span",{style:{color:"#D73A49"}},"OrderVo"),r("span",{style:{color:"#24292E"}},">() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            });")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (data "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"||"),r("span",{style:{color:"#24292E"}}," data."),r("span",{style:{color:"#6F42C1"}},"getStatus"),r("span",{style:{color:"#24292E"}},"() "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"4"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//订单已经被取消或订单不存在，才能解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//问题：订单服务由于网络等原因迟迟没有将订单解锁(data.getStatus()==0)导致库存永远释放不了锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (taskDetailEntity."),r("span",{style:{color:"#6F42C1"}},"getLockStatus"),r("span",{style:{color:"#24292E"}},"() "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#24292E"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#6A737D"}},"//当前库存工作单详情，状态为1 已锁定但是未解锁才可以解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#6F42C1"}},"unLockStock"),r("span",{style:{color:"#24292E"}},"(detail."),r("span",{style:{color:"#6F42C1"}},"getSkuId"),r("span",{style:{color:"#24292E"}},"(), detail."),r("span",{style:{color:"#6F42C1"}},"getWareId"),r("span",{style:{color:"#24292E"}},"(), detail."),r("span",{style:{color:"#6F42C1"}},"getSkuNum"),r("span",{style:{color:"#24292E"}},"(), detailId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        } "),r("span",{style:{color:"#D73A49"}},"else"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//远程调用失败直接抛异常")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"throw"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"RuntimeException"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"远程服务失败"'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    } "),r("span",{style:{color:"#D73A49"}},"else"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//无需解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Xs=r("ul",null,[r("li",null,[r("p",null,"远程调用订单服务获取订单状态")]),r("li",null,[r("p",null,[r("code",null,"com.klaus.gulimall.order.controller.OrderController#getOrderStatus")])])],-1),Js=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"GetMapping"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"/status/{orderSn}"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," R "),r("span",{style:{color:"#B392F0"}},"getOrderStatus"),r("span",{style:{color:"#E1E4E8"}},"(@"),r("span",{style:{color:"#F97583"}},"PathVariable"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"orderSn"'),r("span",{style:{color:"#E1E4E8"}},") String orderSn){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    OrderEntity orderEntity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderService."),r("span",{style:{color:"#B392F0"}},"getOrderByOrderSn"),r("span",{style:{color:"#E1E4E8"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," R."),r("span",{style:{color:"#B392F0"}},"ok"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"setData"),r("span",{style:{color:"#E1E4E8"}},"(orderEntity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"GetMapping"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"/status/{orderSn}"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," R "),r("span",{style:{color:"#6F42C1"}},"getOrderStatus"),r("span",{style:{color:"#24292E"}},"(@"),r("span",{style:{color:"#D73A49"}},"PathVariable"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"orderSn"'),r("span",{style:{color:"#24292E"}},") String orderSn){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    OrderEntity orderEntity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderService."),r("span",{style:{color:"#6F42C1"}},"getOrderByOrderSn"),r("span",{style:{color:"#24292E"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," R."),r("span",{style:{color:"#6F42C1"}},"ok"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"setData"),r("span",{style:{color:"#24292E"}},"(orderEntity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),$s=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," OrderEntity "),r("span",{style:{color:"#B392F0"}},"getOrderByOrderSn"),r("span",{style:{color:"#E1E4E8"}},"(String orderSn) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    OrderEntity orderEntity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"this"),r("span",{style:{color:"#E1E4E8"}},"."),r("span",{style:{color:"#B392F0"}},"getOne"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," QueryWrapper<"),r("span",{style:{color:"#F97583"}},"OrderEntity"),r("span",{style:{color:"#E1E4E8"}},">()."),r("span",{style:{color:"#B392F0"}},"eq"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order_sn"'),r("span",{style:{color:"#E1E4E8"}},", orderSn));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," orderEntity;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," OrderEntity "),r("span",{style:{color:"#6F42C1"}},"getOrderByOrderSn"),r("span",{style:{color:"#24292E"}},"(String orderSn) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    OrderEntity orderEntity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"this"),r("span",{style:{color:"#24292E"}},"."),r("span",{style:{color:"#6F42C1"}},"getOne"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," QueryWrapper<"),r("span",{style:{color:"#D73A49"}},"OrderEntity"),r("span",{style:{color:"#24292E"}},">()."),r("span",{style:{color:"#6F42C1"}},"eq"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order_sn"'),r("span",{style:{color:"#24292E"}},", orderSn));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," orderEntity;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Ys=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.OrderTo)")])],-1),Zs=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"* 防止订单服务卡顿，导致更改订单状态的操作无法完成以及更改的mq消息没有得到执行，解锁库存的消息优先到期，扫描订单状态是新建状态，就会什么都不做")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 导致卡顿的订单永远不能解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"orderTo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 加入统一事务")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"unlockStock"),r("span",{style:{color:"#E1E4E8"}},"(OrderTo orderTo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    String orderSn "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderTo."),r("span",{style:{color:"#B392F0"}},"getOrderSn"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//查一下最新库存的状态，防止重复解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    WareOrderTaskEntity task "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareOrderTaskService."),r("span",{style:{color:"#B392F0"}},"getOrderTaskByOrderSn"),r("span",{style:{color:"#E1E4E8"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    Long id "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," task."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//按照工作单找到所有 没有解锁的库存，进行解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#E1E4E8"}},"> detailEntities "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareOrderTaskDetailService."),r("span",{style:{color:"#B392F0"}},"list"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," QueryWrapper<"),r("span",{style:{color:"#F97583"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#E1E4E8"}},">().")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#B392F0"}},"eq"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"task_id"'),r("span",{style:{color:"#E1E4E8"}},", id).")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//新建的还没被解锁的库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#B392F0"}},"eq"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"lock_status"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#E1E4E8"}},"));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"for"),r("span",{style:{color:"#E1E4E8"}}," (WareOrderTaskDetailEntity entity "),r("span",{style:{color:"#F97583"}},":"),r("span",{style:{color:"#E1E4E8"}}," detailEntities) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//此解锁方式可以解决高并发问题和整个系统的异构(两个服务开发语言不同。如java，php)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#B392F0"}},"unLockStock"),r("span",{style:{color:"#E1E4E8"}},"(entity."),r("span",{style:{color:"#B392F0"}},"getSkuId"),r("span",{style:{color:"#E1E4E8"}},"(), entity."),r("span",{style:{color:"#B392F0"}},"getWareId"),r("span",{style:{color:"#E1E4E8"}},"(), entity."),r("span",{style:{color:"#B392F0"}},"getSkuNum"),r("span",{style:{color:"#E1E4E8"}},"(), entity."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"* 防止订单服务卡顿，导致更改订单状态的操作无法完成以及更改的mq消息没有得到执行，解锁库存的消息优先到期，扫描订单状态是新建状态，就会什么都不做")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 导致卡顿的订单永远不能解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"orderTo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 加入统一事务")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"unlockStock"),r("span",{style:{color:"#24292E"}},"(OrderTo orderTo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    String orderSn "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderTo."),r("span",{style:{color:"#6F42C1"}},"getOrderSn"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//查一下最新库存的状态，防止重复解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    WareOrderTaskEntity task "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareOrderTaskService."),r("span",{style:{color:"#6F42C1"}},"getOrderTaskByOrderSn"),r("span",{style:{color:"#24292E"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    Long id "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," task."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//按照工作单找到所有 没有解锁的库存，进行解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#24292E"}},"> detailEntities "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareOrderTaskDetailService."),r("span",{style:{color:"#6F42C1"}},"list"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," QueryWrapper<"),r("span",{style:{color:"#D73A49"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#24292E"}},">().")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6F42C1"}},"eq"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"task_id"'),r("span",{style:{color:"#24292E"}},", id).")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//新建的还没被解锁的库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6F42C1"}},"eq"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"lock_status"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#24292E"}},"));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"for"),r("span",{style:{color:"#24292E"}}," (WareOrderTaskDetailEntity entity "),r("span",{style:{color:"#D73A49"}},":"),r("span",{style:{color:"#24292E"}}," detailEntities) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//此解锁方式可以解决高并发问题和整个系统的异构(两个服务开发语言不同。如java，php)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6F42C1"}},"unLockStock"),r("span",{style:{color:"#24292E"}},"(entity."),r("span",{style:{color:"#6F42C1"}},"getSkuId"),r("span",{style:{color:"#24292E"}},"(), entity."),r("span",{style:{color:"#6F42C1"}},"getWareId"),r("span",{style:{color:"#24292E"}},"(), entity."),r("span",{style:{color:"#6F42C1"}},"getSkuNum"),r("span",{style:{color:"#24292E"}},"(), entity."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),lo=r("ul",null,[r("li",null,[c("库存解锁方法"),r("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unLockStock")])],-1),so=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"private"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"unLockStock"),r("span",{style:{color:"#E1E4E8"}},"(Long skuId, Long wareId, Integer num, Long taskDetailId) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//库存解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    wareSkuDao."),r("span",{style:{color:"#B392F0"}},"unLockStock"),r("span",{style:{color:"#E1E4E8"}},"(skuId, wareId, num);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//更新库存工作单的状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    WareOrderTaskDetailEntity entity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    entity."),r("span",{style:{color:"#B392F0"}},"setId"),r("span",{style:{color:"#E1E4E8"}},"(taskDetailId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    entity."),r("span",{style:{color:"#B392F0"}},"setLockStatus"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"2"),r("span",{style:{color:"#E1E4E8"}},");"),r("span",{style:{color:"#6A737D"}},"//变为已解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    wareOrderTaskDetailService."),r("span",{style:{color:"#B392F0"}},"updateById"),r("span",{style:{color:"#E1E4E8"}},"(entity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"private"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"unLockStock"),r("span",{style:{color:"#24292E"}},"(Long skuId, Long wareId, Integer num, Long taskDetailId) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//库存解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    wareSkuDao."),r("span",{style:{color:"#6F42C1"}},"unLockStock"),r("span",{style:{color:"#24292E"}},"(skuId, wareId, num);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//更新库存工作单的状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    WareOrderTaskDetailEntity entity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    entity."),r("span",{style:{color:"#6F42C1"}},"setId"),r("span",{style:{color:"#24292E"}},"(taskDetailId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    entity."),r("span",{style:{color:"#6F42C1"}},"setLockStatus"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"2"),r("span",{style:{color:"#24292E"}},");"),r("span",{style:{color:"#6A737D"}},"//变为已解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    wareOrderTaskDetailService."),r("span",{style:{color:"#6F42C1"}},"updateById"),r("span",{style:{color:"#24292E"}},"(entity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),oo=r("ul",null,[r("li",null,"SQL")],-1),no=r("div",{style:{"max-height":"300px"},class:"language-xml"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"xml"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"<"),r("span",{style:{color:"#85E89D"}},"update"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"id"),r("span",{style:{color:"#E1E4E8"}},"="),r("span",{style:{color:"#9ECBFF"}},'"unLockStock"'),r("span",{style:{color:"#E1E4E8"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    UPDATE `wms_ware_sku` SET stock_locked=stock_locked-#{num}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    WHERE sku_id=#{skuId} AND ware_id=#{wareId}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"</"),r("span",{style:{color:"#85E89D"}},"update"),r("span",{style:{color:"#E1E4E8"}},">")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"<"),r("span",{style:{color:"#22863A"}},"update"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"id"),r("span",{style:{color:"#24292E"}},"="),r("span",{style:{color:"#032F62"}},'"unLockStock"'),r("span",{style:{color:"#24292E"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    UPDATE `wms_ware_sku` SET stock_locked=stock_locked-#{num}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    WHERE sku_id=#{skuId} AND ware_id=#{wareId}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"</"),r("span",{style:{color:"#22863A"}},"update"),r("span",{style:{color:"#24292E"}},">")])])]),r("button",{class:"collapse"})],-1),eo=r("figure",null,[r("img",{alt:"image-20230404015601068",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404015601068.png"})],-1),ao={id:"_5-支付成功后-需要进行拆单-根据商品打包方式-所在仓库-物流等进行拆单-待开发",tabindex:"-1"},to={id:"_6-支付的每笔流水都需要记录-以待查账",tabindex:"-1"},ro=r("figure",null,[r("img",{alt:"image-20230403161913669",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230403161913669.png"})],-1),co=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#handlePayResult")])],-1),po=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 处理支付宝的支付结果")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"vo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," String "),r("span",{style:{color:"#B392F0"}},"handlePayResult"),r("span",{style:{color:"#E1E4E8"}},"(PayAsyncVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//1、保存交易流水")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    PaymentInfoEntity infoEntity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"PaymentInfoEntity"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    infoEntity."),r("span",{style:{color:"#B392F0"}},"setAlipayTradeNo"),r("span",{style:{color:"#E1E4E8"}},"(vo."),r("span",{style:{color:"#B392F0"}},"getTrade_no"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    infoEntity."),r("span",{style:{color:"#B392F0"}},"setOrderSn"),r("span",{style:{color:"#E1E4E8"}},"(vo."),r("span",{style:{color:"#B392F0"}},"getOut_trade_no"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    infoEntity."),r("span",{style:{color:"#B392F0"}},"setPaymentStatus"),r("span",{style:{color:"#E1E4E8"}},"(vo."),r("span",{style:{color:"#B392F0"}},"getTrade_status"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    infoEntity."),r("span",{style:{color:"#B392F0"}},"setCallbackTime"),r("span",{style:{color:"#E1E4E8"}},"(vo."),r("span",{style:{color:"#B392F0"}},"getNotify_time"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    paymentInfoService."),r("span",{style:{color:"#B392F0"}},"save"),r("span",{style:{color:"#E1E4E8"}},"(infoEntity);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//2、修改订单的状态信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (vo."),r("span",{style:{color:"#B392F0"}},"getTrade_status"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"equals"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"TRADE_SUCCESS"'),r("span",{style:{color:"#E1E4E8"}},") "),r("span",{style:{color:"#F97583"}},"||"),r("span",{style:{color:"#E1E4E8"}}," vo."),r("span",{style:{color:"#B392F0"}},"getTrade_status"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"equals"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"TRADE_FINISHED"'),r("span",{style:{color:"#E1E4E8"}},")){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//支付成功状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        String outTradeNo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," vo."),r("span",{style:{color:"#B392F0"}},"getOut_trade_no"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#79B8FF"}},"this"),r("span",{style:{color:"#E1E4E8"}},".baseMapper."),r("span",{style:{color:"#B392F0"}},"updateOrderStatus"),r("span",{style:{color:"#E1E4E8"}},"(outTradeNo, OrderStatusEnum.PAYED."),r("span",{style:{color:"#B392F0"}},"getCode"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"success"'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 处理支付宝的支付结果")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"vo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," String "),r("span",{style:{color:"#6F42C1"}},"handlePayResult"),r("span",{style:{color:"#24292E"}},"(PayAsyncVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//1、保存交易流水")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    PaymentInfoEntity infoEntity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"PaymentInfoEntity"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    infoEntity."),r("span",{style:{color:"#6F42C1"}},"setAlipayTradeNo"),r("span",{style:{color:"#24292E"}},"(vo."),r("span",{style:{color:"#6F42C1"}},"getTrade_no"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    infoEntity."),r("span",{style:{color:"#6F42C1"}},"setOrderSn"),r("span",{style:{color:"#24292E"}},"(vo."),r("span",{style:{color:"#6F42C1"}},"getOut_trade_no"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    infoEntity."),r("span",{style:{color:"#6F42C1"}},"setPaymentStatus"),r("span",{style:{color:"#24292E"}},"(vo."),r("span",{style:{color:"#6F42C1"}},"getTrade_status"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    infoEntity."),r("span",{style:{color:"#6F42C1"}},"setCallbackTime"),r("span",{style:{color:"#24292E"}},"(vo."),r("span",{style:{color:"#6F42C1"}},"getNotify_time"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    paymentInfoService."),r("span",{style:{color:"#6F42C1"}},"save"),r("span",{style:{color:"#24292E"}},"(infoEntity);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//2、修改订单的状态信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (vo."),r("span",{style:{color:"#6F42C1"}},"getTrade_status"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"equals"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"TRADE_SUCCESS"'),r("span",{style:{color:"#24292E"}},") "),r("span",{style:{color:"#D73A49"}},"||"),r("span",{style:{color:"#24292E"}}," vo."),r("span",{style:{color:"#6F42C1"}},"getTrade_status"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"equals"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"TRADE_FINISHED"'),r("span",{style:{color:"#24292E"}},")){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//支付成功状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        String outTradeNo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," vo."),r("span",{style:{color:"#6F42C1"}},"getOut_trade_no"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#005CC5"}},"this"),r("span",{style:{color:"#24292E"}},".baseMapper."),r("span",{style:{color:"#6F42C1"}},"updateOrderStatus"),r("span",{style:{color:"#24292E"}},"(outTradeNo, OrderStatusEnum.PAYED."),r("span",{style:{color:"#6F42C1"}},"getCode"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"success"'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),yo={id:"_7-订单创建-支付成功-待开发-等状态都需要给-mq-发送消息-方便其他系统感知订阅",tabindex:"-1"},Eo=r("ul",null,[r("li",null,"添加依赖")],-1),io=r("div",{style:{"max-height":"300px"},class:"language-xml"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"xml"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"<"),r("span",{style:{color:"#85E89D"}},"dependency"),r("span",{style:{color:"#E1E4E8"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    <"),r("span",{style:{color:"#85E89D"}},"groupId"),r("span",{style:{color:"#E1E4E8"}},">org.springframework.boot</"),r("span",{style:{color:"#85E89D"}},"groupId"),r("span",{style:{color:"#E1E4E8"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    <"),r("span",{style:{color:"#85E89D"}},"artifactId"),r("span",{style:{color:"#E1E4E8"}},">spring-boot-starter-amqp</"),r("span",{style:{color:"#85E89D"}},"artifactId"),r("span",{style:{color:"#E1E4E8"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"</"),r("span",{style:{color:"#85E89D"}},"dependency"),r("span",{style:{color:"#E1E4E8"}},">")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"<"),r("span",{style:{color:"#22863A"}},"dependency"),r("span",{style:{color:"#24292E"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    <"),r("span",{style:{color:"#22863A"}},"groupId"),r("span",{style:{color:"#24292E"}},">org.springframework.boot</"),r("span",{style:{color:"#22863A"}},"groupId"),r("span",{style:{color:"#24292E"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    <"),r("span",{style:{color:"#22863A"}},"artifactId"),r("span",{style:{color:"#24292E"}},">spring-boot-starter-amqp</"),r("span",{style:{color:"#22863A"}},"artifactId"),r("span",{style:{color:"#24292E"}},">")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"</"),r("span",{style:{color:"#22863A"}},"dependency"),r("span",{style:{color:"#24292E"}},">")])])]),r("button",{class:"collapse"})],-1),uo=r("ul",null,[r("li",null,[r("strong",null,"订单创建"),c("：(MQ)")]),r("li",null,"订单创建采用延迟队列"),r("li",null,[r("code",null,"com.klaus.gulimall.order.config.MyMQConfig")])],-1),go=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Queue "),r("span",{style:{color:"#B392F0"}},"orderDelayQueue"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    Map<"),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#F97583"}},"Object"),r("span",{style:{color:"#E1E4E8"}},"> arguments "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," HashMap<>();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * x-dead-letter-exchange: order-event-exchange")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * x-dead-letter-routing-key: order.release.order")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * x-message-ttl: 60000")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    arguments."),r("span",{style:{color:"#B392F0"}},"put"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"x-dead-letter-exchange"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#9ECBFF"}},'"order-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    arguments."),r("span",{style:{color:"#B392F0"}},"put"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"x-dead-letter-routing-key"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#9ECBFF"}},'"order.release.order"'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    arguments."),r("span",{style:{color:"#B392F0"}},"put"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"x-message-ttl"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"60000"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//String name, boolean durable, boolean exclusive, boolean autoDelete, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    Queue queue "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"Queue"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order.delay.queue"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},", arguments);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," queue;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Exchange "),r("span",{style:{color:"#B392F0"}},"orderEventExchange"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//String name, boolean durable, boolean autoDelete, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"TopicExchange"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Binding "),r("span",{style:{color:"#B392F0"}},"orderCreateOrderBinding"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"   "),r("span",{style:{color:"#6A737D"}},"//String destination, Binding.DestinationType destinationType, String exchange, String routingKey, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"   "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"Binding"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order.delay.queue"'),r("span",{style:{color:"#E1E4E8"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                Binding.DestinationType.QUEUE,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#9ECBFF"}},'"order-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#9ECBFF"}},'"order.create.order"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Queue "),r("span",{style:{color:"#6F42C1"}},"orderDelayQueue"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    Map<"),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#D73A49"}},"Object"),r("span",{style:{color:"#24292E"}},"> arguments "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," HashMap<>();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * x-dead-letter-exchange: order-event-exchange")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * x-dead-letter-routing-key: order.release.order")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * x-message-ttl: 60000")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    arguments."),r("span",{style:{color:"#6F42C1"}},"put"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"x-dead-letter-exchange"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#032F62"}},'"order-event-exchange"'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    arguments."),r("span",{style:{color:"#6F42C1"}},"put"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"x-dead-letter-routing-key"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#032F62"}},'"order.release.order"'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    arguments."),r("span",{style:{color:"#6F42C1"}},"put"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"x-message-ttl"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"60000"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//String name, boolean durable, boolean exclusive, boolean autoDelete, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    Queue queue "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"Queue"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order.delay.queue"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},", arguments);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," queue;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Exchange "),r("span",{style:{color:"#6F42C1"}},"orderEventExchange"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//String name, boolean durable, boolean autoDelete, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"TopicExchange"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order-event-exchange"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Binding "),r("span",{style:{color:"#6F42C1"}},"orderCreateOrderBinding"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"   "),r("span",{style:{color:"#6A737D"}},"//String destination, Binding.DestinationType destinationType, String exchange, String routingKey, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"   "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"Binding"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order.delay.queue"'),r("span",{style:{color:"#24292E"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                Binding.DestinationType.QUEUE,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#032F62"}},'"order-event-exchange"'),r("span",{style:{color:"#24292E"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#032F62"}},'"order.create.order"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Fo=r("blockquote",null,[r("ul",null,[r("li",null,[c("创建订单 进入路由键-order.create.order- 进入交换机order-event-exchange， 根据路由键会转发到延时队列order.delay.queue 30min(60s)过期时间，过期时间到了之后，根据"),r("strong",null,"死信"),c("路由键-order.release.order-到达释放订单队列order.release.order.queue，监听这个队列的方法判断订单是不是已支付。")])])],-1),Ao=r("figure",null,[r("img",{alt:"image-20230404121815115",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404121815115.png"})],-1),mo=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#submitOrder")])],-1),Do=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," SubmitOrderResponseVo "),r("span",{style:{color:"#B392F0"}},"submitOrder"),r("span",{style:{color:"#E1E4E8"}},"(OrderSubmitVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    ...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//todo 订单创建成功发送消息给MQ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    rabbitTemplate."),r("span",{style:{color:"#B392F0"}},"convertAndSend"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#9ECBFF"}},'"order.create.order"'),r("span",{style:{color:"#E1E4E8"}},", order."),r("span",{style:{color:"#B392F0"}},"getOrder"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"\t...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," SubmitOrderResponseVo "),r("span",{style:{color:"#6F42C1"}},"submitOrder"),r("span",{style:{color:"#24292E"}},"(OrderSubmitVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    ...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//todo 订单创建成功发送消息给MQ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    rabbitTemplate."),r("span",{style:{color:"#6F42C1"}},"convertAndSend"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order-event-exchange"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#032F62"}},'"order.create.order"'),r("span",{style:{color:"#24292E"}},", order."),r("span",{style:{color:"#6F42C1"}},"getOrder"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"\t...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),ho=r("p",null,[r("strong",null,"库存锁定"),c("：(MQ)")],-1),ko=r("ul",null,[r("li",null,[r("p",null,"库存锁定采用延迟队列")]),r("li",null,[r("p",null,[r("code",null,"com.klaus.gulimall.ware.config.MyRabbitConfig")])])],-1),bo=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Exchange "),r("span",{style:{color:"#B392F0"}},"stockEventExchange"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"TopicExchange"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"stock-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Queue "),r("span",{style:{color:"#B392F0"}},"stockDelayQueue"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    Map<"),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#F97583"}},"Object"),r("span",{style:{color:"#E1E4E8"}},"> arguments "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," HashMap<>();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    arguments."),r("span",{style:{color:"#B392F0"}},"put"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"x-dead-letter-exchange"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#9ECBFF"}},'"stock-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    arguments."),r("span",{style:{color:"#B392F0"}},"put"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"x-dead-letter-routing-key"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#9ECBFF"}},'"stock.release"'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    arguments."),r("span",{style:{color:"#B392F0"}},"put"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"x-message-ttl"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"120000"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//String name, boolean durable, boolean exclusive, boolean autoDelete, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"Queue"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"stock.delay.queue"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},", arguments);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Binding "),r("span",{style:{color:"#B392F0"}},"stockLockedBinding"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//String destination, Binding.DestinationType destinationType, String exchange, String routingKey, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"Binding"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"stock.delay.queue"'),r("span",{style:{color:"#E1E4E8"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            Binding.DestinationType.QUEUE,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#9ECBFF"}},'"stock-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#9ECBFF"}},'"stock.locked"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Exchange "),r("span",{style:{color:"#6F42C1"}},"stockEventExchange"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"TopicExchange"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"stock-event-exchange"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Queue "),r("span",{style:{color:"#6F42C1"}},"stockDelayQueue"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    Map<"),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#D73A49"}},"Object"),r("span",{style:{color:"#24292E"}},"> arguments "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," HashMap<>();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    arguments."),r("span",{style:{color:"#6F42C1"}},"put"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"x-dead-letter-exchange"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#032F62"}},'"stock-event-exchange"'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    arguments."),r("span",{style:{color:"#6F42C1"}},"put"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"x-dead-letter-routing-key"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#032F62"}},'"stock.release"'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    arguments."),r("span",{style:{color:"#6F42C1"}},"put"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"x-message-ttl"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"120000"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//String name, boolean durable, boolean exclusive, boolean autoDelete, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"Queue"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"stock.delay.queue"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},", arguments);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Binding "),r("span",{style:{color:"#6F42C1"}},"stockLockedBinding"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//String destination, Binding.DestinationType destinationType, String exchange, String routingKey, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"Binding"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"stock.delay.queue"'),r("span",{style:{color:"#24292E"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            Binding.DestinationType.QUEUE,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#032F62"}},'"stock-event-exchange"'),r("span",{style:{color:"#24292E"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#032F62"}},'"stock.locked"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Co=r("blockquote",null,[r("ul",null,[r("li",null,[c("库存锁定成功 进入路由键-stock.locked- 进入交换机stock-event-exchange， 根据路由键会转发到延时队列stock.delay.queue 50min(120s)过期时间，延迟时间到，根据"),r("strong",null,"死信"),c("路由键-stock.release-到达释放订单队列stock.release.stock.queue，检查订单状态，确认是否需要解锁。")])])],-1),So=r("figure",null,[r("img",{alt:"image-20230404122316210",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404122316210.png"})],-1),Bo=r("ul",null,[r("li",null,[r("p",null,"订单创建成功后库存锁定也成功就发送消息给MQ")]),r("li",null,[r("p",null,[r("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#orderLockStock")])])],-1),fo=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Boolean "),r("span",{style:{color:"#B392F0"}},"orderLockStock"),r("span",{style:{color:"#E1E4E8"}},"(WareSkuLockVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    ...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#6A737D"}},"//发送锁定库存消息；提交订单后，出现异常，订单回滚，库存不回滚，延时队列有2个任务等待死信时间结束后发送消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  rabbitTemplate."),r("span",{style:{color:"#B392F0"}},"convertAndSend"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"stock-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#9ECBFF"}},'"stock.locked"'),r("span",{style:{color:"#E1E4E8"}},", lockedTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  ...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Boolean "),r("span",{style:{color:"#6F42C1"}},"orderLockStock"),r("span",{style:{color:"#24292E"}},"(WareSkuLockVo vo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    ...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6A737D"}},"//发送锁定库存消息；提交订单后，出现异常，订单回滚，库存不回滚，延时队列有2个任务等待死信时间结束后发送消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  rabbitTemplate."),r("span",{style:{color:"#6F42C1"}},"convertAndSend"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"stock-event-exchange"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#032F62"}},'"stock.locked"'),r("span",{style:{color:"#24292E"}},", lockedTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  ...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),vo=r("p",null,[r("strong",null,"防止超卖"),c("：数据库 unsigned int 做最后的保证。 (范围0~65535)")],-1),xo=r("ul",null,[r("li",null,"在mysql数据库中，unsigned表面含义是 '无符号'的意思，unsigned既为非负数，用此类型可以增加数据长度。")],-1),Io=r("p",null,[r("strong",null,"自动关单"),c("：订单超时未支付，需要取消订单 (MQ)")],-1),Oo=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.config.MyMQConfig")])],-1),To=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"\t@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Queue "),r("span",{style:{color:"#B392F0"}},"orderReleaseOrderQueue"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        Queue queue "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"Queue"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order.release.order.queue"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," queue;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}}," \t@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Exchange "),r("span",{style:{color:"#B392F0"}},"orderEventExchange"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//String name, boolean durable, boolean autoDelete, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"TopicExchange"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"\t@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Binding "),r("span",{style:{color:"#B392F0"}},"orderReleaseOrderBinding"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"Binding"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order.release.order.queue"'),r("span",{style:{color:"#E1E4E8"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                Binding.DestinationType.QUEUE,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#9ECBFF"}},'"order-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#9ECBFF"}},'"order.release.order"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"\t@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Queue "),r("span",{style:{color:"#6F42C1"}},"orderReleaseOrderQueue"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        Queue queue "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"Queue"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order.release.order.queue"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," queue;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}}," \t@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Exchange "),r("span",{style:{color:"#6F42C1"}},"orderEventExchange"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//String name, boolean durable, boolean autoDelete, Map<String, Object> arguments")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"TopicExchange"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order-event-exchange"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"\t@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Binding "),r("span",{style:{color:"#6F42C1"}},"orderReleaseOrderBinding"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"Binding"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order.release.order.queue"'),r("span",{style:{color:"#24292E"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                Binding.DestinationType.QUEUE,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#032F62"}},'"order-event-exchange"'),r("span",{style:{color:"#24292E"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#032F62"}},'"order.release.order"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")])])]),r("button",{class:"collapse"})],-1),_o=r("blockquote",null,[r("ul",null,[r("li",null,[c("订单创建延迟时间到了之后，根据路由键-order.release.order-到达释放订单队列order.release.order.queue， 监听这个队列的方法 先是判断订单是不是已支付，如果不是就关闭订单，"),r("code",null,"关闭订单之后，根据路由键order.release.other 发送关闭的订单数据消息到交换机order-event-exchange，交换机再转发到order.release.coupon.queue优惠券队列，返回优惠券，与之通过 也是根据路由键order.release.other(待开发)")])])],-1),Ro=r("figure",null,[r("img",{alt:"image-20230404124500812",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404124500812.png"})],-1),Lo=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.listener.OrderCloseListener")]),r("li",null,[c("添加配置文件"),r("code",null,"application.properties"),c("中的RabbitMQ配置项")])],-1),wo=r("div",{style:{"max-height":"300px"},class:"language-properties"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"properties"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"spring.rabbitmq.host"),r("span",{style:{color:"#E1E4E8"}},"=192.168.10.103")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"spring.rabbitmq.port"),r("span",{style:{color:"#E1E4E8"}},"=5672")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"spring.rabbitmq.virtual-host"),r("span",{style:{color:"#E1E4E8"}},"=/")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"# 开启发送端确认")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"spring.rabbitmq.publisher-confirms"),r("span",{style:{color:"#E1E4E8"}},"=true")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"# 开启发送端消息抵达队列的确认")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"spring.rabbitmq.publisher-returns"),r("span",{style:{color:"#E1E4E8"}},"=true")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"# 只要抵达队列，以异步发送优先回调我们这个returnConfirm")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"spring.rabbitmq.template.mandatory"),r("span",{style:{color:"#E1E4E8"}},"=true")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"# 手动ack消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"spring.rabbitmq.listener.simple.acknowledge-mode"),r("span",{style:{color:"#E1E4E8"}},"=MANUAL")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"spring.rabbitmq.host"),r("span",{style:{color:"#24292E"}},"=192.168.10.103")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"spring.rabbitmq.port"),r("span",{style:{color:"#24292E"}},"=5672")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"spring.rabbitmq.virtual-host"),r("span",{style:{color:"#24292E"}},"=/")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"# 开启发送端确认")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"spring.rabbitmq.publisher-confirms"),r("span",{style:{color:"#24292E"}},"=true")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"# 开启发送端消息抵达队列的确认")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"spring.rabbitmq.publisher-returns"),r("span",{style:{color:"#24292E"}},"=true")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"# 只要抵达队列，以异步发送优先回调我们这个returnConfirm")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"spring.rabbitmq.template.mandatory"),r("span",{style:{color:"#24292E"}},"=true")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"# 手动ack消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"spring.rabbitmq.listener.simple.acknowledge-mode"),r("span",{style:{color:"#24292E"}},"=MANUAL")])])]),r("button",{class:"collapse"})],-1),qo=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 订单释放(关单)监听器")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Service")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"RabbitListener"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"queues"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"order.release.order.queue"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"class"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"OrderCloseListener"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"Autowired")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    OrderService orderService;")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"RabbitHandler")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"listener"),r("span",{style:{color:"#E1E4E8"}},"(OrderEntity "),r("span",{style:{color:"#FFAB70"}},"entity"),r("span",{style:{color:"#E1E4E8"}},", Channel "),r("span",{style:{color:"#FFAB70"}},"channel"),r("span",{style:{color:"#E1E4E8"}},", Message "),r("span",{style:{color:"#FFAB70"}},"message"),r("span",{style:{color:"#E1E4E8"}},") "),r("span",{style:{color:"#F97583"}},"throws"),r("span",{style:{color:"#E1E4E8"}}," IOException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//等待死信时间到后收到订单消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"收到过期的订单信息，准备关闭订单"'),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}},"entity."),r("span",{style:{color:"#B392F0"}},"getOrderSn"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"try"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            orderService."),r("span",{style:{color:"#B392F0"}},"closeOrder"),r("span",{style:{color:"#E1E4E8"}},"(entity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//手动调用支付宝收单")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//签收订单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            channel."),r("span",{style:{color:"#B392F0"}},"basicAck"),r("span",{style:{color:"#E1E4E8"}},"(message."),r("span",{style:{color:"#B392F0"}},"getMessageProperties"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getDeliveryTag"),r("span",{style:{color:"#E1E4E8"}},"(), "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        } "),r("span",{style:{color:"#F97583"}},"catch"),r("span",{style:{color:"#E1E4E8"}}," (Exception "),r("span",{style:{color:"#FFAB70"}},"e"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            channel."),r("span",{style:{color:"#B392F0"}},"basicReject"),r("span",{style:{color:"#E1E4E8"}},"(message."),r("span",{style:{color:"#B392F0"}},"getMessageProperties"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getDeliveryTag"),r("span",{style:{color:"#E1E4E8"}},"(), "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 订单释放(关单)监听器")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Service")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"RabbitListener"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"queues"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"order.release.order.queue"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"class"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"OrderCloseListener"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"Autowired")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    OrderService orderService;")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"RabbitHandler")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"listener"),r("span",{style:{color:"#24292E"}},"(OrderEntity "),r("span",{style:{color:"#E36209"}},"entity"),r("span",{style:{color:"#24292E"}},", Channel "),r("span",{style:{color:"#E36209"}},"channel"),r("span",{style:{color:"#24292E"}},", Message "),r("span",{style:{color:"#E36209"}},"message"),r("span",{style:{color:"#24292E"}},") "),r("span",{style:{color:"#D73A49"}},"throws"),r("span",{style:{color:"#24292E"}}," IOException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//等待死信时间到后收到订单消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"收到过期的订单信息，准备关闭订单"'),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}},"entity."),r("span",{style:{color:"#6F42C1"}},"getOrderSn"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"try"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            orderService."),r("span",{style:{color:"#6F42C1"}},"closeOrder"),r("span",{style:{color:"#24292E"}},"(entity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//手动调用支付宝收单")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//签收订单")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            channel."),r("span",{style:{color:"#6F42C1"}},"basicAck"),r("span",{style:{color:"#24292E"}},"(message."),r("span",{style:{color:"#6F42C1"}},"getMessageProperties"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getDeliveryTag"),r("span",{style:{color:"#24292E"}},"(), "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        } "),r("span",{style:{color:"#D73A49"}},"catch"),r("span",{style:{color:"#24292E"}}," (Exception "),r("span",{style:{color:"#E36209"}},"e"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            channel."),r("span",{style:{color:"#6F42C1"}},"basicReject"),r("span",{style:{color:"#24292E"}},"(message."),r("span",{style:{color:"#6F42C1"}},"getMessageProperties"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getDeliveryTag"),r("span",{style:{color:"#24292E"}},"(), "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Po=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#closeOrder")])],-1),Vo=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   * 关单方法，将订单新建(待付款)状态设置为已取消状态并发送消息给MQ确认关单完成")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"entity")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"*/")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"closeOrder"),r("span",{style:{color:"#E1E4E8"}},"(OrderEntity entity) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//查询当前这个订单的最新状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//将要发送的消息队列实体(释放订单服务前)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    OrderEntity orderEntity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"this"),r("span",{style:{color:"#E1E4E8"}},"."),r("span",{style:{color:"#B392F0"}},"getById"),r("span",{style:{color:"#E1E4E8"}},"(entity."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//status=0")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (orderEntity."),r("span",{style:{color:"#B392F0"}},"getStatus"),r("span",{style:{color:"#E1E4E8"}},"() "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," OrderStatusEnum.CREATE_NEW."),r("span",{style:{color:"#B392F0"}},"getCode"),r("span",{style:{color:"#E1E4E8"}},"()){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//在待付款状态下才关单(消息队列的实体有可能过期了，所以创建新实体)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        OrderEntity update "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"OrderEntity"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        update."),r("span",{style:{color:"#B392F0"}},"setId"),r("span",{style:{color:"#E1E4E8"}},"(entity."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"// status=4")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        update."),r("span",{style:{color:"#B392F0"}},"setStatus"),r("span",{style:{color:"#E1E4E8"}},"(OrderStatusEnum.CANCLED."),r("span",{style:{color:"#B392F0"}},"getCode"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#79B8FF"}},"this"),r("span",{style:{color:"#E1E4E8"}},"."),r("span",{style:{color:"#B392F0"}},"updateById"),r("span",{style:{color:"#E1E4E8"}},"(update);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        OrderTo orderTo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"OrderTo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        BeanUtils."),r("span",{style:{color:"#B392F0"}},"copyProperties"),r("span",{style:{color:"#E1E4E8"}},"(orderEntity, orderTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"try"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//todo 保证消息一定会发送出去，每一个消息都可以做好日志记录（给数据库保存每一个消息的详细信息）")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//todo 定期扫描数据库将失败的消息再发送一遍；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//只要解锁成功了就【立即】发消息给MQ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            rabbitTemplate."),r("span",{style:{color:"#B392F0"}},"convertAndSend"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"order-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#9ECBFF"}},'"order.release.other"'),r("span",{style:{color:"#E1E4E8"}},", orderTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        } "),r("span",{style:{color:"#F97583"}},"catch"),r("span",{style:{color:"#E1E4E8"}}," (Exception "),r("span",{style:{color:"#FFAB70"}},"e"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//todo 将没发送成功的消息进行重试发送 （while）")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   * 关单方法，将订单新建(待付款)状态设置为已取消状态并发送消息给MQ确认关单完成")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"entity")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"*/")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"closeOrder"),r("span",{style:{color:"#24292E"}},"(OrderEntity entity) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//查询当前这个订单的最新状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//将要发送的消息队列实体(释放订单服务前)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    OrderEntity orderEntity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"this"),r("span",{style:{color:"#24292E"}},"."),r("span",{style:{color:"#6F42C1"}},"getById"),r("span",{style:{color:"#24292E"}},"(entity."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//status=0")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (orderEntity."),r("span",{style:{color:"#6F42C1"}},"getStatus"),r("span",{style:{color:"#24292E"}},"() "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," OrderStatusEnum.CREATE_NEW."),r("span",{style:{color:"#6F42C1"}},"getCode"),r("span",{style:{color:"#24292E"}},"()){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//在待付款状态下才关单(消息队列的实体有可能过期了，所以创建新实体)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        OrderEntity update "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"OrderEntity"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        update."),r("span",{style:{color:"#6F42C1"}},"setId"),r("span",{style:{color:"#24292E"}},"(entity."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"// status=4")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        update."),r("span",{style:{color:"#6F42C1"}},"setStatus"),r("span",{style:{color:"#24292E"}},"(OrderStatusEnum.CANCLED."),r("span",{style:{color:"#6F42C1"}},"getCode"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#005CC5"}},"this"),r("span",{style:{color:"#24292E"}},"."),r("span",{style:{color:"#6F42C1"}},"updateById"),r("span",{style:{color:"#24292E"}},"(update);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        OrderTo orderTo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"OrderTo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        BeanUtils."),r("span",{style:{color:"#6F42C1"}},"copyProperties"),r("span",{style:{color:"#24292E"}},"(orderEntity, orderTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"try"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//todo 保证消息一定会发送出去，每一个消息都可以做好日志记录（给数据库保存每一个消息的详细信息）")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//todo 定期扫描数据库将失败的消息再发送一遍；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//只要解锁成功了就【立即】发消息给MQ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            rabbitTemplate."),r("span",{style:{color:"#6F42C1"}},"convertAndSend"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"order-event-exchange"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#032F62"}},'"order.release.other"'),r("span",{style:{color:"#24292E"}},", orderTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        } "),r("span",{style:{color:"#D73A49"}},"catch"),r("span",{style:{color:"#24292E"}}," (Exception "),r("span",{style:{color:"#E36209"}},"e"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//todo 将没发送成功的消息进行重试发送 （while）")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Mo=r("p",null,[r("strong",null,"解锁库存"),c("： (MQ)")],-1),jo=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.ware.config.MyRabbitConfig")])],-1),No=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Exchange "),r("span",{style:{color:"#B392F0"}},"stockEventExchange"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"TopicExchange"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"stock-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Queue "),r("span",{style:{color:"#B392F0"}},"stockReleaseStockQueue"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"Queue"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"stock.release.stock.queue"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," Binding "),r("span",{style:{color:"#B392F0"}},"stockReleaseBinding"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"Binding"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"stock.release.stock.queue"'),r("span",{style:{color:"#E1E4E8"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                Binding.DestinationType.QUEUE,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#9ECBFF"}},'"stock-event-exchange"'),r("span",{style:{color:"#E1E4E8"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#9ECBFF"}},'"stock.release.#"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Exchange "),r("span",{style:{color:"#6F42C1"}},"stockEventExchange"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"TopicExchange"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"stock-event-exchange"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Queue "),r("span",{style:{color:"#6F42C1"}},"stockReleaseStockQueue"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"Queue"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"stock.release.stock.queue"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," Binding "),r("span",{style:{color:"#6F42C1"}},"stockReleaseBinding"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"Binding"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"stock.release.stock.queue"'),r("span",{style:{color:"#24292E"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                Binding.DestinationType.QUEUE,")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#032F62"}},'"stock-event-exchange"'),r("span",{style:{color:"#24292E"}},",")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#032F62"}},'"stock.release.#"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Wo=r("blockquote",null,[r("ul",null,[r("li",null,[r("code",null,"关闭订单之后，根据路由键order.release.other 发送关闭的订单数据到交换机order-event-exchange，交换机再转发到order.release.coupon.queue优惠券队列，返回优惠券，与之通过 也是根据路由键order.release.other，和数据一起转发到解锁库存队列stock.release.stock.queue 解锁库存(待开发)。")])])],-1),Ko=r("figure",null,[r("img",{alt:"image-20230404134206092",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404134206092.png"})],-1),zo=r("ul",null,[r("li",null,[r("p",null,"订单关闭，需要解锁已经占用的库存")]),r("li",null,[r("p",null,[r("code",null,"com.klaus.gulimall.ware.listener.StockReleaseListener")])])],-1),Ho=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 监听库存解锁队列")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"RabbitListener"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"queues"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"stock.release.stock.queue"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Service")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"class"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"StockReleaseListener"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"Autowired")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    WareSkuService wareSkuService;")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"\t/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 订单正常关闭(订单服务正常运行)，需要解锁已经占用的库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"to"),r("span",{style:{color:"#6A737D"}}," 库存工作单(含工作单详情)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"RabbitHandler")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"handleStockLockedRelease"),r("span",{style:{color:"#E1E4E8"}},"(StockLockedTo "),r("span",{style:{color:"#FFAB70"}},"to"),r("span",{style:{color:"#E1E4E8"}},", Message "),r("span",{style:{color:"#FFAB70"}},"message"),r("span",{style:{color:"#E1E4E8"}},", Channel "),r("span",{style:{color:"#FFAB70"}},"channel"),r("span",{style:{color:"#E1E4E8"}},") "),r("span",{style:{color:"#F97583"}},"throws"),r("span",{style:{color:"#E1E4E8"}}," IOException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"收到解锁库存的消息..."'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"try"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//当前消息是否被第二次及以后(重新)派发过来了")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//            Boolean redelivered = message.getMessageProperties().getRedelivered();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            wareSkuService."),r("span",{style:{color:"#B392F0"}},"unlockStock"),r("span",{style:{color:"#E1E4E8"}},"(to);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//只要解锁成功了，就签收消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            channel."),r("span",{style:{color:"#B392F0"}},"basicAck"),r("span",{style:{color:"#E1E4E8"}},"(message."),r("span",{style:{color:"#B392F0"}},"getMessageProperties"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getDeliveryTag"),r("span",{style:{color:"#E1E4E8"}},"(), "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        } "),r("span",{style:{color:"#F97583"}},"catch"),r("span",{style:{color:"#E1E4E8"}}," (Exception "),r("span",{style:{color:"#FFAB70"}},"e"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//有任何异常直接拒绝签收;消息拒绝以后重新放到队列里面，让别人继续消费解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            channel."),r("span",{style:{color:"#B392F0"}},"basicReject"),r("span",{style:{color:"#E1E4E8"}},"(message."),r("span",{style:{color:"#B392F0"}},"getMessageProperties"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getDeliveryTag"),r("span",{style:{color:"#E1E4E8"}},"(), "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 监听库存解锁队列")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"RabbitListener"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"queues"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"stock.release.stock.queue"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Service")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"class"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"StockReleaseListener"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"Autowired")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    WareSkuService wareSkuService;")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"\t/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 订单正常关闭(订单服务正常运行)，需要解锁已经占用的库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"to"),r("span",{style:{color:"#6A737D"}}," 库存工作单(含工作单详情)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"RabbitHandler")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"handleStockLockedRelease"),r("span",{style:{color:"#24292E"}},"(StockLockedTo "),r("span",{style:{color:"#E36209"}},"to"),r("span",{style:{color:"#24292E"}},", Message "),r("span",{style:{color:"#E36209"}},"message"),r("span",{style:{color:"#24292E"}},", Channel "),r("span",{style:{color:"#E36209"}},"channel"),r("span",{style:{color:"#24292E"}},") "),r("span",{style:{color:"#D73A49"}},"throws"),r("span",{style:{color:"#24292E"}}," IOException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"收到解锁库存的消息..."'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"try"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//当前消息是否被第二次及以后(重新)派发过来了")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//            Boolean redelivered = message.getMessageProperties().getRedelivered();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            wareSkuService."),r("span",{style:{color:"#6F42C1"}},"unlockStock"),r("span",{style:{color:"#24292E"}},"(to);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//只要解锁成功了，就签收消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            channel."),r("span",{style:{color:"#6F42C1"}},"basicAck"),r("span",{style:{color:"#24292E"}},"(message."),r("span",{style:{color:"#6F42C1"}},"getMessageProperties"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getDeliveryTag"),r("span",{style:{color:"#24292E"}},"(), "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        } "),r("span",{style:{color:"#D73A49"}},"catch"),r("span",{style:{color:"#24292E"}}," (Exception "),r("span",{style:{color:"#E36209"}},"e"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//有任何异常直接拒绝签收;消息拒绝以后重新放到队列里面，让别人继续消费解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            channel."),r("span",{style:{color:"#6F42C1"}},"basicReject"),r("span",{style:{color:"#24292E"}},"(message."),r("span",{style:{color:"#6F42C1"}},"getMessageProperties"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getDeliveryTag"),r("span",{style:{color:"#24292E"}},"(), "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Qo=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.StockLockedTo)")])],-1),Uo=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"unlockStock"),r("span",{style:{color:"#E1E4E8"}},"(StockLockedTo to) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    ...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//问题：订单服务由于网络等原因迟迟没有将订单解锁(data.getStatus()==0)导致库存永远释放不了锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (taskDetailEntity."),r("span",{style:{color:"#B392F0"}},"getLockStatus"),r("span",{style:{color:"#E1E4E8"}},"() "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#E1E4E8"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//当前库存工作单详情，状态为1 已锁定但是未解锁才可以解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#B392F0"}},"unLockStock"),r("span",{style:{color:"#E1E4E8"}},"(detail."),r("span",{style:{color:"#B392F0"}},"getSkuId"),r("span",{style:{color:"#E1E4E8"}},"(), detail."),r("span",{style:{color:"#B392F0"}},"getWareId"),r("span",{style:{color:"#E1E4E8"}},"(), detail."),r("span",{style:{color:"#B392F0"}},"getSkuNum"),r("span",{style:{color:"#E1E4E8"}},"(), detailId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"\t...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"unlockStock"),r("span",{style:{color:"#24292E"}},"(StockLockedTo to) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    ...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//问题：订单服务由于网络等原因迟迟没有将订单解锁(data.getStatus()==0)导致库存永远释放不了锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (taskDetailEntity."),r("span",{style:{color:"#6F42C1"}},"getLockStatus"),r("span",{style:{color:"#24292E"}},"() "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#24292E"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//当前库存工作单详情，状态为1 已锁定但是未解锁才可以解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6F42C1"}},"unLockStock"),r("span",{style:{color:"#24292E"}},"(detail."),r("span",{style:{color:"#6F42C1"}},"getSkuId"),r("span",{style:{color:"#24292E"}},"(), detail."),r("span",{style:{color:"#6F42C1"}},"getWareId"),r("span",{style:{color:"#24292E"}},"(), detail."),r("span",{style:{color:"#6F42C1"}},"getSkuNum"),r("span",{style:{color:"#24292E"}},"(), detailId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"\t...")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Go=r("ul",null,[r("li",null,"库存锁定成功，订单回滚，保证最终一致性，也需要库存自动解锁；库存锁定成功，订单服务全部炸了，订单都没有创建好，就必须有自动解锁功能"),r("li",null,[r("code",null,"com.klaus.gulimall.ware.listener.StockReleaseListener")])],-1),Xo=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 监听库存解锁队列")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"RabbitListener"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"queues"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"stock.release.stock.queue"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Service")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"class"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"StockReleaseListener"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"Autowired")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    WareSkuService wareSkuService;")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 订单异常关闭(订单服务发送运行时异常或宕机)，需要解锁已经占用的库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 如果库存锁定成功，订单服务全部炸了，订单都没有创建好，就必须有自动解锁功能")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"orderTo"),r("span",{style:{color:"#6A737D"}}," 完整订单信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"message")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"channel")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#F97583"}},"@throws"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#B392F0"}},"IOException")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"RabbitHandler")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"handleOrderCloseRelease"),r("span",{style:{color:"#E1E4E8"}},"(OrderTo "),r("span",{style:{color:"#FFAB70"}},"orderTo"),r("span",{style:{color:"#E1E4E8"}},", Message "),r("span",{style:{color:"#FFAB70"}},"message"),r("span",{style:{color:"#E1E4E8"}},", Channel "),r("span",{style:{color:"#FFAB70"}},"channel"),r("span",{style:{color:"#E1E4E8"}},") "),r("span",{style:{color:"#F97583"}},"throws"),r("span",{style:{color:"#E1E4E8"}}," IOException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"订单关闭准备解锁库存...."'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"try"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            wareSkuService."),r("span",{style:{color:"#B392F0"}},"unlockStock"),r("span",{style:{color:"#E1E4E8"}},"(orderTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//只要解锁成功了，就签收消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            channel."),r("span",{style:{color:"#B392F0"}},"basicAck"),r("span",{style:{color:"#E1E4E8"}},"(message."),r("span",{style:{color:"#B392F0"}},"getMessageProperties"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getDeliveryTag"),r("span",{style:{color:"#E1E4E8"}},"(), "),r("span",{style:{color:"#79B8FF"}},"false"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        } "),r("span",{style:{color:"#F97583"}},"catch"),r("span",{style:{color:"#E1E4E8"}}," (Exception "),r("span",{style:{color:"#FFAB70"}},"e"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//有任何异常直接拒绝签收;消息拒绝以后重新放到队列里面，让别人继续消费解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            channel."),r("span",{style:{color:"#B392F0"}},"basicReject"),r("span",{style:{color:"#E1E4E8"}},"(message."),r("span",{style:{color:"#B392F0"}},"getMessageProperties"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getDeliveryTag"),r("span",{style:{color:"#E1E4E8"}},"(), "),r("span",{style:{color:"#79B8FF"}},"true"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 监听库存解锁队列")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"RabbitListener"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"queues"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"stock.release.stock.queue"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Service")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"class"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"StockReleaseListener"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"Autowired")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    WareSkuService wareSkuService;")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 订单异常关闭(订单服务发送运行时异常或宕机)，需要解锁已经占用的库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * 如果库存锁定成功，订单服务全部炸了，订单都没有创建好，就必须有自动解锁功能")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"orderTo"),r("span",{style:{color:"#6A737D"}}," 完整订单信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"message")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"channel")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     * "),r("span",{style:{color:"#D73A49"}},"@throws"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#6F42C1"}},"IOException")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"RabbitHandler")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"handleOrderCloseRelease"),r("span",{style:{color:"#24292E"}},"(OrderTo "),r("span",{style:{color:"#E36209"}},"orderTo"),r("span",{style:{color:"#24292E"}},", Message "),r("span",{style:{color:"#E36209"}},"message"),r("span",{style:{color:"#24292E"}},", Channel "),r("span",{style:{color:"#E36209"}},"channel"),r("span",{style:{color:"#24292E"}},") "),r("span",{style:{color:"#D73A49"}},"throws"),r("span",{style:{color:"#24292E"}}," IOException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"订单关闭准备解锁库存...."'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"try"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            wareSkuService."),r("span",{style:{color:"#6F42C1"}},"unlockStock"),r("span",{style:{color:"#24292E"}},"(orderTo);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//只要解锁成功了，就签收消息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            channel."),r("span",{style:{color:"#6F42C1"}},"basicAck"),r("span",{style:{color:"#24292E"}},"(message."),r("span",{style:{color:"#6F42C1"}},"getMessageProperties"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getDeliveryTag"),r("span",{style:{color:"#24292E"}},"(), "),r("span",{style:{color:"#005CC5"}},"false"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        } "),r("span",{style:{color:"#D73A49"}},"catch"),r("span",{style:{color:"#24292E"}}," (Exception "),r("span",{style:{color:"#E36209"}},"e"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//有任何异常直接拒绝签收;消息拒绝以后重新放到队列里面，让别人继续消费解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            channel."),r("span",{style:{color:"#6F42C1"}},"basicReject"),r("span",{style:{color:"#24292E"}},"(message."),r("span",{style:{color:"#6F42C1"}},"getMessageProperties"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getDeliveryTag"),r("span",{style:{color:"#24292E"}},"(), "),r("span",{style:{color:"#005CC5"}},"true"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Jo=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.ware.service.impl.WareSkuServiceImpl#unlockStock(com.klaus.common.to.mq.OrderTo)+#unLockStock")])],-1),$o=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 防止订单服务卡顿，导致更改订单状态的操作无法完成以及更改的mq消息没有得到执行，解锁库存的消息优先到期，扫描订单状态是新建状态，就会什么都不做")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 导致卡顿的订单永远不能解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"orderTo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 加入统一事务")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"unlockStock"),r("span",{style:{color:"#E1E4E8"}},"(OrderTo orderTo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    String orderSn "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," orderTo."),r("span",{style:{color:"#B392F0"}},"getOrderSn"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//查一下最新库存的状态，防止重复解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    WareOrderTaskEntity task "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareOrderTaskService."),r("span",{style:{color:"#B392F0"}},"getOrderTaskByOrderSn"),r("span",{style:{color:"#E1E4E8"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    Long id "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," task."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//按照工作单找到所有 没有解锁的库存，进行解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#E1E4E8"}},"> detailEntities "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wareOrderTaskDetailService."),r("span",{style:{color:"#B392F0"}},"list"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," QueryWrapper<"),r("span",{style:{color:"#F97583"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#E1E4E8"}},">().")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#B392F0"}},"eq"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"task_id"'),r("span",{style:{color:"#E1E4E8"}},", id).")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//新建的还没被解锁的库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#B392F0"}},"eq"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"lock_status"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#E1E4E8"}},"));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"for"),r("span",{style:{color:"#E1E4E8"}}," (WareOrderTaskDetailEntity entity "),r("span",{style:{color:"#F97583"}},":"),r("span",{style:{color:"#E1E4E8"}}," detailEntities) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//此解锁方式可以解决高并发问题和整个系统的异构(两个服务开发语言不同。如java，php)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#B392F0"}},"unLockStock"),r("span",{style:{color:"#E1E4E8"}},"(entity."),r("span",{style:{color:"#B392F0"}},"getSkuId"),r("span",{style:{color:"#E1E4E8"}},"(), entity."),r("span",{style:{color:"#B392F0"}},"getWareId"),r("span",{style:{color:"#E1E4E8"}},"(), entity."),r("span",{style:{color:"#B392F0"}},"getSkuNum"),r("span",{style:{color:"#E1E4E8"}},"(), entity."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"private"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"unLockStock"),r("span",{style:{color:"#E1E4E8"}},"(Long skuId, Long wareId, Integer num, Long taskDetailId) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//库存解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    wareSkuDao."),r("span",{style:{color:"#B392F0"}},"unLockStock"),r("span",{style:{color:"#E1E4E8"}},"(skuId, wareId, num);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//更新库存工作单的状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    WareOrderTaskDetailEntity entity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    entity."),r("span",{style:{color:"#B392F0"}},"setId"),r("span",{style:{color:"#E1E4E8"}},"(taskDetailId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    entity."),r("span",{style:{color:"#B392F0"}},"setLockStatus"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"2"),r("span",{style:{color:"#E1E4E8"}},");"),r("span",{style:{color:"#6A737D"}},"//变为已解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    wareOrderTaskDetailService."),r("span",{style:{color:"#B392F0"}},"updateById"),r("span",{style:{color:"#E1E4E8"}},"(entity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 防止订单服务卡顿，导致更改订单状态的操作无法完成以及更改的mq消息没有得到执行，解锁库存的消息优先到期，扫描订单状态是新建状态，就会什么都不做")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 导致卡顿的订单永远不能解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"orderTo")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 加入统一事务")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Transactional")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"unlockStock"),r("span",{style:{color:"#24292E"}},"(OrderTo orderTo) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    String orderSn "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," orderTo."),r("span",{style:{color:"#6F42C1"}},"getOrderSn"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//查一下最新库存的状态，防止重复解锁库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    WareOrderTaskEntity task "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareOrderTaskService."),r("span",{style:{color:"#6F42C1"}},"getOrderTaskByOrderSn"),r("span",{style:{color:"#24292E"}},"(orderSn);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    Long id "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," task."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//按照工作单找到所有 没有解锁的库存，进行解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#24292E"}},"> detailEntities "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wareOrderTaskDetailService."),r("span",{style:{color:"#6F42C1"}},"list"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," QueryWrapper<"),r("span",{style:{color:"#D73A49"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#24292E"}},">().")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6F42C1"}},"eq"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"task_id"'),r("span",{style:{color:"#24292E"}},", id).")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//新建的还没被解锁的库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6F42C1"}},"eq"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"lock_status"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#24292E"}},"));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"for"),r("span",{style:{color:"#24292E"}}," (WareOrderTaskDetailEntity entity "),r("span",{style:{color:"#D73A49"}},":"),r("span",{style:{color:"#24292E"}}," detailEntities) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//此解锁方式可以解决高并发问题和整个系统的异构(两个服务开发语言不同。如java，php)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6F42C1"}},"unLockStock"),r("span",{style:{color:"#24292E"}},"(entity."),r("span",{style:{color:"#6F42C1"}},"getSkuId"),r("span",{style:{color:"#24292E"}},"(), entity."),r("span",{style:{color:"#6F42C1"}},"getWareId"),r("span",{style:{color:"#24292E"}},"(), entity."),r("span",{style:{color:"#6F42C1"}},"getSkuNum"),r("span",{style:{color:"#24292E"}},"(), entity."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"private"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"unLockStock"),r("span",{style:{color:"#24292E"}},"(Long skuId, Long wareId, Integer num, Long taskDetailId) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//库存解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    wareSkuDao."),r("span",{style:{color:"#6F42C1"}},"unLockStock"),r("span",{style:{color:"#24292E"}},"(skuId, wareId, num);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//更新库存工作单的状态")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    WareOrderTaskDetailEntity entity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"WareOrderTaskDetailEntity"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    entity."),r("span",{style:{color:"#6F42C1"}},"setId"),r("span",{style:{color:"#24292E"}},"(taskDetailId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    entity."),r("span",{style:{color:"#6F42C1"}},"setLockStatus"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"2"),r("span",{style:{color:"#24292E"}},");"),r("span",{style:{color:"#6A737D"}},"//变为已解锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    wareOrderTaskDetailService."),r("span",{style:{color:"#6F42C1"}},"updateById"),r("span",{style:{color:"#24292E"}},"(entity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),Yo={id:"订单确认页流程",tabindex:"-1"},Zo=r("figure",null,[r("img",{alt:"image-20230322151416874",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230322151416874.png"})],-1),ln={id:"电商订单流程图",tabindex:"-1"},sn=r("figure",null,[r("img",{alt:"image-20230322151557139",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230322151557139.png"})],-1),on={id:"消息队列流程图",tabindex:"-1"},nn=r("figure",null,[r("img",{alt:"image-20230416235749443",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230416235749443.png"})],-1),en={id:"支付宝支付流程图",tabindex:"-1"},an=r("figure",null,[r("img",{alt:"image-20230404162856264",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230404162856264.png"})],-1),tn={id:"项目难点",tabindex:"-1"},rn=r("ul",null,[r("li",null,[r("p",null,"订单服务与库存的联动(延时队列的使用)")]),r("li",null,[r("p",null,"订单释放&库存解锁"),r("figure",null,[r("img",{alt:"image-20230322190959538",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230322190959538.png"})])])],-1),cn={id:"解决问题",tabindex:"-1"},pn=r("ul",null,[r("li",null,[r("p",null,[c("使用"),r("strong",null,"CompletableFuture 异步编排"),c("解决查询商品详情⻚"),r("strong",null,"响应速度慢的问题"),c("；")]),r("ul",null,[r("li",null,"假如商品详情页的每个查询，需要如下标注的时间才能完成 那么，用户需要 5.5s 后才能看到商品详情页的内容。很显然是不能接受的。 如果有多个线程同时完成这 6 步操作，也许只需要 1.5s 即可完成响应。")])]),r("li",null,[r("p",null,[c("使用"),r("strong",null,"Spring Cache方法级别缓存技术"),c("，实现已经被调用过的指定的目标方法，直接从缓存中获取方法调用后的结果返回，"),r("strong",null,"提高系统的响应速度；")])]),r("li",null,[r("p",null,"幂等解决方案"),r("ul",null,[r("li",null,[r("p",null,"token 机制"),r("ul",null,[r("li",null,[r("p",null,"1、服务端提供了发送 token 的接口。我们在分析业务的时候，哪些业务是存在幂等问题的，就必须在执行业务前，先去获取 token，服务器会把token 保存到 redis 中。")]),r("li",null,[r("p",null,"2、然后调用业务接口请求时，把 token 携带过去，一般放在请求头部。")]),r("li",null,[r("p",null,"3、服务器判断 token 是否存在 redis 中，存在表示第一次请求，然后删除 token,继续执行业务。")]),r("li",null,[r("p",null,"4、如果判断 token 不存在 redis 中，就表示是重复操作，直接返回重复标记给 client，这样就保证了业务代码，不被重复执行。")]),r("li",null,[r("p",null,"危险性："),r("ul",null,[r("li",null,[r("p",null,"1、先删除 token 还是后删除 token；")]),r("li",null,[r("p",null,"(1) 先删除可能导致，业务确实没有执行，重试还带上之前 token，由于防重设计导致，请求还是不能执行。")]),r("li",null,[r("p",null,"(2) 后删除可能导致，业务处理成功，但是服务闪断，出现超时，没有删除 token，别人继续重试，导致业务被执行两遍")]),r("li",null,[r("p",null,"(3) 我们最好设计为先删除 token，如果业务调用失败，就重新获取 token 再次请求。")]),r("li",null,[r("p",null,"2、Token 获取、比较和删除必须是原子性")]),r("li",null,[r("p",null,"(1) redis.get(token) 、token.equals、redis.del(token)如果这两个操作不是原子，可能导致，高并发下，都 get 到同样的数据，判断都成功，继续业务并发执行")]),r("li",null,[r("p",null,"(2) 可以在 redis 使用 lua 脚本完成这个操作")])])])])])]),r("div",{style:{"max-height":"300px"},class:"language-shell"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"shell"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"redis.call("),r("span",{style:{color:"#B392F0"}},"'get'"),r("span",{style:{color:"#B392F0"}},","),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},"KEYS["),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#9ECBFF"}},"]"),r("span",{style:{color:"#E1E4E8"}},") == ARGV["),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#E1E4E8"}},"] "),r("span",{style:{color:"#F97583"}},"then"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," redis.call("),r("span",{style:{color:"#B392F0"}},"'del'"),r("span",{style:{color:"#B392F0"}},","),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},"KEYS["),r("span",{style:{color:"#79B8FF"}},"1"),r("span",{style:{color:"#9ECBFF"}},"]"),r("span",{style:{color:"#E1E4E8"}},") "),r("span",{style:{color:"#F97583"}},"else"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," 0 "),r("span",{style:{color:"#F97583"}},"end")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"redis.call("),r("span",{style:{color:"#6F42C1"}},"'get'"),r("span",{style:{color:"#6F42C1"}},","),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},"KEYS["),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#032F62"}},"]"),r("span",{style:{color:"#24292E"}},") == ARGV["),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#24292E"}},"] "),r("span",{style:{color:"#D73A49"}},"then"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," redis.call("),r("span",{style:{color:"#6F42C1"}},"'del'"),r("span",{style:{color:"#6F42C1"}},","),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},"KEYS["),r("span",{style:{color:"#005CC5"}},"1"),r("span",{style:{color:"#032F62"}},"]"),r("span",{style:{color:"#24292E"}},") "),r("span",{style:{color:"#D73A49"}},"else"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," 0 "),r("span",{style:{color:"#D73A49"}},"end")])])]),r("button",{class:"collapse"})])]),r("li",null,[r("p",null,"Session共享问题解决-不同服务，子域session共享"),r("ul",null,[r("li",null,"jsessionid这个cookie默认是当前系统域名的。当我们分拆服务，不同域名部署的时候，我们可以使用如下解决方案；")]),r("figure",null,[r("img",{alt:"image-20230323001610876",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230323001610876.png"})]),r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Configuration")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"class"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"GulimallSessionConfig"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," CookieSerializer "),r("span",{style:{color:"#B392F0"}},"cookieSerializer"),r("span",{style:{color:"#E1E4E8"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        DefaultCookieSerializer cookieSerializer "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"DefaultCookieSerializer"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        cookieSerializer."),r("span",{style:{color:"#B392F0"}},"setDomainName"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"gulimall.com"'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        cookieSerializer."),r("span",{style:{color:"#B392F0"}},"setCookieName"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"KLAUSSESSION"'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," cookieSerializer;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," RedisSerializer<"),r("span",{style:{color:"#F97583"}},"Object"),r("span",{style:{color:"#E1E4E8"}},"> "),r("span",{style:{color:"#B392F0"}},"springSessionDefaultRedisSerializer"),r("span",{style:{color:"#E1E4E8"}},"() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"GenericJackson2JsonRedisSerializer"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Configuration")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"class"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"GulimallSessionConfig"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," CookieSerializer "),r("span",{style:{color:"#6F42C1"}},"cookieSerializer"),r("span",{style:{color:"#24292E"}},"(){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        DefaultCookieSerializer cookieSerializer "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"DefaultCookieSerializer"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        cookieSerializer."),r("span",{style:{color:"#6F42C1"}},"setDomainName"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"gulimall.com"'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        cookieSerializer."),r("span",{style:{color:"#6F42C1"}},"setCookieName"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"KLAUSSESSION"'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," cookieSerializer;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"Bean")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," RedisSerializer<"),r("span",{style:{color:"#D73A49"}},"Object"),r("span",{style:{color:"#24292E"}},"> "),r("span",{style:{color:"#6F42C1"}},"springSessionDefaultRedisSerializer"),r("span",{style:{color:"#24292E"}},"() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"GenericJackson2JsonRedisSerializer"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})]),r("ul",null,[r("li",null,"SpringSession核心原理")]),r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 加入依赖")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *          <dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <groupId>org.springframework.boot</groupId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <artifactId>spring-boot-starter-data-redis</artifactId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         </dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         \x3c!--整合Springsession完成session共享问题--\x3e")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         <dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <groupId>org.springframework.session</groupId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <artifactId>spring-session-data-redis</artifactId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         </dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 核心原理")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1、@EnableRedisHttpSession导入RedisHttpSessionConfiguration配置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      1）、给容器中添加了一个组件")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *          传入SessionRepository==》【RedisOperationsSessionRepository】===》redis操作session，session的增删改查封装类")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      2）、SessionRepositoryFilter==》Filter(web)：session存储过滤器；每个请求过来都必须经过Filter")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         I）、创建的时候，就自动从容器中获取了SessionRepository")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         II）、原始的HttpServletRequest request, HttpServletResponse response都被分别包装成了SessionRepositoryRequestWrapper，SessionRepositoryResponseWrapper")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         III）、以后获取session-》request.getSession();（原始的）")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         //SessionRepositoryRequestWrapper重写getSession方法")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         IV）、wrapperRequest.getSession();==> SessionRepository中获取的到")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  装饰者模式；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  自动延期；redis中的数据也是有过期时间的")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"EnableRedisHttpSession"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#6A737D"}},"//整合redis作为session存储")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"SpringBootApplication")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"class"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"GulimallAuthServerApplication"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"static"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"main"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},"[] "),r("span",{style:{color:"#FFAB70"}},"args"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        SpringApplication."),r("span",{style:{color:"#B392F0"}},"run"),r("span",{style:{color:"#E1E4E8"}},"(GulimallAuthServerApplication.class, args);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 加入依赖")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *          <dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <groupId>org.springframework.boot</groupId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <artifactId>spring-boot-starter-data-redis</artifactId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         </dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         \x3c!--整合Springsession完成session共享问题--\x3e")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         <dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <groupId>org.springframework.session</groupId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <artifactId>spring-session-data-redis</artifactId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         </dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 核心原理")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1、@EnableRedisHttpSession导入RedisHttpSessionConfiguration配置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      1）、给容器中添加了一个组件")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *          传入SessionRepository==》【RedisOperationsSessionRepository】===》redis操作session，session的增删改查封装类")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      2）、SessionRepositoryFilter==》Filter(web)：session存储过滤器；每个请求过来都必须经过Filter")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         I）、创建的时候，就自动从容器中获取了SessionRepository")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         II）、原始的HttpServletRequest request, HttpServletResponse response都被分别包装成了SessionRepositoryRequestWrapper，SessionRepositoryResponseWrapper")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         III）、以后获取session-》request.getSession();（原始的）")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         //SessionRepositoryRequestWrapper重写getSession方法")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         IV）、wrapperRequest.getSession();==> SessionRepository中获取的到")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  装饰者模式；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  自动延期；redis中的数据也是有过期时间的")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"EnableRedisHttpSession"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6A737D"}},"//整合redis作为session存储")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"SpringBootApplication")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"class"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"GulimallAuthServerApplication"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"static"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"main"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},"[] "),r("span",{style:{color:"#E36209"}},"args"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        SpringApplication."),r("span",{style:{color:"#6F42C1"}},"run"),r("span",{style:{color:"#24292E"}},"(GulimallAuthServerApplication.class, args);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})]),r("figure",null,[r("img",{alt:"image-20230323001706985",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230323001706985.png"})])]),r("li",null,[r("p",null,"ThreadLocal-同一个线程共享数据")])],-1),yn=r("figure",null,[r("img",{alt:"image-20230323001857265",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230323001857265.png"})],-1),En=r("ul",null,[r("li",null,[r("p",null,"Feign远程调用丢失请求头问题"),r("figure",null,[r("img",{alt:"image-20230323001742038",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230323001742038.png"})]),r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.member.config")])])])],-1),un=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Configuration")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"class"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"GulimallFeignConfig"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    @"),r("span",{style:{color:"#F97583"}},"Bean"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"requestInterceptor"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," RequestInterceptor "),r("span",{style:{color:"#B392F0"}},"requestInterceptor"),r("span",{style:{color:"#E1E4E8"}},"() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"// RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//RequestContextHolder.setRequestAttributes(requestAttributes);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"// 进行共享操作，拦截器才会有请求上下文的所有数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"RequestInterceptor"),r("span",{style:{color:"#E1E4E8"}},"() {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            @"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"void"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"apply"),r("span",{style:{color:"#E1E4E8"}},"(RequestTemplate "),r("span",{style:{color:"#FFAB70"}},"template"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//1、RequestContextHolder拿到刚进来的这个请求")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                ServletRequestAttributes attributes "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," (ServletRequestAttributes) RequestContextHolder."),r("span",{style:{color:"#B392F0"}},"getRequestAttributes"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (attributes "),r("span",{style:{color:"#F97583"}},"!="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"RequestInterceptor线程...."'),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}},"Thread."),r("span",{style:{color:"#B392F0"}},"currentThread"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    HttpServletRequest request "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," attributes."),r("span",{style:{color:"#B392F0"}},"getRequest"),r("span",{style:{color:"#E1E4E8"}},"();"),r("span",{style:{color:"#6A737D"}},"//老请求")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (request "),r("span",{style:{color:"#F97583"}},"!="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                        "),r("span",{style:{color:"#6A737D"}},"//请求不为空")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                        "),r("span",{style:{color:"#6A737D"}},"//同步请求头数据，Cookie")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                        String cookie "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," request."),r("span",{style:{color:"#B392F0"}},"getHeader"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"Cookie"'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},'//                System.out.println("feign远程之前先进行RequestInterceptor.apply");')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                        "),r("span",{style:{color:"#6A737D"}},"//给新请求同步了老请求的Cookie")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                        template."),r("span",{style:{color:"#B392F0"}},"header"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"Cookie"'),r("span",{style:{color:"#E1E4E8"}},", cookie);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        };")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Configuration")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"class"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"GulimallFeignConfig"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    @"),r("span",{style:{color:"#D73A49"}},"Bean"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"requestInterceptor"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," RequestInterceptor "),r("span",{style:{color:"#6F42C1"}},"requestInterceptor"),r("span",{style:{color:"#24292E"}},"() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"// RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//RequestContextHolder.setRequestAttributes(requestAttributes);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"// 进行共享操作，拦截器才会有请求上下文的所有数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"RequestInterceptor"),r("span",{style:{color:"#24292E"}},"() {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            @"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"void"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"apply"),r("span",{style:{color:"#24292E"}},"(RequestTemplate "),r("span",{style:{color:"#E36209"}},"template"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//1、RequestContextHolder拿到刚进来的这个请求")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                ServletRequestAttributes attributes "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," (ServletRequestAttributes) RequestContextHolder."),r("span",{style:{color:"#6F42C1"}},"getRequestAttributes"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (attributes "),r("span",{style:{color:"#D73A49"}},"!="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"RequestInterceptor线程...."'),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}},"Thread."),r("span",{style:{color:"#6F42C1"}},"currentThread"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    HttpServletRequest request "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," attributes."),r("span",{style:{color:"#6F42C1"}},"getRequest"),r("span",{style:{color:"#24292E"}},"();"),r("span",{style:{color:"#6A737D"}},"//老请求")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (request "),r("span",{style:{color:"#D73A49"}},"!="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                        "),r("span",{style:{color:"#6A737D"}},"//请求不为空")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                        "),r("span",{style:{color:"#6A737D"}},"//同步请求头数据，Cookie")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                        String cookie "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," request."),r("span",{style:{color:"#6F42C1"}},"getHeader"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"Cookie"'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},'//                System.out.println("feign远程之前先进行RequestInterceptor.apply");')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                        "),r("span",{style:{color:"#6A737D"}},"//给新请求同步了老请求的Cookie")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                        template."),r("span",{style:{color:"#6F42C1"}},"header"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"Cookie"'),r("span",{style:{color:"#24292E"}},", cookie);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        };")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),dn=r("ul",null,[r("li",null,[r("p",null,"Feign异步情况丢失上下文问题"),r("figure",null,[r("img",{alt:"image-20230323001802654",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230323001802654.png"})]),r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.order.service.impl.OrderServiceImpl#confirmOrder")])])])],-1),gn=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//获取原来请求上下文请求属性")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"RequestAttributes requestAttributes "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," RequestContextHolder."),r("span",{style:{color:"#B392F0"}},"getRequestAttributes"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//进行异步编排")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"CompletableFuture<"),r("span",{style:{color:"#F97583"}},"Void"),r("span",{style:{color:"#E1E4E8"}},"> getAddressFuture "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," CompletableFuture."),r("span",{style:{color:"#B392F0"}},"runAsync"),r("span",{style:{color:"#E1E4E8"}},"(() "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//1、远程查询所有的收货地址列表")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"member线程...."'),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," Thread."),r("span",{style:{color:"#B392F0"}},"currentThread"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//在Feign异步调用前将请求上下文进行共享操作(之前的请求数据都来共享每一个线程)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    RequestContextHolder."),r("span",{style:{color:"#B392F0"}},"setRequestAttributes"),r("span",{style:{color:"#E1E4E8"}},"(requestAttributes);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"MemberAddressVo"),r("span",{style:{color:"#E1E4E8"}},"> address "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," memberFeignService."),r("span",{style:{color:"#B392F0"}},"getAddress"),r("span",{style:{color:"#E1E4E8"}},"(memberRespVo."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    confirmVo."),r("span",{style:{color:"#B392F0"}},"setAddress"),r("span",{style:{color:"#E1E4E8"}},"(address);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"CompletableFuture<"),r("span",{style:{color:"#F97583"}},"Void"),r("span",{style:{color:"#E1E4E8"}},"> cartFuture "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," CompletableFuture."),r("span",{style:{color:"#B392F0"}},"runAsync"),r("span",{style:{color:"#E1E4E8"}},"(() "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//2、远程查询购物车所有选中的购物项")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    System.out."),r("span",{style:{color:"#B392F0"}},"println"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"cart线程...."'),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," Thread."),r("span",{style:{color:"#B392F0"}},"currentThread"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"getId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//在Feign异步调用前将请求上下文进行共享操作")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    RequestContextHolder."),r("span",{style:{color:"#B392F0"}},"setRequestAttributes"),r("span",{style:{color:"#E1E4E8"}},"(requestAttributes);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"OrderItemVo"),r("span",{style:{color:"#E1E4E8"}},"> items "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," cartFeignService."),r("span",{style:{color:"#B392F0"}},"currentUserCartItems"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    confirmVo."),r("span",{style:{color:"#B392F0"}},"setItems"),r("span",{style:{color:"#E1E4E8"}},"(items);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//feign在远程调用之前要构造请求，调用很多的拦截器")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//for(RequestInterceptor interceptor:requestInterceptors)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}, executor)."),r("span",{style:{color:"#B392F0"}},"thenRunAsync"),r("span",{style:{color:"#E1E4E8"}},"(() "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"OrderItemVo"),r("span",{style:{color:"#E1E4E8"}},"> items "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," confirmVo."),r("span",{style:{color:"#B392F0"}},"getItems"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"Long"),r("span",{style:{color:"#E1E4E8"}},"> skuIds "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," items."),r("span",{style:{color:"#B392F0"}},"stream"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"map"),r("span",{style:{color:"#E1E4E8"}},"(item "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," item."),r("span",{style:{color:"#B392F0"}},"getSkuId"),r("span",{style:{color:"#E1E4E8"}},"())."),r("span",{style:{color:"#B392F0"}},"collect"),r("span",{style:{color:"#E1E4E8"}},"(Collectors."),r("span",{style:{color:"#B392F0"}},"toList"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//远程查询库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    R r "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," wmsFeignService."),r("span",{style:{color:"#B392F0"}},"getSkusHasStock"),r("span",{style:{color:"#E1E4E8"}},"(skuIds);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    List<"),r("span",{style:{color:"#F97583"}},"SkuStockVo"),r("span",{style:{color:"#E1E4E8"}},"> data "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," r."),r("span",{style:{color:"#B392F0"}},"getData"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," TypeReference<List<"),r("span",{style:{color:"#F97583"}},"SkuStockVo"),r("span",{style:{color:"#E1E4E8"}},">>() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    });")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (data "),r("span",{style:{color:"#F97583"}},"!="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"// Map<SkuId, hasStock> map")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        Map<"),r("span",{style:{color:"#F97583"}},"Long"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#F97583"}},"Boolean"),r("span",{style:{color:"#E1E4E8"}},"> map "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," data."),r("span",{style:{color:"#B392F0"}},"stream"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"collect"),r("span",{style:{color:"#E1E4E8"}},"(Collectors."),r("span",{style:{color:"#B392F0"}},"toMap"),r("span",{style:{color:"#E1E4E8"}},"(SkuStockVo"),r("span",{style:{color:"#F97583"}},"::"),r("span",{style:{color:"#E1E4E8"}},"getSkuId, SkuStockVo"),r("span",{style:{color:"#F97583"}},"::"),r("span",{style:{color:"#E1E4E8"}},"getHasStock));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"// Map<Long, Boolean> stocks;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        confirmVo."),r("span",{style:{color:"#B392F0"}},"setStocks"),r("span",{style:{color:"#E1E4E8"}},"(map);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}, executor);")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//获取原来请求上下文请求属性")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"RequestAttributes requestAttributes "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," RequestContextHolder."),r("span",{style:{color:"#6F42C1"}},"getRequestAttributes"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"//进行异步编排")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"CompletableFuture<"),r("span",{style:{color:"#D73A49"}},"Void"),r("span",{style:{color:"#24292E"}},"> getAddressFuture "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," CompletableFuture."),r("span",{style:{color:"#6F42C1"}},"runAsync"),r("span",{style:{color:"#24292E"}},"(() "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//1、远程查询所有的收货地址列表")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"member线程...."'),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," Thread."),r("span",{style:{color:"#6F42C1"}},"currentThread"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//在Feign异步调用前将请求上下文进行共享操作(之前的请求数据都来共享每一个线程)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    RequestContextHolder."),r("span",{style:{color:"#6F42C1"}},"setRequestAttributes"),r("span",{style:{color:"#24292E"}},"(requestAttributes);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"MemberAddressVo"),r("span",{style:{color:"#24292E"}},"> address "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," memberFeignService."),r("span",{style:{color:"#6F42C1"}},"getAddress"),r("span",{style:{color:"#24292E"}},"(memberRespVo."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    confirmVo."),r("span",{style:{color:"#6F42C1"}},"setAddress"),r("span",{style:{color:"#24292E"}},"(address);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"CompletableFuture<"),r("span",{style:{color:"#D73A49"}},"Void"),r("span",{style:{color:"#24292E"}},"> cartFuture "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," CompletableFuture."),r("span",{style:{color:"#6F42C1"}},"runAsync"),r("span",{style:{color:"#24292E"}},"(() "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//2、远程查询购物车所有选中的购物项")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    System.out."),r("span",{style:{color:"#6F42C1"}},"println"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"cart线程...."'),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," Thread."),r("span",{style:{color:"#6F42C1"}},"currentThread"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"getId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//在Feign异步调用前将请求上下文进行共享操作")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    RequestContextHolder."),r("span",{style:{color:"#6F42C1"}},"setRequestAttributes"),r("span",{style:{color:"#24292E"}},"(requestAttributes);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"OrderItemVo"),r("span",{style:{color:"#24292E"}},"> items "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," cartFeignService."),r("span",{style:{color:"#6F42C1"}},"currentUserCartItems"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    confirmVo."),r("span",{style:{color:"#6F42C1"}},"setItems"),r("span",{style:{color:"#24292E"}},"(items);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//feign在远程调用之前要构造请求，调用很多的拦截器")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//for(RequestInterceptor interceptor:requestInterceptors)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}, executor)."),r("span",{style:{color:"#6F42C1"}},"thenRunAsync"),r("span",{style:{color:"#24292E"}},"(() "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"OrderItemVo"),r("span",{style:{color:"#24292E"}},"> items "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," confirmVo."),r("span",{style:{color:"#6F42C1"}},"getItems"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"Long"),r("span",{style:{color:"#24292E"}},"> skuIds "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," items."),r("span",{style:{color:"#6F42C1"}},"stream"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"map"),r("span",{style:{color:"#24292E"}},"(item "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," item."),r("span",{style:{color:"#6F42C1"}},"getSkuId"),r("span",{style:{color:"#24292E"}},"())."),r("span",{style:{color:"#6F42C1"}},"collect"),r("span",{style:{color:"#24292E"}},"(Collectors."),r("span",{style:{color:"#6F42C1"}},"toList"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//远程查询库存")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    R r "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," wmsFeignService."),r("span",{style:{color:"#6F42C1"}},"getSkusHasStock"),r("span",{style:{color:"#24292E"}},"(skuIds);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    List<"),r("span",{style:{color:"#D73A49"}},"SkuStockVo"),r("span",{style:{color:"#24292E"}},"> data "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," r."),r("span",{style:{color:"#6F42C1"}},"getData"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," TypeReference<List<"),r("span",{style:{color:"#D73A49"}},"SkuStockVo"),r("span",{style:{color:"#24292E"}},">>() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    });")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (data "),r("span",{style:{color:"#D73A49"}},"!="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"// Map<SkuId, hasStock> map")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        Map<"),r("span",{style:{color:"#D73A49"}},"Long"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#D73A49"}},"Boolean"),r("span",{style:{color:"#24292E"}},"> map "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," data."),r("span",{style:{color:"#6F42C1"}},"stream"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"collect"),r("span",{style:{color:"#24292E"}},"(Collectors."),r("span",{style:{color:"#6F42C1"}},"toMap"),r("span",{style:{color:"#24292E"}},"(SkuStockVo"),r("span",{style:{color:"#D73A49"}},"::"),r("span",{style:{color:"#24292E"}},"getSkuId, SkuStockVo"),r("span",{style:{color:"#D73A49"}},"::"),r("span",{style:{color:"#24292E"}},"getHasStock));")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"// Map<Long, Boolean> stocks;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        confirmVo."),r("span",{style:{color:"#6F42C1"}},"setStocks"),r("span",{style:{color:"#24292E"}},"(map);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}, executor);")])])]),r("button",{class:"collapse"})],-1),Fn={id:"项目优化",tabindex:"-1"},An=r("ul",null,[r("li",null,"使用动态线程池管理和监控，定时获取线程池的运行数据")],-1),mn=r("p",null,"Hippo4j 提供了应用线程池运行时变更核心参数的功能。而且，如果应用是集群部署，可以选择修改线程池某一实例，或者修改集群全部实例，运行时生效，不需要再重启服务。",-1),Dn=r("p",null,"压测时可以使用 Hippo4j 动态调整线程池参数，判断线程池核心参数设置是否合理。对于开发测试来说，如果不满足可以随时调整。",-1),hn={id:"completablefuture异步编排",tabindex:"-1"},kn={id:"概念",tabindex:"-1"},bn=r("ul",null,[r("li",null,"CompletableFuture是JDK1.8里面引入的一个异步回调类，就是说当前使用异步线程去执行一个任务时候，我们希望在这个任务结束以后，触发一个后续的动作，而CompletableFuture就可以实现这样的功能。")],-1),Cn={id:"业务场景",tabindex:"-1"},Sn=r("ul",null,[r("li",null,"查询商品详情页的逻辑比较复杂，有些数据还需要远程调用，必然需要花费更多的时间。")],-1),Bn=r("figure",null,[r("img",{alt:"image-20230322152108985",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230322152108985.png"})],-1),fn=r("ul",null,[r("li",null,"假如商品详情页的每个查询，需要如下标注的时间才能完成 那么，用户需要 5.5s 后才能看到商品详情页的内容。很显然是不能接受的。 如果有多个线程同时完成这 6 步操作，也许只需要 1.5s 即可完成响应。"),r("li",null,"在 Java 8 中, 新增加了一个包含 50 个方法左右的类: CompletableFuture，提供了非常强大的 Future 的扩展功能，可以帮助我们简化异步编程的复杂性，提供了函数式编程的能力，可以 通过回调的方式处理计算结果，并且提供了转换和组合 CompletableFuture 的方法。")],-1),vn={id:"项目代码",tabindex:"-1"},xn=r("ul",null,[r("li",null,[r("code",null,"com.klaus.gulimall.product.service.impl.SkuInfoServiceImpl#item")])],-1),In=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//四、线程串行化方法")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"/*")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    thenApply 方法：当一个线程依赖另一个线程时，获取上一个任务返回的结果，并返回当前")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    任务的返回值。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    thenAccept 方法：消费处理结果。接收任务的处理结果，并消费处理，无返回结果。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    thenRun 方法：只要上面的任务执行完成，就开始执行 thenRun，只是处理完任务后，执行")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    thenRun 的后续操作")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    带有 Async 默认是异步执行的。同之前。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    以上都要前置任务成功完成。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"\t@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," SkuItemVo "),r("span",{style:{color:"#B392F0"}},"item"),r("span",{style:{color:"#E1E4E8"}},"(Long skuId) throws ExecutionException, InterruptedException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        SkuItemVo skuItemVo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"SkuItemVo"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//一、创建异步对象")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"/*")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"         runAsync和supplyAsync  runXxxx 都是没有返回结果的，supplyXxx 都是可以获取返回结果的")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"         可以传入自定义的线程池，否则就用默认的线程池；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"         */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        CompletableFuture<"),r("span",{style:{color:"#F97583"}},"SkuInfoEntity"),r("span",{style:{color:"#E1E4E8"}},"> infoFuture "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," CompletableFuture."),r("span",{style:{color:"#B392F0"}},"supplyAsync"),r("span",{style:{color:"#E1E4E8"}},"(() "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//1.sku基本信息获取 pms_sku_info")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            SkuInfoEntity info "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"this"),r("span",{style:{color:"#E1E4E8"}},"."),r("span",{style:{color:"#B392F0"}},"getById"),r("span",{style:{color:"#E1E4E8"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            skuItemVo."),r("span",{style:{color:"#B392F0"}},"setInfo"),r("span",{style:{color:"#E1E4E8"}},"(info);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," info;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }, executor);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    CompletableFuture<"),r("span",{style:{color:"#F97583"}},"Void"),r("span",{style:{color:"#E1E4E8"}},"> saleAttrFuture "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," infoFuture."),r("span",{style:{color:"#B392F0"}},"thenAcceptAsync"),r("span",{style:{color:"#E1E4E8"}},"((res) "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//3、 获取spu的销售属性组合")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"SkuItemSaleAttrVo"),r("span",{style:{color:"#E1E4E8"}},"> saleAttrVos "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," skuSaleAttrValueService."),r("span",{style:{color:"#B392F0"}},"getSaleAttrBySpuId"),r("span",{style:{color:"#E1E4E8"}},"(res."),r("span",{style:{color:"#B392F0"}},"getSpuId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        skuItemVo."),r("span",{style:{color:"#B392F0"}},"setSaleAttr"),r("span",{style:{color:"#E1E4E8"}},"(saleAttrVos);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    CompletableFuture<"),r("span",{style:{color:"#F97583"}},"Void"),r("span",{style:{color:"#E1E4E8"}},"> descFuture "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," infoFuture."),r("span",{style:{color:"#B392F0"}},"thenAcceptAsync"),r("span",{style:{color:"#E1E4E8"}},"((res) "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//4.获取spu的介绍 pms_spu_info_desc")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        SpuInfoDescEntity spuInfoDescEntity "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," spuInfoDescService."),r("span",{style:{color:"#B392F0"}},"getById"),r("span",{style:{color:"#E1E4E8"}},"(res."),r("span",{style:{color:"#B392F0"}},"getSpuId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        skuItemVo."),r("span",{style:{color:"#B392F0"}},"setDesc"),r("span",{style:{color:"#E1E4E8"}},"(spuInfoDescEntity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    CompletableFuture<"),r("span",{style:{color:"#F97583"}},"Void"),r("span",{style:{color:"#E1E4E8"}},"> baseAttrFuture "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," infoFuture."),r("span",{style:{color:"#B392F0"}},"thenAcceptAsync"),r("span",{style:{color:"#E1E4E8"}},"((res) "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//5.获取spu的规格参数信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"SpuItemAttrGroupVo"),r("span",{style:{color:"#E1E4E8"}},"> attrGroupVos "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," attrGroupService."),r("span",{style:{color:"#B392F0"}},"getAttrGroupWithAttrsBySpuId"),r("span",{style:{color:"#E1E4E8"}},"(res."),r("span",{style:{color:"#B392F0"}},"getSpuId"),r("span",{style:{color:"#E1E4E8"}},"(), res."),r("span",{style:{color:"#B392F0"}},"getCatalogId"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        skuItemVo."),r("span",{style:{color:"#B392F0"}},"setGroupAttrs"),r("span",{style:{color:"#E1E4E8"}},"(attrGroupVos);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//一、创建异步对象")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"/*")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     runAsync和supplyAsync  runXxxx 都是没有返回结果的，supplyXxx 都是可以获取返回结果的")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     可以传入自定义的线程池，否则就用默认的线程池；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//2.sku图片信息  pms_spu_images")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    CompletableFuture<"),r("span",{style:{color:"#F97583"}},"Void"),r("span",{style:{color:"#E1E4E8"}},"> imageFuture "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," CompletableFuture."),r("span",{style:{color:"#B392F0"}},"runAsync"),r("span",{style:{color:"#E1E4E8"}},"(() "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        List<"),r("span",{style:{color:"#F97583"}},"SkuImagesEntity"),r("span",{style:{color:"#E1E4E8"}},"> imagesEntities "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," skuImagesService."),r("span",{style:{color:"#B392F0"}},"getImagesBySkuId"),r("span",{style:{color:"#E1E4E8"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        skuItemVo."),r("span",{style:{color:"#B392F0"}},"setImages"),r("span",{style:{color:"#E1E4E8"}},"(imagesEntities);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//TODO //3、远程调用查询当前sku是否参与秒杀优惠活动")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    CompletableFuture<"),r("span",{style:{color:"#F97583"}},"Void"),r("span",{style:{color:"#E1E4E8"}},"> seckillFuture "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," CompletableFuture."),r("span",{style:{color:"#B392F0"}},"runAsync"),r("span",{style:{color:"#E1E4E8"}},"(() "),r("span",{style:{color:"#F97583"}},"->"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#6A737D"}},"//3.远程调用查询当前sku是否参与秒杀优惠活动")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        R skuSeckilInfo "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," seckillFeignService."),r("span",{style:{color:"#B392F0"}},"getSkuSeckilInfo"),r("span",{style:{color:"#E1E4E8"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (skuSeckilInfo."),r("span",{style:{color:"#B392F0"}},"getCode"),r("span",{style:{color:"#E1E4E8"}},"() "),r("span",{style:{color:"#F97583"}},"=="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"0"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//查询成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            SeckillSkuVo skuSeckilInfoData "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," skuSeckilInfo."),r("span",{style:{color:"#B392F0"}},"getData"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"data"'),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#F97583"}},"new"),r("span",{style:{color:"#E1E4E8"}}," TypeReference<"),r("span",{style:{color:"#F97583"}},"SeckillSkuVo"),r("span",{style:{color:"#E1E4E8"}},">() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            });")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            skuItemVo."),r("span",{style:{color:"#B392F0"}},"setSeckillSkuVo"),r("span",{style:{color:"#E1E4E8"}},"(skuSeckilInfoData);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (skuSeckilInfoData "),r("span",{style:{color:"#F97583"}},"!="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"long"),r("span",{style:{color:"#E1E4E8"}}," currentTime "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," System."),r("span",{style:{color:"#B392F0"}},"currentTimeMillis"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," (currentTime "),r("span",{style:{color:"#F97583"}},">"),r("span",{style:{color:"#E1E4E8"}}," skuSeckilInfoData."),r("span",{style:{color:"#B392F0"}},"getEndTime"),r("span",{style:{color:"#E1E4E8"}},"()) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                    skuItemVo."),r("span",{style:{color:"#B392F0"}},"setSeckillSkuVo"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"null"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//七、多任务组合")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"/*")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    allOf：等待所有任务完成")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    anyOf：只要有一个任务完成")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//等到所有任务完成  //TODO 秒杀优惠活动Future")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    CompletableFuture."),r("span",{style:{color:"#B392F0"}},"allOf"),r("span",{style:{color:"#E1E4E8"}},"(saleAttrFuture,descFuture,baseAttrFuture,imageFuture,seckillFuture)."),r("span",{style:{color:"#B392F0"}},"get"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," skuItemVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//四、线程串行化方法")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"/*")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    thenApply 方法：当一个线程依赖另一个线程时，获取上一个任务返回的结果，并返回当前")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    任务的返回值。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    thenAccept 方法：消费处理结果。接收任务的处理结果，并消费处理，无返回结果。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    thenRun 方法：只要上面的任务执行完成，就开始执行 thenRun，只是处理完任务后，执行")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    thenRun 的后续操作")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    带有 Async 默认是异步执行的。同之前。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    以上都要前置任务成功完成。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"\t@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," SkuItemVo "),r("span",{style:{color:"#6F42C1"}},"item"),r("span",{style:{color:"#24292E"}},"(Long skuId) throws ExecutionException, InterruptedException {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        SkuItemVo skuItemVo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"SkuItemVo"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//一、创建异步对象")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"/*")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"         runAsync和supplyAsync  runXxxx 都是没有返回结果的，supplyXxx 都是可以获取返回结果的")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"         可以传入自定义的线程池，否则就用默认的线程池；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"         */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        CompletableFuture<"),r("span",{style:{color:"#D73A49"}},"SkuInfoEntity"),r("span",{style:{color:"#24292E"}},"> infoFuture "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," CompletableFuture."),r("span",{style:{color:"#6F42C1"}},"supplyAsync"),r("span",{style:{color:"#24292E"}},"(() "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//1.sku基本信息获取 pms_sku_info")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            SkuInfoEntity info "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"this"),r("span",{style:{color:"#24292E"}},"."),r("span",{style:{color:"#6F42C1"}},"getById"),r("span",{style:{color:"#24292E"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            skuItemVo."),r("span",{style:{color:"#6F42C1"}},"setInfo"),r("span",{style:{color:"#24292E"}},"(info);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," info;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }, executor);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    CompletableFuture<"),r("span",{style:{color:"#D73A49"}},"Void"),r("span",{style:{color:"#24292E"}},"> saleAttrFuture "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," infoFuture."),r("span",{style:{color:"#6F42C1"}},"thenAcceptAsync"),r("span",{style:{color:"#24292E"}},"((res) "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//3、 获取spu的销售属性组合")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"SkuItemSaleAttrVo"),r("span",{style:{color:"#24292E"}},"> saleAttrVos "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," skuSaleAttrValueService."),r("span",{style:{color:"#6F42C1"}},"getSaleAttrBySpuId"),r("span",{style:{color:"#24292E"}},"(res."),r("span",{style:{color:"#6F42C1"}},"getSpuId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        skuItemVo."),r("span",{style:{color:"#6F42C1"}},"setSaleAttr"),r("span",{style:{color:"#24292E"}},"(saleAttrVos);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    CompletableFuture<"),r("span",{style:{color:"#D73A49"}},"Void"),r("span",{style:{color:"#24292E"}},"> descFuture "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," infoFuture."),r("span",{style:{color:"#6F42C1"}},"thenAcceptAsync"),r("span",{style:{color:"#24292E"}},"((res) "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//4.获取spu的介绍 pms_spu_info_desc")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        SpuInfoDescEntity spuInfoDescEntity "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," spuInfoDescService."),r("span",{style:{color:"#6F42C1"}},"getById"),r("span",{style:{color:"#24292E"}},"(res."),r("span",{style:{color:"#6F42C1"}},"getSpuId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        skuItemVo."),r("span",{style:{color:"#6F42C1"}},"setDesc"),r("span",{style:{color:"#24292E"}},"(spuInfoDescEntity);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    CompletableFuture<"),r("span",{style:{color:"#D73A49"}},"Void"),r("span",{style:{color:"#24292E"}},"> baseAttrFuture "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," infoFuture."),r("span",{style:{color:"#6F42C1"}},"thenAcceptAsync"),r("span",{style:{color:"#24292E"}},"((res) "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//5.获取spu的规格参数信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"SpuItemAttrGroupVo"),r("span",{style:{color:"#24292E"}},"> attrGroupVos "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," attrGroupService."),r("span",{style:{color:"#6F42C1"}},"getAttrGroupWithAttrsBySpuId"),r("span",{style:{color:"#24292E"}},"(res."),r("span",{style:{color:"#6F42C1"}},"getSpuId"),r("span",{style:{color:"#24292E"}},"(), res."),r("span",{style:{color:"#6F42C1"}},"getCatalogId"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        skuItemVo."),r("span",{style:{color:"#6F42C1"}},"setGroupAttrs"),r("span",{style:{color:"#24292E"}},"(attrGroupVos);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//一、创建异步对象")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"/*")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     runAsync和supplyAsync  runXxxx 都是没有返回结果的，supplyXxx 都是可以获取返回结果的")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     可以传入自定义的线程池，否则就用默认的线程池；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//2.sku图片信息  pms_spu_images")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    CompletableFuture<"),r("span",{style:{color:"#D73A49"}},"Void"),r("span",{style:{color:"#24292E"}},"> imageFuture "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," CompletableFuture."),r("span",{style:{color:"#6F42C1"}},"runAsync"),r("span",{style:{color:"#24292E"}},"(() "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        List<"),r("span",{style:{color:"#D73A49"}},"SkuImagesEntity"),r("span",{style:{color:"#24292E"}},"> imagesEntities "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," skuImagesService."),r("span",{style:{color:"#6F42C1"}},"getImagesBySkuId"),r("span",{style:{color:"#24292E"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        skuItemVo."),r("span",{style:{color:"#6F42C1"}},"setImages"),r("span",{style:{color:"#24292E"}},"(imagesEntities);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//TODO //3、远程调用查询当前sku是否参与秒杀优惠活动")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    CompletableFuture<"),r("span",{style:{color:"#D73A49"}},"Void"),r("span",{style:{color:"#24292E"}},"> seckillFuture "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," CompletableFuture."),r("span",{style:{color:"#6F42C1"}},"runAsync"),r("span",{style:{color:"#24292E"}},"(() "),r("span",{style:{color:"#D73A49"}},"->"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#6A737D"}},"//3.远程调用查询当前sku是否参与秒杀优惠活动")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        R skuSeckilInfo "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," seckillFeignService."),r("span",{style:{color:"#6F42C1"}},"getSkuSeckilInfo"),r("span",{style:{color:"#24292E"}},"(skuId);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (skuSeckilInfo."),r("span",{style:{color:"#6F42C1"}},"getCode"),r("span",{style:{color:"#24292E"}},"() "),r("span",{style:{color:"#D73A49"}},"=="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"0"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//查询成功")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            SeckillSkuVo skuSeckilInfoData "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," skuSeckilInfo."),r("span",{style:{color:"#6F42C1"}},"getData"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"data"'),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#D73A49"}},"new"),r("span",{style:{color:"#24292E"}}," TypeReference<"),r("span",{style:{color:"#D73A49"}},"SeckillSkuVo"),r("span",{style:{color:"#24292E"}},">() {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            });")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            skuItemVo."),r("span",{style:{color:"#6F42C1"}},"setSeckillSkuVo"),r("span",{style:{color:"#24292E"}},"(skuSeckilInfoData);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (skuSeckilInfoData "),r("span",{style:{color:"#D73A49"}},"!="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"long"),r("span",{style:{color:"#24292E"}}," currentTime "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," System."),r("span",{style:{color:"#6F42C1"}},"currentTimeMillis"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," (currentTime "),r("span",{style:{color:"#D73A49"}},">"),r("span",{style:{color:"#24292E"}}," skuSeckilInfoData."),r("span",{style:{color:"#6F42C1"}},"getEndTime"),r("span",{style:{color:"#24292E"}},"()) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                    skuItemVo."),r("span",{style:{color:"#6F42C1"}},"setSeckillSkuVo"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"null"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    }, executor);")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//七、多任务组合")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"/*")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    allOf：等待所有任务完成")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    anyOf：只要有一个任务完成")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"     */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//等到所有任务完成  //TODO 秒杀优惠活动Future")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    CompletableFuture."),r("span",{style:{color:"#6F42C1"}},"allOf"),r("span",{style:{color:"#24292E"}},"(saleAttrFuture,descFuture,baseAttrFuture,imageFuture,seckillFuture)."),r("span",{style:{color:"#6F42C1"}},"get"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," skuItemVo;")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),On={id:"rabbitmq延时队列-实现定时任务",tabindex:"-1"},Tn={id:"场景",tabindex:"-1"},_n=r("figure",null,[r("img",{alt:"image-20230322165119843",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230322165119843.png"})],-1),Rn=r("ul",null,[r("li",null,[r("p",null,"比如未付款订单，超过一定时间后，系统自动取消订单并释放占有物品。")]),r("li",null,[r("p",null,"常用解决方案：spring的 schedule 定时任务轮询数据库"),r("ul",null,[r("li",null,[r("p",null,"缺点：消耗系统内存、增加了数据库的压力、存在较大的时间误差")]),r("li",null,[r("p",null,"定时任务的时效性问题"),r("p",null,"定时任务开启的第一次扫描，订单未创建，1min后创建完成，30min第二次扫描订单未过期，无事发生，31min订单过期，直到60min第三次扫描才扫到过期订单"),r("figure",null,[r("img",{alt:"image-20230322165931065",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230322165931065.png"})])])])]),r("li",null,[r("p",null,"解决：rabbitmq的消息TTL和死信Exchange结合")]),r("li",null,[r("p",null,"订单释放&库存解锁")])],-1),Ln=r("figure",null,[r("img",{alt:"image-20230410190115962",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410190115962.png"})],-1),wn={id:"消息的ttl-time-to-live",tabindex:"-1"},qn=r("ul",null,[r("li",null,"消息的TTL就是消息的存活时间。"),r("li",null,"RabbitMQ可以对队列和消息分别设置TTL。"),r("li",null,[c("对队列设置就是队列没有消费者连着的保留时间，"),r("strong",null,"也可以对每一个单独的消息做单独的"),r("strong",null,"设置。超过了这个时间，我们认为这个消息就死了，称之为死信"),c("。")]),r("li",null,[c("如果队列设置了，消息也设置了，那么会"),r("strong",null,"取小的"),c("。所以一个消息如果被路由到不同的队 列中，这个消息死亡的时间有可能不一样（不同的队列设置）。这里单讲单个消息的 TTL，因为它才是实现延迟任务的关键。可以通过"),r("strong",null,"设置消息的expiration字段或者x-"),r("strong",null,"message-ttl属性来设置时间"),c("，两者是一样的效果。")])],-1),Pn={id:"dead-letter-exchanges-dlx",tabindex:"-1"},Vn=r("ul",null,[r("li",null,[r("p",null,"一个消息在满足如下条件下，会进"),r("p",null,"死信路由"),r("p",null,"，记住这里是路由而不是队列，"),r("p",null,"一个路由可以对应很多队列。（什么是死信）"),r("ul",null,[r("li",null,"一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不 会被再次放在队列里，被其他消费者使用。 （ basic.reject/ basic.nack ） requeue=false"),r("li",null,"上面的消息的TTL到了，消息过期了。"),r("li",null,"队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上")])]),r("li",null,[r("p",null,"Dead Letter Exchange其实就是一种普通的exchange，和创建其他 exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有 消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。")]),r("li",null,[r("p",null,"我们既可以控制消息在一段时间后变成死信，又可以控制变成死信的消息 被路由到某一个指定的交换机，结合二者，其实就可以实现一个延时队列")]),r("li",null,[r("p",null,"手动ack&异常消息统一放在一个队列处理建议的两种方式")]),r("li",null,[r("p",null,"catch异常后，手动发送到指定队列，然后使用channel给rabbitmq确认消息已消费")]),r("li",null,[r("p",null,"给Queue绑定死信队列，使用nack（requque为false）确认消息消费失败")])],-1),Mn={id:"延时队列实现",tabindex:"-1"},jn=r("ul",null,[r("li",null,"给队列设置过期时间")],-1),Nn=r("figure",null,[r("img",{alt:"image-20230322152334742",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230322152334742.png"})],-1),Wn=r("ul",null,[r("li",null,"给消息设置过期时间")],-1),Kn=r("figure",null,[r("img",{alt:"image-20230322152358754",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230322152358754.png"})],-1),zn=r("ul",null,[r("li",null,"推荐：给队列设置过期时间，因为给消息设置过期时间的话，RabbitMQ采用的是惰性检查机制，假设队列里面的消息过期时间不同，后面的消息必须等前面的消息过期，最终导致消息不能按照规定的过期时间过期。")],-1),Hn={id:"springboot中使用延时队列",tabindex:"-1"},Qn=r("ul",null,[r("li",null,"1、Queue、Exchange、Binding可以@Bean进去"),r("li",null,[c("2、监听消息的方法可以有三种参数（不分数量，顺序） "),r("ul",null,[r("li",null,"Object content, Message message, Channel channel")])]),r("li",null,"3、channel可以用来拒绝消息，否则自动ack；")],-1),Un={id:"消息队列流程",tabindex:"-1"},Gn=r("ul",null,[r("li",null,"使用RabbitMQ延时队列实现未付款订单，超过一定时间后，系统自动取消订单并解锁库存。"),r("li",null,"PS:创建订单 进入路由键-order.create.order- 进入交换机order-event-exchange， 根据路由键会转发到延时队列order.delay.queue 1min过期时间，过期时间到了之后，根据路由键order.release.order-到达释放订单队列order.release.order.queue， 监听这个队列的方法 先是判断订单是不是已支付，如果不是 就关闭订单，关闭订单之后，根据路由键order.release.other 发送关闭的订单数据到交换机order-event-exchange，交换机再转发到order.release.coupon.queue优惠券队列，返回优惠券，与之通过 也是根据路由键order.release.other，和数据一起转发到解锁库存队列stock.release.stock.queue 解锁库存。")],-1),Xn=r("figure",null,[r("img",{alt:"image-20230416235749443",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230416235749443.png"})],-1),Jn={id:"redis缓存中的数据结构",tabindex:"-1"},$n={id:"分类菜单",tabindex:"-1"},Yn=r("ul",null,[r("li",null,"类型：String"),r("li",null,"value: 菜单信息")],-1),Zn={id:"登陆信息-springsession",tabindex:"-1"},le={id:"购物车",tabindex:"-1"},se=r("ul",null,[r("li",null,"类型：Hash"),r("li",null,"key: gulimall:cart:2 // 2为用户ID"),r("li",null,"field: 商品 id"),r("li",null,"value: 购物项数据"),r("li",null,[c("综上所述，我们的购物车结构是一个双层 Map：Map<String,Map<String,String>> "),r("ul",null,[r("li",null,"第一层 Map，Key 是用户 id"),r("li",null,"第二层 Map，Key 是购物车中商品 id，值是购物项数据")])])],-1),oe={id:"秒杀上架-幂等性处理",tabindex:"-1"},ne=r("ul",null,[r("li",null,[c("缓存秒杀活动信息 (seckill:session:) "),r("ul",null,[r("li",null,"类型: List"),r("li",null,"key: seckill:session:start_endtime // 开始时间的时间戳_结束时间的时间戳"),r("li",null,"value: 场次ID_商品ID")])]),r("li",null,[c("缓存秒杀活动所关联的商品信息 (seckill:skus) "),r("ul",null,[r("li",null,"类型：Hash"),r("li",null,"key: seckill:skus"),r("li",null,"field: 场次ID_商品ID"),r("li",null,"value: 秒杀商品信息")])]),r("li",null,[c("秒杀库存信号量 "),r("ul",null,[r("li",null,"类型： String"),r("li",null,"key: seckIll:stock:UUID"),r("li",null,"value: 库存数量")])])],-1),ee={id:"幂等性保证",tabindex:"-1"},ae=r("ul",null,[r("li",null,"缓存商品信息前，先判断有没有这个key")],-1),te=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    String redisKey "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," seckillSkuVo."),r("span",{style:{color:"#B392F0"}},"getPromotionSessionId"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"toString"),r("span",{style:{color:"#E1E4E8"}},"() "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"-"'),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," seckillSkuVo."),r("span",{style:{color:"#B392F0"}},"getSkuId"),r("span",{style:{color:"#E1E4E8"}},"()."),r("span",{style:{color:"#B392F0"}},"toString"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," ("),r("span",{style:{color:"#F97583"}},"!"),r("span",{style:{color:"#E1E4E8"}},"operations."),r("span",{style:{color:"#B392F0"}},"hasKey"),r("span",{style:{color:"#E1E4E8"}},"(redisKey)) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"              "),r("span",{style:{color:"#6A737D"}},"//判断Redis中是否有该信息，如果没有才进行添加")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                Boolean hasKey "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," redisTemplate."),r("span",{style:{color:"#B392F0"}},"hasKey"),r("span",{style:{color:"#E1E4E8"}},"(key);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#6A737D"}},"//缓存活动信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                "),r("span",{style:{color:"#F97583"}},"if"),r("span",{style:{color:"#E1E4E8"}}," ("),r("span",{style:{color:"#F97583"}},"!"),r("span",{style:{color:"#E1E4E8"}},"hasKey) {")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    String redisKey "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," seckillSkuVo."),r("span",{style:{color:"#6F42C1"}},"getPromotionSessionId"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"toString"),r("span",{style:{color:"#24292E"}},"() "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"-"'),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," seckillSkuVo."),r("span",{style:{color:"#6F42C1"}},"getSkuId"),r("span",{style:{color:"#24292E"}},"()."),r("span",{style:{color:"#6F42C1"}},"toString"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," ("),r("span",{style:{color:"#D73A49"}},"!"),r("span",{style:{color:"#24292E"}},"operations."),r("span",{style:{color:"#6F42C1"}},"hasKey"),r("span",{style:{color:"#24292E"}},"(redisKey)) {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"              "),r("span",{style:{color:"#6A737D"}},"//判断Redis中是否有该信息，如果没有才进行添加")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                Boolean hasKey "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," redisTemplate."),r("span",{style:{color:"#6F42C1"}},"hasKey"),r("span",{style:{color:"#24292E"}},"(key);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#6A737D"}},"//缓存活动信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                "),r("span",{style:{color:"#D73A49"}},"if"),r("span",{style:{color:"#24292E"}}," ("),r("span",{style:{color:"#D73A49"}},"!"),r("span",{style:{color:"#24292E"}},"hasKey) {")])])]),r("button",{class:"collapse"})],-1),re={id:"redission分布式锁",tabindex:"-1"},ce=r("ul",null,[r("li",null,"设置分布式锁以及信号量-关键代码")],-1),pe=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#6A737D"}},"//秒杀商品上架功能的锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    "),r("span",{style:{color:"#F97583"}},"private"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"final"),r("span",{style:{color:"#E1E4E8"}}," String upload_lock "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"seckill:upload:lock"'),r("span",{style:{color:"#E1E4E8"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"    ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  "),r("span",{style:{color:"#6A737D"}},"//分布式锁 .可重入锁（Reentrant Lock）")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        RLock lock "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," redissonClient."),r("span",{style:{color:"#B392F0"}},"getLock"),r("span",{style:{color:"#E1E4E8"}},"(upload_lock);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        "),r("span",{style:{color:"#F97583"}},"try"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            "),r("span",{style:{color:"#6A737D"}},"//加锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            lock."),r("span",{style:{color:"#B392F0"}},"lock"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"10"),r("span",{style:{color:"#E1E4E8"}},", TimeUnit.SECONDS);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            seckillService."),r("span",{style:{color:"#B392F0"}},"uploadSeckillSkuLatest3Days"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }"),r("span",{style:{color:"#F97583"}},"catch"),r("span",{style:{color:"#E1E4E8"}}," (Exception "),r("span",{style:{color:"#FFAB70"}},"e"),r("span",{style:{color:"#E1E4E8"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            e."),r("span",{style:{color:"#B392F0"}},"printStackTrace"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }"),r("span",{style:{color:"#F97583"}},"finally"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            lock."),r("span",{style:{color:"#B392F0"}},"unlock"),r("span",{style:{color:"#E1E4E8"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"          "),r("span",{style:{color:"#6A737D"}},"//如果当前这个场次的商品库存信息已经上架就不需要上架")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                        "),r("span",{style:{color:"#6A737D"}},"//5、使用库存作为分布式Redisson信号量（限流）")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                        "),r("span",{style:{color:"#6A737D"}},"// 使用库存作为分布式信号量")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                        RSemaphore semaphore "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," redissonClient."),r("span",{style:{color:"#B392F0"}},"getSemaphore"),r("span",{style:{color:"#E1E4E8"}},"(SKU_STOCK_SEMAPHORE "),r("span",{style:{color:"#F97583"}},"+"),r("span",{style:{color:"#E1E4E8"}}," token);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                        "),r("span",{style:{color:"#6A737D"}},"// 商品可以秒杀的数量作为信号量")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"                        semaphore."),r("span",{style:{color:"#B392F0"}},"trySetPermits"),r("span",{style:{color:"#E1E4E8"}},"(seckillSkuVo."),r("span",{style:{color:"#B392F0"}},"getSeckillCount"),r("span",{style:{color:"#E1E4E8"}},"());")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#6A737D"}},"//秒杀商品上架功能的锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    "),r("span",{style:{color:"#D73A49"}},"private"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"final"),r("span",{style:{color:"#24292E"}}," String upload_lock "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"seckill:upload:lock"'),r("span",{style:{color:"#24292E"}},";")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"    ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  "),r("span",{style:{color:"#6A737D"}},"//分布式锁 .可重入锁（Reentrant Lock）")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        RLock lock "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," redissonClient."),r("span",{style:{color:"#6F42C1"}},"getLock"),r("span",{style:{color:"#24292E"}},"(upload_lock);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        "),r("span",{style:{color:"#D73A49"}},"try"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            "),r("span",{style:{color:"#6A737D"}},"//加锁")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            lock."),r("span",{style:{color:"#6F42C1"}},"lock"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"10"),r("span",{style:{color:"#24292E"}},", TimeUnit.SECONDS);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            seckillService."),r("span",{style:{color:"#6F42C1"}},"uploadSeckillSkuLatest3Days"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }"),r("span",{style:{color:"#D73A49"}},"catch"),r("span",{style:{color:"#24292E"}}," (Exception "),r("span",{style:{color:"#E36209"}},"e"),r("span",{style:{color:"#24292E"}},"){")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            e."),r("span",{style:{color:"#6F42C1"}},"printStackTrace"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }"),r("span",{style:{color:"#D73A49"}},"finally"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            lock."),r("span",{style:{color:"#6F42C1"}},"unlock"),r("span",{style:{color:"#24292E"}},"();")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"          "),r("span",{style:{color:"#6A737D"}},"//如果当前这个场次的商品库存信息已经上架就不需要上架")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                        "),r("span",{style:{color:"#6A737D"}},"//5、使用库存作为分布式Redisson信号量（限流）")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                        "),r("span",{style:{color:"#6A737D"}},"// 使用库存作为分布式信号量")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                        RSemaphore semaphore "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," redissonClient."),r("span",{style:{color:"#6F42C1"}},"getSemaphore"),r("span",{style:{color:"#24292E"}},"(SKU_STOCK_SEMAPHORE "),r("span",{style:{color:"#D73A49"}},"+"),r("span",{style:{color:"#24292E"}}," token);")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                        "),r("span",{style:{color:"#6A737D"}},"// 商品可以秒杀的数量作为信号量")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"                        semaphore."),r("span",{style:{color:"#6F42C1"}},"trySetPermits"),r("span",{style:{color:"#24292E"}},"(seckillSkuVo."),r("span",{style:{color:"#6F42C1"}},"getSeckillCount"),r("span",{style:{color:"#24292E"}},"());")])])]),r("button",{class:"collapse"})],-1),ye={id:"分布式事务",tabindex:"-1"},Ee=r("figure",null,[r("img",{alt:"image-20230322165148070",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230322165148070.png"})],-1),ie=r("ul",null,[r("li",null,[r("strong",null,"事务保证：")])],-1),ue=r("ol",null,[r("li",null,"订单服务异常，库存锁定不运行，全部回滚，撤销操作"),r("li",null,"库存服务事务自治，锁定失败全部回滚，订单感受到，继续回滚"),r("li",null,"库存服务锁定成功了，但是网络原因返回数据途中问题？"),r("li",null,"库存服务锁定成功了，库存服务下面的逻辑发生故障，订单回滚了，怎么处理？")],-1),de=r("ul",null,[r("li",null,[r("strong",null,"利用消息队列实现最终一致")])],-1),ge=r("p",null,"库存服务锁定成功后发给消息队列消息（当前库存工作单），过段时间自动解锁，解锁时先查询订单的支付状态。解锁成功修改库存工作单详情项状态为已解锁",-1),Fe=r("ul",null,[r("li",null,[c("1、远程服务假失败： "),r("ul",null,[r("li",null,"远程服务其实成功了，由于网络故障等没有返回"),r("li",null,"导致：订单回滚，库存却扣减")])]),r("li",null,[c("2、远程服务执行完成，下面的其他方法出现问题 "),r("ul",null,[r("li",null,"导致：已执行的远程请求，肯定不能回滚")])])],-1),Ae={id:"事务的坑",tabindex:"-1"},me=r("ul",null,[r("li",null,"在同一个类里面，编写两个方法，内部调用的时候，会导致事务设置失效。原因是没有用到代理对象的缘故。"),r("li",null,[c("解决： "),r("ul",null,[r("li",null,"0）、导入 spring-boot-starter-aop"),r("li",null,"1）、@EnableTransactionManagement(proxyTargetClass = true)"),r("li",null,"2）、@EnableAspectJAutoProxy(exposeProxy=true)"),r("li",null,"3）、AopContext.currentProxy() 调用方法")])])],-1),De={id:"cap理论",tabindex:"-1"},he=r("ul",null,[r("li",null,[c("C是"),r("strong",null,"一致性"),c("，分布式系统的"),r("strong",null,"数据要保持一致")]),r("li",null,[c("A是"),r("strong",null,"可用性"),c("，分布式系统能进行"),r("strong",null,"故障转移")]),r("li",null,[c("P是"),r("strong",null,"分区容错性"),c("，分布式系统"),r("strong",null,"出现网络问题能正常运行")]),r("li",null,"CAP理论是指分布式系统中不能保证三者同时存在，只能两两组合")],-1),ke={id:"base-理论",tabindex:"-1"},be=r("ul",null,[r("li",null,[c("是对 CAP 理论的延伸，思想是即使无法做到强一致性（CAP 的一致性就是强一致性），但可 以采用适当的采取弱一致性，即"),r("strong",null,"最终一致性。")])],-1),Ce={id:"分布式事务几种方案",tabindex:"-1"},Se=r("ul",null,[r("li",null,[c("2PC 模式 "),r("ul",null,[r("li",null,[c("数据库支持的 2PC【2 phase commit 二阶提交】，又叫做 XA Transactions。 "),r("ul",null,[r("li",null,"第一阶段：事务协调器要求每个涉及到事务的数据库预提交(precommit)此操作，并反映是 否可以提交."),r("li",null,"第二阶段：事务协调器要求每个数据库提交数据。")])]),r("li",null,[r("strong",null,"性能不理想")])])]),r("li",null,[c("柔性事务-TCC 事务补偿型方案 "),r("ul",null,[r("li",null,"一阶段 prepare 行为：调用 自定义 的 prepare 逻辑。"),r("li",null,"二阶段 commit 行为：调用 自定义 的 commit 逻辑。"),r("li",null,"二阶段 rollback 行为：调用 自定义 的 rollback 逻辑。"),r("li",null,"所谓 TCC 模式，是指支持把 自定义 的分支事务纳入到全局事务的管理中")])]),r("li",null,[c("柔性事务-最大努力通知型方案 "),r("ul",null,[r("li",null,[c("按规律进行通知，"),r("strong",null,"不保证数据一定能通知成功，但会提供可查询操作接口进行核对"),c("。")]),r("li",null,"这种 方案主要用在与第三方系统通讯时，比如：调用微信或支付宝支付后的支付结果通知。"),r("li",null,"这种 方案也是结合 MQ 进行实现，例如：通过 MQ 发送 http 请求，设置最大通知次数。达到通知次数后即不再通知。")])]),r("li",null,[c("柔性事务-"),r("strong",null,"可靠消息"),c("+最终一致性方案（异步确保型） "),r("ul",null,[r("li",null,"实现：业务处理服务在业务事务提交之前，向实时消息服务请求发送消息，实时消息服务只 记录消息数据，而不是真正的发送。业务处理服务在业务事务提交之后，向实时消息服务确 认发送。只有在得到确认发送指令后，实时消息服务才会真正发送。"),r("li",null,[c("防止消息丢失： "),r("ul",null,[r("li",null,"1、做好消息确认机制（pulisher，consumer【手动 ack】）"),r("li",null,"2、每一个发送的消息都在数据库做好记录。定期将失败的消息再次发送一 遍")])])])])],-1),Be=r("blockquote",null,[r("p",null,"刚性事务：遵循 ACID 原则，强一致性。"),r("p",null,"柔性事务：遵循 BASE 理论，最终一致性；"),r("p",null,"与刚性事务不同，柔性事务允许一定时间内，不同节点的数据不一致，但要求最终一致。")],-1),fe={id:"seata",tabindex:"-1"},ve={id:"seata的理解",tabindex:"-1"},xe=r("ul",null,[r("li",null,[c("Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。 "),r("ul",null,[r("li",null,[c("AT模式。是一种基于"),r("strong",null,"本地事务+二阶段协议"),c("来实现的"),r("strong",null,"最终数据一致性方案"),c("，也是Seata默认的解决方案。")]),r("li",null,[c("TCC模式，TCC事务是Try,Confirm,Cancel 三个词语的缩写，简单理解就是把"),r("strong",null,"一个完整的业务逻辑拆分成三个阶段"),c("，然后通过事务管理器在业务逻辑层面，根据每个分支事务的执行情况分别调用该业务的Confirm 或者Cacel方法。")]),r("li",null,[c("Saga模式，Saga模式是SEATA提供"),r("strong",null,"长事务解决方案"),c("，在Saga模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者。")]),r("li",null,[c("XA模式，XA可以认为是一种"),r("strong",null,"强一致性的事务解决方法"),c("，它利用事务资源（数据库，消息服务等）对XA协议的支持，以XA协议的机制来管理分支事务的一种事务模式。")])])])],-1),Ie={id:"tc-transaction-coordinator-事务协调者",tabindex:"-1"},Oe=r("ul",null,[r("li",null,"维护全局和分支事务的状态，驱动全局事务提交或回滚。")],-1),Te={id:"tm-transaction-manager-事务管理器",tabindex:"-1"},_e=r("ul",null,[r("li",null,"定义全局事务的范围：开始全局事务、提交或回滚全局事务。")],-1),Re={id:"rm-resource-manager-资源管理器",tabindex:"-1"},Le=r("ul",null,[r("li",null,"管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。")],-1),we=r("figure",null,[r("img",{alt:"image-20230322152804762",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230322152804762.png"})],-1),qe={id:"seata项目整合",tabindex:"-1"},Pe=r("li",null,"Seata控制分布式事务",-1),Ve=r("li",null,"1）、每一个微服务先必须创建 undo_log；",-1),Me=r("li",null,"1、导入依赖 spring-cloud-starter-alibaba-seata seata-all-0.7.1",-1),je=r("li",null,[c("2、解压并启动seata-server； "),r("ul",null,[r("li",null,"registry.conf: 注册中心配置； 修改registry type=nacos"),r("li",null,"file.conf：")])],-1),Ne=r("li",null,"3、所有想要用到分布式事务的微服务使用seata DataSourceProxy代理自己的数据源",-1),We=r("li",null,"registry.conf",-1),Ke=r("li",null,"5、启动测试分布式事务",-1),ze=r("li",null,"6、给分布式大事务的入口标注@GlobalTransactional",-1),He=r("li",null,"7、每一个远程的小事务用 @Transactional",-1),Qe=r("p",null,"应用场景：",-1),Ue=r("ul",null,[r("li",null,[c("订单服务提交订单，库存服务扣减库存 "),r("ul",null,[r("li",null,"seta-提交订单接口 OrderServiceImpl 类submitOrder（）方法 加 @GlobalTransactional"),r("li",null,"（下单是高并发场景，不推荐seata分布式事务。推荐用消息队列 最终一致性）")])]),r("li",null,"商品服务保持商品信息，远程调用优惠服务保持商品优惠券信息"),r("li",null,[r("ul",null,[r("li",null,"开启seta全局事务-SpuInfoServiceImpl类saveSpuInfo()方法 （推荐）")])])],-1),Ge={id:"sentinel",tabindex:"-1"},Xe={id:"sentinel理解",tabindex:"-1"},Je=r("ul",null,[r("li",null,[c("随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从"),r("strong",null,"流量控制、熔断降级"),c("、系统负载保护等多个维度保护服务的稳定性。")]),r("li",null,[c("我们说的资源，可以是任何东西，服务，服务里的方法，甚至是一段代码。使用 Sentinel 来进行资源保护，主要分为几个步骤: "),r("ol",null,[r("li",null,"定义资源"),r("li",null,"定义规则"),r("li",null,"检验规则是否生效")])]),r("li",null,[c("Sentinel 分为两个部分: "),r("ul",null,[r("li",null,"核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时 对 Dubbo / Spring Cloud 等框架也有较好的支持。"),r("li",null,"控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器")])])],-1),$e={id:"熔断降级限流",tabindex:"-1"},Ye=r("ul",null,[r("li",null,[c("熔断 "),r("ul",null,[r("li",null,"A 服务调用 B 服务的某个功能，B服务卡死，功能时间超长，我们就将B断路，返回降级数据。")])]),r("li",null,[c("降级 "),r("ul",null,[r("li",null,"流量高峰期，服务器压力剧增，对一些页面和服务做策略的降级（停止服务，调用直接返回降级数据）")])]),r("li",null,[c("熔断、降级区别 "),r("ul",null,[r("li",null,[c("相同点 "),r("ul",null,[r("li",null,"保证服务的可用性")])]),r("li",null,[c("不同点 "),r("ul",null,[r("li",null,"1、熔断是被调用方故障，触发的系统主动规则"),r("li",null,"2、降级是基于全局考虑，停止一些正常服务，释放资源")])])])]),r("li",null,[c("限流 "),r("ul",null,[r("li",null,"对打入服务的请求流量进行控制，使服务能够承担不超过自己能力的流量压力")])])],-1),Ze={id:"项目整合步骤",tabindex:"-1"},la=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1、整合Sentinel")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1）、导入依赖 spring-cloud-starter-alibaba-sentinel")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、下载sentinel的控制台")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3）、配置sentinel控制台地址信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 4) 、在控制台调整参数。【默认所有的流控设置保存在内存中，重启失效】")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"      *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"       *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2、每一个微服务都导入 actuator ()；并配合management.endpoints.web.exposure.include=*")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3、自定义sentinel流控返回数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 4、使用Sentinel来保护feign远程调用：熔断；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1）、调用方的熔断保护：feign.sentinel.enabled=true")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、调用方手动指定远程服务的降级策略。远程服务被降级处理。触发我们的熔断回调方法")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3）、超大浏览的时候，必须牺牲一些远程服务。在服务的提供方（远程服务）指定降级策略；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 提供方是在运行。但是不运行自己的业务逻辑，返回的是默认的降级数据（限流的数据），")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 5、自定义受保护的资源")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1）、代码")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},' * try(Entry entry = SphU.entry("seckillSkus")){')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * //业务逻辑")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * catch(Execption e){}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、基于注解。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},' * @SentinelResource(value = "getCurrentSeckillSkusResource",blockHandler = "blockHandler")')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 无论是1,2方式一定要配置被限流以后的默认返回.")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * url请求可以设置统一返回:WebCallbackManager")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    */")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1、整合Sentinel")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1）、导入依赖 spring-cloud-starter-alibaba-sentinel")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、下载sentinel的控制台")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3）、配置sentinel控制台地址信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 4) 、在控制台调整参数。【默认所有的流控设置保存在内存中，重启失效】")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"      *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"       *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2、每一个微服务都导入 actuator ()；并配合management.endpoints.web.exposure.include=*")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3、自定义sentinel流控返回数据")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 4、使用Sentinel来保护feign远程调用：熔断；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1）、调用方的熔断保护：feign.sentinel.enabled=true")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、调用方手动指定远程服务的降级策略。远程服务被降级处理。触发我们的熔断回调方法")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3）、超大浏览的时候，必须牺牲一些远程服务。在服务的提供方（远程服务）指定降级策略；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 提供方是在运行。但是不运行自己的业务逻辑，返回的是默认的降级数据（限流的数据），")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 5、自定义受保护的资源")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1）、代码")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},' * try(Entry entry = SphU.entry("seckillSkus")){')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * //业务逻辑")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * catch(Execption e){}")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、基于注解。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},' * @SentinelResource(value = "getCurrentSeckillSkusResource",blockHandler = "blockHandler")')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 无论是1,2方式一定要配置被限流以后的默认返回.")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * url请求可以设置统一返回:WebCallbackManager")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    */")])])]),r("button",{class:"collapse"})],-1),sa={id:"整合-feign-sentinel-测试熔断降级",tabindex:"-1"},oa=r("li",null,[r("p",null,"引入依赖：>spring-cloud-starter-openfeign、spring-cloud-starter-alibaba-sentinel<")],-1),na=r("li",null,[r("p",null,"2、使用 Nacos 注册中心 spring-cloud-starter-alibaba-nacos-discovery")],-1),ea=r("li",null,[r("p",null,"定义 fallbackfactory 并放在容器中"),r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    * @Author zly")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    * @Date 2022/7/26 16:22")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"      */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"      @"),r("span",{style:{color:"#F97583"}},"Slf4j")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"      @"),r("span",{style:{color:"#F97583"}},"Component")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"      "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"class"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"SeckillFeignServiceFallBack"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"implements"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"SeckillFeignService"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"   ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"      @"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"      "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," R "),r("span",{style:{color:"#B392F0"}},"getSkuSeckilInfo"),r("span",{style:{color:"#E1E4E8"}},"(Long "),r("span",{style:{color:"#FFAB70"}},"skuId"),r("span",{style:{color:"#E1E4E8"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"          log."),r("span",{style:{color:"#B392F0"}},"info"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"熔断方法调用.."'),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"          "),r("span",{style:{color:"#F97583"}},"return"),r("span",{style:{color:"#E1E4E8"}}," R."),r("span",{style:{color:"#B392F0"}},"error"),r("span",{style:{color:"#E1E4E8"}},"(BizCodeEnum.TO_MANY_REQUEST."),r("span",{style:{color:"#B392F0"}},"getCode"),r("span",{style:{color:"#E1E4E8"}},"(),BizCodeEnum.TO_MANY_REQUEST."),r("span",{style:{color:"#B392F0"}},"getMessage"),r("span",{style:{color:"#E1E4E8"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"      }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  }")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    * @Author zly")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"    * @Date 2022/7/26 16:22")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"      */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"      @"),r("span",{style:{color:"#D73A49"}},"Slf4j")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"      @"),r("span",{style:{color:"#D73A49"}},"Component")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"      "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"class"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"SeckillFeignServiceFallBack"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"implements"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"SeckillFeignService"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"   ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"      @"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"      "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," R "),r("span",{style:{color:"#6F42C1"}},"getSkuSeckilInfo"),r("span",{style:{color:"#24292E"}},"(Long "),r("span",{style:{color:"#E36209"}},"skuId"),r("span",{style:{color:"#24292E"}},") {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"          log."),r("span",{style:{color:"#6F42C1"}},"info"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"熔断方法调用.."'),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"          "),r("span",{style:{color:"#D73A49"}},"return"),r("span",{style:{color:"#24292E"}}," R."),r("span",{style:{color:"#6F42C1"}},"error"),r("span",{style:{color:"#24292E"}},"(BizCodeEnum.TO_MANY_REQUEST."),r("span",{style:{color:"#6F42C1"}},"getCode"),r("span",{style:{color:"#24292E"}},"(),BizCodeEnum.TO_MANY_REQUEST."),r("span",{style:{color:"#6F42C1"}},"getMessage"),r("span",{style:{color:"#24292E"}},"());")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"      }")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  }")])])]),r("button",{class:"collapse"})])],-1),aa=r("li",null,[r("p",null,"远程接口配置 feign 客户端容错"),r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"  /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   * @Author zly")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   * @Date 2022/7/26 16:21")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  @"),r("span",{style:{color:"#F97583"}},"FeignClient"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"value"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"gulimall-seckill"'),r("span",{style:{color:"#E1E4E8"}},","),r("span",{style:{color:"#79B8FF"}},"fallback"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," SeckillFeignServiceFallBack.class)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  "),r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"interface"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"SeckillFeignService"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"      /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"       * 根据skuId查询商品是否参加秒杀活动")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"       * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"skuId")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"       * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"       */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"      @"),r("span",{style:{color:"#F97583"}},"GetMapping"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"value"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"/sku/seckill/{skuId}"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"      R "),r("span",{style:{color:"#B392F0"}},"getSkuSeckilInfo"),r("span",{style:{color:"#E1E4E8"}},"(@"),r("span",{style:{color:"#F97583"}},"PathVariable"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"skuId"'),r("span",{style:{color:"#E1E4E8"}},") Long "),r("span",{style:{color:"#FFAB70"}},"skuId"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  }")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"  /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   * @Author zly")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   * @Date 2022/7/26 16:21")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"   */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  @"),r("span",{style:{color:"#D73A49"}},"FeignClient"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"value"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"gulimall-seckill"'),r("span",{style:{color:"#24292E"}},","),r("span",{style:{color:"#005CC5"}},"fallback"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," SeckillFeignServiceFallBack.class)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  "),r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"interface"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"SeckillFeignService"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"      /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"       * 根据skuId查询商品是否参加秒杀活动")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"       * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"skuId")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"       * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"       */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"      @"),r("span",{style:{color:"#D73A49"}},"GetMapping"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"value"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"/sku/seckill/{skuId}"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"      R "),r("span",{style:{color:"#6F42C1"}},"getSkuSeckilInfo"),r("span",{style:{color:"#24292E"}},"(@"),r("span",{style:{color:"#D73A49"}},"PathVariable"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"skuId"'),r("span",{style:{color:"#24292E"}},") Long "),r("span",{style:{color:"#E36209"}},"skuId"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  }")])])]),r("button",{class:"collapse"})])],-1),ta=r("p",null,"开启 sentinel 代理 feign 功能；在 application.properties 中配置",-1),ra=r("ul",null,[r("li",null,"feign.sentinel.enabled=true")],-1),ca=r("p",null,"1、使用@SentinelResource，并定义 fallback",-1),pa=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"SentinelResource"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#79B8FF"}},"value"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"getCurrentSeckillSkusResource"'),r("span",{style:{color:"#E1E4E8"}},","),r("span",{style:{color:"#79B8FF"}},"blockHandler"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"="),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#9ECBFF"}},'"blockHandler"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," List"),r("span",{style:{color:"#F97583"}},"<"),r("span",{style:{color:"#E1E4E8"}},"SeckillSkuRedisTo"),r("span",{style:{color:"#F97583"}},">"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"getCurrentSeckillSkus"),r("span",{style:{color:"#E1E4E8"}},"() {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"SentinelResource"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#005CC5"}},"value"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"getCurrentSeckillSkusResource"'),r("span",{style:{color:"#24292E"}},","),r("span",{style:{color:"#005CC5"}},"blockHandler"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"="),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#032F62"}},'"blockHandler"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"Override")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," List"),r("span",{style:{color:"#D73A49"}},"<"),r("span",{style:{color:"#24292E"}},"SeckillSkuRedisTo"),r("span",{style:{color:"#D73A49"}},">"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"getCurrentSeckillSkus"),r("span",{style:{color:"#24292E"}},"() {")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})],-1),ya={id:"nacos",tabindex:"-1"},Ea={id:"项目整合",tabindex:"-1"},ia=r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1、如何使用Nacos作为配置中心统一管理配置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1）、引入依赖，")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         <dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <groupId>com.alibaba.cloud</groupId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         </dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、创建一个bootstrap.properties。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      spring.application.name=gulimall-coupon")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      spring.cloud.nacos.config.server-addr=127.0.0.1:8848")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3）、需要给配置中心默认添加一个叫 数据集（Data Id）gulimall-coupon.properties。默认规则，应用名.properties")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 4）、给 应用名.properties 添加任何配置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 5）、动态获取配置。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      @RefreshScope：动态获取并刷新配置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},' *      @Value("${配置项的名}")：获取到配置。')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      如果配置中心和当前应用的配置文件中都配置了相同的项，优先使用配置中心的配置。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2、细节")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  1）、命名空间：配置隔离；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      默认：public(保留空间)；默认新增的所有配置都在public空间。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      1、开发，测试，生产：利用命名空间来做环境隔离。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         注意：在bootstrap.properties；配置上，需要使用哪个命名空间下的配置，")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         spring.cloud.nacos.config.namespace=9de62e44-cd2a-4a82-bf5c-95878bd5e871")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      2、每一个微服务之间互相隔离配置，每一个微服务都创建自己的命名空间，只加载自己命名空间下的所有配置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  2）、配置集：所有的配置的集合")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  3）、配置集ID：类似文件名。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      Data ID：类似文件名")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  4）、配置分组：")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      默认所有的配置集都属于：DEFAULT_GROUP；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      1111，618，1212")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 项目中的使用：每个微服务创建自己的命名空间，使用配置分组区分环境，dev，test，prod")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3、同时加载多个配置集")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1)、微服务任何配置信息，任何配置文件都可以放在配置中心中")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、只需要在bootstrap.properties说明加载配置中心中哪些配置文件即可")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3）、@Value，@ConfigurationProperties。。。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 以前SpringBoot任何方法从配置文件中获取值，都能使用。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 配置中心有的优先使用配置中心中的，")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1、开启服务注册发现")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  (配置nacos的注册中心地址)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2、编写网关配置文件")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1、如何使用Nacos作为配置中心统一管理配置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1）、引入依赖，")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         <dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <groupId>com.alibaba.cloud</groupId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *             <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         </dependency>")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、创建一个bootstrap.properties。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      spring.application.name=gulimall-coupon")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      spring.cloud.nacos.config.server-addr=127.0.0.1:8848")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3）、需要给配置中心默认添加一个叫 数据集（Data Id）gulimall-coupon.properties。默认规则，应用名.properties")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 4）、给 应用名.properties 添加任何配置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 5）、动态获取配置。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      @RefreshScope：动态获取并刷新配置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},' *      @Value("${配置项的名}")：获取到配置。')]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      如果配置中心和当前应用的配置文件中都配置了相同的项，优先使用配置中心的配置。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2、细节")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  1）、命名空间：配置隔离；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      默认：public(保留空间)；默认新增的所有配置都在public空间。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      1、开发，测试，生产：利用命名空间来做环境隔离。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         注意：在bootstrap.properties；配置上，需要使用哪个命名空间下的配置，")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *         spring.cloud.nacos.config.namespace=9de62e44-cd2a-4a82-bf5c-95878bd5e871")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      2、每一个微服务之间互相隔离配置，每一个微服务都创建自己的命名空间，只加载自己命名空间下的所有配置")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  2）、配置集：所有的配置的集合")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  3）、配置集ID：类似文件名。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      Data ID：类似文件名")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  4）、配置分组：")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      默认所有的配置集都属于：DEFAULT_GROUP；")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *      1111，618，1212")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 项目中的使用：每个微服务创建自己的命名空间，使用配置分组区分环境，dev，test，prod")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3、同时加载多个配置集")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1)、微服务任何配置信息，任何配置文件都可以放在配置中心中")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2）、只需要在bootstrap.properties说明加载配置中心中哪些配置文件即可")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 3）、@Value，@ConfigurationProperties。。。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 以前SpringBoot任何方法从配置文件中获取值，都能使用。")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 配置中心有的优先使用配置中心中的，")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," /**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 1、开启服务注册发现")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," *  (配置nacos的注册中心地址)")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 2、编写网关配置文件")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")])])]),r("button",{class:"collapse"})],-1),ua={id:"nacos作为注册中心",tabindex:"-1"},da=r("ul",null,[r("li",null,[r("p",null,"将微服务注册到 nacos 中")]),r("li",null,[r("p",null,"1、首先，修改 pom.xml 文件，引入 Nacos Discovery Starter。")]),r("li",null,[r("p",null,"2、在应用的 /src/main/resources/application.properties 配置文 件中配置 Nacos Server 地址"),r("div",{style:{"max-height":"300px"},class:"language-properties"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"properties"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"spring.cloud.nacos.discovery.server-addr"),r("span",{style:{color:"#E1E4E8"}},"=127.0.0.1:8848")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"spring.cloud.nacos.discovery.server-addr"),r("span",{style:{color:"#24292E"}},"=127.0.0.1:8848")])])]),r("button",{class:"collapse"})])]),r("li",null,[r("p",null,"3、使用@EnableDiscoveryClient 开启服务注册发现功能")]),r("li",null,[r("p",null,"4、启动应用，观察 nacos 服务列表是否已经注册上服务"),r("ul",null,[r("li",null,[r("blockquote",null,[r("p",null,"注意：每一个应用都应该有名字，这样才能注册上去。修改 application.properties 文件"),r("p",null,"spring.application.name=service-provider"),r("p",null,"server.port=8000")])])])]),r("li",null,[r("p",null,"5、注册更多的服务上去，测试使用 feign 远程调用"),r("ul",null,[r("li",null,[r("blockquote",null,[r("p",null,"Nacos 使用三步"),r("p",null,"1、导包 nacos-discovery"),r("p",null,"2、写配置，指定 nacos 地址，指定应用的名字"),r("p",null,"3、开启服务注册发现功能@EnableDiscoveryClient"),r("p",null,"Feign 使用三步"),r("p",null,"1、导包 openfeign"),r("p",null,"2、开启@EnableFeignClients 功能"),r("p",null,"3、编写接口，进行远程调用")])])])])],-1),ga={id:"nacos作为配置中心",tabindex:"-1"},Fa=r("li",null,[r("p",null,"1、pom.xml 引入 Nacos Config Starter。")],-1),Aa=r("li",null,[r("p",null,"2、在应用的 /src/main/resources/bootstrap.properties 配 置文件中配置 Nacos Config 元数据"),r("div",{style:{"max-height":"300px"},class:"language-properties"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"properties"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  "),r("span",{style:{color:"#F97583"}},"spring.application.name"),r("span",{style:{color:"#E1E4E8"}},"=nacos-config-example")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  "),r("span",{style:{color:"#F97583"}},"spring.cloud.nacos.config.server-addr"),r("span",{style:{color:"#E1E4E8"}},"=127.0.0.1:8848")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  "),r("span",{style:{color:"#6A737D"}},"#指定命名空间")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  "),r("span",{style:{color:"#F97583"}},"spring.cloud.nacos.config.namespace"),r("span",{style:{color:"#E1E4E8"}},"=af7b6638-68dd-43a0-8bef-19dbaf2ae5c3 ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  "),r("span",{style:{color:"#6A737D"}},"#指定分组  默认DEFAULT_GROUP")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  "),r("span",{style:{color:"#F97583"}},"spring.cloud.nacos.config.group"),r("span",{style:{color:"#E1E4E8"}},"=dev")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"  "),r("span",{style:{color:"#6A737D"}},"#主要配置应用名和配置中心地址")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  "),r("span",{style:{color:"#D73A49"}},"spring.application.name"),r("span",{style:{color:"#24292E"}},"=nacos-config-example")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  "),r("span",{style:{color:"#D73A49"}},"spring.cloud.nacos.config.server-addr"),r("span",{style:{color:"#24292E"}},"=127.0.0.1:8848")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  "),r("span",{style:{color:"#6A737D"}},"#指定命名空间")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  "),r("span",{style:{color:"#D73A49"}},"spring.cloud.nacos.config.namespace"),r("span",{style:{color:"#24292E"}},"=af7b6638-68dd-43a0-8bef-19dbaf2ae5c3 ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  "),r("span",{style:{color:"#6A737D"}},"#指定分组  默认DEFAULT_GROUP")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  "),r("span",{style:{color:"#D73A49"}},"spring.cloud.nacos.config.group"),r("span",{style:{color:"#24292E"}},"=dev")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"  "),r("span",{style:{color:"#6A737D"}},"#主要配置应用名和配置中心地址")])])]),r("button",{class:"collapse"})])],-1),ma=r("p",null,"3、在 nacos 中添加配置",-1),Da=r("li",null,[r("p",null,[c("在 nacos 中创建一个 "),r("strong",null,"应用名.properties"),c(" 配置文件并编写配置")])],-1),ha=r("p",null,[r("strong",null,"Nacos Config"),c(),r("strong",null,"数据结构")],-1),ka=r("p",null,"Nacos Config 主要通过 dataId 和 group 来唯一确定一条配置。",-1),ba=r("p",null,"Nacos Client 从 Nacos Server 端获取数据时，调用的是此接口 ConfigService.getConfig(String dataId, String group, long timeoutMs)。",-1),Ca=r("p",null,[r("strong",null,"Spring Cloud"),c(),r("strong",null,"应用获取数据")],-1),Sa=r("p",null,[r("strong",null,"dataID"),c(":")],-1),Ba=r("p",null,"在 Nacos Config Starter 中，dataId 的拼接格式如下",-1),fa=r("li",null,"spring.profiles.active 即为当前环境对应的 profile",-1),va=r("p",{"file-extension":""},[c("注意，当 activeprofile 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 prefix . {prefix}."),r("em",null,[c("p"),r("strong",null,"re"),c("f"),r("strong",null,"i"),c("x")]),c(".")],-1),xa=r("p",null,"file-extension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置。 目前只支持 properties 类型。",-1),Ia=r("p",null,[r("strong",null,"Group"),c("：")],-1),Oa=r("p",null,"Group 默认为 DEFAULT_GROUP，可以通过 spring.cloud.nacos.config.group 配置。",-1),Ta=r("p",null,"4、在应用中使用@Value 和@RefreshScope",-1),_a=r("p",null,"完成上述两步后，应用会从 Nacos Config 中获取相应的配置，并添加在 Spring Environment",-1),Ra=r("p",null,"的 PropertySources 中 。 这 里 我 们 使 用 @Value 注 解 来 将 对 应 的 配 置 注 入 到",-1),La=r("p",null,"SampleController 的 userName 和 age 字段，并添加 @RefreshScope 打开动态刷新功能",-1),wa=r("p",null,[r("strong",null,"@RefreshScope")],-1),qa=r("p",null,"class SampleController {",-1),Pa=r("p",null,"String userName;",-1),Va=r("p",null,[r("strong",null,"@Value(“${user.age}”)")],-1),Ma=r("p",null,"int age;",-1),ja=r("p",null,"}",-1),Na={id:"nacos进阶",tabindex:"-1"},Wa=r("ul",null,[r("li",null,[r("p",null,[r("strong",null,"核心概念")]),r("ul",null,[r("li",null,[r("p",null,[r("strong",null,"命名空间：配置隔离")]),r("ul",null,[r("li",null,[r("p",null,[c("用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 "),r("strong",null,"Group"),c(" 或 "),r("strong",null,"Data ID"),c(" 的")]),r("p",null,[c("配置。"),r("strong",null,"Namespace"),c(" 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生")]),r("p",null,"产环境的资源（如配置、服务）隔离等")])])]),r("li",null,[r("p",null,[r("strong",null,"配置集：所有配置的集合")]),r("ul",null,[r("li",null,[r("p",null,"一组相关或者不相关的配置项的集合称为配置集。在系统中，一个配置文件通常就是一个配"),r("p",null,"置集，包含了系统各个方面的配置。例如，一个配置集可能包含了数据源、线程池、日志级"),r("p",null,"别等配置项。")])])]),r("li",null,[r("p",null,[r("strong",null,"配置集ID：类似文件名。")]),r("ul",null,[r("li",null,[r("p",null,[c("Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。"),r("strong",null,"Data ID"),c(" 通常用于组")]),r("p",null,"织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有"),r("p",null,"意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名"),r("p",null,"规则保证全局唯一性。此命名规则非强制。")])])]),r("li",null,[r("p",null,[r("strong",null,"配置分组：默认所有的配置集都属于：DEFAULT_GROUP；")]),r("ul",null,[r("li",null,[r("p",null,"Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或"),r("p",null,"Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个"),r("p",null,"配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置"),r("p",null,"分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和"),r("p",null,"MQ_topic 配置。")])])])])]),r("li",null,[r("p",null,[r("strong",null,"原理")]),r("ul",null,[r("li",null,[c("自动注入： "),r("ul",null,[r("li",null,"NacosConfigStarter 实现了 org.springframework.cloud.bootstrap.config.PropertySourceLocator 接口，并将优先级设置成了最高。 在 Spring Cloud 应用启动阶段，会主动从 Nacos Server 端获取对应的数据，并将获取到的 数据转换成 PropertySource 且注入到 Environment 的 PropertySources 属性中，所以使用 @Value 注解也能直接获取 Nacos Server 端配置的内容。")])]),r("li",null,[c("动态刷新： "),r("ul",null,[r("li",null,"Nacos Config Starter 默认为所有获取数据成功的 Nacos 的配置项添加了监听功能，在监听 到服务端配置发生变化时会实时触发 org.springframework.cloud.context.refresh.ContextRefresher 的 refresh 方法 。"),r("li",null,[c("如果需要对 Bean 进行动态刷新，请参照 Spring 和 Spring Cloud 规范。推荐给类添加**@RefreshScope** "),r("strong",null,"或"),c(),r("strong",null,"@ConfigurationProperties"),c(" 注解，")])])])])]),r("li",null,[r("p",null,[r("strong",null,"3、加载多配置文件")]),r("div",{style:{"max-height":"300px"},class:"language-properties"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"properties"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"spring.cloud.nacos.config.server-addr"),r("span",{style:{color:"#E1E4E8"}},"=127.0.0.1:8848")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"spring.cloud.nacos.config.namespace"),r("span",{style:{color:"#E1E4E8"}},"=31098de9-fa28-41c9-b0bd-c754ce319ed4 ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}}," spring.cloud.nacos.config.ext-config[0]."),r("span",{style:{color:"#F97583"}},"data-id"),r("span",{style:{color:"#E1E4E8"}},"=gulimall-datasource.yml ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#6A737D"}},"#动态刷新")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}}," spring.cloud.nacos.config.ext-config[0]."),r("span",{style:{color:"#F97583"}},"refresh"),r("span",{style:{color:"#E1E4E8"}},"=false")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}}," spring.cloud.nacos.config.ext-config[0]."),r("span",{style:{color:"#F97583"}},"group"),r("span",{style:{color:"#E1E4E8"}},"=dev")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"spring.cloud.nacos.config.server-addr"),r("span",{style:{color:"#24292E"}},"=127.0.0.1:8848")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"spring.cloud.nacos.config.namespace"),r("span",{style:{color:"#24292E"}},"=31098de9-fa28-41c9-b0bd-c754ce319ed4 ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}}," spring.cloud.nacos.config.ext-config[0]."),r("span",{style:{color:"#D73A49"}},"data-id"),r("span",{style:{color:"#24292E"}},"=gulimall-datasource.yml ")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6A737D"}},"#动态刷新")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}}," spring.cloud.nacos.config.ext-config[0]."),r("span",{style:{color:"#D73A49"}},"refresh"),r("span",{style:{color:"#24292E"}},"=false")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}}," spring.cloud.nacos.config.ext-config[0]."),r("span",{style:{color:"#D73A49"}},"group"),r("span",{style:{color:"#24292E"}},"=dev")])])]),r("button",{class:"collapse"})])]),r("li",null,[r("p",null,[r("strong",null,"4、namespace 与 group 最佳实践")]),r("ul",null,[r("li",null,"每个微服务创建自己的 namespace 进行隔离，group 来区分 dev，beta，prod 等环境")])])],-1),Ka={id:"gateway",tabindex:"-1"},za=r("ul",null,[r("li",null,[c("简介 "),r("ul",null,[r("li",null,"网关作为流量的入口，常用功能包括路由转发、权限校验、限流控制等。")])]),r("li",null,[c("特点 "),r("ul",null,[r("li",null,"基于 Spring5，支持响应式编程和 SpringBoot2.0"),r("li",null,"支持使用任何请求属性进行路由匹配"),r("li",null,"特定于路由的断言和过滤器"),r("li",null,"集成 Hystrix 进行断路保护"),r("li",null,"集成服务发现功能"),r("li",null,"易于编写 Predicates 和 Filters"),r("li",null,"支持请求速率限制"),r("li",null,"支持路径重写")])]),r("li",null,[c("API网关优点 "),r("ul",null,[r("li",null,"易于监控。可以在网关收集监控数据并将其推送到外部系统进行分析。"),r("li",null,"易于认证。可以在网关上进行认证，然后再将请求转发到后端的微服务，而无须在 每个微服务中进行认证。"),r("li",null,"减少了客户端与各个微服务之间的交互次数。")])]),r("li",null,[c("核心概率 "),r("ul",null,[r("li",null,[c("路由 "),r("ul",null,[r("li",null,"路由是网关最基础的部分，路由信息有一个 ID、一个目的 URL、一组断言和一组 Filter 组成。如果断言路由为真，则说明请求的 URL 和配置匹配")])]),r("li",null,[c("断言 "),r("ul",null,[r("li",null,"Java8 中的断言函数。Spring Cloud Gateway 中的断言函数输入类型是 Spring5.0 框 架中的 ServerWebExchange。Spring Cloud Gateway 中的断言函数允许开发者去定义匹配 来自于 http request 中的任何信息，比如请求头和参数等。")])]),r("li",null,[c("过滤器 "),r("ul",null,[r("li",null,"一个标准的 Spring webFilter。Spring cloud gateway 中的 filter 分为两种类型的 Filter，分别是 Gateway Filter 和 Global Filter。过滤器 Filter 将会对请求和响应进行修改 处理")])]),r("li",null,[r("strong",null,"满足某些断言（predicates）就路由到指定的地址（uri），使用指定的过滤器（filter）")])])])],-1),Ha=r("blockquote",null,[r("div",{style:{"max-height":"300px"},class:"language-yaml"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"yaml"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#85E89D"}},"spring"),r("span",{style:{color:"#E1E4E8"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#85E89D"}},"cloud"),r("span",{style:{color:"#E1E4E8"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#85E89D"}},"gateway"),r("span",{style:{color:"#E1E4E8"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"   "),r("span",{style:{color:"#85E89D"}},"routes"),r("span",{style:{color:"#E1E4E8"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"        - "),r("span",{style:{color:"#85E89D"}},"id"),r("span",{style:{color:"#E1E4E8"}},": "),r("span",{style:{color:"#9ECBFF"}},"test_route")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"          "),r("span",{style:{color:"#85E89D"}},"uri"),r("span",{style:{color:"#E1E4E8"}},": "),r("span",{style:{color:"#9ECBFF"}},"https://www.baidu.com")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"          "),r("span",{style:{color:"#85E89D"}},"predicates"),r("span",{style:{color:"#E1E4E8"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            - "),r("span",{style:{color:"#9ECBFF"}},"Query=url,baidu")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"       - "),r("span",{style:{color:"#85E89D"}},"id"),r("span",{style:{color:"#E1E4E8"}},": "),r("span",{style:{color:"#9ECBFF"}},"product_route")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"          "),r("span",{style:{color:"#85E89D"}},"uri"),r("span",{style:{color:"#E1E4E8"}},": "),r("span",{style:{color:"#9ECBFF"}},"lb://gulimall-product")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"          "),r("span",{style:{color:"#85E89D"}},"predicates"),r("span",{style:{color:"#E1E4E8"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            - "),r("span",{style:{color:"#9ECBFF"}},"Path=/api/product/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"          "),r("span",{style:{color:"#85E89D"}},"filters"),r("span",{style:{color:"#E1E4E8"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            - "),r("span",{style:{color:"#9ECBFF"}},"RewritePath=/api/?(?<segment>.*),/$\\{segment}")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"       - "),r("span",{style:{color:"#85E89D"}},"id"),r("span",{style:{color:"#E1E4E8"}},": "),r("span",{style:{color:"#9ECBFF"}},"gulimall_host_route")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"          "),r("span",{style:{color:"#85E89D"}},"uri"),r("span",{style:{color:"#E1E4E8"}},": "),r("span",{style:{color:"#9ECBFF"}},"lb://gulimall-product")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"          "),r("span",{style:{color:"#85E89D"}},"predicates"),r("span",{style:{color:"#E1E4E8"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"            - "),r("span",{style:{color:"#9ECBFF"}},"Host=gulimall.com,item.gulimall.com")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#22863A"}},"spring"),r("span",{style:{color:"#24292E"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#22863A"}},"cloud"),r("span",{style:{color:"#24292E"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#22863A"}},"gateway"),r("span",{style:{color:"#24292E"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"   "),r("span",{style:{color:"#22863A"}},"routes"),r("span",{style:{color:"#24292E"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"        - "),r("span",{style:{color:"#22863A"}},"id"),r("span",{style:{color:"#24292E"}},": "),r("span",{style:{color:"#032F62"}},"test_route")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"          "),r("span",{style:{color:"#22863A"}},"uri"),r("span",{style:{color:"#24292E"}},": "),r("span",{style:{color:"#032F62"}},"https://www.baidu.com")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"          "),r("span",{style:{color:"#22863A"}},"predicates"),r("span",{style:{color:"#24292E"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            - "),r("span",{style:{color:"#032F62"}},"Query=url,baidu")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"       - "),r("span",{style:{color:"#22863A"}},"id"),r("span",{style:{color:"#24292E"}},": "),r("span",{style:{color:"#032F62"}},"product_route")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"          "),r("span",{style:{color:"#22863A"}},"uri"),r("span",{style:{color:"#24292E"}},": "),r("span",{style:{color:"#032F62"}},"lb://gulimall-product")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"          "),r("span",{style:{color:"#22863A"}},"predicates"),r("span",{style:{color:"#24292E"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            - "),r("span",{style:{color:"#032F62"}},"Path=/api/product/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"          "),r("span",{style:{color:"#22863A"}},"filters"),r("span",{style:{color:"#24292E"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            - "),r("span",{style:{color:"#032F62"}},"RewritePath=/api/?(?<segment>.*),/$\\{segment}")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"       - "),r("span",{style:{color:"#22863A"}},"id"),r("span",{style:{color:"#24292E"}},": "),r("span",{style:{color:"#032F62"}},"gulimall_host_route")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"          "),r("span",{style:{color:"#22863A"}},"uri"),r("span",{style:{color:"#24292E"}},": "),r("span",{style:{color:"#032F62"}},"lb://gulimall-product")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"          "),r("span",{style:{color:"#22863A"}},"predicates"),r("span",{style:{color:"#24292E"}},":")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"            - "),r("span",{style:{color:"#032F62"}},"Host=gulimall.com,item.gulimall.com")])])]),r("button",{class:"collapse"})])],-1),Qa={id:"feign",tabindex:"-1"},Ua=r("p",null,[r("strong",null,"Feign"),c(),r("strong",null,"声明式远程调用")],-1),Ga=r("ul",null,[r("li",null,[r("p",null,"简介"),r("ul",null,[r("li",null,"Feign 是一个声明式的 HTTP 客户端，它的目的就是让远程调用更加简单。"),r("li",null,[c("Feign 整合了 "),r("strong",null,"Ribbon（负载均衡）和 Hystrix(服务熔断)，")])])]),r("li",null,[r("p",null,[r("strong",null,"使用")]),r("ul",null,[r("li",null,[r("p",null,"1、引入依赖 spring-cloud-starter-openfeign")]),r("li",null,[r("p",null,"2、开启 feign 功能 @EnableFeignClients(basePackages = “com.atguigu.gulimall.member.feign”)")]),r("li",null,[r("p",null,"3、声明远程接口"),r("div",{style:{"max-height":"300px"},class:"language-java"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"java"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"* @Author zly")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"* @Date 2022/7/25 12:04")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"*/")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"FeignClient"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"gulimall-order"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"public"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#F97583"}},"interface"),r("span",{style:{color:"#E1E4E8"}}," "),r("span",{style:{color:"#B392F0"}},"OrderFeignService"),r("span",{style:{color:"#E1E4E8"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 分页查询当前登录用户的所有订单信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#FFAB70"}},"params")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#F97583"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"@"),r("span",{style:{color:"#F97583"}},"PostMapping"),r("span",{style:{color:"#E1E4E8"}},"("),r("span",{style:{color:"#9ECBFF"}},'"/order/order/listWithItem"'),r("span",{style:{color:"#E1E4E8"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"R "),r("span",{style:{color:"#B392F0"}},"listWithItem"),r("span",{style:{color:"#E1E4E8"}},"(@"),r("span",{style:{color:"#F97583"}},"RequestBody"),r("span",{style:{color:"#E1E4E8"}}," Map<"),r("span",{style:{color:"#F97583"}},"String"),r("span",{style:{color:"#E1E4E8"}},", "),r("span",{style:{color:"#F97583"}},"Object"),r("span",{style:{color:"#E1E4E8"}},"> "),r("span",{style:{color:"#FFAB70"}},"params"),r("span",{style:{color:"#E1E4E8"}},");")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#E1E4E8"}},"}")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"* @Author zly")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"* @Date 2022/7/25 12:04")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"*/")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"FeignClient"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"gulimall-order"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"public"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#D73A49"}},"interface"),r("span",{style:{color:"#24292E"}}," "),r("span",{style:{color:"#6F42C1"}},"OrderFeignService"),r("span",{style:{color:"#24292E"}}," {")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"/**")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * 分页查询当前登录用户的所有订单信息")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@param"),r("span",{style:{color:"#6A737D"}}," "),r("span",{style:{color:"#E36209"}},"params")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," * "),r("span",{style:{color:"#D73A49"}},"@return")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}}," */")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"@"),r("span",{style:{color:"#D73A49"}},"PostMapping"),r("span",{style:{color:"#24292E"}},"("),r("span",{style:{color:"#032F62"}},'"/order/order/listWithItem"'),r("span",{style:{color:"#24292E"}},")")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"R "),r("span",{style:{color:"#6F42C1"}},"listWithItem"),r("span",{style:{color:"#24292E"}},"(@"),r("span",{style:{color:"#D73A49"}},"RequestBody"),r("span",{style:{color:"#24292E"}}," Map<"),r("span",{style:{color:"#D73A49"}},"String"),r("span",{style:{color:"#24292E"}},", "),r("span",{style:{color:"#D73A49"}},"Object"),r("span",{style:{color:"#24292E"}},"> "),r("span",{style:{color:"#E36209"}},"params"),r("span",{style:{color:"#24292E"}},");")]),c("\n"),r("span",{class:"line"}),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#24292E"}},"}")])])]),r("button",{class:"collapse"})])])])])],-1),Xa={id:"feign远程调用丢失请求头问题",tabindex:"-1"},Ja=r("figure",null,[r("img",{alt:"image-20230410205425533",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410205425533.png"})],-1),$a={id:"feign异步情况丢失上下文问题",tabindex:"-1"},Ya=r("figure",null,[r("img",{alt:"image-20230410205453081",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410205453081.png"})],-1),Za={id:"springcloud-alibaba-常用组件端口号总结",tabindex:"-1"},lt=r("ul",null,[r("li",null,[r("p",null,"Nacos 默认端口号：8848"),r("div",{style:{"max-height":"300px"},class:"language-properties"},[r("button",{title:"Copy Code",class:"copy"}),r("span",{class:"lang"},"properties"),r("pre",{class:"shiki github-dark vp-code-dark"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"#*************** Spring Boot Related Configurations ***************#")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"### Default web context path:")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"server.servlet.contextPath"),r("span",{style:{color:"#E1E4E8"}},"=/nacos")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"### Default web server port:")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#F97583"}},"server.port"),r("span",{style:{color:"#E1E4E8"}},"=8848")])])]),r("pre",{class:"shiki github-light vp-code-light"},[r("code",null,[r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"#*************** Spring Boot Related Configurations ***************#")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"### Default web context path:")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"server.servlet.contextPath"),r("span",{style:{color:"#24292E"}},"=/nacos")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#6A737D"}},"### Default web server port:")]),c("\n"),r("span",{class:"line"},[r("span",{style:{color:"#D73A49"}},"server.port"),r("span",{style:{color:"#24292E"}},"=8848")])])]),r("button",{class:"collapse"})])]),r("li",null,[r("p",null,"Seata默认端口号：8091")]),r("li",null,[r("p",null,"Sentinel控制台默认运行在8080端口上")])],-1),st=r("blockquote",null,[r("p",null,"Elasticsearch 默认端口 9200 搜索引擎 不属于SpringCloud Alibaba")],-1),ot={id:"支付",tabindex:"-1"},nt={id:"加密-对称加密",tabindex:"-1"},et=r("figure",null,[r("img",{alt:"image-20230410190257408",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410190257408.png"})],-1),at={id:"加密-非对称加密",tabindex:"-1"},tt=r("figure",null,[r("img",{alt:"image-20230410190307734",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410190307734.png"})],-1),rt={id:"支付宝验签",tabindex:"-1"},ct=r("figure",null,[r("img",{alt:"image-20230410201313818",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410201313818.png"})],-1),pt={id:"收单",tabindex:"-1"},yt=r("ul",null,[r("li",null,[c("1、订单在支付页，不支付，一直刷新，订单过期了才支付，订单状态改为已支付了，但是库存解锁了。 "),r("ul",null,[r("li",null,"使用支付宝自动收单功能解决。只要一段时间不支付，就不能支付了。")])]),r("li",null,[c("2、由于时延等问题。订单解锁完成，正在解锁库存的时候，异步通知才到 "),r("ul",null,[r("li",null,"订单解锁，手动调用收单")])]),r("li",null,[c("3、网络阻塞问题，订单支付成功的异步通知一直不到达 "),r("ul",null,[r("li",null,"查询订单列表时，ajax获取当前未支付的订单状态，查询订单状态时，再获取一下支付宝此订单的状态")])]),r("li",null,[c("4、其他各种问题 "),r("ul",null,[r("li",null,"每天晚上闲时下载支付宝对账单，一一进行对账")])])],-1),Et={id:"md5-md5盐值加密",tabindex:"-1"},it=r("ul",null,[r("li",null,[c("MD5 "),r("ul",null,[r("li",null,[c("Message Digest algorithm 5，信息摘要算法 "),r("ul",null,[r("li",null,"压缩性：任意长度的数据，算出的MD5值长度都是固定的。"),r("li",null,"容易计算：从原数据计算出MD5值很容易。"),r("li",null,"抗修改性：对原数据进行任何改动，哪怕只修改1个字节，所得到的MD5值都有很大区别。"),r("li",null,"强抗碰撞：想找到两个不同的数据，使它们具有相同的MD5值，是非常困难的。"),r("li",null,"不可逆")])])])]),r("li",null,[c("加盐： "),r("ul",null,[r("li",null,"通过生成随机数与MD5生成字符串进行组合"),r("li",null,"数据库同时存储MD5值与salt值。验证正确性时使用salt进行MD5即可")])])],-1),ut={id:"项目微服务",tabindex:"-1"},dt=r("figure",null,[r("img",{alt:"image-20230410191352836",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410191352836.png"})],-1),gt={id:"nginx-windows搭建域名访问环境",tabindex:"-1"},Ft=r("figure",null,[r("img",{alt:"image-20230410191454442",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410191454442.png"})],-1),At={id:"域名映射效果",tabindex:"-1"},mt=r("li",null,"nginx直接代理给网关，网关判断",-1),Dt=r("li",null,"如果/api/****，转交给对应的服务器",-1),ht=r("li",null,"如果是 满足域名，转交给对应的服务",-1),kt={id:"正向代理与反向代理",tabindex:"-1"},bt=r("ul",null,[r("li",null,"正向代理：如科学上网，隐藏客户端信息")],-1),Ct=r("figure",null,[r("img",{alt:"image-20230410191634342",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410191634342.png"})],-1),St=r("ul",null,[r("li",null,"反向代理：屏蔽内网服务器信息，负载均衡访问")],-1),Bt=r("figure",null,[r("img",{alt:"image-20230410191643706",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410191643706.png"})],-1),ft={id:"nginx配置文件",tabindex:"-1"},vt=r("figure",null,[r("img",{alt:"image-20230410191710095",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410191710095.png"})],-1),xt={id:"nginx动静分离",tabindex:"-1"},It=r("figure",null,[r("img",{alt:"image-20230410191732131",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410191732131.png"})],-1),Ot={id:"nginx转发效果",tabindex:"-1"},Tt=r("figure",null,[r("img",{alt:"image-20230410191756149",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410191756149.png"})],-1),_t={id:"内网穿透",tabindex:"-1"},Rt=r("figure",null,[r("img",{alt:"image-20230410190339367",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410190339367.png"})],-1),Lt=r("figure",null,[r("img",{alt:"image-20230410190351905",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410190351905.png"})],-1),wt={id:"内网穿透联调",tabindex:"-1"},qt=r("figure",null,[r("img",{alt:"image-20230410190422986",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410190422986.png"})],-1),Pt={id:"配置",tabindex:"-1"},Vt=r("ul",null,[r("li",null,"Nginx配置")],-1),Mt=r("p",null,"...",-1),jt=r("p",null,"...",-1),Nt={id:"缓存",tabindex:"-1"},Wt={id:"本地缓存",tabindex:"-1"},Kt=r("figure",null,[r("img",{alt:"image-20230410191857648",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410191857648.png"})],-1),zt={id:"分布式缓存-本地模式在分布式下的问题",tabindex:"-1"},Ht=r("figure",null,[r("img",{alt:"image-20230410191940056",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410191940056.png"})],-1),Qt={id:"分布式缓存",tabindex:"-1"},Ut=r("figure",null,[r("img",{alt:"image-20230410192021777",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410192021777.png"})],-1),Gt={id:"高并发下缓存失效问题-缓存穿透",tabindex:"-1"},Xt=r("figure",null,[r("img",{alt:"image-20230410192133778",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410192133778.png"})],-1),Jt=r("ul",null,[r("li",null,[r("strong",null,"缓存穿透"),c("： "),r("ul",null,[r("li",null,"指查询一个一定不存在的数据，由于缓存是不命中，将去查询数据库，但是数据库也无此记录，我们没有将这次查询的null写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义")])]),r("li",null,[r("strong",null,"风险"),c("： "),r("ul",null,[r("li",null,"利用不存在的数据进行攻击，数据库瞬时压力增大，最终导致崩溃")])]),r("li",null,[r("strong",null,"解决"),c("： "),r("ul",null,[r("li",null,"null结果缓存，并加入短暂过期时间")])])],-1),$t={id:"高并发下缓存失效问题-缓存雪崩",tabindex:"-1"},Yt=r("figure",null,[r("img",{alt:"image-20230410192133778",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410192133778.png"})],-1),Zt=r("ul",null,[r("li",null,[r("p",null,[r("strong",null,"缓存雪崩"),c("：")]),r("ul",null,[r("li",null,"缓存雪崩是指在我们设置缓存时key采用了相同的过期时间，导致缓存在某一时刻同时失效，请求全部转发到DB，DB瞬时压力过重雪崩。")])]),r("li",null,[r("p",null,[r("strong",null,"解决"),c("：")]),r("ul",null,[r("li",null,"原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。")])])],-1),lr={id:"高并发下缓存失效问题-缓存击穿",tabindex:"-1"},sr=r("figure",null,[r("img",{alt:"image-20230410192628947",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410192628947.png"})],-1),or=r("ul",null,[r("li",null,[r("p",null,[r("strong",null,"缓存穿透"),c("：")]),r("ul",null,[r("li",null,[c('对于一些设置了过期时间的key，如果这些key可能会在某些时间点被超高并发地访问，是一种非常"'),r("strong",null,"热点"),c('"的数据。如果这个key在大量请求同时进来前正好失效，那么所有对这个key的数据查询都落到db，我们称为缓存击穿。')])])]),r("li",null,[r("p",null,[r("strong",null,"解决"),c("：")]),r("ul",null,[r("li",null,[c("加锁 "),r("ul",null,[r("li",null,"大量并发只让一个去查，其他人等待，查到以后释放锁，其他人获取到锁，先查缓存，就会有数据，不用去db")])])])])],-1),nr={id:"分布式下如何加锁",tabindex:"-1"},er=r("figure",null,[r("img",{alt:"image-20230410192940277",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410192940277.png"})],-1),ar=r("ul",null,[r("li",null,"本地锁，只能锁住当前进程，所以我们需要分布式锁")],-1),tr={id:"锁-时序问题",tabindex:"-1"},rr=r("figure",null,[r("img",{alt:"image-20230410193041285",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193041285.png"})],-1),cr={id:"分布式锁演进-基本原理",tabindex:"-1"},pr=r("figure",null,[r("img",{alt:"image-20230410193221079",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193221079.png"})],-1),yr=r("blockquote",null,[r("p",null,"我们可以同时去一个地方“占坑”，如果占到，就执行逻辑。否则就必须等待，直到释放锁。 “占坑”可以去redis，可以去数据库，可以去任何大家都能访问的地方。 等待可以自旋的方式。")],-1),Er={id:"分布式锁演进-阶段一",tabindex:"-1"},ir=r("figure",null,[r("img",{alt:"image-20230410193430589",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193430589.png"})],-1),ur={id:"分布式锁演进-阶段二",tabindex:"-1"},dr=r("figure",null,[r("img",{alt:"image-20230410193552631",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193552631.png"})],-1),gr={id:"分布式锁演进-阶段三",tabindex:"-1"},Fr=r("figure",null,[r("img",{alt:"image-20230410193625611",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193625611.png"})],-1),Ar={id:"分布式锁演进-阶段四",tabindex:"-1"},mr=r("figure",null,[r("img",{alt:"image-20230410193648301",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193648301.png"})],-1),Dr={id:"分布式锁演进-阶段五-最终形态",tabindex:"-1"},hr=r("figure",null,[r("img",{alt:"image-20230410193719776",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193719776.png"})],-1),kr={id:"缓存数据一致性-双写模式",tabindex:"-1"},br=r("figure",null,[r("img",{alt:"image-20230410193831064",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193831064.png"})],-1),Cr={id:"缓存数据一致性-失效模式",tabindex:"-1"},Sr=r("figure",null,[r("img",{alt:"image-20230410193909090",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410193909090.png"})],-1),Br={id:"缓存数据一致性-解决方案",tabindex:"-1"},fr=r("ul",null,[r("li",null,[c("无论是双写模式还是失效模式，都会导致缓存的不一致问题。即多个实例同时更新会出事。怎么办？ "),r("ul",null,[r("li",null,"1、如果是用户纬度数据（订单数据、用户数据），这种并发几率非常小，不用考虑这个问题，缓存数据加上过期时间，每隔一段时间触发读的主动更新即可"),r("li",null,"2、如果是菜单，商品介绍等基础数据，也可以去使用canal订阅binlog的方式。"),r("li",null,"3、缓存数据+过期时间也足够解决大部分业务对于缓存的要求。"),r("li",null,"4、通过加锁保证并发读写，写写的时候按顺序排好队。读读无所谓。所以适合使用读写锁。（业务不关心脏数据，允许临时脏数据可忽略）；")])]),r("li",null,[c("总结： "),r("ul",null,[r("li",null,"我们能放入缓存的数据本就不应该是实时性、一致性要求超高的。所以缓存数据的时候加上过期时间，保证每天拿到当前最新数据即可。"),r("li",null,"我们不应该过度设计，增加系统的复杂性"),r("li",null,"遇到实时性、一致性要求高的数据，就应该查数据库，即使慢点。")])])],-1),vr={id:"缓存数据一致性-解决-canal",tabindex:"-1"},xr=r("figure",null,[r("img",{alt:"image-20230410194458435",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410194458435.png"})],-1),Ir={id:"session共享问题",tabindex:"-1"},Or={id:"session原理",tabindex:"-1"},Tr=r("figure",null,[r("img",{alt:"image-20230410195022298",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195022298.png"})],-1),_r={id:"分布式下session共享问题",tabindex:"-1"},Rr=r("figure",null,[r("img",{alt:"image-20230410195051946",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195051946.png"})],-1),Lr={id:"解决-session复制",tabindex:"-1"},wr=r("figure",null,[r("img",{alt:"image-20230410195126743",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195126743.png"})],-1),qr=r("ul",null,[r("li",null,[c("优点 "),r("ul",null,[r("li",null,"web-server（Tomcat）原生支持，只需要修改配置文件")])]),r("li",null,[c("缺点 "),r("ul",null,[r("li",null,"session同步需要数据传输，占用大量网络带宽，降低了服务器群的业务处理能力"),r("li",null,"任意一台web-server保存的数据都是所有web-server的session总和，受到内存限制无法水平扩展更多的web-server"),r("li",null,"大型分布式集群情况下，由于所有web-server都全量保存数据，所以此方案不可取。")])])],-1),Pr={id:"解决-客户端存储",tabindex:"-1"},Vr=r("figure",null,[r("img",{alt:"image-20230410195314820",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195314820.png"})],-1),Mr=r("ul",null,[r("li",null,[r("p",null,"优点"),r("ul",null,[r("li",null,"服务器不需存储session，用户保存自己的session信息到cookie中。节省服务端资源")])]),r("li",null,[r("p",null,"缺点"),r("ul",null,[r("li",null,"都是缺点，这只是一种思路。"),r("li",null,[c("具体如下： "),r("ul",null,[r("li",null,"每次http请求，携带用户在cookie中的完整信息，浪费网络带宽"),r("li",null,"session数据放在cookie中，cookie有长度限制4K，不能保存大量信息"),r("li",null,"session数据放在cookie中，存在泄漏、篡改、窃取等安全隐患")])])])]),r("li",null,[r("p",null,"这种方式不会使用。")])],-1),jr={id:"解决-hash一致性",tabindex:"-1"},Nr=r("figure",null,[r("img",{alt:"image-20230410195638892",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195638892.png"})],-1),Wr=r("ul",null,[r("li",null,[c("优点： "),r("ul",null,[r("li",null,"只需要改nginx配置，不需要修改应用代码"),r("li",null,"负载均衡，只要hash属性的值分布是均匀的，多台web-server的负载是均衡的"),r("li",null,"可以支持web-server水平扩展（session同步法是不行的，受内存限制）")])]),r("li",null,[c("缺点 "),r("ul",null,[r("li",null,"session还是存在web-server中的，所以web-server重启可能导致部分session丢失，影响业务，如部分用户需要重新登录"),r("li",null,"如果web-server水平扩展，rehash后session重新分布，也会有一部分用户路由不到正确的session")])]),r("li",null,"但是以上缺点问题也不是很大，因为session本来都是有有效期的。所以这两种反向代理的方式可以使用")],-1),Kr={id:"解决-统一存储",tabindex:"-1"},zr=r("figure",null,[r("img",{alt:"image-20230410195856602",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410195856602.png"})],-1),Hr=r("ul",null,[r("li",null,[c("优点： "),r("ul",null,[r("li",null,"没有安全隐患"),r("li",null,"可以水平扩展，数据库/缓存水平切分即可"),r("li",null,"web-server重启或者扩容都不会有session丢失")])]),r("li",null,[c("不足 "),r("ul",null,[r("li",null,"增加了一次网络调用，并且需要修改应用代码；如将所有的getSession方法替换为从Redis查数据的方式。redis获取数据比内存慢很多"),r("li",null,"上面缺点可以用SpringSession完美解决")])])],-1),Qr={id:"解决-不同服务-子域session共享",tabindex:"-1"},Ur=r("blockquote",null,[r("p",null,"jsessionid这个cookie默认是当前系统域名的。当我们分拆服务，不同域名部署的时候，我们可以使用 如下解决方案；")],-1),Gr=r("figure",null,[r("img",{alt:"image-20230410200123345",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410200123345.png"})],-1),Xr={id:"springsession核心原理",tabindex:"-1"},Jr=r("figure",null,[r("img",{alt:"image-20230410200156413",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410200156413.png"})],-1),$r={id:"购物车-1",tabindex:"-1"},Yr={id:"购物车数据结构",tabindex:"-1"},Zr=r("figure",null,[r("img",{alt:"image-20230410200320343",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410200320343.png"})],-1),lc=r("blockquote",null,[r("ul",null,[r("li",null,"Map<String k1,Map<String k2,CartItemInfo>> 在redis中"),r("li",null,"k1：标识每一个用户的购物车 key:用户标识"),r("li",null,"k2：购物项的商品id value:Hash（k：商品id，v：购物项详情）")])],-1),sc={id:"消息队列rabbitmq",tabindex:"-1"},oc={id:"rabbitmq概念",tabindex:"-1"},nc=r("figure",null,[r("img",{alt:"image-20230410200724866",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230410200724866.png"})],-1),ec=r("blockquote",null,[r("p",null,"rabbitmq 是一个开源的消息代理和队列服务器，通过普通的协议（Amqp 协议）来完成不同应用之间的数据共享，rabbitMq 是通过 erlang 语言来开发的基于 amqp 协议。")],-1),ac={id:"什么amqp协议",tabindex:"-1"},tc=r("ol",null,[r("li",null,"是一个二进制协议"),r("li",null,"amqp 是一个应用层协议的规范（定义了很多规范），可以有很多不同的消息中间件产品（需要遵循该规范）")],-1),rc=r("ul",null,[r("li",null,[r("p",null,"server： 是消息队列节点")]),r("li",null,[r("p",null,"virtual host： 虚拟主机")]),r("li",null,[r("p",null,"exchange： 交换机（消息投递到交换机上）")]),r("li",null,[r("p",null,"message queue： 被消费者监听消息"),r("p",null,[r("code",null,"交换机和队列是有一个绑定的关系")])])],-1),cc=r("figure",null,[r("img",{alt:"image-20230310210242731",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230310210242731.png"})],-1),pc={id:"amqp的核心概念",tabindex:"-1"},yc=r("ol",null,[r("li",null,"server ： 又称为broker，接受客户端连接，实现amqp实体服务"),r("li",null,"connection： 连接，应用程序与broker建立网络连接"),r("li",null,"channel： 网络通道，几乎所有的操作都是在 channel 中进行的，是进行消息对象的通道，客户端可以建立多个通道，每一个 channnel 表示一个会话任务。"),r("li",null,"Message： 服务器和应用程序之间传递数据的载体，有 properties（消息属性，用来修饰消息，比如消息的优先级，延时投递）和 Body （消息体）"),r("li",null,"virtual host（虚拟主机）：是一个逻辑概念，最上层的消息路由，一个虚拟主机中可以包含多个 exchange 和 queue 但是一个虚拟主机中不能有名称相同的 exchange 和 queue"),r("li",null,"exchange （交换机）： 消息直接投递到交换机上，然后交换机根据消息的路由 key 来路由到对应绑定的队列上。"),r("li",null,"binding （绑定）： 绑定 exchange 与 queue 的虚拟连接， binding 中可以包含route_key"),r("li",null,"route_key（路由key）：它的作用是在交换机上通过 route_key 来把消息路由到那个队列上。"),r("li",null,"queue 队列（队列）： 用来保存消息的载体，有消费者监听，然后消费消息。")],-1),Ec={id:"rabbitmq的消息是如何流转的",tabindex:"-1"},ic=r("figure",null,[r("img",{alt:"image-20230310210409545",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230310210409545.png"})],-1),uc={id:"rabbitmq-交换机详解",tabindex:"-1"},dc={id:"作用",tabindex:"-1"},gc=r("strong",null,"作用",-1),Fc=r("ul",null,[r("li",null,"接受生产者的消息，然后根据路由键把消息投递到跟交换机绑定的对应的队列上。")],-1),Ac=r("figure",null,[r("img",{alt:"image-20230310210717895",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230310210717895.png"})],-1),mc={id:"交换机属性",tabindex:"-1"},Dc=r("strong",null,"交换机属性",-1),hc=r("ul",null,[r("li",null,"Name： 交换机名称"),r("li",null,"Type： 交换机类型，Direct、topic、fanout、headers"),r("li",null,"Durablity：是否需要持久化"),r("li",null,"autodelete： 假如没有队列绑定到该交换机，那么交换机会自动删除。"),r("li",null,"internal： 当前交换机交换机是否用户 RabbitMq 内部使用不常用，默认为false"),r("li",null,"Argurements： 扩展参数，用户扩展AMQP定制化协议。")],-1),kc={id:"交换机类型",tabindex:"-1"},bc=r("ul",null,[r("li",null,[r("strong",null,"直连交换机（Direct exchange）")])],-1),Cc=r("blockquote",null,[r("p",null,"所有发送的 Direct exchange 的消息都会被投递到与 Routekey名称（与队列名称）相同的queue上"),r("p",null,"direct 模式下，可以使用 RabbitMq 自定exchange ---\x3e default exchange 所以不需要交换机和任何队列绑定，消息将会投递到route_key名称和队列名称相同的队列上。")],-1),Sc=r("figure",null,[r("img",{alt:"image-20230310211903967",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230310211903967.png"})],-1),Bc=r("ul",null,[r("li",null,[r("strong",null,"主题交换机 TopicExchange")])],-1),fc=r("blockquote",null,[r("p",null,"就是在队列上绑到 top 交换机上的路由key 可以是通过通配符来匹配的通配符的规则是"),r("p",null,"比如：log.#: 可以是匹配一个单词 也可以匹配多个单词 比如 log.# 可以匹配log.a log.a.b log.* ： 可以匹配一个单词，比如log.* ，可以匹配log.a 但是不可以匹配log.a.b。")],-1),vc=r("figure",null,[r("img",{alt:"image-20230310211944528",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230310211944528.png"})],-1),xc=r("ul",null,[r("li",null,[r("strong",null,"扇形交换机（fanout exchange）")])],-1),Ic=r("blockquote",null,[r("p",null,"就是消息通过丛交换机到队列上不会通过路由key 所以该模式的速度是最快的 只要和交换机绑定的那么消息就会被分发到与之绑定的队列上。")],-1),Oc=r("figure",null,[r("img",{alt:"mall",class:"lazy","data-src":"https://jsd.onmicrosoft.cn/gh/imLKlauS/blog-picture@main/blogs/image-20230310212034909.png"})],-1),Tc={id:"队列、绑定主机、消息",tabindex:"-1"},_c=r("strong",null,"队列、绑定主机、消息",-1),Rc=r("ul",null,[r("li",null,[r("p",null,"绑定： exchange 与 之间的连接关系（通过路由规则）")]),r("li",null,[r("p",null,"队列： 用来存储消息的实体")]),r("li",null,[r("p",null,"队列的属性： durablility 是否被持久化")]),r("li",null,[r("p",null,"AutoDelete： 表示最后一个监听被移除那么该队列就会删除。")]),r("li",null,[r("p",null,"消息： 用来生产者 和 消费者之间传递数据的")]),r("li",null,[r("p",null,"消息属性： 包括 消息体Body 和 属性 properties")]),r("li",null,[r("p",null,"常用属性： delivery mode,headers,content_type(消息类型) content_encoding（消息编码），priporty（消息优先级） correntlation_id( 最终消息唯一的ID)、reply_to(消息失败重回队列)，expiretion(消息的过期时 间),message_id(消息id);timestamp,type,user_id ，app_id,cluster_id等")])],-1);const Lc=l(d,[["render",function(l,s,o,i,u,d){const Lc=E,wc=a;return t(),n(wc,{frontmatter:u.frontmatter,data:u.data},{"main-content-md":e((()=>[g,r("h1",F,[c("项目总结 "),p(Lc,{class:"header-anchor",href:"#项目总结","aria-label":'Permalink to "项目总结"'},{default:e((()=>[c("​")])),_:1})]),A,m,r("h2",D,[c("项目名称 "),p(Lc,{class:"header-anchor",href:"#项目名称","aria-label":'Permalink to "项目名称"'},{default:e((()=>[c("​")])),_:1})]),h,r("h2",k,[c("项目简介 "),p(Lc,{class:"header-anchor",href:"#项目简介","aria-label":'Permalink to "项目简介"'},{default:e((()=>[c("​")])),_:1})]),b,r("h2",C,[c("系统架构 "),p(Lc,{class:"header-anchor",href:"#系统架构","aria-label":'Permalink to "系统架构"'},{default:e((()=>[c("​")])),_:1})]),S,r("h2",B,[c("我的职责 "),p(Lc,{class:"header-anchor",href:"#我的职责","aria-label":'Permalink to "我的职责"'},{default:e((()=>[c("​")])),_:1})]),f,v,x,I,O,T,_,r("h2",R,[c("项目概述 "),p(Lc,{class:"header-anchor",href:"#项目概述","aria-label":'Permalink to "项目概述"'},{default:e((()=>[c("​")])),_:1})]),L,r("h3",w,[c("核心业务一：购物车 "),p(Lc,{class:"header-anchor",href:"#核心业务一-购物车","aria-label":'Permalink to "核心业务一：购物车"'},{default:e((()=>[c("​")])),_:1})]),q,r("h3",P,[c("核心业务二：订单 "),p(Lc,{class:"header-anchor",href:"#核心业务二-订单","aria-label":'Permalink to "核心业务二：订单"'},{default:e((()=>[c("​")])),_:1})]),r("h4",V,[c("订单中心 "),p(Lc,{class:"header-anchor",href:"#订单中心","aria-label":'Permalink to "订单中心"'},{default:e((()=>[c("​")])),_:1})]),M,r("h4",j,[c("订单构成 "),p(Lc,{class:"header-anchor",href:"#订单构成","aria-label":'Permalink to "订单构成"'},{default:e((()=>[c("​")])),_:1})]),N,r("h4",W,[c("订单状态 "),p(Lc,{class:"header-anchor",href:"#订单状态","aria-label":'Permalink to "订单状态"'},{default:e((()=>[c("​")])),_:1})]),K,r("h4",z,[c("订单流程 "),p(Lc,{class:"header-anchor",href:"#订单流程","aria-label":'Permalink to "订单流程"'},{default:e((()=>[c("​")])),_:1})]),H,r("h5",Q,[c("1.订单创建与支付 "),p(Lc,{class:"header-anchor",href:"#_1-订单创建与支付","aria-label":'Permalink to "1.订单创建与支付"'},{default:e((()=>[c("​")])),_:1})]),r("p",null,[p(Lc,{href:"http://order.gulimall.com/toTrade",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("http://order.gulimall.com/toTrade")])),_:1})]),U,r("p",null,[p(Lc,{href:"http://order.gulimall.com/submitOrder",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("http://order.gulimall.com/submitOrder")])),_:1})]),G,X,J,$,Y,Z,ll,r("ul",null,[sl,r("li",null,[r("h6",ol,[nl,c(),p(Lc,{class:"header-anchor",href:"#配置项修改","aria-label":'Permalink to "**配置项修改**"'},{default:e((()=>[c("​")])),_:1})])])]),el,r("blockquote",null,[r("ul",null,[r("li",null,[r("h6",al,[tl,c(),p(Lc,{class:"header-anchor",href:"#核心流程","aria-label":'Permalink to "**核心流程**"'},{default:e((()=>[c("​")])),_:1})])])]),rl,cl,pl,yl,El]),r("ul",null,[r("li",null,[r("h6",il,[c("支付宝沙箱对接 "),p(Lc,{class:"header-anchor",href:"#支付宝沙箱对接","aria-label":'Permalink to "支付宝沙箱对接"'},{default:e((()=>[c("​")])),_:1})])])]),ul,dl,gl,r("p",null,[p(Lc,{href:"https://openhome.alipay.com/platform/developerIndex.htm",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("https://openhome.alipay.com/platform/developerIndex.htmopen in new window")])),_:1})]),Fl,r("p",null,[p(Lc,{href:"https://open.alipay.com/develop/sandbox/app",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("https://open.alipay.com/develop/sandbox/appopen in new window")])),_:1})]),Al,ml,Dl,hl,kl,bl,Cl,Sl,Bl,fl,vl,xl,Il,Ol,r("p",null,[c("调用支付接口"),p(Lc,{href:"http://order.gulimall.com/payOrder?orderSn=202304031500558581642784227126714369%E5%90%8E%EF%BC%8C%E6%96%B0%E5%88%9B%E5%BB%BA",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("http://order.gulimall.com/payOrder?orderSn=202304031500558581642784227126714369后，新创建")])),_:1}),c(),Tl,c(" 空文件，复制控制台日志中前端文件代码到 "),_l,c("。")]),Rl,Ll,wl,ql,Pl,Vl,Ml,jl,Nl,Wl,Kl,zl,Hl,Ql,Ul,Gl,Xl,r("p",null,[p(Lc,{href:"https://natapp.cn/article/natapp_newbie",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("https://natapp.cn/article/natapp_newbieopen in new window")])),_:1})]),r("p",null,[c("开通后，将内网穿透端口为 80，本地地址改为虚拟机映射本地host的地址(192.168.10.103=>"),p(Lc,{href:"http://order.gulimall.com",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("order.gulimall.com")])),_:1}),c(")即支付服务项目端口。")]),Jl,$l,Yl,Zl,ls,ss,os,ns,es,as,r("p",null,[c("页面跳转同步通知页面路径 需"),p(Lc,{href:"http://xn--79sp5fckt6rwxd161acp1b",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("http://格式的完整路径")])),_:1}),c("，不能加?id=123这类自定义参数，必须外网可以正常访问；订单支付完成成功返回以下页面(同步通知，支付成功，一般跳转到成功页)：")]),ts,rs,cs,ps,ys,Es,is,us,r("h5",ds,[c("2.订单创建前需要预览订单，选择收货信息等 "),p(Lc,{class:"header-anchor",href:"#_2-订单创建前需要预览订单-选择收货信息等","aria-label":'Permalink to "2.订单创建前需要预览订单，选择收货信息等"'},{default:e((()=>[c("​")])),_:1})]),r("p",null,[p(Lc,{href:"http://cart.gulimall.com/cart.html",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("http://cart.gulimall.com/cart.html")])),_:1})]),gs,r("p",null,[p(Lc,{href:"http://order.gulimall.com/toTrade",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("http://order.gulimall.com/toTrade")])),_:1})]),Fs,As,ms,Ds,hs,ks,r("h5",bs,[c("3.订单创建需要锁定库存，库存有才可创建，否则不能创建 "),p(Lc,{class:"header-anchor",href:"#_3-订单创建需要锁定库存-库存有才可创建-否则不能创建","aria-label":'Permalink to "3.订单创建需要锁定库存，库存有才可创建，否则不能创建"'},{default:e((()=>[c("​")])),_:1})]),Cs,Ss,Bs,fs,vs,xs,Is,Os,Ts,_s,Rs,Ls,ws,qs,Ps,Vs,Ms,js,Ns,Ws,Ks,zs,Hs,r("h5",Qs,[c("4.订单创建后超时未支付需要解锁库存 "),p(Lc,{class:"header-anchor",href:"#_4-订单创建后超时未支付需要解锁库存","aria-label":'Permalink to "4.订单创建后超时未支付需要解锁库存"'},{default:e((()=>[c("​")])),_:1})]),Us,Gs,Xs,Js,$s,Ys,Zs,lo,so,oo,no,eo,r("h5",ao,[c("5.支付成功后，需要进行拆单，根据商品打包方式，所在仓库，物流等进行拆单(待开发) "),p(Lc,{class:"header-anchor",href:"#_5-支付成功后-需要进行拆单-根据商品打包方式-所在仓库-物流等进行拆单-待开发","aria-label":'Permalink to "5.支付成功后，需要进行拆单，根据商品打包方式，所在仓库，物流等进行拆单(待开发)"'},{default:e((()=>[c("​")])),_:1})]),r("h5",to,[c("6.支付的每笔流水都需要记录，以待查账 "),p(Lc,{class:"header-anchor",href:"#_6-支付的每笔流水都需要记录-以待查账","aria-label":'Permalink to "6.支付的每笔流水都需要记录，以待查账"'},{default:e((()=>[c("​")])),_:1})]),ro,co,po,r("h5",yo,[c("7.订单创建，支付成功(待开发)等状态都需要给 MQ 发送消息，方便其他系统感知订阅 "),p(Lc,{class:"header-anchor",href:"#_7-订单创建-支付成功-待开发-等状态都需要给-mq-发送消息-方便其他系统感知订阅","aria-label":'Permalink to "7.订单创建，支付成功(待开发)等状态都需要给 MQ 发送消息，方便其他系统感知订阅"'},{default:e((()=>[c("​")])),_:1})]),Eo,io,uo,go,Fo,Ao,mo,Do,ho,ko,bo,Co,So,Bo,fo,vo,xo,Io,Oo,To,_o,Ro,Lo,wo,qo,Po,Vo,Mo,jo,No,Wo,Ko,zo,Ho,Qo,Uo,Go,Xo,Jo,$o,r("h5",Yo,[c("订单确认页流程 "),p(Lc,{class:"header-anchor",href:"#订单确认页流程","aria-label":'Permalink to "订单确认页流程"'},{default:e((()=>[c("​")])),_:1})]),Zo,r("h5",ln,[c("电商订单流程图 "),p(Lc,{class:"header-anchor",href:"#电商订单流程图","aria-label":'Permalink to "电商订单流程图"'},{default:e((()=>[c("​")])),_:1})]),sn,r("h5",on,[c("消息队列流程图 "),p(Lc,{class:"header-anchor",href:"#消息队列流程图","aria-label":'Permalink to "消息队列流程图"'},{default:e((()=>[c("​")])),_:1})]),nn,r("h5",en,[c("支付宝支付流程图 "),p(Lc,{class:"header-anchor",href:"#支付宝支付流程图","aria-label":'Permalink to "支付宝支付流程图"'},{default:e((()=>[c("​")])),_:1})]),an,r("h3",tn,[c("项目难点 "),p(Lc,{class:"header-anchor",href:"#项目难点","aria-label":'Permalink to "项目难点"'},{default:e((()=>[c("​")])),_:1})]),rn,r("h3",cn,[c("解决问题 "),p(Lc,{class:"header-anchor",href:"#解决问题","aria-label":'Permalink to "解决问题"'},{default:e((()=>[c("​")])),_:1})]),pn,yn,En,un,dn,gn,r("h3",Fn,[c("项目优化 "),p(Lc,{class:"header-anchor",href:"#项目优化","aria-label":'Permalink to "项目优化"'},{default:e((()=>[c("​")])),_:1})]),An,mn,Dn,r("h2",hn,[c("CompletableFuture异步编排 "),p(Lc,{class:"header-anchor",href:"#completablefuture异步编排","aria-label":'Permalink to "CompletableFuture异步编排"'},{default:e((()=>[c("​")])),_:1})]),r("h3",kn,[c("概念 "),p(Lc,{class:"header-anchor",href:"#概念","aria-label":'Permalink to "概念"'},{default:e((()=>[c("​")])),_:1})]),bn,r("h3",Cn,[c("业务场景 "),p(Lc,{class:"header-anchor",href:"#业务场景","aria-label":'Permalink to "业务场景"'},{default:e((()=>[c("​")])),_:1})]),Sn,Bn,fn,r("h3",vn,[c("项目代码 "),p(Lc,{class:"header-anchor",href:"#项目代码","aria-label":'Permalink to "项目代码"'},{default:e((()=>[c("​")])),_:1})]),xn,In,r("h2",On,[c("RabbitMQ延时队列（实现定时任务） "),p(Lc,{class:"header-anchor",href:"#rabbitmq延时队列-实现定时任务","aria-label":'Permalink to "RabbitMQ延时队列（实现定时任务）"'},{default:e((()=>[c("​")])),_:1})]),r("h3",Tn,[c("场景： "),p(Lc,{class:"header-anchor",href:"#场景","aria-label":'Permalink to "场景："'},{default:e((()=>[c("​")])),_:1})]),_n,Rn,Ln,r("h3",wn,[c("消息的TTL（Time To Live） "),p(Lc,{class:"header-anchor",href:"#消息的ttl-time-to-live","aria-label":'Permalink to "消息的TTL（Time To Live）"'},{default:e((()=>[c("​")])),_:1})]),qn,r("h3",Pn,[c("Dead Letter Exchanges（DLX） "),p(Lc,{class:"header-anchor",href:"#dead-letter-exchanges-dlx","aria-label":'Permalink to "Dead Letter Exchanges（DLX）"'},{default:e((()=>[c("​")])),_:1})]),Vn,r("h3",Mn,[c("延时队列实现 "),p(Lc,{class:"header-anchor",href:"#延时队列实现","aria-label":'Permalink to "延时队列实现"'},{default:e((()=>[c("​")])),_:1})]),jn,Nn,Wn,Kn,zn,r("h3",Hn,[c("SpringBoot中使用延时队列 "),p(Lc,{class:"header-anchor",href:"#springboot中使用延时队列","aria-label":'Permalink to "SpringBoot中使用延时队列"'},{default:e((()=>[c("​")])),_:1})]),Qn,r("h3",Un,[c("消息队列流程 "),p(Lc,{class:"header-anchor",href:"#消息队列流程","aria-label":'Permalink to "消息队列流程"'},{default:e((()=>[c("​")])),_:1})]),Gn,Xn,r("h2",Jn,[c("Redis缓存中的数据结构 "),p(Lc,{class:"header-anchor",href:"#redis缓存中的数据结构","aria-label":'Permalink to "Redis缓存中的数据结构"'},{default:e((()=>[c("​")])),_:1})]),r("h3",$n,[c("分类菜单 "),p(Lc,{class:"header-anchor",href:"#分类菜单","aria-label":'Permalink to "分类菜单"'},{default:e((()=>[c("​")])),_:1})]),Yn,r("h3",Zn,[c("登陆信息-SpringSession "),p(Lc,{class:"header-anchor",href:"#登陆信息-springsession","aria-label":'Permalink to "登陆信息-SpringSession"'},{default:e((()=>[c("​")])),_:1})]),r("h3",le,[c("购物车 "),p(Lc,{class:"header-anchor",href:"#购物车","aria-label":'Permalink to "购物车"'},{default:e((()=>[c("​")])),_:1})]),se,r("h3",oe,[c("秒杀上架 (幂等性处理) "),p(Lc,{class:"header-anchor",href:"#秒杀上架-幂等性处理","aria-label":'Permalink to "秒杀上架 (幂等性处理)"'},{default:e((()=>[c("​")])),_:1})]),ne,r("h3",ee,[c("幂等性保证 "),p(Lc,{class:"header-anchor",href:"#幂等性保证","aria-label":'Permalink to "幂等性保证"'},{default:e((()=>[c("​")])),_:1})]),ae,te,r("h3",re,[c("Redission分布式锁 "),p(Lc,{class:"header-anchor",href:"#redission分布式锁","aria-label":'Permalink to "Redission分布式锁"'},{default:e((()=>[c("​")])),_:1})]),ce,pe,r("h2",ye,[c("分布式事务 "),p(Lc,{class:"header-anchor",href:"#分布式事务","aria-label":'Permalink to "分布式事务"'},{default:e((()=>[c("​")])),_:1})]),Ee,ie,ue,de,ge,Fe,r("h3",Ae,[c("事务的坑 "),p(Lc,{class:"header-anchor",href:"#事务的坑","aria-label":'Permalink to "事务的坑"'},{default:e((()=>[c("​")])),_:1})]),me,r("h3",De,[c("CAP理论 "),p(Lc,{class:"header-anchor",href:"#cap理论","aria-label":'Permalink to "CAP理论"'},{default:e((()=>[c("​")])),_:1})]),he,r("h3",ke,[c("BASE 理论 "),p(Lc,{class:"header-anchor",href:"#base-理论","aria-label":'Permalink to "BASE 理论"'},{default:e((()=>[c("​")])),_:1})]),be,r("h3",Ce,[c("分布式事务几种方案 "),p(Lc,{class:"header-anchor",href:"#分布式事务几种方案","aria-label":'Permalink to "分布式事务几种方案"'},{default:e((()=>[c("​")])),_:1})]),Se,Be,r("h2",fe,[c("Seata "),p(Lc,{class:"header-anchor",href:"#seata","aria-label":'Permalink to "Seata"'},{default:e((()=>[c("​")])),_:1})]),r("p",null,[p(Lc,{href:"https://seata.io/zh-cn/docs/overview/what-is-seata.html",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("Seata 是什么")])),_:1})]),r("h3",ve,[c("Seata的理解 "),p(Lc,{class:"header-anchor",href:"#seata的理解","aria-label":'Permalink to "Seata的理解"'},{default:e((()=>[c("​")])),_:1})]),xe,r("blockquote",null,[r("p",null,[p(Lc,{href:"https://seata.io/zh-cn/docs/overview/what-is-seata.html",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("Seata 是什么")])),_:1})]),r("ul",null,[r("li",null,[r("h4",Ie,[c("TC (Transaction Coordinator) - 事务协调者 "),p(Lc,{class:"header-anchor",href:"#tc-transaction-coordinator-事务协调者","aria-label":'Permalink to "TC (Transaction Coordinator) - 事务协调者"'},{default:e((()=>[c("​")])),_:1})]),Oe]),r("li",null,[r("h4",Te,[c("TM (Transaction Manager) - 事务管理器 "),p(Lc,{class:"header-anchor",href:"#tm-transaction-manager-事务管理器","aria-label":'Permalink to "TM (Transaction Manager) - 事务管理器"'},{default:e((()=>[c("​")])),_:1})]),_e]),r("li",null,[r("h4",Re,[c("RM (Resource Manager) - 资源管理器 "),p(Lc,{class:"header-anchor",href:"#rm-resource-manager-资源管理器","aria-label":'Permalink to "RM (Resource Manager) - 资源管理器"'},{default:e((()=>[c("​")])),_:1})]),Le])]),we]),r("h3",qe,[c("Seata项目整合 "),p(Lc,{class:"header-anchor",href:"#seata项目整合","aria-label":'Permalink to "Seata项目整合"'},{default:e((()=>[c("​")])),_:1})]),r("ul",null,[Pe,Ve,r("li",null,[c("2）、安装事务协调器；seata-server： "),p(Lc,{href:"https://github.com/seata/seata/releases",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("https://github.com/seata/seata/releases")])),_:1})]),r("li",null,[c("3）、整合 "),r("ul",null,[Me,je,Ne,r("li",null,[c("4、每个微服务，都必须导入 "),r("ul",null,[We,r("li",null,[c("file.conf vgroup_mapping.{"),p(Lc,{href:"http://application.name",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("application.name")])),_:1}),c("}-fescar-service-group = “default”")])])]),Ke,ze,He])])]),Qe,Ue,r("h2",Ge,[c("Sentinel "),p(Lc,{class:"header-anchor",href:"#sentinel","aria-label":'Permalink to "Sentinel"'},{default:e((()=>[c("​")])),_:1})]),r("p",null,[p(Lc,{href:"https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("介绍 · alibaba/Sentinel Wiki · GitHub")])),_:1})]),r("h3",Xe,[c("Sentinel理解 "),p(Lc,{class:"header-anchor",href:"#sentinel理解","aria-label":'Permalink to "Sentinel理解"'},{default:e((()=>[c("​")])),_:1})]),Je,r("h3",$e,[c("熔断降级限流 "),p(Lc,{class:"header-anchor",href:"#熔断降级限流","aria-label":'Permalink to "熔断降级限流"'},{default:e((()=>[c("​")])),_:1})]),Ye,r("h3",Ze,[c("项目整合步骤 "),p(Lc,{class:"header-anchor",href:"#项目整合步骤","aria-label":'Permalink to "项目整合步骤"'},{default:e((()=>[c("​")])),_:1})]),la,r("h3",sa,[c("整合 Feign+Sentinel 测试熔断降级 "),p(Lc,{class:"header-anchor",href:"#整合-feign-sentinel-测试熔断降级","aria-label":'Permalink to "整合 Feign+Sentinel 测试熔断降级"'},{default:e((()=>[c("​")])),_:1})]),r("ul",null,[oa,na,ea,aa,r("li",null,[ta,ra,r("blockquote",null,[r("p",null,[p(Lc,{href:"https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("注解支持 · alibaba/Sentinel Wiki · GitHub")])),_:1})]),ca,pa])])]),r("h2",ya,[c("Nacos "),p(Lc,{class:"header-anchor",href:"#nacos","aria-label":'Permalink to "Nacos"'},{default:e((()=>[c("​")])),_:1})]),r("blockquote",null,[r("p",null,[p(Lc,{href:"https://nacos.io/zh-cn/docs/use-nacos-with-springcloud.html",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("Nacos Spring Cloud")])),_:1})])]),r("h3",Ea,[c("项目整合 "),p(Lc,{class:"header-anchor",href:"#项目整合","aria-label":'Permalink to "项目整合"'},{default:e((()=>[c("​")])),_:1})]),ia,r("h3",ua,[c("Nacos作为注册中心： "),p(Lc,{class:"header-anchor",href:"#nacos作为注册中心","aria-label":'Permalink to "Nacos作为注册中心："'},{default:e((()=>[c("​")])),_:1})]),da,r("h3",ga,[c("Nacos作为配置中心 "),p(Lc,{class:"header-anchor",href:"#nacos作为配置中心","aria-label":'Permalink to "Nacos作为配置中心"'},{default:e((()=>[c("​")])),_:1})]),r("ul",null,[Fa,Aa,r("li",null,[ma,r("ul",null,[Da,r("li",null,[r("blockquote",null,[ha,ka,ba,Ca,Sa,Ba,r("ul",null,[r("li",null,[c("${prefix} - ${spring.profiles.active} . ${file-extension} prefix 默认为 "),p(Lc,{href:"http://spring.application.name",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("spring.application.name")])),_:1}),c(" 的值，也可以通过配置项 spring.cloud.nacos.config.prefix 来配置。")]),fa]),va,xa,Ia,Oa])])])]),r("li",null,[Ta,r("ul",null,[r("li",null,[r("blockquote",null,[_a,Ra,La,wa,qa,r("p",null,[r("strong",null,[c("@Value(“${"),p(Lc,{href:"http://user.name",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("user.name")])),_:1}),c("}”)")])]),Pa,Va,Ma,ja])])])])]),r("h3",Na,[c("Nacos进阶 "),p(Lc,{class:"header-anchor",href:"#nacos进阶","aria-label":'Permalink to "Nacos进阶"'},{default:e((()=>[c("​")])),_:1})]),Wa,r("h2",Ka,[c("Gateway "),p(Lc,{class:"header-anchor",href:"#gateway","aria-label":'Permalink to "Gateway"'},{default:e((()=>[c("​")])),_:1})]),r("blockquote",null,[r("p",null,[p(Lc,{href:"https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.3.RELEASE/single/spring-cloud-gateway.html",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("Spring Cloud Gateway")])),_:1})])]),za,Ha,r("h2",Qa,[c("Feign "),p(Lc,{class:"header-anchor",href:"#feign","aria-label":'Permalink to "Feign"'},{default:e((()=>[c("​")])),_:1})]),Ua,Ga,r("h3",Xa,[c("Feign远程调用丢失请求头问题 "),p(Lc,{class:"header-anchor",href:"#feign远程调用丢失请求头问题","aria-label":'Permalink to "Feign远程调用丢失请求头问题"'},{default:e((()=>[c("​")])),_:1})]),Ja,r("h3",$a,[c("Feign异步情况丢失上下文问题 "),p(Lc,{class:"header-anchor",href:"#feign异步情况丢失上下文问题","aria-label":'Permalink to "Feign异步情况丢失上下文问题"'},{default:e((()=>[c("​")])),_:1})]),Ya,r("h2",Za,[c("SpringCloud Alibaba 常用组件端口号总结 "),p(Lc,{class:"header-anchor",href:"#springcloud-alibaba-常用组件端口号总结","aria-label":'Permalink to "SpringCloud Alibaba 常用组件端口号总结"'},{default:e((()=>[c("​")])),_:1})]),lt,st,r("h2",ot,[c("支付 "),p(Lc,{class:"header-anchor",href:"#支付","aria-label":'Permalink to "支付"'},{default:e((()=>[c("​")])),_:1})]),r("h3",nt,[c("加密-对称加密 "),p(Lc,{class:"header-anchor",href:"#加密-对称加密","aria-label":'Permalink to "加密-对称加密"'},{default:e((()=>[c("​")])),_:1})]),et,r("h3",at,[c("加密-非对称加密 "),p(Lc,{class:"header-anchor",href:"#加密-非对称加密","aria-label":'Permalink to "加密-非对称加密"'},{default:e((()=>[c("​")])),_:1})]),tt,r("h3",rt,[c("支付宝验签 "),p(Lc,{class:"header-anchor",href:"#支付宝验签","aria-label":'Permalink to "支付宝验签"'},{default:e((()=>[c("​")])),_:1})]),ct,r("h3",pt,[c("收单 "),p(Lc,{class:"header-anchor",href:"#收单","aria-label":'Permalink to "收单"'},{default:e((()=>[c("​")])),_:1})]),yt,r("h2",Et,[c("MD5&MD5盐值加密 "),p(Lc,{class:"header-anchor",href:"#md5-md5盐值加密","aria-label":'Permalink to "MD5&MD5盐值加密"'},{default:e((()=>[c("​")])),_:1})]),it,r("h2",ut,[c("项目微服务 "),p(Lc,{class:"header-anchor",href:"#项目微服务","aria-label":'Permalink to "项目微服务"'},{default:e((()=>[c("​")])),_:1})]),dt,r("h2",gt,[c("Nginx+Windows搭建域名访问环境 "),p(Lc,{class:"header-anchor",href:"#nginx-windows搭建域名访问环境","aria-label":'Permalink to "Nginx+Windows搭建域名访问环境"'},{default:e((()=>[c("​")])),_:1})]),Ft,r("h3",At,[c("域名映射效果 "),p(Lc,{class:"header-anchor",href:"#域名映射效果","aria-label":'Permalink to "域名映射效果"'},{default:e((()=>[c("​")])),_:1})]),r("ul",null,[r("li",null,[c("请求接口 "),p(Lc,{href:"http://gulimall.com",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("gulimall.com")])),_:1})]),r("li",null,[c("请求页面 "),p(Lc,{href:"http://gulimall.com",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("gulimall.com")])),_:1})]),mt,Dt,ht]),r("h3",kt,[c("正向代理与反向代理 "),p(Lc,{class:"header-anchor",href:"#正向代理与反向代理","aria-label":'Permalink to "正向代理与反向代理"'},{default:e((()=>[c("​")])),_:1})]),bt,Ct,St,Bt,r("h3",ft,[c("Nginx配置文件 "),p(Lc,{class:"header-anchor",href:"#nginx配置文件","aria-label":'Permalink to "Nginx配置文件"'},{default:e((()=>[c("​")])),_:1})]),vt,r("h3",xt,[c("Nginx动静分离 "),p(Lc,{class:"header-anchor",href:"#nginx动静分离","aria-label":'Permalink to "Nginx动静分离"'},{default:e((()=>[c("​")])),_:1})]),It,r("h3",Ot,[c("Nginx转发效果 "),p(Lc,{class:"header-anchor",href:"#nginx转发效果","aria-label":'Permalink to "Nginx转发效果"'},{default:e((()=>[c("​")])),_:1})]),Tt,r("h2",_t,[c("内网穿透 "),p(Lc,{class:"header-anchor",href:"#内网穿透","aria-label":'Permalink to "内网穿透"'},{default:e((()=>[c("​")])),_:1})]),Rt,Lt,r("h3",wt,[c("内网穿透联调 "),p(Lc,{class:"header-anchor",href:"#内网穿透联调","aria-label":'Permalink to "内网穿透联调"'},{default:e((()=>[c("​")])),_:1})]),qt,r("h3",Pt,[c("配置 "),p(Lc,{class:"header-anchor",href:"#配置","aria-label":'Permalink to "配置"'},{default:e((()=>[c("​")])),_:1})]),Vt,Mt,r("p",null,[c("listen 80; server_name "),p(Lc,{href:"http://gulimall.com",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("gulimall.com")])),_:1}),c(" *.gulimall.com "),p(Lc,{href:"http://497n86m7k7.52http.net",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("497n86m7k7.52http.net")])),_:1}),c("; #charset koi8-r; #access_log /var/log/nginx/log/host.access.log main; location /static/ { root /usr/share/nginx/html; } location /payed/ { proxy_set_header Host "),p(Lc,{href:"http://order.gulimall.com",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("order.gulimall.com")])),_:1}),c("; proxy_pass "),p(Lc,{href:"http://gulimall",target:"_blank",rel:"noreferrer"},{default:e((()=>[c("http://gulimall")])),_:1}),c("; }")]),jt,r("h2",Nt,[c("缓存 "),p(Lc,{class:"header-anchor",href:"#缓存","aria-label":'Permalink to "缓存"'},{default:e((()=>[c("​")])),_:1})]),r("h3",Wt,[c("本地缓存 "),p(Lc,{class:"header-anchor",href:"#本地缓存","aria-label":'Permalink to "本地缓存"'},{default:e((()=>[c("​")])),_:1})]),Kt,r("h3",zt,[c("分布式缓存-本地模式在分布式下的问题 "),p(Lc,{class:"header-anchor",href:"#分布式缓存-本地模式在分布式下的问题","aria-label":'Permalink to "分布式缓存-本地模式在分布式下的问题"'},{default:e((()=>[c("​")])),_:1})]),Ht,r("h3",Qt,[c("分布式缓存 "),p(Lc,{class:"header-anchor",href:"#分布式缓存","aria-label":'Permalink to "分布式缓存"'},{default:e((()=>[c("​")])),_:1})]),Ut,r("h4",Gt,[c("高并发下缓存失效问题-缓存穿透 "),p(Lc,{class:"header-anchor",href:"#高并发下缓存失效问题-缓存穿透","aria-label":'Permalink to "高并发下缓存失效问题-缓存穿透"'},{default:e((()=>[c("​")])),_:1})]),Xt,Jt,r("h4",$t,[c("高并发下缓存失效问题-缓存雪崩 "),p(Lc,{class:"header-anchor",href:"#高并发下缓存失效问题-缓存雪崩","aria-label":'Permalink to "高并发下缓存失效问题-缓存雪崩"'},{default:e((()=>[c("​")])),_:1})]),Yt,Zt,r("h4",lr,[c("高并发下缓存失效问题-缓存击穿 "),p(Lc,{class:"header-anchor",href:"#高并发下缓存失效问题-缓存击穿","aria-label":'Permalink to "高并发下缓存失效问题-缓存击穿"'},{default:e((()=>[c("​")])),_:1})]),sr,or,r("h3",nr,[c("分布式下如何加锁？ "),p(Lc,{class:"header-anchor",href:"#分布式下如何加锁","aria-label":'Permalink to "分布式下如何加锁？"'},{default:e((()=>[c("​")])),_:1})]),er,ar,r("h3",tr,[c("锁-时序问题 "),p(Lc,{class:"header-anchor",href:"#锁-时序问题","aria-label":'Permalink to "锁-时序问题"'},{default:e((()=>[c("​")])),_:1})]),rr,r("h3",cr,[c("分布式锁演进-基本原理 "),p(Lc,{class:"header-anchor",href:"#分布式锁演进-基本原理","aria-label":'Permalink to "分布式锁演进-基本原理"'},{default:e((()=>[c("​")])),_:1})]),pr,yr,r("h4",Er,[c("分布式锁演进-阶段一 "),p(Lc,{class:"header-anchor",href:"#分布式锁演进-阶段一","aria-label":'Permalink to "分布式锁演进-阶段一"'},{default:e((()=>[c("​")])),_:1})]),ir,r("h4",ur,[c("分布式锁演进-阶段二 "),p(Lc,{class:"header-anchor",href:"#分布式锁演进-阶段二","aria-label":'Permalink to "分布式锁演进-阶段二"'},{default:e((()=>[c("​")])),_:1})]),dr,r("h4",gr,[c("分布式锁演进-阶段三 "),p(Lc,{class:"header-anchor",href:"#分布式锁演进-阶段三","aria-label":'Permalink to "分布式锁演进-阶段三"'},{default:e((()=>[c("​")])),_:1})]),Fr,r("h4",Ar,[c("分布式锁演进-阶段四 "),p(Lc,{class:"header-anchor",href:"#分布式锁演进-阶段四","aria-label":'Permalink to "分布式锁演进-阶段四"'},{default:e((()=>[c("​")])),_:1})]),mr,r("h4",Dr,[c("分布式锁演进-阶段五-最终形态 "),p(Lc,{class:"header-anchor",href:"#分布式锁演进-阶段五-最终形态","aria-label":'Permalink to "分布式锁演进-阶段五-最终形态"'},{default:e((()=>[c("​")])),_:1})]),hr,r("h3",kr,[c("缓存数据一致性-双写模式 "),p(Lc,{class:"header-anchor",href:"#缓存数据一致性-双写模式","aria-label":'Permalink to "缓存数据一致性-双写模式"'},{default:e((()=>[c("​")])),_:1})]),br,r("h3",Cr,[c("缓存数据一致性-失效模式 "),p(Lc,{class:"header-anchor",href:"#缓存数据一致性-失效模式","aria-label":'Permalink to "缓存数据一致性-失效模式"'},{default:e((()=>[c("​")])),_:1})]),Sr,r("h3",Br,[c("缓存数据一致性-解决方案 "),p(Lc,{class:"header-anchor",href:"#缓存数据一致性-解决方案","aria-label":'Permalink to "缓存数据一致性-解决方案"'},{default:e((()=>[c("​")])),_:1})]),fr,r("h3",vr,[c("缓存数据一致性-解决-Canal "),p(Lc,{class:"header-anchor",href:"#缓存数据一致性-解决-canal","aria-label":'Permalink to "缓存数据一致性-解决-Canal"'},{default:e((()=>[c("​")])),_:1})]),xr,r("h2",Ir,[c("Session共享问题 "),p(Lc,{class:"header-anchor",href:"#session共享问题","aria-label":'Permalink to "Session共享问题"'},{default:e((()=>[c("​")])),_:1})]),r("h3",Or,[c("session原理 "),p(Lc,{class:"header-anchor",href:"#session原理","aria-label":'Permalink to "session原理"'},{default:e((()=>[c("​")])),_:1})]),Tr,r("h3",_r,[c("分布式下session共享问题 "),p(Lc,{class:"header-anchor",href:"#分布式下session共享问题","aria-label":'Permalink to "分布式下session共享问题"'},{default:e((()=>[c("​")])),_:1})]),Rr,r("h3",Lr,[c("解决-session复制 "),p(Lc,{class:"header-anchor",href:"#解决-session复制","aria-label":'Permalink to "解决-session复制"'},{default:e((()=>[c("​")])),_:1})]),wr,qr,r("h3",Pr,[c("解决-客户端存储 "),p(Lc,{class:"header-anchor",href:"#解决-客户端存储","aria-label":'Permalink to "解决-客户端存储"'},{default:e((()=>[c("​")])),_:1})]),Vr,Mr,r("h3",jr,[c("解决-hash一致性 "),p(Lc,{class:"header-anchor",href:"#解决-hash一致性","aria-label":'Permalink to "解决-hash一致性"'},{default:e((()=>[c("​")])),_:1})]),Nr,Wr,r("h3",Kr,[c("解决-统一存储 "),p(Lc,{class:"header-anchor",href:"#解决-统一存储","aria-label":'Permalink to "解决-统一存储"'},{default:e((()=>[c("​")])),_:1})]),zr,Hr,r("h3",Qr,[c("解决-不同服务，子域session共享 "),p(Lc,{class:"header-anchor",href:"#解决-不同服务-子域session共享","aria-label":'Permalink to "解决-不同服务，子域session共享"'},{default:e((()=>[c("​")])),_:1})]),Ur,Gr,r("h3",Xr,[c("SpringSession核心原理 "),p(Lc,{class:"header-anchor",href:"#springsession核心原理","aria-label":'Permalink to "SpringSession核心原理"'},{default:e((()=>[c("​")])),_:1})]),Jr,r("h2",$r,[c("购物车 "),p(Lc,{class:"header-anchor",href:"#购物车-1","aria-label":'Permalink to "购物车"'},{default:e((()=>[c("​")])),_:1})]),r("h3",Yr,[c("购物车数据结构 "),p(Lc,{class:"header-anchor",href:"#购物车数据结构","aria-label":'Permalink to "购物车数据结构"'},{default:e((()=>[c("​")])),_:1})]),Zr,lc,r("h2",sc,[c("消息队列RabbitMQ "),p(Lc,{class:"header-anchor",href:"#消息队列rabbitmq","aria-label":'Permalink to "消息队列RabbitMQ"'},{default:e((()=>[c("​")])),_:1})]),r("h3",oc,[c("RabbitMQ概念 "),p(Lc,{class:"header-anchor",href:"#rabbitmq概念","aria-label":'Permalink to "RabbitMQ概念"'},{default:e((()=>[c("​")])),_:1})]),nc,ec,r("h3",ac,[c("什么AMQP协议 "),p(Lc,{class:"header-anchor",href:"#什么amqp协议","aria-label":'Permalink to "什么AMQP协议"'},{default:e((()=>[c("​")])),_:1})]),tc,rc,cc,r("h3",pc,[c("AMQP的核心概念 "),p(Lc,{class:"header-anchor",href:"#amqp的核心概念","aria-label":'Permalink to "AMQP的核心概念"'},{default:e((()=>[c("​")])),_:1})]),yc,r("h3",Ec,[c("RabbitMq的消息是如何流转的？ "),p(Lc,{class:"header-anchor",href:"#rabbitmq的消息是如何流转的","aria-label":'Permalink to "RabbitMq的消息是如何流转的？"'},{default:e((()=>[c("​")])),_:1})]),ic,r("h3",uc,[c("RabbitMq 交换机详解 "),p(Lc,{class:"header-anchor",href:"#rabbitmq-交换机详解","aria-label":'Permalink to "RabbitMq 交换机详解"'},{default:e((()=>[c("​")])),_:1})]),r("h4",dc,[gc,c("： "),p(Lc,{class:"header-anchor",href:"#作用","aria-label":'Permalink to "**作用**："'},{default:e((()=>[c("​")])),_:1})]),Fc,Ac,r("h4",mc,[Dc,c(),p(Lc,{class:"header-anchor",href:"#交换机属性","aria-label":'Permalink to "**交换机属性**"'},{default:e((()=>[c("​")])),_:1})]),hc,r("h4",kc,[c("交换机类型 "),p(Lc,{class:"header-anchor",href:"#交换机类型","aria-label":'Permalink to "交换机类型"'},{default:e((()=>[c("​")])),_:1})]),bc,Cc,Sc,Bc,fc,vc,xc,Ic,Oc,r("h3",Tc,[_c,c(),p(Lc,{class:"header-anchor",href:"#队列、绑定主机、消息","aria-label":'Permalink to "**队列、绑定主机、消息**"'},{default:e((()=>[c("​")])),_:1})]),Rc])),"main-header":e((()=>[y(l.$slots,"main-header")])),"main-header-after":e((()=>[y(l.$slots,"main-header-after")])),"main-nav":e((()=>[y(l.$slots,"main-nav")])),"main-content":e((()=>[y(l.$slots,"main-content")])),"main-content-after":e((()=>[y(l.$slots,"main-content-after")])),"main-nav-before":e((()=>[y(l.$slots,"main-nav-before")])),"main-nav-after":e((()=>[y(l.$slots,"main-nav-after")])),comment:e((()=>[y(l.$slots,"comment")])),footer:e((()=>[y(l.$slots,"footer")])),aside:e((()=>[y(l.$slots,"aside")])),"aside-custom":e((()=>[y(l.$slots,"aside-custom")])),default:e((()=>[y(l.$slots,"default")])),_:3},8,["frontmatter","data"])}]]);export{i as __pageData,Lc as default};
